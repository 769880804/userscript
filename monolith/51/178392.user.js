// ==UserScript==
// @name           Neopets Attic Timer
// @description    Adds a count-down to next possible attic restock in neopets tab title
// @include http://www.neopets.com/*
// @exclude http://www.neopets.com/*reply_message*
// @exclude http://www.neopets.com/*send&recipient*
// ==/UserScript==

// http://timeapi.org/utc/now.json?callback=myCallback



 
 
var link=("http://www.timeapi.org/utc/7%20hours%20ago.json?format=%25I:%25M:%25S %25P %25a");
 var title=$(document).attr('title');

    $(document).keydown(function(e) {
      if (e.ctrlKey) {
        if (e.keyCode == 65 || e.keyCode == 97) { // 'A' or 'a'
          e.preventDefault();
          window.open("http://www.neopets.com/halloween/garage.phtml","_self");
        }
      }
      
    }); 


function getDay(day){
    switch (day){
        case "Sun":
            return 0;
        break;
        case "Mon":
            return 1;
        break;
        case "Tue":
            return 2;
        break;
        case "Wed":
            return 3;
        break;    
        case "Thu":
            return 4;
        break;
        case "Fri":
            return 5;
        break;
        case "Sat":
            return 6;
        break;

        
    }
return 0;
}

 function start_ajax(){
    $.ajax({
        type : "GET",
        dataType : "jsonp",
        url : link,
        success: function(json){
        console.log(json);
           json=json.dateString;
           var time=json;
           var day;
           var pmam;
           if(json.indexOf("pm") != -1){
                pmam="pm";
           }else{
                pmam="am";
           }
           day=getDay(json.split(pmam)[1].trim());
           time=json.split(pmam)[0]+" "+pmam;
           
           var vars=start(time,day,pmam);
           
           if(vars[0]){
                           
           }else{
                if(pmam=="am"){
                    vars=  start(time,day,"pm");
                }else{
                    vars=start(time,(day+1)%7,"am");
                }
           }

           start_timer(vars[0],vars[1]); 

        }
    });
}

start_ajax();
 //start();

 
function start(time,day,pmam){ 
//console.log(time+" "+day+" "+pmam);
var str;
var horas;
var n = day;
switch (n){
case 0://sunday
if (pmam=="am"){
str =  "12:01/12:08/12:15/12:22/12:29/12:36/12:43/12:50/12:57/1:04/1:11/1:18/1:25/1:32/1:39/1:46/1:53/2:00/2:07/2:14/2:21/2:28/2:35/2:42/2:49/2:56/3:03/3:10/3:17/3:24/3:31/3:38/3:45/3:52/3:59/4:06/4:13/4:20/4:27/4:34/4:41/4:48/4:55/5:02/5:09/5:16/5:23/5:30/5:37/5:44/5:51/5:58/6:05/6:12/6:19/6:26/6:33/6:40/6:47/6:54/7:01/7:08/7:15/7:22/7:29/7:36/7:43/7:50/7:57/8:04/8:11/8:18/8:25/8:32/8:39/8:46/8:53/9:00/9:07/9:14/9:21/9:28/9:35/9:42/9:49/9:56/10:03/10:10/10:17/10:24/10:31/10:38/10:45/10:52/10:59/11:06/11:13/11:20/11:27/11:34/11:41/11:48/11:55";
}else{
str= "12:02/12:09/12:16/12:23/12:30/12:37/12:44/12:51/12:58/1:05/1:12/1:19/1:26/1:33/1:40/1:47/1:54/2:01/2:08/2:15/2:22/2:29/2:36/2:43/2:50/2:57/3:04/3:11/3:18/3:25/3:32/3:39/3:46/3:53/4:00/4:07/4:14/4:21/4:28/4:35/4:42/4:49/4:56/5:03/5:10/5:17/5:24/5:31/5:38/5:45/5:52/5:59/6:06/6:13/6:20/6:27/6:34/6:41/6:48/6:55/7:02/7:09/7:16/7:23/7:30/7:37/7:44/7:51/7:58/8:05/8:12/8:19/8:26/8:33/8:40/8:47/8:54/9:01/9:08/9:15/9:22/9:29/9:36/9:43/9:50/9:57/10:04/10:11/10:18/10:25/10:32/10:39/10:46/10:53/11:00/11:07/11:14/11:21/11:28/11:35/11:42/11:49/11:56";
}
break;
case 1://monday
if (pmam=="am"){
str= "12:03/12:10/12:17/12:24/12:31/12:38/12:45/12:52/12:59/1:06/1:13/1:20/1:27/1:34/1:41/1:48/1:55/2:02/2:09/2:16/2:23/2:30/2:37/2:44/2:51/2:58/3:05/3:12/3:19/3:26/3:33/3:40/3:47/3:54/4:01/4:08/4:15/4:22/4:29/4:36/4:43/4:50/4:57/5:04/5:11/5:18/5:25/5:32/5:39/5:46/5:53/6:00/6:07/6:14/6:21/6:28/6:35/6:42/6:49/6:56/7:03/7:10/7:17/7:24/7:31/7:38/7:45/7:52/7:59/8:06/8:13/8:20/8:27/8:34/8:41/8:48/8:55/9:02/9:09/9:16/9:23/9:30/9:37/9:44/9:51/9:58/10:05/10:12/10:19/10:26/10:33/10:40/10:47/10:54/11:01/11:08/11:15/11:22/11:29/11:36/11:43/11:50/11:57";
}else{
str="12:04/12:11/12:18/12:25/12:32/12:39/12:46/12:53/1:00/1:07/1:14/1:21/1:28/1:35/1:42/1:49/1:56/2:03/2:10/2:17/2:24/2:31/2:38/2:45/2:52/2:59/3:06/3:13/3:20/3:27/3:34/3:41/3:48/3:55/4:02/4:09/4:16/4:23/4:30/4:37/4:44/4:51/4:58/5:05/5:12/5:19/5:26/5:33/5:40/5:47/5:54/6:01/6:08/6:15/6:22/6:29/6:36/6:43/6:50/6:57/7:04/7:11/7:18/7:25/7:32/7:39/7:46/7:53/8:00/8:07/8:14/8:21/8:28/8:35/8:42/8:49/8:56/9:03/9:10/9:17/9:24/9:31/9:38/9:45/9:52/9:59/10:06/10:13/10:20/10:27/10:34/10:41/10:48/10:55/11:02/11:09/11:16/11:23/11:30/11:37/11:44/11:51/11:58";

}
break;
case 2://tuesday
if (pmam=="am"){
str= "12:05/12:12/12:19/12:26/12:33/12:40/12:47/12:54/1:01/1:08/1:15/1:22/1:29/1:36/1:43/1:50/1:57/2:04/2:11/2:18/2:25/2:32/2:39/2:46/2:53/3:00/3:07/3:14/3:21/3:28/3:35/3:42/3:49/3:56/4:03/4:10/4:17/4:24/4:31/4:38/4:45/4:52/4:59/5:06/5:13/5:20/5:27/5:34/5:41/5:48/5:55/6:02/6:09/6:16/6:23/6:30/6:37/6:44/6:51/6:58/7:05/7:12/7:19/7:26/7:33/7:40/7:47/7:54/8:01/8:08/8:15/8:22/8:29/8:36/8:43/8:50/8:57/9:04/9:11/9:18/9:25/9:32/9:39/9:46/9:53/10:00/10:07/10:14/10:21/10:28/10:35/10:42/10:49/10:56/11:03/11:10/11:17/11:24/11:31/11:38/11:45/11:52/11:59/";
}else{
str= "12:06/12:13/12:20/12:27/12:34/12:41/12:48/12:55/1:02/1:09/1:16/1:23/1:30/1:37/1:44/1:51/1:58/2:05/2:12/2:19/2:26/2:33/2:40/2:47/2:54/3:01/3:08/3:15/3:22/3:29/3:36/3:43/3:50/3:57/4:04/4:11/4:18/4:25/4:32/4:39/4:46/4:53/5:00/5:07/5:14/5:21/5:28/5:35/5:42/5:49/5:56/6:03/6:10/6:17/6:24/6:31/6:38/6:45/6:52/6:59/7:06/7:13/7:20/7:27/7:34/7:41/7:48/7:55/8:02/8:09/8:16/8:23/8:30/8:37/8:44/8:51/8:58/9:05/9:12/9:19/9:26/9:33/9:40/9:47/9:54/10:01/10:08/10:15/10:22/10:29/10:36/10:43/10:50/10:57/11:04/11:11/11:18/11:25/11:32/11:39/11:46/11:53";
}
break;
case 3://wednesday
if (pmam=="am"){
str= "12:00/12:07/12:14/12:21/12:28/12:35/12:42/12:49/12:56/1:03/1:10/1:17/1:24/1:31/1:38/1:45/1:52/1:59/2:06/2:13/2:20/2:27/2:34/2:41/2:48/2:55/3:02/3:09/3:16/3:23/3:30/3:37/3:44/3:51/3:58/4:05/4:12/4:19/4:26/4:33/4:40/4:47/4:54/5:01/5:08/5:15/5:22/5:29/5:36/5:43/5:50/5:57/6:04/6:11/6:18/6:25/6:32/6:39/6:46/6:53/7:00/7:07/7:14/7:21/7:28/7:35/7:42/7:49/7:56/8:03/8:10/8:17/8:24/8:31/8:38/8:45/8:52/8:59/9:06/9:13/9:20/9:27/9:34/9:41/9:48/9:55/10:02/10:09/10:16/10:23/10:30/10:37/10:44/10:51/10:58/11:05/11:12/11:19/11:26/11:33/11:40/11:47/11:54";
}else{
str= "12:01/12:08/12:15/12:22/12:29/12:36/12:43/12:50/12:57/1:04/1:11/1:18/1:25/1:32/1:39/1:46/1:53/2:00/2:07/2:14/2:21/2:28/2:35/2:42/2:49/2:56/3:03/3:10/3:17/3:24/3:31/3:38/3:45/3:52/3:59/4:06/4:13/4:20/4:27/4:34/4:41/4:48/4:55/5:02/5:09/5:16/5:23/5:30/5:37/5:44/5:51/5:58/6:05/6:12/6:19/6:26/6:33/6:40/6:47/6:54/7:01/7:08/7:15/7:22/7:29/7:36/7:43/7:50/7:57/8:04/8:11/8:18/8:25/8:32/8:39/8:46/8:53/9:00/9:07/9:14/9:21/9:28/9:35/9:42/9:49/9:56/10:03/10:10/10:17/10:24/10:31/10:38/10:45/10:52/10:59/11:06/11:13/11:20/11:27/11:34/11:41/11:48/11:55";
}
break;
case 4://thrusday
if (pmam=="am"){
str= "12:02/12:09/12:16/12:23/12:30/12:37/12:44/12:51/12:58/1:05/1:12/1:19/1:26/1:33/1:40/1:47/1:54/2:01/2:08/2:15/2:22/2:29/2:36/2:43/2:50/2:57/3:04/3:11/3:18/3:25/3:32/3:39/3:46/3:53/4:00/4:07/4:14/4:21/4:28/4:35/4:42/4:49/4:56/5:03/5:10/5:17/5:24/5:31/5:38/5:45/5:52/5:59/6:06/6:13/6:20/6:27/6:34/6:41/6:48/6:55/7:02/7:09/7:16/7:23/7:30/7:37/7:44/7:51/7:58/8:05/8:12/8:19/8:26/8:33/8:40/8:47/8:54/9:01/9:08/9:15/9:22/9:29/9:36/9:43/9:50/9:57/10:04/10:11/10:18/10:25/10:32/10:39/10:46/10:53/11:00/11:07/11:14/11:21/11:28/11:35/11:42/11:49/11:56";
}else{
str= "12:03/12:10/12:17/12:24/12:31/12:38/12:45/12:52/12:59/1:06/1:13/1:20/1:27/1:34/1:41/1:48/1:55/2:02/2:09/2:16/2:23/2:30/2:37/2:44/2:51/2:58/3:05/3:12/3:19/3:26/3:33/3:40/3:47/3:54/4:01/4:08/4:15/4:22/4:29/4:36/4:43/4:50/4:57/5:04/5:11/5:18/5:25/5:32/5:39/5:46/5:53/6:00/6:07/6:14/6:21/6:28/6:35/6:42/6:49/6:56/7:03/7:10/7:17/7:24/7:31/7:38/7:45/7:52/7:59/8:06/8:13/8:20/8:27/8:34/8:41/8:48/8:55/9:02/9:09/9:16/9:23/9:30/9:37/9:44/9:51/9:58/10:05/10:12/10:19/10:26/10:33/10:40/10:47/10:54/11:01/11:08/11:15/11:22/11:29/11:36/11:43/11:50/11:57";
}
break;
case 5://friday
if (pmam=="am"){
str="12:04/12:11/12:18/12:25/12:32/12:39/12:46/12:53/1:00/1:07/1:14/1:21/1:28/1:35/1:42/1:49/1:56/2:03/2:10/2:17/2:24/2:31/2:38/2:45/2:52/2:59/3:06/3:13/3:20/3:27/3:34/3:41/3:48/3:55/4:02/4:09/4:16/4:23/4:30/4:37/4:44/4:51/4:58/5:05/5:12/5:19/5:26/5:33/5:40/5:47/5:54/6:01/6:08/6:15/6:22/6:29/6:36/6:43/6:50/6:57/7:04/7:11/7:18/7:25/7:32/7:39/7:46/7:53/8:00/8:07/8:14/8:21/8:28/8:35/8:42/8:49/8:56/9:03/9:10/9:17/9:24/9:31/9:38/9:45/9:52/9:59/10:06/10:13/10:20/10:27/10:34/10:41/10:48/10:55/11:02/11:09/11:16/11:23/11:30/11:37/11:44/11:51/11:58";
}else{
str= "12:05/12:12/12:19/12:26/12:33/12:40/12:47/12:54/1:01/1:08/1:15/1:22/1:29/1:36/1:43/1:50/1:57/2:04/2:11/2:18/2:25/2:32/2:39/2:46/2:53/3:00/3:07/3:14/3:21/3:28/3:35/3:42/3:49/3:56/4:03/4:10/4:17/4:24/4:31/4:38/4:45/4:52/4:59/5:06/5:13/5:20/5:27/5:34/5:41/5:48/5:55/6:02/6:09/6:16/6:23/6:30/6:37/6:44/6:51/6:58/7:05/7:12/7:19/7:26/7:33/7:40/7:47/7:54/8:01/8:08/8:15/8:22/8:29/8:36/8:43/8:50/8:57/9:04/9:11/9:18/9:25/9:32/9:39/9:46/9:53/10:00/10:07/10:14/10:21/10:28/10:35/10:42/10:49/10:56/11:03/11:10/11:17/11:24/11:31/11:38/11:45/11:52/11:59";
}
break;
case 6://saturday
if (pmam=="am"){
str= "12:06/12:13/12:20/12:27/12:34/12:41/12:48/12:55/1:02/1:09/1:16/1:23/1:30/1:37/1:44/1:51/1:58/2:05/2:12/2:19/2:26/2:33/2:40/2:47/2:54/3:01/3:08/3:15/3:22/3:29/3:36/3:43/3:50/3:57/4:04/4:11/4:18/4:25/4:32/4:39/4:46/4:53/5:00/5:07/5:14/5:21/5:28/5:35/5:42/5:49/5:56/6:03/6:10/6:17/6:24/6:31/6:38/6:45/6:52/6:59/7:06/7:13/7:20/7:27/7:34/7:41/7:48/7:55/8:02/8:09/8:16/8:23/8:30/8:37/8:44/8:51/8:58/9:05/9:12/9:19/9:26/9:33/9:40/9:47/9:54/10:01/10:08/10:15/10:22/10:29/10:36/10:43/10:50/10:57/11:04/11:11/11:18/11:25/11:32/11:39/11:46/11:53";
}else{
str= "12:00/12:07/12:14/12:21/12:28/12:35/12:42/12:49/12:56/1:03/1:10/1:17/1:24/1:31/1:38/1:45/1:52/1:59/2:06/2:13/2:20/2:27/2:34/2:41/2:48/2:55/3:02/3:09/3:16/3:23/3:30/3:37/3:44/3:51/3:58/4:05/4:12/4:19/4:26/4:33/4:40/4:47/4:54/5:01/5:08/5:15/5:22/5:29/5:36/5:43/5:50/5:57/6:04/6:11/6:18/6:25/6:32/6:39/6:46/6:53/7:00/7:07/7:14/7:21/7:28/7:35/7:42/7:49/7:56/8:03/8:10/8:17/8:24/8:31/8:38/8:45/8:52/8:59/9:06/9:13/9:20/9:27/9:34/9:41/9:48/9:55/10:02/10:09/10:16/10:23/10:30/10:37/10:44/10:51/10:58/11:05/11:12/11:19/11:26/11:33/11:40/11:47/11:54";
}
break;
}
horas=str.split("/");
for (var a=0;a<horas.length;a++){
	if(horas[a].length==4){horas[a]="0"+horas[a];}
}
//console.log(horas);
var next;
//time=time.split(" ")[0];
//time+=":53";
//if (time.length==7){time="0"+time;}

//console.log(time);
//console.log(pmam);
var hora=new Date("9/21/2009 "+time);
//console.log(hora.toString());
for (var a=0;a<horas.length;a++){
d=new Date("9/21/2009 "+horas[a]+":53"+" "+pmam);
if (hora < d){
next = new Date(d);
break;
}//else{console.log(d.toString())}
}


return [next,hora];



// start();
}//function start



function start_timer(next,hora){
    var num;
    var str1;
    //console.log(next+" "+hora+" "+n+" "+pmam);
    num=(next-hora)/1000;
    var myVar;
    //num-=1;
    myFunction();
    function myFunction()
    {
    myVar=setInterval(function(){myTimer()},1000);
    }
    
    function myTimer()
    {
    num-=1;
    if (num==0){
        clearInterval(myVar);
        start_ajax();
    }
    seconds=String((num-(Math.floor(num/60)*60)));
    if (seconds.length==1){seconds="0"+seconds;}
    str1 = String(Math.floor(num/60)+":"+seconds);    
    $(document).attr('title', str1+" "+title);
    }

}//function star_timer



