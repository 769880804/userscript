//-----------------------------------------------------------------------
// Copyright (C) 2012 Zorbing
// 
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
// 
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
// 
// You should have received a copy of the GNU General Public License
// along with this program.  If not, see <http://www.gnu.org/licenses/>.
//-----------------------------------------------------------------------
// ==UserScript==
// @name Ingame-Farmmanager
// @namespace FileFace
// @description Hilft beim Farmen
// @version 1.6.6.2
// @author Zorbing
// @include http://ae*.tribalwars.ae/game.php?*
// @license GPL
// @copyright 2012 Zorbing
// ==/UserScript==
(function(){var win = typeof (unsafeWindow) != 'undefined' ? unsafeWindow : window,$ = win.$,scriptlink = $('<li>').text('Ingame-Farmmanager (Autor: Zorbing)');$('#script_list').append(scriptlink);$('#script_warning').append('<span class="warn">Bitte installiert den neuen <a href="http://userscripts.org/scripts/show/134048">DS-Farmassistent</a></span>!');$('#script_warning').show();var worldsSpeed={17:1.6,26:1.6,30:1.6,40:1.6,42:1.6,44:1.6,46:1.6,54:1.6,60:1.6,67:1.6,73:2,75:2,77:2,81:1.6},worldsUnitSpeed={17:0.625,26:0.625,30:0.625,40:0.625,42:0.625,44:0.625,46:0.625,54:0.625,60:0.625,67:0.625,73:0.75,81:0.625},world=location.href.match(/http:\/\/de(\d+).die-staemme.de\//)[1],worldSpeed=worldsSpeed[world]?worldsSpeed[world]:1,worldUnitSpeed=worldsUnitSpeed[world]?worldsUnitSpeed[world]:1,units=['مقاتل الرمح','مقاتل السيف','مقاتل الفأس','رماة الأسهم','كشافة','فارس خفيف','فارس قوس','فارس ثقيل','محطمة الحائط','مقلاع','قائد الفرسان','نبيل','ميليشيا'],unitImgUrl='graphic/unit/unit_$.png',unitImg=['spear','sword','axe','archer','spy','light','marcher','heavy','ram','catapult','knight','snob','militia'],unitSpeed=[18*worldUnitSpeed,22*worldUnitSpeed,18*worldUnitSpeed,18*worldUnitSpeed,9*worldUnitSpeed,10*worldUnitSpeed,10*worldUnitSpeed,11*worldUnitSpeed,30*worldUnitSpeed,30*worldUnitSpeed,10*worldUnitSpeed,35*worldUnitSpeed,-1],unitsCheck={'مقاتل الرمح':1,'مقاتل السيف':1,'مقاتل الفأس':1,'رماة الأسهم':1,'كشافة':1,'فارس خفيف':1,'فارس قوس':1,'فارس ثقيل':1,'محطمة الحائط':1,'مقلاع':1,'قائد الفرسان':1,'نبيل':1,'ميليشيا':1},unitBooty=[25,15,10,10,0,80,50,50,0,0,100,0,0],dateIndex=['d','M','Y','H','m','s'],dateCheck={'d':1,'M':1,'Y':1,'H':1,'m':1,'s':1},buildingsIndex=['المبنى الرئيسي','الثكنات','الاسطبل','الورشه','Erste Kirche','Kirche','الاكاديميه','الحداد','نقطة التجمع','النصب التذكاري','السوق','الخشاب','حفرة الطمي','منجم الحديد','المزارع','المخازن','المخابئ','الحائط'],buildingImgUrl='graphic/buildings/$.png',buildingImg=['main','barracks','stable','garage','church_f','church','snob','smith','place','statue','market','wood','stone','iron','farm','storage','hide','wall'],buildingsCheck={'المبنى الرئيسي':1,'الثكنات':1,'الاسطبل':1,'الورشه':1,'Erste Kirche':1,'Kirche':1,'الاكاديمية':1,'الحداد':1,'نقطة التجمع':1,'النصب التذكاري':1,'السوق':1,'الخشاب':1,'حفرة الطمي':1,'منجم الحديد':1,'المزارع':1,'المخازن':1,'المخابئ':1,'الحائط':1},resIndex=['خشب','طمي','حديد','الخشاب','حفرة الطمي','منجم الحديد'],resCheck={'خشب':1,'طمي':1,'حديد':1,'الخشاب':1,'حفرة الطمي':1,'منجم الحديد':1},buildingPoints={'المبنى الرئيسي':[0,10,12,14,17,21,25,30,36,43,52,62,74,89,107,128,154,185,222,266,319,383,460,552,662,795,954,1145,1374,1648,1978],'الثكنات':[0,16,19,23,28,33,40,48,57,69,83,99,119,143,171,205,247,296,355,426,511,613,736,883,1060,1272],'الاسطبل':[0,20,24,29,35,41,50,60,72,86,103,124,149,178,214,257,308,370,444,532,639],'الورشه':[0,24,29,35,41,50,60,72,86,103,124,149,178,214,257,308],'Kirche':[0,10,12,14],'Erste Kirche':[0,10],'الاكاديميه':[0,512,614,737],'الحداد':[0,19,23,27,33,39,47,57,68,82,98,118,141,169,203,244,293,351,422,506,607],'نقطة التجمع':[0,0],'النصب التذكاري':[0,24],'السوق':[0,10,12,14,17,21,25,30,36,43,52,62,74,89,107,128,154,185,222,266,319,383,460,552,662,795,954,1145,1374,1648,1978],'الخشاب':[0,6,7,9,10,12,15,18,21,26,31,37,45,53,64,77,92,111,133,160,192,230,276,331,397,477,572,687,824,989,1187],'حفرة الطمي':[0,6,7,9,10,12,15,18,21,26,31,37,45,53,64,77,92,111,133,160,192,230,276,331,397,477,572,687,824,989,1187],'منجم الحديد':[0,6,7,9,10,12,15,18,21,26,31,37,45,53,64,77,92,111,133,160,192,230,276,331,397,477,572,687,824,989,1187],'المزارع':[0,5,6,7,9,10,12,15,18,21,26,31,37,45,53,64,77,92,111,133,160,192,230,276,331,397,477,572,687,824,989],'المخازن':[0,6,7,9,10,12,15,18,21,26,31,37,45,53,64,77,92,111,133,160,192,230,276,331,397,477,572,687,824,989,1187],'المخابئ':[0,5,6,7,9,10,12,15,18,21,26],'الحائط':[0,8,10,12,14,17,20,24,29,34,41,50,59,71,86,103,123,148,177,213,256]},production=[5/3600,30/3600,35/3600,41/3600,47/3600,55/3600,64/3600,74/3600,86/3600,100/3600,117/3600,136/3600,158/3600,184/3600,214/3600,249/3600,289/3600,337/3600,391/3600,455/3600,530/3600,616/3600,717/3600,833/3600,969/3600,1127/3600,1311/3600,1525/3600,1774/3600,2063/3600,2400/3600],storage=[0,1000,1229,1512,1859,2285,2810,3454,4247,5222,6420,7893,9705,11932,14670,18037,22177,27266,33523,41217,50675,62305,76604,94184,115798,142372,175047,215219,264611,325337,400000],hide=[0,150,200,267,356,474,632,843,1125,1500,2000],hCoords=false,vCoords=false;window.oldReport=false;window.keysActive=false;window.UVActive=(location.href.match(/&t=\d+/)!==null);function trim(str){return str.replace(/^\s\s*/,'').replace(/\s\s*$/,'')}function $(el){return document.getElementById(el)}function getNodeTextRecursively(node,delimeter){var result='';if(node&&node.nodeType==3){if(node.nodeValue&&!node.nodeValue.match(/^\s+$/)){result+=trim(node.nodeValue)+delimeter}}if(node.hasChildNodes()){for(var i=0,max=node.childNodes.length;i<max;++i){result+=getNodeTextRecursively(node.childNodes[i],delimeter)}}return result}function removeAllChildNodes(element){while(element.childNodes.length>0){element.removeChild(element.lastChild)}}function is_array(obj){return typeof(obj)=='object'&&(obj instanceof Array)}function getPosX(el){var x=0;while(el&&typeof(el)=='object'&&typeof(el.tagName)!='undefined'){x+=el.offsetLeft;if(el.tagName.toUpperCase()=='BODY'){el=null}else{el=el.offsetParent}}return x}function getPosY(el){var y=0;while(el&&typeof(el)=='object'&&typeof(el.tagName)!='undefined'){y+=el.offsetTop;if(el.tagName.toUpperCase()=='BODY'){el=null}else{el=el.offsetParent}}return y}function raiseEvent(eventType,el){if(document.createEvent){var evt=document.createEvent("Events");evt.initEvent(eventType,true,true);el.dispatchEvent(evt)}else if(document.createEventObject){var evt=document.createEventObject();el.fireEvent('on'+eventType,evt)}}function getValue(key,def){if(GM_getValue(key,def)!=def){GM_setValue('de'+world+key,GM_getValue(key));GM_deleteValue(key)}return GM_getValue('de'+world+key,def)}function setValue(key,value){if(GM_getValue(key,null)!==null){GM_deleteValue(key)}GM_setValue('de'+world+key,value)}function deleteValue(key){if(GM_getValue(key,null)!==null){GM_deleteValue(key)}GM_deleteValue('de'+world+key)}function deleteReport(){var as=document.getElementsByTagName('a'),a=false;for(var i=0,max=as.length;i<max;++i){if(as[i].innerHTML.match(/L.{1,2}schen/)){a=as[i];break}}if(a===false){alert('Kann diesen Bericht nicht löschen!\nEs wurde kein Löschen-Link gefunden!');return false}else{location.href=a.getAttribute('href');return true}}function nextReport(){var as=document.getElementsByTagName('a'),a=false;for(var i=0,max=as.length;i<max;++i){if(as[i].innerHTML.match(/&lt;&lt;/)){a=as[i];break}}if(a){location.href=a.getAttribute('href');return true}else{return false}}function prevReport(){var as=document.getElementsByTagName('a'),a=false;for(var i=0,max=as.length;i<max;++i){if(as[i].innerHTML.match(/&gt;&gt;/)){a=as[i];break}}if(a){location.href=a.getAttribute('href');return true}else{return false}}function moveReport(){var as=document.getElementsByTagName('a'),a=false;for(var i=0,max=as.length;i<max;++i){if(as[i].innerHTML.indexOf('Verschieben')!=-1){a=as[i];break}}if(a){location.href=a.getAttribute('href');return true}else{return false}}function readingReports(){if(arguments.length==1&&arguments[0]=='0'){deleteValue('readingReports')}else{var read=getValue('readingReports',false);if(read){read=read.split(',');if(read[1]=='1'&&window.oldReport){deleteReport()}else{if(!prevReport()){deleteValue('readingReports')}}}}}function getSeconds(Year,Month,day,Hour,minute,second){var daysMonth=[0,0,31,59,90,120,151,181,212,243,273,304,334];if(Month>2){return((((Year-1)*365+Math.floor(Year/4)+daysMonth[Month]+day)*24+Hour)*60+minute)*60+second}else{return((((Year-1)*365+Math.floor((Year-1)/4)+daysMonth[Month]+day)*24+Hour)*60+minute)*60+second}}function getPrevDay(today){yDay=[parseInt(today[0]),parseInt(today[1]),parseInt(today[2])];yDay[0]-=1;if(yDay[0]==0){yDay[1]-=1;if(yDay[1]==0){yDay[2]-=1;yDay[1]=12;yDay[0]=31}else if(yDay[1]==2){if(yDay[2]%4==0){yDay[0]=29}else{yDay[0]=28}}else{yDay[0]=[0,31,28,31,30,31,30,31,31,30,31,30,31][yDay[1]]}}return yDay}function Report(Coords){this.Coords=Coords;this.Save=function(){if(this.SpyReportDate['Y']>this.LastReportDate['Y']||(this.SpyReportDate['Y']==this.LastReportDate['Y']&&this.SpyReportDate['M']>this.LastReportDate['M'])||(this.SpyReportDate['Y']==this.LastReportDate['Y']&&this.SpyReportDate['M']==this.LastReportDate['M']&&this.SpyReportDate['d']>this.LastReportDate['d'])||(this.SpyReportDate['Y']==this.LastReportDate['Y']&&this.SpyReportDate['M']==this.LastReportDate['M']&&this.SpyReportDate['d']==this.LastReportDate['d']&&this.SpyReportDate['H']>this.LastReportDate['H'])||(this.SpyReportDate['Y']==this.LastReportDate['Y']&&this.SpyReportDate['M']==this.LastReportDate['M']&&this.SpyReportDate['d']==this.LastReportDate['d']&&this.SpyReportDate['H']==this.LastReportDate['H']&&this.SpyReportDate['m']>this.LastReportDate['m'])||(this.SpyReportDate['Y']==this.LastReportDate['Y']&&this.SpyReportDate['M']==this.LastReportDate['M']&&this.SpyReportDate['d']==this.LastReportDate['d']&&this.SpyReportDate['H']==this.LastReportDate['H']&&this.SpyReportDate['m']==this.LastReportDate['m']&&this.SpyReportDate['s']>this.LastReportDate['s'])){this.LastReportDate=this.SpyReportDate}var string=this.Name.replace(/\./g,'/&=%')+'.'+this.SpyReportDate['d']+','+this.SpyReportDate['M']+','+this.SpyReportDate['Y']+','+this.SpyReportDate['H']+','+this.SpyReportDate['m']+','+this.SpyReportDate['s']+'.'+this.LastReportDate['d']+','+this.LastReportDate['M']+','+this.LastReportDate['Y']+','+this.LastReportDate['H']+','+this.LastReportDate['m']+','+this.LastReportDate['s']+'.'+this.Buildings['Hauptgebäude']+','+this.Buildings['Kaserne']+','+this.Buildings['Stall']+','+this.Buildings['Werkstatt']+','+this.Buildings['Erste Kirche']+','+this.Buildings['Kirche']+','+this.Buildings['Adelshof']+','+this.Buildings['Schmiede']+','+this.Buildings['Versammlungsplatz']+','+this.Buildings['Statue']+','+this.Buildings['Marktplatz']+','+this.Buildings['Holzfäller']+','+this.Buildings['Lehmgrube']+','+this.Buildings['Eisenmine']+','+this.Buildings['Bauernhof']+','+this.Buildings['Speicher']+','+this.Buildings['Versteck']+','+this.Buildings['Wall']+'.'+this.Res['Holz']+','+this.Res['Lehm']+','+this.Res['Eisen']+','+this.Res['Beute Holz']+','+this.Res['Beute Lehm']+','+this.Res['Beute Eisen']+'.'+this.Troops['Speerträger']+','+this.Troops['Schwertkämpfer']+','+this.Troops['Axtkämpfer']+','+this.Troops['Bogenschütze']+','+this.Troops['Späher']+','+this.Troops['Leichte Kavallerie']+','+this.Troops['Berittener Bogenschütze']+','+this.Troops['Schwere Kavallerie']+','+this.Troops['Rammbock']+','+this.Troops['Katapult']+','+this.Troops['Paladin']+','+this.Troops['Adelsgeschlecht']+','+this.Troops['Miliz']+'.'+this.Ram['Von']+','+this.Ram['Nach']+'.'+this.Cata['Building']+','+this.Cata['Von']+','+this.Cata['Nach']+'.'+this.Mood+'.'+this.Bonus+this.EQ+this.EQCount;setValue('Village['+this.Coords[0]+'|'+this.Coords[1]+']',string)};this.failedLoading=function(){this.Name='';this.SpyReportDate={'d':-1,'M':-1,'Y':-1,'H':-1,'m':-1,'s':-1};this.LastReportDate={'d':-1,'M':-1,'Y':-1,'H':-1,'m':-1,'s':-1};this.Buildings={};this.clearBuildings();this.Res={};this.clearAllRes();this.Troops={};this.clearTroops();this.Ram={};this.clearRam();this.Cata={};this.clearCata();this.Mood=100;this.Bonus=0;this.Mult={'Holz':1,'Lehm':1,'Eisen':1,'Speicher':1};this.EQ=1;this.EQCount=0;this.Save()};this.getName=function(){if(this.Name!==''){return this.Name}else{return false}};this.getSpyDate=function(key){if(dateCheck[key]){return this.SpyReportDate[key]}else{var ret='';var keys=key.split('');for(var i=0,max=keys.length;i<max;++i){if(dateCheck[keys[i]]){if(keys[i]!='Y'&&this.SpyReportDate[keys[i]]<10){ret+='0'}ret+=this.SpyReportDate[keys[i]]}else{ret+=keys[i]}}return ret}};this.getLastDate=function(key){if(dateCheck[key]){return this.LastReportDate[key]}else{var ret='';var keys=key.split('');for(var i=0,max=keys.length;i<max;++i){if(dateCheck[keys[i]]){ret+=this.LastReportDate[keys[i]]}else{ret+=keys[i]}}return ret}};this.getBuilding=function(key){if(buildingsCheck[key]){if(key=='Wall'){if(this.Ram['Nach']!=-1){return this.Ram['Nach']}else{return this.Buildings[key]}}else if(key==this.Cata['Building']){if(this.Cata['Nach']!=-1){return this.Cata['Nach']}else{return this.Buildings[key]}}else{return this.Buildings[key]}}else{return false}};this.getRes=function(key,addSeconds){if(addSeconds===undefined)addSeconds=0;var resBuild={'Holz':'Holzfäller','Lehm':'Lehmgrube','Eisen':'Eisenmine'};var resProd={'Holzproduktion':'Holz','Lehmproduktion':'Lehm','Eisenproduktion':'Eisen'};if(resCheck[key]){if(resBuild[key]){var ret=this.Res[key]+Math.floor(production[this.Buildings[resBuild[key]]]*this.Mult[key]*(this.LastTimeDiff+addSeconds)*worldSpeed);var stor=Math.floor(storage[this.Buildings['Speicher']]*this.Mult['Speicher']);if(ret>stor)ret=stor;return ret}else{return this.Res[key]}}else if(resProd[key]){return Math.floor(production[this.Buildings[resBuild[resProd[key]]]]*3600)}else{return false}};this.getResWarn=function(key,proz){var resBuild={'Holz':'Holzfäller','Lehm':'Lehmgrube','Eisen':'Eisenmine'};var res=0;if(key==''){res=this.Res['Holz']+Math.floor(production[this.Buildings[resBuild['Holz']]]*this.LastTimeDiff*worldSpeed)+this.Res['Lehm']+Math.floor(production[this.Buildings[resBuild['Lehm']]]*this.LastTimeDiff*worldSpeed)+this.Res['Eisen']+Math.floor(production[this.Buildings[resBuild['Eisen']]]*this.LastTimeDiff*worldSpeed)}else{res=this.Res[key]+Math.floor(production[this.Buildings[resBuild[key]]]*this.LastTimeDiff*worldSpeed)}if(!proz){proz=1}if(key==''){proz*=3}if(res>=storage[this.Buildings['Speicher']]*proz){return true}else{return false}};this.getTroops=function(key){if(unitsCheck[key]){return this.Troops[key]}else{return false}};this.isTroops=function(){return(this.Troops['Speerträger']!=0||this.Troops['Schwertkämpfer']!=0||this.Troops['Axtkämpfer']!=0||this.Troops['Bogenschütze']!=0||this.Troops['Späher']!=0||this.Troops['Leichte Kavallerie']!=0||this.Troops['Berittener Bogenschütze']!=0||this.Troops['Schwere Kavallerie']!=0||this.Troops['Rammbock']!=0||this.Troops['Katapult']!=0||this.Troops['Paladin']!=0||this.Troops['Adelsgeschlecht']!=0||this.Troops['Miliz']!=0)};this.getMood=function(key){if(this.Mood>=100){return 100}else{if((this.Mood+Math.floor(this.SpyTimeDiff/3600))>=100){return 100}else{return this.Mood+Math.floor(this.SpyTimeDiff/3600)}}};this.getPoints=function(){points=this.Points;if(points==-1){points=0;for(var i=0,max=buildingsIndex.length;i<max;++i){points+=buildingPoints[buildingsIndex[i]][this.Buildings[buildingsIndex[i]]]}this.Points=points}return points};this.getStorage=function(){return storage[this.Buildings['Speicher']]};this.exist=function(){date=this.LastReportDate;if(date['Y']==-1||date['M']==-1||date['d']==-1||date['H']==-1||date['m']==-1||date['s']==-1){return false}else{return true}};this.setName=function(value){this.Name=value};this.setSpyDate=function(key,value){if(dateCheck[key]){this.SpyReportDate[key]=parseInt(value)}else if(is_array(key)&&key.length==6){this.SpyReportDate={'d':parseInt(key[0]),'M':parseInt(key[1]),'Y':parseInt(key[2]),'H':parseInt(key[3]),'m':parseInt(key[4]),'s':parseInt(key[5])}}else{return false}};this.setLastDate=function(key,value){if(dateCheck[key]){this.LastReportDate[key]=parseInt(value)}else if(is_array(key)&&key.length==6){this.LastReportDate={'d':parseInt(key[0]),'M':parseInt(key[1]),'Y':parseInt(key[2]),'H':parseInt(key[3]),'m':parseInt(key[4]),'s':parseInt(key[5])}}else{return false}};this.clearBuildings=function(){this.Buildings={'Hauptgebäude':0,'Kaserne':0,'Stall':0,'Werkstatt':0,'Erste Kirche':0,'Kirche':0,'Adelshof':0,'Schmiede':0,'Versammlungsplatz':0,'Statue':0,'Marktplatz':0,'Holzfäller':0,'Lehmgrube':0,'Eisenmine':0,'Bauernhof':0,'Speicher':0,'Versteck':0,'Wall':0}};this.setBuilding=function(key,value){if(buildingsCheck[key]){this.Buildings[key]=parseInt(value)}else{return false}};this.clearAllRes=function(){this.Res={'Holz':0,'Lehm':0,'Eisen':0,'Beute Holz':0,'Beute Lehm':0,'Beute Eisen':0}};this.clearRes=function(){tmpRes=this.Res;this.Res={'Holz':0,'Lehm':0,'Eisen':0,'Beute Holz':tmpRes['Beute Holz'],'Beute Lehm':tmpRes['Beute Lehm'],'Beute Eisen':tmpRes['Beute Eisen']}};this.setRes=function(key,value){if(resCheck[key]){this.Res[key]=parseInt(value)}else if(key==0){this.Res['Holz']=0;this.Res['Lehm']=0;this.Res['Eisen']=0}else{return false}};this.clearTroops=function(){this.Troops={'Speerträger':0,'Schwertkämpfer':0,'Axtkämpfer':0,'Bogenschütze':0,'Späher':0,'Leichte Kavallerie':0,'Berittener Bogenschütze':0,'Schwere Kavallerie':0,'Rammbock':0,'Katapult':0,'Paladin':0,'Adelsgeschlecht':0,'Miliz':0}};this.setTroops=function(key,value){if(unitsCheck[key]){this.Troops[key]=parseInt(value)}else{return false}};this.clearRam=function(){this.Ram={'Von':-1,'Nach':-1}};this.setRam=function(key,value){if(key=='Von'||key=='Nach'){this.Ram[key]=parseInt(value)}else{return false}};this.clearCata=function(){this.Cata={'Building':'','Von':-1,'Nach':-1}};this.setCata=function(key,value){if(key=='Von'||key=='Nach'){this.Cata[key]=parseInt(value)}else if(key=='Building'){this.Cata[key]=value}else{return false}};this.setMood=function(value){value=parseInt(value);this.Mood=value};this.setBonus=function(value){this.Bonus=value;switch(value){case 1:this.Mult['Holz']=2;break;case 2:this.Mult['Lehm']=2;break;case 3:this.Mult['Eisen']=2;break;case 8:this.Mult['Holz']=1.3;this.Mult['Lehm']=1.3;this.Mult['Eisen']=1.3;break;case 9:this.Mult['Speicher']=1.5;break;default:break}};this.setTimeDiffs=function(){var tmpDate=$('serverDate').innerHTML.split('/');var tmpTime=$('serverTime').innerHTML.split(':');if(tmpDate.length!=3||tmpTime.length!=3)return false;var tmp=[parseInt(tmpDate[2])-2000,parseInt(tmpDate[1].replace(/^0/,'')),parseInt(tmpDate[0].replace(/^0/,'')),parseInt(tmpTime[0].replace(/^0(\d)/,"$1")),parseInt(tmpTime[1].replace(/^0(\d)/,"$1")),parseInt(tmpTime[2].replace(/^0(\d)/,"$1"))];var serverTime=getSeconds(tmp[0],tmp[1],tmp[2],tmp[3],tmp[4],tmp[5]);var spyDate=this.SpyReportDate;if(spyDate['Y']==-1||spyDate['M']==-1||spyDate['d']==-1||spyDate['H']==-1||spyDate['m']==-1||spyDate['s']==-1){this.SpyTimeDiff=7776000}else{var spyTime=getSeconds(spyDate['Y'],spyDate['M'],spyDate['d'],spyDate['H'],spyDate['m'],spyDate['s']);this.SpyTimeDiff=serverTime-spyTime}lastDate=this.LastReportDate;if(lastDate['Y']==-1||lastDate['M']==-1||lastDate['d']==-1||lastDate['H']==-1||lastDate['m']==-1||lastDate['s']==-1){this.LastTimeDiff=7776000}else{var lastTime=getSeconds(lastDate['Y'],lastDate['M'],lastDate['d'],lastDate['H'],lastDate['m'],lastDate['s']);this.LastTimeDiff=serverTime-lastTime}return true};var saveAfter=false;var rawdata=getValue('Village['+this.Coords[0]+'|'+this.Coords[1]+']',false);if(!rawdata){this.failedLoading();return}var data=rawdata.split('.');if(data.length==9){data[9]=0;saveAfter=true}if(data.length!=10){this.failedLoading();return}this.Name=data[0].replace(/\/&=%/g,'.');var spyReportStr=data[1].split(',');var lastReportStr=data[2].split(',');if(spyReportStr.length!=6||lastReportStr.length!=6){this.failedLoading();return}this.SpyReportDate={'d':parseInt(spyReportStr[0]),'M':parseInt(spyReportStr[1]),'Y':parseInt(spyReportStr[2]),'H':parseInt(spyReportStr[3]),'m':parseInt(spyReportStr[4]),'s':parseInt(spyReportStr[5])};this.LastReportDate={'d':parseInt(lastReportStr[0]),'M':parseInt(lastReportStr[1]),'Y':parseInt(lastReportStr[2]),'H':parseInt(lastReportStr[3]),'m':parseInt(lastReportStr[4]),'s':parseInt(lastReportStr[5])};var buildingsStr=data[3].split(',');if(buildingsStr.length!=18){this.failedLoading();return}this.Buildings={'Hauptgebäude':parseInt(buildingsStr[0]),'Kaserne':parseInt(buildingsStr[1]),'Stall':parseInt(buildingsStr[2]),'Werkstatt':parseInt(buildingsStr[3]),'Erste Kirche':parseInt(buildingsStr[4]),'Kirche':parseInt(buildingsStr[5]),'Adelshof':parseInt(buildingsStr[6]),'Schmiede':parseInt(buildingsStr[7]),'Versammlungsplatz':parseInt(buildingsStr[8]),'Statue':parseInt(buildingsStr[9]),'Marktplatz':parseInt(buildingsStr[10]),'Holzfäller':parseInt(buildingsStr[11]),'Lehmgrube':parseInt(buildingsStr[12]),'Eisenmine':parseInt(buildingsStr[13]),'Bauernhof':parseInt(buildingsStr[14]),'Speicher':parseInt(buildingsStr[15]),'Versteck':parseInt(buildingsStr[16]),'Wall':parseInt(buildingsStr[17])};var resStr=data[4].split(',');if(resStr.length!=6){this.failedLoading();return}this.Res={'Holz':parseInt(resStr[0]),'Lehm':parseInt(resStr[1]),'Eisen':parseInt(resStr[2]),'Beute Holz':parseInt(resStr[3]),'Beute Lehm':parseInt(resStr[4]),'Beute Eisen':parseInt(resStr[5])};var troopsStr=data[5].split(',');if(troopsStr.length!=13){this.failedLoading();return}this.Troops={'Speerträger':parseInt(troopsStr[0]),'Schwertkämpfer':parseInt(troopsStr[1]),'Axtkämpfer':parseInt(troopsStr[2]),'Bogenschütze':parseInt(troopsStr[3]),'Späher':parseInt(troopsStr[4]),'Leichte Kavallerie':parseInt(troopsStr[5]),'Berittener Bogenschütze':parseInt(troopsStr[6]),'Schwere Kavallerie':parseInt(troopsStr[7]),'Rammbock':parseInt(troopsStr[8]),'Katapult':parseInt(troopsStr[9]),'Paladin':parseInt(troopsStr[10]),'Adelsgeschlecht':parseInt(troopsStr[11]),'Miliz':parseInt(troopsStr[12])};var ramStr=data[6].split(',');if(ramStr.length!=2){this.failedLoading();return}this.Ram={'Von':parseInt(ramStr[0]),'Nach':parseInt(ramStr[1])};var cataStr=data[7].split(',');if(cataStr.length!=3){this.failedLoading();return}this.Cata={'Building':cataStr[0],'Von':parseInt(cataStr[1]),'Nach':parseInt(cataStr[2])};this.Mood=parseInt(data[8]);this.Bonus=data[9];this.Mult={'Holz':1,'Lehm':1,'Eisen':1,'Speicher':1};switch(data[9]){case 1:this.Mult['Holz']=2;break;case 2:this.Mult['Lehm']=2;break;case 3:this.Mult['Eisen']=2;break;case 8:this.Mult['Holz']=1.3;this.Mult['Lehm']=1.3;this.Mult['Eisen']=1.3;break;case 9:this.Mult['Speicher']=1.5;break;default:break}this.EQ=1;this.EQCount=0;this.Points=-1;this.setTimeDiffs();if(saveAfter)this.Save()}function countRes(reportTime,Booty,reportID){var Ress=getValue('ResBooty','0.0.0..-1,-1,-1.0.0.0..-1,-1,-1').split('.');if(Ress.length!=10)Ress=[0,0,0,'','-1,-1,-1',0,0,0,'','-1,-1,-1'];var IDs;resToday=Ress[4].split(',');resYesterday=Ress[9].split(',');var tmpDate=$('serverDate').innerHTML.split('/');var dateToday=[parseInt(tmpDate[0].replace(/^0(\d)/,"$1")),parseInt(tmpDate[1].replace(/^0(\d)/,"$1")),parseInt(tmpDate[2])-2000];dateYesterday=getPrevDay(dateToday);var a=-1;if(reportTime[0]==dateToday[0]&&reportTime[1]==dateToday[1]&&reportTime[2]==dateToday[2]){if(resToday[0]==dateToday[0]&&resToday[1]==dateToday[1]&&resToday[2]==dateToday[2]){IDs=Ress[3].split(',');a=0}else if(resToday[0]==dateYesterday[0]&&resToday[1]==dateYesterday[1]&&resToday[2]==dateYesterday[2]){Ress=[Booty[0],Booty[1],Booty[2],reportID,dateToday[0]+','+dateToday[1]+','+dateToday[2],Ress[0],Ress[1],Ress[2],Ress[3],Ress[4]]}else{Ress=[Booty[0],Booty[1],Booty[2],reportID,dateToday[0]+','+dateToday[1]+','+dateToday[2],0,0,0,'',dateYesterday[0]+','+dateYesterday[1]+','+dateYesterday[2]]}}else if(reportTime[0]==dateYesterday[0]&&reportTime[1]==dateYesterday[1]&&reportTime[2]==dateYesterday[2]){if(resToday[0]==dateToday[0]&&resToday[1]==dateToday[1]&&resToday[2]==dateToday[2]){IDs=Ress[8].split(',');a=5}else if(resToday[0]==dateYesterday[0]&&resToday[1]==dateYesterday[1]&&resToday[2]==dateYesterday[2]){Ress=[0,0,0,'',dateToday[0]+','+dateToday[1]+','+dateToday[2],Ress[0],Ress[1],Ress[2],Ress[3],Ress[4]];IDs=Ress[8].split(',');a=5}else{Ress=[0,0,0,'',dateToday[0]+','+dateToday[1]+','+dateToday[2],Booty[0],Booty[1],Booty[2],reportID,dateYesterday[0]+','+dateYesterday[1]+','+dateYesterday[2]]}}else{a=-2}if(a>-1){var match=false;for(var i=0,max=IDs.length;i<max;++i){if(IDs[i]==reportID){match=true;break}}if(!match){IDs.push(reportID);Ress[a]=parseInt(Ress[a])+Booty[0];Ress[a+1]=parseInt(Ress[a+1])+Booty[1];Ress[a+2]=parseInt(Ress[a+2])+Booty[2];Ress[a+3]=IDs.join(',')}}if(a!=-2){setValue('ResBooty',Ress.join('.'))}}var op=1;var faderstyle='top: 110px; opacity: ';var fadeout=function fadeout(){if($('autoHideMsg').getAttribute('style')=='display:none')return;if(op==1){window.setTimeout(fadeout,1800)}else if(op>0){window.setTimeout(fadeout,12)}if(op<0){$('autoHideMsg').parentNode.removeChild($('autoHideMsg'));op=0}else if(op>0){$('autoHideMsg').setAttribute('style',faderstyle+op);op-=0.01}};function reportAnalyzer(){if(!$('attack_info_def')||!$('attack_info_def_units'))return 0;var tds=$('attack_info_def').getElementsByTagName('td');for(var i=0,max=tds.length-1;i<max;++i){if(tds[i].innerHTML.indexOf('Ziel:')!=-1&&tds[i+1]){tds[i+1].innerHTML.match(/">\s*(.+)\s+\((\d{1,3}\|\d{1,3})\)\s+K\d+/)}}if(!RegExp.$1){$('labelText').innerHTML.match(/(.+)\s+\((\d{1,3}\|\d{1,3})\)\s+K\d+/);if(!RegExp.$1||!RegExp.$2)return-1}var vName=RegExp.$1;vCoords=RegExp.$2.split('|');var tmp=false;var tds=document.getElementsByTagName('td');for(var i=0,max=tds.length;i<max;++i){if(tds[i].innerHTML&&trim(tds[i].innerHTML)=='Gesendet'){if(tds[i].parentNode.childNodes[1]){tmp=trim(tds[i].parentNode.childNodes[1].innerHTML);break}}}if(!tmp)return-2;var reportTime=tmp.replace(/\./g,'-').replace(' ','-').replace(/:/g,'-').split('-');if(reportTime.length!=6)return-2;reportTime=[parseInt(reportTime[0].replace(/^0/,'')),parseInt(reportTime[1].replace(/^0/,'')),parseInt(reportTime[2]),parseInt(reportTime[3].replace(/^0/,'')),parseInt(reportTime[4].replace(/^0/,'')),parseInt(reportTime[5].replace(/^0/,''))];var hReport=new Report(vCoords,reportTime);var Booty=[false,false,false,false];if($('attack_results')){var res=getNodeTextRecursively($('attack_results'),'|').split('|');var ramm=false;var kata=false;for(var i=0,max=res.length;i<max;++i){if(!Booty[3]&&res[i].match(/\d+\/(\d+)/)){Booty[3]=parseInt(RegExp.$1);if(res[i+1]=='.'){Booty[3]=Booty[3]*1000+parseInt(res[i+2])}if(res[i-1]=='.'){a=3}else{a=1}for(var j=0;j<3;++j){if(res[i-a-1]=='.'){Booty[2-j]=parseInt(res[i-a-2]+''+res[i-a]);a+=3}else{Booty[2-j]=parseInt(res[i-a]);a+=1}}}else if(!ramm&&res[i].match(/Wall besch.{1,2}digt von Level/)){hReport.setRam('Von',res[i+1]);ramm=true}else if(!kata&&trim(res[i]).match(/(.+) besch.{1,2}digt von Level/)){hReport.setRam('Building',RegExp.$1);hReport.setRam('Von',res[i+1]);kata=true}else if(res[i].indexOf('auf Level')!=-1){if(ramm){hReport.setRam('Nach',res[i+1]);ramm=false}else if(kata){hReport.setCata('Nach',res[i+1]);kata=false}}else if(res[i]=='Gesunken von'&&res[i+1]&&res[i+3]){hReport.setMood(res[i+3])}}}if(!Booty[0])Booty[0]=0;hReport.setRes('Beute Holz',Booty[0]);if(!Booty[1])Booty[1]=0;hReport.setRes('Beute Lehm',Booty[1]);if(!Booty[2])Booty[2]=0;hReport.setRes('Beute Eisen',Booty[2]);if(!window.UVActive){location.href.match(/view=(\d+)/);reportID=RegExp.$1;if(reportID){var tds=$('label').parentNode.parentNode.parentNode.getElementsByTagName('td');var match=false;for(var i=0,max=tds.length;i<max;++i){if(trim(tds[i].innerHTML)=='Weitergeleitet am:'){match=true;break}}if(!match){countRes(reportTime,Booty,reportID)}}}if($('attack_spy')==null&&(hReport.getLastDate('Y')==-1||hReport.getLastDate('M')==-1||hReport.getLastDate('d')==-1||hReport.getLastDate('H')==-1||hReport.getLastDate('m')==-1||hReport.getLastDate('s')==-1||reportTime[2]>hReport.getLastDate('Y')||(reportTime[2]==hReport.getLastDate('Y')&&reportTime[1]>hReport.getLastDate('M'))||(reportTime[2]==hReport.getLastDate('Y')&&reportTime[1]==hReport.getLastDate('M')&&reportTime[0]>hReport.getLastDate('d'))||(reportTime[2]==hReport.getLastDate('Y')&&reportTime[1]==hReport.getLastDate('M')&&reportTime[0]==hReport.getLastDate('d')&&reportTime[3]>hReport.getLastDate('H'))||(reportTime[2]==hReport.getLastDate('Y')&&reportTime[1]==hReport.getLastDate('M')&&reportTime[0]==hReport.getLastDate('d')&&reportTime[3]==hReport.getLastDate('H')&&reportTime[4]>hReport.getLastDate('m'))||(reportTime[2]==hReport.getLastDate('Y')&&reportTime[1]==hReport.getLastDate('M')&&reportTime[0]==hReport.getLastDate('d')&&reportTime[3]==hReport.getLastDate('H')&&reportTime[4]==hReport.getLastDate('m')&&reportTime[5]>hReport.getLastDate('s')))){hReport.setName(vName);if(Booty[3]>(Booty[0]+Booty[1]+Booty[2])){hReport.setRes(0)}else{tmp=hReport.getRes('Holz')-Booty[0];if(tmp<0)tmp=0;hReport.setRes('Holz',tmp);tmp=hReport.getRes('Lehm')-Booty[1];if(tmp<0)tmp=0;hReport.setRes('Lehm',tmp);tmp=hReport.getRes('Eisen')-Booty[2];if(tmp<0)tmp=0;hReport.setRes('Eisen',tmp)}hReport.setLastDate(reportTime);hReport.clearCata();hReport.clearRam();var units_table=$('attack_info_def_units');var units_nums=false;var units_loss_nums=false;var units_trs=units_table.getElementsByTagName('tr');for(var i=0,max=units_trs.length;i<max;++i){var tds=units_trs[i].getElementsByTagName('td');if(!tds)continue;for(var j=0,maxx=tds.length;j<maxx;++j){td=tds[j];if(td.innerHTML==null)continue;if(td.innerHTML.indexOf('Anzahl:')!=-1){units_nums=tds}else if(td.innerHTML.indexOf('Verluste:')!=-1){units_loss_nums=tds}}if(units_nums&&units_loss_nums)break}hReport.clearTroops();a=1;for(var i=0,max=units_nums.length;i<max;++i){units_num=units_nums[i];units_loss_num=units_loss_nums[i];innerHTML1=units_num.innerHTML;innerHTML2=units_loss_num.innerHTML;if(a==1&&innerHTML1.indexOf('Anzahl:')!=-1&&innerHTML2.indexOf('Verluste:')!=-1)a=i+1;class1=units_num.getAttribute('class');class2=units_loss_num.getAttribute('class');if(class1&&class1.indexOf('unit-item')!=-1&&class2&&class2.indexOf('unit-item')!=-1){hReport.setTroops(units[i-a],parseInt(innerHTML1)-parseInt(innerHTML2))}}hReport.Save();return 1}else if($('attack_spy')&&(hReport.getSpyDate('Y')==-1||hReport.getSpyDate('M')==-1||hReport.getSpyDate('d')==-1||hReport.getSpyDate('H')==-1||hReport.getSpyDate('m')==-1||hReport.getSpyDate('s')==-1||reportTime[2]>hReport.getSpyDate('Y')||(reportTime[2]==hReport.getSpyDate('Y')&&reportTime[1]>hReport.getSpyDate('M'))||(reportTime[2]==hReport.getSpyDate('Y')&&reportTime[1]==hReport.getSpyDate('M')&&reportTime[0]>hReport.getSpyDate('d'))||(reportTime[2]==hReport.getSpyDate('Y')&&reportTime[1]==hReport.getSpyDate('M')&&reportTime[0]==hReport.getSpyDate('d')&&reportTime[3]>hReport.getSpyDate('H'))||(reportTime[2]==hReport.getSpyDate('Y')&&reportTime[1]==hReport.getSpyDate('M')&&reportTime[0]==hReport.getSpyDate('d')&&reportTime[3]==hReport.getSpyDate('H')&&reportTime[4]>hReport.getSpyDate('m'))||(reportTime[2]==hReport.getSpyDate('Y')&&reportTime[1]==hReport.getSpyDate('M')&&reportTime[0]==hReport.getSpyDate('d')&&reportTime[3]==hReport.getSpyDate('H')&&reportTime[4]==hReport.getSpyDate('m')&&reportTime[5]>hReport.getSpyDate('s')))){hReport.setSpyDate(reportTime);hReport.setName(vName);hReport.clearCata();hReport.clearRam();var buildings_els,units_out;hReport.clearRes();ths=$('attack_spy').getElementsByTagName('th');for(var i=0,max=ths.length;i<max;++i){th=ths[i];if(!th.firstChild)continue;if(!th.firstChild.nodeValue)continue;if(th.innerHTML.match(/Ersp.{1,2}hte\s+Rohstoffe:/)){imgs=th.nextSibling.getElementsByTagName('img');var wood=0;var loam=0;var iron=0;var loop=true;var j=-1;var maxj=imgs.length;for(var j=0,maxx=imgs.length;(j<maxx)&&loop;++j){img=imgs[j];if(resCheck[img.getAttribute('title')]){var els=img.parentNode.childNodes;for(var k=0,maxk=els.length-1;k<maxk;++k){el=els[k];if(el.nodeType==1){elTitle=el.getAttribute('title');if(resCheck[elTitle]){if(els[k+2]&&els[k+2].getAttribute('class')=='grey'){hReport.setRes(elTitle,parseInt(trim(els[k+1].nodeValue)+trim(els[k+3].nodeValue)))}else{hReport.setRes(elTitle,trim(els[k+1].nodeValue))}}}}loop=false}}}else if(th.innerHTML.match(/Geb.{1,2}ude:/)){buildings_els=th.nextSibling}else if(th.innerHTML.match(/Einheiten\s+au.{1,2}erhalb:/)){var nextS=th.parentNode.nextSibling;while(nextS.nodeType!=1){nextS=nextS.nextSibling}units_out=nextS.getElementsByTagName('table')[0].getElementsByTagName('tr')[1].getElementsByTagName('td')}}hReport.clearBuildings();buildings_els=buildings_els.innerHTML.replace(/\n/g,'').replace(/\r/g,'').replace(/\t/g,'').replace(/\v/g,'').replace(/\f/g,'').replace(/\s*<\s*\/\s*b\s*>\s*<\s*br\s*\/?\s*>\s*/g,'</b>');buildings_els=buildings_els.split('</b>');for(var i=0,max=buildings_els.length;i<max;++i){if(!buildings_els[i])continue;tmp=trim(buildings_els[i]).split('<b>');hReport.setBuilding(trim(tmp[0]),tmp[1].match(/\(Stufe (\d+)\)/)[1])}var units_table=$('attack_info_def_units'),units_nums,units_loss_nums,units_trs=units_table.getElementsByTagName('tr');for(var i=0,max=units_trs.length;i<max&&(!units_nums||!units_loss_nums);++i){var tds=units_trs[i].getElementsByTagName('td');if(units_trs[i].innerHTML.indexOf('Anzahl:')!=-1){units_nums=tds}else if(units_trs[i].innerHTML.indexOf('Verluste:')!=-1){units_loss_nums=tds}}hReport.clearTroops();a=1;for(var i=0,max=units_nums.length;i<max;++i){units_num=units_nums[i];units_loss_num=units_loss_nums[i];if(a==1&&units_num.innerHTML.indexOf('Anzahl:')!=-1&&units_loss_num.innerHTML.indexOf('Verluste:')!=-1)a=i+1;class1=units_num.getAttribute('class');class2=units_loss_num.getAttribute('class');unitsCount=null;if(class1&&class1.indexOf('unit-item')!=-1&&class2&&class2.indexOf('unit-item')!=-1){unitsCount=parseInt(units_num.innerHTML)-parseInt(units_loss_num.innerHTML)}if(units_out&&units_out[i]){class3=units_out[i].getAttribute('class');if(class3&&class3.indexOf('unit-item')!=-1){if(unitsCount===null){unitsCount=0}unitsCount+=parseInt(units_out[i].innerHTML)}}if(unitsCount!==null){hReport.setTroops(units[i-a],unitsCount)}}hReport.Save();var coords=getValue('Village[coords]',false),sCoord=vCoords[0]+'|'+vCoords[1];if(coords){coords=coords.split(',');var match=false;for(var i=0,max=coords.length;i<max;++i){if(coords[i]==sCoord){match=true;break}}if(!match){coords[coords.length]=sCoord}setValue('Village[coords]',coords.join(','))}else{setValue('Village[coords]',sCoord)}return 1}else if($('attack_spy')==null&&reportTime[2]==hReport.getLastDate('Y')&&reportTime[1]==hReport.getLastDate('M')&&reportTime[0]==hReport.getLastDate('d')&&reportTime[3]==hReport.getLastDate('H')&&reportTime[4]==hReport.getLastDate('m')&&reportTime[5]==hReport.getLastDate('s')||$('attack_spy')&&reportTime[2]==hReport.getSpyDate('Y')&&reportTime[1]==hReport.getSpyDate('M')&&reportTime[0]==hReport.getSpyDate('d')&&reportTime[3]==hReport.getSpyDate('H')&&reportTime[4]==hReport.getSpyDate('m')&&reportTime[5]==hReport.getSpyDate('s')){return 2}else{return 3}return true}function reports(){var tr=document.createElement('tr');var td=document.createElement('td');td.setAttribute('colspan','3');td.setAttribute('style','text-align: right;');var select=document.createElement('select');var option=document.createElement('option');option.setAttribute('value','0');option.innerHTML='- Einfaches Einlesen -';select.appendChild(option);var option=document.createElement('option');option.setAttribute('value','1');var text=document.createTextNode('Veraltete Berichte löschen');option.appendChild(text);select.appendChild(option);select.addEventListener('change',function(e){if(this.value=='0'){document.getElementById('ReportButton').addEventListener('click',function(e){setValue('readingReports','1,0');ths=document.getElementsByTagName('th');for(var i=0,max=ths.length;i<max;++i){th=ths[i];if(th.innerHTML=='Betreff'&&th.parentNode&&th.parentNode.parentNode&&th.parentNode.parentNode.getElementsByTagName('tr')&&th.parentNode.parentNode.getElementsByTagName('tr')[2]&&th.parentNode.parentNode.getElementsByTagName('tr')[2].getElementsByTagName('td')&&th.parentNode.parentNode.getElementsByTagName('tr')[2].getElementsByTagName('td')[0]&&th.parentNode.parentNode.getElementsByTagName('tr')[2].getElementsByTagName('td')[0].getElementsByTagName('a')&&th.parentNode.parentNode.getElementsByTagName('tr')[2].getElementsByTagName('td')[0].getElementsByTagName('a')[0]){location.href=th.parentNode.parentNode.getElementsByTagName('tr')[2].getElementsByTagName('td')[0].getElementsByTagName('a')[0].getAttribute('href');break}}},false)}else if(this.value=='1'){document.getElementById('ReportButton').addEventListener('click',function(e){setValue('readingReports','1,1');ths=document.getElementsByTagName('th');for(var i=0,max=ths.length;i<max;++i){th=ths[i];if(th.innerHTML=='Betreff'&&th.parentNode&&th.parentNode.parentNode&&th.parentNode.parentNode.getElementsByTagName('tr')&&th.parentNode.parentNode.getElementsByTagName('tr')[2]&&th.parentNode.parentNode.getElementsByTagName('tr')[2].getElementsByTagName('td')&&th.parentNode.parentNode.getElementsByTagName('tr')[2].getElementsByTagName('td')[0]&&th.parentNode.parentNode.getElementsByTagName('tr')[2].getElementsByTagName('td')[0].getElementsByTagName('a')&&th.parentNode.parentNode.getElementsByTagName('tr')[2].getElementsByTagName('td')[0].getElementsByTagName('a')[0]){location.href=th.parentNode.parentNode.getElementsByTagName('tr')[2].getElementsByTagName('td')[0].getElementsByTagName('a')[0].getAttribute('href');break}}},false)}},false);td.appendChild(select);var input=document.createElement('input');input.setAttribute('id','ReportButton');input.setAttribute('type','button');input.setAttribute('value','Berichte einlesen');input.addEventListener('click',function(e){setValue('readingReports','1,0');ths=document.getElementsByTagName('th');for(var i=0,max=ths.length;i<max;++i){th=ths[i];if(th.innerHTML=='Betreff'&&th.parentNode&&th.parentNode.parentNode&&th.parentNode.parentNode.getElementsByTagName('tr')&&th.parentNode.parentNode.getElementsByTagName('tr')[2]&&th.parentNode.parentNode.getElementsByTagName('tr')[2].getElementsByTagName('td')&&th.parentNode.parentNode.getElementsByTagName('tr')[2].getElementsByTagName('td')[0]&&th.parentNode.parentNode.getElementsByTagName('tr')[2].getElementsByTagName('td')[0].getElementsByTagName('a')&&th.parentNode.parentNode.getElementsByTagName('tr')[2].getElementsByTagName('td')[0].getElementsByTagName('a')[0]){location.href=th.parentNode.parentNode.getElementsByTagName('tr')[2].getElementsByTagName('td')[0].getElementsByTagName('a')[0].getAttribute('href');break}}},false);td.appendChild(input);tr.appendChild(td);var ths=$('content_value').getElementsByTagName('th');var added=false;for(var i=0,max=ths.length;i<max&&!added;++i){if(ths[i].innerHTML=='Betreff'){el=ths[i].parentNode;el.parentNode.insertBefore(tr,el);added=true}}}function villageInfos(){var tds=document.getElementsByTagName('td');var points_td;for(var i=0,max=tds.length;i<max;++i){td=tds[i];childNode=td.parentNode.childNodes[1];if(td.innerHTML=='Koordinaten:'){if(childNode){vCoords=trim(childNode.innerHTML).split('|');vCoords=[parseInt(vCoords[0]),parseInt(vCoords[1])]}}else if(td.innerHTML=='Punkte:'){points_td=childNode}}if(!vCoords)return;var tds=$('menu_row2').getElementsByTagName('td');for(var i=0,max=tds.length;i<max;++i){td=tds[i];innerHTML=td.innerHTML;if(td.getAttribute('class')=='box-item'&&innerHTML&&innerHTML.match(/\(\d\d?\d?\|\d\d?\d?\)\s*K\d\d?/)){var tmp=innerHTML.search(/\(\d\d?\d?\|\d\d?\d?\)\s+K\d\d?/);hCoords=innerHTML.substr(tmp+1,7).split('|');hCoords=[parseInt(hCoords[0]),parseInt(hCoords[1])];break}}if(!hCoords)return;var coordDiff=Math.sqrt(Math.pow(hCoords[0]-vCoords[0],2)+Math.pow(hCoords[1]-vCoords[1],2));var hReport=new Report(vCoords);if(hReport.SpyReportDate['Y']!=-1&&hReport.SpyReportDate['M']!=-1&&hReport.SpyReportDate['d']!=-1&&hReport.SpyReportDate['H']!=-1&&hReport.SpyReportDate['m']!=-1&&hReport.SpyReportDate['s']!=-1){var spans=document.getElementsByTagName('span');for(var i=0,max=spans.length;i<max;++i){spanClass=spans[i].getAttribute('class');if(!spanClass)continue;spanClass.match(/bonus_icon bonus_icon_(\d)/);if(RegExp.$1){hReport.setBonus(RegExp.$1);break}}var momPoints=0;var tmp=points_td.innerHTML.split('<span class="grey">.</span>');if(tmp.length==2){momPoints=parseInt(trim(tmp[0])+trim(tmp[1]))}else{momPoints=parseInt(trim(tmp[0]))}pointsDiff=momPoints-hReport.getPoints();html='';if(momPoints>999){momPointsT=Math.floor(momPoints/1000);momPoints-=momPointsT*1000;html=momPointsT+'<span class="grey">.</span>';if(momPoints<10){html+='00'}else if(momPoints<100){html+='0'}}html+=momPoints;html+=' <span style="font-size: 90%;';if(pointsDiff>0){html+=' color: green;">+'}else if(pointsDiff<0){html+=' color: red;">'}else{html+='">±'}html+=pointsDiff+'</span>';points_td.innerHTML=html;var table=document.createElement('table');table.setAttribute('class','vis');table.setAttribute('style','width: 100%;');var tr=document.createElement('tr');var th=document.createElement('th');th.innerHTML='Jetzt möglich:';tr.appendChild(th);var td=document.createElement('td');var td_img=document.createElement('img');td_img.setAttribute('src','graphic/holz.png');td_img.setAttribute('title','Holz');td.appendChild(td_img);var wood=hReport.getRes('Holz');var td_span=document.createElement('span');td_span.setAttribute('title',hReport.getRes('Holzproduktion'));if(hReport.getResWarn('Holz',1)){td_span.setAttribute('class','warn')}else if(hReport.getResWarn('Holz',0.9)){td_span.setAttribute('class','warn_90')}if(wood>999){var td_text=document.createTextNode(Math.floor(wood/1000));td_span.appendChild(td_text);var td_grey=document.createElement('span');td_grey.setAttribute('class','grey');var td_grey_text=document.createTextNode('.');td_grey.appendChild(td_grey_text);td_span.appendChild(td_grey);var wood=(wood-Math.floor(wood/1000)*1000);if(wood<10){wood='00'+wood}else if(wood<100){wood='0'+wood}}var td_text=document.createTextNode(wood+' ');td_span.appendChild(td_text);td.appendChild(td_span);var td_img=document.createElement('img');td_img.setAttribute('src','graphic/lehm.png');td_img.setAttribute('title','Lehm');td.appendChild(td_img);var loam=hReport.getRes('Lehm');var td_span=document.createElement('span');td_span.setAttribute('title',hReport.getRes('Lehmproduktion'));if(hReport.getResWarn('Lehm',1)){td_span.setAttribute('class','warn')}else if(hReport.getResWarn('Lehm',0.9)){td_span.setAttribute('class','warn_90')}if(loam>999){var td_text=document.createTextNode(Math.floor(loam/1000));td_span.appendChild(td_text);var td_grey=document.createElement('span');td_grey.setAttribute('class','grey');var td_grey_text=document.createTextNode('.');td_grey.appendChild(td_grey_text);td_span.appendChild(td_grey);var loam=(loam-Math.floor(loam/1000)*1000);if(loam<10){loam='00'+loam}else if(loam<100){loam='0'+loam}}var td_text=document.createTextNode(loam+' ');td_span.appendChild(td_text);td.appendChild(td_span);var td_img=document.createElement('img');td_img.setAttribute('src','graphic/eisen.png');td_img.setAttribute('title','Eisen');td.appendChild(td_img);var iron=hReport.getRes('Eisen');var td_span=document.createElement('span');td_span.setAttribute('title',hReport.getRes('Eisenproduktion'));if(hReport.getResWarn('Eisen',1)){td_span.setAttribute('class','warn')}else if(hReport.getResWarn('Eisen',0.9)){td_span.setAttribute('class','warn_90')}if(iron>999){var td_text=document.createTextNode(Math.floor(iron/1000));td_span.appendChild(td_text);var td_grey=document.createElement('span');td_grey.setAttribute('class','grey');var td_grey_text=document.createTextNode('.');td_grey.appendChild(td_grey_text);td_span.appendChild(td_grey);var iron=(iron-Math.floor(iron/1000)*1000);if(iron<10){iron='00'+iron}else if(iron<100){iron='0'+iron}}var td_text=document.createTextNode(iron+' ');td_span.appendChild(td_text);td.appendChild(td_span);tr.appendChild(td);table.appendChild(tr);if(hReport.getMood()<100){var tr=document.createElement('tr');tr.innerHTML='<th>Zustimmung:</th><td>'+hReport.getMood()+'</td>';table.appendChild(tr)}var tr=document.createElement('tr');var th=document.createElement('th');th.innerHTML='Gebäude:<br><span style="font-size: 80%">'+hReport.getSpyDate('d.M. H:m:s')+'</span>';tr.appendChild(th);var td=document.createElement('td');html='<table>';line1=line2='';for(var i=0;i<17;++i){if(hReport.getBuilding(buildingsIndex[i])>0){line1+='<td style="text-align: center; width: 25px;'+((line1!='')?' border-left: 1px dashed #C1A264;':'')+'"><img src="'+buildingImgUrl.replace('$',buildingImg[i])+'"></td>';line2+='<td style="text-align: center;'+((line2!='')?' border-left: 1px dashed #C1A264;':'')+'">'+hReport.getBuilding(buildingsIndex[i])+'</td>'}}var wallLevel=hReport.getBuilding('Wall');if(wallLevel>0){line1+='<td style="text-align: center; width: 25px;'+((line1!='')?' border-left: 1px dashed #C1A264;':'')+'"><img src="'+buildingImgUrl.replace('$',buildingImg[17])+'"></td>';if(wallLevel>4){line2+='<td style="text-align: center;'+((line2!='')?' border-left: 1px dashed #C1A264;':'')+'"><span class="'+((wallLevel>9)?'warn':'warn_90')+'">'+wallLevel+'</span></td>'}else{line2+='<td style="text-align: center;'+((line2!='')?' border-left: 1px dashed #C1A264;':'')+'">'+wallLevel+'</td>'}}td.innerHTML='<table><tr>'+line1+'</tr><tr>'+line2+'</tr></table>';tr.appendChild(td);table.appendChild(tr);var tr=document.createElement('tr');var th=document.createElement('th');th.innerHTML='Truppen:<br><span style="font-size: 80%">'+hReport.getSpyDate('d.M. H:m:s')+'</span>';tr.appendChild(th);var td=document.createElement('td');line1='';line2='';for(var i=0,max=units.length;i<max;++i){unit=units[i];line1+='<td style="text-align: center; width: 25px;'+((line1!='')?'border-left: 1px dashed #C1A264;':'')+'"><img src="'+unitImgUrl.replace('$',unitImg[i])+'" title="'+unit+'" alt="'+unit+'"></td>';line2+='<td style="text-align: center;'+((line2!='')?' border-left: 1px dashed #C1A264;':'')+'" class="unit-item';if(hReport.getTroops(unit)==0){line2+=' hidden'}line2+='">'+hReport.getTroops(unit)+'</td>'}td.innerHTML='<table><tr>'+line1+'</tr><tr>'+line2+'</tr></table>';tr.appendChild(td);table.appendChild(tr);$('content_value').getElementsByTagName('table')[0].firstChild.firstChild.lastChild.appendChild(table)}}function popupClose(e){style=$('inline_popup').getAttribute('style');if(style.match('display: none;')){$('inline_popup').setAttribute('style',style.replace(/width:\s*\d+px;/,''));this.removeEventListener("mouseup",popupClose)}else{window.setTimeout('popupClose('+e+')',500)}}var FarmRows=[],AttackRows=[];function farmList(){hCoords=false;var tds=$('menu_row2').getElementsByTagName('td');for(var i=0,max=tds.length;i<max;++i){td=tds[i];innerHTML=td.innerHTML;if(td.getAttribute('class')=='box-item'&&innerHTML&&innerHTML.match(/\(\d\d?\d?\|\d\d?\d?\)\s*K\d\d?/)){var tmp=innerHTML.search(/\(\d\d?\d?\|\d\d?\d?\)\s+K\d\d?/);hCoords=innerHTML.substr(tmp+1,7).split('|');hCoords=[parseInt(hCoords[0]),parseInt(hCoords[1])];break}}if(!hCoords)return;var attackTable;var tables=$('units_form').parentNode.getElementsByTagName('table');for(var i=0,max=tables.length;i<max;++i){table=tables[i];if(table.getAttribute('class')=='vis'){var ths=table.getElementsByTagName('th');for(var j=0,maxx=ths.length;j<maxx;++j){if(ths[j].innerHTML.indexOf('Eigene Befehle')!=-1){attackTable=table;break}}}}var attacks='';if(attackTable){var fail=false;var a=0;var tds=attackTable.getElementsByTagName('td');for(var i=0,max=tds.length;i<max;++i){innerHTML=tds[i].innerHTML;if(innerHTML.match(/<img\s+src="http:\/\/cdn\.tribalwars\.net\/graphic\/command\/attack\.png\?1".+>/)){innerHTML.match(/\((\d\d?\d?\|\d\d?\d?)\)\s+K\d\d?/);try{if(attacks!='')attacks+=',';attacks+=RegExp.$1}catch(e){fail=true}}}if(fail){alert('Es konnten nicht alle Angriffe eingelesen werden, weil Einige umbenannt wurden!')}}var home=hCoords[0]+'|'+hCoords[1];attacksFrom=getValue('attacksFrom',false);if(attacksFrom){attacksFrom=attacksFrom.split('.');var pos=attacksFrom.length;for(var i=0;i<pos;++i){if(attacksFrom[i]==home){pos=i}}attacksList=getValue('attacksLists',false);if(attacksList){attacksList=attacksList.split('.');attacksFrom[pos]=home;attacksFrom=attacksFrom.join('.');attacksList[pos]=attacks;attacksTo=attacksList.join('.')}else{attacksFrom=home;attacksTo=attacks}}else{attacksFrom=home;attacksTo=attacks}setValue('attacksFrom',attacksFrom);setValue('attacksLists',attacksTo);attacks=attacksTo;var tableForm=false;var tables=$('units_form').getElementsByTagName('table');for(var i=tables.length-1;i>-1;--i){table=tables[i];var match=false;var tds=table.getElementsByTagName('td');for(var j=0,max=tds.length;(j<max)&&!match;++j){innerHTML=tds[j].innerHTML;match=(innerHTML&&innerHTML.indexOf('Eigene')!=-1)}if(match){tableForm=table;break}}if(!tableForm)return;var tr=document.createElement('tr');tableForm.appendChild(tr);var tr=document.createElement('tr');var td=document.createElement('td');td.setAttribute('colspan','6');var a=document.createElement('a');a.setAttribute('id','FarmmanagerLink');var text=document.createTextNode('» Farmmanager');a.appendChild(text);a.setAttribute('href','javascript:;');a.addEventListener('click',function(event){$('inline_popup_content').innerHTML='<table><tbody><tr><td><img src="graphic/throbber.gif" alt=""></td><td>Lade Informationen ...</td></tr></tbody></table>';var popup=$('inline_popup'),pos={x:getPosX($('units_form')),y:getPosY(this)+18};popup.setAttribute('class','popup_style ui-draggable');as=$('inline_popup_menu').getElementsByTagName('a');for(var i=0,max=as.length;i<max;++i){if(as[i].innerHTML.match(/schlie.{1,2}en/)){as[i].addEventListener('mouseup',popupClose,false);break}}popup.setAttribute('style','display: block; left: '+pos.x+'px; top: '+pos.y+'px; width: '+(($('units_form').offsetWidth<690)?690:$('units_form').offsetWidth)+'px;');window.setTimeout(function(){hCoords=hCoords;var coords=getValue('Village[coords]',false);if(coords){coords=coords.split(',')}var table=document.createElement('table');table.setAttribute('id','farmTable');table.setAttribute('class','vis');table.setAttribute('width','100%');var sortCol=getValue('FarmSort','3-1');function sortColFunc(e){var num=e.target.getAttribute('id').match(/FarmCol-(\d+-\d+)/)[1],sortCol=getValue('FarmSort','3-1');if(sortCol!=num){$('FarmCol-'+sortCol).setAttribute('style','color: #808080;');this.setAttribute('style','color: #000000;');setValue('FarmSort',num)}raiseEvent('click',$('FarmmanagerLink'))}var tr=document.createElement('tr');var th=document.createElement('th');th.setAttribute('style','width: 14px;');tr.appendChild(th);var th=document.createElement('th');th.innerHTML='x|y ('+coords.length+')';tr.appendChild(th);var th=document.createElement('th');th.setAttribute('style','text-align: right;');var span=document.createElement('span');span.setAttribute('class','icon header wood');span.setAttribute('title','Holz');span.appendChild(document.createTextNode(' '));th.appendChild(span);th.appendChild(document.createTextNode(' '));var a=document.createElement('a');a.setAttribute('id','FarmCol-0-0');a.setAttribute('style','color: #'+((sortCol=='0-0')?'000000;':'808080;'));a.setAttribute('href','javascript:;');a.appendChild(document.createTextNode('▲'));a.addEventListener('click',sortColFunc,false);th.appendChild(a);var a=document.createElement('a');a.setAttribute('id','FarmCol-0-1');a.setAttribute('style','color: #'+((sortCol=='0-1')?'000000;':'808080;'));a.setAttribute('href','javascript:;');a.appendChild(document.createTextNode('▼'));a.addEventListener('click',sortColFunc,false);th.appendChild(a);tr.appendChild(th);var th=document.createElement('th');th.setAttribute('style','text-align: right;');var span=document.createElement('span');span.setAttribute('class','icon header stone');span.setAttribute('title','Lehm');span.appendChild(document.createTextNode(' '));th.appendChild(span);th.appendChild(document.createTextNode(' '));var a=document.createElement('a');a.setAttribute('id','FarmCol-1-0');a.setAttribute('style','color: #'+((sortCol=='1-0')?'000000;':'808080;'));a.setAttribute('href','javascript:;');a.appendChild(document.createTextNode('▲'));a.addEventListener('click',sortColFunc,false);th.appendChild(a);var a=document.createElement('a');a.setAttribute('id','FarmCol-1-1');a.setAttribute('style','color: #'+((sortCol=='1-1')?'000000;':'808080;'));a.setAttribute('href','javascript:;');a.appendChild(document.createTextNode('▼'));a.addEventListener('click',sortColFunc,false);th.appendChild(a);tr.appendChild(th);var th=document.createElement('th');th.setAttribute('style','text-align: right;');var span=document.createElement('span');span.setAttribute('class','icon header iron');span.setAttribute('title','Eisen');span.appendChild(document.createTextNode(' '));th.appendChild(span);th.appendChild(document.createTextNode(' '));var a=document.createElement('a');a.setAttribute('id','FarmCol-2-0');a.setAttribute('style','color: #'+((sortCol=='2-0')?'000000;':'808080;'));a.setAttribute('href','javascript:;');a.appendChild(document.createTextNode('▲'));a.addEventListener('click',sortColFunc,false);th.appendChild(a);var a=document.createElement('a');a.setAttribute('id','FarmCol-2-1');a.setAttribute('style','color: #'+((sortCol=='2-1')?'000000;':'808080;'));a.setAttribute('href','javascript:;');a.appendChild(document.createTextNode('▼'));a.addEventListener('click',sortColFunc,false);th.appendChild(a);tr.appendChild(th);var th=document.createElement('th');th.setAttribute('style','text-align: right;');var span=document.createElement('span');span.setAttribute('class','icon header ressources');span.setAttribute('title','Gesamt');span.appendChild(document.createTextNode(' '));th.appendChild(span);th.appendChild(document.createTextNode(' '));var a=document.createElement('a');a.setAttribute('id','FarmCol-3-0');a.setAttribute('style','color: #'+((sortCol=='3-0')?'000000;':'808080;'));a.setAttribute('href','javascript:;');a.appendChild(document.createTextNode('▲'));a.addEventListener('click',sortColFunc,false);th.appendChild(a);var a=document.createElement('a');a.setAttribute('id','FarmCol-3-1');a.setAttribute('style','color: #'+((sortCol=='3-1')?'000000;':'808080;'));a.setAttribute('href','javascript:;');a.appendChild(document.createTextNode('▼'));a.addEventListener('click',sortColFunc,false);th.appendChild(a);tr.appendChild(th);var th=document.createElement('th');th.setAttribute('style','text-align: right;');var img=document.createElement('img');img.setAttribute('src','graphic/command/attack.png');img.setAttribute('alt','Frei?');img.setAttribute('title','Keine Truppen in der Farm?');th.appendChild(img);tr.appendChild(th);var th=document.createElement('th');th.setAttribute('style','text-align: right;');var img=document.createElement('img');img.setAttribute('src','graphic/unit/unit_spear.png');img.setAttribute('alt','Speer');img.setAttribute('title','max. nötige Speere für die Rohstoffe zum Zeitpunkt ihrer Ankunft');th.appendChild(img);tr.appendChild(th);var th=document.createElement('th');th.setAttribute('style','text-align: right;');var img=document.createElement('img');img.setAttribute('src','graphic/unit/unit_light.png');img.setAttribute('alt','LKav');img.setAttribute('title','max. nötige LKav für die Rohstoffe zum Zeitpunkt ihrer Ankunft');th.appendChild(img);tr.appendChild(th);var th=document.createElement('th');th.setAttribute('style','text-align: right;');var img=document.createElement('img');img.setAttribute('src','http://help.die-staemme.de/images/9/94/Speed.png');img.setAttribute('alt','Entfernung');img.setAttribute('title','Entfernung');th.appendChild(img);th.appendChild(document.createTextNode(' '));var a=document.createElement('a');a.setAttribute('id','FarmCol-4-0');a.setAttribute('style','color: #'+((sortCol=='4-0')?'000000;':'808080;'));a.setAttribute('href','javascript:;');a.appendChild(document.createTextNode('▲'));a.addEventListener('click',sortColFunc,false);th.appendChild(a);var a=document.createElement('a');a.setAttribute('id','FarmCol-4-1');a.setAttribute('style','color: #'+((sortCol=='4-1')?'000000;':'808080;'));a.setAttribute('href','javascript:;');a.appendChild(document.createTextNode('▼'));a.addEventListener('click',sortColFunc,false);th.appendChild(a);tr.appendChild(th);var th=document.createElement('th');th.setAttribute('style','text-align: right;');var img=document.createElement('img');img.setAttribute('src','graphic/buildings/wall.png');img.setAttribute('alt','Wall');img.setAttribute('title','Wall');th.appendChild(img);th.appendChild(document.createTextNode(' '));var a=document.createElement('a');a.setAttribute('id','FarmCol-5-0');a.setAttribute('style','color: #'+((sortCol=='5-0')?'000000;':'808080;'));a.setAttribute('href','javascript:;');a.appendChild(document.createTextNode('▲'));a.addEventListener('click',sortColFunc,false);th.appendChild(a);var a=document.createElement('a');a.setAttribute('id','FarmCol-5-1');a.setAttribute('style','color: #'+((sortCol=='5-1')?'000000;':'808080;'));a.setAttribute('href','javascript:;');a.appendChild(document.createTextNode('▼'));a.addEventListener('click',sortColFunc,false);th.appendChild(a);tr.appendChild(th);var th=document.createElement('th');th.setAttribute('style','text-align: right;');th.appendChild(document.createTextNode('Alter '));var a=document.createElement('a');a.setAttribute('id','FarmCol-6-0');a.setAttribute('style','color: #'+((sortCol=='6-0')?'000000;':'808080;'));a.setAttribute('href','javascript:;');a.appendChild(document.createTextNode('▲'));a.addEventListener('click',sortColFunc,false);th.appendChild(a);var a=document.createElement('a');a.setAttribute('id','FarmCol-6-1');a.setAttribute('style','color: #'+((sortCol=='6-1')?'000000;':'808080;'));a.setAttribute('href','javascript:;');a.appendChild(document.createTextNode('▼'));a.addEventListener('click',sortColFunc,false);th.appendChild(a);tr.appendChild(th);var th=document.createElement('th');th.setAttribute('style','width: 15px;');tr.appendChild(th);table.appendChild(tr);FarmRows=[];AttackRows=[];var trAttackColor='#D4C4AC';for(var i=0,max=coords.length;i<max;++i){rowArr=[];rowArr[0]=null;coord=coords[i];var attack=(attacks.indexOf(coord)!=-1);tmp=coord.split('|');var vCoords;vCoords=[parseInt(tmp[0]),parseInt(tmp[1])];var hReport=new Report(vCoords);var coordDiff=Math.round(Math.sqrt(Math.pow(hCoords[0]-vCoords[0],2)+Math.pow(hCoords[1]-vCoords[1],2))*10)/10;var tr=document.createElement('tr');tr.addEventListener('mouseover',function(e){var td=this.firstChild;var color=(td.innerHTML.match(/attack/))?'#DFCFAF':'#FFF4CC';do{style=td.getAttribute('style');if(style){if(style.match(/background-color: #.{6}/)){td.setAttribute('style',style.replace(/background-color: #.{6}/,'background-color: '+color))}else{td.setAttribute('style',style+'; background-color: '+color)}}else{td.setAttribute('style','background-color: '+color)}}while(td=td.nextSibling)},false);tr.addEventListener('mouseout',function(e){var td=this.firstChild;var color=td.innerHTML.match(/attack/)?'#D4C4AC':'#F4E4BC';do{style=td.getAttribute('style');if(style){if(style.match(/background-color: #.{6}/)){td.setAttribute('style',style.replace(/background-color: #.{6}/,'background-color: '+color))}else{td.setAttribute('style',style+'; background-color: '+color)}}else{td.setAttribute('style','background-color: '+color)}}while(td=td.nextSibling)},false);var td=document.createElement('td');if(attack){td.setAttribute('style','background-color: '+trAttackColor+';');td.innerHTML='<img src="graphic/command/attack.png" alt="">'}tr.appendChild(td);var td=document.createElement('td');if(attack)td.setAttribute('style','background-color: '+trAttackColor+';');var a=document.createElement('a');a.setAttribute('href','javascript:selectTarget('+vCoords[0]+', '+vCoords[1]+', "")');a.addEventListener('click',function(e){if($('unit_input_spy').value=='0'||$('unit_input_spy').value==''){var els=$('unit_input_spy').parentNode.childNodes;for(var i=els.length-1;i>-1;--i){el=els[i];if(el.nodeType==1){maxAvailable=parseInt(el.innerHTML.replace('(','').replace(')',''));if(maxAvailable>0){$('unit_input_spy').value='1'}break}}}},false);a.setAttribute('title',hReport.getName());a.innerText=vCoords[0]+'|'+vCoords[1];td.appendChild(a);tr.appendChild(td);var td=document.createElement('td');if(attack){td.setAttribute('style','background-color: '+trAttackColor+'; text-align: right;')}else{td.setAttribute('style','text-align: right;')}if(hReport.getResWarn('Holz',1)){td.innerHTML='<span class="warn">'+hReport.getRes('Holz')+'</span>'}else if(hReport.getResWarn('Holz',0.9)){td.innerHTML='<span class="warn_90">'+hReport.getRes('Holz')+'</span>'}else{td.innerHTML=hReport.getRes('Holz')}rowArr[1]=hReport.getRes('Holz');tr.appendChild(td);var td=document.createElement('td');if(attack){td.setAttribute('style','background-color: '+trAttackColor+'; text-align: right;')}else{td.setAttribute('style','text-align: right;')}if(hReport.getResWarn('Lehm',1)){td.innerHTML='<span class="warn">'+hReport.getRes('Lehm')+'</span>'}else if(hReport.getResWarn('Lehm',0.9)){td.innerHTML='<span class="warn_90">'+hReport.getRes('Lehm')+'</span>'}else{td.innerHTML=hReport.getRes('Lehm')}rowArr[2]=hReport.getRes('Lehm');tr.appendChild(td);var td=document.createElement('td');if(attack){td.setAttribute('style','background-color: '+trAttackColor+'; text-align: right;')}else{td.setAttribute('style','text-align: right;')}if(hReport.getResWarn('Eisen',1)){td.innerHTML='<span class="warn">'+hReport.getRes('Eisen')+'</span>'}else if(hReport.getResWarn('Eisen',0.9)){td.innerHTML='<span class="warn_90">'+hReport.getRes('Eisen')+'</span>'}else{td.innerHTML=hReport.getRes('Eisen')}rowArr[3]=hReport.getRes('Eisen');tr.appendChild(td);var td=document.createElement('td');if(attack){td.setAttribute('style','background-color: '+trAttackColor+'; text-align: right;')}else{td.setAttribute('style','text-align: right;')}if(hReport.getResWarn('',1)){td.innerHTML='<span class="warn">'+(hReport.getRes('Holz')+hReport.getRes('Lehm')+hReport.getRes('Eisen'))+'</span>'}else if(hReport.getResWarn('',0.9)){td.innerHTML='<span class="warn_90">'+(hReport.getRes('Holz')+hReport.getRes('Lehm')+hReport.getRes('Eisen'))+'</span>'}else{td.innerHTML=(hReport.getRes('Holz')+hReport.getRes('Lehm')+hReport.getRes('Eisen'))}rowArr[4]=hReport.getRes('Holz')+hReport.getRes('Lehm')+hReport.getRes('Eisen');tr.appendChild(td);var td=document.createElement('td');if(attack){td.setAttribute('style','background-color: '+trAttackColor+'; text-align: right;')}else{td.setAttribute('style','text-align: right;')}if(hReport.isTroops()){td.innerHTML='<img src="graphic/delete.png" alt="x" title="Achtung: Truppen!">'}else{td.innerHTML='<img src="graphic/quests/completed.png" style="width: 19px; height: 16px;" alt="+" title="Keine Truppen!">'}tr.appendChild(td);var td=document.createElement('td');if(attack){td.setAttribute('style','background-color: '+trAttackColor+'; text-align: right;')}else{td.setAttribute('style','text-align: right;')}var spearTime=Math.round(coordDiff*unitSpeed[0]*60);var spearRes=hReport.getRes('Holz',spearTime)+hReport.getRes('Lehm',spearTime)+hReport.getRes('Eisen',spearTime);var spearCount=Math.ceil(spearRes/unitBooty[0]);var a=document.createElement('a');a.setAttribute('href','#'+vCoords[0]+','+vCoords[1]+','+spearCount);a.addEventListener('click',function(e){var params=this.getAttribute('href').replace('#','').split(',');unsafeWindow.selectTarget(params[0],params[1],'');if($('unit_input_spy').value=='0'||$('unit_input_spy').value==''){var els=$('unit_input_spy').parentNode.childNodes;for(var i=els.length-1;i>-1;--i){el=els[i];if(el.nodeType==1){maxAvailable=parseInt(el.innerHTML.replace('(','').replace(')',''));if(maxAvailable>0){$('unit_input_spy').value='1'}break}}}if($('unit_input_spear').value==''){var els=$('unit_input_spear').parentNode.childNodes;for(var i=els.length-1;i>-1;--i){el=els[i];if(el.nodeType==1){maxAvailable=parseInt(el.innerHTML.replace('(','').replace(')',''));if(maxAvailable>=params[2]){$('unit_input_spear').value=params[2]}else{$('unit_input_spear').value=maxAvailable}break}}}},false);a.innerHTML=spearCount;td.appendChild(a);tr.appendChild(td);var td=document.createElement('td');if(attack){td.setAttribute('style','background-color: '+trAttackColor+'; text-align: right;')}else{td.setAttribute('style','text-align: right;')}var lkavTime=Math.round(coordDiff*unitSpeed[5]*60);var lkavRes=hReport.getRes('Holz',lkavTime)+hReport.getRes('Lehm',lkavTime)+hReport.getRes('Eisen',lkavTime);var lkavCount=Math.ceil(lkavRes/unitBooty[5]);var a=document.createElement('a');a.setAttribute('href','#'+vCoords[0]+','+vCoords[1]+','+lkavCount);a.addEventListener('click',function(e){var params=this.getAttribute('href').replace('#','').split(',');unsafeWindow.selectTarget(params[0],params[1],'');if($('unit_input_spy').value=='0'||$('unit_input_spy').value==''){var els=$('unit_input_spy').parentNode.childNodes;for(var i=els.length-1;i>-1;--i){el=els[i];if(el.nodeType==1){maxAvailable=parseInt(el.innerHTML.replace('(','').replace(')',''));if(maxAvailable>0){$('unit_input_spy').value='1'}break}}}if($('unit_input_light').value==''){var els=$('unit_input_light').parentNode.childNodes;for(var i=els.length-1;i>-1;--i){el=els[i];if(el.nodeType==1){maxAvailable=parseInt(el.innerHTML.replace('(','').replace(')',''));if(maxAvailable>=params[2]){$('unit_input_light').value=params[2]}else{$('unit_input_light').value=maxAvailable}break}}}},false);a.innerHTML=lkavCount;td.appendChild(a);tr.appendChild(td);var td=document.createElement('td');if(attack){td.setAttribute('style','background-color: '+trAttackColor+'; text-align: right;')}else{td.setAttribute('style','text-align: right;')}td.innerHTML=coordDiff;rowArr[5]=coordDiff;tr.appendChild(td);var td=document.createElement('td');wallLevel=hReport.getBuilding('Wall');if(attack){td.setAttribute('style','background-color: '+trAttackColor+'; text-align: right;')}else{td.setAttribute('style','text-align: right;')}if(wallLevel>4){td.setAttribute('class',(wallLevel>9)?'warn':'warn_90')}td.innerHTML=wallLevel;rowArr[6]=wallLevel;tr.appendChild(td);var td=document.createElement('td');if(attack){td.setAttribute('style','background-color: '+trAttackColor+'; text-align: right;')}else{td.setAttribute('style','text-align: right;')}var lTime=hReport.LastTimeDiff,ageH=Math.floor(lTime/3600),agem=Math.floor((lTime-ageH*3600)/60),ages=lTime-ageH*3600-agem*60;if(agem<10){agem='0'+agem}if(ages<10){ages='0'+ages}td.innerHTML=ageH+':'+agem+':'+ages;rowArr[7]=hReport.LastTimeDiff;tr.appendChild(td);var td=document.createElement('td');if(attack)td.setAttribute('style','background-color: '+trAttackColor+';');var a=document.createElement('a');a.setAttribute('class','cancel-icon solo');a.setAttribute('title','Farm sperren');a.setAttribute('href','javascript:;');a.addEventListener('click',function(e){el=e.target;while(el.nodeName!='TR'){el=el.parentNode}this.blur();if(confirm('Soll die Farm wirklich gelöscht werden?')){el.firstChild.nextSibling.firstChild.innerText.match(/(\d+\|\d+)/);vCoords=RegExp.$1;var coords=getValue('Village[coords]',false);if(coords){coords=coords.split(',');var a=0;for(var i=0,max=coords.length;i<max;++i){if(coords[i]==vCoords){coords.splice(i,1);break}}setValue('Village[coords]',coords.join(','));$('farmTable').removeChild(this.parentNode.parentNode);var delFarm=getValue('Village[deleted]',false);if(delFarm){lockFarm=delFarm;setValue('Village[locked]',lockFarm);deleteValue('Village[deleted]')}else{lockFarm=getValue('Village[locked]',false)}if(!lockFarm){setValue('Village[locked]',vCoords)}else{lockFarm=lockFarm.split(',');var match=false;for(var i=0,max=lockFarm.length;i<max;++i){if(lockFarm[i]==vCoords){match=true;break}}if(!match){lockFarm[lockFarm.length]=vCoords;setValue('Village[locked]',lockFarm.join(','))}}}}},false);td.appendChild(a);tr.appendChild(td);rowArr[0]=tr;var gesRes=hReport.getRes('Holz')+hReport.getRes('Lehm')+hReport.getRes('Eisen');if(isNaN(gesRes))gesRes=0;if(attack){AttackRows.push(rowArr)}else{FarmRows.push(rowArr)}}sortCol=sortCol.split('-');if(sortCol[0]=='0'){if(sortCol[1]=='0'){SortFunc=function(a,b){return a[1]-b[1]}}else{SortFunc=function(a,b){return b[1]-a[1]}}}else if(sortCol[0]=='1'){if(sortCol[1]=='0'){SortFunc=function(a,b){return a[2]-b[2]}}else{SortFunc=function(a,b){return b[2]-a[2]}}}else if(sortCol[0]=='2'){if(sortCol[1]=='0'){SortFunc=function(a,b){return a[3]-b[3]}}else{SortFunc=function(a,b){return b[3]-a[3]}}}else if(sortCol[0]=='3'){if(sortCol[1]=='0'){SortFunc=function(a,b){return a[4]-b[4]}}else{SortFunc=function(a,b){return b[4]-a[4]}}}else if(sortCol[0]=='4'){if(sortCol[1]=='0'){SortFunc=function(a,b){return a[5]-b[5]}}else{SortFunc=function(a,b){return b[5]-a[5]}}}else if(sortCol[0]=='5'){if(sortCol[1]=='0'){SortFunc=function(a,b){return a[6]-b[6]}}else{SortFunc=function(a,b){return b[6]-a[6]}}}else if(sortCol[0]=='6'){if(sortCol[1]=='0'){SortFunc=function(a,b){return a[7]-b[7]}}else{SortFunc=function(a,b){return b[7]-a[7]}}}FarmRows.sort(SortFunc);for(var i=0,max=FarmRows.length;i<max;++i){table.appendChild(FarmRows[i][0])}AttackRows.sort(SortFunc);for(var i=0,max=AttackRows.length;i<max;++i){table.appendChild(AttackRows[i][0])}$('inline_popup_content').innerHTML='';$('inline_popup_content').appendChild(table)},20);return false},false);td.appendChild(a);tr.appendChild(td);tableForm.appendChild(tr)}function attack(){if(!$('content_value').getElementsByTagName('form')[0]||$('content_value').getElementsByTagName('form')[0].getAttribute('method')!='post')return false;var tds=$('content_value').getElementsByTagName('table')[0].getElementsByTagName('td');for(var i=0,max=tds.length;i<max;++i){nexttd=tds[i+1];if(tds[i].innerHTML=='Ziel:'&&nexttd){nexttd.innerHTML.match(/\((\d\d?\d?\|\d\d?\d?)\)\s+K\d\d?/);break}}vCoords=RegExp.$1.split('|');hReport=new Report(vCoords);if(!hReport.exist())return false;var unit_table=$('content_value').getElementsByTagName('table')[1];var th=document.createElement('th');th.setAttribute('width','50');var img=document.createElement('img');img.setAttribute('src','graphic/unit/unit_militia.png');img.setAttribute('title','Miliz');img.setAttribute('alt','Miliz');th.appendChild(img);unit_table.getElementsByTagName('tr')[0].appendChild(th);var tr=document.createElement('tr');for(var i=0,max=units.length;i<max;++i){unit=units[i];var td=document.createElement('td');if(hReport.getTroops(unit)==0){td.setAttribute('class','unit-item hidden')}else{td.setAttribute('class','unit-item')}var text=document.createTextNode(hReport.getTroops(unit));td.appendChild(text);tr.appendChild(td)}unit_table.appendChild(tr)}function overview(){var Ress=getValue('ResBooty','0.0.0..-1,-1,-1.0.0.0..-1,-1,-1').split('.');if(Ress.length!=10)Ress=[0,0,0,'','-1,-1,-1',0,0,0,'','-1,-1,-1'];resToday=Ress[4].split(',');resYesterday=Ress[9].split(',');dateToday=[];var tmpDate=$('serverDate').innerHTML.split('/');dateToday=[parseInt(tmpDate[0].replace(/^0(\d)/,"$1")),parseInt(tmpDate[1].replace(/^0(\d)/,"$1")),parseInt(tmpDate[2])-2000];dateYesterday=getPrevDay(dateToday);if(resToday[0]!=dateToday[0]&&resToday[1]!=dateToday[1]&&resToday[2]!=dateToday[2]&&resToday[0]!=dateYesterday[0]&&resToday[1]!=dateYesterday[1]&&resToday[2]!=dateYesterday[2]){Ress=[0,0,0,'',dateToday[0]+','+dateToday[1]+','+dateToday[2],0,0,0,'',dateYesterday[0]+','+dateYesterday[1]+','+dateYesterday[2]]}else if(resToday[0]==dateYesterday[0]&&resToday[1]==dateYesterday[1]&&resToday[2]==dateYesterday[2]){Ress=[0,0,0,'',dateToday[0]+','+dateToday[1]+','+dateToday[2],Ress[0],Ress[1],Ress[2],Ress[3],Ress[4]]}Ress=[parseInt(Ress[0]),parseInt(Ress[1]),parseInt(Ress[2]),Ress[3],Ress[4],parseInt(Ress[5]),parseInt(Ress[6]),parseInt(Ress[7]),Ress[8],Ress[9]];var hideBooty=(getValue('hideBooty','0')=='1');var div=document.createElement('div');div.setAttribute('id','show_booty');div.setAttribute('class','vis moveable widget');div.setAttribute('style','opacity: 1; z-index: 0; ');var h4=document.createElement('h4');var img=document.createElement('img');img.setAttribute('style','float: right; cursor: pointer;');img.setAttribute('src',hideBooty?'graphic/plus.png':'graphic/minus.png');img.addEventListener('click',function(e){unsafeWindow.element=unsafeWindow.$('#show_booty > div');unsafeWindow.element.toggle();this.src=unsafeWindow.element.is(':hidden')?'graphic/plus.png':'graphic/minus.png';setValue('hideBooty',unsafeWindow.element.is(':hidden')?'1':'0');return false},false);h4.appendChild(img);div.appendChild(h4);var text=document.createTextNode('Beute');h4.appendChild(text);var innerDiv=document.createElement('div');innerDiv.setAttribute('style',hideBooty?'display: none;':'display: block;');tWoodT=Math.floor(Ress[0]/1000);tWood=Ress[0]-tWoodT*1000;if(tWoodT>0){if(tWood<10){tWood='00'+tWood}else if(tWood<100){tWood='0'+tWood}}tLoamT=Math.floor(Ress[1]/1000);tLoam=Ress[1]-tLoamT*1000;if(tLoamT>0){if(tLoam<10){tLoam='00'+tLoam}else if(tLoam<100){tLoam='0'+tLoam}}tIronT=Math.floor(Ress[2]/1000);tIron=Ress[2]-tIronT*1000;if(tIronT>0){if(tIron<10){tIron='00'+tIron}else if(tIron<100){tIron='0'+tIron}}tTotal=Ress[0]+Ress[1]+Ress[2];yWoodT=Math.floor(Ress[5]/1000);yWood=Ress[5]-yWoodT*1000;if(yWoodT>0){if(yWood<10){yWood='00'+yWood}else if(yWood<100){yWood='0'+yWood}}yLoamT=Math.floor(Ress[6]/1000);yLoam=Ress[6]-yLoamT*1000;if(yLoamT>0){if(yLoam<10){yLoam='00'+yLoam}else if(yLoam<100){yLoam='0'+yLoam}}yIronT=Math.floor(Ress[7]/1000);yIron=Ress[7]-yIronT*1000;if(yIronT>0){if(yIron<10){yIron='00'+yIron}else if(yIron<100){yIron='0'+yIron}}yTotal=Ress[5]+Ress[6]+Ress[7];var html='';html+='<table width="100%">';html+='<tr class="nowrap"><td colspan="2"><strong>Heute erfarmte Rohstoffe:</strong></td></tr>';html+='<tr class="nowrap"><td width="70"><span class="icon header wood"> </span> Holz</td><td><strong>'+((tWoodT>0)?tWoodT+'<span class="grey">.</span>':'')+tWood+'</strong></td></tr>';html+='<tr class="nowrap"><td width="70"><span class="icon header stone"> </span> Lehm</td><td><strong>'+((tLoamT>0)?tLoamT+'<span class="grey">.</span>':'')+tLoam+'</strong></td></tr>';html+='<tr class="nowrap"><td width="70"><span class="icon header iron"> </span> Eisen</td><td><strong>'+((tIronT>0)?tIronT+'<span class="grey">.</span>':'')+tIron+'</strong></td></tr>';html+='<tr class="nowrap"><td width="70"><span class="icon header ressources"> </span> Gesamt</td><td><strong>';tString=tTotal.toString();tLen=tString.length;fLen=(tLen-1)%3+1;html+=tString.substr(0,fLen);tString=tString.substr(fLen);tLen-=fLen;while(tLen>0){html+='<span class="grey">.</span>'+tString.substr(0,3);tLen-=3}html+='</strong></td></tr>';html+='<tr class="nowrap"><td colspan="2"><strong>Gestern erfarmte Rohstoffe:</strong></td></tr>';html+='<tr class="nowrap"><td width="70"><span class="icon header wood"> </span> Holz</td><td><strong>'+((yWoodT>0)?yWoodT+'<span class="grey">.</span>':'')+yWood+'</strong></td></tr>';html+='<tr class="nowrap"><td width="70"><span class="icon header stone"> </span> Lehm</td><td><strong>'+((yLoamT>0)?yLoamT+'<span class="grey">.</span>':'')+yLoam+'</strong></td></tr>';html+='<tr class="nowrap"><td width="70"><span class="icon header iron"> </span> Eisen</td><td><strong>'+((yIronT>0)?yIronT+'<span class="grey">.</span>':'')+yIron+'</strong></td></tr>';html+='<tr class="nowrap"><td width="70"><span class="icon header ressources"> </span> Gesamt</td><td><strong>';tString=yTotal.toString();tLen=tString.length;fLen=(tLen-1)%3+1;html+=tString.substr(0,fLen);tString=tString.substr(fLen);tLen-=fLen;while(tLen>0){html+='<span class="grey">.</span>'+tString.substr(0,3);tLen-=3}html+='</strong></td></tr>';innerDiv.innerHTML=html;div.appendChild(innerDiv);$('rightcolumn').appendChild(div)}window.MapNodeInserted=function(){if(!$('info_content')||$('info_content').innerHTML.match(/Jetzt m.{1,2}glich/))return false;var ths=this.getElementsByTagName('th');if(!ths||ths.length<1||!ths[0]){return false}ths[0].innerHTML.match(/.+ \((\d\d?\d?\|\d\d?\d?)\) K\d\d?/);if(!RegExp.$1){return false}$('map_popup').removeEventListener("DOMNodeInserted",window.MapNodeInserted);tmp=RegExp.$1.split('|');vCoords=[parseInt(tmp[0]),parseInt(tmp[1])];window.setTimeout(function(){if(!$('info_content')||$('info_content').innerHTML.match(/Jetzt m.{1,2}glich/))return false;var hReport=new Report(vCoords);if(hReport.SpyReportDate['Y']!=-1&&hReport.SpyReportDate['M']!=-1&&hReport.SpyReportDate['d']!=-1&&hReport.SpyReportDate['H']!=-1&&hReport.SpyReportDate['m']!=-1&&hReport.SpyReportDate['s']!=-1){var html=$('info_content').innerHTML.replace(/\s*<\/?tbody>\s*/g,'');var td_points=/<td id="info_points">(\d+\.?\d*)<\/td>/;html.match(td_points);var tmp=RegExp.$1.split('.');if(tmp.length==2){var momPoints=parseInt(tmp[0]+tmp[1])}else{var momPoints=parseInt(tmp[0])}pointsDiff=momPoints-hReport.getPoints();pointsHTML='<td id="info_points">';if(momPoints>999){momPointsT=Math.floor(momPoints/1000);pointsHTML+=momPointsT+'.';momPoints-=momPointsT*1000;if(momPoints<10){pointsHTML+='00'}else if(momPoints<100){pointsHTML+='0'}}pointsHTML+=momPoints+' <span style="font-size: 90%;';if(pointsDiff>0){pointsHTML+=' color: green;">+'}else if(pointsDiff<0){pointsHTML+=' color: red;">'}else{pointsHTML+='">±'}pointsHTML+=pointsDiff+'</span></td>';html=html.replace(td_points,pointsHTML);html+='<tr><th>Jetzt möglich:</th>';html+='<td><img src="graphic/holz.png" alt="Holz">';var wood=hReport.getRes('Holz');html+='<span'+(hReport.getResWarn('Holz',0.9)?(hReport.getResWarn('Holz',1)?' class="warn"':' class="warn_90"'):'')+'>';if(wood>999){var woodT=Math.floor(wood/1000);html+=woodT+'<span class="grey">.</span>';var wood=(wood-woodT*1000);if(wood<10){wood='00'+wood}else if(wood<100){wood='0'+wood}}html+=wood+'</span> <img src="graphic/lehm.png" alt="Lehm">';var loam=hReport.getRes('Lehm');html+='<span'+(hReport.getResWarn('Lehm',0.9)?(hReport.getResWarn('Lehm',1)?' class="warn"':' class="warn_90"'):'')+'>';if(loam>999){var loamT=Math.floor(loam/1000);html+=loamT+'<span class="grey">.</span>';var loam=(loam-loamT*1000);if(loam<10){loam='00'+loam}else if(loam<100){loam='0'+loam}}html+=loam+'</span> <img src="graphic/eisen.png" alt="Eisen">';var iron=hReport.getRes('Eisen');html+='<span'+(hReport.getResWarn('Eisen',0.9)?(hReport.getResWarn('Eisen',1)?' class="warn"':' class="warn_90"'):'')+'>';if(iron>999){var ironT=Math.floor(iron/1000);html+=ironT+'<span class="grey">.</span>';var iron=(iron-ironT*1000);if(iron<10){iron='00'+iron}else if(iron<100){iron='0'+iron}}html+=iron+'</span></td></tr>';if(hReport.getMood()<100){html+='<tr><th>Zustimmung:</th><td>'+hReport.getMood()+'</td></tr>'}html+='<tr><th>Gebäude:<br><span style="font-size: 80%">'+hReport.getSpyDate('d.M. H:m:s')+'</span></th>';line1=line2='';for(var i=0;i<17;++i){if(hReport.getBuilding(buildingsIndex[i])>0){line1+='<td style="text-align: center; width: 25px;'+((line1!='')?' border-left: 1px dashed #C1A264;':'')+'"><img src="'+buildingImgUrl.replace('$',buildingImg[i])+'"></td>';line2+='<td style="text-align: center;'+((line2!='')?' border-left: 1px dashed #C1A264;':'')+'">'+hReport.getBuilding(buildingsIndex[i])+'</td>'}}var wallLevel=hReport.getBuilding('Wall');if(wallLevel>0){line1+='<td style="text-align: center; width: 25px;'+((line1!='')?' border-left: 1px dashed #C1A264;':'')+'"><img src="'+buildingImgUrl.replace('$',buildingImg[17])+'"></td>';if(wallLevel>4){line2+='<td style="text-align: center;'+((line2!='')?' border-left: 1px dashed #C1A264;':'')+'"><span class="'+((wallLevel>9)?'warn':'warn_90')+'">'+wallLevel+'</span></td>'}else{line2+='<td style="text-align: center;'+((line2!='')?' border-left: 1px dashed #C1A264;':'')+'">'+wallLevel+'</td>'}}html+='<td><table><tr>'+line1+'</tr><tr>'+line2+'</tr></table></td></tr>';html+='<tr><th>Truppen:<br><span style="font-size: 80%">'+hReport.getSpyDate('d.M. H:m:s')+'</span></th>';line1='';line2='';for(var i=0,max=units.length;i<max;++i){unit=units[i];line1+='<td style="text-align: center; width: 25px;'+((line1!='')?'border-left: 1px dashed #C1A264;':'')+'"><img src="'+unitImgUrl.replace('$',unitImg[i])+'" title="'+unit+'" alt="'+unit+'"></td>';line2+='<td style="text-align: center;'+((line2!='')?' border-left: 1px dashed #C1A264;':'')+'" class="unit-item';if(hReport.getTroops(unit)==0){line2+=' hidden'}line2+='">'+hReport.getTroops(unit)+'</td>'}html+='<td><table><tr>'+line1+'</tr><tr>'+line2+'</tr></table></td></tr>';$('info_content').innerHTML=html}$('map_popup').addEventListener('DOMNodeInserted',window.MapNodeInserted,false)},10)};function map(){hCoords=false;var tds=$('menu_row2').getElementsByTagName('td');for(var i=0,max=tds.length;i<max;++i){td=tds[i];innerHTML=td.innerHTML;if(td.getAttribute('class')=='box-item'&&innerHTML&&innerHTML.match(/\(\d\d?\d?\|\d\d?\d?\)\s*K\d\d?/)){var tmp=innerHTML.search(/\(\d\d?\d?\|\d\d?\d?\)\s+K\d\d?/);hCoords=innerHTML.substr(tmp+1,7).split('|');hCoords=[parseInt(hCoords[0]),parseInt(hCoords[1])];break}}if(!hCoords)return;$('map_popup').addEventListener('DOMNodeInserted',window.MapNodeInserted,false)}if(location.href.match(/screen=report.+view=\d+/)||location.href.match(/view=\d+.+screen=report/)){document.addEventListener('keydown',function(event){var keyPressed=false;if(!event)event=window.event;var keyCode=event.keyCode?event.keyCode:(event.charCode?event.charCode:event.which);if(keyCode==37){if(window.keysActive){nextReport();keyPressed=true}}else if(keyCode==39){if(window.keysActive){prevReport();keyPressed=true}}else if(keyCode==46&&(window.oldReport||confirm('Wollen Sie den Bericht wirklich löschen?'))){deleteReport();keyPressed=true}else if(keyCode==86){moveReport();keyPressed=true}else if(keyCode==27){readingReports('0');keyPressed=true}else{return}if(keyPressed){event.cancelBubble=true;event.returnValue=false;if(event.stopPropagation){event.stopPropagation();event.preventDefault()}}return false},false)}else if(location.href.match(/screen=place/)&&!location.href.match(/try=confirm/)){document.addEventListener('keydown',function(event){if(!event)event=window.event;var keyCode=event.keyCode?event.keyCode:(event.charCode?event.charCode:event.which);if(document.activeElement.nodeName!='INPUT'&&((keyCode>48&&keyCode<58)||(keyCode>96&&keyCode<106))){if(keyCode>48&&keyCode<58){var num=keyCode-49}else if(keyCode>96&&keyCode<106){var num=keyCode-97}var coords=getValue('Village[coords]',false);if(coords){coords=coords.split(',')}attacks=getValue('attacksLists','');FarmRows=[];for(var i=0,max=coords.length;i<max;++i){if(attacks.indexOf(coords[i])!=-1)continue;rowArr=[];coord=coords[i];tmp=coord.split('|');var vCoords;vCoords=[parseInt(tmp[0]),parseInt(tmp[1])];rowArr[0]=vCoords;var hReport=new Report(vCoords);rowArr[1]=hReport.getRes('Holz');rowArr[2]=hReport.getRes('Lehm');rowArr[3]=hReport.getRes('Eisen');rowArr[4]=hReport.getRes('Holz')+hReport.getRes('Lehm')+hReport.getRes('Eisen');rowArr[5]=Math.round(Math.sqrt(Math.pow(hCoords[0]-vCoords[0],2)+Math.pow(hCoords[1]-vCoords[1],2))*10)/10;rowArr[6]=hReport.getBuilding('Wall');rowArr[7]=hReport.LastTimeDiff;FarmRows.push(rowArr)}if(FarmRows.length<=num)return;var sortCol=getValue('FarmSort','3-1').split('-');if(sortCol[0]=='0'){if(sortCol[1]=='0'){SortFunc=function(a,b){return a[1]-b[1]}}else{SortFunc=function(a,b){return b[1]-a[1]}}}else if(sortCol[0]=='1'){if(sortCol[1]=='0'){SortFunc=function(a,b){return a[2]-b[2]}}else{SortFunc=function(a,b){return b[2]-a[2]}}}else if(sortCol[0]=='2'){if(sortCol[1]=='0'){SortFunc=function(a,b){return a[3]-b[3]}}else{SortFunc=function(a,b){return b[3]-a[3]}}}else if(sortCol[0]=='3'){if(sortCol[1]=='0'){SortFunc=function(a,b){return a[4]-b[4]}}else{SortFunc=function(a,b){return b[4]-a[4]}}}else if(sortCol[0]=='4'){if(sortCol[1]=='0'){SortFunc=function(a,b){return a[5]-b[5]}}else{SortFunc=function(a,b){return b[5]-a[5]}}}else if(sortCol[0]=='5'){if(sortCol[1]=='0'){SortFunc=function(a,b){return a[6]-b[6]}}else{SortFunc=function(a,b){return b[6]-a[6]}}}else if(sortCol[0]=='6'){if(sortCol[1]=='0'){SortFunc=function(a,b){return a[7]-b[7]}}else{SortFunc=function(a,b){return b[7]-a[7]}}}FarmRows.sort(SortFunc);var Farm=FarmRows[num],vCoords=Farm[0];unsafeWindow.selectTarget(vCoords[0],vCoords[1],'');if($('unit_input_spy').value=='0'||$('unit_input_spy').value==''){var els=$('unit_input_spy').parentNode.childNodes;for(var i=els.length-1;i>-1;--i){el=els[i];if(el.nodeType==1){maxAvailable=parseInt(el.innerHTML.replace('(','').replace(')',''));if(maxAvailable>0){$('unit_input_spy').value='1'}break}}}event.cancelBubble=true;event.returnValue=false;if(event.stopPropagation){event.stopPropagation();event.preventDefault()}}return false},false)}if(window.UVActive){return 0}if(location.href.match(/screen=info_village.+id=\d+/)||location.href.match(/id=\d+.+screen=info_village/)){window.setTimeout(villageInfos,10)}else if(location.href.match(/screen=report.+view=\d+/)||location.href.match(/view=\d+.+screen=report/)){if($('quickbar_outer'))faderstyle='top: '+(112+$('quickbar_outer').offsetHeight)+'px; opacity: ';var div=document.createElement('div');div.setAttribute('class','autoHideBox');div.setAttribute('id','autoHideMsg');div.setAttribute('style',faderstyle+1);div.innerHTML='<span style="color:#f4e4bc">Der Bericht wird eingelesen...</span>';div.addEventListener('click',function(e){$('autoHideMsg').setAttribute('style','display:none')},false);$('content_value').appendChild(div);window.setTimeout(function(){var ret=reportAnalyzer();if(ret==-2){$('autoHideMsg').setAttribute('style','display:none');window.keysActive=true}else if(ret==-1){$('autoHideMsg').setAttribute('style','display:none');window.keysActive=true}else if(ret==0){$('autoHideMsg').setAttribute('style','display:none');window.keysActive=true}else if(ret==1){$('autoHideMsg').setAttribute('class','autoHideBox success');$('autoHideMsg').innerHTML='Der Bericht wurde erfolgreich eingelesen!';window.keysActive=true;fadeout()}else if(ret==2){$('autoHideMsg').innerHTML='Dieser Bericht ist aktuell!';window.keysActive=true;fadeout()}else if(ret==3){window.oldReport=true;$('autoHideMsg').setAttribute('class','autoHideBox error');$('autoHideMsg').innerHTML='Dieser Bericht ist veraltet!';var tds=document.getElementsByTagName('td');for(var i=0,max=tds.length;i<max;++i){if(tds[i].innerHTML&&trim(tds[i].innerHTML)=='Gesendet'){if(tds[i].parentNode.childNodes[1]){tds[i].parentNode.childNodes[1].setAttribute('class','error');break}}}window.keysActive=true;fadeout()}if(ret>-1)readingReports()},10)}else if(location.href.indexOf('screen=report')!=-1){window.setTimeout(reports,10)}else if(location.href.indexOf('screen=place')!=-1){if($('units_form')){window.setTimeout(farmList,10)}else if(location.href.indexOf('try=confirm')!=-1){window.setTimeout(attack,10)}}else if(location.href.indexOf('screen=overview')!=-1&&location.href.indexOf('screen=overview_villages')==-1){window.setTimeout(overview,10)}else if(location.href.indexOf('screen=map')!=-1){window.setTimeout(map,10)}})();