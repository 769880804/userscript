// ==UserScript==
// @name           OpenCaching.com Helper
// @namespace      http://alopix.net/greasemonkey/occomhelper
// @description    Adds a sidebox with some features to enhance the review process on OpenCaching.com
// @version        1.2.0
// @build          12116
// @copyright      2011 Dustin Steiner
// @license        CC BY-NC-ND 3.0; http://creativecommons.org/licenses/by-nc-nd/3.0/at/deed.en
// @include        http://www.opencaching.com/*
// @exclude        http://www.opencaching.com/js/*
// @exclude        http://www.opencaching.com/css/*
// @exclude        http://www.opencaching.com/templates/*
// @exclude        http://www.opencaching.com/images/*
// @exclude        http://www.opencaching.com/api/*
// @exclude        http://www.opencaching.com/api_doc/*
// @uso:script     116648
// ==/UserScript==
var styleContent="#sidebox {position:fixed;right:0;top:100px;font-size:small;color:#FFFFFF;overflow:hidden;}.sidebox h4 {padding-top:5px;}.sidebox .sb-result, .sidebox .sb-progress {display:none;}.sidebox .sb-result.visible {display:block;}#toggleSidebox {float:left;padding:10px;background:#92A4AE no-repeat left bottom;text-decoration:none;}#sbContent {float:right;width:300px;padding:10px;background:#92A4AE no-repeat left bottom;}.color-red {color:#8B0000;}.color-green {color:green;}";function addJQuery(c){var b=document.createElement("style");b.textContent=styleContent;document.head.appendChild(b);var a=document.createElement("script");a.textContent="("+c.toString()+")();";document.body.appendChild(a)}addJQuery(function(){var f=jQuery;const b=6371;const a=3959;var e=function(j){for(var h in j){this[j[h]]=h}};if(typeof(Number.prototype.toMi)==="undefined"){Number.prototype.toMi=function(){return this*0.621371192237334}}if(typeof(Number.prototype.toKm)==="undefined"){Number.prototype.toKm=function(){return this/0.621371192237334}}if(typeof(Number.prototype.toRad)==="undefined"){Number.prototype.toRad=function(){return this*Math.PI/180}}if(typeof(Number.prototype.toDeg)==="undefined"){Number.prototype.toDeg=function(){return this*180/Math.PI}}var d=function(i,h){this.lat=i;this.lng=h};d.prototype.toString=function(){return"("+this.lat+", "+this.lng+")"};d.prototype.toRadiant=function(){function h(i){return i*Math.PI/180}return[h(this.lat),h(this.lng)]};d.prototype.distanceTo=function(h){var i=this.toRadiant();var k=h.toRadiant();var m=k[0]-i[0];var l=k[1]-i[1];var j=(i[0]+k[0])/2;return b*Math.sqrt(Math.pow(m,2)+Math.pow(Math.cos(j)*l,2))};function c(h){var k=h.match(/^\s*(N|S)\s*(\d+)°\s*(\d+\.\d+)’\s*(W|E)\s*0*(\d+)°\s*(\d+\.\d+)’\s*$/);if(k==null){return null}var j=(k[1]=="N"?1:-1)*(parseInt(k[2])+(parseFloat(k[3])/60));var i=(k[4]=="E"?1:-1)*(parseInt(k[5])+(parseFloat(k[6])/60));return new d(j,i)}function g(){var p="<div id='sidebox' class='sidebox'><a id='toggleSidebox' data-open-string='&gt;' data-closed-string='&lt;'>&gt;</a><div id='sbContent'><h3>OpenCaching Helper</h3><div id='ckCoords'><h4>Opencaching.com</h4><div class='sb-query visible'><a id='ckCoordsGet'>Check distance to existing caches</a></div><div class='sb-progress'>Checking coordinates...</div><div class='sb-result'>Checked <span id='ckCoordsQuery'></span>:<br/><span id='ckCoordsResult'/></div></div><div id='ckGCCom'><h4>Geocaching.com</h4><div class='sb-query visible'><a id='ckGCComGcCode'>Open via gccode</a></div><div class='sb-query visible'><a id='ckGCComNearby'>Check coordinates</a></div></div><div id='ckOCDe'><h4>OpenCaching.de</h4><div class='sb-query visible'><a id='ckOCDeGcCode'>Open via gccode</a></div><div class='sb-query visible'><a id='ckOCDeNearby'>Check coordinates</a></div></div></div></div>";var v=f(p);var r=f("#toggleSidebox",v);var p=f("> #sbContent",v);r.click(function(){if(p.data("display")==undefined){p.data("display",true)}else{p.data("display",!p.data("display"))}k(p.data("display"))});function k(y,x){if(x===undefined){x=true}console.log("animate? "+x);v.data("display",y);if(y){if(x){v.animate({right:"0px"},{duration:"fast"})}else{v.css("right","0px")}}else{if(x){v.animate({right:"-320px"},{duration:"fast",complete:function(){}})}else{v.css("right","-320px")}}r.text(y?r.data("open-string"):r.data("closed-string"));f.cookie("ochelper.sidebox.display",y,{expires:7,path:"/"})}var q=f.cookie("ochelper.sidebox.display");if(q==null||q=="true"){k(true,false)}else{k(false,false)}function o(x){f(".sb-query",x).hide();f(".sb-query.visible",x).show();f(".sb-progress",x).hide();f(".sb-result",x).show()}function l(x){f(".sb-query",x).show();f(".sb-progress",x).hide();f(".sb-result",x).hide()}function n(x){f(".sb-query",x).show();f(".sb-progress",x).show();f(".sb-result",x).hide()}var i=f("#ckCoords",v);function t(y){if(typeof unsafeWindow!=="undefined"){Utl=unsafeWindow.Utl}n(i);var D=f("#geocache-coord-numbers").text();if(D==null){f("#ckCoordsResult",i).text("Could not get coordinates.");o(i)}else{var F=c(D);f("#ckCoordsQuery",v).text(D);if(F==null){f("#ckCoordsResult",i).text("Could not parse coordinates.");o(i)}else{var A=null;var E=0;var C="geocache";var B={center:F.lat+","+F.lng,limit:2,status:"Review",type:"Traditional Cache,Multi-cache,Unknown Cache"};var x="GET";var z=function(I){for(var N=0;N<I.length;++N){console.log("Distance to "+I[N].name+"("+I[N].oxcode+", "+I[N].status+"): "+F.distanceTo(new d(I[N].location.lat,I[N].location.lon))+" type: "+I[N].type)}if(I==null||I.length==0){f("#ckCoordsResult",i).text("Could not find any caches.");o(i)}else{var R=(I.length==2)?1:0;var J=F.distanceTo(new d(I[R].location.lat,I[R].location.lon));if(A==null||A.oxcode==f("#cache_oxcode").text()||A.distance>J){A={oxcode:I[R].oxcode,name:I[R].name,status:I[R].status,distance:J,type:I[R].type}}++E;switch(E){case 1:B={center:F.lat+","+F.lng,limit:1,status:"Inactive",type:"Traditional Cache,Multi-cache,Unknown Cache"};Utl.api_call(C,B,x,z,H);break;case 2:var P=f("#review_comment_instructions").length!=0;B={center:F.lat+","+F.lng,limit:P?1:2,type:"Traditional Cache,Multi-cache,Unknown Cache"};Utl.api_call(C,B,x,z,H);break;case 3:var S=A.distance;var M="km";var O=Number(S).toMi().toFixed(3);if(S<0.5){S*=1000;S=S.toFixed(0);M="m"}else{S=S.toFixed(3)}var L=O*5280;L=L.toFixed(0);var J="";if(O<0.1){J+=L+" ft"}else{J+=O+" mi"}J+=" (= "+S+" "+M+" or ";if(O<0.1){J+=O+" mi"}else{J+=L+" ft"}J+=")";var Q;if(O<0.1){Q="red"}else{Q="green"}var K='Next cache <a href="http://www.opencaching.com/#!geocache/'+A.oxcode+'"">'+A.name+"</a> ("+A.type+') is <span class="color-'+Q+'">'+J+"</span> away.";f("#ckCoordsResult",i).html(K);o(i);break}}};var H=function(){f("#ckCoordsResult",i).text("Could not retrieve caches.");o(i)};var G=Utl.api_call(C,B,x,z,H)}}return false}f("#ckCoordsGet",v).click(t);var h=f("#ckGCCom",v);function m(){var x=f("#cache_oxcode").text();if(x.length!=0){window.open("http://coord.info/GC"+x.substr(2))}return false}f("#ckGCComGcCode",h).click(m);function j(){var C=f("#geocache-coord-numbers").text();if(C.length!=0){var B=C.match(/^\s*(N|S)\s*(\d+)°\s*(\d+\.\d+)’\s*(W|E)\s*(\d+)°\s*(\d+\.\d+)’\s*$/);var F="m";var D=B[1]=="N"?"1":"-1";var G=B[2];var E=B[3];var z=B[4]=="E"?"1":"-1";var y=B[5];var x=B[6];var A=1;window.open("http://www.geocaching.com/seek/nearest.aspx?t="+F+"&lat_ns="+D+"&lat_h="+G+"&lat_mmss="+E+"&long_ew="+z+"&long_h="+y+"&long_mmss="+x+"&dist="+A+"&submit8=Search")}return false}f("#ckGCComNearby",h).click(j);var w=f("#ckOCDe",v);function u(){var x=f("#cache_oxcode").text();if(x.length!=0){window.open("http://www.opencaching.de/viewcache.php?wp=OC"+x.substr(2))}return false}f("#ckOCDeGcCode",w).click(u);function s(){var C=f("#geocache-coord-numbers").text();if(C.length!=0){var B=C.match(/^\s*(N|S)\s*(\d+)°\s*(\d+\.\d+)’\s*(W|E)\s*(\d+)°\s*(\d+\.\d+)’\s*$/);var E=B[1];var G=B[2];var F=B[3];var z=B[4];var y=B[5];var x=B[6];var A=1;var D="km";window.open("http://www.opencaching.de/search.php?searchto=searchbydistance&showresult=1&sort=bydistance&latNS="+E+"&lat_h="+G+"&lat_min="+F+"&lonEW="+z+"&lon_h="+y+"&lon_min="+x+"&distance="+A+"&unit="+D)}return false}f("#ckOCDeNearby",w).click(s);return v}f("#wrapper").append(g())});
