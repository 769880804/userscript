// ==UserScript==
// @name           nhac.vui.vn leecher
// @namespace      tiger2wander.blogspot.com
// @author         Uoc Nguyen
// @email          tiger2wander@gmail.com
// @description    nhac.vui.vn download link leecher
//                 How to use: load nhac.vui.vn playlist page then right click to Grease Monkey
//                 on the status bar. Select User Script Commands -> Generate Unix Shell Script
//                 A diaglog will show up and ask you for script template which will be use for
//                 generate shell script for you. When you have done, click ok then another
//                 dialog will show up and give you generated shell script use for download all
//                 song in playlist. Select all content then copy and paste it to a file then 
//                 save file like: leecher.sh
//                 You may do chmod command also: chmod +x leecher.sh
//                 then launch it using this command: ./leecher.sh
//                 Wait until files download to your computer!
//                 Have fun!
// @include        http://*.nhac.vui.vn/*
// @include        http://nhac.vui.vn/*
// ==/UserScript==

am = {
  util : {
    charTbl : "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",

    encode64 : function(input) {
       var output = "";
       var chr1, chr2, chr3;
       var enc1, enc2, enc3, enc4;
       var i = 0;

       do {
          chr1 = input.charCodeAt(i++);
          chr2 = input.charCodeAt(i++);
          chr3 = input.charCodeAt(i++);

          enc1 = chr1 >> 2;
          enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
          enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
          enc4 = chr3 & 63;

          if (isNaN(chr2)) {
             enc3 = enc4 = 64;
          } else if (isNaN(chr3)) {
             enc4 = 64;
          }

          output = output + am.util.charTbl.charAt(enc1) + am.util.charTbl.charAt(enc2) + 
             am.util.charTbl.charAt(enc3) + am.util.charTbl.charAt(enc4);
       } while (i < input.length);
       
       return output;
    },

    decode64 : function(input) {
       var output = "";
       var chr1, chr2, chr3;
       var enc1, enc2, enc3, enc4;
       var i = 0;

       // remove all characters that are not A-Z, a-z, 0-9, +, /, or =
       input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");

       do {
          enc1 = am.util.charTbl.indexOf(input.charAt(i++));
          enc2 = am.util.charTbl.indexOf(input.charAt(i++));
          enc3 = am.util.charTbl.indexOf(input.charAt(i++));
          enc4 = am.util.charTbl.indexOf(input.charAt(i++));

          chr1 = (enc1 << 2) | (enc2 >> 4);
          chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
          chr3 = ((enc3 & 3) << 6) | enc4;

          output = output + String.fromCharCode(chr1);

          if (enc3 != 64) {
             output = output + String.fromCharCode(chr2);
          }
          if (enc4 != 64) {
             output = output + String.fromCharCode(chr3);
          }
       } while (i < input.length);

       return output;
    }
  }
};

(function() {
  var nhacvuivnLeecher = {
    init : function() {
      GM_registerMenuCommand('Leech raw data', this.leechRawData);
      GM_registerMenuCommand('Leech script', this.leechScript);

      // Get current domain
      this.pageUrl = window.location.href;
      this.pageUrl = this.pageUrl.substr(0, this.pageUrl.lastIndexOf('/'));
    },

    getSongIdList : function() {
      songIdlist = [];

      var songLinks = window.document.body.querySelectorAll('a[href^="?url=Download"]');
      for (var i=0, iLen=songLinks.length; i<iLen; i++) {
        var songId = songLinks[i].href.match(/,(\d+),([^,]+$)/);
        if (songId && songId.length > 2) {
          songIdlist.push({id:songId[1], code:songId[2]});
        }
      }
      return songIdlist;
    },

    leechScript : function() {
      window.alert(
          nhacvuivnLeecher.buildScript(
            nhacvuivnLeecher.getSongIdList()
          )
      );
    },

    leechRawData : function() {
      window.alert(
          nhacvuivnLeecher.buildLinks(
            nhacvuivnLeecher.getSongIdList()
          )
      );
    },

    buildLinks : function(songIdlist) {
      var links = '';
      for (var i=0, iLen=songIdlist.length; i<iLen; i++) {
        var songId = songIdlist[i];
        var link = nhacvuivnLeecher.pageUrl + '/asx.php?type=1&id=' + songId.id + '&code=' + songId.code ;
        links += link + '\n';
      }
      return links;
    },

    buildScript : function(songIdlist) {

      var script = '#!/bin/bash\
\n ## nhac.vui.vn leecher script generated by nhacvuivnLeecher greasemonkey script\
\n ## @copyright Uoc Nguyen (c) 2009\
\n ## @author Uoc Nguyen\n\n';

      for (var i=0, iLen=songIdlist.length; i<iLen; i++) {
        var songId = songIdlist[i];
        var link = nhacvuivnLeecher.pageUrl + '/asx.php?type=1&id=' + songId.id + '&code=' + songId.code ;
        script += 'echo "Downloading songid: ' + songId.id + ' -- code: ' + songId.code + '";';
        script += 'curl -s "' + link + '" | grep -i -P \'http:\/\/[^"]+\' -o | aria2c -i -;\n';
      }

      script += 'echo "Done.";';

      return script;
    }
  }

  window.addEventListener('load', function() {nhacvuivnLeecher.init();}, false);
})();
