// ==UserScript==
// @name egovatwar
// @version 0.2.3
// @author aVie
// @namespace egov4you_egovatwar
// @description script for eRepublik
// @require https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js
// @include http://*.erepublik.com/*
// @downloadURL http://userscripts.org/scripts/show/162001
// @updateURL http://userscripts.org/scripts/show/162001
// ==/UserScript==
var egovatwar='0.2.3';var metaLink='http://userscripts.org/scripts/source/162001.meta.js';var scriptLink='http://userscripts.org/scripts/source/162001.user.js';var egovatwarCountry=GM_getValue('egovatwarCountry',35);var countries=new Array;countries["Albania"]=new Array;countries["Albania"]["id"]=167;countries["Argentina"]=new Array;countries["Argentina"]["id"]=27;countries["Australia"]=new Array;countries["Australia"]["id"]=50;countries["Austria"]=new Array;countries["Austria"]["id"]=33;countries["Belarus"]=new Array;countries["Belarus"]["id"]=83;countries["Belgium"]=new Array;countries["Belgium"]["id"]=32;countries["Bolivia"]=new Array;countries["Bolivia"]["id"]=76;countries["Bosnia-Herzegovina"]=new Array;countries["Bosnia-Herzegovina"]["id"]=69;countries["Brazil"]=new Array;countries["Brazil"]["id"]=9;countries["Bulgaria"]=new Array;countries["Bulgaria"]["id"]=42;countries["Canada"]=new Array;countries["Canada"]["id"]=23;countries["Chile"]=new Array;countries["Chile"]["id"]=64;countries["China"]=new Array;countries["China"]["id"]=14;countries["Colombia"]=new Array;countries["Colombia"]["id"]=78;countries["Croatia"]=new Array;countries["Croatia"]["id"]=63;countries["Cyprus"]=new Array;countries["Cyprus"]["id"]=82;countries["Czech-Republic"]=new Array;countries["Czech-Republic"]["id"]=34;countries["Denmark"]=new Array;countries["Denmark"]["id"]=55;countries["Egypt"]=new Array;countries["Egypt"]["id"]=165;countries["Estonia"]=new Array;countries["Estonia"]["id"]=70;countries["Finland"]=new Array;countries["Finland"]["id"]=39;countries["France"]=new Array;countries["France"]["id"]=11;countries["Germany"]=new Array;countries["Germany"]["id"]=12;countries["Greece"]=new Array;countries["Greece"]["id"]=44;countries["Hungary"]=new Array;countries["Hungary"]["id"]=13;countries["India"]=new Array;countries["India"]["id"]=48;countries["Indonesia"]=new Array;countries["Indonesia"]["id"]=49;countries["Iran"]=new Array;countries["Iran"]["id"]=56;countries["Ireland"]=new Array;countries["Ireland"]["id"]=54;countries["Israel"]=new Array;countries["Israel"]["id"]=58;countries["Italy"]=new Array;countries["Italy"]["id"]=10;countries["Japan"]=new Array;countries["Japan"]["id"]=45;countries["Latvia"]=new Array;countries["Latvia"]["id"]=71;countries["Lithuania"]=new Array;countries["Lithuania"]["id"]=72;countries["Malaysia"]=new Array;countries["Malaysia"]["id"]=66;countries["Mexico"]=new Array;countries["Mexico"]["id"]=26;countries["Montenegro"]=new Array;countries["Montenegro"]["id"]=80;countries["Netherlands"]=new Array;countries["Netherlands"]["id"]=31;countries["New-Zealand"]=new Array;countries["New-Zealand"]["id"]=84;countries["North-Korea"]=new Array;countries["North-Korea"]["id"]=73;countries["Norway"]=new Array;countries["Norway"]["id"]=37;countries["Pakistan"]=new Array;countries["Pakistan"]["id"]=57;countries["Paraguay"]=new Array;countries["Paraguay"]["id"]=75;countries["Peru"]=new Array;countries["Peru"]["id"]=77;countries["Philippines"]=new Array;countries["Philippines"]["id"]=67;countries["Poland"]=new Array;countries["Poland"]["id"]=35;countries["Portugal"]=new Array;countries["Portugal"]["id"]=53;countries["Republic-of-China-Taiwan"]=new Array;countries["Republic-of-China-Taiwan"]["id"]=81;countries["Republic-of-Macedonia-FYROM"]=new Array;countries["Republic-of-Macedonia-FYROM"]["id"]=79;countries["Republic-of-Moldova"]=new Array;countries["Republic-of-Moldova"]["id"]=52;countries["Romania"]=new Array;countries["Romania"]["id"]=1;countries["Russia"]=new Array;countries["Russia"]["id"]=41;countries["Saudi-Arabia"]=new Array;countries["Saudi-Arabia"]["id"]=164;countries["Serbia"]=new Array;countries["Serbia"]["id"]=65;countries["Singapore"]=new Array;countries["Singapore"]["id"]=68;countries["Slovakia"]=new Array;countries["Slovakia"]["id"]=36;countries["Slovenia"]=new Array;countries["Slovenia"]["id"]=61;countries["South-Africa"]=new Array;countries["South-Africa"]["id"]=51;countries["South-Korea"]=new Array;countries["South-Korea"]["id"]=47;countries["Spain"]=new Array;countries["Spain"]["id"]=15;countries["Sweden"]=new Array;countries["Sweden"]["id"]=38;countries["Switzerland"]=new Array;countries["Switzerland"]["id"]=30;countries["Thailand"]=new Array;countries["Thailand"]["id"]=59;countries["Turkey"]=new Array;countries["Turkey"]["id"]=43;countries["Ukraine"]=new Array;countries["Ukraine"]["id"]=40;countries["United-Arab-Emirates"]=new Array;countries["United-Arab-Emirates"]["id"]=166;countries["United-Kingdom"]=new Array;countries["United-Kingdom"]["id"]=29;countries["Uruguay"]=new Array;countries["Uruguay"]["id"]=74;countries["USA"]=new Array;countries["USA"]["id"]=24;countries["Venezuela"]=new Array;countries["Venezuela"]["id"]=28;egovatwarWait();function egovatwarWait(){if(typeof unsafeWindow.jQuery=='undefined'){window.setTimeout(egovatwarWait,100)}else{egovatwarStart()}}function egovatwarStart(){if(window.location.href.split("/").length==4){checkUpdate();getOrders()}else if(window.location.href.indexOf("/military/campaigns")>0){getOrders()}var str='';str='<div id="egovatwarSidebar" style="font-size:10px;font-weight:bold;color:#333;">egovatwar <a target="_blank" href="http://userscripts.org/scripts/show/162001">v'+egovatwar+'</a><select id="selectCountry" style="margin-top:3px;width:150px;font-size:10px;">';for(country in countries){if(countries[country].id==egovatwarCountry){str=str+'<option value="'+countries[country].id+'" selected="selected">'+country+'</option>'}else{str=str+'<option value="'+countries[country].id+'">'+country+'</option>'}}str=str+'</select></div>';$(".user_finances").after(str);$('#selectCountry').change(function(){GM_setValue('egovatwarCountry',$(this).val());window.location=location.href})}function getOrders(){$.getJSON('http://www.egov4you.info/orders/data/'+egovatwarCountry,function(json){var division=getDivision(parseInt($(".user_level b").text()));var str='';if(json.target&&json.target.battle!=null&&(json.target.div==null||json.target.div==division)){str=str+'<h4 class="hq" style="display:none;">'+json.alliance+' HeadQuarters <span style="color:#b6b6b6;font-size:90%;font-weight:normal;">(updated in day '+json.target.updated+')</span></h4>';str=str+'<ul class="hq" style="display:none;">';str=str+'<li id=\'order6\'>';if(json.target.note.length==0){json.target.note='Fight!'}for(i=0;i<json.target.stars;i++){position=4+(i*16);str=str+'<img style="position:absolute;left:'+position+'px;top:26px;width:16px;margin:0;" alt="*" src="http://cdn.egov4you.info/img/star.png"></div>'}str=str+'<span style="position:absolute;left:7px;top:6px;font-size:12px;line-height:12px;color:#333;font-weight:bold;">'+json.target.region+'</span>';str=str+'<span style="position:absolute;left:7px;top:17px;font-size:10px;line-height:10px;color:#333;width:195px;overflow:hidden;white-space:nowrap;">'+json.target.note+'</span>';if(json.target.side!=null){str=str+'<a title="" href="/en/military/battlefield-choose-side/'+json.target.battle+'/'+json.target.side+'"><span>Fight</span></a>'}else{str=str+'<a title="" href="/en/military/battlefield/'+json.target.battle+'"><span>Fight</span></a>'}str=str+'</li>';str=str+'</ul>'}if(json.orders){var checkBattles=false;$.each(json.orders,function(index){if(json.orders[index].battle!=null){checkBattles=true}});if(checkBattles){str=str+'<h4 class="mod" style="display:none;">Ministry of Defence <span style="color:#b6b6b6;font-size:90%;font-weight:normal;">(updated in day '+json.updated+')</span></h4>';str=str+'<ul class="mod" style="display:none;">';$.each(json.orders,function(index){if(json.orders[index].battle!=null&&(json.orders[index].div==null||json.orders[index].div==division)){str=str+'<li id=\'order'+json.orders[index].order+'\' style="display:none;">';if(json.orders[index].note.length==0){json.orders[index].note='Fight!'}for(i=0;i<json.orders[index].stars;i++){position=4+(i*16);str=str+'<img style="position:absolute;left:'+position+'px;top:26px;width:16px;margin:0;" alt="*" src="http://cdn.egov4you.info/img/star.png"></div>'}str=str+'<span style="position:absolute;left:7px;top:6px;font-size:12px;line-height:12px;color:#333;font-weight:bold;">'+json.orders[index].region+'</span>';str=str+'<span style="position:absolute;left:7px;top:17px;font-size:10px;line-height:10px;color:#333;width:195px;overflow:hidden;white-space:nowrap;">'+json.orders[index].note+'</span>';if(json.orders[index].side!=null){str=str+'<a title="" href="/en/military/battlefield-choose-side/'+json.orders[index].battle+'/'+json.orders[index].side+'"><span>Fight</span></a>'}else{str=str+'<a title="" href="/en/military/battlefield/'+json.orders[index].battle+'"><span>Fight</span></a>'}str=str+'</li>'}});str=str+'</ul>'}}$("#rw_pop").after(str);if(json.target&&(json.target.div==null||json.target.div==division)){getPointsWall(json.target.battle,'6',division)}if(json.orders){if(checkBattles){$.each(json.orders,function(index){if(json.orders[index].battle!=null&&(json.orders[index].div==null||json.orders[index].div==division)){getPointsWall(json.orders[index].battle,json.orders[index].order,division)}})}}if(window.location.href.split("/").length==4){if(json.shouts){var shouts='';$.each(json.shouts,function(index){if(json.shouts[index].text.length>0){shouts=shouts+'<ol class="wall_post">';if(json.shouts[index].alliance!=null){shouts=shouts+'<a class="user_pic" target="_blank" title="" href="http:/en/main/alliances">';shouts=shouts+'<span></span>';shouts=shouts+'<img alt="" src="http://cdn.egov4you.info/img/about2.png">'}else{shouts=shouts+'<a class="user_pic" target="_blank" title="" href="http://www.erepublik.com/en/military/campaigns">';shouts=shouts+'<span></span>';shouts=shouts+'<img alt="" src="http://cdn.egov4you.info/img/about1.png">'}shouts=shouts+'</a>';shouts=shouts+'<div class="post_content">';shouts=shouts+'<h6>';if(json.shouts[index].alliance!=null){shouts=shouts+'<a title="" href="http:/en/main/alliances">'+json.shouts[index].alliance+' HeadQuarters</a>'}else{shouts=shouts+'<a title="" href="http://www.erepublik.com/en/military/campaigns">Ministry of Defence</a>'}shouts=shouts+'<em>wrote in day '+json.shouts[index].updated+'</em>';shouts=shouts+'</h6>';shouts=shouts+'<p>'+json.shouts[index].text+'</p>';shouts=shouts+'</div>';shouts=shouts+'</ol>'}});$(".wall_post_list ul li:first").before(shouts)}}})}function checkUpdate(){function drawUpdate(){$(".new_banners_wrapper").remove();$("#mapContainer").before('<div id="egovatwarAlert"></div>');$("#egovatwarAlert").append('<div style="clear:both;text-align:center;margin:10px;font-size:14px;"><span>Your current version of egovatwar script is out of date. Update it <a href="'+scriptLink+'">here</a>.</span></div>')}GM_xmlhttpRequest({method:"GET",url:metaLink,onload:function(text){var meta=text.responseText;var from=meta.indexOf("@version")+8;var to=meta.indexOf("\n",from);var ver=meta.substring(from,to).trim();ver=ver.replace('.','');ver=ver.replace('.','');var old=egovatwar.replace('.','');old=old.replace('.','');if(parseInt(old)<parseInt(ver)){drawUpdate()}}})}function getDivision(e){if(e<25)return 1;if(e<30)return 2;if(e<37)return 3;return 4}function getPointsWall(battleId,order,division){$.getJSON("/en/military/battle-status/"+battleId+"/1",function(json){if(json['message']!='BATTLE_CLOSED'){var countryIdL=Object.getOwnPropertyNames(json['division'])[0];var countryIdR=Object.getOwnPropertyNames(json['division'])[1];var domination=Math.round(json['division']['domination'][division]*1000)/1000;domination=domination.toFixed(3);var bar=json['division']['bar'][division];if(domination>50){if(bar==countryIdL){var wallL=domination;var wallR=100-domination}else{var wallR=domination;var wallL=100-domination}}else{if(bar==countryIdL){var wallR=domination;var wallL=100-domination}else{var wallL=domination;var wallR=100-domination}}var dominationL=json['division'][countryIdL][division]['domination'];var dominationR=json['division'][countryIdR][division]['domination'];var totalL=json['division'][countryIdL]['total'];var totalR=json['division'][countryIdR]['total'];if(window.location.href.indexOf("/military/campaigns")>0){wallL=Number(wallL).toFixed(3);wallR=Number(wallR).toFixed(3);showPoints(order,countryIdL,countryIdR,wallL,wallR,dominationL,dominationR,totalL,totalR)}else{wallL=Number(wallL).toFixed(2);wallR=Number(wallR).toFixed(2);showWall(order,countryIdL,countryIdR,wallL,wallR,dominationL,dominationR,totalL,totalR)}if(order==6){$(".hq").show('slow')}else{$(".mod").show('slow');$("#order"+order).show('slow')}}})}function showPoints(order,countryIdL,countryIdR,wallL,wallR,dominationL,dominationR,totalL,totalR){var str='';str=str+'<img style="position:absolute;left:210px;top:2px;height:16px;border:solid #666 1px;" src="http://cdn.egov4you.info/img/flags/'+countryIdL+'.gif">';str=str+'<img style="position:absolute;left:276px;top:2px;height:16px;border:solid #666 1px;" src="http://cdn.egov4you.info/img/flags/'+countryIdR+'.gif">';str=str+'<span style="width:14px;text-align:left;position:absolute;left:239px;top:17px;font-size:10px;line-height:10px;color:#333;font-weight:bold;">'+totalL+'</span>';str=str+'<span style="width:14px;text-align:right;position:absolute;left:258px;top:17px;font-size:10px;line-height:10px;color:#333;font-weight:bold;">'+totalR+'</span>';str=str+'<span style="width:30px;text-align:right;position:absolute;left:315px;top:17px;font-size:10px;line-height:10px;color:#333;font-weight:bold;">'+dominationL+'</span>';str=str+'<span style="width:30px;text-align:left;position:absolute;left:627px;top:17px;font-size:10px;line-height:10px;color:#333;font-weight:bold;">'+dominationR+'</span>';str=str+'<div style="position:absolute;left:350px;top:10px;width:270px;height:22px;margin:0;padding:0;';str=str+'background: -moz-linear-gradient(left,  #33cc33 0%, #33cc33 '+wallL+'%, #cc3333 '+wallL+'%, #cc3333 100%);';str=str+'background: -webkit-gradient(linear, left top, right top, color-stop(0%,#33cc33), color-stop('+wallL+'%,#33cc33), color-stop('+wallL+'%,#cc3333), color-stop(100%,#cc3333));';str=str+'background: -webkit-linear-gradient(left,  #33cc33 0%,#33cc33 '+wallL+'%,#cc3333 '+wallL+'%,#cc3333 100%);';str=str+'background: -o-linear-gradient(left,  #33cc33 0%,#33cc33 '+wallL+'%,#cc3333 '+wallL+'%,#cc3333 100%);';str=str+'background: -ms-linear-gradient(left,  #33cc33 0%,#33cc33 '+wallL+'%,#cc3333 '+wallL+'%,#cc3333 100%);';str=str+'background: linear-gradient(to right,  #33cc33 0%,#33cc33 '+wallL+'%,#cc3333 '+wallL+'%,#cc3333 100%);';str=str+'border:solid #666 1px;">';str=str+'<span style="width:45px;text-align:left;position:absolute;left:7px;bottom:6px;font-size:10px;line-height:10px;color:#fff;font-weight:bold;">'+wallL+'%</span>';str=str+'<span style="width:45px;text-align:right;position:absolute;right:6px;bottom:6px;font-size:10px;line-height:10px;color:#fff;font-weight:bold;">'+wallR+'%</span>';str=str+'</div>';$("#order"+order).append(str)}function showWall(order,countryIdL,countryIdR,wallL,wallR,dominationL,dominationR,totalL,totalR){var str='';str=str+'<div style="position:absolute;left:137px;top:29px;width:80px;height:11px;margin:0;padding:0;';str=str+'background: -moz-linear-gradient(left,  #33cc33 0%, #33cc33 '+wallL+'%, #cc3333 '+wallL+'%, #cc3333 100%);';str=str+'background: -webkit-gradient(linear, left top, right top, color-stop(0%,#33cc33), color-stop('+wallL+'%,#33cc33), color-stop('+wallL+'%,#cc3333), color-stop(100%,#cc3333));';str=str+'background: -webkit-linear-gradient(left,  #33cc33 0%,#33cc33 '+wallL+'%,#cc3333 '+wallL+'%,#cc3333 100%);';str=str+'background: -o-linear-gradient(left,  #33cc33 0%,#33cc33 '+wallL+'%,#cc3333 '+wallL+'%,#cc3333 100%);';str=str+'background: -ms-linear-gradient(left,  #33cc33 0%,#33cc33 '+wallL+'%,#cc3333 '+wallL+'%,#cc3333 100%);';str=str+'background: linear-gradient(to right,  #33cc33 0%,#33cc33 '+wallL+'%,#cc3333 '+wallL+'%,#cc3333 100%);';str=str+'border:solid #666 1px;">';str=str+'<img style="position:absolute;left:-16px;bottom:0;width:12px;height:9px;border:solid #666 1px;" src="http://cdn.egov4you.info/img/flags/'+countryIdL+'.gif">';str=str+'<img style="position:absolute;right:-16px;bottom:0;width:12px;height:9px;border:solid #666 1px;" src="http://cdn.egov4you.info/img/flags/'+countryIdR+'.gif">';str=str+'<span style="width:40px;text-align:left;position:absolute;left:3px;bottom:1px;font-size:10px;line-height:10px;color:#fff;font-weight:bold;">'+wallL+'</span>';str=str+'<span style="width:40px;text-align:right;position:absolute;right:2px;bottom:1px;font-size:10px;line-height:10px;color:#fff;font-weight:bold;">'+wallR+'</span>';str=str+'</div>';$("#order"+order).append(str)}