// ==UserScript==
// @name           iGoogle Reader Bubble Resizer
// @namespace      iGoogleReaderBubbleResizer
// @include           http://www.google.com/ig
// @include            http://www.google.ae/ig
// @include            http://www.google.am/ig
// @include        http://www.google.com.ar/ig
// @include            http://www.google.at/ig
// @include        http://www.google.com.au/ig
// @include            http://www.google.az/ig
// @include            http://www.google.be/ig
// @include            http://www.google.bf/ig
// @include            http://www.google.bg/ig
// @include            http://www.google.bi/ig
// @include            http://www.google.bj/ig
// @include        http://www.google.com.bo/ig
// @include        http://www.google.com.br/ig
// @include         http://www.google.co.bw/ig
// @include        http://www.google.com.by/ig
// @include            http://www.google.ca/ig
// @include            http://www.google.cd/ig
// @include            http://www.google.cf/ig
// @include            http://www.google.cg/ig
// @include            http://www.google.ch/ig
// @include            http://www.google.ci/ig
// @include            http://www.google.cl/ig
// @include            http://www.google.cm/ig
// @include            http://www.google.cn/ig
// @include            http://www.google.co/ig
// @include        http://www.google.com.co/ig
// @include         http://www.google.co.cr/ig
// @include            http://www.google.cz/ig
// @include            http://www.google.de/ig
// @include         http://www.google.co.de/ig
// @include            http://www.google.dj/ig
// @include            http://www.google.dk/ig
// @include        http://www.google.com.do/ig
// @include            http://www.google.dz/ig
// @include        http://www.google.com.ec/ig
// @include            http://www.google.ee/ig
// @include        http://www.google.com.eg/ig
// @include            http://www.google.es/ig
// @include        http://www.google.com.et/ig
// @include            http://www.google.fi/ig
// @include            http://www.google.fr/ig
// @include            http://www.google.ga/ig
// @include        http://www.google.com.gh/ig
// @include            http://www.google.gm/ig
// @include            http://www.google.gr/ig
// @include         http://www.google.co.gs/ig
// @include        http://www.google.com.gs/ig
// @include        http://www.google.com.gt/ig
// @include        http://www.google.com.hk/ig
// @include            http://www.google.hn/ig
// @include            http://www.google.hr/ig
// @include            http://www.google.hu/ig
// @include         http://www.google.co.id/ig
// @include            http://www.google.ie/ig
// @include         http://www.google.co.il/ig
// @include         http://www.google.co.in/ig
// @include            http://www.google.is/ig
// @include            http://www.google.it/ig
// @include         http://www.google.co.it/ig
// @include            http://www.google.jo/ig
// @include            http://www.google.jp/ig
// @include         http://www.google.co.jp/ig
// @include         http://www.google.co.ke/ig
// @include            http://www.google.kg/ig
// @include        http://www.google.com.kg/ig
// @include         http://www.google.co.kr/ig
// @include            http://www.google.kz/ig
// @include         http://www.google.co.ls/ig
// @include            http://www.google.lt/ig
// @include            http://www.google.lv/ig
// @include         http://www.google.co.ma/ig
// @include            http://www.google.md/ig
// @include            http://www.google.mg/ig
// @include            http://www.google.ml/ig
// @include            http://www.google.mu/ig
// @include            http://www.google.mw/ig
// @include        http://www.google.com.mx/ig
// @include        http://www.google.com.my/ig
// @include         http://www.google.co.mz/ig
// @include        http://www.google.com.na/ig
// @include            http://www.google.ne/ig
// @include        http://www.google.com.ng/ig
// @include            http://www.google.nl/ig
// @include            http://www.google.no/ig
// @include         http://www.google.co.nz/ig
// @include        http://www.google.com.om/ig
// @include        http://www.google.com.pa/ig
// @include        http://www.google.com.pe/ig
// @include         http://www.google.co.ph/ig
// @include        http://www.google.com.ph/ig
// @include        http://www.google.com.pk/ig
// @include            http://www.google.pl/ig
// @include         http://www.google.co.pl/ig
// @include        http://www.google.com.pr/ig
// @include            http://www.google.pt/ig
// @include        http://www.google.com.py/ig
// @include            http://www.google.re/ig
// @include            http://www.google.ro/ig
// @include            http://www.google.rs/ig
// @include            http://www.google.ru/ig
// @include            http://www.google.rw/ig
// @include        http://www.google.com.sa/ig
// @include            http://www.google.sc/ig
// @include            http://www.google.se/ig
// @include        http://www.google.com.sg/ig
// @include            http://www.google.si/ig
// @include            http://www.google.sk/ig
// @include        http://www.google.com.sl/ig
// @include            http://www.google.sn/ig
// @include         http://www.google.co.sr/ig
// @include            http://www.google.st/ig
// @include         http://www.google.co.st/ig
// @include        http://www.google.com.sv/ig
// @include            http://www.google.td/ig
// @include            http://www.google.tg/ig
// @include         http://www.google.co.th/ig
// @include        http://www.google.com.tj/ig
// @include            http://www.google.tm/ig
// @include        http://www.google.com.tr/ig
// @include        http://www.google.com.tw/ig
// @include         http://www.google.co.tz/ig
// @include        http://www.google.com.ua/ig
// @include         http://www.google.co.ug/ig
// @include         http://www.google.co.uk/ig
// @include        http://www.google.com.uy/ig
// @include         http://www.google.co.uz/ig
// @include         http://www.google.co.ve/ig
// @include        http://www.google.com.vn/ig
// @include         http://www.google.co.za/ig
// @include         http://www.google.co.zm/ig
// @include         http://www.google.co.zw/ig
// ==/UserScript==

(function() {
    GM_log('Starting...');
    
    var findAndApplyToBubbleRunning = false;
    var dragging = false;
    
    var dragState = {
        startTop : -1,
        startLeft : -1,
        startWidth : -1,
        startHeight : -1,
        startPointTop : -1,
        startMouseX : 0,
        startMouseY : 0,
        bubbleDivs : {
            frame : null,
            handleN : null,
            handleS : null,
            handleE : null,
            handleW : null,
            handleNE : null,
            handleNW : null,
            handleSE : null,
            handleSW : null,
            header : null,
            scroller : null,
            point : null,
            overlay : null
        },
        handlers : { 
            mouseUp : function() { },
            mouseMove : function() { }
        }
    };
    
    var hasReaders = (function() {
        var anchors = document.getElementsByClassName('gwt-Anchor') || [];
        for (var i = 0, len = anchors.length; i < len; i++) {
            if (('' + anchors[i].getAttribute('title')).toLowerCase() === 'google reader') {
                GM_log('Found "Google Reader" widget...');
                return true;
            }
        }
        return false;
    })();
    
    if (!!hasReaders) {    
        var getOnMouseMoveFunction = function(t, l, w, h) { return function(e) {
            if (!!!dragging) return;
            window.getSelection().removeAllRanges();
            
            var diffX = e.clientX - dragState.startMouseX,
                diffY = e.clientY - dragState.startMouseY;
                    
            var top = (dragState.startTop + (t * diffY)),
                left = (dragState.startLeft + (l * diffX)),
                width = (dragState.startWidth + (w * diffX)),
                height = (dragState.startHeight + (h * diffY)),
                pointTop = (dragState.startPointTop - (t * diffY));
            
            with (dragState.bubbleDivs) {
                frame.style.top = ('' + top + 'px');
                frame.style.left = ('' + left + 'px');
                frame.style.width = handleN.style.width = handleS.style.width = header.style.width = scroller.style.width = ('' + width + 'px');
                frame.style.height = handleE.style.height = handleW.style.height = ('' + height + 'px');
                
                point.style.marginTop = ('' + pointTop + 'px');
                
                scroller.style.height = ('' + (height - header.offsetHeight) + 'px');
                handleS.style.top = handleSE.style.top = handleSW.style.top = ('' + (height + handleN.offsetHeight) + 'px');
            }
        }; };
        
        var getOnMouseUpFunction = function(t, l, w, h) { return function(e) {
            if (!!!dragging) return;
            dragging = false;
            document.removeEventListener('mousemove', dragState.handlers.mouseMove, false);
            document.removeEventListener('mouseup', dragState.handlers.mouseUp, false);
            document.body.removeChild(dragState.bubbleDivs.overlay);
            delete dragState.bubbleDivs.overlay;
            dragState.bubbleDivs.overlay = null;
        }; };
        
        var getOnMouseDownFunction = function(t, l, w, h) { return function(e) {
            if (!!dragging) return;
            dragging = true;
            with (dragState.bubbleDivs) {
                dragState.startTop = frame.offsetTop;
                dragState.startLeft = frame.offsetLeft;
                dragState.startWidth = (frame.offsetWidth - handleE.offsetWidth - handleW.offsetWidth);
                dragState.startHeight = (frame.offsetHeight - handleN.offsetHeight - handleS.offsetHeight);
                dragState.startPointTop = parseFloat(point.style.marginTop);
            }
            with (dragState) {
                startMouseX = e.clientX;
                startMouseY = e.clientY;
                handlers = {
                    mouseUp   : getOnMouseUpFunction(t, l, w, h),
                    mouseMove : getOnMouseMoveFunction(t, l, w, h)
                };
                
                bubbleDivs.overlay = document.createElement('div');
            };
            with (dragState.bubbleDivs.overlay.style) {
                position = 'absolute';
                top = '0px';
                left = '0px';
                right = '0px';
                bottom = '0px';
                opacity = 0.5;
                backgroundColor = '#333333';
                zIndex = 1000;
            };
            document.body.appendChild(dragState.bubbleDivs.overlay);            
            document.addEventListener('mouseup', dragState.handlers.mouseUp, false);
            document.addEventListener('mousemove', dragState.handlers.mouseMove, false);
        }; };
            
        var findAndApplyToBubble = function() {        
            if (findAndApplyToBubbleRunning) return;
            findAndApplyToBubbleRunning = true;
        
            dragState.bubbleDivs.frame = (function() {
                var bubbleObjects = document.getElementsByClassName('bubble') || [];
                for (var i = 0, len = bubbleObjects.length; i < len; i++) {
                    if (('' + bubbleObjects[i].nodeName).toLowerCase() === 'div') {
                        return bubbleObjects[i];
                    }
                }
                return false;
            })();
            
            if (!!dragState.bubbleDivs.frame && dragState.bubbleDivs.frame.getAttribute('iGoogleReaderBubbleResizerApplied') !== 'true') {
                dragState.bubbleDivs.frame.style.zIndex = 1001;
            
                with (dragState.bubbleDivs) {
                    point = (frame.getElementsByClassName('point') || [null])[0];
                    header = (frame.getElementsByClassName('header') || [null])[0];
                    scroller = (frame.getElementsByClassName('scroller') || [null])[0];
                    handleN  = (frame.getElementsByClassName('n')  || [null])[0];
                    handleS  = (frame.getElementsByClassName('s')  || [null])[0];
                    handleE  = (frame.getElementsByClassName('e')  || [null])[0];
                    handleW  = (frame.getElementsByClassName('w')  || [null])[0];
                    handleNE = (frame.getElementsByClassName('ne') || [null])[0];
                    handleNW = (frame.getElementsByClassName('nw') || [null])[0];
                    handleSE = (frame.getElementsByClassName('se') || [null])[0];
                    handleSW = (frame.getElementsByClassName('sw') || [null])[0];
                    
                    if (!!point && !!header && !!scroller && !!handleN && !!handleS && !!handleE && !!handleW && !!handleNE && !!handleNW && !!handleSE && !!handleSW) {
                        var anchorLeft = !!(('' + point.getAttribute('class')).indexOf('point-left') !== -1);
                        var anchorRight = !!(('' + point.getAttribute('class')).indexOf('point-right') !== -1);
                        
                        handleN.style.cursor  = 'n-resize';
                        handleS.style.cursor  = 's-resize';
                        handleE.style.cursor  = anchorLeft  ? 'e-resize'  : 'normal';
                        handleNE.style.cursor = anchorLeft  ? 'ne-resize' : 'normal';
                        handleSE.style.cursor = anchorLeft  ? 'se-resize' : 'normal';
                        handleW.style.cursor  = anchorRight ? "w-resize"  : 'normal';
                        handleNW.style.cursor = anchorRight ? 'nw-resize' : 'normal';
                        handleSW.style.cursor = anchorRight ? 'sw-resize' : 'normal';
                        
                        GM_log('Adding event listeners...');

                        handleN.addEventListener('mousedown', getOnMouseDownFunction(1, 0, 0, -1), true);
                        handleS.addEventListener('mousedown', getOnMouseDownFunction(0, 0, 0, 1), true);

                        if (anchorLeft) {
                            handleE.addEventListener('mousedown', getOnMouseDownFunction(0, 0, 1, 0), true);
                            handleNE.addEventListener('mousedown', getOnMouseDownFunction(1, 0, 1, -1), true);
                            handleSE.addEventListener('mousedown', getOnMouseDownFunction(0, 0, 1, 1), true);
                        }
                        else if (anchorRight) {
                            handleW.addEventListener('mousedown', getOnMouseDownFunction(0, 1, -1, 0), true);
                            handleNW.addEventListener('mousedown', getOnMouseDownFunction(1, 1, -1, -1), true);
                            handleSW.addEventListener('mousedown', getOnMouseDownFunction(0, 1, -1, 1), true);
                        }
                    }
                    frame.setAttribute('iGoogleReaderBubbleResizerApplied', 'true');
                }
            }
            
            findAndApplyToBubbleRunning = false;
        }
        
        window.setInterval(findAndApplyToBubble, 1000);
    }
})()