// ==UserScript==
// @name	Tieba Multiuser
// @namespace	http://gera2ld.blog.163.com/
// @author	Gerald <gera2ld@163.com>
// @icon	http://s.gravatar.com/avatar/a0ad718d86d21262ccd6ff271ece08a3?s=80
// @version	1.3.1.1
// @description	百度贴吧马甲切换
// @homepage	http://userscripts.org/scripts/show/154072
// @downloadURL	https://userscripts.org/scripts/source/154072.user.js
// @updateURL	https://userscripts.org/scripts/source/154072.meta.js
// @include	http://tieba.baidu.com/*
// @require	http://userscripts.org/scripts/source/186749.user.js
// @grant	GM_getValue
// @grant	GM_setValue
// @grant	GM_registerMenuCommand
// ==/UserScript==
function e(e,t){var o=GM_getValue(e,"");return o&&"string"==typeof o&&(o=JSON.parse(o)),o||t}function t(e,t){GM_setValue(e,JSON.stringify(t))}function o(e,t){var o=new Date;e?o.setTime(16094e8):e="",document.cookie="BDUSS="+e+";domain=baidu.com;path=/;expires="+o.toGMTString(),"function"==typeof t?t():"string"==typeof t?location.replace(t):location.reload()}function n(){t("ge_users",s)}function i(e,t,i){e.preventDefault(),i=e.target,e=i.parentNode,t=e.parentNode,"A"==i.tagName?e==t.firstChild?o():e==t.lastChild?location.href="http://wappass.baidu.com/?login&u="+encodeURIComponent(location.href):o(s[i.innerText||i.textContent]):"SPAN"==i.tagName&&(i=i.previousSibling,delete s[i.innerText||i.textContent],setTimeout(n,0),t.removeChild(e))}function r(e){utils.addStyle("#ge_tu>li{position:relative;cursor:pointer;}#ge_tu span{position:absolute;top:0;right:0;background:#77f;color:white;border-radius:3px;border:1px solid;border:none;margin:2px;padding:2px;cursor:pointer;line-height:1em;}"),$("<li class=split>").prependTo(e);var t=$('<li><div class="u_menu_item"><a href=# class=u_menu_wrap style="margin-top:-2px;">马甲</a></div></li>').prependTo(e).mouseover(function(){o.show(),n.addClass("u_menu_hover")}).mouseout(function(){o.hide(),n.removeClass("u_menu_hover")}),o=$("<div class=u_ddl>").hide().appendTo(t),n=t.children().first();$('<div class=u_ddl_tit style="left:1px;">').appendTo(o).width(t.innerWidth()-2),c=$("<ul id=ge_tu>").appendTo($('<div class="u_ddl_con u_ddl_con_top">').appendTo(o)).click(i),a()}function a(){if(d=[],s){d.push("<li><a href=#>未登录状态</a></li>");for(var e in s)e?d.push("<li><a href=#>"+e.replace(/&/g,"&amp;").replace(/</g,"&lt;")+"</a><span>删</span></li>"):delete s[e]}else d.push('<li title="未检测到Cookie，请任意添加一个马甲或自行去除对应Cookie的HttpOnly属性。" style="color:gray">未检测到Cookie</li>');d.push("<li><a href=#>添加马甲</a></li>"),c.html(d.join(""))}function l(){utils.popup.show({html:'<h3>设置 - 贴吧马甲切换脚本</h3><fieldset><legend>马甲数据 <button id=gu_import>导入</button> <button id=gu_export>导出</button> <a title="复制数据到以下文本框然后点击导入即可导入数据。\n点击导出后复制数据文本即可用于导入。">(?)</a></legend><textarea id=gu_data></textarea></fieldset>',className:"ge_opt",init:function(e){var t=e.querySelector("#gu_data");t.onclick=function(){this.select()},e.querySelector("#gu_import").onclick=function(e){try{e=JSON.parse(t.value)}catch(o){e=null}if(e&&"object"==typeof e){for(var i in e)s[i]=e[i];n(),a(),alert("导入成功！")}else alert("导入失败！")},e.querySelector("#gu_export").onclick=function(){t.value=JSON.stringify(s)}}})}function u(t,o){function i(e){"com_userbar"==e.target.parentNode.id&&(document.body.removeEventListener("DOMNodeInserted",i,!1),r(e.target))}s=e("ge_users",{}),(t=PageData)&&t.user&&t.user.is_login&&t.user.name&&(t=t.user.name),t&&(o=document.cookie.match(/BDUSS=(.*?)(;|$)/),o?(s[t]=o[1],n()):s=null),GM_registerMenuCommand("贴吧马甲设置",l),document.body.addEventListener("DOMNodeInserted",i,!1)}var s,c;document.querySelector("a[param=word]")&&u();