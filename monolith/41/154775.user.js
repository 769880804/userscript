// ==UserScript==
// @name	Tieba Sign
// @namespace	http://gera2ld.blog.163.com/
// @author	Gerald <gera2ld@163.com>
// @version	1.0
// @description	贴吧签到
// @downloadURL	https://userscripts.org/scripts/source/154159.user.js
// @updateURL	https://userscripts.org/scripts/source/154159.meta.js
// @include	http://tieba.baidu.com/*
// @exclude	http://tieba.baidu.com/tb/*
// @include	http://wapp.baidu.com/*
// ==/UserScript==
(function(){function e(e){var a=$('<iframe style="display:none" id=ge_wap>').appendTo("body")[0].contentWindow;a&&(a.name="ge_wap"),unsafeWindow.wapcallback=e}if("undefined"!=typeof unsafeWindow?($=unsafeWindow.$,PageData=unsafeWindow.PageData):unsafeWindow=window,/^ge_wap/.test(unsafeWindow.name))return function(){var e,a;if("tieba.baidu.com"==location.host)e=unsafeWindow.name,unsafeWindow.name="ge_wap",a=document.createElement("script"),a.innerHTML="wapcallback("+e[6]+","+JSON.stringify(e.substr(7))+");",parent.document.body.appendChild(a),parent.document.body.removeChild(a);else{if("ge_wap"==unsafeWindow.name)if(unsafeWindow.name="ge_wap_",e=document.querySelector("td[style]>*")){if("a"==e.tagName)return location.replace(e.href);unsafeWindow.name="span"==e.tagName?"ge_wap0已签到":"ge_wap1未知错误"}else unsafeWindow.name="ge_wap2未开通签到";else(e=document.querySelector("span.light"))?(a=e.innerText||e.textContent,unsafeWindow.name="ge_wap"+(/^签到成功/.test(a)?0:1)+a):unsafeWindow.name="ge_wap1签到错误";location.replace("http://tieba.baidu.com/i/data/panel")}}(),void 0;var a={getObj:function(e,a){if(e=localStorage.getItem(e),null!=e)try{return JSON.parse(e)}catch(n){}return a},setObj:function(e,a){localStorage.setItem(e,JSON.stringify(a))},bindProp:function(e,n,t,i,o,s){return e.prop(n,a.getObj(t,i)),s||(s=["change"]),s.forEach(function(i){e.bind(i,function(i){a.setObj(t,this[n]),o&&e.each(function(e,a){o.call(a,i)})})}),e}};unsafeWindow.PageData&&PageData.user&&PageData.user.is_login&&function(){function n(){function e(e,a){e=a?$('<span style="color:red" title="'+a+'">'+e+"<span>"):$('<div class="forum_sign" title="本吧已签到'+e+'" style="display: block;"> </div>'),e.insertBefore(i.children(".always_go_manage"))}var i=r.first(),o=i.children(".j_ba_link");r=r.not(i),n.mark=e,a.getObj("ge_wap")&&"1"==o.attr("forum-like")?$("#ge_wap").attr("src","http://wapp.baidu.com/f?kw="+o.attr("forum")):$.get(o.attr("href"),function(a){var n=a.match(/"is_sign_in":(\d+),"user_sign_rank":(\d+),/);if(n&&"1"==n[1])e("：排名"+n[2]);else{if(n=a.match(/PageData\.tbs = "(.*?)";/))return $.post("/sign/add",{ie:"utf-8",kw:o.html(),tbs:n[1]},function(a){a.no?e("出错",a.no+": "+a.error):e("：排名"+a.data.uinfo.user_sign_rank),setTimeout(t,0)},"json");e("出错","未知错误")}setTimeout(t,0)}).error(function(a,n,i){e("出错",i||"未知错误"),setTimeout(t,0)})}function t(e){if(e){if(l.is(":visible"))return;l.show(),r=$("#always_go_list>ul>li:has(a.j_ba_link):not(:has(.forum_sign))"),r.children("span").remove()}r.length?setTimeout(n,e?0:2e3):l.hide()}var i;if(a.getObj("ge_sign",!0)&&!PageData.user.is_black&&(i=$("#sign_mod .j_cansign")).length)if(a.getObj("ge_wap")&&!$("#balv_dolike").length)e(function(e){e||(i.removeClass("j_cansign signstar_btn").addClass("signstar_signed").html('<span class="sign_keep_span">WAP签到成功</span>'),$("#signstar_wrapper").addClass("signstar_wrapper_signed"))}),$("#ge_wap").attr("src","http://wapp.baidu.com/f?kw="+PageData.forum.name);else{var o=unsafeWindow.Sign_rank;$.tb.post(o.sign_url,{kw:PageData.forum.name,tbs:PageData.tbs,ie:"utf-8"},function(e){if(e&&0==e.no){$(".j_today_signnum").html(e.data.finfo.current_rank_info.sign_count);var a=(PageData.forum.version>=2?2:1,new Date(e.data.uinfo.sign_time));o.sign_year=o.orign_year=a.getFullYear(),o.sign_month=o.orign_month=a.getMonth()+1,o.sign_load_month(1)}},"json")}if(unsafeWindow.oftenForum){$("#jsaddlike").html(function(e,a){return a.replace(/(自定义添加<\/a>)/,'$1<span class=add_like_sep> </span><a href=# class="j_tab add_like_tab" id=import_like>导入“我喜欢的贴吧”</a>')});var s=unsafeWindow.oftenForum.bindEventToFloatlayer;unsafeWindow.oftenForum.bindEventToFloatlayer=function(){var e=s.apply(this,arguments);return $("#import_like").click(function(e){function a(e){for(var i,o=RegExp('<a href="/f\\?kw=[^>]*?>(.*?)</a>',"g");i=o.exec(e);)$.post("/i/submit/add_user_favoforum",{ie:"utf-8",kw:i[1],tbs:PageData.tbs},function(e){e.is_done&&$("#imported").html(++t)},"json");n&&(n=!1,e.match(/\/f\/like\/mylike\?&pn=\d+">\d/g).forEach(function(e){$.get(e.slice(0,-3),a)}))}e.preventDefault(),$(this).replaceWith('<span class="j_tab add_like_tab" style="color:red">已添加 <span id=imported>0</span> 个贴吧</span> <a href=# onclick="location.reload();">刷新</a>');var n=!0,t=0;$.get("/f/like/mylike",a)}),e};var r,l=$('<span id=signing style="color:red;margin:0 20px;display:none">正在签到...</span>').appendTo("span.head_title"),d=$("<li>").addClass("nav_item").appendTo("ul.nav_bar").hover(function(){i.toggle()});$('<a href=# title="自动签到“我爱逛的贴吧”。如有需要，可在通过下面的“添加”导入所有“我喜欢的贴吧”~">自动签到</a>').appendTo(d).click(t),i=$('<div style="padding:10px;background:#d0dbed;display:none;z-index:10;position:absolute;width:80px;">').appendTo(d),a.bindProp($("<input type=checkbox id=wapsign>").appendTo(i),"checked","ge_wap",!1),$('<label for=wapsign title="自动签到和访问时模拟WAP签到">模拟WAP</label><br>').appendTo(i),a.bindProp($("<input type=checkbox id=autosign>").appendTo(i),"checked","ge_sign",!0),$('<label for=autosign title="访问贴吧时自动签到">访问时签到</label>').appendTo(i),e(function(e,a){e?n.mark("出错",a):n.mark(""),t()})}}()})();