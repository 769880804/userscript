// ==UserScript==
// @name           Power Tools - Deutsch
// @namespace      PDX
// @description    KoC Power Tools - German Version by PDX
// @homepage       http://koc.god-like.org
// @version        0.8.2
// @include        *apps.facebook.com/kingdomsofcamelot/*
// @include        *.kingdomsofcamelot.com/*main_src.php*
// @icon           http://koc.god-like.info/pdx.jpg
// @resource       URL_CASTLE_BUT          http://koc.god-like.info/schloss1.png
// @resource       URL_CASTLE_BUT_SEL       http://koc.god-like.info/schloss2.png
// @resource       URL_PROVINCE_MAP       http://koc.god-like.info/karte.png
// @require		   http://koc.god-like.info/update/auto-updater.php?id=98323
// ==/UserScript==

// VERSION
var Version = '0.8.2';
var Title = 'Power Tools - Deutsch';
// BOT VERSION
var BotVersion = '1.1.8';
// UPDATE VERSIONEN
var KoCScriptersPT = '20110804b';

// DEBUG
var DEBUG_BUTTON = true;
var DEBUG_TRACE = false;
var DEBUG_TRACE_DRAG = false;
var DEBUG_TRACE_AJAX = false;
var MAP_DELAY = 1500;
var DISABLE_POST_KNIGHT_SKILLS = false;
var DISABLE_POST_DEFENSES = false;
var ENABLE_TEST_TAB = true;
var SEND_ALERT_AS_WHISPER = false;
var TEST_WIDE = false;
var TEST_WIDE_CITIES = 7;
var ENABLE_SEARCH_TAB = false;

// BILDER
var URL_CASTLE_BUT = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAXCAMAAAGkBsQ5AAABa1BMVEX%2F%2F8X%2F98X%2F973%2F97X%2F77X%2F7633773%2F76X377X3763%2F5q3%2F5qX%2F5pz35q335qX%2F3pz%2F3pT33pz%2F1pT%2F1oz%2F1oT31pT31oz%2FzoT%2Fznv3zoT%2FxXv%2FxXP%2FxWv3xXv3xXP%2FvWv%2FvWP3vWv3vWP%2FtWP%2FtVr%2FtVLmvWv3tWP3tVr3tVL%2FrVL%2FrUrmtWP3rVL3rUrvrVL%2FpUrvrUr%2FpULmrVrmrVL3pUr3pULmpUL3nDrepULWpVLWpUrmnDrFpUK1pVrOnDqcnFKcnEqMnEp7lHN7lGtzlGNrlGtjjEpajFpShFJSe2NChEJKe1o6hDohjDFCc1oZjDEhhDEQjDEAlDEpezoZhDEhezoQhDEAjDEpczoZezoIhDEhc0IhczoAhDEZczoIezEhazoAezEhY0IAczEAcykIazEhWkIAazEAaykIYzEhUkIAYzEAWjEAUjEAUikASjEASikAQjEAQikAOjEAOikAMTEAMSkAKSlOGAcLAAAACXBIWXMAAAsSAAALEgHS3X78AAABVklEQVQYGQXBPW4TYRiF0ee%2B3x2DRSxRIFJTGIkVUFDQIbEDlkE5%2B8kWWEKKIBSB5AohXBGUSAaCIdgz3x%2FnaARztjS3RSPodPkmfuzReLbOh1fm72a4h3kxyWgE8NXPz8%2F%2FhC%2FzRXLM3cmeqvGDl7Mfa9ztT9pvp3%2FDOpjOr7Yft9PXjPHxE%2Bl6p4SJqSq5RsL4EAtZaUAjAABoBADAt%2Fty8ovVnhQ%2Bfx%2BbDTfXQ9Bz5H7IdWGV9k588NJWrQiXjMkdly6Fo9beRap29F4QJBxTE%2Bo9bF7XuUpJsp8BAGjcATSgADOQWRsfLu8WT0%2B33wcePknfJj%2B6j3Hb17m5HQsr1%2Fm4aGBEbtp8uXPWzcSBlhYYXKunObLoOyU1jFH02oVRZNFJQ2CCko26MIrC3MAEpRdcSVkYFYzBuaAuQFFAgzFBK0GVZhYoaUYYVm8b0IAGNDr8B8ZXpEbZNGQ6AAAAAElFTkSuQmCC";
var URL_CASTLE_BUT_SEL = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAXAgMAAAHuttyYAAAACVBMVEX%2F%2F%2F8AOjEAKSnbo5E5AAAACXBIWXMAAAsSAAALEgHS3X78AAAAW0lEQVQI12NYwdAAhCsYOICwQQGEpiYwrGpgCHRgcIChUAeGqaERDBMZJRgmMCDwqlUrgHgBQ2hoAIMjiwAYOzBgxyA1ILVTQ4GggWEKK4MIK4JiYGAgiYKYAgBFlyWR9CCfyAAAAABJRU5ErkJggg%3D%3D";
var URL_PROVINCE_MAP = "data:image/gif;base64,R0lGODlhxgLEAvcAAP%2F%2F%2F%2Ff%2F%2F%2Fv%2F8%2Ff3%2F%2Ff39%2Ff37%2F%2F%2Fpe%2F39%2F%2F%2FnO%2F37%2F%2F%2FlPf%2FnPf%2FlPHv9%2B%2Fv7%2F%2F3lO%2Fv5ubv7%2Ff3lPf3jO%2Fm7%2B%2F3jO%2F0lPfvlObm7%2Bb3jObm5u%2FvjN7m5ubvlObvjN7e5t3whN7e3ubmjObmhNbe1tbb3t7mjN7mhNbmhNbW1t7ehM7W1tTfe9TchM7O1s7OztbWe8XOzsXOxc7We8XWesXFzsXFxc7Oe73FxcXOe8XOc73Oc7XFtb69xdHYAL29vbW9vb3Fc7bGa7XFc7W1vbW1tbXSALW9a6rCY629a6yurq3KALXFAJjCWq21Y6uza6W1Y7W9AJy1Y6Okpa29AJ%2BtY621CJytWq21AJq9AKWwG5ucnJylWpSlWo2oUoylWpytAJSUlHyrSoyUlI%2BcWoycUoyUc4SeUoStAIyMlIyMjIyUUoSMjI2gAYSUUoSUSoSEjHuUSoSEhICEe3OhAHuEhHuMSoSUAHKOQnOMSmKYNHuUAHl7fHOEQmuSAGuEQnOMAHJzc3OEAGt7Omh7Qnt8AGN7Ompralp7Omt7AGNzOlpzOltzMVJ3MmN3AF9rOmFiY2trAEp6AFJrMUpsMSx%2BG1JrGVlbWmdjACh%2FAkprCEpjMUprAEpjKUJjKUJdQkpjCFBRU0hjAEJbOkJjCEJaKUdSRTpaOkJaGTpaKUJSOjpaIUpKSjpSOkJKSjFfBUJKQgB3ADpSITFSMR9eGDFSIQhrCAhrAEBBQzFQGTFSCClSGQBrADFSADFKIRlbBAhjAClKISlKGTg8OQBjAAhdCClKCCBLGAhaAEI6AClCGQBaABtKCCFCIQhSCCFCGSlBBwhSACFCEBlCISFCCCFCAC8xMgBSABlCEAhKCCA5GSE6EANKABk6EAhCCCkxABE7CBA6ECcpKQBCCAFAAAg6CBIwEAA6CBAxCCEhKQgxCB4hIQAxCAIxAAgpCAgpABkZIQApCBkZGQApABAZGQAhCAAhABAQGRAQEAAZAAgQEAgIEAgICAAICAAACAAAACwAAAAAxgLEAgAI%2FgABCBxIsKDBgwBCHAqlhgDChxAhFglEkY8DACkWhnEYsSNBG6xeCCSwJdShFCNLnvTIUuAhOQOnUAw0x%2BELSKG2tOyoQU4oSD9GjjFZQijRnRGLXArF5iKALTPlOLSBcwrSg0qWWhVINdRWAF2%2FXjXIgU%2BoQBoEpph5SKQDn2jHQpwSqiiAH5cuKRmIV6%2FchxouqRH4YmYglA7M8onw16AaiofCCFR6KejkvJb%2FEngc6JBOAmwg6wSQtXLjggTC%2FBQJQEOgUHKcuobt9DRXnBsBEJADeStdSDZsC1RyyLBIhQw5Im%2FYmLhhlBMrXswYKrfwgQ6GyWPFj8%2F1iJf4%2Fq2DJ06DA2vwuMO8%2FsIaP8th%2BLlaVx5A%2FPn1hRMI5C%2FUQFfiyWONAxqIkw4u%2FEhmGwGs6BOKOPj0AIAc%2FLACzzAXUciKPBgKpwQ%2F1nAHiUDD7LMOhwSEQB%2BCYl314TAsYkQeLvvslcKM%2FOxlW3b0hHIPLg085Y88J%2B51iD6s3MMKR8LdiI9IL9BjzTD4BPXCPVNW%2BR0Ah%2FwzIgBsDHliUJfgwwo%2Bl1ynATz4nJjmD%2FgMYw0%2BwcEpJ52NaSBPm%2FSMqCefIxahj5z0sGYbJA6us44GDNLDyj6H6OaKo5BeZ4OUrvwzWAr40LMOPYEAMAU%2FuIizDkq28eHpOvi8R4B2%2F9x5l9123TUWyKqtBhfeeOWdlx4%2F631XRD%2BSsbJObVsSRIA1oTjQwEVK9KNTqcj%2BFQY9ewa17DCk9WPVlN2OdloIVKIpkAPpQNLAs0%2F1s9eUTP5VQjqh2tAdAeLg0m4R%2BOq7hbvCHSJOCACEIk8Eegay7kVquJpvYyURoAE9aVJogwPrsDIhPxdnLFwIXgEQCD8oHbJOCM9KLE%2BadXB8HYP6yCNSIPikoGeaNNu88ndK4KNPpABcUl7KnEZ6SM3C2aDPFgQ4cBEk9GhQNABQS40P0HL1sM8Uz16k9RRNX3SJPFLrE6ptL5gNViAh2AvT2A64HTTZwo2dVh1WFcFPEf4pA8BKOgTIvaDTL6wT6bDFrkMA4n6nU%2B1OYb8AT6jLNstutNOK83hjDQcViD6GJjtQCBxewjYAfLh8NKqnvURhUKSnuQI%2BaO38Au1Js1JEOv4BMDsul%2FCR1upzp7WjQ0TwM0YIV4PFjxrMRyr4aQ0wBkCpgZt5SWxB00OwsZvvpAEc9%2Bhk9%2FXiEHA%2Btd%2F1AONF80EC3F3AhnudGutA8mTjF1ljDYOOA4D%2F4vUXDaQrf7oZhjjkJ5JoSeZfOjrNFvYRikvkRk66yder%2FtevxoSBghYMgH0cZEHdgAtjGrPNFp6nhtxAcGMveKHFbNOAfCmBD8GZEJouoRMHPOxmW%2F4SWFrY8B6R1axzIgPdoTSXkNKdrmXBId53Uhec1ElIdASBE7Pi5IDPzYwfodOMfYo4tRJczYyR4tSXTuMQjPVOCfsYRijwgQsCQOIeRdEf62wTAmss6gX78A4g%2BfCCWsVAbd%2BRQz9gskJchIKCBAjFogpGt8bI4R%2FDSAv4%2FLYoY2kSHsbj4zqWBgAfruNBhWKc3gaDNnpMIQz7U6BDqCWnICkwSLa5xDBU5Kd18G48KZiCt0QlLeF8jhUICgS%2BuLWt8zBzgH85EjJrJU0E8aGDNeSWbdRgIlzQo44NKwIA1NCPH4yBH0AY595sUyApzWkvZQrFMJ7nAHj4RwMeY%2F8PPhTEh31UEYxURJ3LGqO00WhxjhjyYhLDeJqABhSL2LnYOP1RBD4oMRD7YKi1yIiPERWNeR7t6HcwcMpzSZQP%2FejB0fKID7vwcU7iVFqoYhBIQNYLkcJR5CXaaAOHHAKMlwAlJUMpFw38QBxL2iT4PMlJ6y1oLVUKwAsIprRDAEF5AFglDXGBi55U6VXpA4ACsyMOW4b1NFPAhxJCAI9LOIAAU6VfHaJlFWGKK0%2BsmU8fn4khcG2LgDsJgUgIgItjCVY3hQ3Bw3yozdOowR%2BhEqYS4iNOcv6AsuoU52kMeLIGgOuwnrWGijS2phQas5IOBSMUUefP1k2ylBJ97A3%2BL6rE74ShH%2BmUIkRLSbCs%2BmMKDQsO1HornPgEBYiArIMDbBfIkZaUtwKZgj9mKxJJErWA2kknANBIvzBooHk%2FeN79%2BLFGB3xAIGko59EIxj65HJZq%2BNAAJOiGwfmmRU6AvYoDYnCRQl5TA0G6WSFhIswWjaWQ9ICHPOhBjx9Isn%2Fc2iS4bBOKfpyIHmhKkUOiF17J3FazmzWeHrGHQvQ1LZ9FFbH3NGC8S9CjBBisZ%2B%2FQ6g%2FJFDIM0dpLP4MJsH5qFCnLsoZAHkQg4xmrj%2FoKwT3WyEZmDeScQVmvcbmEtL%2F4ME3n6m0R%2FLGF%2BEjojsRNGj%2FQAs3dPmUfYXDAT1%2F%2B0IPuFGgY%2BZXLlK%2BXjhCQU5y4qPOdnds7NehjCg4oUwiiBT0UNyaS%2FDiEDX6QgiBrIKD%2Be%2FRAT1MEfIijCD%2F4AQH4gI8iOGBDGvjXFlKws7%2B42AZ9TN9tpxClEa261WI%2BRE9%2BSzpIOGBUasBYV%2FXITjXIAQ5zPEQIKFQEG%2BCO2MY%2B22mUIAc58IFDSjD2IRxw2y3oKRQaMFiY%2FyLJqQ7wcz3QG0zALe7G%2FC0Fih1GA0KRDnSLA85Hs8GHWHmaEjhKA3dOgT4goQHs6Zvf7W2dPoqg2CXhQrQp8JiLeXzXxnCK3vYis5AjroEyyyVtCnqKPtK8ZnsJD15bsmPM8GH%2FYNH1Wx%2Bj9I76Rh5B4ajhH5Ypgjzk4SCHyJzmoYjzWK4tEHK1CR8wWXfM5JGZxoRXH%2Frgxz8ilVZ57AMSDmn603W%2BE1z0o1X9iFoKIMQqyTgAF51aRw7lYoN04GPBVuk3Pu6xDpGone0%2FBvIh9gEPCl4Eo6xixUVg6XRl368fKOkjPiwd%2BDkRfksO6JNuICEeB2UoZvoI1ml%2BMPOZi3PrgxctRiCED83%2F5ebygEdQQC%2F6zQ8%2Bk%2FeD%2FE6TuCcFfW5PDf9LCuYU%2BqBM4R4zFztYPkXH8F2lCP%2BIoMj3ZJXhk3zZwR%2FIyVOum0uwXHQEUIIaxm7mUgI3M9FXQwySVQIl%2FoTyBWMA9EDAL%2F7vLG7sGgDu2G89hrgjZdBKiL8SWBMDNSiBSfW%2F%2F3WAIH8l8Ks1W5AG6%2FdKe%2BReXcY6DnCA2KGAwmJ%2FTPIDalB%2BANADagBi35ECSiAbXUZcoRYG27YgRcAai%2BOAfFGBW5ICYRAGrPMBYWBto9OC1zUWKKiCAzGDrBMCMLglFKh%2Fk6EGRVcEPrglHcg6L9CCxIWCW%2BB7V6EB3qcs0jd22Ud97tWE2HF9AxGF1ZeFWriFXNiFXviFYBiGYjiGZFiGZniGaJiGariGbNiGbviGcBiHcjiHdIhFXQSGKSB5XKgG7rdbwvOFd%2FiFU9Bye9iHEPWHXvgC%2F%2FTWhfEHhnz4hY8GhoMGhjYghVsYCEoIUZiohRpgWl1oA1jmhUABhqwQg1nYiY6YcV04il%2FICh%2BYhUXAZHu4iFzIil0YAp7IhT8gi1uoBrSohQySiVhUigsyBZERPqj4hVQBhrbYhdgGiLnYi6rIhYdQdFwYCq9YfT%2BANV2YgmBYjV8IMmC4jWDojV4YjK1oikiROtagD6tnEMnohcv4hc14jepoZp%2BWit9ojVuIjV9Ijl9ojl4Ijl4ojv%2FIjVwokFyIjl5IjHkiDzk3MpbYGtGohfMoivyohc%2Fohfn4hS20j2Doj14IkF4YBmogAAIwkBlZfQY5kgi5hQq5hQzZhf8O%2BRfhBROYcxAdmYi8qIWKRor3uFs72Y3TuIWHcEVeuJFdSJJE%2BY1IyYXZBoYqVY5FqYWsgEs0GZQeoQQ1llX1UwJFEJZhOQXDIANmeZZomZZquZZsuZZb8AltGZdyOZcywEN0eZd4KQOPwAN52ZdtyQOt4JeCqZaBwAeDeZhmSQhbgJiHeQpFwJiCGQaXAJmCaQZmQJl%2BaUGYmZdKcAqbmZeS%2BZl4SRGieZetwJelKZewoJUdwZWSUW5FcAiyOZvdoA62eZu4mZu6uZu8uZvecAvu0JvCOZzD6Q7A4A3EmZzKiZtMYAzBuZzQ2ZvlwAvRWZ276Q7I4AzPaZ3cGQ%2F%2FYAAK8cCd4qkOvFAO48md2UAM23meyxkPgAAI4cme0Gmc2SCf0Tmd9gmd8UAKbRCf%2BUmc7uAM2vmfykmdBJqczSCMEXGT3VKVABAM6oAOEjqhFFqhFnqhGGqh3mALGdqhHvqh6AAM2QCiJEqiERoFxhChJbqiGVoOt8CiMIqhxeAMMVqjE%2BqdmuAONmqjt1AOO1qj2QAMPxqj7gmfQwqjInqkLOqiSrqi7qAJYBAPTVqixVAMU1qiPXqlH6oOCTouELlpk0YQCdAMKqqlHbqhZvqhSZqmHYqiZcqmFcqkcCqjNDqnFuoOYJCjdmqhWbqnFBqkfkqhRSqlgSqha1qo%2F3JaqE8KBjpaqOggoI4qoX0aqFyqoBExMu34jgUxpm%2Fqp2gaqYdaqG7qqIlaqDMaqXiqp446qYEKqI46qKA6oqT6oo66qI1aqJAaqay6p5W6IFsACbmGEJwaqZ%2FqqKEaqKOKqLTqqKdaq3l6q4G6q3vqqoUKq8Yqq8qKqlAKrX6aq6vqo4Xaq1k4rI5arIV6rH6arIFaqoHarIr6rLoKroVKrYFqreeKreu6rIFqq5HqrYUqrXMqrtVHroVqroGKrnuqrn7Krn7qrvsKr98aqfTqp%2FZ6sPi6sPrqp%2FzqqP4arfLqpwJrZgQbqAbrpwhrpwq7pwy7pw6rsRD7rx%2Frp%2F8Tu6cVa7IXq7IZu6cbi6t1GrHh2qXjSqbEyqGxGqnokLJ2urJ22rI6%2B7IeK7FC%2BqrvSaj3GqlKC6c7G6gd66cAC6chu1sj66lEe61Gi7RzerVwyrR2mqrcuqddC6cza6c1u6cnC6dom6ZZ2609C7OO%2BrUQFbZ7WrJ0e7MJm6KzarRqO6dsG69QG6lza6d1y6Z3a6Z5u6db67Yxa6d%2Bi0WAa6eCC7mEi7KGm62RmrhY67Rcm7l2Grdz%2BrhzGrlpOrlaWrl2erl2%2BrZpurmi07lz%2BrmvG7pzarZ2m7Msu7cuq6p866isC6euC6ewa6aye6W0O6e2O6e4a6a6myy8C6f%2Fvuu8wAunwiu5xLu0xtu0yPu0yhu11Tq1RXu4tbqt%2FVq%2BmNu3QDuwQluuY1u1kRq%2BsTu%2Bc2q6bLq4Pjuv6luv7Eu27quo8Mux8nu7quu19Suy91uw%2BWuxZTu6%2BYq4DXy655u6jSu1RorApKvAjBq%2FRnu9Wpq9W7K9bNq9bPq8Zsq%2F0Ou%2FabvBAYy685u%2BjnvA%2BjvC%2B7rAPHvCD8ymKvwdLJymLpymMKylMqyl0XulAIy3OOzAH7y%2BIdzDGfy%2BJczAQky%2FlnoaR2ymSWymS3ylTXylTzylUUy5U2y9Q8ymy8umzfvC39u%2F2rrFQcy44RoMCaCFYaylY6ylZTylZzyl%2F2ncpGs8u20MpyispXGcpnOsxHU8w3fctrVrw2zayFOqDnzsxxNMshVssxfcqUlLw2yayNK7yJn8xmn6yGYayWQ8yU5sypQLxFqLyWmqyU3KyV%2FcGH98pYF8pYPcpIXcpIespKg8pQKcvAS8w1dswQn8w3h8y138s738F788pcE8pcOspMWspMd8pMncpMuMvs0MwlQLzT6ssbast9VMqREMtp8stkbbzUf6zUcazkM6zkpazh6sw%2Bjcvuuss%2B1subhsprqspEV8HdncpNvcpPY8pPg8pPr8o%2Fx8pP6cw%2BdsxeksytHMztPsznoMz9csFw2tpA%2BtpBH9oxP9oxW9o%2F8XPaQZTcUAzdECncUkbMnUe9BamtBHutDCcdJHmtJHutI72tI7%2BtI2GtM%2FOtNuXMUG%2FMwePdBrW9CX%2FM4gG89%2FO8%2BBG8qDO8of3bA8rcyqnMusbKaurKWwLMiyjMa0PLtWvdNYzatazblc7bleDbpgTdXki6pljdBn7cgFTLE8rM44Lc06DafVy8iBvcnBUNJjIdRDStRDatQ2itQ2qtQ1ytQ76tSMDdWELdVfHdZVHdIGPdeaW9e7e9e9m9e%2Fu9eH3a5jTc5%2F3dONPaVpfaVrLcxtbchvLb1xrdiz3aQ%2BPaRAbRuS%2FaOU%2FaOWXaOYXaOaHaOcbaOevcqgTbOFPdX%2FsU3Qpn3VI53VkH0Vyb2jy72jzR2jzx2j0Q2j012j1W3W1y232T3afI21wc2mi23d1uzJpIzX9dzbhIzBGKvBft3BGt2qg43doq3XpK24952m%2BQ3f%2Bx20%2Fd3a%2Fw3bA166w43RtX2lxT2kuT2lu83NAA7Ov63MD26mEQ7YXszfQ3vh%2ByvgOEvgzmrgNL3RUd3R9L3dpZ3Y%2BL3hR%2FrhO8rJfUzhL37TyCrjpUzj72rjT13TOY7kM67FPg7hQD6kQm6jxw3GrM29ru29GD7lzHrlnd3hU5rlNhriTTriEF3i%2BXzi5JziWrritt3iRo6%2FMO6o6Q2j682i7R2j783iUB7a%2FzrO4PUdwHJ%2BpXTu4bet0J0MZAQQ6QTBKA8x3jZa3jZ63jC650sK54hM5tRt5sTd6Eqq5krK5irt5hTt6Rid6FO66GdO6sat2g8BY%2F4jDlYBMgJigWLa5S385XQc5kuu4QVe5YKO44Qu5cOe0yb83XR9zR%2FiSK4AT%2FjABtaQDqZo6TWK6TWq6SzK6Sva5yv65zAa6HU%2B6Ape6K%2Fd4Pbd3XLt7Kl9zXJAD40mEEAkWQdBAL6OxMAuycJ%2BtqwuzqDu3qKupGgOpAku3wu%2B7oeOt67epLA%2B6nbeEmUiDuJwTWnjHeE1GGHjNAQCoeUQ8iI%2F8iRf8iZ%2F8iSPDtnAoSjf8v8u7%2FLoYAsj%2BvI0X%2FMi35zqYPM67%2FI9uvM%2BX%2FLoUKXo8PNEH%2FLqkKc5X%2FREfwveoPQ%2Fr%2FIs7%2FQ7zw7vyQ5Sv%2FMxP%2FNXb%2FO%2FufU6rw5QmvRe%2F%2FJBb6VjX%2FM9f%2FYuv%2BW6IU9hAAnE4l%2FOMweiwgp2f%2Fe2wAu3sPd83%2Fd%2B%2F%2FeAH%2Fh%2FHwuxIPiGf%2FiIfwuEn%2FiMz%2Fh6bwSZoPeNP%2FmCzwuFT%2FmYD%2FiLn%2Fmcv%2Fe8kAWSIPmdn%2FmbP%2FqYX%2FqmP%2Fm8QAd0IPqp3%2Fio%2F%2FqJH%2Fuyf%2Fi8IAlZ4Pq1f%2Fi0v%2FuCHwu67%2FuAzwuVUOSQU0oZUwP6oPH1E%2BnOLzEQKrH9HstGi%2FPsnrb%2BVtq3SK%2Br3hDfc0r1gMAOyt67Af%2BjYA8GFY79kQoOBw%2BjvLwTDRBtGeSKikdXB6HtMcrtMertKwruJQoQ5W6hI1jQ4EGECRUmLOZs4UOIEd2B0eQu4kWMBW%2BVy9gRYjZgHkUmjAcIULyRKQsCy6ZSpUCXKd1pAmMxpkhnDm%2BK3Lizo7pmDgAMJVrUKAAH4tL9UMNPDQBc64qEkhfiKIAEzdT57OjNFteOLMFmjGJs61iIMNFGbLgW4sSKbh%2F2lKsQZF2FJU%2FiTSiW70G1fwvOrCnYYE7DBukaBir06mMARcThuwepAYAa1vTJC%2FM469nEXhOvbDkaXVnQggMnbjv%2BGq7NxIsN3x2tF%2BVov4lXCyYM2zBi07L%2FNoYM2YGNFEWPW%2FWs1bRo07kTox69W3DrxK%2BDcxxNO7Ht6KV1D3RN07dg4KOF8yVe3P17op%2Bffw1v%2BrTZ6uRHYzesXT33xLwzDDzcxDPMOr56My292AAUrD34ImwuNcGgK9A%2B6sazjz%2FeKDrvr%2FX4ElAwAhOTTjX9%2BjNvQZ3%2BGw1CCWOMz7nRLDTRQMMyPDBFwzj8y78GTRvxrxINO%2FEvBPFScDQGDQuxLhhljFG%2BGum70DQdUdywxf483E7IkGoz6bYbTUuyriUTa1KwJ%2BWKUsoIqQzNyjKxxE9D03xM0EsXuwvzuzH%2F68vPtDR%2F49JJB4cLCk4p5TTMRiNxFCxLl9RxJx5M4%2FmQoDPr0vOgS%2BM5K1QKMwISUTBNKxIjUlM6kq9O3SoUvUPZTJS9RRmdksY57XuVL0plEiaPKq64goxN1Ck1Vrc%2BLUgdO6qoohR3uumiWGFKvejUtTKFrc2EtF2oVYOGfNatVSPqpgxsxYXo17qYRWvWkdTJVFN3CVozIXJvEq7fsd7UtThHb1L2YIQRRscbYtzJN9yY4D1I4ZuCFckdQ0RAYGOOg1jlPHnRcpYgdWYwwIA%2F4nlGAgMQkOVhhbgdqxs3yCBjkbPANcjSbjJSxxCbJ0nNXHTcCSecbgP1uZsN%2Flr2BOa%2BJIWVxx9XVMnSWuKwmYw%2BglF2oX13ppmMM7CBOiLZfra5lLM9EnjgCblyp48cgrD77rtzICOcJGgIIluMlK0lYqkRcmeTHHK4YieLO3LnD44RkCDyE55JLeSxRkZHnRw2JkTlDRBQoJa2DZJZ7k02NkCEbrbSmWSagzCH1SNOLoNMdIZU1pAZAB8r3YfU6UZjBNgeyS%2Bo81X%2BLOu%2BXqh0fq2uFx03Jo%2Fcgi7CETfsZ6WxoOVUoFco7RxOTnmtt%2BE%2BqmCX4rmi5cgjNyCHcDzY2JNNEVInmCNmIHxbQ5xsBuJDSOMClwrriaBrmzgCx64AG3WwgxfuoGBq%2Fi7lMAo6zF6islQGSYYpCGIKNBS8hk4ueMFndQ4Bn3tG6EZHwNP5xB1ViNwiLPI6ddSiBQZogamcsDE34G5EwmugBHwHFuA9b3gbM97OPPisJwLDGyhpnahMV0EK9sxhOxNVFVNjL%2BF1g4KBuVQ4uhGOCnJReJYiYNGkNxIacsx6CDBAFfLHPZJhw34ICN9OyGc%2B3HElfeorCvtUEo8uiE4BCuCYAhjAyCCEo2kIwF9E1LGJ7%2FnPJRIbjCE2NsCK3UkmUNiYCGoxDzYGoWUt6FnRuoEIMTzBDZvQHkHCsYg%2FEEIYf4DCH7CxiT%2F48hmEgEIZNrG5ZwRzESTzRDCb%2FohLPdDCYZuwwxN6SYnNbU6FLHQh6UYSQ4O1MHJBcB2ALAVC0MxjEp%2Bk4BU1tUWCuOOHCAgiydxBjmWksWjC2JgFnmFFJCotcEssngUXkYQncAFpm%2FPEE56QPXQQgxZu0IEJgtAFWdhEHWdwaCkmkYQT5MANrSPZM8gQhBMEIQ7P0KgwTnqCExwhDtjgRTw3UYUZnKAFUEBELZFJ0Zi6wXLffGNH4pEHjt1gEbX4wwk4RgkIXvAa1wAVFjGlx42lQlP4mhgFuQpFDaqDF%2B2A58%2B60IWnQRGdlcoVIQnGq3DWQq6TsF4f5FoLYZgDEXowhOU26DAOAnQei%2Fgkpuxp%2F5OvHrZolloGOaK6FX1i7JNtNIgBLSlOes5jMKWYpTBItokWxG8GtXCYMBjQshmobhNJaBkZRAA%2FBNhRGAowgBGVpUoDkDOHdGQALcyRhPgh4Aja45znQCc6b16MT2iJRx82xkjJka4nypJFH6T1B09sTh2pSCQCTGCItG5lE8SapU%2FlCUSUqAMbk%2FBCE8qwiFw4LBh5YIDk%2BrAIswV0L0sjXhPj6QmOUQsd8ajCyZJAQT3sUY5u2ErJWqYC2nJMB0hzxyqcGjkTpMJhviAebFlQid0tgI6whUKDa6GC%2BKkguY4r6kAvPIRwiGoetbDAxrpgE3c8YxFkqEI0tyi8Rf4YYhPPsAOypLHHVKTCDV1YBElJFo5JxKELhhCGRmthCEPU4pZN%2BMIkfOqJRSzCd%2B4QBiKuZYhg5O8ig3QrVuBqMGXFIxjWmwQqlRWOOHihDFUWxlkJgY0%2BJEFvGf3ZEDbmgS64QXvhIAROZ8CFPEjjLOoIhyGgMIM9K6IJXRDa5roR6BlUgRC1lCwCQBkTy0JEHbmw3iZ808EGI5BjClYBn2tMOXTMs5S35qM7grAxQ6hsjx6QRjwIsbEdcKPAhw7dxmxY3BUe94XfXC5aUouAMlz7dhuhdBUmd7KNQSHGUICtAY7gsFoYOnIt0HDR5hnEHIaWjoc2xDz6ANusUv%2BWJAJdM0H9SzIdbOx2wrvwJOIhawRsIAgKDja0E34EeSPAhuFQoQeOAINPxjiOOciDa%2BmIhHhgQ2PY6wMp6TgJo11bBUe48Ax8aqoWb4uwTISNO%2FLQ2Qb%2FgXgbk0AXtFsLOopA3h4QhsYUcO2NtUDAOUR6wvuwFQKfLAgB59hwlVU%2BlN0mDwpGgAXi0EY2u9WQBquF9WwIu0l64uB0bAHWN7aBUsyDtRwzwAbMqELYtsCv3fi16jzwWgMMXBjyBncOLFfqU7sk1Q85XD%2BPqL%2B%2BV0AP3VhEjesYD2HcWgKE6EMe5M7zRYRDFnu0gz0gF1t7pI5jm%2Fg8AvRwDShYQAL%2BhjhaA2Mrqm1Ke8WOq7bcAIwABtSiDBs7QTd4UY7HtUwCiWOkAbpgD3LT%2FQjxkEbEeW1KS707Ht1AseQqYD27%2FwHffNQ3QpKoEOH1l0LGTjoa14mAFqARuKau8jPmH39oe0AW83iGCTZW%2BpkzJXtABxrYGJTru6%2Bzh1Q4gjNoBHdIBeILH3twgypwg1qIh5lTgWewh2e4NlfzCHq5iOYiPif7oC1yh2PjOV6rAsGZIzq6gm5QMAVoNvgzm26QNwagwTy4lDjqpzkiBIehupR5HI6xAF5DuXppqza7irGLiRwyO40iKLWDQI5pAaQLgnmoAhHjuR56H8mZgRloPjv%2FEJW5g7%2BmKwP%2BG7ocCJ06uhRPMrXyuw%2FKKjULeLydKbuNQQRiUId5SEEPwIZnuDU0xKD5mz57mScumIfMQ4ATQIfu2pg4QAeN2QBacIhuWAV0eIZN6LsqwD3jEqdpU664YK4r2JggcAdZMDtiQD6TKz17IAQLwLQcGj5GnAStKkXJibRJ2KMhOEQgUkARkAAVoAVbGD3JWYVkmpzNm4QS3InzCxd%2FoxB1EIZmKwV7iKMu4L9mWwSUcAdfsB5qUSEo0Cx3sL08uEZTrIVSkAVcPAN7sD1GTII%2F8IV22MNFTLoq6Ct7sJc4cgJZKIVaiCMyCCSJiDmJoEVyeh5q%2FKRU%2F3gGXEQAg8NDBFCBReACT4jBpEuFbiAE6zlHN9gYFdDIPmCk4iMwjiGDZ6gEFgg3URHC7SOeKhAGYWAtA9AkkQg7QmrCSpHIs%2FM04plCjjmDzemuHBAe54I%2FmVQHN5iBDViEebCH7kqCGbMeO7CUPtjCMrAHpGJEYZgHY5SAU3rDxFOJxXseifxAg0Ajh6HCDaCpzVnE0QlEYMOx%2BauneOACG%2FPEBUiFgPOAGjsC1TuCEnrALsgBXrs9aOMm5IKh3tsJ9SIeQrCHeOi7IDg%2BdzC5DTiCPEiFKrMIdWKnaiGeOEClz4yuedA%2BdMCGYPAFb6iERSCeRbAHYZgcfyLIm%2F94Rv2JRsMxuTJAB6eSAK2iwjo8C%2B7bmJRRoTEsGiHYmHPsu%2BBCgCCIB0yKHwnYARBTBzIIrg0gg24wyec0ACiwTcYzyLeYv1Mcl9MTAWHQFG7YgY1xgnjAQwlgPYfBKgSoN3t5go05N6qrJ3TwQHScyM0hhjNgSXUQQnv4PdahoGCogjw4piR0jCVkwjfziSd0tij8ybVLOEmLhzcUAWwYrMmCrBzrhlTog2tLAnughFIiLnSQt6ycvyt4hlqwv43pA3sQyzgsS%2FSbzRslE3eYhBbogk5Qh1U4NLdUB1Cs0VszBLpErwHDxS7QlI%2BMLfupAlI6gVacKjv4Nvjrvk7%2FTEzdY8xRBItSk4A8MISD4rlKQL6Z4xgGaAFFs5SZ6yElrbFpIzgDtAftU5ZJqIIWYBmOMbhv7Do7dEZ%2BsyTdBJX3m4H3K8oKY6Th9LTu%2BxwVclLlZE576DsPUAGYaoEWUIESc4da4IKd%2ByTtmoQhoEE6coMA3QBPPQEVUAETKAM1ixnyfIh4sAOQbMY4s5c42JgkuI1r0IPJwkN%2FajD7XAXIOsoJuzARmNUW2MYABSVi8AIDRdCtVIFaspd2itAJjRu0uFCJy9D72dA%2FVJZVUMb1nDmbRIdFQKl5E1Z7CFZGJLV3e4e%2BW6RFUh0uyNHJCiV9O9CNoQExOpjaWR3R%2F%2BO5Vagpd%2FAEdpVLBECEJ6UnlHCfvDTSydkARsIynpMcWbgGWqixBbBAdaDFMM29JSXTW00Jgn3OjWkCdigaQug%2B6RuwOkWmbmowdOg%2BSuBT9OqGBjqZ5bs1QqXNQ73NRFU1glqFecigNAqH0JIAjEOAPnAYgiIEVIoHT9hCDbtUi3CH5USAc8TFJKA0dEiFGkWaZxCGTsAGT4gDFSqeTFTHZ5iEMpC3GcBYBCixo5GrM7qYXF2IeDg92xqMMgiCPlhPez0wgijWY0VaZUUyyHrDZ4VZbAtQJ7CIa81W47SHAp3Ibn0nl1XCcJ2ROAwXnjRXSkJXs1k1pMVAVN0cWv9EAIujOhWt0hOopXjQT3pSB3mTgA0YXg%2Fwy6zUUYF1CRTsGGEIB2yo3U4kKCSwhWrpuwFaRLAclbq8WCm9DaQLvlqor4JFB8i13W6QTNtL2U%2FcWWorUwtFOJg9AbO5FGHgrByYI9bL2TvdGEpIr4VEgE0AWnrK0ZYRAT0AsWs7WkNN3YPAzYkhqAedBAmW4FIYMHt9O8Bxh%2Fk7gVLohlpQIRjQHrDNVLK1h5mzALXrhhmwABXoqxOYnEmwB3ugsY1hKtkzgQ20h6OcAXeYuQ3Yv2dQAQtogT9oWcMZXPSTSHgrmmewnzqq1xFFB24Qg43JAVKV3M2xzw%2BMhyqVne7%2Fi4NU8ARP2IRS4EzvHMiIwta%2BbcnPfT%2FWUZZnKANC6ISFchvTPV03Y%2BCJWV3Y0VAqTNcLrUPZhcMcqzEJ%2BIPz5VUEUNH32wCWqhb%2Fy9z5K4NweAZsqIVgeAYxQl5UEyWXNbmuawEFE4HDu2AWkFcDxDxDTi4NhlK%2BnVIL5hj%2FCYcLQ4A4iIdrqIQH2M9F8F3EVFn2FUUjBsHu8oAyOOZj7sEmg4IcEAFPyIcZIx5EMOGk%2B5priyRRwUUQjYd3C1AyaIdlCIY9ikhlVAZ1mB39Ek%2F0I6jnHCByFS6NQjgJ8ADrsQBXgzZMFVvmRIlrk4AgCF7Smj8LCAKQQlUaZkS7%2F2m2MQyHa1O47tuA3dsWJEY%2FeIyDnhEGdZO40ty8S1mFDBC4qYQ%2Fc5hcYeVDbIBRe5i%2FcbQHvhuCPcvCjUHjzl3jl%2F2DeVhXYJuHeRC%2FhGvGwLnj09XJq%2BFjnzzXP35dZF3PN2SlZygF2gyGfbS9Yf3fI3gG%2FuGYrKzSGTjfZ2gBEQiCVJgHTlY8T54eUI4cERCwzcFL1eG5r5vGCGPlhL2dASswA7iC9JIF1cHrGYIf0sqJ2lGduqMj%2F3GwrFuZlnmZ9h1m%2FrIxycwU4DXF%2F3ywNC0Ddh1kf04CdEhBU0sCpLMDCurm7jJgPYg4g7tHHdCBiI4JBxYbVpUfUFIHeP%2FsyaJBBK5DABEwuM0xGQMAwqLBrTHcLsIr4GfDhr4DN0YEsR7eI%2BROAuIKBsLrJyQEwYkOl2CIZNxmyqq7MxVSgCA4gj0i5StGgKLMIwUTqe5jgLB%2BUyjoA%2FdMuGeAaQSQaTUOz5pGib6zgCM4AuuxI3DF40KqUMck6vQzaiRtQUOVTo4xgRkIhluT07k9sHgoA%2FjZABdEw2BoNlGVN0f20IDt5DjcikUYgllVAUyrsmdRB0pIAhSY1SeoJHWQBiytgqHanJKDgrNDQSiAAkwVni7Y8WQ5nB3vTXRoiG6oAmklg1r4cRpXyh3Hn27gAiiISZY10wDaGLQkiHg4A7%2F%2FroUOm9cyUJZ7rDsxql3YqoJ4okkMp0Hla1VRKUCO6SOuaO20XARCwDI8xzJCmASCmAdafGODkKgbhwI3QHGCmARCIASv2ZxNSHRvMsodLyZDFx5DwNId%2F7OaYuI8iPQqWKZJS6ZIt0DGBpXq5pdaqOXIMbwGG7zgsgCU262anDTvkRwPwLeqXGu64zmUiwdycz6UIIYuOBn7xrqUmcaIk%2BUat2MJBfA8Rh%2Bgo6OeFJ60WzsDsABJg3UEqDKRU50N6IbQPRkeCrrWCQeTOxkd6LvbcQdE6ADB7jobwpiTaYEdLWuVcJijobBScRhbOBp4iidNmRgRepaAH4yB%2FyuC%2F2iIOwsHc8Cgfy%2Bagb%2BgNgKnbwq0JPC5iRGGJxCCJHBKYaiCExABkD%2BCTtucRfBqEbC6S3oCEwD5IMCZBsuDJNh4CvKEGQD5GciDj0oCBtuuZhaB3tHjAVtaiYBaorcI4bm2GzsIKQqVxCoafXL6fj%2BntVIrbwkMqQehrvKWiC91fnmGM%2FDqERABjitB4bGDmhcBFJAC0kImJ0iCMIedKqj4VUgCmzeESUOHPOj5k%2F9AdfiDmPdtXjCEmH86pYz5ZNknLlABkB%2FSZFd2Zkdd9CGyOIiDFTMHPBADO8iWZ5j8PkAa9bKDOMiD1tmuJ7CbLrCcPLCbI%2FiDZJr8Z0AHMf8arzgwBHSII98m1cQ1%2FbXPocmn%2FeQVJOdRiHLgheC%2FDp0ofjRpTCd8oq7iBXZosGrpBum3FNMxo1aKpzBqnVfTp63oBmagXlgjGdg%2FI6AP%2Bv2SoZOyWbUmDTOhmgTh%2BnAxGunXImm0COkvhmvwjaePpwoKIzQCCHQCBbpD1%2B2guoICE7pTJ%2FAWQ4foIg5MGO5guIYDN3LsWLGZAwAiR5IsafIkSgAJmkn06PKlx3gyWwokRyyeQ3UyFQqUGa9iw4QOg7pr6G7msxY5jniyZ69bCwQINikUqk5oxZ0wt26MYowm17Bcy90Sa1ZsMWdn1750B0YTT7ZyH5bbePWqx7v%2BHfWGVZcN2Eu8c2HGAwTo5%2BCO7oIYkIqgClh0wLIlnku2slx3msDETcw3MDpnatcKzlva5a26fT%2FPVQcyJezYJ1dGxszVmy3bLtV189B4gxs7M6RuEFZbt0uvx5F3vMwc7ejnW93Clc41tfWtf7MTNoxYtzs3M2bkyBMu8mTuL52rV7y5c3uBouN7xE7%2FY0jZ%2BmPTvr8Rt3ru9OGYAY1JhQd88Snnn0DsMZgWgwS9lWB79jG4XYSFHfZcSxp1lF6EDt6nGWcRhhYdgxbe51p%2B%2B7loUn8RAqieOps8cQKOJxyhhzcmorMggyLeB2GE1FGonor3Ycight%2F5B2KQZRX%2B%2BZ6J85mYZHwsvrglSTEyOGOA7hx0kDvEUGYikP4JSR%2BRDBp5pWoXApahdyZCqaaUblIZoZURYtmellxy6aV%2FYAKq153%2BpXnfmvG16d%2Bbfsbp35L%2BNWnnmVGaSOKR3PWZ4qT0BSroi4TeZ%2BiTmTK4KH2NtvfoiBPCaWKl910aYaKt5gnpngx%2B6t%2BfNL5GaqksmYjqfbnSx2p8rqoHK32RgkrrnEzWiauqjO46Yq%2F%2B%2FXpfsNyNSqx%2BptKHLH3KKvhViNsOiWKs1UlKrYm3Mqiues5mx2mV8IIbapbDkluusTLmhqmPzLanb3bQxictsADHVyt99qZqIsPS8cunv%2FT%2BhZvduCgVEUoIIhEQRih8aGAyyiqjZG586MaHr3oK5%2Bsumx23B%2FG%2F9NK5IbYY47xzt%2Fd967HEwraIkg3p4JOCSHXwg8s9rhAAAB9T48PK1TAW%2FOXBQaPJrqYmOryzrPNGSHF8Fiebra6bFk3f0fF9bF3IJalBDz3yQO3AOqwAoAY%2FPwAuuByFz%2FZ1oWHfC%2FeyZOPp49kBpj3t2tVaeu3jQstdIsc%2B3i1d3iSFIschTwPwwj6BAABEP2GksA8fABTBTxgnBdBMp9l5o%2FmTPY7du3QZS1e35aAQL93o0rHdntvpQr7w0AGCArqvOle4qcAnhcSH6j%2FwIwcANoxvPvn%2B4pP%2Fwhbttx8GLaLJPz%2F99dt%2F%2F%2F3FxII%2F%2F%2F3770ws0vK%2FARKQCb8gIAL9t78EMtB%2BtrBFAyMov2xkQRLZkKAEA4jBCOpvgw3MBh3ocEEPJlCDJERgB09IwGxIIgsjVOH%2FHghDAi5whv6jRQJkAz6oqQ8APeAHHNAHgB7%2BQA5GNCIfioGMYjCxiU58IhSjKEUoAiOAU7wiFrMYC2BksYtedKIRMvHFMWqRjGaU4i1uccY1NtEZFVwGG9loxTie0RZzpOMYnRFCZ%2BDRjLGwRR%2F9GMgxLqOFfBykF9OIyC%2FecZFTRAYOdai6F%2BjDdUXoxxZSUEnbYRIlvDsW8JIlvAj%2BeWV5z6meepDHHbcob1aZqxfngue5Il3PlMxRJXdQua%2FuoWSHAHCAOIbhgEDw4wUECOYw9%2FGCxS2HOzJrD824YzPuGO85lVvl5SLmM2sBrXPt%2BpwtkYPL7DSPOaUrSSD6ATUAhAEf69gHJEQSBn28M57MPJbjLja2Zlqnmsy55r6y2bNX%2FsxJb5ulnrDnLe0hKWni4uVJXjCFFv2gDlPo2hDncNGXMe5U%2BTzoPr9pNoYGVF6YkxMsu6nPsiU0nLoZp3XKiZxzDsxr%2FLTOM9UTzexMMzv%2BRA5ArcMzpG1zcyoFKUt5pVCjkZScDgUZRGt6T4P5aKfW6Wk%2Fddmwpmr%2FTKBEJSg3DSo9hCrVpbaBKfOeireoSrUkMGtPTrljVelgtXhatU5Qu2pSbYLVqGKd2fRuBs5%2BiU6tpGNrW0fyVvXENTtzfU5dn%2FNT3eT1OUO1m2GdF8q2xRKpk5vSUunG1bRGiKaJVUlHz%2FXRsYY0qf6pLHMuW6HMPud56okeYMnKrdDGB62npO1MEXvaxTpztblt7WcjBFvkyLahRbVVZ1nr2mjNrbej%2FW1phZtY4vrOuNAMbM0kpy3KXZe5XsXscysW3eNO92HVbY9vmSNT3Zh2u6mNmXd1Cl5pijduI93UeWebXs4eVbrJLSthXemf%2BraVuzjNr1z3y9P%2BNuuu%2FtJZLngC7Ny%2BQrfA7D3wbs2KmfgiZ762YbBUHSydxlrnscyJLHMmaxsM26a5uQQucmzLHdx%2BV7fU5S18y1tiHJ9Yuw2%2BL1wh7FgJX5XC1CMvgPc6UJQWFGEibWmC1bZgI6cYyYxVcouZTFcnC%2Fa%2FRdLwjQcMvfX2%2BMoIDp2CV8Tlmqr4OSyWjouRA2PkyBgzNMaMjZ2q5tuyWb8%2Bdi%2BQUylk3ZgYMyims5eLW1UxQ5bM1LSwNRcNaDQLmsPq9XCb20u0RHtK05hpdGUePbA6M%2BfOz8mzbvasmz5X5s%2BVCXRMiWwbHWeHx4Z2c4izfFI5L%2B20bo10dyedMEv7FNP%2F%2FjR1YnBNWk8T%2BK%2BhBvGPRVwZEjNa16me86qR%2FWBlI3e8ZnYTp3M96B0XOsKHHrW2E8Nt26DaM%2BAmF6uR42rmwNo2srYNrRNj62ine9pUDquVRR2g9yq6sNkttrEVK%2B4VgxnPlH4xs7MK5TNL%2BasH92vCsY3oeA9m3qf2tr0hHnHU3pTi5CZlxu26cXR3HL3UXjOof63wVTK81A5nkKrxPXE7V%2FzVF9dzzCXrbKBCezDSxu7NCZ1zdwM728Lm65ZVHvF862bfyOk3Zv6NmYAPZuBOLzjUP95ha%2Btc5PC%2B%2BpSJvXKb4vPlq0p6jJdO2abP5enyRXlieG0dX1N95%2Fvq%2Fnl2TF6Zeg8m6MTium28rhuwV0bslSH7XMzed7T%2Ffd29bveS371wUiee73NhfGvu%2Ffiht7ro%2FD56rPHOZ73P2PRs8fuQPT940IdZ9DwnvXUUnxjUy8XxpII8ZiRvG8onxvKJwbxcNJ8Zzuc%2B6uyeeuirPnK4e1zuc%2B8S6%2FXt%2Bq%2FD3t%2BynzXt%2FWz7teC%2B27qXDuGzb3ihIj74618L8dlifEEhvzLKxwzzDYbzDQb0sYX03R71uZ%2F1fR729Z72vR2caZn3fZ9I9F9i%2FF9lBOBcDKBlpF%2Bt3Z9ZtB%2B9Ad5gCB788Z7F%2Bd7hAd%2FxgKBZ5B9pqN7xhV%2FXjd%2FklV%2FYnR%2FA%2F3mgwLlgWIjgyb3fc8SfA86fxtRfC%2F5c1lGgxLUc0dmdoujg2PFg2fkgVwDh4pHgXJjgEKKg0akg%2FbHgcwjfYMDgWezfoNBg5Nng8uFg5Unh5VFh5lnhdCTgCAohcxBhCj7g6JHcXJDh6Wmh%2Fskg%2F6lh8rEhALph88Hh88lh9NEhTGDh8AkiW3BhHnrh64HhEYrhLUEiTJihWaDhlljgYGBgYmigXHCgXBTgWhwg%2B9lhEC7g7jXgHhqhZSHhGHriS4CiWIhisThh60HhfagiW7DiWbjiWUhiGVLiWlgicujhF%2FLh7%2FmhXACiXPBiXxgZAYQARhGANzZA12yj1rFc3f%2BFXBQCI%2FrNHKTAYhbi4TNiIvlp4i1yojjpImowYygaGR%2F4jUjYgDWIgziswxQAQArgAj2IgxJwFDrWoDBGzkJOoTrGCzWyBTaGhTPqBjRmojSu4ESuhTVSJD72onA5AB%2FoAz2s0xbwQyhAQij8AACEgjyEwTCsw8rQHVWZ4zAyIgE6ogHao2Kw4yS6I0bC4w3KY2zhYicq4QSeBExaw0mKxCGsQwg0gEiEwD3E0xT0Q0KaBAGwxF18JViGpViOJVl6AzGQJVqmpVqqAzF4w1q%2BJVyqg3LEJV2OZTnwQl3mZViKhl72pU6AASjghF%2FmJS%2BUw2DmZTac5WHSZZMsJl3%2FmoljxuVdRiZcxsP1CCZlqiVfZuZaFiZnqqVwqcEL%2BBIA4AI%2BpMM68AEBmE8dDBE%2FqAEAEIAGzOZshkAtUANu5qZu7iZv9qZv9uYvZMJvDidxFic1ZMIvGKdyLic1MIEuMCd0%2FiYzCGd0Vudu%2FkJyWqd2doMVOIJ2fmcmMMN3Wucv2MJ4Vmc33MEddMN5RqctZGd7Lud0xid0OoIVsCd9Kid25udyhid%2FGmctjONI%2BFIDsAIrTAEkYJIQic8cAMAUGCiEhoIVMAGFVqiFXiiGZqiGaqgRbKiHfiiIMkGHhiiJligT%2BICJpuiHjqiKtqiFGgGLumiLRoEP%2BEAUyKiM%2F8Yojqqoju4oidKojfoojwppi%2FYokXookN7okZIojC5piRqpk2poAUjSOo2EBshDKCwoP7CB9wSDj2QDIlaGLSjiYDCBMZgIOPBkKxaDiajDWzzkqYEDrYRp4xkGnIopmcpFmrbpZtypwLHplchphOij6jjAFtjAL8EDyeDDIThoPwykTX7JZn2YqPyITloGL%2FjIR55FPABmR55FYQqlbWRkPIZIpoIW2%2FmciYQq0BlZIOgD1GgAPIhDERDTFpSmQOKCPJRMpDZOQ66Ln3ZgREYLUC6jqGIGqRblRobhp5rFpp5FRW4Fg8nBOqxTEVgDPsiDaq7OMLgTpPaqR%2F1qe%2F8Q41oYo1kgYwgWayAea2UkaxsaJXMhZT0qpaho49I4QArUpMnka0qQ4lyY4mCgIluQ61mYK3REWbOKRbRqx6RKXarKn9v1IffZ3BIyITnepNjAXLCuopoeo09yhDKuqyyeIC1Goy0eJT2%2B1MdyxMIGBiGm4cbKBcDOhcCuBcGahcGGBbqKRcheY0iKxUWOKlG%2B67JuYsKGxbO%2B4M9yhS%2B6iL%2FKLJ0GbJ6m4qVy7LA%2BjLr6LLsmhrsmIryCh7yqLL0GjIDaV8yyxczKRc2exc2KRc5yxc7%2BYNaC5NYORtdm4NSWa8fybNie1cpuRMvuxsuOoiH6X9TSbN7abNUW497%2FHizHHe11LC1XBC2yDq3XFu08Qu5WJK3CSi5MNO1%2BPC3aHq7aJi7bLq7eXi3a1JyAjWwXlqxGnmy8pqzfji2gDO4vlmPG3t3ZFmzj6uzfSgjrbpjafdrDFmHETuPEtm7FMqHorkXassXamkXbhsXbbkXcXuHc4p%2FnwgTltqvl4u3X1ljfjljw0sXDWezFgo24hlfv4uzvwu359izduu4lwm6pyi7Y0q752q7SqO%2FznkX0rsX0ikX1jkX8Yu%2F8bi%2B0du9LfC%2FXhu8pmq7bJnBblO%2B2nS86BG5e4K7TFu4Fkq70UrABo67vqq7lDG%2Ba2e874q%2By6i%2F58m8G%2B%2B9Dle2R%2F72vWQzwWRRwWBzwVlwvTGRvHapwpxVvteFkhQ1WBA5bvdpwl%2BGwWOiwWfAwV%2FgwTADxSwhxJDKw0tbtXNztBI8voGGwvGkwB%2B%2BFB4cuCJeiCBMwCfewCcMvCmMTEasbCw%2BlCxMtDI%2BxDJcxDYNMMOSQxQZwDrfxDr9xFcdxBc9xSWnuJzqwS0Cw3Uqw1IrxrZFxyZkxJO9FMDgxpEFxWEixWFDxVljxelhwFi9wHRscpTTs9R1vLSYvRy4v8S7l9xFyFBvyFCNyKSuy9aKyS2hxW3Bx53qxXIBxJWMuyjryS3BuWJwxR4AuwYDybejyKPMyTJiyS2BxMKsyM9%2BjMf%2BzBTIjriVHGyb%2FoSan7yCv8b9ac1iQcjb7MgIzslAR8zNvckdI8hdTMjkr8%2Bx%2Bs0c4c%2BSqs%2FOyM9S2L39R8xUDs0cIs0vQL%2FeG81qMc%2BmWs9OdczWmc6t6crgpNEyI8jtj80tos0dwc0N7c5wpiSszICybrCwzKy2vcPNSIC6HsjtzBTyPtDz%2FMEN3hEN7BEQ3sERzKj9XtD%2FvL0B3hEBvBTTbRRpPs%2B56k8Ye9d4hbErThz4fc1GPsEX3HUazxVI%2Fcml1MgAb9Ogi9IR59Db3NEf89E%2Buctq1ckq1dOy%2BtNHGdBHb8tzVdDWjdZOpdUmz9Ua4Ncja80DfsdDm8eX%2F7vEl93Em%2F%2FFacbTQAbZHgDROi3Ry7PRC07NeJTXL4jNHZLU4b7Ubd3VmfLVHavRM37JZQ%2B9Nb0VOZzZlc4RJ%2BzRKS6BKzzUSPxloefZGhPUugjZ%2BlPVsc4RlwzZmewRJN4dgDwRhb0RQdzFiV65iiy9V87FvDwRwg%2FNGE3dUrxTvXrf6WTVuY%2FVKzyJd569dZy5e2%2FFq73VrC%2FBrw0RsK7dmnzJnW5ZhM7VwD4RoTzRpH7Jp3x5qn8V210d%2FT0QgezfGSnV4M%2FYHkjcTm7du7665YdkSY51erxxfb8Vx03dyd8Ry03ZzC8RzD0R0F%2FN0g291h7F4m7NjozNkH5Zk%2F69ecf%2FHfL9EfYv4fa91fsfWfov1ikdwiyczhF90jGf0jHPIgq%2FzjQ%2FEh%2Bt4iHPEiG9Ebbf1bU%2F4xJw3yab3C6%2F3Mrc3KzcxbGgAH7jCJbgkADSAHLjCIfAqm7s5r4Kravn1mD05Olz5YGe5hud2lVm4f2F49iy5OSEWAZhmKIgDPSBq1rCCPOACVRKTo%2BMCRoEfnqNDlLvEjlN5jwf2j5sXXHfekE9ykffzkXt1koO1am%2B4SKRAarqmHBzO4BQO4ITCrKv5sV16pnvEpndFpzP3p2dYqFefEeOcl%2BsxmP%2BzmMc1maeEA1yNEmDS7NTOD8TOtNsO7pxEV2a3QPxOVf%2BN0t1xu55r9wK3UnlveYU7%2BIVDSi0tu6hDipGlAEBqgBChj5aSjxJcgr7vuy3wwgP9O8AHvMAPPMEP%2FC38UcEnvMIvfCzcwsI%2FPMQDfBgBQ8RXvMIjvMVnvMDHAsZrvMcTQwURg8ePvB2R%2FMhzvMlrPDGEkMinvMU3vMtnfMfH%2FMITQwu1PM0%2FPMrnPMTPPM8TPDBUgiCnRAo4pUuKT2v%2BEBvcOwBowAs8%2FdPjwDF4A9VXvdVfPdZnvdZnvTPcwtZ%2FPdiHvTfcgjOIvdmfvTc4J9qv%2FdZnQyywPdxjPRPFPd17wzmAgSTUPd3HQjboPdw7gy34Pdufwx7swTkI%2Ftr%2BQxDio73bLz7aSwIYHL7ji%2F3cT77Y873lh%2F0uDP1JhIA1rIOaa5IlSfsmRfutcmV85zCXx%2FI5vrgfn5m5a3l7%2FDdRl7pRn%2Fppp3pqE3pwjSMBsAI%2FBEIPFEEJANMwaMCrGlMwacAh6MMy0Tl%2B2Xml4fm4mzifx52fIxygJ3Fvuzuxszq264M%2B8MM%2FuM4UZOs%2BNCoAbAH6qz%2F0J5n0Yxz1lzg6nLjwcvsGJzg60L5ZUDRXAwQ6gQMJFjR4EGHBcrcSNnT40J0mMO4eVrQ40Jmzixsf3irHEaRBdc0cADB58mQIJUVYKklh0oYaJQROxpyJEmWCZupC9hzozZZPocD%2Bsgn1GcUYT6McFy4NWUyj043uwGiiKPWiR6wXswHbajEeIEDxvlYkWvZhU7QNI05c2zDj24Za5YokiRNvXr17TepUWrcgUMAHzw4uiPSvYbWGB0JlPJCq1ccC6T7uOhld2LGYCz9ezLjt1cdxMVc2PLIkX9WrT%2FrFLJhzUcyIJ39m7HhyZNGMTRu%2BPFkz2cmdGdseHBoz6cm9AaNm%2FZyv68mwh8ueTNszQ8y4H%2Bsu%2FXHy78fBY2M2Dhj5ZOWPmdd1Dh0%2BTumPqT8mzhh7ce2TuYOuutuw9uoSjzHyqjNvP9AkAnCw9XgDj7H34ptwPsbqY%2Bw%2Bw%2FJTLMHbouruv%2B%2F%2FMCPQMAPts04%2FzNIb7UP2IDztrgkp3Om1oMqbLanaOjSsP8O8W%2B5F37wCTizhTkRQxQWTa%2FHBySSUEboKDbvQsAwH23Cw8wDr8bgQgRxxyPGKvDG7JN1Sj8kAg2wuRiijpHE6Gw%2FEMbGN1HEHT3fqbEhLoe7UU6A%2F%2F%2BISJEEt%2BtFFMDEzca0%2F8eTJyrrOM7SsFRlzUE0n23STNSkHo3KwSOvC8tBuPNkEVWEATWtHo9TBBtVS0FHnGVRrUYpQO4NJdc%2BDEH1LnWCFFVAuEgdj9Ks7a0XVE2ncIQZFDkVaNhW0LG1UWJ4w7SnbiohtdFNOVfP0InfiOTeebh2CTZ1z%2F3stS1S5SHUoWEJUQABfBDaoQph3CeqzJ3c2wfeEcOKJwwAEkrgq13KPwDcPI9nyslF3nikF41KE4WVNwIwFDFms1AnHDRHyRUCELmzxBsmC3PkD3xz89elatLpJBeNu0Nk2JFlynpmyjuV6Utzo4ASpG0P%2BWPqPVGqpJZhgGxJMnVSWpgRop%2BKll0GL5m1InS5OPlmEVLr%2Bt1WhBCbYYDcMMGBhgRq2SJ0gIJY4oV%2BT7aYMk%2FPdAIljsv7q47pCdkqdboYYO18UBNfRIHcIwVeHwTmq%2Bat48sg3Dnd45iicFvCd5GyCvkWL6KL1IvehqhlXAAELqujGX8HicduAI%2F5Kx2rrvEnuHKSvEXLHjXxTtiOHfGcI5y9BlVpI2EBXnfVRke6UWqC1ESg4HkNMMKELhp3JE%2FtApb5%2BoGD1rPvuivT%2B6mHGEVDhGculKlyuw5dSJ4l8W3DjDKLDVxUS4zyCRI965Ttg9Q5SDl5MDx2So5z9yqWkoenAf%2Bb43EZCN7rdBU1TqVGd0SiYvlTID18GEALzEGI73OkOML07iDo2MQMDXAFvFRGeSISxAXwF4RnuEhsCDEC6WalDGJNYRC3qp46FYEMYwpiVLyZxqzthYxKbwMZu3BGOVSyxG1fRXsES5wtfPGMg1%2FhFLRaxiWeEQzTPEEb9qCjFCIYjFf6TCGL8IuY%2Bin3FHYvI1w7skAe74St8C1zfAc8HqOihL32P%2Bstl1KfAtehPbQNDpMHi0Y1DIsAXPOEJGycRjC0OBIpSpNUkSkE7Rj6DEpMQBhxdho1KLEKKYpwcAipXKQuuxR2pgF2%2BJnGNqCAwfeVTHwQ7iAAjRhKCHkEgJFEXrhHihXX0OiG%2BoOAGN3TBbwgwxFXudC48CcYdhghCENwgSkeaq3nxgCD6KOUyYpADgtR75%2FTscYWEdcEeJdxhQeJhB3xZIBjk7MYM2CmLO9ViBxbAlwQ68IVulIMYVbCABf5wBAkgQAJOeIYdTIAvEYwze4uYwUcl0AJCUGSMBv6zw0ahQBF1xAEEH41dCxahp260wAItiINELUCJeCyiBR%2Fd1wzaB5E%2FbuV2MUMXOoLwNhVABh3CQNUbRdONZ9QPG55Ao1fHuolaZA8dy%2BKqQLJBDHdI41SrCGMJOYJJmkEBXy1gYQRX0QIkxKF%2B7pjESicqgj5krwsb%2FYMTJDo%2FrGVPGFDwwEFzMAml8MQOJ4CdBXLQ0wjuspeA%2FCVa4sGFsT3BmOggq84IIo2vmuOOWhVrBAXSzGfeSRpbxd4twvHVMIZDFp6YazVFeM28ZBNs20SAJ%2BwRj3nUwocIqAJMTZWHOExCFt4gxqyekYpU5GJkODMbNgyRh2pRpBR2wP%2FlVbqBsVvVghB%2FsGIkn9GIOBhCFrMK1MVKUb9aLG2%2BteifwpxGwYESxB1OmOABaZcuJJ6AcQbogjqIMWAinuxeCZvoKu5kCPnZAU%2Ba5J7bFIYnDzNOAqVwRzfCSUQPdIMSKERAH50qGdIaFGWbyMw8StGEL9ghUJPIQXQ30AJDiDIJHRBBHCC8gU2UoQMeyANTJWCHeVBiyPgq8h944o1KPGGyIDVBGVx5yTGVRYBdwJs57hksTzR2bC%2BNRxUOqmEt90sdtSgp44CnjiugmHQS5CVdITLaZD3DZAqowmYrcQ139MECG9ABZAzRgQ3MgHaEACq%2BPFBZntgWpqtIgt%2F%2BNjAEs6GDF5TYQAe6UMOPioDMhKaXNY3bmqPZSbmbuEo8MIiAmgbyXvlagBAq0a7iKSwe2PChCv6wZ1%2Bn4pMbWESwagG7HMRBpxJIQv1mZQ47hBkBC5hBJ8iiOXyVwQnZLsPIIHyyuF3kwJCJXxnw9hd3IMwAPJ3EE35IYQUjct%2FG%2B0MedPqHeTwjulWYxBAlIIx4iLht%2BEoCWWzo60kYot1x6GS7ERCEIVzBHUxFmSEWsYN80dgh75NKIE82AzdsIhzEaAdMO6HTsZGOfWOrxZ8RMExnpsLmJ9M1M1CQL5sfAbZm3sxWEhdszxbkLO5IQsKOsIhF9Brkc84XFBb%2Bni9DkKXXHjgDIUQugVQ8PF9emAReEbC8eIBW1mwx9FYELQJhtFsMjvaFTnU9q0MC9MRjk4AnuihAnKeixRMdZ6o5rQA7G6AMHwxJ6mrdl1tfxHX4Yq5zZeG3KjwXzvkyQE2jimxsTJYBKB7bBp7hjlqkPuhETIKwoGDnfFmgE%2BbaHEgZZ9kW507yBIn3rLrRbjfkMH3CWIQdVtHcSZgUG8T4t%2B7soUkELKK58auCPfrww3nYwx4D%2FkP12Vb6uKVCD2JQhz2kji%2BNFx9fuhtZLXSK%2FXkII8won5iN18J2DDdhFWzqCBJmBgzBXgZITz5JB3RAd%2BiMYJIA0waQlwz%2BUIA%2BT5NaQGP6APYcSumQz0%2Foz4MMojBqwRDiABuaa%2FdkRus6rl3UQeQIwR5KYaIoYR7iIRxEDgrswQGhYBmaK3kQoBPsAe586UxQ5wcBigzwBQQ0gn8GKF1AUAIcquKGQGnajd5sq5OCzQPKwA60UBiIIcYOKg80La%2FCoSwor%2FKQKyEyDwGOoAu4oAqi6%2FrsAccwsBaGaMQkLtnCTASqaHHwZQdkwRB0ahKeS6c2wBBWwf9KYR4ECV%2BEwBMmod30ytwGSBYWIbrIwB0Q4Qd14A8sayOGz%2B%2FwBeRcZlXcYR58gRCqgLD05RikD1%2BOTx2C4aMsoF%2FiIQmlyx5Mq%2B3%2FuuAKuuAHn4D8tifiSiwznKES7AAKVGCY3q%2FdPOuoCMaV3OGQ9C9vnorpuiGxGMcCjEgW%2FqALngH8cvEJEhBflidxVvAEgggb0OG%2FukAY7GEeyiD%2B5uH5UKYPoiaL7KgDD81vXsqeZIPz8mAZh0kFHZAMyEIdeg0Gj01mBCIeYGZ%2BwqHXdKAJuKALBCgPhHDBRKsIkwUEEaAUYnAB8KUR8OQeReAZ5uEM%2Bg0dSiEPuiAc5NEBr9Dw7OHEBq8GhcFvygAM8wX77MERPQAb4g4h0LDW1PAolSvCnGBWwoGNcmEewkEi89D0wswNwE8ibZEsgq0QQ3IR5kFPRK4Mwu%2BH%2F%2B4pHlahsSbBHnavBSJoHthOzexhiAAq%2BIQvR8Di3x6SIMawibABCj4qYQ7xFf9NFkHQFttliLZviIjobRImd4bRKhcmmETnbXgPAZxR82DKEWfgsqrRA10GG0UGFYPhD5bxZPQqguJBGAyBFXWqpnLODhRyBXFIv1CRBKsgqepxFVJvolqg1fSrH9GMFI0kcdxAD5iB2h7mMhvrIBFJIX8QBhdTOARLy2oh0RxTwySMIweNCO8SJOKBHrdHGKRBGIJt9kZGgI4MBvAFGl3vD66gFW1ydHQw%2FnZtiITgJxHAA5pom0SgzESG1tLw8uiGKfNFAWCNhdzMDbKs%2FI5t4v9OD190rRJPgHZsyxBjh9vEE1%2BcIB5ecBmKghpjsS1%2FiCLiYYhUkOfULHjysiIK6qASKnt8IfUsABHoMmE2oNU2AXY2oDBj8Qlr8RYXcxfP0Q3KoAy8yQ0WAe2I0fzi4Rn2bAbyYBWOTTMRoO9Ybnum8Q%2BtcXhG0ynCARtKwRMMZsU2QQjyxaiewaMuzDdj85D%2BQDhWkN4CpRbiJ2F8U3e8QQxir%2BMCNHPOjOnYTq%2BUIh7u0QQCsKrmxw2sJmbaxQFZVB2k0x4c0lC7b3ueIdh2QAyQVEkLcQg9EjztBP5AagNONdtu5WA6tBOkkdpygAEuU6fo05nsge2ODyKP7QT%2FGA8BVFMdZBBlABVxBjQpC7Qi2NANlGgRUsFZRMmTHBNlHlQPJRQBUqFddi8IggVDEXNDjw0KXBBfFCFEM8MwS5QFI%2BjEPDMeVjQ0E0IU80ynciCIbDB%2Blgsd2o0t7SEMfRQWEeAwhVQxB8gexvMIwA8n%2F0CsYsr85kGTiBL8%2Fm02S7Xv1GEVdIoGk63dvNRXwNRVnkGAmHRWoLSx%2FsAd0rRXyWAThghO8aUP5hQhhcMcek0FumASCNYdxmEZhAF55HDGRnUj7CpgHNHXOMljtQwbEDMe7SEOHnUFJZVSNckCGNEGfzAH%2F80LenAelqYUDCZU6W7unEJLZYzekMiH%2F0QgfhIycdqz7dzAE46NVtmS7aYLIsczCPZTBczwV01KWPeHWI1LKWdIuTxBLBcpe6qAAOXrHidzD%2FHFWisxW9VzdDK04XgCFzv0Q%2FGFEMYVHUTODsw1W9H1HNuFXVuUgojHf66gDEQOAZ4gcfyGDG5GgIiyX%2F81doZ0gDLUX4NhESTgbcYP4hYWaicBG%2F6gsY5PYkXjB09gWT9JYyOHY42imTBNnq6MEJ%2BBpWoB%2FMZzZRGgZSHyZWeFFmPHF%2BwhH5a2Dd2BEvQAZQ%2BOEkTu3coCaLnFwmagC7qA4%2BJgHlYhX%2F6gGyYhup4TAZwWcztJgFQgDwyhXtnyxCxAD3Q2X%2F9SYR66FiswZ39MtshUAINbILosFFJPJgqDBVhZD%2FzY7m3tQSJV8lwWCpHsFm%2BBFUCNcob69pr%2BViRyrWvA9fryQSil9SoZ91r7DXKdCXfdoAZLNSvZbgZsgRzs4R6Xy3N5Ip1Cd10RKaA4QhQDpTFPxgBmILAMt%2FGMbhcqjIjGttpAakjfpgrkaTx7Ll9yAI5%2Bl8QidM8UgGeDYMX8JveyZxNiT6eaVzT5L3OOrVfjYBG4YIO7QRhGNhw2Yc%2B2t3sz43vhlWXDoRPQcxcTRgVKAYoOCVdJS1Cz8ZPGBgm8gSd%2BMFr9x2AiNToxF08owU8zU2oWFTMRwAnaRSL50mv%2FP1IqJBkBuCwcflkdhLan3METTuZz8xakJqEbFiHMEhILg8E5Se6QJGAVWHhWXHhvXUWGR4iGC4IN%2B04kRC4IBDHY7vZJqbVxsVVbDQ93JeAKDMHkQKoWHq4kEYAFvECjfigz1Bl02y5gt6cL2ikUXZRu1KELT0Z2uC1xLMwCuuAIPKADDCGjOqADQGwWRcADTqBfiIeiE0kd3ADcJGAImsgTPMAD3M4OKHq6BMvZZuAPTuCk32gGTLoU7G0RnK2bIJpk%2FQiQmY4iZYwQ4sEcRE4BOK5XI%2BiQHnkFE7K2VNeodcAddgEE8sUDdMoCOGw4z1AbwQ1l1sAWigKJVFcE%2F9xgpstmHsiAos9AACHaswQmB2zOpcgpsuCsoWknnaLsCGDYV77WKFa1dpunG4LtcTfX62yqVCXgqUfGK%2FEEUxmnD9yBV%2B%2F2mjktm%2F1km1Wnmw%2FIhn2lDGzvZGShUt%2FmCJItutL5bR43HCCsiHD3wvIFxCIIx8ZGBVQ1D04big3hbTwzkLYThuCNoMvFVFBlE1SledDhVIa7i74KG26hG1yLtdABG6ShHQVitSBjWcwKe8JBGqSBtXqLu7OHFhoBVcKoud8IurfbDBGMWkbmGaQhvWvMZ%2B3kGaqAqxEABVBKHTxBgPgzDlTAAjzg7I5AscQosSzADcgpFZxtrIFKBP%2BCgRwq4QbGZgaeyZOXDnUsRrjd6FlkI3GEu%2FXK2wyb%2B7upG72xahWEO4wWaBfEG7uVQrtHXFTLIhxyYKNKkSBuZ6NEQFUhLajKjKXz5QQyywLoZ3M3KksNYb97FaVSbaOWZ1ZSYaNUoLJ9Ain91lhbpxZmQMutdYbCoQyqWgJUwBC4YAZYICz%2FQMsjz5O0%2FFY2UcsnTB3MAQJnwBPiAQQ3wA6SSgJMYKcDZROGwAIkQAJE4Aq4LZDeHIoHawa%2BNXGgINAlIJF8W9YcJZ%2Byp3qEBXoUCJmOqIDIx5uVqXyQwdEcCXs2HZouy35UjjSfYRJafRI8wRbYIX36t9VV5av%2FnkFnbv25Vcu31NvVW%2B%2BrZqmtzKEUXH1r4%2FtnP%2FnCPb0zHEWUSl3TLUmfKh0dHIiBkkmv91qXpULXD6IYaEGOuvvWXYbVW91Zgj3Xv%2Bq9uygSs4iW0IG3xr225D1ZLrtoMrtQLCYYgmGuvCFMPrAW3XvfTwnB3KESaCEYWo%2BCgkUYgmGWrPi3AQNg3mJugOl5dzlP8IRjFInUUb1O1AWaOh4dKMnTDUfZQyVasiRt5IKCXcXUBcIZHK2ApN3ZOd18Pj7j%2F0Kaoj3b7aK4Ks%2FWeh5sEMjfEQdpQb4giMEbqP1Ypf0hrtgpJn4tKt5aLh4tTgct8Oct4hdeUl7iV%2F4t%2Flr%2BLTboLbC%2B3n8e6AEA350CVAqljCfXIWSoLKB%2BKaQeLai%2BUqy%2BLMyecP69RE4%2BhrxeUsAemPhaLsh%2BLfheQNEe6Nd%2BKdqeI%2FLMAyxgBLitIeT%2BK%2BjeKOy%2BLPAekPT%2BKxQfK7Q%2BqzFE8OWC83MZ2Y0C8a9eaIDF3sXF8Y0C8jnCHOj98k9fXiJ%2B8DEDHTyf7kB%2FK0T%2Ffvz%2BWAC%2FLjAfK1J%2Fgg1%2F7NNkMIifbxmfQIX%2BImo%2F8p1eBHX%2FLTRfKJgfK4B%2FgoUfK6R%2FKUi%2Fwtt1LZRfKsAfbJ1%2FLVp%2F718fXKi%2FWK3fIrB%2F%2Fbl%2FLbzfJwCi3C10BAsaPIgwocKExZwt%2FnwIMaI7MJrcRbyIseCtchk7QswGzKPIhPEAAYo3MmVBYNlUqhToMqU7TWAsxhTpzOFNkRt3dlTXzAGAoUSLGj2KNCmABM3U%2BezozdbTjiynZoxizKlViDC3RmzoFeLEimEf9iyrECRahSVPrk1Y9e3BrnILzqxZ12DOvAbP5gUqVCmACC9KFNWAWAOBoQ5eaFDKVCvfqHxXtqyMDqvkunT5gq081iZfv3nVVm6LsnJcvp3r3hWddy9m0nIBC56SDt%2B9Q4ttrJMnD98UADas4YO3JWlkzJQxr%2BaruXLrup%2F5hp7NsbJpvqidX2Y9EDRN2HVlV6b91nbSEPesFTnU%2F294GH2H%2BASyQQDXOiWs5IVAulxlzan2HXRZSRdeZdXldd152fG1XV7dEYjZdG%2B9hpl5oz1Yl3pIhRBIEQC8wM8cAByyTgqPAVACPocAMEV8SBHQFHMheYdZZgeCl6OGroEBCnlyofdWhHVNyNdznCXI4HgZ6uRgZR4Kxgc%2FIuKiDzz4QEKADfzUAcAP%2FLABgAYpnHnmC8eU402bbr4JZ5xyzhmnMxvRiWeeeQrkjJ5%2B%2FvkmE7qwCWiheMZiaKJyllNMMYQqCuk5FD0KqaKxZFNppc7YQmmmgJ6zByDneJpoObb0Saqh2fCSqqHl0DRqq38y6qisgCJqq5%2Fl7JKAYP9DhcHPJQQQcAkkQPDRzxheyhFmiTCGAm20tvBiS7XWXottttpum20ssXALbrji2uLtuOaea4sRmVCLbrva3vKtu%2FJiW%2B689hKThSTs2itvLLfwO2%2B9ALdLDB10EDOwuwInbC68DKPLiyRZIPywuQtXHK6%2FGIvLSyW9CgZsKIER5QA8oXgJpphqzFijgDdSiFl0PD6J2URBYoe\
ZkXIhmZeSclm4FoaV%2BVgXkWhNedQU%2B4SyWJlyiKiBPJewBwkAW%2FSjBIAtTyYVjjHvmBfQay34I1lRaveyhCallmSBS9bs5NBQbihlUEqFsM4%2BrlwSyhQOpIMcJPxkHYo8agyzzor%2BRgXIdY4%2ByyVz2EzmRbZcDdKNNmY81%2FX4WmKXJTRfRA%2FJYW12J6WEONasns7KNuAijzhjDJVCf%2B4pt3VeA7adY%2BRvY1b5hRQJ%2BZbRaOn81uZydY7W52GFHtvceRkfFtJFDYt900NpMPL22h%2FFuO5dw1yZ7z9PTp30lg%2BPc%2Banre31zNbFLbr6pNfdva%2F6CxZ%2BXbv37La6mO8tzgtL8ILGvrNBKG1Hgh%2F5JAc3vMgtR9TzivX2h8Gi9E8u%2F%2BNcACEHtt8pyH4INBvmFqg5B%2FIOQREk3lpGV7zSped0GayhBnPnv%2FGtsHwhPF%2BODoiWy01PhkVi4M5UCMAKoe9C9Iv%2FHgWJeDQa2tCGG3xLB5f3wbcM0HNLfAsQQZfAE5bGiMlDogeV2EKate8vUpxiBqu4liu%2BhXlo2WLzujg2EgYxjEPMGRnXorw5ZvGOaZzgGjvURjfuD45okeNa6FgWO5algF754vP4WDQoHu%2BPaAnkIwc5STyCronl0SNaKriVCyqSfzjkoA6T%2BLXN%2BBB4prykCfvoPu6YEYtoFI8E6%2FdE%2FK2yhowsiyPRAsmwSDIslNyKJb0ixEz6MYVueaAIm%2FRLJx7SdPkbJitl6UrHgTKSPSSgKMvyzK1E8365VFs1dwhBX7oQLTBcCyqtokpvgq%2BVVnzlGWPJQlrWDJPsROH7%2Ft4JS%2Flhc55lqecpNVm9ROpTa%2BDspzh7V04u%2FrCW0CRoDKd5ULYlNJ7zy2Ypg8mXfE6UKMUMyzHLkkyvLNMrzbRKOq2yzo%2B2s4EI%2FadCXUNKuTi0LPecikpXuhR%2BxtGfvAToT9M30FtKc6dH7GlTn8pEkwqVo14p6lOOutKWeuWlYYnpVma6lZpO5aZTyak9IRoW5AFyl4LsZUkZGpahhsWrPgHrRMW6FbJ6xaxWQatV1PoUtj7FrQ8FqS6tWteA3lWNCkRkN5F6w4ou9aJOJalnuIpTj77Vse4UqU89C1StvkWvXYVrKiWK2aEA1iqC3Qphp2LYqSDWJ4r1CWOJ%2Furarci1k3T9pF0XSlkxcjO2uNNsI5kaWR46l5nnNCBo2yraxlK1jJA1rmSRa8jKLpe5%2B5yuS6HrXel%2Bl3LXXWx2gUtanpr2qqi1XFBX296n8HUnftXnbKdSW6vc9im5fcpud9Lbnfx2r8G1ynDL4klkjpOm1VXnfV%2BYX5%2Fs9yb99eZ%2FnxLgqQzYJwX2yYFvkuCbLLi18a3qfKNb36zi1Sus3cqGY9LhYX7YJyF%2Byoh3UuKdnDgmKY7Jim3c4Kk8OCwRhumE01phnF6YnhneyY1dkuNV7ngnPfbJj28S5JsM2SVFdsmRrXJllyzZK00u65MPG%2BW2TrmhVb5JmlOS%2F2VFbvkmXd7Jl2MS5piMWSVlVsmZp3LnlKx5K20e7Jt1G%2BfFzjmvdY5JokWSZzfuOSZ9vsmfXRJolww6JYWWyXsZ3GLuvji9MQ7apGlcaZdc2iOZnuKmXdLpmHxaJaF%2BSaQTG2tTS7WgY6TmqiV83NTOeCs1RnOS%2Bwrb2N5aJbl2ya5T0uuUjHokpR7JofX7bJ8s2iqNtu2jDfxrBb%2Ba2cFOyax%2FEm3MTjsl1VbJtUeS7ZFsWyTdFsm3NRzunYx7KuUW8LlNnG4Vr9sqzUZ0wHEcb6TOeyT1Tsm9RZJvkezbI%2F32yL%2Bt%2FPCYDPwpBRfxwYWccCMvfCoNB7cwybs4pf4%2Bl7PqxaoX2%2B3vU7N4u3PtLrLXa1%2FVYhilbLwscycukoqP5OIeybhHNt6Rjnfk43YOuZo5CeHi%2FtzmQVz5U1oO8JfDnKUyNyZ6t24g80J5o1FdtrNT3fNjOznZQXc7y3HOE6vjOeJhLft5aZ52oMtF6hmhuqX1rmisM1nrcxe8q4VOZaJbduyZZc7ZG1%2FzVuex7duUy8h9UnIfn1zMKTez130CdpCLnfJI94jSRcL0jji9I1DPCOExYnhZI34kn99J6L08ekGX3tCn30nqq776o4TgEMO4RAoYw4fmPx8ADgiE9JtrecDnZfYZqT1Gbn%2BR3Kvk3R3p%2FU1%2B7%2Bfgi%2F56%2BDIp%2Fk2Of%2FjkXw8X94DEOqzxmEDs4xLrGIZQDrF%2F8OB%2FFJV98RN4XIcW4CcROodkcEdcPod5mjdKkEdnkjdeSIEBkDAcctAPL%2BAA6xAKABAG%2FfADJROCI0gEBCggl%2BdmGKV2cMZ2oMGAb8dzDyh3Leh4XUeBlGaBM2R0RfEDw4ALjbEPfNAsYeACRQgARcAPs3MUNOIO6iCFU0iFVWiFV4iFVegO3kAMUZiFXwiGX%2BgOxOANXhiGZ4iG6hAF1GCGaeiGWMgLbyiHV%2BgOOdGGcyiH8QAk8YCHfagOvFAOfjiHW9iFgpiHa2OIbziGZZiIblgOcdiIaRgPoAAGfP4YiWdYh85wh5eYhZDIiWDoDhGnAeLADysjJsyyLMvSLMwyBdECLZdgBVQgi7NIi7Voi7eIi7i4BLnIi73oi1Swi78ojMNIBT7ABMSIjLwYjMnIjLS4BMvYjMxoBT5gBNFojdVojc34jNnYjD7gA7HIjcgIjeE4jONIjr5oBN94juVojuuYi%2B3ojrdoBQWgPyEgB%2FugBCjTLGqgiqdYJmiSJqigCwNJkAVpkAeJkAmJkK%2BQCQrpkA8JkbqQCa8QkRVpkbrABKBwkRvpkA3JkR9pkJngkSAJksZABZjwDSmpkivJki3pki%2FpktAAkzNJkzVpkzeJkyt5B21gDCRJkv8T6ZMgyZBB%2BZHGkAhW0JNEuZEiqZQcOZJNWZGo8IMO8AOPEQL4EAhXGQhL2A9bUAL6sJVK0JUss4mfqIVcWJZmOYWLmJZqKYVr2JZu6YluaYWZGJdmqYfJ8A97yZd96Zd%2FCZiBKZiDSZiFaZiHiZiFGQknQZd0SIZ3%2BYmP2JhXOImVOJlaaIeXWYVzqZnuoA0%2FmAL6MDVy4A9hQACrUwKHgA8vcJrWEAKQgA8uoIKNY4Dbl1GEJFAyqJeJyZu96Zu%2FCZy%2FuZg36Gh0J2PJhUtFJxh1gA%2F0sDRCoQT0gA9gORRTIJ3UOZvio30CdJuhFIPWAQa7GZzjSZ7laZ6DOZz%2FtTlLkxVeyuWDvmIDW1AE2vMCW%2FADRVGf94l9K7idIPSCkPadDBKe50mgBWqgvZme1rSe4AVMnbcWtUZFfjdWLFicnXVN7DVQ4nmgG8qhHJqg8HShdYecU6WclCdbEhpYFGpuLpiDCYh3UzegHSqjM2qeHzpSIXqc7Zmck2eiSfWfAKaiBseiCIhOL1p4MUqjSaqkiWmjp4Wjj2d3X2ekGUF%2BGAGhxISitBWkJjekElikGbqkYSqmgtmk9PWkOhilqDelGFGlF3Glb5SlQNqfWtSd1BWgP6KhY6qnYVqmMHamE5imxremF9GmEfGmGNR6ULGlotelf%2Fqlurmnkcqn%2FxCIg0QKTe4XE%2FCne%2FJHXomaEa%2FnEbF3FXVKYXe6Pnkqqam6oX3Kao56qTsIaz34oHz3V3EKYosKfI26oBgKqarqq6tKqRVqqRYGq%2Bwmq1H0g%2FJmqzyGq%2Bmnq%2BZkqsKDqr9KrePJqmjnqsQaqO83qBFRqBBxqIu0rFzWrJ6mfqBGqmuXm%2BA5rdXqrggarCvaos%2BDqS6hqeO3e7RGq%2F41rnxWrrp2rryWrjC4rgLaru%2BKsIZ5rRGYrVJWrAzXrRDxrQ8RrvrjqRgBqlQRsNg2sABasHiasCHLmwtbqV76qtuaqRFrFvkKb8kqcf3Kaf9qbRuLbx2LbtGKQAcrsjvbl%2F8kK6wmq60jSmwXyHowi2sya280i3E2i3A4u0c6y7M867PyOqwOi7L2qrILMbELoQ7B8DEmerEXkbEZIaoYwX0Y4X0XoYBigaRR67Y9G69COq8nK7Q69RfB4LJ996O3OqdrcbYXkbZfkbUJMRFQ%2B7YJO7VyW7Vy9rB3d6xlUbG%2BErYRMbYYUbYX8bcREbgQsbYPUbiHC7r%2FkLhcOrdBq6MkyqNga7TUhrQWp7RNx7Qo57RgZLihW62jy6ila7V1O1opta8etrr01rpL97qyF7ukN7uXVLu2%2B6u4m6u6y7hXqxL36m4smxGR%2B00FqKD%2BCb1rNbgI8bnMG7XO66zd61v%2F9Tq934sQW6sQ2AsZwUtxwwt7xTuqeyu7H3uq4ju%2BcUu6iytpjSuljxtReVur9kuufVtHxyt8ydtRy6u%2Fkkq%2B5mqcUMq72lWiqmvA%2ForA5JTB68fA6tS2D4ywEQywE4ymFQxfKYW3Peqj2gui3NnBvvbBoeXAIqynJDyzJgyoKIxqvkvA%2FBrDrLvByqTAHoy%2F0mrDIYvDSavD9ArAairAFvS7Oga%2FSSe%2FoUq%2FZlvEMnzEOZvEiMu%2Fueu%2F5%2FvEghrFr%2FXDwBvEwjvEMrXF2sZ%2BpKa%2BBhG%2BX%2ByuS%2By6TUy3pzu079mjkwsRlXsRlxsRmcsVccxtc2wXIWzHvorHxKvH%2F6bboOLlxxjswjcKw%2BbLW4pMEHXcyM0bxs87xupWxtx6xvg0xVpWxa53xRr7rBrVxU%2F7ybcbyuU7ygpXyil7ykbltSwMyA8hyBFByBBhyA%2BxuQ%2FRuQvhybOcqo88v5G8u3xst6lbtGscv218Vm%2Bsb4jMb5yMDsvMzJHqzFgMzdHLwzt3wdV8yU6aybeMYt4MzuF8w7UswZqMy9KbEtQ7EuybEF37terMn%2BrJve5MZPDMyPI8puPsyvascrmMtbv8Vb0sGEUgB1PQNA6gBBk9Bf8RJhX9PZUX0NtLp9b8dNzMcQZdwwgNrMRJtUAbzZPsnrOarIHAD%2BsgmovBhPzAD%2F%2F%2FkBxboA95UzXZmUPYXFjarHEmHXUordIQTM8lzNCm59DpC9HQ9oMaYA2H4ACHwA8vAABycA9KEAM9wD3iMAwaoH9cXV7rbKbt7NI2pdRLvacKTbZZrLlIjXvom8%2FejA78jBAq5QAE4ACXAA%2F%2FwX9bsAWP8QLUWQRjiRTNgM8Up3hl5Q0Y9dgl3SNvDdcJ3dTWNtlPbWiUWNkeoc88UTMR5wDWwA9hAACnqQ%2FigA%2FiUAL9yA%2BoGAa1XdtqQAvIkBO7zdu97du%2FDdy%2FXQyxENzFbdzH7QyxAAzIzdzN7QxL8ArOLd3BPdwNMd3Xzdu3cAvYzd05kQUpndnnGQl00N3%2F3K3c5X3dw43e1y0x6z3d2u3ezl3d8d3ctPDPSOEAWxAK4sCaW%2BA3SrAP9zHbq0gctn3buU3fzK3eCY7c583gxw3dD27cCy7hwQ3fFR7c3x3eCU3eGA7cDu7hvU3hIc7b7U3ivX3hJ54T863iOWHfghEYKcAPW0kUDbAOrJDYRrjYqt3YoQ0VkT1Ync1DPo62do0Row2j4L3h5CnXlivkbb1YoH3ONlbaP%2FgC4gAHS8gPfKABw2CEL%2BAiH8gKAKAG%2FKCfMUfSrEzUuGXUlh3LtLvkk8rSigvlZEzkR67XfH0Q%2BeQArqAP%2FZEOKUAAocAPrCAO8MDVNI0L9OAKH32i%2F2muqGtOYG1Oe0autpgd5zTa5INM14dcSDC9o0R7FBEgB6FwCNPnAKV%2BCGhNAGkQCoGgOGiu1n7K1g3r1mCa6Um66cLc6cZs6WKB1yOB5B2h5wbhvvtJmyLtt5Tefb%2FOuZie6x266xAxzAtxzAoBPSfloMjqy6sc6QI90p5NaNAe7SsN7rjJnqCOuqIOc7%2B8EMFM7b3%2BEMVs7c6OzORe7gY67Q9R7Qpx7YQb7DiR59ZrpamsZ97%2Bqa0816%2BM7p%2BF6%2FnuoZvNxOLubQEv2gPPqUeH8Bir8JYr7wthyFZoEJIphSpBhQQxhff%2B8BB%2FoHJdhQsRUyePDim%2FzZ%2BuTZQs0%2F%2FdDukJL%2Bkkxux20Q21IPS18AxRSBCmIvTCoBLCIPTdoA7hMPThsBBkow7kUfXYpeQsf5jjbBFDXwvdYPQIkUzqgA1C%2FwxOEQxCL%2FVHbfN7LvNub8DDTrElv9cE76YGr2njWvXuwPcGDO8PQQzkcOeY%2B%2FNO0QctIAGJLwEeUAVnP%2FOVwAALcATbqg45sAALYAjx8AwbwAASUAuaVR3qEA%2B14AZOP%2FOj%2FwdYr%2FXmjmPqQAgzoPgS0AJxYPoHkUzucAWX7wbxEA4tsAASsAmB%2Bu%2Fge19RKAzHHwxnDxvhIAzJL%2FD9HPY%2BIQ3BEAzdUPcZL222WvXPMAndPwnCEP1i2%2FH%2F%2FSwZ3aAHjTAJa2%2BbO%2B8OXYAA7w%2F%2F738CwiCFlfD%2BQkD5M%2FD%2Bmf8MFoAAACGhljp0BQ0WLOasoLpubjZIkKaOoR0LMAgexJhR40F3YJL9AxlS5EiSJU2eRJlS5UqWLVVGAhRv40yN6sogwJkT5wxhFw0Cy0azoDsnOMvEC6cC5yR3QjWWu%2BVU6lSD7jSBaXpQ4qQgFiR83RBkUVZ3hr4e8TnVmUKM7sIRepaWas0gX8feKjdX70Z1zRwAABxY8GDChQ0DSNBMLk2CcUTotAClJ1VvtvbudSesSiqJtXBKiHtZNLooxhaPVlcqZwsybnTk7OJOXSWcQppK5CsxrboZ%2FjgNxXtmAYHA3bgTDk2F0wM2dfEWGUCQA%2Fdojh5dXseeXfv27TBlUncXJ%2BcGKFxM5Eyym5i36Rh1u4NiFGmLpbLbL7yvGyq66bjv4z9tLquw0iqcKnRCsAyC4ukDpyACnGmtjDbJAYGBqMOoNwTuygtDvfr66zARRyQsMQjdCycJBHMSYZWsnKrMQ6HU%2BWMDAzqRrRYGELAgNBmnKu1Evdz5AycVwpknHnWOgM6DbmarbR50aqkFnRetROeZUlLpBkv%2BNPwtuOEu5M8dbEqpxZxr2EpNAQQ8ECYcdQjZKZxwfuzoI%2B725LNPP1Pyjjp1hNkAJx2CiSeebo7IqRSC%2FyTqphJPugnnSome4dKe%2BBA4Khz6ENgkHmG4lM2gbk496NRuoAoH1SlraZVSjFTFcMAr3ekiJwl04GIGN%2Btj0MHiAlTHnTW1ElOCXOTSzan%2FNByLl%2F8%2BFNI9v0jElkQTp3LnitXi6KNCnHIwRyt37NPKG2LKfLS%2FUhc6d7Fi4zVInXA8wKkUJXXkMa5iT5uXWXenzSjIH9GJJw%2FlNmlunlSqqIIMOWlD4IhJZvhqBkIuUmcSHfBVQAQdKHkUTOCEI85KT5J4TIIWmqBFNi4eQyDkJLro4DMTdJDTwzz%2FBDpoobELdLTwcNpAGLJq8WCGLgZSpxaWaxahhT8ucqeUI%2F4KNaGMIOTz1KitETiBjCfVeaYFE1TwRaJSTDAhB2yI%2BQPuPJKQwIIWTjBhBuasrNuEIGq96kV1PMkpiIGUnEQ4A2ZAuEEEHhyKISrl9KnYcGqphBYv1QkG5SrrdaebWnxBOC07rRw0GC%2FRgXYeW1Y52yA777R99YJWR7vK2zNHR%2FeFrs22%2BMK2dVYWCXCCoptE1fEWJ4b529wQQ1Lp6aJndqkEHWGuD%2BcZX3y5s5bry3xmkUWUJv2ZTQzZRBj%2BgpeF5vWj3tECbMIpxRCo6x3UIiaRPYMIY3z8MV8punEljRgMT5vICQNyEAdPoMMe87gNxUQgAejkZCzu2MTyEP5EHN745mRjKtYihIOgGTwjHjnoIAIex6ScGEAEPauVdYa2Qx728B9FE407huAgBspPSWg7wYoQYIgcFQonMeTUfGpYwyPw5xnLU8BAQIgTEcwtDk3KiQ6cyBQrMQoBsQFP4QwSj1y9SRjfQcc83GCCI0gsWJN71CaCYAIFSEAFRyjFbbrRhRYsTwQ56EOlFsHHmp2gBbIoliyqoAIGWGAGZYiIlRahAhX8YRI5sIAFcmCIi2ioD2VAAQNEAIXQQI%2BTTLRXEDjpiXjUogUqqEIePCCBGbTAl5u4TTBmoIJHcox4xkMmYJAnFHeQgYuZtGIOnvCHuLjDExjLiQW6cP%2B2I%2BTNITjpAxm%2BYoduOqgWdqCZBeLwKGxwAV%2BfmUEq5hFCXW3gGfzagB0%2BJQEo9AxtT1ihBIaQi9vUxQKTeIIIW0BKmjjwR%2Bo4EIJYQ1D%2BUAwBIrBDHJyYBNnsADpB6AM6ceIGJZksWbXIjBNFEIcuiPAI7siDuCQQhDLYQUMbOEIVcJdDPfnQpz%2FlDhAvo46vIYCk7qlKF6DTAjHgQVxJUJIZJeCGmOakU59iQBX6oCKcLOKExLEmTk4wNztkMwge8MSmqiCbZxQqZUZT4%2B4%2BVYXv6MZe7pDJHR%2BUNRFCJhVuKSqCumCPP0DRAKWYRyneqROeNKewCFAKFD3RFA3%2BOW41EXHH1wxgByWFI4kIoEQtkSbCE%2FTGAHS1kuRO8KThhSiZyFwmTTKLk5cWCK%2BdcaJODHAUoq6oFG2UoU5ymxNguqMKUDRSNzaB3Hvu6Ik1jI06pKEhnaggezvAiQWgqCwIOVRG9urCCnXigbFAaTibsIc9FIaAGRCkE3GAgjTSG1G6lnCJX62FHMXqi3nMwyz5skct3OQkd8xjEeM6F550CFQGN3glQv0QNmjWBzhmJDV26EIqrtGOA1cMOO8kRH%2Bf8c6rMi9R6HgqfouFOLKRNSeGmIf8JsFFbMTDEOPyWVzR9k4mFqQbzwCyNIAcDr1KJAjQmUEcykCzMtj%2Fo8Mz2EQlmpBd9%2BXATQrIgeIkrJwyVEGEPItHkcTqhjI4kQsyoe4MxAAFEcbGHULASR46qxRQ1dK57O1ah1dbLDgjIA5wBNFrkxnbmajjNQjg7EyaaQADjGwTXH1pbw11hRygI6IIIEMnuMAiQhhihWWYRy20i4A8vE%2BE2Asv89xgOueeAH5DREALzBGPMkDHBITwmAyhIJvAVuG9CwAnAw%2FiXRkVuBZ3O09O9kwxJxXrxtFZUKgX0QVsIuAKJTXhSd0hLjdIyUpFjYM9UjFgzD5bOgf7mYPVve6RQHgu9oLBSCtspXe5wx7PmIQYduBEFaCDxfZcUFGiGDYEkPGO%2Fv0%2B6YrF6uI3nc1en5rEPMyY6DQSiD%2BqwclkrUSGDnjA4x7YgCfsITnKTYIMSXhGejeNacLuZBO0uEYfFjEpdyTrjfEo60XlGQ9CiHASLR9OKdIbvfbatwXdIMY8bkK2BfZZzvaic6j4hYD0ALkbNJvEh4cDyXodU9DZInRN2grOeWNEGJP4gzDsMScjVaqoLSCy8yIqnVCLMA%2FpbSNH%2BbcIQtgDOBrSFzo%2Bm4q1T90QFyzF8iQQp89OIh%2F2EIZwRLDAokonUUU96kaIjaHNpYLIpZsErDc0D4rB3dnj6kw5ofOra9s3TKLbNk4QkZV4CNwN4ib36aGN7gWz2%2FcN%2Fna3gIpa24PAD3PdgILjYniEebadIPABG8Sb4g5K4KQFWRKdwltMjJzrwCe0xkkVulEoC0ym4lkB3Qp7HI%2FjIgi9JF%2FQvScRByE4kQz2mHFOKqADN%2BRXIpFHIUkDtYKIB1hrMjGDHCt5NsixLzKIh1tQh1TYEQWQJ6ebM%2Bmxs646IuPCiSuwh2fzPq3wuq%2FTFsWYCg05iraoN3dIBTtIgs9CABOgPBPjD%2FbDiS5QkoSLBzfAiSdoinmQhkXgAjFqlNKhmcnCHx7JHjFhgGAQBixKAiiAgoTCiVSIh6LCQSvhqsxrINN4qG7QgeX5A5lojqsbKdKjrekzN4IQFxW4%2FoJF2JTWMynY0xBC%2BA53MKPbG7c3KTfU472e%2Br1A9Kngowpc4SLWshLPiLVNmAel4hEkQIRncwJ7gKCLYq142JQSK7jp6zCEy76w2r6cIz4EWh4VkBy0yDGLs5fPSkF3mCMVGAHiGjlh%2BadCYbSccEB1AC5d4QL%2BAEASOjQ7JMBMBDrKcYcn%2B5Kucge8MEMEQCwLhDoM5Je3codOEKsUwYkxFEHXIsESrBYrgbUguBJzKIO088UhukUnWq3ZIrXvsMEzUpJfXBweRAAfVIc8UL6vyBcjzLgcyR9%2F%2BcVguKInYrQYssKi0kZ32MKyM4jNQw1xObp4MLYV%2BgM0RADb%2F1BABFuFAXuGebCHNpLDbBMdTDSUYhGVd0IEhxkw5ymLcZFIBQNEQZTJoSFEbmExa0MYpIA1gcCGMVqGdlAEnEiCuluKeVAHc%2FgUTewCo7SHiLKNZAmGAsu%2FseK%2BNNSK15CAdyIjwrE4%2FuAqFWCt1UkO6ZnFyQEssaoCQ6DHXIyHTbiCQtIJO5RHiRAXbbSSJzCKYnw%2BZLSvo4DAsXPGeYDGpJDGHQG4g6jDx0ia3RjBbjyMsNMIV1SOZyALjDuoeXgCW3ODVJjKGWxHAowoHByU7NvBHpwHa6StRVAGMwqkZkRCfumR%2F0MZJ8SimooDO8iD3KRMhJQJhZS3mXBI0f9ImJyYATvYBDegs%2FJrB4rByJaMDhb8jElAh06gGdGcwzGJh%2FxDACighEXQkBHABhZ0kw0QIOcUgUkwhJ0Cj96byfb8k5qcCnXYlMnBTeq6gnkQEwTog2WghXiLNTkpKhXYhGe4NE2UAEIQBorIRuCwv25IBQ2hSlG8FTphkb%2FhyhehPvSYtURxB8kBlbIMgnhYhezKr4%2BUj1qYBDtAKVrQAzqrghhDGWFIkk2RDrx6Bpr5A73UpJ1IRjziBQNDGhfqsz4wymaUOsP0EYQRj4tyk12zFm50zMc0QWdZBecaghqLB2kQFwaohfEDsA8UK8%2BUM9C8wXgkTXp8AntYOub%2FkxI6%2B6tmJDx3gE2ARBlfaMZFeDxhoKpNeBLe1MLf1DwvfChzEALkygk3kA3mVEPUG7HP%2BBTmkY3rfACouTSdkIDyGlFlQ4ex5CIcWs%2BYdM9QDaqYwBCGED2Jyp4%2B4yXxmrwtyiad6BQ6y67LMrLx%2BJWLYrhRtCKaQYC1Kra4Wggzio44UMtDI0uSi4extABPSA06G6wkWCphcIZiMCMygNGa%2BYNFcJ%2BcqAJP8ISi8oCOFDNj5EvqKgNboASaSQ921IFnwAbgOlIEOMyFCB2dGIsnjVJv5JalizUouAI6MwAcBMwycB%2BaOQG3izN3DE0zRaHSrEc1tb5a0AwPUhSa%2F4ECO2iufpHNMWlE6BCBRVgFJrGh8PRT3zQqhiyI4BQNtKmC4bqodaqos1DDr%2FC%2BY1whA9iAMtglFWCOMJQARPiwvPkfndUJFJg96gms8kMHMzKAI%2FlGZmJPUZVaoiHVUu2GKxCv4WClR7GlJ5KASfoKZi2LxcoBcZoqpIABCRiBbxqXYHgUT4BBC0BOPyKrr%2BAojGCjnNC4VLQUYaAuJTqCjiQ5M4lFHvlbHYgHShChDUCBd7IAlCLMIqxUnfgDvBKzEDxGHrUvnMiAX5GAQJJMpBkuqRvPJC0jZUPEroPSfC2RKXUW6FEiAwiCs4GCDsraHrlCRhtThDmugI1HLP9anDNgtKHEuOEYNRnqFOoygAH6DIAE3syQVZ2ApdcwAAr7UwPgwoIR1IP5v0WwHkPQ1qwoB1s4nWcwlfGRH1%2BMREPoCQOCFe8ZnycJh2DwhWDYqZrzXvgphmuol27I31SgHvQ8n2KL2qk14Aer2lLNjPw1BEjKHGzwXj1wEfGpBWwYiu8BXzsZn0wyoJ4IBuuZBE%2BVLu%2B9nw4uB17ohvExXwBSOutTz%2FNzj4bg1c%2FQgUWQiDATlrK42Q3ogkIRgTdahE%2FpoBYgo9DdR3QoM504AUJoChzGox1lrx4lpPFgYv7ABmOlOjOSuuWZ16HoMEwru0BjXSl92vnJg0e9KLP%2FeZRFYZE8OAITOM95gAK4qWIrKQO4QVS0URsVcFuYgpvosoN3WgAomCMTeAJNopkFiB%2B%2BaQF%2FSZu16eNaqIucUIEeU4cngJse6xa46QNha8jtPZgyORd6KYgTbhYAyZxRbheOOeVTJp1RRga2gBdSnpd38ZkCPuBcNgn4%2FJBRtuVXXgZv4A9XrmW7YuVHUWX3SGb9gEBX9h58%2BzSUxQxgrRfgWIQ%2FwGb%2F%2BZx7ktih8AVs%2FgNfkNNakIUnAb0%2FwAM8WIQFqhdKwOZFuJNi%2BZ53Zmf%2BkAYqSV%2FLOZ2C8AVyDgds0ANsjsp6CYdr%2FgNmfQZZ6FJ7oZL3xY94KN693cYx%2FybjIXHQUsBoabBlgkgFjKbMWLmTcGAGWygX2zmVnaKV3TnpC8ZoqElptGnpgrAFZugSU3GVYa4FjCYVk5YVle7pQC3jH9mPUJ6K4yBqp0g3XVbqk%2BDlo0YHoHBqoRhq9wiC3OriC%2BULvOJQgWmP5nieYU5lY7mGX7YSDjWXrdYKYm5lu%2BKFdlCSjNDqVQagtMCGZxCGQ6u0mmhMilYm16UKYwaYtTYIdbGwYUnrtO6Prj5lYsgGw0bs%2F4BsIVHZqJ7qqN4Io7bsyMTlpV7qpj5qqM7sp4iKjGC%2FDpKAHsMTag5tg5CQ1c4IvCg2XcqtOsZXvm7doP6RGHFtjADt3f%2F%2BZNz2kMr2bcz27aTm7OMGCc8m6t72beFeiGnrgs0EbtlSbddubd8uCNj2mUmIIScotL3ma8gMbd3G7qcOivImDVB2bed2beLebeNGbs5W7lBm7t1m7xr86lC2FfS%2BbuzW7lKtBYhJS0%2BtbdsWDPHObPLG7vre7cl26vsObfd2bfiOb6We74Nh8NWGcMve7%2FLub9%2F%2B71JNlJf87tW1bQS3bAX37QxfbQc%2F6g23bAlfbQqv8Fy%2B8B9h8cyGcafucOz%2B8N0OcdcWYwMPDBSPahXf7RzPbBcn6h13ahkPbRqvcQO%2BcRlRcsoebezucd%2F%2BcdcO8tUeciJHDL%2FebSR37Sv%2Fj2omD2UnP2ooz2wpn3KprXIPQfMXz%2FLiru7V7vLV%2FvLQDnMiN3KnNvPVrvOjVvODYXOidnMO3%2Bw4D9U5x5BCX%2FM7f%2B88D%2B09D%2B0%2Bz%2Bw%2FN%2FBAP%2BpBD21JD%2BVDF2pK3%2B1Fj2o4d3T3hHTqEPVSR%2B8t321Mz2xNt2xOP3Eyd21Qz%2BxX%2FxFSl5FED2VU5%2FFGX%2FWZbPXR8PXgNvUZt%2FTMpnXLtvWoxnXCSIEUCAwHeAENEAxt53bD8HSi5nXLXnYPAXZmR290IPajVvVjl8lkF41ypw5hT%2B2u5HJZ9u8O8e1qF4wXkAdWAAwbsAZ8gIctCPiBL3hw1%2FXVHveolnfqOHcM%2F6H3H1l3om53dw9EeL%2BMhxeNiedb%2FsZ3ENf33eZ3wCAAVugHgAcAXFgHJWAFeQiBlW%2F5l4%2F520bvhndqjheNiJ%2F3Zl%2FtitdvY8f439P4vdD5vfB4rPbwkAfykRdy8A4MNZAHeAD4EMAHSAAAJeiHKdAAfDgEAJiCrT%2BehR9vy0Dvo98Lnh%2BNpMcQoP%2FDoZ%2FaotcLtJ8Ltocre591pvdypwdzqAeAF6CHMBgGgLcBfuADAPgBflCDF%2BCHOkB8fmCDwnAAt715sy9vup8Lte94n49wvY9yoYf7dZP7ucD8qbD7lX32GC%2BGdJ92pwYdEwcMB8CFSwCAwX98OQCAwpcD3f5%2F%2FDkAe1YA%2FuC3BV64heI3%2FuNH%2FuRX%2FuVP%2FliIBeaH%2FuiX%2Fltw%2Fum3%2Fuu%2FBSPIBOLH%2Fu5f%2Fuf3%2FvBH%2FuoX%2F%2FLnhSwA1dAXxEigA%2B4v%2F%2FAn%2F%2Ff3%2FviXf%2BznBUnIAvev%2F%2Bun%2F%2F23foCIdWsgwYIGDyJMeJBXpQQAHkKEGIZfoDDprE2xwY8PgB%2F81LzgV6fjRwAENKBEGSJYuZYuX8KMKXOmzGy2aOLMqbOcrWw7fwItx8RY0KI0vd0yqhQmuGLFwC2Nqg5Msn9Wr2LNqnUr165ev4INK3Ys2EiA2EVdCq5n2qVI2ypVpwmMOrhFmz61W%2FSWN71BjzmIKJjPPXn06P7hG5ZCHiQAU%2Fop0YCv8RbIgh8SaKYOHefOnj%2BDDi0atDdbo0%2BjTo0OWDbVrl%2Bji2JsM%2Bzaocvdsq0bdDFnu3%2Bjc0eVLPHixo8jR242HvDdrJvrxg3dtru57qbXduYbO%2Byk3F2raxb48kMHIc6LG6YBQCh6aoatW9%2F%2Bfbr1lxNo%2Fu66tH7Xz%2FunJhttAIomHYGn9XbgaMJVlZyDD0IY4VfLKSjafxV%2BZiCGnlUHxnUbeqYdiJ95NyI64Y1HXkShNAZACKzIY00RD5UAo4wq4jfgiPyZyNmFJgrYo4YmJtgjgxIimaSSxVHY448gDglihx%2BaKGKP6JQ4IooqCkYAAf8RafAlmGKSl%2BOVPDrZ2pVBmhgliEWaeOSSc9JZ5z9Nmvjkhm5iOOWVVvaYJYhbclmooffl1yOaearZI5sj8okhnCPKaaellyaH54h6Yhipgn72CKiJgm5I6KGnFmqmoqZdySmGj0KZ25WTSjkcprfiKpamILqqoKcHglrldoGW06OpqCIrmKomLrppo0DOJqSsPdK6YaW5YpvtVbtu2OuBvxIY7Iiijkgqhscmm%2B6yO7Ka5pWxRdvmtEQOS6mt2uKbK7cYeksguACKCyK5IJpbIbrpIrsuiM3y%2BuyIsO4574jV9nlvvhdbum%2BF%2FQL4b38BbzjwhgUreDDCpyq8IcP%2F3ToMIsSdSvxmvbU2iLHNdGqsIMf9eawfyBiKjCHJB5p8sqEpY7gyvy1v%2BHKFPetHcYXX3ly1hDkfuLN%2BUHP3c4VBVzg0gUUbzSXSFSq9MdOvxgtpzBtK%2FanFVtPtINYEav0d19h5rSDYCooNINlll5kos%2B0y%2Bq7Tvr4t6czWzl235EwCwpy70l7Z94F%2FHxh4f4MTrqzh7L6b93eLf9t4hXEDG%2Fnkr4d1N4CmY7f3dJoTyDmBnusHeugQna1g2jqvXSHq%2FqquIOvhug6781zJ3h%2Ft09kOHe4A6g4g79%2F5%2FjsAwR84fNbFK3h8x8kfuDzAzT%2Ff%2FraVt0o%2B8plb9%2Bfj%2FiMXa2L3v4NPoPh4y49A5uMZ%2Bgikvo%2Bxz33ti55%2Bpged6jXnev3JXn%2B2x539ha5%2FAPrf7AIIoAFurYAAOqDPEqhA5zHwOw5sDgSBI0H9UFA%2FFsQOBgmnwf5wUHoe7A8I9SbC%2FpDwO1Q7oQJTyJ0VAqeFv3nhd2L4nRlOp4Zlu6F%2BctjAHeqnh9xR4m%2BC2DUTEnFyRsQOEn%2FDRd0wkTtO5A4UoSNFo1HxO1ZUIRZP17ZYvcuLfANjGOs2xumUcTdnpE79QnU%2FoeVPS%2BLx3qHiyJ05HrGO3NFi7X4YtUPKrWZ9dN8foRPI6Fiya4UU1rva2Jw3nsyR2IEkGSWJHUpS%2Fy%2BU3NHj7fi4yap1sjmftM0ga5NG7KwRO6YEDioRpsrpsBKQrpwOLB8oS%2BzQ0nq2vKXNcgmcXdaml7D55XSCOZ1h%2FqaY6hrdwhDnLMXdMWJ5xGTrNElN2FnzN9iEjTZfw03oeBM64NyNOJN1TOgk05PLhE4zWfjM6UQzgtN8Z77i6ZyBJvGgERzluNjZuUQOapGMTBU5VWbOhqFTR%2BqclUXX506GSs6hupnna%2Brpmns2J5%2FN2adu%2BpmwjibtoywLKeZImrmFojRbKrUNS13jUtXAFDgyBQ5NbWNTVP2zOQHVJUSBU9CIrvOnJw2q1YZam6Kq5qipSepvlvqbptbmqf4owynadLo0nsorq0YCKldx5VXYgDU1YkUNWXdj1t2gFTZqbSRbhedWtcHVbXKNE13riqm7viavqNnrafqqm7%2FqJrCvGezRChu%2BwxIvsXj06Vy36liMQdY%2FVRWkRF1IUYGVVHsYLZVGN4ojz%2FoPtOMT7UipFdsSmva0DYXf5eJqpNeG7LcynO25amtbRInUo6Vb7W6uasbWAiehLmyscOuUWtVI9jSUXRBygabcJzLXYM59bkSiCpypXpO6urEuaxdrr%2BB2V6jETVxP41Ter52Xjekt2XrZ%2BxD3%2Fga%2B8pSvbegLSvvSLL%2B43O85%2B0up%2F%2FotwMIcMNEKbGAE70bBD%2F7lLcwgDDn8StiuFAaphaWE4c1p%2BJscHpuH2Qti3Yh4pQyujYN5id0uxlihKE7xY1e80xZb68W5C%2FJMZyy4Gj%2F3xrbJMVF3DJseZ%2FPHu9HuErlLZCR9NzXhHc14RWNZ22DWNpoFD5Qh4oBQHIJGkLgEnX8AAAcEYhiXSMFto5vT6ZL4aVrWDZd3M8Qv68vIb0Vyn5SMPSYz1cmfa%2FND%2BPAPVjzkMesQxzqmAIBD6OMS8BhGitqL2w3qFoCBZpyJKzZkRHtX0Yhl9NQcPUFIn1XSvaP0D%2B6BD0wDgA%2FyCIGXAKABeYQCAGHoBxEK5%2Be2AnpN6SwxaRn7aljPKcyoGf9zgQbtS1vDENeA1TX32uwAa1zCGsAOBbJDoQQA2GAfHCkCP8ZAngBMIx763je%2F%2B%2B3vfwP83%2BcgRsALbvCDx4MY40A4wxsejyhQw%2BESDzg7eDHxi%2FfbHde4hjsw7vF6eBnbdhNEPTyOcXcsY%2BEmvzg7CL7yidcDFGAo%2BcsdrnGO11zivGBHzh0%2BjVJfJhDi0MAwME0Aa6wDEtbQRxE0IgeSPP0Hcpj61Odwh6tjPeta3zrXu971NqDB62IfO9nvgIY2lD3tar%2BDD9C%2B9rd7Pexwn7vW0SB3utN9D20vBN%2F77ve%2FAz7wgh884Qtv%2BMMjPvGGxwIT9oB3vJ%2F98ZCX%2FNz%2F9wAGHzie8m%2B3u%2BbhfvfOp70NBeASEfAxhhBYAxfrCcF6UnCPSzgd6gB4wRZqb3tBJCL3ut8973vv%2B9%2F73g90AD7xi2%2F8RPjBD8dfPvMTgfnmQ5%2F4w48%2B9Xmf%2FOpjPxGOYEIbHOH974M%2F%2FOIfP%2FnH74fyoz%2F96vf%2B%2Bdfv%2FvdjwQqOyH71r09%2F6k%2F%2F%2Fs13RBuYMH%2F9N5%2F9ASDz5d8AHp8gjJ6KBMI%2FGAZikFoKrIcDrEMopAA%2BBAIAKEE%2FbAF5ZEY8uMMHgmAIiuAIkmAJjuDAmWAKquAKuoPCseALvqAHQpwHwmANmmDF2WAOluDG6WAPgiDIkUI9%2BKAP7twQ9uA4%2FxCDEepgPQACySlhDqbcE9ogDkohDMbczFUhDPJgFrKgOhQhF6pgPGgD0EWEDYTBGV6EEpSAPLCCBkwBP8jB0VlDCUACPriAs51JqnXQqqVOq00NGGgClZQLuX1HNgDDlcQDIMhaaNHap4BbE4lbZhEiDVHaQ6TeQ7ABPsjDrwXGFCCGPlwgHq5KtDnKtAmaH8pNIF7JmrmGISKiIloOfxmXf3mI%2FZTSJEZRJcLbC0AE7RUBmdCenfVZHpIitDxbH1abvagisVyJK%2FZIIi7ibjUisDyiGkWimuGiG%2Bki%2F5waDumhDvHh%2FCRjrSzjqGQjdDijiUBjLFbYLF5YLRrSLf8ayzZmUDdW0TdeUTieDyq2TjkOYjMe4jPCYvxcSZmFxpllxzXWBiumBmdx1DF%2BVjE%2BjCmy2jhCjj8SzDk2RzqOyDoS5DSGSzUCk0J2h0aGEz3akD3KET7SkT4SED8yD0biD0C%2BYjSqGkgCjEh2E0m%2BBkOihkOajUo%2BEktGkkuGEEyuj0wiEk0KpE3uIU5%2BjE7iE0%2B6hk%2BeBlAO4yh%2BZClC5D5aZMUoZdiY5G9wJIh4ZHEp1nHBIymt4ljWFEpOkVCuElG2klH6EFIiUFgCjlvqRlluyFnKYlrSoiDCljzqD1zCkVwiE10qk11ukbfVRqGhESAS5kz2iF9iCGC2o2D%2FvmNlmpdhKhIZfphiAhRjCpRjVhJelpBeXhRTquNAouVoDaYttuU8iqaNkaZUmSZVoWYsqaYQUWZtXmZAvqZTgiNU%2BoxUxhRVqoZVjgZWiuLhSKTLUCQy%2BtZPsebu8KVtYGaFaCaLuaOLrWVFgWZG3WaU5eZ77WZ89aYz%2FeYXZadsuWZHwmZgymZn0iYzHuZ52paU1QaVfZWVvQaW0RNkwoZkUkdw6qeJdKeCfOeRhWeSjWdhCmdoGhh0EeNWGiNyXhJ2eqZYzqdZ1udm3qd4fmiGlWepBINDXKipdSWqTWfTVKc4XudcxWcFbWdtNOiBPOiiRWijTWhypei5rGiL%2F7pohsYmdb7oUX7lH97ocoXoX44oeHKmieanOdqmkQJPeibYei5YexrUe%2B7Rk6JXlGbmlEJolUroicLYkKoXf26Uf8IGgOKVgLoGgbaUgb4GgvqSgmLpcNYkO1Jpia7plf7jfmrpgXFpiHnpiEnbkt5lk6Yim2qnmXonmvqomgIppT6amxIYnDKSnL4GnUaWnaoGnhqVnroGn26Tnx4qgxInfRpnPnKoKAXpZ1aoeSbq9ywqjjWqjoEpVklqP3Iqjlqqg2LqrP1ord0qgHlqh4Gq94jqfvxqlQXrdYlpLZGpgB0rjyYrIy6rIzYriuYqbUUrN0LqSsYo26Rrag5rTP8WK5QCalMKapoS6qYaakZmaaJOq2qQqmpda329a1LGa5nOa3HWa6beK7MWrDU%2BK42daz2261yuq%2FHMqFfWKGNt64Z1K4H0qLJqKsPmq2VaKL%2F26pRVa4AG7IMNbF42LMcerKwmLMgurLi%2B7E4%2B7JNFbEpO7GJWbPlc7Eu27GrerD7lKGzsqMd%2BqzSGKzWOa5uWa3PtbFz2bGn%2B7IGgalipqmqwqj25qr7GrIjOakvWKt8op1IxZ2o4p2hAJ4ZqZZLKaNUKa8YqY9E2WccCyMeCa8ja7MguJaKarNyq59UKUNAyKd2So91GGt72h94yLd86reKWVdqixtqGhjoUaeD%2FIql9KmnZQhPlLsjXkuyIJG3eLu1NNm1IPu2S5eyksaiW9mtq%2FCt4mWqAGG6kIu5FSu64Ma5%2BOC7qQq7q7u5lge5oWC5otK3oCG6XEu4H3e5jZqs0bayM9e53%2FO5Tpm5Orm6nRu2b7mrsosbsilntokbW6tXWpkbXvpTo%2Fi2sBqqG1mzk%2Bi2I6k%2FmqogDKMEU5G8IPITUTQGZ%2BC%2BZKO%2FmkmjnZu8IFe9Bsi%2F9ui%2B9wm9v4Wc8du%2BnFgq98QM%2F%2FMMGboE%2BrMM%2BtMgGd3CLuK10PnDcei5CJTBoCMf0Gm31csf1HucBJ%2Bf23lrr7hp%2FqgE%2BKMEL2IAGNIA1qEcg8MML%2FxBAemhAIOwDL44w6ZQwu54wdKgvUi3wXrowdsAwrcqwEJ3t5NpwufEnJKxD7bWeBQJAEWhgCYBiGWsgB57sf8ZqAZtwFkPiT4HC8GJjFU%2FHFZOtHJstDYdbF18QlB2dPogDPohDCmjESPQAP7BB7HnE02nAC0iyJOPAMXjDJWNyJmvyJnNyJ3OyM%2FCFJ4vyKJPyLTgDKaNyKmcyE%2BiCKrvyKGdDLLzyLHcyMBQDLeMyJp8DGEhCLvtyLGSDL%2BOyM9iCMNPyOezBHpyDMc%2ByLZwyM7tyLEPzK0sCGCzzNKeyU2CzKgPzNqMyYHAJAWzBFDhAEezDIcSe0zkyHGIgnf%2B58yXYAi%2FYwjzTcz3b8z3jcz7f8y3Egj778z8DtC0IREATdEHbghFkAjAY9ELrcz8z9EPbcyw4NERDNDFkgSQQA0VT9ERrNEPzAkd3dEETAx3QQUaH9EIP9EmjtEobNDFIQhaYNEsHtETLdEGDdE3nMzA0xKk4QDqwwgvoA0cQQT%2BEQQrImxqHARvbsRuXjjeg01Ln6bukWavW8QQrSOk27ulib%2FACjMxB9WtMdXdkDpSFwDBwxAvgwyFIIKapAT%2F8wFoDABu4dXQyMdw6MR9%2Froda9YFgte9qdQxzdVT68Rzvtc6GcyjwAyuIAzzwIh%2FwAy7QAy58iWPjwj24ggD%2Fb%2BnyMmrz8tDzumvuguVXV%2BXRvkZfW%2B9fY3Fgz7Boq0ZY9yRpq8bgOAAbwJkSE0AYhEIg2AcBjEFu28cSlxNnZ5Fn%2B%2BbQAicL323YSunYFuUTu9ZgO2xhT9rUJqZm%2B6pw25F1Z1n0KhRyL65ynylz16VzL9EW%2B1UKg8bxfkbyHunbcm4cq3aH2ihrqy1sq4ZpvzBq73F82yp9o4Zrj%2Fa%2Bwm4bz2nK1unK%2Bhh3b5d35xoeQ4ceNzdeW495Ey8gUyJ1pxKBj6qBlyqCb7dxw6d%2Fn4Z6fwZ%2BW7F%2BRzh%2F97GIjwaAN6d9%2FyRiZrh2%2FyeHA%2ByjkjeQ6fWCku4bL%2FfM7m38%2Fwrv%2FFIx4A44jRc4dk8ScbsniI8pi4sGiXuGiecxio%2B3hE8UdI%2BkhecihhuThlOrkr8Sk4epk2srlIeGlHcGlT%2B4lTdmjqMRhaMZepMIjF%2BljH85km%2B4mDMTmc8tvez4nzYwwjZxRc6mBPO4uX4vmPurjdOuh7MtCf6LOnwgkkfxWE1xa4L3pYo3eFR6aHDbbaBvZcl5QnK5Nnr5OOl5mBc60K56Z6hDOCzCEwyBEAzBEfwBNvDCT5ZBEARBKdD4pfNVphPIF36gvrnDq0%2B5j4c3kAPHFfg6sINGqIOGQaqwnI8gRP4VpSf7awu4kYpqsofDuKNDPEQXgI57ODw6jv9%2FzDPkAALAe7wjwAnoQVeqAAIYwCIstbBXFrH3DjYgQRIIfBJAQR78wSJgg4izeXNA%2BGvce75XJrVnyKiTl5YjrzpsQhcMfBcA%2B7OZlTtMgsDHAaSq%2BYnguarTEDoQQhCoQMvngB0k%2FGfkmDssQstDwYtK%2FGeYrzo8wwzIuwdIgLwvgrO3ALxPwr7TeWesMJp7hjoIQ9DLe7ybwCY4O3AsPHA0vGsUPQIc%2FbQ%2FizpAJNg35MV3xpCAvbJzyBbHOhREPbxXwTP4mVnFgx0YgAEEQbyWPHtndhR1wxG0PQK0wCYI4swTArznAM6T72nsvBDEexKkwjPUQhx4ALyLgDD%2BbEbHJXuyM8fWd33H6RtnIHtwaL5IqYO5U%2Fo1bIfn64jqHzfTw%2FozWMDfw7sFCD6AXP1vZL1qcH7Etwalo4MwwH23w%2Fp1CEM4JPvZc8bZg%2F0zhMNmUDrPBz86SMfzP4MwdIPvDzk%2FhUMS%2FLy8B4FoyL0dwPsR4L2dP%2BfJ%2B1OvqkM3BEG8W4AOTD68e4Dld4Y3AIPYXyXyckjhI8DhrzdAoBM4EFi2gQLVHVQ4MOFChw8FRjHWEGLFh%2Bo8IdBYxZ07dermTZKgsUy8bnHI5AnGJYcbYTM0TvJIiEyZMsK6uSHTB92iKjrIlKLorlacJDnIVLr28Q8ZMpMaqqP5lKL%2BRavo3IHR5O5q16vqnlkgWcqToSojEajoRlFdvI%2FxuDKM51Zdx7h1PcJFlw2YV78W4wECFO9v1xYx4x4s6C5YmRkWRATpEy5qODs5LLQgUytIjip1L%2BcwBGVDi0Um4%2BTw4CHIInTlbqmzrNrCiSCGPha%2B6k4TmMSF49nRiGCIJ2ybcgwndBeuu2vXfqPD27aqu7l1684TjuBIYuvTFcam6%2FZgW712yetG2MwBAPfv4ceXP58%2BgATNqqp3tx1BFWFgy9DIgCvicoccW7oJp6OoFqwrHAU%2F4mqtAgnRKIeoCEtwQYGAIWdBjyZkqMEMO1IvoolMfCieODSyIJjqjrD%2BUB1pLDAgs%2BFKgQmBSezpQ8Au1BEGAQNOiNEAjRbIgyt3FhFrOAagCCceKAwwYIaEwNpgSEOiSzGrrVIsDCwnDbGno3kMGW6RAmux44gj3JhEOumEcSPOVKo4whDKwvEpiDJc4ytM3QIbbFCHDtuxyw47EWG44Y6gTLYYBbRSASvbquJIJw34A50gHtUoiXJ4QYfSUMnI71CseuuyK3W6OUFU7OKRxlEJuljSlz6SCKIJMUrxTpg%2FnjjCDlkS%2B8POVf7485k8NOpOOnUmcSOILgjpJjF1eClqCDg9yU2dWuzc06wk8nhGVa%2FUYa%2B%2Bd%2BGd7751%2FYJVBVE9ks4dIRD%2BMOEzrDyRggURWjBWUlne7KOWKlqYgYwE%2B8ghskUScqdCBC7EqpYuJIYhiTKw%2BYgWJI5wQhg7dIjMU%2BlqeTOPbsiY4YQnoDJRInpNdCcJGRWKxw2NTggHGw9CncGcRDfxxMlI3RHGSQREmAGtE9ZyWiMRYFBAozjmKUUjCWqpaxGg11oVK61cNXuhMTVaDiF0EuVIujKejlZddyapcgZHEbAAG2l0CPUIZohRu6tCCTMcbsQWIoYWWfvOczgo2vpjuB04Hu7CeK4YboMTPOjGx8ihcBIPYrxGwIM%2BfBouFZxzblW%2FSXD0jhBCagkHq0m0fFSCP5Y0hOjhJHCjoRb%2BjkzUAEIs5y5fKIr2hKuEvKgbgSsmXOTIDUAdTgSh1Gu3vXjJh3feMDEaTiaGgimlbLzRejQIBTfRyIMNjtQoiCCqHI5Li2WkjlXw7VE5wIY7KqG1tAxpOGXoSP0Q0ALk5Q8BwFPPzQynjsAhAAqJGwiTvlaLbgxPBZ2YBMUSVYbeReojVsPYM9yRJgQoIBXzIINGhqAtkUAtZBuMA1yeoJEuePBQX0qb4hASlrZ5B3oImAFWRtc3AuagG%2FGA4HAMwJHuSaAFThJCX5BYEcQhMVHrU8gyxGA%2FT8zDHSzSSCfckRzuoGMe6JDj5jqHgA2kohulCMe9EFAme9DOicD%2BuJgKPEFHO8RhEt1AIm98ox8ZUq06%2BQLL8Ag2PKoRxUkiUIEC14QOHRHvWdHqSIA0ogJM3g2VeuSbASgHwuGcAHIISALsKiK%2B8u2SPufzEgQ3oK7yiGtoGqGBE7qHgFpYkXi9UiACTpCE3umgLRe7kDlmkDwnCAEtp6kEA4bTAifwzQLCYOZwgpAEJz3xgihSmwY10kGFAFCPOBleHMzElcMoAC0woAydnHQadRRTAatQh47iIA1hPENHpbDHdi7UjVsFS21GDONFlIgAtwmEcxq50jOGlwSc%2FAEtebDHFWeQijysghL2E4on%2BFaJI4ZxjIorY5eIwQKS1PEjPkT%2FB9%2FgiI54NA%2BPGnGCW%2BKRipEoIA%2BLWIQhtJQBW6TiUTMjxDPmgUv9yI5QqMzYRTbRAg%2FMQFu0qIAeYbgzBARBGuoYHTtHaYdN%2FHA7R4jHM3pHiIF2Lw%2FzqAVauvAMbPwsJvMYWzwdWQWyadUhuuTlY9%2Fjy5xtJ2j0AssVgrADYNgjHnKcxDyuWKZwQK4Fz7AHtHgYD2sOtAudMa09KPWHeHxTf%2BEYJFpScU4EkMEdPdJIMBm7EAy%2Bs3tfHYjPgCa04ZlxcY%2FaQNgAigCwfQSkM5QFNnonAe1KQIGEiIcwtCQBX2TEiYqz6EXXltGNClWxTsSb%2FWAIkvbewB1X%2FKx1%2FtoLhW48IxztjcNMkVhTw920cTTQCJcE4g4nbO2nGgFfDGXUUQQMESstxSIFESDTLoSqb10IIyQBDJF4tNe4DDHxfvsYhwxoJJGQW8R%2BhXGrF%2BnIrh0JTrRCArRnPKMbzQvCPNzYgmm5g1JQsMdhxduRTixWN46F7GMlqx%2FKlo0hbJnLMSpBiCr0rg8nTW5dKFUSdchCa8FUbQDjMY9u1GIRXTCBRrhgD9oG0i0EXcU5FVALj9SizMIszHDNhty%2B%2Fac83btSMRHwuoEk6lFCwJLVJPCiS1oXuzO0wKUtsIEKWOCHRNZIHlDpBiIWEW3oTa%2BT1ivhGQj6q%2B%2BFJjog%2FijeigVRuhuwNVquMGpTC1Uwuj4UgRWS0wMnTmcM5htF4yHDok6YMPX9mg50kAMd7C8HlYDLJKBAwAOHuDAg1k%2FzRNDWgzyIPGCJQxC0RMFJBAMtmbY1KN2hIy4k7sbcsYcbJWDrDayz2NejtxthIEu11AWClGyyu54MZfyEydnWZQs2aoEVOlXhzf3TyB%2B8DE3KeBoBdnALn9F6ZoxRtwuftPiE5QxOBGzCI3id4Z0hKIK1CLDPwVUIoFflDvIiwAkjat5u5yGN4SlaIIkyTe%2FWFCSxRJq6RCsoOgC5CGwIQxmVoAWPsXLYGdzLAtCtaKl3zRD1bmuDRvZqQ9yx%2F%2BRXQ1AF%2F3QHrRmw3e1SOOzH7TUZY8LZuczFHcTgFwez6g6Jtg0dkOuCmeJBqWVTWB3BEEs54fKMSdQCG7wQRioWIUJPxAFyR7C5V7ytG1lKYBWJiUcXWtAFoTyD0SpAwooR4IlaEE%2Fu2l0TQuld13trJO61D51az5B7jbRAHVpPcMGp%2FBcnJ7x8UW7yKtBiCA%2FGgwwLyEEewAJICwzBDjrCeME3TimPj6vPIs%2BYDo4kAR24YQhCTLl0%2F5Oll5%2BzsjRH6%2BcHgnOzJfMJ7jsZWjxAGNxB6DSC6JprEezhhiKIMiBN0qqLhuahiW7JHmTBA4okbOxFfvBvN8Cu7tgmkP%2ByCiQ8AS0IwR5kqO0SYh4I60rYzu1o7QqeIReEQRZqgRZsoe4OQsDUJlGw5Q980AcXgRj0AEnKoBZSof1CLo8koAxKob1GTsLoTpREZS0UkAZsIY8MqCOaKFfMi6vExOX87S2EgWgMIAnsgbBaYBPM4RpQQI%2BkAdEM4RmCoRZKoRawTkdCSah072JmQBiCQRhWQRaCQV3OLiHiYcE46Mg0AgaOj8nEBOGYr%2FkWblB0pLSQKhjIcAfeoXlYQKbsYYO%2B78s4bvxAzsysKR4I6XvUwR64wP1oSwLiz%2BUKiv5mbhVqTjf071Aab3iuJn7obEaGjiLK6Lv4hmsasOlmKLf%2FrmgHuACQVCBkhKqVAonb%2FuK8PDCj7EAOg4EQIEcEYOivhOgjBmhrMg4FoSiVTCscdKAFdgARqDHQ7s6mOExARMAWsuFUVO7TPGIM5%2FEJ84juZAmaWkCB4oAYlMZ%2BcgCQFKULI0k%2FWlGIcCIVYOBrKGEekJAM7MEeKAGcJCBY5KgL5sEeSuEEZqAKQgYP46Le7KoWOHITMpIMVCAH%2BkC39EodDCH6FBEBGBErkG8DpQMSIzFenE%2F0ZMiJFgHzGA0BNwwBdoAY6mGHKijjKmsUP678rGkemqft%2FIpvDu8VY1FLZrEn7Q%2B4cNGdMkgWRulRREAPsIRGjsQAT6BK1iQe%2F%2Fog%2FYRBSDTCF6irRhKtLgiLgfpFFqJCqexH3AzHGsPuA%2BWOeNxROpywYZzkGc%2FJHMGCbzQjmWQKBzkqHgesH9PCFryhG6DAFz1ASTgqFeQIY5Zyc9orCtXBDsSif5aQVPBmePrHAoznkbxQTLohNSXgBPIRCqxDATfADeKAgHikKIWADGTFAHLAHKQQAfJQJT2CUjagC5JgJJaHK7pHAWZAajTiBqrosHay4QzuEccnKIVyEtFHGn3xMyBMI3bACZ6my8APzDSCFK3SQuIhdZyoCnixKznyK%2BdPLG3x%2FsrSJ3ejGwgBCqBt2vLgGEpFILrBDuzEz9ChD%2BwEA0%2FCTv88oUPdABor9EIrhhKe4EG9gBZ%2B46CM6h39AjF3LUh8US0RIXHAIpmGwwRYDm%2BqRAT%2BqcI4ZTjwYBk0czMNRXFSYROUdEmXtBTs8SNSwULd4A9gCCFk4RmEwRM8YRN6wqM%2BohaU1OsSrE3sxA2CBTawYljK9A8E8MN28ws3SHBmrhZs0wAUYMUMwOPQoYkAUwT0DG7kMiXjoEqCYB%2BVJ3%2BAhE50KlRy4G60xwBUoBENIHR8cvnUsz6GssnUwQ2sRwKqQFLCoYmqRAJgwgCC4Jx8tC6EoEp%2BaMy%2B5hmGSm8%2BYimrRAECx0rQIYE0wgGdRBmvZuaoqm8w1C9y0Wym4yP%2F6gJNP%2Bg6DsI60sM8yGPvmpVZE8wj6uIanAEh3AG00IISXBT0OjAxu0EMvsApzJUMrmpFzWERguA7W6JKx8Up4kB3PghPvnMGaGYcwEgzddBY7eJf7aIgEGLv8iXBhMACPOAIpMEe1KG95AY8FAJayUNZ64JgFXQ33lRMwoEQhuBej8A1ogJhvvMIGqESnKIme6Jdv7MM%2FMwOnEIwEWITThZLnqEMcuA7dQBlpcMW8EBlc8AOyiZeycAOECIY5JVe0fNS1%2FNiF4Io4qAKrqAKyuB1KiMPpKAJphYbnEpOnmFrEcITnIpDnWoRGNCpuPQjzKIKuqAT%2BsSpusEWEMFt%2FwWibaUOLLYWOgdqbJH2L4oVvZS1SIshW8clCbZs%2BH70MMO17niBHfbOYh3CWiPEyvQiYiG3IwSlSPs17AS2ItzBDfLnBJxglPLQL%2F4WB0MvRbADWesiYpHVOaAjPbBCdQsWK6h1YCdXX2RXIRZXdiV3W%2FjORCxVaeUjU4HXWWtXW8mBGOjCLvSlRLR1dpm3eb2DYLGiRDrEeavVkqJXem3GLOuudHEwcKUjGC5FTb4VXMGkSG%2BhHIp0L%2FYVBzN31zYXIgYqNSnICdQDfMPudHHQGbK1fde3SINXeOGDeNHLG26wfedXM%2Fv2ovQ37MQXVvYmanDjomA07AK4SC%2BXX%2F85EwcX%2BCL6BAre5AiqgBLmpDAe2NT4t%2B78t33RIYNxcIAJ2D0M%2BKIQ2IU%2FuO4aOIxS2NTEl0K7wZHO90UTF4PZV4Pft%2B7i19RyuLEAFntR%2BBbad4XDroUB%2BIhjGChnuIDZEwdvWIENon13GIl6GL1%2BeFqYtisueNdgGAc3GH47uO6a2NTK2E0bUjOtWH2x2AO1eItpuIvr7ouLdI5NbYwVp47D6IxNt4jZeI%2Fr7o2VOI41N4w1E5EZcojDJI81s40Ts4%2F9uIbDSJA1k5DRy5ANx5IVR5Hrbo1NjZPDDpLDbonRi5R5WIqLlIp3TZNx0JVNTYZnGJSRSJQ9mJIZ2Hv%2Fww6VDUeV95eRW9mRXzmJY1mS5ZeYv9eWNROXTU2X646X0cuXH6sB3gWYFUeY5ZiaddiYdw2Z1UaZd42V0Yub0QuWd02WL4qWydiaTTdjc%2Fl%2F9ViAPfk9UoAVXAEXcKEIACCgCbqgAUADIEEcXMEGegmQw46cJ9mFTVlt1Nls2FmFmfmdnXnX5NnU6DmM7PmQ8XmV9Tmb%2BXmTP7qb%2F9k9poAfrGEYrEEJAGALZJqmbRoS8CEQxMEa0pOL01g3KHqaLRqd6fik626j0cudLwqeLyqk0WukkaikT1mp2zml0Uubjdifg1o%2BAkEeQgA%2BAmEdNOA9NEAeLuGm%2B8Ggh1ei%2F3etqJnYnMPuos0mo1eFqS24o5%2B6peMZmudZmue6ffF6ULB5q1d6l%2F06jLyZFehhGIYhDNzDsSFbsm2AH%2FgAAICAH9SAPpoBk1PEGwBbfr3hqEE7f7F6n6cYDEDhtNUDqsNIqi%2BKqhUHGEq7SAub4UDhjvs3sbd5il%2BaAHDBGviAFfhhCgiApvnAFfhBCS5bDgDgB%2FhhDgCgCA7hurHbFoBhu7m7u737u8E7vMHbFmJBvM37vNEbGGLhFtK7vd0bGIwgE4rhvelbvMu7vvHbu2PhvvM7v5chCyRhvvs7v2NBuwccv2%2BBvw%2F8vZeBDuhgGRa8vtc7wumbvCn8vYtBEv%2ByAMIvvL33u8PdW8FB3LxpIQHexQHaI61DAQBQHAA%2BQK2fO7r5AbpLoAhs3MaVgBayYcd5vMd9%2FMeBPMiB3BluQciN%2FMiRPBtuoRiSvMmdPBuY4BWefMqF3Bligcqx%2FMe3O8u5PBvGAcC9ocuzPBacQcyxvBjs0cynfBz2YA%2FGQc2n3BaYHM6d3Mrp3Mm9QcPf%2FM6TfMv5PMnJ%2FM%2BRvMTrowF%2BoARYfB1YgQAOPdFDIQXw4RAAQAn6YQrmgwA%2Bu31FG4dvu0glwrWj2IW5mqNb%2B4rbV7ZpSrBnma6Teop3G9QLY9Sb%2BZZfmgPkYRheIAw4O61xfQw4O7nFwQYuAR%2F%2FUkBe4NrU5HrVj3qo%2FyK3w0SvP4yvwwi2kQjVA0zV65nV%2FTa1m1qrL0rWPdqr32UL5AEf8OES2oPczR3dq3sd9AEfOtvYmf0vkj3blx23ud2MfbudpR2JqF1xrF1xaNtwrBqj892OYf0vwL2vxf1dQqAIIPo9Hj4G4EMDiuAFMPXYDziBB1nbSxmpt92Fof2R%2Bl1x%2Ft1wAt5wBl5tCv6uD143eZuF972RG96PhVrTOX6UPf6i7HpVnD1FRt68St5wTl5tUl5tVt5sWt7nX%2F6S23fhp32xkcibhVecDafeSXrnw6jnD%2BXnTSToETd9WfrUR3uqsT3rCbvpD9Pbwwjq%2Fv1d6hWH6pXW6tUG66ta65GI6wfF69UD7L9O7BWb7Ns36Vdl6bte7SuK7ZHI7U0e7jPopQmY7s3G7msb7xVH78OE73XD783GqaNe8DH37O8%2B7adY8RWH8Yne8d8J8qte420454f53isZ8dd55pt66NWm6M3m6OHxSHWe9G%2FZ9A0H9XNf9Y2V9efe9UMZ9stZ9nFQ8wuD83MO981G91eF91eF8A%2FF8Pee9nNO%2BNWG%2BKvf%2BFdF7i9V8leF8gne8g0H81ME%2Bv9C%2BkkN8LeZ%2FK%2B%2F7Gdb9Csf%2BK8Z%2FM0GIJw5Q0ewoMGDCBMqTHir3MKHECGqa%2BYAgMWLGDNq3MgRQIJm%2FuoiihxZ0JstkigjAsuWsqXCKMZCupyJrtwtmjiLDcTp0h0YTe54umwotGU2YEVTxgMEKF5SlCufkrQpdaQ7TWCCVo0ocKtIol4XTqzYsaxZjR9lhlVocu3DqG5fxoyLkCpdhDrvHvQJVK9BsH7RHQ1McGlTwujgBrYb%2BGpWxF0RA9Y79qzls2kRt0WsODBMtXoZB85LmK%2FWwJP1DiZs2CnhzqFvlsZ62m9kwqnpVr7Me2Nmwptfs0T8mbBov6Qb%2F6ytNzfd1YFbcx6%2BWHZj2pB34nYYeHfv7xZ%2FBw4eGLbe4tURo0vu17Rk7oGh%2B5UuHPHxu46Z372NGj5liuAF%2FiieX%2BT5Zd5d6Pl1313s6eXedojJpxd95VGnoHXtYUcYf34555Z3AfI2oF4F6nUgXQnGpl6D%2BC33XoRIscaUaxXah6GDGgbGYXP%2B3QViiJaNeFeJd50YV4p3LUgXi3Q92B%2BMiFFooIUqzvbYhto92R2AQIoIkmYnTaceknQpGReTcTnZYY93SXiXlCZSmeSN%2BOVoW5ZrEvZjl2UJSReRdBnpFplxmekWmm6pySOUMh5Wn3F0NmmnXjve5eFae%2FLJkZ9xARqXoGsR6pahayG6lqKWsvlcjNHNKCakiOWXnXqXhpWppmh9CVyYjxIm6lqkhmVqWKjSVWtYbtIFZ5Fy%2FpYZaZqT7ofnoluShWufuo7Ha43EzZUeYsN6VWxcx3qVbFzLBtpsoc8mGi1dlRqr6odcXtsRp2556haoYf0aVrBehbvVuG6Vu9W5bqX76bqjtnvqu3HFS%2B68mNZrr2%2FZErjtlGN6e%2BGK0zbpIoSEIbyWwvsyDKzDxELslsQFU2yrxRdnhO9a%2Bq7Fr1f%2BegXwVgJXRfBaBldlclgo66zyvyyL6%2FJaMBMts1e31nxzWDmHtfNWPW%2F1c1VBSzV0WEVLdbRXSWu9tM9ND%2Fx0WFGTPfVWVV98tVdZe7V1VV1X9bVUYT81tldlP3X2VmnrvbbXbQv9tldxEz53VXXbe%2FdW%2F3lvtbdUfUv191OBJzX4VoUndXhViWu%2BuN%2BNi%2F34VpGTPrlUlV97eVWZV7X5U50%2F9XlSoRc1elWlF3W6VKnrvrrnrQv%2BelWxEz%2F7U7XjertUuUu1e1K9J%2FV7UcELNbxUxQt1%2FFPJa7%2B8782L%2FrxU0ZM%2FfVLVa3r9U9k%2FtX1R3Rf1vVDh48n4nlI%2BnpwvKenT3%2Fq81z7hve8p8SPg%2FIpSPz7dLyn5S8r%2BhNI%2FofyPJwHEyQCTUkCcHLAoCdTgAv3XQPE9MCkRJOEEhVLBLl2wKBksygZ50kGefDAnIUvTyLQUH1bNx1W9%2BpiV9AOvIE5MTzSr2UVuKJQcCmWHOOkhTv5%2BSJMQ0mSERSkhTU4olBTqcIUebKEAX1iUGIZxhjypIZCoyBMr8gSLNNEiTbg4Ey%2FOBIxCEeNMyMgTM14RjT5UowjZKBQ3BhKOOJFjiOiIEzviBI8z0eNM%2BOgSP%2FZkiHkqmREnhERufes6V9KRE2MGRWtJESOUpIklaYJJl2jSJZxsiSdbAkieCNIlhMSJIe%2BIyC0q8ouM5IkjfQlJmlTuBXXgwwouooRAhMFa1dyCK2GZMRJtLE4dA82cQBYrUFKriFEqJcdgtcRZvahaZSkCPdYhD3m8AABh2Ic49HEJAuBTn%2Fz0Z67EOaRvMiuc7CTMLlPSS5z80iijfJM6wf6Z0Ayl8k60auZMqkaAYVjDAS%2FAhRIIIA5cOIAP%2FLABSU2KUhtgjKB%2FMqi6EHrK0aySWOZMFaNa5ShTKhGVTIzYTeXWyo6kAB%2BHsEERKvICfQQCAEXoxxZS4FSo9iMMGyFAM%2BKhjq569atgDatYxwpWd4yDGO4gq1rXulZ3EGMcaWWrXOfa1ShQg6t0zetY08oLvfpVrO64xjXi%2BtfC1gMMoMBrYQvLi3IQdrF5NStaIfvXegBCEPWgrF%2FdClfNRrYcvHisZ9kaD1CAIbOjnWtgB5tauvZVtK0VazymsU2M2AAf4hDHPYahARvwQw4A6AE%2F4OBb4P7gtwAIwQ%2BWu%2F%2FcIlgCFNCNrnSnS93qWre6mpDEdbfL3e6CQhLa9a54x%2BsDR4z3vNzNribQy97qgre98I0uKZgACFLEN76SWO992%2Fve%2FbKXFGAAg339i97%2BEni82T3weUmxhygMWMHeNTCE05vfCXvXEgXoiA30YY0QAGEfciguAIor4uMCVwmQSHGKDxHgFrv4xTCOsYxnDIYs0PjGOKaxjXPM4x6DwQdW8LGQdTzkIsM4Czs2spJ9wAQlOznJTh4ykqNsZB%2F4gMpFnjKWhQzlLeeYCVf2co%2B1LOYcd7nMM9ZChjnyAnxAAgAkvQRVnxrVMKRgH3ywKlY1EoCtuuPPgA60oAdN6EL%2BD%2FocaDW0ohfN6Lcy%2BtGQ%2FnM83GHXSUf60oZmR2gxzWlCC7bToAb0YUlRj1CHmhfsMDWox7EMVXfasph1NaeXAVdZX5odibY1pOth2lLrGtKf%2FjWkUS1sRsdDG7W9iAOs8dGjHsIB63AFAeSQUmizYtopfSmY1FPLltyyJblMyUJR0lCaPDQlwaTJMC9ZzD0e84%2FJxMkyHapRl9RtC%2FpMBzzuSe1h4OPaAKgDP%2FwdCoHarJsF5Xa78%2BixKil0qAPLqbx2esSerrOmOLoopSAuu6LGExKBuCectwAJOWjAIgQguck3hfCYKpymP7VpOftCMnQ2ikYXj3nGg%2Foyjkv%2Fz%2BOv5CZMOyXThcHc4TIvjcSfKMp0WpyiGK%2BTxqWVUaAHPTwtJ%2FrLuzX0lZFT6TQnol%2FSPZN103LhuHx3T%2BJNk3mbu94tkaSAsp6voqfs6OMEl88Ft3RWNv3mr4q6pKbexKrD8%2BpTpDvO7K40vDvr68o\
JeyhtzlOcQ13nUuc51PYuQatfPZYzmeVMup2Sb6ck3CgZN0nKPZNzo4TsLjH76NEObrXzku0zcXvr4Z4SuYMH9C4RvUtIjxLTowT1JFG9VfouNYqT8ukHrejO3Vnz%2FyRbisBvifBbQnySGH8qttcl54XHfKL%2BvfKBx%2FzgNQ%2B38b%2FR80HPfkq2n5Luj%2BT7%2FiNB%2FkiULxLWD4X36BZRyjJR0Sd40EJ4QmV4fuF73yF%2FKEF%2FUEF73tZwefdwM8d%2BkuN8EgV9MyV9mUd9YucjUfRKDkgSEEgS9icS%2BCcS%2BicS%2FBcR%2FtcSrkcSsNcSsjd8Enh84UduuOcSuvd%2F8EeCioc1jKc2jscukNce5ZeB51dxlleA6neAGAg77vdIQYh9Q4g3Rag4R9gwSeggS9hxTfh8T9iBBuguCNhzCmh9iJd4Xbd4W%2BcrFPh4eneB70R5Tph%2BSDd9WLKGInh9VpOFmLOFqtOFXleHYDeFPzeGG1iGRueB6weCk0cZwZAAbYh1b0iEcegZc4iEiBh5iig%2F%2Fxo4gBz4iGf4MGm4eX6oG5V4iR4hiLhDiMpjiEzzhS0ieec0dgKILgRohlGIhqEIQVXITHoSDIBoN7CIPbKoPrTINrYoMrioU4xIio54d5AohZKYi3%2FoiiU4Eic4EikYESsYES0YES8IETGYEjM4EjWoFL1oir%2BIisEIQ8NIb1cYiJmohZvoF%2BMIEeUIEef4EOmIEusoEu2IEjfIfTkIfrHSgy3xgzIIgCTBgL3RjSLxjSIRjhDRjw%2Fxjw8RkAsxkCRRkBFxkCSRkPW3kPm3g6vnkCkBkeookSNBkV6Sj4O4j%2BfRiV74iUoYjRM3jbxYitZ4ii2Tiu23inFBk5dhkf8RgZEqoZL3p5OHaIGJeIe66HTV2HjXCIzZKI0LOIJYaJOxiJMIIpW1yJNg6JNMh4dkqIcVaFHz2Eb1%2BHb3iIxiqYxkiSJm6YxoeYtxaYVAmTDvOJTxWJR%2FqUxzuXvFeIyWk4z4s4wK1IyM84xCpJZ%2Bx5aN6JZ0CFRd%2BZNfyZi245gYBJkqJJmsQ5mJEoaLiJnUqJmeyJl9aJXbeIlMCRFOCREa%2BRAcuRAeuRAgqRAiORIkCREmORIoGYE20pBGCTmJCYSH14a1%2BRC3%2BRZQqYJ7OZl9CY2HaY%2BBeTKDqZVE6TTLSYVISS%2BgaT2iiUOkeUamyTyoeSqqKYrdiTTfaYT%2FWymPnbmWbEib6VlF63lI7ck%2B74lTltl884k29cmF92mY%2BXmZ%2Bwmd%2FVlH%2F0lMAcpAAyou8dl5B4o4CVqICyqe29l2zRmRxWiJ%2FHmXj5mXR3Kdp5mdlRmiirmhqNOhs%2FihbjOe0DOiMVmXjYmio6mig8Ki7umiqVmg5seaQZmV9hmeNwqjPqijBCmTIqGUQRKhlTSh7FahLHShEWekTIikgimU4FmYINqgBrqArVgWBGADKoVyIfCmJUAWGvADKXAvVipLWHp2WppGXCo0GSpDo5ikrrmTsKlK5VkxxxgCuIAP%2BsAKFfED8oAP%2BMAPWwAAP5AO%2BkAPezZQ2zaoQeqj%2F3xKpPDppWIIpt4ppktKpk1qpkf6oBtxCfRQBGGAD5U6q3ygBnLwAh0lDj8QCvRQAtq2K0AaKkI6k2J1EB%2FUVX00EMqalk5KojKKPDTKjDbqODgKP1A6klIaEVXDAfLwZhoQAhUBCevwAsAKAM4GAErQD1MQrNoyrP1SrCLRDfRar%2FSKDpNGEP8TDvQaDj5YDP3ak8%2B6o9GKPtMamdXqOtcqjIc6M4B4W7gwDOvAB%2F40DPsQqaHgACWGXATQsR6rAcEAquaTp7OnHkwgrxABDkEgAifQsi1rAjRQBZ0QEt%2BjDlAgAiJgCKB6DXqAs0cgsvb2E0DrUN4QqG7BDkzBDv%2BeijUsOZNYMbRdVAyIAQ7DKRZgGVz4sA5TMAeUSgCHkFRy0A9ssLFzAABTwApom7a2wAu30LZu%2B7ZwG7dyO7dxGwuxQLd4m7d6ewt2u7d%2B67dsawSZwLZ%2Fi7e8YAsogACKu7iMqwe80LeF27a8sAMIYABiQLiFGwt6YAAGwAK8gLmRG7m8kAWSALqhe7p8e7eou7qQu7qnywt0QAem67p%2F27q0m7mqe7uFywuSkAWzq7t5a7vAu7ex8LvDK7e8UAkmuhFNdQkAAG2hgBHQ61t5BgT8oAZw5gDaq70gqw7l8L3gG77iO77kW77iKxgnYb7qu77riw62wBLsG7%2FyC77%2FJ%2Bu986u%2B6gAOLaC4FoCzOKsAiusBz2AT4etV5vtVQaC4eMAO49tVBezADsGzPmu%2FD0zB94u%2FQnvBGky%2Bt1C0G%2FzBDpEN6QvCG4y0gMDAJKzB7gu%2FKXy%2F6OANN9HCF6wOTyvDLlwMUmvD90sUOhy%2F6mCMHaEB0fa88AAJGhAI7aoB8nAJGkAPb7YF%2FaAEWXWnoUeyOLinD7G%2FCHAF5tCvhiABijsJ6iAbaSUNz4ANf3YQ6uAO2PAM4TAPCYwAfeAUf7bG6PAMz%2BBV7tANz9ANWuEMxWAO4eCv6LDGaRUUeGzHovOn71ewCHSwpZmwzrOw9NiwVHO1AHAI%2FHAIl8AP%2F0rQAOIgD2oQCvtQBAAQCvjAB9YgDifHqcK6tPEKtQihxV0wD12VVicQxmPcVYuQBB6wASLwBKVwGu5QC0kgAhswA4sQx30wD6sQBEEQB6kQBBvgAUkgDOFQBiewASqQBwRxDY0AzV2wxnkAzaUwCTlQzUcwzItMqqt5lYCXRHv4gbFZfbPJEQ5wCOkgDmNgES%2FACutgDZWaXJewDsPwAywny8FnxQqJxQtBy%2BowyN1ACGAsAb6gDn1VBYyruBLQByGhDqkgAotrAAgAxnJsD5uguBsgASStuC2QA5y7uHkQWJtrADOgDvFQBSSdA5W7uBsgDAqNDsH5FdtakrsYpv9KqqBMaq0DixIwGaU8%2BrwGZxEOMNXPGwB2GtTzx9Ap6dAKocXcrAIqINIl%2FQfuAFp%2FsLgtUAW5rLibEBQzwL9VUAUbsLh9gNKLawFQcAQA7NJVoMUtYA48q7g5gNNX4NNVIASLGwfPOtQRUbULUZwicZwoWJ3%2B2LT955JOna3CWdQPQaWYQcULDa88g7IQocUbrbgiMAlnbQttDQVv%2FAxxjQA54A6pYNKLMA%2FzsAkLoLh3ndKKawj24A48jQAm8Ax4jQAW8AzcoAeEbdj86wnz4A5xDAWNzciAaar0iapKrapMzapf6qqfJ9rax9XIyXVSocUncAQ74AEeYNIIkNv%2FlcC%2FtRAU8QDcy70ILl3IBDHbv63SeewOSaC4UMBVtQDGG8Dczk3b0I0AQWDfbkDg1%2B3O8qndCMrdHrrUCtvUJPHU2hrV6KnVD2jele3VCUHL9qAO0oANtTDbMFAO840AItANHy0MFlDSwqDfCHDTBEHdvp3cJxAOazzgCBAHBo7gCv7c8XDYCNAFThEPZSDh5Efh9vZVBVEuVl7IXhV3koWVsIydhYpRsqkbmNyjnSrPOSni6EDLTtFV89AHKo0NMe4B2FDjNy4BOa64PF7IzAzkNC7gimvk6nDgCJDgza3kTO7k%2BBrlCGDdU87hBuEO4bAKqVDpz5BW6HAs6vAM%2F5UO1OogDJ2Oop%2BeCp5QCV5OP1tOnTaS6vRsqGOelGUemmrujSQOjpa9kaadxYr7BcP9Z%2FPA6Bsg5329CbY8D2ld6N0wCQF86eqADR7w48B9An9O5IJO6Ia%2B4IW95Iqr6FAu5eKD3dy6CDPAAIvrAV1w6cfiDoaguGUQD9re5EltEPHQBdse79KK4QQxyISMEJteC7UgDLg5HGs86wpRDrbg77Ww79hIGWu8I6me5QkB8Y%2Ft2VZ7nvZjpYYMaBKfENO5EEZiyASPf1osBItgCIawCFxg0jkADrYw2y2wCcIwCWRd4M9Q1whQBd2ADfQO7Yor7UMe6Ede6EnO4O%2FO7f%2BM7ujfTuUzGeGpbdyp0FjouO4I0O5Fb%2B%2BFcQWcywVW%2F8gY%2Fukz0AIzkMcI0e03r3lRIel%2FUAsEXxe2INIMkAprjxCyohfCEAzB0CDdYPcAf8d2%2FwwL8Qx23w0f%2FpyIR0cqPgmIPwmUIAx47MfSWesZuS6fPgmLAPd8k%2BsP3fSMuwiaRgnwDd8iANTusPMyTtY8jwA%2BD%2BhFHvTXjuj1vujeLkDgHpJwrtJV4AazveO2AB%2B3DBrqzu7unuiKVRAQr8dlIAIecAa1MfAE0az3Hu%2BDDsB4TlBQzrlIrxAroQ6bENelEPcGYfA2b%2FmR2CSTIAHmLwbXEOmLYP45sOjmr%2FX%2BCSHg5p8H9g7ZER%2FrIV52hNDS%2FLsBFgAQKv64Q1fQoEFvtg4uZNjQ4cODwLI5dIfIAIIZEDU%2BjGJM3UaQBlUgIFmypAdC6srdUrdopMkcqT4WvFLSwIkjCAzksbeJpIhu6twdMWDATTx1tUhKeMZNz8UZ6uJVKdolHrp4ZYo6IRgSojswmrp61ajumQiSOYLFu9qFpAE97NAJ7VbKkzR1M90ZIlmGbU0EXdxJe9bNYLdnhQ8%2Fk4buWTBaCgsSrLUJm7twicORBRkPEKCrG5NKQGBB2MyD7txYsMBlbF7YBSV280Ay1diCsRfmNci7oe6C5Wy12LBhFWrYqHcD9%2Br%2BThMY3JzJuoNSEsQv1O4WkYSB1S2CKqEXugtC0o54jbfKSWd%2FUF0zBwDkz6df3%2F59%2FAASNFNONt4fkwJEwI7%2BEJKsPQQloggRklpAkCOPHmSok0kqtLDCTZ4haCV03OnGEDJCXCSc19SZJMQ4nhGmwtOewTC3VCr05aNuLDTHGVoq9GQuWSqs5aOkKjxOwsnCik5CdwBEQAJZQlMHGxVyIKOScj5y4wSSPEjCF4L26usvksgQRgQPZgjKHS466EAwdaRpwQMRnnGjAw%2FKIEgdT3IgTQQyzlCTkCMf9Aw0kEYr7bSGpAkmmGdy8zCVUmQh0R2JlEELgU3CMWeycIL%2BKQUv1MLpphsS0alFUtzykqaUYEpFRzhhFt1sLnWEKaWURlP1sJRaSCzwq%2BcCJXI3YSwwCZGxtCMpo3i%2BC485d5JgrQ%2F0aC2Ql%2FVy821Yh96LLz9ww7Vvv187I2QpKK64IgjSlsxlprzckTeh3ngTCkjf7u1N3gLj3XYyYryZi1%2BD3KFkhhmuUE4od8oFqSOH2ZN3YoobDu4WR9mKx%2BLxNI7XYoZfI3gyedEpxpmRGUZuZCLBEovbgqZalqFnpMIWneoCPOFHLxHwKx7AulCnBZI8weylFkjcDoEW1OGCJC423qTdktqlFmasPqu221pIM61Ad%2BwwwQQyGu6GCxX%2BFFiyhS6eWaYREdRGAM5NGv6jBWNFSGJI7UQQwQ5CZpBAghYM6codYaBAy4IW8phLuBlM2FmoTXTYgKQNZjAE3me4WFwFN8KJeLxgsXYoHjsCDCK7pZn97gp7upEFm22fqaUWbPY1VZaglLNF07xs99V09%2BAT93hxyW0vnnMR2KCbedhqHoE%2FrvKwFkMMqeUYYgyyvRZ0hFmkV2FqmRGdUrSnVXxKNEztmVIISaUb8cLxpRJaPPTEkBln6uZ2YRQsHKsghCc0NDqHQIx4GuHQAjVyMgd%2BxUhYc4cTSCKY3RTkFuzgy5LKYIjyIOAIUungz4JmjzKQxA32KAUDllL%2Fi3kA5gz2%2BI5V0BFCD%2FThDzkoydVgNqit%2FaZrhypQVooChaskQUAGOEIxGnERmywChQKygEx6hhYoImABk2hYMIgWIMEI53IISEU8PGEsARnOLDMQ0BNEFxLnQCeCuQkHG0VIGgn8aDKt8w5JqhCHtIkACrW40xVa0AJAzSUccZiBBRRggiPcZi7CYIEKoCCMJIiAASooQ1Ac6C3khRI%2FymMP8zBXs7nQhiR5QIohVNAuCXhADJNJggQs0IXaLMAQOojlJEIogScIowtoFMHmDOKG2jSIEDCSwAKS0IdLSaAKotPO4HIwmU7kQG4b6MIbOaPAOTKkgeFkCATJOZ4J%2FsIsHC%2Fxi0PUkxOf5cMe5sBSHudRQjAFxh6eIIkOwmaSzRGNAamg4QXnMUQESHEe0jABSXzILSAWaohfY0hWSAKFeZSiQZ6ohR3kVolVDKFdOjiCLFLRLij8AZ46wEoHEaACO7hhjM8KYQv6UIZ2TaIdtkhmKuaRszLUohQhXJ07AHOCPKyGJAOBY%2Bnm6A6fLEkWX2xnh%2FjYLJIYK4si4Fl5DHCeJ%2B1AQBLoQ8NqobYNeCCLBqiCsIgESlHGdT6klI4pnQe9eMxjakvtiYCWKi94mqQUbFSABLLovADlUSgpFJAdGpaKrArIDfLiozvOKKAkmAOBCwHnOS%2Fm2YWY%2FxO0HUont9QRwraOp2G8wAaWEACFMsT2JZOwBz6BZtBuLO4ZSpRbFYbougvaY2kn8ORQHBpEBEVUNBNF1EIs%2Blp7TIIkAglGSyaRClt4wxyXWkX0qnBRe9hjaLa5Z5aCMQ97AKYK8zip84SRj3ykDjw77Wk8dHBRSiDmD6wyy%2BUkkAr4ShcBq2uqHJ%2BaMyHMgwwkIe5HlIWRPi4rDl1o1wiNOyCkKHFJSSiDay2winggFAFXsIMdN4BK4sFVrnGlK2fsKoEyxGHCY1RALeLhhIsEYROb4CECkgDYkhwBCkdAhx0lEIdOaBgBIliEIZLZh4OikQydwOmh4gHZBi1iEv4vyYFQ%2BFhkkhxhE4QY4yLcmsAIjXacoxUtaF125rp%2BFyMLM8QipMHaSxWlKG8hRG2%2FdNvAbEzOeRhJEHg4AzeQ5AxsqaE9GISAG8wkHolGwEOHpdyyMLeIjMWoL6hGuC4YjRjZyC1JSkGQHg8hpiVepZ8R0GWsMDYH7hCwCGQcB8C0ABw8JS8ZsriBIOThGRvjp%2FPcIGMyoBXFGokjnCVklmRKEaFmturMsLrkZ8xjHvK1wFrgaYeDyo2V8XjGF50Q4naRIR72aG%2BNNysdFa84lC32z%2FT8SoaPrMgOz7CHOxh7BCC%2FOi%2BGsWMS0EuJkig0hDyJA0mCEF57yPkP7P5dik%2Ft0TwaeHlZliWJCcIR3g5CwdmcTTNo1wzaNnv2zRTMQ1aD0RWz7EkP4LhUErrAhS6EqAuLKK%2FP8mkVWi%2BLNHZIoQWwtACZXLsLws0S7ToET0sTCdMQMRRFnctppOQBjSYJQnZLjYBTf10ne9YJ7DoI6werQB1KGvueDbABbPCajO54RghN0gEoF7vtUGTKZps9x%2F9gThjmqCNJhODgqzrrKv0t2jy%2BbQ8lqeCN8ehDg9Dh6SWdmvGKXWC85X08envFrgLygBt481g7DOEEcgP4hY8yFzBTb2MClkB1T%2BtQewiBwVDgvR27QPG5nensGsdIzzzAeyiEUPLfLP%2B5Z9XBC4%2B5R2NIMV3Kz7lymKkD8yKkXxJLogd19NgO8nRHHhaBKtsGDSliJ6PeEdBgpR%2B0XRM%2F6BijLqGpP6TqzT3Ic0WuDnuQkxwYI50QA3L4ulNbp2WpAt5TlyowhJ5DOwFrmg7aAOSrgiuoAjLYtZ6SClqDgrQpiRPTqNKAAgbEwCroAk%2FaiL%2Bbox6TgBM4ARVAI8V6MOAascVDQMczD3toOB87nKWRAGEQBq%2Bpmc3ToxQzns%2BbN%2F5YnuY5sj%2Fogz4wIJgTBh7aMzRqvW8TDzsys6BjGtG5vUqbh%2Ft6Cz3TiRy4sizBi57pMhvsmb3TiROYFa%2ForOubhCZwQC7%2FmoxJwMAMnIR3CwnrIyfsgxnVKIkZIIM4KMMBs4V2oDQLWIRn8EF7Sr8Lsh45e7%2FMIMDUUrqrKEMYswPXqjTkWh6tkagijJ7pcwf%2FC7FFsAOee4ZNCKEdOEDuih54IoN8iB5DmARfIJHh65AJNBEGA0B7qIVF%2BBTh6MBJQIROMhWtKxrMM43wEh8D2hSQaMHOKwWq8Su%2FsMEIu4IcvBRP2MEB6UGHk7Th6hSvOY0jDESy8LwlBJfQCwm7eh5V5JiCCKEcyANZoDQtNA8uJAkvnMAwDCEoC6EjyAM7sIM86APzcwcs8wA2HL437KATaEiHhEhDkA47JCcjeguuoCUo%2FzKAOChF9hjEcCpE01IHwBAQFRAGbCm3qimJsomHDlI3mQm0aiOJH1MHsSKJPYyHp0GAqFGHVNg6knAhUsSa%2FOMaPLqCEJlKMoBATqOhixCB%2BemGnGkCW1QhRBCG5tmARfiQpfAEV5NAy5OGZOIC2%2FmiJzgHuUuFcBCBouACbKgLY1GA2yjDIxCGZxCCi8gBOmQ2p1ogNFkKD1jMxUSjE5CGeEi8BukGVtyrPIqHx6M9GJKXnAkCd9C0d%2Bw8JZzH5GnCUhrLZeuNZ9hLXwivfwu48zCILpQXg8wLhLQHSksCiJMxSZTINRQKi2wdqFrD8JoENzAEWfDI5gNJSvuJ3v95hmQSSKxRyacqrexDhzi4lKXYEndQD3cIhh7LKnzrEERgjclyh2GyADuZJBGYFnmJA9ZogeIiA9b4AoLYJ8uxgL8pw%2FsTlFNcrm40CSaaoteaB2FIJgnYABqsBG9whyGwiUlAhy9yHrUxgCRoqWVxMAGTvCQpCQuApVJgh7mcBx90ng1olyQQCkqApa3bw2w8TNOBtjDpBmmQhm0oBj0oiT6TzIsqHzu6pgs7D2y4lBmYhFJYMJKAQNB8Bv9CwhgdTdKkR9OsK9Tsl9VUoWdYhEsJSAyTTYKkzQY5SIeaB1lol6BqHgMgBOCjSOBMC%2BKLinCAgTArBUowgSOCR3T%2F%2BMhwmrQAMZrhNInYdBSK%2BQ2KWRh3uIZrGNTrs04KwoYL%2BZGPUA%2FYKwUL4T%2FEUAx0uFTD8J7E2NRLdbqCQIzIaBPkTAVG6YbcWyWUrKv%2FzLQTHRxYhVUowM3BaSt3KIXw%2FIlFWIZsqKaSmLhaeNCqqQLa2YvB0QENHZwZ2Iwkic6X4iLhOIHBkSRkCpAhQKW%2BMQkPYKoCGzmJcanbgI1rKIYfBcdry6p22SJ5EdbzgMMAgYK8WNK9dFKskccoHZcpdbE%2FuIi%2BcwhGJMAlox%2FdM0nx%2BKKCnC4x3YmN6YLD8skOwbINqMgMfbDuoLUARQATSM2HWc49bU6B5FNADQ3E%2F7GDJLA5T9iWvEiFMyjZMlgFkEmFP8ADSpiEJ6gCQFzUl%2FmkQjUISRVUfdQWeGEO4EgO91CHbCAGuhujJzAMT7gUSvBWe2xVjQiHWFkUq7XamlEURpkM9MmeXtQQBUHK7JmERsmLTvBamfCfRQmgUF3bgsnSsb2MV7GFqp0Vumuy7EkF2JsMF8me3pwOGK1X3RuwhXCGa0idwooRa0NSMpjQDTCcp1NVq5rQ0uimeCWNDXBH6FwSes0%2BKL3X%2B6jHbFwEyYEBjc0NX7A7gcgBGSyFqRgbbkUHIRgbLoKqsQmCMISCsVGjRWqorFLBeI1BM%2FGysUlRWhsbIhPGFpAbCf%2FQAZdVTjzFP0qTVhGyzSVxrUCVqQB5AlRSh27IxKUog7kISQ8gDQOANUJk1HPq2dHKBmCYCyUTgRBcMrxwSqkti%2BTIX3z5l5CxGAUZGJbZ2XrhX%2F4V4JUQWgF2jwTu1gi6nVpITWdwhv%2B5HWmY4GCYi%2B8RFUP4gz8QhrEonwfWixrhYEPw4JkIh0q4nVkJBwcuzHr9XNCtD9EFCVEZFapDh1VIhflxh2ywBVJBhxouzBrGxkz94YII4twgNx02VX3sBltgBoMwh1GZFSk24g4JhyUGn%2BjNU44FPEobAqI5MWyojRYIoXaVryWJTtzNiyuAIgsgQMEAWZtgJZyFWpj%2FYV%2FQct%2B5wAa7g6IW2IQthoinJKf%2FVTOMGa0OCdx6ZQ50iGBr2V%2BgjZeNWRgEZoufRQdeIOBALhQYjuG5yld4%2B5duiQ1vIAbk6BdKpuTlYGR1GLWifeWiZWSy0FMvvqic2QQBqwILGhADRaMkqIVuYCwEyIN50LsuAMyc%2Ba95aM4g8AQ7qK46RmR0wGPP0mNF8oQ4cANtngTKJJ5BDqdCNrlDHi1tBC1HlmZqJid79WT9AOVzohdpDmfQouUIAtkqUJJsJglC2GU7gLyfuAypeIJ%2BUjA35Q07KgPcFLxJVjn1Jad0JidrHphV3GRBvt9zkudzOrnrU2RyOmdEfug5%2F1pnT57hCIJnRMboc6JnBwJZKJCFBUAAHeChPNKwfpYvgIuZDpqBCvqSmMnNhH4pb2LonB0tkJ6jiAatb54jlA4njSZEjg4njybqbAEtkY5hknYgkx6tpQ4nlV4gkHUCdMASBVAbFUAHmrYHmwbCjQOq0ABZ3ZzeFRRqO%2BaWoo6go%2FaspI6grY6gpl7Jp56jqAatuhbNb2FnGXZncspq0NrrCOpqb%2FZpJUMAJzDHfm45CPuIZV6WnTwCkRXWWaW0jEBklvSswV6guz6nvHYgxl6gvn6qv46gwCbtqXa%2BTmbnq14gxfas1V4gxzYdt7YHy%2Barb5uHVRA3oViFZEJoJf%2BJRNpsF0P4aSQS7YYOp9ImntMGSYsm5IlA5NaOoHL2rNhe39k%2Bp6oG3dsmnty%2B6O1G5N52ytzMqJIYKMyUzsHFiCAYoxPI2i9iAB3gpbQIB5ae65aZ7jmqbtO57j3NbnBeb3GW5u8%2Bp%2FB26PFW59oeacQOp%2FTWbmnmYoquK61gonj4ujmMhyAoipP0XrsTwbrpkFWg3GX5ESOyUAFHEgKPIAPHGgQHPAVXagb3rO52oAfvaGfY8Bs3rQq36gufowxf8A1vb0NsBCSAgj7ICzvgvTzIizzgvT1Uh3D4gyBQARVIxFx4DWywgxwAc0QrrkWoAiTAgxl%2FkNEWb2nO8Xr%2F3nG97vGMHmc3e20HinDqnvBwKu97PW%2FTWXIeb%2FIuDmno0wtLngy2WBkuZ9b%2BEAog3gzqcxREdfAad6Ai5xY6X2k7V208J6cfR0w%2BXyA%2FL3BAD%2BkjN%2B8kL%2BkD0epRJycnh5lSXyDq9O5NX6BOH5ZP9%2BpQX6DdNp1bN50gh%2BohR%2BdVjyCRdoAfePZnTwH5eIEt%2BAH6oHZrH6VXx%2BpYX%2BxZ5%2BpE52s9R7lkJ%2BddJ55eJ5Jf9%2BZgJ55hx5pip6BTJ55Ut%2FFl%2F6QK%2FwF%2F4Ad%2BwId%2BOAQAUIJ7uAd9CAT5mIKBL3ht73D2MPQ7R3SG54x4n85yd7NzN510l5B19%2B12N513%2F7f1cd9oAxuteuf0eyfs%2FNAAJVCCIggFerABArAGawiBQ9CHF4j5mYcEfHiB0N123O523f72Oap1bpl4mMl1IL94rMn4B9l4%2ByWUkxZ6BzL6YTl2wK54wT75JCzs%2FAgBeJADAEgBfAD4IuiHLQgBfDB4JTD7%2ByCAZnjzB%2FGG941ngZHmjoD79qD6YSl54gELUMD79mB6BHH6H%2Bp4rPn4og95QgSFkTdnrCdtB291ALgEcYiPHuCHOQCAy1cDG%2BAHsP8BzweAF5gC0if9LaCFCE591V991m9913f9YoiF15992q99Z4iFk7F93d99JniFbNh94Kd92Q9%2B4m99W7CF4v9P%2FtTPhiyQhN9X%2FuQffugv%2FmLghekv%2FmygAzp4%2FusHfl7I%2Fe4HfukPf9vPBknIAu4n%2F9o%2FfvXf%2FfFv%2F9fPBlpIgHARezWQD9AH%2B86Xg%2F0HgPwHCAA%2F%2BBAkGKgYsmIKFzJs6PAhRIfAYkWsaPFisVi2MHLsWMxIJo8iK1IcabIhr1snVxZblkXSMpYnYwGTadJWSZsel9GhE1OnR41APU4c2nGZpCw%2FjV7kxYspx5xQIyKjlQAA1qxaAajBlwJrDH58BPIL80IsgCL8xmzN2swdurhy59Kta%2FduXW%2FA8PLt6xcdMG9%2FBxNGF8UY3MKK795a7LiuM2ePJ6NzBwZUYsr%2Bi2%2BV0%2Bw4217PiuMBAhRPtOLAqAuXa7x6sDtQYDK%2F7hu59mDXuPm6a%2Bag7VZW1ghg1QAvFIAw%2FX44kIdcORDgCZqp293Xmy3rfYFl0873cHXvdVuLv1tMcnm6ljXRTo%2BOs%2Fu5oOPLJW2aflzu%2BNGRx%2B9O02z73bYffPSp4xtwWTmwDnJZHbLPJesM89sh%2BlwCz4TSUbcfdvsB1t1%2B4OHXH37n7bdee%2BkVSN98%2BNl3Gn76jahbfP8FiN%2BA%2BK3o3oG%2FJQiAA5BsoZUDfAxzyVdAGolkgtOFR1%2BH%2B8mIn4j0kUifif6BwR6BneHXIn0vSgmilTS6Z2OK5eVI347p9fj%2BI5xxavhkfFHGSCZ9VcZ3ZXxZ0odil%2FuBGZ%2BYd%2B7HZ3poCoiejl7G96ackcbpJIfZjemhnu4hmp6fNW6Zpnhtpjeoe4XSN%2BWeZiYKIKjerRmfqOJBKimtbVGKn52n4hlfpultWl6nZ34a6JehhVkajLoeqmp5iuLIKJuO8ohgrdVmdSuUlhoaojF0%2BsossNAKy2WjghpLKLKXzngiq4t6GKt3s1pbK7Z1aqsst96W96t4wSY6bLnF7mdqfKhqCq53ztL3qnvwaifvvJLW616uBe%2FqXq%2F7Iuydv80CHK25A6e7bZns3riwuA1L6ya1EdM6cXoVu2cwxt2uu1%2FH4gH%2FGjCL55Y6Mr4l%2B9fus%2B%2BuXB7ELk%2B6Ia73WoypzUKXmLLH5IIssItAP33zn0SjbDR%2BSSv9I8zlyZwezellLB6%2FHFOt88ewHl0eqekRPPPFGpvcqnYMqzh3vC2PvbS%2BZjuNN9SFe9e2djknHLfKIWd9H8mp7u0usY8KPjjZTGfrYdrlrb34xo2%2F%2FbjVckt%2BLOVBWz70yfH5XZ7D1onN%2BVZli3d2eaGLN7p2jFvnuHY7X92zyK1vLXWNXst%2Bune173Y77td6bi%2FoeYse9etTnwj536ujqzziXDcfu3uzhwr4w5tXn%2Fv1FB%2BOtva%2Fc3%2Bwh8RbZ7zqWLOe7PK6dz6%2BWUd9%2FtFjn%2B3c9z7rKc47vBOP77wDPOsIbzf62w3%2FIue%2F8QGwfMw7k%2FPSBz3tSA831Huf7hw4v97VT4L3%2B1b%2BRohB8NEOgdapW3nuRr9lXa5omZuWjxZoq%2FjFbIUQbKF2JribCuLmgrjJYPg2%2BDPy7dB8IERfegxIQhuaUIFCTKF2HuidCCbxhXrDmQyfSMP1iW%2BKHaziB1eFRTWlETclrM0JqwdG64hRO2S0jhJxw8TaOLE2UKxhG%2B2mNQ8K8IoE3I0WrXPH1%2BQRd3vcTR%2Bt88fdBLI2g3xNIV9zSDZKUZFUZCEPYfdI3ERyN5NcTSU5d0ncZHI3m8RNJ1%2FzydWEcjWj%2FjxgInO4SDg2Uo6rrE0r7chFPHpxgbOsTS1xc8va5HI1u0RNL1Hzyy0GUzw6RKUVjYk5ngFRiHOqVPYSF05O1VGUawRmKYV5yiOmsmtzFE8ya%2FNK1MRycM98TTRrM83XVBM11xRNNkWzTUkuszY49OYwwRnHZoUwi%2B18zT5F08%2Bx%2FXM1AX3NQFdTUNEc1DMJ9cxCXdnQ1zzUO9%2Bk5zp1VlE6gs1AzUQhEQ2XznzFtF8X1eY7uRlPiM5zjEhcYukwOFN8%2FhQ1GfXMRpXWUdR8dDUhRc1IPVNSzZxUMylVZjddGlGYTlSm93RVU0XzVM1E1WVTFU1VUXNV0WRVM1ul%2F0xXKfNVfa50NS3VzkuNWs8BjvN45TQn%2FBoYRiMKlqdl9en3UqdB5E3ujRItJkXP2re0ematlGlrxN7qmbiKZq6eqStl7jqZvE5mrxjtK2r%2Bap3A%2BvGogkzqE5eK1ppqLoiIxYpoNUNaz5hWM6idjGofw9rHuHY1nqWMbHdDW03a1pO4NaRuN8vbw%2F4WuDndHWNrq87Hui2yx3xtWAE71saSd3%2FZLSBnNfPcx4B2XsGlzHA1U1zKHPcxyXXMch3TXKfCVjTRxc10bVldXV5XlO%2BFZHwpM1%2FH1Nda951Mfimz38n01zH%2FXUyAFzNgtRbYMweuTYKluWBrNtiXD2ZlhP4nM%2BHFVLhaF35Mhiez4cd0eDEfVkyIFTPizpZYMyd%2BTYoFumKDtlibL0ZmjB8zY8VQLwWXuPKVh5QCSFw5FD8AUiCOlKQhKpaP4aXueDEbLvP%2B0D1HXk2SQbpkkjZZoU9%2BTT7Ra1PfbsUG4vjzOv4xlin0Ix3iWIcSAFChCGWIzOhUF5XMyLY6IzTKIg4qQ9M72%2FWKt6fFu%2FNq8uzcIk%2FmhAQggANYkSE%2ByCMExAGABpyTnH4UATgE%2BK4KdxrpMt82hmwmp5t9ZkrLklXNCQM1akRN4LDdFCtT0MeXARAK57Ai0TZAi1rSACQNcJvbJWjGPNwh7nGTu9zmPje6zf7tDV6ku93ufrc7iOENeNO73u5gAjXiYe99o1sdvFAHvwNe7mVEQ%2BAGd0c9wCAKfR884LwoR8MDzg1iRJzf9ShNPSq%2Bb2JwQ%2BP2Lge7yw1wj587HqIAQ8ZJDu9rXMPjI3%2B3v1%2B%2Bb5nbex7NJoA1GoTzdEBiGPoowrXlQBahT4EVRj%2B6OVrxiVGM4hNOf%2FonVHGKpbei6U5XRSumDnWot0IVXof6Kbw%2BC1pInelWP8UpRuF1prci62k3%2Byfargq1Nx3rbm97062uClrM4utPP4Xcrb71q6tdFVdvO%2BLRXnWnmz3sWtjE1AUP9a%2BPAu1PH0XXB%2F90rPud8VI%2FBS3ezv50xqfd61NPvNnr3vXCO73tis%2F60q9OC7Ib%2FvKAX7zmo856qiP%2B7mlfutlb0QZGKF3ym5%2F7JyzP%2BMznnvOdVzvaQz%2F30S%2B99Gu3u%2BibDvi5h731d8%2B83sfe%2Berjnfpb97rfMd97xf8%2B9a0YxCCKr%2Fm1Jx%2F5S8e68Tff9eejfe99F331Md31uV7qJR%2FedV%2FUud3tUV%2Fl0R7UVR4BNh%2F6ed76bV%2FeBd8gaIH8DR7dUZ3VqR3uceD%2B1V71hR0lUELZUd%2FbDaDbwZ36CeDhfR%2FcJZ%2F0bd3t%2FZ7mFR7ygWDvQeAHsl2zqUWiYUUIaAAAlAA9XELQDR1waAArdNeP2AAkQP5hghxCtFHhVoSCEWIhkTwhF2qFGoTBF2qFFY5hVmihGQrEIaRhcohhGpahGYZAg5ihDYxFGm7BkKQhK%2FAZFrLCFv7IIcDDFhJAChjhgoRCCuBDIACAEvRDHm5FqrGhFLIhJFzhGKKhGUZiGoYhG8KhGWLiGP7AGqZhGLihGXriF8ohG4oiG4aBGrDhHurhH9raMOBCVoSAPLBCCEwBP8gBzlnDlnlFE3ohHU5hGlYiG4LiF2qiGXLiG1riF4ZCCKQhK5KiKY4hKnKhKlLjKJphKaYhAcSiGfohnDSHMWJFV8gDPsSiEtADPuiDHbaFE0riOY4hMqahMnIhM46hM%2F%2BeIjRyoTRyYyte4xdmIxZuoxlWozcSJBaGIx9SITn%2BCAHYwJhhxQtsQRG8GgCkwBb8Y1bMYxpO4jF6JBXmIxbu4xf2IzaSJBQGZEJ24xh%2B4zOmIUKGIkx%2BoUyOoUPKIhZqACxI4iVQIkt2V0SOoQbY4ia%2B4kjC4jSaYRHUY0oqpRne4xiGADGGIlRyoRpI5RcSAC48JBTCwix2lw2woQOUZRq%2BwFhyoQ1o5BiiZRw2JR2uJRa2ZRo6wAuwYQjI5Ri%2BAFh210Tq5RSs4lD%2BFly%2BpVv%2BlgbYAF8C5l7u5atpwA80JucwZlZM5GFiZmIOTgj0wKsRwF5qgKsR4Q98wPv%2FnKUNBNFEroBWTGRevk8K%2FEAJKMhjjiYAhMAP0KW1pEAPzGIJ5KZW%2FKZuRsxZviYRhqaPFKcQEcBkZkUKpKZW8OZfusxz3uJjJidFnmZtOid0cud0SooDbCeQPOYfvkB34o5mfmQPzKZ6ViTn4KZcimZoZoV5bmbEgGZt%2Bshi8qVkUma1NEBthsBv4GcRRmZzCtEPpIM%2ByANDmpMS3AM%2BvGOiFcE6LOgjco4S9CJWOEAovGMo%2FAaHeuh31ooD4MI6%2BMgWRGiEftkUyIM%2BIBruvIA1RKg15KUT6gM%2BXMJv3GiONgDnEEAgRCg9CB1XqOg95OUWuOg6RIfLAGmEikOt%2FyUHPeiDOERbGExpleLOD4hDhB4CcWgAl%2BIDPyxiCPgcPnjp%2B8iBP7ihHNwDlaKlHLyjONTA%2B4TAOgzHRq5DhGpoClgDjsbj4ByCiqbDb%2FDBOwIjVhiqPiCq0kCCiorDbzjqk%2F5GkOrDMLiny4QALkQoOfqZPtCDUnoqqFaPGqijPAymtEWopZ6ao%2BoDLpjm4BTBPkSoOo7FD1SoPOThrVqo0mQoreLDHDCiO0poWuDqhf7oMFQpK7QaFRoqH6iBHKTAL%2F6AiQ4niY4BPWhocpTFFvDDK4ZBWYArVyrNC%2BACP0AqVhyCPMgBtApoOgzDDyTriEbKpirBFOADcsgBP%2F9sgRo4IgDoK7%2F6a6z%2BAyTYQCjoQ15GiBywgRxwWy5u6TDYp6T8QD%2FwgZ8Nw206B8RmrJeJQ8RyDi6kQw8EQj8k2g%2FoAyRAa60JqhLwAT9EaWVmqxi%2BQI7e6hPS7CXY7PtcQj%2FgqRLowyGoQR182SXQQxEcAj8cZpMOgzVAqxpMJD8cQhEkIQBcm9RSbZNawzBA6xicmtZyLXOOaRHgQ1ZGzCXggxKk6JCY6A%2Bc7VewrdtyTg%2FsQ8EOQ8Q6gDjgArSKYYbOwbMt4uCkgByw66ZmZLL%2BwLJqAAEc7rL6p6QILuHiw5fVAT48a7ROa7XCpiICAKENYXeFAjA2ZViMxRb%2F0BrnbIGF4AORhsKJEoA4PCHrOgABpMNVugze2i26AgAuXGpT%2FgA%2FaBsbJO3gEEAY5KHW6q44AIk8BCUuiAOqLS%2FnvAAfTGPp1towsEIJbGEjDmYgIKzLSCZxMC3n9sNgCmoIbK%2BiCePgvEBeToE%2FJFoY4EMRJAnOYWwiAu7gNECy4oMYKketXYI8OEDpRgcAw%2BrgJKk44Gmc%2FkCSLMgThgWRjk2sHUIKQABW6GtZssI6EAAGA4AGz2uC4GIgpICPiDAJJ%2Bo%2B5KUr5K7SxFpQimZ43sMUFoEjaoAMp4XAjk2QknARbqTqnnD6TiPTSuy8aMA6jEUK6MMidm4JKPH4%2F3pupq7D6oauRe4D6Zpu9fguG6SFt0Kh6%2BKDOkICAdAw3%2FZDg1qLDdjAC%2BiD0C0unlqDNTjAELsxEdMKASiBA0TIb2CAnqqjlxLaYG6BP6Aq7qgFH9QvADRA3jrA8eItUqInLghirIFx5c5arfUrzEZMCgyDPNRa8H4ZBqcBP4DyKFcPHyQhcUACP6jjpRoHcsTaHI4NH4jDvYqhy8YAAHRvCvDBPpRlIKQw56SAPKgB6BJHKKwyPrxqCNxwIpattfiuPNwDgwKAo36Fo4aAoFozPrDnvAABMsPDkHizOoIzNd%2FDNBat49YKze7uEQNADVhx1fbiC8DztQGqy0wb6%2F%2FiQvsiM4yGgiB68DpYa7VAAqECgDe%2FolqEwbUhdBePzSWgK85RshgnNCPmMOfQ8Cv6bgQjVpAEgg2QLEaacUWf8bzMcxvDcfjG8RADANOCcKTELqxdgsUeQskCMgAIMiEPzg%2FIgzVogCLbousOQwTkbSJrbR3XCgFcQlncZijIgRSOMrjWWhpgscsYbDvr65cFbw%2BoQSmzwXKYst3mpRzk7L1eAizD2nFwzg8YbQrsw5AEAj%2FkJS9Lr%2FfCtdLOSzjCrjUkasFuwT4cQgmQ7UbSgzNXi8FugQ1sagg46mwKaglAwj1oM6bSCuIiNid3ZihYdqsB8DRe8%2BDYAD6swxT%2FAOzoxjMfnMVY2AA8D84xQ4ISJPAYh8IU%2FIA1BLQGG%2BG0CTStJCKRqkVG%2Fy7FMvQWK80K4INSdnQdOiIZczFJz4tG43BzL5AGEDbFlvGxkus%2BEOkcGzUuDEf9HnWtwHR0KiL6li4UK81Oi8NXIDLeukIDNDJR%2FyjPbjRWBF31AsAnc44c9IMNgGt06OsLKAcRAEAdCG%2F1nLVWNG8KMEjGBuXYeCU8yIGgssIPdHD3loCF44NxukyGXoIc1PbTagXTCvMUJuJNHvD77nA5a0A2UzM9pHOtmLdWhIE%2FHC0%2BnLM86LacrHFQzu4lrPEiXhsbJPEi9oC2OrT3Bu%2BG77cN%2F1yIEbrCieIOG6iv78IBFyM2P2zxcisN5XLzR1L371b0dStNYE%2Bh%2F0JhCARCrZl4YC8iVxemOmc3VgCwBjhAWtO5nccya0d5CpThtdXBWQgdH3jv%2Bt7pmGkwAdjwFCK6Bgg25yCtVL7AIeQlEJhxdaevl1dLEVzCbIbBPxQBDQ8JJNCDBoS6i8M4eAYtkKwDLnCwUra0%2BKL28JooPMiDO8JB50rbibpvorGujsfJFsDDOtQ6PlhDCdSBGAa1IwtEP4xrxBytEY7BcoDrlzUvAfRrtbOwtShBIBghthdBt%2BM3f3N1Wa60BLP6qps19HZucwSlTQ%2BOy4LyPqQAtxcqP%2F%2BswKB%2FhTU88uC4wsf68Boqx2SeqSWPze7eopoDfJtzBT%2F0wAKFAj3UQQK7dMQYxzqoASvgg8O7wrpOfPXEQD8QaYer8mCOPD%2Fk9J7%2FRgrcgzikAS7QwwssrhSzOnjLSTj2gziEgiusYbdy2cveND%2F4fCZzOD%2BsIyvggg2swKKOgTXAg4D%2BmRzImsv4Li7IwTqIQ50ncB3cwwtrPdf%2FKC7Ao1KL4THzAdIKnb4GQsZvuO3WuVr4op0Og6FOYQhgyNz%2FaLc1r%2BLiQnarshjCNR%2FggjxM9rb%2FAyuowZ02QArQAy647CIufuOPqdJMwT%2BEAuJHLOVbvoQQwDoDPu7A9SH%2BkDwAnC0f1LYRkr7pRy89WIPVt7qnX0KpPqEN6EMoQDru2LmDA0AAsMKQejzvy4HHf688nKMRX3zGfxnHA38cL1AIPDTS1yUr5O0QpkAovC7bj00K4MIjMr01sMEAYEUawDEb1DytBMKHYsUPrDAuROkLVD8ico4T4oL8D8MUcjAcu6H9W0N004oa4IIrAAQuXMN%2BACiCSxyrHgAA2GAl7lIIhhMpVrQ4ccowcaFeMLThCqLEhiAjXjR5kmEISOKsqSEAQMMhlnJeNggkbtgUlDtNpsClhOEPhJA0MAQytChPpRMDXUq5suUAAA5kDgO6lOcWjZdSMFSi8ZADr2CtxWK9GGZrVwBoIZYYKy5QWbMmHQSyZm0MQw0rcRWEydfvXJMHIXYloMaaOEgitYrj81LwRQ2swlAMcUmcKxspMWuOTJEDri0UHYr7ybBEqIQdP%2B%2FUALn13NcVZ8dW6iDpRNy2lQbgAFsvb6Ua5OotLvwigdwMlSNvTvH5xOjIYR4nTvs4dejLAUzXjh289t3bK3pvPV43d%2FTUr1OsPfG9c%2FXzv5uMDxP49%2Fu1AwIAOw%3D%3D";
var provMapCoords = {imgWidth:710, imgHeight:708, mapWidth:670, mapHeight:670, leftMargin:31, topMargin:19};  

// EINSTELLUNG  
var Options = {
  includeWachturm : true,
  includeRessis : true,
  includeNahrung : true,
  includeNahrungUnten : false,
  includeTruppen : true,
  includeInfos : true,
  includeCity	: true,
  includeMarching:true,
  includeTraining:false,
  encRemaining : true,
  maxIdlePop   : false,
  srcSortBy    : 'level',
  srcMinLevel  : 1,
  srcMaxLevel  : 7,
  wildType     : 1,
  MightSrc     : 1,
  unownedOnly  : true,
  fixTower     : true,
  fixTower2    : true,
  fixMapDistance: true,
  fixMsgCount  : true,
  fixWarnZero  : true,
  fixPageNav   : true,
  enhanceARpts : true,
  allowAlterAR : true,
  enhanceMsging : true,
  ptWinIsOpen  : false,
  ptWinDrag    : false,
  ptWinPos     : {},
  enableFoodWarn : true,
  enableFoodAlert : false,
  foodWarnHours : 24,
  foodAlertHours : 4,
  lastVersion : null,
  hideOnGoto : true,
  currentTab : false,
  gmtClock : true,
  chatEnhance : true,
  fixKnightSelect : true,
  attackCityPicker : true,
  mapCoordsTop : true,
  dispBattleRounds : true,
  reportDeleteButton : true,
  overviewFontSize : 12,
  //overviewAllowOverflow : false,
  curMarchTab : 'A',
  playersNoCities : false,
  chatglobal : true,
  chatallianz : true,
  chatwhisper : true,
  chatbold : false,
  chatAttack : true,
  chatLeaders : true,
  enableTowerAlert : false,
  enableTowerAlertEN : false,
  enableFoodChatAlert : false,
  enableFoodChatAlertEN : false,
  enableBarbSummary  : true,
  lastBarbHit        : 0,
  barbHitsKeep       : 1000,
  AllianceLeaders : [],
  NeueNachricht : true,
  AllianzBerichte : true,
  MeineBerichte : true,
  Verstaerken : true,
  Transport : true,
  Wiederholen : true,
  AutoBau : true,
  Makieren : true,
  AutoTransport : true,
  AutoNeuzuordnen : true,
  Hilfe : true,
  AutoRefresh : true,
  ScSync : true,
};

// FARBEN
var Colors ={
    Headers : "#357",
	DarkRow : "#eee",
	ButtonSelected : "#444444",
	TabClicked : "#EED",
	Tabs : "#1E66BD",
    MainTitle  : "#357",
	MainTitleSch : "#FFFFFF",
    ChatLeaders: "#B8B8B8",
    ChatGlobal :  "#CCCCFF",
    OverviewDarkRow : "#f0f0f0",
};
// JSON
var JSON;if(!JSON){JSON={};}(function(){"use strict";function f(n){return n<10?'0'+n:n;}if(typeof Date.prototype.toJSON!=='function'){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+'-'+f(this.getUTCMonth()+1)+'-'+f(this.getUTCDate())+'T'+f(this.getUTCHours())+':'+f(this.getUTCMinutes())+':'+f(this.getUTCSeconds())+'Z':null;};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf();};}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={'\b':'\\b','\t':'\\t','\n':'\\n','\f':'\\f','\r':'\\r','"':'\\"','\\':'\\\\'},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==='string'?c:'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4);})+'"':'"'+string+'"';}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==='object'&&typeof value.toJSON==='function'){value=value.toJSON(key);}if(typeof rep==='function'){value=rep.call(holder,key,value);}switch(typeof value){case'string':return quote(value);case'number':return isFinite(value)?String(value):'null';case'boolean':case'null':return String(value);case'object':if(!value){return'null';}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==='[object Array]'){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||'null';}v=partial.length===0?'[]':gap?'[\n'+gap+partial.join(',\n'+gap)+'\n'+mind+']':'['+partial.join(',')+']';gap=mind;return v;}if(rep&&typeof rep==='object'){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==='string'){v=str(k,value);if(v){partial.push(quote(k)+(gap?': ':':')+v);}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?': ':':')+v);}}}}v=partial.length===0?'{}':gap?'{\n'+gap+partial.join(',\n'+gap)+'\n'+mind+'}':'{'+partial.join(',')+'}';gap=mind;return v;}}if(typeof JSON.stringify!=='function'){JSON.stringify=function(value,replacer,space){var i;gap='';indent='';if(typeof space==='number'){for(i=0;i<space;i+=1){indent+=' ';}}else if(typeof space==='string'){indent=space;}rep=replacer;if(replacer&&typeof replacer!=='function'&&(typeof replacer!=='object'||typeof replacer.length!=='number')){throw new Error('JSON.stringify');}return str('',{'':value});};}if(typeof JSON.parse!=='function'){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==='object'){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v;}else{delete value[k];}}}}return reviver.call(holder,key,value);}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4);});}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,'@').replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,']').replace(/(?:^|:|,)(?:\s*\[)+/g,''))){j=eval('('+text+')');return typeof reviver==='function'?walk({'':j},''):j;}throw new SyntaxError('JSON.parse');};}}());
var JSON2 = JSON;  
// VARS....
var Cities = {};
var crestname = {};
var Seed = unsafeWindow.seed;
var Tabs = {};
var researchLevels = [];
var currentName = 'Stats';
var mainPop;
var CPopUpTopClass = 'ptPopTop';
var KOCversion = null;
var firefoxVersion = getFirefoxVersion();
var barbHit = [];
var ptStartupTimer = null;
var uW = unsafeWindow;
var ResetColors = false;
// TAB ANORDNUNG
var toStats = 1;
var toMarsch = 2;
var toAusbildung = 3;
var toInfo = 4;
var toSpieler = 5;
var toRitter = 6;
var toWildnisse = 7;
var toNachrichten = 8;
var toEinstellung = 9;
var toFake = 10;
var toSuchen = 11;

function ptStartup (){
  clearTimeout (ptStartupTimer);
  if (unsafeWindow.ptLoaded)
    return;
  var metc = getClientCoords(document.getElementById('main_engagement_tabs'));
  if (metc.width==null || metc.width==0){
    ptStartupTimer = setTimeout (ptStartup, 1000);
    return;
  }
  unsafeWindow.ptLoaded = Version;
  KOCversion = anticd.getKOCversion();
  logit ("KofC client version: "+ KOCversion);
  readColors();
  readOptions();
setCities();
//logit ('g_timeoff: '+ unsafeWindow.g_timeoff);
  Seed = unsafeWindow.seed;
  var gmstyles = '\
    .ptcastleButNon {background-image:url("'+ URL_CASTLE_BUT +'")}\
    .ptcastleButSel {background-image:url("'+ URL_CASTLE_BUT_SEL +'")}\
    .ptcastleBut {outline:0px; margin-left:0px; margin-right:0px; width:24px; height:26px; font-size:12px; font-weight:bold;}\
    .ptcastleBut:hover {border-size:3px; border-color:#000;}\
  ';
  //.ptstat {border:1px solid; border-color:#ffffff; font-weight:bold; padding-top:2px; padding-bottom:2px; text-align:center; color:#ffffff; background-color:#357}
  var styles = '.xtab {padding-right: 5px; border:none; background:none; white-space:nowrap;}\
    .ptFeindlich td { background:#FF4040; }.ptFreundlich td{background:lightblue; }.ptally td{background:royalblue; }\
    .ptNeutral td { background:#C8C8C8; }.ptAllianzlose td { background:gold; }\
       .Feindlich td { background:crimson; }.Freundlich td{background:lightblue; }.Alliierte td{background:008000; }\
    .Neutral td { background:lightgreen; }.Allianzlose td { background:gold; }\
    .xtabBR {padding-right: 5px; border:none; background:none;}\
    div.ptDiv {background-color:'+Colors.OverviewDarkRow+';}\
    table.ptTab tr td {border:none; background:none; white-space:nowrap;}\
    table.ptTabPad tr td {border:none; background:none; white-space:nowrap; padding: 2px 4px 2px 4px;}\
    table.ptTabBR tr td {border:none; background:none;}\
    table.ptTabLined tr td {border:1px none none solid none;}\
	table.ptTabOverview tr td {border-left:1px solid #ccc; white-space:nowrap; padding: 1px; background-color:'+Colors.OverviewDarkRow+';}\
    table.ptTabPad tr td.ptentry {background-color:#ffeecc; padding-left: 8px;}\
    table.ptNoPad tr td {border:none; background:none; white-space:nowrap; padding:0px}\
    table.ptPlayers tr td {background-color:none; padding-left:5px; padding-right:5px;}\
    .ptOddrow {background-color:'+Colors.DarkRow+'}\
    .ptOddrow {background-color:#eee}\
    .ptstat {border:1px solid; border-color:#ffffff; font-weight:bold; padding-top:2px; padding-bottom:2px; text-align:center; color:'+Colors.MainTitleSch+';\
     background-color:'+Colors.MainTitle+'}\
    .ptstatLight {color:#ddd}\
    .ptentry {padding: 7px; border:1px solid; border-color:#000000; background-color:#ffeecc; white-space:nowrap;}\
    .ptErrText {font-weight:bold; color:#600000}\
    button::-moz-focus-inner, input[type="submit"]::-moz-focus-inner { border: none; }\
	.ptChatAttack {color: #000; font-weight:bold; background-color: #FF4D4D; }\
    .ptChatWhisper {font-weight:bold;color:#112299}\
    .ptChatGlobalBold {background-color:#66EE55;color:#000}\
	.ptChatGlobalAll {font-weight:bold;background-color:'+Colors.ChatGlobal+';}\
    .ptChatAlliance {background-color:#77DDFF;color:#000}\
	.ptChatAllianz {font-weight:bold;background-color:#77DDFF;color:#000}\
	.ptChatScripter {color:#A56631; font-weight:bold; background-color:'+Colors.ChatLeaders+';}\
	.ptChatOfficers {color:#000; background-color:'+Colors.ChatLeaders+';}\
    .ptChatGlobal {background-color:'+Colors.ChatGlobal+';}\
    .ptChatIcon {border: 3px inset red}\
    span.whiteOnRed {padding-left:3px; padding-right:3px; background-color:#700; color:white; font-weight:bold}\
    span.boldRed {color:#800; font-weight:bold}\
	span.pdxCapShadowRR {color:#0000; font-weight:bold;text-shadow: 1px 1px 1px #FF0000; font-variant:small-caps;}\
	span.pdxCapShadowRW {color:#0000; font-weight:bold;text-shadow: 1px 1px 1px #FFFFFF; font-variant:small-caps;}\
	span.pdxCapShadowSG {color:#0000; font-weight:bold;text-shadow: 1px 1px 1px #00BB33; font-variant:small-caps;}\
	span.pdxCapShadow {color:#0000; font-weight:bold;text-shadow: 1px 1px 1px #AAA; font-variant:small-caps; text-align:center}\
	span.pdxCapShadowRed {color:#600000; font-weight:bold;text-shadow: 1px 1px 1px #AAA; font-variant:small-caps; text-align:center}\
    span.pdxCapShadowI {color:#0000; font-style:italic;text-shadow: 1px 1px 1px #AAA; font-variant:small-caps; text-align:center}\
   span.boldDarkGreen {color:#008000; font-weight:bold}\
    a.ptButton20 {color:#ffff80}\
    hr.ptThin {padding:0px; margin:0px}\
    input.pbSubtab {cursor:pointer; width:10em; margin-right:15px;}\
    input.pbSubtabSel {background-color:#444; color:white; font-weight:bold; cursor:none !important}\
    table.ptMainTab {empty-cells:show; margin-top:5px }\
    table.ptMainTab tr td a {color:inherit }\
    table.ptMainTab tr td   {height:60%; empty-cells:show; padding: 0px 5px 0px 5px;  margin-top:5px; white-space:nowrap; border: 1px solid; border-style: none none solid none; }\
    table.ptMainTab tr td.spacer {padding: 0px 3px;}\
	table.ptMainTab tr td.sel {font-weight:bold; font-size:13px; border: 1px solid; border-style: solid solid none solid; background-color:'+Colors.TabClicked+';}\
    table.ptMainTab tr td.notSel {font-weight:bold; font-size:13px; border: 1px solid; border-style: solid solid none solid; background-color:'+Colors.Tabs+';\ color:white; border-color:black;}\
    tr.ptPopTop td { background-color:#dde; border:none; height: 21px;  padding:0px; }\
    tr.ptretry_ptPopTop td { background-color:#a00; color:#fff; border:none; height: 21px; padding:0px; }\
    input.ptButCancel {background-color:#a00; font-weight:bold; color:#fff}\
    .CPopup .CPopMain { background-color:#f8f8f8; padding:6px;}\
    .CPopup  {border:3px ridge #666} )';
      
  logit ("* Power Tools - Deutsch - by PDX - Version: "+ Version +" geladen!");
  
  
if (TEST_WIDE){
  // max cityname len = 15?
  for(i=0; i<Seed.cities.length; i++){
    Seed.cities[i][1] = Seed.cities[i][1] + 'LONGERNAMETEST';
    Seed.cities[i][1] = Seed.cities[i][1].substr(0,15);
  }
  var numToAdd = TEST_WIDE_CITIES - Seed.cities.length;
  while (numToAdd-- > 0){
    var cityId = Math.random() * 1234567;
    Seed.cities.push (Seed.cities[0]);
  }    
}
  setCities();

// TODO: Make sure WinPos is visible on-screen ?
  if (Options.ptWinPos==null || Options.ptWinPos.x==null|| Options.ptWinPos.x=='' || isNaN(Options.ptWinPos.x)){
//logit ( 'Options.ptWinPos: '+ inspect (Options.ptWinPos, 5, 1));
    var c = getClientCoords (document.getElementById('main_engagement_tabs'));
    Options.ptWinPos.x = c.x+4;
    Options.ptWinPos.y = c.y+c.height;
    saveOptions ();
  }
  mainPop = new CPopup ('ptmain', Options.ptWinPos.x, Options.ptWinPos.y, 749,700, Options.ptWinDrag,
      function (){
        tabManager.hideTab();
        Options.ptWinIsOpen=false;
        saveOptions();
      });

  GM_addStyle (gmstyles);  
  mainPop.getMainDiv().innerHTML = '<STYLE>'+ styles +'</style>';
  getAllianceLeaders();
  FoodAlerts.init();
  AudioAlert.init();
  TowerAlerts.init();
  MessageCounts.init ();
  MapDistanceFix.init ();
  WarnZeroAttack.init ();
  AllianceReports.init ();
  messageNav.init();
  PageNavigator.init ();
  ChatStuff.init ();
  AttackDialog.init();
  battleReports.init ();
  CoordBox.init ();
  GMTclock.init ();
  tabManager.init (mainPop.getMainDiv());
  
  if (Options.enableBarbSummary)
  RecordBarbs.init (); 
  if (Options.ptWinIsOpen){
    mainPop.show (true);
    tabManager.showTab();
  }
  window.addEventListener('unload', onUnload, false);
  
  if (Options.fixTower)
    TowerAlerts.enableFixTarget(true);
  if (Options.fixTower2)
    TowerAlerts.enableFixFalseReports(true);
  
  AddMainTabLink('Power Tools', eventHideShow, mouseMainTab);
TestSomething.init ();  
//setInterval (function(){logit (inspect (getClientCoords (mainPop.getMainDiv()), 3, 1))}, 2000);  
}


function onUnload (){
  Options.ptWinPos = mainPop.getLocation();
  saveOptions();
  if (!ResetColors) saveColors();
}

// RITTER ROLLEN
var knightRoles = [
  ['Meister', 'politics', 'Pol.'],
  ['Marschall', 'combat', 'Schlacht'],
  ['Alchemistisch', 'intelligence', 'Int.'],
  ['Verwalter', 'resourcefulness', 'Ressis'],
];
// GEBÄUDE NAMEN
var buildingNames = {
	 0: 'Schloss',
	 1: 'Bauernhof',
	 2: 'Sägewerk',
	 3: 'Steinbruch',
	 4: 'Bergwerk',
	 5: 'Hütte',
	 6: 'Wirtshaus',
	 7: 'Rittersaal',
	 8: 'Botschaft',
	 9: 'Lagerhaus',
	10: 'Markt',
	11: 'Alchemie Labor',
	12: 'Versammlungspunkt',
	13: 'Kasernen',
	14: 'Wachturm',
	15: 'Schmied',
	16: 'Mauer',
	17: 'Stallung',
	18: 'Hilfsstation',
	19: 'Mauer',
};
var CoordBox = {
  init : function (){
    var t = CoordBox;
    t.boxDiv = searchDOM (document.getElementById('maparea_map'), 'node.className=="mod_coord"', 3, false);
    t.setEnable (Options.mapCoordsTop);
  },
  setEnable : function (tf){
    var t = CoordBox;
    if (t.boxDiv == null)
      return;
    if (tf)
      t.boxDiv.style.zIndex = '100000';
    else
      t.boxDiv.style.zIndex = '10011';
  },
  isAvailable : function (){
    var t = CoordBox;
    return !(t.boxDiv==null);
  },
};


// KOC BUTTLER
// KSX VERSION
var ksxVersion = "2011.08.08.14";
var ksxEnabled = true;
var ksxFriendHelpEnabled = false; //BETA
var ksxDebug = false;
//#region Main

//DEBUGCODE for finding the proper page
//if(ksxDebug) GM_log("Loading document: " +
//	"id=" + document.getElementsByTagName("html")[0].getAttribute("id") + " title: " + document.title + 
//	" \n\t" + "href: " + document.location.href);

// @include       *.kingdomsofcamelot.com/fb/e2/src/main_src.php*
if (ksxEnabled && document.body.id == 'mainbody') {
	//	/*DEBUGCODE:*/if(ksxDebug) GM_log("Setup KoC Buttler \n" + "location: " + document.location.href);
    readOptions();
	ksx = unsafeWindow.ksx = new KsxLibrary();

	var enableToolbar         = true;
	var enablePowerToolbar    = true;
	var enableChatMonitor     = true;
	var enableResourceRequest = true;
	var enableMarchExtender   = true;
	ksx.compatibility.disableMarchXYPaste = false; // [Attack]

	// Toolbar Configuration
	ksx.configuration.toolbar = {items: []};
	if (Options.NeueNachricht) ksx.configuration.toolbar.items.push(["Button", , "Neue Nachricht", "ksx.plugins.Toolbar.macros.newMessage(); return false;"]);
	if (Options.MeineBerichte) ksx.configuration.toolbar.items.push(["Button", , "Meine Berichte", "modal_messages();track_chrome_btn('messages_btn');Messages.listReports();return false;"]);
	if (Options.AllianzBerichte) ksx.configuration.toolbar.items.push(["Button", , "Allianz Berichte", "modal_alliance();track_chrome_btn('alliance_btn');allianceReports();modal_alliance_changetab(4);return false;"]);
	if (Options.Verstaerken) ksx.configuration.toolbar.items.push(["Button", , "Verstärken", "ksx.plugins.Toolbar.macros.newMarch(2, '','', [0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0] );return false;"]);
	if (Options.Neuzuordnen) ksx.configuration.toolbar.items.push(["Button", , "Neu zuordnen", "ksx.plugins.Toolbar.macros.newMarch(5, '','', [0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0] );return false;"]);
	if (Options.Transport) ksx.configuration.toolbar.items.push(["Button", , "Transport", "ksx.plugins.Toolbar.macros.newMarch(1, '','', [0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0] );return false;"]);
	if (Options.Wiederholen) ksx.configuration.toolbar.items.push(["Button", "ksxMarchExtenderRepeatOpen", "Wiederholen", ""]);
		
/*	ksx.configuration.toolbar = {
		items: [
			//[Type, ID, Title, Action]
//			["Button", , "An Alle", "ksx.plugins.Toolbar.macros.newMessageAtAlliance(); return false;"],
			["Separator", ],
			["Button", , "Meine Berichte", "modal_messages();track_chrome_btn('messages_btn');Messages.listReports();return false;"],
			["Button", , "Allianz Berichte", "modal_alliance();track_chrome_btn('alliance_btn');allianceReports();modal_alliance_changetab(4);return false;"],
//			["Button", , "Einladung", "modal_alliance();track_chrome_btn('alliance_btn');inviteFriendsModule();return false;"],
//NOTWORKING["Button", , "Einladung", "modal_alliance();track_chrome_btn('alliance_btn');inviteFriendsModule();WAIT;searchTabInAllianceInvite();return false;"],
//			["LineBreak"],	
			["Separator", ],
//			["Button",, "Truppen aussenden", "modal_attack(4,'','');return false;"],
//			["Button", , "Späh", "ksx.plugins.Toolbar.macros.newMarch(3, '','', [0,0,1,0,0,0,0,0,0,0,0,0], [0,0,0,0,0] );return false;"],
			["Button", , "Verstärken", "ksx.plugins.Toolbar.macros.newMarch(2, '','', [0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0] );return false;"],
			["Button", , "Neu zuordnen", "ksx.plugins.Toolbar.macros.newMarch(5, '','', [0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0] );return false;"],
			["Button", , "Transport", "ksx.plugins.Toolbar.macros.newMarch(1, '','', [0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0] );return false;"],
			["Button", "ksxMarchExtenderRepeatOpen", "Wiederholen", ""],
//			["Button","ksxMarchExtenderRepeatMarch", "Wiederholen!"     , ""],
//			["Button",, "Dump Seed"        , "ksx.plugins.Toolbar.macros.dumpSeed(); return false;"],
		]
	};*/
	ksx.configuration.powertoolbar = {items: [], syncButtons: []};
	if (Options.AutoTransport) ksx.configuration.powertoolbar.items.push(["Button", "ksxpbTraderState", "Transport ${[x]}", ""]);
	if (Options.AutoNeuzuordnen) ksx.configuration.powertoolbar.items.push(["Button", "ksxpbReassignState", "Neu zuordnen ${[x]}", ""]);
	if (Options.AutoBau) ksx.configuration.powertoolbar.items.push(["Button", "ksxpbBuildRunning", "Autobau ${[x]}", ""]);
	if (Options.Makieren) ksx.configuration.powertoolbar.items.push(["Button", "ksxpbBuildMode", "Markieren ${[x]}", ""]);
	if (Options.Hilfe) ksx.configuration.powertoolbar.items.push(["Button", "ksxpbHelpRequest", "Nach Hilfe fragen ${[x]}", ""]);
	if (Options.AutoRefresh) ksx.configuration.powertoolbar.items.push(["Button", "ksxpbEveryEnable", "Auto Refresh ${[x]}", ""]);
	
	if (Options.ScSync) ksx.configuration.powertoolbar.syncButtons.push(["ksxpbTraderState"  , "pbTraderState", "value", /\s=\sAN/]);
	if (Options.ScSync) ksx.configuration.powertoolbar.syncButtons.push(["ksxpbReassignState", "pbReassignState", "value", /\s=\sAN/]);
	if (Options.ScSync) ksx.configuration.powertoolbar.syncButtons.push(["ksxpbBuildRunning", "pbBuildRunning", "value", /\s=\sAN/]);
	if (Options.ScSync) ksx.configuration.powertoolbar.syncButtons.push(["ksxpbBuildMode", "pbBuildMode", "value", /\s=\sAN/]);
	if (Options.ScSync) ksx.configuration.powertoolbar.syncButtons.push(["ksxpbHelpRequest"  , "pbHelpRequest", "checked","true"]);
	if (Options.ScSync) ksx.configuration.powertoolbar.syncButtons.push(["ksxpbEveryEnable", "pbEveryEnable", "checked", "true"]);
	/*
	ksx.configuration.powertoolbar = {
		items: [
			//[Type, ID, Title, Action]
			["Button", "ksxpbTraderState", "Transport ${[x]}", ""],
			["Button", "ksxpbReassignState", "Neu zuordnen ${[x]}", ""],
			["Button", "ksxpbBuildRunning", "Autobau ${[x]}", ""],
			["Button", "ksxpbHelpRequest", "Nach Hilfe fragen ${[x]}", ""],
			["Button", "ksxpbEveryEnable", "Auto Refresh ${[x]}", ""],
		],
		syncButtons: [
			["ksxpbTraderState"  , "pbTraderState", "value", /\s=\sAN/],
			["ksxpbReassignState", "pbReassignState", "value", /\s=\sAN/],
			["ksxpbBuildRunning", "pbBuildRunning", "value", /\s=\sAN/],
			["ksxpbBuildMode", "pbBuildMode", "value", /\s=\sAN/],
			["ksxpbHelpRequest"  , "pbHelpRequest", "checked","true"],
			["ksxpbEveryEnable", "pbEveryEnable", "checked", "true"],
		]
	};
*/

	// Chat Configuration
	ksx.configuration.chat = {
		backgrounds: {
			RequestItemBackground: 'lightgreen',
			OwnItemBackground: 'lightgray',
			InfoBackground: "#E0E060",
			AllyAttackBackground: "#FFB0E0",
			OwnAttackBackground: "#FF8080"
		}
	};
	
	// OBSOLETE: möglicherweise kein Platz mehr
	//@PDX: damit du weniger Arbeit beim Kopieren hast :-)
	//| <small><a href='http://userscripts.org/scripts/show/106722' target='_blank'>Buttler</a> \  - Version: <span class=boldRed>" + ksxVersion + "</span></small>"]);
	if (typeof Version === "string") /*KoC Power detected*/
		ksx.configuration.toolbar.items.push(["HTML", " <small><a href='http://userscripts.org/scripts/show/98323' target='_blank'>Tools</a> \  - Version: <span class=boldRed>" + Version + "</span> \
	  | <small><a href='http://userscripts.org/scripts/show/98414' target='_blank'>Bot</a> \  - Version: <span class=boldRed>" + BotVersion + "</span></small>"]);
		else
		ksx.configuration.toolbar.items.push(["HTML", " <small><a href='http://userscripts.org/scripts/show/106722' target='_blank'>KoC Buttler by KSX</a> \ - Version: <font color=#600000>" + ksxVersion + "</font></small> "]);
	
	if (enableToolbar        ) ksx.plugins.Toolbar         = new ToolbarPlugin(ksx);
	if (enablePowerToolbar   ) ksx.plugins.PowerToolbar    = new PowerToolbarPlugin(ksx);
	if (enableChatMonitor    ) ksx.plugins.ChatMonitor     = new ChatMonitorPlugin(ksx);
	if (enableResourceRequest) ksx.plugins.ResourceRequest = new ResourceRequestPlugin(ksx); //requires ChatMonitor
	if (enableMarchExtender  ) ksx.plugins.MarchExtender   = new MarchExtenderPlugin(ksx);   //requires Toolbar
}

//#region Friend help - step 1

//http://apps.facebook.com/kingdomsofcamelot/?page=helpfriend&tid=2&sid=10129776&lid=8&gid=9&cid=13156&s=308&in=10129776&si=107
//IFRame: http: //www308.kingdomsofcamelot.com/fb/e2/src/helpFriend_src.php?sid=10129776&gid=9&tid=2&lid=8&cid=13156&fbIframeOn=1&standalone=0&res=1&iframe=1&lang=de&in=10129776&si=107&ts=1311608381.8547&page=helpfriend&tid=2&sid=10129776&lid=8&gid=9&cid=13156&s=308&in=10129776&si=107&appBar=&cts=1311608374219
if (ksxEnabled && ksxFriendHelpEnabled && document.location.href.indexOf("kingdomsofcamelot.com/fb/e2/src/helpFriend_src.php") > 0) {
	//if(ksxDebug) GM_log("helpFriend_src");

	var ksx = new KsxLibrary();

	for (; ; ) {
		var claimhelpform = document.getElementById("claimhelpform");
		if (claimhelpform) {
			//if(ksxDebug) GM_log("claimhelpform");
			var nextbtn = ksx.tools.getElement("//div[@class='nextbtndiv clearfix']/a[@class='button25']/span");
			var backbtn = ksx.tools.getElement("//div[@class='backbtn clearfix']/a[@class='button25']/span");
			var btn;
			if (nextbtn) {
				//if(ksxDebug) GM_log("nextbtn");
				btn = nextbtn;
			} else if (backbtn) {
				//if(ksxDebug) GM_log("backbtn");
				btn = backbtn;
			}
			
			//@PDX: Werf mal bitte einen Blick drauf. der Klick auf den Link funktioniert irgendie nie. 
			
//	A		ksx.Tools.click(btn);

/*	B	*/	var evt = document.createEvent('MouseEvents');
			evt.initMouseEvent('click', true, true, document.defaultView, 1, 0, 0, 0, 0, false, false, false, false, 0, null);
			btn.dispatchEvent(evt);

//	C		var evt = document.createEvent("HTMLEvents");
//			evt.initEvent(evt, true, true); // event type,bubbling,cancelable
//			btn.dispatchEvent(evt);

			break;
		}

		break;
	}

	/* Möchtest Du XXX beim Forschen helfen?
	<div id="claimhelp">
		<div class="claimhelpbdy">
			<form id="claimhelpform" method="post" action="">
				<input type="hidden" value="Next" name="go">
				<input type="hidden" value="90_OjHGhPyBOW7JC6Og7U9RKaI642tUZk_P0S-6QUkM.eyJhbGdvcml0aG0iOiJITUFDLVNIQTI1NiIsImV4cGlyZXMiOjEzMTE2MTY4MDAsImlzc3VlZF9hdCI6MTMxMTYxMDc3OCwib2F1dGhfdG9rZW4iOiIxMzA0MDI1OTQ3Nzl8Mi5BUUE0ckNpVTJNNmFQbU00LjM2MDAuMTMxMTYxNjgwMC4xLTEwMDAwMTU4OTU1ODQ4M3xBNWRZUmZUSEpoRlZ3LUVDdnZyOEF1T1pSSzgiLCJ1c2VyIjp7ImNvdW50cnkiOiJkZSIsImxvY2FsZSI6ImRlX0RFIiwiYWdlIjp7Im1pbiI6MjF9fSwidXNlcl9pZCI6IjEwMDAwMTU4OTU1ODQ4MyJ9" name="signed_request">
				<div class="helpbodycontent rscbody">
					<div class="contenthd">Möchtest Du Patrick beim Forschen helfen?</div>
					<div class="contentmsg">Du kannst die Forschungszeit von Patrick um 1 Minute oder 1eduzieren. Wenn du Freunden hilfst, kannst Du jeden Tag 1 Glückslos bekommen.</div>
					<div class="nextbtndiv clearfix">
						<a class="buttonDown25" target="_top" href="http://apps.facebook.com/kingdomsofcamelot/?in=13729577&si=107">
						<a class="button25" onclick="$("claimhelpform").submit();return false;">
							<span>Next</span>
						</a>
					</div>
				</div>
			</form>
		</div>
	</div>
	*/

	/* Du hast XXX bereits bei diesem Projekt geholfen.
	<div id="claimhelp">
		<div class="claimhelpbdy">
			<form id="claimhelpform" method="post" action="">
				<input type="hidden" value="Next" name="go">
				<input type="hidden" value="_iaV8thp6bCb9VoxEYsXWgATNhb_5RMPsxUNL0AjNLw.eyJhbGdvcml0aG0iOiJITUFDLVNIQTI1NiIsImV4cGlyZXMiOjEzMTE2MTY4MDAsImlzc3VlZF9hdCI6MTMxMTYxMTE0NCwib2F1dGhfdG9rZW4iOiIxMzA0MDI1OTQ3Nzl8Mi5BUUE0ckNpVTJNNmFQbU00LjM2MDAuMTMxMTYxNjgwMC4xLTEwMDAwMTU4OTU1ODQ4M3xBNWRZUmZUSEpoRlZ3LUVDdnZyOEF1T1pSSzgiLCJ1c2VyIjp7ImNvdW50cnkiOiJkZSIsImxvY2FsZSI6ImRlX0RFIiwiYWdlIjp7Im1pbiI6MjF9fSwidXNlcl9pZCI6IjEwMDAwMTU4OTU1ODQ4MyJ9" name="signed_request">
				<div class="helpbodycontent rscbody">
					<div	class="applyexistingrad">Du hast Detlef bereits bei diesem Projekt geholfen.</div>
					<div class="backbtn clearfix">
						<a class="button25" target="_top" href="http://apps.facebook.com/kingdomsofcamelot/?in=10129776&si=107">
							<span>Back</span>
						</a>	
					</div>
				</div>
			</form>
		</div>
	</div>
	*/
}
//#endregion

//#region Friend help - step 2

// http://apps.facebook.com/kingdomsofcamelot/?page=accepttoken&s=308&in=10129776&tid=2&lid=8&gid=9&si=107
// contains a IFrame: http://www308.kingdomsofcamelot.com/fb/e2/src/acceptToken_src.php

// TODO make serverID configurable and remove "false" 
// @include       http://www308.kingdomsofcamelot.com/fb/e2/src/acceptToken_src.php*
if (false && ksxEnabled && ksxFriendHelpEnabled && document.location.href.indexOf("kingdomsofcamelot.com/fb/e2/src/acceptToken_src.php") > 0 /*&& document.getElementById("claimhelp")*/) {
	//if(ksxDebug) GM_log("acceptToken_src");

//	var acceptForServer = "270"; //TODO load from config, create UI for config
//
//	var ksx = new KsxLibrary();
//
//	for (;;) {
//		var claimtokenaddtoserver = document.getElementById("claimtokenaddtoserver");
//		if (claimtokenaddtoserver) {
//			//if(ksxDebug) GM_log("claimhelpform");
//			var serveridSelector = document.getElementById("serverid");
//			if (serveridSelector) {
//				//if(ksxDebug) GM_log("serverid found ");
//
//				var idx = -1;
//				for (var i = 0; i < serveridSelector.options.length; i++) {
//					//if(ksxDebug) GM_log(serveridSelector.options[i].value);
//					if (serveridSelector.options[i].value == acceptForServer) idx = i;
//				}
//				if (idx==-1) {/*Server nov found!*/ break;}
//				serveridSelector.selectedIndex = idx;
//				var form = document.getElementById("claimtokenaddtoserver");
//				claimtokenaddtoserver.submit();
//				break;
//			}
//		}
//		break;
//	}
	
	/*
		<div id="claimhelp">
			<div class="claimhelpbdy">
				<div class="pichelp clearfix">
					<div class="applyexistingrad" align="center" style="width:300px;margin:15px auto;">Du kannst jeden Tag ein Glückslos von Merlin bekommen, wenn du deinen Freunden hilfst!</div>
					<div class="nextbtndiv clearfix" style="padding-top: 10px;">
						<a class="button25" target="_top" href="http://apps.facebook.com/kingdomsofcamelot/?in=10129776">
							<span>Fahre fort</span>
						</a>
					</div>
					<div class="nothanks" style="display:none;">
					</div>
				</div>
			</div>
		</div>
	*/
}
//endregion


//#endregion
//#endregion


function KsxLibrary() {
	if(ksxDebug) GM_log(new Date().toTimeString().substring(0, 8) + '.' + new Date().getMilliseconds() + ': ' + "KsxLibrary");
	
	var JSON= {}; (function () { "use strict"; function f(n) { return n < 10 ? '0' + n : n; } if (typeof Date.prototype.toJSON !== 'function') { Date.prototype.toJSON = function (key) { return isFinite(this.valueOf()) ? this.getUTCFullYear() + '-' + f(this.getUTCMonth() + 1) + '-' + f(this.getUTCDate()) + 'T' + f(this.getUTCHours()) + ':' + f(this.getUTCMinutes()) + ':' + f(this.getUTCSeconds()) + 'Z' : null; }; String.prototype.toJSON = Number.prototype.toJSON = Boolean.prototype.toJSON = function (key) { return this.valueOf(); }; } var cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g, escapable = /[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g, gap, indent, meta = { '\b': '\\b', '\t': '\\t', '\n': '\\n', '\f': '\\f', '\r': '\\r', '"': '\\"', '\\': '\\\\' }, rep; function quote(string) { escapable.lastIndex = 0; return escapable.test(string) ? '"' + string.replace(escapable, function (a) { var c = meta[a]; return typeof c === 'string' ? c : '\\u' + ('0000' + a.charCodeAt(0).toString(16)).slice(-4); }) + '"' : '"' + string + '"'; } function str(key, holder) { var i, k, v, length, mind = gap, partial, value = holder[key]; if (value && typeof value === 'object' && typeof value.toJSON === 'function') { value = value.toJSON(key); } if (typeof rep === 'function') { value = rep.call(holder, key, value); } switch (typeof value) { case 'string': return quote(value); case 'number': return isFinite(value) ? String(value) : 'null'; case 'boolean': case 'null': return String(value); case 'object': if (!value) { return 'null'; } gap += indent; partial = []; if (Object.prototype.toString.apply(value) === '[object Array]') { length = value.length; for (i = 0; i < length; i += 1) { partial[i] = str(i, value) || 'null'; } v = partial.length === 0 ? '[]' : gap ? '[\n' + gap + partial.join(',\n' + gap) + '\n' + mind + ']' : '[' + partial.join(',') + ']'; gap = mind; return v; } if (rep && typeof rep === 'object') { length = rep.length; for (i = 0; i < length; i += 1) { k = rep[i]; if (typeof k === 'string') { v = str(k, value); if (v) { partial.push(quote(k) + (gap ? ': ' : ':') + v); } } } } else { for (k in value) { if (Object.hasOwnProperty.call(value, k)) { v = str(k, value); if (v) { partial.push(quote(k) + (gap ? ': ' : ':') + v); } } } } v = partial.length === 0 ? '{}' : gap ? '{\n' + gap + partial.join(',\n' + gap) + '\n' + mind + '}' : '{' + partial.join(',') + '}'; gap = mind; return v; } } if (typeof JSON.stringify !== 'function') { JSON.stringify = function (value, replacer, space) { var i; gap = ''; indent = ''; if (typeof space === 'number') { for (i = 0; i < space; i += 1) { indent += ' '; } } else if (typeof space === 'string') { indent = space; } rep = replacer; if (replacer && typeof replacer !== 'function' && (typeof replacer !== 'object' || typeof replacer.length !== 'number')) { throw new Error('JSON.stringify'); } return str('', { '': value }); }; } if (typeof JSON.parse !== 'function') { JSON.parse = function (text, reviver) { var j; function walk(holder, key) { var k, v, value = holder[key]; if (value && typeof value === 'object') { for (k in value) { if (Object.hasOwnProperty.call(value, k)) { v = walk(value, k); if (v !== undefined) { value[k] = v; } else { delete value[k]; } } } } return reviver.call(holder, key, value); } text = String(text); cx.lastIndex = 0; if (cx.test(text)) { text = text.replace(cx, function (a) { return '\\u' + ('0000' + a.charCodeAt(0).toString(16)).slice(-4); }); } if (/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g, '@').replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, ']').replace(/(?:^|:|,)(?:\s*\[)+/g, ''))) { j = eval('(' + text + ')'); return typeof reviver === 'function' ? walk({ '': j }, '') : j; } throw new SyntaxError('JSON.parse'); }; } } ());
	this.JSON = JSON;

	String.prototype.trim = function() { return this.replace( /^\s+|\s+$/g , ''); };
	
	this.logit = function(msg) {
		var now = new Date();
		GM_log(this.koc.getServerId() + ' @ ' + now.toTimeString().substring(0, 8) + '.' + now.getMilliseconds() + ': ' + msg);
	};

	var tools = {

		getElement: function (locator) {
			//TODO: implement functionality of Selenium element locators
			// http://release.seleniumhq.org/selenium-core/1.0/reference.html
			if (locator.search('//') == 0) return this.getElementByXPath(locator);
			if (locator.search('xpath=') == 0) return this.getElementByXPath(locator.substr(6, locator.length - 6));
			//if (locator.search('css=') == 0) return this.getElementByCssPath(locator.substr(4, locator.length - 4));
			//if (locator.search('document.') == 0) return this.getElementByDom(locator.substr(4, locator.length - 4));
			//if (locator.search('dom=') == 0) return this.getElementByDom(locator.substr(4, locator.length - 4));
			if (locator.search('id=') == 0) return document.getElementById(locator);
			//if (locator.search('link=') == 0) return document.getElementByLink(locator);
			//if (locator.search('identifier=') == 0) ...
			var elmt = document.getElementById(locator); if (elmt != null) return elmt;
			return document.getElementsByName(locator);
		},

		getElementByXPath: function (expr) {
			var d = document;
			var elmFirstResult = d.evaluate(expr, document,
				null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
			return elmFirstResult;
		},

		//TODO: getElementByCssPath: function (expr) {},
		//TODO: getElementByDom: function (expr) {},
		//TODO: getElementByLink: function (expr) {},

		getAttribute: function (attributeLocator) {
			var index = attributeLocator.lastIndexOf('@');
			var locator = attributeLocator.substr(0, index);
			var attribute = attributeLocator.substring(index + 1, attributeLocator.length);
			//alert(locator + " " + attribute);
			var elmt = this.getElement(locator);
			var attrValue = elmt.getAttribute(attribute);
			return attrValue;
		},

		click: function (element) {
			if (element === null || element === undefined) throw "Element not specified!";
			if (typeof (element) == "string") element = this.getElement(element);

			var evt = document.createEvent("MouseEvents");
			evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
			var canceled = !element.dispatchEvent(evt);
			//OPTIONAL: if (canceled) { /* A handler called preventDefault */ } else {/* None of the handlers called preventDefault*/}
		},

		uncheck: function (element) {
			if (element === null || element === undefined) throw "Element not specified!";
			if (typeof (element) == "string") element = this.getElement(element);
			if (typeof element.checked == "undefined") return; //Klick-Buttons (input type="button")  Checkboxen(input type="checkbox")  Radio-Buttons(input type="radio") 
			if (!element.checked) return;

			var evt = document.createEvent("MouseEvents");
			evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
			var canceled = !element.dispatchEvent(evt);
			//OPTIONAL: if (canceled) { /* A handler called preventDefault */ } else {/* None of the handlers called preventDefault*/}
		},

		check: function (element) {
			if (element === null || element === undefined) throw "Element not specified!";
			if (typeof (element) == "string") element = this.getElement(element);
			if (typeof element.checked == "undefined") return;

			if (element.checked) return;

			var evt = document.createEvent("MouseEvents");
			evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
			var canceled = !element.dispatchEvent(evt);
			//OPTIONAL: if (canceled) { /* A handler called preventDefault */ } else {/* None of the handlers called preventDefault*/}
		},


		typeKeys: function (element, chars) {
			if (element == null) throw "Element not specified!";
			if (typeof (element) == "string") element = this.getElement(element);
			for (var i = 0; i < chars.length; i++) {
				// Create the key press event.
				var pressEvent = document.createEvent('KeyboardEvent');
				pressEvent.initKeyEvent("keypress", true, true, window, false, false, false, false, 0, chars.charCodeAt(i));

				element.dispatchEvent(pressEvent); // Press the key.
			}
		},

		//downEvent.initKeyEvent(type, bubbles, cancelable, viewArg, ctrlKeyArg, altKeyArg, shiftKeyArg, metaKeyArg, keyCodeArg, charCodeArg)

		typeKeys2: function (element, chars) {
			if (element == null) throw "Element not specified!";
			if (typeof (element) == "string") element = this.getElement(element);

			element.focus();

			for (var i = 0; i < String(chars).length; i++) {
				var c = String(chars).charCodeAt(i);

				var downEvent = document.createEvent('KeyboardEvent');
				downEvent.initKeyEvent("keydown", true, true, window, false, false, false, false, 0, c);
				element.dispatchEvent(downEvent);

				var pressEvent = document.createEvent('KeyboardEvent');
				pressEvent.initKeyEvent("keypress", true, true, window, false, false, false, false, 0, c);
				element.dispatchEvent(pressEvent);

				var upEvent = document.createEvent('KeyboardEvent');
				upEvent.initKeyEvent("keyup", true, true, window, false, false, false, false, 0, c);
				element.dispatchEvent(upEvent);
			}
		},

		type: function (element, chars) {
			if (element == null) throw "Element not specified!";
			if (typeof (element) == "string") element = this.getElement(element);

			if (element.type == 'text') {
				element.focus();
				element.value = chars;
			} else {
				throw "Element not supported!";
			}
		},

		emulateFocus: function (element) {
			emulateEvent(element, "focus");
		},

		emulateEvent: function (element, eventName) {
			var options = extend(defaultOptions, arguments[2] || {});
			var oEvent, eventType = null;
			for (var name in eventMatchers) {
				if (eventMatchers[name].test(eventName)) { eventType = name; break; }
			}
			if (!eventType) throw new SyntaxError('Only HTMLEvents and MouseEvents interfaces are supported');
			if (document.createEvent) {
				oEvent = document.createEvent(eventType);
				if (eventType == 'HTMLEvents') {
					oEvent.initEvent(eventName, options.bubbles, options.cancelable);
				} else {
					oEvent.initMouseEvent(eventName, options.bubbles, options.cancelable, document.defaultView,
					 	options.button, options.pointerX, options.pointerY, options.pointerX, options.pointerY,
					 	options.ctrlKey, options.altKey, options.shiftKey, options.metaKey, options.button, element);
				}
				element.dispatchEvent(oEvent);
			} else {
				options.clientX = options.pointerX;
				options.clientY = options.pointerY;
				var evt = document.createEventObject();
				oEvent = extend(evt, options);
				element.fireEvent('on' + eventName, oEvent);
			}
			return element;
		},

		extend: function (destination, source) {
			for (var property in source) destination[property] = source[property];
			return destination;
		},

		eventMatchers: {
			'HTMLEvents': /^(?:load|unload|abort|error|select|change|submit|reset|focus|blur|resize|scroll)$/,
			'MouseEvents': /^(?:click|dblclick|mouse(?:down|up|over|move|out))$/
		},
		defaultOptions: { pointerX: 0, pointerY: 0, button: 0, ctrlKey: false, altKey: false, shiftKey: false, metaKey: false, bubbles: true, cancelable: true },

		doUnsafeWindow: function (func, executeByEmbed) {
			if (this.isChrome || executeByEmbed) {
				var scr = document.createElement('script');
				scr.innerHTML = func;
				document.body.appendChild(scr);
			} else {
				try {
					eval("unsafeWindow." + func);
				} catch (error) {
					logit("Bei DoUnsafeWindow hat JavaScript ein fehler gefunden! Meldung: " + error.description);
				}
			}
		},

		findParentByTagName: function (elmt, tagName, findSelf) {
			if (findSelf && elmt.tagName.toLowerCase() == tagName.toLowerCase()) return elmt;
			var t = elmt;
			while (t) {
				try { t = t.parentNode; } catch (ex) { return null; };
				if (t == null) return null;
				//GM_log(t.tagName);
				if (t.tagName.toLowerCase() == tagName.toLowerCase()) break;
			}
			return t;
		},

		className: "KSX+Tools"
	};
	this.tools = tools;

	var selenium = {
		// a small try to implement some Selenium functionality

		click: function(locator) {
			logit("Selenium: click | " + locator);
			var elmt = tools.getElement(locator);
			if (elmt == null) {
				throw "Element not found (" + locator + ")";
			}
			tools.click(elmt);
		},

		getAttribute: function(attributeLocator) {
			logit("Selenium: getAttribute | " + attributeLocator);
			return tools.getAttribute(attributeLocator);
		},

		getElement: function(locator) {
			logit("Selenium: getElement | " + locator);
			return tools.getElement(locator);
		},

		getElementPresent: function(locator) {
			logit("Selenium: getElementPresent | " + locator);
			return tools.getElement(locator) != null;
		},

		waitforElementPresent: function(locator) {
			logit("Selenium: waitforElementPresent | " + locator);
			var tot = new Date().getTime() + 30000;

			do { //because there is no sleep, this will use 100% CPU :-( 
				if (tools.getElementPresent(locator)) return true;
			} while (new Date().getTime() < tot)
			throw "Timeout on waiting for element!";
		},

		className: "KSX.Selenium"
	};
	this.Selenium = selenium;

		/// <summary> Provides funtions to create HTML elements </summary>
	var builder = {

		/// <summary>Creates a blue button </summary>
		BlueButton: function (caption, onclick, id) {
			var a = document.createElement('a');
			if (typeof (onclick) == "string") { a.setAttribute("onclick", onclick); }
			else if (typeof (onclick) == "function") { a.addEventListener("click", onclick, true); }
			else throw "Invalid argument!";
			a.setAttribute("class", "button20");
			a.setAttribute("href", "#");
			if (id) a.setAttribute("id", id);
			var span = document.createElement('span');
			a.appendChild(span);
			span.appendChild(document.createTextNode(caption));
			return a;
		},

		//TODO: DRAFT same as BlueButton but inline
		BlueButton2: function (caption, onclick, id) {
			var a = document.createElement('a');
			if (typeof (onclick) == "string") { a.setAttribute("onclick", onclick); }
			else if (typeof (onclick) == "function") { a.addEventListener("click", onclick, true); }
			else throw "Invalid argument!";
			a.setAttribute("style", "background: url('img/button20_cap.png') no-repeat scroll right top transparent;color: #FFFFFF;cursor: pointer;display: inline; font-size: 12px; font-weight: bold; height: 22px; margin-left: 6px; margin-right: 6px; margin-right: 6px; margin-right: 6px; padding: 2px 8px 5px 0px; text-decoration: none;");
			if (id) a.setAttribute("id", id);
			var span = document.createElement('span');
			span.setAttribute("style", "background: url('img/button20.png') no-repeat scroll 0 0 transparent; padding: 2px 0 5px 8px;");
			a.appendChild(span);
			span.appendChild(document.createTextNode(caption));
			return a;
		},
		ToolbarButton: function (caption, onclick, id) {
			var a = document.createElement('a');
			if (typeof (onclick) == "string") { a.setAttribute("onclick", onclick); }
			else if (typeof (onclick) == "function") { a.addEventListener("click", onclick, true); }
			else throw "Invalid argument!";
			a.setAttribute("style", "background: url('img/button20_cap.png') no-repeat scroll right top transparent;color: #DFDFFF;cursor: pointer;display: inline; font-size: 11px; font-weight: bold; height: 22px; margin-right:1px;margin-left:1px; padding: 2px 8px 5px 0px; text-decoration: none;");
			if (id) a.setAttribute("id", id);
			var span = document.createElement('span');
			span.setAttribute("style", "background: url('img/button20.png') no-repeat scroll 0 0 transparent; line-height: 15px; padding: 2px 0 5px 8px;");
			a.appendChild(span);
			//span.appendChild(document.createTextNode(caption));
			caption = caption.replace("${[x]}", "<span style='color:#00FF00; font-size:16px; vertical-align:middle;'>☑</span>"); //☒
			caption = caption.replace("${[ ]}", "<span style='color:#FF4444; font-size:16px; vertical-align:middle;'>☐</span>");
			caption = caption.replace("${[?]}", "<span style='color:#AAAAAA; font-size:16px; vertical-align:middle;'>?</span>");
			span.innerHTML = caption;
			return a;
		},

		setToolbarCheckButton: function (button, value) {
			var chk = button.childNodes[0].childNodes[button.childNodes[0].childNodes.length-1];
			if (chk.innerHTML != "?" && chk.innerHTML != "☑" && chk.innerHTML != "☐") {
				GM_log("Invalid CheckButton content! '" + chk.innerHTML + "'");
				return;
			}
			chk.style.color = value === null ? "#AAAAAA" : (value ? "#00FF00" : "#FF4444");
			chk.innerHTML = value === null ? "?" : (value ? "☑" : "☐");
		},

		ComTabButton: function (caption, onclick, id) {
			var a = document.createElement('a');
			if (typeof (onclick) == "string") { a.setAttribute("onclick", onclick); }
			else if (typeof (onclick) == "function") { a.addEventListener("click", onclick, true); }
			else throw "Invalid argument!";
			a.setAttribute("style", "padding: 0px 12px");
			if (id) a.setAttribute("id", id);
			var span = document.createElement('span');
			span.setAttribute("style", "line-height: 35px; font-size:12px; font-weight: 700; color:#FFFFFF");
			a.appendChild(span);
			span.appendChild(document.createTextNode(caption));
			return a;
		},

		/// <summary>Creates a blue tab </summary>
		BlueTab: function (caption, onclick, id) {
			var a = document.createElement('a');
			if (typeof (onclick) == "string") { a.setAttribute("onclick", onclick); }
			else if (typeof (onclick) == "function") { a.addEventListener("click", onclick, true); }
			else throw "Invalid argument!";
			a.setAttribute("class", "tab");
			if (id) a.setAttribute("id", id);
			var span = document.createElement('span');
			a.appendChild(span);
			span.appendChild(document.createTextNode(caption));
			return a;
		},

		/// <summary>Creates a green button </summary>
		GreenButton: function (caption, onclick, id) {
			var a = document.createElement('a');
			if (typeof (onclick) == "string") { a.setAttribute("onclick", onclick); }
			else if (typeof (onclick) == "function") { a.addEventListener("click", onclick, true); }
			else throw "Invalid argument!";
			a.setAttribute("class", "buttonGreen20");
			a.setAttribute("href", "#");
			if (id) a.setAttribute("id", id);
			var span = document.createElement('span');
			a.appendChild(span);
			span.appendChild(document.createTextNode(caption));
			return a;
		},

		Span: function (innerHtml, id) {
			var span = document.createElement('span');
			span.innerHTML = innerHtml;
			if (id) a.setAttribute("id", id);
			return span;
		},

		Element: function (elementName, innerElement) {
			var elmt = document.createElement(elementName);
			if (typeof (innerElement) == "object") elmt.appendChild(innerElement);
			else if (typeof (innerElement) == "string") elmt.innerHTML = innerElement;
			else throw "Invalid Argument!";
			return elmt;
		},

		remove: function (id) {
			var elmt = document.getElementById(id);
			if (!elmt) return;
			elmt.parentNode.removeChild(elmt);
		},

		showDialog: function (header, content) {
			var template = " \
	<div id='modalBox2' class='modalBox modalBox400 ' style='width: 416px; top: 150px; \
		left: 172px; z-index: 100310;'> \
		<div id='modalInner2' class='modalInner modalInner400'> \
			<div id='modalTitleBar2' class='modalTitleBar modalTitleBar400'> \
				<div id='modalTitle2' class='modalTitle'> \
					${Header} \
				</div> \
				<div id='modalControls2' class='modalControls'> \
					<a id='modalControlsClose2' onclick='ksx.Builder.remove(\"modalBox2\");return false;'><span>&nbsp;</span> </a> \
				</div> \
			</div> \
			<div id='modalContent2' class='modalContent modalContent400'> \
				<div class='kofcalert'> \
					${Content} \
				</div> \
				<div class='kofcalertbtn clearfix'> \
					<a class='button20' onclick='ksx.Builder.remove(\"modalBox2\");return false;'><span>Ok</span> </a> \
				</div> \
			</div> \
		</div> \
	</div>";

			var s = template.replace("${Header}", header).replace("${Content}", content);
			document.body.appendChild(ksx.Builder.Element("div", s));
		},

		className: "KSX.Builder"
	};
	this.Builder = builder;
	
		/// <summary> Provides KoC specific stuff </summary>
	this.koc = {
		_ServerID: null,
		getServerId: function () {
			if (this._ServerID == null) {
				var m = /^[a-zA-Z]+([0-9]+)\./.exec(document.location.hostname);
				if (m)
					this._ServerId = m[1];
				else
					this._ServerId = '??';
			}
			return this._ServerId;
		},

		_PlayerName: null,
		getPlayerName: function () {
			///*DEBUGCODE:*/alert("Calling ksx.koc.getPlayerName");
			if (this._PlayerName == null) {
				var e = tools.getElement("topnavDisplayName");
				///*DEBUGCODE:*/if (e == null) alert("topnavDisplayName not found!");
				this._PlayerName = e.textContent;
			};
			return this._PlayerName;
		},

		getRallyPointLevel: function (cityId, returnLogicalLevel) {
			if (!cityId) cityId = unsafeWindow.currentcityid;
			else if (city.indexOf("city") != 0) cityId = "city" + cityId;
			if(!returnLogicalLevel) returnLogicalLevel = false;
			var seed = unsafeWindow.seed;
			var rallypointLevel = 0;
			for (var o in seed.buildings[cityId]) {
				if (parseInt(seed.buildings[cityId][o][0]) == 12) {
					rallypointLevel = parseInt(seed.buildings[cityId][o][1]);
					break;
				}
			}
			if (returnLogicalLevel && rallypointLevel == 11) rallypointLevel = 15;
			return rallypointLevel;
		},
		
		getCurrentCityId: function() {
			return unsafeWindow.currentcityid; //"city12345567"
		},
		
		getCurrentMarchType: function () {
			for (var i = 1; i < 6; i++) if (document.getElementById('modal_attack_tab_' + i).className == 'selected') return i;
			return 0;
		},

		MarchUI: function () {

			this.unitIpt1 = ksx.tools.getElement("modal_attack_unit_ipt1");
			this.unitIpt2 = ksx.tools.getElement("modal_attack_unit_ipt2");
			this.unitIpt3 = ksx.tools.getElement("modal_attack_unit_ipt3");
			this.unitIpt4 = ksx.tools.getElement("modal_attack_unit_ipt4");
			this.unitIpt5 = ksx.tools.getElement("modal_attack_unit_ipt5");
			this.unitIpt6 = ksx.tools.getElement("modal_attack_unit_ipt6");
			this.unitIpt7 = ksx.tools.getElement("modal_attack_unit_ipt7");
			this.unitIpt8 = ksx.tools.getElement("modal_attack_unit_ipt8");
			this.unitIpt9 = ksx.tools.getElement("modal_attack_unit_ipt9");
			this.unitIpt10 = ksx.tools.getElement("modal_attack_unit_ipt10");
			this.unitIpt11 = ksx.tools.getElement("modal_attack_unit_ipt11");
			this.unitIpt12 = ksx.tools.getElement("modal_attack_unit_ipt12");

			this.unitnum1 = ksx.tools.getElement("//div[@id='modal_attack_unitlist']/div[@name='1']/div/div[2]/span");
			this.unitnum2 = ksx.tools.getElement("//div[@id='modal_attack_unitlist']/div[@name='2']/div/div[2]/span");
			this.unitnum3 = ksx.tools.getElement("//div[@id='modal_attack_unitlist']/div[@name='3']/div/div[2]/span");
			this.unitnum4 = ksx.tools.getElement("//div[@id='modal_attack_unitlist']/div[@name='4']/div/div[2]/span");
			this.unitnum5 = ksx.tools.getElement("//div[@id='modal_attack_unitlist']/div[@name='5']/div/div[2]/span");
			this.unitnum6 = ksx.tools.getElement("//div[@id='modal_attack_unitlist']/div[@name='6']/div/div[2]/span");
			this.unitnum7 = ksx.tools.getElement("//div[@id='modal_attack_unitlist']/div[@name='7']/div/div[2]/span");
			this.unitnum8 = ksx.tools.getElement("//div[@id='modal_attack_unitlist']/div[@name='8']/div/div[2]/span");
			this.unitnum9 = ksx.tools.getElement("//div[@id='modal_attack_unitlist']/div[@name='9']/div/div[2]/span");
			this.unitnum10 = ksx.tools.getElement("//div[@id='modal_attack_unitlist']/div[@name='10']/div/div[2]/span");
			this.unitnum11 = ksx.tools.getElement("//div[@id='modal_attack_unitlist']/div[@name='11']/div/div[2]/span");
			this.unitnum12 = ksx.tools.getElement("//div[@id='modal_attack_unitlist']/div[@name='12']/div/div[2]/span");

			this.knight = ksx.tools.getElement("modal_attack_knight");
			this.targetCoordsX = ksx.tools.getElement("modal_attack_target_coords_x");
			this.targetCoordsY = ksx.tools.getElement("modal_attack_target_coords_y");

			this.supplyfilterCheckbox = ksx.tools.getElement("modal_attack_supplyfilter_checkbox");

			this.gold = ksx.tools.getElement("modal_attack_gold");
			this.food = ksx.tools.getElement("modal_attack_rec1"); // nahrung
			this.wood = ksx.tools.getElement("modal_attack_rec2"); // holz
			this.stone = ksx.tools.getElement("modal_attack_rec3"); // stein
			this.ore = ksx.tools.getElement("modal_attack_rec4"); // erz

			this.maxGoldValue = ksx.tools.getElement("modal_attack_rec_max_gold").textContent;
			this.maxFoodValue = ksx.tools.getElement("modal_attack_rec_max_rec1").textContent;
			this.maxWoodValue = ksx.tools.getElement("modal_attack_rec_max_rec2").textContent;
			this.maxStoneValue = ksx.tools.getElement("modal_attack_rec_max_rec3").textContent;
			this.maxOreValue = ksx.tools.getElement("modal_attack_rec_max_rec4").textContent;

			this.maxUnit = ksx.tools.getElement("modal_attack_maxunt");
			this.maxRes = ksx.tools.getElement("modal_attack_maxres");

			this.getMarchType = function () {
				for (var i = 1; i < 6; i++) if (document.getElementById('modal_attack_tab_' + i).className == 'selected') return i;
				return 0;
			};

		},

		getCityBuilding: function getCityBuilding(cityId, buildingId) {
			var b = unsafeWindow.seed.buildings['city' + cityId];
			var ret = { count: 0, maxLevel: 0 };
			for (var i = 1; i < 33; i++) {
				if (b['pos' + i] && b['pos' + i][0] == buildingId) {
					++ret.count;
					if (parseInt(b['pos' + i][1]) > ret.maxLevel)
						ret.maxLevel = parseInt(b['pos' + i][1]);
				}
			}
			return ret;
		},

		getMyAlliance: function () {
			if (unsafeWindow.seed.allianceDiplomacies == null || unsafeWindow.seed.allianceDiplomacies.allianceName == null)
				return [0, 'Keine'];
			else
				return [unsafeWindow.seed.allianceDiplomacies.allianceId, unsafeWindow.seed.allianceDiplomacies.allianceName];
		},

		getAllianceId: function () {
			if (unsafeWindow.seed.allianceDiplomacies == null || unsafeWindow.seed.allianceDiplomacies.allianceName == null)
				return 0; else return unsafeWindow.seed.allianceDiplomacies.allianceId;
		},

		className: "ksx.koc"
	};

	this.plugins = {className: "ksx.plugins"};
	this.compatibility = { className: "ksx.compatibility" };
	this.configuration = { className: "ksx.configuration" };
	this.className = "KSX";

	/*DEBUGCODE:*/ this.logit("Current player: " + this.koc.getPlayerName());
};


//#region Feature "Set Titel with player name"
//NOT WORKING
//// @include       http://apps.facebook.com/kingdomsofcamelot/*
//if (document.getElementsByTagName("html")[0].getAttribute("id") == "facebook") {
//	/*DEBUGCODE:*/if(ksxDebug) GM_log("Setup KoC Buttler \n" + "location: " + document.location.href);
//	window.setInterval(function () {
//		if(ksxDebug) GM_log("facebook 1 " + document.title);
//		if(ksxDebug) GM_log(unsafeWindow.getPropertyValue("ksx"));
//		if (typeof (ksx) != "object") return;
//		if(ksxDebug) GM_log("facebook 2");
//		var newTitle = ksx.koc.getPlayerName();
//		var title = document.title;
//		ksx.logit("Update Title: " + title + " -> " + newTitle);
//		document.title = newTitle;
//	}, 5000);
//}
//#endregion Feature "Set Titel with player name"


function ToolbarPlugin(ksx) {

	var macros = {
		// contains all functions, which can be called from toolbar buttons
		
		dumpSeed: function () {
			function dump(obj,path) {
				for (var o in objs) {if(o===obj) return;} objs.push(obj);
				//if(ksxDebug) GM_log("dump " + path);
				
				for (var propName in obj) {
					var propPath = path + "." + propName;
					var propValue = obj[propName];
					
					if(propValue===null) {
						s += "" + propPath +" (undefinied): null" + "\n";
						return;
					}
					var propValueType = typeof propValue;
					switch (propValueType) {
						case "function":return;
						case "object": s += "" + propPath +" ("+ propValueType +"): >>" /*+ propValue.toString().substr(0,20)*/ + "\n";break;
						default:s += "" + propPath +" ("+ propValueType +"): "+ propValue.toString() + "\n";break;
					}
				
					if(obj.propertyIsEnumerable(propName) && !(typeof propValue === "string")) {
						++ind;dump(propValue,propPath);--ind;
					}
				}
			}
			var objs = [];
			var ind = 0;
			var s = "";
			dump(unsafeWindow.seed,"seed");
			//GM_log(s);
		},

		// opens the new message dialog
		newMessage: function () {
			if(ksxDebug) GM_log("Calling ksx.plugins.Toolbar.macros.newMessage()");
			ksx.tools.doUnsafeWindow("modal_messages(); track_chrome_btn('messages_btn'); modal_messages_compose();", true);
		},
		
		// opens the send to alliance dialog
		newMessageAtAlliance: function () {
			if(ksxDebug) GM_log("Calling ksx.plugins.Toolbar.macros.newMessageAtAlliance()");
			var doit = "getMessageWindow(" + ksx.koc.getAllianceId() + ",'Alliance Members','allianceall')";
			//if(ksxDebug) GM_log("doUnsafeWindow "+doit);
			ksx.tools.doUnsafeWindow(doit, true);
		},
		
		newMarch: function (marchType, x, y, troops, res) { ksx.plugins.MarchExtender.march.show(marchType, x, y, troops, res); },

		// template: function(){},

		className: "Macros"
	};
	this.macros = macros;

	this.initUI = function (thisPlugin) {
		if (ksxDebug) GM_log("Calling ToolbarPlugin.initUI");

		var fc = document.body.firstChild;

		var div = document.createElement('div');
		div.id = "ksx_ToolbarPlugin_ToolbarContainer";
		div.setAttribute("style", "line-height: 22px; font-size: small; text-align: left; border-bottom: 1px solid silver; height: 24px; width: 1100px; background: none repeat scroll 0% 0% rgb(223, 223, 255); margin: -2px 0pt 0pt 20px;");
		// div.style.width = '772px';
		// div.style.width = '1100px'; //+ Chat Rechts

		var lines = 1;
		for (var i = 0; i < ksx.configuration.toolbar.items.length; i++) {
			var item = ksx.configuration.toolbar.items[i];
			if (!item) continue; //skip empty item
			if (ksxDebug) GM_log("Create toolbar item: " + item);
			switch (item[0].toLowerCase()) {
				case "button": div.appendChild(ksx.Builder.ToolbarButton(item[2], item[3], item[1])); break;
				case "label": div.appendChild(ksx.Builder.Span(item[2])); break;
				case "html": div.appendChild(ksx.Builder.Span(item[1])); break;
				case "linebreak": lines++; div.appendChild(document.createElement("br")); break; //TODO 
				//				case "popup": break; //TODO           
				case "separator": div.appendChild(ksx.Builder.Span(" | ")); break;
				default: break;
			}
		}

		div.style.height = (lines * 22 + 4) + 'px';

		var ph = document.createElement('div');
		ph.id = "ksx_ToolbarPlugin_NextToolbarPlaceHolder";
		document.body.insertBefore(ph, document.body.firstChild);
		
		document.body.insertBefore(div, ph);
	};

	this.addToolbarItem = function(item) {
		var div = ksx.tools.getElement("ksx_ToolbarPlugin_ToolbarContainer");
		switch (item[0].toLowerCase()) {
			case "button": div.appendChild(ksx.Builder.BlueButton(item[1], item[2])); break;
			case "label" : div.appendChild(ksx.Builder.Span(item[1])); break;
			case "html"  : div.appendChild(ksx.Builder.Span(item[1])); break;
			default: break;
		}
	};

	this.initUI(this);
}

function PowerToolbarPlugin(ksx) {
	
	this.macros = { className: "PowerToolbarPlugin+Macros" };

	this.atSyncButtonClick = function (evt) {
		if (ksxDebug) GM_log("PowerToolbarPlugin.atSyncButtonClick");

		var t = ksx.tools.findParentByTagName(evt.target, "A", true);
		if (!t) { GM_log("Element for event not found!"); return; }

		var id = t.getAttribute("id");
		if (!id) { GM_log("ERROR: Element has no id!"); return; }
		for (var i = 0; i < ksx.configuration.powertoolbar.syncButtons.length; i++) {
			var cfg = ksx.configuration.powertoolbar.syncButtons[i];
			if (cfg[0] === id) {
				var pbButton = document.getElementById(cfg[1]);
				if (!pbButton) { GM_log("ERROR: Element not found! '" + cfg[1] + "'"); return; }
				if (ksxDebug) GM_log("Click: " + cfg[1]);
				ksx.tools.click(pbButton);
				return;
			}
		}
		GM_log("ERROR: Config not found! " + id); return;
	};

	this.updateButtons = function () {
		for (var i = 0; i < ksx.configuration.powertoolbar.syncButtons.length; i++) {
			var cfg = ksx.configuration.powertoolbar.syncButtons[i];
			var ksxpbButton = document.getElementById(cfg[0]);
			if (ksxpbButton) {
				var pbButton = document.getElementById(cfg[1]);
				if (pbButton) {
					ksx.Builder.setToolbarCheckButton(ksxpbButton, String(pbButton[cfg[2]]).search(cfg[3]) != -1);
				} else {
					ksx.Builder.setToolbarCheckButton(ksxpbButton, null);
				}
			}
		}
	};

	this.initUI = function (thisPlugin) {
		if (ksxDebug) GM_log("Calling PowerToolbarPlugin.initUI");

		var div = document.createElement('div');
		div.id = "ksx_PowerToolbarPlugin_ToolbarContainer";
		div.setAttribute("style", "line-height: 22px; font-size: small; text-align: left; border-bottom: 1px solid silver; height: 24px; width: 1100px; background: none repeat scroll 0% 0% rgb(223, 223, 255); margin: -2px 0pt 0pt 20px;");
		// div.style.width = '772px';
		// div.style.width = '1100px'; //+ Chat Rechts

		var lines = 1;
		for (var i = 0; i < ksx.configuration.powertoolbar.items.length; i++) {
			var item = ksx.configuration.powertoolbar.items[i];
			if (!item) continue; //skip empty item
			if (ksxDebug) GM_log("Create toolbar item: " + item);
			switch (item[0].toLowerCase()) {
				case "button": div.appendChild(ksx.Builder.ToolbarButton(item[2], item[3], item[1])); break;
				case "label": div.appendChild(ksx.Builder.Span(item[2])); break;
				case "html": div.appendChild(ksx.Builder.Span(item[1])); break;
				case "linebreak": lines++; div.appendChild(document.createElement("br")); break; //TODO 
				//				case "popup": break; //TODO            
				case "separator": div.appendChild(ksx.Builder.Span(" | ")); break;
				default: break;
			}
		}
		div.style.height = (lines * 22 + 4) + 'px';

		var ph=document.getElementById("ksx_ToolbarPlugin_NextToolbarPlaceHolder");
		document.body.insertBefore(div, ph||document.body.firstChild);
	};

	this.addToolbarItem = function (item) {
		var div = ksx.tools.getElement("ksx_PowerToolbarPlugin_ToolbarContainer");
		switch (item[0].toLowerCase()) {
			case "button": div.appendChild(ksx.Builder.BlueButton(item[1], item[2])); break;
			case "label": div.appendChild(ksx.Builder.Span(item[1])); break;
			case "html": div.appendChild(ksx.Builder.Span(item[1])); break;
			default: break;
		}
	};

	this.updateTimer = function () {
		ksx.plugins.PowerToolbar.updateButtons();
	};

	this.initSync = function (thisPlugin) {
		for (var i = 0; i < ksx.configuration.powertoolbar.syncButtons.length; i++) {
			var cfg = ksx.configuration.powertoolbar.syncButtons[i];
			GM_log("Init toolbarsync: " + cfg[0] + " " + cfg[1]);
			var tbButton = document.getElementById(cfg[0]);
			if (!tbButton) { GM_log("Element not found! '" + cfg[0] + "'"); }
			if (tbButton) { tbButton.addEventListener("click", thisPlugin.atSyncButtonClick, false); }
		}
	};
	this.className = "PowerToolbarPlugin";
	this.initUI(this);
	this.initSync(this);
	window.setInterval(this.updateTimer, 1000);
}

function ChatMonitorPlugin(ksx) {

	this.infoTokens = ["INFO:"]; //Spam vom KoC Power z.B.
	this.attackTokens = ["MÖGLICHER ANGRIFF:", "ALARM:", "*ALARM*", "!!! ACHTUNG = ANGRIFF !!!"];

	this.hooks = [];

	this.AddHook = function (fnc) {
		this.hooks.push(fnc);
	};

	this.Filter = function (name, tokens, conditions, fnc) {
		this.name = name;
		this.tokens = tokens || [];
		this.conditions = conditions || {};
		this.fnc = fnc;
	};

	this.MsgDivWrapper = function (msgdiv) {
		this.msgdiv = msgdiv;
		this.msgType = "unknown"; this.isAlliance = false; this.isDirect = false; this.isNoAlliance = false; this.isGlobal = false;
		if (msgdiv.getAttribute("class") == "chatwrap clearfix") { this.msgType = "alliance"; this.isAlliance = true; }
		else if (msgdiv.getAttribute("class") == "chatwrap clearfix direct") { this.msgType = "direct"; this.isDirect = true; }
		else if (msgdiv.getAttribute("class") == "chatwrap clearfix noalliance") { this.msgType = "noalliance"; this.isNoAlliance = true; }
		else if (msgdiv.getAttribute("class") == "chatwrap clearfix global") { this.msgType = "global"; this.isGlobal = true; }


		if (!this.isNoAlliance) {
			var playerName = ksx.koc.getPlayerName();
			this.img = msgdiv.childNodes[0];
			this.contentDiv = msgdiv.childNodes[1];
			this.infoDiv = msgdiv.childNodes[1].childNodes[0];
			this.whoA = msgdiv.childNodes[1].childNodes[0].childNodes[0];
			this.saysB = msgdiv.childNodes[1].childNodes[0].childNodes[1];
			this.timeSpan = msgdiv.childNodes[1].childNodes[0].childNodes[3];
			this.clearfixDiv = msgdiv.childNodes[1].childNodes[1];
			this.tx = msgdiv.childNodes[1].childNodes[1].childNodes[0];

			this.isOwnEntry = (this.whoA.textContent == playerName);
			this.msgtxt = this.tx.textContent;
		} else {

		}
	};

	this.filters = [];

	//#region Feature: "Cheat Zeit Korrektur"
	this.chatEntryTimeCorrection = function (chatEntry) {
		var enableTimeCorrection = true; // TODO read from Config

		//if(ksxDebug) GM_log("enableTimeCorrection: " + enableTimeCorrection);
		if (!enableTimeCorrection) return;
		if (chatEntry.msgdiv.getAttribute("class") != "chatwrap clearfix" && chatEntry.msgdiv.getAttribute("class") != "chatwrap clearfix direct") return;

		var timeOffset = 9; // TODO read from Config
		var chhmm = ksx.tools.getElement("kochead_time").innerHTML.split(":");
		var cmmm = (60 * chhmm[0]) + (1 * chhmm[1]);

		var timeSpan = chatEntry.msgdiv.childNodes[1].childNodes[0].childNodes[3];
		var hhmm = timeSpan.innerHTML.split(":");
		var hh = (1 * hhmm[0]);
		var mmm = hh * 60 + (1 * hhmm[1]);

		if (Math.abs(cmmm - mmm) > 2) {
			hh += timeOffset; if (hh >= 24) hh -= 24; if (hh < 10) hh = "0" + hh;
			var newTime = hh + ":" + hhmm[1];
			//if(ksxDebug) GM_log("Chat entry: time correction: " + timeSpan.innerHTML + " + Offset " + timeOffset + "h = " + newTime);
			timeSpan.innerHTML = newTime;
		}

	};
	//#endregion

	this.scanChatItem = function (chatEntry, filter) {
		var infoStyle = "background: " + ksx.configuration.chat.backgrounds.InfoBackground;
		var allyAttackStyle = "background: " + ksx.configuration.chat.backgrounds.AllyAttackBackground;
		var ownAttackStyle = "background: " + ksx.configuration.chat.backgrounds.OwnAttackBackground;
		var infoTokens = ksx.plugins.ChatMonitor.infoTokens;
		var attackTokens = ksx.plugins.ChatMonitor.attackTokens;

		if (chatEntry.token0 == infoTokens[0]) {
			/*DEBUGCODE:*/if (ksxDebug) GM_log("INFO token found");
			chatEntry.msgdiv.setAttribute("style", infoStyle);
			return true;
		} else if (chatEntry.token0 == attackTokens[0] && chatEntry.isOwnEntry) {
			/*DEBUGCODE:*/if (ksxDebug) GM_log("ANGRIFF (Selber) token found");
			chatEntry.msgdiv.setAttribute("style", ownAttackStyle);
			return true;
		} else if (chatEntry.token0 == attackTokens[0] && !chatEntry.isOwnEntry) {
			/*DEBUGCODE:*/if (ksxDebug) GM_log("ANGRIFF (Alli) token found");
			chatEntry.msgdiv.setAttribute("style", allyAttackStyle);
			return true;
		}
		return false;
	};

	this.scanAllianceChat = function () {
		//if(ksxDebug) GM_log("ChatMonitorPlugin.scanAllianceChat");

		function setEntryHandled() {
			msgdiv.innerHTML += "<div style='display:none'>Entry processed by ksx</div>";
		}

		var modCommList2 = ksx.tools.getElement("mod_comm_list2");
		for (var i = 0; i < modCommList2.childNodes.length; i++) {
			var msgdiv = modCommList2.childNodes[i];
			if (msgdiv.lastChild.innerHTML == "Entry processed by ksx") return; //allready handled item found => exit loop
			var chatEntry = new ksx.plugins.ChatMonitor.MsgDivWrapper(msgdiv);

			if (chatEntry.isNoAlliance) { setEntryHandled(); continue; }

			//#region Feature: "Cheat Zeit Korrektur"
			ksx.plugins.ChatMonitor.chatEntryTimeCorrection(chatEntry, null);
			//#endregion

			//*DEBUGCODE: if (!chatEntry.isNoAlliance) GM_log("who: " + chatEntry.whoA.textContent + " timeSpan: " + chatEntry.timeSpan.innerHTML + " isOwnEntry: " + chatEntry.isOwnEntry + " context: " + chatEntry.msgType + " \nmsgtxt: " + chatEntry.msgtxt);


			var token = null; var token0 = null;
			for (var k = 0; k < ksx.plugins.ChatMonitor.filters.length; k++) {
				token = null; token0 = null;
				var filter = ksx.plugins.ChatMonitor.filters[k];
				//GM_log("Checking filter: [" + k + "].name: " + filter.name);
				for (var j = 0; j < filter.tokens.length; j++) {
					if (chatEntry.msgtxt.indexOf(filter.tokens[j]) == 0) {
						token = filter.tokens[j];
						token0 = filter.tokens[0];
					}
					if (token != null) break;
				}
				if (token != null) break;
			}
			if (!token) {
				setEntryHandled();
				//GM_log("No token found. filters: (" + ksx.plugins.ChatMonitor.filters.length + ")"); 
				continue;
			}
			chatEntry.token0 = token0;
			chatEntry.token = token;

			/*DEBUGCODE:*/if (ksxDebug) GM_log("Chat token found: " + token + " isOwnEntry: " + isOwnEntry + " context: " + msgType);

			var entryHandled = false;
			for (var k = 0; k < ksx.plugins.ChatMonitor.filters.length; k++) {
				var filter = ksx.plugins.ChatMonitor.filters[k];
				//GM_log("Checking filter: [" + k + "].name: " + filter.name + " tokens: " + filter.tokens);
				if (!filter.tokens) continue;
				if (filter.tokens[0] != token0) continue;
				if (!(typeof filter.isOwnEntry==="undefined") && !(filter.isOwnEntry === null) && filter.isOwnEntry != isOwnEntry) continue;

				entryHandled = filter.fnc(chatEntry, filter);
				if (entryHandled) { entryHandled = true; setEntryHandled(); break; }
			}

			//special case, no token, must be allways the last
			if (entryHandled && chatEntry.isOwnEntry) {
				(function () {
					var ownStyle = "background: " + ksx.configuration.chat.backgrounds.OwnItemBackground;
					chatEntry.msgdiv.setAttribute("style", ownStyle);
				})();
				setEntryHandled();
				continue;
			}

			setEntryHandled();
		}
	};


	this.filters.push(new this.Filter('infoTokens', this.infoTokens, {}, this.scanChatItem));
	this.filters.push(new this.Filter('attackTokens', this.attackTokens, {}, this.scanChatItem));


	if (ksxDebug) GM_log("setInterval scanAllianceChat");
	window.setInterval(this.scanAllianceChat, 5000);
}

function ResourceRequestPlugin(ksx) {

	var atResourceRequestClick = function () {
		if(ksxDebug) GM_log("ResourceRequestPlugin.atResourceRequestClick");
		//var ksx = unsafeWindow.ksx; if (ksx == null) throw "ksx is null!";

		var rrDestination = ksx.tools.getElement("rrDestination");
		var rrGoldAmount  = ksx.tools.getElement("rrGoldAmount");
		var rrFoodAmount  = ksx.tools.getElement("rrFoodAmount");
		var rrWoodAmount  = ksx.tools.getElement("rrWoodAmount");
		var rrStoneAmount = ksx.tools.getElement("rrStoneAmount");
		var rrOreAmount   = ksx.tools.getElement("rrOreAmount");

		var req = ksx.plugins.ResourceRequest.CurrentRequest;

		req.Version = "2";
		req.Destination = rrDestination.value.toLowerCase().replace(/;|-|\//, ",").replace("-", ",").replace("/", ",").replace(/\s+/g, "");
		req.Gold = rrGoldAmount.value.toLowerCase().replace(" ", "").replace("mille", "mio").replace("kk", "mio");
		req.Food = rrFoodAmount.value.toLowerCase().replace(" ", "").replace("mille", "mio").replace("kk", "mio");
		req.Wood = rrWoodAmount.value.toLowerCase().replace(" ", "").replace("mille", "mio").replace("kk", "mio");
		req.Stone = rrStoneAmount.value.toLowerCase().replace(" ", "").replace("mille", "mio").replace("kk", "mio");
		req.Ore = rrOreAmount.value.toLowerCase().replace(" ", "").replace("mille", "mio").replace("kk", "mio");

		var pers = ksx.JSON.stringify(req);
		ksx.logit("save: "+pers);
		GM_setValue("ResourceRequest_" + ksx.koc.getServerId(), pers);

		var mod_comm_input = ksx.tools.getElement("mod_comm_input");
		if (mod_comm_input == null) { alert("mod_comm_input not found!"); return; }

		var sA = "";
		if (req.Gold.length > 0 && req.Gold != 0) sA = sA + (sA.length > 0 ? " + " : "") + "Gold" + " " + req.Gold;
		if (req.Food.length > 0 && req.Food != 0) sA = sA + (sA.length > 0 ? " + " : "") + "Nahrung" + " " + req.Food;
		if (req.Wood.length > 0 && req.Wood != 0) sA = sA + (sA.length > 0 ? " + " : "") + "Holz" + " " + req.Wood;
		if (req.Stone.length > 0 && req.Stone != 0) sA = sA + (sA.length > 0 ? " + " : "") + "Steine" + " " + req.Stone;
		if (req.Ore.length > 0 && req.Ore != 0) sA = sA + (sA.length > 0 ? " + " : "") + "Erz" + " " + req.Ore;
		//if(sA.length==0) return;
		var s = "/a " + "RES ANFRAGE:" + " " + req.Destination + " " + sA;
		ksx.logit("Send: "+s)

		;
		ksx.tools.type(mod_comm_input, s);
		ksx.tools.click(mod_comm_input.nextSibling);

		ksx.tools.getElement("rrContainer").style.display = "none";
		ksx.tools.getElement("//*[@class='comm_body comm_global']").style.display = "";
	};
	this.atResourceRequestClick = atResourceRequestClick;

	this.CurrentRequest = {
		ksxVersion: "2",
		Destination: "xxx,yyy",
		Gold: "",
		Food: "",
		Wood: "",
		Stone: "",
		Ore: "100mio"
	};

	var atShowResourceRequest = function () {
		/*DEBUGCODE:*/if(ksxDebug) GM_log("ResourceRequestPlugin.atShowResourceRequest");
		ksx.tools.getElement("rrContainer").style.display = "";
		ksx.tools.getElement("//*[@class='comm_body comm_global']").style.display = "none";
	};
	this.atShowResourceRequest = atShowResourceRequest;

	var atCloseResourceRequest = function () {
		/*DEBUGCODE:*/if(ksxDebug) GM_log("ResourceRequestPlugin.atCloseResourceRequest");
		ksx.tools.getElement("rrContainer").style.display = "none";
		ksx.tools.getElement("//*[@class='comm_body comm_global']").style.display = "";
	};
	this.atCloseResourceRequest = atCloseResourceRequest;


	this.initUI = function () {
		/*DEBUGCODE:*//*if (ksxDebug)*/ GM_log("ResourceRequestPlugin.initUI");

		var koc_comm_tabs = ksx.tools.getElement("comm_tabs");
		if (!koc_comm_tabs) { throw "Element 'koc_comm_tabs' not found! Maybe KoC has some changes."; }
		var mod_comm = ksx.tools.getElement("//*[@class='mod_comm']");
		if (!mod_comm) { throw "Element 'mod_comm' not found! Maybe KoC has some changes."; }

		// Append the "Anfrage" Tab
		var btn = ksx.Builder.ComTabButton("Ressourcen Anfrage", "ksx.plugins.ResourceRequest.atShowResourceRequest();return false;");
		koc_comm_tabs.appendChild(btn);


		// Append the "Anfrage" form
		var htmlTemplate = "<div id='rrContainer' style='position: relative; top: 96px; border: 1px solid #A56631; height: 350px; margin-left: 10px;margin-top: 84x; overflow-x: hidden; overflow-y: hidden; position: relative; width: 340px;'><table style='width: 100%'><tr><td><span style='font-weight: bold'>RESSOURCEN-ANFRAGE </span></td><td style='text-align: right'><a href='#' onclick='ksx.plugins.ResourceRequest.atCloseResourceRequest();return false;'><img src='http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/close_icon.png' alt='X' /></a></td></tr></table><table><tbody><tr align='center'><td><img src='http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/food_30.png'></td><td>Menge:<input id='rrFoodAmount' type='text' value='0' maxlength='11' size='11'></td></tr><tr align='center'><td><img src='http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/wood_30.png'></td><td>Menge:<input id='rrWoodAmount' type='text' value='0' maxlength='11' size='11'></td></tr><tr align='center'><td><img src='http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/stone_30.png'></td><td>Menge:<input id='rrStoneAmount' type='text' value='0' maxlength='11' size='11'></td></tr><tr align='center'><td><img src='http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/iron_30.png'></td><td>Menge:<input id='rrOreAmount' type='text' value='0' maxlength='11' size='11'></td></tr><tr align='center'><td><img src='http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/gold_30.png'></td><td>Menge:<input id='rrGoldAmount' type='text' value='0' maxlength='11' size='11'></td></tr></tbody></table><div style='margin-bottom: 10px; display: none'><span id='rrCityTo'><input id='rrTraderTo_0' class='castleBut castleButNon' type='submit' value='1'><input id='rrTraderTo_1' class='castleBut castleButNon' type='submit' value='2'><input id='rrTraderTo_2' class='castleBut castleButNon' type='submit' value='3'><input id='rrTraderTo_3' class='castleBut castleButNon' type='submit' value='4'><input id='rrTraderTo_4' class='castleBut castleButNon' type='submit' value='5'><input id='rrTraderTo_5' class='castleBut castleButNon' type='submit' value='6'><input id='rrTraderTo_6' class='castleBut castleButNon' type='submit' value='7'><span id='rrTraderToCityName' style='display: inline-block; width: 85px; font-weight: bold;'></span></span></div><div>Ziel-Koordinate:<input id='rrDestination' type='text' maxlength='7' size='7'></div><br/><span><a class='button20' onclick='ksx.plugins.ResourceRequest.atResourceRequestClick();return false;'><span>Anfrage Senden</span></a></span></div>";
		var div = ksx.Builder.Element("div", htmlTemplate);
		div.setAttribute("id", "rrContainer"); //WORKARROUND id from template is not pressent!?
		div.style.display = "none"; // hide on init
		mod_comm.appendChild(div);

		var s = GM_getValue("ResourceRequest_" + ksx.koc.getServerId());
		// GM_log("Load ResourceRequest:" + s);

		var rrDestination = ksx.tools.getElement("rrDestination");
		var rrGoldAmount = ksx.tools.getElement("rrGoldAmount");
		var rrFoodAmount = ksx.tools.getElement("rrFoodAmount");
		var rrWoodAmount = ksx.tools.getElement("rrWoodAmount");
		var rrStoneAmount = ksx.tools.getElement("rrStoneAmount");
		var rrOreAmount = ksx.tools.getElement("rrOreAmount");

		if (s != null) {
			var rr = ksx.JSON.parse(s);
			if (ksxDebug) GM_log("Output: " + typeof (rr.ksxVersion));
			if (typeof (rr.ksxVersion) != "string" || rr.ksxVersion != "2") {
				rrDestination.value = "xxx,yyy";
				rrGoldAmount.value = "";
				rrFoodAmount.value = "";
				rrWoodAmount.value = "";
				rrStoneAmount.value = "";
				rrOreAmount.value = "100mio";
			} else {
				rrDestination.value = rr.Destination;
				rrGoldAmount.value = rr.Gold;
				rrFoodAmount.value = rr.Food;
				rrWoodAmount.value = rr.Wood;
				rrStoneAmount.value = rr.Stone;
				rrOreAmount.value = rr.Ore;
			}
		} else {
			rrDestination.value = "xxx,yyy";
			rrGoldAmount.value = "";
			rrFoodAmount.value = "";
			rrWoodAmount.value = "";
			rrStoneAmount.value = "";
			rrOreAmount.value = "100mio";
		}
	};

	this.requestTokens = ['RES ANFRAGE:', "*ANFRAGE*"];
	this.acknowledgeTokens = ["RES BESTÄTIGUNG:", "*BESTÄTIGUNG*", "RES BESTÄTIGT:", "BESTÄTIGT:"];
	this.deliveryTokens = ["RES LIEFERUNG:", "*LIEFERUNG*"];
	this.foodLowTokens = ["Mein Heiligtum"]; //TODO: Mein Heiligtum {City} (X,Y) hat zu wenig Nahrung sie reicht noch für 1,541,348 (2h 40m) - Verbrauch: -577,150

	this.atRequestEntry = function(msg, filter) { // requestTokens && !isOwnEntry
		/*DEBUGCODE:*/if (ksxDebug) GM_log("ANFRAGE token found");
		var reqStyle = "background: " + ksx.configuration.chat.backgrounds.RequestItemBackground;
		var acknowledgeTokens = ksx.plugins.ResourceRequest.acknowledgeTokens;
		
		var ackdiv = document.createElement('div');
		var tReqR = msg.msgtxt;
		var t1R = tReqR.indexOf(msg.token);
		tReqR = tReqR.substring(t1R, tReqR.length);
		var t2R = tReqR.indexOf("'");
		if (t2R >= 0) tReqR = tReqR.substr(0, t2R);

		var tAck = tReqR.replace(msg.token, acknowledgeTokens[0]);
		var cA = "var chat = document.getElementById('mod_comm_input'); chat.value = '" + tAck + "';chat.focus();return false;";
		ackdiv.appendChild(ksx.Builder.BlueButton("Bestätigen", cA));
		
		msg.msgdiv.appendChild(ackdiv);
		msg.msgdiv.setAttribute("style", reqStyle);
		return true;
	};

	this.scanChatItem = function (msg, filter) {
		/*DEBUGCODE:*/if (ksxDebug) GM_log("ResourceRequestPlugin.scanChatItem");
		
		var ackStyle = "background: " + ksx.configuration.chat.backgrounds.RequestItemBackground;
		var dlyStyle = "background: " + ksx.configuration.chat.backgrounds.RequestItemBackground;
		var allyFoodLowStyle = "background: " + ksx.configuration.chat.backgrounds.RequestItemBackground;
		var ownFoodLowStyle = "background: " + ksx.configuration.chat.backgrounds.OwnAttackBackground;

		var requestTokens = ksx.plugins.ResourceRequest.requestTokens;
		var acknowledgeTokens = ksx.plugins.ResourceRequest.acknowledgeTokens;
		var deliveryTokens = ksx.plugins.ResourceRequest.deliveryTokens;
		var foodLowTokens = ksx.plugins.ResourceRequest.foodLowTokens;

		//		var token0=msg.token0;
		//		var isOwnEntry = msg.isOwnEntry;
		//		var token = msg.token;

		if (msg.token0 == requestTokens[0] && !msg.isOwnEntry) {
			return this.atRequestEntry(msg, filter);
		} else if (msg.token0 == acknowledgeTokens[0] && msg.isOwnEntry) {
			/*DEBUGCODE:*/if (ksxDebug) GM_log("BESTÄTIGUNG token found");
			var dlydiv = document.createElement('div');
			var tAckM = msg.msgtxt;
			var t1A = tAckM.indexOf(msg.token);
			tAckM = tAckM.substring(t1A, tAckM.length);
			var t2A = tAckM.indexOf("'");
			if (t2A >= 0) tAckM = tAckM.substr(0, t2A);

			var goldAmount = 0;
			var foodAmount = 0;
			var woodAmount = 0;
			var stoneAmount = 0;
			var oreAmount = 0;
			var x; var y;

			var xyPattern = /([0-9]{1,3})\s*(,|-)\s*([0-9]{1,3})/;
			var match = xyPattern.exec(msg.msgtxt);
			if (match === null) return false;
			x = match[1]; y = match[3];

			var pattern = /(Nahrung|Futter|Food|Erz|Ore|Holz|Wood|Steine|Stein|Stone|Gold)\s*([0-9]+)(mio|mrd|bio|M|G|T|kkkk|kkk|kk|k)/gi;
			while (match = pattern.exec(msg.msgtxt)) {
				var res = match[1];
				var amount = match[2];
				var unit = match[3];
				var amountB;
				switch (unit.toLowerCase()) {
					case "k": amountB = amount * 1000; break;
					case "m": case "mio": case "kk": amountB = amount * 1000000; break;
					case "g": case "mrd": case "kkk": amountB = amount * 1000000000; break;
					case "t": case "bio": case "kkkk": amountB = amount * 1000000000000; break;
					default: amountB = amount * 1;
				}

				switch (res.toLowerCase()) {
					case "gold": goldAmount = amountB; break;
					case "nahrung": case "futter": case "food": foodAmount = amountB; break;
					case "holz": case "wood": woodAmount = amountB; break;
					case "steine": case "stein": case "stone": stoneAmount = amountB; break;
					case "erz": case "ore": oreAmount = amountB; break;
					default: break;
				}
			}

			var tDly = tAckM.replace(msg.token, deliveryTokens[0]);
			var cD = " \
				ksx.plugins.MarchExtender.march.show(1, " + x + ", " + y + ", [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [" + goldAmount + ", " + foodAmount + ", " + woodAmount + ", " + stoneAmount + ", " + oreAmount + "]); \
				ksx.plugins.MarchExtender.march.transportTools.calculateFastestTroopsForTransport(); \
				var chat = document.getElementById('mod_comm_input'); \
				chat.value = '" + tDly + " / ??min';chat.focus(); \
				return false;";
			dlydiv.appendChild(ksx.Builder.GreenButton("Liefern", cD));
			msg.msgdiv.appendChild(dlydiv);
			msg.msgdiv.setAttribute("style", ackStyle);
			return true;
		} else if (msg.token0 == deliveryTokens[0] && !msg.isOwnEntry) {
			/*DEBUGCODE:*/if (ksxDebug) GM_log("LIEFERUNG token found");
			msg.msgdiv.setAttribute("style", dlyStyle);
			return true;
		} else if (msg.token0 == foodLowTokens[0] && msg.isOwnEntry) {
			/*DEBUGCODE:*/if (ksxDebug) GM_log("FoodLow (Own) token found");
			msg.msgdiv.setAttribute("style", ownFoodLowStyle);
			return true;
		} else if (msg.token0 == foodLowTokens[0] && !msg.isOwnEntry) {
			/*DEBUGCODE:*/if (ksxDebug) GM_log("FoodLow (Alli) token found");
			// Mein Heiligtum TEST (777,888) hat zu wenig Nahrung sie reicht noch für 1,234,567 (1h 33m) - Verbrauch: -666,777
			(function () {
				var pattern = /.*\(([0-9]{1,3})\s*(,|-)\s*([0-9]{1,3})\).*für\s([0-9,]+)\s\(([0-9\shms]+)\).*Verbrauch:\s([0-9,-]+)/img;
				var match = pattern.exec(msg.msgtxt);

				var x = match[1];
				var y = match[3];
				var foodleft = match[4].replace(",", "").replace(",", "").replace(",", "").replace(",", "").replace(",", "");
				var timeleft = match[5];
				var foodconsumption = match[6].replace(",", "").replace(",", "").replace(",", "").replace(",", "").replace(",", "");

				var foodAmount = -1 * foodconsumption * 8;

				if (ksxDebug) GM_log("FoodLow (Alli): " + x + "," + y + " " + foodleft + " " + timeleft + " " + foodconsumption + "/h -> " + foodAmount);

				msg.msgdiv.setAttribute("style", allyFoodLowStyle);

				var actiondiv = document.createElement('div');

				// Bestätigung
				var tAck = acknowledgeTokens[0] + " " + x + "," + y + " " + "Nahrung" + " " + foodAmount;
				var cA = "var chat = document.getElementById('mod_comm_input'); chat.value = '" + tAck + "';chat.focus(); return false;";
				actiondiv.appendChild(ksx.Builder.GreenButton("Bestätigen", cA));

				// Lieferung
				var tDly = deliveryTokens[0] + " " + x + "," + y + " " + "Nahrung" + " " + foodAmount + " /??min";
				var cDt = "\
					ksx.plugins.MarchExtender.march.show(1, " + x + ", " + y + ", [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, " + foodAmount + ", 0, 0, 0]); \
					ksx.plugins.MarchExtender.march.transportTools.calculateFastestTroopsForTransport(); \
					var chat = document.getElementById('mod_comm_input'); chat.value = '" + tDly + "'; \
					return false;";
				actiondiv.appendChild(ksx.Builder.GreenButton("Liefern", cDt));

				msg.msgdiv.appendChild(actiondiv);
			})();
			return true;
		}
		return false;
	};

	this.initUI();
	ksx.plugins.ChatMonitor.filters.push(new ksx.plugins.ChatMonitor.Filter('requestTokens', this.requestTokens, {isOwnEntry:false}, this.atRequestEntry));
	ksx.plugins.ChatMonitor.filters.push(new ksx.plugins.ChatMonitor.Filter('acknowledgeTokens', this.acknowledgeTokens, {}, this.scanChatItem));
	ksx.plugins.ChatMonitor.filters.push(new ksx.plugins.ChatMonitor.Filter('deliveryTokens', this.deliveryTokens, {}, this.scanChatItem));
	ksx.plugins.ChatMonitor.filters.push(new ksx.plugins.ChatMonitor.Filter('foodLowTokens', this.foodLowTokens, {}, this.scanChatItem)); 

};




function MarchExtenderPlugin(ksx) {
	var thisPlugin = this;

	this.march = {
		type: 0,
		ui: null,

		transportTools: {
			uiElement: null,
			uiElementId: "ksxTransportTools",

			hide: function () {
				//if(ksxDebug) GM_log("MarchExtenderPlugin.march.transportTools.hide()");
				uiElement = ksx.tools.getElement("ksxTransportTools");
				if (!uiElement) return;
				uiElement.style.display = "none";
			},

			show: function (visible) {
				if (ksxDebug) GM_log("MarchExtenderPlugin.march.transportTools.show(" + Boolean(visible) + ")");
				var t = ksx.plugins.MarchExtender.march.transportTools;
				uiElement = document.getElementById(t.uiElementId);
				if (!uiElement) uiElement = t.create();
				t.uiElement.style.display = ((visible) ? "" : "none");
			},

			create: function (visible) {
				if (ksxDebug) GM_log("MarchExtenderPlugin.march.transportTools.create(" + Boolean(visible) + ")");
				var t = ksx.plugins.MarchExtender.march.transportTools;
				t.uiElement = document.getElementById(t.uiElementId);
				if (t.uiElement) return t.uiElement;

				var myString = " \
					<div class='section' style='height: 100'> \
						<div class='section_title'>Transport tools</div> \
						<div class='section_content' style='height:100px'> \
							<a class='button20' href='#' onclick='ksx.plugins.MarchExtender.march.transportTools.calculateFastestTroopsForTransport();return false;'><span>Truppen Berechnen</span></a> \
							<a class='buttonGreen20' style='display:inline; position:absolute;margin-left:4px' href='#' onclick='ksx.plugins.MarchExtender.march.transportTools.calculateFastestTroopsForTransportHelp();return false;'><span>?</span></a> \
							<br/><br/> \
							<span> \
								Vordefinierte Transporte:<br/>  \
								<select onchange='ksx.plugins.MarchExtender.march.transportTools.atTransportTemplateChanged(this);return false;'> \
										<option value=''><option> \
									<optgroup label='Training (für 4 Hütten/Bevölkerung 18000)'> \
										<option value='0,1400000,2700000,0,180000'>Versorgungstruppe (18k)</option>	 \
										<option value='0,1940000,1800000,0,900000'>Milizsoldat (18k)</option> \
										<option value='0,2660000,1800000,0,2700000'>Späher (18k)</option> \
										<option value='0,3200000,9000000,0,1800000'>Lanzenträger (18k)</option>	 \
										<option value='0,4100000,2700000,0,7200000'>Schwertkämpfer (18k)</option> \
										<option value='0,2700000,3150000,0,2700000'>Bogenschütze (9k)</option> \
										<option value='0,6500000,3600000,0,3000000'>Kavallerie (6k)</option>	 \
										<option value='0,6500000,1500000,0,7500000'>Schwere Kavallerie (3000)</option> \
										<option value='0,2700000,6750000,0,1575000'>Versorgungswagen (4500)</option> \
										<option value='0,7250000,8100000,0,4860000'>Ballisten (2700)</option> \
										<option value='0,6500000,9000000,0,2250000'>Rammbock (1500)</option> \
										<option value='0,5000000,5000000,8000000,1200000'>Steinschleuder (1000)</option> \
									</optgroup> \
									<optgroup label='Zuletzt verwendet'> \
										<option value='0,1500000000,0,0,0'>Nahrung 1500mio</option>	 \
									</optgroup> \
								</select> \
									<a class='buttonGreen20' style='display:inline; position:absolute;margin-left:4px' href='#' onclick='ksx.plugins.MarchExtender.march.transportTools.transportTemplateHelp();return false;'><span>?</span></a> \
							</span> \
						</div> \
					</div> \
					";
				var modalAttackTransport = ksx.tools.getElement("modal_attack_transport");
				t.uiElement = ksx.Builder.Element("div", myString);
				t.uiElement.setAttribute("id", t.uiElementId);
				t.uiElement.style.display = ((visible) ? "" : "none");
				modalAttackTransport.parentNode.appendChild(t.uiElement);
				return t.uiElement;
			},
			
			calculateFastestTroopsForTransport: function () {
				if (ksxDebug) GM_log("MarchExtenderPlugin.march.transportTools.calculateFastestTroopsForTransport");
				ui = new ksx.koc.MarchUI();

				var fp = unsafeWindow.seed.tech["tch10"]; // Level Federgewicht-Pulver
				var maxUnits = Number(ui.maxUnit.textContent);
				var hKavLoad = 80;
				var wagonLoad = 5000;
				var kavLoad = 100;
				var scoutLoad = 5;
				var m = 1 * ui.gold.value + 1 * ui.food.value + 1 * ui.wood.value + 1 * ui.stone.value + 1 * ui.ore.value;

				var cHKav = Math.ceil(m / (hKavLoad * (1 + fp / 10)));
				var cWagon = Math.ceil(m / (wagonLoad * (1 + fp / 10)));
				var cKav = Math.ceil(m / (kavLoad * (1 + fp / 10)));
				var cScout = Math.ceil(m / (scoutLoad * (1 + fp / 10)));

				ui.unitIpt1.value = 0; ksx.tools.typeKeys2(ui.unitIpt1, "0");
				ui.unitIpt2.value = 0; ksx.tools.typeKeys2(ui.unitIpt2, "0");
				ui.unitIpt3.value = 0; ksx.tools.typeKeys2(ui.unitIpt3, "0");
				ui.unitIpt4.value = 0; ksx.tools.typeKeys2(ui.unitIpt4, "0");
				ui.unitIpt5.value = 0; ksx.tools.typeKeys2(ui.unitIpt5, "0");
				ui.unitIpt6.value = 0; ksx.tools.typeKeys2(ui.unitIpt6, "0");
				ui.unitIpt7.value = 0; ksx.tools.typeKeys2(ui.unitIpt7, "0");
				ui.unitIpt8.value = 0; ksx.tools.typeKeys2(ui.unitIpt8, "0");
				ui.unitIpt9.value = 0; ksx.tools.typeKeys2(ui.unitIpt9, "0");
				ui.unitIpt10.value = 0; ksx.tools.typeKeys2(ui.unitIpt10, "0");
				ui.unitIpt11.value = 0; ksx.tools.typeKeys2(ui.unitIpt11, "0");
				ui.unitIpt12.value = 0; ksx.tools.typeKeys2(ui.unitIpt12, "0");

				if (cScout < Number(ui.unitnum3.textContent) && cScout < maxUnits) ksx.tools.typeKeys2(ui.unitIpt3, cScout);
				else if (cKav < Number(ui.unitnum7.textContent) && cKav < maxUnits) ksx.tools.typeKeys2(ui.unitIptt7, cKav);
				else if (cHKav < Number(ui.unitnum8.textContent) && cHKav < maxUnits) ksx.tools.typeKeys2(ui.unitIpt8, cHKav);
				else if (cWagon < Number(ui.unitnum9.textContent) && cWagon < maxUnits) ksx.tools.typeKeys2(ui.unitIpt9, cWagon);
			},
			calculateFastestTroopsForTransportHelp: function () {
				ksx.Builder.showDialog("Truppen Berechnen", "Berechnet für die angegebenen Mengen, die schnellste Transportmöglichkeit.");
			},
			transportTemplateHelp: function () {
				ksx.Builder.showDialog("Vordefinierte Transporte", "Enthält ein Liste mit vordefinierte Transporten. Truppentrainingstransporte sind berechnet für 4 Hütten.");
			},

			atTransportTemplateChanged: function (sender) {
				if (ksxDebug) GM_log("MarchExtenderPlugin.march.transportTools.atTransportTemplateChanged(" + sender + ")");
				ui = new ksx.koc.MarchUI();
				var selectedValue = sender.options[sender.selectedIndex].value;
				var res = selectedValue.split(",");
				ui.gold.value = ""; ksx.tools.typeKeys2(ui.gold, res[0]);
				ui.food.value = ""; ksx.tools.typeKeys2(ui.food, res[1]);
				ui.wood.value = ""; ksx.tools.typeKeys2(ui.wood, res[2]);
				ui.stone.value = ""; ksx.tools.typeKeys2(ui.stone, res[3]);
				ui.ore.value = ""; ksx.tools.typeKeys2(ui.ore, res[4]);

				ksx.plugins.MarchExtender.march.transportTools.calculateFastestTroopsForTransport();
			},
			className: "MarchExtenderPlugin+TransportTools"
		},

		attachXYPaste: function (xId, yId, func) {
			// thx (c) unchanged from [KoC Attack - Deutsch] 
			var x = document.getElementById(xId);
			if (!x) {
				//this.Log('Auto Attack: kann X Koordinaten Box nicht finden: ' + xId);
				return;
			}
			var attached = x.getAttribute('KOCpasteAttached');
			if (attached) return;
			x.setAttribute('maxlength', '20');

			var onchange = function () {
				var xValue = x.value.trim();
				var xI = /^\s*([0-9]+)[\s|,|-|.]+([0-9]+)/.exec(xValue);
				if (xI) {
					var y = document.getElementById(yId);
					x.value = xI[1];
					y.value = xI[2];

					if (func != undefined) func(xI[0], xI[1]);
				}
			};
			x.setAttribute('KOCpasteAttached', true);
			x.addEventListener('keyup', function () { onchange(); }, false);
			x.addEventListener('change', function () { onchange(); }, false);
		},
		show: function (type, x, y, troops, res) {
			// marchType: 1-Transport, 2-Reinforce, 3-Scout, 4-Attack, 5-Reassign
			// x,y
			// troops: array[12]
			// res: array[gold,food,wood,stone,ore]
			if (ksxDebug) GM_log("MarchExtenderPlugin.newMarch(...)");
			if (type === 'repeatlast' || type === 'repeatlast!') {
				var s = GM_getValue("LastMarch_" + ksx.koc.getServerId());
				if (!s) { /*No configuration*/return; };
				var cfg = ksx.JSON.parse(s);
				type = cfg[0];
				if (!x) x = cfg[1]; // param x will overwride cfg value
				if (!y) y = cfg[2]; // param y will overwride cfg value
				troops = cfg[3];
				res = cfg[4];
				if (!type) type = 1/*Transport*/;
				ksx.tools.doUnsafeWindow("modal_attack(" + type + "," + x + "," + y + ")", true);
			}
			else {
				ksx.tools.doUnsafeWindow("modal_attack(" + type + ", '" + x + "', '" + y + "')", true);
			}
			ksx.plugins.MarchExtender.march.type = type;
			if (typeof ksx.plugins.MarchExtender.original_modal_attack === "undefined") ksx.plugins.MarchExtender.march.init(type); //WORKAROUND if hooks not enabled
			ksx.plugins.MarchExtender.march.fill(type, x, y, troops, res);
		},
		init: function (type) {
			if (typeof type == "undefined") type = ksx.koc.getCurrentMarchType();

			//add tab handler
			for (var i = 1; i < 6; i++) document.getElementById('modal_attack_tab_' + i).addEventListener('click', ksx.plugins.MarchExtender.march.atMarchTypeChanged, false);
			//add "March" click handler
			document.getElementById('btnMarch').addEventListener('click', ksx.plugins.MarchExtender.march.atMarchClicked, false);


			//TODO: create option
			ksx.tools.uncheck("modal_attack_supplyfilter_checkbox");

			//TODO: create option
			ksx.plugins.MarchExtender.march.transportTools.show((type == 1/*Transport*/ || type == 2/*Reinforce*/ || type == 5/*Reassign*/));

			if (!ksx.compatibility.disableMarchXYPaste)
				ksx.plugins.MarchExtender.march.attachXYPaste('modal_attack_target_coords_x', 'modal_attack_target_coords_y');
		},
		saveConfig: function () {
			if (ksxDebug) GM_log("MarchExtenderPlugin.saveMarchConfig()");
			var t = ksx.plugins.MarchExtender.march.transportTools;
			ui = new ksx.koc.MarchUI();

			var cfg = [
				ui.getMarchType(),
				ui.targetCoordsX.value, ui.targetCoordsY.value,
				[ui.unitIpt1.value, ui.unitIpt2.value, ui.unitIpt3.value, ui.unitIpt4.value, ui.unitIpt5.value, ui.unitIpt6.value, ui.unitIpt7.value, ui.unitIpt8.value, ui.unitIpt9.value, ui.unitIpt10.value, ui.unitIpt11.value, ui.unitIpt12.value],
				[ui.gold.value, ui.food.value, ui.wood.value, ui.stone.value, ui.ore.value],
				[]
			];

			var s = ksx.JSON.stringify(cfg);
			/*if (ksxDebug) */GM_log("Save 'LastMarch': " + s);
			GM_setValue("LastMarch_" + ksx.koc.getServerId(), s);
		},

		fill: function (type, x, y, troops, res) {
			var ui = new ksx.koc.MarchUI();
			if (!type) type = 1;

			if (type == 1/*Transport*/) {
				ksx.tools.uncheck(ui.supplyfilterCheckbox);
			}

			ui.unitIpt1.value = ""; ksx.tools.typeKeys2(ui.unitIpt1, troops[0]);
			ui.unitIpt2.value = ""; ksx.tools.typeKeys2(ui.unitIpt2, troops[1]);
			ui.unitIpt3.value = ""; ksx.tools.typeKeys2(ui.unitIpt3, troops[2]);
			ui.unitIpt4.value = ""; ksx.tools.typeKeys2(ui.unitIpt4, troops[3]);
			ui.unitIpt5.value = ""; ksx.tools.typeKeys2(ui.unitIpt5, troops[4]);
			ui.unitIpt6.value = ""; ksx.tools.typeKeys2(ui.unitIpt6, troops[5]);
			ui.unitIpt7.value = ""; ksx.tools.typeKeys2(ui.unitIpt7, troops[6]);
			ui.unitIpt8.value = ""; ksx.tools.typeKeys2(ui.unitIpt8, troops[7]);
			ui.unitIpt9.value = ""; ksx.tools.typeKeys2(ui.unitIpt9, troops[8]);
			ui.unitIpt10.value = ""; ksx.tools.typeKeys2(ui.unitIpt10, troops[9]);
			ui.unitIpt11.value = ""; ksx.tools.typeKeys2(ui.unitIpt11, troops[10]);
			ui.unitIpt12.value = ""; ksx.tools.typeKeys2(ui.unitIpt12, troops[11]);

			ui.targetCoordsX.value = ""; ksx.tools.typeKeys2(ui.targetCoordsX, x);
			ui.targetCoordsY.value = ""; ksx.tools.typeKeys2(ui.targetCoordsY, y);

			if (type == 1/*Transport*/ || type == 2/*Reinforce*/ || type == 5/*Reassign*/) {
				ui.gold.value = ""; ksx.tools.typeKeys2(ui.gold, res[0]);
				ui.food.value = ""; ksx.tools.typeKeys2(ui.food, res[1]);
				ui.wood.value = ""; ksx.tools.typeKeys2(ui.wood, res[2]);
				ui.stone.value = ""; ksx.tools.typeKeys2(ui.stone, res[3]);
				ui.ore.value = ""; ksx.tools.typeKeys2(ui.ore, res[4]);
			}

			if (type == 4/*Attack*/) {
				// ui.attackKnight.selectedIndex = ui.attackKnight.options.length - 1; // select last
			}
		},

		atMarchTypeChanged: function (evt) {
			if (ksxDebug) GM_log("MarchExtenderPlugin.atMarchTypeChanged");
			type = parseInt(evt.target.id.substr(17)); //modal_attack_tab_{marchType}
			var ui = new ksx.koc.MarchUI();

			//TODO create config option
			ksx.plugins.MarchExtender.march.transportTools.show((type == 1/*Transport*/ || type == 2/*Reinforce*/ || type == 5/*Reassign*/));

			if (type == 3/*Scout*/) {
				//TODO create config option	
				ui.unitIpt3.value = ""; ksx.tools.typeKeys2(ui.unitIpt3, 1);
			}
			if (type == 1/*Transport*/) {
				//TODO create config option
				ksx.tools.uncheck(ui.supplyfilterCheckbox);
			}

			switch (type) {
				case 1/*Transport*/: break;
				case 2/*Reinforce*/: break;
				case 3/*Scout    */: break;
				case 4/*Attack   */: break;
				case 5/*Reassign */: break;
				default: break;
			}
		},
		atMarchClicked: function () {
			if (ksxDebug) GM_log("MarchExtenderPlugin.atMarchClicked()");
			ksx.plugins.MarchExtender.march.saveConfig();
		},

		className: "MarchExtenderPlugin+March"
	},

	this.unsafeModalAttackHook = function (marchType, x, y) {
		//if(ksxDebug) GM_log("MarchExtenderPlugin.unsafeModalAttackHook(..)");

		/*ORIGINAL CALL*/
		var ret = ksx.plugins.MarchExtender.original_modal_attack(marchType, x, y);
		/*WORKAROUND  [Power]*/
		if (typeof attackDialog_hook === "function") attackDialog_hook(marchType, x, y); // 

		ksx.plugins.MarchExtender.march.init(marchType);
		return ret;
	};
	
	this.unsafeModalAttackCheckHook=function() {
		/*WORKAROUND [Power]*/ 
		if(typeof modalAttack_hook === "function") modalAttack_hook();
		/*NEWCALL*/ 
		ksx.plugins.MarchExtender.saveMarchConfig();
		/*ORIGINALCALL*/
		var ret=ksx.plugins.MarchExtender.original_modal_attack_check();
		return ret;
	};

	this.setHooks = function () {
		if(ksxDebug) GM_log("MarchExtenderPlugin.setHooks");
		if (typeof unsafeWindow.modal_attack != "function") {/*UUPS*/GM_log("Check KoC: 'modal_attack' not found!");return;}

		thisPlugin.original_modal_attack = unsafeWindow.modal_attack;
		unsafeWindow.modal_attack = this.unsafeModalAttackHook;

//      not used! event handler attached instead
//		thisPlugin.original_modal_attack_check = unsafeWindow.modal_attack_check;
//		unsafeWindow.modal_attack_check = this.unsafeModalAttackCheckHook;
	};
	
	// @PDX: Schau mal bitte, wenn ich meine hooks setze, funktionieren deine hooks nicht mehr.
	// die WORKAROUNDs rufen als Notlösung zwar deine Funktionen auf, aber eine sauber Lösung  ist das leider nicht.
	thisPlugin.setHooks();

	if (ksx.plugins.Toolbar != null) {
		var ksxMarchExtenderRepeatOpen = document.getElementById("ksxMarchExtenderRepeatOpen");
		if (ksxMarchExtenderRepeatOpen) ksxMarchExtenderRepeatOpen.addEventListener("click", function () { thisPlugin.march.show('repeatlast', '', '', [], []); }, false);
		var ksxMarchExtenderRepeatMarch = document.getElementById("ksxMarchExtenderRepeatMarch");
		if (ksxMarchExtenderRepeatMarch) ksxMarchExtenderRepeatOpen.addEventListener("click", function () { thisPlugin.march.show('repeatlast!', '', '', [], []); }, false);
	}
}

//function userFunctionB() {
//	Selenium.click("mod_views_city");
//	var rallyPointId = Selenium.getAttribute("//a[@class='bldg_12_11' or @class='bldg_12_10' or @class='bldg_12_9' or @class='bldg_12_8' or @class='bldg_12_7' or @class='bldg_12_6' or @class='bldg_12_5' or @class='bldg_12_4' or @class='bldg_12_3' or @class='bldg_12_2' or @class='bldg_12_1']@id");
//	Selenium.click(rallyPointId);
//	Selenium.waitforElementPresent("//*[@id='modal_rallypoint_tabs']/a[3]/span"); // "css=#modal_rallypoint_tabs > a.button20 > span"
//	Selenium.click("//*[@id='modal_rallypoint_tabs']/a[3]/span");
//	//Selenium.waitforElementPresent("modal_attack_tab_1");
//	Selenium.click("modal_attack_tab_1");
//	Selenium.click("modal_attack_supplyfilter_checkbox");
////	Selenium.click("ptatp_${CityIndex}");
////	var x = Selenium.getValue("modal_attack_target_coords_x");
//	//	var y = Selenium.getValue("modal_attack_target_coords_y");
//	Selenium.type("modal_attack_rec1", "12345");
////	Selenium.type("modal_attack_rec1", "${TransportFood}");
////	Selenium.type("modal_attack_rec2", "${TransportWood}");
////	Selenium.type("modal_attack_rec3", "${TransportStone}");
////	Selenium.type("modal_attack_rec4", "${TransportOre}");
////	Selenium.click("modal_attack_unit_ipt8");
////	Selenium.type("modal_attack_unit_ipt8", "${HCav}");
////	Selenium.typeKeys("modal_attack_rec4", ".");
////	Selenium.click("btnMarch");
//}
// END KOC BUTTLER

var TestSomething = {
  init : function (){
    t = TestSomething;
return;    
    var ft = unsafeWindow.modal_messages.toString().replace (/}\s*$/, 'TESTmyHook(); }');
//    logit ('FT: modal_messages = '+ ft);
    unsafeWindow.TESTmyHook = t.hook;
/***
var scr = document.createElement('script');   
scr.innerHTML = 'modal_messages = '+ ft;
document.body.appendChild(scr);
setTimeout ( function (){document.body.removeChild(scr);}, 500);
***/
//with (unsafeWindow){
//  eval ('unsafeWindow.modal_messages = '+ ft);
//  eval ('modal_messages = function (){alert("xxx")}');
logit ("WITH");
  unsafeWindow.modal_messages = eval ('function (){alert("xxx")}');
logit ("EVALED");
//}
setTimeout ( function(){
  var ft=unsafeWindow.modal_messages.toString(); 
  logit('unsafeWindow.modal_messages:\n'+ ft.substr(ft.length-500));
}, 100);
  },
  
  hook : function (){
    logit ('TestSomething.hook');
    logit ('tvuid: '+ tvuid);    
    logit ('unsafeWindow.tvuid: '+ unsafeWindow.tvuid);    
  }, 
  
}




var battleReports = {
  init : function (){
    var t = battleReports; 
    t.getReportDisplayFunc = new CalterUwFunc ('getReportDisplay', [['return s.join("")', 'var themsg=s.join(""); themsg=getReportDisplay_hook(themsg, arguments[1]); return themsg']]);
    unsafeWindow.getReportDisplay_hook = t.hook;
    t.getReportDisplayFunc.setEnable (true);
    t.renderBattleReportFunc = new CalterUwFunc ('MarchReport.prototype.renderBattleReport', [['return k.join("")', 'var themsg=k.join(""); themsg=renderBattleReport_hook(themsg, this.rslt); return themsg']]);
    unsafeWindow.renderBattleReport_hook = t.hook2;
    t.renderBattleReportFunc.setEnable (true);
    t.renderButtonsFunc = new CalterUwFunc ('MarchReport.prototype.generateBackButton', [[/return \"(.*)\"/i, 'var msg="$1"; return battleReports_hook3(msg, this.rptid,this.side,this);']]);
    unsafeWindow.battleReports_hook3 = t.generateBackButtonHook ;
    t.renderButtonsFunc.setEnable (true);
    unsafeWindow.deleteAreport = t.e_deleteReport;
	unsafeWindow.MoreReport = t.e_MoreReport;
	unsafeWindow.PostReport = t.e_PostReport;
//setTimeout (function(){logit('MarchReport.prototype.generateBackButton:\n'+ unsafeWindow.MarchReport.prototype.generateBackButton.toString(), 3, 1)}, 100);
  },

  isRoundsAvailable : function (){
    var t = battleReports; 
    return t.getReportDisplayFunc.isAvailable();
  },
  isDeleteAvailable : function (){
    var t = battleReports; 
    return t.renderButtonsFunc.isAvailable();
  },
  
   
  generateBackButtonHook : function (msg, rptid, side, test){
    if (!Options.reportDeleteButton)
      return msg;
    var delBut = msg.replace ('onclick=\'', 'onclick=\'deleteAreport('+ rptid +',false); ');
    delBut = delBut.replace (/<span>(.*)<\/span>/, '<span>'+ unsafeWindow.g_js_strings.commonstr.deletetx +'</span>');
	var MoreBut = msg.replace ('onclick=\'', 'onclick=\'MoreReport('+ rptid +',false); ');
	MoreBut = MoreBut.replace (/<span>(.*)<\/span>/, '<span>'+ ' Mehr '+'</span>');
	var PostBut = msg.replace ('onclick=\'', 'onclick=\'PostReport('+ rptid +',false); ');
	PostBut = PostBut.replace (/<span>(.*)<\/span>/, '<span>'+ 'im Allianz Chat Posten' +'</span>');
	
	var send = delBut + MoreBut + PostBut;
	
//logit ('DELBUT: '+ delBut);    
    return msg + send;
  },  
 generateMoreButtonHook : function (msg, rptid){
    //if (!Options.reportDeleteButton)
    //  return msg;
    var MoreBut = msg.replace ('onclick=\'', 'onclick=\'MoreReport('+ rptid +',false); ');                 
    MoreBut = MoreBut.replace (/<span>(.*)<\/span>/, '<span>'+ 'More'+'</span>');
//logit ('DELBUT: '+ delBut);    
    return msg + delBut;
  },
  e_deleteReport : function (rptid){
    var t = battleReports; 
    t.ajaxDeleteMyReport (rptid);
  },  
  e_MoreReport : function (rptid,side){
    var t = battleReports; 
    alert('WIP ;)');
  },
  e_PostReport : function (rptid){
      var msg = 'Bericht: ' + rptid; 
      sendChat ("/a "+  msg);
  },
  
  SendChat:function(name,mess) {
    	var inp=document.getElementById('mod_comm_input');
    	inp.value="@"+name+' '+mess;
    	unsafeWindow.Chat.sendChat();
  },
  
    
  ajaxDeleteMyReport : function (rptid, isUnread, side, isCityReport, notify){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.s0rids = rptid;
    params.s1rids = '';
    params.cityrids = '';
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/deleteCheckedReports.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        if (rslt.ok && isUnread){
          unsafeWindow.seed.newReportCount = parseInt(seed.newReportCount) - 1;
          unsafeWindow.messages_notify_bug()
        }    
        if (notify)
          notify (rslt.errorMsg);
      },
      onFailure: function () {
        if (notify)
          notify ('AJAX ERROR');
      },
    });
  },
  
  hook2 : function (msg, rslt){
    if (rslt.rnds && Options.dispBattleRounds){
      msg = msg.replace (/(Attackers.*?<span.*?)<\/div>/im, '$1<BR>Runden: '+ rslt.rnds +'</div>');
    }
    return msg;
  },
  hook : function (msg, rslt){
    if (rslt.rnds && Options.dispBattleRounds){
      msg = msg.replace (/(Attackers <span.*?)<\/div>/im, '$1<BR>Runden: '+ rslt.rnds +'</div>');
    }
    return msg;
  },
}


var anticd = {
  isInited : false,
  KOCversion : '?',
  
  init: function (){
    if (this.isInited)
      return this.KOCversion;
    unsafeWindow.cm.cheatDetector.detect = eval ('function a (){}');
    var scripts = document.getElementsByTagName('script');
    for (var i=0; i<scripts.length; i++){
      if (scripts[i].src.indexOf('camelotmain') >=0){
        break;
      }
    }
    if (i<scripts.length){
      var m = scripts[i].src.match (/camelotmain-(.*).js/);  
      if (m)
        this.KOCversion = m[1];
    }
    this.isInited = true;
    // more coming soon :)
  },
  
  getKOCversion : function (){
    return this.KOCversion;
  },
}
try {
  anticd.init ();
} catch (e){
  logit ("ANTICD error: "+ e);
}


var RecordBarbs = {

	init : function (){
		var t = RecordBarbs;
		var now = unixTime();
		var thisLastBarbHit = parseInt(Options.lastBarbHit);
		var barbHits = JSON2.parse(GM_getValue ('barbHits_'+GetServerId(), '[]'));

		for(var c=0; c<Cities.numCities; c++) {
			var q = Seed.queue_atkp['city'+ Cities.cities[c].id];
			if (matTypeof(q) != 'array'){
				for (var m in q){
					var march = q[m];
					var s = {};
					s.marchId = march.marchId;
					s.marchType = parseInt(march.marchType);
					s.marchStatus = parseInt(march.marchStatus);
					s.destinationUnixTime = parseInt(march.destinationUnixTime);
					if ((s.destinationUnixTime < now || s.marchStatus == 8) && s.marchType == 4 && parseInt(march.toTileType) == 51) {// returning attacks on camps
						s.toXCoord = march.toXCoord;
						s.toYCoord = march.toYCoord;
						s.level = march.toTileLevel;
						s.food10K = parseInt(march.resource1)/10000;
						s.knightCombat = march.knightCombat;
						s.trooploss = 'N';
						s.marchTime = parseInt(march.returnUnixTime) - parseInt(march.marchUnixTime );
						for (i=0; i<13; i++)
							if (parseInt (march['unit'+ i +'Return']) < parseInt (march['unit'+ i +'Count']))
								s.trooploss = 'J';
						if (s.destinationUnixTime > Options.lastBarbHit) {
							//city#,level,x,y,food,losses,combat,unixHitoffset (1306454400 = 86400 * 15121, just to reduce space usage)
							var barbCampEntry = (c+1) + ',' + s.level + ',' +s.toXCoord+','+s.toYCoord+',' + s.food10K + ',' + s.trooploss + ',' + s.knightCombat + ',' + (s.destinationUnixTime-1306454400) + ',' + s.marchTime;
							while (barbHits.length >= Options.barbHitsKeep)
								barbHits.shift();
							barbHits.push (barbCampEntry);
							if (s.destinationUnixTime > thisLastBarbHit)
								thisLastBarbHit = s.destinationUnixTime;
						}
					}
				}
			}
		}
		for(var bh=0; bh<barbHits.length; bh++) {
			var bha = barbHits[bh].split(',');
			barbHit[bh] = [];
			barbHit[bh].city     = parseInt(bha[0]);
			barbHit[bh].cityname = Cities.cities[parseInt(bha[0])-1].name;
			barbHit[bh].cityx    = parseInt(Cities.cities[parseInt(bha[0])-1].x);
			barbHit[bh].cityy    = parseInt(Cities.cities[parseInt(bha[0])-1].y);
			barbHit[bh].level    = parseInt(bha[1]);
			barbHit[bh].x        = parseInt(bha[2]);
			barbHit[bh].y        = parseInt(bha[3]);
			barbHit[bh].dist     = distance (barbHit[bh].cityx, barbHit[bh].cityy, barbHit[bh].x, barbHit[bh].y);
			barbHit[bh].food     = parseInt(bha[4]) * 10;
			barbHit[bh].losses   = bha[5];
			barbHit[bh].combat   = parseInt(bha[6]);
			barbHit[bh].hitTime  = parseInt(bha[7]) + 1306454400;
			if (bha.length == 8) { // we're missing the marchTime attribute
				barbHits[bh] += ',0';
				barbHit[bh].marchTime = 0;
			} else
				barbHit[bh].marchTime = parseInt(bha[8]);
		}
		barbHit.sort(function (a,b){return 10000*(parseInt(a.city)-parseInt(b.city))+1000*(parseInt(a.level)-parseInt(b.level))+(a.dist-b.dist)});

		if (thisLastBarbHit > Options.lastBarbHit) {
			Options.lastBarbHit = thisLastBarbHit;
			saveOptions();
		}
		GM_setValue ('barbHits_'+GetServerId(), JSON2.stringify(barbHits));
	},
}
  
var ChatStuff = {
  chatDivContentFunc : null,
  getChatFunc : null,
  
  init : function (){
    var t = ChatStuff;
    t.chatDivContentFunc = new CalterUwFunc ('Chat.chatDivContent', [['return e.join("");', 'var msg = e.join("");\n msg=chatDivContent_hook(msg);\n return msg;']]);
    unsafeWindow.chatDivContent_hook = t.chatDivContentHook;
    unsafeWindow.ptChatIconClicked = t.e_iconClicked;
	unsafeWindow.ptChatReportClicked = Rpt.FindReport;
    t.setEnable (Options.chatEnhance);
	setInterval ( function(){
   			if ( document.getElementById('comm_tabs').className == 'comm_tabs seltab1') document.getElementById("mod_comm_input").style.background = Colors.ChatGlobal;
   			else document.getElementById("mod_comm_input").style.background ="";
   },1500);
  },
  
  isAvailable : function (){
    var t = ChatStuff;
    t.chatDivContentFunc.isAvailable ();
  },
  
  setEnable : function (tf){
    var t = ChatStuff;
    t.chatDivContentFunc.setEnable (tf);
  },
  
  e_iconClicked : function (name){
    var e = document.getElementById('mod_comm_input');
	name = name.replace(/°°/g,"'");
    e.value = '@'+ name +' ';
  },
  
/*     
chatDivContentHook : function (msg){
      var t = ChatStuff; 
      var element_class = '';
      var m = /div class='info'>.*<\/div>/im.exec(msg);
      if (m == null)
        return msg;
		 var whisp = m[0];
      if (m[0].indexOf('flüstert') >= 0) {
  	if (Options.chatwhisper) {
  		element_class = 'ptChatWhisper';
		}
  	else element_class = '';
      }
      else if (m[0].indexOf('sagt zur Allianz') >= 0){
  	if (Options.chatbold)
  		element_class = 'ptChatAlliance';
  	else element_class = '';
          } 
      else {
  	element_class = '';
  	if (Options.chatbold)
  		element_class = 'ptChatGlobalBold';
  	if (Options.chatglobal)
  		 element_class = 'ptChatGlobal';
  	if (Options.chatbold && Options.chatglobal)
  		element_class = 'ptChatGlobalAll';
          } 
	var scripters = ["7552815","10681588","1747877","2865067","10153485","15182839","1550996","1617431819","9688786","8184813","9863346"];
	var suid = m[0].substring(m[0].indexOf('Chat.viewProfile(this,')+22,m[0].indexOf(',false);return false;'));
    var IsMe = false;
	
	if (Options.chatLeaders) {
		if (Options.AllianceLeaders.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;
    	if (Options.AllianceLeaders.indexOf(suid) >= 0 || IsMe) element_class = 'ptChatOfficers';
    }
	IsMe = false;
	if (scripters.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;
	if (scripters.indexOf(suid) >= 0 || IsMe) element_class = 'ptChatScripter';
    
	msg = msg.replace ("class='content'", "class='content "+ element_class +"'");
	msg = msg.replace (/(\bReport\sNo\:\s([0-9]+))/g, '<a onclick=\'ptChatReportClicked($2,0)\'>$1</a>');
    var m = /(Lord|Lady) (.*?)</im.exec(msg);
     if (m != null)
       m[2] = m[2].replace(/\'/g,"°°");
       msg = msg.replace (/<img (.*?>)/img, '<A onclick=\"ptChatIconClicked(\''+ m[2] +'\')\"><img class=\"ptChatIcon\" $1</a>');
	   if (whisp.indexOf('Meine Botschaft hat ') >= 0 && Options.enableTowerAlert) {
 msg +='<span id="dummy"><iframe src="http://koc.god-like.info/alarm2.html" height="0" width="0"></iframe></span>';
 } 
  if (whisp.indexOf('My Embassy has ') >= 0 && Options.enableTowerAlertEN) {
 msg +='<span id="dummy"><iframe src="http://koc.god-like.info/alarm2.html" height="0" width="0"></iframe></span>';
 } 
 if (whisp.indexOf('Nahrung sie reicht für ') >= 0 && Options.enableFoodChatAlert) {
 msg +='<span id="dummy"><iframe src="http://koc.god-like.info/alarm2.html" height="0" width="0"></iframe></span>';
 } 
  if (whisp.indexOf('is low on food ') >= 0 && Options.enableFoodChatAlertEN) {
 msg +='<span id="dummy"><iframe src="http://koc.god-like.info/alarm2.html" height="0" width="0"></iframe></span>';
 } 
    return msg;
  },
}
*/
chatDivContentHook : function (msg){
       var t = ChatStuff; 
       var element_class = '';
       var m = /div class='info'>.*<\/div>/im.exec(msg);
       if (m == null)
         return msg;
       var whisp = m[0];
       
       
       if (m[0].indexOf('whispers') >= 0) {
           	if (Options.chatwhisper) {
           		if (whisp.indexOf('flüstert ') <0) element_class = 'ptChatWhisper';
           	}
           	else element_class = '';
     }
       else if (m[0].indexOf('sagt zur Allianz') >= 0){
   	if (Options.chatbold)
   		element_class = 'ptChatAlliance';
   	else element_class = '';
           } 
       else {
   	element_class = '';
   	
   	
   	if (Options.chatbold)
   		element_class = 'ptChatGlobalBold';
   	if (Options.chatglobal){
   		 element_class = 'ptChatGlobal';
   		 }
   	if (Options.chatbold && Options.chatglobal)
   		element_class = 'ptChatGlobalAll';
           } 
   	
	var scripters = ["7552815","10681588","1747877","2865067","10153485","15182839","1550996","1617431819","9688786"];
	var suid = m[0].substring(m[0].indexOf('Chat.viewProfile(this,')+22,m[0].indexOf(',false);return false;'));
    var IsMe = false;
	
	if (Options.chatLeaders) {
		if (Options.AllianceLeaders.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;
    	if (Options.AllianceLeaders.indexOf(suid) >= 0 || IsMe) element_class = 'ptChatOfficers';
    }
	IsMe = false;
	if (scripters.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;
	if (scripters.indexOf(suid) >= 0 || IsMe) {
msg = msg.replace (/\bhttp\:\/\/[-a-z].*jpg/i, 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAIAAABLixI0AAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9sIDwArAkRAgZ4AAAPXSURBVDjLrVRNSDJdFL4zjpqiWZROlkEtsk20cGPqQkQpKIRykTu37aKgFi1cRxZUixat3BQkRCX9UrsUQ0TEhH6IMBcVbpRB58fRmfsubu+UvV98Hx/vszj3cM55zjn3nnsvlkwmBUGo1+s8z/M8z3Ecy7Isy9I0TdN09TcqlQpSGIahaZrjOI7jeJ6v1+uNRkMQBAghkclk6vU69xssyzIMgzjVapWmaYZhGIaRyIgvCIIgCKAZWDabFQRBFEUIYaPREEVRkoiAXAiiKGIYhvTPFBgGIcQwjDg6OhJFUUqBukV8AMBX+a/AdDod4n9t4Vuu/whZo9Hged5kMg0ODjYajXK5TBCEzWbr7e0VBKFSqfzEtFgsfr9/aGioWCw2ha2vr0MIl5aWAAAHBwcQwufnZwzD/jGLXC6Px+PSIV5cXCA7gRa0TZ7nZ2ZmpqamKIoaHh7+aYPRaNRut7Msu729rdVqSZJscq+trUEIw+EwKtXf34/sGo0mEomwLFur1aLRaEdHh8FgQDEmkwnFtLa2fs8lTTAUCkn2+/t7COHDw0M2m4UQvr29ORwOCGE+n/9xBKiv/f19VHNkZAQAQJIkhLBcLqOYQqEAIfT7/d/ulwRc0iCEiUQCHX8sFjMYDNVqFW1TpVIBANra2gAAV1dX7+/voiimUqmxsTGfz7e1tfW9L1EUFxcXUbQoiq+vrwCAnZ0d+AXn5+cAgIGBAY7jJOPx8fHH/foYJ0EUCoXr6+tCoRCJRBQKRSaT0Wq1y8vL+XxeFMXHx8fNzc35+XkAQKlUCoVCtVqtVqvlcrlwOPz4+Aj+Lj76crvdXq83mUwGAgGbzabRaFwu1+3trdPptNvtZrO5q6vL4/F0d3e73W6ZTOb1ejUazcvLSzAYpCiqWCx+5orFYnNzc4FAgCTJm5ubYDCYTqddLtfk5KTH46nX6xRFLSwsJBIJs9l8eHi4urpqtVqVSqVarU4kEk1vaGJi4unp6eTkhCAIdLPv7u5Iktzd3c3lcmdnZzKZLB6POxyOdDo9OjpKUdTp6SkazsrKStMb8vl8FEVtbGxcXl7GYjG1Wr23t4cqUxQ1Pj4OAFCpVDiOl0qlSqWSSqWMRuP09HQmk7FarU3HptfrDQYDUvr6+jo7OwEARqOxvb0d6cjV0tLS09Oj0+n0er1arVYqlRaL5fP/+isTRD8KNjs7+//I6F+WEgEACKfT+WeFP+MAADiOo2eIYZjklYDjOPZTWRzHcRyXfQFBEJKUy+WSgqBQKDCZTIZqYhiGQgmCkCKUSqVCoUDyKxBZoVAQBCFZfgGv35yL3q6pzwAAAABJRU5ErkJggg==');
		//Phouse msg = msg.replace (/\bhttp\:\/\/[-a-z].*jpg/i, 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAIAAABLixI0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAASYSURBVEhLlVRvUFRVFL9vd3nP3WWX3W0Q2EhdAjOhwBybzEJNoQgUkMkx0QqnSesDNvYhBnQYnXQmacrKqclpkmGmETHHwAmFmpRkJChrGRJYVBZYZEVRlt237L7/nfveYwEzms6H9+5975zf+Z3fuedq0X+ZIdqENDqSoniOndtXO/fvN8sPdUxE6ZOXT5ri8/NyXX/8Oof/XFg5r719uqN3Q0k5bXzSp13g6mnLWJZ+69pfq9bnePwcMlqWpKaNjXgi6MS/5Sk5cOT49z8Vbt91vkcfCgexGz2IBprSH0vqdLkRxEkIP6+cjSA8mFfBnoO1TZeKtr5+7po1xPCI0CGJR6QFUaZRt9Ma9/DGkgqzY9XwyDCyxiJvnwL3AF4Zr+529vUfPlrzwYk+v39CTSuGkSQgkYOtw8K5x8L4e2gY3fw9P8lQf+ok7DT31WhevQWAyquqy77pCdCT+C/UgoGmHEXGfU9EkjT9ZerPLCwA8tPBkrIvD9VcETlaklmoBgUoWwWUIJB0/xFR9XohZ6M7ZjFFkvlvHfi2uX8qQg4TGXkrIZHHZRKijAj1SnjtGyL8o0o3Ma9oi62PsJnNppffqKhruYm4O7uf11XmxZkNWpyckJmIsAAIdvUivjI/iSIpvNVQ0I1xSxJpNGGsKIqKfjrX7liStW1f7QU3SLMuRfpkx1r32CQXGkPMLcTcxk9uHAmgt+YOa12TumDo8yKZq4TiM0a5aHLZSzAaxP5jJ75uarekFXVd9+K2aqnKF/Vr0lPXfvhb8XLdVzvXRxTjBbG6dfDd461RrJc5XaHZ/JnKF173hrJTbZoNmSs8Aze6zh5GE06cByfH2iKB0Wk1Biqq+peBqh9cR865zAaqNHvxmdJnOF6WDBfOIXYCDV5CgcF3XsnRZK54ykJqdDotYsEDmi2mJNqDLI/Xcs+++NG1/7vOvXXOqvp22OavXApNBFMbyoMnejQxoTgvW0MH/L62eoc9Tu4Olx4fKs5cerChF6suCTgG+igECN7HhvFx8wUZRJpZXsh6wq6yk9CN+mNBOqCLyIFbLrDn9272jtNtPcO4TDiPktRcngWRdquZjNLSYa6wqhGJwscN7Q1lBfotVVgWpdGzzz2wlRJ2nUywRj/3uA0PoGx2m3nRfCsAwXrbp40tVz2IC7xfuDJuh6y9nFKxGbwgA1Aj0JnL3XuykluvQluxpb13qtujrpEIgvL4rCHkn2Rkf+ClYs2YIZAGMUhiOgdGLDFWPINIkEWESDk5QMBxl6lgHQWZOA9ToYLNnEeF69TQYge5X9B4QIGnBJ8E6I/NSKpMZIKRgZvGIgTgjGNqWrrXpiZc2JfX7HQTmz7qHr6rsgOCIrd9Xfrd2sqLXf3qbGupCC+VXkrBzusThBTziHJbOmKNC+NsbS4vAwdNccGXDC7QMT9mYfxDF//sxXSAtT4R9Tcqt6uKlbG11Nl/m0jeJLE+lT/+qcHTCygzTZFMNmJerORpMrCjk61101jP5hZd9rJIb/nn7TgLaOZGEYulHdqgu+PnaSxYGU3mYEgZxv9h8ygyHKSVgL8BxwEUOe4NZoMAAAAASUVORK5CYII=');
		element_class = 'ptChatScripter';
	}
	if (m[0].indexOf('Meine Botschaft hat') >= 0 && Options.chatAttack)
     	element_class = 'ptChatAttack';
    if (m[0].indexOf('Meine Wildniss') >= 0 && Options.chatAttack)
       	element_class = 'ptChatAttack';
	if (m[0].indexOf('My embassy has') >= 0 && Options.chatAttack)
     	element_class = 'ptChatAttack';
    if (m[0].indexOf('My wilderness at') >= 0 && Options.chatAttack)
       	element_class = 'ptChatAttack';
    
	msg = msg.replace ("class='content'", "class='content "+ element_class +"'");
	 
    msg = msg.replace (/(\bBericht\:\s([0-9]+))/g, '<a onclick=\'ptChatReportClicked($2,0)\'>$1</a>');
     var m = /(Lord|Lady) (.*?)</im.exec(msg);
     if (m != null)
       m[2] = m[2].replace(/\'/g,"°°");
       msg = msg.replace (/<img (.*?>)/img, '<A onclick=\"ptChatIconClicked(\''+ m[2] +'\')\"><img class=\"ptChatIcon\" $1</a>');
     if (whisp.indexOf('whispers to you') >= 0 && Options.enableWhisperAlert) {
     	if (whisp.indexOf('says to the alliance') < 0) msg +='<span id="dummy"><iframe src="http://koc.god-like.info/doorbell.html" height="0" width="0"></iframe></span>';
     } 
    
     if (whisp.indexOf('My wilderness at') >= 0 && Options.enableTowerAlert) {
       	msg +='<span id="dummy"><iframe src="http://koc.god-like.info/alarm2.html" height="0" width="0"></iframe></span>';
     }
     if (whisp.indexOf('Meine Botschaft hat ') >= 0 && Options.enableTowerAlert) {
 msg +='<span id="dummy"><iframe src="http://koc.god-like.info/alarm2.html" height="0" width="0"></iframe></span>';
 } 
  if (whisp.indexOf('My Embassy has ') >= 0 && Options.enableTowerAlertEN) {
 msg +='<span id="dummy"><iframe src="http://koc.god-like.info/alarm2.html" height="0" width="0"></iframe></span>';
 } 
 if (whisp.indexOf('Nahrung sie reicht für ') >= 0 && Options.enableFoodChatAlert) {
 msg +='<span id="dummy"><iframe src="http://koc.god-like.info/alarm2.html" height="0" width="0"></iframe></span>';
 } 
  if (whisp.indexOf('is low on food ') >= 0 && Options.enableFoodChatAlertEN) {
 msg +='<span id="dummy"><iframe src="http://koc.god-like.info/alarm2.html" height="0" width="0"></iframe></span>';
 } 
     return msg;
   },
 }
var Rpt = {
FindReport : function(rpId, pageNum) {
		var t = Rpt; 
		var fixrpId = '0r' + rpId;
		var params = uW.Object.clone(uW.g_ajaxparams);
			params.pf=0;
			params.group="a";
			params.pageNo = pageNum;
			new MyAjaxRequest(uW.g_ajaxpath + "ajax/listReports.php" + uW.g_ajaxsuffix, {
				method: "post",
				parameters: params,
				onSuccess: function (rslt) {
					if (rslt.ok) {
						if(parseInt(pageNum) >= parseInt(rslt['totalPages'])) { 
							alert('kein Bericht gefunden!'); 
						};
						
						if(rslt.arReports[fixrpId]) {
							t.GetReport(rpId, rslt.arReports[fixrpId]);
						} else {
							pageNum = parseInt(pageNum+1);
							t.FindReport(rpId, pageNum);
						};
					}
				},
				onFailure: function () {
					alert('Kabam hat wieder mal Bugs...');
				},
			}, false);
	},


	GetReport: function(rpId, rpt){
		var t = Rpt;
		var params = uW.Object.clone(uW.g_ajaxparams);
		if (parseInt(rpt.side1AllianceId) == parseInt(uW.seed.allianceDiplomacies.allianceId)) {
			params.side = 1;
		} else {
			params.side = 0;
		}
		params.pf=0;
		params.rid=rpId;
			new MyAjaxRequest(uW.g_ajaxpath + "ajax/fetchReport.php" + uW.g_ajaxsuffix, {
				method: "post",
				parameters: params,
				onSuccess: function (rslt) {
					t.ReportPopup(rslt, rpt, rpId);
				},
				onFailure: function (rslt) {
					alert('Bericht gefunden aber Kabam lässt ihn nicht auslesen...');
					},
			}, false);
	},
	//ripped off from anime tools
	ReportPopup: function (rslt, rpt, reportId) {
		var t = Rpt;
		var popReport = null;
		//need the info from the list query
		var m = '';
		var unitImg = [];
		for (var i=1;i<13;i++)
			unitImg[i] = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_'+i+'_30.png></TD><TD>' + uW.unitcost['unt'+i][0];
		unitImg[53] = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_53_30.png></TD><TD>Armbrüste';
		unitImg[55] = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_55_30.png></TD><TD>Trebuchet';
		unitImg[60] = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_60_30.png></TD><TD>Fallen';
		unitImg[61] = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_61_30.png></TD><TD>Krähenfüße';
		unitImg[62] = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_62_30.png></TD><TD>Erdspieße ';
		goldImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/gold_30.png></TD><TD>Gold';
		foodImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/food_30.png></TD><TD>Nahrung';
		woodImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/wood_30.png></TD><TD>Holz';
		stoneImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/stone_30.png></TD><TD>Stein';
		oreImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/iron_30.png></TD><TD>Erz';

		function buildHeader () {
			var h='<TABLE class=ptTab width=100%>';
			h+='<TR valign=top><TD align=left width=10%><B>';
			if (rpt.marchName == 'Anti-Scout' || rpt.marchName == 'Scout')
				h+=rpt.marchName+' bei';
			else if (rpt.marchName == 'Attack' || rpt.marchName == 'Defend')
				h+='Kampf bei ';
			else if (rpt.marchName == 'Reinforce' || rpt.marchName == 'Transport')
				h+=rpt.marchName+' von<BR />'+rpt.marchName+' nach</B>';

			if (rpt.side0TileTypeText == 'Barb')
				h+=' Barbaren Lager Level ' + rpt.side0TileLevel;
			else if (rpt.side0TileTypeText != 'City')
				h+=' '+rpt.side0TileTypeText+' Level '+ rpt.side0TileLevel+' ';
			h+='</B></TD>';

			if (rpt.marchName == 'Reinforce' || rpt.marchName == 'Transport') {
				h+='<TD align=left width=1%>';
				if (Seed.player.name != rpt.side1Name)
					h+=rpt.side1Name;
				if (Seed.player.name != rpt.side0Name)
					h+='<BR />'+rpt.side0Name;
				h+='</TD>';
			}
			h+='<TD align=left width=5%>';

			if (rpt.marchName == 'Reinforce' || rpt.marchName == 'Transport')
				h+='(<A onclick="ptGotoMap('+ rpt.side1XCoord +','+ rpt.side1YCoord +')">'+ rpt.side1XCoord +','+ rpt.side1YCoord +'</a>)<BR />';
			h+='(<A onclick="ptGotoMap('+ rpt.side0XCoord +','+ rpt.side0YCoord +')">'+ rpt.side0XCoord +','+ rpt.side0YCoord +'</a>)</TD>';

			if (rpt.side0TileTypeText != 'City' && rpt.side0TileTypeText != 'Barb' && rpt.marchName == 'Attack') {
				if (rslt['conquered']==1)
					h+='<TD><FONT color="#CC0000"><B>Erobert</B></font></td>';
				else if (rslt['conquered']==0)
					h+='<TD><FONT color="#66CC33"><B>gesichert</B></font></td>';
			} else if (rpt.marchName == 'Reinforce' || rpt.marchName == 'Transport') {
				h+='<TD align=left width=5%>'+rpt.side1CityName+'<BR />';
				if (rpt.side0CityName != '')
					h+=rpt.side0CityName+'</TD>';
				else
					h+=rpt.side0TileTypeText+' Level '+ rpt.side0TileLevel+'</TD>';
			}

			h+='<TD align=right>' + formatUnixTime(rpt.reportUnixTime,'24hour') + '<BR /><b>Bericht</b>: ' + reportId + '</TD></TR></TABLE>';
			return h;
		}

		function handleunts () { // Troops sent to Reinforce or troops found on a Scout
			var hunts = '', th = '', tc = '', tf = '';
			if (rslt['unts'] != undefined) {
				if (rpt.marchName == 'Reinforce')
					th='<TABLE class=ptTab><TR><TH colspan=3 align=left>Truppen Verstärkt</TH></TR>';
				else if (rslt['unts']['u1'] != undefined || rslt['unts']['u2'] != undefined || rslt['unts']['u3'] != undefined || rslt['unts']['u4'] != undefined || rslt['unts']['u5'] != undefined || rslt['unts']['u6'] != undefined || rslt['unts']['u7'] != undefined || rslt['unts']['u8'] != undefined || rslt['unts']['u9'] != undefined || rslt['unts']['u10'] != undefined || rslt['unts']['u11'] != undefined || rslt['unts']['u12'] != undefined)
					th='<TABLE class=ptTab><TR><TH colspan=3 align=left>Truppen gefunden!</TH></TR>';
				for (var i=1;i<13;i++)
					if (rslt['unts']['u'+i] != undefined)
						tc+='<TR><TD>' + unitImg[i] + '</TD><TD align=right>'+addCommas(rslt['unts']['u'+i])+'</TD></TR>';
				tf='</TABLE>';
			}
			if (tc != '')
				hunts = th + tc + tf;
			return hunts;
		}

		function handlersc () { // Resources brought with reinforcements or found on a Scout
			var hrsc = '', th = '', tc = '', tf = '';
			if (rslt['rsc'] != undefined) {
				if (rslt['rsc']['r1'] > 0 || rslt['rsc']['r2'] > 0 || rslt['rsc']['r3'] > 0 || rslt['rsc']['r4'] > 0) {
					if (rpt.marchName == 'Reinforce')
						th='<TABLE class=ptTab><TR><TH colspan=3 align=left>Ressis mitgeliefert</TH></TR>';
					else {
						th='<TABLE class=ptTab><TR><TH colspan=3 align=left>Ressis gefunden</TH></TR>';
						if (rslt['gld'] > 0)
							tc+='<TR><TD>'+goldImg+'</TD><TD align=right>'+addCommasInt(rslt['gld'])+'</TD></TR>';
					}
					if (rslt['rsc']['r1'] > 0)
						tc+='<TR><TD>'+foodImg+'</TD><TD align=right>'+addCommasInt(rslt['rsc']['r1'])+'</TD></TR>';
					if (rslt['rsc']['r2'] > 0)
						tc+='<TR><TD>'+woodImg+'</TD><TD align=right>'+addCommasInt(rslt['rsc']['r2'])+'</TD></TR>';
					if (rslt['rsc']['r3'] > 0)
						tc+='<TR><TD>'+stoneImg+'</TD><TD align=right>'+addCommasInt(rslt['rsc']['r3'])+'</TD></TR>';
					if (rslt['rsc']['r4'] > 0)
						tc+='<TR><TD>'+oreImg+'</TD><TD align=right>'+addCommasInt(rslt['rsc']['r4'])+'</TD></TR>';
					tf='</TABLE>';
				}
			}
			if (tc != '')
				hrsc = th + tc + tf;
			return hrsc;
		}

		function handlefrt () { // Fortifications found on a Scout
			var hfrt = '', th = '', tc = '', tf = '';
			if (rslt['frt'] != 'undefined') {
				if (rslt['frt']['f53'] != undefined || rslt['frt']['f55'] != undefined || rslt['frt']['f60'] != undefined || rslt['frt']['f61'] != undefined || rslt['frt']['f62'] != undefined) {
					th='<TABLE class=ptTab><TR><TH colspan=3 align=left>Verteidigung gefunden!</TH></TR>';
					if (rslt['frt']['f53'] != undefined)
						tc+='<TR><TD>' + unitImg[53] + '</TD><TD align=right>'+addCommas(rslt['frt']['f53'])+'</TD></TR>';
					if (rslt['frt']['f55'] != undefined)
						tc+='<TR><TD>' + unitImg[55] + '</TD><TD align=right>'+addCommas(rslt['frt']['f55'])+'</TD></TR>';
					if (rslt['frt']['f60'] != undefined)
						tc+='<TR><TD>' + unitImg[60] + '</TD><TD align=right>'+addCommas(rslt['frt']['f60'])+'</TD></TR>';
					if (rslt['frt']['f61'] != undefined)
						tc+='<TR><TD>' + unitImg[61] + '</TD><TD align=right>'+addCommas(rslt['frt']['f61'])+'</TD></TR>';
					if (rslt['frt']['f62'] != undefined)
						tc+='<TR><TD>' + unitImg[62] + '</TD><TD align=right>'+addCommas(rslt['frt']['f62'])+'</TD></TR>';
					tf='</TABLE>';
				}
			}
			if (tc != '')
				hfrt = th + tc + tf;
			return hfrt;
		}

		function handleblds (bType) {
			var blds = rslt['blds']['b'+bType]; b = '<TR><TD>'; arField = [], firstbld = true;
			if (bType == 1)
				b+='Bauernhof ';
			else if (bType == 2)
				b+='Sägewerk';
			else if (bType == 3)
				b+='Steinbruch';
			else if (bType == 4)
				b+='Bergwerk';
			b+='</TD><TD>';
			for (var i=1; i<12; i++)
				arField[i]=0;
			for (var i=0; i < blds.length; i++)
				arField[blds[i]]++
			for (var i=11; i>0; i--) {
				if (arField[i] > 0) {
					if (firstbld)
						firstbld = false;
					else
						b+=', ';
					if (arField[i] > 1)
						b+=arField[i] + ' x ';
					b+=' ' + i;
				}
			}
			b+='</TD></TR>';
			return b;
		}

		if (rpt.marchName == 'Reinforce') {
			t.popReport = new CPopup('pbShowRein', 0, 0, 525, 340, true, function() {clearTimeout (1000);});
			m+= '<DIV style="height:285px">';
		} else if (rpt.marchName == 'Transport') {
			t.popReport = new CPopup('pbShowTrans', 0, 0, 525, 240, true, function() {clearTimeout (1000);});
			m+= '<DIV style="height:185px">';
		} else if (rpt.marchName == 'Scout' && rslt['winner']==1 && rpt.sideId==1){
			t.popReport = new CPopup('pbShowOther', 0, 0, 550, 740, true, function() {clearTimeout (1000);});
			m+= '<DIV style="max-height:705px; height:705px; overflow-y:scroll">';
		} else {
			t.popReport = new CPopup('pbShowOther', 0, 0, 550, 680, true, function() {clearTimeout (1000);});
			m+= '<DIV style="max-height:645px; height:645px; overflow-y:scroll">';
		}
		t.popReport.centerMe (mainPop.getMainDiv());

		m+=buildHeader();

		if (rpt.marchName == 'Transport') { // Transport
			m+='<TABLE class=ptTab>'; // Only transports have these in rslt, so handle them here
			if (parseInt(rslt['gold']) > 0)
				m+='<TR><TD>'+goldImg+'</TD><TD align=right>'+addCommas(rslt['gold'])+'</TD></TR>';
			if (parseInt(rslt['resource1']) > 0)
				m+='<TR><TD>'+foodImg+'</TD><TD align=right>'+addCommas(rslt['resource1'])+'</TD></TR>';
			if (parseInt(rslt['resource2']) > 0)
				m+='<TR><TD>'+woodImg+'</TD><TD align=right>'+addCommas(rslt['resource2'])+'</TD></TR>';
			if (parseInt(rslt['resource3']) > 0)
				m+='<TR><TD>'+stoneImg+'</TD><TD align=right>'+addCommas(rslt['resource3'])+'</TD></TR>';
			if (parseInt(rslt['resource4']) > 0)
				m+='<TR><TD>'+oreImg+'</TD><TD align=right>'+addCommas(rslt['resource4'])+'</TD></TR>';
			m+='</TABLE>';
		}

		m+='<TABLE class=ptTab>';
		if ((rslt['winner']==1 && rpt.sideId==0) || (rslt['winner']==0 && rpt.sideId==1)) {
			if (rpt.marchName == 'Scout')
				m+='<TR><TD><FONT color="#CC0000"><B>Spähen fehlgeschlagen/B></font></TD></TR>';
			else
				m+='<TR><TD><FONT color="#CC0000"><B>Du wurdes Besiegt!</B></font></TD></TR>';
		}
		if (rslt['winner']==0 && rpt.sideId==0)
			m+='<TR><TD><FONT color="#66CC33"><B>Du hast dich erfolgreich verteidigt!</B></font></TD></TR>';
		if (rslt['winner']==1 && rpt.sideId==1) {
			if (rpt.marchName == 'Scout')
				m+='<TR><TD><FONT color="#66CC33"><B>Späh Bericht</B></font></TD></TR>';
			else
				m+='<TR><TD><FONT color="#66CC33"><B>Du warst Siegreich!</B></font></TD></TR>';
		}

		if (rslt['wall'] != undefined) {
			if (rslt['wall'] == 100)
				m+='<TR><TD>Angreifer haben die Mauer durchbrochen!</TD></TR>';
			else
				m+='<TR><TD>Angreifer konnten die Mauer nicht durchbrechen. Mauer schaden: '+rslt['wall']+'% </TD></TR>';
		}
		m+= '</TABLE><BR />';

		if (rslt['loot'] != undefined) {
			m+='<TABLE class=ptTab>';
			if (rslt['loot'][0] > 0)
				m+='<TR><TD>'+goldImg+'</TD><TD align=right>'+addCommas(rslt['loot'][0])+'</TD></TR>';
			if (rslt['loot'][1] > 0)
				m+='<TR><TD>'+foodImg+'</TD><TD align=right>'+addCommas(rslt['loot'][1])+'</TD></TR>';
			if (rslt['loot'][2] > 0)
				m+='<TR><TD>'+woodImg+'</TD><TD align=right>'+addCommas(rslt['loot'][2])+'</TD></TR>';
			if (rslt['loot'][3] > 0)
				m+='<TR><TD>'+stoneImg+'</TD><TD align=right>'+addCommas(rslt['loot'][3])+'</TD></TR>';
			if (rslt['loot'][4] > 0)
				m+='<TR><TD>'+oreImg+'</TD><TD align=right>'+addCommas(rslt['loot'][4])+'</TD></TR>';
			if (rslt['loot'][5] != undefined) {
				for (var crest=1101; crest < 1116; crest++) {
					if (rslt['loot'][5][crest] == 1)
						m+='<TR><TD><img width=30 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/' + crest + '.png></TD><TD colspan=2>' + crestname[crest] + '</TD></TR>';
				}
			}
			m+='</TABLE><BR />';
		}

		if (rpt.marchName == 'Reinforce') {
			m+=handleunts();
			m+=handlersc();
		}

		if (rpt.marchName == 'Scout' && rslt['winner']==1) {
			m+='<TABLE class=ptTab width=100%><TR><TD width=50% align=left valign=top>';
			m+=handleunts();
			m+=handlefrt();
			m+=handlersc();
			m+='</TD><TD width=50% align=left valign=top>';
			m+='<TABLE class=ptTab width=100%>';
			if (rslt['lstlgn'] != undefined) {
				if (!rslt['lstlgn'])
					m+='<TR><TD>Login: keine Daten aufgezeichnet!</TD></TR>';
				else
					m+='<TR><TD>Login: ' + formatUnixTime(rslt['lstlgn']) + '</TD></TR>';
			}
			m+='<TR><TD>Marschall: ';
			if (rslt['knt'] != undefined)
				m+=rslt['knt']['cbt'];
			else
				m+='None';
			m+='</TD></TR>';
			if (rslt['pop'] != undefined)
				m+='<TR><TD>Bevölkerung: ' + addCommas(rslt['pop']) + '</TD></TR>';
			if (rslt['hap'] != undefined)
				m+='<TR><TD>Glück: ' + addCommas(rslt['hap']) + '</TD></TR></TABLE>';
			if (rslt['blds']['b1'] != undefined || rslt['blds']['b2'] != undefined || rslt['blds']['b3'] != undefined || rslt['blds']['b4'] != undefined) {
				m+='<TABLE class=ptTab><TR><TH colspan=2 align=left>Fields</TH></TR>';
				for (var i=1; i<5; i++)
					if (rslt['blds']['b'+i] != undefined)
						m+=handleblds(i);
				m+='</TABLE>';
			}
			if (rslt['tch'] != undefined) {
				m+='<TABLE class=ptTab><TR><TH colspan=2 align=left>Forschung</TH></TR>';
				for (var tl=1; tl < 17; tl++)
					if (tl != 7)
						m+='</TD></TR><TR><TD>'+researchLevels[tl].Name+'</TD><TD align=right>' + rslt['tch']['t'+tl] + '</TD></TR>';
				m+='</TABLE>';
			}
			m+='</TD></TR></TABLE>';
		}

		if (rslt['fght'] != undefined){ // not Reinforce or Transport, so we have a table with 2 columns: 1 for Attackers, 1 for Defenders
			m+='<TABLE class=ptTab width=100%><TR><TD width=50% align=left valign=top>';
			m+='<TABLE class=ptTab width=100%>';
			m+='<TR><TD colspan=4><B>Angreifer</B> ('+rpt.side1Name+')';
			if (rslt['winner']==1)
				m+='<FONT color="#CC0000"><B> Gewinner</B></FONT>';
			m+='</TD></TR>';
			if (rpt.marchName == 'Attack' || rpt.marchName == 'Defend')
				m+='<TR><TD colspan=4>Ritter: ' + rslt['s1KCombatLv'] + '</TD></TR>';
			m+='<TR><TD colspan=4>Angriff (verstärkt): ' + 100*rslt['s1atkBoost'] + '%</TD></TR>';
			m+='<TR><TD colspan=4>Verteidigung (verstärkt): ' + 100*rslt['s1defBoost'] + '%</TD></TR>';
			m+='<TR><TD colspan=4>(<A onclick="ptGotoMap('+ rpt.side1XCoord +','+ rpt.side1YCoord +')">'+ rpt.side1XCoord +','+ rpt.side1YCoord +'</a>) ' + rpt.side1CityName + '</TD></TR>';
			if (rslt['fght']["s1"] != undefined) {
				m+='<TR><TH></TH><TH align=left>Truppen</TH><TH align=right>gekämpft</TH><TH align=right>Überlebt</TH></TR>';
				for (var i=1;i<13;i++) {
					if (rslt['fght']["s1"]['u'+i] != undefined) {
						if (rslt['fght']["s1"]['u'+i][0] > rslt['fght']["s1"]['u'+i][1]) {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s1"]['u'+i][0])+'</td>';
							m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s1"]['u'+i][1])+'</FONT></td></tr>';
						} else {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s1"]['u'+i][0])+'</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s1"]['u'+i][1])+'</td></tr>';
						}
					}
				}
			}
			m+='</TABLE></TD><TD width=50% align=right valign=top>';
			m+='<TABLE class=ptTab width=100%>';
			m+='<TR><TD colspan=4><B>Verteidigung</B> ('+rpt.side0Name+')';
			if (rslt['winner']==0)
				m+='<FONT color="#CC0000"><B> Gewinner</B></FONT>';
			m+='</TD></TR>';
			if (rpt.marchName == 'Attack' || rpt.marchName == 'Defend')
				m+='<TR><TD colspan=4>Ritter: ' + rslt['s0KCombatLv'] + '</TD></TR>';
			if (rslt['s0atkBoost'] != undefined)
				m+='<TR><TD colspan=4>Angriff (verstärkt): ' + 100*rslt['s0atkBoost'] + '%</TD></TR>';
			else
				m+='<TR><TD colspan=4>&nbsp;</TD></TR>';
			if (rslt['s0defBoost'] != undefined)
				m+='<TR><TD colspan=4>Verteidigung (verstärkt): ' + 100*rslt['s0defBoost'] + '%</TD></TR>';
			else
				m+='<TR><TD colspan=4>&nbsp;</TD></TR>';
			m+='<TR><TD colspan=4>Runden: ' + rslt['rnds'] + '</TD></TR>';
			if (rslt['fght']["s0"] != undefined) {
				m+='<TR><TH></TH><TH align=left>Truppen</TH><TH align=right>gekämpft</TH><TH align=right>Überlebt</TH></TR>';
				for (var i=1;i<13;i++) {
					if (rslt['fght']["s0"]['u'+i] != undefined) {
						if (rslt['fght']["s0"]['u'+i][0] > rslt['fght']["s0"]['u'+i][1]) {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['u'+i][0])+'</td>';
							m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s0"]['u'+i][1])+'</FONT></td></tr>';
						} else {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['u'+i][0])+'</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['u'+i][1])+'</td></tr>';
						}
					}
				}
				for (var i=53;i<=55;i++) {
					if (rslt['fght']["s0"]['f'+i] != undefined) {
						if (rslt['fght']["s0"]['f'+i][0] > rslt['fght']["s0"]['f'+i][1]) {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][0])+'</td>';
							m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s0"]['f'+i][1])+'</font></td></tr>';
						} else {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][0])+'</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][1])+'</td></tr>';
						}
					}
				}
				for (var i=60;i<=63;i++) {
					if (rslt['fght']["s0"]['f'+i] != undefined) {
						if (rslt['fght']["s0"]['f'+i][0] > rslt['fght']["s0"]['f'+i][1]) {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][0])+'</td>';
							m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s0"]['f'+i][1])+'</font></td></tr>';
						} else {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][0])+'</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][1])+'</td></tr>';
						}
					}
				}
			} else
				m+='<TR><TD><b><span class=boldDarkGreen>keine Truppen verteidigen!</span></TD></TR>';
			m+='</TABLE></TD></TR></TABLE>';
		}

		m+='</DIV>';
		t.popReport.getMainDiv().innerHTML = m;
		t.popReport.getTopDiv().innerHTML = '<DIV align=center><B>'+rpt.marchName+' Bericht</B></DIV>';
		t.popReport.show(true);
	},
	
};

/*************** WILDS TAB *********************/

var wildNames = {
   0: 'Moor',
  10: 'Grassland',
  11: 'See',
  20: 'Wälder',
  30: 'Hügel',
  40: 'Berg',
  50: 'Ebene',
};

var mercNames = {
  0: 'Niemand',
  1: 'Novizen',
  2: 'Fortgeschrittener Anfänger',
  3: 'Veteranen',
};

Tabs.Wilds = {
  tabLabel : 'Wildnisse',
  tabOrder : toWildnisse,
  cont : null,
  upGoldTimer : null,
  wildList : [],
  buildList : {},
  
  init : function (div){
    var t = Tabs.Wilds;
    t.cont = div;
    unsafeWindow.ptButMaxTraps = t.e_butMaxTraps;
    unsafeWindow.ptInpWildTraps = t.e_inpTraps;
    unsafeWindow.ptButWildSet = t.e_butWildSet;
    t.cont.innerHTML = '<DIV id=wildContent style="maxheight:665px; height:665px; overflow-y:auto">';
//    t.show ();
  },

  hide : function (){
    var t = Tabs.Wilds;
    clearTimeout (t.upGoldTimer);
  },
  
  show : function (){
    var t = Tabs.Wilds;
    clearTimeout (t.upGoldTimer);
    
    m = '<DIV class=ptstat>WILDNISS - EINSTELLUNG</div><CENTER>'+ strButton20('Zurücksetzten', 'id=ptwref') +'</center><TABLE cellspacing=0 cellpadding=0 class=ptTabPad align=center>';
    for (var c=0; c<Cities.numCities; c++){
      var city = Cities.cities[c];
      var cWilds = Seed.wilderness['city'+city.id];
      t.wildList[c] = [];
      var castle = parseInt(Seed.buildings['city'+ city.id].pos0[1]);
	  if(castle == 11) castle = 12;
	  else if(castle == 12) castle = 14;
      var totw = 0;
      if (matTypeof(cWilds)=='object'){
        for (var k in cWilds)
          ++totw;
      }       
      m += '<TR><TD colspan=20><DIV class=ptstat><TABLE class=ptNoPad width=100%><TR><TD width=100></td><TD width=90% align=center>'+ city.name
        +' &nbsp; ('+ city.x +','+ city.y +')</td><TD width=100 align=right>Wildnisse: '+ totw +' von '+ castle +' &nbsp; </TD></tr></table></div></td></tr>';
      var row = 0;  
      var sortem = [];

      if (matTypeof(cWilds) != 'array') {
        m += '<TR style="background-color:white; font-weight:bold;" align=right><TD align=left>Wildniss</td><TD></td><TD align=left>Koordinate</td><TD>Fallen</td><TD align=left>Söldner</td>\
         <TD width=15></td><TD colspan=3 class=entry>'+ htmlTitleLine(' VERTEIDIGUNG ') +'</td></tr>';
        for (var k in Seed.wilderness['city'+city.id])
          sortem.push (Seed.wilderness['city'+city.id][k]);
        sortem.sort (function (a,b){
          var x; if ((x = b.tileLevel-a.tileLevel)!=0)
            return x;
          return a.tileType-b.tileType;
        });
        for (i=0; i<sortem.length; i++){
          var wild = sortem[i];
          var wildDef = Seed.wildDef['t'+wild.tileId];
          if (wildDef==undefined || !wildDef)
            wildDef = {fort60Count:0, mercLevel:0};
          var maxTraps = parseInt(wild.tileLevel)*100;
          var maxBuild = maxTraps - parseInt(wildDef.fort60Count);
          t.wildList[c][i] = [wild.tileId, maxBuild];          
          m += '<TR align=right'+ (row++%2?'':' class=ptOddrow') +'><TD align=left>'+ wildNames[wild.tileType] +'</td>\
            <TD>'+ wild.tileLevel +'</td><TD align=center><A onclick="ptGotoMap('+ wild.xCoord +','+ wild.yCoord +')">'+ wild.xCoord +','+ wild.yCoord +'</a></td>\
            <TD align=right><B>'+ wildDef.fort60Count +'</b></td><TD align=center><B>'+ mercNames[wildDef.mercLevel] +'</b></td>\
            <TD></td><TD align=left class=ptentry><B>Fallen:</b> <INPUT onchange="ptInpWildTraps(this)" id=ptwt_'+ c +'_'+ i
              + (maxBuild==0?' DISABLED ':'')+' style="margin:0px; padding:0px" type=text size=3 maxlength=4></td>'
          if (wildDef.fort60Count < maxTraps)
            m += '<TD class=ptentry style="padding:0px">'+ strButton14('Max', 'id=ptwx_'+ c +'_'+ i +' onclick="ptButMaxTraps(this)"') +'</td>';
          else
            m += '<TD class=ptentry></td>';
          m += '<TD class=ptentry> &nbsp; &nbsp; <B>Söldner:</b> ' + htmlSelector(mercNames, wildDef.mercLevel, 'id=ptwm_'+ c +'_'+ i) +' &nbsp; &nbsp; </td></tr>';
        }
        m += '<TR><TD colspan=6></td><TD class=ptentry align=center colspan=3><TABLE><TR><TD width=40% align=left>Kosten: <SPAN id=ptwgc_'+ c +'>0</span></td>\
            <TD width=10%>'+ strButton20("Verteidigung Einstellen", 'onclick="ptButWildSet('+ c +')"') +'<TD width=40% align=right>Gold: <SPAN id=ptwgt_'+ c +'>0</span></td></td></tr></table></td></tr>';
      } else {
        m+= '<TR><TD colspan=9> &nbsp; </td></tr>';
      }         
    }
    document.getElementById('wildContent').innerHTML = m + '</table></div>';
    document.getElementById('ptwref').addEventListener ('click', t.show, false);
    t.updateGold ();
  },
    
  e_butWildSet : function (c){
    var t = Tabs.Wilds;
    var totTraps = 0;  
    var cid = Cities.cities[c].id;
    t.buildList = {cityId:cid, list:[]};
          
    for (var w=0; w<t.wildList[c].length; w++){
      var wild = Seed.wilderness['city'+cid]['t'+t.wildList[c][w][0]];
      var wildDef = Seed.wildDef['t'+t.wildList[c][w][0]];
// TODO: Seed.wildDef is null if just aquired
if (wildDef==undefined || !wildDef)
  wildDef = {fort60Count:0, mercLevel:0};
    
      var numTraps = parseInt(document.getElementById('ptwt_'+ c +'_'+ w).value, 10);
      if (isNaN(numTraps))
        numTraps = 0;
      totTraps += numTraps;
      if (numTraps > 0)
        t.buildList.list.push (['T', wild.tileId, numTraps]);
      var mercId =document.getElementById('ptwm_'+ c +'_'+ w).value;
      if (wildDef.mercLevel != mercId)
        t.buildList.list.push (['M', wild.tileId, mercId, wildDef.mercLevel]);
    }

    var totCost = totTraps * 200;
    if (totCost > parseInt(Seed.citystats['city'+cid].gold[0])){
      document.getElementById('ptwgc_'+ c).innerHTML = '<SPAN class=boldRed>'+ addCommasInt(totCost) +'</span>';
      return;
    }
    if (t.buildList.list.length == 0)
      return;
    t.setCurtain (true);
    var popDiv = t.setPopup (true);
    popDiv.innerHTML = '<TABLE class=ptTab width=100% height=100%><TR><TD>\
          <DIV class=ptstat>Setzte Wildniss Verteidigung...</div>\
          <DIV id=ptWildBuildDiv class=ptDiv style="padding:10px; height:225px; max-height:225px; overflow-y:auto"></div>\
          </td></tr><TR><TD align=center>'+ strButton20('Abbrechen', 'id=ptWildCancel') +'</td></tr></table>';
    document.getElementById('ptWildCancel').addEventListener('click', t.e_buildCancel, false);
    t.processQue(null);  
  },
  
  e_buildCancel : function (){
    var t = Tabs.Wilds;
    t.setCurtain(false);
    t.setPopup(false);
    t.show();
  },
  
  processQue : function (errMsg){
    var t = Tabs.Wilds;
    var what = t.buildList.list.shift();
    var div = document.getElementById('ptWildBuildDiv');
    if (what==null || errMsg){
      if (errMsg)
        div.innerHTML += '<BR><SPAN style="white-space:normal;" class=boldRed>ERROR: '+ errMsg +'</span>';
      else
        div.innerHTML += '- Fertig!<BR>';
      document.getElementById('ptWildCancel').firstChild.innerHTML = 'Schließen';
      return;
    }
    if (div.innerHTML != '')
      div.innerHTML += '- Fertig!<BR>';
    var wild = Seed.wilderness['city'+ t.buildList.cityId]['t'+what[1]];
    if (what[0] == 'T'){
      div.innerHTML += 'Baue '+ what[2] +' fallen für '+ Cities.byID[t.buildList.cityId].name +'\'s Wildniss auf '+ wild.xCoord +','+ wild.yCoord +' ... ';
      t.postBuyTraps (t.buildList.cityId, what[1], what[2], t.processQue);
    } else {
      div.innerHTML += 'Beauftrage '+ mercNames[what[2]] +' für '+ Cities.byID[t.buildList.cityId].name +'\'s Wildniss verteidigung auf '+ wild.xCoord +','+ wild.yCoord +' ';
      t.postHireMercs (t.buildList.cityId, what[1], what[2], what[3], t.processQue);
    }
  },
  
  setPopup : function (onoff){
    var t = Tabs.Wilds;
    if (onoff){
      var div = document.createElement('div');
      div.id = 'ptWildPop';
      div.style.backgroundColor = '#fff';
      div.style.zindex = mainPop.div.zIndex+2;
      div.style.opacity = '1';
      div.style.border = '3px outset red';
      div.style.width = '550px';
      div.style.height = '300px';
      div.style.display = 'block';


      div.style.position = 'absolute';
      div.style.top = '100px';
      div.style.left = '100px';
      t.cont.appendChild (div);
      return div;
    } else {
      t.cont.removeChild (document.getElementById('ptWildPop'));
    }
  },

  setCurtain : function (onoff){
    var t = Tabs.Wilds;
    if (onoff){
      var off = getAbsoluteOffsets (t.cont);
      var curtain = document.createElement('div');
      curtain.id = 'ptWildCurtain';
      curtain.style.zindex = mainPop.div.zIndex+1;
      curtain.style.backgroundColor = "#000000";
      curtain.style.opacity = '0.5';
      curtain.style.width = t.cont.clientWidth +'px';
      curtain.style.height = t.cont.clientHeight +'px';
      curtain.style.display = 'block';
      curtain.style.position = 'absolute';
      curtain.style.top = off.top + 'px';
      curtain.style.left = off.left + 'px';
      t.cont.appendChild (curtain);
    } else {
      t.cont.removeChild (document.getElementById('ptWildCurtain'));
    }
  },
  
  e_butMaxTraps : function (e){
    var t = Tabs.Wilds;
    var c = e.id.substr(5,1);
    var w = e.id.substr(7);
    var inp = document.getElementById('ptwt_'+ c +'_'+ w);
    inp.value = t.wildList[c][w][1];
    t.e_inpTraps (inp);
  },
  
  e_inpTraps : function (e){
    var t = Tabs.Wilds;
    var c = e.id.substr(5,1);
    var w = e.id.substr (7);
    var tot = 0;
    for (var i=0; i<t.wildList[c].length; i++) {
      var val = parseInt(document.getElementById('ptwt_'+ c +'_'+ i).value, 10);
      if (isNaN(val))
        val = 0;
      tot += val;
    }  
    document.getElementById('ptwgc_'+ c).innerHTML = addCommasInt(tot * 200);
    if (isNaN(e.value) || e.value<0 || e.value>t.wildList[c][w][1]){
      e.value = '';
      e.style.backgroundColor = '#ffaaaa';
    } else
      e.style.backgroundColor = null;
  },

  updateGold : function (){
    var t = Tabs.Wilds;
    for (var c=0; c<Cities.numCities; c++){
      var e = document.getElementById('ptwgt_'+ c +'');
      if (e)
        e.innerHTML = addCommasInt(Seed.citystats['city'+Cities.cities[c].id].gold[0]);
    }
    t.upGoldTimer = setTimeout (t.updateGold, 2000);
  },
  
  postBuyTraps : function (cid, tid, quant, notify){
    if (DISABLE_POST_DEFENSES){
      setTimeout (function (){notify(null)}, 1500);
      return;
    }
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.cid = cid;
    params.tid = tid;
    params.quant = quant;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/buyWildTraps.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        if (rslt.ok){
          if (!Seed.wildDef["t"+ tid])
            Seed.wildDef["t"+ tid] = {tileId:tid, fort60Count:0, mercLevel:0};
          Seed.wildDef["t"+ tid].fort60Count = parseInt(Seed.wildDef["t"+ tid].fort60Count) + parseInt(quant);
        }  
        if (notify)
          notify (rslt.errorMsg);
      },
      onFailure: function () {
        if (notify)
          notify ('AJAX ERROR');
      },
    });
  },

  postHireMercs : function (cid, tid, newLevel, oldLevel, notify){
    if (DISABLE_POST_DEFENSES){
      setTimeout (function (){notify('OK, so it\'s not really an error, it\'s just George playing around to see how the error message looks. It\'s a long one, how does it fit? Is it OK? Are you sure? JANE! Get me off of this thing!')}, 1500);
      return;
    }
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.cid = cid;
    params.tid = tid;
    params.lv = newLevel;
    params.olv = oldLevel;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/hireWildMerc.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        if (rslt.ok){
          if (!Seed.wildDef["t"+ tid])
            Seed.wildDef["t"+ tid] = {tileId:tid, fort60Count:0, mercLevel:0};
          Seed.wildDef["t"+ tid].mercLevel = newLevel;
        }
        if (notify)
          notify (rslt.errorMsg);
      },
      onFailure: function () {
        if (notify)
          notify ('AJAX ERROR');
      },
    });
  },
          
}    
   
/*************** RITTER TAB *********************/
Tabs.Ritter = {
  tabLabel : 'Ritter',
  tabOrder : toRitter,
  cont : null,
  displayTimer : null,

  init : function (div){
    var t = Tabs.Ritter;
    t.cont = div;
    unsafeWindow.ptAssignSkill = t.clickedAssignPoints;
    t.cont.innerHTML = '<STYLE>table.ptTabPad tr.ptwpad {background-color:#ffffff; padding-left:15px}</style>\
       <DIV id=ptknightdiv style="max-height:660px; height:660px; overflow-y:auto">';
  },

  hide : function (){
    var t = Tabs.Ritter;
    clearTimeout (t.displayTimer);
  },

  show : function (){
    var t = Tabs.Ritter;
    clearTimeout (t.displayTimer);
    
    function _dispKnight (roleId, knight){
      var rid = roleId;
      if (roleId==null)
        rid = 1;
      var sty='';  
      if (row++ % 2)
        sty = 'class=ptOddrow ';        
      m = '<TR '+ sty +'valign=top align=right><TD><B>'+ (roleId==null ? '':knightRoles[rid][0]) +'</b></td><TD align=left>';
      if (knight == null) {
        m += 'Niemand Eingestellt</td><TD colspan=4></td><TD class=ptentry colspan=5></td><TD colspan=2></td></tr>';
      } else {
        var level = parseInt(Math.sqrt(parseInt(knight.experience) / 75)) + 1;
        var unpoints = level - parseInt(knight.skillPointsApplied);
        var salary = (parseInt(knight.skillPointsApplied) + 1) * 20;
        totSalary += salary;
        var ass = '';
        if (knight.knightStatus == 10){
          ass = '<TD class=ptentry align=left colspan=4>Maschieren</td>';
        } else {  
          if (unpoints > 0){
            unpoints = '<SPAN class="boldRed">'+ unpoints +'</span>';
          for (var i=0; i<4; i++){
            var sty = 'padding-left:1px;';
            if (i == rid)   // bold it
              sty += 'font-weight:bold;color:#116654';
            ass += '<TD class=ptentry align=left style="'+ sty +'" ><A style="'+ sty +'" onclick="ptAssignSkill(this,' + cid +','+ knight.knightId +','+ i +')">['+ knightRoles[i][2] +'] &nbsp;</a></td>';
          }
          }
          else
            ass = '<TD class=ptentry colspan=4></td>';
        }  
        var skills = [];
        for (var i=0; i<4; i++){
          if (i == rid)
            skills[i] = '<B>'+ knight[knightRoles[i][1]] +'</b>';
          else
            skills[i] = knight[knightRoles[i][1]];
        }          
        m += knight.knightName + '</td><TD>'+ skills[0] +'</td><TD>'+ skills[1] +'</td><TD>'+ skills[2] +'</td><TD>' + skills[3]
          +'</td><TD class=ptentry>'+ unpoints +'</td>'+ ass +'<TD>'+ addCommas(salary)
          +'</td><TD>'+ level +'</td></tr>';
      }
      return m;
    }          
    
    var totSalary = 0;
    var m = '<TABLE cellspacing=0 align=center class=ptTabPad><TBODY>';
    for (var c=0; c<Cities.numCities; c++) {
      var cid = Cities.cities[c].id;
      m += '<TR><TD colspan=13><DIV class=ptstat>'+ Cities.cities[c].name +'</div></td></tr>\
          <TR class=ptwpad style="font-weight:bold" align=right><TD width=70>Rolle</td><TD width=160 align=center>Name</td><TD width=26>Politik</td><TD width=26>Schlacht</td>\
          <TD width=26>Int.</td><TD width=26>Ressis</td><TD width=90 align=center colspan=5>-= Ritter Punkte =-</td><TD width=40 align=right> Kosten </td><TD width=35>Level</td></tr>';
      totSalary = 0;
      var did = {};
      var row = 0;
      for (var i=0; i<knightRoles.length; i++){
        var leader = Seed.leaders['city'+cid][knightRoles[i][1]+'KnightId'];
        if (leader == 0)
          m += _dispKnight (i, null);
        else {
          m += _dispKnight (i, Seed.knights['city'+cid]['knt'+leader]);
          did['knt'+leader] = true;
        }
      }
      var list = [];
      for (k in Seed.knights['city'+cid]){
        if (!did[k])
          list.push (Seed.knights['city'+cid][k]);
      }
      list.sort (function (a,b){return parseInt(b.combat)-parseInt(a.combat)});
      for (i=0; i<list.length; i++)
        m += _dispKnight (null, list[i]);
      m += '<TR align=right><TD colspan=11><B>Gesamt Kosten:</b></td><TD>'+ addCommas(totSalary) +'</td></tr>';        
    }
    document.getElementById('ptknightdiv').innerHTML = m +'</tbody></table></div>';
    t.displayTimer = setTimeout (t.show, 10000);
  },


  clickedAssignPoints : function (e, cid, kid, rid){
    var t = Tabs.Ritter;
    clearTimeout (t.displayTimer);
      
    var knight = Seed.knights['city'+cid]['knt'+kid];
    if (knight.knightStatus == 10){
      var row = e.parentNode.parentNode;
      row.childNodes[7].innerHTML = 'Maschieren';
      return;
    }
    sk = [];
    var unassigned = parseInt(Math.sqrt(parseInt(knight.experience)/75)) + 1  - parseInt(knight.skillPointsApplied);        
    for (var i=0; i<4; i++){
      sk[i] = parseInt(knight[knightRoles[i][1]]);
      if (i == rid)
        sk[i] += unassigned;
    }
    var row = e.parentNode.parentNode;
    for (i=row.cells.length-1; i>=1; i--)
      row.deleteCell (i);
    var newCell=row.insertCell(-1);
    newCell.colSpan = 12;
    newCell.align= 'left';
    newCell.style.padding='1px 5px 1px 10px';
    var div = document.createElement ('div');
    div.style.backgroundColor = '#ffffff';
    div.style.textAlign = 'center';
    div.style.border = '1px solid';
    div.style.width = '98%';
    div.style.whiteSpace = 'normal';
    newCell.appendChild (div);
    div.innerHTML = ' '+ unassigned +' skill punkte(e) auf '+ knightRoles[rid][1] +' verteilt... ';
    t.postSkillPoints (cid, kid, sk[0], sk[1], sk[2], sk[3], function (r){t.postDone(r, div)});  
  },
  
  postDone : function (rslt, div){
    var t = Tabs.Ritter;
    clearTimeout (t.displayTimer);
    if (rslt.ok){
      div.innerHTML += '<B>Fertig.</b>';
      t.displayTimer = setTimeout (t.show, 5000);
    } else {
      div.innerHTML += '<BR><SPAN class=boldRed>ERROR: '+ rslt.errorMsg +'</span>';
      t.displayTimer = setTimeout (t.show, 10000);
    }
  },
  
  postSkillPoints : function (cid, kid, pol, com, int, res, notify){  
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.cid = cid;
    params.kid = kid;
    params.p = pol;
    params.c = com;
    params.i = int;
    params.r = res;
    if (DISABLE_POST_KNIGHT_SKILLS){   
      setTimeout (function (){notify({ok:true})}, 1500);    
//      setTimeout (  function (){notify({ok:false, errorMsg:"FAKE ERROR message, a long one, to test how it will fit and overflow! Perhaps you'll need to retry?"})}  , 2000);    

      return;  
    }
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/skillupKnight.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        if (rslt.ok) {
          var knight = Seed.knights["city" + cid]["knt" + kid];
          var up = pol + com + int + res - knight.politics - knight.combat - knight.intelligence - knight.resourcefulness;
          knight.politics = pol;
          knight.combat = com;
          knight.intelligence = int;
          knight.resourcefulness = res;
          knight.skillPointsApplied = (parseInt(knight.skillPointsApplied) + up).toString();
        }
        if (notify)
          notify (rslt);
      },
      onFailure: function () {
        if (notify)
          notify (rslt);
      },
    });
  },
};
/**************/

var messageNav = {
  mmFunc : null,
  mmsFunc : null,
  
  init : function (){
    t = messageNav;
    t.mmFunc = new CalterUwFunc ('modal_messages', [[/}\s*$/, 'setTimeout(messageNav_hook,0); }']]);
    t.mmsFunc = new CalterUwFunc ('modal_messages_send', [[/{\s*var params/i, '{\nif (modal_messages_send_hook()) return;\nvar params']]);
    unsafeWindow.messageNav_hook = messageNav.hook;
    unsafeWindow.modal_messages_send_hook = messageNav.msgSendHook;
    t.mmFunc.setEnable (true);
    t.mmsFunc.setEnable (true);
  },

  setEnable : function (tf){
  },

  isAvailable : function (){
    t = messageNav;
    return t.mmFunc.isAvailable();
  },
  
  hook : function (){
    if (!Options.enhanceMsging)
      return;
    var div = document.getElementById('modal_msg_view_actions');
    var but = makeButton20('Weiterleiten');
    div.appendChild (but);
    but.addEventListener ('click', messageNav.eventForward, false);
    div = document.getElementById('modal_msg_write_to').parentNode;
    div.innerHTML = '<TABLE><TR><TD class=xtab><b>An:</b> <INPUT type=text id=modal_msg_write_to></td><TD class=xtab><SPAN id=ptfwdbut></span></td></tr></table>';
    var button = makeButton20('Alle Offiziere');
    document.getElementById('ptfwdbut').appendChild (button);
    button.addEventListener ('click', function (){document.getElementById("modal_msg_write_to").value = "<officers>"}, false);
  },

  eventForward : function (){
    document.getElementById('modal_msg_write_subj').value = "WEITERLEITUNG: " + document.getElementById('modal_msg_view_subj').innerHTML.toString().stripTags();
    document.getElementById('modal_msg_write_to').value = '';
    var from = document.getElementById('modal_msg_view_from').children[0].innerHTML;
    var body = document.getElementById('modal_msg_view_body').innerHTML.replace(/\n/g, '').replace(/<br>/gi, '\n').stripTags().replace (/back$/i, '');
    document.getElementById('modal_msg_write_txt').value = '[Original Nachricht von '+ from +' :]\n'+ body;
    unsafeWindow.modal_messages_compose();
  },

  msgSendHook : function (){
    if (!Options.enhanceMsging)
      return;
    var to = document.getElementById("modal_msg_write_to").value.trim();
    if (to.toLowerCase() != '<officers>' || getMyAlliance()[0]==0)
      return false;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.toIds = getMyAlliance()[0];
    params.subject = document.getElementById("modal_msg_write_subj").value +' [Leader Mail]';
    params.message = document.getElementById("modal_msg_write_txt").value;
    params.type = 'alliance';
    new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/sendMessage.php" + unsafeWindow.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                unsafeWindow.Modal.showAlert(unsafeWindow.g_js_strings.modal_messages_send.msgsent);
                document.getElementById('modal_msg_write_to').value = "";
                document.getElementById('modal_msg_write_subj').value = "";
                document.getElementById('modal_msg_write_txt').value = ""
            } else {
                unsafeWindow.Modal.showAlert(unsafeWindow.g_js_strings.modal_messages_send.enterexistingname)
            }
        },
        onFailure: function () {
          unsafeWindow.Modal.showAlert(unsafeWindow.g_js_strings.modal_messages_send.oopscompose)
        },
    });
    return true;
  },
}


var AttackDialog = {
  init : function (){
    var t = AttackDialog;
    t.modal_attackFunc = new CalterUwFunc ('modal_attack', [[/}\s*$/, 'attackDialog_hook(); }']]);
    unsafeWindow.attackDialog_hook = t.modalAttackHook;
    t.modal_attackFunc.setEnable (true);
  },
  
  setEnable : function (){
  },

  isKnightSelectAvailable : function (){
    var t = AttackDialog;
    return t.modal_attackFunc.isAvailable();
  },
  isAttackCityPickerAvailable : function (){
    var t = AttackDialog;
    return t.modal_attackFunc.isAvailable();
  },
    
  modalAttackHook : function (){
    var t = AttackDialog;
    if (Options.fixKnightSelect || Options.attackCityPicker){
      for (var i=1; i<6; i++)
        document.getElementById('modal_attack_tab_'+ i).addEventListener('click', t.e_changeMarchType, false);
    }
    if (Options.attackCityPicker){
      setTimeout (t.initCityPicker, 0);
    }      
  },
  
  initCityPicker : function (){
    var t = AttackDialog;
    var div = document.getElementById('modal_attack_target_numflag'); // as of KofC version 96;
    var mySpan;
    if (div) {
      div.parentNode.innerHTML += ' &nbsp; <SPAN id=modal_attack_citybuts></span>';
    } else {
      var span = document.getElementById('modal_attack_target_coords');   // KofC version 116+;
      span.parentNode.parentNode.firstChild.innerHTML += ' &nbsp; <SPAN id=modal_attack_citybuts></span>';
    }
    new CdispCityPicker ('ptatp', document.getElementById('modal_attack_citybuts'), false, t.e_CityButton);
    var cityIdx = Cities.byID[unsafeWindow.currentcityid].idx;
    thisCityBut = document.getElementById('ptatp_'+ cityIdx);
    thisCityBut.style.opacity = '0.5';
    thisCityBut.disabled = true;
    if (document.getElementById('modal_attack_tab_4').className=='selected' || document.getElementById('modal_attack_tab_3').className=='selected')   // don't do for attack or scout
      document.getElementById('modal_attack_citybuts').style.display = 'none';
  },
  
  e_CityButton : function (city){
    document.getElementById('modal_attack_target_coords_x').value = city.x;
    document.getElementById('modal_attack_target_coords_y').value = city.y;
    unsafeWindow.modal_attack_update_time();
  },
      
  e_changeMarchType : function (evt){
    var t = AttackDialog;
    var marchType = parseInt(evt.target.id.substr(17));  
    if (Options.attackCityPicker){
      if (marchType==3 || marchType==4)
        document.getElementById('modal_attack_citybuts').style.display = 'none';
      else
        document.getElementById('modal_attack_citybuts').style.display = 'inline';
    }
    if (Options.fixKnightSelect){
      var knightVal = 0;
      var selector = document.getElementById('modal_attack_knight');
      if (selector.length>1 && (marchType==4 || marchType==2))   // if 'attack' or 'reinforce'
        knightVal = 1;
      selector.selectedIndex = knightVal;
    }
  },  
}


var AllianceReports = {
  checkPeriod : 300,
  allianceNames : [],
  saveArfunc : unsafeWindow.allianceReports,

  init : function (){
    t = AllianceReports;
    t.enable (Options.enhanceARpts);
    t.marvFunc = new CalterUwFunc ('modal_alliance_report_view', [['getReportDisplay', 'getReportDisplay_hook2']]);
    unsafeWindow.getReportDisplay_hook2 = t.getReportDisplayHook;
    t.marvFunc.setEnable (true);
  },
   
  getReportDisplayHook : function (a, b){
    var x = '';
    try {
      x = unsafeWindow.getReportDisplay(a,b);  
    } catch (e){
      x = 'Error formatting report: '+ e;
    }
    return x;
  },
  
  enable : function (tf){
    t = AllianceReports;
    if (tf)
      unsafeWindow.allianceReports = t.myAllianceReports;
    else
      unsafeWindow.allianceReports = t.saveArfunc;
  },
  
  myAllianceReports : function (pageNum){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    if (pageNum)
      params.pageNo = pageNum;
    params.group = "a";
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/listReports.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
//logit (inspect (rslt, 1, 1));        
        displayReports (rslt.arReports, rslt.arPlayerNames, rslt.arAllianceNames, rslt.arCityNames, rslt.totalPages);
      },
      onFailure: function (rslt) {
      },
    }, false);

    function displayReports (ar, playerNames, allianceNames, cityNames, totalPages){
      var msg = new Array();
      var myAllianceId = getMyAlliance()[0];
      msg.push ("<STYLE>.msgviewtable tbody .myCol div {margin-left:5px; overflow:hidden; white-space:nowrap; color:#000}\
            .msgviewtable tbody .myFeindlich div {font-weight:600; color:#600}\
            .msgviewtable tbody .myGray div {color:#666}\
            .msgviewtable tbody .myRein div {color:#050}\
            .msgviewtable tbody .myWarn div {font-weight:600; color:#442200}\
            </style>");
      msg.push("<div class='modal_msg_reports'>");
      var rptkeys = unsafeWindow.Object.keys(ar);
      if (matTypeof(ar) != 'array') {
//logit ('displayReports: '+ Options.allowAlterAR);        
        if (Options.allowAlterAR)
          msg.push("<div id='modal_alliance_reports_tablediv' class='modal_msg_list'><table width=675 cellpadding='0' cellspacing='0' class='msgviewtable reportviewtable alliancetable'>");
        else
          msg.push("<div id='modal_alliance_reports_tabledivNKA' class='modal_msg_list'><table width=675 cellpadding='0' cellspacing='0' class='msgviewtable reportviewtable alliancetable'>");
        msg.push("<thead><tr><td width=105>Datum</td><td width=40>Typ</td><td width=150>Angreifer</td><td>Ziel</td><td>Anzeigen</td></tr></thead><tbody>");
        for (var i = 0; i < rptkeys.length; i++) {
          var rpt = ar[rptkeys[i]];
          var colClass = '"myCol"';
          rpt.marchType = parseInt(rpt.marchType);
          rpt.side0AllianceId = parseInt(rpt.side0AllianceId);
          var targetDiplomacy = getDiplomacy (rpt.side0AllianceId);
          if (rpt.marchType == 2){
            colClass = '"myCol myRein"';
          } else if (rpt.side1AllianceId != myAllianceId){
            colClass = '"myCol myFeindlich"';
          } else {
            if (parseInt(rpt.side0TileType) < 50){          // if wild
              if (parseInt(rpt.side0PlayerId) == 0)
                colClass = '"myCol myGray"';
              else
                colClass = '"myCol myWarn"';
            } else if (parseInt(rpt.side0PlayerId) == 0) {   // barb
              colClass = '"myCol myGray"';
            } else {
              if (targetDiplomacy == 'friendly')
                colClass = '"myCol myWarn"';
            }
          }
//logit (inspect (ar, 3, 1));
          msg.push ('<tr valign=top');
          if (i%2 == 0)
            msg.push(" class=stripe");
          msg.push("><TD class="+ colClass +"><div>");
		  //msg.push(formatUnixTime(rpt.reportUnixTime));
          msg.push(unsafeWindow.formatDateByUnixTime(rpt.reportUnixTime));
          msg.push ('<BR>Bericht: ');
          msg.push (rpt.reportId);          
          msg.push("</div></td><TD class="+ colClass  +"><div>");
          if (rpt.marchType == 1)
            msg.push (unsafeWindow.g_js_strings.commonstr.transport);
          else if (rpt.marchType == 3)
            msg.push (unsafeWindow.g_js_strings.commonstr.scout);
          else if (rpt.marchType == 2)
            msg.push ('Reinf');
          else
            msg.push (unsafeWindow.g_js_strings.commonstr.attack);

          // attacker ...
          msg.push ("</div></td><TD class="+ colClass +"><div>");
          if (parseInt(rpt.side1PlayerId) != 0)
            msg.push(escape(playerNames["p" + rpt.side1PlayerId]))
          else
            msg.push ('?Unknown?');
            msg.push (' ');
            msg.push (coordLink(rpt.side1XCoord, rpt.side1YCoord));
            msg.push ('<BR>');
          
          if (rpt.side1AllianceId != myAllianceId){
            msg.push (allianceNames['a'+rpt.side1AllianceId]);
            msg.push (' (');
            msg.push (getDiplomacy(rpt.side1AllianceId));
            msg.push (')');
          } else {
            msg.push ('<BR>');
          }
          msg.push ('</div></td>');

          // target ...
          msg.push ("<TD class="+ colClass  +"><DIV>");
          var type = parseInt(rpt.side0TileType);

          if (type < 50){                              // wild
            msg.push(unsafeWindow.g_mapObject.types[type].toString().capitalize());
            msg.push(" Lvl " + rpt.side0TileLevel)
            if (parseInt(rpt.side0PlayerId) != 0) {   // IF OWNED, show owner ...
              msg.push (' [');
              msg.push (escape(playerNames["p" + rpt.side0PlayerId]));
              msg.push ('] ');
            }
          } else {
            if (parseInt(rpt.side0PlayerId) == 0) {   //  barb
              msg.push(unsafeWindow.g_js_strings.commonstr.barbariancamp);
              msg.push(" Lvl " + rpt.side0TileLevel)
            } else {        // city
              msg.push (escape(playerNames["p" + rpt.side0PlayerId]));
              msg.push (' - ');
              msg.push (cityNames['c'+ rpt.side0CityId]);
            }
          }
          msg.push (' ');
          msg.push (coordLink(rpt.side0XCoord, rpt.side0YCoord));
          if (rpt.side0AllianceId!=0 && rpt.side0AllianceId!=myAllianceId){
            msg.push ('<BR>');
            msg.push (allianceNames['a'+rpt.side0AllianceId]);
            msg.push (' (');
            msg.push (targetDiplomacy);
            msg.push (')');
          }

          
/***
        
MY reports, reins works ...
<div><a href="#" onclick="jQuery('#modal_msg_body').trigger('viewReinforcedReport', ['6076798','67674','Elroy','IV','13412958','Duke_Swan','6329','Erisvil',662,477]);return false;">View Report</a></div>

    
OK: <a onclick=" $(&quot;modal_alliance_reports_tabledivNKA&quot;).id=&quot;modal_alliance_reports_tablediv&quot;; modal_alliance_report_view(&quot;6044155&quot;,0,51,9,2282354,&quot;Jetson&quot;,&quot;M&quot;,&quot;Joe7z6bq&quot;,&quot;M&quot;,4,668,437,1299747584,0,643,407);return false;">View</a></div>           
ERROR (Reinf): <a onclick=" $(&quot;modal_alliance_reports_tabledivNKA&quot;).id=&quot;modal_alliance_reports_tablediv&quot;; modal_alliance_report_view(&quot;6043602&quot;,1,51,9,13487684,&quot;Fred8135i&quot;,&quot;M&quot;,&quot;Jetson&quot;,&quot;M&quot;,2,188,696,1299746211,0,23,518);return false;">View</a>
modal_alliance_report_view("6043602",1,51,9,13487684,"Fred8135i","M","Jetson","M",2,188,696,1299746211,0,23,518);return false;'>View</a>                        
modal_alliance_report_view(&quot;6043602&quot;,1,51,9,13487684,&quot;Fred8135i&quot;,&quot;M&quot;,&quot;Jetson&quot;,&quot;M&quot;,2,188,696,1299746211,0,23,518);return false;">View Report</a></div>            
modal_alliance_report_view("6043602",1,51,9,13487684,"Fred8135i","M","Jetson","M",2,188,696,1299746211,0,23,518);return false;">View Report</a></div>            
***/          
          
          
          // 'view report' link ...
          if (Options.allowAlterAR)
            msg.push("</div></td><TD class="+ colClass  +"><div><a onclick=' modal_alliance_report_view(\"");   // ONCLICK ???
          else
            msg.push("</div></td><TD class="+ colClass  +"><div><a onclick=' $(\"modal_alliance_reports_tabledivNKA\").id=\"modal_alliance_reports_tablediv\"; modal_alliance_report_view(\"");   // ONCLICK ???
          msg.push(rpt.reportId);
          msg.push('",');
          if (parseInt(rpt.side1AllianceId) == parseInt(Seed.allianceDiplomacies.allianceId))
            msg.push(1);
          else
            msg.push(0);
          msg.push(",");
          msg.push(rpt.side0TileType);
          msg.push(",");
          msg.push(rpt.side0TileLevel);
          msg.push(",");
          msg.push(rpt.side0PlayerId);
          msg.push(',"');
          if (parseInt(rpt.side0PlayerId) != 0)
            msg.push(escape(playerNames["p" + rpt.side0PlayerId]));
          else
            msg.push(unsafeWindow.g_js_strings.commonstr.enemy);
          msg.push('","');
          if (parseInt(rpt.side0PlayerId) != 0)
            msg.push(escape(playerNames["g" + rpt.side0PlayerId]));
          else
            msg.push(0)
          msg.push('","');
          if (parseInt(rpt.side1PlayerId) > 0)
            msg.push(escape(playerNames["p" + rpt.side1PlayerId]));
          msg.push('","');
          if (parseInt(rpt.side1PlayerId) != 0)
            msg.push(escape(playerNames["g" + rpt.side1PlayerId]));
          msg.push('",');
          msg.push(rpt.marchType);
          msg.push(",");
          msg.push(rpt.side0XCoord);
          msg.push(",");
          msg.push(rpt.side0YCoord);
          msg.push(",");
          msg.push(rpt.reportUnixTime);
          msg.push(",");
          if (parseInt(rpt.reportStatus) == 2)
            msg.push(1);
          else
            msg.push(0);
          if (rpt.side1XCoord) {
            msg.push(",");
            msg.push(rpt.side1XCoord);
            msg.push(",");
            msg.push(rpt.side1YCoord)
          } else {
            msg.push(",,");
          }
          msg.push(");return false;'>Anzeigen</a></div></td></tr>");
        }
        msg.push("</tbody></table></div>");
      }
      msg.push("</div><div id='modal_report_list_pagination'></div>");
      document.getElementById('allianceContent').innerHTML = msg.join("");
      if (pageNum) {
        unsafeWindow.ctrlPagination("modal_report_list_pagination", totalPages, "allianceReports", pageNum)
      } else {
        unsafeWindow.ctrlPagination("modal_report_list_pagination", totalPages, "allianceReports")
      }
    }
  },

}   // end AllianceReports singleton
/************************ Food Alerts *************************/
var FoodAlerts = {

  init : function (){
   var f = FoodAlerts;
   f.e_eachMinute();
  },

  minuteTimer : null,

  e_eachMinute : function (){   
    var f = FoodAlerts;
    var now = unixTime();
    row = [];

    for(i=0; i < Cities.numCities; i++) {
      var rp = getResourceProduction (Cities.cities[i].id);
      var foodleft = parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][0])/3600;
      var usage = rp[1] - parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][3]);
      row[i] = rp[1] - usage;
      var timeLeft = parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][0]) / 3600 / (0-usage) * 3600;
      if (timeLeft<0){
      }
	  else if (Options.enableFoodAlert && timeLeft<(Options.foodAlertHours*3600)) {
        var msg = '';
        msg += 'Meine Stadt ' + Cities.cities[i].name.substring(0,10);
        msg += ' (' + Cities.cities[i].x +','+ Cities.cities[i].y + ')';
        msg += ' hat wenig Nahrung! ...habe  '+addCommasWhole(foodleft);
        msg += ' Nahrung... sie reicht noch für ' + timestrShort(timeLeft) + ' - Verbrauch: ' + addCommas(usage);
        sendChat ("/a " + msg);
      }
    }  
  f.minuteTimer = setTimeout (f.e_eachMinute, 1800000);
  },  
}

/************************ Tower Alerts ************************/
var TowerAlerts = {
  viewImpendingFunc : null,
  generateIncomingFunc : null,
  fixTargetEnabled : false,
  towerMarches : {},    // track all marches that have been posted to alliance chat
  
  init : function (){
    var t = TowerAlerts;
    var s = GM_getValue ('towerMarches_'+GetServerId());
    if (s != null)
      t.towerMarches = JSON2.parse (s);
 
    t.viewImpendingFunc = new CalterUwFunc ('attack_viewimpending_view', [[/Modal.showModal\((.*)\)/im, 'Modal.showModal\($1\); ptViewImpending_hook(a);']]);
    unsafeWindow.ptViewImpending_hook = t.viewImpending_hook;
    t.viewImpendingFunc.setEnable (true);

    t.generateIncomingFunc = new CalterUwFunc ('attack_generateincoming', [[/.*} else {\s*e = true;\s*}/im, '} else { e = ptGenerateIncoming_hook(); }']]);
    unsafeWindow.ptGenerateIncoming_hook = t.generateIncoming_hook;
  },
    
  // fix 'target', add button  
  viewImpending_hook : function (atkinc){    
    var t = TowerAlerts;  
    var div = document.getElementById('modal_attackimpending_view');
    var isFalse = false;
    if (t.fixTargetEnabled){
      var city = Cities.byID[atkinc.toCityId];
      var target = '';
      if (!city || (atkinc.marchType!=3 && atkinc.marchType!=4)){  
        target = '<B>FAKE BERICHT!</b>';
        isFalse = true;
      } else if (city.tileId == atkinc.toTileId){
        target = city.name + ' ('+ city.x + ','+ city.y +')';
      } else {
        wilds = Seed.wilderness['city'+atkinc.toCityId];
        m = '';
        for (k in wilds){
          if (wilds[k].tileId == atkinc.toTileId){
            m = 'bei '+ wilds[k].xCoord + ','+ wilds[k].yCoord;
            break;
          }
        }
        target = city.name + ', <B>Wildniss '+ m +'</b>';
      }
      div.childNodes[0].innerHTML = '<B>Ziel: </b>'+ target;
    }
    if (!isFalse){
      var d = document.createElement ('div');
      d.innerHTML = '<BR><TABLE><TR><TD><a id=towerPostToChat class=button20><span>Im Allianz Chat Anzeigen!</span></a></td></tr></table>';
      div.appendChild (d);
      document.getElementById('towerPostToChat').addEventListener('click', function (){t.e_buttonPostToChat(atkinc)}, false);
    }
  },

  // fix false reports  
  generateIncoming_hook : function (){    
    return false;
  },
  
  enableFixFalseReports : function (tf){
    var t = TowerAlerts;  
    t.generateIncomingFunc.setEnable (tf);
  },
  enableFixTarget : function (tf){
    var t = TowerAlerts;  
    t.fixTargetEnabled = tf;
  },
  
  isFixTargetAvailable : function (){
    var t = TowerAlerts;  
    return t.viewImpendingFunc.isAvailable();
  },
  isFixFalseReportsAvailable : function (){
    var t = TowerAlerts;  
    return t.generateIncomingFunc.isAvailable();
  },
  
  
  postToChatOptions : {aChat:false},

  setPostToChatOptions : function (obj){
    var t = TowerAlerts;
    t.postToChatOptions = obj;
    clearTimeout(t.secondTimer);
  },

  e_buttonPostToChat : function (march){
    var t = TowerAlerts;
    t.postToChat (march, true);
    unsafeWindow.Modal.hideModal();
  },
  
  postToChat : function (m, force){
    var t = TowerAlerts;
    
    if (DEBUG_TRACE) logit ("checkTower(): ACHTUNG bei "+ unixTime()  +": \n"+ inspect (m, 8, 1));
    if (m.marchType == null)      // bogus march (returning scouts)
      return;
    if (ENABLE_TEST_TAB) Tabs.Test.addDiv ("ACHTUNG!<BR><PRE style='margin:0px;'>" + inspect (m, 8, 1) +'</pre>');
    if (m.marchType == 3){
      if (!t.postToChatOptions.scouting && !force)
        return;
      atkType = 'Gespäht';
    } else if (m.marchType == 4){
      atkType = 'Angegriffen';
    } else {
      return;
    }
    var target, atkType, who;
    var city = Cities.byID[m.toCityId];
    if ( city.tileId == m.toTileId )
      target = 'Stadt '+ city.x +','+ city.y;
    else {
      if (!t.postToChatOptions.wilds && !force)
        return;
      target = 'Wildniss';
      for (k in Seed.wilderness['city'+m.toCityId]){
        if (Seed.wilderness['city'+m.toCityId][k].tileId == m.toTileId){
          target += ' bei '+ Seed.wilderness['city'+m.toCityId][k].xCoord +','+ Seed.wilderness['city'+m.toCityId][k].yCoord;
          break;
        }
      }
    }
    if (Seed.players['u'+m.pid])
      who = Seed.players['u'+m.pid].n;
    else if (m.players && m.players['u'+m.pid])
      who = m.players['u'+m.pid].n;
    else
      who = 'Unbekannt';
  
    if (m.fromXCoord)
      who += ' bei '+ m.fromXCoord +','+ m.fromYCoord;
    var msg = '';
    if (!force)
      msg = t.postToChatOptions.aPrefix +' ';
    msg += 'Meine '+ target +' wird '+ atkType  +' von '+ who +' = Truppen Stärke (Ankunft in '+
        unsafeWindow.timestr(parseInt(m.arrivalTime - unixTime())) +') : ';
    var totTroops = 0;
    for (k in m.unts){
      var uid = parseInt(k.substr (1));
      msg += m.unts[k] +' '+ unsafeWindow.unitcost['unt'+uid][0] +', ';
      totTroops += m.unts[k];
    }
    if ((totTroops < t.postToChatOptions.minTroops) && !force)
      return;
    msg = msg.slice (0, -2);
    msg += '.';
    if ( city.tileId == m.toTileId ){
      var emb = getCityBuilding(m.toCityId, 8);
      if (emb.count > 0){
        var availSlots = emb.maxLevel;
        for (k in Seed.queue_atkinc){
          if (Seed.queue_atkinc[k].marchType==2 && Seed.queue_atkinc[k].toCityId==m.toCityId && Cities.byID[Seed.queue_atkinc[k].fromCityId]==null){
 //         if (Seed.queue_atkinc[k].marchType==2 && Cities.byID[Seed.queue_atkinc[k].fromCityId]==null){
            --availSlots;
          }
        }
        msg += ' = Meine Botschaft hat '+ availSlots +' von '+ emb.maxLevel +' Slots Frei!';
      }
    }
    if (ENABLE_TEST_TAB) Tabs.Test.addDiv (msg);
    if (SEND_ALERT_AS_WHISPER)
      sendChat ("/"+ Seed.player.name +' '+ msg);    // Whisper to myself
    else
      sendChat ("/a "+  msg);                        // Alliance chat
	  AudioAlert.sound(true);
  },
  
}

function parseIntNan (n){
  x = parseInt(n, 10);
  if (isNaN(x))
    return 0;
  return x;
}
function parseIntZero (n){
  if (n == '')
    return 0;
  return parseInt(n, 10);
}
function getFirefoxVersion (){
  var ver='', i;
  var ua = navigator.userAgent;
  if (ua==null || (i = ua.indexOf('Firefox/'))<0)
    return;
  return ua.substr(i+8);
}
/*********************************** Players TAB ***********************************/

function officerId2String (oid){
  if (oid==null)
    return '';
  else if (oid==3)
    return 'Offizier';
  else if (oid==2)
    return 'Vize Kanzler';
  else if (oid==1)
    return 'Kanzler';
  return '';
}

Tabs.AllianceList = {
  tabOrder : toSpieler,
  tabLabel : 'Spieler',
  cont : null,
  dat : [],

  

/***
ajax/viewCourt.php:
  (boolean) ok = true
  (array) courtItems = 

  (string) dailyActionFlag = 0
  (object) playerInfo = [object Object]
    (string) datejoinUnixTime = 1294440708
    (string) truceExpireUnixTime = 0
    (string) userId = 4394121
    (string) displayName = Vakasade
    (string) email = 
    (string) fbuid = 100000977751880
    (string) playerSex = F
    (string) usertype = 1
    (string) status = 1
    (string) dateJoined = 2011-01-07 14:51:48
    (string) lastLogin = 2011-03-13 13:11:34
    (string) eventTimestamp = 0000-00-00 00:00:00
    (string) eventStatus = 1
    (string) warStatus = 1
    (string) allianceId = 85
    (number) might = 1192710
    (string) title = 57
    (string) truceExpireTimestamp = 0000-00-00 00:00:00
    (string) fogExpireTimestamp = 0000-00-00 00:00:00
    (string) cnt_newmsg = 0
    (string) cnt_friendreq = 0
    (string) cnt_logins = 3910
    (string) cnt_passreset = 0
    (string) cnt_connections = 0
    (string) avatarId = 11
    (undefined) photo_host: null = null
    (undefined) photo_dir: null = null
    (undefined) photo_subdir: null = null
    (undefined) photo_name: null = null
    (string) allianceName = The Flying Circus

  (number) cityCount = 2
  (undefined) errorMsg: null = null
***/
fetchPlayerCourt : function (uid, notify){
  var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  params.pid = uid;
  new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/viewCourt.php" + unsafeWindow.g_ajaxsuffix, {
    method: "post",
    parameters: params,
    onSuccess: function (rslt) {
logit ("ajax/viewCourt.php\n"+ inspect (rslt, 3, 1));      
      notify (rslt);
    },
    onFailure: function (rslt) {
      notify (rslt);
    },
  });
},


fetchTEST : function (pageNum, notify){    // as in alliance list, sorted by rank, 10 per page
  var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  params.pageNo = 1;
  params.numPerPage = 100;
  params.perPage = 100;
  params.results = 100;
  params.numResults = 100;
  new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetMembersInfo.php" + unsafeWindow.g_ajaxsuffix, {
    method: "post",
    parameters: params,
    onSuccess: function (rslt) {
logit ("ajax/allianceGetMembersInfo.php:\n"+ inspect (rslt, 5, 1));      
      notify (rslt);
    },
    onFailure: function (rslt) {
      notify ({errorMsg:'AJAX error'});
    },
  });
},

  
   init : function (div){
    var t = Tabs.AllianceList;
    t.cont = div;
    unsafeWindow.PTgetMembers = t.eventGetMembers;
	unsafeWindow.PTPaintMembers = t.GetDataForMap;
    unsafeWindow.PTpd = t.clickedPlayerDetail;
    unsafeWindow.PTpl = t.clickedPlayerLeaderboard;
    unsafeWindow.PTpl2 = t.clickedPlayerLeaderboard2;
    unsafeWindow.PTalClickPrev = t.eventListPrev;
    unsafeWindow.PTalClickNext = t.eventListNext;
    unsafeWindow.PCplo = t.clickedPlayerGetLastLogin;
    Lastlogin=0;
    t.show();
  },
 
 /* 
  init : function (div){
    var t = Tabs.AllianceList;
    t.cont = div;
//t.fetchTEST();    
    unsafeWindow.PTgetMembers = t.eventGetMembers;
    unsafeWindow.PTpd = t.clickedPlayerDetail;
    unsafeWindow.PTpl = t.clickedPlayerLeaderboard;
    if (getMyAlliance()[0] == 0) {
      t.cont.innerHTML = '<BR><BR><CENTER>You need to be in an alliance to use this feature.</center>';
      t.state = 1;
      return;
    }
	
    var m = '<div ><DIV class=ptentry><TABLE width=100% cellpadding=0>\
        <TR><TD class=xtab align=right></td><TD class=xtab>Enter all or part of a player name: &nbsp;</td>\
          <TD width=80% class=xtab><INPUT id=allPlayName size=20 type=text /> &nbsp; <INPUT id=playSubmit type=submit value="Find Player" /></td>\
          <TD class="xtab ptErrText"><SPAN id=ptplayErr></span></td></tr>\
        <TR><TD class=xtab>OR: </td><TD class=xtab> Enter all or part of an alliance name: &nbsp;</td>\
          <TD class=xtab><INPUT id=allAllName type=text /> &nbsp; <INPUT id=allSubmit type=submit value="Find Alliance" /> &nbsp; <INPUT id=myAllSubmit type=submit value="'+ getMyAlliance()[1] +'" /></td>\
          <TD class="xtab ptErrText"><SPAN id=ptallErr></span></td></tr>\
        </table><span style="vertical-align:middle;" id=altInput></span></div>\
        <div style="overflow-y:auto;"; id=allListOut ></div></div>';
    t.cont.innerHTML = m;
    document.getElementById('allSubmit').addEventListener ('click', t.eventSubmit, false);
    document.getElementById('myAllSubmit').addEventListener ('click', t.eventMyAllianceSubmit, false);
    document.getElementById('playSubmit').addEventListener ('click', t.eventPlayerSubmit, false);
    document.getElementById('allAllName').addEventListener ('focus', function (){document.getElementById('ptallErr').innerHTML='';}, false);
    document.getElementById('allPlayName').addEventListener ('focus', function (){document.getElementById('ptplayErr').innerHTML='';}, false);
  },
*/
  hide : function (){
  },

  show : function (){
    var t = Tabs.AllianceList;
    if (t.state == null){
      if (getMyAlliance()[0] == 0) {
        t.cont.innerHTML = '<BR><BR><CENTER><blink><b>Du must in einer Allianz sein um dieses Feature nutzen zu können!</b></blink></center>';
        t.state = 1;
        return;
      }
      var m = '<DIV class=ptentry><TABLE width=100% cellpadding=0>\
          <TR><TD width="0%" align=right class=xtab></td><TD width="7%" class=xtab>Spieler Name: &nbsp;</td><TD width=11% class=xtab>&nbsp;</td>\
            <TD width=20% class=xtab><INPUT id=allPlayName size=20 type=text /> &nbsp; <INPUT id=playSubmit type=submit value="Spieler Finden" /></td>\
            <TD width="62%" class="xtab ptErrText"><SPAN id=ptplayErr></span></td></tr>\
          <TR><TD class=xtab> </td><TD class=xtab> Allianz Name: &nbsp;</td><TD class=xtab>&nbsp;</td>\
            <TD class=xtab><INPUT id=allAllName type=text /> &nbsp; <INPUT id=allSubmit type=submit value="Allianz Finden" /></td>\
            <TD class="xtab ptErrText"><SPAN id=ptallErr></span></td></tr><TR><TD class=xtab></td>\
             <TD class=xtab><INPUT align=left id=allListSubmit type=submit value="Alle Allianzen" /></td>\
             <TD class=xtab><INPUT align=left id=idMyAllSubmit type=submit value="'+ getMyAlliance()[1] +'"/></td>\
             <TD class=xtab>&nbsp;</td>\
             <TD class=xtab ><span><b><center>Ankunftszeit</center></b></span></td></tr>\
           <TR><TD height="43" class=xtab> </td><TD colspan="3" class=xtab><SPAN class=boldRed><u>Wichtig</u></span>: Die daten sind vom Leaderboard und können bis zu 24 Stunden alt sein!<br>\
<u><b>Hinweis</b></u>: Auf die Kopfspalte klicken zum Sortierten!<br>\
<b>ETA</b>: <i>estimated time of arrival</i> | voraussichtliche Ankunftszeit!</td>\
             <TD class=xtab ><div><center><select id="idFindETASelect">\
        <option value="0,250" >-- Auswählen --</option>\
        <option value="0,180" >Versorgungstruppe</option>\
        <option value="0,200" >Milizsoldat</option>\
        <option value="0,3000" >Späher</option>\
        <option value="0,300" >Lanzenträger</option>\
        <option value="0,275" >Schwertkämpfer</option>\
        <option value="0,250" >Bogenschütze</option>\
        <option value="1,1000" >Kavallerie</option>\
        <option value="1,750" >Schwere Kavallerie</option>\
        <option value="1,150" >Versorgungswagen</option>\
        <option value="1,100" >Ballisten</option>\
        <option value="1,120" >Rammbock</option>\
        <option value="1,80" >Steinschleuder</option>\
        </select></center></div>\
        </td></tr></table><span style="vertical-align:middle;" id=altInput></span></div><SPAN id=allListOut></span>';
      t.cont.innerHTML = m;
      document.getElementById('allSubmit').addEventListener ('click', t.eventSubmit, false);
      document.getElementById('playSubmit').addEventListener ('click', t.eventPlayerSubmit, false);
      document.getElementById('allAllName').addEventListener ('focus', function (){document.getElementById('ptallErr').innerHTML='';}, false);
      document.getElementById('allPlayName').addEventListener ('focus', function (){document.getElementById('ptplayErr').innerHTML='';}, false);
      document.getElementById('allListSubmit').addEventListener ('click', t.eventListSubmit, false);
      //document.getElementById('allGotoPage').addEventListener ('click', t.gotoPage, false);
      document.getElementById('idMyAllSubmit').addEventListener ('click', t.showMyAlliance, false);
      document.getElementById('idFindETASelect').addEventListener ('click', t.handleEtaSelect, false);
      //document.getElementById('allGotoPage').disabled = true;
      document.getElementById('idFindETASelect').disabled = true;
      t.ModelCity=Cities.cities[0];
      t.curPage = 0;
      t.MaxPage = -1;
      t.state = 1;
    }
  },

  pName : '',
  eventPlayerSubmit : function (){
    var t = Tabs.AllianceList;
    document.getElementById('ptplayErr').innerHTML='';
    var name = document.getElementById('allPlayName').value;
    t.pName = name;
    if (name.length < 3){
      document.getElementById('ptplayErr').innerHTML = '<blink>Mind. 3 Zeichen eingeben!</blink>';
      return;
    }
    document.getElementById('altInput').innerHTML = '';
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER><b>Versuche den gesuchten Spieler zu finden!</b></center>';
    t.fetchPlayerList (name, t.eventGotPlayerList);
  },
  
  eventGotPlayerList : function (rslt){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      document.getElementById('allListOut').innerHTML = rslt.errorMsg;
      return;
    }
    t.playerList = rslt.matchedUsers;
    var uList = [];
    for (k in rslt.matchedUsers)
      uList.push (rslt.matchedUsers[k].userId);     
    t.fetchPlayerStatus (uList, function(r){t.eventGotPlayerOnlineList(r)});    
  },    
    
  eventGotPlayerOnlineList : function (rslt){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      document.getElementById('allListOut').innerHTML = rslt.errorMsg;
      return;
    }
    var m = '<DIV class=ptstat>Ergebniss: <B>"'+ t.pName +'"</b></div>\
      <DIV style="height:575px; max-height:575px; overflow-y:auto">\
      <TABLE width=100% align=center class=ptTab cellspacing=0><TR style="font-weight:bold"><TD>Name</td>\
      <TD align=right>Macht</td><TD> &nbsp; Online</td><TD> &nbsp;Facebook &nbsp; </td><TD width=75%>Anzeigen </td></tr>';
    var row=0;
    var cl='';
    for (k in t.playerList){
      var u = t.playerList[k];
      if (++row % 2)
        cl = 'class=ptOddrow ';
      else
        cl = '';
      m += '<TR '+ cl +'valign=top><TD>'+ u.genderAndName +'</td><TD align=right>'+ addCommasInt(u.might) +'</td>\
          <TD>'+ (rslt.data[u.userId]?"&nbsp;<SPAN class=boldDarkGreen>ONLINE</span>":"") +'</td>\
          <TD align=center><A target="_tab" href="http://www.facebook.com/profile.php?id='+ u.fbuid +'">Profile</a></td>\
          <TD><SPAN onclick="PTpd(this, '+ u.userId +')"><A>Details</a> &nbsp; <BR></span><SPAN onclick="PTpl2(this,'+ u.userId+','+rslt.data[u.userId]+')"><A>Leaderboard</a><BR></span><SPAN onclick="PCplo(this, \''+ u.userId +'\')"><A>Login</a></span></td></tr>';
    }
    m += '</table></div>';
    document.getElementById('allListOut').innerHTML = m;
  },
  
    
  clickedPlayerDetail : function (span, uid){
    var t = Tabs.AllianceList;
    span.onclick = '';
    span.innerHTML = "suche spieler details...";
    t.fetchPlayerInfo (uid, function (r) {t.gotPlayerDetail(r, span)});
  },

  clickedPlayerLeaderboard : function (span, uid){
    var t = Tabs.AllianceList;
    span.onclick = '';
    span.innerHTML = "suche leaderboard daten...";
    t.fetchLeaderboard (uid, function (r) {t.gotPlayerLeaderboard(r, span)});
  },

  clickedPlayerLeaderboard2 : function (span, uid,status){
    var t = Tabs.AllianceList;
    span.onclick = '';
    span.innerHTML = "suche leaderboard daten...";
    t.fetchLeaderboard (uid, function (r) {t.gotPlayerLeaderboard2(r, span,uid,status)});
  },
  
  clickedPlayerGetLastLogin : function (span, uid){
     var t = Tabs.AllianceList;
     span.onclick = '';
     span.innerHTML = "suche login daten...";
     t.fetchPlayerLastLogin (uid, function (r) {t.gotPlayerLastLogin(r, span)});
   },

  gotPlayerLeaderboard2 : function (rslt,span,uid,status){
   // alert(uid+'/'+status);
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      span.innerHTML = rslt.errorMsg;
      return;
    }
    if (rslt.totalResults == 0){
      span.innerHTML = '<B>Leaderboard:</b> niemanden gefunden! (evtl. im Nebel?)';
      return;
    }
    var myA = getMyAlliance ();
    t.dat = [];
    //logit ("gotPlayerLeaderboard2 -1 "+JSON2.stringify(rslt));
    var p = rslt.results[0];
        if ( myA[0] == p.allianceId)
           t.friendEta = true;
        else
           t.friendEta = false;
        for (var c=0; c<p.cities.length; c++){
          t.dat.push ([p.displayName, parseInt(p.might), p.officerType, parseInt(p.numCities), parseInt(p.cities[c].tileLevel),
               parseInt(p.cities[c].xCoord), parseInt(p.cities[c].yCoord), p.cities[c].cityName, 0, status,0,p.userId]);
        }
        t.setDistances (Cities.cities[0].x, Cities.cities[0].y);
        t.ModelCity=Cities.cities[0];
        t.setEta();
        t.fetchPlayerLastLogin (uid, function (r) {t.displayPlayer(p.allianceName,r)});
        //t.fetchPlayerLastLogin();
        //t.displayPlayer (p.allianceId);
  },
  
  
  gotPlayerLeaderboard : function (rslt, span){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      span.innerHTML = rslt.errorMsg;
      return;
    }
    if (rslt.totalResults == 0){
      span.innerHTML = '<B>Leaderboard:</b> niemanden gefunden! (evtl. im Nebel?)';
      return;
    }
    var p = rslt.results[0];
    var an = p.allianceName;
    if (!an || an=='' || p.officerType==4)
      an = 'none';
    else
      an += ' ('+ officerId2String(p.officerType) +')';
    pStr = JSON2.stringify(p);
    logit (pStr);
    m = '<TABLE cellspacing=0 class=ptTab><TR><TD><B>Leaderboard: </b></td><TD colspan=2> Macht: '+ p.might  +' &nbsp; Allianz: '+ an +'</td></tr>'; 
    for (var i=0; i<p.cities.length; i++){
      var c = p.cities[i];
      var created = '';
      if (c.dateCreated && c.dateCreated.substr(0,2)=='20')
        created = ' &nbsp; Erstellt: ' + c.dateCreated.substr(0,10);
      m += '<TR><TD align=right><B>Stadt #'+ (i+1) +':</b></td><TD> &nbsp; '+ c.cityName 
      +' (<a onclick="ptGotoMap ('+ c.xCoord +',' +c.yCoord+ ')">'+ c.xCoord +','+ c.yCoord +'</a>)</td><TD width=75%> &nbsp; Level: '
        + c.tileLevel +' &nbsp; Status: '+ cityStatusString (c.cityStatus) + created +'</td></tr>';
    }  
    span.innerHTML = m + '</table>';
  },
    
  gotPlayerDetail : function (rslt, span){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      span.innerHTML = rslt.errorMsg;
      return;
    }
    var u = rslt.userInfo[0];
    var a = 'None';
    if (u.allianceName)
      a = u.allianceName +' ('+ getDiplomacy(u.allianceId) + ')';
    var m = '<TABLE cellspacing=0 class=ptTab><TR><TD><B>Details:</b> &nbsp; </td><TD><b>Allianz</b> '+ a +' &nbsp; <b>Städte</b> '
          + u.cities +' &nbsp; <b>Bevölkerung</b> '+ u.population +'</td></tr><TR><TD></td><TD><b>Provinzen</b> ';
    var pids = u.provinceIds.split (',');
    var p = [];
    for (var i=0; i<pids.length; i++)
      p.push(unsafeWindow.provincenames['p'+pids[i]]);
    span.innerHTML = m + p.join (', ') +'</td></tr></table>';
  },

  eventMyAllianceSubmit : function (){
    var t = Tabs.AllianceList;
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER>Searching2 ...</center>';
    t.fetchAllianceMemberList (getMyAlliance()[0], null, t.eventGotMemberList);
  },  
    
  aName : '',
  eventSubmit : function (){
    var t = Tabs.AllianceList;
    document.getElementById('ptallErr').innerHTML='';
    t.aName = document.getElementById('allAllName').value;
    if (t.aName.length < 3){
      document.getElementById('ptallErr').innerHTML = '<blink>Mind. 3 Zeichen eingeben!</blink>';
      return;
    }
    var myA = getMyAlliance ();
    document.getElementById('altInput').innerHTML = '';
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER><b>Verusche die gesuchte Allianz zu finden!</b></center>';
    if (myA[0]!=0 && myA[1].toLowerCase().indexOf(t.aName.toLowerCase())>=0 )
      t.fetchAllianceList (t.aName, myA[0], t.eventGotAllianceList);
    else
      t.fetchAllianceList (t.aName, null, t.eventGotAllianceList);
  },

  eventListSubmit : function (){
    var t = Tabs.AllianceList;
    var myA = getMyAlliance ();
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER><b>Durchsuche Leaderboard nach allen Allianzen!</b></center>';
    if (myA[0]!=0  ) {
       t.curPage=1;
       t.fetchOtherAllianceInfo ( 1, t.eventGotOtherAlliancePage);
       //document.getElementById('allGotoPage').disabled = false;
    }
    else {
       document.getElementById('allListOut').innerHTML = '<blink><b>Du must in einer Allianz sein um dieses Feature nutzen zu können!</b></blink>';
    }
  },
/*
  eventGotAllianceList : function (rslt){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      document.getElementById('allListOut').innerHTML = rslt.errorMsg;
      return;
    }
    var m = '<DIV class=ptstat>Showing alliances matching <B>"'+ t.aName +'"</b></div>\
    <TABLE><TR style="font-weight:bold"><TD class=xtab>Allianz</td><TD class=xtab>Rang</td><TD class=xtab>Spieler</td>\
        <TD align=right class=xtab>Macht</td><TD class=xtab>Diplomatie</td><TD class=xtab></td></tr>';
    for (k in rslt.alliancesMatched){
      var all = rslt.alliancesMatched[k];
      var dip = '';
      if (all.relation && all.relation==1)
        dip = 'Friendly';
      else if (all.relation && all.relation==2)
        dip = 'Hostile';
      m += '<TR><TD class=xtab>'+ all.allianceName +'</td><TD align=right class=xtab>'+ all.ranking +'</td><TD align=right class=xtab>'+ all.membersCount +'</td>\
       <TD align=right class=xtab>'+ addCommasInt(all.might) +'</td><TD class=xtab>'+ dip +'</td>\
       <TD class=xtab><a onclick="PTgetMembers('+ all.allianceId +')">Spieler Anzeigen</a></td></tr>';
    }
    document.getElementById('allListOut').innerHTML = m;
  },
*/
eventGotAllianceList : function (rslt){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      document.getElementById('allListOut').innerHTML = rslt.errorMsg;
      return;
    }
    var m = '<DIV class=ptstat>'+uW.g_js_strings.commonstr.alliances+'<B>"'+ t.aName +'"</b></div>\
    <TABLE><TR style="font-weight:bold"><TD class=xtab>'+uW.g_js_strings.commonstr.alliance+'</td><TD class=xtab>'+uW.g_js_strings.commonstr.rank+'</td><TD class=xtab>'+uW.g_js_strings.commonstr.members+'</td>\
        <TD align=right class=xtab>'+uW.g_js_strings.commonstr.might+'</td><TD class=xtab>'+uW.g_js_strings.getAllianceSearchResults.currdiplo+'</td><TD class=xtab></td><TD class=xtab></td></tr>';
    for (k in rslt.alliancesMatched){
      var all = rslt.alliancesMatched[k];
      var dip = '';
      if (all.relation && all.relation==1)
        dip = uW.g_js_strings.commonstr.friendly;
      else if (all.relation && all.relation==2)
        dip = uW.g_js_strings.commonstr.hostile;
      m += '<TR><TD class=xtab>'+ all.allianceName +'</td><TD align=right class=xtab>'+ all.ranking +'</td><TD align=right class=xtab>'+ all.membersCount +'</td>\
       <TD align=right class=xtab>'+ addCommasInt(all.might) +'</td><TD class=xtab>'+ dip +'</td>\
       <TD class=xtab><a onclick="PTgetMembers('+ all.allianceId +')">'+uW.g_js_strings.commonstr.members+'</a></td>\
        <TD class=xtab><a onclick="PTPaintMembers('+ all.allianceId +')">'+uW.g_js_strings.commonstr.viewmap+'</a></td></tr>';
    }
    document.getElementById('allListOut').innerHTML = m;
  },
/*
  showMyAlliance : function (){
    var t = Tabs.AllianceList;
    var myA = getMyAlliance ();
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER>5 ...</center>';
    if (myA[0]!=0  ) {
       t.eventGetMembers(myA[0]);
    }
    else {
       document.getElementById('allListOut').innerHTML = '<blink><b>Du must in einer Allianz sein um dieses Feature nutzen zu können!</b></blink>';
    }
  },
*/
showMyAlliance : function (){
    var t = Tabs.AllianceList;
    var myA = getMyAlliance ();
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER>'+uW.g_js_strings.commonstr.loadingddd+'</center>';
    if (myA[0]!=0  ) {
       t.eventGetMembers(myA[0],false);
    }
    else {
       document.getElementById('allListOut').innerHTML = uW.g_js_strings.membersInfo.youmustbelong;
    }
  },
  curPage : 0,
  MaxPage : 0,

  eventListNext : function (amt){
    var t = Tabs.AllianceList;
    if( parseInt(amt) >= 9999 )
       t.curPage = t.MaxPage;
    else {
	    t.curPage = parseInt(t.curPage) + parseInt(amt);
	    if ( t.curPage > t.MaxPage) {
	      t.curPage = t.MaxPage;
	    }
    }
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER><b>weiter...</b></center>';
    t.fetchOtherAllianceInfo (t.curPage, t.eventGotOtherAlliancePage);
  },

  eventListPrev : function (amt){
    var t = Tabs.AllianceList;
    if(amt <= -1)
       t.curPage = 1;
    else {
	    t.curPage-=amt;
	    if ( t.curPage < 1 ) {
	      t.curPage = 1;
	    }
    }
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER><b>zurück...</b></center>';
    t.fetchOtherAllianceInfo (t.curPage, t.eventGotOtherAlliancePage);
  },

  gotoPage : function (){
    var t = Tabs.AllianceList;
    //var val = document.getElementById('idPageNum').value;
    if (t.MaxPage < 0 ) {
      document.getElementById('allListOut').innerHTML = 'Erst Allianz Auflisten!';
      return;
    }
    if (t.MaxPage < 0 || val > t.MaxPage || val < 1) {
      document.getElementById('allListOut').innerHTML = '<blink><b>Seite ist nicht vorhanden!</b></blink>';
      return;
    }
    //t.curPage = val;
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER> 9...</center>';
    t.fetchOtherAllianceInfo (t.curPage, t.eventGotOtherAlliancePage);
  },

  eventGotOtherAlliancePage : function (rslt){
    var t = Tabs.AllianceList;

    if (!rslt.ok){
      document.getElementById('allListOut').innerHTML = rslt.errorMsg;
      return;
    }

    //	document.getElementById('idPageNum').value = t.curPage;

    t.MaxPage=rslt.noOfPages;
    //document.getElementById('idMaxPageNum').innerHTML = 'of ' + t.MaxPage;

    var m = '<div style="overflow:auto; height:556px;width:700px;"><TABLE><thead><TR style="font-weight:bold"> \
        <th class=xtab>'+uW.g_js_strings.modaltitles.alliance+'</th><th class=xtab>'+uW.g_js_strings.commonstr.rank+'</th><th class=xtab>'+uW.g_js_strings.commonstr.members+'</th>\
        <th align=right class=xtab>'+uW.g_js_strings.commonstr.might+'</th><th class=xtab>'+uW.g_js_strings.getAllianceSearchResults.currdiplo+'</th><th class=xtab></th><th class=xtab></th></tr></thead><tbody>';
    document.getElementById('allListOut').innerHTML = m;



    for (var i=0; i<rslt.otherAlliances.length; i++) {
      var alliance = rslt.otherAlliances[i];
      var dip = '';
      dip = getDiplomacy(alliance.allianceId);

      m += '<TR class="'+ dip + '"><TD class=xtab>' + alliance.name +'</td><TD align=right class=xtab>'+ alliance.ranking +'</td><TD align=right class=xtab>'+ alliance.membersCount +'</td>\
       <TD align=right class=xtab>'+ addCommasInt(alliance.might) +'</td><TD class=xtab>'+ dip +'</td>\
	   <TD class=xtab><a onclick="PTgetMembers('+ alliance.allianceId +')">Spieler</a></td>\
       <TD class=xtab><a onclick="PTPaintMembers('+ alliance.allianceId +')">Karte</a></td></tr>';
    }
    m += '</tbody></TABLE><div style="font-weight:bold"; height:20px;width:560px; ><span> <a onclick="PTalClickPrev(-1)"> [Anfang] </a><a onclick="PTalClickPrev(10)"> [-10] </a><a onclick="PTalClickPrev(5)"> [-5] </a><a onclick="PTalClickPrev(1)"> [zurück] </a> \
          <a onclick="PTalClickNext(1)"> [weiter] </a><a onclick="PTalClickNext(5)"> [+5] </a><a onclick="PTalClickNext(10)"> [+10] </a><a onclick="PTalClickNext(9999)"> [Ende] </a> </span></div>';
    m += '</div>';
    document.getElementById('allListOut').innerHTML = m;
 },

  showCurrentPage : function (){
    var t = Tabs.AllianceList;
    var myA = getMyAlliance ();

    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER> 10...</center>';
    if (myA[0]!=0  ) {
       t.fetchOtherAllianceInfo ( t.curPage, t.eventGotOtherAlliancePage);
    }
    else {
       t.fetchOtherAllianceInfo ( t.curPage, t.eventGotOtherAlliancePage);
    }

  },

  eventGotMemberList : function (rslt){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      document.getElementById('allListOut').innerHTML = rslt.errorMsg;
      return;
    }
    t.memberListRslt = rslt;
    var uList = [];
    for (k in rslt.results)
      uList.push (rslt.results[k].userId);     
    t.fetchPlayerStatus (uList, function(r){t.eventGotMemberOnlineList(r)});    
  },    
    
  eventGotMemberOnlineList : function (rslt){
    var t = Tabs.AllianceList;
    var numInvalid = 0;
    var numPlayers = 0;
    var myA = getMyAlliance ();
    t.dat = [];
    for (var i=0; i<t.memberListRslt.results.length; i++){
      p = t.memberListRslt.results[i];
      if (p.userId == 0){
        ++numInvalid;
      } else {
        ++numPlayers;
        if ( myA[0] == p.allianceId)
           t.friendEta = true;
        else
           t.friendEta = false;
        for (var c=0; c<p.cities.length; c++){
          t.dat.push ([p.displayName, parseInt(p.might), p.officerType, parseInt(p.numCities), parseInt(p.cities[c].tileLevel),
               parseInt(p.cities[c].xCoord), parseInt(p.cities[c].yCoord), p.cities[c].cityName, 0, rslt.data[p.userId]?1:0,'NA',p.userId]);
        }
      }
    }
    t.setDistances (Cities.cities[0].x, Cities.cities[0].y);
    t.ModelCity=Cities.cities[0];
    t.setEta();
    t.displayMembers (t.memberListRslt.allianceName, numPlayers);
  },

  // sort and display
  reDisp : function (){
    var t = Tabs.AllianceList;
    function sortFunc (a, b){
      var t = Tabs.AllianceList;
      if (typeof(a[t.sortColNum]) == 'number'){
        if (t.sortDir > 0)
          return a[t.sortColNum] - b[t.sortColNum];
        else
          return b[t.sortColNum] - a[t.sortColNum];
      } else if (typeof(a[t.sortColNum]) == 'boolean'){
// TODO !!        
return 0;        
      } else {
        if (t.sortDir > 0)
          return a[t.sortColNum].localeCompare(b[t.sortColNum]);
        else
          return b[t.sortColNum].localeCompare(a[t.sortColNum]);
      }
    }
    t.dat.sort (sortFunc);
    var m = '';
    for (var i=0; i<t.dat.length; i++){
    m += '<TR style="max-height:30px"><TD class=xxtab>'+ t.dat[i][0] +'</td><TD align=right class=xxtab>'+ addCommasInt(t.dat[i][1]) 
         +'</td><TD align=center class=xxtab>'+ t.dat[i][3] +'</td><TD class=xxtab>'+ t.dat[i][7] +'</td><TD class=xxtab>'+ officerId2String(t.dat[i][2]) +'</td><TD align=center class=xxtab><DIV onclick="ptGotoMap('+ t.dat[i][5] +','+ t.dat[i][6] +')"><A>'+ t.dat[i][5] +','+ t.dat[i][6] +'</a></div></td><TD class=xxtab>'+ (t.dat[i][9]?'<SPAN class=boldDarkGreen>ONLINE</span>':'') +'</td><td class=xxtab><SPAN onclick="PCplo(this, \''+ t.dat[i][11] +'\')"><A>Login Daten</a></span></td>\
            <TD align=right class=xxtab style="padding-right:20px;">'+ t.dat[i][8].toFixed(2) +'</td>\
			<TD  nowrap class=xxtab>'+ (t.dat[i][10]?'<SPAN>'+ (t.dat[i][10]>0?timestr(t.dat[i][10],1):'NA') +'</span>':'<SPAN>NA</span>') +'\
         <TD align=right class=xxtab>'+ t.dat[i][4] + ' </td></tr>';
    }
    var tbody = document.getElementById('allBody');
    tbody.style.maxHeight = '';
    tbody.innerHTML = m;


    if (parseInt(tbody.clientHeight) > 470){
      tbody.style.height = '470px';
      tbody.style.maxHeight = '470px';
    }
//new CtableToText('tabAllMembers').toText();
  },


  setDistances : function (x, y){
    var t = Tabs.AllianceList;
    for (var i=0; i<t.dat.length; i++)
      t.dat[i][8] = distance (x, y, t.dat[i][5], t.dat[i][6]);
  },

  friendEta:false,

  setEta : function (){
    var t = Tabs.AllianceList;
    for (var i=0; i<t.dat.length; i++) {
      if (t.dat[i][8]) {
        var eta = t.estETA(parseFloat(t.dat[i][8]));
        if (t.friendEta)
           t.dat[i][10] = eta.friendETA;
        else
           t.dat[i][10] = eta.ETA;
      }
    }
  },



  handleEtaSelect : function (){
    var t = Tabs.AllianceList;
    t.setEta();
    t.reDisp();
  },

  sortColNum : 8,
  sortDir : 1,

  displayMembers : function (allName, numPlayers){
    var t = Tabs.AllianceList;
    function alClickSort (e){
      var t = Tabs.AllianceList;
      var newColNum = e.id.substr(8);
      document.getElementById('clickCol'+t.sortColNum).className = 'clickable';
      e.className='clickable clickableSel';
      if (newColNum == t.sortColNum)
        t.sortDir *= -1;
      else
        t.sortColNum = newColNum;
      t.reDisp();
    }
    unsafeWindow.PTalClickSort = alClickSort;
    var m = '<STYLE>.clickable{background-color:#ddd; border:2px outset; border-color:#555; padding-left:5px; padding-right:5px}\
            .clickableSel{background-color:#ffffcc;}\
            .xxtab{background-color:none; padding-left:5px; padding-right:5px;} </style>\
      <DIV class=ptstat ><TABLE id=tabAllMembers cellpadding=0  width=100%><TR font-weight:bold"><TD class=xtab>Allianz: '+ allName +'</td>\
        <TD class=xtab width=80% align=center>Entfernung von <SPAN id=distFrom>'+ Cities.cities[0].name +' ('+ Cities.cities[0].x +','+ Cities.cities[0].y +')</span></td><TD class=xtab align=right>Spieler: '+ numPlayers +' </td></tr></table></div>\
      <div style="max-height:470px; height:470px; overflow-y:auto;"><TABLE id=tabAllMembers align=center cellpadding=0 cellspacing=0><THEAD style="overflow-y:hidden;">\
      <TR style="font-weight:bold"><TD id=clickCol0 onclick="PTalClickSort(this)" class=clickable><A><DIV>Spieler</div></a></td>\
        <TD id=clickCol1 onclick="PTalClickSort(this)" class=clickable align=center><A><DIV>Macht</a></div></td>\
        <TD id=clickCol3 onclick="PTalClickSort(this)" class=clickable><A><DIV>#</a></div></td>\
		<TD id=clickCol7 onclick="PTalClickSort(this)" class=clickable><A><DIV>Stadt</a></div></td>\
        <TD id=clickCol2 onclick="PTalClickSort(this)" class=clickable align=center><A><DIV>Rang</a></div></td>\
        <TD id=clickCol5 onclick="PTalClickSort(this)" class=clickable><A><DIV>Koord</a></div></td>\
		<TD id=clickCol9 onclick="PTalClickSort(this)" class=clickable align=center><A><DIV>Online</a></div></td>\
		<TD class=clickable><A><DIV>Login</a></div></td>\
        <TD id=clickCol8 onclick="PTalClickSort(this)" class=clickable><A><DIV>Entf.</a></div></td>\
        <TD id=clickCol10 onclick="PTalClickSort(this)" class=clickable><A><DIV>Eta</a></div></td>\
		 <TD id=clickCol4 onclick="PTalClickSort(this)" class=clickable><A><DIV>Lvl</a></div></td>\
        </tr></thead>\
      <TBODY id=allBody style="background-color:#ffffff;"></tbody></table></div>';
      
    document.getElementById('allListOut').innerHTML = m; //style="top:670px; left:0px; position:absolute;
    document.getElementById('altInput').innerHTML = '<HR><TABLE width=100% cellpaddding=0><TR align=center>\
        <TD class=xtab>Entfernung von: &nbsp; X: <INPUT size=2 type=text id=plyrX /> Y: <INPUT size=2 type=text id=plyrY /> <span id=dmcoords></span></td></tr></table>';
    document.getElementById('clickCol'+t.sortColNum).className = 'clickable clickableSel';

    t.reDisp();
    new CdispCityPicker ('plyrdcp', document.getElementById ('dmcoords'), true, t.eventCoords, 0).bindToXYboxes(document.getElementById('plyrX'), document.getElementById('plyrY'));
    document.getElementById('idFindETASelect').disabled = false;
  },
  
  displayPlayer : function (allName,rslt){
    var t = Tabs.AllianceList;
    function alClickSort (e){
      var t = Tabs.AllianceList;
      var newColNum = e.id.substr(8);
      document.getElementById('clickCol'+t.sortColNum).className = 'clickable';
      e.className='clickable clickableSel';
      if (newColNum == t.sortColNum)
        t.sortDir *= -1;
      else
        t.sortColNum = newColNum;
      t.reDisp();
    }
    unsafeWindow.PTalClickSort = alClickSort;
    var m = '<STYLE>.clickable{background-color:#ddd; border:2px outset; border-color:#555; padding-left:5px; padding-right:5px}\
            .clickableSel{background-color:#ffffcc;}\
            .xxtab{background-color:none; padding-left:5px; padding-right:5px;} </style>\
            <DIV class=ptstat ><TABLE id=tabAllMembers cellpadding=0  width=100%><TR font-weight:bold"><TD class=xtab>Allianz: '+ allName +'</td>\
              <TD class=xtab width=80% align=center>Letzter Login: <SPAN id=lastlogin>'+  rslt.playerInfo.lastLogin+'</span></td><TD class=xtab align=right></td></tr></table></div>\
      <div style="max-height:470px; height:470px; overflow-y:auto;"><TABLE id=tabAllMembers align=center cellpadding=0 cellspacing=0><THEAD style="overflow-y:hidden;">\
      <TR style="font-weight:bold"><TD id=clickCol0 onclick="PTalClickSort(this)" class=clickable><A><DIV>Spieler</div></a></td>\
        <TD id=clickCol1 onclick="PTalClickSort(this)" class=clickable align=center><A><DIV>Macht</a></div></td>\
        <TD id=clickCol3 onclick="PTalClickSort(this)" class=clickable><A><DIV>#</a></div></td>\
				 <TD id=clickCol7 onclick="PTalClickSort(this)" class=clickable><A><DIV>Stadt</a></div></td>\
        <TD id=clickCol2 onclick="PTalClickSort(this)" class=clickable align=center><A><DIV>Rang</a></div></td>\
        <TD id=clickCol5 onclick="PTalClickSort(this)" class=clickable><A><DIV>Koord.</a></div></td>\
		<TD id=clickCol9 onclick="PTalClickSort(this)" class=clickable align=center><A><DIV>Online</a></div></td>\
		<TD class=clickable><A><DIV>Login</a></div></td>\
        <TD id=clickCol8 onclick="PTalClickSort(this)" class=clickable><A><DIV>Entf.</a></div></td>\
        <TD id=clickCol10 onclick="PTalClickSort(this)" class=clickable><A><DIV>Eta</a></div></td>\
		<TD id=clickCol4 onclick="PTalClickSort(this)" class=clickable><A><DIV>Lvl</a></div></td>\
		</tr></thead>\
      <TBODY id=allBody style="background-color:#ffffff;"></tbody></table></div>\
      <DIV  width:100%; style="top:670px; left:0px; position:absolute; background-color:#ffffff; border-top:1px solid; margin-top:8px; color:#700; font-weight:bold;">';
    document.getElementById('allListOut').innerHTML = m;  //style="top:670px; left:0px; position:absolute;
    document.getElementById('altInput').innerHTML = '<HR><TABLE width=100% cellpaddding=0><TR align=center>\
        <TD class=xtab>Entfernung von: &nbsp; X: <INPUT size=2 type=text id=plyrX /> Y: <INPUT size=2 type=text id=plyrY /> <span id=dmcoords></span></td></tr></table>';
    document.getElementById('clickCol'+t.sortColNum).className = 'clickable clickableSel';

    t.reDisp();
    new CdispCityPicker ('plyrdcp', document.getElementById ('dmcoords'), true, t.eventCoords, 0).bindToXYboxes(document.getElementById('plyrX'), document.getElementById('plyrY'));
    document.getElementById('idFindETASelect').disabled = false;
  },
  
  eventCoords : function (city, x, y){
    var t = Tabs.AllianceList;
    var m = '';
    if (city != null)
      m = city.name +' ('+ city.x +','+ city.y +')';
    else
      m = x +','+ y;
    var distFrom = document.getElementById('distFrom');
    if (distFrom)
        distFrom.innerHTML = m;
    t.ModelCity=city;
    t.setDistances(x,y);
    t.setEta();
    t.reDisp();
  },

  eventGetMembers : function (aid){
    var t = Tabs.AllianceList;
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER><b>Durchsuche Leaderboard nach Allianz daten!</b></center>';
    t.fetchAllianceMemberList (aid, null, t.eventGotMemberList);
  },

  fetchAllianceMemberList : function (allianceId, allianceName, notify) {
    var t = Tabs.AllianceList;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.perPage = 100;
    if (allianceName)
      params.allianceName = allianceName;
    if (allianceId && allianceId != 0)
      params.allianceId = allianceId;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getUserLeaderboard.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },
GetDataForMap : function (allianceId) {
    var t = Tabs.AllianceList;
    var params = uW.Object.clone(uW.g_ajaxparams);
    var Data=[];
    params.perPage = 100;
    params.allianceId = allianceId;
    
    new MyAjaxRequest(uW.g_ajaxpath + "ajax/getUserLeaderboard.php" + uW.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
      	var city = '';
      	for (var i=0; i<rslt.results.length; i++) {
      		//alert(rslt.results[i].toSource());
      	    if (rslt.results[i]['userId'] !=0){
	      	    player = rslt.results[i]['cities'];
	      	    for (var ii=0; ii<player.length; ii++) 
	      			Data.push ({X:player[ii]['xCoord'],Y:player[ii]['yCoord']});
	    	}  	
        }
        if (Data != []) t.PaintDataOnMap(Data);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },
  
  PaintDataOnMap : function(Data){
  		var provMapCoordsA = {imgWidth:710, imgHeight:708, mapWidth:670, mapHeight:670, leftMargin:31, topMargin:19};  
  		var map = '<DIV id=ptAlliProvMap style="height:'+ provMapCoordsA.imgHeight +'px; width:'+ provMapCoordsA.imgWidth +'px; background-repeat:no-repeat; background-image:url(\''+ URL_PROVINCE_MAP +'\')"></div>';
  	    
		//Data = [{X:"700", Y:"700"}, {X:"600", Y:"600"}, {X:"500", Y:"500"},{X:"400", Y:"400"},{X:"300", Y:"300"},{X:"200", Y:"200"},{X:"100", Y:"100"},{X:"0", Y:"0"},{X:"750", Y:"750"}, {X:"650", Y:"650"}, {X:"550", Y:"550"},{X:"450", Y:"450"},{X:"350", Y:"350"},{X:"250", Y:"250"},{X:"150", Y:"150"},{X:"50", Y:"50"}];
  	    			
		document.getElementById('allListOut').innerHTML = map;
		var eMap =  document.getElementById('ptAlliProvMap');
		
		for (var cc=0; cc<Seed.cities.length; cc++) {
		    var city = Seed.cities;
		    var Xplot = parseInt((provMapCoordsA.mapWidth * parseInt(city[cc][2])) / 750);
		    var Yplot = parseInt((provMapCoordsA.mapHeight * parseInt(city[cc][3])) / 750);
		    var cf = document.createElement ('div');
		    cf.style.background = 'black';
		    cf.style.opacity = '1.0';
		    cf.style.position='relative';
		    cf.style.display='block';
		    cf.style.width='14px';
		    cf.style.height='16px';
		    cf.style.border='1px solid #fff';
		    cf.style.color = 'white';
		    cf.style.textAlign = 'center';
		    cf.style.top = (Yplot+provMapCoordsA.topMargin-(cc*16)-8) +'px';      
		    cf.style.left = (Xplot+provMapCoordsA.leftMargin-7) +'px';
		    cf.innerHTML = (cc+1) +'';
		    eMap.appendChild(cf);
		    
		}

		for (var i=0;i<Data.length;i++) {
			var x = parseInt(Data[i]['X']);
			var y = parseInt(Data[i]['Y']);
  	        var xplot = parseInt((provMapCoordsA.mapWidth * x) / 750);
  	        var yplot = parseInt((provMapCoordsA.mapHeight * y) / 750);
  	    	var ce= document.createElement ('div');
  	    		ce.style.background = 'red';
  	    		ce.style.opacity = '1.0';
  	    		ce.style.position='relative';
  	    		ce.style.display='block';
  	    		ce.style.width='4px';
  	    		ce.style.height='4px';
  	    	ce.style.top = (yplot+provMapCoordsA.topMargin -(4*i)-((Seed.cities.length)*18)) +'px';      
  	    	ce.style.left = (xplot+provMapCoordsA.leftMargin -2) +'px';
  	        eMap.appendChild(ce);
  	   }
  	   
  	   
  },
  
  fetchLeaderboard : function (uid, notify) {
    var t = Tabs.AllianceList;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.userId = uid;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getUserLeaderboard.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },

  fetchAllianceList : function (allianceName, myAid, notify) {   // at least 3 chars :)
    var t = Tabs.AllianceList;
    function combineResults (rsltA, rsltM, notify){
      if (!rsltA.ok){
        if (rsltA.msg.indexOf("No alliance found under")!=0 || !rsltM.ok){
          notify (rsltA);
          return;
        }
        rsltA.ok = true;
        rsltA.count = 0;
        rsltA.alliancesMatched = {};
      }
      if (rsltM.ok){
        rsltA.alliancesMatched['a'+rsltM.allianceInfo.allianceId] = {allianceId: rsltM.allianceInfo.allianceId, allianceName: rsltM.allianceInfo.allianceName,
              membersCount: rsltM.allianceInfo.members, relation: null, might: rsltM.allianceInfo.might, ranking: rsltM.allianceInfo.ranking};
        ++rsltA.count;
      }
      notify (rsltA);
    }
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.allianceName = allianceName;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetSearchResults.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        if (myAid!=null && myAid>0)
          t.fetchMyAllianceInfo  (function (r){ combineResults (rslt, r, notify)});
        else
          notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },

  fetchOtherAllianceInfo : function (pageNum, notify){    // as in alliance list, sorted by rank, 10 per page
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.pageNo = pageNum;
    params.cityId = unsafeWindow.currentcityid;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetOtherInfo.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },

  fetchMyAllianceInfo : function (notify){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetInfo.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },

  fetchPlayerList : function (name, notify){  // at least 3 chars!! 
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.searchName = name;
    params.subType = "ALLIANCE_INVITE";
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/searchPlayers.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },

  fetchPlayerInfo : function (uid, notify){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.uid = uid;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getUserGeneralInfo.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },
  
/***
ajax/getOnline.php:
  (string) ok = true
  (object) data = [object Object]
    (boolean) 4394121 = false
  (undefined) errorMsg: null = null
***/
  fetchPlayerStatus : function (uidArray, notify){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.checkArr = uidArray.join(',');
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getOnline.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },
  
  fetchPlayerLastLogin : function (uid, notify){
      var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
      params.pid = uid;
      new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/viewCourt.php" + unsafeWindow.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (rslt) {
          notify (rslt);
        },
        onFailure: function (rslt) {
          notify ({errorMsg:'AJAX error'});
        },
      });
    },
    
    gotPlayerLastLogin : function (rslt, span){
        var t = Tabs.AllianceList;
        if (!rslt.ok){
          span.innerHTML = rslt.errorMsg;
          return;
        }
    
        var p = rslt.playerInfo;
        var lastLogin = rslt.playerInfo.lastLogin;
    
        if (lastLogin) {
          m = '<span style="color:black"><b>Login</b><font color=#600000> '+lastLogin+'</font></span>';
        } else {
           m = '<span style="color:red">keine Login daten gefunden: '+lastLogin+'</span>';
        }
        span.innerHTML = m + '';
      },

  ModelCity : {},

  estETA : function(dist) { // Need Relief Station Levels to estimate transport, reinf, or reassign times. 
    var t = Tabs.AllianceList;
    var ret={ETA:0,etaStr:'NA',friendETA:0,friendEtaStr:'NA'};    
    var cityID;
    if (dist <= 0) return ret;
    var EtaType = document.getElementById('idFindETASelect');
    var baseSpeedSel = EtaType.options[EtaType.selectedIndex].value;
    var m = baseSpeedSel.split(',');
    var horse = 0;
    var baseSpeed = 0;
    if(m) {
      horse = parseInt(m[0]);
      baseSpeed = parseInt(m[1]);
    }
    if (baseSpeed == 0) return ret;
    var mmLvl = parseInt(Seed.tech.tch11);//Magical Mapping
    var Speed = 0;
    if (horse){
   //HorsesSiegeSpeed = Base * (1 + MM/10) * (1 + AH/20) 
      var hsLvl = parseInt(Seed.tech.tch12);//Alloy Horse Shoes
      Speed = baseSpeed * (1 + mmLvl/10.0) * (1 + hsLvl/20.0);
    }
    else {
    //FootSpeed = Base * (1 + MM/10)
      Speed = baseSpeed * (1 + mmLvl/10.0);
    }
    //Grid Speed (tiles/second) = Speed (100ths/min) / 6000 
    var gSpeed = 0;
    var estSec;
    if (Speed>0) {
      gSpeed = Speed/6000.0;//0.48333 mm=10, hs=9
      estSec = (parseFloat(dist)/gSpeed).toFixed(0);
    }
    ret.ETA = (parseInt((estSec+''))+30); 
    ret.etaStr = timestr (ret.ETA,1);
    //ret.etaStr = ret.ETA + ', ' + timestr (ret.ETA,1);
    //RS - Cities Relief Station Level
    //Friendly Speed = Speed * (1 + RS/2)
    if (t.ModelCity) {
      cityID = t.ModelCity.id;
      var building = getCityBuilding (cityID, 18);
      if (building) {
        fSpeed = Speed * (1 + parseInt(building.maxLevel)/2);
        gSpeed = fSpeed/6000;
        estSec = (dist/gSpeed).toFixed(0);
        ret.friendETA = parseInt((estSec+''))+30; 
        ret.friendEtaStr = timestr ((ret.friendETA+''),1);
      }
   }
    return ret;
  },
};

/*********************************** Fake TAB ***********************************/

Tabs.F = {
   tabLabel : 'F',
  tabOrder : toFake,
  tabDisabled : !ENABLE_TEST_TAB,
  cont : null,

  init : function (div){
    var t = Tabs.F;
    t.cont = div;
  var citySelect = '  <SELECT id=fakeCity>';
      for (var c=0; c<Cities.numCities; c++) {
        aCity = Cities.cities[c].name + ' ('+Cities.cities[c].x + ','+ Cities.cities[c].y+')';
           citySelect += '<option value=\''+c+'\'>'+aCity+'</option>';
      }
      citySelect += '</select>';
    var m = '<div class=ptstat>FAKE ANGRIFF</div><DIV id=testDiv style="background-color:#fffff0; maxwidth:675; max-height:630px; height:630px; overflow-y:auto;"> <TABLE><TR><TD align=right>Späh Angriff: </td><TD><INPUT type=checkbox id=fakeIsScout></td></tr>\
        <TR><TD align=right>Wildniss Angreifen: </td><TD><INPUT type=checkbox id=fakeIsWild></td></tr>\
        <TR><TD align=right>Fake Bericht: </td><TD><INPUT type=checkbox disabled id=fakeFalse></td></tr>\
        <TR><TD align=right>Sekunden: </td><TD><INPUT type=text size=4 value=300 id=fakeSeconds></td></tr>\
        <TR><TD align=right>Versorgungstruppe: </td><TD><INPUT type=text size=6 value=0 id=fakeSupply></td></tr>\
    <TR><TD align=right>Milizsoldat: </td><TD><INPUT type=text size=6 value=5000 id=fakeMilitia></td></tr>\
    <TR><TD align=right>Späher: </td><TD><INPUT type=text size=6 value=0 id=fakeScout></td></tr>\
      <TR><TD align=right>Lanzenträger: </td><TD><INPUT type=text size=6 value=0 id=fakePike></td></tr>\
      <TR><TD align=right>Schwertkämpfer: </td><TD><INPUT type=text size=6 value=0 id=fakeSword></td></tr>\
      <TR><TD align=right>Bogenschütze: </td><TD><INPUT type=text size=6 value=0 id=fakeArcher></td></tr>\
      <TR><TD align=right>Kavallerie: </td><TD><INPUT type=text size=6 value=0 id=fakeCav></td></tr>\
      <TR><TD align=right>Schwere Kavallerie: </td><TD><INPUT type=text size=6 value=0 id=fakeHeavy></td></tr>\
      <TR><TD align=right>Versorgungswagen: </td><TD><INPUT type=text size=6 value=0 id=fakeWagon></td></tr>\
      <TR><TD align=right>Ballisten: </td><TD><INPUT type=text size=6 value=0 id=fakeBallista></td></tr>\
      <TR><TD align=right>Rammbock: </td><TD><INPUT type=text size=6 value=0 id=fakeRam></td></tr>\
      <TR><TD align=right>Steinschleuder: </td><TD><INPUT type=text size=6 value=0 id=fakeCat></td></tr>\
      <TR><TD align=right>Fake Name: </td><TD><INPUT type=text size=13 value=FAKE_ANGRIFF id=fakeName></td></tr>\
      <TR><TD align=right>Ziel: </td><TD>'+citySelect+'</td></tr>\
        <TR><TD colspan=2 align=center><INPUT id=testSendMarch type=submit value="Fake Angriff" \></td></tr></table>\
        <INPUT id=ptReloadKOC type=submit value="Refresh KoC" \>\
        <BR></div>';
    t.cont.innerHTML = m;
    document.getElementById('testSendMarch').addEventListener ('click', t.clickFakeAttack, false);
    document.getElementById('ptReloadKOC').addEventListener ('click', t.reloadKOC, false);
    function xyNotify(city, x, y){
      var m = '[ Notified: '+ (city?city.name:'null') +', x='+ x +', y='+ y +' ]';
      document.getElementById('testNotify').innerHTML = m;
    }
  },

  hide : function (){
  },

  show : function (){
  },
  
  reloadKOC : function (){
    window.location.href = '';
    setTimeout (function (){window.location.href = window.location.href +'&rload=3';}, 0);
    var goto = 'http://apps.facebook.com/kingdomsofcamelot/?s='+GetServerId();
    var t = '<FORM target="_top" action="'+ goto +'" method=post><INPUT id=xxButReload type=submit value=RELOAD><INPUT type=hidden name=s value="'+ GetServerId() +'"</form>';
    var e = document.createElement ('div');
    e.innerHTML = t;
    document.body.appendChild (e);
    setTimeout (function (){document.getElementById('xxButReload').click();}, 0);
  },
 
  writeDiv : function (msg){
    var t = Tabs.F
    if (t.state != null)
      document.getElementById('testDiv').innerHTML = msg;
  },

  addDiv : function (msg){
    var t = Tabs.F;
    if (t.state != null)
      document.getElementById('testDiv').innerHTML += msg;
  },

  createFakeAttack : function (cityNum, isScout, isWild, isFalse, secs, numMilitia, numSupply, numPike,numSword,numArcher,numCav,numHeavy,numWagon,numBallista,numRam,numCat,numScout, name){
    var marchId = 'm'+ (88888 + Math.floor(Math.random()*11111));
    var march = {};
    if (matTypeof(Seed.queue_atkinc)=='array')
      Seed.queue_atkinc = {};
    if (isFalse)
      march.marchType = 0;
    else if (isScout)
      march.marchType = 3;
    else
      march.marchType = 4;

    march.toCityId = Cities.cities[cityNum].id;
    if (isWild) {
      keys = unsafeWindow.Object.keys(Seed.wilderness['city'+Cities.cities[cityNum].id]);
      march.toTileId = Seed.wilderness['city'+Cities.cities[cityNum].id][keys[0]].tileId;
    } else {
      march.toTileId = Cities.cities[cityNum].tileId;
    }
    secs = parseInt(secs);
    march.arrivalTime = unixTime() + secs;
    march.departureTime = unixTime() - 10;
     march.unts = {}
  if(numScout != 0)
    march.unts.u3 = numScout
  if(numMilitia != 0)
    march.unts.u2 = numMilitia
  if(numSupply != 0)
  march.unts.u1 = numSupply
  if(numPike != 0)
  march.unts.u4 = numPike
  if(numSword != 0)
  march.unts.u5 = numSword
  if(numArcher != 0)
  march.unts.u6 = numArcher
  if(numCav != 0)
  march.unts.u7 = numCav
  if(numHeavy != 0)
  march.unts.u8 = numHeavy
  if(numWagon != 0)
  march.unts.u9 = numWagon
  if(numBallista != 0)
  march.unts.u10 = numBallista
  if(numRam != 0)
  march.unts.u11 = numRam
  if(numCat != 0)
  march.unts.u12 = numCat
    march.pid = 1234567
    march.score = 9
    march.mid = marchId.substr(1);
    march.players = {}
    march.players.u1234567 = {}
    march.players.u1234567.n = name;
    march.players.u1234567.t = 60
    march.players.u1234567.m = 5441192
    march.players.u1234567.s = 'M';
    march.players.u1234567.w = 1
    march.players.u1234567.a = 1
    march.players.u1234567.i = 5
    Seed.queue_atkinc[marchId] = march;
    Seed.players.u1234567 = march.players.u1234567;
  },

  clickFakeAttack : function (){
    var t = Tabs.F;
    var isScout = document.getElementById('fakeIsScout').checked;
    var isWild = document.getElementById('fakeIsWild').checked;
    var isFalse = document.getElementById('fakeFalse').checked;
    var secs = parseInt(document.getElementById('fakeSeconds').value);
    var mil = parseInt(document.getElementById('fakeMilitia').value);
  var numSupply = parseInt(document.getElementById('fakeSupply').value);
  var numPike = parseInt(document.getElementById('fakePike').value);
  var numSword = parseInt(document.getElementById('fakeSword').value);
  var numArcher = parseInt(document.getElementById('fakeArcher').value);
  var numCav = parseInt(document.getElementById('fakeCav').value);
  var numHeavy = parseInt(document.getElementById('fakeHeavy').value);
  var numWagon = parseInt(document.getElementById('fakeWagon').value);
  var numBallista = parseInt(document.getElementById('fakeBallista').value);
  var numRam = parseInt(document.getElementById('fakeRam').value);
  var numCat = parseInt(document.getElementById('fakeCat').value);
  var numScout = parseInt(document.getElementById('fakeScout').value);
  var name = document.getElementById('fakeName').value;
  var city = document.getElementById('fakeCity').value;
    t.createFakeAttack (city, isScout, isWild, isFalse, secs, mil, numSupply, numPike,numSword,numArcher,numCav,numHeavy,numWagon,numBallista,numRam,numCat,numScout,name);

  },
}
/*********************************** Info Tab ***********************************/

Tabs.Karte = {
	tabOrder:	toInfo,
	tabLabel:	'Karte',
	cont:			null,

	init: function (div){
		var t = Tabs.Karte;
		t.cont = div;
		fortmight = {
			u53: "4",
			u55: "7",
			u60: "1",
			u61: "2",
			u62: "3",
		};
		var t = Tabs.Karte;
		rownum = 0;
		m = '<STYLE>.xtabH {background:#ffffe8; border:none; padding-right: 5px; padding-left: 5px; margin-left:10px; }\
            .xtabHL { background:#ffffe8; border-width: 1px; border-style: none none none solid; padding-right:5px; padding-left:5px; margin-left:10px; }\
            .xtabL { background:none; border-width: 1px; border-style: none none none solid; padding-right:5px; padding-left: 5px; margin-left:10px; }\
            .xtabLine { padding:0px; spacing:0px; height:1px; border-color:black; border-width: 1px; border-style: none none solid none }</style>\
        <DIV style="height:650px; max-height:650px; overflow-y:auto; overflow-x:auto">';
	 
    m += '<DIV class=ptstat>ENTFERNUNGS RECHNER</div><DIV class=ptentry><TABLE align=center cellpadding=1 cellspacing=0>\
	<TR><TD class=xtab align=left><INPUT id=plot type=checkbox>Startpunkt und Ziel auf der Karte in Makieren.</td></tr>\
      <TR><TD class=xtab align=right><B>Startpunkt: </b></td><TD  class=xtab> X: <INPUT id=calcX type=text\> Y: <INPUT id=calcY type=text\> <SPAN id=ptloc1></span></td></tr>\
      <TR><TD class=xtab align=right><B>Ziel: </b></td><TD class=xtab> X: <INPUT id=calcX2 type=text\> Y: <INPUT id=calcY2 type=text\> <SPAN id=ptloc2></span></td></tr></table>\
      <CENTER><DIV style="width:60%; font-size:14px; border: 1px solid; background-color:white; margin:20px 3px 3px 0px; padding:4px" id=ptdistout></div>\
  <div><br><b>Marschzeit für</b><br><select id="idETASelect">\
        <option value="0,250" > -- Auswählen -- </option>\
        <option value="0,180" > Versorgungstruppe </option>\
        <option value="0,200" > Milizsoldat </option>\
        <option value="0,3000" > Späher </option>\
        <option value="0,300" > Lanzenträger </option>\
        <option value="0,275" > Schwertkämpfer </option>\
        <option value="0,250" > Bogenschütze </option>\
        <option value="1,1000" > Kavallerie </option>\
        <option value="1,750" > Schwere Kavallerie </option>\
        <option value="1,150" > Versorgungswagen </option>\
        <option value="1,100" > Ballisten </option>\
        <option value="1,120" > Rammbock </option>\
        <option value="1,80" > Steinschleuder </option>\
</select><BR><BR><SPAN class=boldRed>(Startpunkt, Ziel und Truppen Auswählen!)</span></div>\
<DIV style="width:60%; font-size:14px; border: 1px solid; background-color:white; margin:20px 3px 3px 0px; padding:4px" id=ptETAout></div>\
ETA = <i>estimated time of arrival</i> | voraussichtliche Ankunftszeit</center></div>';
    m += '<DIV class=ptstat>PROVINZ KARTE</div><DIV id=ptProvMap style="height:'+ provMapCoords.imgHeight +'px; width:'+ provMapCoords.imgWidth +'px; background-repeat:no-repeat; background-image:url(\''+ URL_PROVINCE_MAP +'\')"></div>';
    
    t.cont.innerHTML = m +'</div>';
   for (var c=0; c<Cities.numCities; c++)      
      t.makeCityImg (c, document.getElementById('ptProvMap'));
	new CdispCityPicker ('ptloc1', document.getElementById('ptloc1'), true, t.eventLocChanged, 0).bindToXYboxes(document.getElementById('calcX'), document.getElementById('calcY'));   
	new CdispCityPicker ('ptloc2', document.getElementById('ptloc2'), true, t.eventLocChanged, 0).bindToXYboxes(document.getElementById('calcX2'), document.getElementById('calcY2'));
	t.eventLocChanged(Cities.cities[0], Cities.cities[0].x, Cities.cities[0].y);
    t.eventFromLocChanged(Cities.cities[0], Cities.cities[0].x, Cities.cities[0].y);
    document.getElementById('idETASelect').addEventListener ( 'change', t.eventLocChanged, false);
	document.getElementById('plot').addEventListener('change', function(){
	t.plotCityImg(0, document.getElementById('ptProvMap'), document.getElementById('calcX').value, document.getElementById('calcY').value);
	t.plotCityImg(1, document.getElementById('ptProvMap'), document.getElementById('calcX2').value, document.getElementById('calcY2').value);
    }, false);
	},

	hide: function (){
	},

	show: function (){
		function rlShow(rl) {
			var retval = '<TD><B>'+rl.Name+'</B></TD><TD align=right><B>&nbsp;&nbsp;';
			if (rl.NextLevelETA > 0)
				nlETA = '(' + (rl.Level + 1) + ': ' + timestr(rl.NextLevelETA) + ')';
			else
				nlETA = '';
			if (rl.Level < 9)
				retval += '<SPAN class=boldRed>' + rl.Level + '</SPAN></B></TD><TD nowrap>&nbsp;&nbsp;' + nlETA + '</TD>';
			else
				retval += rl.Level + '</B></TD><TD nowrap>&nbsp;&nbsp;' + nlETA + '</TD>';
			return retval;
		};

		
	},

	makeCityImg: function (cityNum, eMap){
		var t = Tabs.Karte;
		var city = Cities.cities[cityNum];
		var x = parseInt((provMapCoords.mapWidth * city.x) / 750);
		var y = parseInt((provMapCoords.mapHeight * city.y) / 750);
		var ce = document.createElement ('div');
		ce.style.background = '#700';
		ce.style.opacity = '1.0';
		ce.style.position='relative';
		ce.style.display='block';
		ce.style.width='14px';
		ce.style.height='16px';
		ce.style.border='1px solid #fff';
		ce.style.color = 'white';
		ce.style.textAlign = 'center';
		ce.style.top = (y+provMapCoords.topMargin-(cityNum*18)-8) +'px';
		ce.style.left = (x+provMapCoords.leftMargin-7) +'px';
		eMap.appendChild(ce);
		ce.innerHTML = (cityNum+1) +'';
	},

	plotCityImg: function (cityNum, eMap, x, y){
		var t = Tabs.Karte;
		var xplot = parseInt((provMapCoords.mapWidth * x) / 750);
		var yplot = parseInt((provMapCoords.mapHeight * y) / 750);
		if(document.getElementById('plotmap_'+cityNum) == null){
			var ce = document.createElement ('div');
			ce.style.background = 'white';
			ce.id = 'plotmap_'+cityNum;
			ce.style.opacity = '1.0';
			ce.style.position='relative';
			ce.style.display='block';
			ce.style.width='14px';
			ce.style.height='16px';
			ce.style.border='1px solid #fff';
			ce.style.color = 'black';
			ce.style.textAlign = 'center';
		} else
			ce = document.getElementById('plotmap_'+cityNum);
		ce.style.top = (yplot+provMapCoords.topMargin-((Cities.numCities+cityNum)*18)-8) +'px';
		ce.style.left = (xplot+provMapCoords.leftMargin-7) +'px';
		eMap.appendChild(ce);
		ce.innerHTML = (cityNum+1) +'';
	},

eventLocChanged : function (city, x, y){
    var t = Tabs.Karte;
    var x1 = parseInt(document.getElementById('calcX').value);
    var x2 = parseInt(document.getElementById('calcX2').value);
    if (isNaN(x2))
      return;
    var y1 = parseInt(document.getElementById('calcY').value);
    var y2 = parseInt(document.getElementById('calcY2').value);
    var m = 'Entfernung von '+ x1 +','+ y1 +' nach '+ x2 +','+ y2 +' ist: &nbsp;<B>'+ distance (x1, y1, x2, y2).toFixed(2) +'</b>';
    document.getElementById('ptdistout').innerHTML = m;
	if (document.getElementById('plot').checked){
	t.plotCityImg(0, document.getElementById('ptProvMap'), x1, y1);
	t.plotCityImg(1, document.getElementById('ptProvMap'), x2, y2);
	}
    var dist = distance (x1, y1, x2, y2);
    m = t.estETA(dist);
    if (m != null)
       document.getElementById('ptETAout').innerHTML = m;
    else logit("no M");
  },

  eventFromLocChanged : function (city, x, y){
    var t = Tabs.Karte;
    t.ModelCity = city;
    var x1 = parseInt(document.getElementById('calcX').value);
    var x2 = parseInt(document.getElementById('calcX2').value);
    if (isNaN(x2))
      return;
    var y1 = parseInt(document.getElementById('calcY').value);
    var y2 = parseInt(document.getElementById('calcY2').value);
    var m = 'Entfernung von '+ x1 +','+ y1 +' nach '+ x2 +','+ y2 +' ist: &nbsp;<B>'+ distance (x1, y1, x2, y2).toFixed(2) +'</b>';
    document.getElementById('ptdistout').innerHTML = m;
    var dist = distance (x1, y1, x2, y2);
    m = t.estETA(dist);
    if (m != null)
       document.getElementById('ptETAout').innerHTML = m;
    else logit("no M");
  },
	estETA : function(dist) { // Need Relief Station Levels to estimate transport, reinf, or reassign times.
    var t = Tabs.Karte;
    var cityID;
    if (dist == 0) return "Keine Marschzeit gefunden!";
    var EtaType = document.getElementById('idETASelect');
    var baseSpeedSel = EtaType.options[EtaType.selectedIndex].value;
    var m = baseSpeedSel.split(',');
    var horse = parseInt(m[0]);
    var baseSpeed = parseInt(m[1]);
    if (baseSpeed == 0) return "ETA: unbekannt";
    var mmLvl = parseInt(Seed.tech.tch11);//Magical Mapping
    var Speed = 0;
    if (horse){
    //HorsesSiegeSpeed = Base * (1 + MM/10) * (1 + AH/20)
      var hsLvl = parseInt(Seed.tech.tch12);//Alloy Horse Shoes
      Speed = baseSpeed * (1 + mmLvl/10) * (1 + hsLvl/20);
    }
    else {
    //FootSpeed = Base * (1 + MM/10)
      Speed = baseSpeed * (1 + mmLvl/10);
    }
    //Grid Speed (tiles/second) = Speed (100ths/min) / 6000
    var gSpeed = 0;
    var estSec = 0;
    if (Speed>0) {
      gSpeed = Speed/6000;
      estSec = (dist/gSpeed).toFixed(0);
    }
    var ETAstr = 'Angriff:  <B>' + timestr ((parseInt((estSec+''))+30)+'',1) +'</b>';
    //RS - Cities Relief Station Level
    //Friendly Speed = Speed * (1 + RS/2)
    if (t.ModelCity) {
      cityID = t.ModelCity.id;
      //logit ('ETAest - cityID: ' + cityID);
      var building = getCityBuilding (cityID, 18);
      if (building) {
        //logit ('ETAest - building: ' + building.count + ' : ' + building.maxLevel);
        fSpeed = Speed * (1 + parseInt(building.maxLevel)/2);
        gSpeed = fSpeed/6000;
        estSec = (dist/gSpeed).toFixed(0);
        var friendTimestr = '| Verbündet: <B>' + timestr ((parseInt((estSec+''))+30)) +'</b>';
        ETAstr = ETAstr + ' ' + friendTimestr;
      }
    }
    return ETAstr;
  },

}
// EINSTELLUNG TAB
Tabs.Options = {
  tabLabel : 'Einstellung',
  tabOrder: toEinstellung,
  myDiv : null,
  fixAvailable : {},
  displayTimer:null,
  curTabBut : null,
  curTabName : null,

  init : function (div){
    var t = Tabs.Options;


    t.myDiv = div;
    t.myDiv.innerHTML = '<div class=ptstat>POWER TOOLS - EINSTELLUNG</div><TABLE class=ptTab2 align=center><TR><TD><INPUT class=pdxSubtab ID=ptmrchSubP type=submit value=Power></td>\
          <TD><INPUT class=pdxSubtab ID=ptmrchSubQ type=submit value=Misc></td>\
          <TD><INPUT class=pdxSubtab ID=ptmrchSubR type=submit value=Alarm></td>\
<TD><INPUT class=pdxSubtab ID=ptmrchSubS type=submit value=Style></td></tr></table><HR class=ptThin>\
      <DIV id=ptOptionsOutput style="margin-top:10px; height:600px"></div>';
    t.optionsDiv = document.getElementById('ptOptionsOutput');
    document.getElementById('ptmrchSubP').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubQ').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubR').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubS').addEventListener('click', e_butSubtab, false);
    changeSubtab (document.getElementById('ptmrchSubO'));

    function e_butSubtab (evt){
      changeSubtab (evt.target);
    }

    function changeSubtab (but){
      if (but == t.curTabBut)
        return;
      if (t.curTabBut){
        t.curTabBut.className='pdxSubtab';
        t.curTabBut.disabled=false;
      }
      t.curTabBut = but;
      but.className='pdxSubtab pdxSubtabSel';
      but.disabled=true;
      t.curTabName = but.id.substr(9);
      t.show ();
    }
  },

  hide : function (){
    var t = Tabs.Options;
    clearTimeout (t.displayTimer);
      mainPop.div.style.width = 750 + 'px';
   if (Options.widescreen==true)mainPop.div.style.width = 1100 + 'px';
  },

  show : function (){
    var t = Tabs.Options;
    clearTimeout (t.displayTimer);
      mainPop.div.style.width = 750 + 'px';
   if (Options.widescreen==true)mainPop.div.style.width = 1100 + 'px';
    if (t.curTabName == 'Q')
      t.showColors();
    else if (t.curTabName == 'R')
      t.showTabs();
    else if (t.curTabName == 'S')
      t.showStyle();
    else
      t.showOptions();

  },

// EINSTELLUNG
   showOptions : function (){
    var t = Tabs.Options;

    try {
      m = '<DIV style="height:500px; max-height:500px;"><TABLE width=100% class=pbOptions cellspacing=0 cellpadding=0>\
       <TR><TD colspan=2><div class=ptstat>POWER TOOLS - MAIN EINSTELLUNG</div></td></tr>\
        <TR><TD><INPUT id=ptAllowWinMove type=checkbox /></td><TD>Fenster verschieben erlauben.</td></tr>\
		<TR><TD><INPUT id=pdxwidescreenEnable type=checkbox /></td><TD>Festergrößen automatisch anpassen.</td></tr>\
        <TR><TD><INPUT id=ptHideOnGoto type=checkbox /></td><TD>Automatisch bei Klick auf Koordinaten Fenster Schließen.</td></tr>\
        <TR><TD><INPUT id=ptEnableFoodWarn type=checkbox /></td><TD>\'Reicht für\' in Rot Anzeigen wenn es noch für \
        <INPUT id=optFoodHours type=text size=3 value="'+ Options.foodWarnHours +'"> Stunden ausreicht! <SPAN class=boldRed>(Stats Tab)</span></td></tr>\
 <TR><TD><INPUT id=ptEnableFoodAlert type=checkbox /></td><TD>Im Allianz Chat posten wenn die Nahrung noch für \
    <INPUT id=optFoodAlertHours type=text size=3 value="'+ Options.foodAlertHours +'"> Stunden ausreicht! <SPAN class=boldRed>(Bei Refresh und alle 30 Min.)</span></td></tr>\
 <TR><TD colspan=2><span style=\"font-size:10px; color:#555; line-height:18px; \"><font color=#600000><B><u>Wichtig</u></b></font>: max. 8 Stunden eintragen! sonst spamst du den Allianz Chat!</span></td></tr>\
<TR><TD><INPUT id=ptEnableBarbSummary type=checkbox /></TD><TD><INPUT id=optBarbHitsKeep type=text size=3 value="'+ Options.barbHitsKeep +'"> Barbaren Lager Treffer Daten für den <b>Märsche</b> SubTab <b>Lager Stats</b> Speichern!&nbsp;&nbsp;<INPUT id="optResetBarbSummary" type=submit value="Barbaren Stats Zurücksetzten"\></td></tr>\
        </table><BR><BR><HR><u>Hinweis</u>: Wenn eine Box nicht klickbar ist hat KoC mal wieder eine änderung vorgenommen!<HR>\
<table width="624" border="0" cellspacing="0" cellpadding="0"><tr>\
    <td colspan="2"><a href="http://userscripts.org/scripts/show/98323" target="_blank">Power Tools- Deutsch</a> -   Version: <SPAN class=boldRed> '+ Version +' </span> by <a href="http://userscripts.org/users/297645/scripts" target="_blank">PDX</a></span></td>\
    <td><b>Bewertungen</b></td>\
  </tr><tr><td width="84"><span class="boldRed"><img src="http://koc.god-like.info/pdxlogo.jpg" alt="" width="80" height="78"></span></td>\
    <td width="291">powered by<br><a href="http://koc.god-like.org" title="Hier geht es zum KoC Scripts Blog!" target="_blank">KoC Scripts<br>\
      Der erste Deutsche KoC Scripts Blog!</a></td>\
    <td width="249"><span style=\"font-size:10px; color:#555; line-height:18px; \"><a href="http://userscripts.org/scripts/reviews/104137" title="Jetzt eine Bewertung abgeben!" target="_blank">KoC Power - Deutsch</a><br>\
      <a href="http://userscripts.org/scripts/reviews/98414" title="Jetzt eine Bewertung abgeben!" target="_blank">KoC Power Bot - Deutsch</a><br>\
      <a href="http://userscripts.org/scripts/reviews/98323" title="Jetzt eine Bewertung abgeben!" target="_blank">Power Tools - Deutsch</a><br>\
      <a href="http://userscripts.org/scripts/reviews/98788" title="Jetzt eine Bewertung abgeben!" target="_blank">KoC Allianz - Extras</a><br>\
      <a href="http://userscripts.org/scripts/reviews/98234" title="Jetzt eine Bewertung abgeben!" target="_blank">KoC Attack - Deutsch</a></span></td></tr></table>\
</div>';
			t.optionsDiv.innerHTML = m;
			t.togOpt ('ptEnableFoodAlert', 'enableFoodAlert');
			t.togOpt ('ptAllowWinMove', 'ptWinDrag', mainPop.setEnableDrag);
			t.togOpt ('pdxwidescreenEnable', 'widescreen');
			t.togOpt ('ptHideOnGoto', 'hideOnGoto');	  
			t.togOpt ('ptEnableFoodWarn', 'enableFoodWarn');
			t.togOpt ('ptEnableBarbSummary', 'enableBarbSummary');
			document.getElementById('optBarbHitsKeep').addEventListener ('change', function () {
				Options.barbHitsKeep = document.getElementById('optBarbHitsKeep').value;
				saveOptions();
			}, false);

			document.getElementById('optResetBarbSummary').addEventListener ('click', function () {
				barbHit = [];
				barbHits = [];
				GM_setValue ('barbHits_'+GetServerId(), JSON2.stringify(barbHits));
			}, false);  
			 document.getElementById('optFoodHours').addEventListener ('change', function () {
          var x = document.getElementById('optFoodHours').value;
          if (isNaN(x) || x<0.01 || x>99999){
            document.getElementById('optFoodHours').value = Options.foodWarnHours;
            return;
          }
          Options.foodWarnHours = x;
          saveOptions();
        }, false);
    document.getElementById('optFoodAlertHours').addEventListener ('change', function () {
          var x = document.getElementById('optFoodAlertHours').value;
          if (isNaN(x) || x<0.01 || x>99999){
            document.getElementById('optFoodAlertHours').value = Options.foodAlertHours;
            return;
          }
          Options.foodAlertHours = x;
          saveOptions();
        }, false);
			
    } catch (e) {
     // div.innerHTML = '<PRE>'+ e.name +' : '+ e.message +'</pre>';
    }
  },


togOpt : function (checkboxId, optionName, callOnChange, callEnable,callIsAvailable){
    var t = Tabs.Options;
    var checkbox = document.getElementById(checkboxId);

    if (callIsAvailable && callIsAvailable()==false){
      checkbox.disabled = true;
      return;
    }
    if (Options[optionName])
      checkbox.checked = true;
    checkbox.addEventListener ('change', eventHandler, false);
    function eventHandler (){
      Options[optionName] = this.checked;

      saveOptions();
      if (callOnChange)
        callOnChange (this.checked);
    }
  },
  changeOpt : function (valueId, optionName, callOnChange){
    var t = Tabs.Options;
    var e = document.getElementById(valueId);
    e.value = Options[optionName];
    e.addEventListener ('change', eventHandler, false);
    function eventHandler (){
      Options[optionName] = this.value;
      saveOptions();
      if (callOnChange)
        callOnChange (this.value);
    }
  },

  e_watchChanged : function (){
    GlobalOptions.pbWatchdog = document.getElementById('pbWatchEnable').checked;
    GM_setValue ('Options_??', JSON2.stringify(GlobalOptions));
  },


// CHAT EINSTELLUNG
  showTabs : function (){
     var t = Tabs.Options;

    try {
      m = '<DIV style="height:600px; "><TABLE width=100% class=pbOptions cellspacing=0 cellpadding=0>\
        <TR><TD colspan=2><DIV class=ptstat>POWER TOOLS - ALARM EINSTELLUNG</div></tr>\
		  <TR><TD width="2%"><INPUT id=togWhisperOn type=checkbox /></td><TD width="98%">Flüster Sound Alarm Einschalten!</td></tr>\
 <TR><TD colspan="2"><b>Sound Alarm bei Allianz Angriffen!</b></td></tr>\
  <TR><TD colspan="2"><font color=#333333>Deutsche Meldung <INPUT id=ptEnableTowerAlert type=checkbox /> - Englishe Meldung <INPUT id=ptEnableTowerAlertEN type=checkbox /></font></td></tr>\
  <TR><TD colspan="2"><b>Sound Alarm wenn ein Allianz Mitglied zuwenig Nahrung hat!</b></td></tr>\
  <TR><TD colspan="2"><font color=#333333>Deutsche Meldung <INPUT id=ptEnableFoodChatAlert type=checkbox /> - Englishe Meldung <INPUT id=ptEnableFoodChatAlertEN type=checkbox /></font></td></tr>\
   <TR><TD colspan=2><span style=\"font-size:10px; color:#555; line-height:18px; \"><font color=#600000><B><u>Hinweis</u></b></font>: Der Sound Alarm für zu wenig Nahrung und bei Allianz Angriffen reagiert <u>nur</u> auf die Meldungen vom Bot oder den Allianz Extras</span></td></tr>\
        </table><BR><BR><HR><u>Hinweis</u>: Wenn eine Box nicht klickbar ist hat KoC mal wieder eine änderung vorgenommen!<HR>\
<table width="624" border="0" cellspacing="0" cellpadding="0"><tr>\
    <td colspan="2"><a href="http://userscripts.org/scripts/show/104137" target="_blank">KoC Power - Deutsch</a> -   Version: <SPAN class=boldRed> '+ Version +' </span> by <a href="http://userscripts.org/users/297645/scripts" target="_blank">PDX</a></span></td>\
    <td><b>Bewertungen</b></td>\
  </tr><tr><td width="84"><span class="boldRed"><img src="http://koc.god-like.info/pdxlogo.jpg" alt="" width="80" height="78"></span></td>\
    <td width="291">powered by<br><a href="http://koc.god-like.org" title="Hier geht es zum KoC Scripts Blog!" target="_blank">KoC Scripts<br>\
      Der erste Deutsche KoC Scripts Blog!</a></td>\
    <td width="249"><span style=\"font-size:10px; color:#555; line-height:18px; \"><a href="http://userscripts.org/scripts/reviews/104137" title="Jetzt eine Bewertung abgeben!" target="_blank">KoC Power - Deutsch</a><br>\
      <a href="http://userscripts.org/scripts/reviews/98414" title="Jetzt eine Bewertung abgeben!" target="_blank">KoC Power Bot - Deutsch</a><br>\
      <a href="http://userscripts.org/scripts/reviews/98323" title="Jetzt eine Bewertung abgeben!" target="_blank">Power Tools - Deutsch</a><br>\
      <a href="http://userscripts.org/scripts/reviews/98788" title="Jetzt eine Bewertung abgeben!" target="_blank">KoC Allianz - Extras</a><br>\
      <a href="http://userscripts.org/scripts/reviews/98234" title="Jetzt eine Bewertung abgeben!" target="_blank">KoC Attack - Deutsch</a></span></td></tr></table>\
</div>';
      t.optionsDiv.innerHTML = m;
    
	  t.togOpt ('togWhisperOn', 'WhisperOn');
	   t.togOpt ('ptEnableTowerAlert', 'enableTowerAlert');
	   t.togOpt ('ptEnableTowerAlertEN', 'enableTowerAlertEN');
	   t.togOpt ('ptEnableFoodChatAlert', 'enableFoodChatAlert');
	    t.togOpt ('ptEnableFoodChatAlertEN', 'enableFoodChatAlertEN');
        
      
nHtml.SetSelect(ById('htmlSelector'),this.options.autoPublishPrivacySetting);
    } catch (e) {
     // div.innerHTML = '<PRE>'+ e.name +' : '+ e.message +'</pre>';
    }
  },

// STYLE EINSTELLUNG
   showStyle : function (){
    var t = Tabs.Options;
	// ANGEFANGEN DIE SHORTCUTS AUSZUBLENDEN... muss noch beendet werden...
    try {
      m = '<DIV style="height:500px; max-height:500px;"><TABLE class=ptTab width=100% class=pbOptions cellspacing=0 cellpadding=0>\
       <TR><TD colspan=2><div class=ptstat>POWER TOOLS - STYLE EINSTELLUNG</div></td></tr>\
  <table class=ptTab width="612" border="0" cellspacing="0" cellpadding="0">\
         <tr>\
           <td colspan="2"><strong><u>Shortcuts</u></strong></td>\
           <td colspan="2"><strong><u>Chat Style</u></strong></td>\
         </tr>\
         <tr>\
           <td width="19"><INPUT id=togNeueNachricht type=checkbox /></td>\
           <td width="199">Neue Nachricht</td>\
           <td width="22"><INPUT id=togChatStuff type=checkbox /></td>\
           <td width="372">Erweiterten Chat <span class=boldRed>(Hintergrund Farben etc.)</span></td>\
         </tr>\
         <tr>\
           <td><INPUT id=togMeineBerichte type=checkbox /></td>\
           <td>Meine Berichte</td>\
           <td><INPUT id=togChatGlobal type=checkbox /></td>\
           <td>Global Chat Hintergrund</td>\
         </tr>\
         <tr>\
           <td><INPUT id=togAllianzBerichte type=checkbox /></td>\
           <td>Allianz Berichte</td>\
           <td><INPUT id=togChatWhisper type=checkbox /></td>\
           <td>Flüster Text in Rot anzeigen.</td>\
         </tr>\
         <tr>\
           <td><INPUT id=togVerstaerken type=checkbox /></td>\
           <td>Verstärken </td>\
           <td><INPUT id=togChatBold type=checkbox /></td>\
           <td>Fette Schrift im Chat.</td>\
         </tr>\
         <tr>\
           <td><INPUT id=togNeuzuordnen type=checkbox /></td>\
           <td>Neuzuordnen</td>\
           <td><INPUT id=togChatAttack type=checkbox /></td>\
           <td>Roter Hintergrund bei Wachturm Meldung.</td>\
         </tr>\
         <tr>\
           <td><INPUT id=togWiederholen type=checkbox /></td>\
           <td>Wiederholen</td>\
           <td><INPUT id=togChatLead type=checkbox /></td>\
           <td>Hintergrundfarbe für das Allianz Leading.</td>\
         </tr>\
		  <tr>\
		 <td><INPUT id=togTransport type=checkbox /></td>\
           <td>Transport</td>\
           <td>&nbsp;</td>\
           <td>&nbsp;</td>\
         </tr>\
         <tr>\
		 <td><INPUT id=togATransport type=checkbox /></td>\
           <td>Auto Transport</td>\
           <td>&nbsp;</td>\
           <td>&nbsp;</td>\
         </tr>\
		 <tr>\
           <td><INPUT id=togANeuzuordnen type=checkbox /></td>\
           <td>Auto Neu zuordnen</td>\
           <td>&nbsp;</td>\
           <td>&nbsp;</td>\
         </tr>\
		  <tr>\
           <td><INPUT id=togAutoBau type=checkbox /></td>\
           <td>Auto Bau</td>\
           <td>&nbsp;</td>\
           <td>&nbsp;</td>\
         </tr>\
         <tr>\
           <td><INPUT id=togMakieren type=checkbox /></td>\
           <td>Makieren</td>\
           <td>&nbsp;</td>\
           <td>&nbsp;</td>\
         </tr>\
         <tr>\
           <td><INPUT id=togHilfe type=checkbox /></td>\
           <td>Hilfe</td>\
           <td>&nbsp;</td>\
           <td>&nbsp;</td>\
         </tr>\
         <tr>\
           <td><INPUT id=togAutoRefresh type=checkbox /></td>\
           <td>AutoRefresh</td>\
           <td>&nbsp;</td>\
           <td>&nbsp;</td>\
         </tr>\
		          <tr>\
           <td><INPUT id=togScSync type=checkbox /></td>\
           <td>Shortcut Sync</td>\
           <td>&nbsp;</td>\
           <td>&nbsp;</td>\
         </tr>\
  </table>\
  <p>&nbsp;</p>\
  <TR><TD colspan=2><div class=ptstat>FARBEN</div></td></tr>\
	 <TABLE class=ptTab>\
      <TR><TD>Chat Farbe - Global: </td><TD><INPUT id=togGlobal type=text size=7 maxlength=7 value="'+Colors.ChatGlobal+'"></td>&nbsp;<TD style="background-color:'+Colors.ChatGlobal+'" width=30px>&nbsp;</td></tr>\
      <TR><TD>Chat Farbe - Leaders: </td><TD><INPUT id=togChatLeaders type=text size=7 maxlength=7 value="'+Colors.ChatLeaders+'"></td>&nbsp;<TD style="background-color:'+Colors.ChatLeaders+'" width=30px>&nbsp;</td></tr>\
      <TR><TD>Allg. - Überschrift Hintergrund: </td><TD><INPUT id=togChatMainTiltle type=text size=7 maxlength=7 value="'+Colors.MainTitle+'"></td>&nbsp;<TD style="background-color:'+Colors.MainTitle+'" width=30px>&nbsp;</td></tr>\
      <TR><TD>Allg. - Überschrift Schrift: </td><TD><INPUT id=togChatMainTiltleSch type=text size=7 maxlength=7 value="'+Colors.MainTitleSch+'"></td>&nbsp;<TD style="background-color:'+Colors.MainTitleSch+'" width=30px>&nbsp;</td></tr>\
      <TR><TD>Allg. - Trennlinie: </td><TD><INPUT id=togDarkRow type=text size=7 maxlength=7 value="'+Colors.DarkRow+'"></td>&nbsp;<TD style="background-color:'+Colors.DarkRow+'" width=30px>&nbsp;</td></tr>\
      <TR><TD>Allg. - Button Ausgewählt: </td><TD><INPUT id=togButClick type=text size=7 maxlength=7 value="'+Colors.ButtonSelected+'"></td>&nbsp;<TD style="background-color:'+Colors.ButtonSelected+'" width=30px>&nbsp;</td></tr>\
      <TR><TD>Allg. - Tab Ausgewählt: </td><TD><INPUT id=togTabClick type=text size=7 maxlength=7 value="'+Colors.TabClicked+'"></td>&nbsp;<TD style="background-color:'+Colors.TabClicked+'" width=30px>&nbsp;</td></tr>\
      <TR><TD>Allg. - Tabs: </td><TD><INPUT id=togTab type=text size=7 maxlength=7 value="'+Colors.Tabs+'"></td>&nbsp;<TD style="background-color:'+Colors.Tabs+'" width=30px>&nbsp;</td></tr>\
      <TR><TD>Allg. - Stats Trennlinie:</td><TD><INPUT id=togOverDarkRow type=text size=7 maxlength=7 value="'+Colors.OverviewDarkRow+'"></td>&nbsp;<TD style="background-color:'+Colors.OverviewDarkRow+'" width=30px>&nbsp;</td></tr>\
      </table>\
	  <TR><TD colspan=2><div class=ptstat>HTML FARBEN UND FARBCODES</div></td></tr>\
      <a href="http://www.colorpicker.com/" target="_blank">Farbe Auswählen</a>&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;&nbsp;\
      <a href="http://www.w3schools.com/html/html_colors.asp" target="_blank">Farben</a>\
      <HR><span class=boldRed><u>Wichtig</u>:</span> Damit es wirksam wird musst du ein Refresh durchführen!<BR>\
        </table><BR><BR><HR><u>Hinweis</u>: Wenn eine Box nicht klickbar ist hat KoC mal wieder eine änderung vorgenommen!<HR>\
<table width="624" border="0" cellspacing="0" cellpadding="0"><tr>\
    <td colspan="2"><a href="http://userscripts.org/scripts/show/98323" target="_blank">Power Tools- Deutsch</a> -   Version: <SPAN class=boldRed> '+ Version +' </span> by <a href="http://userscripts.org/users/297645/scripts" target="_blank">PDX</a></span></td>\
    <td><b>Bewertungen</b></td>\
  </tr><tr><td width="84"><span class="boldRed"><img src="http://koc.god-like.info/pdxlogo.jpg" alt="" width="80" height="78"></span></td>\
    <td width="291">powered by<br><a href="http://koc.god-like.org" title="Hier geht es zum KoC Scripts Blog!" target="_blank">KoC Scripts<br>\
      Der erste Deutsche KoC Scripts Blog!</a></td>\
    <td width="249"><span style=\"font-size:10px; color:#555; line-height:18px; \"><a href="http://userscripts.org/scripts/reviews/104137" title="Jetzt eine Bewertung abgeben!" target="_blank">KoC Power - Deutsch</a><br>\
      <a href="http://userscripts.org/scripts/reviews/98414" title="Jetzt eine Bewertung abgeben!" target="_blank">KoC Power Bot - Deutsch</a><br>\
      <a href="http://userscripts.org/scripts/reviews/98323" title="Jetzt eine Bewertung abgeben!" target="_blank">Power Tools - Deutsch</a><br>\
      <a href="http://userscripts.org/scripts/reviews/98788" title="Jetzt eine Bewertung abgeben!" target="_blank">KoC Allianz - Extras</a><br>\
      <a href="http://userscripts.org/scripts/reviews/98234" title="Jetzt eine Bewertung abgeben!" target="_blank">KoC Attack - Deutsch</a></span></td></tr></table>\
</div>';

			t.optionsDiv.innerHTML = m;
	
	 t.togOpt ('togChatStuff', 'chatEnhance', ChatStuff.setEnable, ChatStuff.isAvailable);
      t.togOpt ('togChatGlobal', 'chatglobal');
      t.togOpt ('togChatWhisper', 'chatwhisper');	
      t.togOpt ('togChatBold', 'chatbold');
      t.togOpt ('togChatAttack', 'chatAttack');
      t.togOpt ('togChatLead', 'chatLeaders');
	  t.togOpt ('togTransport', 'Transport');
	  t.togOpt ('togATransport', 'AutoTransport');
	  t.togOpt ('togANeuzuordnen', 'AutoNeuzuordnen');
	  t.togOpt ('togNeueNachricht', 'NeueNachricht');
	  t.togOpt ('togMeineBerichte', 'MeineBerichte');
      t.togOpt ('togAllianzBerichte', 'AllianzBerichte');
      t.togOpt ('togVerstaerken', 'Verstaerken');	
      t.togOpt ('togNeuzuordnen', 'Neuzuordnen');
      t.togOpt ('togWiederholen', 'Wiederholen');
	  t.togOpt ('togAutoBau', 'AutoBau');
      t.togOpt ('togMakieren', 'Makieren');
	  t.togOpt ('togHilfe', 'Hilfe');
	  t.togOpt ('togAutoRefresh', 'AutoRefresh');
	  t.togOpt ('togScSync', 'ScSync');
	  
	// FARBEN
      document.getElementById('togGlobal').addEventListener('change', function(){Colors.ChatGlobal = document.getElementById('togGlobal').value;t.showStyle()}, false);
      document.getElementById('togChatLeaders').addEventListener('change', function(){Colors.ChatLeaders = document.getElementById('togChatLeaders').value;t.showStyle()}, false);
      document.getElementById('togChatMainTiltle').addEventListener('change', function(){Colors.MainTitle = document.getElementById('togChatMainTiltle').value;t.showStyle()}, false);
	  document.getElementById('togChatMainTiltleSch').addEventListener('change', function(){Colors.MainTitleSch = document.getElementById('togChatMainTiltleSch').value;t.showStyle()}, false);
      document.getElementById('togDarkRow').addEventListener('change', function(){Colors.DarkRow = document.getElementById('togDarkRow').value;t.showStyle()}, false);
      document.getElementById('togButClick').addEventListener('change', function(){Colors.ButtonSelected = document.getElementById('togButClick').value;t.showStyle()}, false);
      document.getElementById('togTabClick').addEventListener('change', function(){Colors.TabClicked = document.getElementById('togTabClick').value;t.showStyle()}, false);
      document.getElementById('togTab').addEventListener('change', function(){Colors.Tabs = document.getElementById('togTab').value;t.showStyle()}, false);
      document.getElementById('togOverDarkRow').addEventListener('change', function(){Colors.OverviewDarkRow = document.getElementById('togOverDarkRow').value;t.showStyle()}, false);
	
	  document.getElementById('ResetALL').addEventListener ('click', function(){
      		RemoveList = (GM_listValues());
      		for (i=0;i<RemoveList.length;i++){
      			if (RemoveList[i] == "Colors") GM_deleteValue(RemoveList[i]);
      		}
      		ResetColors=true;
      		reloadKOC();
      },false);	
    } catch (e) {
     // div.innerHTML = '<PRE>'+ e.name +' : '+ e.message +'</pre>';
    }
  },

  /*togOpt : function (checkboxId, optionName, callOnChange, callEnable,callIsAvailable){
    var t = Tabs.Options;
    var checkbox = document.getElementById(checkboxId);

    if (callIsAvailable && callIsAvailable()==false){
      checkbox.disabled = true;
      return;
    }
    if (Options[optionName])
      checkbox.checked = true;
    checkbox.addEventListener ('change', eventHandler, false);
    function eventHandler (){
      Options[optionName] = this.checked;

      saveOptions();
      if (callOnChange)
        callOnChange (this.checked);
    }
  },*/
  changeOpt : function (valueId, optionName, callOnChange){
    var t = Tabs.Options;
    var e = document.getElementById(valueId);
    e.value = Options[optionName];
    e.addEventListener ('change', eventHandler, false);
    function eventHandler (){
      Options[optionName] = this.value;
      saveOptions();
      if (callOnChange)
        callOnChange (this.value);
    }
  },


  e_wideChanged : function (){
    GlobalOptions.pbWideScreen = document.getElementById('pbWideOpt').checked;
    GM_setValue ('Options_??', JSON2.stringify(GlobalOptions));
  },
  // MISC
  showColors : function (){
    var t = Tabs.Options;
      try {
      m = '<DIV style="height:750px;" overflow-y:auto><TABLE width=100% class=pbOptions cellspacing=0 cellpadding=0>\
        <TR><TD colspan=2><div class=ptstat>KINGDOM OF CAMELOT - EINSTELLUNG</div></td></tr>\
        <TR><TD><INPUT id=togMsgCountFix type=checkbox /></td><TD>Position der Nachrichten Zahl fixen.</td></tr>';
      m += '<TR><TD><INPUT id=togAllRpts type=checkbox /></td><TD>Erweiterte Allianz Berichte.</td></tr>\
        <TR><TD><INPUT id=togAllowAlter type=checkbox /></td><TD>Erlaube anderen Scripten das Format der Allianz Berichte zu wechseln.</td></tr>\
        <TR><TD><INPUT id=togEnhanceMsging type=checkbox /></td><TD>Erweiterte Nachrichten. <SPAN class=boldRed>("Weiterleiten" und "Alle Offiziere" Buttons)</span></td></tr>\
        <TR><TD><INPUT id=togPageNav type=checkbox /></td><TD>Erweiterte Seiten Navigation <SPAN class=boldRed>(Nachrichten und Berichte)</span> </td></tr>\
        <TR><TD><INPUT id=togWarnZero type=checkbox /></td><TD>Warnen falls du nach 0,0 Maschieren möchtest.</td></tr>\
        <TR><TD><INPUT id=togGmtClock type=checkbox /></td><TD>GMT Uhrzeit neben der Camelot Zeit <SPAN class=boldRed>(Um Angriffe zu planen)</span> </td></tr>\
        <TR><TD><INPUT id=togAttackPicker type=checkbox /></td><TD>Heiligtum Auswähler auf der Truppen Bewegungs Seite Anzeigen. <SPAN class=boldRed>(Verstärkung, Transport etc...)</span></td></tr>\
        <TR><TD><INPUT id=togBatRounds type=checkbox /></td><TD>Die Runden Anzahl einblenden</td></tr>\
        <TR><TD><INPUT id=togAtkDelete type=checkbox /></td><TD>Berichte Lösch Button einblenden <SPAN class=boldRed>(Um die Berichten zu Löschen)</span></td></tr>\
        <TR><TD colspan=2><div class=ptstat>BUG FIX</div></td></tr>\
        <TR><TD><INPUT id=togTowerFix type=checkbox /></td><TD>Wachturm Berichte Fix <SPAN class=boldRed>(Stadt, Wildnis oder Ungültig)</span></td></tr>\
        <TR><TD><INPUT id=togMapDistFix type=checkbox /></td><TD>Zeige die Entfernung von der Ausgewählten Stadt, und nicht immer die von der ersten!</td></tr>\
        <TR><TD><INPUT id=togTowerFix2 type=checkbox /></td><TD>Fake Angriffe durch Späher Attacken vermeiden.</td></tr>\
        <TR><TD><INPUT id=togKnightSelect type=checkbox /></td><TD><u>Keinen</u> Ritter auswählen wenn der Marsch typ: <SPAN class=boldRed>Spähen, Transport</span> oder <SPAN class=boldRed>Verstärken</span> ist!</td></tr>\
        <TR><TD><INPUT id=togCoordBox type=checkbox /></td><TD>Koordinaten Box  <SPAN class=boldRed>über</span> der Truppenbewegung Anzeigen!</td></tr>\
        </table><HR><u>Hinweis</u>: Wenn eine Box nicht klickbar ist hat KoC mal wieder eine änderung vorgenommen!<HR>\
<table width="624" border="0" cellspacing="0" cellpadding="0"><tr>\
    <td colspan="2"><a href="http://userscripts.org/scripts/show/104137" target="_blank">KoC Power - Deutsch</a> -   Version: <SPAN class=boldRed> '+ Version +' </span> by <a href="http://userscripts.org/users/297645/scripts" target="_blank">PDX</a></span></td>\
    <td><b>Bewertungen</b></td>\
  </tr><tr><td width="84"><span class="boldRed"><img src="http://koc.god-like.info/pdxlogo.jpg" alt="" width="80" height="78"></span></td>\
    <td width="291">powered by<br><a href="http://koc.god-like.org" title="Hier geht es zum KoC Scripts Blog!" target="_blank">KoC Scripts<br>\
      Der erste Deutsche KoC Scripts Blog!</a></td>\
    <td width="249"><span style=\"font-size:10px; color:#555; line-height:18px; \"><a href="http://userscripts.org/scripts/reviews/104137" title="Jetzt eine Bewertung abgeben!" target="_blank">KoC Power - Deutsch</a><br>\
      <a href="http://userscripts.org/scripts/reviews/98414" title="Jetzt eine Bewertung abgeben!" target="_blank">KoC Power Bot - Deutsch</a><br>\
      <a href="http://userscripts.org/scripts/reviews/98323" title="Jetzt eine Bewertung abgeben!" target="_blank">Power Tools - Deutsch</a><br>\
      <a href="http://userscripts.org/scripts/reviews/98788" title="Jetzt eine Bewertung abgeben!" target="_blank">KoC Allianz - Extras</a><br>\
      <a href="http://userscripts.org/scripts/reviews/98234" title="Jetzt eine Bewertung abgeben!" target="_blank">KoC Attack - Deutsch</a></span></td></tr></table>\
</div>';
      t.optionsDiv.innerHTML = m;

      var checkbox = document.getElementById('togAllRpts');
       if (Options.enhanceARpts)
         checkbox.checked = true;
       checkbox.addEventListener ('change', function() {
       Options.enhanceARpts=document.getElementById('togAllRpts').checked; saveOptions(); AllianceReports.enable(Options.enhanceARpts);}, false);



      t.togOpt ('togAllowAlter', 'allowAlterAR');	  
     t.togOpt ('togTowerFix', 'fixTower', TowerAlerts.enableFixTarget, TowerAlerts.isFixTargetAvailable);
      t.togOpt ('togTowerFix2', 'fixTower2', TowerAlerts.enableFixFalseReports, TowerAlerts.isFixFalseReportsAvailable);
      t.togOpt ('togMsgCountFix', 'fixMsgCount', MessageCounts.init);
      t.togOpt ('togMapDistFix', 'fixMapDistance', MapDistanceFix.enable, MapDistanceFix.isAvailable);
      t.togOpt ('togWarnZero', 'fixWarnZero', WarnZeroAttack.setEnable, WarnZeroAttack.isAvailable);
      t.togOpt ('togPageNav', 'fixPageNav', PageNavigator.enable, PageNavigator.isAvailable);
      t.togOpt ('togGmtClock', 'gmtClock', GMTclock.setEnable);
      t.togOpt ('togKnightSelect', 'fixKnightSelect', AttackDialog.setEnable, AttackDialog.isKnightSelectAvailable);
      t.togOpt ('togAttackPicker', 'attackCityPicker', AttackDialog.setEnable, AttackDialog.isCityPickerAvailable);
      t.togOpt ('togEnhanceMsging', 'enhanceMsging', messageNav.setEnable, messageNav.isAvailable);
      t.togOpt ('togCoordBox', 'mapCoordsTop', CoordBox.setEnable, CoordBox.isAvailable);
      t.togOpt ('togBatRounds', 'dispBattleRounds', null, battleReports.isRoundsAvailable);
      t.togOpt ('togAtkDelete', 'reportDeleteButton', null, battleReports.isDeleteAvailable);
             
     
      var checkbox = document.getElementById('togAllRpts');
       if (Options.enhanceARpts)
         checkbox.checked = true;
       checkbox.addEventListener ('change', function() {Options.enhanceARpts=document.getElementById('togAllRpts').checked; saveOptions(); AllianceReports.enable(Options.enhanceARpts);}, false);
    } catch (e) {
      div.innerHTML = '<PRE>'+ e.name +' : '+ e.message +'</pre>';
    }
  },

togOpt : function (checkboxId, optionName, callOnChange, callEnable,callIsAvailable){
    var t = Tabs.Options;
    var checkbox = document.getElementById(checkboxId);

    if (callIsAvailable && callIsAvailable()==false){
      checkbox.disabled = true;
      return;
    }
    if (Options[optionName])
      checkbox.checked = true;
    checkbox.addEventListener ('change', eventHandler, false);
    function eventHandler (){
      Options[optionName] = this.checked;
      saveOptions();
      if (callOnChange)
        callOnChange (this.checked);
    }
  },
  changeOpt : function (valueId, optionName, callOnChange){
    var t = Tabs.Options;
    var e = document.getElementById(valueId);
    e.value = Options[optionName];
    e.addEventListener ('change', eventHandler, false);
    function eventHandler (){
      Options[optionName] = this.value;
      saveOptions();
      if (callOnChange)
        callOnChange (this.value);
    }
  },

};
/********************************* Search Tab *************************************/

function distance (d, f, c, e) {
  var a = 750;
  var g = a / 2;
  var b = Math.abs(c - d);
  if (b > g)
    b = a - b;
  var h = Math.abs(e - f);
  if (h > g)
    h = a - h;
  return Math.round(100 * Math.sqrt(b * b + h * h)) / 100;
};

Tabs.Search = {
  tabLabel : ' Suchen',
  tabOrder : toSuchen,
  tabDisabled : !ENABLE_SEARCH_TAB,
  //MapAjax : new CMapAjax(),
  cont:null,

  init : function (div){
    var t = Tabs.Search;
  var Provinces = {1:{'name':"Tintagel",'x':75,'y':75},
        2:{'name':"Cornwall",'x':225,'y':75},
        3:{'name':"Astolat",'x':375,'y':75},
        4:{'name':"Lyonesse",'x':525,'y':75},
        5:{'name':"Corbenic",'x':625,'y':75},

        6:{'name':"Paimpont",'x':75,'y':225},
        7:{'name':"Cameliard",'x':225,'y':225},
        8:{'name':"Sarras",'x':375,'y':225},
        9:{'name':"Canoel",'x':525,'y':225},
        10:{'name':"Avalon",'x':625,'y':225},

        11:{'name':"Carmathen",'x':75,'y':375},
        12:{'name':"Shallot",'x':225,'y':375},
        13:{'name':"-------",'x':375,'y':375},
        14:{'name':"Cadbury",'x':525,'y':375},
        15:{'name':"Glastonbury",'x':625,'y':375},

        16:{'name':"Camlamn",'x':75,'y':525},
        17:{'name':"Orkney",'x':225,'y':525},
        18:{'name':"Dore",'x':375,'y':525},
        19:{'name':"Logres",'x':525,'y':525},
        20:{'name':"Caerleon",'x':625,'y':525},

        21:{'name':"Parmenie",'x':75,'y':675},
        22:{'name':"Bodmin Moor",'x':225,'y':675},
        23:{'name':"Cellwig",'x':375,'y':675},
        24:{'name':"Listeneise",'x':525,'y':675},
        25:{'name':"Albion",'x':625,'y':675}};
  unsafeWindow.PTgotoMap2 = t.gotoMap;
    unsafeWindow.PTpd = t.clickedPlayerDetail;
    unsafeWindow.PTpd2 = t.clickedPlayerLeaderboard;
  unsafeWindow.PCpo2 = t.clickedPlayerCheckOnline;
    unsafeWindow.PCplo2 = t.clickedPlayerGetLastLogin;
    t.cont = div;
    t.cont.innerHTML = '\
      <DIV class=ptentry><table><tr><td><TABLE><TR valign=bottom><TD class=xtab width=100 align=right>Suchen: </td><TD>\
      <SELECT id="srcType">\
        <OPTION value=0>Barbaren Lager</option>\
        <OPTION value=1>Wildniss</option>\
    <OPTION value=2>Städte</option>\
      </select></td></tr>\
      </table>\
      <DIV id="srcOpts" style="height:100px"></div></td><td style="visibility:hidden"><DIV id=divOutOpts style="background:#e0e0f0; padding:10px ;visibility:hidden"></div></td></tr></table></div>\
      <DIV id="srcResults" style="height:470px; max-height:470px;"></div>';
    var psearch = document.getElementById ("srcType");
    m = '<TABLE><TR valign=middle><TD class=xtab width=100 align=right>Startpunkt: &nbsp; X: </td><TD class=xtab>\
      <INPUT id=srchX type=text\> &nbsp; Y: <INPUT id=srchY type=text\> &nbsp;';
  m += '<span><select id="ptprovinceXY"><option>--Provinzen--</option>';
    for (var i in Provinces) {
      m += '<option value="'+i+'">'+Provinces[i].name+'</option>';
    }
  m += '</select></span>';

  m += '</td></tr><TR><TD class=xtab align=right>Max. Entfernung: </td><TD class=xtab><INPUT id=srcDist size=4 value=10 /> &nbsp; <SPAN id=spInXY></span></td></tr>';
    m += '<TR><TD class=xtab></td><TD class=xtab><INPUT id=srcStart type=submit value="Suche Starten"/></td></tr>';
    m += '</table>';
    document.getElementById ('srcOpts').innerHTML = m;
    new CdispCityPicker ('srchdcp', document.getElementById('spInXY'), true, null, 0).bindToXYboxes(document.getElementById ('srchX'), document.getElementById ('srchY'));
    document.getElementById ('ptprovinceXY').addEventListener('change', function() {
    if (this.value >= 1) {
      document.getElementById ('srchX').value = Provinces[this.value].x;
      document.getElementById ('srchY').value = Provinces[this.value].y;
      document.getElementById ('srcDist').value = 75;
    }
    }, false);
  document.getElementById ('srcStart').addEventListener ('click', t.clickedSearch, false);
  },

//Edit add city search
clickedPlayerDetail : function (span, uid){
    var t = Tabs.AllianceList;
    span.onclick = '';
    span.innerHTML = "suche details ...";
    t.fetchPlayerInfo (uid, function (r) {t.gotPlayerDetail(r, span)});
  },

  clickedPlayerLeaderboard : function (span, uid){
    var t = Tabs.AllianceList;
    span.onclick = '';
    span.innerHTML = "suche leaderboard info ...";
    t.fetchLeaderboard (uid, function (r) {t.gotPlayerLeaderboard(r, span)});
  },
  
  clickedPlayerCheckOnline : function (span, uid){
  var s = Tabs.Search;
    span.onclick = '';
    span.innerHTML = "suche online status ...";
    s.fetchPlayerStatus (uid, function (r) {s.gotPlayerStatus(r, span, uid)});
  },
  
  fetchPlayerStatus : function (uidArray, notify){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.checkArr = uidArray;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getOnline.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },


  
  gotPlayerLeaderboard : function (rslt, span){
    var t = Tabs.AllianceList;
    alert(rslt);
    if (!rslt.ok){
      span.innerHTML = rslt.errorMsg;
      return;
    }
    if (rslt.totalResults == 0){
      span.innerHTML = '<B>Leaderboard:</b> nicht gefunden! evtl. im Nebel ?';
      return;
    }
    var p = rslt.results[0];
    var an = p.allianceName;
    if (!an || an=='' || p.officerType==4)
      an = 'none';
    else
      an += ' ('+ officerId2String(p.officerType) +')';
    m = '<TABLE cellspacing=0 class=ptTab><TR><TD><B>Leaderboard: </b></td><TD colspan=2> Macht: '+ p.might  +' &nbsp; Allianz: '+ an +'</td></tr>';
    for (var i=0; i<p.cities.length; i++){
      var c = p.cities[i];
      m += '<TR><TD align=right><B>Stadt #'+ (i+1) +':</b></td><TD> &nbsp; '+ c.cityName +' '+coordLink (c.xCoord, c.yCoord)+'</td><TD width=75%> &nbsp; Level: '
        + c.tileLevel +' &nbsp; &nbsp; Status: '+ cityStatusString (c.cityStatus) +' &nbsp; &nbsp; Erstellt: ' + c.dateCreated.substr(0,10) +'</td></tr>';
    }  
    span.innerHTML = m + '</table>';
  },
    
  gotPlayerDetail : function (rslt, span){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      span.innerHTML = rslt.errorMsg;
      return;
    }
    var u = rslt.userInfo[0];
    var a = 'None';
    if (u.allianceName)
      a = u.allianceName +' ('+ getDiplomacy(u.allianceId) + ')';
    var m = '<TABLE cellspacing=0 class=ptTab><TR><TD><B>Details:</b> &nbsp; </td><TD>Allianz: '+ a +' &nbsp; Städte: '
          + u.cities +' &nbsp; Bevölkerung: '+ u.population +'</td></tr><TR><TD></td><TD>Provinzen: ';
    var pids = u.provinceIds.split (',');
    var p = [];
    for (var i=0; i<pids.length; i++)
      p.push(unsafeWindow.provincenames['p'+pids[i]]);
    span.innerHTML = m + p.join (', ') +'</td></tr></table>';
  },
  
  gotPlayerStatus : function (rslt, span,uid){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      span.innerHTML = rslt.errorMsg;
      return;
    }

    var p = rslt.data;
    if (p[uid] == true) {

      m = '<span style="color:green"><blink><b>Online</b></blink></span>';
    } else {
       m = '<span style="color:red"><b>evtl. Offline</b></span>';
    }  
    span.innerHTML = m + '';
  },

  gotPlayerLastLogin : function (rslt, span){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      span.innerHTML = rslt.errorMsg;
      return;
    }

    var p = rslt.playerInfo;
    var lastLogin = rslt.playerInfo.lastLogin;
    
    if (lastLogin) {
      m = '<u>Login</u> <b><FONT COLOR=#660000> '+lastLogin+' </font></b>';
    } else {
       m = '<span style="color:red">Keine Logindaten gefunden: '+lastLogin+'</span>';
    }  
    span.innerHTML = m + '';
  },
//End edit city search

  hide : function (){
  },

  show : function (cont){
  },

  opt : {},

  searchRunning : false,
  tilesSearched : 0,
  tilesFound : 0,
  curX : 0,
  curY : 0,
  lastX : 0,
  firstX : 0,
  firstY : 0,
  lastY : 0,

  normalizeCoord : function (x){
    if ( x >= 750)
      x -= 750;
    else if (x < 0)
      x += 750;
    return parseInt (x/5) * 5;
  },

  clickedSearch : function (){
    var t = Tabs.Search;

    if (t.searchRunning){
      t.stopSearch ('SUCHE ABGEBROCHEN!');
      return;
    }
    t.opt.searchType = document.getElementById ('srcType').value;
    t.opt.startX = parseInt(document.getElementById ('srchX').value);
    t.opt.startY = parseInt(document.getElementById ('srchY').value);
    t.opt.maxDistance = parseInt(document.getElementById ('srcDist').value);
    errMsg = '';

    if (isNaN (t.opt.startX) ||t.opt.startX<0 || t.opt.startX>749)
      errMsg = "<blink>X muss zwischen 0 und 749 liegen!</blink><BR>";
    if (isNaN (t.opt.startY) ||t.opt.startY<0 || t.opt.startY>749)
      errMsg += "<blink>Y muss zwischen 0 und 749 liegen!</blink><BR>";
    if (isNaN (t.opt.maxDistance) ||t.opt.maxDistance<1 || t.opt.maxDistance>750)
      errMsg += "<blink>Max. Entfernung muss zwischen 1 und 750 liegen!</blink><BR>";
    if (errMsg != ''){
      document.getElementById('srcResults').innerHTML = '<FONT COLOR=#660000>FEHLER:</font><BR><BR>'+ errMsg;
      return;
    }

    t.searchRunning = true;
    document.getElementById ('srcStart').value = 'Suche Abbrechen';
    m = '<DIV class=ptstat><TABLE width=100% cellspacing=0><TR><TD class=xtab width=125><DIV id=statSearched></div></td>\
        <TD class=xtab align=center><SPAN id=statStatus></span></td>\
        <TD class=xtab align=right width=125><DIV id=statFound></div></td></tr></table></div>\
      <TABLE width=100%><TR><TD><DIV id=divOutTab style="width:100%; height:470px; max-height:470px; overflow-y:auto;"></div></td></tr></table>';
    document.getElementById('srcResults').innerHTML = m;
    if (t.opt.searchType == 0)
      typeName = 'Barbaren Lager';
    else if (t.opt.searchType == 1)
      typeName = 'Wildnisse';
  else
    typeName = 'Städte';

    m = '<CENTER><B>Suche nach '+ typeName +'<BR>\
        Startpunkt: '+ t.opt.startX +','+ t.opt.startY +'  &nbsp; Entfernung: '+ t.opt.maxDistance +'<BR></center>\
        <DIV class=ptentry><TABLE cellspacing=0 width=100%><TR align=center><TD class=xtab colspan=10><B>EINSTELLUNG:</b><BR></td></tr>';
  if (t.opt.searchType == 1 || t.opt.searchType == 0) {
      m += '<TR><TD class=xtab align=right>Min. Level:</td><TD class=xtab> <INPUT id=filMinLvl size=2 value='+ Options.srcMinLevel +' /></td></tr>\
        <TR><TD class=xtab align=right>Max. Level:</td><TD class=xtab> <INPUT id=filMaxLvl size=2 value='+ Options.srcMaxLevel +' /></td></tr>';
  }
    if (t.opt.searchType == 1){
      m += '<TR><TD class=xtab align=right>Wildniss Typ:</td><TD class=xtab><SELECT id=filWildType>';
      m += htmlOptions ( {1:'Glassland/See', 3:'Wälder', 4:'Hügel', 5:'Berg', 6:'Ebene', 0:'Alle'}, Options.wildType );
      m += '</select></td></tr><TR><TD class=xtab align=right>Frei:</td>\
      <TD class=xtab><INPUT id=filUnowned type=CHECKBOX '+ (Options.unownedOnly?' CHECKED':'') +'\><td></tr>';
    }
  if (t.opt.searchType == 1 || t.opt.searchType == 0) {
    m += '<TR><TD class=xtab align=right>Sortieren:</td><TD class=xtab><SELECT id=filSortBy>\
        <OPTION value="Level" '+ (Options.srcSortBy=='Level'?'SELECTED':'')  +'>Level</option>\
        <OPTION value="Entfernung" '+ (Options.srcSortBy=='Entfernung'?'SELECTED':'')  +'>Entfernung</option>';
    if(t.opt.searchType == 1){ m+= '<OPTION value="Macht" '+ (Options.srcSortBy=='Macht'?'SELECTED':'')  +'>Macht</option>';}
      m += '</select></td></tr>\
            <TR><TD class=xtab align=right>Nur Koordinaten: </td><TD class=xtab><INPUT type=checkbox id=coordsOnly \></td></tr>\
            </table></div><BR><SPAN id=srchSizeWarn></span>';
  } else {
   m += '<TR><TD class=xtab align=right>Stadt Typ:</td><TD class=xtab><SELECT id=filCities>';
     m += htmlOptions ( {1:'Alle', 2:'Alliierte', 3:'Freundlich', 4:'Feinlich', 5:'Neutral', 6:'Allianzlos', 7:'Nebel'}, Options.cityType );
     m += '</select></td></tr>';    
   m += '<TR><TD class=xtab align=right>Sortieren:</td><TD class=xtab><SELECT id=filSortBy>\
      <OPTION value="Macht" '+ (Options.srcSortBy=='Macht'?'SELECTED':'')  +'>Macht</option>\
      <OPTION value="Entfernung" '+ (Options.srcSortBy=='Entfernung'?'SELECTED':'')  +'>Entfernung</option>\
           </select></td></tr>\
       <TR><TD class=xtab align=right>Min. Macht:</td><TD class=xtab><INPUT type=text id=minMight value='+Options.MightSrc+' size=3 \></td></tr>\
           <TR><TD class=xtab align=right>Nur Koordinaten:</td><TD class=xtab><INPUT type=checkbox id=coordsOnly \></td></tr>\
           </table></div><BR><SPAN id=srchSizeWarn></span>';
  }

  document.getElementById ('divOutOpts').style.visibility = 'visible';
    document.getElementById('divOutOpts').innerHTML = m;
  if (t.opt.searchType == 1 || t.opt.searchType == 0) {
    document.getElementById('filMinLvl').addEventListener ('change', function (){
      Options.srcMinLevel = document.getElementById('filMinLvl').value;
      saveOptions();
      t.dispMapTable ();
      }, false);
    document.getElementById('filMaxLvl').addEventListener ('change', function (){
      Options.srcMaxLevel = document.getElementById('filMaxLvl').value;
      saveOptions();
      t.dispMapTable ();
      }, false);
  }
    document.getElementById('filSortBy').addEventListener ('change', function (){
      Options.srcSortBy = document.getElementById('filSortBy').value;
      saveOptions();
      t.dispMapTable ();
      }, false);
    document.getElementById('coordsOnly').addEventListener ('change', function (){ t.dispMapTable (); }, false);
    if (t.opt.searchType == 1){
      document.getElementById('filWildType').addEventListener ('change', function (){
        Options.wildType = document.getElementById('filWildType').value;
        saveOptions();
        t.dispMapTable ();
        }, false);
      document.getElementById('filUnowned').addEventListener ('change', function (){
        Options.unownedOnly = (document.getElementById('filUnowned').checked);
        saveOptions();
        t.dispMapTable ();
        }, false);
    }
  if (t.opt.searchType == 2){
    document.getElementById('filCities').addEventListener ('change', function (){
    Options.cityType = document.getElementById('filCities').value
    saveOptions();
        t.dispMapTable ();
    },false);
    document.getElementById('minMight').addEventListener ('change', function (){
    Options.MightSrc = document.getElementById('minMight').value
    saveOptions();
        t.dispMapTable ();
    },false);
  }

    t.mapDat = [];
    t.firstX =  t.opt.startX - t.opt.maxDistance;
    t.lastX = t.opt.startX + t.opt.maxDistance;
    t.firstY =  t.opt.startY - t.opt.maxDistance;
    t.lastY = t.opt.startY + t.opt.maxDistance;
    t.tilesSearched = 0;
    t.tilesFound = 0;
    t.curX = t.firstX;
    t.curY = t.firstY;
    var xxx = t.normalizeCoord(t.curX);
    var yyy = t.normalizeCoord(t.curY);
    document.getElementById ('statStatus').innerHTML = 'Durchsuche... '+ xxx +','+ yyy;
if (DEBUG_TRACE) logit (" 0 clickedSearch()... setTimeout ..:" + xxx +' , '+ yyy +' , '+ t.mapCallback.name);
    setTimeout (function(){Map.request (xxx, yyy, 15, t.mapCallback)}, MAP_DELAY);
  },

  dispMapTable : function (){
    var tileNames = ['Barbaren Lager', 'Grassland', 'See', 'Wälder', 'Hügel', 'Berg', 'Ebene', 'Stadt' ];
    var t = Tabs.Search;
    var coordsOnly = document.getElementById('coordsOnly').checked;
if (DEBUG_TRACE) DebugTimer.start();
    function mySort(a, b){
      if (Options.srcSortBy == 'Level'){
        if ((x = a[4] - b[4]) != 0)
          return x;
      }
    if (Options.srcSortBy == 'Macht'){
    if(b[10] == null) b[10] = 0;
    if(a[10] == null) a[10] = 0;
        if ((x = b[10] - a[10]) != 0)
          return x;
      }
      return a[2] - b[2];
    }

   dat = [];
    for (i=0; i<t.mapDat.length; i++){
      lvl = parseInt (t.mapDat[i][4]);
      type = t.mapDat[i][3];
    if (t.opt.searchType == 2 && type == 7 ) {
if (DEBUG_TRACE) DebugTimer.display('if (t.opt.searchType == 2 && type == 7 )  document.getElementById( idSrchFilter ).value = ' + document.getElementById('idSrchFilter').value + ' ' + t.mapDat[i][12]);
              switch(parseInt (document.getElementById('idSrchFilter').value)) {
                case 0:
                 dat.push(t.mapDat[i]);
                 break;
                case 1:
                   if (t.mapDat[i][12] == 'Feindlich') dat.push(t.mapDat[i]);
                   break;
                case 2:
                   if (t.mapDat[i][5]===true) dat.push(t.mapDat[i]);
                   break;
                case 3:
                   if (t.mapDat[i][12] == 'Alliierte') dat.push(t.mapDat[i]);
                   break;
                case 4:
                   if (t.mapDat[i][12] == 'Freundlich') dat.push(t.mapDat[i]);
                   break;
                case 5:
                   if (t.mapDat[i][12] == 'Neutral') dat.push(t.mapDat[i]);
                   break;
                 case 6:
                   if (t.mapDat[i][12] == 'Allianzlos') dat.push(t.mapDat[i]);
                   break;
             }
    } else {
       if (lvl>=Options.srcMinLevel && lvl<=Options.srcMaxLevel){
        if (t.opt.searchType==0
            || (Options.woodWild==1 && type == 3)
            || (Options.hillWild==1 && type ==4)
            || (Options.mtnWild==1 && type==5)
            || (Options.plnWild==1 && type == 6)
            || (Options.foodWild==1 && (type==1 || type==2)))
          if (!Options.unownedOnly || t.mapDat[i][5]===false)
            dat.push (t.mapDat[i]);
        }
       }
    }
if (DEBUG_TRACE) DebugTimer.display('SEACHdraw: FILTER');

    document.getElementById('statFound').innerHTML = 'Gefunden: '+ dat.length;
    if (dat.length == 0){
      m = '<BR><CENTER>nichts Gefunden... :/ </center>';
    } else {
      dat.sort(mySort);
if (DEBUG_TRACE) DebugTimer.display('SEACHdraw: SORT');
      if (coordsOnly)
        m = '<TABLE align=center id=srcOutTab cellpadding=2 cellspacing=2><TR style="font-weight: bold"><TD>Koordinate</td></tr>';
      else {
        if (t.opt.searchType == 2) {
      m = '<TABLE id=srcOutTab cellpadding=2 cellspacing=2><TR style="font-weight: bold"><TD>Koordinate</td><TD >Entfernung</td><TD>Stadt</td><TD>Besitzer</td><TD>Macht</td><td>Allianz</td><TD width=80% style="font-size:9px;">Information</td><TD style="padding-left: 10px;"></td></tr>';
    } else {
      if(Options.unownedOnly || t.opt.searchType == 0){
        m = '<TABLE id=srcOutTab cellpadding=2 cellspacing=2><TR style="font-weight: bold"><TD>Koordinate</td><TD style="padding-left: 10px">Entfernung</td><TD style="padding-left: 10px;">Level</td><TD width=80%> &nbsp; Typ</td><TD style=""></td></tr>';
      } else {
        m = '<TABLE id=srcOutTab cellpadding=2 cellspacing=2><TR style="font-weight: bold"><TD>Koordinate</td><TD style="padding-left: 10px">Entfernung</td><TD style="padding-left: 10px;">Level</td><TD>Type</td><TD>Besitzer</td><TD>Macht</td><TD>Allianz</td><TD width=80% style="font-size:9px;">Information</td></tr>';
      }
    }
    }
      var numRows = dat.length;
      if (numRows > 500 && t.searchRunning){
        numRows = 500;
        document.getElementById('srchSizeWarn').innerHTML = '<FONT COLOR=#600000><u>Wichtig</u>: Tabelle zeigt nur 500 von  '+ dat.length +' Ergebnissen an bis die Suche beendet ist!</font>';
      }
      for (i=0; i<numRows; i++){
      m += '<TR valign="top"';
     if (dat[i][12]) m += 'class="pt'+dat[i][12]+'"';
        m += ' ><TD><DIV onclick="ptGotoMapHide('+ dat[i][0] +','+ dat[i][1] +')"><A>'+ dat[i][0] +','+ dat[i][1] +'</a></div></td>';
        if (coordsOnly)
          m += '</tr>';
        else
      if (t.opt.searchType == 2) {
         m += '<TD align="left"  valign="top">'+ dat[i][2].toFixed(2) +' &nbsp; </td><TD align=left>'+ dat[i][8] +'</td><TD valign="top">'+dat[i][9]+'</td><TD valign="top">'+dat[i][10]+'</td><td>'+dat[i][11]+'</td><td>';
         if (dat[i][5]) {
          m += '<DIV onclick="PTscout('+ dat[i][0] +','+ dat[i][1] +');return false;"><A style="font-size:9px;" >Spähen</a></div>';
        } else
          m += '<DIV onclick="PTpd(this, '+ dat[i][7] +')"><A style="font-size:9px;" >Details</a></div>\
          <DIV style="" onclick="PTpd2(this, '+ dat[i][7] +')"><A style="font-size:9px;">Leaderboard</a></div>\
          <DIV style="" onclick="PCpo2(this, '+ dat[i][7] +')"><A style="font-size:9px;">Online Status</a></div>\
          <DIV style="" onclick="PCplo2(this, '+ dat[i][7] +')"><A style="font-size:9px;">Login</a></div>';
          m+= '</td><TD  valign="top">'+ (dat[i][5]?' Nebel':'') +'</td></tr>';
      } else {
        if(!dat[i][5] || t.opt.searchType == 0){
        m += '<TD align="left"  valign="top">'+ dat[i][2].toFixed(2) +' &nbsp; </td><TD align=left valign="top">'+ dat[i][4] +'</td><TD align="left" valign="top">'+ tileNames[dat[i][3]]+'</td><TD colspan=4>'+ (dat[i][5]?' BESETZ':'') +'</td></tr>';
        } else {
          m += '<TD align="left"  valign="top">'+ dat[i][2].toFixed(2) +' &nbsp; </td><TD align=left valign="top">'+ dat[i][4] +'</td><TD align="left" valign="top">'+ tileNames[dat[i][3]]+'</td><TD valign="top">'+ dat[i][9] +'</td><TD valign="top">'+dat[i][10]+'</td><TD valign="top">'+dat[i][11]+'</td><td>';
          if (dat[i][6]) {
          m += '<DIV onclick="PTscout('+ dat[i][0] +','+ dat[i][1] +');return false;"><A style="font-size:9px;" >Spähen</a></div>';
          } else {
          m += '<DIV onclick="PTpd(this, '+ dat[i][8] +')"><A style="font-size:9px;" >Details</a></div>\
          <DIV style="" onclick="PTpd2(this, '+ dat[i][8] +')"><A style="font-size:9px;">Leaderboard</a></div>\
          <DIV style="" onclick="PCpo2(this, '+ dat[i][8] +')"><A style="font-size:9px;">Online Status</a></div>\
          <DIV style="" onclick="PCplo2(this, '+ dat[i][8] +')"><A style="font-size:9px;">Login</a></div>';
          }
        m += '</td></tr>';
        }
      }
       }
      m += '</table>';
    }
    document.getElementById('divOutTab').innerHTML = m;
    dat = null;
if (DEBUG_TRACE) DebugTimer.display('SEACHdraw: DRAW');
  },

  mapDat : [],

  gotoMap : function (e){
    coords = e.children[0].innerHTML.split(',');
    hideMe ();
    document.getElementById('mapXCoor').value = coords[0];
    document.getElementById('mapYCoor').value = coords[1];
    unsafeWindow.reCenterMapWithCoor();
    unsafeWindow.changeview_map(document.getElementById('mod_views_map'));
  },
  
  stopSearch : function (msg){
    var t = Tabs.Search;
    document.getElementById ('statStatus').innerHTML = '<FONT color=#ffaaaa>'+ msg +'</font>';
    document.getElementById ('srcStart').value = 'Suche Starten';
    document.getElementById('srchSizeWarn').innerHTML = '';
    t.searchRunning = false;
  },


/** mapdata.userInfo:
(object) u4127810 = [object Object]
    (string) n = George2gh02    (name)
    (string) t = 1              (title code)
    (string) m = 55             (might)
    (string) s = M              (sex)
    (string) w = 2              (mode: 1=normal, 2=begprotect, 3=truce, 4=vacation )
    (string) a = 0              (alliance)
    (string) i = 1              (avatar code)
*****/

  mapCallback : function (left, top, width, rslt){
    function insertRow (x, y, msg){
      row = document.getElementById('srcOutTab').insertRow(-1);
      row.insertCell(0).innerHTML = x +','+ y;
      row.insertCell(1).innerHTML = distance (t.opt.startX, t.opt.startY, x, y);
      row.insertCell(2).innerHTML = msg;
    }
if (DEBUG_TRACE) logit (" 3 mapCallback()");
    var t = Tabs.Search;
    if (!t.searchRunning)
      return;
    if (!rslt.ok){
      t.stopSearch ('FEHLER: '+ rslt.errorMsg);
      return;
    }

    map = rslt.data;
  var userInfo = rslt.userInfo;
    var alliance = rslt.allianceNames;
  
    for (k in map){
      if (t.opt.searchType==0 && map[k].tileType==51 && !map[k].tileCityId ) {  // if barb
        type = 0;
      } else if (t.opt.searchType==1 && map[k].tileType>=10 &&  map[k].tileType<=50) {
        if (map[k].tileType == 10)
          type = 1;
        else if (map[k].tileType == 11)
          type = 2;
        else
          type = (map[k].tileType/10) + 1;
      } else if (t.opt.searchType==2 && map[k].tileCityId >= 0 && map[k].tileType > 50 && map[k].cityName)
      type = 7;
    else
        continue;
      dist = distance (t.opt.startX, t.opt.startY, map[k].xCoord, map[k].yCoord);
      if (dist <= t.opt.maxDistance){
      if (t.opt.searchType==2) {
      var isMisted = map[k].tileUserId == 0 || false;    
      var uu = 'u'+map[k].tileUserId;
      var aU = 'unknown';
      var aD = 'unknown';
      var mightU = 0;
      var nameU = 'unknown';
      if (isMisted) {
        nameU = 'Im Nebel';
        mightU = '';
      } else {
        if (userInfo[uu] ) { // Corrects a problem with hung search.
          nameU = userInfo[uu].n;
          mightU = userInfo[uu].m;
          aD = getDiplomacy(userInfo[uu].a);
          if ( alliance && alliance['a'+userInfo[uu].a] ) {
            aU = alliance['a'+userInfo[uu].a];
          }
          else {
            aU = '---';
            aD = 'Allianzlos';
          }
        }
      }
      t.mapDat.push ([map[k].xCoord, map[k].yCoord, dist, type, map[k].tileLevel, isMisted, map[k].tileCityId, map[k].tileUserId, map[k].cityName,nameU,mightU,aU,aD ]);
    } else {
      isOwned = map[k].tileUserId>0 || map[k].misted;
      if(!isOwned){
        t.mapDat.push ([map[k].xCoord, map[k].yCoord, dist, type, map[k].tileLevel, isOwned]);
      } else {
        var isMisted = map[k].tileUserId == 0 || false;
        var uu = 'u'+map[k].tileUserId;
        var aU = 'unknown';
        var aD = 'unknown';
        var mightU = 0;
        var nameU = 'unknown';
        if (isMisted) {
          nameU = 'Im Nebel';
          mightU = '';
        } else {
          if (userInfo[uu] ) { // Corrects a problem with hung search.
            nameU = userInfo[uu].n;
            mightU = userInfo[uu].m;
            aD = getDiplomacy(userInfo[uu].a);
            if ( alliance && alliance['a'+userInfo[uu].a] ) {
              aU = alliance['a'+userInfo[uu].a];
            }
            else {
              aU = '---';
              aD = 'Allianzlos';
            }
          }
        }
        t.mapDat.push ([map[k].xCoord, map[k].yCoord, dist, type, map[k].tileLevel, isOwned, isMisted, map[k].tileCityId, map[k].tileUserId, nameU, mightU, aU, aD]);
      }
    }
        ++t.tilesFound;
      }
    }
    t.tilesSearched += (15*15);
    document.getElementById('statSearched').innerHTML = 'Durchsucht: '+ t.tilesSearched;
    t.dispMapTable();

    t.curX += 15;
    if (t.curX > t.lastX){
      t.curX = t.firstX;
      t.curY += 15;
      if (t.curY > t.lastY){
        t.stopSearch ('Fertig!');
        return;
      }
    }

    var x = t.normalizeCoord(t.curX);
    var y = t.normalizeCoord(t.curY);
    document.getElementById ('statStatus').innerHTML = 'Durchsuche... '+ x +','+ y;
if (DEBUG_TRACE) logit (" 0 mapCallback()... setTimeout ..:" + x +' , '+ y +' , '+ t.mapCallback.toString().substr (0,50));
    setTimeout (function(){Map.request (x, y, 15, t.mapCallback)}, MAP_DELAY);
  },
};

function estimateETA (fromCityID,dist,troopSpeed,horseTF) { // Need Relief Station Levels to estimate transport, reinf, or reassign times.
    var ret={ETA:-1,etaStr:'NA',friendETA:-1,friendEtaStr:'NA'};
    if (dist <= 0) return ret;
    if (troopSpeed <=0) return ret;
    var horse = horseTF;
    var baseSpeed = troopSpeed;
    var mmLvl = parseInt(Seed.tech.tch11);//Magical Mapping
    var Speed = 0;
    if (horse==true){
    //HorsesSiegeSpeed = Base * (1 + MM/10) * (1 + AH/20)
      var hsLvl = parseInt(Seed.tech.tch12);//Alloy Horse Shoes
      Speed = baseSpeed * (1 + mmLvl/10) * (1 + hsLvl/20);
    }
    else {
    //FootSpeed = Base * (1 + MM/10)
      Speed = baseSpeed * (1 + mmLvl/10);
    }
    //Grid Speed (tiles/second) = Speed (100ths/min) / 6000
    var gSpeed = 0;
    var estSec = 0;
    if (Speed>0) {
      gSpeed = Speed/6000;
      estSec = (dist/gSpeed).toFixed(0);
    }
    ret.ETA = parseInt((estSec+''))+30;
    ret.etaStr = timestr ( (ret.ETA+'') ,1 );
    //RS - Cities Relief Station Level
    //Friendly Speed = Speed * (1 + RS/2)
    if (fromCityID>0) {
      //logit ('ETAest - cityID: ' + cityID);
      var building = getCityBuilding (fromCityID, 18);//18 is relief station id.
      if (building) {
        fSpeed = Speed * (1 + parseInt(building.maxLevel)/2);
        gSpeed = fSpeed/6000;
        estSec = (dist/gSpeed).toFixed(0);
        ret.friendETA = parseInt((estSec+''))+30;
        ret.friendEtaStr = timestr ((ret.friendETA+''),1);
      }
    }
    return ret;
};

/*******************   KOC Map interface ****************/
Map = {
/***
 0: bog
10: grassland
11: lake
20: woods
30: hills
40: mountain
50: plain
51: city / barb
53: misted city
***/
  generateBlockList : function(left, top, width) {
    var width5 = parseInt(width / 5);
    var bl = [];

    for (x=0; x<width5; x++){
      xx = left + (x*5);
      if (xx > 745)
        xx -= 750;
      for (y=0; y<width5; y++){
        yy = top + (y*5);
        if (yy > 745)
          yy -= 750;
        bl.push ('bl_'+ xx +'_bt_'+ yy);
      }
    }
    return bl.join(",");
  },

  callback : null,
  request : function (left, top, width, cb) {
if (DEBUG_TRACE) logit (" 1 Map.request(): "+ left +' , '+ top +' , '+ width);
    left = parseInt(left / 5) * 5;
    top = parseInt(top / 5) * 5;
    width = parseInt((width+4) / 5) * 5;
    var blockString = this.generateBlockList(left, top, width);
    Map.callback = cb;
    if (unsafeWindow.SANDBOX)
      return RequestMAPTEST(left, top, width, callback);
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.blocks = blockString;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/fetchMapTiles.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
if (DEBUG_TRACE) logit (" 2 Map.request  Map = "+ inspect (Map, 2, 1, 2));
        Map.callback(left, top, width, rslt);
      },
      onFailure: function (rslt) {
        Map.callback(left, top, width, rslt);
      }
    });
  },
};

/*************************************** Train Tab ***********************************************/

Tabs.Train = {
  tabLabel : 'Ausbildung',
  tabOrder : toAusbildung,
  cont : null,
  timer : null,
  stats : {},
  selectedCity : {},
  trainTimer : null,
  running : false,
  
  init : function (div){
    var t = Tabs.Train;
    t.cont = div;
uW.cancelTrain = t.butcancelTrain;
 uW.cancelFort = t.butcancelFort;
    s = "<DIV id=trainTopSelect>\
      <DIV class=ptstat  id=trainheader>Hier kannst du Truppen Ausbilden und Mauer Verteidigung Bauen</div><DIV style='height:10px'></div><DIV class=ptentry>\
      <DIV style='text-align:center; margin-bottom:10px;'><b>Heiligtum</b>: &nbsp; <span id=ptspeedcity></span></div>\
      <TABLE class=ptTab width=100%><TR valign=top><TD width=50%>\
      <TABLE align=center><TR><TD align=right>Truppen Typ </td><TD colspan=2>\
      <SELECT id=ptttType>\
        <option value='1'>Versorgungstruppe</option>\
        <option value='2'>Milizsoldat</option>\
        <option value='3'>Späher</option>\
        <option value='4'>Lanzenträger</option>\
        <option value='5'>Schwertkämpfer</option>\
        <option value='6'>Bogenschütze</option>\
        <option value='7'>Kavallerie</option>\
        <option value='8'>Schwere Kavallerie</option>\
        <option value='9'>Versorgungswagen</option>\
        <option value='10'>Ballisten</option>\
        <option value='11'>Rammbock</option>\
        <option value='12'>Steinschleuder</option>\
      </select> &nbsp; max. <span id=ptttSpMax></span></td></tr>\
      <TR><TD align=right># je Slot: </td><TD><INPUT id='ptttInpPS' size=5 type='text' value='0'\></td>\
        <TD><INPUT id='ptttButMaxPS' type=submit value='max'\> &nbsp; max. <span id=ptttSpMaxPS>0</span></td></tr>\
      <TR><TD align=right># Slots: </td><TD><INPUT id='ptttInpSlots' size=2 type='text' value='1'\></td>\
        <TD width=75%><INPUT id='ptttButMaxSlots' type=submit value='max'\> &nbsp; max. <span id=ptttSpMaxSlots>1</span></td></tr>\
      <TR><TD align=right>Du benötigst mehr: </td><td colspan=2><font color=#FF0000><B> <span id=ptttLimiter></span> </b></font></TD></TR>\
      <TR><TD align=right valign=top>Arbeiter Entlassen: </td><TD colspan=2><INPUT type=CHECKBOX id=chkPop"+ (Options.maxIdlePop?' CHECKED ':'') +"> \
        <SPAN style='white-space:normal;'>Erlaubt dir die Feld Arbeiter zu Soldaten Auszubilden! <FONT COLOR=#600000><B>(Feld Produktion wird vorerst eingestellt!)</b></font></span></td></tr>\
      <TR><TD colspan=3 align=center><SELECT id=tutelage>\
		<option value='0'><CENTER>--- "+uW.g_js_strings.commonstr.speedup+" ---</center></option>\
		<option value='36'>"+ uW.itemlist.i36.name+"</option>\
        <option value='37'>"+ uW.itemlist.i37.name+"</option>\
        <option value='38'>"+ uW.itemlist.i38.name+"</option>\
		</select>\
			</td></tr>\
	  <TR><TD colspan=3 align=center><DIV style='height:10px'></div><INPUT id='ptttButDo' type=submit value='Truppen Ausbilden'\></td></tr>\
      </table></td><TD width=20></td><TD style='border-left:solid 2px;' width=50% align=center>\
      <TABLE align=center><TR><TD align=right>Mauer Bau </td><TD colspan=2>\
      <SELECT id=pttdType>\
        <option value='53'>Fest montierte Armbrüste</option>\
        <option value='55'>Abwehr Trebuchet</option>\
        <option value='60'>Falle</option>\
        <option value='61'>Krähenfüße</option>\
        <option value='62'>Eiserne Erdspieße</option>\
      </select> &nbsp; <span id=pttdSpMax></span></td></tr>\
      <TR><TD align=right># per Slot: </td><TD><INPUT id='pttdInpPS' size=5 type='text' value='0'\></td>\
        <TD><INPUT id='pttdButMaxPS' type=submit value='max'\> &nbsp; max. <span id=pttdSpMaxPS>0</span></td></tr>\
      <TR><TD align=right># Slots: </td><TD><INPUT id='pttdInpSlots' size=2 type='text' value='1'\></td>\
        <TD width=75%><INPUT id='pttdButMaxSlots' type=submit value='max'\> &nbsp; max. <span id=pttdSpMaxSlots>1</span></td></tr>\
      <TR align=center><td align=right>Du benötigst mehr: </td><TD colspan=2 align=left><font color=#FF0000><B> <span id=pttdLimiter></span> </b></font></td></tr>\
      <TR align=center><TD colspan=3><SPAN id=pttdSpace></span></td></tr>\
	  <TR><TD colspan=3 align=center><SELECT id=siege>\
      <option value='0'><CENTER>--- "+uW.g_js_strings.commonstr.speedup+" ---</center></option>\
      <option value='26'>"+ uW.itemlist.i26.name+"</option>\
      </select></div>\
      <BR><INPUT id='pttdButDo' type=submit value='"+uW.g_js_strings.modal_openWalls.builddefenses+"'\></td></tr></table>\
      </td></tr></table></div></div>\
      <TABLE align=center width=425 class=ptTab><TR><TD><div id=ptTrainStatus style='overflow-y:auto; max-height:78px; height: 78px;'></div></td></tr></table>\
      <div style='height: 330px; background: #e8ffe8'>\
      <TABLE width=100% class=ptTab><TR><TD colspan=3><DIV id=divSTtop></div></td></tr>\
      <TR><TD width=50% style='padding-left:15px; padding-right:15px'><DIV style='text-align:center'>\
      <B>"+uW.g_js_strings.commonstr.troops+" ("+uW.g_js_strings.modal_openBarracks.trainingttl+")\
        &nbsp; (<SPAN id=statTTtot></span>)</b><BR><HR></div><DIV id=divSTleft style='overflow-y: auto; height:210px; max-height:210px'></div></td>\
        <TD width=50% style='padding-left:15px; padding-right:15px'><DIV style='text-align:center'><B>"+uW.g_js_strings.modal_openWalls.defqueue+"&nbsp; (<SPAN\ id=statDTtot></span>)</b><BR><HR></div><DIV id=divSTright style='overflow-y: auto; height:210px; max-height:210px'></div></td></tr>\
      </div>";
    t.cont.innerHTML = s;

    var dcp = new CdispCityPicker ('ptspeed', document.getElementById('ptspeedcity'), true, t.clickCitySelect, 0);
    t.TTspMax = document.getElementById ('ptttSpMax');
    t.TTspMaxPS = document.getElementById ('ptttSpMaxPS');
    t.TTspMaxSlots = document.getElementById ('ptttSpMaxSlots');
    t.TTbutMaxSlots = document.getElementById ('ptttButMaxSlots');
    t.TTbutMaxPerSlot = document.getElementById ('ptttButMaxPS');
    t.TTinpPerSlot = document.getElementById ('ptttInpPS');
    t.TTinpSlots = document.getElementById ('ptttInpSlots');
    t.TTselType = document.getElementById ('ptttType');
    t.TTbutDo = document.getElementById ('ptttButDo');
    t.TTlimiter = document.getElementById ('ptttLimiter');
    t.TDspMax = document.getElementById ('pttdSpMax');
    t.TDspMaxPS = document.getElementById ('pttdSpMaxPS');
    t.TDspMaxSlots = document.getElementById ('pttdSpMaxSlots');
    t.TDbutMaxSlots = document.getElementById ('pttdButMaxSlots');
    t.TDbutMaxPerSlot = document.getElementById ('pttdButMaxPS');
    t.TDinpPerSlot = document.getElementById ('pttdInpPS');
    t.TDinpSlots = document.getElementById ('pttdInpSlots');
    t.TDselType = document.getElementById ('pttdType');
    t.TDbutDo = document.getElementById ('pttdButDo');
    t.TDspSpace = document.getElementById ('pttdSpace');
    t.TDlimiter = document.getElementById ('pttdLimiter');
    t.divTrainStatus = document.getElementById ('ptTrainStatus');
          
    t.TTinpSlots.addEventListener ('change', t.updateTopTroops, false);
    t.TTbutMaxPerSlot.addEventListener ('click', t.clickTroopMaxPS, false);
    t.TTbutMaxSlots.addEventListener ('click', t.clickTroopMaxSlots, false);
    t.TTselType.addEventListener ('change', t.changeTroopSelect, false);
    t.TTbutDo.addEventListener ('click', t.clickTroopDo, false);
    t.TDinpSlots.addEventListener ('change', t.updateTopDef, false);
    t.TDselType.addEventListener ('change', t.changeDefSelect, false);
    t.TDbutMaxPerSlot.addEventListener ('click', t.clickDefMaxPS, false);
    t.TDbutMaxSlots.addEventListener ('click', t.clickDefMaxSlots, false);
    t.TDbutDo.addEventListener ('click', t.clickDefDo, false);
    
    document.getElementById ('chkPop').addEventListener ('change', t.clickCheckIdlePop, false);
    t.changeTroopSelect();
    t.changeDefSelect();
  },


  hide : function (){
    var t = Tabs.Train;
    clearTimeout (t.timer);
  },
  
  show : function (){
    var t = Tabs.Train;
    clearTimeout (t.timer);

    t.displayCityStats();
    t.changeTroopSelect();
    t.changeDefSelect();
    t.timer = setTimeout (t.show, 2000);
  },

/*******  TROOPS  ******/  

  
  updateTopTroops : function (){
    var t = Tabs.Train;
    var slots = parseInt(t.TTinpSlots.value, 10);
    if (isNaN(slots) || slots<0)
      slots = 0;
    t.TTspMax.innerHTML = t.stats.MaxTrain;
    t.TTlimiter.innerHTML = t.stats.Limiter;
    t.TTspMaxSlots.innerHTML = t.stats.barracks - t.stats.queued;
    if (slots<1 || (t.stats.barracks-t.stats.queued < 1))
      t.TTspMaxPS.innerHTML = 0;
    else
      t.TTspMaxPS.innerHTML = parseInt(t.stats.MaxTrain / slots);
  },
      
  
  clickTroopMaxPS : function (){
    var t = Tabs.Train;
    var slots = parseInt(t.TTinpSlots.value, 10);
    if (slots<1 || (t.stats.barracks-t.stats.queued < 1))
      t.TTinpPerSlot.value = 0;
    else
      t.TTinpPerSlot.value = parseInt(t.stats.MaxTrain / slots);
  },

  clickTroopMaxSlots : function (){
    var t = Tabs.Train;
    t.TTinpSlots.value = t.stats.barracks - t.stats.queued;
  },
  
  clickCitySelect : function (city){
    var t = Tabs.Train;
    t.selectedCity = city;
    t.lastQueString = null;   
    t.lastDQueString = null;   
    t.displayCityStats ();
    t.changeTroopSelect();
    t.changeDefSelect();
  },
  
  clickCheckIdlePop : function (){
    var t = Tabs.Train;
    if (document.getElementById ('chkPop').checked)
      Options.maxIdlePop = true;
    else
      Options.maxIdlePop = false;
    saveOptions ();
    t.displayCityStats ();
    t.changeTroopSelect ();
  },
  
  changeTroopSelect : function (){
    var t = Tabs.Train;
    var cityId = t.selectedCity.id;
    // unitcost: NAME, Food, Wood, Stone, Ore, Gold, Pop, ?
    var id = t.TTselType.value;
    t.lastTroopSelect = id;
    var uc = unsafeWindow.unitcost['unt'+id];
    var max = 9999999999;
    var limiter = 'Unbekannt';
    if ( (t.stats.food / uc[1]) < max) {
      max = t.stats.food / uc[1];
      limiter = 'Nahrung';
    }
    if ( (t.stats.wood / uc[2]) < max) {
      max = t.stats.wood / uc[2];
      limiter = 'Holz<';
    }
    if ( (t.stats.stone / uc[3]) < max) {
      max = t.stats.stone / uc[3];
      limiter = 'Stein';
    }
    if ( (t.stats.ore / uc[4]) < max) {
      max = t.stats.ore / uc[4];
      limiter = 'Erz';
    }
    if ( (t.stats.idlePop / uc[6]) < max) {
      max = t.stats.idlePop / uc[6];
      limiter = 'Bevölkerung';
    }
    t.stats.MaxTrain = parseInt (max);
    t.stats.Limiter = limiter;
    if (t.stats.MaxTrain < 0)
      t.stats.MaxTrain = 0;
    if (matTypeof(uc[8]) == 'object'){
      for (k in uc[8]){  // check building requirement
        var b = getCityBuilding (cityId, k.substr(1));
        if (b.maxLevel < uc[8][k][1]){
          t.stats.MaxTrain = 0;
          t.stats.Limiter = 'Gebäude/Upgrade';
          break;
        }
      }
    }
    if (matTypeof(uc[9]) == 'object'){
      for (k in uc[9]){    // check tech requirement
        if (parseInt(Seed.tech['tch'+k.substr(1)]) < uc[9][k][1]){
          t.stats.MaxTrain = 0;
          t.stats.Limiter = 'Forschung';
          break;
        }
      }
    }
    t.updateTopTroops();
  },
  
  clickTroopDo : function (){
    var t = Tabs.Train;
    var cityId = t.selectedCity.id;
    var unitId = t.TTselType.value;
    var perSlot = parseInt(t.TTinpPerSlot.value, 10);
    var numSlots = parseInt(t.TTinpSlots.value, 10);
    
    t.displayCityStats ();
    if (perSlot<1){
      t.divTrainStatus.innerHTML = '<FONT COLOR=#550000>Die Anzahl der Slots muss mind. <blink><b>1</b></blink> betragen...</font>';
      return;
    }
    if (perSlot*numSlots > t.stats.MaxTrain){
      t.divTrainStatus.innerHTML = '<FONT COLOR=#550000>Kann nicht so viele Truppen Ausbilden! <blink>'+ t.stats.MaxTrain +' </blink>ist dein max. !</font>';
      return;
    }
    if (numSlots<1 || numSlots>t.stats.barracks - t.stats.queued){
      t.divTrainStatus.innerHTML = '<FONT COLOR=#550000><blink>Fehlerhafte Slot anzahl!</blink></font>';
      return;
    }
    t.setBusy(true);
    var que = [];
    for (var i=0; i<numSlots; i++)
      que.push (['T', unitId, parseInt (perSlot)]);
    t.divTrainStatus.innerHTML = '';
    t.doQueue (cityId, que);
  },

  
/*******  DEF  ******/  
  
  updateTopDef : function (){
    var t = Tabs.Train;
    var slots = parseInt(t.TDinpSlots.value, 10);
    if (isNaN(slots) || slots<0)
      slots = 0;
    t.TDspMax.innerHTML = 'max. '+ t.stats.MaxDefTrain +'&nbsp; <BR>Du Besitz: '+ t.stats.defOwned;   
    t.TDlimiter.innerHTML = t.stats.DefLimiter;
    t.TDspMaxSlots.innerHTML = t.stats.wallLevel-t.stats.Dqueued;
    if (slots<1)
      t.TDspMaxPS.innerHTML = 0;
    else
      t.TDspMaxPS.innerHTML = parseInt(t.stats.MaxDefTrain / slots);

    t.TDspSpace.innerHTML = 'Mauer Level: <B>'+ t.stats.wallLevel +'</b><BR>Verteidigungswall: '+ (t.stats.wallSpaceUsed+t.stats.wallSpaceQueued)  +'/<B>'+ t.stats.wallSpace +'</b><BR>\
        Feldabwehr: '+ (t.stats.fieldSpaceUsed+t.stats.fieldSpaceQueued) +'/<B>'+ t.stats.fieldSpace +'</b>';
  },

  changeDefSelect : function (){
    var t = Tabs.Train;
    var cityId = t.selectedCity.id;
    // unitcost: NAME, Food, Wood, Stone, Ore, Gold, Pop, ?
    var id = t.TDselType.value;
    t.lastDefSelect = id;
    t.stats.defOwned = parseInt(Seed.fortifications['city' + cityId]['fort'+id]);    
    var uc = unsafeWindow.fortcost['frt'+id];
    var max = 9999999999;
    var limiter = 'Unbekannt';
    if ( (t.stats.food / uc[1]) < max) {
      max = t.stats.food / uc[1];
      limiter = 'Nahrung';
    }
    if ( (t.stats.wood / uc[2]) < max) {
      max = t.stats.wood / uc[2];
      limiter = 'Holz';
    }
    if ( (t.stats.stone / uc[3]) < max) {
      max = t.stats.stone / uc[3];
      limiter = 'Stein';
    }
    if ( (t.stats.ore / uc[4]) < max) {
      max = t.stats.ore / uc[4];
      limiter = 'Erz';
    }
    if ( (t.stats.idlePop / uc[6]) < max) {
      max = t.stats.idlePop / uc[6];
      limiter = 'Bevölkerung';
    }
    t.stats.MaxDefTrain = parseInt (max);
    if (t.stats.MaxDefTrain < 0)
      t.stats.MaxDefTrain = 0;
    if (matTypeof(uc[8]) == 'object'){
      for (k in uc[8]){  // check building requirement
        var b = getCityBuilding (cityId, k.substr(1));
        if (b.maxLevel < uc[8][k][1]){
          t.stats.MaxDefTrain = 0;
          t.stats.DefLimiter = 'Gebäude/Upgrade';
          break;
        }
      }
    }
    if (matTypeof(uc[9]) == 'object'){
      for (k in uc[9]){    // check tech requirement
        if (parseInt(Seed.tech['tch'+k.substr(1)]) < uc[9][k][1]){
          t.stats.MaxDefTrain = 0;
          t.stats.DefLimiter = 'Forschung';
          break;
        }
      }
    }

    var spaceEach = parseInt(unsafeWindow.fortstats["unt"+ id][5]);
    if (id<60)
      var spaceAvail = t.stats.wallSpace - t.stats.wallSpaceUsed - t.stats.wallSpaceQueued;
    else
      var spaceAvail = t.stats.fieldSpace - t.stats.fieldSpaceUsed - t.stats.fieldSpaceQueued;
    if ( t.stats.MaxDefTrain * spaceEach > spaceAvail) {
      t.stats.MaxDefTrain = parseInt(spaceAvail / spaceEach);
      if (id<60)
        t.stats.DefLimiter = 'Verteidigungswall';
      else
        t.stats.DefLimiter = 'Feldabwehr';
    }
    t.updateTopDef();
  },
  
  clickDefMaxPS : function (){
    var t = Tabs.Train;
    var slots = parseInt(t.TDinpSlots.value, 10);
    if (slots<1)
      t.TDinpPerSlot.value = 0;
    else
      t.TDinpPerSlot.value = parseInt(t.stats.MaxDefTrain / slots);
  },

  clickDefMaxSlots : function (){
    var t = Tabs.Train;
    t.TDinpSlots.value = t.stats.wallLevel-t.stats.Dqueued;
  },
    
  clickDefDo : function (){
    var t = Tabs.Train;
    var cityId = t.selectedCity.id;
    var unitId = t.TDselType.value;
    var perSlot = parseInt(t.TDinpPerSlot.value, 10);
    var numSlots = parseInt(t.TDinpSlots.value, 10);
    
    t.displayCityStats ();
    if (perSlot<1){
      t.divTrainStatus.innerHTML = '<FONT COLOR=#550000>Die Anzahl der Slots muss mind. 1 betragen...</font>';
      return;
    }
    if (perSlot*numSlots > t.stats.MaxDefTrain){
      t.divTrainStatus.innerHTML = '<FONT COLOR=#550000>Kann nicht so viele Truppen Ausbilden! '+ t.stats.MaxDefTrain +' ist dein max.</font>';
      return;
    }
    if (numSlots<1 || numSlots > t.stats.wallLevel-t.stats.Dqueued){
      t.divTrainStatus.innerHTML = '<FONT COLOR=#550000>Fehlerhafte Slot Anzahl!</font>';
      return;
    }
    t.setBusy(true);
    var que = [];
    for (var i=0; i<numSlots; i++)
      que.push (['T', unitId, parseInt (perSlot)]);
    t.divTrainStatus.innerHTML = '';
    t.doDefQueue (cityId, que);
  },

  doDefQueue : function (cityId, que, errMsg){
    var t = Tabs.Train;
    try {
      t.displayCityStats();
      if (errMsg){
        t.dispTrainStatus ('<font color=#550000><B>ERROR: '+ errMsg +'</b></font><BR>');
        t.setBusy(false);
        return;
      }
      var cmd = que.shift();
      if (!cmd){
        t.dispTrainStatus ('<B>Bau Aufträge wurden in Auftrag gegeben!</b><BR>');
        t.setBusy(false);
        return;
      }
      if (cmd[0] == 'T'){
        t.dispTrainStatus (''+ cmd[2] +' '+  fortNamesShort[cmd[1]] +' werden Gebaut!<BR>');
        doDefTrain ( cityId, cmd[1], cmd[2],
          function(errMsg){
            setTimeout(function (){Tabs.Train.doDefQueue(cityId, que, errMsg);}, (Math.random()*3500)+1500);
          } );
      }
    } catch (err) {
      logit (inspect (err, 8, 1));
      t.dispTrainStatus ('<font color=#550000>PROGRAMM FEHLER: '+ err.message +'</font><BR>');
      t.setBusy(false);
    }
  },
  

  setBusy : function (tf){
    var t = Tabs.Train;
    t.TDbutDo.disabled = tf;
    t.TTbutDo.disabled = tf;
  },

  // fix KofC bugs ....
  // if first start time > now, make it now
  // if any end time != next start time, fix it
  fixQueTimes : function (q){
    var now = unixTime();
    if (q[0][2] > now)
      q[0][2] = now;
    for (var i=0; i<q.length; i++){
      if (q[i+1]!=null && q[i+1][2]!=q[i][3])
        q[i][3] = q[i+1][2];
    }        
  },
  
  displayCityStats : function (){
    var t = Tabs.Train;
    var cityId = t.selectedCity.id;
    t.stats.food = parseInt (Seed.resources['city'+cityId].rec1[0]/3600);
    t.stats.wood = parseInt (Seed.resources['city'+cityId].rec2[0]/3600);
    t.stats.stone = parseInt (Seed.resources['city'+cityId].rec3[0]/3600);
    t.stats.ore = parseInt (Seed.resources['city'+cityId].rec4[0]/3600);
    t.stats.gold = Seed.citystats['city'+cityId].gold[0];
    if (Options.maxIdlePop)
      t.stats.idlePop = parseInt(Seed.citystats['city'+cityId].pop[0]);
    else
      t.stats.idlePop = parseInt(Seed.citystats['city'+cityId].pop[0]) - parseInt(Seed.citystats['city'+cityId].pop[3]);
    t.stats.barracks = getCityBuilding (cityId, 13).count;
    var m = '<CENTER><B>'+ Cities.byID[cityId].name +' &nbsp; ('+ Cities.byID[cityId].x +','+ Cities.byID[cityId].y +')</b></center><HR>';
  
m += '<TABLE class=ptTab width=100%><TR align=center>\
        <TD width=8%><B><u>Versorger</u></b></td><TD width=8%><B><u>Miliz</u></b></td><TD width=8%><B><u>Späher</u></b></td>\
        <TD width=8%><B><u>Lanzen</u></b></td><TD width=8%><B><u>Schwerter</u></b></td><TD width=8%><B><u>Bogen</u></b></td>\
        <TD width=8%><B><u>Kav</u></b></td><TD width=8%><B><u>S-Kav</u></b></td><TD width=8%><B><u>Wagen</u></b></td>\
        <TD width=8%><B><u>Ballis</u></b></td><TD width=8%><B><u>Ram</u></b></td><TD width=8%><B><u>Kat</u></b></td><tr>';
    
 m += '<TR align=center><TD width=8%>'+Seed.units['city'+cityId]['unt1']+'</td><TD width=8%>'+Seed.units['city'+cityId]['unt2']+
 '<TD width=8%>'+Seed.units['city'+cityId]['unt3']+'</td><TD width=8%>'+Seed.units['city'+cityId]['unt4']+
 '<TD width=8%>'+Seed.units['city'+cityId]['unt5']+'</td><TD width=8%>'+Seed.units['city'+cityId]['unt6']+
 '<TD width=8%>'+Seed.units['city'+cityId]['unt7']+'</td><TD width=8%>'+Seed.units['city'+cityId]['unt8']+
 '<TD width=8%>'+Seed.units['city'+cityId]['unt9']+'</td><TD width=8%>'+Seed.units['city'+cityId]['unt10']+
 '<TD width=8%>'+Seed.units['city'+cityId]['unt11']+'</td><TD width=8%>'+Seed.units['city'+cityId]['unt12']+'</td><tr></table>';
  
    m += '<TABLE class=ptTab width=100%><TR align=center>\
        <TD width=18%><B>Nahrung</b></td><TD width=16%><B>Holz</b></td><TD width=16%><B>Stein</b></td>\
        <TD width=16%><B>Erz</b></td><TD width=16%><B>Gold</b></td><TD width=16%><B>Müßige Bevölkerung</b></td></tr>\
      <TR align=center><TD>'+ addCommasInt(t.stats.food) +'</td><TD>'+ addCommasInt(t.stats.wood) +'</td><TD>'+ addCommasInt(t.stats.stone) +'</td>\
        <TD>'+ addCommasInt(t.stats.ore) +'</td><TD>'+ addCommasInt(t.stats.gold) +'</td>\
        <TD>'+ addCommasInt(t.stats.idlePop) +'</td></tr></table><BR>';
    document.getElementById ('divSTtop').innerHTML = m;
    
// troop queue ....
    var totTime = 0;
    var q = Seed.queue_unt['city'+cityId];
    var qs = q.toString();
    var now = unixTime();
    if (q!=null && q.length>0)
      totTime = q[q.length-1][3] - now;
    if ( qs == t.lastQueString){
      if (q!=null && q.length>0){
        var cur = q[0][3] - now;
        if (cur < 1)
          q.shift();
        document.getElementById ('ptttfq').innerHTML = timestr(cur, true);
      }
    } else {
      t.lastQueString = qs;
      t.stats.queued = 0;
      m = '<TABLE align=center class=ptTab>';
      if (q!=null && q.length>0 ){
        t.fixQueTimes (q);
        t.stats.queued = q.length;
        first = true;
        for (var i=0; i<q.length; i++){
          start = q[i][2];
          end = q[i][3];
          if (first)
            actual = end - now;
          else
            actual = end - lastEnd;
          if (actual < 0)
            actual = 0;
          q[i][6] = cityId;
 m += '<TR align=right><TD width="5px"><A><DIV onclick="cancelTrain('+ q[i][0]+','+q[i][1]+','+q[i][2]+','+q[i][3]+','+q[i][5]+','+q[i][6]+','+i +')">X</div></a></td>';
 m += '<TD>'+ q[i][1] +' </td><TD align=left> '+ unsafeWindow.unitcost['unt'+q[i][0]][0]; 
          if (first)
            m += '</td><TD> &nbsp; '+  timestr(end-start, true) +'</td><TD> (<SPAN id=ptttfq>'+ timestr(actual, true) +'</span>)';
          else
            m += '</td><TD> &nbsp; '+  timestr(actual, true) +'</td></tr>';
          lastEnd = end;
          first = false;
        }
      }
      m += '</table>';
      document.getElementById ('divSTleft').innerHTML = m;
    }
    m = t.stats.barracks +' Kasernen';
    if (t.stats.queued > 0)
      m += ', '+ t.stats.queued +' Slots';
    if (totTime > 0)
      m += ', '+ unsafeWindow.timestr(totTime);
    document.getElementById ('statTTtot').innerHTML = m;
    
// defense queue ....
    getWallInfo (cityId, t.stats);    
    var totTime = 0;
    var q = Seed.queue_fort['city'+cityId];
    var qs = q.toString();
    if (q!=null && q.length>0)
      totTime = q[q.length-1][3] - now;
    if ( qs == t.lastDQueString){
      if (q!=null && q.length>0){
        var cur = q[0][3] - now;
        if (cur < 1)
          q.shift();
        document.getElementById ('pttdfq').innerHTML = timestr(cur, true);
      }
    } else {
      t.lastDQueString = qs;
      t.stats.Dqueued = 0;
      t.stats.wallSpaceQueued = 0;
      t.stats.fieldSpaceQueued = 0;
      m = '<TABLE align=center class=ptTab>';
      if (q!=null && q.length > 0 ){
        t.fixQueTimes (q);
        t.stats.Dqueued = q.length;
        first = true;
        for (i=0; i<q.length; i++){
          if (q[i][0] < 60)          
            t.stats.wallSpaceQueued += parseInt(unsafeWindow.fortstats["unt"+ q[i][0]][5]) * parseInt(q[i][1]);
          else          
            t.stats.fieldSpaceQueued += parseInt(unsafeWindow.fortstats["unt"+ q[i][0]][5]) * parseInt(q[i][1]);
          start = q[i][2];
          end = q[i][3];
          if (first)
            actual = end - now;
          else
            actual = end - lastEnd;
          if (actual < 0)
            actual = 0;
           q[i][7]=cityId;
 m += '<TR align=right><TD width="5px"><A><DIV onclick="cancelFort('+ q[i][0]+','+q[i][1]+','+q[i][2]+','+q[i][3]+','+q[i][5]+','+q[i][6]+','+q[i][7] +','+ i +')">X</div></a></td>'
 m += '<TD>'+ q[i][1] +' </td><TD align=left> '+ fortNamesShort[q[i][0]]; 
          if (first)
            m += '</td><TD> &nbsp; '+  timestr(end-start, true) +'</td><TD> (<SPAN id=pttdfq>'+ timestr(actual, true) +'</span>)';
          else
            m += '</td><TD> &nbsp; '+  timestr(actual, true) +'</td></tr>';
          lastEnd = end;
          first = false;
        }
      }
      m += '</table>';
      document.getElementById ('divSTright').innerHTML = m;
    }
    m = t.stats.Dqueued +' Slots';
    if (totTime > 0)
      m += ', '+ unsafeWindow.timestr(totTime);
    document.getElementById ('statDTtot').innerHTML = m;
  },

  dispTrainStatus : function (msg){
    var t = Tabs.Train;
    t.divTrainStatus.innerHTML = msg + t.divTrainStatus.innerHTML;
  },
 butcancelTrain : function (typetrn, numtrptrn, trnTmp, trnETA, trnNeeded, cityId, trainingId){
 var t = Tabs.Train;
 var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);

 params.pf =0;
 params.requestType = "CANCEL_TRAINING";
 params.cityId = cityId;
 params.typetrn = typetrn;
 params.numtrptrn = numtrptrn;
 params.trnETA = trnETA;
 params.trnTmp = trnTmp;
 params.trnNeeded = trnNeeded;

 new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/cancelTraining.php" + unsafeWindow.g_ajaxsuffix, {
 method: "post",
 parameters: params,
 onSuccess: function (message) {
 var rslt=eval("("+message.responseText+")");
 if (rslt.ok) {
 var k=0;
 for(var j=0;j<Seed.queue_unt["city"+cityId].length;j++){
 if(j>trainingId){
 Seed.queue_unt["city"+cityId][j][2]=parseInt(rslt.dateTraining[k]["start"]);
 Seed.queue_unt["city"+cityId][j][3]=parseInt(rslt.dateTraining[k]["end"]);
 k++;
 }
 }

 Seed.queue_unt["city"+cityId].splice(trainingId,1);
 for(var i=1;i<5;i++){
 var totalReturn=parseInt(unsafeWindow.unitcost["unt"+typetrn][i])*parseInt(numtrptrn)*3600/2;
 Seed.resources["city"+cityId]["rec"+i][0]=parseInt(Seed.resources["city"+cityId]["rec"+i][0])+totalReturn;
 }
 }
 },
 onFailure: function () {
 },
 });
 },


 butcancelFort : function (typefrt, numtrpfrt, frtTmp, frtETA, frtNeeded, frtid, cityId, queueId){
 var t = Tabs.Train;
 var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);

 params.pf =0;
 params.requestType = "CANCEL_FORTIFICATIONS";
 params.cityId = cityId;
 params.typefrt = typefrt;
 params.numtrpfrt = numtrpfrt;
 params.frtETA = frtETA;
 params.frtTmp = frtTmp;
 params.frtNeeded = frtNeeded;
 params.frtid = frtid;

 new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/cancelFortifications.php" + unsafeWindow.g_ajaxsuffix, {
 method: "post",
 parameters: params,
 onSuccess: function (message) {
 var rslt=eval("("+message.responseText+")");
 if (rslt.ok) {
 var k=0;
 for(var j=0;j<Seed.queue_fort["city"+cityId].length;j++){
 if(j>queueId){
 Seed.queue_fort["city"+cityId][j][2]=parseInt(rslt.dateFortifications[k]["start"]);
 Seed.queue_fort["city"+cityId][j][3]=parseInt(rslt.dateFortifications[k]["end"]);
 k++;
 }
 }
 unsafeWindow.update_seed(rslt.updateSeed);
 Seed.queue_fort["city"+cityId].splice(queueId,1);
 for(var i=1;i<5;i++){
 Seed.resources["city"+cityId]["rec"+i][0]=parseInt(Seed.resources["city"+cityId]["rec"+i][0])+totalReturn;
 }
 }
 },
 onFailure: function () {
 },
 });
 },
 
  doQueue : function (cityId, que, errMsg){
    var t = Tabs.Train;
    try {
      t.displayCityStats();
      if (errMsg){
        t.dispTrainStatus ('<font color=#550000><B>ERROR: '+ errMsg +'</b></font><BR>');
        t.setBusy(false);
        return;
      }
      var cmd = que.shift();
      if (!cmd){
        t.dispTrainStatus ('<B>Truppen erfolgreich Rekrutiert!</b><BR>');
        t.setBusy(false);
        return;
      }
      if (cmd[0] == 'T'){
        t.dispTrainStatus (''+ cmd[2] +' '+  unsafeWindow.unitcost['unt'+cmd[1]][0] +' werden Ausgebildet!<BR>');
        doTrain (cityId, cmd[1], cmd[2],
          function(errMsg){
           setTimeout(function (){Tabs.Train.doQueue(cityId, que, errMsg);}, (Math.random()*3500)+1500 );
          }
        );
      }
    } catch (err) {
      logit (inspect (err, 8, 1));
      t.dispTrainStatus ('<font color=#550000>PROGRAM ERROR: '+ err.message +'</font><BR>');
      t.setBusy(false);
    }
  },
}
/********************************* Messages Tab *************************************/
Tabs.msg = {
  tabOrder : toNachrichten,
  tabLabel : 'MSG',
  maxPages:9999,
  totalPages:0,
  content:"",

  init : function (div){
    var t = Tabs.msg;
    t.cont=div;
    uW.getmsg = t.getEmailBody;
	uW.getReport = t.getReportBody;
	    
    var m = '<DIV class=ptstat>NACHRICHTEN UND ALLIANZ BERICHTE</div>';
    m += '<DIV class=ptentry style="height:30px"><table>';
    m += '<TABLE width=95% class=ptTab><TD>Suchen in: <select id="searchSelect"><option value="Reports">Berichte</option>';
    m += '<option value="inbox">Eingang</option>';
    m += '<option value="outbox">Ausgang</option></select></td>';
        
    m += '<TD>nach: <select disabled=true id="searchForSelect"><option value="Subject">Betreff</option>';
    m += '<option value="User">Spieler</option></select></td>';
    
    m += '<TD>Seiten: <select id="pagesSelect">';
    m += '<option value=1> 1 </option>'
    m += '<option value=5> 5 </option>'
    m += '<option value=10> 10 </option>'
    m += '<option value=20> 20 </option>'
    m += '<option value=30> 30 </option>'
    m += '<option value=40> 40 </option>'
    m += '<option value=50> 50 </option>'
    m += '<option value=60> 60 </option>'
    m += '<option value=70> 70 </option>'
    m += '<option value=80> 80 </option>'
    m += '<option value=90> 90 </option>'
    m += '<option value=100> 100 </option>'
    m += '<option value=101> Alle </option></select></td>'

    m += '<TD>Suchbegriff: <INPUT id=searchString disabled=true type=text size=10 maxlength=25 value=""</td>';
    m += '<TD><INPUT id=StartSearch type=submit value="Suchen"></td>';
    m += '<TD><DIV id="searchStatus"></div></td></table>';
    m += '<BR><DIV id="ReportResults" style="height:470px; max-height:470px; width=100%;"></div>';
    
    t.cont.innerHTML = m;
        
    document.getElementById('StartSearch').addEventListener ('click', function(){ 
        	 if (document.getElementById('searchSelect').value == "Reports") {
        	 		t.totalPages = 0;
        	 		t.content = '<center><table><thead><th>Öffnen</th><th>Seite</th><th>Datum</th><th>Angreifer</th><th>von</th><th>Allianz</th><th>Aktion</th><th>Ziel</th><th>Typ</th><th>At</th></thead><tbody>';
        	 		t.searchReports("",1); 
        	 }
        	 else {
        	 	t.totalPages = 0;
        	 	t.content = '<center><table><thead><th>Öffnen</th><th>Seite</th><th>Datum</th><th>von</th><th>Betreff</th></thead><tbody>';
        	 	t.searchMail("",1); 
        	 }
        }, false);
    document.getElementById('searchSelect').addEventListener ('change', function(){ 
        	if (document.getElementById('searchSelect').value == "Reports")  {
              document.getElementById('searchString').disabled=true;
              document.getElementById('searchForSelect').disabled=true;
          }
        	else {
              document.getElementById('searchString').disabled=false;
              document.getElementById('searchForSelect').disabled=false;
          }
        }, false);
        
    return this.cont;
  },

 
  searchReports : function(rslt, pageNum) {
    var t = Tabs.msg;
    t.maxPages=document.getElementById("pagesSelect").value;
    
    if (t.totalPages==0){
  		    var params = uW.Object.clone(uW.g_ajaxparams);
  		      params.pf=0;
  		      params.group="a";
  		      params.pageNo = 1;
  		         
  		      new MyAjaxRequest(uW.g_ajaxpath + "ajax/listReports.php" + uW.g_ajaxsuffix, {
  		      method: "post",
  		      parameters: params,
  		      onSuccess: function (rslt) {
  		          if (rslt.ok)
  		          t.totalPages = parseInt(rslt['totalPages']);
  		      },
  		      onFailure: function () {
  		      },
  		    }, false);
    }
    
    if ( t.maxPages==101 && t.totalPages > 0)
       t.maxPages=t.totalPages;
       
       
    if (parseInt(pageNum) <= t.maxPages) {
          document.getElementById('searchStatus').innerHTML = pageNum;
          t.getReports(pageNum);
       }
       else {
          document.getElementById('searchStatus').innerHTML = "FERTIG";
       } 
  },
  
  getReports : function (pageNum){
    var t = Tabs.msg;
    var params = uW.Object.clone(uW.g_ajaxparams);
      params.pf=0;
      params.group="a";
      params.pageNo = pageNum;
         
    new MyAjaxRequest(uW.g_ajaxpath + "ajax/listReports.php" + uW.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
          if (rslt.ok)
          t.searchInReports(rslt, pageNum);     
      },
      onFailure: function () {
      },
    }, false);
  },
  
  
  searchInReports: function(rslt,pageNum){
  	   var t = Tabs.msg;  
  	   var myarray = rslt['arReports'];
  	   var results=document.getElementById("ReportResults");
  	   
  	   for (k in myarray) {
  	   	if (getMyAlliance()[0] != myarray[k]['side1AllianceId'] || myarray[k]['marchType'] == 2) {
	  	        t.content += '<TR><TD><A><SPAN onclick="getReport('+ myarray[k]['reportId']+','+myarray[k]['side0TileType']	 +')">Öffnen</span></a></td>';
	  	    	t.content +='<TD>'+ pageNum +'</td>';
	  	    	t.content +='<TD>'+ uW.formatDateByUnixTime(myarray[k]['reportUnixTime']) +'</td>';
	  	    	t.content +='<TD>';
	  	    	if ( rslt['arPlayerNames']['g'+myarray[k]['side1PlayerId']] == "M") t.content +='Lord ';
	  	    	if ( rslt['arPlayerNames']['g'+myarray[k]['side1PlayerId']] == "F") t.content +='Lady ';
	  	    	t.content += rslt['arPlayerNames']['p'+myarray[k]['side1PlayerId']]+'</td>'
	  	    	t.content +='<TD>'+ coordLink(myarray[k]['side1XCoord'],myarray[k]['side1YCoord']) +'</td>';
	  	   		t.content +='<TD>'+ rslt['arAllianceNames']['a'+myarray[k]['side1AllianceId']] +'</td>';
	  	   		if (myarray[k]['marchType'] == 2) t.content +='<TD><FONT color="00CC33">Reinf</font></td>';
	  	   		if (myarray[k]['marchType'] == 3) t.content +='<TD><FONT color="FF9933">Scout</font></td>';
	  	   		if (myarray[k]['marchType'] == 4) t.content +='<TD><FONT color="FF0033">Attack</font></td>';
				t.content +='<TD>';
				if ( rslt['arPlayerNames']['g'+myarray[k]['side0PlayerId']] == "M") t.content +='Lord ';
				if ( rslt['arPlayerNames']['g'+myarray[k]['side0PlayerId']] == "F") t.content +='Lady ';
				t.content += rslt['arPlayerNames']['p'+myarray[k]['side0PlayerId']]+'</td>'
				
				if ( myarray[k]['side0TileType'] == 51 ) t.content += '<TD>City (' + myarray[k]['side0TileLevel'] + ')</td>';
				else t.content += '<TD><FONT color="#909090"> Wildniss (' + myarray[k]['side0TileLevel'] + ')</font></td>';
	  	    	t.content +='<TD>'+ coordLink(myarray[k]['side0XCoord'],myarray[k]['side0YCoord']) +'</td>';
  	   	  }	
       }
       results.innerHTML = t.content;
       pageNum++;
       t.searchReports(rslt, pageNum); 
  },
  
  
  searchMail : function(rslt, pageNum) {
    var t = Tabs.msg;
    t.maxPages=document.getElementById("pagesSelect").value;
    
    if (t.totalPages==0){
		    var params = uW.Object.clone(uW.g_ajaxparams);
		      params.pf=0;
		      params.requestType="GET_MESSAGE_HEADERS_FOR_USER_INBOX";
		      params.boxType = document.getElementById('searchSelect').value;
		      params.pageNo = 1;
		         
		      new MyAjaxRequest(uW.g_ajaxpath + "ajax/getEmail.php" + uW.g_ajaxsuffix, {
		      method: "post",
		      parameters: params,
		      onSuccess: function (rslt) {
		          if (rslt.ok)
		          t.totalPages = parseInt(rslt['noOfPages']);
		      },
		      onFailure: function () {
		      },
		    }, false);
    }
    
    if ( t.maxPages==101 && t.totalPages > 0)
       t.maxPages=t.totalPages;
       
    if (parseInt(pageNum) <= t.maxPages) {
          document.getElementById('searchStatus').innerHTML = pageNum;
          t.getMail(pageNum);
       }
       else {
          document.getElementById('searchStatus').innerHTML = "DONE";
       } 
  },
  
  getMail : function (pageNum){
    var t = Tabs.msg;
    var params = uW.Object.clone(uW.g_ajaxparams);
      params.pf=0;
      params.requestType="GET_MESSAGE_HEADERS_FOR_USER_INBOX";
      params.boxType = document.getElementById('searchSelect').value;
      params.pageNo = pageNum;
         
    new MyAjaxRequest(uW.g_ajaxpath + "ajax/getEmail.php" + uW.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
          if (rslt.ok)
          t.searchInMail(rslt, pageNum);     
      },
      onFailure: function () {
      },
    }, false);
  },
  
  getReportBody : function(ID,TileId){
    var t = Tabs.msg;
    var params = uW.Object.clone(uW.g_ajaxparams);
    params.pf=0;
    params.rid=ID;
    params.side=0;
     
    new MyAjaxRequest(uW.g_ajaxpath + "ajax/fetchReport.php" + uW.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
          	t.showReportBody(rslt,TileId);
      },
      onFailure: function () {
      },
    }, false);
  },
  
  showReportBody: function (rslt,TileId) {
  	var t = Tabs.msg;
  	var popReport = null;
  	t.popReport = new CPopup('pbShowBarbs', 0, 0, 500, 300, true, function() {clearTimeout (1000);});
  	t.popReport.centerMe (mainPop.getMainDiv());  
  	var m = '<DIV style="max-height:275px; height:275px; overflow-y:scroll">'; 
  	
  	m+='<TABLE class=ptTab>';
  	if (TileId < 51) m+='<TD><FONT size="3px">Wild Lvl.'+ rslt['tileLevel'] +'</font></td>';
  	if (rslt['conquered']==1) m+='<TD><FONT color="#CC0000" size="3px">Erobert</font></td></tr>';
  	if (rslt['winner']==1) m+='<TR><TD><FONT color="#CC0000" size="3px">Niederschlagen</font></td></tr><TR><TD></TD></TR><TR><TD></TD></TR><TR><TD></TD></TR></table>';
  	if (rslt['winner']==0) m+='<TR><TD><FONT color="#66CC33" size="3px">Sieg</font></td></tr><TR><TD></TD></TR><TR><TD></TD></TR><TR><TD></TD></TR></table>';
  	
		
	
	if (rslt['fght'] != undefined){
			m+='<TABLE style="float:left;width:45%;" class=ptTab><TR><TD align="center">Truppen</td><TD align="center">gekämpft</td><TD align="center">Survived</td></tr>'; 
			if (rslt['fght']["s1"] != undefined) {
					for (var i=1;i<=12;i++) {
						if (rslt['fght']["s1"]['u'+i] != undefined) {
							if (rslt['fght']["s1"]['u'+i][0] > rslt['fght']["s1"]['u'+i][1]) m+='<TR><TD align="center"><img src=http://koc.god-like.info/img/unit_'+i+'_30.png></td><TD align="center">'+rslt['fght']["s1"]['u'+i][0]+'</td><TD align="center"><FONT color="#CC0000">'+rslt['fght']["s1"]['u'+i][1]+'</font></td></tr>';
							else m+='<TR><TD align="center"><img src=http://koc.god-like.info/img/unit_'+i+'_30.png></td><TD align="center">'+rslt['fght']["s1"]['u'+i][0]+'</td><TD align="center">'+rslt['fght']["s1"]['u'+i][1]+'</td></tr>';
						}
					}
			}
				  	
		  	if (rslt['fght']["s0"] != undefined) {
 				  	m+='</table><TABLE style="float:right;width:45%;" class=ptTab><TR><TD align="center">Truppen</td><TD align="center">gekämpft</td><TD align="center">Survived</td></tr>';
				  	for (var i=1;i<=12;i++) {
				  		if (rslt['fght']["s0"]['u'+i] != undefined) {
				  			if (rslt['fght']["s0"]['u'+i][0] > rslt['fght']["s0"]['u'+i][1]) m+='<TR><TD align="center"><img src=http://koc.god-like.info/img/unit_'+i+'_30.png></td><TD align="center">'+rslt['fght']["s0"]['u'+i][0]+'</td><TD align="center"><FONT color="#CC0000">'+rslt['fght']["s0"]['u'+i][1]+'</font></td></tr>';
				  			else m+='<TR><TD align="center"><img src=http://koc.god-like.info/img/unit_'+i+'_30.png></td><TD align="center">'+rslt['fght']["s0"]['u'+i][0]+'</td><TD align="center">'+rslt['fght']["s0"]['u'+i][1]+'</td></tr>';
				  		}
				  	}
				  	
				  	for (var i=53;i<=55;i++) {
				  		if (rslt['fght']["s0"]['f'+i] != undefined) {
				  			if (rslt['fght']["s0"]['f'+i][0] > rslt['fght']["s0"]['f'+i][1]) m+='<TR><TD align="center"><img src=http://koc.god-like.info/img/unit_'+i+'_30.jpg></td><TD align="center">'+rslt['fght']["s0"]['f'+i][0]+'</td><TD align="center"><FONT color="#CC0000">'+rslt['fght']["s0"]['f'+i][1]+'</font></td></tr>';
				  			else m+='<TR><TD align="center"><img src=http://koc.god-like.info/img/unit_'+i+'_30.jpg></td><TD align="center">'+rslt['fght']["s0"]['f'+i][0]+'</td><TD align="center">'+rslt['fght']["s0"]['f'+i][1]+'</td></tr>';
				  		}
				  	}
				  	for (var i=60;i<=63;i++) {
				  		if (rslt['fght']["s0"]['f'+i] != undefined) {
				  			if (rslt['fght']["s0"]['f'+i][0] > rslt['fght']["s0"]['f'+i][1]) m+='<TR><TD align="center"><img src=http://koc.god-like.info/img/unit_'+i+'_30.jpg></td><TD align="center">'+rslt['fght']["s0"]['f'+i][0]+'</td><TD align="center"><FONT color="#CC0000">'+rslt['fght']["s0"]['f'+i][1]+'</font></td></tr>';
				  			else m+='<TR><TD align="center"><img src=http://koc.god-like.info/img/unit_'+i+'_30.jpg></td><TD align="center">'+rslt['fght']["s0"]['f'+i][0]+'</td><TD align="center">'+rslt['fght']["s0"]['f'+i][1]+'</td></tr>';
				  		}
				  	}
		  	}
		  	m+='<TR><TD></TD></TR></table>';
	}
  	
  	if (rslt['unts']!= undefined) {
  		  	m+='<TABLE class=ptTab><TR><TD align="center">Truppen</td><TD align="center">Verstärkt</td></tr>';
  		  	for (var i=1;i<=12;i++) {
  		  		if (rslt['unts']['u'+i] != undefined) m+='<TR><TD align="center"><img src=http://koc.god-like.info/img/unit_'+i+'_30.png></td><TD align="center">'+rslt['unts']['u'+i]+'</td></tr>';
  		  	}
  	}
  	m+='<TR><TD></TD></TR><TR><TD></TD></TR></table>';
  	
  	if (rslt['loot'] != undefined) {
		  	m+='<TABLE class=ptTab><TR><TD><img src=http://koc.god-like.info/img/gold_30.png></td><TD>'+addCommas(rslt['loot'][0])+'</td>';
		  	m+='<TD><img src=http://koc.god-like.info/img/food_30.png></td><TD>'+addCommas(rslt['loot'][1])+'</td>';
		  	m+='<TD><img src=http://koc.god-like.info/img/wood_30.png></td><TD>'+addCommas(rslt['loot'][2])+'</td>';
		  	m+='<TD><img src=http://koc.god-like.info/img/stone_30.png></td><TD>'+addCommas(rslt['loot'][3])+'</td>';
		  	m+='<TD><img src=http://koc.god-like.info/img/iron_30.png></td><TD>'+addCommas(rslt['loot'][4])+'</td></table>';
	}	
	
	
	if (rslt['rsc'] != undefined) {
		  	m+='<TABLE class=ptTab><TR><TD><img src=http://koc.god-like.info/img/food_30.png></td><TD>'+addCommas(rslt['rsc']['r1'])+'</td>';
		  	m+='<TD><img src=http://koc.god-like.info/img/wood_30.png></td><TD>'+addCommas(rslt['rsc']['r2'])+'</td>';
		  	m+='<TD><img src=http://koc.god-like.info/img/stone_30.png></td><TD>'+addCommas(rslt['rsc']['r3'])+'</td>';
		  	m+='<TD><img src=http://koc.god-like.info/img/iron_30.png></td><TD>'+addCommas(rslt['rsc']['r4'])+'</td></table>';
	}	
	
	m+='</div>';
  	t.popReport.getMainDiv().innerHTML = m;
  	t.popReport.getTopDiv().innerHTML = '<TD><CENTER><B>ANGRIFFS BERICHT</center></td>';
  	t.popReport.show(true)	;
   },
   
  
  getEmailBody : function(ID){
    var t = Tabs.msg;
    var params = uW.Object.clone(uW.g_ajaxparams);
      params.messageId=ID;
      params.requestType="GET_MESSAGE_FOR_ID";
     
    new MyAjaxRequest(uW.g_ajaxpath + "ajax/getEmail.php" + uW.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
          if (rslt.ok)
          t.showEmailBody(rslt['messageBody'])
      },
      onFailure: function () {
      },
    }, false);
  },
  
  showEmailBody: function (messageBody) {
  	var t = Tabs.msg;
  	var popMsg = null;
  	t.popMsg = new CPopup('pbShowBarbs', 0, 0, 550, 300, true, function() {clearTimeout (1000);});
  	t.popMsg.centerMe (mainPop.getMainDiv());  
  	var m = '<DIV style="max-height:265px; height:265px; overflow-y:scroll">';  
  	m+= messageBody + '</div>';
  	t.popMsg.getMainDiv().innerHTML = m;
  	t.popMsg.getTopDiv().innerHTML = '<TD><CENTER><B>NACHRICHTEN</center></td>';
  	t.popMsg.show(true)	;
   },
   
  
  searchInMail: function(rslt,pageNum){
	   var t = Tabs.msg;  
	   var myarray = rslt['message'];
	   var results=document.getElementById("ReportResults");
	   
	   for (k in myarray) {
	      if (document.getElementById('searchForSelect').value == "Subject") var lookup = myarray[k]['subject'];
	      else var lookup = myarray[k]['displayName'];
	      var what = document.getElementById('searchString').value;
	      if (lookup.search(what, "i") != -1){
	        t.content += '<TR><TD><A><SPAN onclick="getmsg('+ myarray[k]['messageId'] +')">OPEN</span></a></td>'
  	    	t.content +='<TD>'+ rslt['pageNo'] +'</td>';
  	    	t.content +='<TD>'+myarray[k]['dateSent']+'</td>';
  	    	t.content +='<TD>'+myarray[k]['displayName']+'</td>';
  	    	t.content +='<TD>'+myarray[k]['subject']+'</td>';
	   	  }	
       }
       results.innerHTML = t.content;
       pageNum++;
       t.searchMail(rslt, pageNum); 
  },
  
  show : function (){
  },

  hide : function (){
  },
};


/*************************************** OVERVIEW TAB ************************************************/
var GMTclock = {
  span : null,
  timer : null,
  
  init : function (){
    this.span = document.createElement ('span');
    this.span.style.fontWeight = 'bold';
    document.getElementById('kochead_time').parentNode.appendChild (this.span);
    this.setEnable (Options.gmtClock);
  },

  setEnable : function (tf){
    var t = GMTclock;
    clearInterval (t.timer);
    if (tf){
      t.timer = setInterval (t.everySecond, 900);
    } else {
      t.span.innerHTML = '';
    }
  },
    
  everySecond : function (){
    var now = new Date();  
    now.setTime(now.getTime() + (now.getTimezoneOffset()*60000));
    GMTclock.span.innerHTML = ' | '+ now.toLocaleFormat('%H:%M:%S') +'';
  },
}


function getResourceProduction (cityId){
  var ret = [0,0,0,0,0];
  var now = unixTime ();
  var search='type==10 || type==11';
  var wilds = [0, 0, 0, 0, 0];
  var w = Seed.wilderness["city" + cityId];
  for (var k in w){
    var type = parseInt(w[k].tileType);

    if (type==10 || type==11)
	      wilds[1] += parseInt(w[k].tileLevel);
	    else 
	      wilds[type/10] += parseInt(w[k].tileLevel);
  }  
  knight = 0;       
  var s = Seed.knights["city" + cityId];
  if (s) {
    s = s["knt" + Seed.leaders["city" + cityId].resourcefulnessKnightId];
    if (s){
      var knight = parseInt(s.resourcefulness);
      if (s.resourcefulnessBoostExpireUnixtime > now)
        knight *= 1.25;
    }
  }
  var workerFactor = 1;
  var c = parseInt(Seed.citystats["city" + cityId]["pop"][0]);  // Current  population
  var w = parseInt(Seed.citystats["city" + cityId]["pop"][3]);  // Labor force
  if (w > c)
    workerFactor = c / w;
  
  for (var i=1; i<5; i++){
    var usage = Seed.resources["city" + cityId]["rec" + i];
    var items = 0;
    if (parseInt(Seed.playerEffects["r" + i + "BstExp"]) > now) {
      items = 0.25;
    }
    var tech = Seed.tech["tch" + i];
    ret[i] = parseInt((usage[2] * (1 + tech/10 + knight/100 + items + 0.05 * wilds[i]) * workerFactor + 100));
  }
  return ret;  
}

function getWallInfo (cityId, objOut){
  objOut.wallSpaceUsed = 0;
  objOut.fieldSpaceUsed = 0;
  objOut.wallLevel = 0;  
  objOut.wallSpace = 0;     
  objOut.fieldSpace = 0;  
  var b = Seed.buildings["city" + cityId];
  if (b.pos1==null)
    return;  
  objOut.wallLevel = parseInt(b.pos1[1]);
  var spots = 0;
  for (var i=1; i<(objOut.wallLevel+1); i++)
    spots += (i * 500);
  objOut.wallSpace = spots;     
  objOut.fieldSpace = spots;  
     
  var fort = Seed.fortifications["city" + cityId];
  for (k in fort){
    var id = parseInt(k.substr(4));
    if (id<60)
      objOut.wallSpaceUsed += parseInt(uW.fortstats["unt"+ id][5]) * parseInt(fort[k]);
    else
      objOut.fieldSpaceUsed += parseInt(uW.fortstats["unt"+ id][5]) * parseInt(fort[k]);
  }
}    


Tabs.OverView = {
  tabLabel : 'Stats',
  tabOrder : toStats,
  cont:null,
  displayTimer:null,
  curTabBut : null,
  curTabName : null,
  	
  init : function (div){
    var t = Tabs.OverView;
    dt = new Date ();
    dt.setTime (Seed.player.datejoinUnixTime * 1000);
    t.cont = div;
    
    var main = '<DIV class=ptstat style="margin-top:5px; margin-bottom:5px;"><TABLE cellspacing=0 cellpadding=0 class=ptTab width=97% align=center>';
    main +='<TR align=left><TD><SPAN class=ptstatLight>Spielt seit:</span> '+ dt.toLocaleDateString() +'</td>';
    main +='<TD><SPAN class=ptstatLight>Macht:</span> ' + addCommas(Seed.player.might) +'</td>';
    main +='<TD><SPAN class=ptstatLight>Allianz:</span> ' + getMyAlliance()[1] +'</td>';
    main +='<TD align=right><SPAN class=ptstatLight>Domain:</span> ' + uW.domainName +'</td></tr></table></div>';      
    main +='<TABLE class=ptTab align=left><TR>';
    main +='<TD width=125px><SELECT id="ShowExtra"><option value="maximum">'+uW.g_js_strings.commonstr.maximum+'</options>';
    main +='<option value="normal">'+uW.g_js_strings.commonstr.normal+'</options></select></td>';
    main +='<TD><INPUT class=pbSubtab ID=ptmrchSubA type=submit value=Stats></td>';
    main +='<TD><INPUT class=pbSubtab ID=ptmrchSubB type=submit value='+uW.g_js_strings.commonstr.troops+'></td>';
    main +='<TD><INPUT class=pbSubtab ID=ptmrchSubC type=submit value='+uW.g_js_strings.modaltitles.buildings+'></td>';
    main +='<TD><INPUT class=pbSubtab ID=ptmrchSubD type=submit value='+uW.g_js_strings.commonstr.info+'></td>';
	main +='<TD><INPUT class=pbSubtab ID=ptmrchSubE type=submit value=Extras></td></tr></table><BR><BR>';
    main +='<DIV id=ptOverOutput align=left style="margin-top:10px; background-color:"#F8F8F8"; height:680px; overflow:scroll;"></div>';
            
    t.cont.innerHTML = main;
    t.Overv = document.getElementById('ptOverOutput');
    
    document.getElementById('ShowExtra').value = Options.OverViewShowExtra; 
    document.getElementById('ptmrchSubA').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubB').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubC').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubD').addEventListener('click', e_butSubtab, false);
	document.getElementById('ptmrchSubE').addEventListener('click', e_butSubtab, false);
    document.getElementById('ShowExtra').addEventListener('change', function(){
           Options.OverViewShowExtra = document.getElementById('ShowExtra').value;
           saveOptions();
           clearTimeout (t.displayTimer);
           t.init(div); 
    }, false);
    changeSubtab (document.getElementById('ptmrchSubA'));
    
    function e_butSubtab (evt){            
      changeSubtab (evt.target);   
    }

    function changeSubtab (but){
      if (but == t.curTabBut)
        return;
      if (t.curTabBut){
        t.curTabBut.className='pbSubtab'; 
        t.curTabBut.disabled=false;
      }
      t.curTabBut = but;
      but.className='pbSubtab pbSubtabSel'; 
      but.disabled=true;
      t.curTabName = but.id.substr(9);
      Options.curMarchTab = t.curTabName;
      t.show ();
    }    
  },

  hide : function (){
    var t = Tabs.OverView;
    clearTimeout (t.displayTimer);
  },
  
  show : function (){
    var t = Tabs.OverView;
    clearTimeout (t.displayTimer);
    if (t.curTabName == 'A') 
    	if (Options.OverViewShowExtra == "maximum") t.showResources(); 
    		else t.paintOld();
    else if (t.curTabName == 'B')
      t.showTroops();
    else if (t.curTabName == 'C')
      t.showBuilds();
    else if (t.curTabName == 'D')
      t.showInfo();
	else if (t.curTabName == 'E')
      t.showExtras();
  },
  
      showResources : function (){
        var t = Tabs.OverView;
        t.Overv.innerHTML = null;
        t.Overv.style.maxHeight = '700px';
        t.Overv.style.overflowY = 'scroll';
        clearTimeout (t.displayTimer);	
         var z = "<DIV class=ptstat>DETAILIERTE HEILIGTUM STATS</div><DIV id=overMain><TABLE class=ptTabOverview cellpadding=0 cellspacing=0><TR valign=top align=right><TD style='background: #FFFFFF; border:none;'></td>";
              for(i=0; i<Cities.numCities; i++) {
                z += "<TD width=81 style='background: #FFFFFF'><B>"+ Cities.cities[i].name.substring(0,11) +'</b><BR>'+ coordLink (Cities.cities[i].x, Cities.cities[i].y) +"<BR>"+ uW.provincenames['p'+ Cities.cities[i].provId];
                cityID = 'city'+Cities.cities[i].id;
                Gate = parseInt(Seed.citystats[cityID].gate);
                if(Gate == 0)
                  z+= '<BR>Versteckt</td>';
                else
                  z+= '<BR><SPAN class=boldRed>Verteidigen</span></td>';
              }
        	  for (a=1;a<=4;a++){
        	  		var total = 0;
        	  		z+='<TR><TD colspan="8" style="background: #FFFFFF"><B>'+uW.resourceinfo['rec'+a]+': </b></td></tr><TR>';
        	  		for(b=0; b<Cities.numCities; b++) total += parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][0]/3600);
        	  		z+='<TD>'+ addCommas(total) +'</td>';
        	  		for(b=0; b<Cities.numCities; b++) z+='<TD align=right ">'+ addCommas( parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][0]/3600)) +'</font></td>';
        	  		z+='</tr><TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.showResourceTooltip.caplimit+':</font></td>';
        	  		for(b=0; b<Cities.numCities; b++) {
        	  			    z+='<TD align=right style="background: #FFFFFF">';
        	  				if (parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][1]/3600) > parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][0]/3600)) z+='<FONT COLOR= "669900">';
        	  				else z+='<FONT COLOR="686868">';
        	  				z+= addCommas( parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][1]/3600));
        	  				z+='</font></td>';
        	  		}
        	  		z+='</tr><TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.showResourceTooltip.hrprod+':</font></td>';
        	  		for(b=0; b<Cities.numCities; b++) {
        	  				var rp = getResourceProduction (Seed.cities[b][0]);
        	  				var usage = parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][3]);
        	  				z+='<TD align=right style="background: #FFFFFF"><FONT COLOR="686868">'+ addCommas(rp[a] - usage)  +'</font></td>';
        	  		}
        	  		z+='</tr>';
        	  		if (a==1){
        	  			z+='<TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.commonstr.upkeep+':</font></td>';
        	  			for(b=0; b<Cities.numCities; b++){
        	  				 var rp = getResourceProduction (Seed.cities[b][0]);
        	  				 var usage = parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][3]);
        	  				 var prod = rp[a] - usage;
        	  				 var timeLeft = parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][0]) / 3600 / (0-prod) * 3600;
        				 	 if (prod > 0) z+='<TD align=right style="background: #FFFFFF"><FONT COLOR="686868">----</font></td>';
        	  				 else {
        		  				 if (Options.enableFoodWarn && timeLeft<(Options.foodWarnHours*3600)) z+='<TD align=right style="background: #FFFFFF"><FONT COLOR=RED>';
        		  				 else  z+='<TD align=right style="background: #FFFFFF"> <FONT COLOR="686868">';
        		  				 z+= timestrShort(timeLeft) +'</font></td>';
        		  				 
        	  				}
        	  		   }
        	  	  }
        	  	  var totalmarching = 0;
        	  	  for(b=0; b<Cities.numCities; b++) {
        	  	  	   var march = Seed.queue_atkp['city' + Seed.cities[b][0]];
        	  	  	   if (march != []) for (c in march) 
        	  	  	   		if (march[c]['resource'+a] != undefined && march[c]['marchType'] != 9) totalmarching += parseInt(march[c]['resource'+a]);
        	  	  } 
        	  	  if (totalmarching > 0){
		        	  	  z+='</tr><TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.commonstr.marching+':</font></td>';
		        	  	  for(b=0; b<Cities.numCities; b++) {
		        	  	  	   var recmarching = 0;
		        	  	  	   var march = Seed.queue_atkp['city' + Seed.cities[b][0]];
		        	  	  	   if (march != []) for (c in march) 
		        	  	  	   		if (march[c]['resource'+a] != undefined && march[c]['marchType'] != 9) recmarching += (parseInt(march[c]['resource'+a]));
		        	  	       if (recmarching !=0)	z+= '<TD align=right style="background: #FFFFFF"><FONT COLOR="686868">'+addCommas(recmarching)+'</font></td>';
		        	  	       else z+= '<TD align=right style="background: #FFFFFF"></td>';
		        	  	  }	
		       	  }
        	  }
        	  z+='</tr><TR><TD colspan="8" style="background: #FFFFFF; border:none">&nbsp;</td><TR><TD colspan="8" style="background: #FFFFFF"><B>'+uW.g_js_strings.commonstr.gold+':</b></td></tr><TR>';
        	  var goldtotal = 0;
        	  for(b=0; b<Cities.numCities; b++) goldtotal += parseInt(Seed.citystats["city" + Seed.cities[b][0]]['gold'][0]);
        	  z+='<TD>'+addCommas(goldtotal)+'</td>';
        	  for(b=0; b<Cities.numCities; b++) {
        	  		z+='<TD align=right >'+ addCommas(Seed.citystats["city" + Seed.cities[b][0]]['gold'][0])  +'</td>';
        	  }
        	  z+='<TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.showGoldTooltip.netincome+':</font></td>';
        	  for(b=0; b<Cities.numCities; b++) {
        	  		var f = 1;
        	  		if (parseInt(Seed.playerEffects.r0BstExp) > unixTime()) f = 2;
        	  		var g = parseInt(parseInt(Seed.citystats["city" + Seed.cities[b][0]]['gold'][1] * Seed.citystats["city" + Seed.cities[b][0]]['pop'][0]) * 0.01) * f;
        	  		var h = parseInt(Seed.citystats["city" + Seed.cities[b][0]]["gold"][2] * 10 * -1);
        	  		z+='<TD align=right style="background: #FFFFFF"><FONT COLOR="686868">'+ addCommas(g+h)  +'</font></td>';
        	  }
        	  z+='</tr><TR><TD colspan="8" style="background: #FFFFFF">&nbsp;</td> </tr><TR><TD style="background: #F8F8F8"><B>'+uW.g_js_strings.showPopTooltip.idlepop+':</b></td>';
        	  for(b=0; b<Cities.numCities; b++) {
    	  			var i = Seed.citystats["city" + Seed.cities[b][0]]['pop'][0];
    	  			var j = Seed.citystats["city" + Seed.cities[b][0]]['pop'][3];
    	  			var k = i - j;
    	  			if (k > 0) z+='<TD align=right style="background: #FFFFFF">'+ addCommas(k)  +'</td>'; 
    	  			 else z+='<TD align=right style="background: #FFFFFF"><FONT COLOR=red>'+ addCommas(k)  +'</font></td>';
        	  }  
        	 z+='</tr><TR><TD colspan="8" style="background: #FFFFFF">&nbsp;</td> </tr><TR><TD style="background: #F8F8F8"><B>'+uW.g_js_strings.showMyWilderness.conqueredwild+':</b></td>';
        		for(b=0; b<Cities.numCities; b++) {
        		      var totWilds = 0;
        			  dat = Seed.wilderness['city'+ Seed.cities[b][0]];
        			  if (dat!=null && matTypeof(dat)=='object')
        		  			for (k in dat)
        		    			++totWilds;
        			 var castle = parseInt(Seed.buildings['city'+ Seed.cities[b][0]].pos0[1]);
        			 if(castle == 11) castle = 12;
        			 else if(castle == 12) castle = 14;
        			 if (totWilds < castle)
        		  	z+=  '<TD align=right "><FONT COLOR=RED>'+ totWilds +'/'+ castle +'</font></span>';
        			else
        		  		z+=  '<TD align=right>'+ totWilds +'/'+ castle +'</span>';
        		}
        		z+='</tr>';
              for (c in uW.cm.WILDERNESS_TYPES){
              		var wildtype ='';
              		switch (c) {
              		  case 'GRASSLAND' : wildtype = uW.g_js_strings.commonstr.grassland;break;
              		  case 'LAKE' : wildtype = uW.g_js_strings.commonstr.lake;break;
              		  case 'WOODS' : wildtype = uW.g_js_strings.commonstr.woods;break;
              		  case 'HILLS' : wildtype = uW.g_js_strings.commonstr.hills;break;
              		  case 'MOUNTAIN' : wildtype = uW.g_js_strings.commonstr.mountain;break;
              		  case 'PLAIN' : wildtype = uW.g_js_strings.commonstr.plain;break;
              		}
              		var grandtotal = 0;
              		for(b=0; b<Cities.numCities; b++) {
              			dat = Seed.wilderness['city'+ Seed.cities[b][0]];
              			if (dat!=null && matTypeof(dat)=='object') for (k in dat) if (dat[k]['tileType'] == uW.cm.WILDERNESS_TYPES[c]) grandtotal++; 
              		}
              		if (grandtotal >0) {
		              		z+='<TR><TD style="background: #FFFFFF">'+wildtype+'</td>';
		              		for(b=0; b<Cities.numCities; b++) {		
		              			var total =0;
		              			dat = Seed.wilderness['city'+ Seed.cities[b][0]];
		              			if (dat!=null && matTypeof(dat)=='object')
		              					for (k in dat)
		              						if (dat[k]['tileType'] == uW.cm.WILDERNESS_TYPES[c])
		              							++total;  
		        				if (total >0) z+='<TD align=right style="background: #FFFFFF">'+total+'</td>';
		        				else z+='<TD style="background: #FFFFFF"></td>';
		        					
		              		}
		              		z+='</tr>';
		      	    }       
              }
             
        var totboosts = false;
        	  var l = Seed.playerEffects;
            for (p in l) if (l[p] > unixTime()) totboosts =true;               
            if (totboosts) {
                z+='</tr><TR><TD colspan="8" style="background: #FFFFFF; border:none">&nbsp;</td> </tr><TR><TD style="background: #F8F8F8"><B>'+uW.g_js_strings.commonstr.boost+':</b></td>';
                for (p in l) {
                   if (p =='r0BstExp' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.resourceinfo['rec'+0]+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='r1BstExp' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.resourceinfo['rec'+1]+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='r2BstExp' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.resourceinfo['rec'+2]+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='r3BstExp' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.resourceinfo['rec'+3]+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='r4BstExp' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.resourceinfo['rec'+4]+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='atkExpire' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.g_js_strings.commonstr.attack+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='defExpire' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.g_js_strings.commonstr.defend+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='loadExpire' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.g_js_strings.modal_barracks_train.load+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='returnExpire' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.g_js_strings.commonstr.returning+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='troopUpkeepReductExp' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.g_js_strings.commonstr.upkeep+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='fogExpire' && l[p] > unixTime()) z+='<TR ><TD style="background: #FFFFFF">'+uW.itemlist.i10021.name+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
               }
            }      
        z+='</table></div>';
      t.Overv.innerHTML = z;
     	t.displayTimer = setTimeout (t.showResources, 1000);  
   },   
      
        
    showTroops : function (){
      var t = Tabs.OverView;
      t.Overv.innerHTML =null;
      t.Overv.style.maxHeight = '700px';
      t.Overv.style.overflowY = 'scroll';
     var n = "<TABLE class=ptTabOverview cellpadding=0 cellspacing=0><TR valign=top align=right></td><TD colspan='2' id=update align=center style='background: #FFFFFF; border:none; vertical-align:middle'><INPUT id=TEST type=submit value="+uW.g_js_strings.modal_progress_actions.updatestatus+"></td></td>";
           for(i=0; i<Cities.numCities; i++) {
             n += "<TD width=81 style='background: #FFFFFF'><B>"+ Cities.cities[i].name.substring(0,11) +'</b><BR>'+ coordLink (Cities.cities[i].x, Cities.cities[i].y) +"<BR>"+ uW.provincenames['p'+ Cities.cities[i].provId] +"</td>";
           }
   	  for(a=1;a<13;a++) {
   	        var total=0;
   	        var marching = 0;
   	        var raiding = 0;
   	        var tottraining = 0;
   	        
   	        for(b=0; b<Cities.numCities; b++) {
   	        	   var train = Seed.queue_unt['city' + Seed.cities[b][0]];
   	        	   if (train != []) for (c in train) if (train[c][0] == a) tottraining += parseInt(train[c][1]);
   	        }
   	        if (tottraining > 0) var rowsp = 3; 
   	        else var rowsp = 2; 
   	        n+='<TR><TD rowspan="'+rowsp+'" style="background: #FFFFFF; vertical-align:top;"><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_'+a+'_30.jpg></td>';
   	        for(b=0; b<Cities.numCities; b++) total += parseInt(Seed.units['city' + Seed.cities[b][0]]['unt'+a]);
   	        if (total >0) n+='<TD align=right >'+addCommas(total)+'</td>';
   	        else n+='<TD align=right >&nbsp;</td>';
   	        for(b=0; b<Cities.numCities; b++) {
   	        	if (Seed.units['city' + Seed.cities[b][0]]['unt'+a] > 0) n+= '<TD align=right >'+addCommas(Seed.units['city' + Seed.cities[b][0]]['unt'+a])+'</td>';
   	        	else n+='<TD ></td>';
   	        }
   	        n+='</tr><TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.commonstr.marching+'</font></td>';
   	        for(b=0; b<Cities.numCities; b++) {
   	        	   marching = 0;
   	        	   raiding = 0;
   	        	   var atkp = Seed.queue_atkp['city' + Seed.cities[b][0]];
   	        	   if (atkp != []){
	   	        	   for (c in atkp){
	   	        	   		if (atkp[c]['marchType'] == 9) raiding += (parseInt(atkp[c]['unit'+a+'Count']) + parseInt(atkp[c]['unit'+a+'Return']));
	   	        	   		else if (atkp[c]['marchType'] != undefined)marching += parseInt(atkp[c]['unit'+a+'Count']);
	   	        	   }
	   	        	   if (marching >0 || raiding > 0) {
	   	        	   		n+= '<TD align=right style="background: #FFFFFF"><FONT COLOR="686868">'+addCommas(marching)+' / ';
	   	        	   		n+= addCommas(raiding)+'</font></td>';
   	        	   	   }
   	        	   	   else n+='<TD style="background: #FFFFFF"></td>';	
   	        	   }
   	        }
   	      if (tottraining >0){
   	        n+='</tr><TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.modal_openBarracks.trainingttl+'</font></td>';
   	        for(b=0; b<Cities.numCities; b++) {
   	        	   training = 0;
   	        	   var train = Seed.queue_unt['city' + Seed.cities[b][0]];
   	        	   if (train != []){
	   	        	   for (c in train) if (train[c][0] == a) training += parseInt(train[c][1]);
	   	        	   if (training >0) {
	   	        	   		n+= '<TD align=right style="background: #FFFFFF"><FONT COLOR="686868">'+addCommas(training)+'</font></td>';
   	        	   	   }
   	        	   	   else n+='<TD style="background: #FFFFFF"></td>';	
   	        	   }
   	      }
   	  		n+='</tr>';
   	  	}
   	  }
   	  n+='<TR><TD colspan="8" style="background: #FFFFFF; border:none;">&nbsp;</td> </tr>';
      n+='<TR><TD colspan="2" style="border=solid">'+uW.g_js_strings.openKnights.myknights+':</td>';
      for(b=0; b<Cities.numCities; b++) {
           var knights=0;
           var knightscity = Seed.knights['city' + Seed.cities[b][0]];
           if (knightscity != []) for (c in knightscity) if (knightscity[c]['knightId'] > 0) knights++;
        	 n+= '<TD align=right >'+knights+'</td>';	
      }
      n+='</tr><TR><TD colspan="2" >'+uW.g_js_strings.commonstr.combat+':</td>';
      for(b=0; b<Cities.numCities; b++) {
           var combat=0;
           var knightscity = Seed.knights['city' + Seed.cities[b][0]];
           if (knightscity != []) for (c in knightscity) if (knightscity[c]['combat'] > combat) 
               if (Seed.leaders['city' + Seed.cities[b][0]]['combatKnightId'] != knightscity[c]['knightId'])  combat = knightscity[c]['combat'];
        	 n+= '<TD align=right style="background: #FFFFFF">'+combat+'</td>';	
      }
      
      n+='<TR><TD colspan="8" style="background: #FFFFFF; border:none;">&nbsp;</td> </tr>';
      n+='<TR><TD colspan="2" style="border=solid">'+uW.g_js_strings.modal_barracks_trainingtab.totaltraintime+':</td>';
      for(b=0; b<Cities.numCities; b++) {
           var time=0;
           now = unixTime();
           var  unt = Seed.queue_unt['city' + Seed.cities[b][0]];
           //alert(unt.length);
           if (unt != null && unt.length > 0) time = (unt[unt.length-1][3] - now);
           if (time < 0) time=0;
           if (time < 3600) n+= '<TD align=right ><FONT COLOR=red>'+timestr(time)+'</font></td>';	
           else n+= '<TD align=right >'+timestr(time)+'</td>';	
      }
      
      
      
   	  n+='</tr></table>';
   	  t.Overv.innerHTML = n;
   	  
   	  document.getElementById('TEST').addEventListener('click', function(){
   	  		var params = uW.Object.clone(uW.g_ajaxparams);
   	    			new AjaxRequest(uW.g_ajaxpath + "/fb/e2/src/main_src.php?g=&y=0&n=nan001&l=nl_NL&messagebox=&standalone=0&res=1&iframe=1&lang=en&ts=1304248288.7067&s=250&appBar=" + uW.g_ajaxsuffix, {
   	    			    method: "POST",
   	    			    parameters: params,
   	    			    onSuccess: function (rslt) {
   	    			        var mainSrcHTMLCode = rslt.responseText;
   	    			    	var myregexp = /var seed=\{.*?\};/;
   	    			    	var match = myregexp.exec(mainSrcHTMLCode);
   	    			    	if (match != null) {
   	    			    		result = match[0];
   	    			    		result = result.substr(4);
   	    			    		var seed = eval(result);
   	  	  			    		uW.document.seed = seed;
   	  	  			    		Seed = seed;
   	  	  			    		uW.seed = seed;
   	  	  			    		document.getElementById('update').style.background ='#99FF99';
   	  	  			    		setTimeout(function(){ (document.getElementById('update').style.background ='#FFFFF'); }, 1000);
   	    			    	}
   	    			    },
   	    			    onFailure: function () {
   	    			      if (notify != null)
   	    			        notify(rslt.errorMsg);
   	    			    },
   	    			});
   	  	
   	  }, false);
   	    	
      t.displayTimer = setTimeout (t.showTroops, 1000);  
    },
	
	
  showExtras : function (){
    var t = Tabs.OverView;
    clearTimeout (t.displayTimer);
    t.Overv.innerHTML =null;
    t.Overv.style.maxHeight = '700px';
    t.Overv.style.overflowY = 'scroll';	
 			  		       
    
    var m = '<DIV class=ptstat>NÜTZLICHE LINKS</div>';
	
    m += '<table class=ptTab align="center" width="700" border="0" cellspacing="0" cellpadding="0">';
    m += '<tr><td width="57"><b>Nr.</b></td>';
    m += '<td width="343"><b><center>Thema</center></b></td>';
    m += '<td width="156"><b><center>Quelle</center></b></td></tr>';
    m += '<tr><td><b># 1</b></td>';
    m += '<td><center><a href="http://koc.god-like.org/?cat=252" target=_blank>Tips und Tricks</a></center></td>';
    m += '<td><center><a href="http://kocscripts.god-like.org" target="_blank">koc.god-like.org</a></center></td></tr>';
    m += '<tr><td><b># 2</b></td>';
    m += '<td><center><a href="http://koc.god-like.org/?cat=78" target="_blank">Angriffe auf Babaren Lager</a></center></td>';
    m += '<td><center><a href="http://kocscripts.god-like.org" target="_blank">koc.god-like.org</a></center></td></tr>';
    m += '<tr><td><b># 3</b></td>';
    m += '<td><center><a href="http://koc.god-like.org/?cat=122" target="_blank">Wappen Suche</a></center></td>';
    m += '<td><center><a href="http://kocscripts.god-like.org" target="_blank">koc.god-like.org</a></center></td></tr>';
    m += '<tr><td><b># 4</b></td>';
    m += '<td><center><a href="http://koc.god-like.org/?cat=211" target="_blank">Wildniss Angriffe Allgemein</a></center></td>';
    m += '<td><center><a href="http://kocscripts.god-like.org" target="_blank">koc.god-like.org</a></center></td></tr>';
    m += '<tr><td><b># 5</b></td>';
    m += '<td><center><a href="http://koc.god-like.org" target="_blank">KoC Scripts - Der erste Deutsche KoC Scripts Blog!</a></center></td>';
    m += '<td><center><a href="http://kocscripts.god-like.org" target="_blank">koc.god-like.org</a></center></td></tr>';
	m += '<tr><td><b># 6</b></td>';
    m += '<td><center><a href="http://koc.god-like.info/update/auto-updater-usage.php" target="_blank">Scripte via KoC Scripts downloaden</a></center></td>';
    m += '<td><center><a href="http://kocscripts.god-like.org" target="_blank">koc.god-like.org</a></center></td></tr>';
	m += '<tr><td><b># 7</b></td>';
    m += '<td><center><a href="http://koc.god-like.info/update/auto-updater-usage.php" target="_blank">Scripte via Userscripts.org downloaden</a></center></td>';
    m += '<td><center><a href="http://userscripts.org" target="_blank">userscripts.org</a></center></td></tr>';
    m += '<tr><td><b># 8</b></td>';
    m += '<td><center><a href="http://koc.god-like.org/?p=1034" target="_blank">Bugs/Fehler auf KoC Scripts Melden</a></center></td>';
    m += '<td><center><a href="http://kocscripts.god-like.org" target="_blank">koc.god-like.org</a></center></td></tr>';
	m += '<tr><td><b># 9</b></td>';
    m += '<td><center><a href="http://koc.god-like.org/?p=966" target="_blank">Wünsche und Vorschläge</a></center></td>';
    m += '<td><center><a href="http://kocscripts.god-like.org" target="_blank">koc.god-like.org</a></center></td></tr>';
	m += '<tr><td><b># 10</b></td>';
    m += '<td><center><a href="http://koc.god-like.org/?p=1082" target="_blank">KoC Scripts - Facebook Gruppen</a></center></td>';
    m += '<td><center><a href="http://kocscripts.god-like.org" target="_blank">koc.god-like.org</a></center></td></tr>';
    m += '<tr><td><b># 11</b></td>';
    m += '<td><center><a href="http://koc.god-like.org/?p=1432" target="_blank">Kostenlose Gems (FB-Credits) bei 4loot.com</a></center></td>';
    m += '<td><center><a href="http://kocscripts.god-like.org" target="_blank">koc.god-like.org</a></center></td></tr>';
	m += '</table>';
    m += '<DIV class=ptstat>WEITERE INFORMATION</div><TABLE class=ptTab><TD width="300px">Kingdom of Camelot - Client Version: <span class=boldRed>'+ KOCversion +'</span></td>';
    m += '<TD><INPUT id=ptButDebug type=submit name="SEED" value="DEBUG"></td></table></div>';
    	
    t.Overv.innerHTML = m;

    document.getElementById('ptButDebug').addEventListener('click', function (){debugWin.doit()}, false);  
    t.displayTimer = setTimeout (t.showExtras, 1000);
  },
  
  showInfo : function (){
      var t = Tabs.OverView;
      t.Overv.innerHTML = null;
      t.Overv.style.maxHeight = '600px';
      t.Overv.style.overflowY = 'scroll';
      clearTimeout (t.displayTimer);	

	  var m='';

	  fortmight = {
	        u53: "4",
	        u55: "7",
	        u60: "1",
	        u61: "2",
	        u62: "3",
	      };
	      rownum = 0;
		
	      m += '<STYLE>.xtabH {background:#ffffe8; border:none; padding-right: 5px; padding-left: 5px; margin-left:10px; }\
	              .xtabHL { background:#ffffe8; border-width: 1px; border-style: none none none solid; padding-right:5px; padding-left:5px; margin-left:10px; }\
	              .xtabL { background:none; border-width: 1px; border-style: none none none solid; padding-right:5px; padding-left: 5px; margin-left:10px; }\
	              .xtabLine { padding:0px; spacing:0px; height:1px; border-color:black; border-width: 1px; border-style: none none solid none }</style>\
	          <DIV style="overflow-y:auto; overflow-x:hidden"><DIV class=ptstat>STÄDTE VORAUSSETZUNGEN</div><SPAN id="cityRequirements">&nbsp;</SPAN><DIV class=ptstat>TRUPPEN INFORMATION</div><TABLE align=center cellpadding=1 cellspacing=0>\
	          <TR align=center><TD class=xtab></td><TD class=xtabHL colspan=5><B>KOSTEN</b></td><TD class=xtabHL colspan=7><B>STATS</b></td><TD class=xtabHL><B>Verb.</b></td></tr>\
	          <TR valign=bottom align=right><TD class=xtab></td><TD class=xtabHL>Futter</td><TD class=xtabH>Holz</td><TD class=xtabH>Stein</td>\
	          <TD class=xtabH>Erz</td><TD class=xtabH>Bev</td><TD class=xtabHL>Macht</td><TD class=xtabH>Leb</td><TD class=xtabH>Ang</td><TD class=xtabH>Def</td><TD class=xtabH>Gesch</td><TD class=xtabH>Weite</td><TD class=xtabH>Lade</td>\
	          <TD class=xtabHL>Futter</td></tr>\
	          <TR style="height:1px;"><TD style="padding:0px; spacing:0px; height:1px; border-color:black; border-width: 1px; border-style: none none solid none" colspan=14></td></tr>';
	      for (ui=1; ui<13; ui++){
	        if (++rownum % 2)
	          rsty = '';
	        else
	          rsty = ' style="background: #e8e8e8" ';
	        cost = unsafeWindow.unitcost['unt'+ui];     //  NAME, Food, Wood, Stone, Ore, ?, IdlePop, Time
	        stats = unsafeWindow.unitstats['unt'+ui];   //  Life, Attack, Defense, Speed, Range, Load
	        food = unsafeWindow.unitupkeeps[ui];
	        might = unsafeWindow.unitmight['u'+ui];
	        m += '<TR '+ rsty +'align=right><TD class=xtab align=left><B>'+ cost[0].substr(0,16) +'</b></td><TD class=xtabL>'+ cost[1] +'</td><TD class=xtab>'+ cost[2] +'</td>\
	            <TD class=xtab>'+ cost[3] +'</td><TD class=xtab>'+ cost[4] +'</td><TD class=xtab>'+ cost[6] +'</td><TD class=xtabL>'+ might +'</td>\
	            <TD class=xtab>'+ stats[0] +'</td><TD class=xtab>'+ stats[1] +'</td><TD class=xtab>'+ stats[2] +'</td><TD class=xtab>'+ stats[3] +'</td>\
	            <TD class=xtab>'+ stats[4] +'</td><TD class=xtab>'+ stats[5] +'</td><TD class=xtabL>'+ food +'</td></tr>';
	  
	      }
	      m += '<TR class=xtabLine><TD colspan=14 class=xtabLine></td></tr>';
	      for (k in uW.fortcost){
	        if (++rownum % 2)
	          rsty = '';
	        else
	          rsty = ' style="background: #e8e8e8" ';
	        cost = unsafeWindow.fortcost[k];     //  NAME, Food, Wood, Stone, Ore, ?, IdlePop, Time
	        fi = k.substring(3);
	        stats = unsafeWindow.fortstats['unt'+fi];   //  Life, Attack, Defense, Speed, Range, Load
	        food = 0;
	        might = fortmight['u'+fi];
	        name = cost[0].replace ('Defensive','');
	        name = name.replace ('Wall-Mounted','');
	        m+= '<TR '+ rsty +'align=right><TD align=left class=xtab><B>'+ name +'</b></td><TD class=xtabL>'+ cost[1] +'</td><TD class=xtab>'+ cost[2] +'</td>\
	            <TD class=xtab>'+ cost[3] +'</td><TD class=xtab>'+ cost[4] +'</td><TD class=xtab>'+ cost[6] +'</td><TD class=xtabL>'+ might +'</td>\
	            <TD class=xtab>'+ stats[0] +'</td><TD class=xtab>'+ stats[1] +'</td><TD class=xtab>'+ stats[2] +'</td><TD class=xtab>'+ stats[3] +'</td>\
	            <TD class=xtab>'+ stats[4] +'</td><TD class=xtab>'+ stats[5] +'</td><TD class=xtabL>'+ food +'</td></tr>';
	      }
	      m += '<TR class=xtabLine><TD colspan=14 class=xtabLine></td></tr>';
	      m += '</table></div>';
		  
	  // TRAINING INFO
	function _displayrow (name, row){
			if (rownum++ % 2)
				style = '';
			else
				style = ' style = "background: #e8e8e8"';
			m += '<TR' + style + '>';
			m += '<TD align=right><B>' + name + '</B></td>';
			for (i=0; i<row.length; i++)
				if (row[i]==0)
					m += '<td align=right><SPAN class=boldRed>0</SPAN></td>';
				else
					m += '<td align=right>'+addCommas(parseInt(row[i]))+'</td>';
			m += '</tr>';
		}
		m += '<DIV class=ptstat>AUSBILDUNGSZEITEN</div><BR /><TABLE align=center cellpadding=1 cellspacing=0>\
					<TABLE align=center cellpadding=1 cellspacing=0><TR align=right><TD></td>';
		infoRows = [];
		for (r=0; r<18; r++){
			infoRows[r] = [];
		}
		for(i=0; i<Cities.numCities; i++) {
			cityID = 'city'+ Cities.cities[i].id;
			m += "<TD align=center valign=bottom width=60px><B>";
			m += Cities.cities[i].name.replace(/ /g, "<BR>");
			m += "</B></TD>";
			getTroopTrainEstimates(cityID);
			infoRows[0][i] = numBarracks;
			infoRows[1][i] = totLevelsBarracks;
			infoRows[2][i] = marshallCombatScore;
			infoRows[3][i] = geometryLevel;
			infoRows[4][i] = stableLevel;
			infoRows[5][i] = workshopLevel;
			infoRows[6][i] = rateSupplyTroop;
			infoRows[7][i] = rateMilitiaman;
			infoRows[8][i] = rateScout;
			infoRows[9][i] = ratePikeman;
			infoRows[10][i] = rateSwordsman;
			infoRows[11][i] = rateArcher;
			infoRows[12][i] = rateCavalry;
			infoRows[13][i] = rateHeavyCavalry;
			infoRows[14][i] = rateSupplyWagon;
			infoRows[15][i] = rateBallista;
			infoRows[16][i] = rateBatteringRam;
			infoRows[17][i] = rateCatapult;
		}
		m += "</tr>";
		rownum=0;
		_displayrow ("Kasernen",   infoRows[0]);
		_displayrow ("Kasernen Level Gesamt", infoRows[1]);
		_displayrow ("Marschall Punkte", infoRows[2]);
		_displayrow ("Geometrie  Level",       infoRows[3]);
		_displayrow ("Stallung Level",         infoRows[4]);
		_displayrow ("Werkstatt Level",       infoRows[5]);
		m += "<TR><TD nowrap align=center colspan="+(Cities.numCities+1)+"><B>Ausbildungszeit <u>je</u> Heiligtum <u>in der Stunde</u></B></TD>";
		_displayrow ("Versorgungstruppe",  infoRows[6]);
		_displayrow ("Milizsoldat",    infoRows[7]);
		_displayrow ("Späher",         infoRows[8]);
		_displayrow ("Lanzenträger",       infoRows[9]);
		_displayrow ("Schwertkämpfer",     infoRows[10]);
		_displayrow ("Bogenschütze",        infoRows[11]);
		_displayrow ("Kavallerie",       infoRows[12]);
		_displayrow ("Schwere Kavallerie", infoRows[13]);
		_displayrow ("Versorgungswagen",  infoRows[14]);
		_displayrow ("Ballisten",      infoRows[15]);
		_displayrow ("Rammbock", infoRows[16]);
		_displayrow ("Steinschleuder",      infoRows[17]);
		m += "</TABLE>";
// TRAINING INFO END
	      t.Overv.innerHTML = m;
	   var crest = {};
		for (k in crestname){
			if(Seed.items['i'+k])
				crest[k] = Seed.items['i'+k];
			else
				crest[k] = 0;
		}
		var crestreq = {
			3:{1101:4, 1102:2, 1103:1},
			4:{1103:4, 1104:3, 1105:1},
			5:{1106:4, 1107:3, 1108:2},
			6:{1109:4, 1110:3, 1111:2},
			7:{1112:4, 1113:3, 1114:2}};

		m = '<TABLE align=center cellpadding=1 cellspacing=0>';
		m += '<TR CLASS="xtabH"><TD class=xtab></TH>';
		m += '<TD class=xtabHL><b>Besitz/Benötigt 1</b></TD>';
		m += '<TD class=xtabHL><b>Besitz/Benötigt 2</b></TD>';
		m += '<TD class=xtabHL><b>Besitz/Benötigt 3</b></TD></TR>';
		m += '<TR style="height:1px;"><TD style="padding:0px; spacing:0px; height:1px; border-color:black; border-width: 1px; border-style: none none solid none" colspan=4></td></tr>';
		var numFriends = 0; // Seed.appFriends.length doesn't work, so iterate through :-(
		Friends = Seed.appFriends;
		for (k in Friends)
			numFriends++;
		var cityCount = Cities.numCities;
		if (cityCount == 1)
			csty = '';
		else
			csty = ' style="color:#060; font-weight:bold"';
		m += '<TR><TD class=xtab'+csty+'><B>Stadt 2</B></TD>';
		if (parseInt(Seed.player.title) < 7)
			m += '<TD class=xtabL><SPAN class=boldRed>'+Seed.player.title+'/7 Spieler Level</SPAN></TD>';
		else
			m += '<TD class=xtabL'+csty+'>'+Seed.player.title+'/7 Spieler Level</TD>';
		if (numFriends < 10 && cityCount == 1)
			m += '<TD class=xtabL><SPAN class=boldRed>'+numFriends+'/10 Freunde</SPAN></TD>';
		else
			m += '<TD class=xtabL'+csty+'>'+numFriends+'/10 Freunde</TD>';
		m += '<TD class=xtabL'+csty+'>&nbsp;</TD></TR>'
		rownum = 1;
		for(k in crestreq){
			if (++rownum % 2)
				rsty = '';
			else
				rsty = ' style="background: #e8e8e8" ';
			if (k <= cityCount)
				csty = ' style="color:#060; font-weight:bold"';
			else
				csty = '';
			m += '<TR '+rsty+'><TD class=xtab'+csty+'><B>Stadt '+k+'</B></TD>';
			for(u in crestreq[k]) {
				if (k <= cityCount)
					m+='<TD class=xtabL'+csty+'>'+crest[u]+'/'+crestreq[k][u]+' '+crestname[u]+ '</TD>';
				else {
					if (crest[u] < crestreq[k][u])
						m+='<TD class=xtabL><SPAN class=boldRed>'+crest[u]+'/'+crestreq[k][u]+' '+crestname[u]+ '</SPAN></TD>';
					else
						m+='<TD class=xtabL><SPAN class=boldDarkGreen>'+crest[u]+'/'+crestreq[k][u]+' '+crestname[u]+ '</SPAN></TD>';
				}
			}
			m += '</TR>';
		}
		m += '</TABLE></SPAN>';
		
		document.getElementById('cityRequirements').innerHTML = m;
	},      
  
showBuilds : function (){
    var t = Tabs.OverView;
    clearTimeout (t.displayTimer);
    t.Overv.innerHTML =null;
    t.Overv.style.maxHeight = '700px';
    t.Overv.style.overflowY = 'scroll';	
    var wall=0;
    var blacksmith=0;
    var fletching=0;
    var geometry = 0;
    var metalalloys = 0;
    var logging = 0;
    var poisonededge = 0;

    var FieldSpace = {1:13,
    			  2:16,
    			  3:19,
    			  4:22,
    			  5:25,
    			  6:28,
    			  7:31,
    			  8:34,
    			  9:37,
    			  10:40,
    			  11:40,
				  12:40};
    			  		   
    fertilizer = Seed.tech['tch1'];
    logging = Seed.tech['tch2'];
    stoneworking = Seed.tech['tch3'];
    mining = Seed.tech['tch4'];
    geometry = Seed.tech['tch5'];
    eagleeyes = Seed.tech['tch6'];
    poisonededge = Seed.tech['tch8'];
    metalalloys = Seed.tech['tch9'];
    featherweightpowder = Seed.tech['tch10'];
    magicalmapping = Seed.tech['tch11'];
    alloyhorseshoes = Seed.tech['tch12'];
    fletching = Seed.tech['tch13'];
    shrinkingpowder = Seed.tech['tch14'];
    healingpotions = Seed.tech['tch15'];
    giantsstrength = Seed.tech['tch16'];			  		       
    
    var m = '<DIV class=ptstat>GEBÄUDE UND FORSCHUNG STATS</div><DIV id=BuildsDiv style="font-size:12px"><TABLE cellpadding=5 cellspacing=0 border="1" style="border: 1px solid; border-style: none none none none;"><TR valign=top align=right>';
    m += "<TD align=left width=85 style='background-color:"+Colors.OverviewDarkRow+";'><INPUT id=showReq type=checkbox " + (t.showReq?'CHECKED ':'') +">Benötigt</td>";
    for(i=0; i<Cities.numCities; i++) {
      m += "<TD width=79 style='background-color:"+Colors.OverviewDarkRow+"'><B>"+ Cities.cities[i].name.substring(0,11) +"</b><BR>"+ coordLink(Cities.cities[i].x, Cities.cities[i].y) +"<BR></td>";
    }
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';"><b>Gebäude</b></td>';	
    for(i=0; i<Seed.cities.length; i++) {
    	city = 'city'+Seed.cities[i][0];
    	m+='<TD width=79 style="background:#FFFFFF">';
    	if (Seed.queue_con[city][0] != undefined) {
    		m+=uW.buildingcost['bdg' + Seed.queue_con[city][0][0]][0];
    		m+=' ('+Seed.queue_con[city][0][1]+')';
    		m+='<br>'+ timestr((Seed.queue_con[city][0][4] - unixTime()),true);
    	}
    	m+='</td>';	
    }
    m+='</tr>';
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';"><b>Forschung</b></td>';	
    for(i=0; i<Seed.cities.length; i++) {
    	city = 'city'+Seed.cities[i][0];
    	m+='<TD width=79 style="background:#FFFFFF">';
    	if (Seed.queue_tch[city][0] != undefined) {
    		m+=uW.techcost['tch' + Seed.queue_tch[city][0][0]][0];
    		m+=' ('+Seed.queue_tch[city][0][1]+')';
    		m+='<br>'+ timestr((Seed.queue_tch[city][0][3] - unixTime()),true);
    	}
    	m+='</td>';		
    }
    m+='</tr><TR><TD colspan="8" style="background: #FFFFFF; border:none">&nbsp;</td></tr>';
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+uW.fortcost['frt53'][0]+'</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] == 15) blacksmith = Seed.buildings[city][y][1]; 
    	}
    	wall = parseInt(Seed.buildings[city].pos1[1]);
		var WallSpace = 0;
		for (var b = 1; b < (wall + 1); b++) {WallSpace += (b * 1000)};
		max = WallSpace/2/4 - parseInt(Seed.fortifications[city]["fort53"]) - parseInt(Seed.fortifications[city]["fort55"]);
    	m+= '<TD width=79 style="background:#FFFFFF">' + Seed.fortifications[city]["fort53"];
    	if (wall >=6 && blacksmith >=6 && fletching >=5 && max > 0) m+= '<br>Left: ' + max +'</td>';
    	else if (t.showReq){
    			if (wall < 6) m+= '<br><FONT COLOR= "CC0000">Mauer: ' + wall + '(6)</font>';
    			if (blacksmith < 6) m+= '<br><FONT COLOR= "CC0000">BlackS.: ' + blacksmith + '(6)</font>';
    			if (fletching < 5) m+= '<br><FONT COLOR= "CC0000">Fletch.: ' + fletching + '(5)</font>';
    			m+='</td>';
    		} 		
    }
    m+='</tr><TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+uW.fortcost['frt55'][0]+'</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] == 19) wall = Seed.buildings[city][y][1];
    		if (Seed.buildings[city][y][0] == 15) blacksmith = Seed.buildings[city][y][1]; 
    	}
    	max = WallSpace[wall]/2/4 - parseInt(Seed.fortifications[city]["fort53"]) - parseInt(Seed.fortifications[city]["fort55"]);
    	m+=  '<TD width=79 style="background:#FFFFFF">' +Seed.fortifications[city]["fort55"];
    	if (wall >=8 && blacksmith >=8 && fletching >=7 && geometry>=7 && max > 0) m+= '<br>Left: ' + max+'</td>';
    	else if (t.showReq){
    			if (wall < 8) m+= '<br><FONT COLOR= "CC0000">Mauer: ' + wall + '(8)</font>';
    			if (blacksmith < 8) m+= '<br><FONT COLOR= "CC0000">BlackS.: ' + blacksmith + '(8)</font>';
    			if (fletching < 7) m+= '<br><FONT COLOR= "CC0000">Fletch.: ' + fletching + '(7)</font>';
    			if (geometry < 7) m+= '<br><FONT COLOR= "CC0000">Geomet.: ' + geometry + '(7)</font>';
    			m+='</td>';
    	} 	
    }
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">Mauer Def</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	wall = parseInt(Seed.buildings[city].pos1[1]);
    	build = (parseInt(Seed.fortifications[city]["fort53"])*2)+ (parseInt(Seed.fortifications[city]["fort55"])*4);
    	var WallSpace = 0;
		for (var b = 1; b < (wall + 1); b++) {WallSpace += (b * 1000)};
		max = WallSpace/2;
		if (build < max) m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "CC0000">';
    	else m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "669900">';
    	m+= build+'</font>';
    	m+= '/' + max +'</td>';
    }
    m+='</tr><TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+uW.fortcost['frt60'][0]+'</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] == 15) blacksmith = Seed.buildings[city][y][1]; 
    	}
    	wall = parseInt(Seed.buildings[city].pos1[1]);
		var WallSpace = 0;
		for (var b = 1; b < (wall + 1); b++) {WallSpace += (b * 1000)};
		max = WallSpace/2/4 - (parseInt(Seed.fortifications[city]["fort60"])*4) - (parseInt(Seed.fortifications[city]["fort61"])*1) - (parseInt(Seed.fortifications[city]["fort62"])*3);
    	m+=  '<TD width=79 style="background:#FFFFFF">'+Seed.fortifications[city]["fort60"];
    	if (wall >=4 && blacksmith >=4 && poisonededge>=4 && max>0) m+= '<br>Left: ' + max+'</td>';
    	else if (t.showReq){
    			if (wall < 4) m+= '<br><FONT COLOR= "CC0000">Wall: ' + wall + '(4)</font>';
    			if (blacksmith < 4) m+= '<br><FONT COLOR= "CC0000">BlackS.: ' + blacksmith + '(4)</font>';
    			if (poisonededge < 4) m+= '<br><FONT COLOR= "CC0000">Poison.: ' + poisonededge + '(4)</font>';
    			m+='</td>';
    	} 	
    }
    m+='</tr><TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+uW.fortcost['frt61'][0]+'</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] == 15) blacksmith = Seed.buildings[city][y][1]; 
    	}
		wall = parseInt(Seed.buildings[city].pos1[1]);
		var WallSpace = 0;
		for (var b = 1; b < (wall + 1); b++) {WallSpace += (b * 1000)};
		max = WallSpace/2/1 - (parseInt(Seed.fortifications[city]["fort60"])*4) - (parseInt(Seed.fortifications[city]["fort61"])*1) - (parseInt(Seed.fortifications[city]["fort62"])*3);
    	m+= '<TD width=79 style="background:#FFFFFF">'+Seed.fortifications[city]["fort61"];
    	if (wall >=1 && metalalloys >=1 && max>0) m+= '<br>Left: ' + max+'</td>';
    	else if (t.showReq){
    			if (wall < 1) m+= '<br><FONT COLOR= "CC0000">Wall: ' + wall + '(1)</font>';
    			if (metalalloys < 1) m+= '<br><FONT COLOR= "CC0000">Metal.: ' + metalalloys + '(1)</font>';
    			m+='</td>';
    	} 	
    }
    m+='</tr><TR valign=top align=right><TD style="background-color:'+Colors.OverviewDarkRow+';">'+uW.fortcost['frt62'][0]+'</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] == 15) blacksmith = Seed.buildings[city][y][1]; 
    	}
		wall = parseInt(Seed.buildings[city].pos1[1]);
		var WallSpace = 0;
		for (var b = 1; b < (wall + 1); b++) {WallSpace += (b * 1000)};
		max = (WallSpace/2/3).toFixed(0) - (parseInt(Seed.fortifications[city]["fort60"])*4) - (parseInt(Seed.fortifications[city]["fort61"])*1) - (parseInt(Seed.fortifications[city]["fort62"])*3);
    	m+=  '<TD width=79 style="background:#FFFFFF">'+Seed.fortifications[city]["fort62"];
    	if (wall >=2 && blacksmith>=2 && logging>=2 && max>0) m+= '<br>Left: ' + max+'</td>';
    	else if (t.showReq){
    			if (wall < 2) m+= '<br><FONT COLOR= "CC0000">Wall: ' + wall + '(2)</font>';
    			if (blacksmith < 2) m+= '<br><FONT COLOR= "CC0000">BlackS.: ' + blacksmith + '(2)</font>';
    			if (logging < 2) m+= '<br><FONT COLOR= "CC0000">Logg.: ' + logging + '(2)</font>';
    			m+='</td>';
    	} 	
    }
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">Feldabwehr</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	wall = parseInt(Seed.buildings[city].pos1[1]);
    	build = (parseInt(Seed.fortifications[city]["fort60"])*4)+ (parseInt(Seed.fortifications[city]["fort61"])*1) + (parseInt(Seed.fortifications[city]["fort62"])*3);
    	var WallSpace = 0;
		for (var b = 1; b < (wall + 1); b++) {WallSpace += (b * 1000)};
		max = WallSpace/2;
    	if (build < max) m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "CC0000">';
    	else m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "669900">';
    	m+= build+'</font>';
    	m+= '/' + max +'</td>';
    }
    m+='</tr><TR><TD colspan="8" style="background: #FFFFFF; border:none">&nbsp;</td></tr>';
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">Gebäude Slots</td>';
    
    for(i=0; i<Seed.cities.length; i++) {
    	var count=0;
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] >=5 && Seed.buildings[city][y][0] <19) count++;
    	}
    	if (count == 31) m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "669900">';
    	else m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "CC0000">';
    	m+= count + '</font> (31)</td>';
    }
    m+='</tr>';
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">Feldslots</td>';
    
    for(i=0; i<Seed.cities.length; i++) {
    	var count=0;
    	var castle=0;
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] == 0) castle = Seed.buildings[city][y][1];
    		if (Seed.buildings[city][y][0] >=1 && Seed.buildings[city][y][0] <=4) count++;
    	}
    	if (count == FieldSpace[castle]) m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "669900">';
    	else m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "CC0000">';
    	m+= count + '</font> ('+FieldSpace[castle]+')</td>';
    }
    m+='</tr>';
    for (b=0;b<20;b++){
    	m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+uW.buildingcost['bdg' + b][0]+'</td>';
        for (c=0;c<Seed.cities.length;c++){
        	m+='<TD style="width:79px; max-width:79px; word-wrap: break-word; background:#FFFFFF">';
        		city= 'city'+Seed.cities[c][0];
        		var count =0;
        		for (y in Seed.buildings[city]) {
        			if (Seed.buildings[city][y][0] == b) {
        				count++;
        				if (count > 1) m+=",";
        				if (Seed.buildings[city][y][1] >= 9) m+='<FONT COLOR= "669900">';
        				m+=Seed.buildings[city][y][1];
        				if (Seed.buildings[city][y][1] >= 9) m+='</font>';
        				
        			}
        		}
        		if (count == 0) {
        			m+='<FONT COLOR= "CC0000">0</font>';
        		}
        	m+='</td>';		
        }
        m+='</tr>';
    } 
    m+='</tr><TR><TD colspan="8" style="background: #FFFFFF; border:none">&nbsp;</td></tr>';
    for(i=0; i<Cities.numCities; i++) {
    }
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">Wächter</td>';
    for(i=0; i<Seed.cities.length; i++) {
     	for(g=0;g<Seed.guardian.length;g++) {
     		if (Seed.guardian[g]['cityId'] == Seed.cities[i][0] && Seed.guardian[g]['level']!=0) {
     			m += '<TD width=79 style="background:#FFFFFF">';
     			if (Seed.guardian[g]['level'] >=9) m+='<FONT COLOR= "669900">'; 
     			m+=Seed.guardian[g]['level']+"("+Seed.guardian[g]['type']+")</td>";
     			if (Seed.guardian[g]['level'] >=9) m+='</font>'; 
     		}
     		else {if (Seed.guardian[g]['cityId'] == Seed.cities[i][0] && Seed.guardian[g]['level']==0) m += '<TD width=79 style="background:#FFFFFF"><FONT COLOR= "CC0000">0</font></td>'};
    	}
    }
    m+='</tr></table><BR></table><DIV class=ptstat>FORSCHUNG STATS</div><TABLE class=ptBuilds  border=1px cellpadding=2 cellspacing=0><TR valign=top align=left>';
	
    for (i in uW.techcost) {
    	m+='<TD border=1px style="width:150px; background:#FFFFFF">'+uW.techcost[i][0]+'</td><TD align=center style="width:50px max-width:150px; background:#FFFFFF;">';
    	if (Seed.tech[i] >=9) m+='<FONT COLOR= "669900">';
    	if (Seed.tech[i] ==0) m+='<FONT COLOR= "CC0000">';
    	m+=Seed.tech[i];
    	if (Seed.tech[i] >=9 || Seed.tech[i] ==0) m+='</font>';
    	if (t.showReq) {
    		for(z=0; z<Seed.cities.length; z++) {
        		city = 'city'+Seed.cities[z][0];
        		for (y in Seed.buildings[city]) {
        			var farm,sawmill,quarry,mine,alchemylab,workshop,blacksmith,stable,storehouse,barracks = 0;
        			if (Seed.buildings[city][y][0] == 1 && Seed.buildings[city][y][0] > farm) farm = Seed.buildings[city][y][1]; 
        			if (Seed.buildings[city][y][0] == 2 && Seed.buildings[city][y][0] > sawmill) sawmill = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 3 && Seed.buildings[city][y][0] > quarry) quarry = Seed.buildings[city][y][1]; 
        			if (Seed.buildings[city][y][0] == 4 && Seed.buildings[city][y][0] > mine) mine = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 9) storehouse = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 11) alchemylab = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 13 && Seed.buildings[city][y][0] > barracks) barracks = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 15) blacksmith = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 16) workshop = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 17) stable = Seed.buildings[city][y][1];
        		}
        	}
        	m+='<FONT COLOR= "CC0000">';
    		switch (i) {
    			case '1': 
    				if (alchemylab < Seed.tech[i]) m+='<BR>Alchemie Labor '+ alchemylab+ '('+ (Seed.tech[i]) +')';
    				if (farm < Seed.tech[i]) m+='<BR>Farm '+ farm +'('+ (Seed.tech[i]+1) +')</td>';
    				break;
    			case '2': 
    				if (alchemylab < Seed.tech[i]) m+='<BR>Alchemie Labor '+ alchemylab+ '('+ (Seed.tech[i]) +')';
    				if (sawmill < Seed.tech[i]) m+='<BR>Sawmill '+ sawmill +'('+ (Seed.tech[i]) +')';
    				break;
    			case '3': 
    				if (alchemylab < Seed.tech[i]) m+='<BR>Alchemie Labor '+ alchemylab+ '('+ (Seed.tech[i]) +')';
    				if (quarry < Seed.tech[i]) m+='<BR>Quarry '+ quarry +'('+ (Seed.tech[i]) +')</td>';
    				break;
    			case '4': 
    				if (alchemylab < Seed.tech[i]) m+='<BR>Alchemie Labor '+ alchemylab+ '('+ (Seed.tech[i]) +')';
    				if (mine < Seed.tech[i]) m+='<BR>Mine '+ mine +'('+ (Seed.tech[i]) +')';
    				break;
    			case '5': 
    				if (alchemylab < 3) m+='<BR>Alchemie Labor '+ alchemylab +'(3)';
    				if (alchemylab >= 3 && alchemylab < Seed.tech[i]) m+='<BR>Alchemie Labor '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (workshop < Seed.tech[i]) m+='<BR>Workshop ' + workshop +'('+ (Seed.tech[i]) +')';
    				if (stoneworking < 2) m+='<BR>Stoneworking '+ stoneworking +'(2)';
    				break;
    			case '6': 
    				if (alchemylab < 3) m+='<BR>Alchemie Labor '+ alchemylab +'(3)';
    				if (alchemylab >= 3 && alchemylab < Seed.tech[i]) m+='<BR>Alchemie Labor '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				break;	
    			case '8': 
    				if (alchemylab < 2) m+='<BR>Alchemie Labor '+ alchemylab +'(2)';
    				if (alchemylab >= 2 && alchemylab < Seed.tech[i]) m+='<BR>Alchemie Labor '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (barracks < 2) m+='<BR>Barracks '+ barracks +'(2)';
    				break;		
    			case '9': 
    				if (alchemylab < 3) m+='<BR>Alchemie Labor '+ alchemylab +'(3)';
    				if (alchemylab >= 3 && alchemylab < Seed.tech[i]) m+='<BR>Alchemie Labor '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (blacksmith < Seed.tech[i]) m+='<BR>Blacksmith '+ blacksmith+'('+ (Seed.tech[i]) +')';
    				if (mining < Seed.tech[i]) m+='<BR>Mining '+ mining +'('+ (Seed.tech[i]) +')';
    				break;
    			case '10': 
    				if (alchemylab < 4) m+='<BR>Alchemie Labor '+ alchemylab +'(4)';
    				if (alchemylab >= 4 && alchemylab < Seed.tech[i]) m+='<BR>Alchemie Labor '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				break;
    			case '11': 
    				if (alchemylab < 4) m+='<BR>Alchemie Labor '+ alchemylab +'(4)';
    				if (alchemylab >= 4 && alchemylab < Seed.tech[i]) m+='<BR>Alchemie Labor '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				break;
    			case '12': 
    				if (alchemylab < 5) m+='<BR>Alchemie Labor '+ alchemylab +'(5)';
    				if (alchemylab >= 5 && alchemylab < Seed.tech[i]) m+='<BR>Alchemie Labor '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (stable < Seed.tech[i]) m+='<BR>Stable '+ stable +'('+ (Seed.tech[i]+1) +')';
    				if (metalalloys < Seed.tech[i]) m+='<BR>Metal Alloys '+ metalalloys +'('+ (Seed.tech[i]+1) +')';
    				break;
    			case '13': 
    				if (alchemylab < 4) m+='<BR>Alchemie Labor '+ alchemylab +'(4)';
    				if (alchemylab >= 4 && alchemylab < Seed.tech[i]) m+='<BR>Alchemie Labor '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (logging < 4) m+='<BR>Logging '+ logging +'(4)';
    				break;
    			case '14': 
    				if (alchemylab < 6) m+='<BR>Alchemie Labor '+ alchemylab +'(6)';
    				if (alchemylab >= 6 && alchemylab < Seed.tech[i]) m+='<BR>Alchemie Labor '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (storehouse < Seed.tech[i]) m+='<BR>Storehouse '+ storehouse +'('+ (Seed.tech[i]) +')';
    				if (logging < 3) m+='<BR>Logging '+ logging+'(3)';
    				break;
    			case '15': 
    				if (alchemylab < 6) m+='<BR>Alchemie-Labor '+ alchemylab +'(6)';
    				if (alchemylab >= 6 && alchemylab < Seed.tech[i]) m+='<BR>Alchemie Labor '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (featherweightpowder  < 3) m+='<BR>Featherweight Powder  '+ featherweightpowder +'(3)';
    				break;
    			case '16': 
    				if (alchemylab < 5) m+='<BR>Alchemie Labor '+ alchemylab +'(5)';
    				if (alchemylab >= 5 && alchemylab < Seed.tech[i]) m+='<BR>Alchemie Labor '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (logging  < 5) m+='<BR>Logging '+ logging +'(5)';
    				if (geometry  < 2) m+='<BR>Geometrie  '+ geometry +'(2)';
    				break;
    		}
    		m+='</font>';
    	}
    	m+='</td></tr>';
    }	
    m+='</table></div>';
	
    t.Overv.innerHTML = m;
    document.getElementById('showReq').addEventListener ('change', function (){
    	t.showReq = document.getElementById('showReq').checked;
    	t.showBuilds();
    },false);	
    t.displayTimer = setTimeout (t.showBuilds, 1000);
  },
  paintOld : function (){
    var rownum = 0;
      var t = Tabs.OverView;
    
        clearTimeout (t.displayTimer);
    
        function _row (name, row, noTotal){
          if (rownum++ % 2)
            style = '';
          else
            style = ' style = "background: #e8e8e8"';
          var tot = 0;
          var m = [];
          m.push ('<TR style="background: #fff" align=right');
          m.push (style);
          m.push ('><TD');
          m.push (style);
          m.push ('><B>');
          m.push (name);
          m.push (' &nbsp; </td>');
          if (noTotal){
            m.push ('<TD');
            m.push (style);
            m.push ('> &nbsp;</td>');
          } else {
            for (i=0; i<row.length; i++)
              tot += parseInt(row[i]);
            m.push ('<TD style="background: #600000;color: #FFF">');
    if (TEST_WIDE)
      m.push ('X,');        
            m.push (addCommas(tot));
            m.push ('</td>');
          }
          for (i=0; i<row.length; i++){
            m.push ('<TD');
            m.push (style);
            m.push ('>');
    if (TEST_WIDE)
      m.push ('X,');        
            m.push (addCommas(row[i]));
            m.push ('</td>');
          }
          m.push ('</tr>');
          return m.join('');
        }
        
    //DebugTimer.start();
        try {
    	Tabs.Marches.getMarchCount(0);
          if (Options.includeMarching)
            march = getMarchInfo ();
    
          dt = new Date ();
          dt.setTime (Seed.player.datejoinUnixTime * 1000);
		  
          str = '<DIV class=ptstat>HEILIGTUM STATS</div>';
          str += "<DIV id=overMainDiv style='font-size:"+ Options.overviewFontSize +"px'><TABLE class=ptTabOverview cellpadding=0 cellspacing=0><TR valign=top align=right><TD width=65><span class=pdxCapShadowRW><b>Stadt Name</b></span><br><span class=pdxCapShadowI>(Koordinate)<br>Provinz</td></span><TD width=88 style='background: #600000;color: #FFF'><span class=pdxCapShadow><center>Gesamt</center></span></td>";
      var currentCityId = unsafeWindow.currentcityid;
          for(i=0; i<Cities.numCities; i++) {
            if (Cities.cities[i].id == currentCityId) {
              var button = '<INPUT id="idGotoCity_'+i+ '" disabled="disabled" type=submit value='+ Cities.cities[i].name.substring(0,11) +' /><BR>';
              //str += "<TD width=81><B>"+ Cities.cities[i].name.substring(0,11) +'</b><BR\
              //        >'+ coordLink (Cities.cities[i].x, Cities.cities[i].y) +"<BR>\
              //        "+ unsafeWindow.provincenames['p'+ Cities.cities[i].provId] +"</td>";
              str += '<TD width=81>'+button + coordLink (Cities.cities[i].x, Cities.cities[i].y) +"<BR>\
                     <span class=pdxCapShadow>"+ unsafeWindow.provincenames['p'+ Cities.cities[i].provId] +"</span></td>";
            } else {
              var button = '<INPUT id="idGotoCity_'+i+ '" type=submit value='+ Cities.cities[i].name.substring(0,11) +' /><BR>';
              str += '<TD width=81>'+button + coordLink (Cities.cities[i].x, Cities.cities[i].y) +"<BR>\
                     <span class=pdxCapShadow>"+ unsafeWindow.provincenames['p'+ Cities.cities[i].provId] +"</span></td>";
            }
          }
    	  
    	  
          if (Options.includeMarching)
            str += '<TD width=81><span class=pdxCapShadowRW>Marsch</span></td>';
          str += "</tr>";
    	  str += '<tr align=right><TD style=\'background: #CCFFCC\' width=88 ><span class=pdxCapShadowRW>Verteidigung</span> &nbsp;</td><TD style=\'background: #CCFFCC\' ></td>';
    	      for(i=0; i<Cities.numCities; i++) {
              var mode = Seed.citystats["city" + Cities.cities[i].id].gate;
              str+='<TD style=\'background: #CCFFCC\'><center><INPUT id="idToggleDef_'+i+ '" type=submit value='+((mode==1)?'AN':'AUS')+' /></INPUT></center></td>';
          }
    
      if (Options.includeWachturm) {
    	  str += '<TR><TD style=\'background: #CCFFCC\'><SPAN class=pdxCapShadowRW><center>Wachturm</center></span></td><TD style=\'background: #CCFFCC\'></td>';
    	  for(i=0; i<Cities.numCities; i++){
    	    cityID = 'city'+Cities.cities[i].id;
    	    Gate = parseInt(Seed.citystats[cityID].gate);
    		if(Gate == 0)
    			str += '<TD style=\'background: #CCFFCC\'><center><span class=pdxCapShadow>Versteckt</span></center></td>';
    		else
    			str += '<TD style=\'background: #CCFFCC\' ><center><SPAN class=pdxCapShadowRed><blink>Verteidigung</blink></center></span></td>';
    
    	  }
      }
    
        if (Options.includeMaersche) {
          str += '<tr><TD style=\'background: #CCFFCC\' width=88 ><span class=pdxCapShadowRW><center>Märsche</center></span></td><TD style=\'background: #CCFFCC\' ></td>';
          for(i=0; i<Cities.numCities; i++) {
              str+='<TD  style=\'background: #CCFFCC\'><center>'+Tabs.Marches.counts[i]+'</center></td>';
          }
          str += "</tr>";
    	}
          rows = [];
          rows[0] = [];
          for(i=0; i<Cities.numCities; i++) {
            cityID = 'city'+ Cities.cities[i].id;
            rows[0][i] = parseInt(Seed.citystats[cityID].gold[0]);
          }
          for (r=1; r<5; r++){
            rows[r] = [];
            for(i=0; i<Cities.numCities; i++) {
              cityID = 'city'+ Cities.cities[i].id;
              rows[r][i] = parseInt(Seed.resources[cityID]['rec'+r][0] / 3600);
            }
          }
      
          if (Options.includeMarching){
            for (var i=0; i<5; i++)
              rows[i][Cities.numCities] = march.resources[i];
          }
    
          if (Options.includeRessis) {
          str += _row ('<span class=pdxCapShadowRR>Gold</span>', rows[0]);
          str += _row ('<span class=pdxCapShadowRR>Nahrung</span>', rows[1]);
          str += _row ('<span class=pdxCapShadowRR>Holz</span>', rows[2]);
          str += _row ('<span class=pdxCapShadowRR>Stein</span>', rows[3]);
          str += _row ('<span class=pdxCapShadowRR>Erz</span>', rows[4]);
     }
         for (r=1; r<13; r++){
            rows[r] = [];
        for(i=0; i<Cities.numCities; i++) {
                rows[r][i] = 0;
            }
        }
    
    
    		if (Options.includeCity){
    			 for (r=1; r<13; r++){
    				 for(i=0; i<Cities.numCities; i++) {
    					  cityID = 'city'+ Cities.cities[i].id;
    					  rows[r][i] = parseInt(Seed.units[cityID]['unt'+r]);
    				 }
    			 }
    		}
    	
    
          if (Options.includeMarching){
            for (var i=0; i<13; i++)
              rows[i][Cities.numCities] = march.marchUnits[i];
          }
    
          if (Options.includeTraining){
            var q = Seed.queue_unt;
            for(i=0; i<Cities.numCities; i++) {
              q = Seed.queue_unt['city'+ Cities.cities[i].id];
              if (q && q.length>0){
                for (qi=0; qi<q.length; qi++)
                  rows[q[qi][0]][i] += parseInt(q[qi][1]);
              }    
            }
          }
    
    	 if (Options.includeMarching){
            for (var i=0; i<13; i++)
              rows[i][Cities.numCities] = march.marchUnits[i];
          }
          if (Options.includeTraining){
            var q = Seed.queue_unt;
    
            for(i=0; i<Cities.numCities; i++) {
              q = Seed.queue_unt['city'+ Cities.cities[i].id];
              if (q && q.length>0){
                for (qi=0; qi<q.length; qi++)
                  rows[q[qi][0]][i] += parseInt(q[qi][1]);
              }    
            }
          }
        if (Options.includeNahrung) {
           row = [];
          for(i=0; i<Cities.numCities; i++) {
            var rp = getResourceProduction (Cities.cities[i].id);
            var usage = parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][3]);
            row[i] = rp[1] - usage;
          }
          str += '<TR><TD class=ptstat>Nahrung</td></tr>';
          str += _row ('<span class=pdxCapShadowRR>Verbrauch +/-</span>', row, true);
          
          for(i=0; i<Cities.numCities; i++) {
            if (row[i] >= 0)
              row[i] = '----';
            else {
              var timeLeft = parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][0]) / 3600 / (0-row[i]) * 3600;
              if (timeLeft > 86313600)
                row[i] = '----';
              else {
                if (Options.enableFoodWarn && timeLeft<(Options.foodWarnHours*3600))
                  row[i] = '<SPAN class=whiteOnRed>'+ timestrShort(timeLeft) +'</span>';
                else
                  row[i] = timestrShort(timeLeft);
              }
            }
          }    
          str += _row ('<span class=pdxCapShadowRR>Reicht für</span>', row, true);
          }
    //**********************************
        t_rows = [];
        for (r=2; r<26; r+=2){
            t_rows[r] = [];
            for(j=0; j<Cities.numCities; j++) {
           t_rows[r][j] = [0];
              cityID = 'city'+ Cities.cities[j].id;    
              var q = Seed.queue_unt[cityID];
              var supply_t=militia_t=scout_t=pike_t=sword_t=archer_t=cavalry_t=heavy_t=wagon_t=ballista_t=ram_t=catapult_t=0 ;     
               for (var i=0; i<q.length; i++){
            switch(q[i][0])
            {
              case '1':
              supply_t += parseInt(q[i][1]);
             break;
            case '2':
              militia_t += parseInt(q[i][1]);
              break;
            case '3':
              scout_t += parseInt(q[i][1]);
              break;
            case '4':
              pike_t += parseInt(q[i][1]);
              break;
            case '5':
              sword_t += parseInt(q[i][1]);
              break;
            case '6':
             archer_t += parseInt(q[i][1]);
              break;
            case '7':
              cavalry_t += parseInt(q[i][1]);
              break;
            case '8':
              heavy_t += parseInt(q[i][1]);
              break;
            case '9':
             wagon_t += parseInt(q[i][1]);
              break;
            case '10':
              ballista_t += parseInt(q[i][1]);
              break;
              case '11':
              ram_t += parseInt(q[i][1]);
              break;
            case '12':
              catapult_t += parseInt(q[i][1]);
                  break;
          }
            switch(r)
            {
              case 2:
              t_rows[r][j] = parseInt(supply_t);
            break;
              case 4:
              t_rows[r][j] = parseInt(militia_t);
            break;
              case 6:
              t_rows[r][j] = parseInt(scout_t);
            break;
              case 8:
              t_rows[r][j] = parseInt(pike_t);
            break;
              case 10:
              t_rows[r][j] = parseInt(sword_t);
            break;
              case 12:
              t_rows[r][j] = parseInt(archer_t);
            break;
              case 14:
              t_rows[r][j] = parseInt(cavalry_t);
            break;
              case 16:
              t_rows[r][j] = parseInt(heavy_t);
            break;
              case 18:
              t_rows[r][j] = parseInt(wagon_t);
            break;
              case 20:
              t_rows[r][j] = parseInt(ballista_t);
            break;
              case 22:
              t_rows[r][j] = parseInt(ram_t);
            break;
              case 24:
              t_rows[r][j] = parseInt(catapult_t);
            break;
            
          }
              }  
            }
        }    
          rownum = 0;
    
          if (Options.includeTruppen) {
        str += '<TR><TD class=ptstat>Truppen</td></tr>';
          rownum = 0;
          str += _row ('<span class=pdxCapShadowRR>Versorger</span>', rows[1]);
          str += _row ('<span class=pdxCapShadowRR>Miliz</span>', rows[2]);
          str += _row ('<span class=pdxCapShadowRR>Späher</span>', rows[3]);
          str += _row ('<span class=pdxCapShadowRR>Lanzen</span>', rows[4]);
          str += _row ('<span class=pdxCapShadowRR>Schwerter</span>', rows[5]);
          str += _row ('<span class=pdxCapShadowRR>Bogen</span>', rows[6]);
          str += _row ('<span class=pdxCapShadowRR>Kav</span>', rows[7]);
          str += _row ('<span class=pdxCapShadowRR>S-Kav</span>', rows[8]);
          str += _row ('<span class=pdxCapShadowRR>Wagen</span>', rows[9]);
          str += _row ('<span class=pdxCapShadowRR>Ballis</span>', rows[10]);
          str += _row ('<span class=pdxCapShadowRR>Ram</span>', rows[11]);
          str += _row ('<span class=pdxCapShadowRR>Katapulte</span>', rows[12]);
    
        
         if (Options.includeTraining) {
        var intmax = 0;
    str += '<TR><TD class=ptstat>Ausbildung</td></tr>';
          for (intt=0; intt<t_rows[2].length; intt++) {
             if (t_rows[2][intt] > intmax) {intmax = t_rows[2][intt]};
          }
    
          if (intmax > 0) {str += _row ('<SPAN class=pdxCapShadowSG>Versorger</SPAN>', t_rows[2])};
          var intmax = 0;
          for (intt=0; intt<t_rows[4].length; intt++) {
             if (t_rows[4][intt] > intmax) {intmax = t_rows[4][intt]};
          }
          if (intmax > 0) {str += _row ('<SPAN class=pdxCapShadowSG>Miliz</SPAN>', t_rows[4])};
          var intmax = 0;
          for (intt=0; intt<t_rows[6].length; intt++) {
             if (t_rows[6][intt] > intmax) {intmax = t_rows[6][intt]};
          }
          if (intmax > 0) {str += _row ('<SPAN class=pdxCapShadowSG>Späher</SPAN>', t_rows[6])};
          var intmax = 0;
          for (intt=0; intt<t_rows[8].length; intt++) {
             if (t_rows[8][intt] > intmax) {intmax = t_rows[8][intt]};
          }
          if (intmax > 0) {str += _row ('<SPAN class=pdxCapShadowSG>Lanzen</SPAN>', t_rows[8])};
          var intmax = 0;
          for (intt=0; intt<t_rows[10].length; intt++) {
             if (t_rows[10][intt] > intmax) {intmax = t_rows[10][intt]};
          }
          if (intmax > 0) {str += _row ('<SPAN class=pdxCapShadowSG>Schwerter</SPAN>', t_rows[10])};
          var intmax = 0;
          for (intt=0; intt<t_rows[12].length; intt++) {
             if (t_rows[12][intt] > intmax) {intmax = t_rows[12][intt]};
          }
          if (intmax > 0) {str += _row ('<SPAN class=pdxCapShadowSG>Bogen</SPAN>', t_rows[12])};
          var intmax = 0;
          for (intt=0; intt<t_rows[14].length; intt++) {
             if (t_rows[14][intt] > intmax) {intmax = t_rows[14][intt]};
          }
          if (intmax > 0) {str += _row ('<SPAN class=pdxCapShadowSG>Kav</SPAN>', t_rows[14])};
          var intmax = 0;
          for (intt=0; intt<t_rows[16].length; intt++) {
             if (t_rows[16][intt] > intmax) {intmax = t_rows[16][intt]};
          }
          if (intmax > 0) {str += _row ('<SPAN class=pdxCapShadowSG>S-Kav</SPAN>', t_rows[16])};
          var intmax = 0;
          for (intt=0; intt<t_rows[18].length; intt++) {
             if (t_rows[18][intt] > intmax) {intmax = t_rows[18][intt]};
          }
          if (intmax > 0) {str += _row ('<SPAN class=pdxCapShadowSG>Wagen</SPAN>', t_rows[18])};
          var intmax = 0;
          for (intt=0; intt<t_rows[20].length; intt++) {
             if (t_rows[20][intt] > intmax) {intmax = t_rows[20][intt]};
          }
          if (intmax > 0) {str += _row ('<SPAN class=pdxCapShadowSG>Ballisten</SPAN>', t_rows[20])};
          var intmax = 0;
          for (intt=0; intt<t_rows[22].length; intt++) {
             if (t_rows[22][intt] > intmax) {intmax = t_rows[22][intt]};
          }
          if (intmax > 0) {str += _row ('<SPAN class=pdxCapShadowSG>Ram</SPAN>', t_rows[22])};
          var intmax = 0;
          for (intt=0; intt<t_rows[24].length; intt++) {
             if (t_rows[24][intt] > intmax) {intmax = t_rows[24][intt]};
          }
          if (intmax > 0) {str += _row ('<SPAN class=pdxCapShadowSG>Steubschleuder</SPAN>', t_rows[24])};
          }
          str += '<TR><TD><BR></td></tr>';
      }
        if (Options.BauAnzeigen) {
        str += '<TR><TD class=ptstat>Gebäude</td></tr>';
            rowsnm = [];
            for (r=0; r<23; r++){
              rowsnm[r] = [];
            }
            for(i=0; i<Cities.numCities; i++) {
              cityID = 'city' + Cities.cities[i].id;
              getAllCityBuildings(cityID);
              rowsnm[0][i]  = sumCastle;
              rowsnm[1][i]  = sumCottage;
              rowsnm[2][i]  = sumTavern;
              rowsnm[3][i]  = sumKnightsHall;
              rowsnm[4][i]  = sumEmbassy;
              rowsnm[5][i]  = sumStorehouse;
              rowsnm[6][i]  = sumMarket;
              rowsnm[7][i]  = sumAlchemyLab;
              rowsnm[8][i]  = sumRallyPoint;
              rowsnm[9][i]  = sumBarracks;
              rowsnm[10][i] = sumWatchTower;
              rowsnm[11][i] = sumBlacksmith;
              rowsnm[12][i] = sumWorkshop;
              rowsnm[13][i] = sumStable;
              rowsnm[14][i] = sumReliefStation;
              rowsnm[15][i] = sumWall;
              rowsnm[16][i] = sumGuardian;
              rowsnm[17][i] = sumInside;
              rowsnm[18][i] = sumFarm;
              rowsnm[19][i] = sumSawmill;
              rowsnm[20][i] = sumQuarry;
              rowsnm[21][i] = sumMine;
              rowsnm[22][i] = sumOutside;
            }
            rownum = 0;
            str += _row ('<span class=pdxCapShadowSG>Labor</span>',  rowsnm[7], true);
            str += _row ('<span class=pdxCapShadowSG>Kasernen</span>',  rowsnm[9], true);
            str += _row ('<span class=pdxCapShadowSG>Schmied</span>',  rowsnm[11], true);
            str += _row ('<span class=pdxCapShadowSG>Schloss</span>',    rowsnm[0], true);
            str += _row ('<span class=pdxCapShadowSG>Hütte</span>',   rowsnm[1], true);
            str += _row ('<span class=pdxCapShadowSG>Botschaft</span>',   rowsnm[4], true);
            str += _row ('<span class=pdxCapShadowSG>Wächter</span>',  rowsnm[16], true);
            str += _row ('<span class=pdxCapShadowSG>Rittersaal</span>',   rowsnm[3], true);
            str += _row ('<span class=pdxCapShadowSG>Markt</span>',    rowsnm[6], true);
            str += _row ('<span class=pdxCapShadowSG>VP</span>',  rowsnm[8], true);
            str += _row ('<span class=pdxCapShadowSG>Hilfss.</span>', rowsnm[14], true);
            str += _row ('<span class=pdxCapShadowSG>Stallung</span>',    rowsnm[13], true);
            str += _row ('<span class=pdxCapShadowSG>Lagerhaus</span>',   rowsnm[5], true);
            str += _row ('<span class=pdxCapShadowSG>Wirtshaus</span>',    rowsnm[2], true);
            str += _row ('<span class=pdxCapShadowSG>Wachturm</span>',     rowsnm[10], true);
            str += _row ('<span class=pdxCapShadowSG>Mauer</span>',      rowsnm[15], true);
            str += _row ('<span class=pdxCapShadowSG>Werkstatt</span>',   rowsnm[12], true);
            str += _row ('<span class=pdxCapShadowSG>Stadt</span>',    rowsnm[17], true);
            str += _row ('<span class=pdxCapShadowSG>Bauernhof</span>',      rowsnm[18], true);
            str += _row ('<span class=pdxCapShadowSG>Sägewerk</span>',   rowsnm[19], true);
            str += _row ('<span class=pdxCapShadowSG>Steinbruch</span>',    rowsnm[20], true);
            str += _row ('<span class=pdxCapShadowSG>Bergwerk</span>',      rowsnm[21], true);
            str += _row ('<span class=pdxCapShadowSG>Feld</span>',   rowsnm[22], true);
          }
            if (Options.bevAnzeigen) {
            str += '<TR><TD class=ptstat>Bevölkerung</td></tr>';
            rowsnm = [];
            for (r=0; r<7; r++){
              rowsnm[r] = [];
            }
            for(i=0; i<Cities.numCities; i++) {
              cityID = 'city'+ Cities.cities[i].id;
              rowsnm[0][i] = parseInt(Seed.citystats[cityID]["pop"][1]);       // Max population
              rowsnm[1][i] = parseInt(Seed.citystats[cityID]["pop"][0]);       // Current population
              rowsnm[2][i] = parseInt(Seed.citystats[cityID]["pop"][3]);       // Labor force
              rowsnm[5][i] = parseInt(Seed.citystats[cityID]["pop"][2]);       // Happiness
              rowsnm[3][i] = rowsnm[0][i] * rowsnm[5][i] / 100 - rowsnm[2][i]; // Max Idle population
              rowsnm[4][i] = rowsnm[1][i] - rowsnm[2][i];                      // Current Idle population
              rowsnm[6][i] = parseInt(Seed.citystats[cityID]["gold"][1]);      // Tax
              if (rowsnm[6][i] > 0)
                rowsnm[6][i] = '<SPAN class=boldRed>' + rowsnm[6][i] + '</SPAN>';
            }
    
            rownum = 0;
            str += _row ('<span class=pdxCapShadowSG>Max. Bev.</span>',  rowsnm[0]);
            str += _row ('<span class=pdxCapShadowSG>Bevölkerung</span>',  rowsnm[1]);
            str += _row ('<span class=pdxCapShadowSG>Arbeiter</span>',  rowsnm[2]);
            str += _row ('<span class=pdxCapShadowSG>Max. Müßig</span>', rowsnm[3]);
            str += _row ('<span class=pdxCapShadowSG>Müßig</span>', rowsnm[4]);
            str += _row ('<span class=pdxCapShadowSG>% Glück</span>',  rowsnm[5], true);
            str += _row ('<span class=pdxCapShadowSG>Steuern</span>', rowsnm[6], true);
          }
      if (Options.defAnzeigen) {
            str += '<TR><TD class=ptstat>Mauer Def</td></tr>';
            rowsnm = [];
            for (r=0; r<5; r++){
              rowsnm[r] = [];
            }
            for(i=0; i<Cities.numCities; i++) {
              var wall = {};
              getWallInfo (Cities.cities[i].id, wall);
              rowsnm[0][i] = parseInt(wall.Crossbows);
              rowsnm[1][i] = parseInt(wall.Trebuchet);
              rowsnm[2][i] = parseInt(wall.Caltrops);
              if (isNaN(parseInt(wall.SpikedBarrier))) // KoC bug if wall lvl 0
                rowsnm[3][i] = 0;
              else
              rowsnm[3][i] = parseInt(wall.SpikedBarrier);
              rowsnm[4][i] = parseInt(wall.Trap);
            }
            if (Options.defBau){
              var q = Seed.queue_unt;
              for(i=0; i<Cities.numCities; i++) {
                var q = Seed.queue_fort['city'+Cities.cities[i].id];
                if (q && q.length>0){
                  for (qi=0; qi<q.length; qi++) {
                    if (q[qi][0]==53)
                      rowsnm[0][i] += parseInt(q[qi][1]);
                    if (q[qi][0]==55)
                      rowsnm[1][i] += parseInt(q[qi][1]);
                    if (q[qi][0]==60)
                      rowsnm[4][i] += parseInt(q[qi][1]);
                    if (q[qi][0]==61)
                      rowsnm[2][i] += parseInt(q[qi][1]);
                    if (q[qi][0]==62)
                      rowsnm[3][i] += parseInt(q[qi][1]);
                  }
                }
              }
            }
    
            rownum = 0;
            str += _row ('<span class=pdxCapShadowSG>Armbrüste</span>',  rowsnm[0]);
            str += _row ('<span class=pdxCapShadowSG>Trebuchet</span>',  rowsnm[1]);
            str += _row ('<span class=pdxCapShadowSG>Krähenfüße</span>',  rowsnm[2]);
            str += _row ('<span class=pdxCapShadowSG>Erdspieße</span>', rowsnm[3]);
            str += _row ('<span class=pdxCapShadowSG>Fallen</span>',  rowsnm[4]);
          }
        if (Options.includeNahrungUnten) {
          row = [];
          for(i=0; i<Cities.numCities; i++) {
            var rp = getResourceProduction (Cities.cities[i].id);
            var usage = parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][3]);
            row[i] = rp[1] - usage;
          }
           
          str += '<TR><TD class=ptstat>Nahrung</td></tr>';
          str += _row ('<span class=pdxCapShadowRR>Verbrauch +/-</span>', row, true);
          
          for(i=0; i<Cities.numCities; i++) {
            if (row[i] >= 0)
              row[i] = '----';
            else {
              var timeLeft = parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][0]) / 3600 / (0-row[i]) * 3600;
              if (timeLeft > 86313600)
    
                row[i] = '----';
              else {
                if (Options.enableFoodWarn && timeLeft<(Options.foodWarnHours*3600))
                  row[i] = '<SPAN class=whiteOnRed>'+ timestrShort(timeLeft) +'</span>';
                else
                  row[i] = timestrShort(timeLeft);
              }
            }
          }    
          str += _row ('<span class=pdxCapShadowRR>Reicht für</span>', row, true);
          }
        if (Options.includeInfos) {
          str += '<TR><TD class=ptstat>Info</td></tr>';
          row = [];
          for(i=0; i<Cities.numCities; i++) {
            var totWilds = 0;
            dat = Seed.wilderness['city'+ Cities.cities[i].id];
            if (dat!=null && matTypeof(dat)=='object')
              for (k in dat)
                ++totWilds;
            var castle = parseInt(Seed.buildings['city'+ Cities.cities[i].id].pos0[1]);
        if(castle == 11) castle = 12;
		else if(castle == 12) castle = 14;
            if (totWilds < castle)
              row[i] = '<SPAN class=boldRed><B>'+ totWilds +'/'+ castle +'</b></span>';
            else
              row[i] = totWilds +'/'+ castle;
          }
          str += _row ('<span class=pdxCapShadowRR>Wildnisse</span>', row, true);
      
          row = [];
          for(i=0; i<Cities.numCities; i++) {
            totKnights = 0;
            dat = Seed.knights['city'+ Cities.cities[i].id];
            for (k in dat)
              ++totKnights;
            row[i] = totKnights;
          }
          str += _row ('<span class=pdxCapShadowRR>Ritter</span>', row, true);
      
          var now = unixTime();
          var row = [];
          for(i=0; i<Cities.numCities; i++) {
            var totTime = 0;
            var q = Seed.queue_unt['city'+Cities.cities[i].id];
            if (q!=null && q.length>0)
              totTime = q[q.length-1][3] - now;
            if (totTime < 0)
              totTime = 0;
            if (totTime < 3600)
              row[i] = '<SPAN class=boldRed><B>'+ timestr(totTime) +'</b></span>';
            else
              row[i] = timestr(totTime);
          }
          str += _row ('<span class=pdxCapShadowRR>Warteschlange</span>', row, true);
          
          var row = [];
          for(i=0; i<Cities.numCities; i++) {
            var wall = {};
            getWallInfo (Cities.cities[i].id, wall);
            var totTime = 0;
            var q = Seed.queue_fort['city'+Cities.cities[i].id];
            if (q!=null && q.length>0)
              totTime = q[q.length-1][3] - now;
            if (totTime < 0)
              totTime = 0;
            if (totTime<1 && (wall.wallSpaceUsed < wall.wallSpace-4 || wall.fieldSpaceUsed < wall.fieldSpace-4))
              row[i] = '<SPAN class=boldRed><B>'+ timestr(totTime) +'</b></span>';
            else
              row[i] = timestr(totTime);
          }    
          str += _row ('<span class=pdxCapShadowRR>MauerBau</span>', row, true);
      }
    
           str += '<table width="696" border="0" cellspacing="0" cellpadding="0"><tr><td colspan="10">&nbsp;</td></tr><tr>\
        <td colspan="10"><b><u>Ansicht Einstellung</u></b></td></tr><tr>\
        <td width="20"><INPUT type=CHECKBOX id=ptIncWachturm'+ (Options.includeWachturm?' CHECKED':'') +'></td>\
        <td width="72">Wachturm</td><td width="20"><INPUT type=CHECKBOX id=ptIncMaersche'+ (Options.includeMaersche?' CHECKED':'') +'></td>\
        <td width="219">Märsche</td><td width="20"><INPUT type=CHECKBOX id=ptIncInfos'+ (Options.includeInfos?' CHECKED':'') +'></td>\
        <td width="55">Info</td><td width="20"><INPUT type=CHECKBOX id=ptbevAnzeigen'+ (Options.bevAnzeigen?' CHECKED':'') +'></td>\
        <td width="84">Bevölkerung</td><td colspan="2">Nahrungs Verbrauch: Oben <INPUT type=CHECKBOX id=ptIncNahrung'+ (Options.includeNahrung?' CHECKED':'') +'> Unten \
        <INPUT type=CHECKBOX id=ptIncNahrungUnten'+ (Options.includeNahrungUnten?' CHECKED':'') +'></td>\
      </tr> <tr><td height="20"><INPUT type=CHECKBOX id=ptIncTruppen'+ (Options.includeTruppen?' CHECKED':'') +'></td><td>Truppen</td>\
        <td><INPUT type=CHECKBOX id=ptoverOriginal'+ (Options.includeCity?' CHECKED':'') +'></td>\
        <td>Truppen in der Stadt! </td><td><INPUT type=CHECKBOX id=ptoverIncTraining'+ (Options.includeTraining?' CHECKED':'') +'></td>\
        <td colspan="3">Auszubildene Truppen</td><td colspan="2">Schriftgröße: '+ htmlSelector ({9:9, 10:10, 11:11, 12:12, 14:14}, Options.overviewFontSize, 'id=ptoverfont') +'</td>\
      </tr><tr> <td height="20"><INPUT type=CHECKBOX id=ptIncRessis'+ (Options.includeRessis?' CHECKED':'') +'></td>\
        <td>Ressourcen</td><td><INPUT type=CHECKBOX id=idCheck'+ (Options.includeMarching?' CHECKED':'') +'></td>\
        <td>Marschierende Truppen/Resourcen </td><td><INPUT type=CHECKBOX id=ptBauAnzeigen'+ (Options.BauAnzeigen?' CHECKED':'') +'></td>\
        <td>Gebäude</td><td><INPUT type=CHECKBOX id=ptdefAnzeigen'+ (Options.defAnzeigen?' CHECKED':'') +'></td>\
        <td>Mauer</td><td width="20"><INPUT type=CHECKBOX id=ptdefBau'+ (Options.defBau?' CHECKED':'') +'></td><td width="166">Mauer Bau</td>\
      </tr></table>';
      str += "</table></div>";
    //<INPUT type=CHECKBOX id=ptOverOver'+ (Options.overviewAllowOverflow?' CHECKED':'') +'>
          Tabs.OverView.Overv.innerHTML = str;
        document.getElementById('ptIncRessis').addEventListener('click', e_clickEnableRessis, false);
        document.getElementById('ptIncNahrungUnten').addEventListener('click', e_clickEnableNahrungUnten, false);
        document.getElementById('ptIncNahrung').addEventListener('click', e_clickEnableNahrung, false);
          document.getElementById('ptoverOriginal').addEventListener('click', e_clickEnableTroops, false);
         document.getElementById('ptIncWachturm').addEventListener('click', e_clickEnableWachturm, false);
              document.getElementById('ptIncMaersche').addEventListener('click', e_clickEnableMaersche, false);
          document.getElementById('idCheck').addEventListener('click', e_clickEnableMarch, false);
        document.getElementById('ptIncTruppen').addEventListener('click', e_clickEnableTruppen, false);
        document.getElementById('ptBauAnzeigen').addEventListener('click', e_clickEnableBauAnzeigen, false);
        document.getElementById('ptbevAnzeigen').addEventListener('click', e_clickEnablebevAnzeigen, false);
        document.getElementById('ptdefAnzeigen').addEventListener('click', e_clickEnabledefAnzeigen, false);
        document.getElementById('ptdefBau').addEventListener('click', e_clickEnabledefBau, false);
          document.getElementById('ptoverIncTraining').addEventListener('click', e_clickEnableTraining, false);
          //document.getElementById('ptOverOver').addEventListener('click', e_allowWidthOverflow, false);
          document.getElementById('ptoverfont').addEventListener('change', e_fontSize, false);
        document.getElementById('ptIncInfos').addEventListener('click', e_clickEnableInfos, false);
         for(i=0; i<Cities.numCities; i++) {
             var button = document.getElementById('idGotoCity_'+i);
             if (button) {
                button.addEventListener('click', function() { t.clickCity(this); }, false);
            }
          }
          for(i=0; i<Cities.numCities; i++) {
             var button = document.getElementById('idToggleDef_'+i);
             if (button) {
                button.addEventListener('click', function() { t.toggleDefence(this); }, false);
            }
          }
    //DebugTimer.display ('Draw Overview');    
        } catch (e){
          Tabs.OverView.cont.innerHTML = '<PRE>'+ e.name +' : '+ e.message +'</pre>';
        }   
        t.displayTimer = setTimeout (t.show, 5000);
    
        function e_clickEnableTroops (){
	      var t = Tabs.OverView;
          Options.includeCity = document.getElementById('ptoverOriginal').checked;
          t.show ();
        }
      function e_clickEnableWachturm (){
          var t = Tabs.OverView;
          Options.includeWachturm = document.getElementById('ptIncWachturm').checked;
          t.show ();
        }
        function e_clickEnableMaersche (){
          var t = Tabs.OverView;
          Options.includeMaersche = document.getElementById('ptIncMaersche').checked;
          t.show ();
        }
      function e_clickEnableRessis (){
          var t = Tabs.OverView;
          Options.includeRessis = document.getElementById('ptIncRessis').checked;
          t.show ();
        }
      function e_clickEnableNahrung (){
          var t = Tabs.Overview;
          Options.includeNahrung = document.getElementById('ptIncNahrung').checked;
          t.show ();
        }
       function e_clickEnableTruppen (){
          var t = Tabs.OverView;
          Options.includeTruppen = document.getElementById('ptIncTruppen').checked;
          t.show ();
        }
     function e_clickEnableBauAnzeigen (){
          var t = Tabs.OverView;
          Options.BauAnzeigen = document.getElementById('ptBauAnzeigen').checked;
          t.show ();
        }
       function e_clickEnablebevAnzeigen (){
          var t = Tabs.Overview;
          Options.bevAnzeigen = document.getElementById('ptbevAnzeigen').checked;
          t.show ();
        }
       function e_clickEnabledefAnzeigen (){
          var t = Tabs.OverView;
          Options.defAnzeigen = document.getElementById('ptdefAnzeigen').checked;
          t.show ();
        }
       function e_clickEnabledefBau (){
          var t = Tabs.OverView;
          Options.defBau = document.getElementById('ptdefBau').checked;
          t.show ();
        }
          function e_clickEnableNahrungUnten (){
          var t = Tabs.OverView;
          Options.includeNahrungUnten = document.getElementById('ptIncNahrungUnten').checked;
          t.show ();
        }
        function e_clickEnableMarch (){
          var t = Tabs.OverView;
          Options.includeMarching = document.getElementById('idCheck').checked;
          t.show ();
        }
        function e_clickEnableTraining (){
          var t = Tabs.OverView;
          Options.includeTraining = document.getElementById('ptoverIncTraining').checked;
          t.show ();
        }
      function e_clickEnableInfos (){
          var t = Tabs.OverView;
          Options.includeInfos = document.getElementById('ptIncInfos').checked;
          t.show ();
        }
        function e_fontSize(evt){
          document.getElementById('overMainDiv').style.fontSize = evt.target.value +'px';
          Options.overviewFontSize = evt.target.value;
        }
    /*
        function e_allowWidthOverflow (evt){
          var tf = document.getElementById('ptOverOver').checked;
          Options.overviewAllowOverflow = tf;
          if (tf)
            t.cont.style.overflowX = 'visible';
          else
            t.cont.style.overflowX = 'auto';
        }
    */
      },
      //The next two functions are from "KOC Attack Helper".
    ClickWin:function(win,obj,evtName) {
      var evt = win.document.createEvent("MouseEvents");
      evt.initMouseEvent(evtName, true, true, win,
        0, 0, 0, 0, 0, false, false, false, false, 0, null);
      return !obj.dispatchEvent(evt);
    },
    Click:function(obj) {
          var t = Tabs.OverView;
      return t.ClickWin(window,obj,'click');
    },
    clickCity : function (e) {
         var t = Tabs.OverView;
         if ( e ) {
           var m = e.id.split('_');
           var cityNum = parseInt(m[1])+1;
           var cityButton = document.getElementById('citysel_'+cityNum);
           if (cityButton) {
              t.Click(cityButton);
           }
         }
      },
      toggleDefence : function (e) {
         var t = Tabs.OverView;
         if ( e ) {
           var m = e.id.split('_');
           var cityId = Cities.cities[m[1]].id;
           var state = Seed.citystats["city" + cityId].gate;
           //flip state
           //logit ("Def state: "+state);
           if ( state == 1 )
              state = 0;
           else
              state = 1;
           //call to change state
           t.ajaxSetDefMode (cityId, state);
         }
      },
    //Modified from power bot - to toggle the defensive stance.
      ajaxSetDefMode : function (cityId, state){
         var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
         params.cid = cityId;
         params.state = parseInt(state);
         new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/gate.php" + unsafeWindow.g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (rslt) {
               if (rslt.ok) {
                  Seed.citystats["city" + cityId].gate = state;
                  //logit ("New state: "+state);
               }
            },
            onFailure: function () {
            }
         })
      },
   
    
};

/*************************************** MARCHES TAB ************************************************/

Tabs.Marches = {
  tabLabel : 'Marsch',
tabOrder : toMarsch,
  cont:null,
  displayTimer:null,
  curTabBut : null,
  curTabName : null,
  widescreen:true,
    
  init : function (div){
    var t = Tabs.Marches;
    unsafeWindow.pr56Recall = t.butRecall;
    unsafeWindow.r8x6Home = t.butSendHome;
    unsafeWindow.cancelMarch = t.butcancelmarch;
    
    t.cont = div;
    t.cont.innerHTML = '<TABLE class=ptTab align=center><div class=ptstat>MÄRSCHE, ANGRIFFE, VERSTÄRKUNG UND BARBAREN LAGER STATS</div><TR><TD><INPUT class=pbSubtab ID=ptmrchSubF type=submit value=Angriffe></td>\
          <TD><INPUT class=pbSubtab ID=ptmrchSubG type=submit value=Märsche></td>\
<TD><INPUT class=pbSubtab ID=ptmrchSubI type=submit value="Lager Stats"></td>\
          <TD><INPUT class=pbSubtab ID=ptmrchSubH type=submit value="Botschaft"></td></tr></table><HR class=ptThin>\
      <DIV id=ptMarchOutput style="margin-top:10px; background-color:white; height:680px; overflow:scroll;"></div>';
            
    t.marchDiv = document.getElementById('ptMarchOutput');
    document.getElementById('ptmrchSubF').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubG').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubH').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubI').addEventListener('click', e_butSubtab, false);
    changeSubtab (document.getElementById('ptmrchSub'+Options.curMarchTab));
    
    function e_butSubtab (evt){
      changeSubtab (evt.target);   
    }

    function changeSubtab (but){
      if (but == t.curTabBut)
        return;
      if (t.curTabBut){
        t.curTabBut.className='pbSubtab';
        t.curTabBut.disabled=false;
      }
      t.curTabBut = but;
      but.className='pbSubtab pbSubtabSel';
      but.disabled=true;
      t.curTabName = but.id.substr(9);
      Options.curMarchTab = t.curTabName;
      t.show ();
    }    
  },

  hide : function (){
    var t = Tabs.Marches;
    clearTimeout (t.displayTimer);
  },
  
  show : function (){
    var t = Tabs.Marches;
    clearTimeout (t.displayTimer);
    if (t.curTabName == 'H')
      t.showReinforcements();
    else if (t.curTabName == 'G')
      t.showMarches();
    else if (t.curTabName == 'I')
      t.showBarbSummary();
    else
      t.showIncoming();
  },
  
  /***   Incoming SUBTAB  ***/
      showIncoming : function (){
        var t = Tabs.Marches;
    var count = 0;
        t.marchDiv.innerHTML = null;  

        var z = '<TABLE id=pdincoming cellSpacing=10 width=100% height=0% class=ptTab><div class=ptstat>ANGRIFFE AUF DIE HEILIGTÜMER</div>';

        for (k in Seed.queue_atkinc) {
          if(Seed.queue_atkinc.length !=0){
        var now = unixTime();
        count+=1;
        var icon, status, FROM, cityname, FROMmight, marchdir, marchtime;
        var marchType = parseInt(Seed.queue_atkinc[k]["marchType"]);
        var marchStatus = parseInt(Seed.queue_atkinc[k]["marchStatus"]);
        
        for (var i=0; i<Seed.cities.length;i++) {
          if (Seed.cities[i][0] == Seed.queue_atkinc[k]["toCityId"]) cityname = Seed.cities[i][1];
        }   
      
        if (Seed.queue_atkinc[k]["destinationUnixTime"] < now || marchStatus == 8)
          marchdir = "returning";
        else
          marchdir = "going";  
        
        var destinationUnixTime = Seed.queue_atkinc[k]["arrivalTime"] - now;
        if(destinationUnixTime > 0)
          marchtime = timestr(destinationUnixTime, true)
        else
          marchtime = 'Arrived';
        
        if (marchType != 3 && marchType !=4){
          var player = Seed.players['u'+Seed.queue_atkinc[k]["fromPlayerId"]]
          FROM = player.n;
          FROMmight = player.m;
        }
        else {
          for (players in Seed.players){
            if (marchType == 3 || marchType == 4){
              if (('u'+Seed.queue_atkinc[k]["pid"]) == players){
                FROM = Seed.players[players]["n"];
                FROMmight = Seed.players[players]["m"];
              }
            }
          }
        }
        
        if (marchType == 2 && marchStatus == 2) marchType = 102;
        
        switch (marchType) {
          case 1: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/transporting.jpg";status="Transport";break;
          case 2: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/reinforce.jpg";status="Verstäkung";break;
          case 3: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/scouting.jpg";status="Spähen";break;
          case 4: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/attacking.jpg";status="Angriff";break;
          case 9: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/attacking.jpg";status="Angriff";break;
          case 5: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/transporting.jpg";status="Neu zurodnen";break;
          case 100: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/returning.jpg";status="Rückmarsch";break;
          case 102: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/reinforce.jpg";status="Lagernd";break;
        }
        
        if(status == 'Encamped')
          z += '<TD width="10px"><A onclick="r8x6Home('+ Seed.queue_atkinc[k].marchId +')"><img src='+ icon +'></a></td>';
        else
          z += '<TD width="10px"><img src='+ icon +'></td>';
        z += '<TD width="40px">'+ status +'</td>';
        z += '<TD>' + cityname + '</td>';
        z += '<TD>'+ marchtime +'</td>';
        z +='<TD>von: ' + FROM + '</td>';
        z +='<TD>Macht: ' + addCommas(FROMmight) + '</td>';
        if (Seed.queue_atkinc[k]["knt"] != undefined) z +='<TD>Ritter: '+ Seed.queue_atkinc[k]["knt"]["cbt"]+'</td>';
        
        if (Seed.queue_atkinc[k]["gold"] > 0) z += '<TD>Gold:'+ addCommas(Seed.queue_atkinc[k]["gold"]) +'</td>';
        if (Seed.queue_atkinc[k]["resource1"] > 0) z += '<TD>Nahrung: '+ addCommas(Seed.queue_atkinc[k]["resource1"]) +'</td>';
        if (Seed.queue_atkinc[k]["resource2"] > 0) z += '<TD>Holz: '+ addCommas(Seed.queue_atkinc[k]["resource2"]) +'</td>';
        if (Seed.queue_atkinc[k]["resource3"] > 0) z += '<TD>Stein: '+ addCommas(Seed.queue_atkinc[k]["resource3"]) +'</td>';
        if (Seed.queue_atkinc[k]["resource4"] > 0) z += '<TD>Erz: '+ addCommas(Seed.queue_atkinc[k]["resource4"]) +'</td>';
                
        for(i=1; i<13; i++){
          if(Seed.queue_atkinc[k]["unit"+i+"Count"] > 0 && marchdir == "going") z += '<TD>'+ unsafeWindow.unitcost['unt'+i][0] +': '+ addCommas(Seed.queue_atkinc[k]["unit"+i+"Count"]) +'</td>';
          if(Seed.queue_atkinc[k]["unit"+i+"Return"] > 0 && marchdir == "returning") z += '<TD>'+ unsafeWindow.unitcost['unt'+i][0] +': '+ addCommas(Seed.queue_atkinc[k]["unit"+i+"Return"]) +'</td>';
        }
            
        if (marchType == 3)
          if (Seed.queue_atkinc[k]["unts"]["u3"] > 0) z += '<TD>Scouts: '+ addCommas(Seed.queue_atkinc[k]["unts"]["u3"]) +'</td>';
        if (marchType == 4){
          for(ui=1; i<13; i++){
            if (Seed.queue_atkinc[k]["unts"]["u"+ui] > 0) z += '<TD>'+ unsafeWindow.unitcost['unt'+ui][0] +': '+ addCommas(Seed.queue_atkinc[k]["unts"]["u"+ui]) +'</td>';
          }
        }
        
        z += '</tr>';
          }
    }
     z += '</table>';
     t.marchDiv.innerHTML = z;
         if (count==0)
     t.marchDiv.innerHTML = '<TABLE id=pdincoming cellSpacing=10 width=100% height=0% class=ptTab><div class=ptstat>ANGRIFFE AUF DIE HEILIGTÜMER</div><BR><center><b>Du wirst zur Zeit nicht Angegriffen! :)</b></center>';
     t.displayTimer = setTimeout (t.showIncoming, 500);  
   },   
      
 	/***  BARB SUMMARY SUBTAB  ***/
	showBarbSummary : function (){
		var t = Tabs.Marches;

		var campsFound = 0;
		var minLevel = 11;
		var maxLevel = 0;
		var minTime = 1369526400;
		var maxTime = 0;
		var troopsLost = 'N';
		var bhcl = [];
		var bhc = [];
		var bhl = [];
		for (var c=0; c <= Cities.numCities; c++) {
			bhcl[c] = [];
			bhc[c] = [];
			bhc[c].count = 0;
			bhc[c].totaldist = 0;
			bhc[c].maxdist = 0;
			bhc[c].totalfood = 0;
			bhc[c].totaltime = 0;
			bhc[c].losses = 'N';
			bhc[c].totalscore = 0;
			for (var l=1; l < 11; l++){
				bhcl[c][l] = [];
				bhcl[c][l].count = 0;
				bhcl[c][l].totaldist = 0;
				bhcl[c][l].maxdist = 0;
				bhcl[c][l].totalfood = 0;
				bhcl[c][l].totaltime = 0;
				bhcl[c][l].losses = 'N';
				bhcl[c][l].totalscore = 0;
			}
		}
		for (var l=1; l < 11; l++){
			bhl[l] = [];
			bhl[l].count = 0;
			bhl[l].totaldist = 0;
			bhl[l].maxdist = 0;
			bhl[l].totalfood = 0;
			bhl[l].totaltime = 0;
			bhl[l].losses = 'N';
			bhl[l].totalscore = 0;
		}
		for (var c=1; c<= Cities.numCities; c++) {
			bhc[c].cityname = '<A onclick=\"ptGotoCity(' + c + ')\">' + Cities.cities[c-1].name + '</A>';
			for (var l=1; l < 11; l++)
				bhcl[c][l].cityname = '<A onclick=\"ptGotoCity(' + c + ')\">' + Cities.cities[c-1].name + '</A>';
		}
		var m5 = '<BR /><TABLE cellspacing=0 width=100%><TR align=center>';
		m5 += '<TH width=20%>Stadt</TH>';
		m5 += '<TH width=6%>Level</TH>';
		m5 += '<TH width=6% align=rightEntf.&nbsp;</TH>';
		m5 += '<TH width=8%>Zeit</TH>';
		m5 += '<TH width=9%>Koords</TH>';
		m5 += '<TH width=6% align=right>Nahrung</TH>';
		m5 += '<TH width=6%>Ritter</TH>';
		m5 += '<TH width=6%>Verluste</TH>';
		m5 += '<TH width=6%>Punkte</TH>';
		m5 += '<TH width=16%>Datum</TH>';
		m5 += '<TH width=11%></TH></TR>';
		for (bh=0; bh<barbHit.length; bh++) {
			campsFound++;
			var city      = barbHit[bh].city;
			var cityname  = '<A onclick=\"ptGotoCity(' + city + ')\">' + barbHit[bh].cityname + '</A>';
			var level     = barbHit[bh].level;
			var hitTime   = barbHit[bh].hitTime;
			var dist      = barbHit[bh].dist;
			var xy        = '<A onclick="ptGotoMap(' + barbHit[bh].x + ',' + barbHit[bh].y +')">'+ barbHit[bh].x + ',' + barbHit[bh].y + '</A>';
			var food      = barbHit[bh].food;
			var combat    = barbHit[bh].combat;
			var losses    = barbHit[bh].losses;
			var marchTime = barbHit[bh].marchTime;
			var score     = 0;
			bhcl[city][level].count++;
			bhcl[city][level].totaldist += dist;
			bhcl[city][level].totalfood += food;
			bhcl[city][level].totaltime += marchTime;
			if (dist > bhcl[city][level].maxdist)
				bhcl[city][level].maxdist = dist;
			bhc[city].count++;
			bhc[city].totaldist += dist;
			bhc[city].totalfood += food;
			bhc[city].totaltime += marchTime;
			if (dist > bhc[city].maxdist)
				bhc[city].maxdist = dist;
			bhl[level].count++;
			bhl[level].totaldist += dist;
			bhl[level].totalfood += food;
			bhl[level].totaltime += marchTime;
			if (dist > bhl[level].maxdist)
				bhl[level].maxdist = dist;
			if (level < minLevel)
				minLevel = level;
			if (level > maxLevel)
				maxLevel = level;
			if (hitTime < minTime)
				minTime = hitTime;
			if (hitTime > maxTime)
				maxTime = hitTime;
			if (losses == 'J') {
				troopsLost = 'J';
				bhcl[city][level].losses = 'J';
				bhc[city].losses = 'J';
				bhl[level].losses = 'J';
			} else { // only give a score if no troops were lost
				if (marchTime > 0) {
					score = 1000 * food / marchTime;
					bhcl[city][level].totalscore += score;
					bhc[city].totalscore += score;
					bhl[level].totalscore += score;
				}
			}
			m5 += '<TR align=center><TD>' + cityname + '</TD>';
			m5 += '<TD>' + level + '</TD>';
			m5 += '<TD align=right>' + show2DPs(dist) + '&nbsp;</TD>';
			m5 += '<TD align=right>' + timestrcolon(marchTime) + '&nbsp;</TD>';
			m5 += '<TD>' + xy + '</TD>';
			m5 += '<TD align=right>' + thouormil(food) + '&nbsp;&nbsp;&nbsp;&nbsp;</TD>';
			m5 += '<TD>' + combat + '</TD>';
			m5 += '<TD>' + losses + '</TD>';
			m5 += '<TD align=right>' + addCommas(parseInt(score)) + '&nbsp;&nbsp;&nbsp;</TD>';
			m5 += '<TD align=right>' + formatUnixTime(hitTime) + '</TD>';
			m5 += '<TD></TD></TR>';
		}
		m5 += '</TABLE>';

		var m3 = '<BR /><TABLE cellspacing=0 width=100%><TR align=center><TR>';
		m3 += '<TH width=20% valign=bottom>Stadt</TH>';
		m3 += '<TH width=6% valign=bottom>Level</TH>';
		m3 += '<TH width=5% valign=bottom>Treffer</TH>';
		m3 += '<TH width=7%>Gesamt<BR/>Nahrung</TH>';
		m3 += '<TH width=6%>Durchschnitt<BR/>Nahrung</TH>';
		m3 += '<TH width=6%>Gesamt<BR/>Entf.</TH>';
		m3 += '<TH width=6%>Durchschnitt<BR/>Entf.</TH>';
		m3 += '<TH width=6%>Max.<BR/>Entf.</TH>';
		m3 += '<TH width=8%>Gesamt<BR/>Zeit</TH>';
		m3 += '<TH width=6%><BR/>Verluste</TH>';
		m3 += '<TH width=7%>Gesamt<BR/>Punkte</TH>';
		m3 += '<TH width=6%>Durchscnitt<BR/>Punkte</TH>';
		m3 += '<TH width=11%></TH></TR>'
		for (var c=1; c<= Cities.numCities; c++) {
			for (var l=1; l < 11; l++) {
				if (bhcl[c][l].count > 0) {
					m3 += '<TR align=center><TD>' + bhcl[c][l].cityname + '</TD>';
					m3 += '<TD>' + l + '</TD>';
					m3 += '<TD align=right>' + bhcl[c][l].count + '&nbsp;&nbsp;</TD>';
					m3 += '<TD align=right>' + addCommas(bhcl[c][l].totalfood) + '&nbsp;&nbsp;</TD>';
					m3 += '<TD align=right>' + addCommas(parseInt(bhcl[c][l].totalfood/bhcl[c][l].count)) + '&nbsp;&nbsp;&nbsp;</TD>';
					m3 += '<TD align=right>' + addCommas(parseInt(bhcl[c][l].totaldist)) + '&nbsp;&nbsp;</TD>';
					m3 += '<TD align=right>' + show2DPs(parseInt((bhcl[c][l].totaldist/bhcl[c][l].count)*100)/100) + '&nbsp;&nbsp;</TD>';
					m3 += '<TD align=right>' + show2DPs(parseInt(bhcl[c][l].maxdist*100)/100) + '&nbsp;&nbsp;</TD>';
					m3 += '<TD align=right>' + timestrcolon(bhcl[c][l].totaltime) + '&nbsp;</TD>';
					m3 += '<TD>' + bhcl[c][l].losses + '</TD>';
					m3 += '<TD align=right>' + addCommas(parseInt(bhcl[c][l].totalscore)) + '&nbsp;&nbsp;&nbsp;</TD>';
					m3 += '<TD align=right>' + addCommas(parseInt(bhcl[c][l].totalscore/bhcl[c][l].count)) + '&nbsp;&nbsp;&nbsp;</TD>';
					m3 += '<TD></TD></TR>';
				}
			}
		}
		m3 += '</TABLE>';

		var m1 = '<BR /><TABLE cellspacing=0 width=100%><TR align=center><TR>';
		m1 += '<TH width=20% valign=bottom>Stadt</TH>';
		m1 += '<TH width=6%></TH>';
		m1 += '<TH width=5% valign=bottom>Treffer</TH>';
		m1 += '<TH width=7%>Gesamt<BR/>Nahrung</TH>';
		m1 += '<TH width=6%>Durchschnitt<BR/>Nahrung</TH>';
		m1 += '<TH width=6%>Gesamt<BR/>Entf.</TH>';
		m1 += '<TH width=6%>Durchschnitt<BR/>Entf.</TH>';
		m1 += '<TH width=6%>Max.<BR/>Entf.</TH>';
		m1 += '<TH width=8%>Gesamt<BR/>Zeit</TH>';
		m1 += '<TH width=6%><BR/>Verluste</TH>';
		m1 += '<TH width=7%>Gesamt<BR/>Punkte</TH>';
		m1 += '<TH width=6%>Durchschnitt<BR/>Punkte</TH>';
		m1 += '<TH width=11%></TH></TR>'
		for (var c=1; c<= Cities.numCities; c++) {
			if (bhc[c].count > 0) {
				m1 += '<TR align=center><TD>' + bhc[c].cityname + '</TD><TD></TD>';
				m1 += '<TD align=right>' + bhc[c].count + '&nbsp;&nbsp;</TD>';
				m1 += '<TD align=right>' + addCommas(bhc[c].totalfood) + '&nbsp;&nbsp;</TD>';
				m1 += '<TD align=right>' + addCommas(parseInt(bhc[c].totalfood/bhc[c].count)) + '&nbsp;&nbsp;&nbsp;</TD>';
				m1 += '<TD align=right>' + addCommas(parseInt(bhc[c].totaldist)) + '&nbsp;&nbsp;</TD>';
				m1 += '<TD align=right>' + show2DPs(parseInt((bhc[c].totaldist/bhc[c].count)*100)/100) + '&nbsp;&nbsp;</TD>';
				m1 += '<TD align=right>' + show2DPs(parseInt(bhc[c].maxdist*100)/100) + '&nbsp;&nbsp;</TD>';
				m1 += '<TD align=right>' + timestrcolon(bhc[c].totaltime) + '&nbsp;</TD>';
				m1 += '<TD>' + bhc[c].losses + '</TD>';
				m1 += '<TD align=right>' + addCommas(parseInt(bhc[c].totalscore)) + '&nbsp;&nbsp;&nbsp;</TD>';
				m1 += '<TD align=right>' + addCommas(parseInt(bhc[c].totalscore/bhc[c].count)) + '&nbsp;&nbsp;&nbsp;</TD>';
				m1 += '<TD></TD></TR>';
			}
		}
		m1 += '</TABLE>';

		var m2 = '<BR /><TABLE cellspacing=0 width=100%><TR align=center><TR>';
		m2 += '<TH width=20%>&nbsp;</TH>';
		m2 += '<TH width=6% valign=bottom>Level</TH>';
		m2 += '<TH width=5% valign=bottom>Treffer</TH>';
		m2 += '<TH width=7%>Gesamt<BR/>Nahrung</TH>';
		m2 += '<TH width=6%>Durchschnitt<BR/>Nahrung</TH>';
		m2 += '<TH width=6%>Gesamt<BR/>Entf.</TH>';
		m2 += '<TH width=6%>Durchschnitt<BR/>Entf.</TH>';
		m2 += '<TH width=6%>Max.<BR/>Entf.</TH>';
		m2 += '<TH width=8%>Gesamt<BR/>Zeit</TH>';
		m2 += '<TH width=6%>Durchschnitt<BR/>Verluste</TH>';
		m2 += '<TH width=7%>Gesamt<BR/>Punkte</TH>';
		m2 += '<TH width=6%>Durchschnitt<BR/>Punkte</TH>';
		m2 += '<TH width=11%></TH></TR>'
			for (var l=1; l < 11; l++) {
				if (bhl[l].count > 0) {
					m2 += '<TR align=center><TD></TD><TD>' + l + '</TD>';
					m2 += '<TD align=right>' + bhl[l].count + '&nbsp;&nbsp;</TD>';
					m2 += '<TD align=right>' + addCommas(bhl[l].totalfood) + '&nbsp;&nbsp;</TD>';
					m2 += '<TD align=right>' + addCommas(parseInt(bhl[l].totalfood/bhl[l].count)) + '&nbsp;&nbsp;&nbsp;</TD>';
					m2 += '<TD align=right>' + addCommas(parseInt(bhl[l].totaldist)) + '&nbsp;&nbsp;</TD>';
					m2 += '<TD align=right>' + show2DPs(parseInt((bhl[l].totaldist/bhl[l].count)*100)/100) + '&nbsp;&nbsp;</TD>';
					m2 += '<TD align=right>' + show2DPs(parseInt(bhl[l].maxdist*100)/100) + '&nbsp;&nbsp;</TD>';
					m2 += '<TD align=right>' + timestrcolon(bhl[l].totaltime) + '&nbsp;</TD>';
					m2 += '<TD>' + bhl[l].losses + '</TD>';
					m2 += '<TD align=right>' + addCommas(parseInt(bhl[l].totalscore)) + '&nbsp;&nbsp;&nbsp;</TD>';
					m2 += '<TD align=right>' + addCommas(parseInt(bhl[l].totalscore/bhl[l].count)) + '&nbsp;&nbsp;&nbsp;</TD>';
					m2 += '<TD></TD></TR>';
				}
			}
		m2 += '</TABLE>';

		var m4 = '<BR /><TABLE cellspacing=0 width=100%><TR align=center><TR>';
		m4 += '<TH width=20% valign=bottom>Stadt</TH>';
		m4 += '<TH width=6% valign=bottom>Level</TH>';
		m4 += '<TH width=5% valign=bottom>Treffer</TH>';
		m4 += '<TH width=7%>Gesamt<BR/>Nahrung</TH>';
		m4 += '<TH width=6%>Durchschnitt<BR/>Nahrung</TH>';
		m4 += '<TH width=6%>Gesamt<BR/>Entf.</TH>';
		m4 += '<TH width=6%>Durchschnitt<BR/>Entf.</TH>';
		m4 += '<TH width=6%>Max<BR/>Entf.</TH>';
		m4 += '<TH width=8%>Gesamt<BR/>Zeit</TH>';
		m4 += '<TH width=6%><BR/>Verluste</TH>';
		m4 += '<TH width=7%>Gesamt<BR/>Punkte</TH>';
		m4 += '<TH width=6%>Durchschnitt<BR/>Punkte</TH>';
		m4 += '<TH width=11%></TH></TR>'
		for (var l=1; l < 11; l++) {
			for (var c=1; c<= Cities.numCities; c++) {
				if (bhcl[c][l].count > 0) {
					m4 += '<TR align=center><TD>' + bhcl[c][l].cityname + '</TD>';
					m4 += '<TD>' + l + '</TD>';
					m4 += '<TD align=right>' + bhcl[c][l].count + '&nbsp;&nbsp;</TD>';
					m4 += '<TD align=right>' + addCommas(bhcl[c][l].totalfood) + '&nbsp;&nbsp;</TD>';
					m4 += '<TD align=right>' + addCommas(parseInt(bhcl[c][l].totalfood/bhcl[c][l].count)) + '&nbsp;&nbsp;&nbsp;</TD>';
					m4 += '<TD align=right>' + addCommas(parseInt(bhcl[c][l].totaldist)) + '&nbsp;&nbsp;</TD>';
					m4 += '<TD align=right>' + show2DPs(parseInt((bhcl[c][l].totaldist/bhcl[c][l].count)*100)/100) + '&nbsp;&nbsp;</TD>';
					m4 += '<TD align=right>' + show2DPs(parseInt(bhcl[c][l].maxdist*100)/100) + '&nbsp;&nbsp;</TD>';
					m4 += '<TD align=right>' + timestrcolon(bhcl[c][l].totaltime) + '&nbsp;</TD>';
					m4 += '<TD>' + bhcl[c][l].losses + '</TD>';
					m4 += '<TD align=right>' + addCommas(parseInt(bhcl[c][l].totalscore)) + '&nbsp;&nbsp;&nbsp;</TD>';
					m4 += '<TD align=right>' + addCommas(parseInt(bhcl[c][l].totalscore/bhcl[c][l].count)) + '&nbsp;&nbsp;&nbsp;</TD>';
					m4 += '<TD></TD></TR>';
				}
			}
		}
		m4 += '</TABLE>';

		var mheader = '<DIV class=ptstat>BARBAREN LAGER STATS</div>Barbaren Lager: ' + addCommas(campsFound);
		if (campsFound > 0) {
			minTime = formatUnixTime(minTime);
			maxTime = formatUnixTime(maxTime);
			if (minTime.substr(0,6) == maxTime.substr(0,6))
				maxTime = maxTime.substr(8,8);
			mheader += ' - Level: ' + minLevel + ' - ' + maxLevel + '; vom ' + minTime + ' bis ' + maxTime;
			if (troopsLost == 'N')
				mheader += ' <SPAN class=boldDarkGreen>und du hast keine Truppen verloren :)</span>';
			else
				mheader += ' <SPAN class=boldRed>leider hast du hast Truppen verloren :/</span>';
			mheader += '<BR />';
		}

		var m6 = '<DIV class=ptstat>BARBAREN LAGER STATS</div><b><u>Hinweis</u></b>: Die Daten für die Barbaren Lager bekommst du nach einem Refresh und auch nur für die Lager wo die Angriffe bis zum Refresh zurück gekommen sind!<BR />';
		m6 += '<BR />';

		if (barbHit.length == 0)
			t.marchDiv.innerHTML = m6;
		else
			t.marchDiv.innerHTML = mheader + m1 + m2 + m3 + m4 + m5 + m6;
	},       
  /***   MARCHES SUBTAB  ***/
    showMarches : function (){
      var t = Tabs.Marches;
      t.marchDiv.innerHTML =null;  
      var updatemarch = Seed.queue_atkp;
     
     var  m = '<TABLE id=pdmarches cellSpacing=10 width=200px height=0% class=ptTab>';
     m += '<div class=ptstat>TRUPPENBEWEGUNG</div>';
     if (t.widescreen) m += '<TR><TD><INPUT id=Wide type=checkbox checked=true>Widescreen</td>';
    else  m += '<TR><TD><INPUT id=Wide type=checkbox unchecked=true>Widescreen</td></tr></table>';
	m+='<TABLE id=pdmarches cellSpacing=10 width=100% height=0% class=pbTab>';
     for (var c=0; c< Seed.cities.length;c++) {
         cityname = Seed.cities[c][1];
         cityID = 'city' + Seed.cities[c][0];    
        number=0;  
        
        if (Seed.queue_atkp[cityID].length !=0) m+= '<TR><TD colspan=5 align=center><B><DIV class=ptstat>' + cityname +' </div></b></td></tr>';
          for (k in Seed.queue_atkp[cityID]){
          if (Seed.queue_atkp[cityID].length !=0) {
              var marchID = new String(k);
              marchID = marchID.substr(1);
              var marchType = parseInt(Seed.queue_atkp[cityID][k]["marchType"]);
              var marchStatus = parseInt(Seed.queue_atkp[cityID][k]["marchStatus"]);
              var now = unixTime();

              cityTo = null;
              number++;
          var icon, status, type, cityTo, knight, marchtime;
              
              for (var i=0; i<Seed.cities.length;i++) {
                  if (Seed.cities[i][2] == Seed.queue_atkp[cityID][k]["toXCoord"] && Seed.cities[i][3] == Seed.queue_atkp[cityID][k]["toYCoord"]) cityTo = Seed.cities[i][1];
              }
              
              //for (var i=0; i<Seed.cities.length;i++) {
          //  if (Seed.cities[i][2] == Seed.queue_atkp[cityID][k]["toCityId"]) cityTo = Seed.cities[i][1];
              //}
              
              var destinationUnixTime = Seed.queue_atkp[cityID][k]["destinationUnixTime"] - now;
              var returnUnixTime = Seed.queue_atkp[cityID][k]["returnUnixTime"] - now;
              var encampedUnixTime = now - Seed.queue_atkp[cityID][k]["destinationUnixTime"];
          var restingUnixTime = now - Seed.queue_atkp[cityID][k]["returnUnixTime"];
          
              if (Seed.queue_atkp[cityID][k]["destinationUnixTime"] > now)
            marchtime = timestr(destinationUnixTime, true);
              else
            marchtime = timestr(returnUnixTime, true);
              
              if (Seed.queue_atkp[cityID][k]["destinationUnixTime"] < now && marchType == 2)
            marchtime = timestr(encampedUnixTime, true);
          if (Seed.queue_atkp[cityID][k]["returnUnixTime"] < now && marchType == 9)
            marchtime = timestr(restingUnixTime, true);
            
              if (Seed.queue_atkp[cityID][k]["destinationUnixTime"] < now || marchStatus == 8)
            type = "returning";
              else
            type = "going";
             
          if(Seed.queue_atkp[cityID][k]["destinationUnixTime"] < now){
            if (marchStatus == 8)
              marchtime = timestr(returnUnixTime, true);
            if (type =="returning" && marchType == 2 && marchStatus != 2)
              marchtime = timestr(returnUnixTime, true);
            if (type =="returning" && marchType == 4 && marchStatus == 2)
              marchtime = timestr(returnUnixTime, true);
            if (marchStatus == 2 && marchType !=2)
              marchtime = timestr(returnUnixTime, true);
          }
              if (parseInt(Seed.queue_atkp[cityID][k]["marchType"]) == 4 && marchStatus == 2)
            marchtime = timestr(destinationUnixTime, true);;
              
          
          if (type =="returning" && marchType != 2)
            marchType = 8;
              if (type =="returning" && marchType == 2 && marchStatus == 2)
            marchType = 102;
              if (type =="returning" && marchType == 2 && marchStatus != 2)
            marchType = 8;
              if (marchStatus == 3)
              marchType = 103;
          if (marchStatus == 4)
              marchType = 104;
          
          
              if (parseInt(Seed.queue_atkp[cityID][k]["marchType"]) == 4 && marchStatus == 2) {
              marchType = 102;
              marchtime = timestr(encampedUnixTime, true)
              }
  
              switch (marchType) {
                case 1: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/transporting.jpg";status="Transport";break;
                case 2: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/reinforce.jpg";status="Verstärken";break;
                case 3: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/scouting.jpg";status="Spähen";break;
                case 4: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/attacking.jpg";status="Angriff";break;
                case 5: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/transporting.jpg";status="Neu zuordnen";break;
                case 8: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/returning.jpg";status="Rückmarsch";break;
                case 9: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/attacking.jpg";status="Farmen";break;
                case 102: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/reinforce.jpg";status="Lagernd";break;
            case 103: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/autoAttack/raid_stopped_desat.png";status="Angehalten";break;
            case 104: icon="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/autoAttack/raid_resting.png";status="Warte";break;
              }
                            
              if (Seed.queue_atkp[cityID][k]["knightId"] !=0){
                for (i in Seed.knights[cityID]) {
                    if (i == ("knt" + Seed.queue_atkp[cityID][k]["knightId"]) ) knight = Seed.knights[cityID][i]["combat"];
                }
              } else knight = null;
              
              m += '<TR><TD>'+ number +'</td>';
             if (status=="Encamped" && !t.isMyself(Seed.queue_atkp[cityID][k].fromPlayerId))
            m += '<TD><A onclick="r8x6Home('+ marchID +')"><img src='+ icon +'></a></td>';
             else if(status=='Lagernd' && t.isMyself(Seed.queue_atkp[cityID][k].fromPlayerId))
            m += '<TD><A onclick="pr56Recall('+ marchID +')"><img src='+ icon +'></a></td>';
          else if(status=='Rückmarsch' || status=="Angehalten" || status=="Warte")
            m += '<TD><img src='+ icon +'></td>';
          else
            m += '<TD><A onclick="cancelMarch('+ marchID +')"><img src='+ icon +'></a></td>';
              m += '<TD width="40px">'+ status +'</td>';
              m += '<TD>'+ marchtime +'</td>';
              
              if (cityTo == null)
            m += '<TD style="padding-right:10px;">'+ coordLink(Seed.queue_atkp[cityID][k]["toXCoord"],Seed.queue_atkp[cityID][k]["toYCoord"]) + '</td>';
              else
            m += '<TD style="padding-right:10px;">'+ cityTo +'</td>';
              
              if (knight != null)  m += '<TD>R:'+ knight +'</td>';
              
              if (Seed.queue_atkp[cityID][k]["toTileType"] == 11) m+='<TD>See Lvl: ' + Seed.queue_atkp[cityID][k]["toTileLevel"] + '</td>';
              else if (Seed.queue_atkp[cityID][k]["toTileType"] == 20) m+='<TD>Grassland Lvl: ' + Seed.queue_atkp[cityID][k]["toTileLevel"] + '</td>';
              else if (Seed.queue_atkp[cityID][k]["toTileType"] == 30) m+='<TD>Hügel Lvl: ' + Seed.queue_atkp[cityID][k]["toTileLevel"] + '</td>';
              else if (Seed.queue_atkp[cityID][k]["toTileType"] == 40) m+='<TD>Berg Lvl: ' + Seed.queue_atkp[cityID][k]["toTileLevel"] + '</td>';
              else if (Seed.queue_atkp[cityID][k]["toTileType"] == 50) m+='<TD>Ebene Lvl: ' + Seed.queue_atkp[cityID][k]["toTileLevel"] + '</td>';
            else if (Seed.queue_atkp[cityID][k]["toCityId"] ==0) m +='<TD>Barbaren Lvl: '+Seed.queue_atkp[cityID][k]["toTileLevel"]+'</td>';
      
              if (Seed.queue_atkp[cityID][k]["gold"] > 0) m += '<TD>Gold:'+ Seed.queue_atkp[cityID][k]["gold"] +'</td>';
              if (Seed.queue_atkp[cityID][k]["resource1"] > 0) m += '<TD>Nahrung: '+ addCommas(Seed.queue_atkp[cityID][k]["resource1"]) +'</td>';
              if (Seed.queue_atkp[cityID][k]["resource2"] > 0) m += '<TD>Holz: '+ addCommas(Seed.queue_atkp[cityID][k]["resource2"]) +'</td>';
              if (Seed.queue_atkp[cityID][k]["resource3"] > 0) m += '<TD>Stein: '+ addCommas(Seed.queue_atkp[cityID][k]["resource3"]) +'</td>';
              if (Seed.queue_atkp[cityID][k]["resource4"] > 0) m += '<TD>Erz: '+ addCommas(Seed.queue_atkp[cityID][k]["resource4"]) +'</td>';
              
              for(i=1; i<13; i++){
            if(Seed.queue_atkp[cityID][k]["unit"+i+"Count"] > 0 && type == "going") m += '<TD>'+ unsafeWindow.unitcost['unt'+i][0] +': '+ addCommas(Seed.queue_atkp[cityID][k]["unit"+i+"Count"]) +'</td>';
            if(Seed.queue_atkp[cityID][k]["unit"+i+"Return"] > 0 && type == "returning") m += '<TD>'+ unsafeWindow.unitcost['unt'+i][0] +': '+ addCommas(Seed.queue_atkp[cityID][k]["unit"+i+"Return"]) +'</td>';
          }
          m += '</tr>';
        }
          }
    }
    m += '</table>';
    t.marchDiv.innerHTML = m;
    
    if (t.widescreen==false) document.getElementById('ptMarchOutput').style.maxWidth = '740px';
    else document.getElementById('ptMarchOutput').style.maxWidth = '1100px';
    
    document.getElementById('Wide').addEventListener('click', function(){
      t.widescreen=document.getElementById('Wide').checked;  
    }, false);
    
    
    document.getElementById('TEST').addEventListener('click', function(){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
        new AjaxRequest(unsafeWindow.g_ajaxpath + "/fb/e2/src/main_src.php?g=&y=0&n=nan001&l=nl_NL&messagebox=&standalone=0&res=1&iframe=1&lang=en&ts=1304248288.7067&s=250&appBar=" + unsafeWindow.g_ajaxsuffix, {
            method: "POST",
            parameters: params,
            onSuccess: function (rslt) {
                //rslt = eval("(" + message + ")");
                var mainSrcHTMLCode = rslt.responseText;
              //var mainSrcHTMLCode; // get and set this by pulling in the main_src.php file via AJAX
              var myregexp = /var seed=\{.*?\};/;
              var match = myregexp.exec(mainSrcHTMLCode);
              
              if (match != null) {
              result = match[0];
              result = result.substr(4);
              var seed = eval(result);
              WinLog.write ("seed @ "+ unixTime()  +" ("+ now +")\n\n"+ inspect (seed, 8, 1));
              unsafeWindow.document.seed = result;
              unsafeWindow.update_seed(result);
              }
            },
            onFailure: function () {
              if (notify != null)
                notify(rslt.errorMsg);
            },
        });
  
    }, false);
           
    t.displayTimer = setTimeout (t.showMarches, 500);  
    },
  
  isMyself: function(userID){
    if(!Seed.players["u"+userID])
      return false;
    if(Seed.players["u"+userID].n == Seed.player.name)
      return true;
    else
      return false;
    return false;
  },
    
    butcancelmarch: function(marchID){
       var t = Tabs.Marches;
          var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
          params.mid = marchID;
           for (var c=0; c<Cities.numCities; c++){
            var que = Seed.queue_atkp['city'+ Cities.cities[c].id];
            if (matTypeof(que)=='array')
              continue;
            for (k in que){
              if (k == 'm'+marchID){
                params.cid = Cities.cities[c].id;
                break;
              }
            }    
          }    
          
          new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/cancelMarch.php" + unsafeWindow.g_ajaxsuffix, {
              method: "post",
              parameters: params,
              onSuccess: function (rslt) {
              var march = unsafeWindow.seed.queue_atkp["city" + params.cid]["m" + params.mid];
              march.marchStatus = 8;
               var marchtime = parseInt(march.returnUnixTime) - parseInt(march.destinationUnixTime);
               var ut = unixTime();
               if (unsafeWindow.seed.playerEffects.returnExpire > unixtime())
                 marchtime *= 0.5
                march.returnUnixTime = ut + marchtime;
                march.destinationUnixTime = ut;
                march.marchUnixTime = ut - marchtime;
                if (notify != null)
                  notify(rslt.errorMsg);
              },
              onFailure: function () {
                if (notify != null)
                  notify(rslt.errorMsg);
              },
          });
          
       },    
       
           
      
  /***  REINFORCEMENTS SUBTAB  ***/
  showReinforcements : function (){
    var rownum = 0;
    var names = ['Versorger', 'Miliz', 'Späher', 'Lanzen', 'Schwerter', 'Bogen', 'Kav', 'S-Kav', 'Wagen', 'Ballis', 'Ram', 'Kats'];
    var t = Tabs.Marches;
    clearTimeout (t.displayTimer);
    
// TODO FIX:    Troops show as encamped even if they are here yet (check destinationUnixTime)

/***    
var s = 'OUTGOING:<BR>';
for (var c=0; c<Cities.numCities; c++){
  var que = Seed.queue_atkp['city'+ Cities.cities[c].id];
  if (matTypeof(que)=='array')
    continue;

s += 'City: '+  Cities.cities[c].name + ': <BR>';

  for (k in que){
    march = que[k];
    var mid = k.substr(1);
    s += mid +' DEST: '+ march.toXCoord +','+ march.toYCoord + '  <INPUT type=submit value="Recall" onclick="pr56Recall('+ mid +')"><BR>'
  }      
}
t.cont.innerHTML = s;
t.displayTimer = setTimeout (t.show, 10000);
return;
***/
    
    function clickShowRemaining (){
      checkBox = document.getElementById('idCheck2');
      if (checkBox.checked)
        Options.encRemaining = false;
      else
        Options.encRemaining = true;
      t.show ();
    }
        
    enc = {};
    numSlots = 0;
    
    if (matTypeof(Seed.queue_atkinc) != 'array'){
      for (k in Seed.queue_atkinc){
        march = Seed.queue_atkinc[k];

        if (march.marchType == 2){
          ++numSlots;
          city = march.toCityId;
          from = march.fromPlayerId;
          if (!enc[city])
            enc[city] = {};
          if (!enc[city][from])
            enc[city][from] = [];
          s = {};
          s.knight = parseInt (march.knightCombat);
          s.marchId = k.substr(1);
          s.troops = [];
          for (i=1; i<13; i++){
            if (Options.encRemaining)
              s.troops[i] = parseInt (march['unit'+ i +'Return']);
            else
              s.troops[i] = parseInt (march['unit'+ i +'Count']);
          }
          enc[city][from].push (s);
        }
      }
    }
//logit ("enc: "+ inspect (enc, 6, 1));    
    s = '<div class=ptstat>TRUPPEN IN DER BOTSCHAFT</div><BR>';
    if (numSlots == 0){
      s += '<BR><CENTER><B>Dir wurde keine Verstärkung geschickt... :/</b></center>';
    } else {
      s += '<STYLE> .tot{background:#f0e0f8;} .city{background:#ffffaa;}</style>';
      s += '<TABLE cellspacing=0 width=100%><TR align=right><TD align=left width=16%><B>Spieler (ritter)</b></td>';

      for (k=0; k<names.length; k++)
        s += '<TD width=7%><B>' + names[k] + '</b></td>';
      s += '</tr>';

      tot = [];
      for (i=0; i<13; i++)
        tot[i] = 0;
      for (c in Cities.cities){
        dest = Cities.cities[c].id;
        if (enc[dest]){
          s+= '<TR><TD class=xtab><BR></td></tr>';
          s+= '<TR><TD class="city" colspan=13 align=center><div class=ptstat><B>'+ Cities.cities[c].name +'</b></div></td></tr>';
          for (p in enc[dest]){
            try {
              player = Seed.players['u'+p].n;
            } catch (err){
              player = '???';
            }
            for (m=0; m<enc[dest][p].length; m++){
              var march = enc[dest][p][m];
              knight = '';
              if (march.knight > 0)
                knight = ' ('+ march.knight +')';
// TODO: Only allow 'send home' if troops are here now  (marchStatus = ?)              
              s += '<TR align=right><TD align=left>'+ player + knight +' <A><SPAN onclick="r8x6Home('+ march.marchId +')">X</span></a></td>'
              for (i=1; i<13; i++){
                s += '<TD>'+ march.troops[i]  +'</td>';
                tot[i] += march.troops[i];
              }
              s += '</tr>';

            }
          }
        }
      }
      s += '<TR><TD colspan=13><BR><BR></td></tr><TR align=right><TD class="tot" align=left><B>Gesamt:</b></td>';
      for (i=1; i<13; i++)
        s+= '<TD class="tot">'+ tot[i] +'</td>';
      s += '</tr></table>';
    }

    s += '<BR><BR><INPUT type=CHECKBOX id=idCheck2 '+ (Options.encRemaining?'':' CHECKED ') +'> Zeige Orginale Truppenstärke!';
    s += '<BR><BR><DIV style="font-size: 10px"><u><b>Hinweis</b></u>: Um die Truppen anzeigen zu lassen musst du ein Refresh machen!</div>';
    t.marchDiv.innerHTML = s;
    checkBox = document.getElementById('idCheck2');
    checkBox.addEventListener('click', clickShowRemaining, false);
    t.displayTimer = setTimeout (t.show, 10000);
  },

  
  butRecall : function (marchId){
    var t = Tabs.Marches;
    logit ("CANCELLING: "+ marchId);
    t.ajaxRecall (marchId);
  },

  butSendHome : function (marchId){
    var t = Tabs.Marches;
    //alert("Sent Home march#"+marchId);
    logit ("SEND HOME: "+ marchId);
    t.ajaxSendHome (marchId, function(r){t.show(); logit("AJAX RESULT: "+ r)});
  },


  /***  
  // not working, returns 'invalid parameters' :(  
  ajaxCancelMarch : function (marchId, notify){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
logit ('ajaxCancelMarch: '+ marchId);    
    for (var c=0; c<Cities.numCities; c++){
      var que = Seed.queue_atkp['city'+ Cities.cities[c].id];
      if (matTypeof(que)=='array')
        continue;
      for (k in que){
        if (k == 'm'+marchId){
          params.cid = Cities.cities[c].id;
          params.cityId = Cities.cities[c].id;
          break;
        }
      }    
    }    
    params.marchId = marchId;
    params.mid = 'm'+ marchId;
    params.requestType = "CANCEL_MARCH";
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/cancelMarch.php" + unsafeWindow.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (rslt) {
          if (notify != null)
            notify(rslt.errorMsg);
        },
        onFailure: function () {
          if (notify != null)
            notify(rslt.errorMsg);
        },
    });
  },
***/  
 

  repairList:[],
  fixLateMarch : function (march) {
  //1. return knight
       logit ("TBD fixLateMarch kid: "+march.knightId);
  //2. return troops
       //logit ("TBD fixLateMarch troops: "+returningTroops(march));
  //3. delete march
  //4. remove waiting reports
  },
  getScoutingReport : function (march) {
     var t = Tabs.Marches;
     var result='undefined';
     if (t.scoutingReports.length > 0) {
        for (var i=0; i<t.scoutingReports.length; i++){
            var rptHead = t.scoutingReports[i].rptHead;
            var report = t.scoutingReports[i].report;
            if (rptHead.side0XCoord==march.toXCoord &&
                rptHead.side0YCoord==march.toYCoord &&
                (Math.abs(parseInt(rptHead.reportUnixTime)-parseInt(march.destinationUnixTime)) < 30) &&
                march.marchType == rptHead.marchType)  {// match report, march
               return report;
            }
        }
     }
     return result;
  },
  counts:[],
  getMarchCount : function (cityNum) {
    var t = Tabs.Marches;
    for(var i=0; i<Cities.numCities; i++) {   
      cityId = 'city'+ Cities.cities[i].id;
      t.counts[i] = 0;
      for (var k in Seed.queue_atkp[cityId]){   
        march = Seed.queue_atkp[cityId][k];
        if (typeof (march) == 'object'){
          t.counts[i]++;
        }
      }
    }
    return t.counts[cityNum];
  },
  showTroops : function (data) {
     new CPopupDisplayData ('ptDisplayTroops',500,'Troops','troops',data);

  },
  showLoot : function (data) {
     //logit ( "showLoot: "+data);
     new CPopupDisplayData ('ptDisplayLoot',250,'Loot','loot',data);

  },



  ajaxSendHome : function (marchId, notify){
logit ('ajaxSendHome: '+ marchId);    
    var march = Seed.queue_atkinc['m'+ marchId];
    if (march == null){
      notify ('March not found!');
      return;
    }    
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.mid = marchId;
    params.cid = march.toCityId;
    params.fromUid = march.fromPlayerId;
    params.fromCid = march.fromCityId;
   
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/kickoutReinforcements.php" + unsafeWindow.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (rslt) {
          if (rslt.ok){
            var upkeep = 0;
            for (var i=1; i<13; i++)
              upkeep += parseInt(march["unit" + i + "Return"]) * parseInt(unsafeWindow.unitupkeeps[i])
            unsafeWindow.seed.resources["city"+ march.toCityId].rec1[3] -= upkeep;
            if (parseInt(march.fromPlayerId) == parseInt(unsafeWindow.tvuid)) {
//logit ('FROM ME!');
              var mymarch = unsafeWindow.seed.queue_atkp["city" + march.fromCityId]["m" + marchId];
              var marchtime = Math.abs(parseInt(mymarch.destinationUnixTime) - parseInt(mymarch.eventUnixTime));
              mymarch.returnUnixTime = unixTime() + marchtime;
              mymarch.marchStatus = 8;
            }
            delete unsafeWindow.seed.queue_atkinc["m" + marchId];
            if (notify != null)
              notify(null);
          } else {
            if (notify != null)
              notify(rslt.errorMsg);
          }
        },
        onFailure: function () {
          if (notify != null)
            notify(rslt.errorMsg);
        },
    });
  },

/*****

      for (var b = 1; b < 13; b++) {
        g += parseInt(e["unit" + b + "Return"]) * parseInt(unitupkeeps[b])
      }

function kickout_allies(mid, cid, fromUid, fromCid, upkeep) {
  var params = Object.clone(g_ajaxparams);
  params.mid = mid;
  params.cid = cid;
  params.fromUid = fromUid;
  params.fromCid = fromCid;
  new Ajax.Request(g_ajaxpath + "ajax/kickoutReinforcements.php" + g_ajaxsuffix, {
    method: "post",
    parameters: params,
    onSuccess: function(transport) {
      var rslt = eval("(" + transport.responseText + ")");
      if (rslt.ok) {
        Modal.showAlert(g_js_strings.kickout_allies.troopshome);
        seed.resources["city" + currentcityid].rec1[3] = parseInt(seed.resources["city" + currentcityid].rec1[3]) - upkeep;
        Modal.hideModalAll();
        if (parseInt(fromUid) == parseInt(tvuid)) {
          var curmarch = seed.queue_atkp["city" + fromCid]["m" + mid];
          var marchtime = Math.abs(parseInt(curmarch.destinationUnixTime) - parseInt(curmarch.eventUnixTime));
          curmarch.returnUnixTime = unixtime() + marchtime;
          curmarch.marchStatus = 8
        }
        delete seed.queue_atkinc["m" + mid]
      } else {
        Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
      }
    },
    onFailure: function() {}
  })
};
***/




 
  ajaxRecall : function (marchId, notify){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    for (var c=0; c<Cities.numCities; c++){
      var que = Seed.queue_atkp['city'+ Cities.cities[c].id];
      if (matTypeof(que)=='array')
        continue;
      for (k in que){
        if (k == 'm'+marchId){
          params.cid = Cities.cities[c].id;
          break;
        }
      }    
    }    
    params.mid = marchId;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/undefend.php" + unsafeWindow.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (rslt) {
          var march = unsafeWindow.seed.queue_atkp["city" + params.cid]["m" + params.mid];
          march.marchStatus = 8;
          var marchtime = parseInt(march.returnUnixTime) - parseInt(march.destinationUnixTime);
          var ut = unixTime();
          if (unsafeWindow.seed.playerEffects.returnExpire > unixTime())
            marchtime *= 0.5
          march.returnUnixTime = ut + marchtime;
          march.destinationUnixTime = ut;
          march.marchUnixTime = ut - marchtime;
          if (notify != null)
            notify(rslt.errorMsg);
        },
        onFailure: function () {
          if (notify != null)
            notify(rslt.errorMsg);
        },
    });
  },
  
};
/*******************************************/

var PageNavigator = {
  modalMessagesFunc : null,
  ctrlPaginationOld : null,
  loadPage_paginationOld : null,
  cpPager : null,
  
  init : function (){
    var t = PageNavigator;
    t.modalMessagesFunc = new CalterUwFunc ('modal_messages', [
        [/pageNavigatorModel =.*$/im, 'var pager = new ptPagerHook(0,5); pageNavigatorModel=pager'],
        [/pageNavigatorView =.*$/im, 'pageNavigatorView=pager'],
        [/pageNavigatorController =.*$/im, 'pageNavigatorController=pager']
        ]);
    unsafeWindow.ptPagerHook = t.Cpager;
    t.ctrlPaginationOld = unsafeWindow.ctrlPagination;
    t.loadPage_paginationOld = unsafeWindow.loadPage_pagination;
    t.cpPager = new t.Cpager (0,0);
    t.cpPager.oldStyle = true;
    t.enable(Options.fixPageNav);
  },

  // called on 'back' ...
  loadPage_pagination : function (divId, currentPage, callbackFunction, totalPages) {
    var t = PageNavigator;
    var curPage = parseInt(currentPage);
//logit ('loadPage_pagination: '+  divId +','+ t.cpPager.divId +','+ currentPage +','+ callbackFunction +','+ totalPages +','+ t.cpPager.getCurrentPage());
    if (divId == t.cpPager.divId) // if 'old' style ...  
      unsafeWindow[callbackFunction] (t.cpPager.getCurrentPage());
    else
      unsafeWindow[callbackFunction] (currentPage);
  },
    
  ctrlPagination : function (navDivId, numPages, notify, curPage){
    var t = PageNavigator;
//logit ('ctrlPagination (divid:'+ navDivId +')');    
    if (document.getElementById(navDivId).firstChild == null)
      document.getElementById(navDivId).appendChild (t.cpPager.getHtmlElement());   
    t.cpPager.setPageCount(numPages);
    t.cpPager.divId = navDivId;
    if (!curPage)
      curPage = 1;
    t.cpPager.gotoPage(curPage);
    t.cpPager.onClick = unsafeWindow[notify];
    unsafeWindow.pageNavigatorView = t.cpPager;
  },  
  
  enable : function (tf){
    var t = PageNavigator;
    t.modalMessagesFunc.setEnable(tf);
    if (tf){
      unsafeWindow.ctrlPagination = t.ctrlPagination;
      unsafeWindow.loadPage_pagination = t.loadPage_pagination;
    } else {
      unsafeWindow.ctrlPagination = t.ctrlPaginationOld;
      unsafeWindow.loadPage_pagination = t.loadPage_paginationOld;
    }
  },
  
  isAvailable : function (){
    var t = PageNavigator;
    return t.modalMessagesFunc.isAvailable();
  },
  
  Cpager : function (a, b){
    // public function protos ...
    this.getHtmlElement = getHtmlElement;    
    this.setPageCount = setPageCount;    
    this.getPageCount = getPageCount;    
    this.getCurrentPage = getCurrentPage;    
    this.gotoPage = gotoPage;    
    this.e_but = e_but;    
    this.e_inp = e_inp;
    //    
    var t = this;
    this.onClick = null;
    this.numPages = b;
    this.curPage = a;
    this.oldStyle = false;
    
    function getHtmlElement (){
      function aButton (msg, evtPage){
        return '<A class=ptPageNav onclick="pageNavigatorView.e_but(\''+ evtPage +'\')"><SPAN class=ptPageNav>'+ msg +'</span></a>';
      }
      var div = document.createElement ('div');
      div.id = 'ptPageNavBar';
      div.innerHTML = '<STYLE>table.ptPageNav tr td  {border:none; text-align:center; padding:0px 1px;}\
        span.ptPageNav {font-size:12px; background:inherit; line-height:135%}\
        A.ptPageNav {background-color:#44e; color:#ff4; display:block; border:1px solid #666666; height:18px; width:18px;}\
        A.ptPageNav:hover {background-color:#66f;}\
        A.ptPageNav:active {background-color:#186}\
        </style>\
        <TABLE class=ptPageNav><TR valign=middle>\
        <TD style="margin-right:15px">'+ aButton('<SPAN style="padding-right:0.8em; letter-spacing:-0.99em;">&#x258f;&#x258f;&#x25c4;</span>', 'F') +'</td>\
        <TD>'+ aButton('&#x25c4', '-') +'</td>\
        <TD>'+ aButton('&#x25ba', '+') +'</td>\
        <TD style="margin-right:15px">'+ aButton('<SPAN style="padding-right:1.05em; letter-spacing:-0.99em;">&#x25ba;&#x2595;&#x2595;</span>', 'L') +'</td>\
        <TD width=20></td><TD>Seite <INPUT id=ptPagerPageNum onChange="pageNavigatorView.e_inp()" type=text size=1> von <span id=ptPagerNumPages>?</span></td>\
        </tr></table>';
      var mml = document.getElementById('modal_msg_list');
      if (mml != null)
        mml.style.minHeight = '320px';
      return div;
    }

    function getPageCount(){    // koc needs for 'back'
      return t.numPages;
    }    
    function getCurrentPage(){    // koc needs for 'back'
      return t.curPage;
    }    
    function setPageCount(c){
      t.numPages = c;
      document.getElementById('ptPagerNumPages').innerHTML = c;
      var mml = document.getElementById('modal_msg_list');
      if (mml != null){
        if (document.getElementById('modal_msg_tabs_report').className.indexOf('selected') >= 0)
          mml.style.minHeight = '460px';
        else
          mml.style.minHeight = '320px';
      }
    }
    function gotoPage(p){
      t.curPage = parseIntZero(p);
      document.getElementById('ptPagerPageNum').value = t.curPage;
    }
    function e_but (p){

      if (p=='F' && t.curPage!=1)
        loadPage(1);
      else if (p=='-' && t.curPage>1)
        loadPage(t.curPage-1);
      else if (p=='+' && t.curPage<t.numPages)
        loadPage(t.curPage+1);
      else if (p=='L' && t.curPage!=t.numPages)
        loadPage(t.numPages);
      function loadPage (p){
        if (t.oldStyle)
      t.gotoPage(p);
        t.onClick (p);
      }
    }
    function e_inp (p){
      var pageNum = parseIntZero(document.getElementById('ptPagerPageNum').value);
      t.onClick(pageNum);
    }
  },
}


function addScript (scriptText){
  var scr = document.createElement('script');   
  scr.innerHTML = scriptText;
  document.body.appendChild(scr);
//    setTimeout ( function (){document.body.removeChild(scr);}, 500);
}
addScript ('uwuwuwFunc = function (text){ eval (text);  }');  



// TODO: Handle multiple instances altering same function!!   ****************************
var CalterUwFunc = function (funcName, findReplace) {
  var t = this;
  this.isEnabled = false;
  this.isAvailable = isAvailable;
  this.setEnable = setEnable;
  this.funcOld = null;  
  this.funcNew = null;
  try {
    var x = funcName.split('.');
    var f = unsafeWindow;
    for (var i=0; i<x.length; i++)
      f = f[x[i]];
    ft = f.toString();
    this.funcOld = f;
    var rt = ft.replace ('function '+ funcName, 'function');
    for (var i=0; i<findReplace.length; i++){
      x = rt.replace(findReplace[i][0], findReplace[i][1]);
      if (x == rt)  // if not found
        return;
      rt = x;
    }
    this.funcNew = rt;
  } catch (err) {
  }
      
  function setEnable (tf){
    if (t.funcNew == null)
      return;
    if (t.isEnabled != tf){
      if (tf){
//        var scr = document.createElement('script');   
//        scr.innerHTML = funcName +' = '+ t.funcNew;
//        document.body.appendChild(scr);
//        setTimeout ( function (){document.body.removeChild(scr);}, 500);
unsafeWindow.uwuwuwFunc(funcName +' = '+ t.funcNew);
        t.isEnabled = true;
      } else {
      var x = funcName.split('.');
      var f = unsafeWindow;
      for (var i=0; i<x.length-1; i++)
        f = f[x[i]];
      f[x[x.length-1]] = this.funcOld;
        t.isEnabled = false;
      }
    }
  }
  function isAvailable (){
    if (t.funcNew == null)
      return false;
    return true;
  }
};

var MessageCounts = {
  messagesNotifyFunc : null,
  
  init : function (){ 
	var t = MessageCounts; 
	if (Options.fixMsgCount){ 
		document.getElementById('chrome_messages_report').style.margin = '10px 0 0 65px'; 
		document.getElementById('chrome_messages_notify').style.margin = '10px 0 0 10px'; 		
	}
  },
}

function ShowExtraInfo(){
	 alert('ineter');
content = document.getElementById('mod_citylist').innerHTML
content += "O";
document.getElementById('mod_citylist').innerHTML = content;	 
}
var WarnZeroAttack = {
  modalAttackFunc : null,  
  
  init : function (){
    var t = WarnZeroAttack;
    t.modalAttackFunc = new CalterUwFunc ('modal_attack', [['modal_attack_check()', 'modalAttack_hook()']]);
    unsafeWindow.modalAttack_hook = t.hook;
    t.modalAttackFunc.setEnable(Options.fixWarnZero);
  },
   
  setEnable : function (tf){
    var t = WarnZeroAttack;
    t.modalAttackFunc.setEnable (tf);
  },
  
  isAvailable : function (){
    var t = WarnZeroAttack;
    return t.modalAttackFunc.isAvailable();
  },
    
  hook : function (){
    var t = WarnZeroAttack;
    if (parseIntZero(document.getElementById('modal_attack_target_coords_x').value) == 0
    && parseIntZero(document.getElementById('modal_attack_target_coords_y').value) == 0){
      new CdialogCancelContinue ('<SPAN class=boldRed>Du rennst grade auf 0,0!</span>', null, unsafeWindow.modal_attack_check, document.getElementById('modalInner1'));      
    } else {
      unsafeWindow.modal_attack_check();
    }
  },
  
}

function distance (d, f, c, e) {
  var a = 750;
  var g = a / 2;
  var b = Math.abs(c - d);
  if (b > g)
    b = a - b;
  var h = Math.abs(e - f);
  if (h > g)
    h = a - h;
  return Math.round(100 * Math.sqrt(b * b + h * h)) / 100;
};
function show2DPs(num) {
	if (num == parseInt(num))
		return num + '.00';
	else if (10*num == parseInt(10*num))
		return num + '0';
	else
		return num;
};
var MapDistanceFix = {
  popSlotsFunc : null,
  init : function (){
    var t = MapDistanceFix;
    t.popSlotsFunc = new CalterUwFunc ('MapObject.prototype.populateSlots', [['this.distance', 'fixMapDistance_hook']]);
    if (t.popSlotsFunc.isAvailable()){
      unsafeWindow.fixMapDistance_hook = t.fixMapDistance_hook;
      if (Options.fixMapDistance)
        t.enable (true);

    }
  },
  fixMapDistance_hook : function (cityX, cityY, tileX, tileY){
    var city = Cities.byID[unsafeWindow.currentcityid];
    return distance (city.x, city.y, tileX, tileY);
  },
  enable : function (tf){
    var t = MapDistanceFix;
    t.popSlotsFunc.setEnable (tf);
  },
  isAvailable : function (){
    var t = MapDistanceFix;
    return t.popSlotsFunc.isAvailable();
  },
}


var tabManager = {
  tabList : {},           // {name, obj, div}
  currentTab : null,
  
  init : function (mainDiv){
    var t = tabManager;
    var sorter = [];
    for (k in Tabs){
      if (!Tabs[k].tabDisabled){  
        t.tabList[k] = {};
        t.tabList[k].name = k;
        t.tabList[k].obj = Tabs[k];
        if (Tabs[k].tabLabel != null)
          t.tabList[k].label = Tabs[k].tabLabel;
        else
          t.tabList[k].label = k;
        if (Tabs[k].tabOrder != null)
          sorter.push([Tabs[k].tabOrder, t.tabList[k]]);
        else
          sorter.push([1000, t.tabList[k]]);
        t.tabList[k].div = document.createElement('div');
      }
    }

    sorter.sort (function (a,b){return a[0]-b[0]});
    var m = '<TABLE cellspacing=0 class=ptMainTab><TR>';
    for (var i=0; i<sorter.length; i++)
      m += '<TD class=spacer></td><TD class=notSel id=pttc'+ sorter[i][1].name +' ><A><SPAN>'+ sorter[i][1].label +'</span></a></td>';
    //m += '<TD class=spacer width=90% align=right>'+ Version +'&nbsp;</td></tr></table>';
    mainPop.getTopDiv().innerHTML = m;
    
    t.currentTab = null;
    for (k in t.tabList) {
      if (t.tabList[k].name == Options.currentTab)
        t.currentTab = t.tabList[k] ;
      document.getElementById('pttc'+ k).addEventListener('click', this.e_clickedTab, false);
      var div = t.tabList[k].div; 
      div.style.display = 'none';
      div.style.height = '100%';
      div.style.maxWidth = '1200px';
      div.style.overflowX = 'auto';
      mainDiv.appendChild(div);
      try {
        t.tabList[k].obj.init(div);
      } catch (e){
        div.innerHTML = "INIT ERROR: "+ e;
      }
    }
    if (t.currentTab == null)
      t.currentTab = sorter[0][1];    
    t.setTabStyle (document.getElementById ('pttc'+ t.currentTab.name), true);
    t.currentTab.div.style.display = 'block';
  },
  
  hideTab : function (){
    var t = tabManager;
    t.currentTab.obj.hide();
  },
  
  showTab : function (){
    var t = tabManager;
    t.currentTab.obj.show();
  },
    
  setTabStyle : function (e, selected){
    if (selected){
      e.className = 'sel';
    } else {
      e.className = 'notSel';
    }
  },
  
  e_clickedTab : function (e){
    var t = tabManager;
    newTab = t.tabList[e.target.parentNode.parentNode.id.substring(4)];
    if (t.currentTab.name != newTab.name){
      t.setTabStyle (document.getElementById ('pttc'+ t.currentTab.name), false);
      t.setTabStyle (document.getElementById ('pttc'+ newTab.name), true);
      t.currentTab.obj.hide ();
      t.currentTab.div.style.display = 'none';
      t.currentTab = newTab;
      newTab.div.style.display = 'block';
      Options.currentTab = newTab.name;      
    }
    newTab.obj.show();
  },
}


function setTabStyle (e, selected){
  if (selected){
    e.className = 'matTabSel';
  } else {
    e.className = 'matTabNotSel';
  }
}

function clickedTab (e){
  who = e.target.id.substring(2);
  newObj = my[who];
  currentObj = my[currentName];
  if (currentName != who){
    setTabStyle (document.getElementById ('aa'+currentName), false);
    setTabStyle (document.getElementById ('aa'+who), true);
    if (currentObj){
      currentObj.hide ();
      currentObj.getContent().style.display = 'none';
    }
    currentName = who;
    cont = newObj.getContent();
    newObj.getContent().style.display = 'block';
  }
  newObj.show();
}

function mouseMainTab (me){
  if (me.button == 2){
    var c = getClientCoords (document.getElementById('main_engagement_tabs'));
    mainPop.setLocation ({x: c.x+4, y: c.y+c.height});
  }
}

function eventHideShow (){
  if (mainPop.toggleHide(mainPop)){
    tabManager.showTab();
    Options.ptWinIsOpen = true;
  } else {
    tabManager.hideTab();
    Options.ptWinIsOpen = false;
  }
  saveOptions();
}

function hideMe (){
  if (!Options.ptWinIsOpen)
    return;
  mainPop.show (false);
  tabManager.showTab();
  Options.ptWinIsOpen = false;
  saveOptions();
}
function showMe (){
  mainPop.show (true);
  tabManager.showTab();
  Options.ptWinIsOpen = true;
  saveOptions();
}


function addMyFunction (func){      // add function to run in our own scope
  unsafeWindow[func.name] = func;
}

function addUwFunction (func){      // add function to run in unsafeWindow's scope
  scr = document.createElement('script');
  scr.innerHTML = func.toString();
  document.body.appendChild(scr);
}

function alterUwFunction (funcName, frArray){
  try {
    funcText = unsafeWindow[funcName].toString();
    rt = funcText.replace ('function '+funcName, 'function');
    for (i=0; i<frArray.length; i++){
      x = rt.replace(frArray[i][0], frArray[i][1]);
      if (x == rt)
        return false;
      rt = x;
    }
    js = funcName +' = '+ rt;
    var scr=document.createElement('script');
    scr.innerHTML=js;
    document.body.appendChild(scr);
    return true;
  } catch (err) {
    return false;
  }
}
function getResearchLevels () {
	for (var t=1; t < 17; t++) {
		if (t != 7) {
			researchLevels[t] = {};
			researchLevels[t].Id = t;
			researchLevels[t].Name = unsafeWindow.techcost['tch'+t][0].replace (/&#39;/img, '\'');
			researchLevels[t].Level = parseInt(Seed.tech['tch'+t]);
			researchLevels[t].NextLevelETA = 0;
		}
	}
	var q;
	var now = unixTime();
	for(var i=0; i<Cities.numCities; i++) { // each city
		var cityID = 'city'+ Cities.cities[i].id;
		q = Seed.queue_tch[cityID];
		if (q[0] != undefined)
			researchLevels[parseInt(q[0][0])].NextLevelETA = parseInt(q[0][3]) - now;
	}
	//GM_log(inspect(researchLevels, 10, 1, false));
}
function getTroopDefTrainEstimates (cityID){
	var b = Seed.buildings[cityID];
	city.numBarracks = 0;
	city.maxBarracks = 0;
	city.totLevelsBarracks = 0;
	city.blacksmithLevel = 0;
	city.stableLevel = 0;
	city.workshopLevel = 0;
	city.wallLevel = 0;
	for (var j=1; j<33; j++){
		if (b['pos'+j]) {
			var bname = parseInt(b['pos'+j][0]);
			var blvl = parseInt(b['pos'+j][1]);
			if (bname==13) {
				city.numBarracks++;
				city.totLevelsBarracks += parseInt(blvl);
				if (blvl>city.maxBarracks) city.maxBarracks=blvl;
			}
			if (bname==15)
				city.blacksmithLevel = blvl;
			if (bname==16)
				city.workshopLevel = blvl;
			if (bname==17)
				city.stableLevel = blvl;
			if (bname==19)
				city.wallLevel = blvl;
		}
	}

	var now = unixTime();
	city.marshallCombatScore = 0;
	var s = Seed.knights[cityID];
	if (s) {
		s = s["knt" + Seed.leaders[cityID].combatKnightId];
		if (s){
			city.marshallCombatScore = s.combat;
			if (s.combatBoostExpireUnixtime > now)
				city.marshallCombatScore *= 1.25;
		}
	}
	city.foremanBasePoliticsScore = 0;
	var s = Seed.knights[cityID];
	if (s) {
		s = s["knt" + Seed.leaders[cityID].politicsKnightId];
		if (s)
			city.foremanBasePoliticsScore = s.basePolitics;
	}

	city.loggingLevel = parseInt(Seed.tech["tch2"]);
	city.geometryLevel = parseInt(Seed.tech["tch5"]);
	city.eagleEyesLevel = parseInt(Seed.tech["tch6"]);
	city.poisonedEdgeLevel = parseInt(Seed.tech["tch8"]);
	city.metalAlloysLevel = parseInt(Seed.tech["tch9"]);
	city.featherweightPowderLevel = parseInt(Seed.tech["tch10"]);
	city.alloyHorseshoesLevel = parseInt(Seed.tech["tch12"]);
	city.fletchingLevel = parseInt(Seed.tech["tch13"]);
	city.giantsStrengthLevel = parseInt(Seed.tech["tch16"]);

	var bm = city.numBarracks + 0.1 * (city.totLevelsBarracks - city.numBarracks);
	var mf = city.marshallCombatScore / 200;
	var gf = city.geometryLevel / 10;
	var sf = city.stableLevel / 10;
	var wf = city.workshopLevel / 10;
	var isf = bm * (1 + mf + gf);
	var csf = bm * (1 + mf + gf + sf);
	var ssf = bm * (1 + mf + gf + sf + wf);
	var pf = city.foremanBasePoliticsScore / 200;
	var gsf = city.giantsStrengthLevel / 10;
	var dsf = 1 + pf + gsf;

	if (city.maxBarracks > 0) {
		city.Troop1Time= 50 / isf;
		city.Troop2Time= 25 / isf;
	} else {
		city.Troop1Time= 0;
		city.Troop2Time= 0;
	}
	if (city.maxBarracks > 1 && city.eagleEyesLevel > 0)
		city.Troop3Time= 100 / isf;
	else
		city.Troop3Time= 0;
	if (city.maxBarracks > 1 && city.poisonedEdgeLevel > 0)
		city.Troop4Time = 150 / isf;
	else
		city.Troop4Time = 0;
	if (city.maxBarracks > 2 && city.blacksmithLevel > 0 && city.metalAlloysLevel > 0)
		city.Troop5Time = 225 / isf;
	else
		city.Troop5Time = 0;
	if (city.maxBarracks > 3 && city.fletchingLevel > 0)
		city.Troop6Time = 350 / isf;
	else
		city.Troop6Time = 0;
	if (city.maxBarracks > 4 && city.stableLevel > 0 && city.alloyHorseshoesLevel > 0)
		city.Troop7Time = 500 / csf;
	else
		city.Troop7Time = 0;
	if (city.maxBarracks > 6 && city.blacksmithLevel > 4 && city.stableLevel > 4 && city.alloyHorseshoesLevel > 4)
		city.Troop8Time = 1500 / csf;
	else
		city.Troop8Time = 0;
	if (city.maxBarracks > 5 && city.stableLevel > 0 && city.workshopLevel > 2 && city.featherweightPowderLevel > 0)
		city.Troop9Time = 1000 / ssf;
	else
		city.Troop9Time = 0;
	if (city.maxBarracks > 7 && city.stableLevel > 1 && city.workshopLevel > 4 && city.geometryLevel > 4 && city.fletchingLevel > 5)
		city.Troop10Time = 3000 / ssf;
	else
		city.Troop10Time = 0;
	if (city.maxBarracks > 8 && city.blacksmithLevel > 4 && city.stableLevel > 2 && city.workshopLevel > 6 && city.metalAlloysLevel > 7 && city.geometryLevel > 6)
		city.Troop11Time = 4500 / ssf;
	else
		city.Troop11Time = 0;
	if (city.maxBarracks > 9 && city.stableLevel > 1 && city.workshopLevel > 8 && city.geometryLevel > 9 && city.fletchingLevel > 9)
		city.Troop12Time = 6000 / ssf;
	else
		city.Troop12Time = 0;
	if (city.wallLevel > 5 && city.blacksmithLevel > 5 && city.fletchingLevel > 4)
		city.Def53Time = 180 / dsf;
	else
		city.Def53Time = 0;
	if (city.wallLevel > 7 && city.blacksmithLevel > 7 && city.fletchingLevel > 6 && city.geometryLevel > 6)
		city.Def55Time = 135 / dsf;
	else
		city.Def55Time = 0;
	if (city.wallLevel > 3 && city.blacksmithLevel > 3 && city.poisonedEdgeLevel > 1)
		city.Def60Time = 90 / dsf;
	else
		city.Def60Time = 0;
	if (city.wallLevel > 0 && city.metalAlloysLevel > 0)
		city.Def61Time = 30 / dsf;
	else
		city.Def61Time = 0;
	if (city.wallLevel > 1 && city.blacksmithLevel > 1 && city.loggingLevel > 1)
		city.Def62Time = 60 / dsf;
	else
		city.Def62Time = 0;
}

function setCities(){
  var il = unsafeWindow.itemlist;
  for (var i=1101; i < 1115; i++)
  crestname[i] = il['i'+i].name
  getResearchLevels();
  Cities.numCities = Seed.cities.length;
  Cities.cities = [];
  Cities.byID = {};
  for (i=0; i<Cities.numCities; i++){
    city = {};
    city.idx = i;
    city.id = parseInt(Seed.cities[i][0]);
    city.name = Seed.cities[i][1];
    city.x = parseInt(Seed.cities[i][2]);
    city.y = parseInt(Seed.cities[i][3]);
    city.tileId = parseInt(Seed.cities[i][5]);
    city.provId = parseInt(Seed.cities[i][4]);
    Cities.cities[i] = city;
    Cities.byID[Seed.cities[i][0]] = city;
  }
}
function getCityIdFromXY(x, y) {
	for(var i=0; i<Cities.numCities; i++) {
		if (Cities.cities[i].x == x && Cities.cities[i].y == y) {
			return Cities.cities[i].id;
		}
	}
	return -1;
}
function officerId2String (oid){
  if (oid==null)
    return '';
  else if (oid==3)
    return 'Offizier';
  else if (oid==2)
    return 'Vize Kanzler';
  else if (oid==1)
    return 'Kanzler';
  return '';
}
function estimateTroopETA (dist, cityId, troopId, fhFlag) { // Need Relief Station Levels to estimate transport, reinf, or reassign times.
	var ret = {ETAstr: '', hsec: 0, fsec: 0};
	if (dist < 0.1 || parseInt(troopId) == 0) {
		ret.ETAstr = 'kein ETA';
	} else {
		var baseSpeed = unsafeWindow.unitstats['unt'+troopId][3];
		var mmLvl = parseInt(Seed.tech.tch11);//Magical Mapping
		var Speed;
		if (troopId > 6) {
			//HorsesSiegeSpeed = Base * (1 + MM/10) * (1 + AH/20)
			var hsLvl = parseInt(Seed.tech.tch12);//Alloy Horse Shoes
			Speed = baseSpeed * (1.0 + 0.1*mmLvl) * (1.0 + 0.05*hsLvl);
		} else {
			//FootSpeed = Base * (1 + MM/10)
			Speed = baseSpeed * (1 + 0.1*mmLvl);
		}
		var gSpeed = Speed / 6000; // Grid Speed (tiles/second) = Speed (100ths/min) / 6000
		ret.hsec = (30 + dist/gSpeed).toFixed(0);
		if (fhFlag == 'FH' || fhFlag == 'H') {
			ret.ETAstr = 'Angriff ETA: <B>' + timestr(ret.hsec, 1) +'</B>';
		}
		//RS - Cities Relief Station Level
		//Friendly Speed = Speed * (1 + RS/2)
		if (cityId > -1) {
			var building = getCityBuilding (city.id, 18);
			if (building) {
				fSpeed = Speed * (1 + parseInt(building.maxLevel)/2);
				gSpeed = fSpeed/6000;
				ret.fsec = (30 + dist/gSpeed).toFixed(0);
				var friendTimestr = 'Freundlich ETA: <B>' + timestr(ret.fsec, 1) +'</B>';
				if (fhFlag == 'F')
					ret.ETAstr = friendTimestr;
				else if (fhFlag == 'FH')
					ret.ETAstr = friendTimestr + ', ' + ret.ETAstr;
			}
		}
	}
	return ret;
}
function formatUnixTime (unixTimeString,format){
 var rtn = unsafeWindow.formatDateByUnixTime (unixTimeString);
/*if (format=='24hour') {
 if (rtn.substr(14,2)=='AM')
 rtn = rtn.substr(0,13);
 else
 rtn = rtn.substr(8,2)+' '+rtn.substr(0,8)+(parseInt(rtn.substr(8,2))+12)+rtn.substr(10,3);
 } */
 return rtn;
} 
// onClick (city{name, id, x, y}, x, y)   city may be null!
function CdispCityPicker (id, span, dispName, notify, selbut){
  function CcityButHandler (t){
    var that = t;
    this.clickedCityBut = clickedCityBut;
    function clickedCityBut (e){
      if (that.selected != null)
        that.selected.className = "ptcastleBut ptcastleButNon";
      that.city = Cities.cities[e.target.id.substr(that.prefixLen)];
      if (that.dispName)
        document.getElementById(that.id+'cname').innerHTML = that.city.name;
      e.target.className = "ptcastleBut ptcastleButSel";
      that.selected = e.target;
      if (that.coordBoxX){
        that.coordBoxX.value = that.city.x;
        that.coordBoxY.value = that.city.y;
        that.coordBoxX.style.backgroundColor = '#ffffff';
        that.coordBoxY.style.backgroundColor = '#ffffff';
      }
      if (that.notify != null)
        that.notify(that.city, that.city.x, that.city.y);
    }
  }

  function selectBut (idx){
    document.getElementById(this.id+'_'+idx).click();
  }

  function bindToXYboxes (eX, eY){
    function CboxHandler (t){
      var that = t;
      this.eventChange = eventChange;
      if (that.city){
        eX.value = that.city.x;
        eY.value = that.city.y;
      }
      function eventChange (){
        var x = parseInt(that.coordBoxX.value, 10);
        var y = parseInt(that.coordBoxY.value, 10);
        if (isNaN(x) || x<0 || x>750){
          that.coordBoxX.style.backgroundColor = '#ff8888';
          return;
        }
        if (isNaN(y) || y<0 || y>750){
          that.coordBoxY.style.backgroundColor = '#ff8888';
          return;
        }
        that.coordBoxX.style.backgroundColor = '#ffffff';
        that.coordBoxY.style.backgroundColor = '#ffffff';
        if (that.notify != null)
          that.notify (null, x, y);
      }
    }
    this.coordBoxX = eX;
    this.coordBoxY = eY;
    var bh = new CboxHandler(this);
    eX.size=2;
    eX.maxLength=3;
    eY.size=2;
    eY.maxLength=3;
    eX.addEventListener('change', bh.eventChange, false);
    eY.addEventListener('change', bh.eventChange, false);
  }

  this.selectBut = selectBut;
  this.bindToXYboxes = bindToXYboxes;
  this.coordBoxX = null;
  this.coordBoxY = null;
  this.id = id;
  this.dispName = dispName;
  this.prefixLen = id.length+1;
  this.notify = notify;
  this.selected = null;
  this.city = null;
  var m = '';
  for (var i=0; i<Cities.cities.length; i++)
    m += '<INPUT class="ptcastleBut ptcastleButNon" id="'+ id +'_'+ i +'" value="'+ (i+1) +'" type=submit \>';
  if (dispName)
    m += ' &nbsp; <br><b>Stadt Name:</b> &nbsp; <SPAN style="display:inline-block; width:85px; font-weight:bold;" id='+ id +'cname' +'></span>';
  span.innerHTML = m;
  var handler = new CcityButHandler(this);
  for (var i=0; i<Cities.cities.length; i++)
    document.getElementById (id+'_'+i).addEventListener('click', handler.clickedCityBut, false);
  if (selbut != null)
    this.selectBut(selbut);
};


function CdialogCancelContinue (msg, canNotify, contNotify, centerElement){
  var pop = new CPopup ('ptcancont', 0, 0, 400,200, true, canNotify);
  if (centerElement)
    pop.centerMe(centerElement);
  else
    pop.centerMe(document.body);
  pop.getTopDiv().innerHTML = '<CENTER>KoC Power Tools</center>';
  pop.getMainDiv().innerHTML = '<TABLE class=ptTab align=center style="height: 100%"><TR align=center height=90%><TD>'+ msg +'</td></tr>\
      <TR align=center><TD><INPUT id=ptcccancel type=submit value="CANCEL" \> &nbsp; &nbsp; <INPUT id=ptcccontin type=submit value="CONTINUE" \></td></tr></table>';
  document.getElementById('ptcccancel').addEventListener ('click', function (){pop.show(false); if (canNotify) canNotify();}, false);
  document.getElementById('ptcccontin').addEventListener ('click', function (){pop.show(false); if (contNotify) contNotify();}, false);
  pop.show(true);
}


// TODO: make class (multiple instances needed)
function dialogRetry (errMsg, seconds, onRetry, onCancel){
  seconds = parseInt(seconds);
  var pop = new CPopup ('ptretry', 0, 0, 400,200, true);
  pop.centerMe(mainPop.getMainDiv());
  pop.getTopDiv().innerHTML = '<CENTER>KoC Power Tools - Deutsch</center>';
  pop.getMainDiv().innerHTML = '<CENTER><BR><FONT COLOR=#550000><B>Fehlermeldung:</b></font><BR><BR><DIV id=paretryErrMsg></div>\
      <BR><BR><B>Auto Refresh in <SPAN id=paretrySeconds></b></span> Sekunden...<BR><BR><INPUT id=paretryCancel type=submit value="Abbruch Wiederholen" \>';
  document.getElementById('paretryCancel').addEventListener ('click', doCancel, false);
  pop.show(true);
  
  document.getElementById('paretryErrMsg').innerHTML = errMsg;
  document.getElementById('paretrySeconds').innerHTML = seconds;
  var rTimer = setTimeout (doRetry, seconds*1000);
  countdown ();

  function countdown (){
    document.getElementById('paretrySeconds').innerHTML = seconds--;
    if (seconds > 0)
      cdTimer = setTimeout (countdown, 1000);
  }
  function doCancel(){
    clearTimeout (rTimer);
    clearTimeout (cdTimer);
    pop.destroy();
    onCancel ();
  }
  function doRetry (){
    clearTimeout (rTimer);
    clearTimeout (cdTimer);
    pop.show(false);
    onRetry();
  }
}



function implodeUrlArgs (obj){
  var a = [];
  for (var k in obj)
    a.push (k +'='+ encodeURI(obj[k]) );
  return a.join ('&');    
}

// NOTE: args can be either a string which will be appended as is to url or an object of name->values
function addUrlArgs (url, args){
  if (!args)
    return url;
  if (url.indexOf('?') < 0)
    url += '?';
  else if (url.substr(url.length-1) != '&')
    url += '&';    
  if (matTypeof(args == 'object'))
    return url + implodeUrlArgs (args);    
  return url + args;
}

// emulate protoype's Ajax.Request ...
function AjaxRequest (url, opts){
  var headers = {
    'X-Requested-With': 'XMLHttpRequest',
    'X-Prototype-Version': '1.6.1',
    'Accept': 'text/javascript, text/html, application/xml, text/xml, */*'
  };
  var ajax = null;

if (DEBUG_TRACE_AJAX) logit ("AJAX: "+ url +"\n" + inspect (opts, 3, 1));  
    
  if (window.XMLHttpRequest)
    ajax=new XMLHttpRequest();
  else
    ajax=new ActiveXObject("Microsoft.XMLHTTP");
  
  if (opts.method==null || opts.method=='')
    method = 'GET';
  else
    method = opts.method.toUpperCase();  
    
  if (method == 'POST'){
    headers['Content-type'] = 'application/x-www-form-urlencoded; charset=UTF-8';
  } else if (method == 'GET'){
    addUrlArgs (url, opts.parameters);
  }

  ajax.onreadystatechange = function(){
//  ['Uninitialized', 'Loading', 'Loaded', 'Interactive', 'Complete']; states 0-4
    if (ajax.readyState==4) {
      if (ajax.status >= 200 && ajax.status < 305)
        if (opts.onSuccess) opts.onSuccess(ajax);
      else
        if (opts.onFailure) opts.onFailure(ajax);
    } else {
      if (opts.onChange) opts.onChange (ajax);
    }
  }  
    
  ajax.open(method, url, true);   // always async!

  for (var k in headers)
    ajax.setRequestHeader (k, headers[k]);
  if (matTypeof(opts.requestHeaders)=='object')
    for (var k in opts.requestHeaders)
      ajax.setRequestHeader (k, opts.requestHeaders[k]);
      
  if (method == 'POST'){
    var a = [];
    for (k in opts.parameters)
      a.push (k +'='+ opts.parameters[k] );
    ajax.send (a.join ('&'));
  } else               {
    ajax.send();
  }
}   



function MyAjaxRequest (url, o, noRetry){
if (DEBUG_TRACE) logit (" 0 myAjaxRequest: "+ url +"\n" + inspect (o, 2, 1));
  var opts = unsafeWindow.Object.clone(o);
  var wasSuccess = o.onSuccess;
  var wasFailure = o.onFailure;
  var retry = 0;
  var delay = 5;
  var noRetry = noRetry===true?true:false;
  opts.onSuccess = mySuccess;
  opts.onFailure = myFailure;

if (DEBUG_TRACE) logit (" 1a myAjaxRequest: "+ url +"\n" + inspect (o, 2, 1));
  new AjaxRequest(url, opts);
  return;

  function myRetry(){
    ++retry;
    new AjaxRequest(url, opts);
    delay = delay * 1.25;
  }


  function myFailure(){
    var o = {};
if (DEBUG_TRACE) logit ("myAjaxRequest.myFailure(): "+ inspect(rslt, 1, 1));
    o.ok = false;
    o.errorMsg = "AJAX Communication Failure";
    wasFailure (o);
  }

  function mySuccess (msg){
    var rslt = eval("(" + msg.responseText + ")");
    var x;
    if (rslt.ok){
if (DEBUG_TRACE) logit (" 1b myAjaxRequest.mySuccess(): "+ inspect(rslt, 1, 1));
      rslt.errorMsg = null;   ///// !!!!!!!!!!!!!  ************
      if (rslt.updateSeed)
        uW.update_seed(rslt.updateSeed);
      wasSuccess (rslt);
      return;
    }
if (DEBUG_TRACE) logit (" 1b myAjaxRequest.mySuccess() !ok : "+ inspect(rslt, 3, 1));
    rslt.errorMsg = uW.printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null));
    /*if ( (x = rslt.errorMsg.indexOf ('<br><br>')) > 0)
      rslt.errorMsg = rslt.errorMsg.substr (0, x-1);*/
    if (!noRetry && (rslt.error_code==0 ||rslt.error_code==8 || rslt.error_code==1 || rslt.error_code==3)){
      dialogRetry (rslt.errorMsg, delay, function(){myRetry()}, function(){wasSuccess (rslt)});
    } else {
      wasSuccess (rslt);
    }
  }
}





// returns: 'neutral', 'friendly', or 'hostile'
function getDiplomacy (aid) {
if(aid < 1 || aid == null)
 return 'Allianzlos'; 
  if (Seed.allianceDiplomacies == null)
    return 'Neutral';
  if (Seed.allianceDiplomacies.friendly && Seed.allianceDiplomacies.friendly['a'+aid] != null)
    return 'Freundlich';
  if (Seed.allianceDiplomacies.hostile && Seed.allianceDiplomacies.hostile['a'+aid] != null)
    return 'Feindlich';
  return 'Neutral';
};
// returns: 'neutral', 'friendly', ally, or 'hostile'
function getDiplomacy2 (aid) {
  if (Seed.allianceDiplomacies == null)
    return 'Neutral';
  if (Seed.allianceDiplomacies.friendly && Seed.allianceDiplomacies.friendly['a'+aid] != null)
    return 'Freundlich';
  if (Seed.allianceDiplomacies.hostile && Seed.allianceDiplomacies.hostile['a'+aid] != null)
    return 'Feindlich';
  if (aid == Seed.allianceDiplomacies.allianceId)
    return 'Alliierte';
  return 'Neutral';
};

function getMyAlliance (){
  if (Seed.allianceDiplomacies==null || Seed.allianceDiplomacies.allianceName==null)
    return [0, 'None'];
  else
    return [Seed.allianceDiplomacies.allianceId, Seed.allianceDiplomacies.allianceName];
}



// TODO: Check times for expired marches !?!?!
// note: unselected city has outdated info

function getMarchInfo (){
  var ret = {};

  ret.marchUnits = [];
  ret.returnUnits = [];
  ret.resources = [];
  for (i=0; i<13; i++){
    ret.marchUnits[i] = 0;

    ret.returnUnits[i] = 0;
  }
  for (i=0; i<5; i++){
    ret.resources[i] = 0;
  }

  var now = unixTime();

  for(i=0; i<Cities.numCities; i++) {   // each city
    cityID = 'city'+ Cities.cities[i].id;
    for (k in Seed.queue_atkp[cityID]){   // each march
      march = Seed.queue_atkp[cityID][k];
      if (typeof (march) == 'object'){
        for (ii=0; ii<13; ii++){
          ret.marchUnits[ii] += parseInt (march['unit'+ ii +'Count']);
          ret.returnUnits[ii] += parseInt (march['unit'+ ii +'Return']);
        }
        for (ii=1; ii<5; ii++){
          ret.resources[ii] += parseInt (march['resource'+ ii]);
        }
          ret.resources[0] += parseInt (march['gold']);
      }
// TODO: fixup completed marches
// TODO: Assume transport is complete ?
    }
  }
  return ret;
}

var fortNamesShort = {
  53: "Crossbows",
  55: "Trebuchet",
  60: "Trap",
  61: "Caltrops",
  62: "Spiked Barrier",
}

// returns {count, maxlevel}
function getCityBuilding (cityId, buildingId){
  var b = Seed.buildings['city'+cityId];
  var ret = {count:0, maxLevel:0};
  for (var i=1; i<33; i++){
    if (b['pos'+i] && b['pos'+i][0] == buildingId){
      ++ret.count;
      if (parseInt(b['pos'+i][1]) > ret.maxLevel)
        ret.maxLevel = parseInt(b['pos'+i][1]);
    }
  }
  return ret;
}
// GEBÄUDE INFO
function highlightLowBuilding (noBuildings, buildingLevel, buildingPrefix){
	var ret = '';
	if (buildingLevel<9)
		ret += '<SPAN class=boldRed>';
	if (noBuildings>1)
		ret += noBuildings + ' x ';
	if (buildingPrefix)
		ret += buildingPrefix;
	ret += 'lvl ' + buildingLevel;
	if (buildingLevel<9)
		ret += '</SPAN>';
	return ret;
}

function getAllCityBuildings (cityID){
	var b = Seed.buildings[cityID];
	var castleLevel = parseInt(b['pos0'][1]);
	var noFields = 10 + 3 * castleLevel;
	if (castleLevel==11)
		noFields = 40;
	sumCastle = highlightLowBuilding(1,castleLevel);
	sumCottage = '';
	sumTavern = '';
	sumKnightsHall = '';
	sumEmbassy = '';
	sumStorehouse = '';
	sumMarket = '';
	sumAlchemyLab = '';
	sumRallyPoint = '';
	sumBarracks = '';
	sumWatchTower = '';
	sumBlacksmith = '';
	sumWorkshop = '';
	sumStable = '';
	sumReliefStation = '';
	sumWall = '';
	sumGuardian = '';
	sumInside = 0;
	sumFarm = '';
	sumSawmill = '';
	sumQuarry = '';
	sumMine = '';
	sumOutside = 0;
	arrCottage = [];
	arrBarracks = [];
	arrFarm = [];
	arrSawmill = [];
	arrQuarry = [];
	arrMine = [];
	for (var i=1; i<12; i++){
		arrCottage[i]=0;
		arrBarracks[i]=0;
		arrFarm[i]=0;
		arrSawmill[i]=0;
		arrQuarry[i]=0;
		arrMine[i]=0;
	}

	for (var i=1; i<33; i++){
		if (b['pos'+i]) {
			bname = b['pos'+i][0];
			blvl  = b['pos'+i][1];
			if (bname==5)  arrCottage[blvl]++;
			if (bname==6)  sumTavern        = highlightLowBuilding(1,blvl);
			if (bname==7)  sumKnightsHall   = highlightLowBuilding(1,blvl);
			if (bname==8)  sumEmbassy       = highlightLowBuilding(1,blvl);
			if (bname==9)  sumStorehouse    = highlightLowBuilding(1,blvl);
			if (bname==10) sumMarket        = highlightLowBuilding(1,blvl);
			if (bname==11) sumAlchemyLab    = highlightLowBuilding(1,blvl);
			if (bname==12) sumRallyPoint    = highlightLowBuilding(1,blvl);
			if (bname==13) arrBarracks[blvl]++;
			if (bname==14) sumWatchTower    = highlightLowBuilding(1,blvl);
			if (bname==15) sumBlacksmith    = highlightLowBuilding(1,blvl);
			if (bname==16) sumWorkshop      = highlightLowBuilding(1,blvl);
			if (bname==17) sumStable        = highlightLowBuilding(1,blvl);
			if (bname==18) sumReliefStation = highlightLowBuilding(1,blvl);
			if (bname==19) sumWall          = highlightLowBuilding(1,blvl);
		}
		else
			sumInside += 1;
	}
	for (var i=100; i<100+noFields; i++){
		if (b['pos'+i]) {
			bname = b['pos'+i][0];
			blvl  = b['pos'+i][1];
			if (bname==1) arrFarm[blvl]++;
			if (bname==2) arrSawmill[blvl]++;
			if (bname==3) arrQuarry[blvl]++;
			if (bname==4) arrMine[blvl]++;
		}
		else
			sumOutside += 1;
	}
	for (var i=1; i<12; i++){
		if(arrCottage[i]>0)  sumCottage+=highlightLowBuilding(arrCottage[i],i)+'<BR>';
		if(arrBarracks[i]>0) sumBarracks+=highlightLowBuilding(arrBarracks[i],i)+'<BR>';
		if(arrFarm[i]>0)     sumFarm+=highlightLowBuilding(arrFarm[i],i)+'<BR>';
		if(arrSawmill[i]>0)  sumSawmill+=highlightLowBuilding(arrSawmill[i],i)+'<BR>';
		if(arrQuarry[i]>0)   sumQuarry+=highlightLowBuilding(arrQuarry[i],i)+'<BR>';
		if(arrMine[i]>0)     sumMine+=highlightLowBuilding(arrMine[i],i)+'<BR>';
	}
	if (sumCottage.length>0)  sumCottage=sumCottage.substring (0,sumCottage.length-4);
	if (sumBarracks.length>0) sumBarracks=sumBarracks.substring (0,sumBarracks.length-4);
	if (sumFarm.length>0)     sumFarm=sumFarm.substring (0,sumFarm.length-4);
	if (sumSawmill.length>0)  sumSawmill=sumSawmill.substring (0,sumSawmill.length-4);
	if (sumQuarry.length>0)   sumQuarry=sumQuarry.substring (0,sumQuarry.length-4);
	if (sumMine.length>0)     sumMine=sumMine.substring (0,sumMine.length-4);
	if (b['pos500']) {
		blvl  = b['pos500'][1];
		bname = unsafeWindow.buildingcost['bdg' + b['pos500'][0]][0];
		bname = bname.substr(0,bname.length-8);
		sumGuardian = highlightLowBuilding(1,blvl,bname);
	}
	else
		sumInside += 1;
	if (sumInside==0)
		sumInside='<b>Ausgebaut</b>';
	else
		sumInside='<SPAN class=boldRed>Frei: '+sumInside+'</SPAN>';
	if (sumOutside==0)
		sumOutside='<b>Ausgebaut</b>';
	else
		sumOutside='<SPAN class=boldRed>Frei: '+sumOutside+'</SPAN>';
}
// GEBÄUDE INFO ENDE
// AUSBILDUNGSZEITEN
function getTroopTrainEstimates (cityID){

	var b = Seed.buildings[cityID];
	numBarracks = 0;
	maxBarracks = 0;
	totLevelsBarracks = 0;
	blacksmithLevel = 0;
	stableLevel = 0;
	workshopLevel = 0;
	for (var j=1; j<33; j++){
		if (b['pos'+j]) {
			var bname = parseInt(b['pos'+j][0]);
			var blvl = parseInt(b['pos'+j][1]);
			if (bname==13) {
				numBarracks++;
				totLevelsBarracks += parseInt(blvl);
				if (blvl>maxBarracks) maxBarracks=blvl;
			}
			if (bname==15)
				blacksmithLevel = blvl;
			if (bname==17)
				stableLevel = blvl;
			if (bname==16)
				workshopLevel = blvl;
		}
	}

	var now = unixTime();
	marshallCombatScore = 0;
	var s = Seed.knights[cityID];
	if (s) {
		s = s["knt" + Seed.leaders[cityID].combatKnightId];
		if (s){
			marshallCombatScore = s.combat;
			if (s.combatBoostExpireUnixtime > now)
				marshallCombatScore *= 1.25;
		}
	}

	geometryLevel            = parseInt(Seed.tech["tch5"]);
	eagleEyesLevel           = parseInt(Seed.tech["tch6"]);
	poisonedEdgeLevel        = parseInt(Seed.tech["tch8"]);
	metalAlloysLevel         = parseInt(Seed.tech["tch9"]);
	featherweightPowderLevel = parseInt(Seed.tech["tch10"]);
	alloyHorseshoesLevel     = parseInt(Seed.tech["tch12"]);
	fletchingLevel           = parseInt(Seed.tech["tch13"]);

	var bm = numBarracks + 0.1 * (totLevelsBarracks - numBarracks);
	var mf = marshallCombatScore / 200;
	var gf = geometryLevel/10;
	var sf = stableLevel/10;
	var wf = workshopLevel/10;
	var isf = bm * (1 + mf + gf);
	var csf = bm * (1 + mf + gf + sf);
	var ssf = bm * (1 + mf + gf + sf + wf);

	if (maxBarracks > 0) {
		rateSupplyTroop = 3600 * isf /   50;
		rateMilitiaman  = 3600 * isf /   25;
	} else {
		rateSupplyTroop = 0;
		rateMilitiaman  = 0;
	}
	if (maxBarracks > 1 && eagleEyesLevel > 0)
		rateScout = 3600 * isf /  100;
	else
		rateScout = 0;
	if (maxBarracks > 1 && poisonedEdgeLevel > 0)
		ratePikeman = 3600 * isf /  150;
	else
		ratePikeman = 0;
	if (maxBarracks > 2 && blacksmithLevel > 0 && metalAlloysLevel > 0)
		rateSwordsman = 3600 * isf /  225;
	else
		rateSwordsman = 0;
	if (maxBarracks > 3 && fletchingLevel > 0)
		rateArcher = 3600 * isf /  350;
	else
		rateArcher = 0;
	if (maxBarracks > 4 && stableLevel > 0 && alloyHorseshoesLevel > 0)
		rateCavalry = 3600 * csf /  500;
	else
		rateCavalry = 0;
	if (maxBarracks > 6 && blacksmithLevel > 4 && stableLevel > 4 && alloyHorseshoesLevel > 4)
		rateHeavyCavalry = 3600 * csf / 1500;
	else
		rateHeavyCavalry = 0;
	if (maxBarracks > 5 && stableLevel > 0 && workshopLevel > 2 && featherweightPowderLevel > 0)
		rateSupplyWagon  = 3600 * ssf / 1000;
	else
		rateSupplyWagon = 0;
	if (maxBarracks > 7 && stableLevel > 1 && workshopLevel > 4 && geometryLevel > 4 && fletchingLevel > 5)
		rateBallista = 3600 * ssf / 3000;
	else
		rateBallista = 0;
	if (maxBarracks > 8 && blacksmithLevel > 4 && stableLevel > 2 && workshopLevel > 6 && metalAlloysLevel > 7 && geometryLevel > 6)
		rateBatteringRam = 3600 * ssf / 4500;
	else
		rateBatteringRam = 0;
	if (maxBarracks > 9 && stableLevel > 1 && workshopLevel > 8 && geometryLevel > 9 && fletchingLevel > 9)
		rateCatapult = 3600 * ssf / 6000;
	else
		rateCatapult = 0;

}
// example: http://www150.kingdomsofcamelot.com
function GetServerId() {
  var m=/^[a-zA-Z]+([0-9]+)\./.exec(document.location.hostname);
  if(m)
    return m[1];
  return '';
}

function logit (msg){
  var serverID = GetServerId();
  var now = new Date();
  GM_log (serverID +' @ '+ now.toTimeString().substring (0,8) +'.' + now.getMilliseconds() +': '+  msg);
}



/************ DEBUG WIN *************/
var debugWin = {
  popDebug : null,
  dbDefaultNot : 'tech,tutorial,items,quests,wilderness,wildDef,buildings,knights,allianceDiplomacies,appFriends,players',
  dbSelect : {},

  doit : function (){
    var t = debugWin;    

    function syncBoxes (){
      var div = document.getElementById('dbpoplist');
      for (var i=0; i<div.childNodes.length; i++){
        if (div.childNodes[i].type && div.childNodes[i].type=='checkbox'){
          var name=div.childNodes[i].name.substr(6);
          div.childNodes[i].checked = t.dbSelect[name];
        }
      }
    }
    function clickedAll (){
      for (var k in t.dbSelect)
        t.dbSelect[k] = true;
      syncBoxes();
    }
    function clickedNone (){
      for (var k in t.dbSelect)
        t.dbSelect[k] = false;
      syncBoxes();
    }
    function clickedDefaults (){
      for (k in t.dbSelect)
        t.dbSelect[k] = true;
      var not = t.dbDefaultNot.split(',');
      for (var i=0; i<not.length; i++)
        t.dbSelect[not[i]] = false;
      syncBoxes();
    }
    function clickedShow (){
      var now = new Date();
      var myseed = unsafeWindow.Object.clone (Seed);
      var div = document.getElementById('dbpoplist');
      for (var i=0; i<div.childNodes.length; i++){
        if (div.childNodes[i].type && div.childNodes[i].type=='checkbox'){
          var name=div.childNodes[i].name.substr(6);
          if (!div.childNodes[i].checked)
            delete myseed[name];
        }
      }
      WinLog.write ("seed @ "+ unixTime()  +" ("+ now +")\n\n"+ inspect (myseed, 8, 1));
      myseed=null;
    }
    
    function clickedShowScripts (){
      var scripts = document.getElementsByTagName('script');
      for (var i=0; i<scripts.length; i++){
        if (scripts[i].src!=null && scripts[i].src!='')
          WinLog.write ('<A TARGET=_tab HREF="'+ scripts[i].src +'">'+ scripts[i].src +'</a>');
      }
    }
    
    if (t.popDebug == null){  
      t.popDebug = new CPopup ('db', 0, 0, 400,500, true);
      t.popDebug.getTopDiv().innerHTML = 'DEBUG';
      t.popDebug.getMainDiv().innerHTML = '<DIV><INPUT type=submit id=dbsuball value=ALL> &nbsp; <INPUT type=submit id=dbsubnone value=NONE> &nbsp; \
        <INPUT type=submit id=dbdefaults value=DEFAULTS> &nbsp; <INPUT type=submit id=dbsubdo value=SHOW> &nbsp; <INPUT type=submit id=dbsubscripts value=SCRIPTS></div>\
        <DIV id=dbpoplist style="max-height:400px; height:400px; overflow-y:auto"></div>';
      var div = document.getElementById('dbpoplist');
      for (var k in Seed)
        t.dbSelect[k] = true;
      var not = t.dbDefaultNot.split(',');
      for (var i=0; i<not.length; i++)
        t.dbSelect[not[i]] = false;
      var m = [];
      for (k in t.dbSelect){
        m.push ('<INPUT type=checkbox ');
        m.push ('name="dbpop_');
        m.push (k);
        m.push ('"> &nbsp; ');
        m.push (k);
        m.push ('<BR>');
      }
      div.innerHTML = m.join ('');
      document.getElementById('dbsuball').addEventListener('click', clickedAll, false);
      document.getElementById('dbsubnone').addEventListener('click', clickedNone, false);
      document.getElementById('dbdefaults').addEventListener('click', clickedDefaults, false);
      document.getElementById('dbsubdo').addEventListener('click', clickedShow, false);
      document.getElementById('dbsubscripts').addEventListener('click', clickedShowScripts, false);
      syncBoxes();
    }
    t.popDebug.show (true);
  },
}

function saveColors (){
  var serverID = GetServerId();
  GM_setValue ('Colors', JSON2.stringify(Colors));
}

function readColors (){
  var serverID = GetServerId();
  s = GM_getValue ('Colors');
  if (s != null){
    opts = JSON2.parse (s);
    for (k in opts)
      Colors[k] = opts[k];
  }
}
function saveOptions (){
  var serverID = GetServerId();
  GM_setValue ('Options_'+serverID, JSON2.stringify(Options));
}

function readOptions (){
  var serverID = GetServerId();
  s = GM_getValue ('Options_'+serverID);
  if (s != null){
    opts = JSON2.parse (s);
    for (k in opts)
      Options[k] = opts[k];
  }
}


/***
***/
var myServers = {   // incomplete, untested
  serverlist : null,
  
  get : function (notify){
    if (myServers.serverlist){
      notify (myServers.serverlist);
      return;
    }
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/myServers.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function(rslt) {
logit (inspect (rslt, 3, 1));  
        if (notify)      
          notify (myServers.serverlist);
      },
      onFailure: function(rslt) {
      }
    });
  },
};


function createButton (label){
  var a=document.createElement('a');
  a.className='button20';
  a.innerHTML='<span style="color: #ff6">'+ label +'</span>';
  return a;
}

function AddMainTabLink(text, eventListener, mouseListener) {
  var a = createButton (text);
  a.className='tab';
  var tabs=document.getElementById('main_engagement_tabs');
  if(!tabs) {
    tabs=document.getElementById('topnav_msg');
    if (tabs)
      tabs=tabs.parentNode;
  }
  if (tabs) {
    var e = tabs.parentNode;
    var gmTabs = null;
    for (var i=0; i<e.childNodes.length; i++){
      var ee = e.childNodes[i];
//if (ee.tagName=='DIV') logit ("CHILD: "+  ee.tagName +' : '+ ee.className+' : '+ ee.id);      
      if (ee.tagName && ee.tagName=='DIV' && ee.className=='tabs_engagement' &&  ee.id!='main_engagement_tabs'){
        gmTabs = ee;
        break;
      }
    }
    if (gmTabs == null){
      gmTabs = document.createElement('div');
      gmTabs.className='tabs_engagement';
      gmTabs.style.background='none';
      tabs.parentNode.insertBefore (gmTabs, tabs);
      gmTabs.style.whiteSpace='nowrap';
      gmTabs.style.width='735px';
      gmTabs.lang = 'en_PT';
    }
    if (gmTabs.firstChild)
      gmTabs.insertBefore (a, gmTabs.firstChild);
    else
      gmTabs.appendChild(a);
    a.addEventListener('click',eventListener, false);
    if (mouseListener != null)
      a.addEventListener('mousedown',mouseListener, true);
    return a;
  }
  return null;
}

function coordLink (x, y){
  var m = [];
  m.push ('(<a onclick="ptGotoMapHide (');
  m.push (x);
  m.push (',');
  m.push (y);
  m.push ('); return false">');
  m.push (x);
  m.push (',');
  m.push (y);
  m.push ('</a>)');  
  return m.join('');
}


unsafeWindow.ptGotoMapHide = function (x, y){
  try {
    unsafeWindow.Modal.hideModal();
  } catch (e){ }
  try {
    Modal.hideModal();
  } catch (e){ }
  unsafeWindow.ptGotoMap (x, y);  
}



unsafeWindow.ptGotoMap = function (x, y){
  if (Options.hideOnGoto)
    hideMe ();
  setTimeout (function (){
    document.getElementById('mapXCoor').value = x;
    document.getElementById('mapYCoor').value = y;
    unsafeWindow.reCenterMapWithCoor();
    var a = document.getElementById("mod_views").getElementsByTagName("a");
    for (var b = 0; b < a.length; b++) {
        a[b].className = ""
    }
    document.getElementById('mod_views_map').className = "sel";
    document.getElementById("maparea_city").style.display = 'none';
    document.getElementById("maparea_fields").style.display = 'none';
    document.getElementById("maparea_map").style.display = 'block';
    unsafeWindow.tutorialClear()
  }, 0);
};


/**********************************************************************************/

function makeButton20 (label){
  var a = document.createElement('a');
  a.className = "button20 ptButton20";
  var s = document.createElement('span');
  s.innerHTML = label;
  a.appendChild (s);
  return a;
}

function strButton20 (label, tags){
  if (tags == null)
    tags = '';
  return ('<TABLE class=ptNoPad><TR><TD><A class="button20 ptButton20" '+ tags +'><SPAN>'+ label +'</span></a></td></tr></table>' );
}

function strButton14 (label, tags){
  if (tags == null)
    tags = '';
  return ('<A class="button14 ptButton20" '+ tags +'><SPAN>'+ label +'</span></a>' );
}

function cityStatusString (cs){
  if (cs==4)
    return 'V';
  if (cs==3)
    return 'T';
  if (cs==2)
    return 'BP';
  return 'N';
}    

// Simple method, as if it were typed in thru DOM
function sendChat (msg){
  document.getElementById ("mod_comm_input").value = msg;
  unsafeWindow.Chat.sendChat ();
}

// works well, but message is not echoed back to local client
Chat = {
  params : null,

  sendWhisper : function (msg, who, notify){
    this.params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    this.params.ctype = 3;
    this.params.name = who;
    this._sendit (msg, notify);
  },

  sendGlobal : function (msg, notify){
    this.params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    this.params.ctype = 1;
    this._sendit (msg, notify);
  },

  sendAlliance : function (msg, notify){
    this.params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    this.params.ctype = 2;
    this._sendit (msg, notify);
  },

  _sendit : function (msg, notify){
    function strip(s) {
       return s.replace(/^\s+/, '').replace(/\s+$/, '');
    }
    this.params.comment = strip (msg);
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/sendChat.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: this.params,
      onSuccess: function(transport) {
        if (notify)
          notify ();
      },
      onFailure: function(transport) {
        if (notify)
          notify ();
      }
    });
  },
}

function doDefTrain (cityId, unitId, num, notify){
  var time = unsafeWindow.modal_walls_traintime(unitId, num);
  var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  params.cid = cityId;
  params.type = unitId;
  params.quant = num;
  params.items = 0;
  new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/fortify.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        if (rslt.ok) {
          unsafeWindow.seed.queue_fort["city" + cityId].push([unitId, num, rslt.initTS, parseInt(rslt.initTS) + time, 0, time, rslt.fortifyId]);
          if (notify != null)
            setTimeout (function (){notify(null);}, 500);
        } else {
          if (notify != null)
            setTimeout (function (){notify(rslt.errorMsg);}, 500);
        }
      },
      onFailure: function () {
        if (notify != null)
          notify(rslt.errorMsg);
      },
  });
}


function doTrain (cityId, unitId, num, notify){
  var time = unsafeWindow.modal_barracks_traintime(unitId, num);
  var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  params.cid = cityId;
  params.type = unitId;
  params.quant = num;
  params.items = 0;

  new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/train.php" + unsafeWindow.g_ajaxsuffix, {
    method: "post",
    parameters: params,
    onSuccess: function(rslt) {
      if (rslt.ok) {
        for (var i = 1; i < 5; i++) {
          unsafeWindow.seed.resources["city" + cityId]["rec" + i][0] = parseInt(unsafeWindow.seed.resources["city" + cityId]["rec" + i][0]) - parseInt(unsafeWindow.unitcost["unt" + unitId][i]) * 3600 * parseInt(num)
        }
        unsafeWindow.seed.citystats["city" + cityId].gold[0] = parseInt(unsafeWindow.seed.citystats["city" + cityId].gold[0]) - parseInt(unsafeWindow.unitcost["unt" + unitId][5]) * parseInt(num);
        unsafeWindow.seed.citystats["city" + cityId].pop[0] = parseInt(unsafeWindow.seed.citystats["city" + cityId].pop[0]) - parseInt(unsafeWindow.unitcost["unt" + unitId][6]) * parseInt(num);
        unsafeWindow.seed.queue_unt["city" + cityId].push([unitId, num, rslt.initTS, parseInt(rslt.initTS) + time, 0, time, null]);
        if (notify != null)
          setTimeout (function (){notify(null);}, 500);
      } else {
        if (notify != null){
          setTimeout (function (){notify(rslt.errorMsg);}, 500);
        }
      }
    },
    onFailure: function(o) {
      if (notify != null)
        notify(rslt.errorMsg);
    }
  });
}



/************  LIB classes/functions .... **************/
function getAbsoluteOffsets (e){
  ret = {left:0, top:0};
  while (e.offsetParent){
    if (e.style.position == 'absolute')
      break;
    ret.left += e.offsetLeft;
    ret.top += e.offsetTop;
    e = e.offsetParent;
  }      
  return ret;  
}

DebugTimer = {
  startTime : 0,
  start : function (){
    now = new Date();
    DebugTimer.startTime = now.getTime();
  },
  display : function (label, noReset){
    now = new Date();
    elapsed = now.getTime() - DebugTimer.startTime;
    logit (label +": "+ elapsed/1000);
    if (noReset===null || !noReset)
      DebugTimer.startTime = now.getTime();
  },
};

function debugPos  (e){
  return 'client - offset: '+ e.clientLeft +','+ e.clientTop +','+ e.clientWidth +','+ e.clientHeight
          +' - '+ e.offsetLeft +','+ e.offsetTop +','+ e.offsetWidth +','+ e.offsetHeight +' '+ e +' --OP--> '+ e.offsetParent;
}

function debugElement  (e){
  var x = unsafeWindow.Object.clone (e.wrappedJSObject);
  x.innerHTML = '';
  x.innerText = '';
  x.textContent = '';
  return inspect (x, 1, 1);
}     

function searchDOM (node, condition, maxLevel, doMult){
  var found = [];
  eval ('var compFunc = function (node) { return ('+ condition +') }');
  doOne(node, 1);
  if(!doMult){
    if (found.length==0)
      return null;
    return found[0];
  }
  return found;
  function doOne (node, curLevel){
    try {
      if (compFunc(node))
        found.push(node);
    } catch (e){
    }      
    if (!doMult && found.length>0)
      return;
    if (++curLevel<maxLevel && node.childNodes!=undefined)
      for (var c=0; c<node.childNodes.length; c++)
        doOne (node.childNodes[c], curLevel);
  }
}

function getClientCoords(e){
  if (e==null)
    return {x:null, y:null, width:null, height:null};
  var x=0, y=0;
  ret = {x:0, y:0, width:e.clientWidth, height:e.clientHeight};
  while (e.offsetParent != null){
    ret.x += e.offsetLeft;
    ret.y += e.offsetTop;
    e = e.offsetParent;
  }
  return ret;
}


function htmlTitleLine (msg){
  return '<TABLE width=100% cellspacing=0><TR><TD style="padding:0px" width=50%><HR></td><TD style="padding:0px">[ '+ msg +' ]</td><TD style="padding:0px" width=50%><HR></td></tr></table>';  
}


var WinManager = {
  wins : {},    // prefix : CPopup obj

  get : function (prefix){
    var t = WinManager;
    return t.wins[prefix];
  },
  
  add : function (prefix, pop){
    var t = WinManager;
    t.wins[prefix] = pop;
    if (unsafeWindow.cpopupWins == null)
      unsafeWindow.cpopupWins = {};
    unsafeWindow.cpopupWins[prefix] = pop;
  },
  
  delete : function (prefix){
    var t = WinManager;
    delete t.wins[prefix];
    delete unsafeWindow.cpopupWins[prefix];
  }    
}


// creates a 'popup' div
// prefix must be a unique (short) name for the popup window
function CPopup (prefix, x, y, width, height, enableDrag, onClose) {
  var pop = WinManager.get(prefix);
  if (pop){
    pop.show (false);
    return pop;
  }
  this.BASE_ZINDEX = 111111;
    
  // protos ...
  this.show = show;
  this.toggleHide = toggleHide;
  this.getTopDiv = getTopDiv;
  this.getMainDiv = getMainDiv;
  this.getLayer = getLayer;
  this.setLayer = setLayer;
  this.setEnableDrag = setEnableDrag;
  this.getLocation = getLocation;
  this.setLocation = setLocation;
  this.focusMe = focusMe;
  this.unfocusMe = unfocusMe;
  this.centerMe = centerMe;
  this.destroy = destroy;

  // object vars ...
  this.div = document.createElement('div');
  this.prefix = prefix;
  this.onClose = onClose;
  
  var t = this;
  this.div.className = 'CPopup '+ prefix +'_CPopup';
  this.div.id = prefix +'_outer';
  this.div.style.background = "#fff";
  this.div.style.zIndex = this.BASE_ZINDEX        // KOC modal is 100210 ?
  this.div.style.display = 'none';
  this.div.style.width = width + 'px';
  this.div.style.height = height + 'px';
  this.div.style.position = "absolute";
  this.div.style.top = y +'px';
  this.div.style.left = x + 'px';
  
  if (CPopUpTopClass==null)
    topClass = 'CPopupTop '+ prefix +'_CPopupTop';
  else
    topClass = CPopUpTopClass +' '+ prefix +'_'+ CPopUpTopClass;
    
  var m = '<TABLE cellspacing=0 width=100% height=100%><TR id="'+ prefix +'_bar" class="'+ topClass +'"><TD width=99% valign=bottom><SPAN id="'+ prefix +'_top"></span></td>\
      <TD id='+ prefix +'_X align=right valign=middle onmouseover="this.style.cursor=\'pointer\'" style="color:#fff; background:#333; font-weight:bold; font-size:14px; padding:0px 5px">X</td></tr>\
      <TR><TD height=100% valign=top class="CPopMain '+ prefix +'_CPopMain" colspan=2 id="'+ prefix +'_main"></td></tr></table>';
  document.body.appendChild(this.div);
  this.div.innerHTML = m;
  document.getElementById(prefix+'_X').addEventListener ('click', e_XClose, false);
  this.dragger = new CWinDrag (document.getElementById(prefix+'_bar'), this.div, enableDrag);
  
  this.div.addEventListener ('mousedown', e_divClicked, false);
  WinManager.add(prefix, this);
  
  function e_divClicked (){
    t.focusMe();
  }  
  function e_XClose (){
    t.show(false);
    if (t.onClose != null)
      t.onClose();
  }

  function focusMe (){
    t.setLayer(5);
    for (k in unsafeWindow.cpopupWins){
      if (k != t.prefix)
        unsafeWindow.cpopupWins[k].unfocusMe();
    }
  }
  function unfocusMe (){
    t.setLayer(-5);
  }
  function getLocation (){
    return {x: parseInt(this.div.style.left), y: parseInt(this.div.style.top)};
  }
  function setLocation (loc){
    t.div.style.left = loc.x +'px';
    t.div.style.top = loc.y +'px';
  }
  function destroy (){
    document.body.removeChild(t.div);
    WinManager.delete (t.prefix);
  }
  function centerMe (parent){
    if (parent == null){
      var coords = getClientCoords(document.body);
    } else
      var coords = getClientCoords(parent);
    var x = ((coords.width - parseInt(t.div.style.width)) / 2) + coords.x;
    var y = ((coords.height - parseInt(t.div.style.height)) / 2) + coords.y;
    if (x<0)
      x = 0;
    if (y<0)
      y = 0;
    t.div.style.left = x +'px';
    t.div.style.top = y +'px';
  }
  function setEnableDrag (tf){
    t.dragger.setEnable(tf);
  }
  function setLayer(zi){
    t.div.style.zIndex = ''+ (this.BASE_ZINDEX + zi);
  }
  function getLayer(){
    return parseInt(t.div.style.zIndex) - this.BASE_ZINDEX;
  }
  function getTopDiv(){
    return document.getElementById(this.prefix+'_top');
  }
  function getMainDiv(){
    return document.getElementById(this.prefix+'_main');
  }
  function show(tf){
    if (tf){
      t.div.style.display = 'block';
      t.focusMe ();
    } else {
      t.div.style.display = 'none';
    }
    return tf;
  }
  function toggleHide(t){
    if (t.div.style.display == 'block') {
      return t.show (false);
    } else {
      return t.show (true);
    }
  }
}

function CWinDrag (clickableElement, movingDiv, enabled) {
  var t=this;
  this.setEnable = setEnable;
  this.setBoundRect = setBoundRect;
  this.debug = debug;
  this.dispEvent = dispEvent;
  this.lastX = null;
  this.lastY = null;
  this.enabled = true;
  this.moving = false;
  this.theDiv = movingDiv;
  this.body = document.body;
  this.ce = clickableElement;
  this.moveHandler = new CeventMove(this).handler;
  this.outHandler = new CeventOut(this).handler;
  this.upHandler = new CeventUp(this).handler;
  this.downHandler = new CeventDown(this).handler;
  this.clickableRect = null;
  this.boundRect = null;
  this.bounds = null;
  this.enabled = false;
  if (enabled == null)
    enabled = true;
  this.setEnable (enabled);

  function setBoundRect (b){    // this rect (client coords) will not go outside of current body
    this.boundRect = boundRect;
    this.bounds = null;
  }

  function setEnable (enable){
    if (enable == t.enabled)
      return;
    if (enable){
      clickableElement.addEventListener('mousedown',  t.downHandler, false);
      t.body.addEventListener('mouseup', t.upHandler, false);
    } else {
      clickableElement.removeEventListener('mousedown', t.downHandler, false);
      t.body.removeEventListener('mouseup', t.upHandler, false);
    }
    t.enabled = enable;
  }

  function CeventDown (that){
    this.handler = handler;
    var t = that;
    function handler (me){
if (DEBUG_TRACE_DRAG) t.dispEvent ('eventDOWN', me);
      if (t.bounds == null){
        t.clickableRect = getClientCoords(clickableElement);
        t.bodyRect = getClientCoords(document.body);
        if (t.boundRect == null)
          t.boundRect = t.clickableRect;
if (DEBUG_TRACE_DRAG) logit ('Clickable rect: '+ inspect (t.clickableRect, 3, 1));
if (DEBUG_TRACE_DRAG) logit ('Body rect: '+ inspect (t.bodyRect, 3, 1));
if (DEBUG_TRACE_DRAG) logit ('Bound rect: '+ inspect (t.boundRect, 3, 1));
        t.bounds = {top:10-t.clickableRect.height, bot:t.bodyRect.height-25, left:40-t.clickableRect.width, right:t.bodyRect.width-25};
if (DEBUG_TRACE_DRAG) logit ("BOUNDS: "+ inspect (t.bounds, 8, 10));
      }
      if (me.button==0 && t.enabled){
        t.body.addEventListener('mousemove', t.moveHandler, true);
        t.body.addEventListener('mouseout', t.outHandler, true);
        t.lastX = me.clientX;
        t.lastY = me.clientY;
        t.moving = true;
      }
    }
  }

  function CeventUp  (that){
    this.handler = handler;
    var t = that;
    function handler (me){
if (DEBUG_TRACE_DRAG) t.dispEvent ('eventUP', me);
      if (me.button==0 && t.moving)
        _doneMoving(t);
    }
  }

  function _doneMoving (t){
if (DEBUG_TRACE_DRAG) logit ('doneMoving');
    t.body.removeEventListener('mousemove', t.moveHandler, true);
    t.body.removeEventListener('mouseout', t.outHandler, true);
    t.moving = false;
  }

  function CeventOut  (that){
    this.handler = handler;
    var t = that;
    function handler (me){
//t.dispEvent ('eventOUT', me);
      if (me.button==0){
        t.moveHandler (me);
      }
    }
  }

  function CeventMove (that){
    this.handler = handler;
    var t = that;
    function handler (me){
      if (t.enabled && !t.wentOut){
//t.dispEvent ('eventMOVE', me);
        var newTop = parseInt(t.theDiv.style.top) + me.clientY - t.lastY;
        var newLeft = parseInt(t.theDiv.style.left) + me.clientX - t.lastX;
        if (newTop < t.bounds.top){     // if out-of-bounds...
          newTop = t.bounds.top;
          _doneMoving(t);
        } else if (newLeft < t.bounds.left){
          newLeft = t.bounds.left;
          _doneMoving(t);
        } else if (newLeft > t.bounds.right){
          newLeft = t.bounds.right;
          _doneMoving(t);
        } else if (newTop > t.bounds.bot){
          newTop = t.bounds.bot;
          _doneMoving(t);
        }
        t.theDiv.style.top = newTop + 'px';
        t.theDiv.style.left = newLeft + 'px';
        t.lastX = me.clientX;
        t.lastY = me.clientY;
      }
    }
  }

  function debug  (msg, e){
    logit ("*************** "+ msg +" ****************");
    logit ('clientWidth, Height: '+ e.clientWidth +','+ e.clientHeight);
    logit ('offsetLeft, Top, Width, Height (parent): '+ e.offsetLeft +','+ e.offsetTop +','+ e.offsetWidth +','+ e.offsetHeight +' ('+ e.offsetParent +')');
    logit ('scrollLeft, Top, Width, Height: '+ e.scrollLeft +','+ e.scrollTop +','+ e.scrollWidth +','+ e.scrollHeight);
  }

  function dispEvent (msg, me){
    logit (msg + ' Button:'+ me.button +' Screen:'+ me.screenX +','+ me.screenY +' client:'+  me.clientX +','+ me.clientY +' rTarget: '+ me.relatedTarget);
  }
}

function inspect(obj, maxLevels, level, doFunctions){
  var str = '', type, msg;
  if(level == null)  level = 0;
  if(maxLevels == null) maxLevels = 1;
  if(maxLevels < 1)
      return 'Inspect Error: Levels number must be > 0';
  if(obj == null)
    return 'ERROR: Object is NULL\n';
  var indent = '';
  for (var i=0; i<level; i++)
    indent += '  ';
  for(property in obj) {
    try {
        type =  matTypeof(obj[property]);
        if (doFunctions==true && (type == 'function')){
          str += indent + '(' + type + ') ' + property + "[FUNCTION]\n";
        } else if (type != 'function') {
          str += indent + '(' + type + ') ' + property + ( (obj[property]==null)?(': null'):('')) +' = '+ obj[property] +"\n";
        }
        if((type=='object' || type=='array') && (obj[property] != null) && (level+1 < maxLevels))
          str += inspect(obj[property], maxLevels, level+1, doFunctions);  // recurse
    }
    catch(err) {
      // Is there some properties in obj we can't access? Print it red.
      if(typeof(err) == 'string') msg = err;
      else if(err.message)        msg = err.message;
      else if(err.description)    msg = err.description;
      else                        msg = 'Unknown';
      str += '(Error) ' + property + ': ' + msg +"\n";
    }
  }
  str += "\n";
  return str;
}

Array.prototype.compare = function(testArr) {
    if (this.length != testArr.length) return false;
    for (var i = 0; i < testArr.length; i++) {
        if (this[i].compare) {
            if (!this[i].compare(testArr[i])) return false;
        }
        if (this[i] !== testArr[i]) return false;
    }
    return true;
}
String.prototype.StripQuotes = function() {
return this.replace(/"/g,'');
} 
String.prototype.entityTrans = { '&':'&amp;', '<':'&lt;',  '>':'&gt;',  '\"':'&quot;' };
String.prototype.htmlEntities = function() {
  var ret = this.toString();
  for (k in this.entityTrans)
     ret  = ret.split(k).join(this.entityTrans[k]);
  return ret;
}

String.prototype.stripTags = function(){
  return this.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi, '');
}

String.prototype.capitalize = function(){
  return this.charAt(0).toUpperCase() + this.substring(1).toLowerCase();
}


function objectName (o){
  var s = o.toString();
  return s.substr(7,s.length-8);
}

function matTypeof (v){
  if (v == undefined)
    return 'undefined';
  if (typeof (v) == 'object'){
    if (!v)
      return 'null';
    else if (v.constructor.toString().indexOf("Array")>=0 && typeof(v.splice)=='function')
      return 'array';
    else return 'object';
  }
  return typeof (v);
}

function addCommasInt(n){
  nStr = parseInt(n) + '';
  var rgx = /(\d+)(\d{3})/;
  while (rgx.test(nStr)) {
    nStr = nStr.replace(rgx, '$1' + ',' + '$2');
  }
  return nStr;
}

function addCommas(nStr){
  nStr += '';
  x = nStr.split('.');
  x1 = x[0];
  x2 = x.length > 1 ? '.' + x[1] : '';
  var rgx = /(\d+)(\d{3})/;
  while (rgx.test(x1)) {
    x1 = x1.replace(rgx, '$1' + ',' + '$2');
  }
  return x1 + x2;
}

function addCommasWhole(nStr){
  nStr += '';
  x = nStr.split('.');
  x1 = x[0];
  x2 = x.length > 1 ? '.' + x[1] : '';
  var rgx = /(\d+)(\d{3})/;
  while (rgx.test(x1)) {
    x1 = x1.replace(rgx, '$1' + ',' + '$2');
  }
  return x1;
}
function htmlSelector (valNameObj, curVal, tags){
  m = [];
  m.push ('<SELECT');
  if (tags){
    m.push (' ');
    m.push (tags);
  }  
  for (k in valNameObj){
    m.push ('><OPTION ');
    if (k == curVal)
      m.push ('SELECTED ');
    m.push ('value="');
    m.push (k);
    m.push ('">');
    m.push (valNameObj[k]);
    m.push ('</option>');
  }
  m.push ('</select>');
  return m.join ('');

}


function unixTime (){
  return parseInt (new Date().getTime() / 1000) + unsafeWindow.g_timeoff;
}
function htmlOptions (a, curVal){
  m = '';
  for (k in a)
    m += '<OPTION value="'+ k +'"'+ (k==curVal?' SELECTED':'')  +'>'+ a[k] +'</option>';
  return m;
}
function getFunctionName (func){
  var name=/\W*function\s+([\w\$]+)\(/.exec(func);
  if (!name)
    return '';
  return name[1];
}

function findAllBetween (txt, find1, find2){
  var m = [];
  var last = 0;
  while ( (i1=txt.indexOf(find1, last))>=0 && (i2=txt.indexOf (find2, i1))>=0 ) {
    m.push (txt.substring(i1+find1.length, i2));
    last = i2 + find2.length;
  }
  return m;
}

function strUpTo (s, find){
  var i = s.indexOf(find);
  if (i > 0)
    return s.substr(0, i);
  return s;
}


/********
 Xd Xh
 Xh Xm
 Xm Xs

 Xs
********/
function timestrShort(time) {
  time = parseInt (time);
  if (time > 86400){
    var m = [];
    time /= 3600;
    m.push (parseInt(time/24));
    m.push ('T ');
    m.push (parseInt(time%24));
    m.push ('Std. ');
    return m.join ('');    
  } else
    return timestr (time);
}

/**********************
 part       full
 Xd Xh Xm   Xd Xh Xm Xs
 Xh Xm      Xh Xm Xs
 Xm Xs      Xm Xs
 Xs         Xs
**********************/
function timestr(time, full) {
  time = parseInt (time);
  var m = [];
  var t = time;
  if (t < 61)
    return  t + 's';
  if (t > 86400){
    m.push (parseInt(t/86400));
    m.push ('T ');
    t %= 86400;
  }  
  if (t>3600 || time>3600){
    m.push (parseInt(t/3600));
    m.push ('Std. ');
    t %= 3600;
  }  
  m.push (parseInt(t/60));
  m.push ('m');
  if (full || time<=3600 ){
    m.push (' ');
    m.push (t%60);
    m.push ('s');  
  }
  return m.join ('');
}

/************  LIB singletons .... **************/
function timestrcolon(time) {
 seconds = parseInt (time);
 var t, u;
 var secs86400 = seconds % 86400;
 var numhours = Math.floor(secs86400 / 3600);
 t = '00' + numhours;
 t = t.substr(t.length-2,2) + ':';
 var numminutes = Math.floor((secs86400 % 3600) / 60);
 u = '00' + numminutes;
 t += u.substr(u.length-2,2) + ':';
 var numseconds = (secs86400 % 3600) % 60;
 u = '00' + numseconds;
 t += u.substr(u.length-2,2);
 return t;
} 
// TODO: fix REopening window
var WINLOG_MAX_ENTRIES = 1000;     // TODO
var WinLog = {
  state : null,
  win: null,
  eOut : null,
  lastE : null,
  enabled : true,
  reverse : true,
  busy : false,
isOpening : false,

  open : function (){
    var t = WinLog;

    function eventButClear(){
      var t = WinLog;
      t.lastE = null;
      t.eOut.innerHTML ='';
    }
    function eventButReverse(){
      var t = WinLog;
      if (t.busy)
        return;
      t.busy = true;
      if (t.reverse){
        t.win.document.getElementById('wlRev').value= 'Top';
        t.reverse = false;
      } else{
        t.win.document.getElementById('wlRev').value= 'Bottom';
        t.reverse = true;
      }
      var n = t.eOut.childNodes.length;
      if (n < 2)
        return;
      for (i=n-2; i>=0; i--){
        t.eOut.appendChild (t.eOut.childNodes[i]);
      }
      t.busy = false;
    }
    
    if (!t.win || t.win.closed){
t.isOpening = true;  
// Firefox bug??? It appears as if a new thread is started on open, withOUT reusing same window
      //t.win = window.open('', 'uwtrace', 'top=30,left=0,width=900,height=700,scrollbars=no,location=no,menubar=no,directories=no,status=no');
	  t.win = new CPopup('ptwinlog', 0, 0, 500, 800, true, function(){t.win.destroy(); t.win=null; t.win.closed=true;});
	  t.win.show(true);
t.isOpening = false; 
t.state = null; 
    }
    
    if (t.state == null){
      t.win.getMainDiv().innerHTML = '<STYLE>pre{margin:0px} hr{margin:3px; height:1px; border:0px; color:#cee; background-color:#cee}</style>\
        <BODY style="margin:0px; padding:0px; border:none">\
        <DIV id=winlogtop style="background-color:#d0d0d0; margin:0px; padding:0px; border:1px solid">\
        <INPUT id=wlClear type=submit value="Clear"> &nbsp; <INPUT id=wlRev type=submit value="Bottom"></div>\
        <DIV id=wlOut style="overflow-y:auto; overflow-x:auto; height:750px; max-height:800px; width:600px"></div></body>';
      document.getElementById('wlClear').addEventListener('click', eventButClear, false);
      document.getElementById('wlRev').addEventListener('click', eventButReverse, false);
      t.eOut =  document.getElementById('wlOut');
      t.lastE = null;
      t.state = 1;
    }
  },

  writeText : function (msg){
    WinLog.write (msg.htmlEntities()); 
  },
  
  write : function (msg){
    var t = WinLog;
    if (!t.enabled || t.isOpening)
      return;
    t.open();
    var te = document.createElement('pre');
    var now = new Date();
    var m = [];
    var millis = now.getMilliseconds();
    m.push (now.toTimeString().substring (0,8));
    m.push ('.');
    if (millis<100)
      m.push('0');
    if (millis<10)
      m.push('0');
    m.push(millis);
    m.push (': ');
    m.push (msg);
    te.innerHTML = m.join('');

    if (t.reverse){
      if (t.lastE == null){
        t.eOut.appendChild(te);
        t.lastE = te;
      } else {
        t.eOut.insertBefore(te, t.lastE);
      }
      var hr = document.createElement('hr');
      t.eOut.insertBefore(hr, te);
      t.lastE = hr;
    } else {
      t.eOut.appendChild(te);
      t.eOut.appendChild(document.createElement('hr'));
    }
  },
};
 function formatUnixTime (unixTimeString,format){
	var rtn = unsafeWindow.formatDateByUnixTime (unixTimeString);
/*if (format=='24hour') {
		if (rtn.substr(14,2)=='AM')
			rtn = rtn.substr(0,13);
		else
			rtn = rtn.substr(8,2)+' '+rtn.substr(0,8)+(parseInt(rtn.substr(8,2))+12)+rtn.substr(10,3);
	} */
	return rtn;
}
function getAllianceLeaders (){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetLeaders.php" + unsafeWindow.g_ajaxsuffix, {
		 method: "post",
		 parameters: params,
		 loading: true,
		 onSuccess: function (rslt) {
		 rslt = eval("(" + rslt.responseText + ")");
		 if (rslt.officers) {
			 Options.AllianceLeaders = [];
       for (add in rslt.officers) {
          Options.AllianceLeaders.push(rslt.officers[add]['userId']);
       }
     } 
     else {
			  setTimeout(function(){getAllianceLeaders;}, 1500);
		  }
		},
		onFailure: function () {}
  		});
};


ptStartup ();
var AudioAlert = {
  alert : true,
  init : function(){
    var t = AudioAlert;
	//t.whisperalert();
	t.creatediv();
  },
  
  creatediv : function(){
  var diva = document.getElementsByTagName('div');
	for (var i = 0; i < diva.length - 1; i++)
		if (diva[i].className == 'mod_comm_forum')
			e = diva[i];
	alertDiv = document.createElement("span");
	alertDiv.setAttribute("id", "alertDiv");
	e.appendChild(alertDiv);
  },
  
  sound : function(tf){
   var t = AudioAlert;
	
	var divs = document.getElementById('alertDiv');	

	if(tf){
	divs.innerHTML = '<iframe src="http://koc.god-like.info/fluester.html" height="20" width="100"></iframe>';
	t.alert = true;
	} else {
		divs.innerHTML = "<b style='color: rgb(165, 102, 49); font-size: 9px;'>Audio Alert Played</b>";
	t.alert = false;
	}
	
	if(t.alert)
	setTimeout(function(){t.sound(false)},10000);
  },
  
  scanalliancechat : function(){
  
  },
  
  whisperalert : function(){
  var divs = document.getElementsByTagName('div');
	for (var i = 0; i < divs.length - 1; i++) {
		if (divs[i].className == 'comm_tabs seltab2') {
		bS = document.getElementsByTagName('b')
			for (var j = 0; j < bS.length - 1; j++) 
				if (bS[j].innerHTML == ' flüstert:')
					AudioAlert.sound(true);
		}
	}
  },
  
}

GM_setValue("lastMsgTime", "0000");//hold the previous msg alert time.
//alert('got here');

function check_html(){
    var divCollection = document.getElementsByTagName('div');
    var div_collection_adjusted = divCollection.length - 1;
    for (var i = 0; i < div_collection_adjusted; i++) {
        if ((divCollection[i].getAttribute("class") == "tx" && divCollection[i].innerHTML == "****")) {
            var new_msg_index = i;
            i = divCollection.length - 1;
            
            var tx_div_collection = divCollection[new_msg_index].parentNode.parentNode.getElementsByTagName('span');
            //var tx_div_collection_adjusted = tx_div_collection.length -1;
            
            for (var j = 0; j < tx_div_collection.length; j++) {
                if (tx_div_collection[j].getAttribute("class") == "time") {
                    //alert("got here");
                    if (tx_div_collection[j].innerHTML != GM_getValue("lastMsgTime")) {
                        GM_setValue("lastMsgTime", tx_div_collection[j].innerHTML);
                        //alert("got here");
                        iframe = document.createElement("iframe");
                        iframe.setAttribute("src", "http://koc.god-like.info/fluester.html");
                        iframe.setAttribute("width", "100");
                        iframe.setAttribute("height", "20");
                        //void(document.body.appendChild(iframe));
                        //alert("got here");		
                        void (divCollection[new_msg_index].parentNode.appendChild(iframe));
                        divCollection[new_msg_index].className = 'edited';
                    }
                }
                
            }
        }
    }
}

function scan_allianceChat(){
    try {
	   if (Options.WhisperOn==false){ 
}
else
        //this should isolate the stuff in alliance chat. seltab2 = alliance.
        var foundMsg = false;
        
        var divs = document.getElementsByTagName('div');
        for (var i = 0; i < divs.length - 1; i++) {
            if (divs[i].className == 'comm_tabs seltab2') {
                //Ok we have now detected that chat is set to alliance.
                
                bS = document.getElementsByTagName('b')
                for (var j = 0; j < bS.length - 1; j++) {
                    if (bS[j].innerHTML == ' flüstert dir zu:') {
                        //ok we have now found a whisper to you.
                        if (foundMsg == false) {
                            foundMsg = true;
                            
                            //now find the message time.
                            //var msgSpan = bS[j].parentNode.getElementsByTagName('span')[0].innerHTML;
                            //if (GM_getValue("lastMsgTime") != msgSpan) {
							//	alert('got here');
                            //  GM_setValue("lastMsgTime", msgSpan);
							//	alert('have set message value');
                                bS[j].innerHTML = ' flüstert dir zu:';
                                alertDiv = document.createElement("div");
                                alertDiv.innerHTML = '<iframe src="http://koc.god-like.info/fluester.html" height="20" width="100"></iframe>';
                                alertDiv.setAttribute("class", "alertDiv");
                                
                                void (bS[j].appendChild(alertDiv));
                                
                                window.setTimeout(function(){
                                    var divs = document.getElementsByTagName('div');
                                    for (var i = 0; i < divs.length - 1; i++) {
                                        if (divs[i].className == 'alertDiv') {
                                            divs[i].innerHTML = "Flüster Alarm Abgespielt!";
                                        }
                                    }
                                }, 10000);
                                
                                
                            //}
                        }
                    }
                }
            }
        }
    } 
    catch (err) {
        alert(err);
    }
}


window.setInterval(function(){
    scan_allianceChat();
    //check_html()
}, 5000);