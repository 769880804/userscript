// ==UserScript==
// @id          vnsharing
// @name        vnsharing
// @namespace   vnsharing.net
// @description Bộ công cụ hữu ích dành cho các bbcoder Vnsharing.
// @include     http://vnsharing.net/forum/newreply.php*
// @include     http://vnsharing.net/forum/visitormessage.php*
// @include     http://vnsharing.net/forum/newthread.php*
// @include     http://vnsharing.net/forum/private.php*
// @include     http://vnsharing.net/forum/editpost.php*
// @icon        http://vnsharing.net/forum/images/giaodien2/misc/favicon.ico
// @screenshot  http://i1071.photobucket.com/albums/u513/Kaldorei89/vnsharing_zpsb99ac394.jpg
// @screenshot  http://i1071.photobucket.com/albums/u513/Kaldorei89/vnsharing2_zps7ae3b002.jpg
// @author      Kaldorei http://vnsharing.net/forum/member.php?u=366921
// @homepageURL http://vnsharing.net/forum/forumdisplay.php?f=978
// @supportURL  http://vnsharing.net/forum/member.php?u=366921
// @version     1
// @run-at      document-end
// @resource    style https://googledrive.com/host/0B8k8spTx-FTdeld0ajB2dHoxVmc/style.css
// @resource    toolbarDataDefault https://googledrive.com/host/0B8k8spTx-FTdeld0ajB2dHoxVmc/toolbarDataDefault.txt
// @resource    config https://googledrive.com/host/0B8k8spTx-FTdeld0ajB2dHoxVmc/config.html
// @resource    datagen https://googledrive.com/host/0B8k8spTx-FTdeld0ajB2dHoxVmc/datagen.html
// @priority    1
// ==/UserScript==
function getbyid(e){return document.getElementById(e)}function bbcodeToolbar(e){function r(e,n,r,i,s){this.name=e;this.prefix=n;this.suffix=r;this.position=i;this.defaultValue=s;this.func=function(){var e=t.value;var o=t.selectionStart;var u=t.selectionEnd;if(i!==0){this.defaultValue=prompt("Nhập giá trị mong muốn:",s);if(this.defaultValue===null)return}if(window.chrome){var a=n.substr(0,i)+this.defaultValue+n.substr(i)+e.substring(o,u)+r;var f=document.createEvent("TextEvent");f.initTextEvent("textInput",true,true,null,a);t.dispatchEvent(f)}else{t.value=e.substring(0,o)+n.substr(0,i)+this.defaultValue+n.substr(i)+e.substring(o,u)+r+e.substring(u)}t.selectionStart=o;t.selectionEnd=u+n.length+this.defaultValue.length+r.length;t.focus()}}function l(e){if($){$("#"+e).slideToggle("medium")}else{var t=getbyid(e);t.className=t.className==="show"?"hide":"show"}}function c(){toolbarData=GM_getValue("bbcodeToolbar",GM_getResourceText("toolbarDataDefault"));l("configDiv");getbyid("dataEditor").value=toolbarData}var t=getbyid("vB_Editor_001_textarea");var n=document.createElement("div");getbyid("vB_Editor_001_controls").appendChild(n);n.id="bbToolbar";var s=e.split("~");var o=[];while(s.length>0){o.push(s.splice(0,5))}for(i=0;i<o.length;i++){o[i]=new r(o[i][0],o[i][1],o[i][2],Number(o[i][3]),o[i][4])}for(i=0;i<o.length;i++){var u=document.createElement("input");n.appendChild(u);u.type="button";u.value=o[i].name;u.className="bbButton";u.onclick=o[i].func.bind(o[i])}var a=document.createElement("input");document.querySelector("#vB_Editor_001_controls>table:first-of-type td:nth-child(12)").appendChild(a);a.type="button";a.value="Configuration";a.className="bbButton";a.id="configBtn";a.onclick=c;var f=document.createElement("div");n.appendChild(f);f.id="configDiv";f.className="hide";f.innerHTML=GM_getResourceText("config");getbyid("openTool").addEventListener("click",function(e){e.preventDefault();var t=GM_getResourceURL("datagen");if(window.chrome)t="https://googledrive.com/host/0B8k8spTx-FTdeld0ajB2dHoxVmc/datagen.html";GM_openInTab(t)});getbyid("btnSaveData").addEventListener("click",function(){GM_setValue("bbcodeToolbar",getbyid("dataEditor").value);l("configDiv")});getbyid("btnDefaultData").addEventListener("click",function(){getbyid("dataEditor").value=GM_getResourceText("toolbarDataDefault")})}function bbcodeInstantPreview(){function i(){r.className="bbButton working";var e=getbyid("vB_Editor_001_textarea");if(e.style.display=="none"){alert("Không hỗ trợ cho khung soạn thảo dạng trù phú!\nXin hãy đổi sang dạng thường hoặc dạng cơ bản");return}var t=encodeURIComponent(e.value);s(t)}function s(r){GM_xmlhttpRequest({method:"POST",url:"http://vnsharing.net/forum/newreply.php",headers:{"Content-type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},data:"do=postreply&preview=Preview+Message&parseurl=1&message="+r+"&t="+e+"&securitytoken="+t,onload:function(e){var t=(new DOMParser).parseFromString(e.responseText,"text/html");if(!t.forms["vbform"]){alert(n);return}var r=t.forms["vbform"].previousElementSibling.previousElementSibling;o(r)}})}function o(e){r.className="bbButton";var t;if(/private/.test(window.location)){if(document.forms["vbform"].childElementCount==3){var n=vbform.children[0];n.style.marginTop="1em";vbform.insertBefore(e,n)}else{vbform.replaceChild(e,vbform.getElementsByTagName("table")[0])}}else{t=vbform.previousElementSibling.previousElementSibling;t.parentNode.replaceChild(e,t)}scrollToPreview();fixTab();if($)fixTip()}var e="674149";var t=document.getElementsByName("securitytoken")[0].value;var n="Có lỗi xảy ra, xin kiểm tra lại:\n- bài post của bạn trên 10 kí tự?\n- nick hiện tại có quyền post bài, post ảnh, link..?\n- forum đang hoạt động bình thường?";var r=document.createElement("input");getbyid("vB_Editor_001").appendChild(r);r.type="button";r.value="Instant Preview (Alt-Shift-Z)";r.accessKey="z";r.className="bbButton";r.style.cssFloat="right";r.addEventListener("click",i)}function fixTip(){var e=document.querySelectorAll('div[id^="data_tooltip"]');var t=e.length;for(i=0;i<t;i++){var n=e[i].id.replace(/data\_tooltip\_/,"tooltip");$("."+n).tooltip()}}function fixTab(){var e=document.getElementById("fixTab");if(e)document.body.removeChild(e);var t=document.createElement("script");t.id="fixTab";t.src="clientscript/tabber.js";document.body.appendChild(t)}function scrollBtn(){var e=document.createElement("img");e.src="http://i1071.photobucket.com/albums/u513/Kaldorei89/z_zpsc3c86314.png";e.id="scrol";document.body.appendChild(e);e.onclick=function(){scrollCount+=1;if(scrollCount%2==0)scrollToPreview();else getbyid("vB_Editor_001").scrollIntoView(true)}}function scrollToPreview(){if($){$("html, body").animate({scrollTop:450})}else{window.scrollTo(0,450)}}var $=false;if(unsafeWindow.jQuery)$=unsafeWindow.jQuery;var toolbarData=GM_getValue("bbcodeToolbar",GM_getResourceText("toolbarDataDefault"));var vbform=document.forms["vbform"];GM_addStyle(GM_getResourceText("style"));bbcodeToolbar(toolbarData);bbcodeInstantPreview();scrollBtn();var scrollCount=0
