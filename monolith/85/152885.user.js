// ==UserScript==
// @name          RenRen Mark
// @description   关注一条人人新鲜事
// @include       http://*.renren.com/*
// ==/UserScript==

function e(e){var t=document.createElement("script");t.textContent="("+e.toString()+")()",document.body.appendChild(t)}function t(e){var t=document.createElement("style");t.textContent=e,document.getElementsByTagName("head")[0].appendChild(t)}function n(){if(window.XN&&XN.pageId==="home"){var e=function(e){var t=$element("a");return t.href="javascript:void(0);",t.html(e),t},t=function(t){if(t.id){var n=null,r=Sizzle(".legend",t)[0];r.getAttribute("data-renren-mark-btn")||(localStorage[t.id]?n=e("Marked"):(n=e("Mark"),n.addClass("renren-mark-button")),n.addClass("renren-mark-button-style"),r.appendChild(n),r.setAttribute("data-renren-mark-btn",!0))}},n=function(){var e=document.getElementsByClassName(".feed-list")[0];Sizzle("article.a-feed",e).forEach(t)},r=function(e,t,n){var r=e.oid,i=e.cid,s=e.typeNum,t="c="+encodeURIComponent(t)+"&owner="+r+"&rpLayer=0&source="+i+"&t="+s;new XN.net.xmlhttp({url:e.sendURI,method:"post",data:t,onSuccess:function(e){e=XN.JSON.parse(e.responseText),n&&n(e)}})},i=function(e,t,n){var r=e.delURI;if(e.type=="zhan"||e.type=="minigroup")r=r.replace("{{commentId}}",t);new XN.net.xmlhttp({url:r,data:"replyId="+t+"&source="+e.cid+"&doingId="+e.cid+"&owner="+e.oid+"&t="+e.typeNum+"&createId="+XN.user.id,method:"post",onSuccess:function(){n&&n()}})},s=function(e,t){var n=e.id.split("-")[1],n=$("reply-params-"+n).innerHTML,s=JSON.parse(XN.string.trim(XN.string.unescapeHTML(n)));r(s,"mark",function(e){i(s,e.id,t)})},o=function(){XN.element.delegate(document.body,".renren-mark-button","mousedown",function(){var e=$(this),t=XN.element.parent(e,"article.a-feed");s(t,function(){localStorage[t.id]=!0,e.innerHTML="Marked",e.delClass("renren-mark-button")})}),XN.element.delegate(document.body,".show-new-feed","mousedown",function(){var e=Sizzle(".new-feed-tip")[0].style;setTimeout(function(){e.display=="none"?setTimeout(n,500):setTimeout(arguments.callee,100)},100)})},u=function(){setTimeout(function(){window.newsfeed?window.newsfeed.addEvent("append",function(){setTimeout(n,500)}):setTimeout(arguments.callee,100)},100)};o(),n(),u(),window.asyncHTMLManager.addEvent("load",function(){o(),setTimeout(function(){n(),u()},500)})}}var r=".renren-mark-button-style{text-decoration:none;padding-right:10px;float:right;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAABEUlEQVR42u2SO2oCURiFTZXCLcQmTCUzA/Oe2UFIk05cg9lDsoxkCRZamcpdiJDnBpSAoliZxOQ7cAsxd8BHEYRcOPzPc+b+c/9K5eiP7/tVcGZQ3VsoDMMoTdNunuejoigmgvwsyzqqbatzkiTJBcQ+Ap/YBQID7NLET8oZv69ecaxKjuOcQr6h+YPmObe79zzvHP+R3Lfy1EeM7aqmHgnj34r762Y0tMEKUg/UTa4hMeIluCJ+xbZUC4Kgjv8gjribN7UKYptrgpfUX7DXa4K9MkHbyHdxHGvkN4nqP1J/j6LIU414ppHFsY1c+ihgaD7yBfl560cpWxvIYzA1GCu3y9pYF9t13Zpw0GL/n787P3LsiG0XWQAwAAAAAElFTkSuQmCC) no-repeat;padding-left:21px;}";t(r),e(n);