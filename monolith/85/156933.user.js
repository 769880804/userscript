// ==UserScript==
// @name 		     TW Gold Jobs Finder
// @description   Shows the list of all silver and gold jobs
// @author 		Macabre2077
// @author 		tw81 (Italian translation)
// @author 		Jakovlev (Hungarian translation)
// @author 		realfan2002 (Romanian translation)
// @version 	     0.8
// @include 	http://*.the-west.*/game.php*
// ==/UserScript==

// TODO: sorting from a-z in export and list as well

function exec(fn) {
    var script = document.createElement('script');
    script.setAttribute("type", "application/javascript");
    script.textContent = '(' + fn + ')();';
    document.body.appendChild(script); // run the script
    document.body.removeChild(script); // clean up
}

exec(function() {
	
var VERSION = 0.8;
	
if(window.hasOwnProperty("GoldJobs") && GoldJobs.version > VERSION) return;
	
GoldJobs = {
	version: VERSION,
	CHECK_FILE_URL: 0,
	CHECK_FILE_URL: "http://macabre2077.koding.com/userscripts/the-west/goldjobs/getVersion.php",
    SCRIPT_SITE: "http://userscripts.org/scripts/show/154884",
	toLoad: 0,
	loaded: 0,
	xMax:181,
	yMax:79,
	xMin:0,
	yMin:0,
	blockMaxLength:300,
	dataLoaded: false,
	silverJobBbColor: "#708090",
	goldJobBbColor: "#f4c430",
};

GoldJobs.languages = {
	"ru_RU": {
		jobIcob: "Иконка",
		jobName: "Название работы",
		distanceTime: "Время",
		showJob: "Показать",
		title: "Золотые и серебряные работы",
		changelist: "Список изменений",
		version: "версия",
		parseMap: "1. Получить данные",
		openJobsWindow: "2. Открыть список работ",
		loaded: "Загружено: ",
		update_available: "Доступно обновление скрипта Gold Jobs",
		update_question: "Вы можете скачать новую версию с сайта userscripts.org. Перейти?",
		loading: "Загрузка... Это займет примерно 20 секунд",
		noNeedToLoad:"Нет необходимости загружать заново данные",
		reloadData:"Загрузить заново данные?",
		exportTitle: "Поделиться результатами",
		exportButtonTitle: "Поделиться",
		generatedBy: "Получено с помощью TW Gold Jobs Finder",
		generatedByBb: "[i][url="+GoldJobs.SCRIPT_SITE+"]Получено с помощью TW Gold Jobs Finder[/url][/i]",
		plainText: "Без BB-кода",
		bbCode: "С BB-кодом"
	},
	"en_US": {
		jobIcob: "Icon",
		jobName: "Job name",
		distanceTime: "Travel time",
		showJob: "Show",
		title: "Gold And Silver Jobs",
		parseMap: "1. Get data",
		openJobsWindow: "2. Open jobs window",
		loaded: "Loaded: ",
		changelist: "Changelist",
		version: "version",
		update_available: "Gold Jobs update available",
		update_question: "You can download the latest version from userscripts.org. Visit the site?",
		loading: "Loading... It will take a while",
		noNeedToLoad:"There is no need for data to be loaded again",
		reloadData:"Load data again?",
		exportTitle: "Share",
		exportButtonTitle: "Share",
		generatedBy: "Generated by TW Gold Jobs Finder",
		generatedByBb: "[i][url="+GoldJobs.SCRIPT_SITE+"]Generated by TW Gold Jobs Finder[/url][/i]",
		plainText: "Plain Text",
		bbCode: "BB code"
	}, 
	"it_IT": {
		jobIcob: "Icona",  
		jobName: "Nome lavoro",  
		distanceTime: "Tempo di viaggio",  
		showJob: "Mostra",  
		title: "Lavoro Oro e Argento",  
		parseMap: "1. Importa dati",  
		openJobsWindow: "2. Apri posti di lavoro",  
		loaded: "Caricato: ",  
		changelist: "Elenco modifiche",  
		version: "versione",  
		update_available: "E' disponibile un aggiornamento per TW Gold Jobs Finder",  
		update_question: "È possibile scaricare la versione più recente dal userscripts.org. Visita il sito?",  
		loading: "Caricamento in corso ... Ci vorrà un po '" ,
		noNeedToLoad:"Non vi è alcun bisogno di caricare nuovamente i dati",  
		reloadData:"Caricare i dati di nuovo?",  
		exportTitle: "Cita",  
		exportButtonTitle: "Cita",  
		generatedBy: "Generato da TW Gold Jobs Finder",  
		generatedByBb: "[i][url="+GoldJobs.SCRIPT_SITE+"]Generato da  TW Gold Jobs Finder[/url][/i]",  
		plainText: "Testo normale",  
		bbCode: "BB code"  
	},
	"hu_HU": {
		jobIcob: "Ikon",  
		jobName: "Munka neve",  
		distanceTime: "Menetidő",  
		showJob: "Mutatás",  
		title: "Arany és ezüst munkák",  
		parseMap: "1. Adatok importálása",  
		openJobsWindow: "2. Munkák mutatása",  
		loaded: "Töltés: ",  
		changelist: "Változások",  
		version: "verzió",  
		update_available: "Gold Jobs frissítés elérhető",  
		update_question: "Letöltheted a legújabb verziót itt: userscripts.org. Megnyitod az oldalt?",  
		loading: "Kis türelmet, töltés alatt...",  
		noNeedToLoad:"Nem szükséges az adatok újratöltése.",  
		reloadData:"Újra importálod az adatokat?",  
		exportTitle: "Megosztás",  
		exportButtonTitle: "Megosztás",  
		generatedBy: "TW Gold Jobs Finder által létrehozva",  
		generatedByBb: "[i][url="+GoldJobs.SCRIPT_SITE+"]TW Gold Jobs Finder által létrehozva[/url][/i]",  
		plainText: "Szövegként",  
		bbCode: "BB kód"
	},
	"ro_RO": {
		jobIcob: "Imagine",  
		jobName: "Denumirea muncii",  
		distanceTime: "Distanţa",  
		showJob: "Arată",  
		title: "Munci aurii şi argintii",  
		parseMap: "1. Obţine datele",  
		openJobsWindow: "2. Deschide fereastra cu munci",  
		loaded: "Încărcat: ",  
		changelist: "Lista modificărilor",  
		version: "versiune",  
		update_available: "Actualizare disponibilă",  
		update_question: "Puteţi descărca cea mai recentă versiune de pe userscripts.org. Doriţi să vizitaţi pagina?",  
		loading: "Se încarcă... Poate dura ceva timp!",  
		noNeedToLoad:"Nu este necesar reîncărcarea datelor!",  
		reloadData:"Reîncarc datele?",  
		exportTitle: "Distribuiţi",  
		exportButtonTitle: "Distribuiţi",  
		generatedBy: "Generat cu TW Gold Jobs Finder",  
		generatedByBb: "[i][url="+GoldJobs.SCRIPT_SITE+"]Generat cu TW Gold Jobs Finder[/url][/i]",  
		plainText: "Text simplu",  
		bbCode: "BB code"  
	}
};

GoldJobs.parseWholeMap = function() {
	this.loaded = 0;
	
	var x,y;
	var arr = [];
	var currentBlock = 0;
	var currentBlockLength = 0;
	for(x=this.xMin; x<=this.xMax; x++) {
		for(y=this.yMin; y<=this.yMax; y++) {
			if(currentBlockLength == 0) {
				arr[currentBlock] = [];
			}
			arr[currentBlock].push([x,y]);
			if(++currentBlockLength == this.blockMaxLength) {
				currentBlock++;
				currentBlockLength = 0;
			}
		}
	}

	var i, to = arr.length;
	this.toLoad = to;
	for(i=0;i<to;i++){
		Map.Data.Loader.load(arr[i], function(){
			GoldJobs.loaded++;
		});
	}
};

GoldJobs.getIcon = function(x, y) {
	return '<a href="javascript:Map.center('+x+','+y+');" style="display: inline-block;background: url(http://www.the-west.ru/images/tw2gui/window/window2_title_divider.jpg) no-repeat;width: 15px;height: 15px;"></a>';
};

GoldJobs.addColumnsCss = function() {
	$('.goldenJobs .jobIcon').css('width' , '60px');
	$('.goldenJobs .jobName').css('width' , '160px');
	$('.goldenJobs .jobX').css('width' , '60px');
	$('.goldenJobs .jobY').css('width' , '60px');
	$('.goldenJobs .move').css('width' , '45px');
	$('.goldenJobs .distanceTime').css('width' , '75px');
	$('.goldenJobs .row').css('height' , '56px');
	$('.goldenJobs .row').css('background' , "none");

	$(".goldenJobs").find('.tw2gui_scrollpane').css("height", "280px");
};

GoldJobs.calculateDistance = function(jobX, jobY) {
	var to = {x: jobX, y: jobY};
	return Map.calcWayTime(Character.position, to).formatDuration();
};

GoldJobs.openWindow = function() {
	var content = $("<div class='jobwindow'/>");
	var table = GoldJobs.makeJobsTable("");
	var jobNameFilter = new tw2gui.textfield("job_name_search").setSize(20);
	var exportButton = new tw2gui.button(this.lang.exportButtonTitle,function() {
		var jobName = $("#job_name_search").val();
		var jobs = GoldJobs.jobsDataToBbString(jobName);
		GoldJobs.showExportWindow(jobs+GoldJobs.lang.generatedByBb, true);
	}).setWidth(100);
	
	var win = wman.open("goldenJobs").setResizeable(true).setMinSize(450, 475).setSize(450, 475).setMiniTitle(this.lang.title);
	content.append(table.getMainDiv());
	content.append(this.lang.jobName+": ");
	content.append(jobNameFilter.getMainDiv());
	content.append(exportButton.getMainDiv());
	win.appendToContentPane(content);	
	this.addColumnsCss();
	this.addFilterEvent();
};

GoldJobs.makeJobsTable = function(chosenJobName) {
	chosenJobName = chosenJobName.toLowerCase();
	var jobs = Map.JobHandler.Featured;
	var k, jobId, job, t, j;
	var result = {};
	var table = new tw2gui.table();
	table
		.addColumn('jobIcon', 'jobIcon')
		.addColumn('jobName', 'jobName')
		.addColumn('distanceTime', 'distanceTime')
		.addColumn('move', 'move');
	table.appendToCell('head', 'jobIcon', this.lang.jobIcon);
	table.appendToCell('head', 'jobName', this.lang.jobName);
	table.appendToCell('head', 'distanceTime', this.lang.distanceTime);
	table.appendToCell('head', 'move', this.lang.showJob);
	for(k in jobs) {
		var jobPlace = jobs[k];
		for(jobId in jobPlace) {
			job = JobList.getJobById(jobId);
			if(chosenJobName != "" && job.name.toLowerCase().indexOf(chosenJobName) < 0) continue;
			if(result.hasOwnProperty(jobId)) {
				result[jobId]++;
			} else {
				result[jobId] = 1				
			}
			j = jobPlace[jobId];
			t = j.gold ? "gold" : "silver";
			table.appendRow()
				.appendToCell(-1,"jobIcon", '<div class="job" style="left: 0; top: 0; position: relative;"><div class="featured '+t+'"></div><img src="http://www.the-west.ru/images/jobs/'+ job.shortname +'.png" class="job_icon"></div>')
				.appendToCell(-1,"jobName", job.name)
				.appendToCell(-1,"distanceTime", this.calculateDistance(j.x, j.y))
				.appendToCell(-1,"move", this.getIcon(j.x, j.y));
		}
	}

	console.log(result);
	return table;
};

GoldJobs.addFilterEvent = function() {
	var f = function() {
		if(GoldJobs.filterTimeout != undefined) {			
			clearTimeout(GoldJobs.filterTimeout);
		}
		GoldJobs.filterTimeout = setTimeout(function() {
			var jobName = $("#job_name_search").val();
			var newTable = GoldJobs.makeJobsTable(jobName);
			$(".goldenJobs .fancytable").remove();
			$(".jobwindow").prepend(newTable.getMainDiv());
			GoldJobs.addColumnsCss();
		}, 500);
	};
	$("#job_name_search").keypress(f);
	$("#job_name_search").change(f);
};

GoldJobs.checkUpdate = function() {
	var url = this.CHECK_FILE_URL;
	url += "?name="+Character.name;
	url += "&world="+location.hostname;
	url += "&usedToday="+this.isScriptUsedToday();
	url += "&callback=?";
	$.getScript(url);
};

GoldJobs.compareVersions = function(actualVersion) {
	if(parseFloat(this.version) >= parseFloat(actualVersion)) return;
	new MessageDialog(this.lang.update_available, "", MessageDialog.SYS_WARNING)
		.setText(this.lang.update_question)
		.addButton("OK",function(){
			window.open(GoldJobs.SCRIPT_SITE,'_blank');
		})
		.addButton("cancel")
		.show();
}

GoldJobs.intro = function(){
	if(localStorage.getItem('VipJobs.version') >= this.version) return;
	localStorage.setItem('VipJobs.version' , this.version);

	var title = 'Gold Jobs, '+this.lang.version+' '+this.version;
	var text = this.lang.changelist+':<br/><ul>';
	text += '<li>Hungarian and romanian translation thanks to Jakovlev and realfan2002</li>';
	text += '<li>Use it at your own risk!</li>';
	text += '</ul>';

	this.mb = new MessageDialog(title).addButton("ОК");
	this.mb.setText(text).show();
};

GoldJobs.init = function() {
	var div = $('<div class="ui_menucontainer">/');
	var link = $('<div class="menulink" style="background: url(http://www.the-west.ru/images/map/icons/jobicon.png);background-position: -4px -3px;"></div>');
	link.click(function() {
		GoldJobs.openSelectWindow()
	});
	div.append(link).append('<div class="loptions"></div><div class="menucontainer_bottom"></div>');
	$("#ui_menubar").append(div);
	GoldJobs.lang = GoldJobs.languages.hasOwnProperty(Game.locale) ? GoldJobs.languages[Game.locale] : GoldJobs.languages["en_US"];
};

GoldJobs.onButtonClick = function() {
	if(GoldJobs.dataLoaded) {
		new MessageDialog(GoldJobs.lang.reloadData, GoldJobs.lang.noNeedToLoad).setIcon(MessageDialog.SYS_QUESTION).setDefaultBtns(function () {
			GoldJobs.dataLoaded = false;
			GoldJobs.onButtonClick();
		}).show();
	} else {
		new UserMessage(GoldJobs.lang.loading,UserMessage.TYPE_SUCCESS).show();
		GoldJobs.parseWholeMap();
		// check if interval is visible from anonymized function
		var interval = setInterval(function() {
			if(GoldJobs.loaded < GoldJobs.toLoad) return;
			clearInterval(interval);
			GoldJobs.openWindow();
			GoldJobs.dataLoaded = true;
		},1000);
	}
};

GoldJobs.jobsDataToString = function(chosenJobName) {
	chosenJobName = chosenJobName.toLowerCase();
	var str = "";
	var jobs = Map.JobHandler.Featured;
	var k, jobId, job, t, j;
	for(k in jobs) {
		var jobPlace = jobs[k];
		for(jobId in jobPlace) {
			job = JobList.getJobById(jobId);
			if(chosenJobName != "" && job.name.toLowerCase().indexOf(chosenJobName) < 0) continue;
			j = jobPlace[jobId];
			t = j.gold ? "gold" : "silver";
			str += job.name + "; " + t + "; " + j.x + "-" + j.y + "; " + jobId + "\n";
		}
	}
	return str;
};

GoldJobs.jobsDataToBbString = function(chosenJobName) {
	chosenJobName = chosenJobName.toLowerCase();
	var str = "";
	var jobs = Map.JobHandler.Featured;
	var k, jobId, job, color, j;
	for(k in jobs) {
		var jobPlace = jobs[k];
		for(jobId in jobPlace) {
			job = JobList.getJobById(jobId);
			if(chosenJobName != "" && job.name.toLowerCase().indexOf(chosenJobName) < 0) continue;
			j = jobPlace[jobId];
			color = j.gold ? GoldJobs.goldJobBbColor : GoldJobs.silverJobBbColor;
			str += "[img]http://www.the-west.ru/images/jobs/"+ job.shortname +".png[/img][b][color="+color+"]"+job.name+"[/color][/b] (" +j.x + "; " + j.y + ")" + "\n";
		}
	}
	return str;
};

GoldJobs.showExportWindow = function(jobs, isBb) {
	var textarea = '<textarea style="height: 100px; width: 400px; background-color: transparent; border-width: 0px;" onclick="$(this).select()">'+jobs+'</textarea>';
	var md = new MessageDialog(this.lang.exportTitle).setText(textarea);
	var jobName = $("#job_name_search").val();
	if(isBb) {
		md.addButton(this.lang.plainText,function(){
			var jobs = GoldJobs.jobsDataToString(jobName);
			GoldJobs.showExportWindow(jobs+GoldJobs.lang.generatedBy, false);
		});
	} else {
		md.addButton(this.lang.bbCode,function(){
			var jobs = GoldJobs.jobsDataToBbString(jobName);
			GoldJobs.showExportWindow(jobs+GoldJobs.lang.generatedByBb, true);
		});
	}
	md.addButton('ok').show();
};

GoldJobs.openSelectWindow = function() {
	this.setScriptUsed();
	
	var button1 = new tw2gui.button(this.lang.parseMap,GoldJobs.onButtonClick).setWidth(245).getMainDiv();
	var button2 = new tw2gui.button(this.lang.openJobsWindow, function(){GoldJobs.openWindow();}).setWidth(245).getMainDiv();
	wman.open("goldenJobsSelect").setSize(300, 175).appendToContentPane(button1).appendToContentPane(button2);
};

GoldJobs.setScriptUsed = function() {
	localStorage.setItem('VipJobs.lastUseTime' , new Date().getTime());
};

GoldJobs.isScriptUsedToday = function() {
	var lastUse = localStorage.getItem('VipJobs.lastUseTime') || new Date().getTime();
	var lastUseDate = new Date(parseInt(lastUse));
	var now=new Date();
	return now.toDateString() == lastUseDate.toDateString();
};

$(document).ready(function() {
	try {
		GoldJobs.init();
		GoldJobs.checkUpdate();
		GoldJobs.intro();
	} catch(e) {
		console.log(e.stack);
		alert("Gold Jobs script error: " + e);
	}
});
})