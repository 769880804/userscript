// ==UserScript==
// @name		Library Deluxe
// @version		1.4
// @description	turns tokyo toshokan into a visual appealing library. 'tis a WIP so don't go wild in stabbing its instabilities.
// @run-at		document-start
// @match		*://*.tokyotosho.info/*
// @match		*://*.tokyotosho.net/*
// @match		*://*.tokyotosho.se/*
// @include		http://www.tokyotosho.info/*
// @include		http://www.tokyo-tosho.net/*
// @include		http://www.tokyotosho.se/*
// @include		http://tokyotosho.info/*
// @include		http://tokyo-tosho.net/*
// @include		http://tokyotosho.se/*
// @require		https://googledrive.com/host/0B3YLtiTla9ZvQi1qRzJORkUzQzQ/jquery.min.js
// @require		https://googledrive.com/host/0B3YLtiTla9ZvQi1qRzJORkUzQzQ/TweenLite.min.js
// @require		https://googledrive.com/host/0B3YLtiTla9ZvQi1qRzJORkUzQzQ/TimelineLite.min.js
// @require		https://googledrive.com/host/0B3YLtiTla9ZvQi1qRzJORkUzQzQ/CSSPlugin.min.js
// @copyright	2013, Dalon
// ==/UserScript==
/*! libraryDeluxe 2013-07-24 */
function onDOMInsert(){document.head&&!styleAdded&&(styleAdded=1,$(document.head).append("<style>#main { display: none; }</style>"),$(document.head).append('<link rel="stylesheet" href="'+(debugcss?debugcss:productioncss)+'" type="text/css" />'),$(document.head).append('<link rel="stylesheet" href="https://googledrive.com/host/0B3YLtiTla9ZvcmNIam5rVkJKc2M/icons.css" type="text/css" />'),console.log("customStyle added!")),document.body&&(document.removeEventListener("DOMNodeInserted",onDOMInsert),$(document.body).addClass("init"),"left"==preferences.align&&$(document.body).addClass("leftMenu"),console.log("customHtml added!"),init())}function init(){""===hash&&document.location.search.length>0?document.location.hash=url2hash(document.location.search).hash:setInterface(hash2url(hash)),$("body").append('<div id="loader" style="display:none"></div>'),$("body").prepend("<div id='header'>		<div id='sidebar'>			<div class='searchfield'>				<form name='loginBox' action='search.php' method='get' accept-charset='utf-8'>					<input  id='type' type='text' name='type' style='display:none;' />					<input  id='search' type='text' name='terms' placeholder='Search' />					<span aria-hidden='true' class='icon-search'></span>					<input type='submit' style='position: absolute; left: -9999px; width: 1px; height: 1px;' />				</form>			</div>			<div class='nav'>				<ul class='cat'></ul>			</div>		</div>		<div id='settings-menu'>			<h2><span aria-hidden='true' class='icon-cog'></span> Settings</h2>			<hr/><div id='keyw_settings'>				<h3><span aria-hidden='true' class='icon-flag'></span> Blacklist</h3>				<ul class='keywords'>				</ul>			</div>			<div id='cat_triggers'></div>		</div>		<div class='iconBar'>			<span aria-hidden='true' class='icon-newspaper'></span>			<span aria-hidden='true' class='icon-cog'></span>		</div>	</div>	<div id='wrapper'>		<section id='libview'>			<div class='spacer'></div>		</section>		<section id='blacklist'>			<div class='spacer'></div>		</section>		<div class='clearfix'></div>	</div>	<div class='overlay' title='Close' style='display:none'>		<iframe id='website' src='' sandbox='allow-same-origin'></iframe>	</div>");for(var a=$("div.nav>ul.cat"),b=0;b<category_order.length;b++)a.append('<li class="cat_'+category_order[b]+'"><a href="/?'+(0==b?"":"cat="+category_order[b])+'">'+category_list[category_order[b]]+"</a></li>"),~preferences.discardedCategories.indexOf(category_order[b])?($("#cat_triggers").append('<span aria-hidden="true" class="icon-eye-blocked cat_'+category_order[b]+'"></span>'),a.find(".cat_"+category_order[b]).addClass("discarded").hide()):$("#cat_triggers").append('<span aria-hidden="true" class="icon-eye cat_'+category_order[b]+'"></span>');for(b=0;b<preferences.keywords.blacklist.length;b++){var c=preferences.keywords.blacklist[b];$("#keyw_settings .keywords").append('<li><input type="text" value="'+c+'"/></li>')}$("#keyw_settings .keywords").append('<li><input class="add_keyword" type="button" value="+"></li>'),$("#libview"),api.init(),$(document).ready(function(){initInterface(!1),console.log([hash,hash.length>0]),hash.length>0?ttAjaxLoad(hash):spawnTiles(ttGetList(document.body))}),$(window).scroll(scrollTiles),$(window).resize(scrollTiles),$("#search").focus(function(){$(this).attr("placeholder","")}).blur(function(){$(this).attr("placeholder","Search")}).change(function(){console.log($(this).val())}).keyup(searchMagic).parent().submit(function(){return console.log("Submitting: "+$(this).serialize()),ttAjaxLoad("/search.php?"+$(this).serialize()),$("#search").blur(),!1});var d=["9","16","17","18","33","34","35","36","37","38","39","40","91"];$(window).keydown(function(a){~d.indexOf(a.which.toString())||document.activeElement==$("input:focus")[0]||($(".searchfield").is(":hidden")&&($("#sidebar>.searchfield").slideToggle(),$(".searchIcon").toggleClass("highlight")),$("#search")[0].focus())}),setInterval(hashCheck,100),$(".nav a").bind("click",ajaxInTT),$("#sidebar h1").click(function(){document.location="index.php"}),$(".icon-newspaper").on("click",function(){$("#sidebar>ul.news").slideToggle(),$(this).toggleClass("highlight")});var e=new TimelineLite;e.insert(TweenLite.to($("#header"),.3,{width:"500px"})),e.insert(TweenLite.to($("#wrapper"),.3,{left:"500px",right:"-300px"})),e.append(TweenLite.fromTo($("#settings-menu"),.01,{display:"none"},{display:"block"})),e.append(TweenLite.fromTo($("#settings-menu"),.3,{opacity:"0"},{opacity:"1"})),e.pause(),$(".icon-cog").on("click",function(){$(this).toggleClass("highlight"),$(this).hasClass("highlight")?(e.play(),$(".cat>.discarded").slideDown()):(checkKeywords(),e.reverse(),$(".cat>.discarded").slideUp())}),$("#cat_triggers>span").click(toggleCategory),$("#keyw_settings .add_keyword").click(addKeywordField),$("#header")[0].addEventListener("mousewheel",scrollHeader,!1)}function checkKeywords(){preferences.keywords.blacklist=[],$("#keyw_settings :input:not(.add_keyword)").each(function(){""!=$(this).val()?preferences.keywords.blacklist.push($(this).val()):$(this).parent().remove()}),setPreferences(),patt_blacklist=createBlacklistPatt()}function addKeywordField(){$(this).parent().before('<li><input type="text"/></li>'),$(this).parent().prev().find(":input").focus()}function createBlacklistPatt(){for(var a=[],b=preferences.keywords.blacklist.length-1;b>=0;b--)a.push(escape(preferences.keywords.blacklist[b]));return new RegExp(a.join("|"),"ig")}function toggleCategory(){var a;$(this).hasClass("icon-eye")?($(this).toggleClass("icon-eye"),a=parseFloat($(this).attr("class").replace("cat_","")),$(".nav .cat").find(".cat_"+a).addClass("discarded"),$(this).toggleClass("icon-eye-blocked"),preferences.discardedCategories.push(a)):($(this).toggleClass("icon-eye-blocked"),a=parseFloat($(this).attr("class").replace("cat_","")),$(".nav .cat").find(".cat_"+a).removeClass("discarded"),$(this).toggleClass("icon-eye"),preferences.discardedCategories.splice(preferences.discardedCategories.indexOf(a),1)),console.log(preferences),setPreferences()}function scrollHeader(a){var b=a||window.event,c=b.wheelDelta?b.wheelDelta/120:-b.detail/3,d=$("#sidebar").position().top,e=$("#sidebar").outerHeight(),f=$("#header").outerHeight();distance=10*c+d,0>c&&d+e>f?(distance>0?$("#sidebar").css("top",0):$("#sidebar").css("top",distance+"px"),b.preventDefault()):c>0&&0>d&&(distance>0?$("#sidebar").css("top",0):$("#sidebar").css("top",distance+"px"),b.preventDefault())}function openInIframe(a){1==a.which&&(a.preventDefault(),openIframe($(this).attr("href")))}function ajaxInTT(a){1==a.which&&(a.preventDefault(),ttAjaxLoad($(this).attr("href")))}function scrollTiles(){var a=0;$(".waitForAnimation").each(function(){isOnScreen(this)&&($(this).removeClass("waitForAnimation"),TweenLite.from($(this),.3,{delay:.1*a,opacity:0,top:200}),a++)})}function searchMagic(a){var b,c;if(0===searchLength&&8===a.which)$("#type").val(""),$(this).attr("class","");else if(c=$(this).val().match(/ ?([a-z\-]+)[@!#:]{1}/i),c||(c=$(this).val().match(/ ?[@!#:]([a-z\-]+)$/i)),c){for(var d=category_list.length-1;d>=0;d--)if(category_list[d].toLowerCase()==c[1].toLowerCase()){b=d;break}b&&($("#type").val(b),$(this).val($(this).val().replace(c[0],"")),$(".searchfield").removeClass(function(a,b){return(b.match(/cat_[0-9]+/g)||[]).join(" ")}).addClass("cat_"+b),$(".cat>li").removeClass("selected").parent().find(".cat_"+b).addClass("selected"))}searchLength=$(this).val().length}function openIframe(a){$(".overlay").show(),$(".overlay>#website").attr("src",a),$(".overlay").click(function(){$(this).hide()})}function skipOpening(a){window.localStorage.setItem("skip_opening",a)}function isOnScreen(a){var b=$(window).scrollTop(),c=b+$(window).height(),d=$(a).offset().top,e=d+$(a).height();return c>=d&&e>=b}function initInterface(a){skipOpening(!0),TweenLite.from($("#header"),1,{opacity:0}),TweenLite.from($("#wrapper"),1,{opacity:0}),$("#sidebar").prepend($("#main>ul.news")).prepend($(".searchfield")),$('.dcenter>a[href^="search.php?terms="]').each(function(){$("<li></li>").append(this).appendTo("div.nav>ul.hot")}),a&&spawnTiles(a)}function setInterface(a){a.cat?($(".cat>li").removeClass("selected"),$(".cat .cat_"+a.cat).addClass("selected"),$(".searchfield").removeClass(function(a,b){return(b.match(/cat_[0-9]+/g)||[]).join(" ")}).addClass("cat_"+a.cat),$("#type").val(a.cat)):($(".cat>li").removeClass("selected"),$(".nav .cat_all").addClass("selected"),$(".searchfield").removeClass(function(a,b){return(b.match(/cat_[0-9]+/g)||[]).join(" ")})),a.terms?$("#search").val(a.terms.split("+").join(" ")):$("#search").val("");var b,c;a.page>1||!a.terms&&a.page>0?(b="/"+(a.terms?"search.php?type=":"?cat=")+a.cat+"&page="+(a.page-1)+(a.terms?"&terms="+a.terms:""),$(".prevpage").show().find("a").attr("href",b)):$(".prevpage").hide(),c="/"+(a.terms?"search.php?type=":"?cat=")+a.cat+"&page="+(a.page+1)+(a.terms?"&terms="+a.terms:""),$(".nextpage a").attr("href",c)}function createTile(a,b){var c=$("<div class='tile cat_"+b.category+"'>		<a class='thumb'><img /><span class='score'></span></a>		<div class='titlebar'>			<h2 class='title'>"+a.title+"</h2>			<h3 class='group'>"+(a.group.length>0?a.group:"[unknown group]")+"</h3>			<div class='comment'>"+b.meta.comment+"</div>			<div class='files'>				<div class='download'>					<a href='"+b.link+"'>"+a.filename.replace(/_/g," ")+"</a>					<div class='meta'></div>				</div>			</div>		</div>		<div class='ribbon'></div>	</div>");a.episode&&(c.find(".titlebar").prepend('<div class="ep">'+a.episode+"</div>"),a.episode.length>5?c.find(".ep").addClass("smallest"):a.episode.length>3&&c.find(".ep").addClass("smaller")),c.find(".comment a").each(function(){try{$(this).html(decodeURI($(this).html()))}catch(a){console.log(a)}}),c.find(".download").prepend(b.magnet.addClass("magnet")),"Anonymous"!=b.meta.submitter&&c.find(".group").attr("title","Submitter: "+$(b.meta.submitter).html());for(var d=c.find(".meta").append("<span class='size'>"+b.meta.size+"</span>"),e=["extras_unsafe","extras","resolution","videoType","audioType"],f=0;f<e.length;f++)a[e[f]].length>0&&d.append("<span class='"+e[f]+"'>"+a[e[f]].join("</span><span class='"+e[f]+"'>")+"</span>");return a.version&&c.find(".ribbon").append("<div class='version'>"+a.version+"</div>"),b.link.indexOf("nyaa.eu/")>-1&&$(".download>a:not(.magnet)",c).bind("click",openInIframe),$(c).append("<div class='clearfix'></div>"),c}function findTileSibling(a){for(var b=$("#libview .tile"),c=0;c<b.length;c++){var d=$(b[c]);if(d.find(".title").html()==a.title&&d.find(".group").html()==a.group&&(d.find(".ep").html()==a.episode||""===a.episode&&0==d.find(".ep").length))return d}return!1}function checkBlacklist(a){return escape(a.filename).match(patt_blacklist)}function spawnTiles(a){api.clean("loading");for(var b=0;b<a.length;b++){var c=!1,d=a[b],e=new Anime(d.file);if(e.title){var f=api.hash(e.cleanTitle),g=createTile(e,d),h=checkBlacklist(e);if(c=findTileSibling(e),g.attr("data-name",f),preferences.censor&&~["4","5","12","13","14","15"].indexOf(d.category)&&g.find(".thumb").addClass("censored"),h)$("#blacklist").append(g);else{if(c){c.find(".files").prepend(g.find(".download"));continue}$("#libview").append(g)}api.search(e.cleanTitle,d.category)}}$(".tile").each(function(){var a=new TimelineLite;a.insert(TweenLite.to($(".titlebar",this),.3,{top:0})),a.insert(TweenLite.fromTo($(".files",this),.3,{bottom:"-100%"},{bottom:0})),a.pause();var b=this;$(".titlebar",this).mouseenter(function(){a.play(),$(".thumb",b).addClass("blur")}).mouseleave(function(){a.reverse(),$(".thumb",b).removeClass("blur")}),isOnScreen($(this))?TweenLite.from($(this),.3,{delay:.1*$(".tile").index(this)+1,opacity:0,top:200}):$(this).addClass("waitForAnimation")}),$(".tile").bind("contextmenu",function(a){console.log(a.which)}),$(".tile .title").click(function(){$("#search").val($(this).html()).parent().submit()}),$(".tile .group").click(function(){$("#search").val($(this).html()).parent().submit()}),$(".tile .ep").click(function(){$("#search").val($(this).parent().find(".title").html()+" "+$(this).html()).parent().submit()}),$("html, body").animate({scrollTop:1})}function ttGetList(a){var b=[];return $(".listing tr",a).each(function(){var a=$(this).find(".desc-top"),c=$(this).find(".desc-bot"),d=$(this).find(".web"),e=$(this).find(".stats");if(a.length>0){a.find(".s").remove();var f={file:a.find("a:last").html(),link:a.find("a:last").attr("href"),magnet:a.find(".sprite_magnet").parent(),web:d.html(),category:$(this).attr("class").replace("shade","").replace(" ","").replace("category_","")};b.push(f)}else if(c.length>0){c.find(".s").remove(),b[b.length-1].meta=ttMetaParse(c.html());var g=e.html().split(" ID: ");b[b.length-1].stats=g[0],b[b.length-1].id=g[1]}}),b}function ttMetaParse(a){var b,c,d,e=a.split(" | Comment: "),f=e[0].split(" | "),g={auth:0,comment:e[1]?e[1]:"",submitter:"",size:"0kb",date:""};g.comment=g.comment.replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,"<a href='$1'>$1</a>");for(var h=0;h<f.length;h++)if(f[h].match(/Authorized:.*?auth_ok/)&&(g.auth=1),f[h].match(/Authorized:.*?auth_bad/)&&(g.auth=2),f[h].match(/Submitter:/))g.submitter=f[h].split(/ ?Submitter: /)[1];else if(~f[h].indexOf("Size:"))g.size=f[h].replace("Size: ","");else if(~f[h].indexOf("ago"))g.date=f[h];else{b=f[h].split(" "),c=b[2].split(":"),b=b[1].split("-"),d=Date.UTC(b[0],b[1]-1,b[2],c[0],c[1]);var i=new Date;c=i-d,g.date=Math.floor(c/864e5)>1?Math.floor(c/864e5)+" days ago":Math.floor(c/864e5)>0?"1 day ago":Math.floor(c/36e5)>1?Math.floor(c/36e5)+" hours ago":Math.floor(c/36e5)>0?"1 hour ago":Math.floor(c/6e4)>0?"some min ago":"some sec ago"}return g}function ttAjaxLoad(a){$("#wrapper .msg").remove(),$(".searchfield .icon-search").addClass("loading"),console.log("trying to load: "+a),isLoading=!0;var b;b=a.indexOf("#")>=0?hash2url(a):url2hash(a),console.log(b),setInterface(b),document.location=document.location.origin+b.hash,$("#loader").empty().load(b.url+" .listing",function(){isLoading=!1,$("#wrapper .msg").remove(),$(".searchfield .icon-search").removeClass("loading");var a=ttGetList($("#loader"));a.length>0?($("#libview").empty(),$("#blacklist").empty(),spawnTiles(a)):$("#libview").prepend('<span class="error msg">Nothing found!</span>')})}function hashCheck(){if(location.hash!=hash){hash=document.location.hash;var a=~hash.indexOf("#")?hash2url(hash):url2hash(document.location.search);setInterface(a),isLoading||ttAjaxLoad(a.url)}}function url2hash(a){var b=a.toString().match(/page=([0-9]{1,2})/),c=a.toString().match(/(?:cat|type)=([0-9]{1,2})/),d=a.toString().match(/terms=(.*?)(?:\&|$)/);b=b?parseFloat(b[1]):d?1:0,c&&(c=c[1]),d&&(d=d[1]);var e="#/"+(c?category_list[c]:category_list[0])+"/"+b+(d?"/"+d:"");return{url:a,hash:e,page:b,cat:c,terms:d}}function hash2url(a){var b,c,d,e=a.split("/");return b=category_list.indexOf(e[1]),d=parseFloat(e[2]),c=e[3]?e[3]:!1,url="/"+(c?"search.php?type=":"?cat=")+b+"&page="+d+(c?"&terms="+c:""),{url:url,hash:a,page:d,cat:b,terms:c}}function getPreferences(){var a=window.localStorage.getItem("Preferences");return a=a?JSON.parse(a):{align:"left",censor:!0,discardedCategories:[],keywords:{blacklist:["480P","DeadFish","HorribleSubs"]}}}function setPreferences(){for(var a=[],b=0;b<category_list.length;b++)~$.inArray(b,preferences.discardedCategories)||a.push(b);console.log(a),setCookie("filter",a),window.localStorage.setItem("Preferences",JSON.stringify(preferences))}function setCookie(a,b){var c=300,d=new Date;d.setTime(d.getTime()+1e3*60*60*24*c);var e="; expires="+d.toGMTString();document.cookie=a+"="+escape(b)+e+"; path=/"}!function(){function a(a){this.id=0,this.title=null,this.cleanTitle=null,this.version=null,this.episode="",this.ep_prefix=[],this.group=[],this.resolution=[],this.videoType=[],this.audioType=[],this.extras=[],this.extras_unsafe=[],this.checkSum=null,this.extention="",this.file=null,this.filename=null,a&&(this.file=a,this.filename=a,c(this))}function b(a){this.content=a,this.seperator=a.match(v)?a.match(v)[1]:!1,this.virgin=!0}function c(a){if(!a.file)return!1;a.file=a.file.replace(/_/g," "),e(a);var b=d(a);if(b)for(var c=0;c<b.length;c++){var t=b[c];f(t,a),t.virgin&&(g(t,a),""!==t.content&&(h(k.AUDIO,t,a.audioType),""!==t.content&&(h(k.VIDEO,t,a.videoType),""!==t.content&&(h(k.EXTRA,t,a.extras),""!==t.content&&(h(k.EXTRA_UNSAFE,t,a.extras),""!==t.content&&t.virgin&&a.group.push(t.content))))))}i(q,a,a.resolution),i(o,a,a.audioType),i(n,a,a.videoType),i(l,a,a.extras),i(m,a,a.extras_unsafe),i(p,a,a.ep_prefix),a.file=j(a.file);for(var c=a.ep_prefix.length-1;c>=0;c--)switch(a.ep_prefix[c]=a.ep_prefix[c].replace(" ",""),a.ep_prefix[c].toUpperCase()){case"VOL":case"VOL.":case"VOLUME":a.episode="Vol.";break;case"PV":case"OP":case"ED":a.episode+=a.ep_prefix[c].toUpperCase()+" "}var u;r.test(a.file)&&(u=a.file.match(r),a.version=u[1],a.file=a.file.replace(u[1],"")),a.file=j(a.file),a.file=a.file.replace(/([0-9])[^0-9]*?$/gi,"$1"),a.file=a.file.replace(/\./gi," "),s.test(a.file)&&(u=a.file.match(s),a.episode+=u[1]?u[1]:u[2],a.file=a.file.replace(u[0],"")),a.file=j(a.file),a.title=a.file,a.cleanTitle=a.title.replace(/[^a-z0-9 !\']/gi," "),a.cleanTitle=a.cleanTitle.replace(/S([0-9]{1,2})/i,"$1")}function d(a){var c=a.file.match(t);if(c)for(var d=0;d<c.length;d++)a.file=a.file.replace(c[d],""),c[d]=new b(c[d].replace(u,""));return a.file.replace(u,""),c}function e(a){var b=a.file.match(x);b&&(a.extention=b[1],a.file=a.file.replace(b[0],""))}function f(a,b){w.test(a.content)&&(b.checkSum=a.content,a.virgin=!1)}function g(a,b){for(var c;q.test(a.content);)c=a.content.match(q),b.resolution.push(c[0].toUpperCase()),a.content=a.content.replace(c[0],""),a.virgin=!1}function h(a,b,c){var d=b.content.toUpperCase();d=b.seperator?d.split(b.seperator):[d];for(var e=d.length-1;e>=0;e--)~a.indexOf(d[e])&&(c.push(d.splice(e,1)),b.virgin=!1);b.virgin||(b.content=d.join(b.seperator))}function i(a,b,c){for(var d;a.test(b.file);)d=b.file.match(a),c.push(d[1]),b.file=b.file.replace(d[1],"")}function j(a){return a.replace(/ -? /g," ").replace(/(^[\. \-]+|)/,"").replace(/[\. \-\[\]]+$/,"")}var k={AUDIO:["2CH","5.1CH","5.1","AAC","AC3","DTS","DTS5.1","DTS-ES","DUALAUDIO","DUAL AUDIO","FLAC","MP3","OGG","TRUEHD5.1","VORBIS"],EXTRA:["ASS","BATCH","BIG5","BD","BDRIP","BLURAY","BLU-RAY","TV","COMPLETE","DIRECTOR'S CUT","DVD","DVD5","DVD9","DVD-R2J","DVDRIP","ENG","ENGLISH","GB","HARDSUB","JAP","PS3","R2DVD","R2J","R2JDVD","RAW","REMASTER","REMASTERED","SOFTSUB","SUBBED","SUB","UNCENSORED","UNCUT","VOSTFR","WEBCAST","WEBRIP","WIDESCREEN","WS"],EXTRA_UNSAFE:["END","FIN","FINAL","OAD","OAV","ONA","OVA","SPECIAL","SP","MOVIE"],VIDEO:["8BITS","8BIT","10BITS","10BIT","10-BIT","AVI","DIVX","H264","H.264","HD","HDTV","HI10P","HQ","LQ","MP4","RMVB","SD","TS","VFR","WMV","X264","X.264","XVID"],EPISODE:["EPISODE","EP.","EP","PV","VOLUME","VOL.","VOL","ED","EPS.","EPS","OP"]},l=new RegExp(" ("+k.EXTRA.join("|")+")(?: |$)","i"),m=new RegExp(" ("+k.EXTRA_UNSAFE.join("|")+")(?: |$)","i"),n=new RegExp(" ("+k.VIDEO.join("|")+")(?: |$)","i"),o=new RegExp(" ("+k.AUDIO.join("|")+")(?: |$)","i"),p=new RegExp(" ("+k.EPISODE.join("|")+")(?: |[0-9]{1,2})","i"),q=/([0-9]{3,4}X[0-9]{3,4}|[0-9]{3,4}[PI]|1080)/i,r=/(?:[0-9]{1,3}| )(v[0-9]{1})(?:[^0-9]|$)/i,s=/(?:-? |-)(?:[第#]?)([0-9]{0,3}\-?[0-9]{1,3})(:?話|$)|S[0-9]{1,2}E([0-9]{1,3})(:?話|$)/,t=/((?:\[.*?\])|(?:\(.*?\)?\))|(?:\{.*?\})|(?:「{.*?」))/g,u=/[\[\]\(\)\{\}「」]/g,v=/([\-\ \_\+\,]|\.)(?:[^0-9])/,w=/[0-9A-F]{8}/i,x=/\.(.{3,5})$/;window.Anime=a}(window),function(){String.prototype.distanceTo=function(a){if(0===a.length)return this.length;if(0===this.length)return a.length;var b=[],c=0,d=0;for(c;c<=this.length;c++)b[c]=[c];for(d;d<=a.length;d++)b[0][d]=d;for(c=1;c<=this.length;c++)for(d=1;d<=a.length;d++)b[c][d]=this.charAt(c-1)==a.charAt(d-1)?b[c-1][d-1]:Math.min(b[c-1][d-1]+1,Math.min(b[c][d-1]+1,b[c-1][d]+1));return b[this.length][a.length]};var a={data:{anime:{},manga:{},drama:{}},search:function(b,c){var d,e,f,g=this.hash(b);switch(c){case"1":case"anime":case"4":case"hentai":case"7":case"raws":case"10":case"non-english":case"11":case"batch":case"12":case"h-anime":case"14":case"h-games":d="anime",e="http://mal-api.com/anime/search?q=",f="json";break;case"3":case"manga":case"13":case"h-manga":d="manga",e="http://mal-api.com/manga/search?q=",f="json";break;case"8":case"drama":d="drama",e="http://api.trakt.tv/search/shows.json/033c883a434cb6845b3ed442710d5113/",f="json";break;default:return!1}return a.data[d][g]?(("object"==typeof a.data[d][g]||"no result!"===a.data[d][g])&&a.apply(g,a.data[d][g]),!0):(a.data[d][g]="loading!",$.getJSON(e+b.replace(/ /g,"+")).done(function(c){a.data[d][g]=c.length>1?a.match(b,c,d):c.length>0?c[0]:"no result!"}).fail(function(c){console.log(["api call failed",b,c]),a.data[d][g]="no result!"}).complete(function(){var b=a.data[d][g];"no result!"!=b&&("anime"==d||"manga"==d?(b.image_url=b.image_url.replace(/t(\.[jpg|png|gif]{3})$/i,"$1"),b.url="http://myanimelist.net/"+d+"/"+b.id):"drama"==d&&(b.image_url=b.images.poster.replace(/(\.[jpg|png|gif]{3})$/i,"-300$1"),~b.image_url.indexOf("poster-dark")&&(b.image_url=b.images.poster),b.members_score=""),a.save(d)),a.apply(g,b)}),void 0)},match:function(a,b){for(var c,d=1e3,e=b.length-1;e>=0;e--){var f=a.distanceTo(b[e].title);d>f&&(d=f,c=b[e])}return c},apply:function(a,b){"no result!"===b?$(".tile[data-name="+a+"]").addClass("noImg"):"object"==typeof b&&$(".tile[data-name="+a+"] .thumb img").attr("src",b.image_url).parent().attr("href",b.url).find(".score").html(b.members_score)},save:function(a){window.localStorage.setItem("APIdata_"+a,JSON.stringify(this.data[a]))},load:function(a){var b=window.localStorage.getItem("APIdata_"+a);return b&&(this.data[a]=JSON.parse(b)),b?!0:!1},clean:function(a){if(0===arguments.length||"all"==a)this.reset();else for(var b in this.data){for(var c in this.data[b])switch(this.data[b][c]){case"no result!":("strings"==a||"result"==a)&&delete this.data[b][c];break;case"loading!":("strings"==a||"loading"==a)&&delete this.data[b][c]}this.save(b)}},reset:function(){this.data={anime:{},manga:{},drama:{}};for(var a in this.data)this.save(a)},hash:function(a){var b,c,d=0;if(0===a.length)return d;for(b=0;b<a.length;b++)c=a.charCodeAt(b),d=(d<<5)-d+c,d&=d;return d.toString(16)},init:function(){this.load("anime"),this.load("manga"),this.load("drama")}};window.api=a}(window);var debugcss=!1,productioncss="https://googledrive.com/host/0B3YLtiTla9ZvcmNIam5rVkJKc2M/libdeluxe1.4.min.css",styleAdded=!1,preferences=getPreferences(),patt_blacklist=createBlacklistPatt();document.addEventListener("DOMNodeInserted",onDOMInsert);var category_list=["All","Anime","Music","Manga","Hentai","Other","Other","Raws","Drama","M-Video","Non-English","Batch","H-Anime","H-Manga","H-Games","Jav"],category_order=[0,1,10,7,3,8,2,9,11,4,12,13,14,15,5],hash=document.location.hash,isLoading=!1,searchLength;