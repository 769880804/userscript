{\rtf1\ansi\ansicpg1252\deff0\deflang16393{\fonttbl{\f0\fswiss\fcharset0 Arial;}}
{\*\generator Msftedit 5.41.21.2508;}\viewkind4\uc1\pard\f0\fs20 // ==UserScript==\par
// @name           KOC Throne Room Organizer\par
// @version        20121220b\par
// @namespace      mmm\par
// @homepage       https://userscripts.org/scripts/show/132329\par
// @delay 1000\par
// @include        *.kingdomsofcamelot.com/*main_src.php*\par
// @include        *.kingdomsofcamelot.com/*standAlone.php*\par
// @include        *apps.facebook.com/kingdomsofcamelot/*\par
// @include        *kabam.com/kingdoms-of-camelot/play*\par
// @resource       jqcss http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css\par
// @updateURL      https://userscripts.org/scripts/source/132329.meta.js\par
// @downloadURL    https://userscripts.org/scripts/source/132329.user.js\par
// @icon  https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/briton_chair_normal_1.png\par
// @require        https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js\par
// @require        https://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js\par
// @grant       unsafeWindow\par
// @grant       GM_getValue\par
// @grant       GM_setValue\par
// @grant       GM_addStyle\par
// @grant       GM_xmlhttpRequest\par
// @grant       GM_log\par
// @grant       GM_registerMenuCommand\par
// @grant       GM_getResourceText\par
// @grant       GM_getResourceURL\par
// @description    Organizes, upgrades and salvages KOC throne room items\par
// ==/UserScript==\par
\par
\par
var Version = '20121220b_mm';\par
\par
var trPopUpTopClass = 'trPopTop';\par
var ResetAll = false;\par
var DEBUG_TRACE = false;\par
\par
\par
var JSON;if(!JSON)\{JSON=\{\};\}(function()\{"use strict";function f(n)\{return n<10?'0'+n:n;\}if(typeof Date.prototype.toJSON!=='function')\{Date.prototype.toJSON=function(key)\{return isFinite(this.valueOf())?this.getUTCFullYear()+'-'+f(this.getUTCMonth()+1)+'-'+f(this.getUTCDate())+'T'+f(this.getUTCHours())+':'+f(this.getUTCMinutes())+':'+f(this.getUTCSeconds())+'Z':null;\};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key)\{return this.valueOf();\};\}var cx=/[\\u0000\\u00ad\\u0600-\\u0604\\u070f\\u17b4\\u17b5\\u200c-\\u200f\\u2028-\\u202f\\u2060-\\u206f\\ufeff\\ufff0-\\uffff]/g,escapable=/[\\\\\\"\\x00-\\x1f\\x7f-\\x9f\\u00ad\\u0600-\\u0604\\u070f\\u17b4\\u17b5\\u200c-\\u200f\\u2028-\\u202f\\u2060-\\u206f\\ufeff\\ufff0-\\uffff]/g,gap,indent,meta=\{'\\b':'\\\\b','\\t':'\\\\t','\\n':'\\\\n','\\f':'\\\\f','\\r':'\\\\r','"':'\\\\"','\\\\':'\\\\\\\\'\},rep;function quote(string)\{escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a)\{var c=meta[a];return typeof c==='string'?c:'\\\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4);\})+'"':'"'+string+'"';\}function str(key,holder)\{var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==='object'&&typeof value.toJSON==='function')\{value=value.toJSON(key);\}if(typeof rep==='function')\{value=rep.call(holder,key,value);\}switch(typeof value)\{case'string':return quote(value);case'number':return isFinite(value)?String(value):'null';case'boolean':case'null':return String(value);case'object':if(!value)\{return'null';\}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==='[object Array]')\{length=value.length;for(i=0;i<length;i+=1)\{partial[i]=str(i,value)||'null';\}v=partial.length===0?'[]':gap?'[\\n'+gap+partial.join(',\\n'+gap)+'\\n'+mind+']':'['+partial.join(',')+']';gap=mind;return v;\}if(rep&&typeof rep==='object')\{length=rep.length;for(i=0;i<length;i+=1)\{k=rep[i];if(typeof k==='string')\{v=str(k,value);if(v)\{partial.push(quote(k)+(gap?': ':':')+v);\}\}\}\}else\{for(k in value)\{if(Object.hasOwnProperty.call(value,k))\{v=str(k,value);if(v)\{partial.push(quote(k)+(gap?': ':':')+v);\}\}\}\}v=partial.length===0?'\{\}':gap?'\{\\n'+gap+partial.join(',\\n'+gap)+'\\n'+mind+'\}':'\{'+partial.join(',')+'\}';gap=mind;return v;\}\}if(typeof JSON.stringify!=='function')\{JSON.stringify=function(value,replacer,space)\{var i;gap='';indent='';if(typeof space==='number')\{for(i=0;i<space;i+=1)\{indent+=' ';\}\}else if(typeof space==='string')\{indent=space;\}rep=replacer;if(replacer&&typeof replacer!=='function'&&(typeof replacer!=='object'||typeof replacer.length!=='number'))\{throw new Error('JSON.stringify');\}return str('',\{'':value\});\};\}if(typeof JSON.parse!=='function')\{JSON.parse=function(text,reviver)\{var j;function walk(holder,key)\{var k,v,value=holder[key];if(value&&typeof value==='object')\{for(k in value)\{if(Object.hasOwnProperty.call(value,k))\{v=walk(value,k);if(v!==undefined)\{value[k]=v;\}else\{delete value[k];\}\}\}\}return reviver.call(holder,key,value);\}text=String(text);cx.lastIndex=0;if(cx.test(text))\{text=text.replace(cx,function(a)\{return'\\\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4);\});\}if(/^[\\],:\{\}\\s]*$/.test(text.replace(/\\\\(?:["\\\\\\/bfnrt]|u[0-9a-fA-F]\{4\})/g,'@').replace(/"[^"\\\\\\n\\r]*"|true|false|null|-?\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d+)?/g,']').replace(/(?:^|:|,)(?:\\s*\\[)+/g,'')))\{j=eval('('+text+')');return typeof reviver==='function'?walk(\{'':j\},''):j;\}throw new SyntaxError('JSON.parse');\};\}\}());\par
var JSON2 = JSON;\par
\par
var URL_CASTLE_BUT = "data:image/png;base64,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";\par
var URL_CASTLE_BUT_SEL = "data:image/png;base64,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";\par
var success_image = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3AgNBDgX+Hd0CAAACkZJREFUWMOtl3uMHdV9x7+/c2buzJ373rvvtb3exYuNDfYaMIkgkNYCFIdScB+CVm4UIWiTIKs0FVSplAqaBiUWbYXSh1CcREkr2lRKrZgoJThYLQWMIY6pjV+7fqx37fU+7t7nPO48zvn1j12btYG0fzDSkWbmjH6f3/m9h/AxXjw+DhoZAY+PL39NH/U5jYx85ObHAadfoQBfUeLjtcAYALosUyzBFxczL4EZRFfujQ8VNLsb1PMoeHb3tVv0oYdhE/BvAhQDDAJIgBYVYGYiIkK+JA6ceF0MWKVwVfcKtaQQyf8HnABIAMayZQIwwWyASIINAdEWICawKcFSAjBYJVInWoh1a2/Y33jl4ef/+e9uOHb4xKltD+wI4baAJWFXH/F9+GXwZXhqCWyAWQIgEBgsEpBOIEIF2VJgAVCOEBNTYTAj+3IPf3f+G1/6p3/44UzhTPHJnV98tI25SwKA+oACy059GZwCsw0gDSANIhuABZIGQEtCOAFTBOKIKYohg4RYKO4e7mnmW3/2l6e+8Dt7/uLlX95Tu/eJF/Z+7zguXGDWimnJm8Zysy8LGhOADWaHOcqQsIts9g6w6ByE2bGCjOwACAYnURXaryCuXxJxZZJUWIMwYwwMrflP77++/Df//c2b3/nH9974HO94Ytcru0/i9GliZk2LQbho8Wt8LpfgaWbOEUd5ZEc3atF/H6ziraTP9qE97iCuSbACkwWkVkZk3+hqlT4l3LP/EWbY+uvJ3Y98/+1/7fP2qEOfLz385Ne/9tWjcKOIQTERxwAxAH0lDZfgYgnuAJwHRCdnNm/V5urHBU+sUtMvQM2OEderoMAHtAIMA7CyEB0DMIYegp/7dPup9x5RP9y/L2O/lr30lY2P/cnjO3e8jbZosbICYjMGQV2Bj4wsxQCDmFgSk8VAhoiLiRzcAhJfRvXF3uDk9+GPTeL0RIDDFxOMuYQIAj22wK19FawfrqARuPyNeJe958dH0HPeCf/8tkde+KM/3T6FWtVkYYIow0hyGiw16EohgqFndoOJiSBMgNJEXIyVU2pWjj6WSTd64+M/wuShi/y374Z0yFYIugF7kJAyJURi4hXXwrrAxOFjh+n4wTrK1RR23f+78lPXdwlEbo6p3SJDSmaficFQhcUEWqqaBhETWMgk4VQcJ7l0Pp8be+2lB4dvHrnZO/Yyzr0zx398XFG8iZHrIHQ6EqmUgZRhwmQLuayDt+bmMLm/jlQd+IM1a/me0aIRq/rO6dNnj3f3FWogmIZhCKYAlHQxrb7rSuk2AIJmLWfnG+lm0y/H/rmhjrL5W62Jw7ww1aRdk4rkbUCulIKdk7DTApZpwDIspMnGa+dmMfGzOrgFdIQONgyVCe1ZTtmZ4vmTr25Plz77Aqswk8vYrmkFIczqYvSPjCylIYHaYSLn5pvZpuuWUZ28rTige4TU+EUtxsJaRld/CrYjIC1C2rFgWyk4lMKrv5zG+L4auAlYvsTarR3Y17iAmysOFTMBEFa2jB058VLvYFeDhDZLliOWesWyGFAartc2kiSxDSnSbb+15uhpP7WfGfb6TbjRIJRzOQz2F9BdBCbrb6MR+jjwbgWn9tXANYB94IZPlJFeyXhvrIKTF4vYPNiDsNXq8uKplUFPfsK2zJRWaRLi6nZiRLGiSqVlhlFkmwIpt97q6x7Iov/wDJ79zpsIshoJAUoA/Wvy+Pz2h3DLiINnf/I8kspiQvV2OejfYqHuBWgjwuGLC9jQ3wnfi7NNv97ZFSe2F0RmSWmZEle3HyNRilpeIJJESdMUorHg5YbXFLD11k68qAowmDBzJsB8JcD8/zTx9SPfhkwDZrRYM2VMWPepAiinEDZiKJ1guhEgijQ8P6F6HGS11jIMI8la07X9TxhSIopiUlozEalarQ3PjRDGhDiMYQ8DN95fwvobOyAjgsWAEQCsAB0C/QNZdG1OwQ1DhGGMOFIQzGi3GW5ToR0xhCAthODF5nV18xOCiP0gUk3XB6QIqy1uNioe2LBQikw0FiKEMsLqbRnctKUMERKQAEgA8oCN9xXg6jZarQhtTyH2NQYyeXhujHo9VjDthmEYkWkaioj0td1XaGaO4kS5XhhL0wgi2JOXLjSRsIFNHR1waxG8Zgg3bGPwM2msHS2CPSDxgOs25iAGFKqVNrxqjHZdId2WuK5cRr3iYqGauFZH57QhRdswRGRIyR9QgDVzqZiNAPKI2LN6uo9NnmuGrZrHd16/Dk5LoDUfoTEfoO75WHWvhcG1GZhtQtctJiqVAM25GMGCQljTGM33omxnMDvR4LmWMX395pEJaRieachIpIwPWiDtWOjrKSaWlXJdL/Juv3v08PiMnpw6MUu92Sz/9rrNaC9oNC/FWLgQoFb3Ud4iMXCTjdCIUb8Ywp+NES5olBIHf3jHJ7k24+L8WI3D3hVv3H7r6mkhhJ9x7BBgDYCXj3oCkjiftZN83vFct+3eccvgVGH0hj0HDs4kp35xhn7/rl/nZx5+EiVagYUJH3NnfXjtCM4GRmM2RO18gGge+OR1n8a/PfU0ty62cPTAJE4E6bOPPr7tpTCIXCmFl8+lYyitL09dVyafp7+yHZlcGm0/RLXuk5WS4p5fWz/z04PnCxPvXVyfNOdpw8AK3n73Q3Td0B2oVpuYn51H24tRTHVj6033Y+dnv4DPdPXiyMuv0pv7jtHxKi9s27H1mw/8xuiR6kKrkcukXcs2I9bQRMAzz+29espl/nfUxqbkkRMXHGIurBnuzi9UWqueeXbvl8Tcpfs2rusRfUNl7h8eoKGNd6J71TqwFvCac7h44iDGDr2D6Ykanxmfo/GWWrj3wdufe+KLd/88jpNKorhRLmU9IoqZmUXvYx8cs9XMtyE683TwlXfNS7N1Z6CvlO3rKRTqzaDv6V0/2VE9PbVtZdHs6u3OUqlkIZNLIYk1Aj9GoxZiZs7HdM2PgnT25P0PfuK7Tz1+92uNZlCPE9Uo5h3fNI0YgLo8eS13wfsjWeMHmJmap5/tP2r5fphZv7Y/vWao2wFzx4t7Do2+9dbYXa1KY1RFcb9g7TBDxppjlrKWLWTHhq8feOOh7Vtev/Outefr861WnGg3n7N9y05F0Kw/DP6+C5Y23HN/j3/Zc1CMnZmxchk7fcumVamucs4xDMqFYVLw/Cg/N98qzle8YhTFZqHguEODXZU1w90LpYLTJEIrUdozDcN30qlQSpEwL0b+tab/yD+dd/Z+FT/6+SExuKJDpm3TZGbbsmTasc10PmunOss52dmRg22nWEqhACRac6SZQ9OQQS6TjiApgWbFzPqjwFea0fKH5//q97DlN7+GqXef0xk7pf0wSl5/ayy6MF1tt7zA15qtXNaW/b1FvXpllyrk0yqbsVQuk45LRScRpqGhtGKlmYhY9D72oWb/lRb48Q924oHPfWtxVuW9OPDTN1EqZumNg2N08vSMUEqLVSs6sGnDKu4qZzmfc/RAbxFSCmZmEBFfBv5fcAD4X6XxV1xnuaXKAAAAAElFTkSuQmCC";\par
var up_img ="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAaCAYAAACkVDyJAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3AgRBjoxAQevPgAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAEWUlEQVRIx+2Vb2iVZRTAf+d53/tv2929m3d3a9NN55AMFG0RKhUF9aEEoX0I0rCS0HS0UkEpMJAUSxti/sn6VH0QpI/Wl0CyIhkhzbJ/rsScOXX/t7vt/nvf5/ThbrNlxjKDgg6c5zwHnvf83nOew3ng3y7xTd9M9Vu+++dgZVu/ntxHVny7puHLDgEo3/b9tGOYm8py65nW7KAe6H/f2wZAKDjtb2VagI3tDO5dDEBsy1ePusYceTAQCx9ntDtvWDm0ff7xW5rhJGxze4P1dXdtIhx+bFVc68rdJCqvlG8/Ww0wY2fHrStp2abTRb6vr5VFgw0mXsS+tkGZnXA0UeIstSo7AETM3weWtpwCwPP956IRpymSLKUrrdqdsgyM5plf6RIJytMzdv64qfelBhK7zt08sLT5C4bfuIvSllNLAg6vxqpipEMh9RUZyihXBjxxjdX6hIuItCZ2nVvW++JcKnaf/+vA6LNtDB+8m+iGtkqsfhSbUYxUxjXrqQjg+Up/yuNCb17qywzJYgcfjib3nK/s2TKHRGvn9IHRdSdJHV5CfF1bkbUcjZeGorHbq7U/h8h4X6sqmZzSl/Lp6M7RONPVsogzM+9zINnaGendXDt9YOqtZQDkle3RkLkv0VinPeqKg045p1YZSVv6hj0uDuTkzmqHSNA0+aprq/d0SsXezumXtHjtyRWO+s11S+ulN1gkonbqAVVQxVplcMzSM+wzmvV1QaVjRHg977KoZ2MtFfsu3hhY8tRnBbvm81rx7L76hdWRnni5qur1f6SFDLHg+4XSXh7yJeKq1sUdF5Fjyf2/FPc8P4vkwUvXA4tXf8LIO/dS8uSnAdQeSlaXzs7NrVbPyB9OI51Y1KJWyXlKX8rj6rAnc2Ki0ZDUoBy97d2r0t1cQ/LQld9nqBPrnnA4sDzWOEfHgkFBb1Bz1UkYqqhV0lnL1SGf/jFfFle6qshyO2p3AHRvqKLq8JUCsPiJE4y+dz9Fq08843t2/bx75tIfLcHaPxm2EyXV394njKQtXYMeIxmPpTUuGV+bKw9fbipMbnMtXnjlx4sckQ8al8yq6byjHuspiCAKNptHszlsOo/N5NFMDm8oTa5rABNywTWI62BcB1xDKOSSLAswOxHQtBeQH4b0zKjVpr71lT8ZgKLHj5fHI+6rax+oqnnk4XpFIRwQwi6EXAgHDCF3QmXShh0IOxBxhIgz7ruCAcaylpGMlRcWFuu8EXdBIuW8/NCRgSLZf+xn4yMtCnv7UnnO5gK0pwTHCGIERFBrwSr443dmFc37+GMZTMBBnEKGGAOOQZyCLYk4LCoP037Skhs2DI7qKrezNysVsWDu9IWRSx+e7k97KmCkEMQx1/auAWOuBXcM4rpgDSCFl0IFUQEVUOgfhYvpLDrT4PXYIhzjuF39WT+Tt292dKXfTuctgYAD45lhxlVMwR9XnXi5dWrXCjKlycw424mAJMBT9flf/vPyKztX7pN6V2XmAAAAAElFTkSuQmCC";  \par
var up_glow="data:image/png;base64,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";\par
var down_img = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAaCAYAAACkVDyJAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3AgRBwUywRK+jwAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAEi0lEQVRIx+1WXWwUVRT+zrl3drfbdne73e2Wv1WQYDQxwd9UjIiJ0ScfJDEENGp8ofwIgcpviGI0Gk2AaFIEYvwBwyMPRsJTI1FDkYithRCUtkChS7vd0t1u9292Zo4P0xYLrVQTEk38kpk7dyZzvnO+79yZC/yP/zropV0dCFcb1Hohqzp6czAMBSgGMYM0A0wgViBNADNIsftc3bgG0/icePSeIrBSECawwXDyBGuAbD0z7FXRoGflYM7afiFZKFgCwBGAxB0BgBxAGBABREDj6f45dYLcVM1YGLsAWCn4MURbdTziFRvkeXR+YNa8WAV+Mw20ZQmKCcTkBnIc923bgThuIlK2YeeLYFaj1bkKQAlICaAIVRXAwrAXbSccmMOMdE5sAgD/8pZwwO85vPzx6HOxJffKvksgD4+mKYCYNpyiCadQhlM0IcUyrEwe5d7rYK8GaTV6MGAokFLw+xXitQaaHgrL7mNFumI7h+KzVeO4KL4V3y1URN8+3DBnVs/98+BYAhC5ypbKkNIYYRlSNGFlCjATQ2CvBjSDtAJrBWiG16tRV2Pg7oghBcug8xk5k3Nk6eCqWCcDQOXLx1E8/HS7KOw8dfKKObMvBVIkt205dr2jMfmZoBUjWMmoDygRUvTTQDlTEnvn4KpYZ/3+JBgAcl8vQeUrx5E/uOQzpfnT33/sQjg7AmZgSlbCqMcuKYjADFRVMGaGNKp8Gq29FnyKmvsbZxxx7XHAEyK4503FYvlo5vRF8pumTOhETOxKEI83FjGhwsuIBRXCfiVt/RYR5ChX8g4AqNvbh77G+huEuYNPoeq1HzDy1eIyiFcnE8OXPF0J0o7IFAWOVueSejShtlojFtByMSOULUkvCMuuvRqTuuZeJFfXj7swjpEvn3THz5/oEc3ruzsShWj6OhHR1JIyoBShtlphRlBJwSK6nLYtiDyffGN2LvrxFSTXzJpg+6TIHVj0jU2q+XJrt0TMvAjxJJISmAkhPyMaUKj0KjrTbzsieNOw0B7d04OB9XNu6bNbUL3yBADAILydLTnfp05fpihZYt9kKDGhqoJRG9CYU+ORXxI2CqZzRBEdSGyKy8CG+KSNfQuy+xehuvEk0vsb8sxYlh4uZTPnExT2QMYcJSL4PK6UC+o8OH3VoqGCfdVQWJtsihciu3qmXEmTIruvAYE1p5Dd29APpmczgzlIf5q8mkQAaEUIV2vcFTGke8hBMmdDAcuSm+b2Rz+6iFRT/O8RAsBw82MIrPsZw588crJsY2umL4OKUokUQYI+Qn2NFsth6k5ZEJGm1LZ7TkQ+6MLA5rn4i+U7PdRsbPeXHedQOORbGp0dRKW2EVWWtF+zaTAvX6R3Lng98n4nUtvn3/bjNC0M7V6YV4q2DGXNTiedx/qGkFxK2ZQasVuZZAcAiDi3/wFPhyy0oQ3pPQ8CAIKbf31BMx9+xgj6WpBLlhkrMu/c13JHtgc1WzrcBLac2cWLz+bD2869BQDh97qmHYP/CXH6wweavCFaG35RvwsAKJl3bhMU2nh24nzduX/3ru0PInfZcM1Vy/MAAAAASUVORK5CYII=";\par
var down_glow = "data:image/png;base64,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";\par
var gbtn_img = "data:image/png;base64,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";\par
var remove_img = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAABo6AAAaOgG4MgkwAAAAB3RJTUUH3AgSBikNXTI9xQAABK5JREFUaN7t2F2IXHcZx/HPMzM7m81usktC1JJELSSNWEEvOilSbNGLBuldfaFe9KZUrBdKLwIKCiJK9UpBqGClvQoFi60v6I2geOGF3dHYqqmGtKWGqmvK7izZNd3dmTmPF+fM7pZEyE52t6XMDw7nzGH+L9/ze57/GyONNNJII4000khvX7WHKDO7je3HdsLMlhU2kzuT+4I7cDMauJScxc9qPI1Oi3xLgLTRwlmix7HkU8GXY8y+xiRjB6hNlY0UK3QX6C2Xz8mTwWNBu8WVWZx8M0AGDbcZTx4oeLgx7pbpD7H/I3LiVpqHRH0vkfT/S/c1ufoSy7Ni8SyvL1gKztT4bosLNwITNwIxy2TwaMF9kzcZP/IFOdmisU+ooSv1hD76UiH0KJblystcekbMtWWD55OHTvLssDBxA2E1jh8U3D99WBz/HrWZsqNZyOgJBXpUILJPbNwzCzH/tLzwK8Z4AZ9ulffdAaly4vPJd6bfqXnihyIDqzL6pQPZIwYgxdUw68B7xMJP5Yu/FXiqxudaLA7y73rVGCa5exwveHhqxvjxr8pcwirRF4OOvgFikyvxRqDIvjxwmzj8H/75N59InsGPdtyRWSRfqdd889j9cvqkyF7pRG7qqGKTE90NkM3X5v+vdeSLvxbLS87X+ECrxN8ZRyryJr40fZTJI1gkeiJ75eikVpJaxEoF06xa6mOtcqhXxqeiBBqriYOH5ZXzTkin8MsdBUnujJp9+98jG12RndKN6Fedfx4vlaG2Pt1F1dIkprCngovKlRVcZmqxnE1XOL0bIJ8ZazCxH0tEV+Qq8fc6f66zltSvLqSLDhY2vUNkd/CYE0STXOWurfZrmNC6Y2ycZgqL0oqIPzX4+EN8+166a9dXUb3OxYucPi06HYiojMohcncYR95bq1FfQV/4IzrB+27hYx/dWmXnztFsrhsUZKMC2g1HGlEQS/gXXsPYpljZiorimqPoroDgUtF1U//f1OcGHxKXLzM3x9oWQmt+/iqYPjlMaA0zj/xivOaeYw25d60ccSOCo0c5dOhaX/n/tBwl9Pnzsttd78wFskPcvsW+DZMjP+8W7llZY2/VeGaKixfL5B1euUKsloj/2Grh2hAFflxguVyFZG7P7ixjUlyZkqvl70d3HASd5MnBxB1Vlg+z1ctBPL1b9G6TnaYo6AWP7yhItWjM4LHXWbpUrkoiy3dbgknV7PdhGXez1KezQPJIi4X2ToK0NkaIdnBmjpwvIdZhrted2Et+UsbdoluTr/xOFDwXPLGrW902x/FUlw+ewIGqrkHOXCt31gFvlh4Q8S66L8tz3xKrLNT5bKtcxu+OZjfut7f567Pkq+UaqagGgCwoqnt57ZHFMVk8qMifyO4ZxcKDirM1+Xvm23zxTTlF2XT48P6Cr+HeKRoHySlMTIraQRyWjgi3lgdDK3Wu/EF2fiM6f6FIz9X4xsCJre4Mt+U4aBPMTHIq+XqNE000J2RzhsY7hJlyxu4tsfqqWO1QdPWSR4InTlbzxrAQ235A1y4n2FMFp4O7sloADnKmypFXgu8Hj7c2FvVvnePS2SEdbRtppJFGGmmkkUZ62+p/v5QIkkqA6+0AAAAASUVORK5CYII=";\par
var remove_glow = "data:image/png;base64,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";\par
\par
\par
var upgradeData = \{\par
        active : false,\par
        item : 0,\par
        retryInterval : 30,\par
        enhanceAction : false,\par
        enhanceItem : 0,\par
        enhanceMax  : 5,\par
        minStones : 100000,\par
        switchToUpgrade : true,\par
        salvageActive : false,\par
        throneSaveNum : 10,\par
        currentTab : null,\par
        trWinIsOpen : false,\par
        Opacity : 1.0,\par
        anyCity : true,\par
        uCityNum : 0,\par
        sCityNum : 0,\par
        repairAll : false,\par
        trWinPos : \{\},\par
        disableAnim : false,\par
        upgradeH: '300px',\par
        upgradeW:  '700px',\par
        salvageH: '300px',\par
        salvageW:  '710px',\par
        organizeH: '500px',\par
        organizeW: '770px',\par
        optionH: '500px',\par
        optionW: '700px',\par
        logH:    '500px',\par
        logW:    '710px',\par
        activeTab: 1,\par
        sortSelected: "none",\par
        buffSelected: "both",\par
        sortInactive: true,\par
        newUpgradeState: 0,\par
        whisperToMe: false,\par
        safetyOn: false,\par
        buffsOff: false,\par
        safetyLimit: 50000\par
\};\par
\par
var queueData = \{\par
        list : [],\par
        oneItem : true,\par
        doingRepairs : false,\par
        index : 0,\par
        dataConverted : false\par
\};\par
\par
var TRGlobalOptions = \{\par
        trUpdate : false\par
\};\par
\par
var presetData = \{\par
        items : [],\par
        ids : ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R'],\par
        desc : ['Preset A', 'Preset B', 'Preset C', 'Preset D', 'Preset E', 'Preset F', 'Preset G', 'Preset H', 'Preset I', 'Preset J',\par
                'Preset K', 'Preset L', 'Preset M', 'Preset N', 'Preset O', 'Preset P', 'Preset Q', 'Preset R'],\par
        num_presets: 10,\par
        noTooltips : false\par
\};\par
\par
var TABLE_SCALE =0.47;\par
\par
var upgradeStats = \{\par
        upgradeSuccess: \{0: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
            1: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
            2: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
            3: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
            4: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
            5: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\}    \},\par
\par
            upgradeFailure: \{0: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
                1: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
                2: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
                3: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
                4: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
                5: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\}    \},\par
\par
                enhanceSuccess: \{0: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
                    1: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
                    2: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
                    3: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
                    4: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
                    5: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\}    \},\par
\par
                    enhanceFailure: \{0: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
                        1: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
                        2: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
                        3: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
                        4: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\},\par
                        5: \{0: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0\}    \}\par
\};\par
\par
var salvageData = \{\par
        salvageActive : false,\par
        throneSaveNum : 10,\par
        minQuality    : 3,\par
        ruleSet       : [\{"type":"Throne","faction":"any","conditions": [\{"mustHave":"true","number":"2","effect":"Range","buffType":"e","slots": [false,false,false,true,true]\}]\},[\{"type":"Table","faction":"any","conditions": [\{"mustHave":"true","number":"2","effect":"Range","buffType":"e","slots": [false,false,false,true,true]\}]\},[\{"type":"Window","faction":"any","conditions": [\{"mustHave":"true","number":"2","effect":"Range","buffType":"e","slots": [false,false,false,true,true]\}]\},[\{"type":"Banner","faction":"any","conditions": [\{"mustHave":"true","number":"1","effect":"Ranged  Range","buffType":"e","slots":[false,false,true,true,true]\}]\},[\{"type":"Trophy","faction":"any","conditions": [\{"mustHave":"true","number":"2","effect":"Range","buffType":"e","slots": [false,false,true,true,false]\}]\},\par
        numSalvagedItems : 0,\par
        maxStones     : 980000,\par
        anyCity       : true,\par
        overflow      : "order",\par
        numSalvaged   : \{0: 0, 1: 0, 2:0, 3:0, 4:0, 5:0, 6:0\},\par
        upgradeFirst  : false,\par
        upgradeFirstQual : 2,\par
        upgradedToDelete : []\par
\};\par
\par
var Cities = \{\};\par
var Seed = unsafeWindow.seed;\par
var Tabs = \{\};\par
var uW = unsafeWindow;\par
//var firefoxVersion = getFirefoxVersion();\par
var CM = unsafeWindow.cm;\par
var Cities = \{\};\par
\par
var trStartupTimer = null;\par
\par
var trDispTimer = null;\par
\par
function trStartup ()\{\par
    \par
   if (!unsafeWindow.cm)\par
        return;\par
\par
    if (uW.trLoaded)\par
        return;\par
\par
    var metc = getClientCoords(document.getElementById('main_engagement_tabs'));\par
    if (metc.width==null || metc.width==0)\{\par
        trStartupTimer = setTimeout (trStartup, 1000);\par
        return;\par
    \}\par
\par
    uW.trLoaded = Version;\par
\par
    readUpgradeData();\par
    readUpgradeStats();\par
    readSalvageData();\par
    readQueueData();\par
    readPresetData();\par
\par
    logit ("Throne room organizer loaded");\par
\par
    installHandlerFunctions();\par
\par
    var styles = '.xtab \{padding-right: 5px; border:none; background:none; white-space:nowrap;\}\\\par
        .xtabBR \{padding-right: 5px; border:none; background:none;\}\\\par
        .semi_transparent \{ zoom: 1; filter: alpha(opacity=60); opacity: 0.6;\}  \\\par
        div.trTitle \{ text-shadow: 0px 1px 0px white; line-height: 24px; text-align: center; color: #5C3317; font: bold 1.3em Georiga; \}\\\par
        .rot45 \{ transform: rotate(-45deg); -ms-transform: rotate(-45deg); -webkit-transform: rotate(-45deg); -o-transform: rotate(-45deg); -moz-transform: rotate(-45deg); -moz-transform-origin: 50% 50%; z-index: 10;\}\\\par
        div.cardOverlay \{ font: cracked; width: 100%; font-size:3.5em; position: absolute; left: 0%; top: 50%; color: red; text-align: center; text-shadow: 2px 2px 4px #000;\} \\\par
        div.trCloseSpan \{float: right; background-image: url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/close_icon.png"); background-repeat: no-repeat; height: 20px; width: 20px; \}\\\par
        body table.trMainTab tbody tr td \{background: transparent;\}\\\par
        table.trTabdef \{ height: 0px;\}\\\par
        .trCardDisp \{ display: static;\}\\\par
        table.trTabDef thead \{background: transparent;\}\\\par
        table.trPopMain tbody tr td,th \{background: transparent;\}\\\par
        table.trTabDef tbody tr td \{background: transparent; height: 0px; \}\\\par
        table.trTab tr td, th \{ border: 1px solid brown;\}\\\par
        #tr_footer \{height: 50px; background: url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/dialog_740_r3_c1.jpg") scroll no-repeat center bottom;\}\\\par
        #tr_footer \{ background-size: cover; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover; \}\\\par
        table.trTab tr td,th \{border:none; background:none; padding: 0px\}\\\par
        table.trTab#trDisplayTable tr th \{ border: 3px solid grey; font-size:1.2em; \}\\\par
        table.trStatTab tr td \{ background-color: #ffffff; white-space:nowrap; padding:5px; border-bottom:solid black 1px;\}\\\par
        table.trStatTab tr td:last-child \{ border-right:solid black 1px; \}\\\par
        table.trStatTab tr:first-child th \{ border-top:solid black 1px; \}\\\par
        table.trStatTab tr td.td0 \{ background-color: white; \}\\\par
        table.trStatTab tr td.td1 \{ background-color: #eeeeee; \}\\\par
        table.trStatTab tr td.td2 \{ background-color: white; \}\\\par
        table.trStatTab tr th \{border:solid black 1px; border-top: none; background-color: #357; color: white; white-space:nowrap; padding:5px\}\\\par
        table.trStatTab tr:last-child td:first-child, table.trStatTab tr:last-child th:first-child \{ -moz-border-radius-bottomleft:10px; -webkit-border-bottom-left-radius:10px; border-bottom-left-radius:10px\} \\\par
        table.trStatTab tr:last-child td:last-child, table.trStatTab tr:last-child th:last-child \{ -moz-border-radius-bottomright:10px; -webkit-border-bottom-right-radius:10px; border-bottom-right-radius:10px\} \\\par
        table.trStatTab tr:first-child th:first-child \{ -moz-border-radius-topleft:10px; -webkit-border-top-left-radius:10px; border-top-left-radius:10px\} \\\par
        table.trStatTab tr:first-child th:last-child \{ -moz-border-radius-topright:10px; -webkit-border-top-right-radius:10px; border-top-right-radius:10px\} \\\par
        table.trTabLined tbody tr td \{border-bottom:1px solid gray; padding: 2px 5px; \}\\\par
        table.trOptions tr td,th \{border:1px none none solid none; padding: 1px 3px; white-space:nowrap;\}\\\par
        table.trSrchResults tr td,th \{border:1px none none solid none; padding: 1px 3px; white-space:nowrap;\}\\\par
        table.trTabSome tr td,th \{border:none; background:none; padding: 1px 3px; white-space:nowrap;\}\\\par
        table.trTabPad tr td,th \{ padding-left: 2px; background: none;\}\\\par
        table.trTabPad2 tr td,th \{ padding-left: 20px; background: none;\}\\\par
        .trDetLeft \{padding:0 5px 0 0 !important; font-weight:bold; text-align:right\}\\\par
        .trStat \{border:1px solid; border-color:#000000; font-weight:bold; padding-top:2px; padding-bottom:2px; text-align:center; color:#ffffff ; background-color:#357;  -moz-border-radius:5px;\}\\\par
        .trentry \{padding: 7px; white-space:nowrap;\}\\\par
        button::-moz-focus-inner, input[type="submit"]::-moz-focus-inner \{ border: none; \}\\\par
        button::-moz-focus-inner, input[type="button"]::-moz-focus-inner \{ border: none; \}\\\par
        .castleBut \{outline:0px; margin-left:0px; margin-right:0px; width:24px; height:26px; font-size:12px; font-weight:bold;\}\\\par
        .castleBut:hover \{background-image:url("'+ URL_CASTLE_BUT_SEL +'")\}\\\par
        .castleButNon \{background-image:url("'+ URL_CASTLE_BUT +'")\}\\\par
        .castleButSel \{background-image:url("'+ URL_CASTLE_BUT_SEL +'")\}\\\par
        input.trDefButOn \{cursor:pointer; border:1px solid #45d183; -moz-box-shadow:inset 0px 1px 5px #3aef8b; -moz-border-radius:5px;\}\\\par
        input.trDefButOff \{cursor:pointer; border:1px solid #f61646; -moz-box-shadow:inset 0px 1px 5px #f6375f; -moz-border-radius:5px;\}\\\par
        table.trMainTab \{ empty-cells: show;  \}\\\par
        table.trMainTab tr td,th a \{color:inherit \}\\\par
        table.trMainTab tr td,th  \{height:60%; empty-cells:show; padding: 0px 0px 0px 0px;  margin-top:5px; white-space:nowrap; border: 1px solid; border-style: none none solid none; -moz-border-radius:5px; \}\\\par
        table.trMainTab tr td.spacer,th.space \{padding: 0px 0px;\}\\\par
        table.trMainTab tr th.sel,td.sel    \{font-weight:bold; font-size:13px; \}\\\par
        table.trMainTab tr th.notSel,td.notSel \{font-weight:bold; font-size:13px; \}\\\par
        tr.trPopTop td,th \{ background-color:transparent; border:none; height: 21px;  padding:0px;\}\\\par
        .trPopMain  \{  -moz-box-shadow:inset 0px 0px 10px #6a6a6a; -moz-border-radius-bottomright: 20px; -moz-border-radius-bottomleft: 20px;\}\\\par
        .trPopup  \{ border:3px ridge #666; opacity:'+upgradeData.Opacity+'; -moz-border-radius:25px; -moz-box-shadow: 1px 1px 5px #000000;\}\\\par
        .trPopup \{ overflow-x: hide; overflow-y: hide; max-height: 900px; min-height: 400px; height: 500px;  \}\\\par
        #tr_top \{  background: url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/dialog_740_r2_c1.jpg") no-repeat transparent 0% 0%; \}\\\par
        #tr_top \{ background-size: cover; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover; \}\\\par
        /* this was needed because the css used a object id and not a class.  reusing the ID caused display issues w/ the TR tooltips */ \\\par
        div.trCard \{width: 200px;\}\\\par
        div.trCard div.description>div\{width:70px;height:70px; \}\\\par
        div.trCard div.description div.briton.advisor\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/briton_advisor_normal_1.png") top left no-repeat;\}\\\par
        div.trCard div.description div.briton.banner\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/briton_banner_normal_1.png") top left no-repeat;\}\\\par
        div.trCard div.description div.briton.chair\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/briton_chair_normal_1.png") top left no-repeat;\}\\\par
        div.trCard div.description div.briton.table\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/briton_table_normal_1.png") top left no-repeat;\}\\\par
        div.trCard div.description div.briton.window\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/briton_window_normal_1.png") top left no-repeat;\}\\\par
        div.trCard div.description div.briton.trophy\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/briton_trophy_normal_1_5.png") top left no-repeat;\}\\\par
        div.trCard div.description div.briton.candelabrum\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/briton_candelabrum_normal_1_5.png") top left no-repeat;\}\\\par
        div.trCard div.description div.druid.advisor\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/druid_advisor_normal_1.png") top left no-repeat;\}\\\par
        div.trCard div.description div.druid.banner\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/druid_banner_normal_1.png") top left no-repeat;\}\\\par
        div.trCard div.description div.druid.chair\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/druid_chair_normal_1.png") top left no-repeat;\}\\\par
        div.trCard div.description div.druid.table\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/druid_table_normal_1.png") top left no-repeat;\}\\\par
        div.trCard div.description div.druid.window\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/druid_window_normal_1.png") top left no-repeat;\}\\\par
        div.trCard div.description div.druid.trophy\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/druid_trophy_normal_1_5.png") top left no-repeat;\}\\\par
        div.trCard div.description div.druid.candelabrum\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/druid_candelabrum_normal_1_5.png") top left no-repeat;\}\\\par
        div.trCard div.description div.fey.advisor\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/fey_advisor_normal_1.png") top left no-repeat;\}\\\par
        div.trCard div.description div.fey.banner\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/fey_banner_normal_1.png") top left no-repeat;\}\\\par
        div.trCard div.description div.fey.chair\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/fey_chair_normal_1.png") top left no-repeat;\}\\\par
        div.trCard div.description div.fey.table\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/fey_table_normal_1.png") top left no-repeat;\}\\\par
        div.trCard div.description div.fey.window\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/fey_window_normal_1.png") top left no-repeat;\}\\\par
        div.trCard div.description div.fey.trophy\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/fey_trophy_normal_1_5.png") top left no-repeat;\}\\\par
        div.trCard div.description div.fey.candelabrum\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/icons/70/fey_candelabrum_normal_1_5.png") top left no-repeat;\}\\\par
        div.trCard\{font:bold 16px Georiga; overflow: hidden;\}\\\par
        div.trCard>div\{float:left;border:1px solid #a56631;margin:0px;padding:0px;width:200px; height: 300px;background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/modal/modal_med_bg_4.png") -200px 0 no-repeat;\}\\\par
        div.trCard div.title\{font:bold 16px Georgia;border-bottom:1px solid #703200;padding:4px 3px 5px 8px;background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/panel/modal/item_bg.png") -20px -100px no-repeat;\}\\\par
        div.trCard div.title span.icon\{background:transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/modal/equip.png") top right no-repeat;display:block;height:20px;width:20px;top:12px;right:12px;position:absolute;\}\\\par
        div.trCard .disabled\{opacity:.5;\}\\   div.trCard ul\{margin:0px;padding:0;list-style:none;\}\\\par
        div.trCard li\{padding:0px 0 0 0px;color:#3f2300;font-weight:bold;font-size:16px;\}\\\par
        div.trCard div.description\{overflow:hidden;border-bottom:1px solid #703200;padding:5px 0;\}\\\par
        div.trCard div.description\{overflow:hidden;border-bottom:1px solid #703200;\}\\\par
        div.trCard div.description div.portrait\{float:left;\}\\\par
        div.trCard div.description div.portrait\{border:3px solid #deaf69;margin-right:10px;\}\\\par
        div.trCard div.description>ul\{float:left;margin:3px 0 0 0;padding:0;\}\\\par
        div.trCard div.description>ul li\{padding:0;font-weight:bold;font-size:13px;text-transform:capitalize;\}\\\par
        div.trRule \{border:2px inset #c0c0c0; margin-right:10px; margin-left:10px; margin-bottom:2px; padding-left:5px; padding-bottom:5px\} \\\par
        div.trRuleCreate \{margin-right:10px; padding-right: 5px; margin-bottom:2px; padding-bottom:5px\} \\\par
        div.trRule \{ background-color: #eeeeee; \} \\\par
        div.blueBorder \{ border: 2px solid blue; \} \\\par
        div.blueBorder2 \{ border: 10px solid blue; \} \\\par
        div.yellowBorder \{ outline: 2px solid yellow; outline-offset:0px; \}\\\par
        div.yellowBorder2 \{ outline: 10px solid yellow; outline-offset:0px; \}\\\par
        #trhammer \{ background-image: url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/modal/sm_hammer.png"); background-repeat: no-repeat; background-color: transparent; display: inline-block; width: 28px; height: 32px; margin: 2px; vertical-align: middle;\}\\\par
        div.trhammer \{ background-image: url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/modal/sm_hammer.png"); background-repeat: no-repeat; background-color: transparent; display: inline-block; width: 28px; height: 32px; margin: 2px; vertical-align: middle;\}\\\par
        div.trbroken \{ background-image: url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/modal/sm_fail_overlay.png"); background-repeat: no-repeat; background-color: transparent; display: inline-block; width: 28px; height: 32px; margin: 2px; vertical-align: middle;\}\\\par
        div.trsuccess \{ background-image: url('+ success_image +'); background-repeat: no-repeat; background-color: transparent; display: inline-block; width: 28px; height: 32px; margin: 2px; vertical-align: middle;\}\\\par
        div.trup \{ display=inline;  background-image: url('+ up_img +'); background-repeat: no-repeat; background-color: transparent;  width: 28px; height: 24px; \}\\\par
        div.trup:hover \{ display=inline;  background-image: url('+ up_glow +'); background-repeat: no-repeat; background-color: transparent;  width: 28px; height: 24px; \}\\\par
        div.trremove \{ display=inline;  background-image: url('+ remove_img +'); background-repeat: no-repeat; background-color: transparent;  width: 50px; height: 50px; \}\\\par
        div.trremove:hover \{ display=inline;  background-image: url('+ remove_glow +'); background-repeat: no-repeat; background-color: transparent;  width: 50px; height: 50px; \}\\\par
        div.trdown \{ display=inline;  background-image: url('+ down_img +'); background-repeat: no-repeat; background-color: transparent;  width: 28px; height: 24px; \}\\\par
        div.trdown:hover \{ display=inline;  background-image: url('+ down_glow +'); background-repeat: no-repeat; background-color: transparent;  width: 28px; height: 24px; \}\\\par
        div.trgbtn \{ display=inline;  background-image: url('+ gbtn_img +'); background-repeat: no-repeat; background-color: transparent;  width: 32px; height: 32px; margin: 0px; \}\\\par
        ul#t_throneStatList li \{ float: left; width: 22px; height: 22px; text-align: center; color: white; \}\\\par
        ul#t_throneStatList li.active \{ background: transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/modal/set_active.png") top left no-repeat; \} \\\par
        ul#t_throneStatList li.selected \{ background: transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/modal/set_selected.png") top left no-repeat; \}\\\par
        ul#t_throneStatList li.locked \{ background: transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/modal/set_locked.png") top left no-repeat; text-indent: -999px; \}\\\par
        ul#t_throneStatList li.buy \{ background: transparent url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/throne/modal/set_buy.png") top left no-repeat; text-indent: -999px; \}\\\par
        #trQueue th \{ text-align: center; \}\\\par
        div.tt \{margin-left: -999em; position: absolute;\}\\\par
        div.indent25 \{padding-left:25px\}\\\par
        a.loadPreset:hover div.tt \{ border-radius: 5px 5px; -moz-border-radius: 5px; -webkit-border-radius: 5px;\\\par
        box-shadow: 5px 5px 5px rgba(0, 0, 0, 0.1); -webkit-box-shadow: 5px 5px rgba(0, 0, 0, 0.1); -moz-box-shadow: 5px 5px rgba(0, 0, 0, 0.1);\\\par
        font-family: Calibri, Tahoma, Geneva, sans-serif; font-weight: normal;\\\par
        position: absolut; left: 250px; top: 100px; z-index: 99;\\\par
        margin-left: 0; width: 200px; background-color: white; color: black;\\\par
        background: #FFFFAA; border: 1px solid #FFAD33; padding: 0.8em 1em;\}';\par
\par
    window.name = 'TR';\par
    \par
    if (upgradeData.trWinPos==null ||  upgradeData.trWinPos.x==null || upgradeData.trWinPos.x=='' || isNaN(upgradeData.trWinPos.x))\{\par
        var c = getClientCoords (document.getElementById('main_engagement_tabs'));\par
        upgradeData.trWinPos.x = 100;\par
        upgradeData.trWinPos.y = 100;\par
        saveUpgradeData();\par
    \}\par
    \par
    var newCSS = GM_getResourceText ("jqcss");\par
    GM_addStyle (newCSS);\par
    GM_addStyle (styles);\par
    \par
    // clear some styles\par
    var styles2 = ".ui-widget-content \{ font-size: 1.0em; background: none; border: none;\}" +\par
            " .ui-tabs .ui-tabs-nav li a \{ font-weight: bold; font-family: georgia,arial,sans-serif; color: white; font-size: 1.2em; background: url('https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/tab_unselected.png') no-repeat scroll 0% 0% transparent;\}" +\par
            " .ui-tabs .ui-tabs-nav li.ui-tabs-active a \{   background: url('https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/tab_selected.png') no-repeat scroll 0% 0% transparent;\}" +\par
            ".ui-widget-content a \{ color: white;\}" +\par
            "a.buttonDown20 span \{ color: white;\}" +\par
    \tab\tab ".ui-widget \{font-size: 1.0em;\}" +\par
    \tab     ".ui-dialog .ui-dialog-title \{margin: 0px; width: 100%;\}" +\par
    \tab\tab ".ui-widget-header \{background: none; border: none;\}" +\par
    \tab\tab ".ui-state-deafault \{background-color: none; \}" +\par
    \tab\tab ".ui-widget .ui-widget \{font-size: 0.9em;\}" +\par
    \tab\tab '.ui-dialog .ui-dialog-titlebar-close span \{ background-position: 0px 0px; background-image: url("https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/close_icon.png"); background-repeat: no-repeat; height: 20px; width: 20px; \}' +\par
    \tab\tab " .ui-dialog .ui-dialog-titlebar-close \{ top: 30%; width: 20px; height: 20px;\}" +\par
    \tab\tab " .ui-resizable-s \{ background: rgba(0,0,255,0.3);\}" +\par
    \tab\tab " .ui-tabs .ui-tabs-nav \{ position: relative; top: 10px; left: 15px;\}" +\par
    \tab\tab " table.trTable tbody tr td \{ background: none;\}";\par
    GM_addStyle(styles2);\par
\par
    var prefix = 'tr';\par
    var topClass = 'trPopTop';\par
\par
    $("#mainbody").append(\par
            "<div id='tr_dialog' class='trPopup tr_trPopup'>"\par
            + '<TABLE class=trTab cellspacing=0 width=100% height=100%>'\par
            + '<tbody><TR><TD colspan=2><div width=720px height=100% valign=top class="trPopMain '+ prefix +'_trPopMain" id="'+ prefix +'_main"></div></td></tr>'\par
            + '<tr><td colspan=2><div id=tr_footer></div></td>'\par
            + '</tr></tbody></table></div>');\par
\par
    $("#tr_dialog").css(\{\par
        "overflow-y": "hidden",\par
        "overflow-x": "hidden",\par
        "padding": '0px'\par
    \});\par
    \par
    var tStr= '<div style="width: auto; padding: 0px;" vAlign=top id="'+ prefix +'_bar" class="'+ topClass +' trTitle">Throne Room Organizer</div>';\par
\par
    $("#tr_dialog").dialog(\{\par
        title: tStr,\par
        zIndex: 111111,\par
        position: [ upgradeData.trWinPos.x, upgradeData.trWinPos.y],\par
        draggable: true,\par
        height: "auto",\par
        maxHeight: 2000,\par
        minHeight: 300,\par
        width: "auto",\par
        resizable: false,\par
        autoOpen: upgradeData.trWinIsOpen,\par
        dragStop: function( event, ui ) \{\par
            upgradeData.trWinPos.x = ui.position.left;\par
            upgradeData.trWinPos.y = ui.position.top;\par
            saveUpgradeData();\par
        \},\par
        close: function( event, ui ) \{\par
            upgradeData.trWinIsOpen = false;\par
            saveUpgradeData();\par
        \}\par
  \par
    \});\par
    \par
    $("#tr_dialog").css('max-height', '2000px');\par
    \par
    \par
    $("#tr_dialog").parent().attr( \{id: 'tr_top', padding: '0px'\});\par
    mainPop = $("#tr_top")[0];\par
    $("div.ui-dialog-titlebar").css( \{background: 'none', border: 'none'\} );\par
    \par
    var mainDiv = $("#tr_top")[0];\par
\par
    setCities();\par
\par
    CM.cheatDetector.detect = foo;\par
\par
    $("#tr_main").html(\par
            '<div>\\\par
            <ul>\\\par
            <li><a href="#tabs-upgrade">Upgrade</a></li>\\\par
            <li><a href="#tabs-salvage">Salvage</a></li>\\\par
            <li><a href="#tabs-organize">Organize</a></li>\\\par
            <li><a href="#tabs-estats">Enhance Stats</a></li>\\\par
            <li><a href="#tabs-ustats">Upgrade Stats</a></li>\\\par
            <li><a href="#tabs-options">Options</a></li>\\\par
            <li><a href="#tabs-log">Log</a></li>\\\par
            </ul>\\\par
            <div id="tabs-upgrade">  Options tab    </div>\\\par
            <div id="tabs-salvage">  Salvage tab    </div>\\\par
            <div id="tabs-organize">  Organize tab    </div>\\\par
            <div id="tabs-estats">  EStats tab    </div>\\\par
            <div id="tabs-ustats">  UStats tab    </div>\\\par
            <div id="tabs-options">  Options tab    </div>\\\par
            <div id="tabs-log">  Log tab    </div>\\\par
    </div>');\par
    $("#tr_main").tabs(\{ \par
        heightStyle: "content",\par
        active: upgradeData.activeTab,\par
        beforeActivate: function( event, ui ) \{\par
            if (ui.oldPanel && ui.oldPanel[0]) \{\par
               tab = findTab(ui.oldPanel[0]);\par
               if (tab) \{\par
                   Tabs[tab].hide();\par
               \}\par
            \}\par
            if (ui.newPanel && ui.newPanel[0]) \{\par
                var tab = findTab(ui.newPanel[0]);\par
                if (tab) Tabs[tab].show();  \par
            \}\par
        \}\par
        \});\par
    \par
    // set the width of all main tab divs\par
    $("#tr_main>div").css(\{\par
        "width": "auto",\par
        "padding": "0px"\par
    \});\par
\par
    window.addEventListener('unload', onUnload, false);\par
\par
    Tabs.options.init($("#tabs-options")[0]);\par
    Tabs.trActionLog.init($("#tabs-log")[0]);\par
    Tabs.upgrader.init($("#tabs-upgrade")[0]);\par
    Tabs.throneSalvage.init($("#tabs-salvage")[0]);\par
    Tabs.organizer.init($("#tabs-organize")[0]);\par
    Tabs.ustats.init($("#tabs-ustats")[0]);\par
    Tabs.estats.init($("#tabs-estats")[0]);\par
    \par
    trPopup('tr');\par
\par
    $( "#tr_main" ).tabs( "refresh" ); \par
\par
    AddMainTabLink('TR Organizer', trHideShow, trMainTab);\par
    attachTab();\par
\par
    // set the labels on the new salvage tab\par
    $("a.throne").click( function() \{\par
        Tabs.throneSalvage.updateTRTab();\par
        Tabs.upgrader.updateTRTab();\par
        //Tabs.upgrader.updateTRSelect();\par
        $("ul#throneInventoryList > li > div").removeClass('blueBorder');\par
        $("ul#throneInventoryList > li > div").removeClass('yellowBorder');\par
\par
        for (ii in queueData.list) \{\par
            var list_item = queueData.list[ii];\par
            if (!list_item) continue;\par
            if (list_item.status != "complete") \{\par
                var id = list_item.item;\par
                if (list_item.action == "upgrade") $("div#throneInventoryItem" + id).addClass('blueBorder');\par
                if (list_item.action == "enhance") $("div#throneInventoryItem" + id).addClass('yellowBorder');\par
            \}\par
\par
        \}\par
\par
        $("ul#throneInventoryList").css('height', '520px');\par
        $("div#throneInventoryContainer").css('height', '520px');\par
\par
        // update the other presets buttons when clicked\par
        $('ul#throneStatList li.active, ul#throneStatList li.selected').click( \par
                function () \{\par
                    var s = $(this).attr('id').split('throneInventoryPreset')[1];\par
                    setPresetWidget(+s);\par
                \});\par
    \});\par
\par
    // create a preset list on the main display\par
    buildPresetWidget();\par
    \par
    // set the color on the tab button\par
    setUpgradeColor();\par
    \par
    trDispTimer = setInterval(updateTimerDisp , 1000);\par
\par
\}\par
\par
var foo = function() \{\par
\};\par
\par
function setUpgradeColor() \{\par
    if (upgradeData.newUpgradeState == 0)\par
        $("#trtab>span").css('color', '#FFFF66');\par
    else if (upgradeData.newUpgradeState == 1)\par
        $("#trtab>span").css('color', 'cyan');\par
    else if (upgradeData.newUpgradeState == 2)\par
        $("#trtab>span").css('color', 'red');\par
\}\par
\par
\par
//callback handler when a preset button is presed\par
function processPresetClick(btn)\par
\{\par
    // don't do anything if already the right preset\par
    if (btn == Seed.throne.activeSlot) return;\par
\par
    // send message\par
    unsafeWindow.AjaxCall.gPostRequest(\par
            "ajax/_dispatch53.php",\par
            \{\par
                ctrl: "throneRoom\\\\ThroneRoomServiceAjax",\par
                action: "setPreset",\par
                presetId: btn\par
            \},\par
            function (v) \{\par
                if (v.ok === true)\par
                \{\par
                    // success\par
                    var H = Seed.throne.slotEquip[btn];\par
                    Seed.throne.activeSlot = btn;\par
\par
                    // set the right items as equiped\par
                    $.each(unsafeWindow.kocThroneItems, function (I, J) \{\par
                        C = $.inArray(J.id, H) > -1;\par
                        if (C) \{\par
                            J.isEquipped = true;\par
                        \} else \{\par
                            J.isEquipped = false;\par
                        \}\par
                    \});\par
\par
                    // update the buttons\par
                    setPresetWidget(btn);\par
                    unsafeWindow.cm.ThroneView.renderThrone();\par
                    unsafeWindow.cm.ThroneView.renderStats();\par
\par
                    // redraw the organizer tab\par
                    Tabs.organizer.show();\par
                \}\par
                else\par
                \{\par
                    logit("Preset change failed. Error code: " + v.error_code);\par
                \}\par
            \}\par
    );\par
\}\par
\par
//update the preset list buttons\par
function setPresetWidget(slot)\par
\{\par
    // logit("preset: " + slot);\par
    var x = ($("#t_throneStatList .selected, #throneStatList .selected"));\par
    x.removeClass('selected');\par
    x.addClass('active');\par
    x.bind("mouseenter", function (I) \{\par
        unsafeWindow.cm.ThroneView.boostsTooltip(this, I, I.target.id)\par
    \});\par
    x.bind("mouseleave", function (I) \{\par
        unsafeWindow.removeTooltip()\par
    \});\par
\par
    var s = $("#t_throneInventoryPreset" + slot + ", #throneInventoryPreset" + slot);     \par
    s.removeClass('active');\par
    s.addClass('selected')\par
    s.unbind("mouseenter").unbind("mouseleave");\par
\}\par
\par
//create a preset list on the main display\par
function buildPresetWidget()\par
\{\par
    var E = [];\par
    var J = Seed.throne.activeSlot;\par
    var F = Seed.throne.slotNum;\par
\par
    for (var G = 0; G < 8; ++G) \{\par
        var H = G + 1;\par
        var I = $("<li/>");\par
        if (H === J) \{\par
            I.attr("id", "t_throneInventoryPreset" + H);\par
            I.addClass("selected");\par
            I.html(H);\par
            I.bind("click", \{\par
                idx: G\par
            \}, function (K) \{\par
                var L = K.data.idx + 1;\par
                processPresetClick(L);\par
            \});\par
\par
        \} else \{\par
            if (H === (F + 1)) \{\par
                I.attr("id", "t_throneInventoryPreset" + H);\par
                I.addClass("buy");\par
                I.html(H);\par
                I.bind("click", function () \{\par
                    unsafeWindow.cm.ContextualMenuThrone.renderMenu(this, null);\par
                \})\par
            \} else \{\par
                if (H <= F) \{\par
                    I.attr("id", "t_throneInventoryPreset" + H);\par
                    I.addClass("active");\par
                    I.html(H);\par
                    I.bind("click", \{\par
                        idx: G\par
                    \}, function (K) \{\par
                        var L = K.data.idx + 1;\par
                        processPresetClick(L);\par
                    \});\par
                    I.bind("mouseenter", function (K) \{\par
                        unsafeWindow.cm.ThroneView.boostsTooltip(this, K, K.target.id)\par
                    \});\par
                    I.bind("mouseleave", function (K) \{\par
                        unsafeWindow.removeTooltip()\par
                    \})\par
                \} else \{\par
                    I.attr("id", "t_throneInventoryPreset" + H);\par
                    I.addClass("locked");\par
                    I.html(H)\par
                \}\par
            \}\par
        \}\par
        E.push(I)\par
    \}\par
    var C = $("<ul/>", \{\par
        id: "t_throneStatList",\par
        addClass: "presetList",\par
        style: "padding: 0; margin: 5px; list-style: none; overflow: hidden; float: left; border: 5px outset tan;"\par
    \});\par
    $.each(E, function (K, L) \{\par
        C.append(L)\par
    \})\par
\par
    //$("div.tabs_engagement").append(C);\par
    //$("div#kocmain_bottom").append(C);\par
    var aa = $("<div/>", \{height: '40px'\});\par
    $(aa).append(C);\par
    $("div.mod_comm").prepend(aa);\par
\par
    var p = $("div.mod_comm").css('top');\par
    if (+p.split('px')[0] < -611)\par
    \{  \par
        $("div.mod_comm").css('top', "-610px");\par
        $("div.comm_body").css('top', '40px');\par
    \}\par
\par
    $("div.mod_comm").bind('DOMAttrModified', function ()\par
            \{\par
        var p = $("div.mod_comm").css('top');\par
        if (+p.split('px')[0] < -611)\par
        \{  \par
            $("div.mod_comm").css('top', "-610px");\par
            $("div.comm_body").css('top', '40px');\par
        \}\par
            \});\par
\}\par
\par
function updateTimerDisp () \{\par
\par
    var t = Tabs.upgrader;\par
    var timeUntilDone = 0;\par
\par
    if (t.repairEnd != 0)\par
    \{\par
        timeUntilDone = t.repairEnd - unixTime();\par
    \}\par
\par
    if (timeUntilDone > 0)\par
    \{\par
        $("#trtimerdisp").html("<span id='trhammer'></span>  " + rectime(timeUntilDone))\par
        .css('text-align', 'left')\par
        .css('width', '100px');\par
    \}\par
    else\par
    \{\par
        $("#trtimerdisp").html("<span id='trhammer'></span> Done").css('width', '100px');\par
    \}\par
\}\par
\par
\par
function rectime(secs) \{\par
    var min = Math.floor((secs)/60);\par
    var sec = Math.ceil(secs - (min * 60));\par
\par
    if (sec < 10) \{sec = "0" + sec;\}\par
    return  min + ':' + sec;\par
\}\par
\par
var withAnim = null;\par
if (unsafeWindow.cm && unsafeWindow.cm.ThronePanelView) withAnim = unsafeWindow.cm.ThronePanelView.statusAnim;\par
\par
\par
function noAnim(result) \{\par
    if (result == "success")\par
    \{\par
        var item_name = $("#thronePanelName").html();\par
        var attempt_type = $("div.thronePanelContainer").find("li.selected").html();\par
\par
        var msg = "Manual ";\par
        if (attempt_type)\par
            msg += attempt_type;\par
        else\par
            msg += "upgrade/enhance";\par
\par
        msg += " successful."\par
\par
            if (item_name) msg += "  Item: " + item_name;\par
\par
        trSuccessLog(msg);\par
\par
        if (withAnim) withAnim(result);\par
    \}\par
    $("div.thronePanelItemContainer").append("<div>" + result + "</div>");\par
\}\par
\par
function disableAnimation(disable) \{\par
    if (disable) \{\par
        // override the success failure animations\par
        CM.ThronePanelView.statusAnim = noAnim;\par
    \} else \{\par
        if (withAnim) CM.ThronePanelView.statusAnim = withAnim;\par
    \}\par
\}\par
\par
function installHandlerFunctions() \{\par
\par
    var oldR = unsafeWindow.cm.ThroneView.renderInventory;\par
\par
    var ri2 = function(l) \{\par
        oldR(l);\par
        $("ul#throneInventoryList > li > div").removeClass('blueBorder');\par
        $("ul#throneInventoryList > li > div").removeClass('yellowBorder');\par
        for (ii in queueData.list) \{\par
            var list_item = queueData.list[ii];\par
            if (!list_item) continue;\par
            if (list_item.status != "complete") \{\par
                var id = list_item.item;\par
\par
                if (list_item.action == "upgrade") $("div#throneInventoryItem" + id).addClass('blueBorder');\par
                if (list_item.action == "enhance") $("div#throneInventoryItem" + id).addClass('yellowBorder');\par
\par
            \}\par
\par
        \}\par
    \};\par
\par
    unsafeWindow.cm.ThroneView.renderInventory = ri2;\par
\par
    // intercept the render menu call for our own uses\par
\par
    // save the location of the old funtion\par
    var oldF = unsafeWindow.cm.ContextualMenuThrone.renderMenu;\par
\par
    var renderMenu2 = function (l, j) \{\par
        // call the old one\par
        oldF(l,j);\par
\par
        if (j != null)\par
        \{\par
            // create a button to set the item to auto-enhance\par
            var btn2 = document.createElement('a');\par
            $(btn2).addClass("buttonv2 h20 green")\par
            .html("Auto Enhance")\par
            .css('color', 'yellow')\par
            .bind("click", function () \{\par
                Tabs.upgrader.addEnhanceItem(j.id);\par
                Tabs.upgrader.repaint();\par
                $("#contextMenu").remove();\});\par
            $("#contextMenu div.title").after(btn2);\par
\par
            // create a button to set the item to auto-update\par
            var btn = document.createElement('a');\par
            $(btn).addClass("buttonv2 h20 green")\par
            .html("Auto Upgrade")\par
            .css('color', 'blue')\par
            .bind("click", function () \{\par
                Tabs.upgrader.addUpgradeItem(j.id);\par
                Tabs.upgrader.repaint();\par
                $("#contextMenu").remove();\});\par
            $("#contextMenu div.title").after(btn);\par
\par
            // create a button to set the item to auto-update/enhance\par
            var btn = document.createElement('a');\par
            $(btn).addClass("buttonv2 h20 green")\par
            .html("Auto Upgrade/Enhance")\par
            .css('color', 'black')\par
            .bind("click", function () \{\par
                Tabs.upgrader.addBothItem(j.id);\par
                Tabs.upgrader.repaint();\par
                $("#contextMenu").remove();\});\par
            $("#contextMenu div.title").after(btn);\par
\par
            // create a button to copy the stats\par
            var btn = document.createElement('a');\par
            $(btn).addClass("buttonv2 h20 blue")\par
            .html("Copy Stats")\par
            .css('color', 'white')\par
            .bind("click", function () \{\par
                var cText = $("div#trCardItem" + j.id).find("div.trCard").text();\par
                if (cText) window.prompt ("Copy to clipboard: Ctrl+C", cText);\par
                $("#contextMenu").remove();\})\par
                $("#contextMenu div.title").after(btn);\par
\par
\par
            $(".buttonv2.red").click(function() \{ $(".mediumModal").css('z-index', 120000);\});\par
        \}\par
\par
    \};\par
\par
    // hook up our new function\par
    unsafeWindow.cm.ContextualMenuThrone.renderMenu = renderMenu2;\par
\par
    // add some new functionality here ...\par
    var F2 = CM.ThronePanelView.renderPanel;\par
\par
    var renderPanel2 = function(v1, v2) \{\par
        F2(v1,v2);\par
        // save off this data ...\par
        Tabs.organizer.panelId = v2.id;\par
        Tabs.organizer.panelType = v1;\par
        Tabs.organizer.panelNextLevel = 2;\par
       \par
        // register some callbacks when the buttons are pushed\par
        addPanelCb();\par
    \par
        var addClickAction = function ()\par
        \{\par
            // add an action to the buttons to switch between upgrade/enhance\par
            $("#thronePanelContainer div.navigation li").click( function ()\{\par
                // clear the pulldown\par
                unselectToken();\par
                \par
                // buttons have been recreated.  install action again\par
                addClickAction(); \par
            \});\par
        \}\par
        \par
        var checkAstoneLevel = function () \{\par
            // check limit\par
            var stones = Seed.resources["city" + unsafeWindow.currentcityid]["rec5"][0];\par
            if (stones < upgradeData.safetyLimit) \{\par
                disableUpgradeButton();\par
            \}\par
        \}\par
        \par
        var disableUpgradeButton = function () \{\par
            // disable the button\par
            unsafeWindow.jQuery("#thronePanelItemRequirementsContainer a.gemButtonv2").unbind("click");\par
            \par
            // change the appearance\par
            $("#thronePanelItemRequirementsContainer a.gemButtonv2").removeClass('green');\par
            $("#thronePanelItemRequirementsContainer a.gemButtonv2").addClass('gray');\par
            $("#thronePanelItemRequirementsContainer a.gemButtonv2").html("LOW A-STONE")\par
        \}\par
        \par
        var addClickAction2 = function ()\par
        \{\par
            // add an action to the buttons to switch between upgrade/enhance\par
            $("#thronePanelContainer div.navigation li").click( function ()\{\par
                \par
                // check every time the panel is switched\par
                checkAstoneLevel();\par
                 \par
                // buttons have been recreated.  install action again\par
                addClickAction2(); \par
            \});\par
        \}\par
        \par
        if (upgradeData.safetyOn)\par
        \{\par
            // enforce a lower limit on a-stone.   Disable button if too low. \par
            // see if we have enough a-stone\par
            checkAstoneLevel();\par
            \par
            $("#thronePanelItemRequirementsContainer a.gemButtonv2").click ( function ()\{\par
                // every time the button is pushed, check the levels\par
                checkAstoneLevel(); \par
            \});\par
            \par
            addClickAction2();\par
            \par
        \}\par
        \par
        function unselectToken() \{\par
            \par
            // if the user manually selected a buff, leave it alone\par
            if (!buffChanged) \{\par
            \par
               // set the pull down to nothing when first displayed\par
               $("#buffDropDown").val(0);\par
            \par
               // remove the icon ....\par
               $("#thronePanelBuffIcon").removeClass().addClass('icon').addClass('i0');\par
               $("#thronePanelBuffPrice span.items").html('');\par
               \par
               // install an action to track when a buff is selected\par
               $("#buffDropDown").change( function () \{\par
                   buffChanged = true; \par
               \});\par
               \par
               // reset once the dialog is closed\par
               $(".throneContainer div.close").click( function () \{\par
                   buffChanged = false; \par
               \});\par
            \}\par
            \par
        \}\par
        \par
        // force the buff item selection to be empty\par
        if (upgradeData.buffsOff)\par
        \{\par
            // deselect the token\par
            unselectToken();\par
            \par
            // add a clck action to set it back to nothing when switching between upgrade/enhance\par
            addClickAction();\par
        \}\par
        \par
    \};\par
\par
    // hook up to the new function\par
    CM.ThronePanelView.renderPanel = renderPanel2;\par
\}\par
\par
var buffChanged = false;\par
\par
function addPanelCb() \{\par
    // these elements get rebuilt after every click so they have to reinstall\par
    // themselves ...\par
    $("ul.tabsv2 > li:contains('enhance')").click( function() \{Tabs.organizer.panelType = "enhance"; Tabs.organizer.panelNextLevel = 2; addPanelCb();\});\par
    $("ul.tabsv2 > li:contains('upgrade')").click( function() \{Tabs.organizer.panelType = "upgrade"; Tabs.organizer.panelNextLevel = 2; addPanelCb();\});\par
\}\par
\par
function onUnload ()\{\par
\par
    upgradeData.activeTab = $( "#tr_main" ).tabs( "option", "active"); \par
    upgradeData.sortSelected = $("#trSortList").val();\par
    upgradeData.buffSelected = $("#trSortType").val();\par
    upgradeData.sortInactive = ($("#trSortInactive").attr('checked') == 'checked');\par
\par
    if (!ResetAll) saveUpgradeData();\par
\}\par
\par
function trMainTab (me)\{   // right-click on main button resets window\par
    if (me.button == 2)\{\par
        $( "#tr_dialog" ).dialog( "option", "position",  \par
            \{my: "left top",\par
             at: "left+15 bottom+5",\par
             of: "#main_engagement_tabs"\});\par
    \}\par
\}\par
\par
function attachTab()\par
\{\par
\par
    unsafeWindow.hideShow     = trHideShow;\par
    unsafeWindow.execSalvage  = Tabs.throneSalvage.togglePower;\par
    unsafeWindow.execUpgrade  = Tabs.upgrader.togglePower;\par
    unsafeWindow.clickNext    = Tabs.organizer.showNext;\par
\par
    var str = unsafeWindow.cm.FETemplates.Throne.mainThrone.replace(\par
            '<li id="throneStatTab" class="inactive"> Stats </li>',\par
            //'<li id="throneStatTab" class="inactive"> Stats </li><li id="throneTest" class="inactive" onclick="hideShow()"> Controls </li><li id="trexecselect" class="inactive" onclick="execSelect()">Select</li><li id="trexecupgrade" class="inactive" onclick="execUpgrade()">Upgrade</li><li id="trexecsalvage" class="inactive" onclick="execSalvage()">Salvage</li><li id="trtimerdisp" class="inactive">Timer</li>');\par
    '<li id="throneStatTab" class="inactive"> Stats </li><li id="throneTest" class="inactive" onclick="hideShow()"> Controls </li><li id="trexecupgrade" class="inactive" onclick="execUpgrade()">Upgrade</li><li id="trexecsalvage" class="inactive" onclick="execSalvage()">Salvage</li><li id="trtimerdisp" class="inactive">Timer</li>');\par
\par
    str = str.replace( '<div id="thronePanelContainer">', '<div id="thronePanelContainer" style="z-index: 101">');\par
    unsafeWindow.cm.FETemplates.Throne.mainThrone = str;\par
\par
    unsafeWindow.cm.FETemplates.Throne.throneInfo = unsafeWindow.cm.FETemplates.Throne.throneInfo.replace (\par
            '<div id="throneInfoContainer">',\par
    '<div id="throneInfoContainer" style="z-index: 100;">');\par
\par
    unsafeWindow.cm.FETemplates.Throne.mainThrone = unsafeWindow.cm.FETemplates.Throne.mainThrone.replace (\par
            '<div id="throneInfoContainer">',\par
    '<div id="throneInfoContainer" style="z-index: 100;">');\par
\par
    unsafeWindow.cm.FETemplates.Throne.thronePanel = unsafeWindow.cm.FETemplates.Throne.thronePanel.replace(\par
            '<div class="thronePanelContainer">',\par
    '<div class="thronePanelContainer" style="z-index: 101;">');\par
\par
    unsafeWindow.cm.FETemplates.Throne.thronePanel = unsafeWindow.cm.FETemplates.Throne.thronePanel.replace(\par
            '<div id="nextStatContainer" class="nextStat"><span> Next </span>',\par
    '<div id="nextStatContainer" class="nextStat" onclick="clickNext()"><span> Next *Click Me* </span>');  \par
    \par
\}\par
\par
function trHideShow ()\{\par
    if ($("#tr_dialog").dialog("isOpen"))\{\par
        $("#tr_dialog").dialog("close");\par
        upgradeData.trWinIsOpen = false;\par
    \} else \{\par
        $("#tr_dialog").dialog("open");\par
        upgradeData.trWinIsOpen = true;\par
        // clear the color\par
        upgradeData.newUpgradeState = 0;\par
        setUpgradeColor();\par
    \}\par
    saveUpgradeData();\par
\}\par
\par
//Simple method, as if it were typed in thru DOM\par
function sendChat (msg)\{\par
  $("#mod_comm_input").val(msg);\par
  uW.Chat.sendChat ();\par
\}\par
\par
function AddMainTabLink(text, eventListener, mouseListener) \{\par
    var label = "Throne Room";\par
\par
    var a=document.createElement('a');\par
    a.className='button20';\par
    a.innerHTML='<span style="color: #ff6">'+ label +'</span>';\par
    a.id = 'trtab';\par
    a.className='tab';\par
\par
    var tabs=document.getElementById('main_engagement_tabs');\par
    if(!tabs) \{\par
        tabs=document.getElementById('topnav_msg');\par
        if (tabs)\par
            tabs=tabs.parentNode;\par
    \}\par
    if (tabs) \{\par
        var e = tabs.parentNode;\par
        var gmTabs = null;\par
        for (var i=0; i<e.childNodes.length; i++)\{\par
            var ee = e.childNodes[i];\par
            if (ee.tagName && ee.tagName=='DIV' && ee.className=='tabs_engagement' && ee.id!='main_engagement_tabs')\{\par
                gmTabs = ee;\par
                break;\par
            \}\par
        \}\par
        if (gmTabs == null)\{\par
            gmTabs = document.createElement('div');\par
            gmTabs.className='tabs_engagement';\par
            // gmTabs.style.background='#ca5';\par
            tabs.parentNode.insertBefore (gmTabs, tabs);\par
            gmTabs.style.whiteSpace='nowrap';\par
            gmTabs.style.width='735px';\par
            gmTabs.lang = 'en_PT';\par
        \}\par
        if (gmTabs.firstChild)\par
            gmTabs.insertBefore (a, gmTabs.firstChild);\par
        else\par
            gmTabs.appendChild(a);\par
        a.addEventListener('click',eventListener, false);\par
        if (mouseListener != null)\par
            a.addEventListener('mousedown',mouseListener, true);\par
        return a;\par
    \}\par
    return null;\par
\}\par
\par
\par
function getClientCoords(e)\{\par
    if (e==null)\par
        return \{x:null, y:null, width:null, height:null\};\par
        var x=0, y=0;\par
        ret = \{x:0, y:0, width:e.clientWidth, height:e.clientHeight\};\par
        while (e.offsetParent != null)\{\par
            ret.x += e.offsetLeft;\par
            ret.y += e.offsetTop;\par
            e = e.offsetParent;\par
        \}\par
        return ret;\par
\}\par
\par
//emulate protoype's Ajax.Request ...\par
function AjaxRequest (url, opts)\{\par
    var headers = \{\par
            'X-Requested-With': 'XMLHttpRequest',\par
            'X-Prototype-Version': '1.6.1',\par
            'Accept': 'text/javascript, text/html, application/xml, text/xml, */*'\par
    \};\par
    var ajax = null;\par
\par
    if (window.XMLHttpRequest)\par
        ajax=new XMLHttpRequest();\par
    else\par
        ajax=new ActiveXObject("Microsoft.XMLHTTP");\par
\par
    if (opts.method==null || opts.method=='')\par
        method = 'GET';\par
    else\par
        method = opts.method.toUpperCase();\par
\par
    if (method == 'POST')\{\par
        headers['Content-type'] = 'application/x-www-form-urlencoded; charset=UTF-8';\par
    \} else if (method == 'GET')\{\par
        addUrlArgs (url, opts.parameters);\par
    \}\par
\par
    ajax.onreadystatechange = function()\{\par
//      ['Uninitialized', 'Loading', 'Loaded', 'Interactive', 'Complete']; states 0-4\par
        if (ajax.readyState==4) \{\par
            if (ajax.status >= 200 && ajax.status < 305)\par
                if (opts.onSuccess) opts.onSuccess(ajax);\par
                else\par
                    if (opts.onFailure) opts.onFailure(ajax);\par
        \} else \{\par
            if (opts.onChange) opts.onChange (ajax);\par
        \}\par
    \}\par
\par
    ajax.open(method, url, true);   // always async!\par
\par
    for (var k in headers)\par
        ajax.setRequestHeader (k, headers[k]);\par
    if (matTypeof(opts.requestHeaders)=='object')\par
        for (var k in opts.requestHeaders)\par
            ajax.setRequestHeader (k, opts.requestHeaders[k]);\par
\par
    if (method == 'POST')\{\par
        var a = [];\par
        for (k in opts.parameters)\{\par
            if(matTypeof(opts.parameters[k]) == 'object')\par
                for(var h in opts.parameters[k])\par
                    a.push (k+'['+h+'] ='+ opts.parameters[k][h] );\par
            else\par
                a.push (k +'='+ opts.parameters[k] );\par
        \}\par
        ajax.send (a.join ('&'));\par
    \} else               \{\par
        ajax.send();\par
    \}\par
\}\par
\par
function MyAjaxRequest (url, o, noRetryX)\{\par
    if (DEBUG_TRACE) logit (" 0 myAjaxRequest: "+ url +"\\n" + inspect (o, 2, 1));\par
    var opts = unsafeWindow.Object.clone(o);\par
    var wasSuccess = o.onSuccess;\par
    var wasFailure = o.onFailure;\par
    var retry = 0;\par
    var delay = 10;\par
    var noRetry = noRetry===true?true:false;\par
    opts.onSuccess = mySuccess;\par
    opts.onFailure = myFailure;\par
\par
    new AjaxRequest(url, opts);\par
    return;\par
\par
    function myRetry()\{\par
        ++retry;\par
        new AjaxRequest(url, opts);\par
        delay = delay * 2.25;\par
    \}\par
    function myFailure()\{\par
        var o = \{\};\par
        o.ok = false;\par
        o.errorMsg = "AJAX Communication Failure";\par
        wasFailure (o);\par
    \}\par
    function mySuccess (msg)\{\par
        var rslt = eval("(" + msg.responseText + ")");\par
        if (!rslt)\par
        \{\par
            logit("Message error: " + inspect(msg,3,1));\par
            return;\par
        \}\par
        var x;\par
        if (window.EmulateAjaxError)\{\par
            rslt.ok = false;\par
            rslt.error_code=8;\par
        \}\par
        if (rslt.ok)\{\par
            if (rslt.updateSeed)\par
                unsafeWindow.update_seed(rslt.updateSeed);\par
            wasSuccess (rslt);\par
            return;\par
        \}\par
        rslt.errorMsg = unsafeWindow.printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null));\par
        // if ( (x = rslt.errorMsg.indexOf ('<br><br>')) > 0)\par
        // rslt.errorMsg = rslt.errorMsg.substr (0, x-1);\par
        if (!noRetry && (rslt.error_code==0 || rslt.error_code==8 || rslt.error_code==1 || rslt.error_code==3))\{\par
            dialogRetry (inspect(rslt.errorMsg), delay, function()\{myRetry()\}, function()\{wasSuccess (rslt)\}, rslt.error_code);\par
        \} else \{\par
            wasSuccess (rslt);\par
        \}\par
    \}\par
\}\par
\par
//example: https://www150.kingdomsofcamelot.com\par
var myServerId = null;\par
function getServerId() \{\par
    if (myServerId == null)\{\par
        var m=/^[a-zA-Z]+([0-9]+)\\./.exec(document.location.hostname);\par
        if (m)\par
            myServerId = m[1];\par
        else\par
            myServerId = '??';\par
    \}\par
    return myServerId;\par
\}\par
\par
function logit (msg)\{\par
    var now = new Date();\par
    GM_log (getServerId() +' @ '+ now.toTimeString().substring (0,8) +'.' + now.getMilliseconds() +': '+  msg);\par
\}\par
\par
function saveUpgradeData ()\{\par
    var serverID = getServerId();\par
    setTimeout (function ()\{GM_setValue ('UpgradeDataMM2_'+serverID, JSON2.stringify(upgradeData));\}, 0);\par
\}\par
\par
function savePresetData ()\{\par
    var serverID = getServerId();\par
    setTimeout (function ()\{GM_setValue ('PresetDataMM2_'+serverID, JSON2.stringify(presetData));\}, 0);\par
\}\par
\par
function saveQueueData ()\{\par
    var serverID = getServerId();\par
    setTimeout (function ()\{GM_setValue ('QData_'+serverID, JSON2.stringify(queueData));\}, 0);\par
\}\par
\par
function saveSalvageData ()\{\par
    var serverID = getServerId();\par
    setTimeout (function ()\{GM_setValue ('SalvageDataMM2_'+serverID, JSON2.stringify(salvageData));\}, 0);\par
\}\par
\par
function saveUpgradeStats ()\{\par
    var serverID = getServerId();\par
    setTimeout (function ()\{GM_setValue ('UpgradeStats_'+serverID, JSON2.stringify(upgradeStats));\}, 0);\par
\}\par
\par
function readTRGlobalOptions ()\{\par
    TRGlobalOptions = JSON2.parse (GM_getValue ('TROptions_??', '\{\}'));\par
\}\par
\par
function readUpgradeData ()\{\par
    var serverID = getServerId();\par
    s = GM_getValue ('UpgradeDataMM2_'+serverID);\par
    if (s != null)\{\par
        opts = JSON2.parse (s);\par
        for (k in opts)\{\par
            if (matTypeof(opts[k]) == 'object')\par
                for (kk in opts[k])\par
                    upgradeData[k][kk] = opts[k][kk];\par
            else\par
                upgradeData[k] = opts[k];\par
        \}\par
    \}\par
\}\par
\par
function readPresetData ()\{\par
    var serverID = getServerId();\par
    s = GM_getValue ('PresetDataMM2_'+serverID);\par
    if (s != null)\{\par
        opts = JSON2.parse (s);\par
        for (k in opts)\{\par
            if (matTypeof(opts[k]) == 'object')\par
                for (kk in opts[k])\par
                    presetData[k][kk] = opts[k][kk];\par
            else\par
                presetData[k] = opts[k];\par
        \}\par
    \}\par
\}\par
\par
function readQueueData ()\{\par
    var serverID = getServerId();\par
    s = GM_getValue ('QData_'+serverID);\par
    if (s != null)\{\par
        opts = JSON2.parse (s);\par
        for (k in opts)\{\par
            if (matTypeof(opts[k]) == 'object')\par
                for (kk in opts[k])\par
                    queueData[k][kk] = opts[k][kk];\par
            else\par
                queueData[k] = opts[k];\par
        \}\par
    \}\par
\}\par
\par
function readSalvageData ()\{\par
    var serverID = getServerId();\par
    s = GM_getValue ('SalvageDataMM2_'+serverID);\par
    if (s != null)\{\par
        opts = JSON2.parse (s);\par
        for (k in opts)\{\par
            if (matTypeof(opts[k]) == 'object')\par
                for (kk in opts[k])\par
                    salvageData[k][kk] = opts[k][kk];\par
            else\par
                salvageData[k] = opts[k];\par
        \}\par
    \}\par
\par
    // recreate the objects w/ functions\par
    for (k in salvageData.ruleSet)\par
    \{\par
        var r = salvageData.ruleSet[k];\par
        var rule = new Rule(r.type, r.faction, r.conditions);\par
        for (j in rule.conditions)\par
        \{\par
            rule.conditions[j].checkCondition = checkCondition;\par
        \}\par
        salvageData.ruleSet[k] = rule;\par
    \}\par
\}\par
\par
function readUpgradeStats ()\{\par
    var serverID = getServerId();\par
    s = GM_getValue ('UpgradeStats_'+serverID);\par
    if (s != null)\{\par
        opts = JSON2.parse (s);\par
        for (k in opts)\{\par
            if (matTypeof(opts[k]) == 'object')\par
                for (kk in opts[k])\par
                    upgradeStats[k][kk] = opts[k][kk];\par
            else\par
                upgradeStats[k] = opts[k];\par
        \}\par
    \}\par
\}\par
\par
function loadSalvageData (domainId)\{\par
\par
    s = GM_getValue ('SalvageDataMM2_'+ domainId);\par
\par
    if (s==null) \{\par
        alert("Unable to find data from domain: " + domainId);\par
        return;\par
    \}\par
\par
\par
    if (s != null)\{\par
        opts = JSON2.parse (s);\par
        for (k in opts)\{\par
            if (matTypeof(opts[k]) == 'object')\par
                for (kk in opts[k])\par
                    salvageData[k][kk] = opts[k][kk];\par
            else\par
                salvageData[k] = opts[k];\par
        \}\par
    \}\par
\par
    // recreate the objects w/ functions\par
    for (k in salvageData.ruleSet)\par
    \{\par
        var r = salvageData.ruleSet[k];\par
        var rule = new Rule(r.type, r.faction, r.conditions);\par
        for (j in rule.conditions)\par
        \{\par
            rule.conditions[j].checkCondition = checkCondition;\par
        \}\par
        salvageData.ruleSet[k] = rule;\par
    \}\par
\par
    // turn off\par
    salvageData.salvageActive = false;\par
    clearInterval(Tabs.throneSalvage.sTimer);\par
    clearInterval(Tabs.throneSalvage.delTimer);\par
    saveSalvageData();\par
    alert('Salvage settings loaded from domain ' + domainId);\par
    Tabs.throneSalvage.init(Tabs.throneSalvage.myDiv);\par
\}\par
\par
function inspect(obj, maxLevels, level, doFunctions)\{\par
    var str = '', type, msg;\par
    if(level == null)  level = 0;\par
    if(maxLevels == null) maxLevels = 1;\par
    if(maxLevels < 1)\par
        return 'Inspect Error: Levels number must be > 0';\par
    if(obj == null)\par
        return 'ERROR: Object is NULL\\n';\par
    var indent = '';\par
    for (var i=0; i<level; i++)\par
        indent += '  ';\par
    for(property in obj) \{\par
        try \{\par
            type =  matTypeof(obj[property]);\par
            if (doFunctions==true && (type == 'function'))\{\par
                str += indent + '(' + type + ') ' + property + "[FUNCTION]\\n";\par
            \} else if (type != 'function') \{\par
                str += indent + '(' + type + ') ' + property + ( (obj[property]==null)?(': null'):('')) +' = '+ obj[property] +"\\n";\par
            \}\par
            if((type=='object' || type=='array') && (obj[property] != null) && (level+1 < maxLevels))\par
                str += inspect(obj[property], maxLevels, level+1, doFunctions);  // recurse\par
        \}\par
        catch(err) \{\par
            // Is there some properties in obj we can't access? Print it red.\par
            if(typeof(err) == 'string') msg = err;\par
            else if(err.message)        msg = err.message;\par
            else if(err.description)    msg = err.description;\par
            else                        msg = 'Unknown';\par
            str += '(Error) ' + property + ': ' + msg +"\\n";\par
        \}\par
    \}\par
    str += "\\n";\par
    return str;\par
\}\par
\par
function matTypeof (v)\{\par
    if (typeof (v) == 'object')\{\par
        if (!v)\par
            return 'null';\par
//      else if (unsafeWindow.Object.prototype.toString.apply(v) === '[object\par
//      Array]')\par
        else if (v.constructor.toString().indexOf("Array")>=0 && typeof(v.splice)=='function')\par
            return 'array';\par
        else return 'object';\par
    \}\par
    return typeof (v);\par
\}\par
\par
\par
function unixTime ()\{\par
    return parseInt (new Date().getTime() / 1000) + unsafeWindow.g_timeoff;\par
\}\par
\par
/** ***************** Throne Savlager ********************* */\par
\par
Tabs.throneSalvage = \{\par
        tabOrder    : 200,\par
        tabLabel    : 'Salvage',\par
        tabDisabled : false,\par
        myDiv    : null,\par
        timer    : null,\par
        city     : null,\par
        cityNum  : 0,\par
        delItems        : [],\par
        rowNum   : 0,\par
        sTimer : null,\par
        delTimer : null,\par
        upgradeProfit: true,\par
\par
        init : function (div) \{\par
            var t = Tabs.throneSalvage;\par
            t.myDiv = div;\par
            var m = '<Div><DIV  id=trSalvage class=trStat>AUTOMATED SALVAGE</div>';\par
            m += "<div id='trInfoArea'>";\par
            m += '</div>';\par
            m += '<TABLE class="trTabDef trTable" id=trupgrader width =100% height=0% class=trTab style="padding-left: 20px;">';\par
            m += '<tr><th width=20%/><th width=30%/><th width=40%/><th/></tr>';\par
            if (salvageData.salvageActive == false) \{\par
                m += '<tr><TD><div><INPUT id=trSalvagerPower type=button value="Salvager = OFF"/></div></td>';\par
            \} else \{\par
                m += '<tr><TD><div><INPUT id=trSalvagerPower type=button value="Salvager = ON"/></div></td>';\par
            \}\par
\par
\par
            m += '<td colspan=3><b> City to put aetherstones: </b><div style="display: inline;" id=trSalvageCity /></td>';\par
\par
            m += '<tr><td><td/><tdtyle="text-align: center;"></td>'; \par
            m += '</tr></table>';\par
\par
            m += '<table class="trTabPad trTable"><hr/>';\par
            m += '<tr><td width=35%><div> Keep all: <select id="trSalvageQuality">';\par
            m += '<option value="1">Common</option>';\par
            m += '<option value="2">Uncommon</option>';\par
            m += '<option value="3">Rare</option>';\par
            m += '<option value="4">Epic</option>';\par
            m += '<option value="5">Wondrous</option>';\par
            m += '</select> and higher</div></td>';\par
\par
            m += '<td colspan=2 width=24%>Keep the first <INPUT id=trSaveNum type=text size=3 maxlength=3 value="' + salvageData.throneSaveNum+ '"/> items</td>';\par
            m += "</tr></table><hr/>";\par
\par
            m += "<div id='trRulesCreate' class='trRuleCreate'>";\par
\par
            // rules definition\par
            m += '<TABLE class="trTabDef trTable" width=100% class=trTabPad style="padding-left: 10px;">';\par
            m += '<tr><td>  <b>Define the TR items to keep: </b> </td>';\par
\par
            m += '<td alight="left"><div><span>Faction: <select id="trFactionType">';\par
            m += '  <option value="any">Any</option>';\par
            m += '  <option value="fey">Fey</option>';\par
            m += '  <option value="briton">Briton</option>';\par
            m += '  <option value="druid">Druid</option>';\par
            m += '</select></span></div></td>';\par
            m += '<td alight="left"><div><span>Card type: <select id="trCardType">';\par
            m += '  <option value="any">Any</option>';\par
            m += '  <option value="chair">Chair</option>';\par
            m += '  <option value="table">Table</option>';\par
            m += '  <option value="window">Window</option>';\par
            m += '  <option value="banner">Banner</option>';\par
            m += '  <option value="advisor">Advisor</option>';\par
            m += '  <option value="trophy">Trophy</option>';\par
            m += '  <option value="candelabrum">Candelabrum</option>';\par
            m += '</select></span></div></td>';\par
            m += '<td align="right"><INPUT id=trAddRule type=button value="Create Rule"/></td>';\par
            m += '</tr></table>';\par
            m += '<TABLE  class="trTabPad trTable" width=100% id="trConditionTable"  style="padding-left: 5px;">';\par
            m += '<tr><td align=left colspan=1><INPUT id=trAddRow type=button value="Add Row"/></td>';\par
            m += '<td></td><td></td><td></td><td></td><td></td></tr>';\par
            m += '</table>';\par
            m += '</div><hr/>';\par
            m += '<div id="trSalvStatus" style="text-align: center;" >Loading ... </div>';\par
            m += '<div id="trNumSalv" style="text-align: center;">Number of items salvaged: '+ addCommas(salvageData.numSalvagedItems) + ' </div>';\par
            m += '<hr/>';\par
            m += '<div class=trRulePane>';\par
            m += '<div align=center> <b> Salvager will keep items matching any of these rules </b></div>';\par
            m += '<div id=trRuleScroll style="position: static; width: 710px; height: 300px; overflow-x: hidden; overflow-y: auto;" >';\par
            m += "<div id='trRuleDisplay' >";\par
            m += '</div></div></div>';\par
            t.myDiv.innerHTML = m;\par
            new CdispCityPicker ('trcitysel', document.getElementById('trSalvageCity'), true, t.e_CityButton, upgradeData.sCityNum);\par
            t.createRow();\par
            t.buildRuleDisplay();\par
            \par
                        \par
\par
            document.getElementById('trSaveNum').addEventListener('change', function()\{\par
                salvageData.throneSaveNum = parseInt(document.getElementById('trSaveNum').value);\par
                if (upgradeData.throneSaveNum < 0) salvageData.throneSaveNum = 0;\par
                saveSalvageData();\par
            \}, false);\par
            document.getElementById ('trSalvageQuality').addEventListener ('click', function() \{t.setSalvageLevel(this.value);\}, false);\par
            document.getElementById ('trSalvageQuality').value = salvageData.minQuality;\par
\par
            document.getElementById ('trAddRow').addEventListener ('click', function() \{t.createRow();\}, false);\par
            document.getElementById ('trAddRule').addEventListener ('click', function() \{t.createRule();\}, false);\par
            \par
            $("#trRuleScroll").resizable(\{\par
                minWidth: 720,\par
                maxWidth: 1000,\par
                minHeight: 180,\par
                maxHeight: 700,\par
                stop: function(event, ui) \{\par
                    upgradeData.salvageH =  ui.size.height + 'px';\par
                    upgradeData.salvageW =  ui.size.width  + 'px';\par
                    saveUpgradeData();\par
                \}\par
            \});\par
            \par
            $("#trRuleScroll").css('height', upgradeData.salvageH).css('width', upgradeData.salvageW);\par
          \par
            if (salvageData.upgradedToDelete.length > 0)\par
            \{\par
               // some items were left over that need to be deleted \par
               logit("Found " + salvageData.upgradedToDelete.length + " upgraded items that need to be deleted.");\par
               \par
               for (k=0; k< salvageData.upgradedToDelete.length; k++)\par
               \{\par
                   var id = salvageData.upgradedToDelete[k];\par
                   // if the item is not longer in the inventory, remove the id\par
                   if (!unsafeWindow.kocThroneItems[id] ) \{\par
                     logit("Removing item " + id +" from salvage list.");\par
                     salvageData.upgradedToDelete.splice(k,1); // Remove item from array\par
                     saveSalvageData();\par
                     k--;\par
                   \}\par
               \}\par
               \par
               // resume deleting things\par
               if (salvageData.salvageActive)\par
               \{\par
                 t.delItems = salvageData.upgradedToDelete;\par
                 t.upgradeAndDelete();\par
               \}\par
               else\par
               \{\par
                   // if the salvager is powered off, clear the list\par
                   salvageData.upgradedToDelete = [];\par
                   saveSalvageData();\par
               \}\par
            \}\par
            \par
            // this check makes sure upgrading before deleting is still profitable\par
            \par
            t.upgradeProfit = (5*CM.WorldSettings.getSettingAsNumber("AETHERSTONE_SALVAGE_MULTIPLIER", 500) > CM.thronestats.upgrade[1]["Stones"]); \par
            \par
            t.start();\par
        \},\par
\par
        createRow : function()\par
        \{\par
            var t = Tabs.throneSalvage;\par
            var table = document.getElementById('trConditionTable');\par
            var rowCount = table.rows.length;\par
            var row = table.insertRow(rowCount-1);\par
            var rowId = "r" + t.rowNum;\par
            t.rowNum++;\par
            row.id = rowId;\par
\par
            var h  = "<td> <select id='" + rowId + "sel1'> <option value='true'> </option> <option value='false'>NOT</option></select></td>";\par
            h += "<td> <select id='" + rowId + "sel2'>";\par
            h += "  <option value='1'>1x</option>";\par
            h += "  <option value='2'>2x</option>";\par
            h += "  <option value='3'>3x</option>";\par
            h += "  <option value='4'>4x</option>";\par
            h += "  <option value='5'>5x</option>";\par
            h += "</select></td>";\par
            h += "<td> <select id='" + rowId + "sel3'>";\par
            h += "</select></td>";\par
            h += "<td> <select id='" + rowId + "sel4'>";\par
            h += "  <option value='e'>Either</option>";\par
            h += "  <option value='b'>Buff</option>";\par
            h += "  <option value='d'>Debuff</option>";\par
            h += "</select></td>";\par
\par
            h += "<td> Slots: ";\par
            h += "  <input type=checkbox value='1' checked=true id='" + rowId + "slot1'/>1";\par
            h += "  <input type=checkbox value='2' checked=true id='" + rowId + "slot2'/>2";\par
            h += "  <input type=checkbox value='3' checked=true id='" + rowId + "slot3'/>3";\par
            h += "  <input type=checkbox value='4' checked=true id='" + rowId + "slot4'/>4";\par
            h += "  <input type=checkbox value='5' checked=true id='" + rowId + "slot5'/>5";\par
            h += "</td>";\par
\par
            row.innerHTML = h;\par
\par
            var effects = [];\par
\par
            for (e in CM.thronestats.effects)\par
            \{\par
                var effectName = CM.thronestats.effects[e][1].split(" Debuff")[0];\par
                if (effects.indexOf(effectName) < 0) effects.push(effectName);\par
            \}\par
\par
            var select = document.getElementById(rowId + "sel3");\par
            for(index in effects) \{\par
                select.options.add(new Option(effects[index], effects[index]));\par
            \}\par
\par
            var c = row.insertCell(5);\par
            var btn = $("<input type=button value='X'/>");\par
            $(btn).click( function () \{ t.removeRow(row);\});\par
            $(c).append( btn );\par
\par
            t.setFullness();\par
        \},\par
\par
        setSalvageLevel : function(level)\par
        \{\par
            salvageData.minQuality = level;\par
            saveSalvageData();\par
        \},\par
\par
        pickCity : function () \{\par
            var t = Tabs.throneSalvage;\par
            var cid = upgradeData.sCityNum;\par
            if ( Seed.resources["city" + Seed.cities[cid][0]]["rec5"][0] <= salvageData.maxStones) return cid;\par
\par
            var ind = -1;\par
            var lowest = 9999999;\par
\par
            if (salvageData.anyCity)\par
            \{\par
                for (i= 0; i < Seed.cities.length; i++)\par
                \{\par
                    if (salvageData.overflow == "lowest")\par
                    \{\par
                        // put in the city w/ the lowest number of a-stone\par
                        if (Seed.resources["city" + Seed.cities[i][0]]["rec5"][0] < lowest )\par
                        \{\par
                            ind = i;\par
                            lowest = Seed.resources["city" + Seed.cities[ind][0]]["rec5"][0];\par
                        \}\par
                    \}\par
                    else \par
                    \{\par
                        // put in the first city with low stones\par
                        if ( Seed.resources["city" + Seed.cities[i][0]]["rec5"][0] <= salvageData.maxStones) \{\par
                            return i;\par
                        \}\par
                    \}\par
                \}\par
            \}\par
            return ind;\par
        \},\par
\par
        createRule : function()\par
        \{\par
            var t = Tabs.throneSalvage;\par
            t.readRows();\par
            t.buildRuleDisplay();\par
        \},\par
\par
        buildRuleDisplay : function ()\par
        \{\par
            var t = Tabs.throneSalvage;\par
            var rd = document.getElementById('trRuleDisplay');\par
\par
            var m = '<TABLE  width=100% class="trTabPad trTable">';\par
\par
            for (i =0; i < salvageData.ruleSet.length; i++)\par
            \{\par
                var rule = salvageData.ruleSet[i];\par
\par
                m += '<tr>';\par
                m += "<td width=90%><div class='trRule'>";\par
\par
                m += " Type: " + rule.type;\par
                m += " Faction: " + rule.faction;\par
\par
                for (ii = 0; ii < rule.conditions.length; ii++)\par
                \{\par
                    var condition = rule.conditions[ii];\par
\par
                    if (ii ==0 )\par
                        m += "<br> Item";\par
                    else\par
                        m += "<br> <u>and</u>";\par
\par
                    if (condition.mustHave != "false")\par
                        m += " must have ";\par
                    else\par
                        m += " must NOT have ";\par
\par
                    m += condition.number + "x ";\par
                    m += condition.effect + " ";\par
\par
                    if (condition.buffType == "b")\par
                        m += "buff ";\par
                    else if (condition.buffType == "d")\par
                        m += "debuff ";\par
                    else\par
                        m += "buff or debuff ";\par
\par
                    m += " in slot(s): ";\par
\par
                    for (j = 0; j < condition.slots.length; j++)\par
                    \{\par
                        if (condition.slots[j] ) m += (j+1) + " ";\par
                    \}\par
\par
                \}\par
                m += "</div></td>";\par
                m += "<td width=20%><INPUT id=trDelRule" + i + " type=button value='Delete Rule' /></td>";\par
                m += '</tr>';\par
            \}\par
\par
            rd.innerHTML = m;\par
\par
            for (var j=0; j < salvageData.ruleSet.length; j++)\par
            \{\par
                document.getElementById('trDelRule' +j).v1 = j;\par
                document.getElementById('trDelRule' +j).addEventListener ('click', function() \{ t.deleteRule(this.v1);\}, false);\par
            \}\par
\par
            document.getElementById('trSalvagerPower').addEventListener('click', function()\{t.togglePower(this);\} , false);\par
\par
        \},\par
\par
        updateTRTab : function() \{\par
            $("#trexecsalvage").html("Salvage " + (salvageData.salvageActive ? "ON" : "OFF"));\par
        \},\par
\par
\par
        togglePower: function(obj)\{\par
            var t = Tabs.throneSalvage;\par
            if (salvageData.salvageActive == true) \{\par
                var btn = document.getElementById('trSalvagerPower');\par
                salvageData.salvageActive = false;\par
                btn.value = "Salvager = OFF";\par
                clearInterval(t.sTimer);\par
                clearInterval(t.delTimer);\par
                t.delItems = [];\par
                salvageData.upgradedToDelete = [];\par
            \} else \{\par
                salvageData.salvageActive = true;\par
                var btn = document.getElementById('trSalvagerPower');\par
                btn.value = "Salvager = ON";\par
                t.doSalvage();\par
                t.start();\par
            \}\par
            saveSalvageData();\par
            t.updateTRTab();\par
        \},\par
\par
        // delete a rule from the ruleset\par
        deleteRule : function(i)\par
        \{\par
            var t = Tabs.throneSalvage;\par
            salvageData.ruleSet.splice(i,1);\par
            saveSalvageData();\par
            t.buildRuleDisplay();\par
        \},\par
\par
        readRows : function()\par
        \{\par
            var t = Tabs.throneSalvage;\par
            var table = document.getElementById('trConditionTable');\par
            var rowCount = table.rows.length;\par
\par
            var cType = document.getElementById('trCardType').value;\par
            var faction = document.getElementById('trFactionType').value;\par
\par
            var conditions = [];\par
            for (i=0; i < table.rows.length; i++)\par
            \{\par
                var row = table.rows[i];\par
                if (row.id)\par
                \{\par
                    var s1 = document.getElementById(row.id + "sel1");\par
                    var s2 = document.getElementById(row.id + "sel2");\par
                    var s3 = document.getElementById(row.id + "sel3");\par
                    var s4 = document.getElementById(row.id + "sel4");\par
\par
                    var slots = [];\par
                    for (j =1; j <= 5; j++)\par
                    \{\par
                        var ch = document.getElementById(row.id + "slot" + j);\par
                        slots.push(ch.checked);\par
                    \}\par
\par
                    var c = new Condition(s1.value, s2.value, s3.value, s4.value, slots );\par
                    conditions.push(c);\par
                \}\par
            \}\par
            var rule1 = new Rule(cType, faction, conditions);\par
            t.addRule(rule1);\par
        \},\par
\par
        removeRow : function(row)\par
        \{\par
            var table = document.getElementById('trConditionTable');\par
\par
            for (i=0; i < table.rows.length  ; i++ )\par
            \{\par
                if (table.rows[i] == row)\par
                \{\par
                    table.deleteRow(i);\par
                    break;\par
                \}\par
            \}\par
        \},\par
\par
        // add a new rule\par
        addRule : function(rule)\par
        \{\par
            salvageData.ruleSet.push(rule);\par
            saveSalvageData();\par
        \},\par
\par
        // callback for when salvage city is changed\par
        e_CityButton : function (city, x, y)\{\par
            var t = Tabs.throneSalvage;\par
            upgradeData.sCityNum = city.idx;\par
            saveUpgradeData();\par
        \},\par
\par
        start : function()\{\par
            var t = Tabs.throneSalvage;\par
            if(salvageData.salvageActive) \{\par
                t.sTimer = setInterval(t.doSalvage, 1*60*1000);\par
            \}\par
        \},\par
\par
        // do the actual discard of TR items\par
        doSalvage : function() \{\par
            var t = Tabs.throneSalvage;\par
\par
            t.setFullness();\par
\par
            if(!salvageData.salvageActive) \{\par
                return;\par
            \}\par
\par
            if (t.deleting == true) return;\par
            t.deleting = true;\par
            t.setStatus('Salvaging items');        \par
\par
            t.delItems = t.buildList(false);\par
\par
            if (t.delItems.length > 0) \{\par
                // upgrade items from +0 to +1 first\par
                t.upgradeAndDelete();\par
            \} else \{\par
                t.deleting = false;\par
                t.setStatus('No items to salvage.  Waiting for next cycle.');\par
            \}\par
            t.setFullness();\par
        \},\par
\par
        setFullness : function () \{\par
            // change the color on the throne button when full\par
\par
            var num_items = unsafeWindow.Object.keys(unsafeWindow.kocThroneItems).length;  \par
            if (num_items > 90)\par
                $("a.buttonv2.throne").css('color', 'red');\par
            else \par
                $("a.buttonv2.throne").css('color', 'black');\par
        \},\par
\par
        // Create the list of items to delete.\par
        // If 'test' is set to true, then broken/equipted items are included.\par
        buildList : function(test)\{\par
            var t = Tabs.throneSalvage;\par
\par
            var throneSaveNum = salvageData.throneSaveNum;\par
            var countItem = 0;\par
            var retList = [];\par
\par
            for (k in unsafeWindow.kocThroneItems) \{\par
                var throne_item = unsafeWindow.kocThroneItems[k];\par
                countItem++;\par
\par
                // ignore these things\par
                if (throne_item.level !=0) continue;\par
\par
                // in test mode, include these items\par
                // These items are at risk if they are repaired or unequiped.\par
                if (test != true)\par
                \{\par
                    if (throne_item.isEquipped) continue;\par
                    if (throne_item.isBroken) continue;\par
                \}\par
\par
                // keep the first X items\par
                if ( countItem <= throneSaveNum) continue;\par
\par
                // keep things w/ at least minQuality\par
                if (throne_item.quality >= salvageData.minQuality) continue;\par
\par
                // check the rules\par
                if (t.applyRules(throne_item.id)) continue;\par
\par
                // passes all tests\par
                retList.push(throne_item.id);\par
            \}\par
            return retList;\par
        \},\par
\par
        // put out a status message on the trSavlStatus div\par
        setStatus : function(msg)\par
        \{\par
            document.getElementById('trSalvStatus').innerHTML = msg;\par
        \},\par
\par
        // returns true if the item should be saved and not salvaged\par
        applyRules : function(id) \{\par
            var t = Tabs.throneSalvage;\par
            for (r in salvageData.ruleSet)\par
            \{\par
                var rule = salvageData.ruleSet[r];\par
                if ( rule.applyRule(id)) return true;\par
            \}\par
            return false;\par
        \},\par
        \par
        // update items to +1 before deleting\par
        upgradeAndDelete : function () \{\par
            //logit("upgradeAndDelete");\par
            if(!salvageData.salvageActive) \{\par
                return;\par
            \}\par
            \par
            var t = Tabs.throneSalvage;\par
            var id = t.delItems[0];\par
\par
            // since simple +0 can be upgrade w/ near 100% success for 1500 a-stone and then salvaged for 2150\par
            // upgrade all these items 1 level\par
            if (salvageData.upgradeFirst && t.upgradeProfit) \par
            \{\par
\par
                var item = unsafeWindow.kocThroneItems[id];\par
                if (item) \{\par
                    if ( item.quality <= salvageData.upgradeFirstQual && item.level==0 \par
                            && ( salvageData.upgradedToDelete.indexOf(id) < 0 ) )\par
                    \{\par
                        salvageData.upgradedToDelete.push(id);\par
                        saveSalvageData();\par
                        Tabs.upgrader.doUpgrade(id,true);\par
                    \}\par
                \}\par
                else\par
                \{\par
                    logit("item not found.");    \par
                \}\par
            \}\par
            // delete the item\par
            t.delTimer = setTimeout( function () \{t.doDelete(id)\}, 2000);\par
        \},\par
\par
        doDelete : function(id) \{\par
\par
            if(!salvageData.salvageActive) \{\par
                return;\par
            \}\par
            var t = Tabs.throneSalvage;\par
            //var id = t.delItems[0];\par
            //logit("deleting item: " + id);\par
            \par
            var item = unsafeWindow.kocThroneItems[id];\par
            if (item) t.setStatus('Salvaging ' + item.name);\par
            \par
            var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);\par
            var num_city = t.pickCity();\par
            if ( num_city < 0)\par
            \{\par
                t.setStatus("All cities are (nearly) full of aetherstone");\par
                num_city = upgradeData.sCityNum;\par
            \}\par
            \par
            params.ctrl = 'throneRoom\\\\ThroneRoomServiceAjax';\par
            params.action = 'salvage';\par
            params.itemId = id;\par
            params.cityId = Seed.cities[num_city][0];\par
\par
            new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/_dispatch53.php" + unsafeWindow.g_ajaxsuffix, \{\par
                method: "post",\par
                parameters: params,\par
                loading: true,\par
                onSuccess: function (transport) \{\par
                    var rslt = eval("(" + transport.responseText + ")");\par
                    var throne_item = unsafeWindow.kocThroneItems[id];\par
                    if(rslt.ok) \{\par
                        if (throne_item) trSalvageLog('Deleted Throne room item '+ throne_item.name);\par
                        salvageData.numSalvagedItems++;\par
                        saveSalvageData();\par
\par
                        $("#trNumSalv").html('<div style="text-align: center;">Number of items salvaged: '+ addCommas(salvageData.numSalvagedItems) + ' </div>');\par
\par
                        // temporarily set the city id\par
                        var tmp = unsafeWindow.currentcityid;\par
                        unsafeWindow.currentcityid = Seed.cities[num_city][0];\par
                        if (throne_item) \{\par
                            salvageData.numSalvaged[throne_item.quality]++;\par
                            saveSalvageData();\par
                            throne_item.salvage();\par
                        \}\par
                        unsafeWindow.currentcityid = tmp;\par
                        \par
                        var sidx = salvageData.upgradedToDelete.indexOf(id);\par
                        if (sidx >=0)\par
                        \{\par
                            salvageData.upgradedToDelete.splice(sidx,1); // Remove item from array\par
                            saveSalvageData();\par
                        \}\par
                    \}\par
                    else\par
                    \{\par
                        logit("salvage failed");\par
                        logit("rslt: " + inspect(rslt,3,1));\par
                        if (throne_item) Tabs.throneSalvage.setStatus('Unable to salvage item ' + throne_item.name);\par
                        unsafeWindow.cm.ThroneView.renderInventory(unsafeWindow.kocThroneItems);\par
                    \}\par
\par
                    var idx = t.delItems.indexOf(id);\par
                    if (idx >=0)\par
                    \{\par
                        t.delItems.splice(idx,1); \par
                        // Remove item from array regardless\par
                        // of success. Catch on next refresh\par
                    \}\par
                    if (t.delItems.length > 0) \{ // Check if the array is empty\par
                        t.upgradeAndDelete();\par
                    \} else \{\par
                        t.deleting = false;\par
                        t.setStatus('Salvaging complete.  Waiting for next cycle.');\par
                        return;\par
                    \}\par
                \},\par
                onFailure: function () \{\par
                    t.delIems = [];\par
                    t.deleting = false;\par
                    if (unsafeWindow.kocThroneItems[id] )\par
                        logit("salvage failed for item " + unsafeWindow.kocThroneItems[id].name );\par
                    unsafeWindow.cm.ThroneView.renderInventory(unsafeWindow.kocThroneItems);\par
                    return;\par
                \}\par
            \});\par
\par
        \},\par
\par
        show: function()\{\par
        \},\par
\par
        hide: function()\{\par
        \}\par
\}\par
\par
//class definition for upgrade queue items\par
function QueueItem()\par
\{\par
    this.item   = 0;\par
    this.action = "upgrade";\par
    this.level  = 1;\par
    this.status = "not started";\par
    this.triesTotal = 0;\par
    this.triesThis = 0;\par
    this.triesLast = 0;\par
    this.lastUpgrade = "none";\par
    this.upgrades = [];\par
\}\par
\par
\par
//class definition for rules and conditions\par
function Rule(type, faction, conditions)\par
\{\par
    this.type = type;\par
    this.faction = faction;\par
    if (conditions)\par
        this.conditions = conditions;\par
    else\par
        this.conditions = [];\par
\par
    this.addCondition = addCondition;\par
    this.applyRule    = applyRule;\par
\}\par
\par
function cloneRule( rule)\par
\{\par
    this.type = rule.type;\par
    this.faction = rule.faction;\par
    this.conditions = [];\par
    if (rule.conditions) this.conditions = rule.conditions;\par
\par
    this.addCondition = addCondition;\par
    this.applyRule    = applyRule;\par
\}\par
\par
function addCondition(c)\par
\{\par
    this.conditions.push(c);\par
\}\par
\par
function applyRule(id)\par
\{\par
    var throne_item = unsafeWindow.kocThroneItems[id];\par
\par
    if (this.type != "any" && (this.type != throne_item.type)) return false;\par
    if (this.faction != "any" && (this.faction != throne_item.faction)) return false;\par
    for (r in this.conditions)\par
    \{\par
        if (!this.conditions[r].checkCondition(id)) return false;\par
    \}\par
    return true;\par
\}\par
\par
function Condition(mustHave, number, effect, buffType, slots )\par
\{\par
    this.mustHave = mustHave;\par
    this.number   = number;\par
    this.effect   = effect;\par
    this.buffType = buffType;\par
    this.slots    = slots;\par
\par
    this.checkCondition = checkCondition;\par
\}\par
\par
function checkCondition(id)\par
\{\par
    var numberFound  = 0;\par
    var effectsFound = false;\par
    // get card\par
    var throne_item = unsafeWindow.kocThroneItems[id];\par
\par
    if (!throne_item) return false;\par
\par
    // for loop for stat\par
    // count up occurances\par
    for (i in throne_item.effects)\par
    \{\par
        var card_effect = CM.thronestats.effects[throne_item.effects[i].id][1];\par
        var slotid = i.split("slot")[1];\par
\par
        if (!this.slots[slotid-1])\par
        \{\par
            continue;\par
        \}\par
\par
        if ( (this.buffType == "e" || this.buffType == "b") && card_effect == this.effect)\par
        \{\par
            numberFound++;\par
        \}\par
\par
        if ( (this.buffType == "e" || this.buffType == "d") && card_effect == (this.effect + " Debuff"))\par
        \{\par
            numberFound++;\par
        \}\par
    \}\par
\par
    if ( numberFound >= this.number)\par
    \{\par
        effectsFound = true;\par
    \}\par
\par
    if (this.mustHave != "false")\par
        return effectsFound;\par
    else\par
        return (!effectsFound);\par
\}\par
\par
\par
\par
/** **************** Throne organizer ********************* */\par
\par
Tabs.organizer = \{\par
        tabOrder: 300,\par
        tabLabel: 'Organize',\par
        tabDisabled : false,\par
        myDiv : null,\par
        itemLists : [],\par
        itemTypes : \{ chair: 0, table: 1, window: 2, banner: 3, advisor: 4, trophy: 5, candelabrum: 6\},\par
        selectedItems : [],\par
        panelId: -1,\par
        panelType: "upgrade",\par
        panelNextLevel : 2,\par
        sortEffect: "none",\par
        sortType: "both",\par
        //sortInactive: true,\par
        switchingPresets : false,\par
\par
        init : function (div)\{\par
            var t = Tabs.organizer;\par
            // setup the lists for tables, chairs, etc.\par
            t.fillLists();\par
            t.myDiv = div;\par
\par
            // setup the tab\par
            //var m = '<Div style="width: 710px"><DIV id=trOrganizer class=trStat>ORGANIZER</div>';\par
            var m = '<Div><DIV id=trOrganizer class=trStat>ORGANIZER</div>';\par
\par
\par
            var effects = [];\par
            for (e in CM.thronestats.effects)\par
            \{\par
                var effectName = CM.thronestats.effects[e][1].split(" Debuff")[0];\par
                if (effects.indexOf(effectName) < 0) effects.push(effectName);\par
            \}\par
\par
            // header stuff\par
\par
            // preset selector\par
            m += '<TABLE  width=710px class="trTabPad2 trTable"><tr width=100% align=center><td width=15%/><td width=30%><div><span>View preset: <select id="PresetList">';\par
            m += '<option value="0">--Presets--</option>';\par
\par
            for (k= 1; k <= Seed.throne.slotNum; k++)\par
            \{\par
                m += '<option value="'+k+'"> Preset:  '+ k +'</option>';\par
            \}\par
            for (k= 0; k < presetData.num_presets; k++)\par
            \{\par
                if (presetData.ids[k])\par
                   m += '<option value="local'+k+'"> Local:  '+ presetData.ids[k] +'</option>';\par
                else\par
                    m += '<option value="local'+k+'"> Local:  '+ String.fromCharCode(65 + k) +'</option>';\par
            \}\par
\par
            m += '</select></span></div></td>';\par
            m += '<TD width=20%><INPUT id=testSalvage type=button value=" Test Salvage "/></td><td id=trDelResults></td>';\par
            m += '</tr>';\par
\par
\par
            m+= '<tr  width=100% ><td colspan=1><span style="width: 130px; float: left; margin-top: 4px;  margin-right: 4px; margin-left: 5px;"> Switch to preset: </span>';\par
            m+= '</td><td colspan=3>';\par
            for (a=1; a <= Seed.throne.slotNum; a++)\par
            \{\par
                m += '<a style="font-family: serif; width: 25px;" class="button20 loadGPreset"  id=trPresetNum'+ a + ' > <span> ' + a + ' </span></a>';                   \par
            \}\par
            m += '<span style="float: right; margin-top: 4px;  margin-right: 4px; margin-left: 5px;">';\par
            if (presetData.num_presets > 0) m +=  "Note: Final preset is overwritten when using local presets.";\par
            m +=  "</span>" ;\par
            m += '</td></tr>';\par
\par
            if (presetData.num_presets > 0) \{\par
                m+= '<tr  width=100% ><td colspan=1><span style="width: 130px; float: left; margin-top: 4px;  margin-right: 4px; margin-left: 5px;"> Switch to local preset: </span>';\par
                m+= '</td><td colspan=3>';\par
                for (a=0; a< presetData.num_presets; a++)\par
                \{\par
                    if (!presetData.ids[a]) presetData.ids[a] = String.fromCharCode(65 +a);\par
                    if (!presetData.desc[a]) presetData.desc[a] = 'Preset ' + String.fromCharCode(65 +a);\par
\par
                    m += '<a style="font-family: serif;" class="button20 loadPreset"  id=trLoad'+ a + ' > <span> '+ presetData.ids[a] + ' </span>';\par
                    m += '<div class="tt"> <b>' + presetData.ids[a] +':</b> ' + presetData.desc[a]   + '</div></a>';\par
                \}\par
                m += '</td></tr>';\par
\par
                m+= '<tr><td colspan=1><span style="width: 130px; float: left; margin-top: 4px;  margin-right: 4px; margin-left: 5px;"> Save local preset: </span>';\par
                m+= '</td><td colspan=3>';\par
                for (a=0; a< presetData.num_presets; a++)\par
                \{\par
                    m += '<a style="font-family: serif;" class="buttonDown20 savePreset" id=trSave'+ a + ' > <span>' + presetData.ids[a] + ' </span></a>';                 \par
                \}\par
\par
                m += '</td></tr>';\par
            \}\par
            \par
            m += '<tr align=center><td colspan=4><div id=trSwitchStatus></div></td></tr>';\par
\par
            m += '<tr align=center><td colspan=2><div><span>Sort: <select id="trSortList">';\par
\par
            m += '<option value="none">--Effect--</option>';\par
            for (k in effects)\par
            \{\par
                m += '<option value="' + effects[k] + '">'+ effects[k] +'</option>';\par
            \}\par
            m += '</select></span></div></td>';\par
\par
            m += "<td> <select id='trSortType'>";\par
            m += "  <option value='both'>Either</option>";\par
            m += "  <option value='buff'>Buff</option>";\par
            m += "  <option value='debuff'>Debuff</option>";\par
            m += "</select></td>";\par
\par
            m += '<td><INPUT id=trSortInactive type=checkbox '+ (  upgradeData.sortInactive ?' CHECKED':'') +'/> Include Inactive</td>';\par
            m +='</tr></table>';\par
\par
            m += "<div id='trScrollDiv' style='position: static; width: " + upgradeData.organizeW + "; height: " + upgradeData.organizeH + "; overflow-x: auto; overflow-y: auto;'>";\par
            \par
            var ii = Math.max(t.itemLists['chair'].length, t.itemLists['table'].length, t.itemLists['window'].length, t.itemLists['banner'].length, t.itemLists['advisor'].length, t.itemLists['trophy'].length, t.itemLists['candelabrum'].length );\par
\par
            m += "<div id='trTableDiv' style='width: 100%;'>";\par
            m += '<TABLE id=trDisplayTable width=100% height=0% class=trTab>';\par
            m += "<tr align=center valign=top><th width=14%>Chairs</th><th width=14%>Tables</th><th width=14%>Windows</th><th width=14%>Banners</th><th width=14%>Advisors</th><th width=14%>Throphies</th><th width=14%>Candelabra</th></tr>";\par
            m += '</table></div>';\par
            m += '</div>';\par
            m += '</div>';\par
\par
            t.myDiv.innerHTML = m;\par
            t.paintTable();\par
            \par
            $("#trScrollDiv").resizable(\{\par
                minWidth: 710,\par
                maxWidth: 900,\par
                minHeight: 180,\par
                /*maxHeight: 560,*/\par
                maxHeight: 1000,\par
                stop: function(event, ui) \{\par
                    upgradeData.organizeH = ui.size.height + 'px';\par
                    upgradeData.organizeW = ui.size.width  + 'px';\par
                    saveUpgradeData();\par
                \}\par
            \});\par
            \par
            $("#PresetList").click( function() \{t.selectPreset( $(this).val());\});\par
            $("#testSalvage").click(function() \{t.testSalvage();\});\par
\par
            // default to highlight the active preset\par
            t.selectPreset(Seed.throne.activeSlot);\par
            document.getElementById ('PresetList').value = Seed.throne.activeSlot;\par
\par
            $("#trSortList").change( function () \{ \par
                t.sortEffect = $(this).val();\par
                t.show();\par
            \});\par
\par
            $("#trSortType").change( function() \{\par
                t.sortType = $(this).val();\par
                t.show();\par
            \});\par
\par
            $("#trSortInactive").change( function() \{\par
                t.show();\par
            \});\par
\par
            $(".loadGPreset").click( function () \{\par
                var id= $(this).attr('id');\par
                processPresetClick(+id.split("trPresetNum")[1]);\par
            \});\par
\par
            $(".loadPreset").click( function () \{\par
                var id= $(this).attr('id');\par
                Tabs.organizer.loadLocalPreset(+id.split("trLoad")[1]);\par
            \});\par
\par
            $(".savePreset").click( function () \{\par
                var id= $(this).attr('id');\par
                Tabs.organizer.saveLocalPreset(+id.split("trSave")[1]);\par
            \});\par
            \par
            $("#trSortList").val(upgradeData.sortSelected);\par
            $("#trSortType").val(upgradeData.buffSelected);\par
            t.sortEffect = upgradeData.sortSelected;\par
            t.sortType = upgradeData.buffSelected;\par
            \par
            t.show();\par
\par
        \},\par
\par
        setSwitchStatus : function(s) \{\par
            $("#trSwitchStatus").html(s); \par
        \},\par
\par
        loadLocalPreset : function (id) \{\par
            var t = Tabs.organizer;\par
            //logit("load: " + id );\par
\par
            if (t.switchingPresets)\par
            \{\par
                t.setSwitchStatus("Local preset switch still in prgres ....");\par
                return;\par
            \}\par
\par
            var items = presetData.items[id];            \par
            if (!items || items.length==0)\par
            \{\par
                t.setSwitchStatus("Local preset is empty");\par
                return;\par
            \}\par
\par
            // grab the list of items equipped in the last slot\par
            var ei = Seed.throne.slotEquip[Seed.throne.slotNum];\par
            var c = 0;\par
            t.switchingPresets = true;\par
\par
            // see if we are already on the last slot\par
            if (Seed.throne.slotNum != Seed.throne.activeSlot) \{\par
                // switch to the last preset\par
                t.setSwitchStatus("Switching to last active slot ...");\par
                processPresetClick(Seed.throne.slotNum);\par
                c++;\par
            \} else \{\par
                t.setSwitchStatus("Already in last slot.");\par
            \}\par
\par
            var delay = 7;\par
            for (i in items)\par
            \{\par
                if (!items[i]) continue;\par
\par
                // only equip the items not already equipped\par
                if (ei.indexOf(items[i]) < 0)\par
                \{\par
                    var I = unsafeWindow.kocThroneItems[+items[i]];\par
\par
                    if (!I) \{\par
                        t.setSwitchStatus("Throne room item " + items[i] + " not found");\par
                        continue;\par
                    \}\par
\par
                    var f = function (I2) \{\par
                        return function () \{\par
                            Tabs.organizer.equipItem(I2, Seed.throne.slotNum);\par
                            Tabs.organizer.setSwitchStatus("Equipping " + I2.name); \par
                        \};\par
                    \}\par
                    setTimeout (f(I), c*delay*1000); // have to wait at least 5 seconds between switches\par
                    c++;\par
                \}\par
                else\par
                \{\par
                    var I = unsafeWindow.kocThroneItems[+items[i]];\par
                    //t.setSwitchStatus("Item " + I.name + " is already equipped");\par
                \}\par
            \}\par
\par
            setTimeout ( function () \{ \par
                Tabs.organizer.show(); \par
                t.switchingPresets = false;\par
                t.setSwitchStatus("Local preset "+ presetData.ids[id] + " loaded.")\par
            \}, c* delay*1000 + 1000);\par
        \},\par
\par
        saveLocalPreset : function (id) \{            \par
            var equipedItems = \{\};\par
            var ei = Seed.throne.slotEquip[Seed.throne.activeSlot];\par
\par
            // convert array to an object\par
            for (j=0; j < ei.length; j++) \{\par
                equipedItems[j] = ei[j];\par
            \}\par
\par
            presetData.items[id] = equipedItems;\par
            savePresetData();\par
            Tabs.organizer.setSwitchStatus("Local preset " + presetData.ids[id] + " saved.");\par
        \},\par
\par
        equipItem :  function ( I, preset) \{\par
            if (!I) return;\par
            unsafeWindow.AjaxCall.gPostRequest("ajax/_dispatch53.php", \{\par
                ctrl: "throneRoom\\\\ThroneRoomServiceAjax",\par
                action: "equipItem",\par
                itemId: I.id,\par
                presetId: preset\par
            \}, function (u) \{\par
                //logit("result: "+ inspect(u,3,1));\par
                if (u.ok === true) \{\par
                    unsafeWindow.cm.ThroneView.clickItemEquip(I);\par
                    Tabs.organizer.show();\par
                \} else \{\par
                    if (I && I.name) \{\par
                        Tabs.organizer.setSwitchStatus("Unable to equip item " + I.name);\par
                    \} else \{\par
                        Tabs.organizer.setSwitchStatus("Unable to equip item");\par
                    \}\par
                    logit("Unable to equip item.");\par
                    cm.ModalManager.alert(\{\par
                        button_text: unsafeWindow.g_js_strings.commonstr.ok,\par
                        text: u.msg,\par
                        "class": "craftFailure",\par
                        exe: function () \{\par
                            unsafeWindow.Modal.hideModalAll();\par
                            unsafeWindow.cm.ModalManager.close()\par
                        \}\par
                    \})\par
                \}\par
            \}, function (u) \{\par
                logit("equip error");\par
                logit("e:" + inspect(u,3,1));\par
\par
            \})\par
        \},\par
\par
        showNext : function () \{\par
            var t = Tabs.organizer;\par
            if (t.panelId < 0) return;\par
            var X = unsafeWindow.kocThroneItems[t.panelId];\par
            var V = "next";\par
            var P = t.panelType;\par
\par
            var bump = t.panelNextLevel;\par
\par
            if (P == "enhance")\par
            \{\par
                if ( (X.quality + bump ) > 5)\par
                \{\par
                    bump = 5 - X.quality;\par
                \}\par
            \}\par
            else if ( (X.level + bump) > 10)\par
            \{\par
                bump =  10 - X.level;\par
            \}\par
\par
            var R = [],\par
            Q, Y, S, U, N = \{\},\par
            T, W;\par
            if (V == "next") \{\par
                if (P == "enhance") \{\par
                    X.quality += bump;\par
                    $("#nextStatContainer span").html('<span> ' + X.createPrefix() + ' </span>');\par
                \} else \{\par
                    if (P == "upgrade") \{\par
                        X.level += bump;\par
                        $("#nextStatContainer span").html('<span> Level ' + X.level + ' </span>');\par
                    \}\par
                \}\par
            \}\par
            $.each(X.effects, function (Z, aa) \{\par
                Q = +(Z.split("slot")[1]);\par
                Y = CM.thronestats.effects[aa.id];\par
                S = CM.thronestats.tiers[aa.id][aa.tier];\par
                U = +(S.base) + ((X.level * X.level + X.level) * +(S.growth) / 2);\par
                U = U.toFixed(2);\par
                N[aa.id] = \{\};\par
                N[aa.id].percent = U;\par
                N[aa.id].name = Y[1];\par
                if (Q % 2 == 0) \{\par
                    T = "even"\par
                \} else \{\par
                    T = "odd"\par
                \}\par
                if (Q <= X.quality) \{\par
                    if (U > 1) \{\par
                        R.push("<li class='" + T + "'>" + Y[1] + " +" + U + "%</li>")\par
                    \} else \{\par
                        R.push("<li class='" + T + "'>" + Y[1] + " " + U + "%</li>")\par
                    \}\par
                \} else \{\par
                    R.push("<li class='disabled " + T + "'>" + Y[1] + " + " + U + "%</li>")\par
                \}\par
            \});\par
            if (V == "next") \{\par
                if (P == "enhance") \{\par
                    X.quality -= bump\par
                \} else \{\par
                    if (P == "upgrade") \{\par
                        X.level -= bump;\par
                    \}\par
                \}\par
            \}\par
            if (V === "next") \{\par
                if (CM.ThronePanelController.isLastLevel(X, P)) \{\par
                    W = $("<div/>").addClass("lock").attr("id", "lockedStatIcon");\par
                    $("#nextStatContainer").append(W)\par
                \} else \{\par
                    $("#lockedStatIcon").remove()\par
                \}\par
            \}\par
            t.panelNextLevel++;\par
            $("#thronePanelStat2").html(R.join(""));\par
        \},\par
\par
        // highlight the items the salvager will target\par
        testSalvage : function() \{\par
            var t = Tabs.organizer;\par
            var s = Tabs.throneSalvage;\par
            var toDelete = s.buildList(true);\par
\par
            $('#trDelResults').html("<div> " + toDelete.length + " item(s) targeted for deletion</div>");\par
\par
            for (i =0; i < toDelete.length; i++)\par
            \{\par
                var item = unsafeWindow.kocThroneItems[toDelete[i]];\par
                if (item.isBroken || item.isEquipped)\par
                \{\par
                    t.selectCard(toDelete[i], "orange");\par
                \}\par
                else\par
                \{\par
                    t.selectCard(toDelete[i], "red");\par
                \}\par
            \}\par
        \},\par
\par
        paintTable : function() \{\par
            // fill in the table\par
            var t = Tabs.organizer;\par
            var m = "";\par
            var mm;\par
            var tab = document.getElementById('trDisplayTable');\par
            var ii = Math.max(t.itemLists['chair'].length, t.itemLists['table'].length, t.itemLists['window'].length, t.itemLists['banner'].length, t.itemLists['advisor'].length, t.itemLists['trophy'].length, t.itemLists['candelabrum'].length);\par
\par
            m += "<tr align=center valign=top><th width=14%>Chairs</th><th width=14%>Tables</th><th width=14%>Windows</th><th width=14%>Banners</th><th width=14%>Advisors</th><th width=14%>Throphies</th><th width=14%>Candelabra</th></tr>";\par
            for (var k= 0; k < ii ; k++)\par
            \{\par
                mm = '<TR  align=left valign=top style="height: auto;">';\par
                for (i in t.itemTypes)\par
                \{\par
                    var item = t.itemLists[i][k];\par
                    var item_num = 0;\par
                    var id="card";\par
                    if (item != null)\par
                    \{\par
                        id += item.id;\par
                        item_num = item.id;\par
                    \}\par
                    mm += '<TD class="tdcard" style="overflow: visible;  width:auto; height: 150px; border: 4px solid white;" id="' + id +'" >';\par
                    mm += t.buildCard(t.itemLists[i][k]);\par
                    mm += '</TD>';\par
                \}\par
                mm += '</TR>';\par
                m+= mm;\par
            \}\par
            tab.innerHTML = m;\par
            // repair the height/width caused by the 2d transform\par
            var d = document.getElementById ('trTableDiv');\par
            var t = document.getElementById ('trDisplayTable');\par
            var nodes = t.getElementsByTagName('td');\par
\par
            for (n=0; n < nodes.length; n++)\par
            \{\par
                var d2 = nodes[n].childNodes[0];\par
                var h = d2.offsetHeight;\par
                var w = d2.offsetWidth;\par
                d2.style.height = (TABLE_SCALE * h) + "px";\par
                d2.style.width  = (TABLE_SCALE * w) + "px";\par
            \}\par
\par
            $(".trCardDisp").click( function( A)\{\par
                var theId = $(this).attr("id").split("trCardItem")[1];\par
                unsafeWindow.cm.ContextualMenuThrone.renderMenu( $(this), unsafeWindow.kocThroneItems[theId]);\par
            \});\par
\par
            // add the large tooltip\par
\par
            if (presetData.noTooltips != true) $("td.tdcard").on("mouseenter", "*", function (A) \{\par
                A.stopPropagation();\par
                var theId = $(this).parents("td.tdcard").attr("id").split("card")[1];\par
                $("#contextMenu").remove();\par
\par
                if (!theId || theId == 0) \{\par
                    return;\par
                \}\par
\par
                if (unsafeWindow.kocThroneItems[theId])\par
                \{ \par
                    unsafeWindow.cm.ThroneView.hoverItem(A, this, unsafeWindow.kocThroneItems[theId]);\par
                    $("#kofcNewTooltipDiv").css('position', 'absolute');\par
                    $("#kofcNewTooltipDiv").css('left', ($("#tr_dialog").position().left+200) + 'px');\par
                    $("#kofcNewTooltipDiv").css('top',  A.pageY-350 + 'px');\par
                \}\par
                else \par
                \{\par
                    $("#kofcNewTooltipDiv").remove();\par
                    setTimeout( function () \{Tabs.organizer.show();\}, 200);    \par
                \}\par
            \});\par
\par
            if (presetData.noTooltips != true) $("td.tdcard").on( "mouseleave", "*", function (A) \{\par
                var theId = $(this).parents("td.tdcard").attr("id").split("card")[1];\par
                if (unsafeWindow.kocThroneItems[theId]) \{\}\par
                    //unsafeWindow.cm.ThroneView.unhoverItem(A, this, unsafeWindow.kocThroneItems[theId])\par
            \});\par
\par
            // add yellow and blue borders\par
            $("div.trCard").removeClass("blueBorder2");\par
            $("div.trCard").removeClass("yellowBorder2");\par
\par
            for (ii in queueData.list) \{\par
                var list_item = queueData.list[ii];\par
                if (!list_item) continue;\par
                if (list_item.status != "complete") \{\par
                    var id = list_item.item;\par
\par
                    if (list_item.action == "upgrade") $("div#trCardItem" + id).find("div.trCard").addClass("blueBorder2");\par
                    if (list_item.action == "enhance") $("div#trCardItem" + id).find("div.trCard").addClass("yellowBorder2");\par
                \}\par
            \}\par
\par
        \},\par
\par
        // select a kabam preset\par
        selectPreset : function (p)\par
        \{\par
            // highlight the selected set of cards\par
            var t = Tabs.organizer;\par
            t.clearHighlights();\par
\par
            p += "";\par
\par
            if (p.indexOf("local") >=0 ) \{\par
                // highlight the local preset\par
                var localNum = +(p.split("local")[1]);\par
                var items = presetData.items[localNum];\par
\par
                if (!items || items.length==0) return;\par
\par
                for (i in items)\par
                \{\par
                    t.selectCard(items[i], "green");\par
                \}\par
                return;\par
            \}\par
\par
            // highlight the standard preset\par
            var equipedItems = Seed.throne.slotEquip[parseInt(p)];\par
            if (equipedItems != null)\par
            \{\par
                for (ll =0; ll < equipedItems.length; ll++)\par
                \{\par
                    t.selectCard(equipedItems[ll], "green");\par
                \}\par
            \}\par
        \},\par
\par
        // fill the lists w/ the current TR items\par
        fillLists : function ()\par
        \{\par
            var t = Tabs.organizer;\par
\par
            for (i in t.itemTypes)\par
            \{\par
                t.itemLists[i] = new Array;\par
            \}\par
\par
            for (k in unsafeWindow.kocThroneItems) \{\par
                var throne_item = unsafeWindow.kocThroneItems[k];\par
                if (throne_item.isEquipped)\par
                    t.itemLists[throne_item.type].unshift(throne_item);\par
                else\par
                    t.itemLists[throne_item.type].push(throne_item);\par
            \}\par
        \},\par
\par
        // sort the lists in the desired order\par
        sortLists : function ()\par
        \{\par
            var t = Tabs.organizer;\par
            upgradeData.sortInactive = ($("#trSortInactive").attr('checked') == 'checked');\par
            for (i in t.itemLists)\par
            \{\par
                t.itemLists[i].sort( function (item1, item2) \{\par
                    return t.sortValue(item2) - t.sortValue(item1);\par
                \});\par
            \}\par
        \},\par
\par
        sortValue : function (item)\par
        \{\par
            var t = Tabs.organizer;\par
            var retValue = 0.0;\par
            for (e in item.effects)\par
            \{\par
                var N = item.effects[e];\par
                var effect=CM.thronestats.effects[N.id][1];\par
                var tier=CM.thronestats.tiers[N.id][N.tier];\par
                var B=+(e.split("slot")[1]);\par
\par
                if (B> item.quality && !upgradeData.sortInactive)\par
                \{\par
                    return +retValue;\par
                \}\par
\par
                var percent=+(tier.base+((item.level*item.level+item.level)*tier.growth*0.5));  \par
                if ( (effect == (t.sortEffect + " Debuff")) && (t.sortType != "buff"))\par
                \{\par
                    retValue -= percent;\par
                \}\par
                else if (effect == t.sortEffect && t.sortType != "debuff")\par
                \{\par
                    retValue += percent;\par
                \}\par
            \}\par
            return +retValue;\par
        \},\par
\par
        // clear all the highlists\par
        clearHighlights : function()\par
        \{\par
            var t = Tabs.organizer;\par
\par
            for (k in unsafeWindow.kocThroneItems)\par
            \{\par
                var throne_item = unsafeWindow.kocThroneItems[k];\par
                t.selectCard(throne_item.id, "white");\par
            \}\par
\par
        \},\par
\par
        // highlight a card\par
        selectCard : function(itemId, color)\par
        \{\par
            var t = Tabs.organizer;\par
            var item = unsafeWindow.kocThroneItems[itemId];\par
\par
            t.selectedItems[item.type] = itemId;\par
            td = document.getElementById( "card"+itemId);\par
            if (td)\par
            \{\par
                td.style.borderColor = color;\par
            \}\par
        \},\par
\par
        clearCards : function()\par
        \{\par
            var t = Tabs.organizer;\par
            for (k in t.selectedItems)\par
            \{\par
                var td = document.getElementById( "card" + t.selectedItems[k]);\par
                if (td)\par
                \{\par
                    td.style.borderColor = "white";\par
                \}\par
            \}\par
            t.selectedItems = [];\par
        \},\par
\par
        // create the card to display\par
        buildCard : function(I)\{\par
            var t = Tabs.organizer;\par
            var D = [];\par
            var w=CM.thronestats.mightByQuality;\par
            var z=CM.thronestats.mightByLevel;\par
            if (I == null)\par
            \{\par
                D.push("<div>");\par
                D.push("</div>");\par
                return D.join("");\par
            \}\par
            D.push("<div class='trCardDisp' id='trCardItem" + I.id + "' style='border: 1px solid white; clear: both;  overflow: visible; position: relative; left: 0px; top: 0px; -moz-transform: scale(" + TABLE_SCALE + ", "+ TABLE_SCALE + "); -moz-transform-origin: 0% 0%;  -webkit-transform: scale(" + TABLE_SCALE + ", "+ TABLE_SCALE + ");  -webkit-transform-origin: 0% 0%;);'>");\par
            if (I.isBroken)\par
            \{\par
                D.push(" <div class='cardOverlay semi_transparent rot45'> Broken </div>");\par
            \}\par
            D.push(" <div class='trCard' style='white-space: normal; padding: 0px;'> ");\par
            D.push("<div class='section' style='overflow: visible;' id = 'idsection'>");\par
            D.push(" <div class='title "+I.createPrefix().toLowerCase()+"' style='text-transform: capitalize;'> ");\par
            D.push(I.name);\par
            D.push(" </div> ");\par
            D.push(" <div class='description'> ");\par
            D.push(" <div class='portrait "+I.faction+" "+I.type+"'> </div> ");\par
            D.push("<ul>");\par
            D.push("<li> "+uW.g_js_strings.commonstr.faction+": "+I.faction+"</li>");\par
            D.push("<li> "+uW.g_js_strings.commonstr.quality+": "+I.createPrefix()+"</li>");\par
            D.push("<li> "+uW.g_js_strings.commonstr.type+": "+I.type+"</li>");\par
            D.push("<li> "+uW.g_js_strings.commonstr.level+": "+I.level+"</li>");\par
            D.push("<li> "+uW.g_js_strings.commonstr.might+": "+(w[I.quality].Might+z[I.level].Might)+"</li>");\par
            D.push("</ul>");\par
            D.push(" </div> ");\par
            D.push(" <ul> ");\par
\par
            for (M in I.effects)\par
            \{\par
                var N = I.effects[M];\par
                effect=CM.thronestats.effects[N.id];\par
                tier=CM.thronestats.tiers[N.id][N.tier];\par
                percent=+(tier.base+((I.level*I.level+I.level)*tier.growth*0.5));\par
                percent=(percent>0)?"+"+percent:+percent;\par
                percent= parseFloat(percent).toFixed(2);\par
                // percent=Math.ceil(percent);\par
                css=(M%2===0)?"even":"odd";\par
                B=+(M.split("slot")[1]);\par
                if(B<=I.quality)\{\par
                    D.push(" <li class='effect "+css+"'> "+percent+"% "+effect[1]+" </li> ");\par
                \}else\{\par
                    D.push(" <li class='effect disabled "+css+"'> "+percent+"% "+effect[1]+" </li> ");\par
                \}\par
            \}\par
            D.push(" </ul> ");\par
            D.push(" </div> ");\par
            D.push(" </ul> ");\par
            D.push(" </div> ");\par
            D.push(" </div> ");\par
            return D.join("");\par
\par
        \},\par
\par
        show: function()\{\par
            var t = Tabs.organizer;\par
            t.fillLists();\par
            t.sortLists()\par
            t.paintTable();\par
            t.selectPreset(Seed.throne.activeSlot);\par
            document.getElementById ('PresetList').value = Seed.throne.activeSlot;\par
        \},\par
\par
        hide: function()\{\par
        \}\par
\}\par
\par
\par
/** ********************************* Log Tab ********************************** */\par
Tabs.trActionLog = \{\par
        tabOrder: 600,\par
        tabLabel : 'Log',\par
        myDiv : null,\par
        logTab : [null, null, null],\par
        maxEntries: 300,\par
        saveEntries : [[],[],[]],\par
        state : null,\par
\par
        init : function (div)\{\par
            var t = Tabs.trActionLog;\par
            t.myDiv = div;\par
            t.myDiv.innerHTML = '<div id=logScroll style=" position: static; width: 710px; height: 500px; overflow-x: hidden; overflow-y: auto;" >\\\par
                <DIV class=trStat>UPGRADE LOG - VERSION: '+ Version+'</div>\\\par
                <DIV style="height:535px; max-height:535px;">\\\par
                <TABLE cellpadding=0 cellspacing=0 id=trsuccesslog class=trTabLined width=100%><TR><TD width=20%></td><TD width=80%></td></tr></table>\\\par
                <DIV class=trStat>Action Log</div>\\\par
                <TABLE cellpadding=0 cellspacing=0 id=tractionlog class=trTabLined  width=100%><TR><TD width=20%></td><TD width=80%></td></tr></table>\\\par
                <DIV class=trStat>Salvage Log</div>\\\par
                <TABLE cellpadding=0 cellspacing=0 id=trsalvagelog class=trTabLined  width=100%><TR><TD width=20%></td><TD width=80%></td></tr></table></div></div>';\par
            t.logTab[0]  = document.getElementById('trsuccesslog');\par
            t.logTab[1]  = document.getElementById('tractionlog');\par
            t.logTab[2]  = document.getElementById('trsalvagelog');\par
            t.state = 1;\par
            \par
            for (var j=0; j<3; j++)\par
            \{\par
                var logVar = 'trlog_';\par
                if (j !=0)  logVar += (j + "_")\par
                logVar += getServerId();\par
\par
                var a = JSON2.parse(GM_getValue (logVar, '[]'));\par
\par
                if (matTypeof(a) == 'array')\{\par
                    t.saveEntries[j] = a;\par
                    for (var i=0; i<t.saveEntries[j].length; i++)\par
                        t._addTab(j, t.saveEntries[j][i].msg, t.saveEntries[j][i].ts);\par
                \}\par
            \}\par
\par
            window.addEventListener('unload', t.onUnload, false);\par
            \par
            $("#logScroll").resizable(\{\par
                minWidth: 710,\par
                maxWidth: 1000,\par
                minHeight: 180,\par
                maxHeight: 1100,\par
                stop: function(event, ui) \{\par
                    upgradeData.logH = ui.size.height + 'px';\par
                    upgradeData.logW = ui.size.width  + 'px';\par
                    saveUpgradeData();\par
                \}\par
            \});\par
            \par
            $("#logScroll").css('height', upgradeData.logH).css('width', upgradeData.logW);\par
        \},\par
\par
        hide : function ()\{\par
        \},\par
\par
        show : function ()\{\par
        \},\par
\par
        onUnload : function ()\{\par
            var t = Tabs.trActionLog;\par
            if (!ResetAll) GM_setValue ('trlog_'+getServerId(),  JSON2.stringify(t.saveEntries[0]));\par
            if (!ResetAll) GM_setValue ('trlog_1_'+getServerId(), JSON2.stringify(t.saveEntries[1]));\par
            if (!ResetAll) GM_setValue ('trlog_2_'+getServerId(), JSON2.stringify(t.saveEntries[2]));\par
        \},\par
\par
        _addTab : function (lnum, msg, ts)\{\par
            var t = Tabs.trActionLog;\par
            if (t.state != 1)\par
                return;\par
            if (t.logTab[lnum].rows.length >= t.maxEntries)\par
                t.logTab[lnum].deleteRow(t.maxEntries-1);\par
            var row = t.logTab[lnum].insertRow(0);\par
            row.vAlign = 'top';\par
            row.insertCell(0).innerHTML = ts;\par
            row.insertCell(1).innerHTML = msg;\par
        \},\par
\par
        log : function (lnum, msg)\{\par
            var t = Tabs.trActionLog;\par
            var d = new Date();\par
            var ts = d.toDateString().substring(3,10) + " "+ d.toTimeString().substring(0,8);\par
            t._addTab (lnum, msg, ts);\par
            while (t.saveEntries[lnum].length >= 30)\par
                t.saveEntries[lnum].shift();\par
            t.saveEntries[lnum].push (\{msg:msg, ts:ts\});\par
        \}\par
\}\par
\par
function trSuccessLog (msg)\{\par
    if (!Tabs.trActionLog.tabDisabled)\par
        Tabs.trActionLog.log (0,msg);\par
\}\par
\par
function trActionLog (msg)\{\par
    if (!Tabs.trActionLog.tabDisabled)\par
        Tabs.trActionLog.log (1,msg);\par
\}\par
\par
function trSalvageLog (msg)\{\par
    if (!Tabs.trActionLog.tabDisabled)\par
        Tabs.trActionLog.log(2,msg);\par
\}\par
\par
/** ***************** options ********************* */\par
\par
Tabs.options = \{\par
        tabOrder: 700,\par
        tabLabel: 'Options',\par
        myDiv : null,\par
\par
        init : function (div) \{\par
            var t = Tabs.options;\par
            t.myDiv = div;\par
            \par
            // header stuff\par
            var m = '<Div id=optionScroll style=" position: static; width: 700px; height: 500px; overflow-x: hidden; overflow-y: auto;">';\par
            m += '<DIV id=trOptions class=trStat>OPTIONS</div><TABLE id=trOptionTbl width=100% height=0% class=trTab>';\par
            m += '<TR><TD width=100%><INPUT id=trupdate type=checkbox '+ (TRGlobalOptions.trUpdate?'CHECKED ':'') +'/>Check for script updates on userscripts.org (all domains) &nbsp; &nbsp; <INPUT id=trupdatenow type=button value="Update Now" /></TD></TR>';\par
            m += '<TR><TD width=100%><INPUT id=trDisableAnim type=checkbox '+ (upgradeData.disableAnim?'CHECKED ':'') +'/> Disable failure animation (Big red X) </TD></TR>';\par
\par
            m += '<TR><td><div  class=trStat>Salvage Options</div></td></TR>';\par
            m += '<tr><td><div>Load salvager settings from domain number: <INPUT id=trLoadDomain type=text size=3 maxlength=3 /><INPUT id=trLoadRules type=button value="Load"/></div></td></tr>';\par
            m += '<TR><TD><div style="white-space: pre;" ><INPUT id=trSalAnyCity type=checkbox '+ (salvageData.anyCity?' CHECKED':'') +'/> When primary city is full, put aetherstones in any city. ';\par
            m += '    Maximum number of aetherstones: <INPUT id=trMaxStone type=text size=7 maxlength=7 value="' + salvageData.maxStones+ '"/></div></td></TR>';\par
            m += '<TR><TD>Overflow method: <select id=trOverflow><option value="order">City order</option><option value="lowest">Lowest city</option>  </select></TD></TR>';\par
            m += '<TR><TD><div style="white-space: pre;" ><INPUT id=trSalUpgradeFirst type=checkbox '+ (salvageData.upgradeFirst?' CHECKED':'') +'/> Upgrade items to +1 before deleting.';\par
            \par
            m += ' Maximum quality: <select id="trSalUpgradeQuality">';\par
            m += '<option value="0">Simple</option>';\par
            m += '<option value="1">Common</option>';\par
            m += '<option value="2">Uncommon</option>';\par
            m += '<option value="3">Rare</option>';\par
            m += '<option value="4">Epic</option>';\par
            m += '<option value="5">Wondrous</option>';\par
            m += '</select> </div></td></tr>';\par
            \par
            m += '<TR><td><div  class=trStat>Upgrade Options</div></td></TR>';\par
            m += '<tr><td width=25%>Retry interval (seconds): <INPUT id=trUpRefresh type=text size=3 maxlength=3 value="' +upgradeData.retryInterval+ '"/></td></tr>';\par
            m += '  <tr><td colspan=2><div style="white-space: pre;"><INPUT id=trAnyCity type=checkbox '+ (upgradeData.anyCity?' CHECKED':'') +'/> When primary city is low, use aetherstones from any city.  ';\par
            m += ' Minimum number of aetherstones: <INPUT id=trMinStone type=text size=7 maxlength=7 value="' +upgradeData.minStones+ '"/> </div></td></tr>';\par
            m += '<tr><td colspan=2>  <INPUT id=trWhisperCheck type=checkbox '+ (upgradeData.whisperToMe?'CHECKED ':'') +'/> Whisper to myself on successful upgrades</td></tr> ';\par
            m += '<tr><td colspan=2>  <INPUT id=trBuffsCheck type=checkbox '+ (upgradeData.buffsOff?'CHECKED ':'') +'/> Automatically unselect upgrade tokens on upgrade panel</td></tr> ';\par
            m += '<tr><td colspan=2><INPUT id=trSafetyCheck type=checkbox '+ (upgradeData.safetyOn?'CHECKED ':'') +'/> Disable manual upgrades if less than <input id=trSafetyLimit size=10 maxlength=10 value="' + upgradeData.safetyLimit +'" /> aetherstone</td></tr> ';\par
         \par
            m += '<TR><td><div  class=trStat>Organizer Options</div></td></TR>';\par
            m += '<TR><td><div style="text-align:center;"> Local Preset Names/Descriptions</div></td></TR>';\par
\par
            for (j=0; j<presetData.num_presets; j++ ) \par
            \{\par
                if (!presetData.desc[j]) presetData.desc[j] = 'Preset ' + String.fromCharCode(65 + j);\par
                if (!presetData.ids[j]) presetData.ids[j] = String.fromCharCode(65 + j);\par
                m += '<tr><td style="width: 650px; white-space: nowrap;">Name: <INPUT class=trNameEntry id=trPresetName' + j + ' type=text size=8 maxlength=8 value="' + presetData.ids[j] + '"/> Description: <INPUT class=trDescEntry id=trPresetDesc' +j+' type=text size=80 maxlength=100 value="' + presetData.desc[j] + '"/></td></tr>';\par
            \}\par
\par
            m += '<TR><TD><div style="white-space: pre;" >Number of presets: <INPUT id=trNumPresets type=text size=4 maxlength=2 value="' +presetData.num_presets+ '"/>  <INPUT id=trNoTooltips type=checkbox '+ (presetData.noTooltips?' CHECKED':'') +'/> Do not show large portrait tooltips</div></td></tr>';\par
            m += '</table></div>';\par
\par
            t.myDiv.innerHTML = m;\par
            \par
            $("#optionScroll").resizable(\{\par
                minWidth: 710,\par
                maxWidth: 810,\par
                minHeight: 300,\par
                maxHeight: 780,\par
                stop: function(event, ui) \{\par
                    upgradeData.optionH =  ui.size.height + 'px';\par
                    upgradeData.optionW =  ui.size.width  + 'px';\par
                    saveUpgradeData();\par
                \}\par
            \});\par
            \par
            $("#optionScroll").css('height', upgradeData.optionH).css('width', upgradeData.optionW);\par
            \par
            $('#trDisableAnim').change( function ()\{\par
                upgradeData.disableAnim = document.getElementById('trDisableAnim').checked;\par
                disableAnimation(upgradeData.disableAnim);\par
            \}\par
            );\par
\par
            $('#trupdate').change( function ()\{\par
                TRGlobalOptions.trUpdate = document.getElementById('trupdate').checked;\par
                GM_setValue ('TROptions_??', JSON2.stringify(TRGlobalOptions));\par
            \}\par
            );\par
            \par
            $('#trWhisperCheck').change( function ()\{\par
                upgradeData.whisperToMe = document.getElementById('trWhisperCheck').checked;\par
                saveUpgradeData();\par
               \}\par
            );\par
            \par
            $('#trSafetyCheck').change( function ()\{\par
                upgradeData.safetyOn = document.getElementById('trSafetyCheck').checked;\par
                saveUpgradeData();\par
               \}\par
            );\par
            \par
            $('#trBuffsCheck').change( function ()\{\par
                upgradeData.buffsOff = document.getElementById('trBuffsCheck').checked;\par
                saveUpgradeData();\par
               \}\par
            );\par
            \par
            $('#trSafetyLimit').change( function ()\{\par
                upgradeData.safetyLimit = $("#trSafetyLimit").val();\par
                saveUpgradeData();\par
               \}\par
            );\par
\par
            $('#trupdatenow').click(\par
                    function() \{ AutoUpdater_132329.call(true,true); \}\par
            );\par
\par
            $('#trSalAnyCity').change( function()\{\par
                salvageData.anyCity = document.getElementById('trSalAnyCity').checked;\par
                saveSalvageData();\par
            \});\par
            \par
            $('#trSalUpgradeFirst').change( function()\{\par
                salvageData.upgradeFirst = document.getElementById('trSalUpgradeFirst').checked;\par
                saveSalvageData();\par
            \});\par
            \par
            // set the upgrade quality limit widget\par
            $("#trSalUpgradeQuality").val(salvageData.upgradeFirstQual);\par
            $("#trSalUpgradeQuality").change( function() \{ salvageData.upgradeFirstQual = $("#trSalUpgradeQuality").val(); saveSalvageData();\});\par
            \par
            $("#trMaxStone").change ( function() \{\par
                salvageData.maxStones = $("#trMaxStone").val(); \par
                saveSalvageData();\par
            \});\par
\par
            $('#trUpRefresh').change( function()\{\par
                upgradeData.retryInterval = parseInt(document.getElementById('trUpRefresh').value);\par
                if (upgradeData.retryInterval < 15) upgradeData.retryInterval = 15;\par
                saveUpgradeData();\par
            \});\par
\par
            $("#trMinStone").change ( function() \{\par
                upgradeData.minStones = $("#trMinStone").val(); \par
                saveUpgradeData();\par
            \});\par
\par
            $("#trLoadRules").click(function () \{\par
                var d = $("#trLoadDomain").val();\par
                if (d != null)\par
                    loadSalvageData(d);\par
            \});\par
\par
            // set the overflow widget\par
            $("#trOverflow").val(salvageData.overflow);\par
            $("#trOverflow").change( function() \{ salvageData.overflow = $("#trOverflow").val(); saveSalvageData();\});\par
            \par
           \par
            // read the preset names and descriptions\par
            $("input.trNameEntry").change(function ()  \{\par
                var id= $(this).attr('id');\par
                var num = id.split("trPresetName")[1];\par
                presetData.ids[num]= $(this).val();\par
                savePresetData();\par
                Tabs.organizer.init(Tabs.organizer.myDiv);\par
            \});\par
\par
            $("input.trDescEntry").change (function ()  \{\par
                var id= $(this).attr('id');\par
                var num = id.split("trPresetDesc")[1];\par
                presetData.desc[num]= $(this).val();\par
                savePresetData();\par
                Tabs.organizer.init(Tabs.organizer.myDiv);\par
            \});\par
\par
            $('#trNoTooltips').change( function()\{\par
                presetData.noTooltips = document.getElementById('trNoTooltips').checked;\par
                savePresetData();\par
                Tabs.organizer.show();\par
                \par
            \});\par
            \par
            $("#trNumPresets").change ( function() \{\par
                var newNum  = $("#trNumPresets").val(); \par
                if (presetData.num_presets != newNum)\par
                \{\par
                  presetData.num_presets = newNum;\par
                  t.init(t.myDiv);\par
                  savePresetData();\par
                  Tabs.organizer.init(Tabs.organizer.myDiv);\par
                \}\par
            \});\par
\par
\par
            disableAnimation(upgradeData.disableAnim);\par
        \},\par
\par
\par
        show : function () \{\par
\par
        \},\par
\par
        hide : function () \{\par
\par
        \}\par
\par
\}\par
\par
/** ***************** Throne upgrade ********************* */\par
\par
Tabs.upgrader = \{\par
        tabOrder: 100,\par
        tabLabel: 'Upgrade',\par
        tabDisabled : false,\par
        myDiv : null,\par
        repairId : 0,\par
        repairEnd : 0,\par
        timerH : null,\par
        clearTimerH : null,\par
        qualities :  [ "Simple", \par
                       "Common",\par
                       "Uncommon",\par
                       "Rare", \par
                       "Epic",\par
                       "Wondrous"],\par
                       upgradePath : \{\par
                           0: \{maxLev: 2, nextQual: 2 \},\par
                           1: \{maxLev: 2, nextQual: 2 \},\par
                           2: \{maxLev: 3, nextQual: 4 \},\par
                           3: \{maxLev: 3, nextQual: 4 \},\par
                           4: \{maxLev: 4, nextQual: 5 \}\par
                       \},\par
\par
                       repaint : function() \{\par
                           var t = Tabs.upgrader;\par
                           t.init(t.myDiv);\par
                       \},\par
\par
                       init : function (div)\{\par
                           var t = Tabs.upgrader;\par
                           t.myDiv = div;\par
\par
                           if (unsafeWindow.g_js_strings)\par
                           \{\par
                               t.qualities = [ unsafeWindow.g_js_strings.throneRoom.simple, \par
                                               unsafeWindow.g_js_strings.throneRoom.common,\par
                                               unsafeWindow.g_js_strings.throneRoom.uncommon,\par
                                               unsafeWindow.g_js_strings.throneRoom.rare, \par
                                               unsafeWindow.g_js_strings.throneRoom.epic,\par
                                               unsafeWindow.g_js_strings.throneRoom.wondrous];\par
                           \}\par
\par
                           // header stuff\par
                           var m = '<Div id=trfield><DIV id=trUpgrader class=trStat>AUTOMATED UPGRADER</div><TABLE id=trupgrader width=100% height=0% class=trTab>';\par
                           m+= '</table></div>';\par
\par
                           // \par
                           m += '<TABLE width=100% id=trupdtable class=trTabPad>';\par
\par
                           m += '<tr>';\par
                           if (upgradeData.active == false) \{\par
                               m += '<TD width=25%><div><INPUT id=trUpgraderPower type=button value="Upgrade = OFF"/></div></td>';\par
                           \} else \{\par
                               m += '<TD width=25%><div><INPUT id=trUpgraderPower type=button value="Upgrader = ON"/></div></td>';\par
                           \}\par
\par
                           m += '<td width=25%><INPUT id=trOneItem type=checkbox '+ (queueData.oneItem ? ' CHECKED':'') +'/>  Upgrade 1 at a time</td>';\par
                           m += '<td width=25%><INPUT id=trRepairAll type=checkbox '+ (upgradeData.repairAll?' CHECKED':'') +'/>  Repair all TR items</td>'; \par
                           m += '<td width=25%/></tr>';\par
\par
                           m += '  <tr><td colspan=3><div ><b>City to use aetherstones from: </b><span id="trUpgradeCity"></span></div></td>';\par
                           m += '  <td><div id=trStoneRemain></div></td></tr>';\par
                           m += '<tr><td colspan=4><hr></td></tr>';\par
                           m += '<tr align="center"><td colspan=4><div id=trUpgradeStatus class=indent25> <br> </div></td></tr>';\par
                           m += '<tr align="center"><td colspan=4><div id=trLastResult class=indent25> <br> </div></td></tr>';\par
                           m += '<tr><td colspan=4><hr></td></tr></table>';\par
\par
                           m += '<TABLE id=trupdtable2 class=trTabPad>';\par
                           m += '<tr><td width=50%><div><span>Item: <select id="trUpgradeList">';\par
                           m += '<option value="0">--Items--</option>';\par
                           for (k in unsafeWindow.kocThroneItems) \{\par
                               var throne_item = unsafeWindow.kocThroneItems[k];\par
                               m += '<option value="'+k+'">'+throne_item.name+'</option>';\par
                           \}\par
                           m += '</select></span></div></td>';\par
\par
                           m += '<td width=20%><div id=trActionDiv>Action: <select id="trAction">';\par
                           m += '<option value="upgrade">Upgrade</option>';\par
                           m += '<option value="enhance">Enhance</option>';\par
                           m += '<option value="both">Both</option>';\par
                           m += '</select></div></td>';\par
                           m += '<td width=20%><div id=trMaxDiv></div></td>';\par
\par
                           m += "<td width=10%><div><INPUT id=trQueueAdd type=button value='Add'/></div></td></tr>";\par
                           m += '<tr><td colspan=4><hr/</td></tr>';\par
                           m += '<tr><td colspan=4><div id=trQScroll style=" position: static; width: 700px; height: 300px; overflow-x: visible; overflow-y: auto;"><div id=trQDiv /></div></td></tr>';\par
\par
                           m += '<tr align=center><div><td><input style="float: left;" id=trClearQ type=button value="Clear Queue"/></div></td><td colspan=1></td><td colspan=2><a id=trpplink><img id=trpp /></a></td></tr>';\par
                           m += '</table>';\par
\par
                           m+='</div>';\par
                           t.myDiv.innerHTML = m;\par
\par
                           $('#trClearQ').click( function() \{\par
                               queueData.list =[];\par
                               saveQueueData();\par
                               Tabs.upgrader.buildQueueDisplay();\par
                           \});\par
                           \par
                           $("#trQScroll").resizable(\{\par
                               minWidth: 710,\par
                               maxWidth: 1200,\par
                               minHeight: 200,\par
                               maxHeight: 800,\par
                               stop: function(event, ui) \{\par
                                   upgradeData.upgradeH =  ui.size.height + 'px';\par
                                   upgradeData.upgradeW =  ui.size.width  + 'px';\par
                                   saveUpgradeData();\par
                               \}\par
                           \});\par
                           \par
                           $("#trQScroll").css('height', upgradeData.upgradeH).css('width', upgradeData.upgradeW);\par
\par
                           $("#trpplink")\par
                           .attr('href', 'https://www.paypal.com/cgi-bin/webscr?cmd=_donations&business=FDW4NZ6PRMDMJ&lc=US&item_name=TR%20Organizer%20Donations&item_number=1001&currency_code=USD&bn=PP%2dDonationsBF%3abtn_donateCC_LG%2egif%3aNonHosted')\par
                           .attr('target', '_blank');\par
                           $("#trpp")\par
                           .attr( 'src', 'https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif')\par
                           .attr( 'alt', 'dontae')\par
                           .css( 'cursor', 'pointer');\par
\par
                           document.getElementById('trUpgraderPower').addEventListener('click', function()\{t.togglePower(this);\} , false);\par
\par
                           document.getElementById('trRepairAll').addEventListener('change', function()\{\par
                               upgradeData.repairAll = document.getElementById('trRepairAll').checked;\par
                               saveUpgradeData();\par
                           \}, false);\par
\par
                           document.getElementById('trAnyCity').addEventListener('change', function()\{\par
                               upgradeData.anyCity = document.getElementById('trAnyCity').checked;\par
                               saveUpgradeData();\par
                           \}, false);\par
\par
                           new CdispCityPicker ('trupcitysel', document.getElementById('trUpgradeCity'), true, t.e_CityButton, upgradeData.uCityNum);\par
\par
                           // wait for the current repair to finish before starting\par
                           t.setStones(Seed.resources["city" + Seed.cities[upgradeData.uCityNum][0]]["rec5"][0]);\par
                           t.setStatus("Loading ....");\par
\par
                           //$(div).append(m);\par
                           $("#trQDiv").html('<div><table id="trQueue" class="trTabLined" width="100%"/></div>');\par
                           \par
                           $("#trQueueAdd").click( function () \{ t.addQueue();\});\par
                           $("#trOneItem").change( function () \{ \par
                               queueData.oneItem = document.getElementById('trOneItem').checked;\par
                               saveQueueData();\par
                           \});\par
\par
                           \par
                           var d = 2 + Math.random() * 8;\par
                           if (Seed.queue_throne != null && Seed.queue_throne.end != null)\par
                           \{\par
                               var repairTimeLeft = Seed.queue_throne.end- unixTime();\par
                               t.repairEnd = Seed.queue_throne.end;\par
                               t.repairId = Seed.queue_throne.itemId;\par
                               var n = new Date(t.repairEnd *1000);\par
\par
                               t.setStatus("Waiting until " + n.toLocaleTimeString() + " for repair to complete.  Item: " + unsafeWindow.kocThroneItems[t.repairId].name);\par
                               setTimeout(t.clearRepair, (repairTimeLeft+1)*1000);\par
                               if (repairTimeLeft >0) d += repairTimeLeft;\par
                           \}\par
                           \par
                           t.buildLevelWidget();\par
                           t.buildQueueDisplay();\par
                           $("#trAction").change( function() \{t.buildLevelWidget();\});\par
\par
\par
                           if (t.timerH == null)\par
                               t.timerH = setTimeout(t.doAction, d*1000);\par
\par
                       \},\par
\par
                       e_CityButton : function (city, x, y)\{\par
                           var t = Tabs.upgrader;\par
                           upgradeData.uCityNum = city.idx;\par
                           saveUpgradeData();\par
                           t.setStones(Seed.resources["city" + Seed.cities[upgradeData.uCityNum][0]]["rec5"][0]);\par
                       \},\par
\par
                       addUpgradeItem : function(id) \{\par
                           var t = Tabs.upgrader;\par
                           var qItem = new QueueItem();\par
                           qItem.item   = id;\par
                           qItem.action = "upgrade";\par
                           qItem.level  = 10;\par
                           queueData.list.push(qItem);\par
                           saveQueueData();\par
                           $("div#throneInventoryItem" + id).addClass('blueBorder');\par
                           $("div#trCardItem" + id).find("div.trCard").addClass("blueBorder2");\par
                           t.buildQueueDisplay();\par
                       \},\par
\par
                       addEnhanceItem : function(id) \{\par
                           var t = Tabs.upgrader;\par
                           var qItem = new QueueItem();\par
                           qItem.item   = id;\par
                           qItem.action = "enhance";\par
                           qItem.level  = 5;\par
                           queueData.list.push(qItem);\par
                           saveQueueData();\par
                           $("div#throneInventoryItem" + id).addClass('yellowBorder');\par
                           $("div#trCardItem" + id).find("div.trCard").addClass("yellowBorder2");\par
                           t.buildQueueDisplay();\par
                       \},\par
\par
                       addBothItem : function (id) \{\par
                           var t = Tabs.upgrader;\par
\par
                           var throne_item = unsafeWindow.kocThroneItems[id];\par
                           if (!throne_item)\par
                           \{\par
                               logit("Unable to find throne item.");\par
                               return;\par
                           \}\par
\par
                           var qual = +throne_item.quality;\par
                           var lev  = +throne_item.level;\par
\par
                           if (qual >= 5) \{\par
                               logit("Item already at wondrous");\par
                               return;\par
                           \}\par
\par
                           var maxLev = null;\par
                           var nextQual = null;\par
                           var qItem = null;\par
\par
                           while (qual < 5) \{\par
                               maxLev = t.upgradePath[qual].maxLev;\par
                               nextQual = t.upgradePath[qual].nextQual;\par
\par
                               if (lev < maxLev) \{\par
                                   qItem = new QueueItem();\par
                                   qItem.item   = id;\par
                                   qItem.action = "upgrade";\par
                                   qItem.level  = maxLev;\par
                                   queueData.list.push(qItem);\par
                                   $("div#throneInventoryItem" + id).addClass('blueBorder');\par
                                   $("div#trCardItem" + id).find("div.trCard").addClass("blueBorder2");\par
                               \}\par
\par
                               qItem = new QueueItem();\par
                               qItem.item   = id;\par
                               qItem.action = "enhance";\par
                               qItem.level  = nextQual;\par
                               queueData.list.push(qItem);\par
                               $("div#throneInventoryItem" + id).addClass('yellowBorder');\par
                               $("div#trCardItem" + id).find("div.trCard").addClass("yellowBorder2");\par
                               lev = maxLev;\par
                               qual = nextQual;\par
                           \}\par
\par
                           saveQueueData();\par
                           t.buildQueueDisplay();\par
                       \},\par
\par
                       doAction :function ()\par
                       \{\par
                           var t = Tabs.upgrader;\par
                           var retryTime = upgradeData.retryInterval;\par
\par
                           try \{\par
                               // check if repair is done\par
                               var ti = t.clearRepair();\par
                               if ( ti <= 0)\par
                               \{  \par
                                   // repair is done\par
                                   if (queueData.oneItem || (queueData.doingRepairs == true))\par
                                   \{\par
                                       if (upgradeData.repairAll == true)\par
                                       \{\par
                                           // repair everything\par
                                           for (k in unsafeWindow.kocThroneItems)\par
                                           \{\par
                                               var throne_item = unsafeWindow.kocThroneItems[k];\par
                                               if (!throne_item) continue;\par
                                               if (throne_item.isBroken)\par
                                               \{\par
                                                   t.doRepair(throne_item.id);\par
                                                   clearTimeout(t.timerH);\par
                                                   t.timerH = setTimeout(t.doAction, retryTime*1000);\par
                                                   return;\par
                                               \}\par
                                           \}\par
                                       \} else \{\par
                                           // repair first broken item in queue\par
                                           for (k in queueData.list)\par
                                           \{\par
                                               var q = queueData.list[k];\par
                                               if (!q) continue;\par
                                               var throne_item = unsafeWindow.kocThroneItems[q.item];\par
                                               if ((throne_item == null) || (queueData.list[k].status == "complete"))\par
                                                   continue;\par
\par
                                               if ( throne_item.isBroken )\par
                                               \{\par
                                                   t.doRepair(throne_item.id);\par
                                                   clearTimeout(t.timerH);\par
                                                   t.timerH = setTimeout(t.doAction, retryTime*1000);\par
                                                   return;\par
                                               \}  else if (queueData.oneItem) \{\par
                                                   break;\par
                                               \}\par
                                           \}\par
                                       \}\par
                                   \}\par
\par
                                   // all repairs complete\par
                                   queueData.doingRepairs = false;\par
                                   // set the index\par
                                   t.selectNext();\par
                                   saveQueueData();\par
\par
                                   // if we reach the end of the queue, start repair cycle\par
                                   if (queueData.index <0) \{\par
                                       t.setStatus("Reached end of queue.")\par
                                       queueData.doingRepairs = true;\par
                                       saveQueueData();\par
                                       clearTimeout(Tabs.upgrader.timerH);\par
                                       t.timerH = setTimeout(t.doAction, retryTime*1000);\par
                                       return;\par
                                   \}\par
\par
                                   // upgrade/enhance next item\par
                                   var qItem = queueData.list[queueData.index];\par
\par
                                   if (qItem) \{\par
                                       //qItem.triesTotal++;\par
                                       //qItem.triesThis++;\par
\par
                                       if (qItem.action == "enhance")\par
                                           t.doEnhance(qItem.item);\par
                                       else \par
                                           t.doUpgrade(qItem.item, false);\par
                                   \}\par
                               \} else \{\par
                                   // come back after repair is complete\par
                                   retryTime = ti + 5;\par
                                   var n = new Date(t.repairEnd *1000);\par
                                   t.setStatus("Waiting until " + n.toLocaleTimeString() + " for repair to complete.  Item: " + unsafeWindow.kocThroneItems[t.repairId].name);\par
                               \}\par
                               unsafeWindow.cm.ThroneView.renderInventory(unsafeWindow.kocThroneItems);\par
                           \} catch(e) \{\par
                               logit ("exception: " + inspect(e,3,1));\par
                           \}\par
                           // recycle\par
                           clearTimeout(Tabs.upgrader.timerH);\par
                           t.timerH = setTimeout(t.doAction, retryTime*1000);\par
                       \},\par
\par
                       selectNext : function () \{\par
\par
                           if (queueData.index >= queueData.list.length) queueData.index = 0;\par
                           if (queueData.index < 0) queueData.index = 0;\par
\par
                           // for single item mode, always start from the top\par
                           if (queueData.oneItem) queueData.index = 0; \par
\par
                           var l = queueData.list.length;\par
                           for (i=queueData.index; i < l; i++ ) \{\par
                               var item = queueData.list[i];\par
                               if (!item) continue;\par
                               //var id = item.item;\par
                               var throne_item = unsafeWindow.kocThroneItems[item.item];\par
                               if ( (queueData.list[i].status != "complete") \par
                                       && ( throne_item != null) \par
                                       && (!throne_item.isBroken) )\par
                               \{\par
                                   if ( ((item.action == "enhance") && (item.level <= throne_item.quality)) ||\par
                                           ((item.action == "upgrade") && (item.level <= throne_item.level)) ) \{\par
                                       item.status = "complete";\par
                                   \}  else \{\par
                                       queueData.index = i;\par
                                       return;\par
                                   \}\par
                               \}\par
                           \}\par
\par
                           // if we get here, the queue is complete\par
                           queueData.index = -1;\par
                       \},\par
\par
                       doEnhance : function(eItem) \{\par
                           var t = Tabs.upgrader;\par
                           try \{\par
                               if (upgradeData.active == false ||  eItem ==0)\par
                               \{\par
                                   t.setStatus("Powered off");\par
                                   return;\par
                               \}\par
                               var y = unsafeWindow.kocThroneItems[eItem];\par
\par
                               if (!y) return;\par
\par
                               if (y.isBroken)\par
                               \{\par
                                   // repair and then try again later\par
                                   t.doRepair(eItem);\par
                                   return;\par
                               \}\par
\par
                               var num_city = t.pickCity();\par
                               if ( num_city < 0)\par
                               \{\par
                                   t.setStatus("Not enough aetherstones to enhance.  Minimum of " + upgradeData.minStones + " needed.  Waiting for more ...");\par
                                   return;\par
                               \}\par
\par
                               var t_city = unsafeWindow.currentcityid;\par
                               unsafeWindow.currentcityid = Seed.cities[num_city][0];\par
                               var w = unsafeWindow.cm.ThronePanelController.calcCost("enhance", y, null, "stones");\par
                               unsafeWindow.currentcityid = t_city;\par
\par
                               if ( (w.gems.use > 0) || (w.stones.total > Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0] ))\par
                               \{\par
                                   t.setStatus("Not enough aetherstones to enhance.");\par
                                   return; \par
                               \}\par
\par
                               var qI = queueData.list[queueData.index];\par
                               if (qI)\par
                               \{\par
\par
                                   qI.triesTotal++;\par
                                   qI.triesThis++;\par
                               \}\par
\par
                               var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);\par
                               params.ctrl = 'throneRoom\\\\ThroneRoomServiceAjax';\par
                               params.action = 'upgradeQuality';\par
                               params.throneRoomItemId = eItem;\par
                               \par
                               params.payment = "aetherstone";\par
                               params.buffItemId = 0;\par
                               params.cityId = Seed.cities[num_city][0];\par
\par
                               //logit("Sending enhance request");\par
                               t.setStatus("Sending enhance request");\par
                               new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/_dispatch53.php" + unsafeWindow.g_ajaxsuffix, \{\par
                                   method: "post",\par
                                   parameters: params,\par
                                   loading: true,\par
                                   onSuccess: function (transport) \{\par
                                       try \{\par
                                           //logit("enhance request sucess");\par
                                           //logit("transport: " + inspect(transport,3,1));\par
                                           var rslt = eval("(" + transport.responseText + ")");\par
                                           //logit("rslt: " + inspect(rslt,3,1));\par
                                           if(rslt.ok)\{\par
                                               Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0] -= rslt.aetherstones;\par
                                               if (rslt.gems > 0)\par
                                               \{\par
                                                   trActionLog('Upgrader accidentally spent gems!  Upgrader turned off');\par
                                                   t.setStatus("Error ... shutting down");\par
                                                   upgradeData.active = false;\par
                                                   saveUpgradeData();\par
                                               \}\par
\par
\par
                                               if (rslt.success)\par
                                               \{\par
                                                   //logit("successful enhancement");\par
                                                   upgradeStats.enhanceSuccess[y.quality][y.level]++;\par
                                                   y.level = rslt.item.level;\par
                                                   y.quality = rslt.item.quality\par
                                                   y.status = rslt.item.status;\par
                                                   saveUpgradeStats();\par
                                                   y.name = y.createName();\par
                                                   Tabs.upgrader.repaint();\par
                                                   t.setResult("Enhance successful.  "  + addCommas(rslt.aetherstones) + " aetherstones used.");\par
                                                   t.setStones(Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0]);\par
                                                   t.setStatus("Attempting next action");\par
                                                   unsafeWindow.cm.sounds.play("tr_success_build");\par
                                                   // update the cost line\par
                                                   var qItem = queueData.list[queueData.index];\par
                                                   if (qItem)\par
                                                   \{\par
                                                       var now = new Date();\par
                                                       qItem.lastUpgrade = "Enhanced to " + Tabs.upgrader.qualities[y.quality] + " " + now.toDateString().substring(3,10) + " " + now.toTimeString().substring(0,8)  + " in " + qItem.triesThis + " attempts";\par
                                                       if (!qItem.upgrades) qItem.upgrades = [];\par
                                                       qItem.upgrades.push(qItem.lastUpgrade);\par
\par
                                                       var msg = 'Enhanced '+unsafeWindow.kocThroneItems[eItem].name + ' to quality ' + rslt.item.quality+ " in " + qItem.triesThis + " attempts. " + qItem.triesTotal + " total attempts for this item.";\par
                                                       trSuccessLog(msg);\par
                                                       if (upgradeData.whisperToMe) sendChat("/"+ Seed.player.name +' ' + msg);\par
\par
                                                       if (qItem.level <= y.quality) \{\par
                                                           qItem.status = "complete";\par
                                                           upgradeData.newUpgradeState = 2;\par
                                                       \}\par
                                                       else \{\par
                                                           var now = new Date();\par
                                                           qItem.status = "Partially enhanced";\par
                                                           qItem.triesLast = qItem.triesThis;\par
                                                           qItem.triesThis = 0;\par
                                                           if (upgradeData.newUpgradeState !=2 ) upgradeData.newUpgradeState =1;\par
                                                       \}\par
                                                       saveUpgradeData();\par
                                                       setUpgradeColor();\par
                                                   \}\par
                                                   saveQueueData();\par
                                                   Tabs.upgrader.buildQueueDisplay();\par
                                                   clearTimeout(Tabs.upgrader.timerH);\par
                                                   t.timerH = setTimeout(t.doAction, 10* 1000);\par
                                               \}\par
                                               else\par
                                               \{\par
                                                   //logit("enhance failed");\par
                                                   trActionLog('Enhance failed Throne room item '+unsafeWindow.kocThroneItems[eItem].name);\par
                                                   upgradeStats.enhanceFailure[y.quality][y.level]++;\par
                                                   y.level = rslt.item.level;\par
                                                   y.quality = rslt.item.quality;\par
                                                   y.status = rslt.item.status;\par
                                                   saveUpgradeStats();\par
                                                   if (rslt["break"]) \par
                                                   \{\par
                                                       y.isBroken = true;\par
                                                       y.brokenType = "quality";\par
                                                   \}\par
                                                   y.name = y.createName();\par
                                                   t.setResult("Enhance failed.  "  + addCommas(rslt.aetherstones) + " aetherstones used");\par
                                                   t.setStones(Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0]);\par
                                                   //t.setStatus("Starting repair ...");\par
                                                   var qItem = queueData.list[queueData.index];\par
                                                   if (qItem)  if (qItem.status == "not started") qItem.status = "started";\par
                                                   saveQueueData();\par
                                                   Tabs.upgrader.buildQueueDisplay();\par
                                                   clearTimeout(Tabs.upgrader.timerH);\par
                                                   Tabs.upgrader.timerH = setTimeout(t.doAction, 10*1000);\par
                                                   //t.doRepair(y.id);\par
                                               \}\par
                                               unsafeWindow.cm.ThroneView.renderInventory(unsafeWindow.kocThroneItems);\par
                                               if (rslt.heatupModifier) unsafeWindow.cm.HeatUpModel.attemptCallback(+(rslt.heatupModifier));\par
                                           \}\par
                                           else\par
                                           \{\par
                                               logit("enhance error");\par
                                               logit("Enhance result:" + inspect (rslt, 3, 1));\par
                                               t.setStatus("Unable to enhance at this time ... waiting for next cycle");\par
\par
                                           \}\par
                                       \} catch (e) \{\par
                                           //logit("exception: " + inspect(e,3,1));\par
                                       \}\par
                                       return;\par
                                   \},\par
                                   onFailure: function (rst) \{\par
                                       logit("Enhance request error.  Waiting for next cycle.");\par
                                       t.setStatus("Unable to send enhance request.  Waiting for next cycle");\par
                                       logit("result: " + inspect(rst,3,1));\par
                                       // try to repair item\par
                                       //t.doRepair(y.id);\par
                                       \par
                                       return;\par
                                   \}\par
                               \});\par
                           \} catch (e) \{\par
                               //logit("exception");\par
                               //logit ("exception: "+ inspect(e,5,2,true));\par
                               \par
                           \}\par
                           return;\par
                       \},\par
\par
\par
                       doUpgrade : function(uItem, bypass) \{\par
                           var t = Tabs.upgrader;\par
                           var y = unsafeWindow.kocThroneItems[uItem];\par
                           if ( uItem ==0 || y == null)\par
                           \{\par
                               t.setStatus("Item not found.");\par
                               return;\par
                           \}\par
                           \par
                           if ( (upgradeData.active == false) && (bypass !=true))\par
                           \{\par
                              t.setStatus("Powered off.");\par
                              return;\par
                           \}\par
\par
                           if (y.isBroken)\par
                           \{\par
                               // repair and then try again later\par
                               t.doRepair(uItem);\par
                               return;\par
                           \}\par
\par
                           var num_city = t.pickCity();\par
                           if ( num_city < 0)\par
                           \{\par
                               t.setStatus("Not enough aetherstones to upgrade.  Minimum of " + upgradeData.minStones + " needed.  Waiting for more ...");\par
                               return;\par
                           \}\par
\par
                           var t_city = unsafeWindow.currentcityid;\par
                           unsafeWindow.currentcityid = Seed.cities[num_city][0];\par
                           var w = unsafeWindow.cm.ThronePanelController.calcCost("upgrade", y, null, "stones");\par
                           unsafeWindow.currentcityid = t_city;\par
\par
                           if ( (w.gems.use > 0) || (w.stones.total > Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0] ))\par
                           \{\par
                               t.setStatus("Not enough aetherstones to upgrade.");\par
                               return; \par
                           \}\par
                           \par
                           if (bypass != true)\par
                           \{\par
                               var qI = queueData.list[queueData.index];\par
                               if (qI)\par
                               \{\par
                                   qI.triesTotal++;\par
                                   qI.triesThis++;\par
                               \}\par
\par
                               t.setStatus("Sending upgrade request ...");\par
                           \}\par
                           \par
                           var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);\par
                           params.ctrl = 'throneRoom\\\\ThroneRoomServiceAjax';\par
                           params.action = 'upgradeLevel';\par
                           params.throneRoomItemId = uItem;\par
                           params.buffItemId = 0;\par
                           params.payment = "aetherstone";\par
                           params.cityId = Seed.cities[num_city][0];\par
\par
                           new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/_dispatch53.php" + unsafeWindow.g_ajaxsuffix, \{\par
                               method: "post",\par
                               parameters: params,\par
                               loading: true,\par
                               onSuccess: function (transport) \{\par
                                   try \{\par
                                   //logit("upgrade success");\par
                                   //logit("transport: " + inspect(transport,3,1));\par
                                   var rslt = eval("(" + transport.responseText + ")");\par
                                   //logit("rslt: " + inspect(rslt,3,1));\par
                                   if(rslt.ok)\{\par
                                       Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0] -= rslt.aetherstones;\par
                                       if (rslt.gems > 0)\par
                                       \{\par
                                           t.setStatus("Error .... Shutting down.");\par
                                           trActionLog('Upgrader accidentally spent gems!  Upgrader turned off');\par
                                           upgradeData.active = false;\par
                                           saveUpgradeData();\par
                                       \}\par
\par
                                       if (rslt.success)\par
                                       \{\par
                                           //logit("upgrade successful");\par
                                           t.setStones(Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0]);\par
                                           y.level = rslt.item.level;\par
                                           y.quality = rslt.item.quality;\par
                                           y.name = y.createName();\par
                                           \par
                                           if (bypass !=true)\par
                                           \{\par
                                               upgradeStats.upgradeSuccess[y.quality][y.level]++;\par
                                               saveUpgradeStats();\par
                                               Tabs.upgrader.repaint();\par
                                               \par
                                               t.setResult("Upgrade successful.  "  + addCommas(rslt.aetherstones) + " aetherstones used.");\par
                                               t.setStatus("Attempting next upgrade");\par
                                               unsafeWindow.cm.sounds.play("tr_success_build");\par
\par
                                               var qItem = queueData.list[queueData.index];\par
                                               if (qItem) \{\par
                                                   var now = new Date();\par
                                                   qItem.lastUpgrade = "Upgraded to +" + y.level + " " + now.toDateString().substring(3,10) + " "+ now.toTimeString().substring(0,8) + " in " + qItem.triesThis + " attempts";\par
                                                   \par
                                                   if (!qItem.upgrades) qItem.upgrades = [];\par
                                                   qItem.upgrades.push (qItem.lastUpgrade);\par
\par
                                                   var msg = 'Upgraded '+unsafeWindow.kocThroneItems[uItem].name + ' to level ' + rslt.item.level + " in " + qItem.triesThis + " attempts. " + qItem.triesTotal + " total attempts for this item.";\par
                                                   if (upgradeData.whisperToMe) sendChat("/"+ Seed.player.name +' ' + msg);\par
                                                   trSuccessLog(msg);\par
                                                   if (qItem.level <= y.level) \{\par
                                                       qItem.status = "complete";\par
                                                       upgradeData.newUpgradeState =2;\par
                                                   \}\par
                                                   else \{\par
                                                       var now = new Date();\par
                                                       qItem.status = "Partially upgraded";\par
                                                       qItem.triesLast = qItem.triesThis;\par
                                                       qItem.triesThis = 0;\par
                                                       if (upgradeData.newUpgradeState !=2) upgradeData.newUpgradeState = 1;\par
                                                   \}\par
                                                   saveUpgradeData();\par
                                                   setUpgradeColor();\par
                                               \}\par
                                               saveQueueData();\par
                                               Tabs.upgrader.buildQueueDisplay();\par
                                               clearTimeout(Tabs.upgrader.timerH);\par
                                               Tabs.upgrader.timerH = setTimeout(Tabs.upgrader.doAction, 10* 1000);\par
                                           \}\par
                                       \}\par
                                       else\par
                                       \{\par
                                           //logit("upgrade failed");\par
                                           t.setStones(Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0]);\par
                                           trActionLog('Upgrade failed Throne room item '+unsafeWindow.kocThroneItems[uItem].name);\par
                                           if (rslt["break"]) \{\par
                                              y.isBroken = true;\par
                                              y.brokenType = "level";\par
                                           \}\par
                                           y.status = rslt.item.status;\par
                                           y.name = y.createName();\par
                                           if (bypass !=true)\par
                                           \{\par
                                               upgradeStats.upgradeFailure[y.quality][y.level]++;\par
                                               saveUpgradeStats();\par
                                               t.setResult("Upgrade failed.  "  + addCommas(rslt.aetherstones) + " aetherstones used");\par
                                               \par
                                               //t.setStatus("Starting repair ... ");\par
                                               var qItem = queueData.list[queueData.index];\par
                                               if (qItem.status == "not started") qItem.status = "started";\par
                                               saveQueueData();\par
                                               Tabs.upgrader.buildQueueDisplay();\par
                                               //t.doRepair(uItem);  // fix item\par
                                               clearTimeout(Tabs.upgrader.timerH);\par
                                               Tabs.upgrader.timerH = setTimeout(Tabs.upgrader.doAction, 10*1000);\par
                                           \}\par
                                       \}\par
                                       unsafeWindow.cm.ThroneView.renderInventory(unsafeWindow.kocThroneItems);\par
                                       if (rslt.heatupModifier) unsafeWindow.cm.HeatUpModel.attemptCallback(+(rslt.heatupModifier));\par
                                       return;\par
                                   \}\par
                                   else\par
                                   \{\par
                                       if (bypass !=true) t.setStatus("Upgrade request not accepted.  Waiting for next cycle.");\par
                                       logit("Upgrade result:" + inspect (rslt, 3, 1));\par
                                       \par
                                   \}\par
                                   \} catch (e) \{\par
                                       //logit("Exception: " + inspect(e,3,1));\par
                                   \}\par
                                   return;\par
                               \},\par
                               onFailure: function (rrr) \{\par
                                   t.setStatus("Unable to transmitt upgrade request.  Waiting for next cycle.");\par
                                   unsafeWindow.cm.ThroneView.renderInventory(unsafeWindow.kocThroneItems);\par
                                   \par
                                   logit("RRR: " + inspect(rrr,3,1));\par
                                   \par
                                   return;\par
                               \}\par
                           \});\par
\par
                           return;\par
                       \},\par
\par
                       addQueue : function () \{\par
                           var t = Tabs.upgrader;\par
\par
                           var action = $("#trAction").val();\par
\par
                           if (action == "both") \{\par
                               t.addBothItem($("#trUpgradeList").val());\par
                               return;\par
                           \}\par
\par
                           var qItem = new QueueItem();\par
                           qItem.item   = $("#trUpgradeList").val();\par
                           qItem.action = $("#trAction").val();\par
                           qItem.level  = $("#trMaxLevel").val();\par
\par
                           if (qItem.item == 0) return;\par
\par
                           queueData.list.push(qItem);\par
                           saveQueueData();\par
                           t.buildQueueDisplay();\par
                       \},\par
\par
                       buildLevelWidget : function () \{\par
                           var t = Tabs.upgrader;\par
                           var m;\par
                           if ($("#trAction").val() == "enhance") \{\par
                               m = '<div id=trMaxDiv> Max: <select id="trMaxLevel">';\par
                               for (i =1; i <=5; i++) \{\par
                                   m  += '<option value="' + i + '">' + t.qualities[i] + '</option>';\par
                               \}\par
                               m += '</select></div>';\par
                           \} else if ($("#trAction").val() == "upgrade") \{\par
                               m = '<div id=trMaxDiv> Max: <select id="trMaxLevel">';\par
                               for (i =1; i <=10; i++) \{\par
                                   m  += '<option value="' + i + '"> +' + i + '</option>';\par
                               \}\par
                               m += '</select></div>';\par
                           \} else \{\par
                               m =  '<div id=trMaxDiv> - <select id="trMaxLevel">';\par
                               m += '</select></div>';\par
                           \}\par
\par
                           $("#trMaxDiv").html(m);\par
                           if ($("#trAction").val() == "enhance") \{\par
                               $("#trMaxLevel").val(5);\par
                           \} else if ($("#trAction").val() == "upgrade") \{\par
                               $("#trMaxLevel").val(10);\par
                           \}\par
\par
                       \},\par
\par
                       buildQueueDisplay : function () \{\par
                           var t = Tabs.upgrader;\par
                           $("#trQueue").html("<table id='trQueue' width='100%' class=trTabPad/>");\par
                           $("#trQueue").append("<tr><th width=5%>Reorder</th><th width='8%'>Status</th><th width='25%'>Item</th><th width='5%'>Action</th><th width='5%'>Max</th><th width='40%'>Status/Last Upgrade/Attempts</th><th width='10%'>Remove</th></tr>");\par
\par
                           for (ii in queueData.list) \{\par
                               var q = queueData.list[ii];\par
                               if (!q) continue;\par
                               var the_item = unsafeWindow.kocThroneItems[q.item];\par
\par
                               var name = "Unknown / Item removed";\par
\par
                               if (the_item)\par
                                   name = the_item.name;\par
\par
                               var m = "<tr><td><div class='trup' id=trUpRow" + ii +" /><div class='trdown'  id=trDownRow" + ii +" /></td>"\par
                               +   "<td><div id=trState" + ii +"></div></td><td>"\par
                               + name + "</td><td>" + q.action + "</td><td>";\par
\par
                               if (q.action =="enhance") \{\par
                                   m += '<div style="text-align: center;"><select id="trChangeLevel' + ii +'" style="width:90px; text-align: center;">';\par
                                   for (i =1; i <=5; i++) \{\par
                                       m  += '<option value="' + i + '" '+ (q.level==i ? 'selected' : '' ) +'>' + t.qualities[i] + '</option>';\par
                                   \}\par
                                   m += '</select></div>';\par
                               \} else \{\par
                                   m += '<div  style="text-align: center;"><select id="trChangeLevel' + ii +'" style="width:90px; text-align: center;">';\par
                                   for (i =1; i <=10; i++) \{\par
                                       m  += '<option value="' + i + '"  '+ (q.level==i ? 'selected' : '' ) +'> +' + i + '</option>';\par
                                   \}\par
                                   m += '</select></div>';\par
                               \}\par
\par
                               m += "</td><td style='text-align: center; white-space: pre-wrap;'>" + q.status + " / ";\par
                               if (q.lastUpgrade) m += q.lastUpgrade;\par
\par
                               m += " / " + q.triesThis + " tries this level, " + q.triesTotal + " tries total"\par
\par
                               m += "</td>";\par
                               m += "<td><div><div id=trQueueRemove" + ii + " class=trremove/></div></td></tr>";       \par
\par
                               $("#trQueue").append(m);\par
                           \}\par
\par
                           for (var j=0; j < queueData.list.length; j++)\par
                           \{ \par
                               var q = queueData.list[j];\par
                               if (!q) continue;\par
                               var the_item = unsafeWindow.kocThroneItems[q.item];\par
\par
                               $("#trQueueRemove"+j).attr('v1', j);  \par
                               $("#trQueueRemove"+j).click( function () \{t.deleteQueueItem( $(this).attr('v1') );\});\par
\par
                               $("#trUpRow"+j).attr('v1', j);  \par
                               $("#trUpRow"+j).click( function () \{ t.moveUpRow(+($(this).attr('v1') ));\});\par
\par
                               $("#trDownRow"+j).attr('v1', j);  \par
                               $("#trDownRow"+j).click( function () \{ t.moveDownRow(+($(this).attr('v1') ));\});\par
\par
                               $("#trChangeLevel"+j).attr('v1', j);  \par
                               $("#trChangeLevel"+j).change( function () \{ t.changeLevel(+($(this).attr('v1') ), $(this).val() ) \});\par
\par
                               if (!the_item || !(the_item.id)) \{\par
                                   $("#trState"+j).html("<div style='text-align:center'> ??</div>");\par
                               \} else if (q.status == "complete") \{\par
                                   $("#trState"+j).addClass('trsuccess');\par
                               \} else if (the_item.isBroken) \{\par
                                   if (the_item.id == t.repairId) \{\par
                                       $("#trState"+j).addClass('trhammer');\par
                                   \} else \{ \par
                                       $("#trState"+j).addClass('trbroken');\par
                                   \}\par
                               \} else \{\par
                                   $("#trState"+j).html("<div class='trgbtn'/>");\par
                                   $("#trState"+j).css('text-align', 'center');\par
                               \}\par
                           \}\par
\par
                       \},\par
\par
                       deleteQueueItem : function (i) \{\par
                           // delete an item from the queue\par
                           var t = Tabs.upgrader;\par
                           queueData.list.splice(i,1);\par
                           if (i > queueData.index) queueData.index--;\par
                           saveQueueData();\par
                           t.buildQueueDisplay();  \par
                       \},\par
\par
                       changeLevel : function (index, level) \{\par
                           var t = Tabs.upgrader;\par
\par
                           var q = queueData.list[index];\par
                           if (!q) return;\par
\par
                           q.level = level;\par
                           saveQueueData();\par
                           t.buildQueueDisplay();\par
                       \},\par
\par
                       moveUpRow : function (i) \{\par
                           if (i<1) return;\par
                           var t = Tabs.upgrader;\par
                           var q = queueData.list.splice(i,1);\par
                           queueData.list.splice(i-1,0,q[0]);\par
\par
                           if (i == queueData.index)\par
                               queueData.index--;\par
                           else if (queueData.index == i-1)\par
                               queueData.index++;\par
\par
                           saveQueueData();\par
                           t.buildQueueDisplay();\par
                       \},\par
\par
                       moveDownRow : function (index) \{\par
                           if (index > (queueData.list.length - 2)) return;\par
\par
                           var t = Tabs.upgrader;\par
                           var q = queueData.list.splice(index,1);\par
                           queueData.list.splice(index+1,0,q[0]);\par
\par
                           /*\par
            $($("#trQueue")[0].rows[i])\par
                .find('td')\par
                .wrapInner('<div style="display: none;" />')\par
                .parent()\par
                .find('td > div')\par
                .slideDown(700, function()\{\par
                    var $set = $(this);\par
                    $set.replaceWith($set.contents());\par
                \});\par
                            */\par
\par
                           /*\par
\par
            $($("#trQueue")[0].rows[i])\par
             .find('tr div')\par
            .slideDown(700);\par
                            */\par
\par
\par
                           if (i == queueData.index)\par
                               queueData.index++;\par
                           else if (queueData.index == i+1)\par
                               queueData.index--;\par
\par
                           saveQueueData();\par
                           t.buildQueueDisplay();\par
\par
                       \},\par
                       \par
                       updateTRTab : function() \{\par
                           $("#trexecupgrade").html("Upgrade " + (upgradeData.active ? "ON" : "OFF"));\par
                       \},\par
                       \par
                       togglePower: function(obj)\{\par
                           var t = Tabs.upgrader;\par
                           var btn = document.getElementById('trUpgraderPower');\par
                           if (upgradeData.active == true) \{\par
                               upgradeData.active = false;\par
                               btn.value = "Upgrade = OFF";\par
                               t.setStatus("Powered off");\par
\par
                           \} else \{\par
                               upgradeData.active = true;\par
                               btn.value = "Upgrade = ON";\par
                               t.setStatus("Power on");\par
                           \}\par
                           \par
                           if (upgradeData.active == false)\par
                           \{\par
                           \}\par
                           t.updateTRTab();\par
                           saveUpgradeData();\par
                       \},\par
                       \par
                       toggleSelect: function(obj)\{\par
                           var btn = document.getElementById('trUpgraderSelect');\par
                           var t = Tabs.upgrader;\par
                           if (upgradeData.enhanceAction == true) \{\par
                               upgradeData.enhanceAction = false;\par
                               btn.value = "Action = Upgrade";\par
                           \} else \{\par
                               upgradeData.enhanceAction = true;\par
                               btn.value = "Action = Enhance";\par
                           \}\par
                           t.updateTRSelect();\par
                           saveUpgradeData();\par
                       \},\par
\par
                       setStatus : function (s)\par
                       \{\par
                           document.getElementById('trUpgradeStatus').innerHTML = "<div>" + s + "</div>";\par
                       \},\par
\par
                       setResult : function (s)\par
                       \{\par
                           document.getElementById('trLastResult').innerHTML = "<div>" + s + "</div>";\par
                       \},\par
\par
                       setStones : function(n)\par
                       \{\par
                           var st = addCommas(n) + " stones";\par
                           document.getElementById('trStoneRemain').innerHTML = "<div>" + st + "</div>";\par
                       \},\par
\par
                       pickCity : function () \{\par
                           var t = Tabs.upgrader;\par
                           var cid = upgradeData.uCityNum;\par
                           if ( Seed.resources["city" + Seed.cities[cid][0]]["rec5"][0] >= upgradeData.minStones) return cid;\par
\par
                           if (upgradeData.anyCity)\par
                           \{\par
                               for (i= 0; i < Seed.cities.length; i++)\par
                               \{\par
                                   if ( Seed.resources["city" + Seed.cities[i][0]]["rec5"][0] >= upgradeData.minStones) return i;\par
                               \}\par
                           \}\par
                           return -1;\par
                       \},\par
\par
\par
                       doRepair : function( rItem) \{\par
                           var t = Tabs.upgrader;\par
                           var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);\par
\par
                           if (upgradeData.active == false || rItem == 0 || unsafeWindow.kocThroneItems[rItem] == null)\par
                           \{\par
                               logit("repair is turned off");\par
                               return;\par
                           \}\par
                           var theItem = unsafeWindow.kocThroneItems[rItem];\par
\par
                           params.action = 'timeRepair';\par
                           params.throneRoomItemId = rItem;\par
                           params.ctrl = 'throneRoom\\\\ThroneRoomServiceAjax';\par
                          \par
                           new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/_dispatch53.php" + unsafeWindow.g_ajaxsuffix, \{\par
                               method: "post",\par
                               parameters: params,\par
                               loading: true,\par
                               onSuccess: function (transport) \{\par
                                   //logit("repair success");\par
                                   //logit("tport: " + inspect(transport,3,1));\par
                                   var rslt = eval("(" + transport.responseText + ")");\par
                                   //logit("rslt: " + inspect(rslt,3,1));\par
                                   if(rslt.ok)\{\par
                                       trActionLog('Starting repair for Throne room item '+unsafeWindow.kocThroneItems[rItem].name);\par
                                       Seed.queue_throne.itemId= rItem;\par
                                       Seed.queue_throne.start=unixTime();\par
                                       Seed.queue_throne.end= rslt.eta;\par
                                       t.repairId = rItem;\par
                                       t.repairEnd = rslt.eta;\par
                                       var n = new Date(t.repairEnd *1000);\par
                                       t.setStatus("Repair begun ... Repair will be complete at " + n.toLocaleTimeString() + ". Item: "  + unsafeWindow.kocThroneItems[t.repairId].name);\par
                                       var x = rslt.eta - unixTime();\par
                                       unsafeWindow.cm.ThroneView.renderInventory(unsafeWindow.kocThroneItems);\par
                                       t.clearTimerH = setTimeout(t.clearRepair, (x+1)*1000);\par
                                       var item = unsafeWindow.kocThroneItems[rItem];\par
                                       Tabs.upgrader.buildQueueDisplay();\par
                                       // uW.cm.ThronePanelView.clickSpeedUp(item);\par
                                   \}\par
                                   else\par
                                   \{\par
                                       logit ("Repair failed");\par
                                       if (rslt.msg == "Item is not broken")\par
                                       \{\par
                                           unsafeWindow.kocThroneItems[rItem].isBroken = false;\par
                                           t.clearRepair();\par
                                       \}\par
                                       \par
                                       // regrab the end times in case this is caused by a manual repair\par
                                       if (Seed.queue_throne && Seed.queue_throne.Seed.queue_throne && Seed.queue_throne.Seed.queue_throne.end)\par
                                       \{\par
                                           t.repairEnd = Seed.queue_throne.end;\par
                                           t.repairId = Seed.queue_throne.itemId;\par
                                       \}\par
                                       logit("result:" + inspect(rslt,3,1));\par
                                   \}\par
                                   return;\par
                               \},\par
                               onFailure: function (ttt) \{\par
                                   logit("repair error");\par
                                   // this usually means a repair is in progress (such as a\par
                                   // manual\par
                                   // repair). Grab the seed data (if possible)\par
                                   if (Seed.queue_throne && Seed.queue_throne.Seed.queue_throne.end)\par
                                   \{\par
                                       t.repairEnd = Seed.queue_throne.end;\par
                                       t.repairId = Seed.queue_throne.itemId;\par
                                   \}\par
                                   logit("ttt: " + inspect(ttt,3,1));\par
                                   return;\par
                               \}\par
                           \});\par
                           return;\par
                       \},\par
\par
                       clearRepair : function () \{\par
                           var t = Tabs.upgrader;\par
                           var timeUntilDone = 0;\par
\par
                           if (t.repairEnd == 0)\par
                           \{\par
                               return timeUntilDone;\par
                           \}\par
                           timeUntilDone = t.repairEnd - unixTime();\par
\par
                           if (timeUntilDone <= 0)\par
                           \{\par
                               // logit("clearing repair");\par
                               if (t.repairId != 0 && unsafeWindow.kocThroneItems[t.repairId]  != null)\par
                               \{\par
                                   if (unsafeWindow.kocThroneItems[t.repairId].isBroken == true)\par
                                   \{\par
                                       t.setStatus("Repair time complete.");\par
                                   \}\par
                                   unsafeWindow.kocThroneItems[t.repairId].isBroken = false;\par
                                   unsafeWindow.kocThroneItems[t.repairId].brokenType = "";\par
                                   t.repairId = 0;\par
                               \}\par
\par
                           \}\par
                           unsafeWindow.cm.ThroneView.renderInventory(unsafeWindow.kocThroneItems);\par
                           return timeUntilDone;\par
                       \},\par
\par
                       show: function()\{\par
                           Tabs.upgrader.repaint();\par
                       \},\par
\par
                       hide: function()\{\par
                       \}\par
\};\par
\par
\par
/** ***************** Throne Enhancing Stats ********************* */\par
\par
Tabs.estats = \{\par
        tabOrder: 300,\par
        tabLabel: 'Enhance Stats',\par
        tabDisabled : false,\par
        myDiv : null,\par
\par
        init : function (div)\{\par
            var t = Tabs.estats;\par
            t.myDiv = div;\par
            t.buildDisplay();\par
        \},\par
\par
        buildDisplay :function()   \{\par
            var t = Tabs.estats;\par
            var m = '<DIV class=trstat style="margin-top:5px; margin-bottom:5px;"><DIV id=trStatsMain class=trStat>ENHANCEMENT STATISTICS</div>';\par
            m += '<DIV id= trStatsTabDiv align=left style="margin-top:10px; margin-bottom:10px; margin-left: 30px;">';\par
            m += '<TABLE class=trStatTab align=center cellspacing=0>';\par
\par
            m += '<TR valign=top align=center><TH colspan=6>Enhancing Numbers  (successes/failures)</TH></TR>';\par
\par
            var qstrings = new Array(uW.g_js_strings.throneRoom.simple,  uW.g_js_strings.throneRoom.common, uW.g_js_strings.throneRoom.uncommon,\par
                    uW.g_js_strings.throneRoom.rare,    uW.g_js_strings.throneRoom.epic,   uW.g_js_strings.throneRoom.wondrous);\par
\par
\par
            m += '<TR valign=top align=center><th></th>';\par
            for( q =1; q <=5; q++)\par
            \{\par
                m += "<td style='font-weight: bold;' class='td" + (q%2+1) +"'  >";\par
                m += qstrings[q];\par
                m += '</td>';\par
            \}\par
\par
            m += '</tr>';\par
\par
\par
            var st = [0,0,0,0,0];\par
            var ft = [0,0,0,0,0];\par
\par
            for (l=0; l<=10; l++)\par
            \{\par
                m += '<TR valign=top align=center>';\par
                m += "<th>";\par
                if (l !=0) m += "+";\par
                m+=  l + '</th>';\par
                for( q =0; q <5; q++)\par
                \{\par
                    if (upgradeStats.enhanceSuccess[q][l] == null) upgradeStats.enhanceSuccess[q][l] =0;\par
                    if (upgradeStats.enhanceFailure[q][l] == null) upgradeStats.enhanceFailure[q][l] =0;\par
                    st[q] += upgradeStats.enhanceSuccess[q][l];\par
                    ft[q] += upgradeStats.enhanceFailure[q][l];\par
\par
                    m += "<td class='td" + (q%2) +"'  >";\par
                    m += upgradeStats.enhanceSuccess[q][l] + " / " + upgradeStats.enhanceFailure[q][l];\par
                    m += "</td>";\par
                \}\par
                m += '</TR>';\par
            \}\par
\par
            m += '<TR valign=top align=center><th> Totals: </th>';\par
            for( q =0; q <5; q++)\par
            \{\par
                m += "<td style='font-weight: bold;' class='td" + (q%2) +"'  >";\par
                m += st[q] + " / " + ft[q];\par
                m += "</td>";\par
            \}\par
            m += '</TR>';\par
\par
            m += '<TR valign=top align=center><th> Percents: </th>';\par
            for( q =0; q <5; q++)\par
            \{\par
                m += "<td style='font-weight: bold;' class='td" + (q%2) +"'  >";\par
                if ( (st[q] + ft[q]) == 0 )\par
                    m += "--";\par
                else\par
                \{\par
                    var p = (100* st[q] / (st[q] + ft[q]));\par
                    m += p.toFixed(2) + "%";\par
                \}\par
                m += "</td>";\par
            \}\par
            m += '</TR>';\par
\par
            m += '</TABLE></DIV>';\par
\par
            m += "<div id='trStats'></div>";\par
            m += '</div>';\par
            t.myDiv.innerHTML = m;\par
        \},\par
\par
        show: function()\{\par
            var t = Tabs.estats;\par
            t.buildDisplay();\par
        \},\par
\par
        hide: function()\{\par
        \}\par
\}\par
\par
/** ***************** Throne Upgrade Stats ********************* */\par
\par
Tabs.ustats = \{\par
        tabOrder: 400,\par
        tabLabel: 'Upgrade Stats',\par
        tabDisabled : false,\par
        myDiv : null,\par
\par
        init : function (div)\{\par
            var t = Tabs.ustats;\par
            t.myDiv = div;\par
            t.buildTab();\par
        \},\par
\par
        buildTab : function ()\par
        \{\par
            var t = Tabs.ustats;\par
            var m = '<DIV class=trstat style="margin-top:5px; margin-bottom:5px;"><DIV id=trStatsMain2 class=trStat>UPGRADE STATISTICS</div>';\par
            m += '<DIV id= trStatsTabDiv2 align=left style="margin-top:10px; margin-bottom:10px; margin-left: 30px;">';\par
            m += '<TABLE class=trStatTab align=center cellspacing=0>';\par
\par
            m += '<TR valign=top align=center><TH colspan=12>Upgrading Numbers  (successes/failures)</TH></TR>';\par
\par
            var qstrings = new Array(uW.g_js_strings.throneRoom.simple,  uW.g_js_strings.throneRoom.common, uW.g_js_strings.throneRoom.uncommon,\par
                    uW.g_js_strings.throneRoom.rare,    uW.g_js_strings.throneRoom.epic,   uW.g_js_strings.throneRoom.wondrous);\par
\par
\par
            m += '<TR valign=top align=center><th></th>';\par
\par
            for (l= 0; l<10; l++)\par
            \{\par
                m += "<td style='font-weight: bold;' class='td" + (l%2) +"'  >";\par
                m+= "+" +(l+1) + "</td>";\par
            \}\par
            m += '</TR>';\par
            var st = [0,0,0,0,0,0,0,0,0,0,0];\par
            var ft = [0,0,0,0,0,0,0,0,0,0,0];\par
\par
            for( q =0; q <=5; q++)\par
            \{\par
                m += '<TR valign=top align=center><th>' + qstrings[q] + '</th>';\par
                for (l=0; l<10; l++)\par
                \{\par
                    if (upgradeStats.upgradeSuccess[q][l] == null) upgradeStats.upgradeSuccess[q][l] =0;\par
                    if (upgradeStats.upgradeFailure[q][l] == null) upgradeStats.upgradeFailure[q][l] =0;\par
                    st[l] += upgradeStats.upgradeSuccess[q][l];\par
                    ft[l] += upgradeStats.upgradeFailure[q][l];\par
\par
                    m += "<td class='td" + (l%2) +"'  >";\par
                    m += upgradeStats.upgradeSuccess[q][l] + " / " + upgradeStats.upgradeFailure[q][l];\par
                    m += "</td>";\par
                \}\par
                m += '</TR>';\par
            \}\par
\par
            m += '<TR valign=top align=center><th> Totals: </th>';\par
            for( l =0; l<10; l++)\par
            \{\par
                m += "<td style='font-weight: bold;' class='td" + (l%2) +"'  >";\par
                m += st[l] + " / " + ft[l];\par
                m += "</td>";\par
            \}\par
            m += '</TR>';\par
\par
            m += '<TR valign=top align=center><th> Percents: </th>';\par
            for( l =0; l <10; l++)\par
            \{\par
                m += "<td style='font-weight: bold;' class='td" + (l%2) +"'  >";\par
                if ( (st[l] + ft[l]) == 0 )\par
                    m += "--";\par
                else\par
                \{\par
                    var p = (100* st[l] / (st[l] + ft[l]));\par
                    m += p.toFixed(2) + "%";\par
                \}\par
                m += "</td>";\par
            \}\par
            m += '</TR>';\par
\par
            m += '</TABLE></DIV>';\par
\par
            m += "<div id='trStats2'></div>";\par
            m += '</div>';\par
            t.myDiv.innerHTML = m;\par
        \},\par
\par
        show: function()\{\par
            var t = Tabs.ustats;\par
            t.buildTab();\par
        \},\par
\par
        hide: function()\{\par
        \}\par
\}\par
\par
function findTab(div) \{\par
    for (o in Tabs)\par
    \{\par
        if (Tabs[o].myDiv && (Tabs[o].myDiv == div)) return o;\par
    \}\par
    return null;\par
\}\par
\par
var WinManager = \{\par
        wins : \{\},    // prefix : trPopup obj\par
        didHide : [],\par
\par
        get : function (prefix)\{\par
            var t = WinManager;\par
            return t.wins[prefix];\par
        \},\par
\par
        add : function (prefix, pop)\{\par
            var t = WinManager;\par
            t.wins[prefix] = pop;\par
            if (unsafeWindow.cpopupWins == null)\par
                unsafeWindow.cpopupWins = \{\};\par
            unsafeWindow.cpopupWins[prefix] = pop;\par
        \},\par
\par
        hideAll : function ()\{\par
            var t = WinManager;\par
            t.didHide = [];\par
            for (k in t.wins)\{\par
                if (t.wins[k].isShown())\{\par
                    t.didHide.push (t.wins[k]);\par
                    t.wins[k].show (false);\par
                \}\par
            \}\par
        \},\par
        restoreAll : function ()\{\par
            var t = WinManager;\par
            for (var i=0; i<t.didHide.length; i++)\par
                t.didHide[i].show (true);\par
        \},\par
\par
        deleteWin : function (prefix)\{\par
            var t = WinManager;\par
            delete t.wins[prefix];\par
            delete unsafeWindow.cpopupWins[prefix];\par
        \}\par
\}\par
\par
\par
// registers the popup\par
//prefix must be a unique (short) name for the popup window\par
function trPopup(prefix) \{\par
    var pop = WinManager.get(prefix);\par
    if (pop)\{\par
        pop.show(false);\par
        return pop;\par
    \}\par
    \par
    // this.BASE_ZINDEX = 100402; // value should put it in front of the TR and\par
    // behind the salvage popup\par
    this.BASE_ZINDEX = 111111;\par
\par
    // protos ...\par
    this.show = show;\par
    this.getTopDiv = getTopDiv;\par
    this.getMainTopDiv = getMainTopDiv;\par
    this.getMainDiv = getMainDiv;\par
    this.getLayer = getLayer;\par
    this.setLayer = setLayer;\par
    //this.getLocation = getLocation;\par
    //this.setLocation = setLocation;\par
    this.focusMe = focusMe;\par
    this.isShown = isShown;\par
    this.unfocusMe = unfocusMe;\par
    this.destroy = destroy;\par
\par
    // object vars ...\par
    this.div = $("#tr_top")[0];\par
    this.prefix = prefix;\par
\par
    var t = this;   \par
    this.div.addEventListener ('mousedown', e_divClicked, false);\par
    WinManager.add(prefix, this);\par
\par
    function e_divClicked ()\{\par
        t.focusMe();\par
    \}\par
  \par
    \par
    function focusMe ()\{\par
        t.setLayer(5);\par
        for (k in unsafeWindow.cpopupWins)\{\par
            if (k != t.prefix)\par
                unsafeWindow.cpopupWins[k].unfocusMe();\par
        \}\par
    \}\par
    \par
    function unfocusMe ()\{\par
        t.setLayer(-5);\par
    \}\par
    \par
    \par
    function destroy ()\{\par
        document.body.removeChild(t.div);\par
        WinManager.deleteWin (t.prefix);\par
    \}\par
    \par
    function setLayer(zi)\{\par
        t.div.style.zIndex = ''+ (this.BASE_ZINDEX + zi);\par
    \}\par
    function getLayer()\{\par
        return parseInt(t.div.style.zIndex) - this.BASE_ZINDEX;\par
    \}\par
    function getTopDiv()\{\par
        return document.getElementById(this.prefix+'_top');\par
    \}\par
    function getMainDiv()\{\par
        return document.getElementById(this.prefix+'_main');\par
    \}\par
    function getMainTopDiv()\{\par
        return document.getElementById(this.prefix+'_top');\par
    \}\par
    function isShown ()\{\par
        return $("#tr_dialog").dialog("isOpen");\par
    \}\par
    function show(tf)\{\par
        if (tf)\{\par
            $("#tr_dialog").dialog("open");\par
            t.focusMe ();\par
        \} else \{\par
            $("#tr_dialog").dialog("close");\par
        \}\par
        return tf;\par
    \}\par
\}\par
\par
//onClick (city\{name, id, x, y\}, x, y) city may be null!\par
function CdispCityPicker (id, span, dispName, notify, selbut)\{\par
    function CcityButHandler (t)\{\par
        var that = t;\par
        \par
        function clickedCityBut (e)\{\par
            if (that.selected != null)\par
                that.selected.className = "castleBut castleButNon";\par
            that.city = Cities.cities[e.target.id.substr(that.prefixLen)];\par
            if (that.dispName)\par
                document.getElementById(that.id+'cname').innerHTML = that.city.name;\par
            e.target.className = "castleBut castleButSel";\par
            that.selected = e.target;\par
            if (that.coordBoxX)\{\par
                that.coordBoxX.value = that.city.x;\par
                that.coordBoxY.value = that.city.y;\par
                var evt = document.createEvent("HTMLEvents");\par
                evt.initEvent('change', true, true ); // event\par
                // type,bubbling,cancelable\par
                that.coordBoxX.dispatchEvent(evt);\par
                that.coordBoxY.dispatchEvent(evt);\par
                that.coordBoxX.style.backgroundColor = '#ffffff';\par
                that.coordBoxY.style.backgroundColor = '#ffffff';\par
            \}\par
            if (that.notify != null)\par
                that.notify(that.city, that.city.x, that.city.y);\par
        \}\par
        \par
        this.clickedCityBut = clickedCityBut;\par
    \}\par
\par
    function selectBut (idx)\{\par
        document.getElementById(this.id+'_'+idx).click();\par
    \}\par
\par
    function bindToXYboxes (eX, eY)\{\par
        function CboxHandler (t)\{\par
            var that = t;\par
            this.eventChange = eventChange;\par
            if (that.city)\{\par
                eX.value = that.city.x;\par
                eY.value = that.city.y;\par
            \}\par
            function eventChange ()\{\par
                var xValue=that.coordBoxX.value.trim();\par
                var xI=/^\\s*([0-9]+)[\\s|,|-|.]+([0-9]+)/.exec(xValue);\par
                if(xI) \{\par
                    that.coordBoxX.value=xI[1]\par
                    that.coordBoxY.value=xI[2]\par
                \}\par
                var x = parseInt(that.coordBoxX.value, 10);\par
                var y = parseInt(that.coordBoxY.value, 10);\par
                if (isNaN(x) || x<0 || x>750)\{\par
                    that.coordBoxX.style.backgroundColor = '#ff8888';\par
                    return;\par
                \}\par
                if (isNaN(y) || y<0 || y>750)\{\par
                    that.coordBoxY.style.backgroundColor = '#ff8888';\par
                    return;\par
                \}\par
                that.coordBoxX.style.backgroundColor = '#ffffff';\par
                that.coordBoxY.style.backgroundColor = '#ffffff';\par
                if (that.notify != null)\par
                    that.notify (null, x, y);\par
            \}\par
            return false;\par
        \}\par
        this.coordBoxX = eX;\par
        this.coordBoxY = eY;\par
        var bh = new CboxHandler(this);\par
        eX.maxLength=8;\par
        eY.maxLength=3;\par
        eX.style.width='2em';\par
        eY.style.width='2em';\par
        eX.addEventListener('change', bh.eventChange, false);\par
        eY.addEventListener('change', bh.eventChange, false);\par
    \}\par
\par
    this.selectBut = selectBut;\par
    this.bindToXYboxes = bindToXYboxes;\par
    this.coordBoxX = null;\par
    this.coordBoxY = null;\par
    this.id = id;\par
    this.dispName = dispName;\par
    this.prefixLen = id.length+1;\par
    this.notify = notify;\par
    this.selected = null;\par
    this.city = null;\par
    var m = '';\par
    for (var i=0; i<Cities.cities.length; i++)\par
        m += '<INPUT class="castleBut castleButNon" id="'+ id +'_'+ i +'" value="'+ (i+1) +'" type=button />';\par
    if (dispName)\par
        m += ' &nbsp; <SPAN style="display:inline-block; width:85px; font-weight:bold;" id='+ id +'cname' +'></span>';\par
    span.innerHTML = m;\par
    var handler = new CcityButHandler(this);\par
    for (var i=0; i<Cities.cities.length; i++)\par
        document.getElementById (id+'_'+i).addEventListener('click', handler.clickedCityBut, false);\par
    if (selbut != null)\par
        this.selectBut(selbut);\par
\};\par
\par
function setCities()\{\par
    Cities.numCities = Seed.cities.length;\par
    Cities.cities = [];\par
    Cities.byID = \{\};\par
    for (i=0; i<Cities.numCities; i++)\{\par
        city = \{\};\par
        city.idx = i;\par
        city.id = parseInt(Seed.cities[i][0]);\par
        city.name = Seed.cities[i][1];\par
        city.x = parseInt(Seed.cities[i][2]);\par
        city.y = parseInt(Seed.cities[i][3]);\par
        city.tileId = parseInt(Seed.cities[i][5]);\par
        city.provId = parseInt(Seed.cities[i][4]);\par
        // getTroopDefTrainEstimates('city'+ city.id, city);\par
        Cities.cities[i] = city;\par
        Cities.byID[Seed.cities[i][0]] = city;\par
    \}\par
\}\par
\par
function addCommas(nStr)\{\par
    nStr += '';\par
    x = nStr.split('.');\par
    x1 = x[0];\par
    x2 = x.length > 1 ? '.' + x[1] : '';\par
    var rgx = /(\\d+)(\\d\{3\})/;\par
    while (rgx.test(x1)) \{\par
        x1 = x1.replace(rgx, '$1' + ',' + '$2');\par
    \}\par
    return x1 + x2;\par
\}\par
\par
/** *********** Updater code ************ */\par
//Function for displaying a confirmation message modal popup similar to the\par
//default javascript confirm() function\par
//but with the advantage being that it won't halt all other javascript being\par
//executed on the page.\par
//Original Author: Thomas Chapin (April 6, 2011)\par
function display_confirm(confirm_msg,ok_function,cancel_function)\{\par
    if(!confirm_msg)\{confirm_msg="";\}\par
\par
    var container_div = document.getElementById('modal_js_confirm');\par
    var div;\par
    if(!container_div) \{\par
        container_div=document.createElement('div');\par
        container_div.id='modal_js_confirm';\par
        container_div.style.position='absolute';\par
        container_div.style.top='0px';\par
        container_div.style.left='0px';\par
        container_div.style.width='100%';\par
        container_div.style.height='1px';\par
        container_div.style.overflow='visible';\par
        container_div.style.zIndex=2000005;\par
\par
        div=document.createElement('div');\par
        div.id='modal_js_confirm_contents';\par
        div.style.zIndex=2000005;\par
        div.style.backgroundColor='#eee';\par
        div.style.fontFamily='"lucida grande",tahoma,verdana,arial,sans-serif';\par
        div.style.fontSize='11px';\par
        div.style.textAlign='center';\par
        div.style.color='#333333';\par
        div.style.border='2px outset #666';\par
        div.style.padding='10px';\par
        div.style.position='relative';\par
        div.style.width='300px';\par
        div.style.height='100px';\par
        div.style.margin='300px auto 0px auto';\par
        div.style.display='block';\par
\par
        container_div.appendChild(div);\par
        document.body.appendChild(container_div);\par
\par
        div.innerHTML = '<div style="text-align:center"><div>'+confirm_msg+'</div><br/><div>Press OK to continue.</div><br><button id="modal_js_confirm_ok_button">OK</button> <button id="modal_js_confirm_cancel_button">Cancel</button></div>';\par
        var ok_button = document.getElementById('modal_js_confirm_ok_button');\par
        ok_button.addEventListener('click',function() \{\par
            if(ok_function && typeof(ok_function) == "function")\{\par
                ok_function();\par
            \}\par
            container_div.parentNode.removeChild(container_div);\par
        \},false);\par
        var cancel_button = document.getElementById('modal_js_confirm_cancel_button');\par
        cancel_button.addEventListener('click',function() \{\par
            if(cancel_function && typeof(cancel_function) == "function")\{\par
                cancel_function();\par
            \}\par
            container_div.parentNode.removeChild(container_div);\par
        \},false);\par
    \}\par
\}\par
\par
//The following code is released under public domain.\par
\par
var AutoUpdater_132329 = \{\par
        id: 132329,\par
        days: 1,   // check every 1 day\par
        name: "KOC Throne Room Organizer",\par
        version: Version,\par
        time: new Date().getTime(),\par
        call: function(response, secure) \{\par
            logit("checking version");\par
            GM_xmlhttpRequest(\{\par
                method: 'GET',\par
                url: 'http'+(secure ? 's' : '')+'://userscripts.org/scripts/source/'+this.id+'.meta.js',\par
                onload: function(xpr) \{AutoUpdater_132329.compare(xpr, response);\},\par
                onerror: function(xpr) \{if (secure) AutoUpdater_132329.call(response, false);\}\par
            \});\par
        \},\par
        enable: function() \{\par
            GM_registerMenuCommand("Enable "+this.name+" updates", function() \{\par
                GM_setValue('updated_132329', new Date().getTime()+'');\par
                AutoUpdater_132329.call(true, true)\par
            \});\par
        \},\par
        compareVersion: function(r_version, l_version) \{\par
            var r_parts = r_version.split(''),\par
            l_parts = l_version.split(''),\par
            r_len = r_parts.length,\par
            l_len = l_parts.length,\par
            r = l = 0;\par
            for(var i = 0, len = (r_len > l_len ? r_len : l_len); i < len && r == l; ++i) \{\par
                r = +(r_parts[i] || '0');\par
                l = +(l_parts[i] || '0');\par
            \}\par
            return (r !== l) ? r > l : false;\par
        \},\par
        compare: function(xpr,response) \{\par
            this.xversion=/\\/\\/\\s*@version\\s+(.+)\\s*\\n/i.exec(xpr.responseText);\par
            this.xname=/\\/\\/\\s*@name\\s+(.+)\\s*\\n/i.exec(xpr.responseText);\par
\par
            if ( (this.xversion) && (this.xname[1] == this.name) ) \{\par
                this.xversion = this.xversion[1];\par
                this.xname = this.xname[1];\par
            \} else \{\par
                if ( (xpr.responseText.match("the page you requested doesn't exist")) || (this.xname[1] != this.name) ) \{\par
                    // GM_setValue('updated_132329', 'off');\par
                \}\par
                return false;\par
            \}\par
\par
            var updated = this.compareVersion(this.xversion, this.version);\par
\par
            if ( updated ) \{\par
                display_confirm('A new version of '+this.xname+' is available.\\nDo you wish to install the latest version?',\par
                        // Ok\par
                        function()\{\par
                    try \{\par
                        location.href = 'https://userscripts.org/scripts/source/132329.user.js';\par
                    \} catch(e) \{\}\par
                \},\par
                // Cancel\par
                function()\{\par
                    if ( AutoUpdater_132329.xversion ) \{\par
                        if(confirm('Do you want to turn off auto updating for this script?')) \{\par
                            // GM_setValue('updated_132329', 'off');\par
                            TRGlobalOptions.trUpdate = false;\par
                            GM_setValue ('TROptions_??', JSON2.stringify(TRGlobalOptions));\par
                            AutoUpdater_132329.enable();\par
                            alert('Automatic updates can be re-enabled for this script from the User Script Commands submenu.');\par
                        \}\par
                    \}\par
                \}\par
                );\par
\par
            \} else if (response)\{\par
                alert('No updates available for '+this.name);\par
            \}\par
        \},\par
        check: function(tf) \{\par
            if (!tf)\{\par
                this.enable();\par
            \} else \{\par
                // convert days to milliseconds and compare\par
                if (+this.time > (+GM_getValue('updated_132329', 0) + 1000*60*60*24*this.days)) \{\par
                    GM_setValue('updated_132329', this.time+'');\par
                    this.call(false, true);\par
                \}\par
                GM_registerMenuCommand("Check "+this.name+" for updates", function() \{\par
                    GM_setValue('updated_132329', new Date().getTime()+'');\par
                    AutoUpdater_132329.call(true, true)\par
                \});\par
            \}\par
        \}\par
\};\par
\par
readTRGlobalOptions();\par
\par
//even though Scriptish provides its own update mechanism (GM_updatingEnbled ==\par
//true), lets use this method.\par
if (typeof(GM_xmlhttpRequest) !== 'undefined' /*\par
 * && typeof(GM_updatingEnabled)\par
 * === 'undefined'\par
 */) \{\par
    try \{\par
        if (unsafeWindow.frameElement === null) \{\par
            AutoUpdater_132329.check(TRGlobalOptions.trUpdate);\par
        \}\par
    \} catch(e) \{\par
        AutoUpdater_132329.check(TRGlobalOptions.trUpdate);\par
    \}\par
\}\par
\par
/** ******* End updater code ************ */\par
\par
String.prototype.capitalize = function()\{ \par
    return this.charAt(0).toUpperCase() + this.substring(1).toLowerCase();\par
  \}\par
\par
//only run in the main iframe\par
if (document.location.toString().match('src/main_src.php') ) trStartup ();\par
}
