// ==UserScript==
// @name        habrahabr graph 3
// @namespace   dg
// @include     http://habrahabr.ru/post/*
// @version     1
// @grant       none
// ==/UserScript==


(function(){ var v = "1.3.2"; if (window.jQuery === undefined || window.jQuery.fn.jquery < v) { var done = false; var script = document.createElement("script"); script.src = "http://ajax.googleapis.com/ajax/libs/jquery/" + v + "/jquery.min.js"; script.onload = script.onreadystatechange = function(){ if (!done && (!this.readyState || this.readyState == "loaded" || this.readyState == "complete")) { done = true; initMyBookmarklet(); } }; document.getElementsByTagName("head")[0].appendChild(script); } else { initMyBookmarklet(); } function initMyBookmarklet() { (window.myBookmarklet = function() { $('#scoring').remove(); var container = document.createElement('div'); container.id = "scoring"; document.getElementsByTagName('body')[0].appendChild(container); var data = [] , scores = $('.score'); var off1 = (scores.eq(1).offset()).top; var off2 = (scores.filter(':last').offset()).top; var h = off2 - off1 + 200; var min = 0; var max = 0; scores.each(function(ind){ var that = $(this); if (ind < 1) {} else { var a = {}; if (!that.parent('.mark').hasClass('negative')) a.score = parseInt(that.text()); else a.score = (-1) * parseInt(that.text().substr(1)); if (a.score > max) max = a.score; if (a.score < min) min = a.score; a.title = that.attr('title'); a.id = that.parents('.info').attr('rel'); a.offs = (that.offset()).top; data.push(a); } }); for (var i=0; i < data.length - 1; i++ ){ data[i].h = data[i+1].offs - data[i].offs; } data[data.length-1].h = 200; var inner = '<style>#scoring { position: fixed; z-index: 100000; bottom: 100px; width: 50px; top: 100px; right: 20px; box-shadow: 0px 2px 5px rgba(1,1,1,.2); background-color: white;} #scoring a{display:block; margin: 0 auto; cursor: pointer; overflow: hidden;} #scoring a:hover {opacity: 1!important;}</style>'; for (var i=0, s; i < data.length ; i++ ){ a = data[i]; inner += "<a style='"; inner += "height: " + (100 * a.h / h) +"%;"; inner += "background-color: " + ((a.score > 0)? "#339900; " : (a.score < 0)? "#cc0001; " : "#cccccc; "); inner += "opacity: " + Math.sqrt((a.score> 0)? (a.score/max) : (a.score< 0)? ( a.score / min) : .1); inner += ";width: " + ( ((a.score> 0) ? Math.sqrt(a.score / max) : (a.score< 0) ? ( Math.sqrt((-1) * a.score / min) ) : -.2) * 60 + 40 ) + "%; "; inner += "z-index: " + (a.score + min + 100); inner += "' data-offset='" + (a.offs); inner += "' title=' ˀьힿ� "+ (a.score) + "; " + (a.title); inner += "' href='#comment_" + (a.id); inner += "'>" + a.score + "</a>"; } $('#scoring').append(inner); $('a[href^="#"]').on('click',function (e) {				    e.preventDefault(); var target = this.hash, $target = $(target);				    $('html, body').stop().animate({'scrollTop': $target.offset().top }, 400, 'swing', function () { window.location.hash = target;});});})();}})(); 
