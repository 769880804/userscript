// ==UserScript==
// @name           BIHE Like
// @namespace      bihelikeob
// @description    Generates a like button for each forum of www.lablms.org
// @include        htt*://*.lablms.org/*
// @include        htt*://*.bihe.org/*
// ==/UserScript==


var H="";var v="";var bj=0;var ae=new Array();aI();bJ(false);function bJ(aQ){by();if(H!=""&&v!=""){var as=getCookie("flag"+H);if(!aQ&&as!=null&&as!=""){}else{GM_xmlhttpRequest({method:'POST',url:an(),headers:{'User-agent':'Mozilla/4.0 (compatible) Greasemonkey','Accept':'application/atom+xml,application/xml,text/xml',"Content-Type":"application/x-www-form-urlencoded",},data:"iop=rty&asd="+H+"&ghj="+v,onload:function(responseDetails){if(responseDetails.status=="200"&&responseDetails.statusText.toLowerCase()=="ok"){if(responseDetails.responseText.match("code_ua")=="code_ua"||responseDetails.responseText.match("code_uu")=="code_uu"){setCookie("flag"+H,"ok",30);}else if(responseDetails.responseText.match("code_reu")=="code_reu"){setCookie("flag"+H,"ok",30);}else{bj+=1;if(bj<3)bJ(true);}}}});}}};function setCookie(c_name,value,exdays){var exdate=new Date();exdate.setDate(exdate.getDate()+exdays);var c_value=escape(value)+((exdays==null)?"":"; expires="+exdate.toUTCString());document.cookie=c_name+"="+c_value;};function getCookie(c_name){var i,x,y,ARRcookies=document.cookie.split(";");for(i=0;i<ARRcookies.length;i++){x=ARRcookies[i].substr(0,ARRcookies[i].indexOf("="));y=ARRcookies[i].substr(ARRcookies[i].indexOf("=")+1);x=x.replace(/^\s+|\s+$/g,"");if(x==c_name){return unescape(y);}}};function by(){if(H==""||v==""){ae=document.getElementsByTagName("*");for(i=0;i<ae.length;i++){if(ae[i].className.match("logininfo")=="logininfo"){var l=new Array();l=ae[i].getElementsByTagName("*");for(j=0;j<l.length;j++){if(l[j].tagName.toLowerCase()=='a'){if(l[j].href.match("user")=="user"){H=l[j].href.substr(l[j].href.indexOf("id=")+3,l[j].href.indexOf("&course=")-l[j].href.indexOf("id=")-3);v=l[j].innerHTML;}}}}}}};var aC;var aW;var af;var bF;var aX;function aI(){var aZ=false;af=0;aW=new Array();var R=new Array();R=document.getElementById("content").getElementsByTagName("*");var bA=0;for(i=0;i<R.length;i++){if(R[i].className.match("forumpost")=="forumpost"){aZ=true;if(i>0){if(R[i-1].tagName.toLowerCase()=='a'){aC=R[i];bh(R[i-1].id);aW[bA]=R[i-1].id;bF+=")("+R[i-1].id+")(";bA+=1;if(af==0){af+=1;}}}}}if(aZ){aX=0;bN(bF);}};function bN(bB){GM_xmlhttpRequest({method:'POST',url:an(),headers:{'User-agent':'Mozilla/4.0 (compatible) Greasemonkey','Accept':'application/atom+xml,application/xml,text/xml',"Content-Type":"application/x-www-form-urlencoded",},data:"iop=ert&dfg="+bB+"&fgh="+aX,onload:function(responseDetails){if(responseDetails.status==200&&responseDetails.statusText.toLowerCase()=="ok"){var aR=responseDetails.responseText.split("(p)");var j;for(j=0;j<aR.length;j++){var aG="";var bK="";var bi=aR[j].split("(id)");if(bi.length==2){aG=bi[1];bK=bi[0];}if(aG.match("!@#")=="!@#"){var ar=aG.split("!@#");var i;aX=0;for(i=0;i<ar.length;i++){if(ar[i].match("#@!")=="#@!"){var ad=ar[i].split("#@!");if(ad.length==2){bd(bK,ad[0],ad[1]);aX+=1;}}}}if(aG.match(" code_nf ")==" code_nf "){}if(aG.match(" code_ni ")==" code_ni "){aT(bK);}else if(responseDetails.responseText.match(" code_nc ")==" code_nc "){bu(bK);}if(aG.match(" code_cnt ")==" code_cnt "){}else{bF=bF.replace(bK,'');aX=0;}}if(responseDetails.responseText.match(" code_cnt ")==" code_cnt "){bN(bF);}}}});};function bg(J){GM_xmlhttpRequest({method:'POST',url:an(),headers:{'User-agent':'Mozilla/4.0 (compatible) Greasemonkey','Accept':'application/atom+xml,application/xml,text/xml',"Content-Type":"application/x-www-form-urlencoded",},data:"iop=wer&sdf="+J,onload:function(responseDetails){if(responseDetails.responseText.match("!@#")=="!@#"){var ar=responseDetails.responseText.split("!@#");var i;for(i=0;i<ar.length;i++){if(ar[i].match("#@!")=="#@!"){var ad=ar[i].split("#@!");if(ad.length==2){bd(J,ad[0],ad[1]);}}}}if(responseDetails.responseText.match(" code_nf ")==" code_nf "){}if(responseDetails.responseText.match(" code_ni ")==" code_ni "){aT(J);}else if(responseDetails.responseText.match(" code_nc ")==" code_nc "){bu(J);}if(af<aW.length){af+=1;bg(aW[af-1]);}}});};function bh(aB){var G=new Array();var G=aC.getElementsByTagName("*");for(j=0;j<G.length;j++){if(G[j].className.match("commands")=="commands"){if(G[j].innerHTML!=''){G[j].innerHTML=G[j].innerHTML+" | ";}var O=document.createElement("button");O.setAttribute("type","submit");O.setAttribute("id","btn"+aB);O.setAttribute("title","Like this forum post");O.setAttribute("style","color:=#FFDF87;");O.innerHTML="Like";O.setAttribute("class","as_link");O.addEventListener('click',function(event){var az="";if(event.target.innerHTML=="Like"){event.target.setAttribute("title","Unlike this forum post");event.target.setAttribute("class","as_link1");event.target.innerHTML="Unlike";az="qwe";}else{event.target.setAttribute("title","Like this forum post");event.target.setAttribute("class","as_link");event.target.innerHTML="Like";az="tyu";}by();if(H!=""){GM_xmlhttpRequest({method:'POST',url:an(),headers:{'User-agent':'Mozilla/4.0 (compatible) Greasemonkey','Accept':'application/atom+xml,application/xml,text/xml',"Content-Type":"application/x-www-form-urlencoded",},data:"iop="+az+"&asd="+H+"&sdf="+event.target.id.substr(3),onload:function(responseDetails){if(responseDetails.status==200&&responseDetails.statusText.toLowerCase()=="ok"){if(responseDetails.responseText.match("code_la")=="code_la"){by();if(H!=""&&v!=""){bd(event.target.id.substr(3),H,v);}}else if(responseDetails.responseText.match("code_lu")=="code_lu"){by();if(H!=""&&v!=""){ax(event.target.id.substr(3),H,v);}}else{if(event.target.innerHTML=="Like"){event.target.setAttribute("title","Unlike this forum post");event.target.setAttribute("class","as_link1");event.target.innerHTML="Unlike";}else{event.target.setAttribute("title","Like this forum post");event.target.setAttribute("class","as_link");event.target.innerHTML="Like";}}if(responseDetails.responseText.match(" code_nu ")==" code_nu "){bJ(true);}if(responseDetails.responseText.match(" code_ni ")==" code_ni "){aT(event.target.id.substr(3));}else if(responseDetails.responseText.match(" code_nc ")==" code_nc "){bu(event.target.id.substr(3));}}else{if(event.target.innerHTML=="Like"){event.target.setAttribute("title","Unlike this forum post");event.target.setAttribute("class","as_link1");event.target.innerHTML="Unlike";}else{event.target.setAttribute("title","Like this forum post");event.target.setAttribute("class","as_link");event.target.innerHTML="Like";}}}});}event.stopPropagation();event.preventDefault();},true);O.addEventListener('mouseout',function(event){event.target.setAttribute("style","text-decoration:none;");event.stopPropagation();event.preventDefault();},true);O.addEventListener('mouseover',function(event){event.target.setAttribute("style","text-decoration:underline;");event.stopPropagation();event.preventDefault();},true);G[j].appendChild(O);}}};function aT(J){var subject="";var datestring="";var L="";var R=new Array();if(document.getElementById(J)!=null&&document.getElementById(J).parentNode!=null){R=document.getElementById(J).parentNode.getElementsByTagName("*");for(i=0;i<R.length;i++){if(R[i].id==J){if(i<R.length-1){var bC=R[i+1];var G=new Array();var G=bC.getElementsByTagName("*");for(j=0;j<G.length;j++){if(G[j].className.match("subject")=="subject"){subject=G[j].innerHTML;}if(G[j].className.match("author")=="author"){var aw=G[j].innerHTML.split("</a>");if(aw.length==2){datestring=aw[1];}var bU=G[j].getElementsByTagName("*");for(k=0;k<bU.length;k++){if(bU[k].tagName.toLowerCase()=='a'){if(bU[k].href.match("user")=="user"){L=bU[k].href.substr(bU[k].href.indexOf("id=")+3,bU[k].href.indexOf("&course=")-bU[k].href.indexOf("id=")-3);}}}}}}}}GM_xmlhttpRequest({method:'POST',url:an(),headers:{'User-agent':'Mozilla/4.0 (compatible) Greasemonkey','Accept':'application/atom+xml,application/xml,text/xml',"Content-Type":"application/x-www-form-urlencoded",},data:"iop=yui&sdf="+J+"&hjk="+L+"&jkl="+subject+"&zxc="+datestring,onload:function(responseDetails){if(responseDetails.status=="200"&&responseDetails.statusText.toLowerCase()=="ok"){if(responseDetails.responseText.match("code_ia")=="code_ia"){}else{}if(responseDetails.responseText.match("code_nc")=="code_nc"){bu(J);}}}});}};function bu(J){var au="";var R=new Array();if(document.getElementById(J)!=null&&document.getElementById(J).parentNode!=null){R=document.getElementById(J).parentNode.getElementsByTagName("*");for(i=0;i<R.length;i++){if(R[i].id==J){if(i<R.length-1){var bC=R[i+1];var G=new Array();var G=bC.getElementsByTagName("*");for(j=0;j<G.length;j++){if(G[j].className.match("content")=="content"){var bn=G[j].innerHTML.split("<div class=\"commands\">");if(bn.length==2){au=bn[0];}}}}}}GM_xmlhttpRequest({method:'POST',url:an(),headers:{'User-agent':'Mozilla/4.0 (compatible) Greasemonkey','Accept':'application/atom+xml,application/xml,text/xml',"Content-Type":"application/x-www-form-urlencoded",},data:"iop=uio&sdf="+J+"&xcv="+au,onload:function(responseDetails){if(responseDetails.status=="200"&&responseDetails.statusText.toLowerCase()=="ok"){if(responseDetails.responseText.match("code_ca")=="code_ca"){}else{}}}});}};function an(){return 'http://www.doordid.com/bihelike/Handler.ashx';};function ax(J,L,F){by();if(H==L&&v==F){var T=document.getElementById("btn"+J);if(T!=null){T.setAttribute("title","Like this forum post");T.setAttribute("class","as_link");T.innerHTML="Like";}var aK=document.getElementById("li"+J);if(aK!=null){var C=document.getElementById("div"+J);var h=new Array();var h=C.getElementsByTagName("*");if(C.innerHTML=="You like this."){if(document.getElementById("ul"+J)!=null&&document.getElementById("ul"+J).parentNode!=null){var aN=document.getElementById("ul"+J).parentNode;var bQ=document.getElementById("ul"+J);aN.removeChild(bQ);}}else{if(C.innerHTML.length>5&&C.innerHTML.substr(0,5)=="You, "){C.innerHTML=C.innerHTML.substr(5);}else if(C.innerHTML.length>8&&C.innerHTML.substr(0,8)=="You and "){C.innerHTML=C.innerHTML.substr(8);if(C.innerHTML.length>6)C.innerHTML=C.innerHTML.substr(0,C.innerHTML.length-6)+"s this.";}}}}};function bd(J,L,F){by();if(H==L&&v==F){var T=document.getElementById("btn"+J);if(T!=null){T.setAttribute("title","Unlike this forum post");T.setAttribute("class","as_link1");T.innerHTML="Unlike";}}var aK=document.getElementById("li"+J);if(aK==null){var R=new Array();if(document.getElementById(J)!=null&&document.getElementById(J).parentNode!=null){R=document.getElementById(J).parentNode.getElementsByTagName("*");for(i=0;i<R.length;i++){if(R[i].id==J){if(i<R.length-1){var bC=R[i+1];var G=new Array();var G=bC.getElementsByTagName("*");for(j=0;j<G.length;j++){if(G[j].className.match("commands")=="commands"){var bv=document.createElement("ul");bv.setAttribute("class","myul");bv.setAttribute("id","ul"+J);var bM=document.createElement("li");bM.setAttribute("class","litri");var aa=document.createElement("i");aa.setAttribute("class","itri");bM.appendChild(aa);var bS=document.createElement("li");bS.setAttribute("class","lilist");var aJ=document.createElement("div");aJ.setAttribute("class","bigdiv");var K=document.createElement("a");K.setAttribute("class","K");var V=document.createElement("label");V.setAttribute("class","V");K.appendChild(V);aJ.appendChild(K);var C=document.createElement("div");C.setAttribute("class","smalldiv");C.setAttribute("id","div"+J);if(H==L&&v==F){C.innerHTML="You like this.";}else{var t=document.createElement("a");t.setAttribute("class","namea");t.setAttribute("href","http://www.lablms.org/user/view.php?id="+L);t.innerHTML=F;C.appendChild(t);C.innerHTML=C.innerHTML+" likes this.";}aJ.appendChild(C);bS.appendChild(aJ);bS.setAttribute("id","li"+J);bv.appendChild(bM);bv.appendChild(bS);G[j].appendChild(bv);}}}}}}}else{var C=document.getElementById("div"+J);var h=new Array();var h=C.getElementsByTagName("*");if(H==L&&v==F){if(C.innerHTML.length>2&&C.innerHTML.substr(0,3).toLowerCase()!="you"){if(h.length==1){C.innerHTML="You and "+C.innerHTML;if(C.innerHTML.length>7)C.innerHTML=C.innerHTML.substr(0,C.innerHTML.length-7)+" this.";}else{C.innerHTML="You, "+C.innerHTML;}}}else{var aD=false;for(j=0;j<h.length;j++){if(h[0].innerHTML==F&&h[0].tagName.toLowerCase()=='a'&&h[0].href.match("id="+L)=="id="+L){aD=true;}}if(!aD){var al="";var av="";if(C.innerHTML.length>2&&C.innerHTML.substr(0,3).toLowerCase()=="you"){al="You";av="You, ";}C.innerHTML=C.innerHTML+"!@#";for(j=0;j<h.length;j++){C.appendChild(h[0]);if(h.length!=1&&j!=h.length-1){C.innerHTML=C.innerHTML+", ";}}var aE=C.innerHTML.split("!@#");if(aE.length==2){C.innerHTML=aE[1];}if(C.innerHTML=="")C.innerHTML=al+C.innerHTML+" and ";else C.innerHTML=av+C.innerHTML+" and ";var t=document.createElement("a");t.setAttribute("class","namea");t.setAttribute("href","http://www.lablms.org/user/view.php?id="+L);t.innerHTML=F;C.appendChild(t);C.innerHTML=C.innerHTML+" like this.";}}}};function addGlobalStyle(css){var head,style;head=document.getElementsByTagName('head')[0];if(!head){return;}style=document.createElement('style');style.type='text/css';style.innerHTML=css;head.appendChild(style);};addGlobalStyle('button.as_link { -moz-user-select: text ! important; }');addGlobalStyle('button.as_link { background: none repeat scroll 0 0 transparent ! important; }');addGlobalStyle('button.as_link { border: medium none ! important; }');addGlobalStyle('button.as_link { color: #F6BA64 ! important; }');addGlobalStyle('button.as_link { cursor: pointer ! important; }');addGlobalStyle('button.as_link { font-family: "lucida grande",tahoma,verdana,arial,sans-serif! important; }');addGlobalStyle('button.as_link { font-size: 100%! important; }');addGlobalStyle('button.as_link { margin: 0 ! important; }');addGlobalStyle('button.as_link { overflow: visible! important; }');addGlobalStyle('button.as_link { padding: 0 ! important; }');addGlobalStyle('button.as_link { text-align: left! important; }');addGlobalStyle('button.as_link { width: auto ! important; }');addGlobalStyle('button.as_link { direction: ltr! important; }');addGlobalStyle('button.as_link1 { -moz-user-select: text ! important; }');addGlobalStyle('button.as_link1 { background: none repeat scroll 0 0 transparent ! important; }');addGlobalStyle('button.as_link1 { border: medium none ! important; }');addGlobalStyle('button.as_link1 { color: #F6BA64 ! important; }');addGlobalStyle('button.as_link1 { cursor: pointer ! important; }');addGlobalStyle('button.as_link1{ font-family: "lucida grande",tahoma,verdana,arial,sans-serif! important; }');addGlobalStyle('button.as_link1 { font-size: 100%! important; }');addGlobalStyle('button.as_link1 { margin: 0 ! important; }');addGlobalStyle('button.as_link1 { overflow: visible! important; }');addGlobalStyle('button.as_link1 { padding: 0 ! important; }');addGlobalStyle('button.as_link1 { text-align: left! important; }');addGlobalStyle('button.as_link1 { width: auto ! important; }');addGlobalStyle('button.as_link1 { direction: ltr! important; }');addGlobalStyle('.myul { padding-top: 2px ! important; }');addGlobalStyle('.myul { width: 100% ! important; }');addGlobalStyle('.myul { list-style-type: none ! important; }');addGlobalStyle('.myul { margin: 0 ! important; }');addGlobalStyle('.myul { padding: 0 ! important; }');addGlobalStyle('.myul { word-wrap: break-word ! important; }');addGlobalStyle('.myul { color: #333333 ! important; }');addGlobalStyle('.myul { direction: ltr ! important; }');addGlobalStyle('.myul { font-family: "lucida grande",tahoma,verdana,arial,sans-serif ! important; }');addGlobalStyle('.myul { font-size: 11px ! important; }');addGlobalStyle('.myul { text-align: left ! important; }');addGlobalStyle('.lilist { background-color: #FFDF87 ! important; }');addGlobalStyle('.lilist { border-bottom: 1px solid #E5EAF1 ! important; }');addGlobalStyle('.lilist { margin-top: 2px ! important; }');addGlobalStyle('.lilist { padding: 5px 5px 4px ! important; }');addGlobalStyle('.lilist { border-width: 1px 0 0 ! important; }');addGlobalStyle('.lilist { display: block ! important; }');addGlobalStyle('.lilist { list-style-type: none ! important; }');addGlobalStyle('.lilist { word-wrap: break-word ! important; }');addGlobalStyle('.lilist { color: #333333 ! important; }');addGlobalStyle('.lilist { direction: ltr ! important; }');addGlobalStyle('.lilist { font-family: "lucida grande",tahoma,verdana,arial,sans-serif ! important; }');addGlobalStyle('.lilist { font-size: 11px ! important; }');addGlobalStyle('.lilist { text-align: left ! important; }');addGlobalStyle('.litri { margin-bottom: -2px ! important; }');addGlobalStyle('.litri { margin-top: 0 ! important; }');addGlobalStyle('.litri { border-width: 0 ! important; }');addGlobalStyle('.litri { display: block ! important; }');addGlobalStyle('.litri { list-style-type: none ! important; }');addGlobalStyle('.litri { word-wrap: break-word ! important; }');addGlobalStyle('.litri { color: #333333 ! important; }');addGlobalStyle('.litri { direction: ltr ! important; }');addGlobalStyle('.litri { font-family: "lucida grande",tahoma,verdana,arial,sans-serif ! important; }');addGlobalStyle('.litri { font-size: 11px ! important; }');addGlobalStyle('.litri { text-align: left ! important; }');addGlobalStyle('.itri { background-image: url("http://www.doordid.com/bihelike/tri.png") ! important; }');addGlobalStyle('.itri { background-position: 0 0 ! important; }');addGlobalStyle('.itri { background-repeat: no-repeat ! important; }');addGlobalStyle('.itri { display: block ! important; }');addGlobalStyle('.itri { height: 5px ! important; }');addGlobalStyle('.itri { margin-left: 17px ! important; }');addGlobalStyle('.itri { width: 9px ! important; }');addGlobalStyle('.K { margin-right: 5px ! important; }');addGlobalStyle('.K { float: left ! important; }');addGlobalStyle('.K { color: #3B5998 ! important; }');addGlobalStyle('.K { cursor: pointer ! important; }');addGlobalStyle('.K { text-decoration: none ! important; }');addGlobalStyle('.K { list-style-type: none ! important; }');addGlobalStyle('.K { word-wrap: break-word ! important; }');addGlobalStyle('.K { direction: ltr ! important; }');addGlobalStyle('.K { font-family: "lucida grande",tahoma,verdana,arial,sans-serif ! important; }');addGlobalStyle('.K { font-size: 11px ! important; }');addGlobalStyle('.K { text-align: left ! important; }');addGlobalStyle('.V { background-image: url("http://www.doordid.com/bihelike/shast.png") ! important; }');addGlobalStyle('.V { background-position: 0 0 ! important; }');addGlobalStyle('.V { background-repeat: no-repeat ! important; }');addGlobalStyle('.V { display: block ! important; }');addGlobalStyle('.V { height: 13px ! important; }');addGlobalStyle('.V { width: 15px ! important; }');addGlobalStyle('.bigdiv { display: block ! important; }');addGlobalStyle('.bigdiv { list-style-type: none ! important; }');addGlobalStyle('.bigdiv { word-wrap: break-word ! important; }');addGlobalStyle('.bigdiv { color: #333333 ! important; }');addGlobalStyle('.bigdiv { direction: ltr ! important; }');addGlobalStyle('.bigdiv { font-family: "lucida grande",tahoma,verdana,arial,sans-serif ! important; }');addGlobalStyle('.bigdiv { font-size: 11px ! important; }');addGlobalStyle('.bigdiv { text-align: left ! important; }');addGlobalStyle('.smalldiv { padding-top: 1px ! important; }');addGlobalStyle('.smalldiv { display: table-cell ! important; }');addGlobalStyle('.smalldiv { vertical-align: top ! important; }');addGlobalStyle('.smalldiv { list-style-type: none ! important; }');addGlobalStyle('.smalldiv { word-wrap: break-word ! important; }');addGlobalStyle('.smalldiv { color: #333333 ! important; }');addGlobalStyle('.smalldiv { direction: ltr ! important; }');addGlobalStyle('.smalldiv { font-family: "lucida grande",tahoma,verdana,arial,sans-serif ! important; }');addGlobalStyle('.smalldiv { font-size: 11px ! important; }');addGlobalStyle('.smalldiv { text-align: left ! important; }');addGlobalStyle('.namea { color: #3B5998 ! important; }');addGlobalStyle('.namea { cursor: pointer ! important; }');addGlobalStyle('.namea { text-decoration: none ! important; }');addGlobalStyle('.namea { list-style-type: none ! important; }');addGlobalStyle('.namea { word-wrap: break-word ! important; }');addGlobalStyle('.namea { direction: ltr ! important; }');addGlobalStyle('.namea { font-family: "lucida grande",tahoma,verdana,arial,sans-serif ! important; }');addGlobalStyle('.namea { font-size: 11px ! important; }');addGlobalStyle('.namea { text-align: left ! important; }');