// ==UserScript==
// @name       X Romeo
// @namespace  http://userscripts.org/users/seteriel
// @version    2.0.1
// @include    http*://www.planetromeo.com/*/shortcuts.php
// @include    http*://www.planetromeo.com/*/search*
// @include    http*://www.gayromeo.com/*/shortcuts.php*
// @include    http*://www.gayromeo.com/*/search*
// @include    http*://83.98.143.20/*/shortcuts.php*
// @include    http*://83.98.143.20/*/search*
// @copyright  2014+, seteriel
// @downloadURL http://userscripts.org/scripts/source/434659.user.js
// @require    //ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js
// ==/UserScript==
function addJQuery(b){var a=document.createElement("script");a.setAttribute("src","//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js");a.addEventListener("load",function(){var c=document.createElement("script");c.textContent="("+b.toString()+")();";document.body.appendChild(c)},false);document.body.appendChild(a)}X={vars:{activePage:"",job:"idle",i:0,lastPage:0},master:top.frames.rechts,injectBasicUI:function(){var a=X.frame("rechts");$("body").prepend("<div id='xrui'></div>");$("body").prepend("<iframe id='xrf' name='xrf' src='about:blank' onload='X.jobHandler();' style='display: none;'>");$("#xrui").css(X.css.xrui);$("#xrui").css("top",$("#directsearch",a).outerHeight()||58);$("#xrui").append("<div id='xrv-progress' class='xrview' style='text-align: center;'></div>");$("#xrv-progress").append("<p style='font-size: 26px; color: #fc0; margin: 25px 0 15px;'>{job-name}</p>");$("#xrv-progress").append("<div id='xrpc'><input type='text' id='xrprogress' data-min='0' data-max='100' data-width='110' data-height='110' data-readOnly=true data-angleOffset=-150 data-angleArc=300 data-fgColor='#00FF00' value='0' /></div>");$("#xrv-progress").append("<div id='jc-abort' style='text-align: center;'>Please wait<br /><br /><input type='button' value='Cancel' onclick='X.job.abort()'></div>");$("#xrv-progress").append("<div id='jc-continue' style='text-align: center;'>Finished<br /><br /><input type='button' value='Back' onclick='X.view(&quot;#xrv-main&quot;)'></div>");$("#xrpc").css(X.css.xrpc);$("#xrui").append("<div id='xrv-about' class='xrview' style='text-align: center;'></div>");$("#xrv-about").append("<div class='headline'>X Romeo</div>");$("#xrv-about").append("<p>Version 2.0.1</p>");$("#xrv-about").append("<p>&copy; 2014+ seteriel</p>");$("#xrv-about").append("<div style='text-align: center;'><input type='button' value='Back' onclick='X.view(&quot;#xrv-main&quot;)'></div>");$("#xrui").append("<div id='xrv-main' class='xrview' style='text-align: center;'></div>");$("#xrv-main").append("<div class='headline'>X Romeo</div>");$("#xrv-main").append("<span>What are we going to do?</span>");$("#xrv-main").append("<ul id='menu'></ul>");$("#menu").append("<li id='x-collect-page' onclick='X.collect.results(X.frame(&quot;mitte&quot;));'>Scan this page</li>");$("#menu").append("<li id='x-collect-all' onclick='X.collect.pages();'>Scan all pages</li>");$("#menu").append("<li id='x-clear-soft' onclick='X.eraseVisit();'>Clear except ignore-list</li>");$("#menu").append("<li id='x-clear-all' onclick='X.erase();'>Clear all</li>");$("#menu").append("<li id='x-seed' onclick='X.seed.start();'>Start seeding</li>");$("#menu").append("<li id='x-seed' onclick='X.view(&quot;#xrv-about&quot;);'>About this tool</li>");$("#xrv-main").append("<p>Collection size: <span id='count'>0</span></p>");$("#menu li").hover(function(){$(this).css("text-decoration","underline")},function(){$(this).css("text-decoration","none")});X.view("#xrv-main");$("#menu").css(X.css.menu);$("input[type=button]").css(X.css.button);$(".headline").css(X.css.headline);$("#xrf",a).css("top",$("#xrui",a).outerHeight()+$("#xrui",a).offset().top+25);$.getScript("//cdn.jsdelivr.net/jquery.knob/1.2.2/jquery.knob.min.js",function(){$("#xrprogress").knob()})},frame:function(a){return top.frames[a].document},start:function(a){X.injections();X.load()},css:{xrui:{position:"absolute",fontSize:"16px",display:"block",width:220,minHeight:300,marginLeft:7,backgroundColor:"#305ab1",border:"1px solid #fff",borderLeft:"none","line-height":"normal"},xrpc:{padding:10,textAlign:"center"},button:{display:"inline-block",padding:"5px 10px",margin:"5px 25px",cursor:"pointer"},headline:{textAlign:"center",fontSize:"26px",color:"#fc0",margin:"25px 0 15px"},menu:{"list-style-type":"none",color:"#fc0",cursor:"pointer",textAlign:"left",paddingLeft:20}},injections:function(){X.injectBasicUI()},getFileName:function(a){a=a.split("/");return a[a.length-1]},updateUI:function(){X.vars.activePage=top.frames.mitte.location.pathname},enhanceSearch:{userDetail:function(){$("select[name^='alter'] option:not([value=0])").remove();for(i=18;i<=100;i++){$("select[name^='alter']").append("<option value='"+i+"'>"+i+"</option>")}}},urlParam:function(a,e){var d=e.substring(1);var c=d.split("&");for(var b=0;b<c.length;b++){var f=c[b].split("=");if(f[0]==a){return f[1]}}return false},urlParamReplace:function(d,e,a){if(a.indexOf(d+"=")>=0){var b=a.substring(0,a.indexOf(d));var c=a.substring(a.indexOf(d));c=c.substring(c.indexOf("=")+1);c=(c.indexOf("&")>=0)?c.substring(c.indexOf("&")):"";a=b+d+"="+e+c}else{if(a.indexOf("?")<0){a+="?"+d+"="+e}else{a+="&"+d+"="+e}}return a},collect:{results:function(a){$("td.resHeadline a:not([title])",a).each(function(){X.collect.profile(X.urlParam("set",$(this).attr("href").substr($(this).attr("href").toString().indexOf("?"))),"v")});top.frames.mitte.X.renderResultControls()},profile:function(b,a){if(X.master.X.known(b)==-1){X.master.X.collection.push([b,a]);X.master.X.updateCount(X.master.X.collection.length);X.master.X.save();return true}else{return false}},pages:function(){var a=$("a[href*='showPage']:first",X.frame("mitte"));if(a.length){console.log("Found Pagination.");if(X.vars.job=="idle"){X.job.start("eval");X.vars.i=1;$("#xrv-progress p").html("Scanning");$("#xrf").attr("src",X.getBaseURL()+"00000000000000000000000000000000/search/index.php"+X.urlParamReplace("resultPage","1",a.attr("href")))}else{return false}}else{console.log("Just one page. Cancel job.");X.collect.results(X.frame("mitte"))}},turnover:function(){if(X.vars.i==1){X.vars.lastPage=X.urlParam("resultPage",$("table:first a[href*='showPage']:last",$("#xrf").contents()).attr("href"))}X.collect.results($("#xrf").contents());X.vars.i++;X.progress(Math.floor(X.vars.i/X.vars.lastPage*100));if(X.vars.i<=X.vars.lastPage){console.log("Requesting results page "+X.vars.i);$("#xrf").attr("src",X.urlParamReplace("resultPage",X.vars.i,$("#xrf").attr("src")))}else{X.job.finish()}}},known:function(b){var a=-1;$.each(X.master.X.collection,function(c,d){if(d[0]==b){a=c;return false}});return a},seed:{start:function(){if(X.vars.job=="idle"&&X.collection.length>0){X.job.start("seed");X.vars.i=0;$("#xrv-progress p").html("Seeding");X.seed.iterate()}else{return false}},iterate:function(){X.progress(Math.floor(X.vars.i/X.collection.length*100));if(X.vars.i<X.collection.length){if(X.collection[X.vars.i][1]=="v"){console.log("Loading setcard: "+X.collection[X.vars.i][0]);$.get(X.getBaseURL()+"00000000000000000000000000000000/auswertung/setcard/?set="+X.collection[X.vars.i][0],function(a){X.jobHandler()})}else{X.jobHandler()}}else{X.job.finish()}}},debugPrintCollection:function(){console.log("Length: "+top.frames.rechts.X.collection.length)},jobHandler:function(){if(X.vars.job=="seed"){console.log("Done.");X.vars.i++;X.seed.iterate()}else{if(X.vars.job=="eval"){X.collect.turnover()}}},collection:[],save:function(){localStorage.setItem("XCollection",JSON.stringify(X.master.X.collection));X.master.X.updateCount(X.master.X.collection.length)},load:function(){X.master.X.collection=$.parseJSON(localStorage.getItem("XCollection"))||[];X.master.X.updateCount(X.master.X.collection.length)},erase:function(){var a=confirm("This will delete even the ignored setcards. Are you sure?");if(!a){return false}X.master.X.collection=[];X.master.X.save();top.frames.mitte.X.renderResultControls()},eraseVisit:function(){for(var a=0;a<X.master.X.collection.length;a++){if(X.master.X.collection[a][1]=="v"){X.master.X.collection.splice(a,1);a--}}X.master.X.save();X.master.X.load();top.frames.mitte.X.renderResultControls()},eraseSpecific:function(a){for(var b=0;b<X.master.X.collection.length;b++){if(X.master.X.collection[b][0]==a){X.master.X.collection.splice(b,1);X.master.X.save();return true}}return false},setFlag:function(a,b){for(var c=0;c<X.master.X.collection.length;c++){if(X.master.X.collection[c][0]==a){X.master.X.collection[c][1]=b;X.master.X.save();return true}}return false},getBaseURL:function(){return location.protocol+"//"+location.hostname+(location.port&&":"+location.port)+"/"},progress:function(a){$("#xrprogress").val(a).trigger("change")},view:function(a){$(".xrview").hide();$(a).show()},job:{start:function(a){X.vars.job=a;X.progress(0);$("#jc-abort").css("display","block");$("#jc-continue").css("display","none");X.view("#xrv-progress")},finish:function(){X.vars.job="idle";$("#jc-abort").css("display","none");$("#jc-continue").css("display","block")},abort:function(){X.vars.job="idle";X.view("#xrv-main")}},updateCount:function(a){$("#count").html(a)},renderResultControls:function(){$(".xcontrols").remove();$("td.resHeadline a:not([title])").each(function(){var a=X.urlParam("set",$(this).attr("href").substr($(this).attr("href").toString().indexOf("?")));var c=X.master.X.known(a);$(this).parents("tr").find("td:first").append("<div class='xcontrols'></div>");if(c>-1){var b=X.master.X.collection[c][1];$(".xcontrols:last").append("<span title='Remove from collection' onclick='if(X.eraseSpecific(  "+a+" )) X.renderResultControls();' class='glyphicon glyphicon-remove'></span>");$(".xcontrols:last").append("<span title='"+(b=="v"?"Do not seed":"Seed")+"' onclick='if(X.setFlag(  "+a+", &quot;"+(b=="v"?"i":"v")+"&quot; )) X.renderResultControls();' class='glyphicon glyphicon-ban-circle"+(b=="v"?"":" active")+"'></span>")}else{$(".xcontrols:last").append("<span title='Add to collection' onclick='if(X.collect.profile(  "+a+", &quot;v&quot; )) X.renderResultControls();' class='glyphicon glyphicon-plus green'></span>")}});$(".xcontrols").css({"text-align":"center","margin-top":"5px"});$(".glyphicon").css({"font-size":"1.2em",color:"#fc0",cursor:"pointer",margin:"0 2px"});$(".xcontrols .active").css({color:"#f00"});$(".xcontrols .green").css({color:"#0f0"})}};function init(){$(document).ready(function(){if(X.getFileName(window.location.pathname)=="shortcuts.php"){X.start()}else{X.renderResultControls()}$("head").prepend("<link rel='stylesheet' type='text/css' href='//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css' />");pageQuery=window.location.search;if(X.urlParam("searchType",pageQuery)=="userDetail"){X.enhanceSearch.userDetail()}else{if(X.urlParam("searchType",pageQuery)=="userClubMemberDetail"){X.enhanceSearch.userDetail()}}})}(function(){if(!window.jQuery){addJQuery(init)}else{init()}})();