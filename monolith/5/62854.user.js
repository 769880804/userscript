// ==UserScript==
// @name           player.omroep.nl - MMS-link Creator
// @namespace     -
// @description    Creates a downloadable/clickable MMS-link on player.omroep.nl pages. You can use right click and download or open it with your favourite application (like Orbit/flashget/vlc). Also skips the advertisement.
// @version 0.12
// @include        http://player.omroep.nl/?aflid=*
// @include        http://cgi.omroep.nl/*
// @copyright 2009+, RealBase
// @license GPL version 3 or any later version; http://www.gnu.org/copyleft/gpl.html
// ==/UserScript==



 
/*
Homepage: http://userscripts.org/scripts/show/62854


Author: RealBase
Script initially based on:
- Wicher Minnaard's "player.omroep.nl - Video downloaden met mplayer userscript (http://userscripts.org/scripts/show/47693) 
- Twan Coenraad's "player.omroep.nl en nos.nl - zonder reclames" userscript (http://userscripts.org/scripts/show/9025) 
- Gantt's  Download YouTube Videos as MP4" userscript (http://userscripts.org/scripts/show/25105)

Version: 28 Nov 2009

Please report any bugs on:

http://userscripts.org/scripts/show/62854


*/



/// Remove Ad-movies

setTimeout('exitReclame()',2000);
setTimeout('openNext()', 1000);

///




var playert = document.getElementById("player");



// Listener for node insertions (generated by omroep.nl's javascript)

if (playert) playert.addEventListener("DOMNodeInserted", genMovieSource, true);



// Generates the movie source
function genMovieSource()

{

movielink=genMovieLink();

  if(movielink){
      
      //gets the wmv-file from cgi.omroep.nl
      
      GM_xmlhttpRequest({
        method: "GET",
        url:movielink  ,
        headers: {
          "User-Agent": "Mozilla/5.0",  
          "Accept": "video/x-ms-wmv" 
        },
        onload: function(response) {
              playert.removeEventListener("DOMNodeInserted", genMovieSource, true);
            
             //create a temporary div, for embedding the wmv/asx file
             
              var temp_div = document.createElement('div');
              temp_div.innerHTML = response.responseText;
            
             //pull out the mms-link
              var download_link = temp_div.getElementsByTagName("ref")[0];
              var mms_download_link = download_link.getAttribute("href");
            
            // embed the mms-link in the player
              var download_div = document.createElement('div');
              download_div.innerHTML = '<br /> <span id=\'download-uitzending-gemist\'  style=\'background-color: black;\'> <a href=\''+mms_download_link+'\'>Download Uitzendinggemist</a></span>';
            
              playert.appendChild(download_div);
      
            }
        });
      
      }
}

// retrieve the movielink
function genMovieLink()

  {

  var playert = document.getElementById("player");

  var embedelement = document.getElementById('MediaPlayer');

  if (embedelement.getElementsByTagName("param"))

  //The embed element got inserted and has params - now we have all required parameters for dumping

    {

    var source;

    var params = embedelement.getElementsByTagName("param");

    for (var i = 0; ((i < params.length) && (!source)); i++) 

      {

      if (params[i].getAttribute("name")=="url")

        {

        source = params[i].getAttribute("value").replace("'","\\'"); //These URL's shouldn't have "'" in them but we escape them just to be sure.

        }

      }


    if (source)

      {

      return source;


      }

    }

  }





