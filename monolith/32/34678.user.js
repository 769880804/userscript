// ==UserScript==
// @name           Avanturist.org.PATCH
// @description    Avanturist.org forum PATCH
// @version        0.11.18
// @include        http://avanturist.org*
// @include        http://www.avanturist.org*
// @include        https://avanturist.org*
// @include        https://www.avanturist.org*
// ==/UserScript==


(function(){function s(e){return document.getElementById(e)}function x(e,j){new g("$x",e);++T;j=j||document.body;return document.evaluate(e,j,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null)}function q(e,j){var k=x(e,j);return k.snapshotLength>0?k.snapshotItem(0):null}function O(e,j,k){if(typeof k.caretPos!="undefined"&&k.createTextRange){var n=k.caretPos,r=n.text.length;n.text=n.text.charAt(n.text.length-1)==" "?e+n.text+j+" ":e+n.text+j;if(r==0){n.moveStart("character",-j.length);n.moveEnd("character",
-j.length);n.select()}else k.focus(n)}else if(typeof k.selectionStart!="undefined"){n=k.value.substr(0,k.selectionStart);r=k.value.substr(k.selectionStart,k.selectionEnd-k.selectionStart);var w=k.value.substr(k.selectionEnd),B=k.selectionStart,H=k.scrollTop;k.value=n+e+r+j+w;if(k.setSelectionRange){r.length==0?k.setSelectionRange(B+e.length,B+e.length):k.setSelectionRange(B,B+e.length+r.length+j.length);k.focus()}k.scrollTop=H}else{k.value+=e+j;k.focus(k.value.length-1)}}function P(){new g("getTopicId");
var e=/^.*\/forum\/topic\/(\d+)(\/)?.*/.exec(t);return e!=null&&2<=e.length?parseInt(e[1]):null}function ga(e){var j=new g("showHideForm");e=e||window.event;var k=e.srcelement?e.srcelement:e.target,n=k.getAttribute("div_id"),r=s(n);if(r.style.visibility=="visible"){r.style.visibility="hidden";j.trace("Form "+n+" was hidden")}else{r.style.visibility="visible";k=k.getAttribute("input_id");k!=null&&s(k).focus();j.trace("Form "+n+" was showed")}e.returnValue=false;typeof e.preventDefault!="undefined"&&
e.preventDefault();return false}function I(){var e=new g("CTopicWrapper");this.boards=[];var j=x(h.trBoard);e.trace("Number of found boards: "+j.snapshotLength);for(e=0;e<j.snapshotLength;++e){var k=j.snapshotItem(e),n=this.boards.length;k=new U(k,n);this.boards[n]=k}}function U(e,j){var k=new g("CBoard",e,j);this.idx=j;this.board=e;this.isCollapsed=false;this.href=null;this.hiddenTopics=[];this.collapseAlways=m.controllers[0].settings.hiddenBoards[j]==true;var n=e.parentNode;n=n.rows;for(var r=e.rowIndex+
1;r<n.length;++r){var w=n[r];if(w.cells.length!=6&&w.cells.length!=7)break;w=new y(this,w);if(w.isRead||this.collapseAlways)this.hiddenTopics.push(w)}if(n=q(h.trBoardContent,e)){k=document.createElement("TH");k.width="20%";k.style.textAlign="center";n.insertBefore(k,n.cells[1]);n.cells[0].width="40%";n.cells[2].width="40%";n.cells[2].style.textAlign="right";this.spanMsg=document.createElement("SPAN");this.spanMsg.innerHTML=this.allUnreadText;this.spanMsg.setAttribute("board_idx",j);this.spanToggle=
document.createElement("SPAN");this.spanToggle.innerHTML=this.collapseText;this.spanToggle.setAttribute("board_idx",j);this.href=document.createElement("A");this.href.href="#";this.href.appendChild(this.spanToggle);this.href.appendChild(this.spanMsg);this.href.setAttribute("board_idx",j);this.href.addEventListener("click",I.onClick,false);if(this.hiddenTopics.length==0){this.spanToggle.style.display="none";this.spanMsg.style.display="inline"}else{this.spanToggle.style.display="inline";this.spanMsg.style.display=
"none"}k.appendChild(this.href);this.cbHide=document.createElement("SPAN");this.cbHide.className=this.collapseAlways?"cbHideChecked":"cbHideUnchecked";this.cbHide.setAttribute("board_idx",j);this.lblHide=document.createElement("LABEL");this.lblHide.innerHTML="&nbsp;&nbsp;(";this.lblHide.appendChild(this.cbHide);this.lblHide.appendChild(document.createTextNode(this.collapseAlwaysText+")"));this.lblHide.addEventListener("click",I.onClick,false);this.lblHide.setAttribute("board_idx",j);r=document.createElement("SMALL");
r.appendChild(this.lblHide);k.appendChild(r);n.cells[0].align="left";w=q("./th[1]/small",n);if(null!=w){r=document.createElement("TR");k=document.createElement("TH");k.colSpan=3;k.align="left";k.appendChild(w);r.appendChild(k);n=n.parentNode;n.appendChild(r)}}else k.error("TR wasn't found")}function y(e,j){new g("CTopic","row index = "+j.rowIndex);y.nextId++;j.setAttribute("topicId",y.nextId);y.topics[y.nextId]=this;this.board=e;this.topic=j;this.isRead=j.cells[1].innerHTML.indexOf("new_post.gif")==
-1}function ha(e){new g("submitGotoPageForm");e=e||window.event;var j=(e.srcelement?e.srcelement:e.target).getAttribute("idx");e=s("york_start"+j);j=s("york_page"+j);e.value=(j.value-1)*20}function J(){var e=new g("onLoad");Q=new Date;e.trace("START: "+Q);if(document.body){if(typeof $=="undefined")$=u.jQuery;try{ia()}catch(j){e.error("EXCEPTION:\n"+j)}}else e.error("document.body hasn't been loaded")}function ia(){function e(){new g("CSettingsModel");this.sett_collapseTopics=this.isVisible=false;
this.label_sett_collapseTopics="Сворачивать прочитанные темы после загрузки главной страницы";this.sett_searchPosts=false;this.label_sett_searchPosts="Автоматически искать сообщения";this.sett_confirmSearchPosts=false;this.label_sett_confirmSearchPosts="Выдавать запрос перед началом поиска сообщения";this.sett_borderTables=false;this.label_sett_borderTables="Рисовать границы у таблиц в сообщениях";this.sett_addImageLinks=false;this.label_sett_addImageLinks="Добавлять ссылки к уменьшенным изображениям";
this.userIgnoreType=e.BLACK_LIST;this.userIgnoreListBlack=[];this.userIgnoreListWhite=[];this.hiddenBoards=[];this.load()}function j(a,c,b,d){new g("CDisplayedMessageModel");this.userIgnoreModel=a;this.originalMsg=c;this.userId=b;this.userName=d}function k(a,c,b){new g("CDisplayedMessageController");m.addController(this);this.userIgnoreController=a;this.model=c;this.view=b}function n(a,c){var b=new g("CDisplayedMessageView");this.model=a;this.controller=new k(c,a,this);this.profileHrefNode=q(h.bMsgAuthor,
this.model.originalMsg);if(this.profileHrefNode==null)b.error("Profile URL wasn't found");else{b=this.profileHrefNode.parentNode;this.createUserCellContentNode();b.appendChild(this.userCellContentNode)}}function r(a,c,b,d){new g("CHiddenMessageModel");this.userIgnoreModel=a;this.originalMsg=c;this.userId=b;this.userName=d;this.isVisible=true}function w(a,c,b){new g("CHiddenMessageController");m.addController(this);this.userIgnoreController=a;this.model=c;this.view=b}function B(a,c){new g("CHiddenMessageView");
this.model=a;this.controller=new w(c,a,this);this.expanded=a.originalMsg;this.parseExpandedView();this.createUserCellContentNode();this.createCollapsedView();this.expanded.parentNode.insertBefore(this.collapsed,this.expanded)}function H(a,c){var b=new g("CUserIgnoreModel");this.isBlackList=a;this.users=c;this.hiddenMessages=[];this.displayedMessages=[];var d=x(h.aMsgAuthor);b.trace("number of found posts: "+d.snapshotLength);for(var f=0;f<d.snapshotLength;++f){var i=d.snapshotItem(f);if(q(h.aSaveToJournalBtn,
i)!=null)b.trace("There is script user's message");else{var l=i.href,o=l.indexOf(";u=");if(o==-1)b.error("Can't find user ID. href = "+l);else{l=l.substr(o+3);b.trace("User ID = "+l);o=i.innerHTML;i=i.parentNode.parentNode.parentNode.parentNode;var v=c[l]!=null;if(v&&a||!v&&!a){b.trace("Found hidden message: idx = "+f);v=this.hiddenMessages.length;this.hiddenMessages[v]=new r(this,i,l,o)}else{v=this.displayedMessages.length;this.displayedMessages[v]=new j(this,i,l,o)}}}}}function V(a){new g("CUserIgnoreController");
m.addController(this);this.settings=a;this.model=a.userIgnoreType==e.BLACK_LIST?new H(true,a.userIgnoreListBlack):new H(false,a.userIgnoreListWhite);this.view=new W(this.model,this);a=this.model.hiddenMessages.length;for(var c=0;c<a;++c){var b=this.model.hiddenMessages[c];this.view.addHiddenMsgView(new B(b,this))}a=this.model.displayedMessages.length;for(c=0;c<a;++c){b=this.model.displayedMessages[c];this.view.addDisplayedMsgView(new n(b,this))}m.addHotKey("alt+ctrl+38",this);m.addHotKey("ctrl+shift+38",
this);m.addHotKey("alt+ctrl+40",this);m.addHotKey("ctrl+shift+40",this)}function W(a,c){new g("CUserIgnoreView");this.model=a;this.controller=c;this.hiddenMsgViews=[];this.displayedMsgViews=[]}function X(a,c){new g("CSettingsController");m.addController(this);this.model=a;this.view=new Y(this,c)}function Y(a,c){new g("CSettingsView");this.model=a.model;this.controller=a;this.href=document.createElement("A");this.href.href="#";this.href.innerHTML="Настройки";m.addEventListener(this.href,"click",this.controller);
var b=this.form=document.createElement("FORM"),d=a.model,f;for(f in d)if(f.indexOf("sett_")==0){var i=document.createElement("INPUT");i.type="checkbox";this[f]=i;var l=document.createElement("LABEL");l.appendChild(i);l.appendChild(document.createTextNode(d["label_"+f]));b.appendChild(l);b.appendChild(document.createElement("BR"))}this.createUserIgnoreSettingsView();d=document.createElement("INPUT");d.type="button";d.value="Сохранить";m.addEventListener(d,"click",this.controller);this.btnSave=d;b.appendChild(d);
b.appendChild(document.createTextNode(" "));d=document.createElement("INPUT");d.type="button";d.value="Отменить";m.addEventListener(d,"click",this.controller);this.btnCancel=d;b.appendChild(d);this.div=document.createElement("DIV");this.div.setAttribute("style",Z);this.div.appendChild(b);b=document.createElement("SPAN");b.style.display="inline-block";b.appendChild(this.href);b.appendChild(this.div);if(c!=null){d=c.createItem("");d.appendChild(b);c.insertMenuScriptItem(d);this.userIgnoreRadioBlack=
s("york_user_ignore_type_black");this.userIgnoreRadioWhite=s("york_user_ignore_type_white");this.userIgnoreSelectBlack=s("york_user_ignore_select_black");this.userIgnoreSelectWhite=s("york_user_ignore_select_white");this.userIgnoreBtnDelete=s("york_user_ignore_btn_delete");this.userIgnoreBtnImport=s("york_user_ignore_btn_import");this.userIgnoreBtnExport=s("york_user_ignore_btn_export");m.addEventListener(this.userIgnoreRadioBlack,"click",this.controller);m.addEventListener(this.userIgnoreRadioWhite,
"click",this.controller);m.addEventListener(this.userIgnoreBtnDelete,"click",this.controller);m.addEventListener(this.userIgnoreBtnImport,"click",this.controller);m.addEventListener(this.userIgnoreBtnExport,"click",this.controller)}}function ja(a){new g("CSearchModel",a);this.isVisible=false;if(this.isTopic=a!=null){this.topicId=a;this.topicTitle=document.title}}function aa(a,c){new g("CSearchController");m.addController(this);this.pageCtrl=a;this.model=new ja(a.model.topicId);this.view=new ba(this.model,
this,c)}function ba(a,c,b){new g("CSearchView");this.model=a;this.controller=c;this.href=document.createElement("A");this.href.style.textDecoration="none";this.href.style.color="black";this.href.href="#";this.href.innerHTML="<img src='http://www.google.com/favicon.ico' alt='g' style='vertical-align: top; height: 16px;'/>&nbsp;Google";m.addEventListener(this.href,"click",this.controller);c=this.form=document.createElement("FORM");c.method="GET";c.action="http://www.google.com/search";c.target="_blank";
c.innerHTML="<input type='text' id='york_search_text' name='q' value='' size='30'/><input type='submit' value='Поиск'/>";if(a.isTopic)c.innerHTML+="<br/><input type='checkbox' id='york_checkbox_in_topic' checked/><label for='york_checkbox_in_topic'>Только в текущей теме</label><input type='hidden' id='york_search_topic_id' name='q' value='inurl:"+a.topicId+"'/><input type='hidden' id='york_search_topic_title' name='q' value='intitle:\""+a.topicTitle+"\"'/>";c.innerHTML+="<input type='hidden' name='q' value='site:avanturist.org'/><input type='hidden' name='q' value='inurl:forum'/><input type='hidden' name='q' value='inurl:topic'/>";
m.addEventListener(this.form,"submit",this.controller);this.div=document.createElement("DIV");this.div.align="left";this.div.setAttribute("style",Z);this.div.appendChild(this.form);a=document.createElement("SPAN");a.style.display="inline-block";a.appendChild(this.href);a.appendChild(this.div);b!=null&&b.insertMenuForumItem(a,5)}function ca(){var a=new g("CMenuControl");this.menuSite=q(h.divMenuSite);null==this.menuSite&&a.trace(a,"Site menu wasn't found");this.menuForum=q(h.trMenuForum);null==this.menuForum&&
a.trace("Forum menu wasn't found");this.menuUser=q(h.divMenuUser);if(null!=this.menuUser){this.menuUser.className+="topMenu";this.menuUser.removeAttribute("style");this.menuUser.style.height="29px";a=q(h.tableMenuUser);if(null!=a){a.className+="york_menu";a.removeAttribute("cellPadding");a.removeAttribute("style");a=q(h.tdCabinet,a);if(null!=a&&a.width!=""){a.width=parseInt(a.width)+30;a.style.textAlign="right"}}}else a.trace("User menu wasn't found");a=document.createElement("DIV");a.className="topMenu york_menu";
this.menuScript=document.createElement("UL");this.menuScript.className="york_scriptMenu";this.menuScript.style.cssFloat="left";this.menuScript.style.textAlign="left";this.scriptLinks=document.createElement("UL");this.scriptLinks.className="york_scriptMenu";this.menuScript.style.textAlign="right";a.appendChild(this.menuScript);a.appendChild(this.scriptLinks);this.menuUser!=null&&this.menuUser.parentNode.insertBefore(a,this.menuUser.nextSibling);this.insertMenuScriptItem(this.createItem("<b>Скрипт:</b>"))}
function p(){var a=new g("CPageModel");this.pageType=/index\.php.+action=post/.test(t)?p.PAGE_TYPE_MESSAGE:/index\.php.+topic[=,]/.test(t)||/\/forum\/topic\/\d+/.test(t)?p.PAGE_TYPE_TOPIC:/index\.php.+board[=,]/.test(t)?p.PAGE_TYPE_BOARD:/\/forum\//.test(t)?null!=q(h.tableBoardTable)?p.PAGE_TYPE_MAIN_FORUM_PAGE:p.PAGE_TYPE_OTHER_FORUM_PAGE:p.PAGE_TYPE_OTHER_SITE_PAGE;a.trace("Page type = "+this.pageType);if(p.PAGE_TYPE_TOPIC==this.pageType){this.topicId=P();a.trace("topic_id = "+this.topicId);var c=
q(h.bCurrentPage);if(c!=null){this.currentPage=parseInt(c.innerHTML);a.trace("currentPage = "+this.currentPage);c=q(h.aLastPage);this.lastPage=c!=null?parseInt(c.innerHTML):1;this.lastPage=Math.max(this.lastPage,this.currentPage);a.trace("lastPage = "+this.lastPage);if(this.currentPage!=1){this.firstPageUrl=this.buildPageUrl(1);this.prevPageUrl=this.buildPageUrl(this.currentPage-1)}if(this.currentPage!=this.lastPage){this.nextPageUrl=this.buildPageUrl(this.currentPage+1);this.lastPageUrl=this.buildPageUrl(this.lastPage)}}}else this.topicId=
null}function da(){new g("CPageController");m.addController(this);this.settings=new e;this.model=new p;this.view=new ea(this,this.model);if((this.model.pageType&p.PAGE_TYPE_FORUM_PAGE_GROUP)!=0){this.searchCtrl=new aa(this,this.view.menuCtrl);this.settingsCtrl=new X(this.settings,this.view.menuCtrl);this.view.createUserMenuItems()}if(p.PAGE_TYPE_TOPIC==this.model.pageType){this.userIgnoreController=new V(this.settings);this.userIgnoreController.collapse();m.addHotKey("ctrl+37",this);m.addHotKey("ctrl+39",
this);m.addHotKey("ctrl+36",this);m.addHotKey("ctrl+35",this)}if(p.PAGE_TYPE_MAIN_FORUM_PAGE==this.model.pageType){m.addHotKey("alt+ctrl+38",this);m.addHotKey("ctrl+shift+38",this);m.addHotKey("alt+ctrl+40",this);m.addHotKey("ctrl+shift+40",this)}}function ea(a,c){var b=new g("CPageView");this.controller=a;this.model=c;c.pageType==p.PAGE_TYPE_MAIN_FORUM_PAGE&&this.highlightModerators();if((c.pageType&p.PAGE_TYPE_FORUM_PAGE_GROUP)!=0){try{this.menuCtrl=new ca}catch(d){this.menuCtrl=null;b.error("menu control creation error: "+
d)}if(this.menuCtrl!=null){b=document.createElement("DIV");b=this.menuCtrl.createItem("Непрочитанные темы","/forum/index.php?action=unread");this.menuCtrl.insertScriptLinksItem(b);b=this.menuCtrl.createItem("Непрочитанные ответы","/forum/index.php?action=unreadreplies");this.menuCtrl.insertScriptLinksItem(b);b=this.menuCtrl.createItem("Последние сообщения","/forum/index.php?action=recent");this.menuCtrl.insertScriptLinksItem(b)}}if(c.pageType==p.PAGE_TYPE_MESSAGE){this.addEditButtons();this.removeHideMessageOptions()}if(c.pageType==
p.PAGE_TYPE_TOPIC){c.isClosedTopic()&&this.addSaveToArchiveButtons();a.settings.sett_addImageLinks&&this.addImageLinks();this.updateHeadLinks()}(c.pageType&p.PAGE_TYPE_FORUM_TOPIC_GROUP)!=0&&a.settings.sett_borderTables&&this.borderTables();if((c.pageType&p.PAGE_TYPE_FORUM_PAGE_GROUP)!=0||(c.pageType&p.PAGE_TYPE_FORUM_TOPIC_GROUP)!=0)this.addScriptVersion();this.addImageAlt();this.addFavicon();this.addCustomCSS()}var A=new g("main"),fa=true;if(typeof $=="undefined"){C?A.trace("jQuery hasn't installed. URL: "+
t):A.error("jQuery hasn't installed. URL: "+t);$=function(){};fa=false}e.BLACK_LIST=0;e.WHITE_LIST=1;e.prototype={store:function(a,c){new g("CSettingsModel.store");if(D||C){var b=(new Date).getTime();b=new Date(b+15768E7);document.cookie=escape(a)+"="+escape(c)+";expires="+b.toGMTString()+";path=/"}else GM_setValue(a,c)},restore:function(a){var c=new g("CSettingsModel.restore");if(D||C){for(var b=null,d=document.cookie.split("; "),f=0;f<d.length;++f){var i=d[f].split("=");if(i[0]==escape(a)){try{b=
unescape(i[1])}catch(l){c.error("Can't unescape the value of the cookie: '"+i[0]+"="+i[1]+"'")}break}}return b}else return GM_getValue(a)},save:function(){new g("CSettingsModel.save");var a="",c;for(c in this)if(c.indexOf("sett_")==0){if(a.length>0)a+=",";a+=c+"="+this[c]}if(a.length>0)a+=",";a+="userIgnoreType=";a+=this.userIgnoreType;c=this.userIgnoreListToString(this.userIgnoreListBlack);a+=",userIgnoreListBlack=";a+=c;c=this.userIgnoreListToString(this.userIgnoreListWhite);a+=",userIgnoreListWhite=";
a+=c;c=this.hiddenBoardsToString(this.hiddenBoards);a+=",hiddenBoards=";a+=c;this.store("york_settings",a)},load:function(){var a=new g("CSettingsModel.load"),c=this.restore("york_settings");if(c==null)a.error("Stored settings weren't found");else{c=c.split(",");for(var b=0;b<c.length;++b){var d=c[b].split("=");if(d[0].indexOf("sett_")==0)this[d[0]]=eval(d[1]);else if(d[0]=="userIgnoreType")this.userIgnoreType=parseInt(d[1]);else if(d[0]=="userIgnoreList")this.userIgnoreType==e.BLACK_LIST?this.userIgnoreListFromString(this.userIgnoreListBlack,
d[1]):this.userIgnoreListFromString(this.userIgnoreListWhite,d[1]);else if(d[0]=="userIgnoreListBlack")this.userIgnoreListFromString(this.userIgnoreListBlack,d[1]);else if(d[0]=="userIgnoreListWhite")this.userIgnoreListFromString(this.userIgnoreListWhite,d[1]);else d[0]=="hiddenBoards"?this.hiddenBoardsFromString(this.hiddenBoards,d[1]):a.error("Unknown setting: "+c[b])}}},userIgnoreListFromString:function(a,c){new g("CSettingsModel.userIgnoreListFromString");for(var b=c.split("|"),d=b.length,f=0;f<
d;++f)if(b[f]!=null&&b[f].length>0){var i=b[f].split(":"),l=NaN;try{l=parseInt(i[0])}catch(o){l=NaN}isNaN(l)||(a[i[0]]=i[1]==null?"":i[1])}},userIgnoreListToString:function(a){new g("CSettingsModel.userIgnoreListToString");var c="";if(a.length>0){var b=/[,:|]/g,d;for(d in a){if(c.length>0)c+="|";var f=a[d];c+=d;c+=":";if(K)c+=f.replace(b,"_")}}return c},hiddenBoardsFromString:function(a,c){new g("CSettingsModel.hiddenBoardsFromString");for(var b=c.split("|"),d=b.length,f=0;f<d;++f)if(b[f]!=null&&
b[f].length>0){var i=NaN;try{i=parseInt(b[f])}catch(l){i=NaN}isNaN(i)||(this.hiddenBoards[i]=true)}},hiddenBoardsToString:function(a){new g("CSettingsModel.hiddenBoardsToString");var c="",b;for(b in a)if(a[b]==true)c+="|"+b;return c=="|"?"":c}};var R=new e;if(R.sett_searchPosts){var M=function(a){a=new g("CPostSearcher",a);this.msgId=L;this.topicId=P();if(null==this.topicId){a.error("topic_id wasn't found");throw"topic_id wasn't found";}var c=q(h.bCurrentPage);if(c==null){a.error("Navigator wasn't found");
throw"Navigator wasn't found";}this.currentPage=parseInt(c.innerHTML);a.trace("currentPage = "+this.currentPage);c=q(h.aLastPage);this.lastPage=c!=null?parseInt(c.innerHTML):1;this.lastPage=Math.max(this.lastPage,this.currentPage);a.trace("lastPage = "+this.lastPage);c=M.parseUrlParameters(t);this.searchFrom=parseInt(c.search_from);this.searchTo=parseInt(c.search_to);this.searchMid=parseInt(c.search_mid);this.mode=1;if(!this.initPageMessageIds()){a.error("Can't initialize page message ids");throw"Can't initialize page message ids";
}if(this.firstPageMsgId>this.lastPageMsgId){this.mode=-1;this.msgId*=-1;this.firstPageMsgId*=-1;this.lastPageMsgId*=-1}};M.prototype={searchMessage:function(){new g("CPostSearcher.searchMessage");return isNaN(this.searchFrom)||isNaN(this.searchTo)?this.firstPageLoad():isNaN(this.searchMid)?this.searchPageInterval():this.binaryPageSearch()},firstPageLoad:function(){var a=new g("CPostSearcher.firstPageLoad"),c="Вы пытаетесь перейти к сообщению № "+this.msgId+".\nЭто сообщение не найдено на текущей странице № "+
this.currentPage+".\nНачать поиск сообщения?\n(В процессе поиска страница будет неоднократно перегружена.)",b=5;this.searchFrom=this.currentPage;if(this.msgId<this.firstPageMsgId)if(this.currentPage==1)return this.jumpToMessage(1,this.firstPageMsgId);else{b=Math.floor(this.currentPage/b);b=Math.max(1,b);this.searchTo=this.searchFrom-b;this.searchTo=Math.max(1,this.searchTo);return!R.sett_confirmSearchPosts||confirm(c)?this.jumpToSearchToPage():false}else if(this.lastPageMsgId<this.msgId)if(this.currentPage==
this.lastPage)return this.jumpToMessage(this.lastPage,this.lastPageMsgId);else{b=Math.floor((this.lastPage-this.currentPage)/b);b=Math.max(1,b);this.searchTo=this.searchFrom+b;this.searchTo=Math.min(this.lastPage,this.searchTo);return!R.sett_confirmSearchPosts||confirm(c)?this.jumpToSearchToPage():false}else{a.trace("Message "+this.msgId+" is on the current page");a=this.msgId;for(c=0;c<this.pageMessagesSnapshot.snapshotLength;++c){b=this.extractMessageId(c);if(b<this.msgId)a=b;else{if(b==this.msgId)a=
b;break}}if(a!=this.msgId)return this.jumpToMessage(this.currentPage,a)}return false},searchPageInterval:function(){var a=new g("CPostSearcher.searchPageInterval"),c=Math.abs(this.searchTo-this.searchFrom);if(this.msgId<this.firstPageMsgId)if(this.searchFrom<this.searchTo)if(c==1){this.swapFromAndTo();return this.jumpToSearchToPage()}else{c=Math.floor(c/2);this.searchMid=this.searchFrom+c;return this.jumpToSearchMidPage()}else if(this.searchTo<this.searchFrom)if(this.searchTo==1)return this.jumpToMessage(1,
this.firstPageMsgId);else{this.searchFrom=this.searchTo;this.searchTo=this.searchFrom-c;this.searchTo=Math.max(1,this.searchTo);return this.jumpToSearchToPage()}else a.error("Unexpected error");else if(this.lastPageMsgId<this.msgId)if(this.searchFrom<this.searchTo)if(this.searchTo==this.lastPage)return this.jumpToMessage(this.lastPage,this.lastPageMsgId);else{this.searchFrom=this.searchTo;this.searchTo=this.searchFrom+c;this.searchTo=Math.min(this.lastPage,this.searchTo);return this.jumpToSearchToPage()}else if(this.searchTo<
this.searchFrom)if(c==1)return this.jumpToMessage(this.currentPage,this.lastPageMsgId);else{this.swapFromAndTo();c=Math.floor(c/2);this.searchMid=this.searchFrom+c;return this.jumpToSearchMidPage()}else a.error("Unexpected error");else{a.trace("Message "+this.msgId+" is found");return this.jumpToMessage(this.currentPage,this.msgId)}return false},binaryPageSearch:function(){var a=new g("CPostSearcher.binaryPageSearch");if(this.msgId<this.firstPageMsgId){this.searchTo=this.searchMid;a=this.searchTo-
this.searchFrom;if(a==1){this.swapFromAndTo();return this.jumpToSearchToPage()}else{a=Math.floor(a/2);this.searchMid=this.searchFrom+a;return this.jumpToSearchMidPage()}}else if(this.lastPageMsgId<this.msgId){this.searchFrom=this.searchMid;a=this.searchTo-this.searchFrom;if(a==1)return this.jumpToMessage(this.searchFrom,this.lastPageMsgId);else{a=Math.floor(a/2);this.searchMid=this.searchFrom+a;return this.jumpToSearchMidPage()}}else{a.trace("Message "+L+" is found");return this.jumpToMessage(this.searchMid,
this.msgId)}},initPageMessageIds:function(){var a=new g("CPostSearcher.initPageMessageIds"),c=x(h.msgTableBody);if(c.snapshotLength>0){this.pageMessagesSnapshot=c;this.firstPageMsgId=this.extractMessageId(0);this.lastPageMsgId=this.extractMessageId(c.snapshotLength-1);a.trace("firstPageMsgId = "+this.firstPageMsgId);a.trace("lastPageMsgId = "+this.lastPageMsgId);return!isNaN(this.firstPageMsgId)&&!isNaN(this.lastPageMsgId)}else{a.error("The message table wasn't found");return false}},extractMessageId:function(a){new g("CPostSearcher.extractMessageId");
a=this.pageMessagesSnapshot.snapshotItem(a);a=parseInt(a.rows[1].cells[1].id.substr(13));isNaN(a)||(a*=this.mode);return a},swapFromAndTo:function(){new g("CPostSearcher.swapFromAndTo");var a=this.searchFrom;this.searchFrom=this.searchTo;this.searchTo=a},jumpToMessage:function(a,c){new g("CPostSearcher.jumpToMessage");u.location.replace(u.location.protocol+"//www.avanturist.org/forum/index.php/topic,"+this.topicId+"."+20*(a-1)+".html#msg"+Math.abs(c))},jumpToSearchToPage:function(){new g("CPostSearcher.jumpToSearchToPage");
u.location.replace(u.location.protocol+"//www.avanturist.org/forum/index.php?topic="+this.topicId+"&start="+20*(this.searchTo-1)+"&search_from="+this.searchFrom+"&search_to="+this.searchTo+"#msg"+Math.abs(this.msgId));return true},jumpToSearchMidPage:function(){new g("CPostSearcher.jumpToSearchMidPage");u.location.replace(u.location.protocol+"//www.avanturist.org/forum/index.php?topic="+this.topicId+"&start="+20*(this.searchMid-1)+"&search_from="+this.searchFrom+"&search_to="+this.searchTo+"&search_mid="+
this.searchMid+"#msg"+Math.abs(this.msgId));return true}};M.parseUrlParameters=function(a){var c=new g("CPostSearcher.parseUrlParameters",a),b=[],d=a.indexOf("?")+1;if(d==0){c.trace("Question mark wasn't found");return b}var f=a.indexOf("#");f=f==-1?a.length():f;if(f<=d){c.error("invalid URL");return b}a=a.substr(d,f-d);c.trace("paramStr = "+a);c=a.split("&");for(a=0;a<c.length;++a){d=c[a].split("=");b[d[0]]=d[1]}return b};var F=/^.*#msg(\d+)$/.exec(t);if(F!=null&&F.length==2){var L=parseInt(F[1]);
A.trace("msgId = "+L);try{if((new M(L)).searchMessage())return}catch(ka){A.error("error in CPostSearcher initialization. "+ka)}}else A.trace("There is not a search message URL")}var Z="visibility: hidden;z-index: 2;position: absolute;background-color: rgb(245, 245, 250);border: 1px solid rgb(60, 97, 164);padding: 3px;text-align: left;color: black;";j.prototype={removeFromList:function(){this.userIgnoreModel.removeFromList(this.userId)},addToList:function(){this.userIgnoreModel.addToList(this.userId,
this.userName)}};k.prototype={handle:function(a,c){var b=new g("CDisplayedMessageController.handle",a,c.type),d=this.model;if(a==this.view.listCtrlHref){if(d.userIgnoreModel.isBlackList){b='Вы действительно хотите поместить "'+this.model.userName+'" в "чёрный" список?';if(!confirm(b))return false;this.model.addToList()}else{b='Вы действительно хотите удалить "'+this.model.userName+'" из "белого" списка?';if(!confirm(b))return false;this.model.removeFromList()}this.userIgnoreController.updateSettings();
u.location.reload();return false}else{b.error("An unexpected event. src.id = "+a.id+", e.type = "+c.type);return true}}};n.prototype={createListCtrlHref:function(){new g("CDisplayedMessageView.createListCtrlHref");var a=document.createElement("A");a.href="#";a.innerHTML="x";a.setAttribute("style","font-weight: bold; font-size: 16px; color: red;");a.title=this.model.userIgnoreModel.isBlackList?'Поместить пользователя в "чёрный" список':'Удалить пользователя из "белого" списка';m.addEventListener(a,
"click",this.controller);this.listCtrlHref=a},createUserCellContentNode:function(){new g("CDisplayedMessageView.createUserCellContentNode");this.createListCtrlHref();var a=document.createElement("TABLE");a.width="100%";a.cellPadding="0";a.cellSpacing="0";var c=a.insertRow(-1),b=c.insertCell(-1);b.width="95%";b.appendChild(this.profileHrefNode);c=c.insertCell(-1);c.width="5%";c.align="right";c.appendChild(this.listCtrlHref);this.userCellContentNode=a}};r.prototype={removeFromList:function(){this.userIgnoreModel.removeFromList(this.userId)},
addToList:function(){this.userIgnoreModel.addToList(this.userId,this.userName)}};w.prototype={handle:function(a,c){var b=new g("CHiddenMessageController.handle",a,c.type);if(a==this.view.expandHref){this.view.expand();return false}else if(a==this.view.collapseHref){this.view.collapse();return false}else if(a==this.view.listCtrlHref){if(this.model.userIgnoreModel.isBlackList){b='Вы действительно хотите удалить "'+this.model.userName+'" из "чёрного" списка?';if(!confirm(b))return false;this.model.removeFromList()}else{b=
'Вы действительно хотите добавить "'+this.model.userName+'" в "белый" список?';if(!confirm(b))return false;this.model.addToList()}this.userIgnoreController.updateSettings();u.location.reload();return false}else{b.error("An unexpected event. src.id = "+a.id+", e.type = "+c.type);return true}}};B.prototype={createListCtrlHref:function(){new g("CHiddenMessageView.createListCtrlHref");var a=document.createElement("A");a.href="#";a.innerHTML="+";a.setAttribute("style","font-weight: bold; font-size: 16px; color: blue;");
a.title=this.model.userIgnoreModel.isBlackList?'Удалить пользователя из "чёрного" списка':'Добавить пользователя в "белый" список';m.addEventListener(a,"click",this.controller);this.listCtrlHref=a},createUserCellContentNode:n.prototype.createUserCellContentNode,createCollapsedView:function(){new g("CHiddenMessageView.createCollapsedView");var a=document.createElement("TABLE");a.className="message_hidden_york";a.cellSpacing="1";a.cellPadding="5";a.width="100%";a.style.display="none";var c=a.insertRow(-1),
b=c.insertCell(-1);b.width=200;var d=c.insertCell(-1),f=document.createElement("TABLE");f.width="100%";c=f.insertRow(-1);var i=c.insertCell(-1);i.width="40%";var l=c.insertCell(-1);l.width="10%";l.align="center";c=c.insertCell(-1);c.width="40%";c.align="right";c.id="XXX";var o=document.createElement("A");o.href="#";o.style.fontWeight="bold";o.innerHTML="РАЗВЕРНУТЬ";m.addEventListener(o,"click",this.controller);l.appendChild(o);d.appendChild(f);this.collapsed=a;this.collapsedCellUser=b;this.collapsedCellInfo=
i;this.collapsedCellCtrl=l;this.collapsedCellRating=c;this.expandHref=o},parseExpandedView:function(){var a=new g("CHiddenMessageView.parseExpandedView");this.profileHrefNode=q(h.bMsgAuthor,this.expanded);if(this.profileHrefNode==null)a.error("Profile URL wasn't found");else{this.expandedCellUser=this.profileHrefNode.parentNode;var c=x(h.aMsgHeadLinks,this.expanded);if(c.snapshotLength==0)a.error("Date weren't found");else{this.cellAnchorContent=[];for(var b=0;b<c.snapshotLength;++b){var d=c.snapshotItem(b);
this.cellAnchorContent[b]=d}this.expandedCellAnchor=this.cellAnchorContent[0].parentNode;c=document.createElement("A");c.href="#";c.style.fontWeight="bold";c.innerHTML="СВЕРНУТЬ";m.addEventListener(c,"click",this.controller);b=this.expandedCellAnchor.parentNode;d=b.insertCell(1);d.align="center";d.width="10%";d.appendChild(c);b.cells[0].width="40%";b.cells[2].width="40%";this.collapseHref=c;d=b.insertCell(2);d.width="40%";d.appendChild(c);this.ratingDiv=q(h.divRating,this.expanded);if(this.ratingDiv==
null)a.error("Message rating wasn't found");else this.expandedCellRating=this.ratingDiv.parentNode}}},collapse:function(){new g("CHiddenMessageView.collapse");if(this.model.isVisible){this.expanded.style.display="none";this.collapsedCellUser.appendChild(this.userCellContentNode);for(var a=this.cellAnchorContent.length,c=0;c<a;++c)this.collapsedCellInfo.appendChild(this.cellAnchorContent[c]);this.collapsedCellRating.appendChild(this.ratingDiv);this.collapsed.style.display="table";this.model.isVisible=
false}},expand:function(){new g("CHiddenMessageView.expand");if(!this.model.isVisible){this.collapsed.style.display="none";this.expandedCellUser.appendChild(this.userCellContentNode);for(var a=this.cellAnchorContent.length,c=0;c<a;++c)this.expandedCellAnchor.appendChild(this.cellAnchorContent[c]);this.expandedCellRating.insertBefore(this.ratingDiv,this.expandedCellRating.childNodes[0]);this.expanded.style.display="table";this.model.isVisible=true}}};H.prototype={removeFromList:function(a){delete this.users[a]},
addToList:function(a,c){this.users[a]=c}};V.prototype={handleHotKey:function(a){new g("CUserIgnoreController.handleHotKey",a);if("alt+ctrl+38"==a||"ctrl+shift+38"==a)this.collapse();else if("alt+ctrl+40"==a||"ctrl+shift+40"==a)this.expand()},collapse:function(){this.view.collapse()},expand:function(){this.view.expand()},updateSettings:function(){new g("CUserIgnoreController.updateSettings");if(this.model.isBlackList){this.settings.userIgnoreType=e.BLACK_LIST;this.settings.userIgnoreListBlack=this.model.users}else{this.settings.userIgnoreType=
e.WHITE_LIST;this.settings.userIgnoreListWhite=this.model.users}this.settings.save()}};W.prototype={addHiddenMsgView:function(a){this.hiddenMsgViews[this.hiddenMsgViews.length]=a},addDisplayedMsgView:function(a){this.displayedMsgViews[this.displayedMsgViews.length]=a},collapse:function(){new g("CUserIgnoreView.collapse");for(var a=this.hiddenMsgViews,c=a.length,b=0;b<c;++b)a[b].collapse()},expand:function(){new g("CUserIgnoreView.expand");for(var a=this.hiddenMsgViews,c=a.length,b=0;b<c;++b)a[b].expand()}};
X.prototype={handle:function(a,c){var b=new g("CSettingsController.handle",a,c.type),d=this.view;if(a==d.btnSave){this.showHideForm();this.synchronizeModel();this.model.save();u.location.reload();return false}else if(a==d.href||a==d.btnCancel){this.showHideForm();return false}else if(a==d.userIgnoreRadioBlack||a==d.userIgnoreRadioWhite){this.synchronizeSelect();return true}else if(a==d.userIgnoreBtnDelete){d=d.userIgnoreRadioBlack.checked?d.userIgnoreSelectBlack:d.userIgnoreSelectWhite;for(var f=
d.options,i=f.length,l=-1,o=0;o<i;++o)if(f[o].selected){l=o;break}if(l!=-1){d.removeChild(f[l]);i--;if(l<i)f[l].selected=true;else if(i>0)f[i-1].selected=true}else b.error("selectedIndex = "+l);return false}else if(a==d.userIgnoreBtnImport){b=d.userIgnoreRadioBlack.checked;d=prompt('Импорт "'+(b?"ЧЁРНОГО":"БЕЛОГО")+'" списка.\nВставьте строку, полученную при экспорте списка');if(d!=null&&d.length>0){f=[];this.model.userIgnoreListFromString(f,d);this.createUserIgnoreListOptionsFromArray(b,f)}return false}else if(a==
d.userIgnoreBtnExport){b=d.userIgnoreRadioBlack.checked;f=this.userIgnoreListOptionsToArray(b);d=this.model.userIgnoreListToString(f);prompt('Экспорт "'+(b?"ЧЁРНОГО":"БЕЛОГО")+'" списка.\nСохраните куда-нибудь эту строку.\nВ любой момент Вы можете восстановить сохранённый\nсписок воспользовавшись кнопкой "Импорт"',d);return false}else{b.error("An unexpected event. src.id = "+a.id+", e.type = "+c.type);return true}},synchronizeForm:function(){new g("CSettingsController.synchronizeForm");var a=this.model,
c=this.view,b;for(b in a)if(b.indexOf("sett_")==0){var d=c[b];if(d!=null)d.checked=a[b]}if(a.userIgnoreType==e.BLACK_LIST){c.userIgnoreRadioBlack.checked=true;c.userIgnoreRadioWhite.checked=false}else{c.userIgnoreRadioBlack.checked=false;c.userIgnoreRadioWhite.checked=true}this.createUserIgnoreListOptionsFromArray(true,a.userIgnoreListBlack);this.createUserIgnoreListOptionsFromArray(false,a.userIgnoreListWhite);this.synchronizeSelect()},synchronizeModel:function(){new g("CSettingsController.synchronizeModel");
var a=this.model,c=this.view,b;for(b in c)if(b.indexOf("sett_")==0){var d=c[b];if(d!=null)a[b]=d.checked}a.userIgnoreType=c.userIgnoreRadioBlack.checked?e.BLACK_LIST:e.WHITE_LIST;a.userIgnoreListBlack=this.userIgnoreListOptionsToArray(true);a.userIgnoreListWhite=this.userIgnoreListOptionsToArray(false)},createUserIgnoreListOptionsFromArray:function(a,c){new g("CSettingsController.createUserIgnoreListOptionsFromArray");var b=[],d;for(d in c)b[b.length]=parseInt(d);b.sort(function(S,G){return S<G?-1:
S>G?1:0});var f=a?this.view.userIgnoreSelectBlack:this.view.userIgnoreSelectWhite,i=f.options.length;for(l=i-1;l>=0;l--)f.removeChild(f.options[l]);i=b.length;for(var l=0;l<i;++l){var o=document.createElement("OPTION");d=b[l];var v=c[new String(d)];o.value=d;o.setAttribute("userName",v);o.innerHTML=v.length>0?d+" ("+v+")":d;f.options[f.options.length]=o}if(f.options.length>0)f.options[0].selected=true},userIgnoreListOptionsToArray:function(a){new g("CSettingsController.userIgnoreListOptionsToArray");
a=(a?this.view.userIgnoreSelectBlack:this.view.userIgnoreSelectWhite).options;for(var c=[],b=a.length,d=0;d<b;++d){var f=a[d].value,i=a[d].getAttribute("userName");c[f]=i}return c},showHideForm:function(){new g("CSettingsController.showHideForm");if(this.model.isVisible){this.view.div.style.visibility="hidden";this.model.isVisible=false}else{this.synchronizeForm();this.view.div.style.visibility="visible";this.model.isVisible=true}},synchronizeSelect:function(){new g("CSettingsController.synchronizeSelect");
var a=this.view;if(a.userIgnoreRadioBlack.checked){a.userIgnoreSelectBlack.style.visibility="inherit";a.userIgnoreSelectBlack.style.zOrder="20";a.userIgnoreSelectWhite.style.visibility="hidden";a.userIgnoreSelectWhite.style.zOrder="10"}else{a.userIgnoreSelectWhite.style.visibility="inherit";a.userIgnoreSelectWhite.style.zOrder="20";a.userIgnoreSelectBlack.style.visibility="hidden";a.userIgnoreSelectBlack.style.zOrder="10"}}};Y.prototype={createUserIgnoreSettingsView:function(){new g("CSettingsView.createUserIgnoreSettingsView");
var a=document.createElement("DIV");a.setAttribute("style","border: 1px solid black; margin-top: 10px; margin-bottom: 10px; padding: 5px; width: 300px;");a.innerHTML="<b>Автоскрытие сообщений</b><br/><br/>Тип списка:&nbsp;&nbsp;&nbsp;&nbsp;<label><input type='radio' name='york_user_ignore_type' id='york_user_ignore_type_black'/> \"Чёрный\"</label>&nbsp;&nbsp;&nbsp;&nbsp;<label><input type='radio' name='york_user_ignore_type' id='york_user_ignore_type_white'/> \"Белый\"</label><br/><br/>Список пользователей:<table width='100%' cellpadding='0' cellspacint='0'><tr><td width='90%' rowspan='2'><div style='position: relative; top: 0px; left: 0px;'><select id='york_user_ignore_select_black' size='10' style='z-index: 10; width: 100%; visibility: inherit;'></select><select id='york_user_ignore_select_white' size='10' style='z-index: 20; position: absolute; top: 0px; left: 0px; width: 100%; visibility: hidden;'></select></div></td><td width='10%' valign='top'><input type='button' id='york_user_ignore_btn_delete' value='Удалить'/> </td></tr><tr><td width='10%' valign='bottom'><input type='button' id='york_user_ignore_btn_import' value='Импорт'/> <input type='button' id='york_user_ignore_btn_export' value='Экспорт'/> </td></tr></table>";
this.form.appendChild(a)}};aa.prototype={handle:function(a,c){var b=new g("CSearchController.handle",a,c.type);if(a==this.view.form){if(this.model.isTopic){b=this.view;var d=b.form;if(b.getCheckbox().checked){d.appendChild(b.getInputTopicId());d.appendChild(b.getInputTopicTitle())}else{d.removeChild(b.getInputTopicId());d.removeChild(b.getInputTopicTitle())}}this.showHideForm();return true}else if(a==this.view.href){this.showHideForm();return false}else{b.error("An unexpected event. src.id = "+a.id+
", e.type = "+c.type);return true}},showHideForm:function(){new g("CSearchController.showHideForm");if(this.model.isVisible){this.view.div.style.visibility="hidden";this.model.isVisible=false}else{this.view.div.style.visibility="visible";this.view.getInputText().focus();this.model.isVisible=true}}};ba.prototype={getInputText:function(){if(this.inputText==null)this.inputText=s("york_search_text");return this.inputText},getInputTopicId:function(){if(this.inputTopicId==null)this.inputTopicId=s("york_search_topic_id");
return this.inputTopicId},getInputTopicTitle:function(){if(this.inputTopicTitle==null)this.inputTopicTitle=s("york_search_topic_title");return this.inputTopicTitle},getCheckbox:function(){if(this.checkbox==null)this.checkbox=s("york_checkbox_in_topic");return this.checkbox}};ca.prototype={insertMenuForumItem:function(a,c){if(this.menuForum!=null){var b=this.menuForum.insertCell(c);b.align="center";b.width="100";b.style.borderRight="1px solid #ffffff";b.appendChild(a)}},insertMenuScriptItem:function(a,
c){this.insertItem(this.menuScript,a,c)},insertScriptLinksItem:function(a,c){this.insertItem(this.scriptLinks,a,c)},insertItem:function(a,c,b){var d=new g("CMenuControl.insertItem",b);if(a!=null)null==b?a.appendChild(c):a.insertBefore(c,a.childNodes[b]);else d.error("Can't insert an item: menu is null")},createItem:function(a,c){new g("CMenuControl.createItem",a,c);var b;if(null!=c){b=document.createElement("A");b.href=c}else b=document.createElement("SPAN");b.innerHTML=a;var d=document.createElement("LI");
d.appendChild(b);return d}};p.PAGE_TYPE_MAIN_FORUM_PAGE=257;p.PAGE_TYPE_BOARD=258;p.PAGE_TYPE_TOPIC=1284;p.PAGE_TYPE_MESSAGE=1032;p.PAGE_TYPE_OTHER_FORUM_PAGE=272;p.PAGE_TYPE_OTHER_SITE_PAGE=544;p.PAGE_TYPE_FORUM_PAGE_GROUP=256;p.PAGE_TYPE_SITE_GROUP=512;p.PAGE_TYPE_FORUM_TOPIC_GROUP=1024;p.prototype={isClosedTopic:function(){var a=new g("CPageModel.isClosedTopic");if(this.pageType!=p.PAGE_TYPE_TOPIC)return false;if(typeof this.isClosed=="undefined"){var c=null==q(h.aSignup);a.trace("userSignedup = "+
c);this.isClosed=c?null==q(h.btnReply):false;a.trace("result = "+this.isClosed)}return this.isClosed},buildPageUrl:function(a){return"/forum/index.php/topic,"+this.topicId+"."+(a-1)*20+".html"}};da.prototype={handle:function(a,c){var b=new g("CPageController.handle",a,c.type);if(c.type=="click")if(a==this.view.collapseAllBoards){E.collapse();return false}else if(a==this.view.expandAllBoards){E.expand();return false}else if(a==this.view.collapseIgnoredMsgs){this.userIgnoreController.collapse();return false}else if(a==
this.view.expandIgnoredMsgs){this.userIgnoreController.expand();return false}else if(a==this.view.btnPre||a.parentNode==this.view.btnPre){O("[pre]","[/pre]",this.view.textArea);return false}else if(a==this.view.btnUrl||a.parentNode==this.view.btnUrl){b=u.prompt("Введите URL. Например, http://yandex.ru","");null!=b&&O("[url="+b+"]","[/url]",this.view.textArea);return false}else if(a==this.view.btnQuote||a.parentNode==this.view.btnQuote){b=u.prompt('Введите источник цитирования. Например, avanturist.\nМожете ничего не указывать.\nКнопка "Отменить" отменяет создание цитаты.',
"");if(b!=null)O("[quote"+(b!=""?"="+b:"")+"]","[/quote]",this.view.textArea);return false}else if(a==this.view.btnFormatTable||a.parentNode==this.view.btnFormatTable){b=this.view.textArea;if(typeof b.caretPos!="undefined"&&b.createTextRange){var d=b.caretPos,f=this.formatTable(d.text);if(f.length>0){d.text=f;b.focus(d)}}else if(typeof b.selectionStart!="undefined"){d=b.value.substr(0,b.selectionStart);f=b.value.substr(b.selectionStart,b.selectionEnd-b.selectionStart);var i=b.value.substr(b.selectionEnd),
l=b.selectionStart,o=b.scrollTop;f=this.formatTable(f);if(f.length>0){b.value=d+f+i;if(b.setSelectionRange){b.setSelectionRange(l,l+f.length);b.focus()}b.scrollTop=o}}else alert("Извините, функция не поддерживается вашим браузером");return false}else{b.error("An unexpected event. src.id = "+a.id+", e.type = "+c.type);return true}else if(c.type=="mouseover"){u.bbc_highlight!=null&&u.bbc_highlight(a,true);return false}else if(c.type=="mouseout"){u.bbc_highlight!=null&&u.bbc_highlight(a,false);return false}else{b.error("An unexpected event. src.id = "+
a.id+", e.type = "+c.type);return true}},handleHotKey:function(a){new g("CPageController.handleHotKey",a);if("alt+ctrl+38"==a||"ctrl+shift+38"==a)E.collapse();else if("alt+ctrl+40"==a||"ctrl+shift+40"==a)E.expand();else if("ctrl+37"==a)null!=this.model.prevPageUrl&&window.location.replace(this.model.prevPageUrl);else if("ctrl+39"==a)null!=this.model.nextPageUrl&&window.location.replace(this.model.nextPageUrl);else if("ctrl+36"==a)null!=this.model.firstPageUrl&&window.location.replace(this.model.firstPageUrl);
else"ctrl+35"==a&&null!=this.model.lastPageUrl&&window.location.replace(this.model.lastPageUrl)},handleSaveToArchive:function(a,c){new g("CPageController.handleSaveToArchive",a,c.type);var b=$(a).parent().parent().find("input[name='topic_id']").val(),d=$(a).parent().parent().find("input[name='message_id']").val();if(b=="undefined"||d=="undefined")alert("Ошибка сохранения материала в ваш личный архив!");else{$.getJSON("/forum/index.php?action=all_ajax_save_to_archive",{topic_id:b,message_id:d},function(f){f.result==
1?$(a).hide():alert(f.result_status)});return false}},formatTable:function(a){for(var c=new g("CPageController.formatTable"),b=a.length,d=0;d<a.length;++d){var f=a[d];if(f!=" "&&f!="\r"&&f!="\n"){b=d;break}}if(b==a.length){c.error("the text is empty");return""}c=0;for(d=a.length-1;d>b;d--){f=a[d];if(f!=" "&&f!="\r"&&f!="\n"){c=d;break}}var i="[table]\n[tr][td]";for(d=b;d<=c;++d){f=a[d];if(f=="\t")i+="[/td][td]";else if(f=="\n")i+="[/td][/tr]\n[tr][td]";else if(f!="\r")i+=f}i+="[/td][/tr]\n[/table]\n";
return i}};ea.prototype={createUserMenuItems:function(){new g("CPageView.createUserMenuItems");if(p.PAGE_TYPE_MAIN_FORUM_PAGE==this.model.pageType){this.collapseAllBoards=this.appendScriptMenuItem("Свернуть разделы");this.expandAllBoards=this.appendScriptMenuItem("Развернуть разделы")}else if(p.PAGE_TYPE_TOPIC==this.model.pageType){this.collapseIgnoredMsgs=this.appendScriptMenuItem("Свернуть игнорируемые сообщения");this.expandIgnoredMsgs=this.appendScriptMenuItem("Развернуть игнорируемые сообщения")}},
appendScriptMenuItem:function(a){new g("CPageView.appendScriptMenuItem",a);var c=document.createElement("A");c.href="#";c.innerHTML=a;m.addEventListener(c,"click",this.controller);if(this.menuCtrl!=null){a=this.menuCtrl.createItem("");a.appendChild(c);this.menuCtrl.insertMenuScriptItem(a)}return c},createButton:function(a,c){new g("CPageView.createButton",c);var b=document.createElement("IMG");b.src=a;b.title=c;b.alt=c;b.height=22;b.width=23;b.align="bottom";b.style.margin="0px 2px 0px 1px";b.style.backgroundImage=
"url(/forum/Themes/default/images/bbc/bbc_bg.gif)";b.style.verticalAlign="middle";m.addEventListener(b,"mouseout",this.controller);m.addEventListener(b,"mouseover",this.controller);var d=document.createElement("A");d.href="#";m.addEventListener(d,"click",this.controller);d.appendChild(b);return d},borderTables:function(){new g("CPageView.borderTables");var a=document.createElement("style");a.type="text/css";if(a.styleSheet)a.styleSheet.cssText=".text .table .table .post table, #preview_section .post table {border: 2px solid rgb(213, 213, 234);border-spacing: 0px;border-collapse: collapse;margin-top: 5px; } .text .table .table .post tr:first-child, #preview_section .post tr:first-child {font-weight: bold; }.text .table .table .post td, #preview_section .post td {border: 1px solid rgb(213, 213, 234);padding: 2px;}";
else a.appendChild(document.createTextNode(".text .table .table .post table, #preview_section .post table {border: 2px solid rgb(213, 213, 234);border-spacing: 0px;border-collapse: collapse;margin-top: 5px; } .text .table .table .post tr:first-child, #preview_section .post tr:first-child {font-weight: bold; }.text .table .table .post td, #preview_section .post td {border: 1px solid rgb(213, 213, 234);padding: 2px;}"));document.getElementsByTagName("head")[0].appendChild(a)},addImageLinks:function(){var a=
new g("CPageView.addImageLinks"),c=x(h.postScaledImages);a.trace("Found images: "+c.snapshotLength);for(a=0;a<c.snapshotLength;++a){var b=c.snapshotItem(a),d=document.createElement("A");d.href=b.src;d.target="_blank";b.parentNode.insertBefore(d,b);d.appendChild(b)}},addImageAlt:function(){var a=new g("CPageView.addImageAlt"),c=x(h.imgEmptyAlt);a.trace("Found images without alt: "+c.snapshotLength);for(a=0;a<c.snapshotLength;++a)c.snapshotItem(a).alt="IMG"},addSaveToArchiveButtons:function(){var a=
new g("CPageView.addSaveToArchiveButtons");if(fa){var c=x(h.tdPostButtons),b=c.snapshotLength;a.trace("Number of found posts: "+b);for(a=0;a<b;++a){var d=c.snapshotItem(a),f=document.createElement("IMG");f.src="/forum/Themes/default/images/btn_save_to_archive.gif";f.style.verticalAlign="middle";f.style.marginTop="-3px";f.style.marginBottom="-4px";f.alt="Сохранить в архив";f.title=f.alt;var i=document.createElement("A");i.href="#";i.appendChild(f);m.addEventListener(i,"click",this.controller,"handleSaveToArchive");
d.appendChild(i)}}else a.error("feature requires jQuery, but it is not found")},updateHeadLinks:function(){var a=new g("CPageView.updateHeadLinks"),c=document.getElementsByTagName("HEAD")[0],b=document.createElement("LINK");b.href="#";b.rel="up";c.appendChild(b);b=document.createElement("LINK");b.href="/forum/index.php?action=search";b.rel="search";c.appendChild(b);b=document.createElement("LINK");b.href="/forum/index.php";b.rel="Index";c.appendChild(b);b=document.createElement("LINK");b.href="/forum/index.php";
b.rel="Contents";c.appendChild(b);b=document.createElement("LINK");b.href="/forum/index.php?action=help";b.rel="Help";c.appendChild(b);if(null!=this.model.firstPageUrl){b=b.cloneNode(true);b.href=this.model.firstPageUrl;b.rel="start";c.appendChild(b);b=b.cloneNode(true);b.rel="first";c.appendChild(b)}if(null!=this.model.lastPageUrl){b=b.cloneNode(true);b.href=this.model.lastPageUrl;b.rel="last";c.appendChild(b)}b=q(h.linkRelPrev);if(null!=this.model.prevPageUrl){if(null==b){a.trace("<link rel='prev'> wasn't found");
b=document.createElement("LINK");b.rel="prev";c.appendChild(b)}b.href=this.model.prevPageUrl}else null!=b&&b.parentNode.removeChild(b);b=q(h.linkRelNext);if(null!=this.model.nextPageUrl){if(null==b){a.trace("<link rel='next'> wasn't found");b=document.createElement("LINK");b.rel="next";c.appendChild(b)}b.href=this.model.nextPageUrl}else null!=b&&b.parentNode.removeChild(b)},addFavicon:function(){new g("CPageView.addFavicon");var a=document.getElementsByTagName("HEAD")[0],c=document.createElement("LINK");
c.href="data:image/x-icon;base64,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";
c.rel="shortcut icon";c.type="image/x-icon";a.appendChild(c)},addCustomCSS:function(){new g("CPageView.addCustomCSS");var a="#postmodify textarea {width: 100%;}.signature a {font-size: 11px !important;text-decoration: none !important;border-bottom: 1px dashed blue;}.signature a * {text-decoration: none !important;}.quote a {text-decoration: underline !important;color: blue !important;}.quoteheader a {text-decoration: none !important;color: black !important;}.quoteheader a:hover {text-decoration: underline !important;color: blue !important;}table.york_menu {position: absolute;padding: 6px 15px 0px 15px !important;}table.york_menu td {padding: 0px 2px 0px 2px !important;}div.york_menu {padding: 0px 8px 1px 12px !important;margin-bottom: 4px !important;}.york_scriptMenu {padding-left: 0px;padding-top: 2px;padding-bottom: -2px;margin-top: 0px;margin-bottom: 0px;text-align: right; }.york_scriptMenu li {margin-left: 9px;display: inline; }.york_scriptMenu li a {color: black;text-decoration: none; }a.york_moderator {font-weight: bold !important; }a.york_avanturist {font-weight: bold !important;font-size: 14px !important;color: green !important; }a.york_moderator:hover, a.york_avanturist:hover {text-decoration: underline !important;color: blue !important; }.message_hidden_york {border: 1px solid #3C61A4;background-color: #d5d5ea !important; }.message_hidden_york td {background-color: #e8e8ff !important; }.message_hidden_york .ga_message_expert_vote_rate {float: right; }a[ctrl_idx], a[board_idx] {text-decoration: none !important; }.boardTable label span {display: inline-block;width: 3px;height: 3px;padding: 0px;margin-left: 2px;margin-right: 4px;margin-bottom: 0px;outline: 1px solid black;border: 1px solid white; }.cbHideUnchecked {background-color: white; }.cbHideChecked {background-color: black; }.boardTable small label {position: absolute; }";
if(C)a+=".boardTable small {position: relative; }.boardTable small label {white-space: nowrap;position: absolute; }";var c=document.createElement("style");c.type="text/css";if(c.styleSheet)c.styleSheet.cssText=a;else c.appendChild(document.createTextNode(a));document.getElementsByTagName("head")[0].appendChild(c)},addScriptVersion:function(){var a=new g("CPageView.addScriptVersion"),c=q(h.brCopyright);if(null==c)a.error("BR wasn't found");else{a=document.createElement("SPAN");var b=document.createElement("A");
b.href="/forum/index.php/topic,196.html";b.innerHTML="Патч к форуму v"+la+" от "+ma;b.style.fontWeight="normal";b.style.color="#666666";a.appendChild(document.createTextNode(" | "));a.appendChild(b);c.parentNode.insertBefore(a,c)}},addEditButtons:function(){var a=new g("CPageView.addEditButtons");this.textArea=q(h.textareaMessage,s("postmodify"));if(this.textArea==null)a.error("the text area wasn't found");else{var c=q(h.brToolbar,s("postmodify"));if(c==null)a.error("<br> in the buttons cell wasn't found");
else{a=c.parentNode;a.removeChild(c);for(c=0;c<a.childNodes.length;++c){var b=a.childNodes[c];if(b.tagName!=null&&b.tagName=="IMG"){a.appendChild(b.cloneNode(true));a.appendChild(document.createTextNode(" "));break}}this.btnFormatTable=this.createButton("/forum/Themes/default/images/bbc/flash.gif","Форматировать таблицу");a.appendChild(this.btnFormatTable);this.btnPre=this.createButton("/forum/Themes/default/images/bbc/code.gif","Код");a.appendChild(this.btnPre);this.btnUrl=this.createButton("/forum/Themes/default/images/bbc/url.gif",
"Вставить URL");a.appendChild(this.btnUrl);this.btnQuote=this.createButton("/forum/Themes/default/images/bbc/quote.gif","Цитата");a.appendChild(this.btnQuote)}}},removeHideMessageOptions:function(){var a=new g("CPageView.removeHideMessageOptions"),c=q(h.selectAutoHide,s("postmodify"));if(c!=null)for(a=c.length-1;0<=a;--a)c.options[a].value.indexOf("Hide")!=-1&&c.remove(a);else a.error("select wasn't found")},highlightModerators:function(){var a=new g("CPageView.highlightModerators"),c=x(h.smallModerators);
a.trace("Number of found SMALL tags: "+c.snapshotLength);for(var b=/^[^:]+:\s*(.*)/,d=/,\s/g,f=",ConstB,",i=0;i<c.snapshotLength;++i){var l=c.snapshotItem(i).innerHTML;l=b.exec(l);if(l!=null){l=l[1];l=l.replace(d,",");f+=l+","}}a.trace("Moderator list: "+f);c=x(h.aUsersOnline);a.trace("Number of found users: "+c.snapshotLength);for(i=0;i<c.snapshotLength;++i){b=c.snapshotItem(i);if(f.indexOf(","+b.innerHTML+",")>0){a.trace("Moderator: "+b.innerHTML);b.className+=" york_moderator"}else if(b.innerHTML==
"avanturist"&&b.href.indexOf("u=3")!=-1){a.trace("Avanturist is online!");b.className+=" york_avanturist"}}}};m={controllers:[],run:function(){new g("app.run");this.hotKeys=[];document.addEventListener("keydown",m.keyPressed,false);this.pageController=new da;if(/index\.php.+topic[=,]/.test(t)||/forum\/topic\/\d+/.test(t)){var a=new g("handleTopicPage"),c=P();a.trace("topic_id = "+c);if(c!=null){var b=new g("createGotoPageForms",c);a=q(h.h1TopicTitle);if(null!=a){var d=a.innerHTML.lastIndexOf(" ("),
f=document.createElement("DIV");f.style.cssFloat="right";f.style.paddingRight="10px";f.innerHTML=a.innerHTML.substr(d);a.innerHTML=a.innerHTML.substr(0,d);a.appendChild(f)}a=x(h.bPagerDots);b.trace("Number of found three dots: "+a.snapshotLength);for(b=0;b<a.snapshotLength;++b){d=a.snapshotItem(b);f=document.createElement("A");f.innerHTML="...";f.href="#";f.setAttribute("div_id","york_div"+b);f.setAttribute("input_id","york_page"+b);f.addEventListener("click",ga,false);f.style.fontWeight="bold";f.style.fontSize=
"inherit";f.style.textDecoration="underline";var i=document.createElement("SPAN");i.id="york_span"+b;i.innerHTML=na.replace(/%idx%/g,b);d.innerHTML="";d.appendChild(document.createTextNode(" "));d.appendChild(f);d.appendChild(i);d.appendChild(document.createTextNode(" "));d=s("york_form"+b);d.setAttribute("idx",b);d.addEventListener("submit",ha,false);s("york_topic"+b).value=c}}a=new g("processMessageLinks");c=x(h.postLinks);a.trace("number of found links: "+c.snapshotLength);for(a=0;a<c.snapshotLength;++a){d=
b=c.snapshotItem(a);f=new g("cutLongLink",d);i=d.href;var l=d.innerHTML;if(i.indexOf("http://www.avanturist.org/redirect.php?url=")==0)i=i.substr(43);if(i.indexOf("http://")==0&&l.indexOf("http://")==0&&l.length>80){var o=i==l;if(o)f.trace("href == html");else{var v=l.replace(/&amp;/g,"&");if(o=i==v)f.trace("href == htmlAmp");else{o=void 0;try{o=decodeURI(i)}catch(S){o=i;f.error("Can't decode href: "+i)}var G=void 0;try{G=decodeURI(v)}catch(oa){G=v;f.error("Can't decode htmlAmp: "+v)}o=o==G}}if(o){f.trace("Found long link: "+
i);d.innerHTML=l.substr(0,77)+"...";d.style.fontStyle="italic"}}if(b.href.indexOf("http://www.avanturist.org/redirect.php?url=")==0)b.href=b.href.replace(/&/g,"%26")}}else if(/index\.php.+board[=,]/.test(t))new g("handleBoardPage");else if(/\/forum\//.test(t))if(null!=q(h.tableBoardTable)){c=new g("handleForumMainPage");if(m.controllers[0].settings.sett_collapseTopics){E=new I;E.collapse()}else c.trace("Don't collapse the read topics")}else new g("handleOtherForumPages");else new g("handleOtherSitePages")},
addController:function(a){a.idx=m.controllers.length;m.controllers[a.idx]=a},actionHandler:function(a){var c=new g("app.actionHandler");a=a||window.event;for(var b=a.srcelement?a.srcelement:a.target,d=b.getAttribute("ctrl_idx");d==null;){b=b.parentNode;if(b!=null&&typeof b.getAttribute=="function")d=b.getAttribute("ctrl_idx");else break}if(d==null){b=a.srcelement?a.srcelement:a.target;c.error("Controller index wasn't found. Event: type = "+a.type+", src = "+b);return true}var f=m.controllers[parseInt(d)];
if(f!=null){b=(c=b.getAttribute("ctrl_handler"))?f[c](b,a):f.handle(b,a);if(!b){a.returnValue=false;typeof a.preventDefault!="undefined"&&a.preventDefault()}return b}else{c.error("Controller wasn't found. Event: type = "+a.type+", src = "+b+", controllerIdx = "+d);return true}},addEventListener:function(a,c,b,d){new g("app.addEventListener",b.idx);a.setAttribute("ctrl_idx",b.idx);d&&a.setAttribute("ctrl_handler",d);a.addEventListener(c,m.actionHandler,false)},keyPressed:function(a){var c=new g("app.keyPressed");
a=a||window.event;var b=a.which||a.keyCode,d="";d+=a.altKey?"alt+":"";d+=a.ctrlKey?"ctrl+":"";d+=a.shiftKey?"shift+":"";d+=b;c.trace("Hot key: "+d);a=m.hotKeys[d];if(null!=a){c.trace("Controllers count: "+a.length);for(c=0;c<a.length;++c)a[c].handleHotKey(d);return false}return true},addHotKey:function(a,c){new g("app.addHotKey",a);var b=a.toLowerCase(),d=this.hotKeys[b];if(d==null){d=[];this.hotKeys[b]=d}d.push(c)}};m.run();F=new Date;A.trace("END: "+F);A.trace("SCRIPT TOOK "+(F.getTime()-Q.getTime())+
" ms");A.trace("NUMBER OF XPATH QUERIES: "+T)}var la="0.11.18",ma="28.08.2011",m,u=typeof unsafeWindow!="undefined"?unsafeWindow:window,N=navigator.userAgent.toLowerCase(),D=/opera/.test(N),C=/chrome/.test(N),K=/firefox/.test(N),t=location.href;t.replace(/#.*/,"");var z=/^.*#enable_log$/.test(t),Q,T=0,na="<div id='york_div%idx%' style='visibility: hidden; z-index: 10; position: absolute; background-color: rgb(245, 245, 250); border-style: solid; border-width: 1px; border-color: rgb(60, 97, 164); padding: 3px; font-size: 13px; color: #000000;'>  <form id='york_form%idx%' method='get' action='/forum/index.php'>    <input type='hidden' id='york_topic%idx%' name='topic' value=''/>    <input type='hidden' id='york_start%idx%' name='start' value=''/>    Номер страницы:    <input type='text' id='york_page%idx%' value='' maxlength='4' size='4'/>    <input type='submit' value='Перейти'/>  </form></div>",
g;g=z?function(e){this.context="AVANTURIST.ORG "+e+"() ";this.errorContext="AVANTURIST.ORG ERROR "+e+"() ";var j=arguments.length;if(1<j){for(var k="Arguments: ",n=1;n<j;++n){if(n!=1)k+=", ";k+=arguments[n]}this.trace(k)}else this.trace("")}:function(e){this.errorContext="AVANTURIST.ORG ERROR "+e+"() "};g.prototype.trace=z?D?function(e){opera.postError(this.context+e)}:C?function(e){console.log(this.context+e)}:K?function(e){GM_log(this.context+e)}:function(){}:function(){};g.prototype.error=D?function(e){opera.postError(this.errorContext+
e)}:C?function(e){console.error(this.errorContext+e)}:K?function(e){GM_log(this.errorContext+e)}:function(){};var h=function(){};h.linkRelPrev="/html/head/link[@rel='prev']";h.linkRelNext="/html/head/link[@rel='next']";h.imgEmptyAlt="//img[@alt='']";h.divMain="./div[@class='main']";h.divMenuSite=h.divMain+"/div[ @class='topMenu' and div[position()=1 and @class='link'] ]";h.divMenuUser=h.divMenuSite+"/following-sibling::div[1]";h.tableMenuUser=h.divMenuUser+"/table[not(@class)]";h.tdCabinet="./tbody[1]/tr[1]/td[2]";
h.tableRowMenuUser=h.tableMenuUser+"/tbody[1]/tr[1]";h.aSignup=h.tableRowMenuUser+"/td/a[contains(@href, '/signup')]";h.divContainer=h.divMain+"/div[@class='container']";h.divContent=h.divContainer+"/div[@class='content-leftcenter']";h.tableMenuForum=h.divContent+"/table[1]";h.trMenuForum=h.tableMenuForum+"/tbody[1]/tr[1]";h.bPagerDots=h.divContent+"//b[ contains(text(), '...') and 0<count(preceding-sibling::a[@class='navPages']) ]";h.tableBoardTable=h.divContent+"/table[contains(@class, 'boardTable')]";
h.trBoard=h.tableBoardTable+"/tbody[1]/tr[ th[6<=number(@colspan)]/table[@class='boardTable'] ]";h.trBoardContent="./th/table[@class='boardTable']/tbody[1]/tr[1]";h.smallModerators=h.trBoard+"/th[1]/table[@class='boardTable']/tbody[1]/tr/th/small | "+h.tableBoardTable+"/tbody[1]/tr/td[2]/small";h.aUsersOnline=h.tableBoardTable+"/following-sibling::table/tbody[1]/tr[3]/td[2]/a[contains(@href, 'profile')]";h.divBottom=h.divMain+"/div[@class='bottom']";h.brCopyright=h.divBottom+"/br[1]";h.divMessages=
h.divContent+"/div[@class='textwoshadow']/div[@id='messagesDiv']";h.msgTable=h.divMessages+"/table[@class='table']";h.msgTableBody=h.msgTable+"/tbody[1]";h.trMsgTitle=h.msgTableBody+"/tr[1]/td[2]/table[1]/tbody[1]/tr[1]";h.aMsgAuthor=h.msgTableBody+"/tr[1]/td[1]/a[contains(@href,'profile')]";h.tdPostButtons=h.msgTableBody+"/tr[1]/td[2]/table/tbody[1]/tr[1]/td[last()]";h.aSaveToJournalBtn="../../../td[2]/table/tbody[1]/tr[1]/td[2]/a[@class='all_save_to_journal']";h.btnReply=h.trMsgTitle+"/td/a[contains(@href, 'action=post')]";
h.postBody=h.msgTableBody+"/tr[2]/td[2]/div[@class='post']";h.postLinks=h.postBody+"//a";h.postScaledImages=h.postBody+"//img[not(contains(@src, 'avanturist.org/')) and starts-with(@src, 'http://') and string-length(@width) > 0 and string-length(@height) > 0 and count(ancestor::a)=0 ]";h.bMsgAuthor="./tbody/tr[1]/td[1]/a";h.aMsgHeadLinks="./tbody/tr[1]/td[2]/table/tbody/tr[1]/td[1]/a";h.divRating="./tbody/tr[3]/td[2]/table/tbody/tr[1]/td[1]/div";h.tdBottomPageNav=h.divContent+"/table[not(@id)]/tbody[1]/tr[1]/td[@class='middletext']/";
h.bCurrentPage=h.tdBottomPageNav+"/b[following-sibling::node()[position()=1 and contains(self::text(), ']')]]";h.aLastPage=h.tdBottomPageNav+"/a[@class='navPages' and position()=last()]";h.tbodyMessageForm="./table[2]/tbody[1]/tr[2]/td[1]/table[1]/tbody[1]";h.textareaMessage=h.tbodyMessageForm+"/tr/td[2]/textarea[@name='message']";h.selectAutoHide=h.tbodyMessageForm+"/tr[4<position()]/td[2]/select[ option[contains(@value, 'Hide')] ]";h.brToolbar=h.tbodyMessageForm+"/tr[position()<5]/td[2]/br[ preceding-sibling::img[position()=1 and @alt='|'] ]";
var E;I.onClick=function(e){new g("CTopicWrapper.onClick");e=e||window.event;var j=e.srcelement?e.srcelement:e.target,k=j.getAttribute("board_idx");j=E.boards[k].onClick(j);e.returnValue=j;!j&&typeof e.preventDefault!="undefined"&&e.preventDefault();return j};I.prototype={collapse:function(){new g("CTopicWrapper.collapse");for(var e=0;e<this.boards.length;++e)this.boards[e].collapse()},expand:function(){new g("CTopicWrapper.expand");for(var e=0;e<this.boards.length;++e)this.boards[e].expand()},boards:[]};
U.prototype={collapse:function(){for(var e=new g("CBoard.collapse",this.board.rowIndex),j=0;j<this.hiddenTopics.length;++j)this.hiddenTopics[j].collapse();if(this.href!=null)this.spanToggle.innerHTML=this.expandText;else e.error("this.href == null. It isn't expected");this.isCollapsed=true},expand:function(){for(var e=new g("CBoard.expand"),j=0;j<this.hiddenTopics.length;++j)this.hiddenTopics[j].expand();if(this.href!=null)this.spanToggle.innerHTML=this.collapseText;else e.error("this.href == null. It isn't expected");
this.isCollapsed=false},changeCollapseSetting:function(){new g("CBoard.changeCollapseSetting");var e=m.controllers[0].settings;if(this.collapseAlways){this.collapseAlways=false;this.cbHide.className="cbHideUnchecked";delete e.hiddenBoards[this.idx]}else{this.collapseAlways=true;this.cbHide.className="cbHideChecked";e.hiddenBoards[this.idx]=true}e.save();this.cbHideForceRedraw()},cbHideForceRedraw:function(){new g("CBoard.cbHideForceRedraw");0<this.cbHide.childNodes.length?this.cbHide.removeChild(this.cbHide.childNodes[0]):
this.cbHide.appendChild(document.createTextNode(" "))},onClick:function(e){new g("CBoard.onClick");if(e==this.spanToggle||e==this.spanMsg||e==this.href){this.isCollapsed?this.expand():this.collapse();return false}else if(e==this.cbHide||e==this.lblHide){this.changeCollapseSetting();return false}else return true},collapseText:"СВЕРНУТЬ",expandText:"РАЗВЕРНУТЬ",allUnreadText:"Прочитанных тем нет",collapseAlwaysText:"всегда сворачивать"};y.find=function(e){new g("CTopic.find");e=e.getAttribute("topicId");
if(e==null)return null;return y.topics[e]};y.topics=[];y.nextId=0;y.prototype={collapse:function(){new g("CTopic.collapse");this.topic.style.display="none"},expand:function(){new g("CTopic.expand");this.topic.style.display=""}};z=new g("GLOBAL",t);z.trace("User-Agent: "+N);z.trace("Opera/Firefox/Chrome = "+D+"/"+K+"/"+C);if(/^https?:\/\/(www\.)?avanturist.org(\/|\?|$)/.test(t)){D&&/myarchive/.test(t)&&window.opera.addEventListener("BeforeExternalScript",function(e){e.element.getAttribute("src").match(/ga_mycolumns\.js$|ga_myjournal\.js$/)&&
e.preventDefault()},false);if(D)if(document.readyState=="complete"){z.trace("Opera. Document has loaded. Calling onLoad()");J()}else if(typeof opera.version=="function"&&opera.version()>=9){z.trace("Opera 9.x. Subscribing on the DOMContentLoaded event");document.addEventListener("DOMContentLoaded",J,false)}else{z.trace("Opera older then 9.0. Subscribing on the load event");document.addEventListener("load",J,false)}else{z.trace("Firefox or Chrome. Calling onLoad()");J()}}else z.trace(t+" - isn't avanturist.org. Do nothing.")})();
