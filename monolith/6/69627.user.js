// ==UserScript==
// @name           music.douban + xiami
// @namespace      http://sospartan.xiami.com
// @description    Inserts xiami links on music.douban.com
// @include        http://music.douban.com/*
// @exclude		   http://music.douban.com/mine/*
// ==/UserScript==
function cleanurl(b){return b.replace(/%25([0-9]{2})/,"%$1")}function trim(b){return b.replace(/^\s+/,"").replace(/\s+$/,"")}function createLink(d){var b=document.createElement("a");b.href=d;b.target="_blank";b.title="listen in Xiami.com";b.setAttribute("xiamiLink",true);var c=document.createElement("img");c.style.border="none";c.style.marginLeft="3px";c.src="data:image/png;charset=utf-8;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAJCAYAAAALpr0TAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAABh0RVh0U29mdHdhcmUAUGFpbnQuTkVUIHYzLjM2qefiJQAAAPxJREFUKFNjZICC13EMoaxSMquYePlhQnD697PHCDGQwh+Lff7/P1aIgT81qv2HqwQrnOP0/+d8t//fplrD8Z81wf8/1SqiKZxs8f9tKsceoCZzGP5cp/T/U6UMmsIu3f9ABauQHfmpROw/CDMAJYSA2OBNIlPlz0ZlsEIgZgViLSA2+1wo/P9TvuB/hnfJrKu/dtp+/tGg9f9vvTxMYeyXKtWn36YF/ftTI/3/Uxb3f4aPRbK//7Xq/f9fLvb/Zz4fSGE7EC/5W6fy/3+V9P8/xYL/P6Sw3md4l8A051MKy1cg/v0hiXkrUJEgEPt8TGZ+DhT7D6SvA9V4AQA78aLQOkpNkwAAAABJRU5ErkJggg==";b.appendChild(c);return b}function addLinks(k){if(k.hasAttribute("xiamiLinksAdded")){return}k.setAttribute("xiamiLinksAdded",true);var l=/^http:\/\/(.*\.|)(last\.fm|lastfm\.[^\/]+)\/music\/([^\?#]*)$/i;var b=k.getElementsByTagName("a");for(var g=0;g<b.length;g++){var d=b[g];if(!d.href||trim(d.textContent)==""||d.className.match(/\blfmButton\b/)){continue}if(m=l.exec(d.href)){var n=false;parts=m[3].split("/");for(var f=0;f<parts.length;f++){if(parts[f][0]=="+"){n=true;break}}if(n){continue}var c=d;while(c!=null){if(c.id&&c.id.match(/^(secondaryNavigation|featuredArtists)$/)||c.className&&c.className.match(/\b(pagehead|image|artistsMegaWithFeatured)\b/)){n=true;break}c=c.parentNode}if(n){continue}q=["artist="+cleanurl(parts[0])];if(parts[1]&&parts[1]!="_"){q.push("album="+cleanurl(parts[1]))}if(parts[2]){q.push("song="+cleanurl(parts[2]))}var h=createLink("http://www.xiami.com/search/find?"+q.join("&"));if(!d.nextSibling||!d.nextSibling.hasAttribute||!d.nextSibling.hasAttribute("xiamiLink")){d.parentNode.insertBefore(h,d.nextSibling)}}}}function insertafter(b,c){c.parentNode.insertBefore(b,c.nextSibling)}var navs=document.getElementById("nav").childNodes;var nav_music;for(var r=0;r<navs.length;r++){if(navs[r].href=="http://music.douban.com"){var nav_music=navs[r];break}}if(nav_music&&nav_music.className=="now"){try{var as=document.getElementsByTagName("a");for(var i=0;i<as.length;i++){if(as[i].href.match(/\/artist\/[^\/]+(\/)?$/)&&as[i].textContent.replace(/^\s+/,"").replace(/\s+$/,"")!=""){insertafter(createLink("http://www.xiami.com/search/find?artist="+encodeURIComponent(as[i].textContent)),as[i])}}}catch(e){}try{var artist=document.getElementById("info")?(document.getElementById("info").getElementsByTagName("a")[0]):null;var h1=document.getElementsByTagName("h1")[0];if(artist&&h1){h1.appendChild(createLink("http://www.xiami.com/search/find?artist="+encodeURIComponent(artist.textContent)+"&album="+encodeURIComponent(h1.textContent)));insertafter(createLink("http://www.xiami.com/search/find?artist="+encodeURIComponent(artist.textContent)),artist)}}catch(e){}try{var href=window.location.href;if(href.match(/\/artist\/[^\/]+(\/)?$/)){var h1=document.getElementsByTagName("h1")[0];if(h1){h1.appendChild(createLink("http://www.xiami.com/search/find?artist="+encodeURIComponent(h1.textContent)))}}}catch(e){}try{var divs=document.getElementById("in_tablem")?document.getElementById("in_tablem").getElementsByTagName("div"):[];for(var i=0;i<divs.length;i++){if(divs[i].className=="pl2"){var a=divs[i].getElementsByTagName("a")[0];insertafter(createLink("http://www.xiami.com/search/find?album="+encodeURIComponent(a.textContent.split("/")[0])),a)}}}catch(e){}try{var spans=document.getElementById("in_tablem")?document.getElementById("in_tablem").getElementsByTagName("span"):[];for(var i=0;i<spans.length;i++){if(spans[i].className=="starb"){var a=spans[i].getElementsByTagName("a")[1];if(!a){continue}insertafter(createLink("http://www.xiami.com/search/find?album="+encodeURIComponent(a.textContent)),a)}}}catch(e){}try{var lis=document.getElementsByTagName("li");lis=lis?lis:[];for(var i=0;i<lis.length;i++){if(lis[i].className=="clearfix"){var a=lis[i].getElementsByTagName("a")[1];if(a.href.indexOf("/subject/")>=0){insertafter(createLink("http://www.xiami.com/search/find?album="+encodeURIComponent(a.textContent)),a)}}}var dls=document.getElementsByTagName("dl");dls=dls?dls:[];for(var i=0;i<dls.length;i++){if(dls[i].className!="obu"){var a=dls[i].getElementsByTagName("a")[1];if(!a){continue}if(a.href.indexOf("/subject/")>=0){insertafter(createLink("http://www.xiami.com/search/find?album="+encodeURIComponent(a.textContent)),a)}}}}catch(e){}};
