// ==UserScript==
// @name Bucket Updater Script
// @namespace mcf
// @version 0.1.1.5
// @description my bucket list
// @include     *://*.mafiawars.zynga.com/mwfb/*
// @include     *://www.mafiawars.zynga.com/play*
// @include     *://apps.facebook.com/inthemafia*
// @match     	*://*.mafiawars.zynga.com/mwfb/*
// @match     	*://www.mafiawars.zynga.com/play*
// @match     	*://www.facebook.com/dialog/feed*
// @match     	*://apps.facebook.com/inthemafia*
// @icon           http://mwscripts.screepts.netdna-cdn.com/images/lucifersicon.jpg
// @grant 		    GM_xmlhttpRequest
// @grant       	GM_getValue
// @grant       	GM_setValue
// @grant       	GM_deleteValue
// ==/UserScript==


function injectScript(e){var t=function(e){return Object.prototype.toString.call(e)=="[object Function]"};var n=function(e){if(!e||!e.length)return e;var t=/['"<>\/]/g,n="",r=0,i;do{i=t.exec(e);n+=i?e.substring(r,t.lastIndex-1)+"\\x"+i[0].charCodeAt(0).toString(16):e.substring(r)}while(i&&(r=t.lastIndex)>0);return n.length?n:e};var r=t(e);var i=document.createElement("script");var s,o,u="";if(r){var a=[];for(var f=1;f<arguments.length;f++){var l=arguments[f];var c;if(t(l))c='eval("'+n("("+l.toString()+")")+'")';else if(Object.prototype.toString.call(l)=="[object Date]")c="(new Date("+l.getTime().toString()+"))";else if(Object.prototype.toString.call(l)=="[object RegExp]")c="(new RegExp("+l.toString()+"))";else if(typeof l==="string"||typeof l==="object")c='JSON.parse("'+n(JSON.stringify(l))+'")';else c=l.toString();a.push(c)}while(u.length<16)u+=String.fromCharCode(!u.length||Math.random()>.5?97+Math.floor(Math.random()*25):48+Math.floor(Math.random()*9));s="(function(){var value={callResult: null, throwValue: false};try{value.callResult=(("+e.toString()+")("+a.join()+"));}catch(e){value.throwValue=true;value.callResult=e;};"+"document.getElementById('"+u+"').innerText=JSON.stringify(value);})();";i.id=u}else{s=e}i.type="text/javascript";i.innerHTML=s;document.head.appendChild(i);if(r){o=JSON.parse(i.innerText);i.parentNode.removeChild(i);delete i;if(o.throwValue)throw o.callResult;else return o.callResult}else return i}var BucketUpdaterWrapper="("+function(){function i(e){var t=new Date;var n=t.getHours()%12;n=n<10?"0"+n:n;var r=t.getMinutes();r=r<10?"0"+r:r;var i=t.getHours()>12?" pm":" am";if(e){var s=new Date;var o=s.getDate();var u=s.getMonth()+1;if(o<10){o="0"+o}if(u<10){u="0"+u}s=o+"/"+u;if(e=="both"){return'<span class="more_in">['+n+":"+r+i+" | "+s+"]</span> "}else{return'<span class="more_in">['+s+"]</span> "}}else{return'<span class="more_in">['+n+":"+r+i+"]</span> "}}function s(){$(document).ready(function(){function p(){if(r.verified){e.verifyBucketButton.toggleClass("hide",true)}e.bucketID.val(r.id);e.bucketAuth.val(r.auth);a.toggleClass("hide")}$.extend(true,r,b());m();g();var i=$("#"+t.namespace+"Main");var a=$("#"+t.namespace+"Tabs");e.startBucketButton=$("."+t.namespace+"Start_Bucket");e.stopBucketButton=$("."+t.namespace+"Stop_Bucket");e.log=$("#"+t.namespace+"Status");e.EnableRestart=$("#"+t.namespace+"EnableRestart");e.SaveSettings=$("#"+t.namespace+"SaveSettings");e.verifyBucketButton=$("."+t.namespace+"Verify_Bucket");e.SetupBucket=$("#"+t.namespace+"Settings");e.bucketID=$("#"+t.namespace+"Bucket_ID");e.bucketAuth=$("#"+t.namespace+"Bucket_Auth");e.verifyMessage=$("#"+t.namespace+"VerifyMessage");a.tabs().css({height:"300px",overflow:"hidden"});var f=$("#"+t.namespace+"ListMessage");var l=$("#"+t.namespace+"AddRival");var c=$("#"+t.namespace+"BulkAddRival");l.live("click",function(){t.stop=false;if(!r.verified){alert("Need to activate bucket");return}var e=$(this).attr("rival_id");r.addToBucket.push(e);d(function(){alert(e+" Added To Bucket")})});c.live("click",function(){t.stop=false;if(!r.verified){alert("Need to activate bucket");return}if(t.tmpRivals.length<1){alert("Bulk adding failed")}var e=confirm("Add "+t.tmpRivals.length+" rivals to bucket?");if(e){r.addToBucket=t.tmpRivals;d(function(){alert(" Added To "+t.tmpRivals.length+" rivals to Bucket")})}});e.SaveSettings.click(function(){w()});e.startBucketButton.click(function(){e.log.toggleClass("disabled",false);e.startBucketButton.toggleClass("disabled",true);e.startBucketButton.toggleClass("hide",true);e.stopBucketButton.toggleClass("hide",false);t.stop=false;S()});e.verifyBucketButton.click(function(){r.id=$.trim(e.bucketID.val());r.auth=$.trim(e.bucketAuth.val());if(r.id.length<1||r.auth.length<1){alert("Missing Bucket ID or Bucket Auth");return}e.SetupBucket.toggleClass("disabled",true);e.verifyBucketButton.toggleClass("disabled",true);if(r.updated)return;var t={action:"verify_bucket",bucket_id:r.id,bucket_auth:r.auth,type:"POST"};M(t,function(t){if(Util.isset(t.data.verified)){r.verified=t.data.verified}if(r.verified==false){e.verifyMessage.text("Failed to verify bucket, check bucket id & bucket auth").fadeOut(7e3,function(){e.verifyMessage.empty();e.verifyMessage.show()});e.verifyBucketButton.toggleClass("disabled",false);e.SetupBucket.toggleClass("disabled",false);return}e.verifyMessage.text("Verified and loaded bucket "+t.data.bucket_name);v(function(n){e.verifyBucketButton.toggleClass("hide",true);e.SetupBucket.toggleClass("hide",true);e.startBucketButton.toggleClass("hide",false);w("Verified bucket "+t.data.bucket_name+" loaded "+r.list.length+" rivals")})})});$("."+t.namespace+"BucketList-Tab").click(function(){if(r.list.length<1)f.text("No rivals in bucket, Add rival or go to bucket auth tab & click update");return});e.stopBucketButton.click(function(){if($(this).hasClass("disabled"))return;e.stopBucketButton.toggleClass("disabled",true);t.stop=true;t.processing=false;e.log.toggleClass("disabled",true);h("Stopping ",5,function(){e.log.text("STOPPED");e.startBucketButton.toggleClass("hide",true);e.stopBucketButton.toggleClass("hide",true);e.stopBucketButton.toggleClass("disabled",false);e.startBucketButton.toggleClass("hide",false);e.startBucketButton.toggleClass("disabled",false)})});$("."+t.namespace+"CloseOpenTabs").click(p);$("#"+t.namespace+"CloseToolbar").click(function(){t.stop=true;l.die();c.die();$(document).unbind("ajaxComplete.BucketUpdater");i.unbind();i.die();i.remove();r=null;t=null;n=null;s=null});$(document).bind("ajaxComplete.BucketUpdater",function(e,t,n){try{if(!/xw_controller/.test(n.url)){return}var r=/<!--\s*Current\s*Page:\s*(\w+)/;var i;if(i=r.exec(t.responseText)[1]){console.log("Parsing Page");var s=$("#inner_page").attr("class");o(s)}}catch(e){}});u()})}function o(e){if(!Util.isset(e))console.log("parsePage",e);t.page=e;switch(t.page){case"fight_controller":break;case"stats_controller":c();break;case"clan_controller":l();break}}function u(){p("Loaded Bucket System Updater v"+t.version,true);r.updated=false;var n=$("#inner_page").attr("class");o(n);e.bucketID.val(r.id);e.bucketAuth.val(r.auth);e.EnableRestart.prop("checked",r.settings.EnableRestart);if(r.verified){e.verifyBucketButton.toggleClass("hide",true);e.SetupBucket.toggleClass("hide",true);e.startBucketButton.toggleClass("hide",false);p("LOADING BUCKET....");v(function(e){if(r.list.length<1){t.stop=true;p("Need to add targets to bucket");return}else{p("Click start to run live target checking")}})}else{e.verifyBucketButton.toggleClass("hide",false);e.SetupBucket.toggleClass("hide",false);e.startBucketButton.toggleClass("hide",true);p("Click on setup icon and setup bucket",true)}if(r.settings.EnableRestart==true&&r.verified==true){p("Auto Starting Bucket System",true);e.startBucketButton.toggleClass("disabled",true);e.startBucketButton.toggleClass("hide",true);e.stopBucketButton.toggleClass("hide",false);h("STARTING IN ",10,S)}}function f(){e.startBucketButton.toggleClass("hide");e.stopBucketButton.toggleClass("hide");e.startBucketButton.toggleClass("disabled",false)}function l(){console.log("Checking addClanPageButtons");if($("#"+t.namespace+"BulkAddRival").length>0)return;t.tmpRivals=[];$("#clan_members").find(".member_sort").each(function(){var e=$(this).find(".name_n_rank > a").attr("href");var n;if(n=/user=([^\n]+)/g.exec(e)){var r=unsafeWindow.atob(unescape(n[1]));$(this).find(".clanmember_stats td:last").after("<td>"+'<a id="'+t.namespace+'AddRival" href="#" rival_id ="'+r+'" title="Bucket Updater Script | Add this member to your bucket">'+'<span><img src="https://zynga1-a.akamaihd.net/mwfb/mwfb/graphics/clan/family_quest/family_quest_icon.png" width="28px" height="28px" /></span>'+"</a>"+"</td>");t.tmpRivals.push(r)}});$('<div><a id="'+t.namespace+'BulkAddRival" class="sexy_button_new mw_new_ajax medium red" title="Bucket Updater Script | Add this clan to your bucket" style="float: right; margin: 0px 5px;"><span><span>Add Family To Bucket</span></span></a></div>').css({padding:"0px 10px","text-align":"left","font-weight":"bold",height:50,"margin-top":10}).insertAfter("#clan_profile_link")}function c(){console.log("Checking addProfilePageButtons");var e=$.trim($("#profile_link").text());console.log(e.length);var n;if(n=/"user":"(.*)"/.exec(decodeURIComponent(e))){n=atob(n[1]);if($("#"+t.namespace+"AddRival").length>0){return}$('<div><a id="'+t.namespace+'AddRival" rival_id="'+n+'" class="sexy_button_new mw_new_ajax medium red" title="Bucket Updater Script | Add Rival to your bucket" style="float: right; margin: 0px 5px;"><span><span>Add To Bucket</span></span></a></div>').css({padding:"0px 10px","text-align":"left","font-weight":"bold",height:50,"margin-top":10}).insertAfter(".title.stats_title")}else{console.log("Failed to get p|id");return false}}function h(n,r,i){if(t.timerEvent!=null)clearTimeout(t.timerEvent);setTimeout(function(){e.log.text(n.trunc(30));e.log.append('<span id = "'+t.namespace+'Timer">'+r+"</span>");$timer=$("#"+t.namespace+"Timer");t.timerEvent=setInterval(function(){var e=parseInt($timer.text());r--;$timer.text(r);if(r<1){clearInterval(t.timerEvent);t.timerEvent=null;if(typeof i=="function")i&&i()}},1e3)},10)}function p(n,r){var r=typeof r==="undefined"?false:r;if(e.log.hasClass("disabled"))return;e.log.text(n.trunc(40));if(r){var s=$("#"+t.namespace+"FullLog");var o=$(".full-log",s).length;s.prepend('<div class="full-log"><span id="'+o+'">'+i()+"</span><span>"+n+"</span></div>");if(o>30){s.find(".full-log:last",s).remove()}}var s=null;var o=null;var n=null}function d(e){var t={action:"add_rivals",bucket_id:r.id,bucket_auth:r.auth,mw_ids:r.addToBucket,type:"POST"};M(t,function(t){p("Added "+r.addToBucket.length+" to bucket");$.extend(r.list,r.addToBucket);if(typeof e=="function")e&&e()})}function v(e){if(t==null||t.stop)return;p("Getting Bucket Details");var n={action:"get_bucket",bucket_id:r.id};M(n,function(n){theBucket=n.data;if(n.data.length>0){$("#"+t.namespace+"List").removeClass("hide")}r.list=[];$.each(theBucket,function(e,t){console.log("rival.mw_id",t.mw_id);if(t.mw_id!=null)r.list.push(t.mw_id)});$("#"+t.namespace+"BucketList").val(r.list.join("\n"));$("#"+t.namespace+"Bucket_TotalTargets").text(r.list.length);p("Loaded "+r.list.length+" rivals",true);if(typeof e=="function")e&&e()})}function m(){if($("#BucketUpdaterCSS").length>0)$("#BucketUpdaterCSS").remove();$("link[href*='ui-lightness']").remove();$("link[href='http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.6/themes/ui-darkness/jquery-ui.css']").remove();$('<link type="text/css" rel="stylesheet">').attr("href","https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.6/themes/ui-darkness/jquery-ui.css").appendTo("head");$BucketUpdaterCSS=atob("I2x1Y2lmZXJNb2R1bGUgLnVpLWhlbHBlci1yZXNldCB7DQogICAgYm9yZGVyOiAwIG5vbmUgOw0KICAgIGZvbnQtc2l6ZTogOTAlIDsNCiAgICBsaW5lLWhlaWdodDogMC44IDsNCiAgICBsaXN0LXN0eWxlOiBub25lIG91dHNpZGUgbm9uZSA7DQogICAgbWFyZ2luOiAwIDsNCiAgICBvdXRsaW5lOiAwIG5vbmUgOw0KICAgIHBhZGRpbmc6IDAgOw0KICAgIHRleHQtZGVjb3JhdGlvbjogbm9uZSA7DQp9DQojbHVjaWZlck1vZHVsZSAuc2V0dGluZ3MtdGFiIHsNCiAgICBoZWlnaHQ6MjQ1cHggOyANCiAgICBvdmVyZmxvdzphdXRvOw0KfQ0KDQojbHVjaWZlck1vZHVsZSAuc2V0dGluZ3MtdGFiIHRleHRhcmVhIHsNCiAgIGZvbnQtc2l6ZTogMTBwdDsNCiAgIGZvbnQtZmFtaWx5OiBBcmlhbDsNCn0gDQojYnVja2V0TGlzdENvbnRhaW5lciB7DQogICAgd2lkdGg6IDEwMCU7DQogICAgaGVpZ2h0OiAxODBweDsNCiAgIA0KICAgIG1hcmdpbjogYXV0bzsNCiAgICBwYWRkaW5nOiAxMHB4Ow0KfQ0KI0J1Y2tldFVwZGF0ZXJfTGlzdCB7DQogICAgd2lkdGg6IDUwJTsNCiAgICBoZWlnaHQ6IDE4MHB4Ow0KICAgIGZsb2F0OiBsZWZ0Ow0KfQ0KI0J1Y2tldFVwZGF0ZXJfTGlzdEJ1dHRvbnMgew0KICAgIG1hcmdpbi1sZWZ0OiA1MiU7DQogICAgaGVpZ2h0OiAyMDBweDsNCn0NCg==");$('<style type="text/css"></style>').text($BucketUpdaterCSS).attr("id","BucketUpdaterCSS").appendTo("head")}function g(){if($("#"+t.namespace+"Main").length>0)$("#"+t.namespace+"Main").remove();console.log("Inserting toolbar");$toolbar='<div id="{$namespace}Main">'+'<div class="empire_main_module" style="padding-bottom:5px;">'+'     <div class="clearfix" style="width:750px;">'+'         <table style="border:0px;padding:0px;border-collapse:collapse;">'+"             <tbody>"+"                 <tr>"+'                     <td style="border:0px;padding:0px;border-collapse:collapse;">'+'                        <div id="luciferModule" style="float:left;width:735px;" class="empire_module_header">'+'                             <div class="empire_module_title" style="border-bottom:0px;">'+'                                 <div  style="float:left;margin-top:-4px;"><span><span id="toolbar_header" title="bucket updater script | version '+t.version+'"  style="vertical-align:5px;color:yellow">'+' 				                    <img title="bucket updater script | version '+t.version+'" src="https://zynga1-a.akamaihd.net/mwfb/mwfb/graphics/iced.png"/> Bucket Updater'+" 									</span>"+'                                    </span><span class="spacer"></span>'+'                                     <span style="position:relative;top:-5px;" >'+'<a href="#" id="{$namespace}SetupBucket" class=" sexy_button_new short black ui-icon-gear {$namespace}CloseOpenTabs" title="Click for settings" alt="Click for settings"><span><span><img src="http://mwfb.static.zgncdn.com/mwfb/graphics/v3/icon_hammer_wrench.png"></span></span></a>'+'<span class="spacer"></span>'+'<span><a id="{$namespace}Settings" class="sexy_button_new short orange {$namespace}CloseOpenTabs"><span><span>Setup Bucket</span></span></a></span>'+'<span><a class="{$namespace}Start_Bucket sexy_button_new short green hide"><span><span>START</span></span></a></span>'+'<span><a class="{$namespace}Stop_Bucket sexy_button_new short red hide"><span><span>STOP</span></span></a></span>'+"</span>"+"                                 </div>"+'								 <span class="update_txt">Status :<span class ="good" id="{$namespace}Status"></span></span>'+'                                 <div style="float:right;margin-right:0px;margin-top:-10px;"><span style="font-size:0.6em;color:#FFF;"></span>'+'                                     <span class="spacer"></span><a href="#" id="{$namespace}CloseToolbar" title="Close/Exit Bucket Updater" class="close" style="margin:-15px 8px 0px 10px;vertical-align:top;"></a>'+'									 <span id="stats" style="font-size:11px"><span class="bad">BUCKET DETAILS</span> Alive [<span class="good" title="how many targets are alive" id="{$namespace}Bucket_AliveTargets">0</span>] Scans[<span class="bad" title="how many total targets have been scanned" id="{$namespace}Bucket_TotalScans">0</span>] Total [<span class="bad" title="how many total targets in bucket" id="{$namespace}Bucket_TotalTargets">0</span>]</span>'+"								 </div>"+"                             </div>"+'                             <div class="clearfix" style="clear: both; border-top-width: 1px; border-top-style: solid; border-top-color: gray; " id="fighter_log_outer">'+'<div id="{$namespace}Tabs" class="hide">'+' <a href="#" id="CloseTabs" title="Close Tabs" class="close {$namespace}CloseOpenTabs" style="margin:5px 8px 0px 10px;vertical-align:top;"></a>'+"    <ul>  "+'        <li><a href="#{$namespace}Settings-Tab"    class="{$namespace}Settings-Tab">Bucket & Auth Settings</a></li>  '+'        <li><a href="#{$namespace}BucketList-Tab"  class="{$namespace}BucketList-Tab">Bucket List</a></li>  '+'        <li><a href="#{$namespace}Log-Tab">Log</a></li>  '+"    </ul>  "+'    <div id="{$namespace}Settings-Tab" class="settings-tab">  '+"        <p>Bucket & Auth Settings</p>  "+"<table>"+"<tr>"+'<td width="80px;">'+'Bucket ID: <td><input type="text" size="40" id="{$namespace}Bucket_ID" value=""></td>'+"</td>"+"</tr>"+"<tr>"+'<td width="80px;">'+'Bucket Auth: <td width = "200px;"><input type="text" id="{$namespace}Bucket_Auth" value=""></td>'+"</td>"+"</tr>"+'<td width="80px;">'+"<td>"+'<span><a class="{$namespace}Verify_Bucket sexy_button_new short orange"><span><span>Verify Bucket</span></span></a></span>'+'<span><a class="{$namespace}Start_Bucket sexy_button_new short green hide"><span><span>Start Updating</span></span></a></span>'+'<span><a class="{$namespace}Stop_Bucket sexy_button_new short red hide"><span><span>Stop Updating</span></span></a></span>'+"</td>"+"</td>"+"</tr>"+"</table>"+"</p>"+'<span><input id="{$namespace}EnableRestart" type="checkbox"/><span><span>Enable Restart</span></span></span>'+'<!-- <span><input id="{$namespace}EnableForce" type="checkbox"/><span><span>FORCE Fight Scripts to use bucket</span></span></span> !-->'+'<div><a id ="{$namespace}SaveSettings" class="sexy_button_new short red"><span><span>SAVE</span></span></a></div>'+'<div><br/><span id="{$namespace}VerifyMessage"></span></div>'+"</div>  "+'    <div id="{$namespace}BucketList-Tab" class="settings-tab">  '+"        <p>Bucket List</p>  "+'<span id="{$namespace}ListMessage"></span>'+'<div id="bucketListContainer"  >'+'    <div id ="BucketUpdater_List" class="">'+'        <textarea id="{$namespace}BucketList" cols=40 rows=11 DISABLED>Need to click start to load bucketlist</textarea>'+"    </div>"+'    <div id ="BucketUpdater_ListButtons">'+'<div><p></p><a class="sexy_button_new short white disabled"><span><span>Clear Bucket</span></span></a></div>'+'<div><p><a class="sexy_button_new short red disabled"><span><span>Delete Bucket</span></span></a></div>'+'<div><p><a class="sexy_button_new short green disabled"><span><span>Rename Bucket</span></span></a></div>'+"</div>"+"</div>"+"    </div>  "+'    <div id="{$namespace}Log-Tab" class="settings-tab">  '+"        <p>System LOG</p>  "+'    <div id="{$namespace}FullLog"></div>  '+"    </div>  "+"</div>  "+"				              </div>"+"                         </div>"+"                     </td>"+'                     <td style="border:0px;padding:0px;background:url(&quot;https://zynga1-a.akamaihd.net/mwfb/mwfb/graphics/empire/shadow_right_side.png&quot;);background-position:0px 8px;background-repeat:no-repeat;background-size:8px 100000px;width:8px;vertical-align:top;">'+'                         <div style="background:url(&quot;https://zynga1-a.akamaihd.net/mwfb/mwfb/graphics/empire/shadow_upper_right.png&quot;);height:8px;width:8px;"></div>'+"                     </td>"+"                 </tr>"+"                 <tr>"+'                     <td colspan="2" style="border:0px;padding:0px;">'+'                         <div style="float:left;background:url(&quot;https://zynga1-a.akamaihd.net/mwfb/mwfb/graphics/empire/shadow_lower_left.png&quot;) repeat scroll 0% 0% transparent;height:8px;width:8px;"></div>'+'                         <div style="float:left;background:url(&quot;https://zynga1-a.akamaihd.net/mwfb/mwfb/graphics/empire/shadow_bottom.png&quot;) repeat scroll 0% 0% transparent;height:8px;width:729px;"></div>'+'                         <div style="float:left;background:url(&quot;https://zynga1-a.akamaihd.net/mwfb/mwfb/graphics/empire/shadow_lower_right.png&quot;) repeat scroll 0% 0% transparent;height:8px;width:8px;"></div>'+"                     </td>"+"                 </tr>"+"             </tbody>"+"         </table>"+"     </div>"+" </div>"+"</div";$("#mw_navigation").append($toolbar.replace(/\{\$namespace\}/g,t.namespace))}function y(e){function s(){if(typeof i.Move=="function"){t.Current=r.Items[n];i.Move.apply(t,[n,r.Keys[n],r.Items[n]])}}function o(){if(typeof i.End=="function"){i.End.apply(t)}}var t=this;var n=0;var r=new Object;var i=new Object;this.onMove=function(e){if(typeof e=="function"){i.Move=e}};this.onEnd=function(e){if(typeof e=="function"){i.End=e}};this.MoveFirst=function(){n=0;s()};this.MoveNext=function(){n++;if(n<r.Items.length){s()}else{o()}return null};this.setArray=function(e){r.Keys=new Array;r.Items=new Array;for(var t in e){if(typeof e[t]!="function"){r.Keys.push(t);r.Items.push(e[t])}}n=0};if(e){t.setArray(e);return t}else{return false}}function b(){settings=unsafeWindow.localStorage.getItem(t.namespace+"Settings"+User.trackId);if(settings===null){return r}else{return JSON.parse(settings)}}function w(n){n=typeof n==="undefined"?"SAVED SETTINGS!":n;r.settings.EnableRestart=e.EnableRestart.is(":checked");if(r.id!=e.bucketID.val()||r.auth!=e.bucketAuth.val()){r.verified=false}r.id=$.trim(e.bucketID.val());r.auth=$.trim(e.bucketAuth.val());e.SaveSettings.toggleClass("disabled",true);e.verifyMessage.text(n).fadeOut(7e3,function(){e.verifyMessage.empty();e.verifyMessage.show();e.SaveSettings.toggleClass("disabled",false)});E();if(t.processing==false)u()}function E(){unsafeWindow.localStorage.setItem(t.namespace+"Settings"+User.trackId,JSON.stringify(r))}function S(){if(t==null||t.stop)return;if(t.processing)return;t.stop=false;t.processing=true;t.rivalsProcess=null;v(function(e){if(r.list.length<1){t.stop=true;p("Need to add targets to bucket");return}x()})}function x(){if(t==null||t.stop)return;if(t.pid>=r.list.length){N();p("Finished Scan");$("#BucketUpdater_Bucket_TotalScans").text("0");console.log(r);A(function(e){$("#BucketUpdater_Bucket_AliveTargets").text("0");p("Updated Server, reloading bucket targets");h("NEW SCAN IN ",30,x);t.pid=0});return}var e=r.list[t.pid];if(t.process.length>3&&r.updated==false){t.processed=parseInt(t.processed+t.process.length);A(function(){t.process=[];if(t.processed>=r.list.length){r.updated=true}x()})}else{scan_rival=r.list[t.pid++];h("NEXT TARGET IN ",10,function(){T(scan_rival,x);if(t==null||t.stop)return;t.process.push(e);N()})}}function T(e,r){if(t==null||t.stop)return;var i=e;k(i,function(){if(n.bucket[i].in_mafia==false){L(i,function(){if(n.bucket[i].health>0){console.log(i+" Found healthy target");p(i+" is alive",true);n.liveTargets[i]=true;r();C();return}r();return})}else{r();return}})}function N(){var e=parseInt($("#BucketUpdater_Bucket_TotalScans").text());e++;$("#BucketUpdater_Bucket_TotalScans").text(e)}function C(e){var n=parseInt($("#BucketUpdater_Bucket_AliveTargets").text());n++;$("#BucketUpdater_Bucket_AliveTargets").text(n);if(r.updated==true){time_past=(new Date).getTime()-t.UpdateTime;if(time_past/1e3>=20){A(function(){if(typeof e=="function")e&&e()})}else{if(typeof e=="function")e&&e()}}else{if(typeof e=="function")e&&e()}var n=null}function k(e,i){if(t==null||t.stop)return;var s=e;p("LOADING "+e);if(!/p/i.test(s)){s="p|"+s}s=btoa($.trim(s));console.log("PID",s);O("html_server.php?xw_controller=stats&xw_action=view&user="+s,function(s){if(r.updated==true){target={health:0,in_mafia:false,level:0,scanTime:null,hitlist_link:null}}else{target={health:0,in_mafia:false,family_tag:"",family_id:"",name:null,facebook_id:"",level:0,scanTime:null,hitlist_link:null}}s=t.extract(s,"user_info_update","stats_left");var o=$(s);is_inMafia=t.extract(s,"xw_action=remove");if(is_inMafia==false){target.in_mafia=false}else{target.in_mafia=true;p(e+" is in your mafia, can't check health  [REMOVE] from mafia",true)}var u=t.extract(s,"xw_controller=hitlist&xw_action=set");if(u!=false){target.hitlist_link=u}if(is_inMafia==false&&u==false){console.log("Something stuffed up");console.log(s);return}var a=o.find(".stats_title_text a");var f=o.find('div[class*="stats_title"]').text();if(Util.isset(target.family_tag)){target.family_tag=encodeURIComponent(o.find('div[class*="stats_title"] span:first').html())}var l;if(Util.isset(target.family_id)){if(l=/\&id\=(.*)\&/.exec(decodeURIComponent(a.eq(0).attr("href")))){target.family_id=atob(l[1])}}if(Util.isset(target.name)){if(l=/"(.*?)" level/.exec(f.replace(target.family_tag,""))){target.name=encodeURIComponent(l[1]);p("name -> "+target.name)}}if(Util.isset(target.facebook_id)){if((l=/user%2522.*?%2522([0-9A-Za-z%]+)%2522/.exec(s))||(l=/user%22.*?%22([0-9A-Za-z%]+)%22/.exec(s))){target.facebook_id=atob(l[1].replace(/%253D/g,"=").replace(/%3D/g,"="))}}if(Util.isset(target.level)){if(l=/Level (\d+) (Fearless|Maniac|Mogul)/i.exec(s)){target.level=parseInt(l[1])}}if(target.name!=null||r.updated){n.bucket[e]=target;s=null;o=null;i()}else{console.log("Failed to cache target");console.log("cacheTarget Issue",s);console.log(e,target)}})}function L(e,r){if(t==null||t.stop)return;p("Checking "+decodeURIComponent(n.bucket[e].name));if(n.bucket[e].in_mafia==true){p("Player is in our mafia need to remove");r();thisTarget=null;return}p("Checking health "+e,true);var i="html_server.php?"+n.bucket[e].hitlist_link;O(i,function(i){n.bucket[e].scanTime=(new Date).getTime();var s=t.extract(i,"xw_controller=hitlist&xw_action=create");n.bucket[e].health=0;if(s!=false){n.bucket[e].health=100}else if(/Tell your mafia/.test(i)){n.bucket[e].health=100}else if(/There is already a bounty set/.test(i)){n.bucket[e].health=100}else{if(/You cannot set a bounty on this user|You can&#39;t add/.test(i)){n.bucket[e].health=0}else{error=$(i).find(".message_body").text();if(/action was not able to be completed/.test(error)){}else{console.log("Health Check Error -> ",error)}}}i=null;s=null;i=null;thisTarget=null;r()})}function A(e){if(t==null||t.stop)return;var i=[];if(r.updated==true){for(mw_id in n.liveTargets){var s=mw_id;scanTime=((new Date).getTime()-n.bucket[s].scanTime)/1e3;var o={health:n.bucket[s].health,mw_id:s,level:n.bucket[s].level,scanTime:scanTime};i.push(o);o=null}}else{for(mw_id in t.process){var s=t.process[mw_id];if(n.bucket[s]==false)continue;if(!Util.isset(n.bucket[s])){return}if(!Util.isset(n.bucket[s].scanTime)){return}scanTime=((new Date).getTime()-n.bucket[s].scanTime)/1e3;var o={health:n.bucket[s].health,family_tag:n.bucket[s].family_tag,family_id:n.bucket[s].family_id,name:n.bucket[s].name,mw_id:s,facebook_id:n.bucket[s].facebook_id,level:n.bucket[s].level,scanTime:scanTime};i.push(o)}}if(i.length<1){console.log("Nothing to upload");e();return}settings={cache:!r.updated,targets:i};send_data=unsafeWindow.btoa(JSON.stringify(settings));send={action:"update_bucket",bucket_id:r.id,bucket_auth:r.auth,bucket_data:send_data,type:"POST"};M(send,function(t){p("updated bucket server ",true);n.liveTargets=new Object;send=null;settings=null;i=null;e()})}function O(e,n,r){function o(){function r(e){if(i>5){window.location.reload()}else{i++;setTimeout(o,333)}console.log("ajaxerror",e)}if(t==null||t.stop)return;$.ajax({type:"POST",url:e,data:s,cache:false,success:function(e){if(t==null||t.stop)return;if(/ERROR 500/i.test(e)){r();return}if(/^<script type="text\/javascript">top\.location\.href/.test(e)){console.log("POSSIBLE REFRESH DETECTED",e);try{}catch(i){}return}n(e)},error:r})}_();var i=0;if(t==null||t.stop)return;unsafeWindow.User.clicks++;var s={ajax:1,sf_xw_user_id:unsafeWindow.User.id,sf_xw_sig:unsafeWindow.local_xw_sig,liteload:1,cb:unsafeWindow.User.id+parseInt((new Date).getTime().toString().substring(0,10)),xw_person:unsafeWindow.User.id.substr(2),xw_client_id:8};setTimeout(o,600)}function M(e,n,r){function i(){$.ajax({type:e.type,url:t.bucket_url,crossDomain:true,data:e,dataType:"json",timeout:2e4,success:function(e,t,r){if(Util.isset(e)&&e.success==true){n(e)}else if(Util.isset(e)&&e.success==false){n(e)}else{console.log("Bucket Api Call Failed",e)}},error:function(t){console.log("callBucket sendRequest",t);if(e.type=="POST"){e.type="GET";setTimeout(i,333)}}})}if(t==null||t.stop)return;i()}function _(){a={sf_xw_sig:unsafeWindow.local_xw_sig,sf_xw_user_id:unsafeWindow.User.id.substr(2)};$.ajax({type:"POST",url:"https://facebook-ca2.mafiawars.zynga.com/mwfb/sf_updater.php",data:a,success:function(e){unsafeWindow.local_xw_sig=/([a-f0-9]{32})/.exec(e)[1]}})}var e={startBucketButton:null,stopBucketButton:null,verifyBucketButton:null,EnableRestart:null,SaveSettings:null,bucketID:null,verifyMessage:null,bucketAuth:null,log:null,SetupBucket:null};var t={timerEvent:null,process:[],processed:0,processing:false,stop:false,namespace:"BucketUpdater_",version:1.15,bucket_url:"https://api.mwscripts.com/bucketlist/api/bucket_api.php",wait:function(e){e.tries=typeof e.tries==="undefined"?100:e.tries;e.timeout=typeof e.timeout==="undefined"?100:e.timeout;var t=setInterval(function(){try{if(e.func()===true){clearInterval(t);if(typeof e.success()=="function")e.success&&e.success();t=null;return}}catch(n){}if(e.tries<0){clearInterval(t);if(typeof e.error()=="function")e.error&&e.error();t=null;return;}e.tries--},e.timeout)},page:"index_controller",rivalsProcess:null,UpdateTime:(new Date).getTime(),pid:0,extract:function(e,t,n){n=typeof n==="undefined"?'"':n;var r=typeof n==="undefined"?"'":n;try{var i=0;var s=0;var o=0;var u=0;var a,f=e.indexOf(t,o);if(f===-1){return false}if(u!==true){a=e.indexOf(n,f+Math.max(i,1))}else{a=e.lastIndexOf(n)}if(a===-1){return false}f+=i;a+=s;return e.substr(f,a-f)}catch(l){return false}}};var n={bucket:new Object,liveTargets:new Object};var r={id:"",auth:"",list:[],verified:false,updated:false,scanTime:null,addToBucket:[],settings:{EnableRestart:false},currentTarget:{}};if(typeof unsafeWindow=="undefined"){window.unsafeWindow||(unsafeWindow=function(){var e=document.createElement("p");e.setAttribute("onclick","return window;");return e.onclick()}())}if(/html_server/.test(unsafeWindow.location.href)){if(document.getElementById("final_wrapper")){t.wait({tries:10,timeout:50,func:function(){return typeof ($=unsafeWindow.$)!=="undefined"},success:s,error:function(){console.log("Failed to find Jquery")}})}}String.prototype.trunc=function(e){return this.substr(0,e-1)+(this.length>e?"..":"")}}+")();";injectScript(BucketUpdaterWrapper);