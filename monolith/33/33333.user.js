// ==UserScript==
// @name           Douban-weather
// @namespace      http://npchen.blogspot.com
// @description    在登记了所在城市的豆瓣用户主页上显示其城市的天气信息（v1.1.1）
// @include        http://www.douban.com/people/*/
// @require        http://jqueryjs.googlecode.com/files/jquery-1.3.min.js
// @require        http://userscript-autoupdate-helper.googlecode.com/svn/trunk/autoupdatehelper.js
// @author         NullPointer (http://www.douban.com/people/NullPointer/)
// @version        1.1.0.1
/* @reason
   v 1.1.1  自带jquery，解决豆瓣页面jquery定义失踪带来的问题。   
   @end*/
// ==/UserScript==

var thisScript = {
   name: "豆瓣天气",
   id: "33333",
   version:"1.1.1"
}

var updater = new Updater(thisScript);
updater.check();   


var ID = { //自动生成的，没有逐个校对，应该会有错或遗漏。。。
"abagqi":"chxx0243",
"acheng":"chxx0001",
"aihui":"chxx0174",
"akqi":"chxx0210",
"alar":"chxx0212",
"altay":"chxx0196",
"anda":"chxx0187",
"ang''angxi":"chxx0002",
"ankang":"chxx0394",
"anning":"chxx0003",
"anqing":"chxx0452",
"anshan":"chxx0004",
"anshun":"chxx0005",
"anyang":"chxx0269",
"arxan":"chxx0182",
"bachu":"chxx0211",
"bailing-miao":"chxx0247",
"baingoin":"chxx0324",
"baise":"chxx0488",
"baiyin":"chxx0006",
"balguntay":"chxx0204",
"baoding":"chxx0308",
"baoji":"chxx0387",
"baoqing":"chxx0188",
"baoshan":"chxx0370",
"baotou":"chxx0007",
"barkam":"chxx0348",
"batang":"chxx0352",
"bayanmod":"chxx0225",
"bayanbulak":"chxx0206",
"baytikshan":"chxx0201",
"beihai":"chxx0499",
"beijing":"chxx0008",
"bengbu":"chxx0444",
"benxi":"chxx0296",
"bijie":"chxx0418",
"boxian":"chxx0439",
"boyang":"chxx0009",
"bugt":"chxx0287",
"changdao":"chxx0312",
"changbai":"chxx0299",
"changchun":"chxx0010",
"changde":"chxx0416",
"changji":"chxx0011",
"changling":"chxx0277",
"changping":"chxx0012",
"changsha":"chxx0013",
"changshu":"chxx0014",
"changting":"chxx0472",
"changzhou":"chxx0015",
"chaoyang":"chxx0294",
"chengde":"chxx0302",
"chengdu":"chxx0016",
"chengshantou":"chxx0314",
"chenzhou":"chxx0435",
"chifeng":"chxx0286",
"chongqing":"chxx0017",
"chuxiong":"chxx0373",
"daxian":"chxx0400",
"da-qaidam":"chxx0230",
"dachendao":"chxx0464",
"daladqi":"chxx0018",
"dali":"chxx0371",
"dalian":"chxx0019",
"dandong":"chxx0306",
"danxian":"chxx0505",
"daocheng":"chxx0357",
"daodi":"chxx0020",
"daolin":"chxx0021",
"darlag":"chxx0336",
"datong":"chxx0251",
"datun":"chxx0022",
"dawu":"chxx0347",
"daxing":"chxx0023",
"dege":"chxx0344",
"delingha":"chxx0231",
"dengqen":"chxx0342",
"deqen":"chxx0360",
"dinghai":"chxx0455",
"dingtao":"chxx0320",
"dingxi":"chxx0024",
"dingxian":"chxx0025",
"dongfang":"chxx0504",
"dongshadao":"chxx0503",
"dongsheng":"chxx0255",
"dongtai":"chxx0445",
"dulan":"chxx0235",
"dunhua":"chxx0284",
"dunhuang":"chxx0223",
"duolun":"chxx0285",
"dushan":"chxx0432",
"ejinqi":"chxx0220",
"emeishan":"chxx0359",
"enshi":"chxx0406",
"erenhot":"chxx0240",
"fangxian":"chxx0395",
"fengcheng":"chxx0026",
"fengjie":"chxx0401",
"fengning":"chxx0292",
"fengtai":"chxx0027",
"fogang":"chxx0483",
"foshan":"chxx0028",
"fu-sui":"chxx0030",
"fuding":"chxx0469",
"fujin":"chxx0185",
"fushun":"chxx0029",
"fuyang":"chxx0442",
"fuyun":"chxx0197",
"fuzhou":"chxx0031",
"gangca":"chxx0232",
"gangu":"chxx0032",
"ganyu":"chxx0438",
"ganzhou":"chxx0436",
"gaoyao":"chxx0491",
"gaoyi":"chxx0033",
"garze":"chxx0345",
"gengma":"chxx0377",
"golmud":"chxx0234",
"gonggar":"chxx0034",
"gongxian":"chxx0035",
"guaizihu":"chxx0222",
"guang''an":"chxx0036",
"guangchang":"chxx0470",
"guanghua":"chxx0396",
"guangnan":"chxx0477",
"guangzhou":"chxx0037",
"guiding":"chxx0038",
"guilin":"chxx0434",
"guiping":"chxx0489",
"guiyang":"chxx0039",
"gushi":"chxx0443",
"guyang":"chxx0040",
"haicheng":"chxx0041",
"haikou":"chxx0502",
"hailar":"chxx0175",
"hails":"chxx0244",
"hailun":"chxx0183",
"haining":"chxx0042",
"haiyang":"chxx0319",
"haliut":"chxx0246",
"hami":"chxx0219",
"hangu":"chxx0043",
"hangzhou":"chxx0044",
"hanjiang":"chxx0045",
"hanzhong":"chxx0390",
"harbin":"chxx0046",
"hechi":"chxx0478",
"hechuan":"chxx0047",
"hefei":"chxx0448",
"hejiang":"chxx0048",
"henan":"chxx0337",
"hequ":"chxx0256",
"heyuan":"chxx0492",
"hezuo":"chxx0339",
"hoboksar":"chxx0199",
"hohhot":"chxx0249",
"hongkong":"chxx0049",
"hotan":"chxx0216",
"huashan":"chxx0388",
"hua-yang":"chxx0052",
"huade":"chxx0248",
"huadian":"chxx0290",
"huailai":"chxx0301",
"huajialing":"chxx0239",
"huangshan":"chxx0453",
"huangpi":"chxx0050",
"huangshi":"chxx0051",
"huili":"chxx0366",
"huimin":"chxx0311",
"huize":"chxx0367",
"huizhou":"chxx0053",
"hulan":"chxx0054",
"hulin":"chxx0194",
"huma":"chxx0172",
"huoshan":"chxx0447",
"hu****ai":"chxx0055",
"huzhou":"chxx0056",
"jartai":"chxx0252",
"jarudqi":"chxx0275",
"ji''an":"chxx0425",
"jiangcheng":"chxx0384",
"jiangjin":"chxx0057",
"jiangling":"chxx0408",
"jiangmen":"chxx0058",
"jianyang":"chxx0059",
"jiaonan":"chxx0060",
"jiaoxian":"chxx0061",
"jiaxing":"chxx0062",
"jiexiu":"chxx0268",
"jilin":"chxx0063",
"jinan":"chxx0064",
"jingdezhen":"chxx0457",
"jinghai":"chxx0065",
"jinghe":"chxx0202",
"jinghong":"chxx0380",
"jingyuan":"chxx0066",
"jining":"chxx0250",
"jinzhou":"chxx0067",
"jiujiang":"chxx0068",
"jiulong":"chxx0361",
"jiuquan":"chxx0226",
"jiutai":"chxx0069",
"jiuxianshan":"chxx0475",
"jiuzhen":"chxx0070",
"jixi":"chxx0193",
"jurh":"chxx0245",
"jurong":"chxx0071",
"kabahe":"chxx0195",
"kaifeng":"chxx0072",
"kaiyang":"chxx0073",
"kangding":"chxx0358",
"karamay":"chxx0200",
"kashi":"chxx0074",
"keshan":"chxx0181",
"king''spark":"chxx0170",
"korla":"chxx0209",
"kowloon":"chxx0075",
"kuandian":"chxx0305",
"kunming":"chxx0076",
"kunyang":"chxx0077",
"kuqa":"chxx0208",
"lancang":"chxx0379",
"langzhong":"chxx0399",
"lanxi":"chxx0078",
"lanzhou":"chxx0079",
"lenghu":"chxx0227",
"leting":"chxx0307",
"lhasa":"chxx0080",
"lhunze":"chxx0329",
"lianxian":"chxx0481",
"liangping":"chxx0405",
"lianping":"chxx0484",
"liaoyang":"chxx0081",
"lijing":"chxx0365",
"lincang":"chxx0378",
"lindong":"chxx0276",
"lingling":"chxx0429",
"lingxian":"chxx0310",
"linhai":"chxx0463",
"linhe":"chxx0253",
"linjiang":"chxx0297",
"lintong":"chxx0082",
"linxi":"chxx0281",
"lishi":"chxx0264",
"lishui":"chxx0461",
"litang":"chxx0353",
"liuyang":"chxx0083",
"liuzhou":"chxx0479",
"liyang":"chxx0450",
"longkou":"chxx0313",
"longli":"chxx0084",
"longzhou":"chxx0494",
"lushan":"chxx0456",
"luhe":"chxx0085",
"luodian":"chxx0431",
"luoyang":"chxx0086",
"lushi":"chxx0389",
"lushun":"chxx0087",
"lusi":"chxx0446",
"luxi":"chxx0376",
"luzhou":"chxx0088",
"macau":"chxx0512",
"macheng":"chxx0403",
"madoi":"chxx0335",
"manas":"chxx0089",
"mandal":"chxx0242",
"mangnai":"chxx0217",
"maoming":"chxx0090",
"mazongshan":"chxx0221",
"meixian":"chxx0486",
"meishan":"chxx0091",
"mengla":"chxx0383",
"mengshan":"chxx0480",
"mengxian":"chxx0092",
"mengzi":"chxx0385",
"mianyang":"chxx0351",
"minhang":"chxx0093",
"minqin":"chxx0229",
"minqing":"chxx0094",
"miquan":"chxx0095",
"miyun":"chxx0096",
"mohe":"chxx0171",
"mudanjiang":"chxx0278",
"nagqu":"chxx0325",
"nanchang":"chxx0097",
"nancheng":"chxx0465",
"nanchong":"chxx0098",
"nanjing":"chxx0099",
"nanning":"chxx0100",
"nanping":"chxx0471",
"nanshadao":"chxx0511",
"nantong":"chxx0101",
"nanxiang":"chxx0102",
"nanyang":"chxx0391",
"nanyue":"chxx0423",
"napo":"chxx0487",
"naranbulag":"chxx0241",
"neijiang":"chxx0103",
"nenjiang":"chxx0177",
"newkowloon":"chxx0104",
"niuzhuang":"chxx0105",
"nyingchi":"chxx0356",
"otogqi":"chxx0254",
"pagri":"chxx0330",
"pingliang":"chxx0270",
"pingtan":"chxx0476",
"pingwu":"chxx0350",
"pingyao":"chxx0106",
"pingyin":"chxx0107",
"pishan":"chxx0215",
"poli":"chxx0108",
"potou":"chxx0309",
"pucheng":"chxx0468",
"pukou":"chxx0109",
"qamdo":"chxx0343",
"qiangorlos":"chxx0190",
"qijiaojing":"chxx0205",
"qingdao":"chxx0110",
"qingjiang":"chxx0111",
"qinglong":"chxx0303",
"qingyuan":"chxx0289",
"qinzhou":"chxx0498",
"qionghai":"chxx0506",
"qiqihar":"chxx0112",
"qitai":"chxx0113",
"quxian":"chxx0460",
"quanzhou":"chxx0114",
"qumarleb":"chxx0333",
"rizhao":"chxx0322",
"rongjiang":"chxx0433",
"ruili":"chxx0375",
"ruo''ergai":"chxx0338",
"ruoqiang":"chxx0214",
"sangzhi":"chxx0410",
"sanhudao":"chxx0509",
"sansui":"chxx0426",
"sertar":"chxx0346",
"shache":"chxx0115",
"shangchuandao":"chxx0501",
"shanghai":"chxx0116",
"shangzhi":"chxx0192",
"shantou":"chxx0493",
"shanwei":"chxx0496",
"shaoguan":"chxx0482",
"shaowu":"chxx0466",
"shaoxing":"chxx0117",
"shaoyang":"chxx0422",
"shashi":"chxx0118",
"shengsi":"chxx0454",
"shengxian":"chxx0458",
"shenyang":"chxx0119",
"shenzhen":"chxx0120",
"sheyang":"chxx0441",
"shiguaigou":"chxx0121",
"shijiazhuang":"chxx0122",
"shilong":"chxx0123",
"shipu":"chxx0459",
"shiquanhe":"chxx0323",
"shuangcheng":"chxx0124",
"shule":"chxx0125",
"simao":"chxx0381",
"sinan":"chxx0420",
"siping":"chxx0283",
"sogxian":"chxx0341",
"songpan":"chxx0349",
"stanley":"chxx0126",
"suifenhe":"chxx0279",
"suining":"chxx0127",
"sunwu":"chxx0178",
"suzhou":"CHXX0014",
"tacheng":"chxx0198",
"taha":"chxx0128",
"taishan":"chxx0316",
"tailai":"chxx0186",
"taiyuan":"chxx0129",
"tanggu":"chxx0130",
"tangshan":"chxx0131",
"tengchong":"chxx0369",
"tiangang":"chxx0132",
"tianjin":"chxx0133",
"tianshui":"chxx0386",
"tieling":"chxx0134",
"tikanlik":"chxx0213",
"tingri":"chxx0328",
"tongdao":"chxx0427",
"tonghe":"chxx0191",
"tongliao":"chxx0282",
"tulihe":"chxx0173",
"tuotuohe":"chxx0331",
"turpan":"chxx0207",
"uliastai":"chxx0189",
"urumqi":"chxx0135",
"usu":"chxx0136",
"wanyuan":"chxx0393",
"weichang":"chxx0293",
"weifang":"chxx0318",
"weinan":"chxx0137",
"weining":"chxx0368",
"wenzhou":"chxx0462",
"wudaoliang":"chxx0238",
"wudu":"chxx0340",
"wugang":"chxx0428",
"wuhan":"chxx0138",
"wuhu":"chxx0449",
"wuming":"chxx0139",
"wushaoling":"chxx0233",
"wutaishan":"chxx0257",
"wuyishan":"chxx0467",
"wuzhou":"chxx0490",
"xainza":"chxx0326",
"xiujimqinqi":"chxx0274",
"xian":"chxx0141",
"xiamen":"chxx0140",
"xiangtan":"chxx0142",
"xianyang":"chxx0143",
"xiao''ergou":"chxx0176",
"xiaogan":"chxx0144",
"xichang":"chxx0363",
"xifengzhen":"chxx0271",
"xigaze":"chxx0145",
"xihua":"chxx0392",
"xilinhot":"chxx0280",
"xinbaragyouqi":"chxx0179",
"xin''an":"chxx0146",
"xingren":"chxx0430",
"xingtai":"chxx0266",
"xining":"chxx0236",
"xinjin":"chxx0147",
"xinxian":"chxx0315",
"xinxiang":"chxx0148",
"xinyang":"chxx0149",
"xinyi":"chxx0495",
"xishadao":"chxx0508",
"xiushui":"chxx0412",
"xunwu":"chxx0485",
"xuwen":"chxx0150",
"xuzhou":"chxx0437",
"ya''an":"chxx0354",
"yanan":"chxx0267",
"yanchi":"chxx0263",
"yangcheng":"chxx0273",
"yangjiang":"chxx0500",
"yangliuqing":"chxx0151",
"yangquan":"chxx0152",
"yanji":"chxx0291",
"yanzhou":"chxx0321",
"yaxian":"chxx0507",
"yibin":"chxx0362",
"yichang":"chxx0407",
"yichuan":"chxx0153",
"yidu":"chxx0154",
"yilaxi":"chxx0155",
"yinchuan":"chxx0259",
"yingkou":"chxx0304",
"yining":"chxx0203",
"yiwu":"chxx0218",
"yiyang":"chxx0156",
"yiyuan":"chxx0317",
"yong''an":"chxx0473",
"yongchuan":"chxx0157",
"yongning":"chxx0158",
"yongshujiao":"chxx0510",
"youyang":"chxx0414",
"yuxian":"chxx0258",
"yuanjiang":"chxx0382",
"yuanling":"chxx0415",
"yuanmou":"chxx0372",
"yuanping":"chxx0261",
"yucheng":"chxx0159",
"yuci":"chxx0160",
"yueyang":"chxx0411",
"yulin":"chxx0260",
"yumenzhen":"chxx0224",
"yuncheng":"chxx0272",
"yushe":"chxx0265",
"yushu":"chxx0334",
"zadoi":"chxx0332",
"zaoyang":"chxx0397",
"zhangping":"chxx0474",
"zhangjiakou":"chxx0300",
"zhangqiu":"chxx0161",
"zhangwu":"chxx0288",
"zhangye":"chxx0228",
"zhangzhou":"chxx0162",
"zhanjiang":"chxx0163",
"zhanyi":"chxx0374",
"zhaotong":"chxx0364",
"zhengding":"chxx0164",
"zhengzhou":"chxx0165",
"zhenjiang":"chxx0166",
"zhijiang":"chxx0421",
"zhongning":"chxx0262",
"zhongxiang":"chxx0402",
"zhoucun":"chxx0167",
"zhumadian":"chxx0398",
"zhuozhou":"chxx0168",
"zibo":"chxx0169",
"zunyi":"chxx0419",
"dongguan":"CHXX0123",
"118259":"CHXX0407",
"118111":"CHXX0249",
"118290":"CHXX0491",
"118175":"CHXX0062",
"118226":"CHXX0313",
"118322":"CHXX0351",
"118204":"CHXX0114",
"118207":"CHXX0473",
"118273":"CHXX0416",
"118278":"CHXX0453",
"118177":"CHXX0117",
"118225":"CHXX0318",
"nyc":"USNY0996",
}

var $ = jQuery;


function code2img(code){
   return "http://l.yimg.com/us.yimg.com/i/us/we/52/"+code+".gif";  
}

function weather2html(weather,divclass,time){
   var imgurl = code2img(weather.code);
   var text = weather.text;
   var _temp = weather.temp;
   var _txt = "";
   if (_temp==undefined) {
      var high = weather.high;
      var low = weather.low;
      _txt = text+": "+low+"℃ ~ "+high+"℃";
   }
   else {
      _txt = text+": "+_temp+"℃";
   }
   return "<div class='"+divclass+"'><table><tr><td> <a title='"+_txt+"'><img src='"+imgurl+"/></a></td><td><span>"
          +time+"</span><br/><span>"+_txt+"</span></td></tr></table></div>"

}

$(document).ready(function(){
   var location= $("#profile table.infobox tbody td.tablecc a:first").attr("href");
   location = location.substring(10, location.length-1);

   if (ID[location]!=undefined) { //当链接是有效城市时继续
       //alert(ID[location]);
       var url ="http://pipes.yahoo.com/pipes/pipe.run?_id=2eb187fcae6192aee203f670109a40f7&_render=json&p="+ID[location]+"&_callback=?";
      
      $.getJSON(url, function(data){
        var _item = data.value.items[0];
        
        var _now = _item["yweather:condition"];
        var _tomorrow = _item["yweather:forecast"][0];
        var _dayafter = _item["yweather:forecast"][1];
        
        var now = weather2html(_now, "weather", "Now...");
        var tomorrow = weather2html(_tomorrow, "forcast", "24 hours...");
        var dayafter = weather2html(_dayafter, "forcast", "48 hours...");
                
        $("#profile table.infobox tbody td.tablecc a:first").after($(dayafter));
        $("#profile table.infobox tbody td.tablecc a:first").after($(tomorrow));
        $("#profile table.infobox tbody td.tablecc a:first").after($(now));
        
        $("div.weather").show();
        $("div.forcast").hide();
        $("div.weather").click(function(e){$("div.forcast").toggle();})
        $("div.forcast").click(function(e){$("div.forcast").hide(); })
        
      })
  }
  //else alert("undefined:"+location);
});