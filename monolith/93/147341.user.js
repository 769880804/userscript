// ==UserScript==
// @name           Forecaster
// @description    Unknown
// @namespace      BS
// @include        https://prodgame*.alliances.commandandconquer.com/*/index.aspx*
// @version        1.0.1.0
// @author         Handsom3Strang3r
// @require        http://userscripts.org/scripts/show/145102
// ==/UserScript==
(function(){var b=function(){function b(a,b){return a-b}function c(a){a.sort(b);for(var c=1;c<a.length;c++){a[c]===a[c-1]&&a.splice(c--,1)}return a}function d(){var a={};qx.Class.define("TASuite.main",{type:"singleton",extend:qx.core.Object,members:{buttons:{attack:{layout:{save:null,load:null},simulate:null,unlock:null,tools:null,optimize:null},simulate:{back:null},shiftUp:null,shiftDown:null,shiftLeft:null,shiftRight:null},stats:{spoils:{tiberium:null,crystal:null,credit:null,research:null},health:{infantry:null,vehicle:null,aircraft:null,overall:null},repair:{infantry:null,vehicle:null,aircraft:null,overall:null},damage:{units:{overall:null},structures:{construction:null,defense:null,command:null,support:null,overall:null},overall:null},time:null,supportLevel:null},labels:{health:{infantry:null,vehicle:null,aircraft:null,overall:null},damage:{units:{overall:null},structures:{construction:null,defense:null,command:null,support:null,overall:null},overall:null,outcome:null},time:null,supportLevel:null},utils:{playerCity:null,ownCity:null,ownCityId:null,add_ViewModeChange:null,add_ArmyChanged:null,offenseUnits:null,units:null},layouts:{label:null,layoutsList:null,all:null,current:null,restore:null},options:{autoDisplay:null,shiftButtons:null},attacker_modules:null,defender_modules:null,battleResultsBox:null,statsPage:null,initializeStats:function(a){try{this.statsPage=new qx.ui.tabview.Page("Stats"),this.statsPage.setLayout(new qx.ui.layout.VBox(1)),a.add(this.statsPage);var b=new qx.ui.container.Composite,c=new qx.ui.layout.Grid;c.setColumnAlign(1,"right","middle"),c.setColumnFlex(0,1),b.setLayout(c),b.setThemedFont("bold"),b.setThemedBackgroundColor("#eef"),this.statsPage.add(b),b.add(new qx.ui.basic.Label("Enemy Base:"),{row:0,column:0}),this.labels.damage.overall=new qx.ui.basic.Label("100"),b.add(this.labels.damage.overall,{row:0,column:1}),b.add(new qx.ui.basic.Label("Defences:"),{row:1,column:0}),this.labels.damage.units.overall=new qx.ui.basic.Label("100"),b.add(this.labels.damage.units.overall,{row:1,column:1}),b.add(new qx.ui.basic.Label("Buildings:"),{row:2,column:0}),this.labels.damage.structures.overall=new qx.ui.basic.Label("100"),b.add(this.labels.damage.structures.overall,{row:2,column:1}),b.add(new qx.ui.basic.Label("Construction Yard:"),{row:3,column:0}),this.labels.damage.structures.construction=new qx.ui.basic.Label("100"),b.add(this.labels.damage.structures.construction,{row:3,column:1}),b.add(new qx.ui.basic.Label("Defense Facility:"),{row:4,column:0}),this.labels.damage.structures.defense=new qx.ui.basic.Label("100"),b.add(this.labels.damage.structures.defense,{row:4,column:1}),b.add(new qx.ui.basic.Label("Command Center:"),{row:5,column:0}),this.labels.damage.structures.command=new qx.ui.basic.Label("100"),b.add(this.labels.damage.structures.command,{row:5,column:1}),this.labels.supportLevel=new qx.ui.basic.Label(""),b.add(this.labels.supportLevel,{row:6,column:0}),this.labels.damage.structures.support=new qx.ui.basic.Label(""),b.add(this.labels.damage.structures.support,{row:6,column:1}),b=new qx.ui.container.Composite,c=new qx.ui.layout.Grid,c.setColumnAlign(1,"right","middle"),c.setColumnFlex(0,1),b.setLayout(c),b.setThemedFont("bold"),b.setThemedBackgroundColor("#eef"),this.statsPage.add(b),b.add(new qx.ui.basic.Label("Overall:"),{row:0,column:0}),this.labels.health.overall=new qx.ui.basic.Label("100"),b.add(this.labels.health.overall,{row:0,column:1}),b.add(new qx.ui.basic.Label("Infantry:"),{row:1,column:0}),this.labels.health.infantry=new qx.ui.basic.Label("100"),b.add(this.labels.health.infantry,{row:1,column:1}),b.add(new qx.ui.basic.Label("Vehicle:"),{row:2,column:0}),this.labels.health.vehicle=new qx.ui.basic.Label("100"),b.add(this.labels.health.vehicle,{row:2,column:1}),b.add(new qx.ui.basic.Label("Aircraft:"),{row:3,column:0}),this.labels.health.aircraft=new qx.ui.basic.Label("100"),b.add(this.labels.health.aircraft,{row:3,column:1}),b=new qx.ui.container.Composite,c=new qx.ui.layout.Grid,c.setColumnAlign(1,"right","middle"),c.setColumnFlex(0,1),b.setLayout(c),b.setThemedFont("bold"),b.setThemedBackgroundColor("#eef"),this.statsPage.add(b),b.add(new qx.ui.basic.Label("Outcome:"),{row:0,column:0}),this.labels.damage.outcome=new qx.ui.basic.Label("Unknown"),b.add(this.labels.damage.outcome,{row:0,column:1}),b.add(new qx.ui.basic.Label("Battle Time:"),{row:1,column:0}),this.labels.time=new qx.ui.basic.Label("120"),b.add(this.labels.time,{row:1,column:1})}catch(d){console.log(d)}},initializeLayout:function(a){try{var b=new qx.ui.tabview.Page("Layouts");b.setLayout(new qx.ui.layout.VBox),a.add(b),this.layouts.layoutsList=new qx.ui.form.List,this.layouts.layoutsList.set({height:150,selectionMode:"one"}),b.add(this.layouts.layoutsList);var c=new qx.ui.container.Composite;c.setLayout(new qx.ui.layout.HBox(5)),this.buttons.attack.layout.load=new qx.ui.form.Button("Load"),this.buttons.attack.layout.load.set({width:80,appearance:"button-text-small",toolTipText:"Load this saved layout."}),this.buttons.attack.layout.load.addListener("click",this.loadCityLayout,this),c.add(this.buttons.attack.layout.load),this.buttonLayoutDelete=new qx.ui.form.Button("Delete"),this.buttonLayoutDelete.set({width:80,appearance:"button-text-small",toolTipText:"Delete this saved layout."}),this.buttonLayoutDelete.addListener("click",this.deleteCityLayout,this),c.add(this.buttonLayoutDelete),b.add(c);var d=new qx.ui.container.Composite;d.setLayout(new qx.ui.layout.VBox(1)),d.setThemedFont("bold"),d.setThemedPadding(2),d.setThemedBackgroundColor("#eef");var e=new qx.ui.container.Composite;e.setLayout(new qx.ui.layout.HBox(5)),e.add(new qx.ui.basic.Label("Name: ")),this.layouts.label=new qx.ui.form.TextField,e.add(this.layouts.label),d.add(e),this.buttons.attack.layout.save=new qx.ui.form.Button("Save"),this.buttons.attack.layout.save.set({width:80,appearance:"button-text-small",toolTipText:"Save this layout."}),this.buttons.attack.layout.save.addListener("click",this.saveCityLayout,this),d.add(this.buttons.attack.layout.save),b.add(d)}catch(f){console.log(f)}},initializeInfo:function(a){try{var b=new qx.ui.tabview.Page("Info");b.setLayout(new qx.ui.layout.VBox(1)),a.add(b);var c=new qx.ui.container.Composite;c.setLayout(new qx.ui.layout.VBox(1)),c.setThemedFont("bold"),c.setThemedPadding(2),c.setThemedBackgroundColor("#eef"),b.add(c);var d=(new qx.ui.basic.Label).set({value:"<a target='_blank' href='http://userscripts.org/scripts/discuss/138212'>Forums</a>",rich:true});c.add(d);var e=new qx.ui.container.Composite;e.setLayout(new qx.ui.layout.VBox(1)),e.setThemedFont("bold"),e.setThemedPadding(2),e.setThemedBackgroundColor("#eef"),b.add(e),e.add(new qx.ui.basic.Label("Spoils")),this.stats.spoils.tiberium=new qx.ui.basic.Atom("0","webfrontend/ui/common/icn_res_tiberium.png"),e.add(this.stats.spoils.tiberium),this.stats.spoils.crystal=new qx.ui.basic.Atom("0","webfrontend/ui/common/icn_res_chrystal.png"),e.add(this.stats.spoils.crystal),this.stats.spoils.credit=new qx.ui.basic.Atom("0","webfrontend/ui/common/icn_res_dollar.png"),e.add(this.stats.spoils.credit),this.stats.spoils.research=new qx.ui.basic.Atom("0","webfrontend/ui/common/icn_res_research_mission.png"),e.add(this.stats.spoils.research);var f=new qx.ui.container.Composite;f.setLayout(new qx.ui.layout.VBox(1)),f.setThemedFont("bold"),f.setThemedPadding(2),f.setThemedBackgroundColor("#eef"),b.add(f),f.add(new qx.ui.basic.Label("Options:")),this.options.autoDisplay=new qx.ui.form.CheckBox("Auto display this box");var g=localStorage.ta_sim_popup;g?(g=JSON.parse(localStorage.ta_sim_popup),this.options.autoDisplay.setValue(g)):this.options.autoDisplay.setValue(true),this.options.autoDisplay.addListener("click",this.autoOpenHandler,this),f.add(this.options.autoDisplay),this.options.shiftButtons=new qx.ui.form.CheckBox("Show shift buttons");var g=localStorage.ta_sim_showShift;g?(g=JSON.parse(localStorage.ta_sim_showShift),this.options.shiftButtons.setValue(g)):this.options.shiftButtons.setValue(true),this.options.shiftButtons.addListener("click",this.shiftButtonHandler,this),f.add(this.options.shiftButtons),this.battleResultsBox.add(a)}catch(h){console.log(h)}},initialize:function(){try{if(typeof CCTAWrapper_IsInstalled=="undefined"||!CCTAWrapper_IsInstalled){alert("Combat Simulator Script Requires 'C&C TA Wrapper' in order to work!\r\nAborting...");return}this.utils.add_ViewModeChange=(new ClientLib.Vis.ViewModeChange).$ctor(this,this.onViewChange),this.utils.add_ArmyChanged=(new System.EventHandler).$ctor(this,this.onUnitMoved),this.buttons.attack.simulate=new qx.ui.form.Button("Simulate"),this.buttons.attack.simulate.set({width:65,appearance:"button-text-small",toolTipText:"Start Combat Simulation"}),this.buttons.attack.simulate.addListener("click",this.startSimulation,this),this.buttons.simulate.back=new qx.ui.form.Button("Setup"),this.buttons.simulate.back.set({width:80,appearance:"button-text-small",toolTipText:"Return to Combat Setup"}),this.buttons.simulate.back.addListener("click",this.returnSetup,this);var a=qx.core.Init.getApplication().getReportReplayOverlay();a.add(this.buttons.simulate.back,{top:10,left:0});var b=qx.core.Init.getApplication().getUIItem(ClientLib.Data.Missions.PATH.BAR_ATTACKSETUP);this.buttons.attack.unlock=new qx.ui.form.Button("Unlock"),this.buttons.attack.unlock.set({width:55,height:46,appearance:"button-text-small",toolTipText:"Unlock Attack Button"}),this.buttons.attack.unlock.addListener("click",this.unlockAttacks,this),this.buttons.attack.unlock.setOpacity(.5),b.add(this.buttons.attack.unlock,{top:107,right:4}),this.buttons.attack.tools=new qx.ui.form.Button("Tools"),this.buttons.attack.tools.set({width:65,appearance:"button-text-small",toolTipText:"Open Simulator Tools"}),this.buttons.attack.tools.addListener("click",this.toggleTools,this),this.buttons.shiftLeft=new qx.ui.form.Button("<"),this.buttons.shiftLeft.set({width:30,appearance:"button-text-small",toolTipText:"Shift units left"}),this.buttons.shiftLeft.addListener("click",function(){this.doShift("l")},this),this.buttons.shiftRight=new qx.ui.form.Button(">"),this.buttons.shiftRight.set({width:30,appearance:"button-text-small",toolTipText:"Shift units right"}),this.buttons.shiftRight.addListener("click",function(){this.doShift("r")},this),this.buttons.shiftUp=new qx.ui.form.Button("^"),this.buttons.shiftUp.set({width:30,appearance:"button-text-small",toolTipText:"Shift units up"}),this.buttons.shiftUp.addListener("click",function(){this.doShift("u")},this),this.buttons.shiftDown=new qx.ui.form.Button("v"),this.buttons.shiftDown.set({width:30,appearance:"button-text-small",toolTipText:"Shift units down"}),this.buttons.shiftDown.addListener("click",function(){this.doShift("d")},this);this.buttons.attack.optimize=new qx.ui.form.Button("Optimize");this.buttons.attack.optimize.set({width:65,appearance:"button-text-small",toolTipText:"Try to optimize army formation"});this.buttons.attack.optimize.addListener("click",function(){this.buttons.attack.tools.setEnabled(false);this.buttons.attack.simulate.setEnabled(false);this.buttons.attack.optimize.setEnabled(false);this.optimizeFormation()},this);b.add(this.buttons.attack.optimize,{top:93,right:50});var c=localStorage.ta_sim_showShift;c?c=JSON.parse(localStorage.ta_sim_showShift):c=true,c&&(b.add(this.buttons.shiftUp,{top:21,right:50}),b.add(this.buttons.shiftLeft,{top:40,right:65}),b.add(this.buttons.shiftRight,{top:40,right:35}),b.add(this.buttons.shiftDown,{top:55,right:50}));var d=ClientLib.Data.CityPreArmyUnit.prototype;d.set_Enabled_Original||(d.set_Enabled_Original=d.set_Enabled),d.set_Enabled=function(a){this.set_Enabled_Original(a),window.TASuite.main.getInstance().onUnitMoved()},ClientLib.Vis.VisMain.GetInstance().add_ViewModeChange(this.utils.add_ViewModeChange),this.loadLayouts(),b.add(this.buttons.attack.tools,{top:74,right:50}),b.add(this.buttons.attack.simulate,{top:112,right:50}),this.battleResultsBox=(new qx.ui.window.Window("Battle Simulator","FactionUI/icons/icon_loading_logo.gif")).set({contentPaddingTop:0,contentPaddingBottom:2,contentPaddingRight:2,contentPaddingLeft:6,showMaximize:false,showMinimize:false}),this.battleResultsBox.getChildControl("icon").set({scale:true,width:25,height:25}),this.battleResultsBox.setLayout(new qx.ui.layout.HBox),this.battleResultsBox.moveTo(125,125),this.battleResultsBox.addListener("beforeClose",function(){window.TASuite.main.getInstance().unbindArmyChangedEvent()});var e=(new qx.ui.tabview.TabView).set({contentPaddingTop:3,contentPaddingBottom:6,contentPaddingRight:7,contentPaddingLeft:3});this.battleResultsBox.add(e),this.initializeStats(e),this.initializeLayout(e),this.initializeInfo(e)}catch(f){console.log(f)}},initArmyFormation:function(){try{var a=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentOwnCity(),b=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentCity(),c=b.get_Id(),d=a.get_CityArmyFormationsManager().GetFormationByTargetBaseId(c);this.utils.offenseUnits!==null&&this.unbindArmyChangedEvent(),this.utils.offenseUnits=d,this.utils.units=d.get_ArmyUnits().l}catch(e){console.log(e)}},autoOpenHandler:function(){localStorage.ta_sim_popup=JSON.stringify(this.options.autoDisplay.getValue())},shiftButtonHandler:function(){localStorage.ta_sim_showShift=JSON.stringify(this.options.shiftButtons.getValue());var a=qx.core.Init.getApplication().getUIItem(ClientLib.Data.Missions.PATH.BAR_ATTACKSETUP);this.options.shiftButtons.getValue()?(a.add(this.buttons.shiftUp,{top:21,right:77}),a.add(this.buttons.shiftLeft,{top:40,right:92}),a.add(this.buttons.shiftRight,{top:40,right:62}),a.add(this.buttons.shiftDown,{top:55,right:77})):(a.remove(this.buttons.shiftUp),a.remove(this.buttons.shiftLeft),a.remove(this.buttons.shiftRight),a.remove(this.buttons.shiftDown))},toggleTools:function(){this.battleResultsBox.isVisible()?this.closeToolsBox():this.openToolsBox()},calculateLoot:function(){try{var a=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentCity(),b=0,c,d={1:0,2:0,3:0,6:0,7:0};if(a.get_CityBuildingsData().get_Buildings()!==null){b=a.get_CityBuildingsData().get_Buildings().l.length;var e;for(var f=b;--f>=0;){e=a.get_CityBuildingsData().get_Buildings().l[f],c=e.get_HitpointsPercent();for(var g=e.get_UnitLevelRepairCost().length;--g>=0;){d[e.get_UnitLevelRepairCost()[g].Type]+=c*e.get_UnitLevelRepairCost()[g].Count}}}if(a.get_CityUnitsData().get_DefenseUnits()!==null){b=a.get_CityUnitsData().get_DefenseUnits().l.length;var h;for(f=b;--f>=0;){h=a.get_CityUnitsData().get_DefenseUnits().l[f],c=h.get_HitpointsPercent();for(g=h.get_UnitLevelRepairCost().length;--g>=0;){d[h.get_UnitLevelRepairCost()[g].Type]+=c*h.get_UnitLevelRepairCost()[g].Count}}}var i=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentOwnCity(),j=a.CalculateAttackCommandPointCostToCoord(i.YVZLTL,i.CSYYUZ),k=this.formatNumberWithCommas(d[1])+" ("+this.formatNumberWithCommas(Math.round(d[1]/j))+" / CP)",l=this.formatNumberWithCommas(d[2])+" ("+this.formatNumberWithCommas(Math.round(d[2]/j))+" / CP)",m=this.formatNumberWithCommas(d[3])+" ("+this.formatNumberWithCommas(Math.round(d[3]/j))+" / CP)",n=this.formatNumberWithCommas(d[6])+" ("+this.formatNumberWithCommas(Math.round(d[6]/j))+" / CP)";this.stats.spoils.tiberium.setLabel(k),this.stats.spoils.crystal.setLabel(l),this.stats.spoils.credit.setLabel(m),this.stats.spoils.research.setLabel(n)}catch(o){console.log(o)}},calculateSimResults:function(a,b){try{if(qx.core.Init.getApplication().getPlayArea().getViewMode()!==webfrontend.gui.PlayArea.PlayArea.modes.EMode_CombatViewerAttacker){var c=this.setupBattleground(this.utils.offenseUnits);while(c.get_Simulation().DoStep(false)){}this.calculateTroopStrengths(c),b&&this.calculateLoot(),a&&this.updateStatsWindow()}}catch(d){console.log(d)}},onUnitMoved:function(a,b){try{this.battleResultsBox.isVisible()&&!this.layouts.restore&&window.TASuite.main.getInstance().calculateSimResults(true)}catch(b){console.log(b)}},calculateStrength:function(a,b,c,d){if(c>=1){return 0}var e=a.length,f;while(e--){f=a[e];if(f.Type==b){return d.ConvertRepairCost(f.Type,f.Count,1-c)}}return 0},calculateTroopStrengths:function(a){try{a=a?a:ClientLib.Vis.VisMain.GetInstance().get_Battleground();var b=0,c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0;this.stats.damage.structures.defense=0,this.stats.damage.structures.construction=0,this.stats.damage.structures.command=0,this.stats.supportLevel=0,this.stats.damage.structures.support=0,this.stats.repair.infantry=0,this.stats.repair.vehicle=0,this.stats.repair.aircraft=0;var p=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentOwnCity(),q=p.get_CityRepairData(),r=ClientLib.Res.ResMain.GetInstance().GetGamedata().units,s=a.get_Entities().d,t,u,v,w,x,y,z=0,A=0,B=0;for(var C in s){t=s[C],u=t.get_Entity(),v=r[u.get_MDCTypeId()];if(v.r.length<=1){continue}w=u.get_iHitpointsCurrent(),x=u.get_iHitpoints(),y=ClientLib.Base.Util.GetUnitLevelData(u.get_iLevel(),v);if(u.get_eAlignment()==1){c+=w,b+=x;switch(v.mt){case ClientLib.Base.EUnitMovementType.Air:case ClientLib.Base.EUnitMovementType.Air2:l+=w,n+=x,B+=this.calculateStrength(y,ClientLib.Base.EResourceType.RepairChargeAir,w/x,q);break;case ClientLib.Base.EUnitMovementType.Feet:j+=w,o+=x,z+=this.calculateStrength(y,ClientLib.Base.EResourceType.RepairChargeInf,w/x,q);break;case ClientLib.Base.EUnitMovementType.Track:case ClientLib.Base.EUnitMovementType.Wheel:k+=w,m+=x,A+=this.calculateStrength(y,ClientLib.Base.EResourceType.RepairChargeVeh,w/x,q);break;default:}}else{d+=x,e+=w;if(u.get_MDCTypeId()>=200&&u.get_MDCTypeId()<=205){this.stats.supportLevel=u.get_iLevel(),this.stats.damage.structures.support=w/x*100}else{switch(u.get_MDCTypeId()){case 112:case 151:case 177:this.stats.damage.structures.construction=w/x*100;break;case 158:case 131:case 195:this.stats.damage.structures.defense=w/x*100;break;case 111:case 159:this.stats.damage.structures.command=w/x*100;break;default:}}switch(v.mt){case ClientLib.Base.EUnitMovementType.Structure:f+=x,g+=w;break;default:h+=x,i+=w}}}this.stats.health.infantry=o?j/o*100:100,this.stats.health.vehicle=m?k/m*100:100,this.stats.health.aircraft=n?l/n*100:100,this.stats.time=a.get_Simulation().get_iCombatStep()*a.get_TimePerStep()/1e3,this.stats.damage.units.overall=i/h*100,this.stats.damage.structures.overall=g/f*100,this.stats.damage.overall=e/d*100,this.stats.health.overall=c?c/b*100:0,this.stats.repair.infantry=z,this.stats.repair.aircraft=B,this.stats.repair.vehicle=A,this.stats.repair.overall=Math.max(this.stats.repair.vehicle,this.stats.repair.aircraft,this.stats.repair.infantry)}catch(D){console.log(D)}},setLabelColor:function(a,b,c){var d=["green","blue","black","red"],e=d[0],f=b;c>=0&&(f=100-f),f>99.99?e=d[3]:f>50?e=d[2]:f>0&&(e=d[1]),a.setTextColor(e)},updateLabel100:function(a,b,c){this.setLabelColor(a,b,c),a.setValue(b.toFixed(2).toString())},updateLabel100time:function(a,b,c,d){var e=b.toFixed(2).toString()+" @ ";e+=this.formatSecondsAsTime(d),this.setLabelColor(a,b,c),a.setValue(e)},updateStatsWindow:function(){var a=["black","blue","green","red"],b="",c=0;this.stats.damage.structures.construction===0?(b="Total Victory",c=0):this.stats.damage.structures.overall<100?(b="Victory",c=1):(b="Total Defeat",c=3),this.labels.damage.outcome.setValue(b),this.labels.damage.outcome.setTextColor(a[c]),this.updateLabel100(this.labels.damage.overall,this.stats.damage.overall,-1),this.updateLabel100(this.labels.damage.units.overall,this.stats.damage.units.overall,-1),this.updateLabel100(this.labels.damage.structures.overall,this.stats.damage.structures.overall,-1),this.updateLabel100(this.labels.damage.structures.construction,this.stats.damage.structures.construction,-1),this.updateLabel100(this.labels.damage.structures.defense,this.stats.damage.structures.defense,-1),this.utils.playerCity?this.updateLabel100(this.labels.damage.structures.command,this.stats.damage.structures.command,-1):(this.labels.damage.structures.command.setValue("--"),this.labels.damage.structures.command.setTextColor("green"));var d=this.stats.supportLevel>0?this.stats.supportLevel.toString():"--";this.labels.supportLevel.setValue("Suport lvl "+d+": "),this.updateLabel100(this.labels.damage.structures.support,this.stats.damage.structures.support,-1),this.updateLabel100time(this.labels.health.overall,this.stats.health.overall,1,this.stats.repair.overall),this.updateLabel100time(this.labels.health.infantry,this.stats.health.infantry,1,this.stats.repair.infantry),this.updateLabel100time(this.labels.health.vehicle,this.stats.health.vehicle,1,this.stats.repair.vehicle),this.updateLabel100time(this.labels.health.aircraft,this.stats.health.aircraft,1,this.stats.repair.aircraft),this.setLabelColor(this.labels.time,this.stats.time/120,-1),this.labels.time.setValue(this.stats.time.toFixed(2).toString())},formatNumberWithCommas:function(a){return Math.floor(a).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},formatSecondsAsTime:function(a,b){var c=Math.floor(a/3600),d=Math.floor((a-c*3600)/60),e=Math.floor(a-c*3600-d*60);c<10&&(c="0"+c),d<10&&(d="0"+d),e<10&&(e="0"+e);return c+":"+d+":"+e},openToolsBox:function(){this.initArmyFormation(),this.updateLayoutsList(),this.bindArmyChangedEvent(),this.calculateSimResults(true,true),this.battleResultsBox.open()},closeToolsBox:function(){this.battleResultsBox.close()},unlockAttacks:function(){var a=qx.core.Init.getApplication().getUIItem(ClientLib.Data.Missions.PATH.BAR_ATTACKSETUP);a.remove(this.buttons.attack.unlock);var b=this;setTimeout(function(){a.add(b.buttons.attack.unlock)},2e3)},unbindArmyChangedEvent:function(){try{this.utils.offenseUnits.remove_ArmyChanged(this.utils.add_ArmyChanged)}catch(a){console.log(a)}},bindArmyChangedEvent:function(){try{this.utils.offenseUnits.add_ArmyChanged(this.utils.add_ArmyChanged)}catch(a){console.log(a)}},onViewChange:function(a,b){try{var c=this.utils.ownCity;this.utils.ownCity=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentCity()===ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentOwnCity();var d=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentCity().get_CityFaction();this.utils.playerCity=d===ClientLib.Base.EFactionType.GDIFaction||d===ClientLib.Base.EFactionType.NODFaction;if(!c&&a===webfrontend.gui.PlayArea.PlayArea.modes.EMode_CombatSetupDefense&&b!==webfrontend.gui.PlayArea.PlayArea.modes.EMode_PlayerOffense){this.battleResultsBox.isVisible()&&this.closeToolsBox();return}if(!this.utils.ownCity&&b===webfrontend.gui.PlayArea.PlayArea.modes.EMode_CombatSetupDefense&&qx.core.Init.getApplication().getPlayArea().getViewMode()!==webfrontend.gui.PlayArea.PlayArea.modes.EMode_CombatViewerAttacker){if(this.options.autoDisplay.getValue()){var e=this;setTimeout(function(){e.openToolsBox()},1500)}return}this.battleResultsBox.isVisible()&&this.closeToolsBox()}catch(f){console.log(f)}},returnSetup:function(){var a=qx.core.Init.getApplication(),b=ClientLib.Data.MainData.GetInstance().get_Cities();b.get_CurrentCity();try{a.getPlayArea().setView(webfrontend.gui.PlayArea.PlayArea.modes.EMode_CombatSetupDefense,localStorage.ta_sim_last_city,0,0)}catch(c){a.getPlayArea().setView(webfrontend.gui.PlayArea.modes.EMode_CombatSetupDefense,localStorage.ta_sim_last_city,0,0),console.log(c)}},setupBattleground:function(a){try{var b=ClientLib.Data.MainData.GetInstance().get_Cities(),d=b.get_CurrentCity(),e=b.get_CurrentOwnCity();localStorage.ta_sim_last_city=d.get_Id();var f=ClientLib.Data.MainData.GetInstance().get_Alliance(),g=(new ClientLib.Data.Combat).$ctor();g.set_Version(1);var h=e.get_CityUnitsData().get_OffenseUnits().l;a=a?a.get_ArmyUnits().l:e.get_CityArmyFormationsManager().GetFormationByTargetBaseId(d.get_Id()).get_ArmyUnits().l;var i=new Array,j={l:[]},k,l,m,n=[],o=ClientLib.Data.MainData.GetInstance().get_Player().get_PlayerResearch(),p,q;for(var r=0;r<h.length;r++){if(a[r].get_Enabled()){q={h:h[r].get_Health(),i:h[r].get_MdbUnitId(),l:h[r].get_CurrentLevel(),m:100,x:a[r].get_CoordX(),y:a[r].get_CoordY()},i.push(q),p=o.GetResearchItemFomMdbId(h[r].get_UnitGameData_Obj().tl),l=h[r].get_UnitGameData_Obj().m,m=l.length;while(m--){k=l[m],p!==null&&k.r.length>0?p.get_CurrentLevel()>=k.r[0].l&&n.push(k.i):n.push(k.i)}}}g.set_Attacker(i),h=e.get_CityUnitsData().get_DefenseUnits().l;for(r=0;r<h.length;r++){p=o.GetResearchItemFomMdbId(h[r].get_UnitGameData_Obj().tl),l=h[r].get_UnitGameData_Obj().m,m=l.length;while(m--){k=l[m],p!==null&&k.r.length>0?p.get_CurrentLevel()>=k.r[0].l&&n.push(k.i):n.push(k.i)}}j.l=c(n),i=new Array;var s={l:[]};if(d.get_CityUnitsData().get_DefenseUnits()!==null){h=d.get_CityUnitsData().get_DefenseUnits().l,n=[];for(r=0;r<h.length;r++){q={h:h[r].get_Health(),i:h[r].get_MdbUnitId(),l:h[r].get_CurrentLevel(),m:100,x:h[r].get_CoordX(),y:h[r].get_CoordY()},i.push(q),l=h[r].get_UnitGameData_Obj().m,m=l.length;while(m--){n.push(l[m].i)}}s.l=c(n)}g.set_Defender(i),i=new Array;for(var r=0;r<9;r++){for(var t=0;t<8;t++){var u=d.GetResourceType(r,t+8),v=-1;switch(u){case ClientLib.Data.ECityTerrainType.FOREST:v=ClientLib.Base.EUnit.Forest;break;case ClientLib.Data.ECityTerrainType.BRIAR:v=ClientLib.Base.EUnit.Scrub;break;case ClientLib.Data.ECityTerrainType.SWAMP:v=ClientLib.Base.EUnit.Swamp;break;case ClientLib.Data.ECityTerrainType.WATER:v=ClientLib.Base.EUnit.Water;break;default:}v!==-1&&(q={h:100,i:v,l:1,m:100,x:r,y:t},i.push(q))}}g.set_Blocker(i),h=d.get_CityBuildingsData().get_Buildings().l,i=new Array;for(r=0;r<h.length;r++){q={h:h[r].get_Health(),i:h[r].get_MdbUnitId(),l:h[r].get_CurrentLevel(),m:100,x:h[r].get_CoordX(),y:h[r].get_CoordY()},i.push(q)}g.set_Buildings(i),g.set_Supports(null),g.set_StartStep(8696244),g.m_CombatSteps=1,g.m_BoostInfantry=f.get_POIInfantryBonus(),g.m_BoostVehicle=f.get_POIVehicleBonus(),g.m_BoostAir=f.get_POIAirBonus(),g.m_BoostDefense=d.get_AllianceDefenseBonus(),g.m_AttackerBaseId=e.get_Id(),g.m_AttackerBaseName=e.get_Name(),g.m_AttackerPlayerId=e.get_PlayerId(),g.m_AttackerPlayerName=e.get_PlayerName(),g.m_AttackerAllianceId=e.get_AllianceId(),g.m_AttackerAllianceName=e.get_AllianceName(),g.m_DefenderBaseId=d.get_Id(),g.m_DefenderBaseName=d.get_Name(),g.m_DefenderPlayerId=d.get_PlayerId(),g.m_DefenderPlayerName=d.get_OwnerName(),g.m_DefenderAllianceId=d.get_AllianceId(),g.m_DefenderAllianceName=d.get_OwnerAllianceName(),g.m_DefenderBlockStep=0,g.m_AttackTimeStamp=(new Date).getTime(),g.m_ResourceLayout={l:[]},g.m_AttackerFaction=e.get_CityFaction(),g.m_DefenderFaction=d.get_CityFaction(),g.m_AttackerModules=j,g.m_DefenderModules=s,(g.m_DefenderFaction===ClientLib.Base.EFactionType.FORFaction||g.m_DefenderFaction===ClientLib.Base.EFactionType.NPCBase||g.m_DefenderFaction===ClientLib.Base.EFactionType.NPCCamp)&&g.setNPCNames(),g.m_MaxDuration=120,g.m_Complete=false,g.set_Debug(null);var w=ClientLib.Vis.VisMain.GetInstance().get_Battleground();return w.Reset(),w.set_CurrentReplay(g),w.InitBattle(),w.setCombatData(g),w.StartBattle(),w}catch(x){console.log(x)}},startSimulation:function(){try{var a=qx.core.Init.getApplication(),b=ClientLib.Data.MainData.GetInstance().get_Cities(),c=b.get_CurrentCity();try{a.getPlayArea().setView(webfrontend.gui.PlayArea.PlayArea.modes.EMode_CombatReplay,c.get_Id(),0,0)}catch(d){a.getPlayArea().setView(webfrontend.gui.PlayArea.modes.EMode_CombatReplay,c.get_Id(),0,0)}this.setupBattleground();try{a.getPlayArea().setView(webfrontend.gui.PlayArea.PlayArea.modes.EMode_CombatReplay,c.get_Id(),0,0)}catch(d){a.getPlayArea().setView(webfrontend.gui.PlayArea.modes.EMode_CombatReplay,c.get_Id(),0,0)}}catch(d){console.log(d)}},updateLayoutsList:function(){try{this.layouts.layoutsList.removeAll(),this.loadCityLayouts();if(this.layouts.current){for(var a in this.layouts.current){var b=this.layouts.current[a],c=new qx.ui.form.ListItem(b.label,null,b.id);this.layouts.layoutsList.add(c)}}}catch(d){console.log(d)}},deleteCityLayout:function(){try{var a=this.layouts.layoutsList.getSelection()[0].getModel();this.layouts.current&&typeof this.layouts.current[a]!="undefined"&&(delete this.layouts.current[a],this.saveLayouts(),this.updateLayoutsList())}catch(b){console.log(b)}},loadCityLayout:function(a){var b=typeof a=="object"?this.layouts.layoutsList.getSelection()[0].getModel():a;try{this.layouts.current&&typeof this.layouts.current[b]!="undefined"&&this.restoreFormation(this.layouts.current[b].layout),this.calculateSimResults(true,true)}catch(c){console.log(c)}},saveCityLayout:function(){try{var a=this.saveFormation(),b=(new Date).getTime().toString(),c=this.layouts.label.getValue()+" ("+this.stats.damage.structures.construction.toFixed(0).toString()+":"+this.stats.damage.structures.defense.toFixed(0).toString()+":"+this.stats.damage.units.overall.toFixed(0).toString()+")";return this.layouts.current[b]={id:b,label:c,layout:a},this.saveLayouts(),this.updateLayoutsList(),this.layouts.label.setValue(""),b}catch(d){console.log(d)}},loadCityLayouts:function(){try{var a=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentCity().get_Id(),b=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentOwnCity().get_Id();this.layouts.all.hasOwnProperty(a)||(this.layouts.all[a]={}),this.layouts.all[a].hasOwnProperty(b)||(this.layouts.all[a][b]={}),this.layouts.current=this.layouts.all[a][b]}catch(c){console.log(c)}},loadLayouts:function(){try{var a=localStorage.ta_sim_layouts;a?this.layouts.all=JSON.parse(a):this.layouts.all={}}catch(b){console.log(b)}},saveLayouts:function(){try{localStorage.ta_sim_layouts=JSON.stringify(this.layouts.all)}catch(a){console.log(a)}},restoreFormation:function(a){try{this.layouts.restore=true;for(var b=0;b<a.length;b++){var c=a[b];for(var d=0;d<this.utils.units.length;d++){this.utils.units[d].get_Id()===c.id&&(this.utils.units[d].MoveBattleUnit(c.x,c.y),c.enabled===undefined?this.utils.units[d].set_Enabled(true):this.utils.units[d].set_Enabled(c.enabled))}}this.utils.offenseUnits.RefreshData(),this.layouts.restore=false}catch(e){console.log(e)}},saveFormation:function(){try{var a=[];for(var b=0;b<this.utils.units.length;b++){var c=this.utils.units[b],d={};d.x=c.get_CoordX(),d.y=c.get_CoordY(),d.id=c.get_Id(),d.enabled=c.get_Enabled(),a.push(d)}return a}catch(e){console.log(e)}},doShift:function(a){if(a==="u"){var b=-1}if(a==="d"){var b=1}if(a==="l"){var c=-1}if(a==="r"){var c=1}if(!b){var b=0}if(!c){var c=0}this.initArmyFormation();var d=[];this.unbindArmyChangedEvent();for(var e=0;e<this.utils.units.length;e++){var f=this.utils.units[e],g={},h=f.get_CoordX()+c;switch(h){case 9:h=0;break;case-1:h=8;break;default:}var i=f.get_CoordY()+b;switch(i){case 4:i=0;break;case-1:i=3;break;default:}g.x=h,g.y=i,g.id=f.get_Id(),g.enabled=f.get_Enabled(),d.push(g)}this.restoreFormation(d),this.calculateSimResults(true),this.bindArmyChangedEvent()},optimizeFormation:function(){this.unbindArmyChangedEvent();this.defenceFacFull=false;this.defenceFull=false;this.optimizeFormations(1,this.randomizeFormation(-1),this.getScore())},optimizeFormations:function(a,b,c){if(a===this.utils.units.length||!this.battleResultsBox.isVisible()){console.log("End: "+c);this.restoreFormation(b);this.calculateSimResults(true);this.bindArmyChangedEvent();this.buttons.attack.tools.setEnabled(true);this.buttons.attack.simulate.setEnabled(true);this.buttons.attack.optimize.setEnabled(true)}else{var d=this;setTimeout(function(){try{var e=d.randomizeFormation(a%d.utils.units.length);d.restoreFormation(e);d.calculateSimResults(false,false);var f=d.getScore();if(f>c){b=e;c=f;d.updateStatsWindow();console.log("Try:"+f)}else{d.restoreFormation(b)}d.optimizeFormations(++a,b,c)}catch(g){console.log(g)}},10)}},getScore:function(){try{var a=this.defenceFacFull&&this.defenceFull?{defenceFacility:100,defences:100}:this.getStartHPs();return(100-this.stats.damage.structures.construction)*100+(a.defenceFacility-this.stats.damage.structures.defense)*20+(a.defences-this.stats.damage.units.overall)*3+(this.stats.health.overall+this.stats.damage.structures.overall)-this.stats.repair.overall/18}catch(b){console.log(b)}},defenceFacFull:false,defenceFull:false,getStartHPs:function(){try{var a=this.setupBattleground(this.utils.offenseUnits),b=a.get_Entities().d,c=ClientLib.Res.ResMain.GetInstance().GetGamedata().units,d,e,f={defenceFacility:100,defences:0},g,h,i=0;for(var j in b){e=b[j].get_Entity();d=c[e.get_MDCTypeId()];g=e.get_iHitpointsCurrent();h=e.get_iHitpoints();if(e.get_eAlignment()!=1&&d.r.length>1){if(e.get_MDCTypeId()==158||e.get_MDCTypeId()==131||e.get_MDCTypeId()==195){f.defenceFacility=g/h*100;this.defenceFacFull=f.defenceFacility===100}else if(d.mt!=ClientLib.Base.EUnitMovementType.Structure){f.defences+=g/h*100;i++}}}f.defences/=i;this.defenceFull=f.defences===100;return f}catch(k){console.log(k)}},getRandom:function(a,b){return Math.floor(Math.random()*(b-a+1))+a},randomizeFormation:function(a){var b,c,d=[],e,f,g;var h=Math.random();e=h>.65&&a>-1?this.getRandom(0,this.utils.units.length):-1;f=h>.75&&a>-1?this.getRandom(0,this.utils.units.length):-1;g=h>.85&&a>-1?this.getRandom(0,this.utils.units.length):-1;for(var i=0;i<this.utils.units.length;i++){b=this.utils.units[i];c={};c.x=b.get_CoordX();c.y=b.get_CoordY();c.id=b.get_Id();c.enabled=b.get_Enabled();if(i===a||i===e||i===f||i===g){c.x=(c.x+this.getRandom(0,8))%9;c.y=(c.y+this.getRandom(0,3))%4}d.push(c)}return d}}})}function e(){try{typeof qx!="undefined"?(a=qx.core.Init.getApplication(),a=qx.core.Init.getApplication().getMenuBar(),a&&a&&typeof PerforceChangelist!="undefined"?(PerforceChangelist===371911?d():alert("C&C TA Combat Simulator:\r\nUnsupported Version: "+PerforceChangelist),window.TASuite.main.getInstance().initialize()):window.setTimeout(e,1e3)):window.setTimeout(e,1e3)}catch(b){typeof console!="undefined"?console.log(b):window.opera?opera.postError(b):GM_log(b)}}console.log("CombatSim: Simulator loaded"),/commandandconquer\.com/i.test(document.domain)&&window.setTimeout(e,5e3)},c=document.createElement("script"),d=b.toString();c.innerHTML="("+d+")();",c.type="text/javascript",/commandandconquer\.com/i.test(document.domain)&&document.getElementsByTagName("head")[0].appendChild(c)})()