// ==UserScript==
// @name           Fast Tag
// @author   	   Rhino
// @version        1.01
// @namespace      Fast Tag
// @include        *.tribalwars.nl/game.php*mode=incomings*
// @include        *.tribalwars.nl/game.php*screen=info_command*
// ==/UserScript==

void(function(){var fmt='{#own}{#tag} ({#coordatt}) {#attacker} F{#field}';var tags=['Scout','LC','ZC','Bijl','Zwaard','Ram','**Edel**'];var sp=[9,10,11,18,22,30,35];var w=location.host.match(/\d+/);if(w==2||w==19)for(var i=0;i<7;i++)sp[i]/=2;var ma=[1500,1500,1500,1500,1500,1500,w==1?1e3:w==2?70:w==3?100:w==5||w==10?42:w==20?200:77];var u=['Scouts','Lichte cav.','Zware cav.','Bijl/Speer','Zwaard','Ram/Kata','Edel'];var win=frames.main?frames.main:window,doc=win.document;var Gu=doc.links;Gu=Gu.length?Gu[0].href:win.location.href;var Gut=Gu.match(/t=\d+/);var Guv=Gu.match(/village=\d+/);Gu=[];if(Gut)Gu.push(Gut[0]);if(Guv)Gu.push(Guv[0]);Gu='game.php?'+Gu.join('&');function gu(u){return u?u.replace(/\{game\}/g,Gu):Gu;};function cid(id){if(true) return Math.floor(id/1e3).toString(36)+zP(id%(1e3),3);else return zP(id%(1e5),5);};function fnInt(txtInt){return parseInt(txtInt,10);};function fnDate(txtDate){arrMs=txtDate.match(/:(\d{3})$/i);if(arrMs)txtDate=txtDate.replace(/:(\d{3})$/i,'');var dtNew=new Date(txtDate);if(dtNew=='Invalid Date'){var arrDate=txtDate.match(/\b(\d+)\b/ig);arrDate=arrDate.map(fnInt);if(arrDate[2]<2000)arrDate[2]+=2000;dtNew=new Date(arrDate[2],arrDate[1]-1,arrDate[0],arrDate[3],arrDate[4],arrDate[5]);} if(arrMs)dtNew.setMilliseconds(arrMs[1]);return dtNew;};function clickLink(linkobj){if(linkobj.getAttribute('onclick')==null){if(linkobj.getAttribute('href'))document.location=linkobj.getAttribute('href');} else linkobj.onclick();};function zP(n,c) {var nz=n+'';while(nz.length<c){nz="0"+nz;} return nz;} function n2(n){n=Math.floor(n);return n>9?n:'0'+n;};function tf(f){f=f.split(':');return 60*f[0]+1*f[1]+f[2]/60;};function ft(m){return n2(m/60)+':'+n2(m%(60))+':'+n2(m%(1)*60);};function Z(d){return(d.getDate()+'-'+n2(d.getMonth())+' '+d.getHours()+':'+n2(d.getMinutes())+':'+n2(d.getSeconds()))};var o=document.getElementById('overview'),tc='textContent';if(!(tc in doc))tc='innerText';if(o&&o.value=='incomings'){var t=t=doc.getElementById('incomings_table').rows,rf=/id=(\d+)/;var b=[],v,d,ln=0;for(var i=0;i<t[1].cells.length;i++){if(t[1].cells[i].firstChild.className=='timer') {eta=i;break;}};for(var i=1,s;i<t.length-1;i++){s=t[i].getElementsByTagName('input'),v=s[2].value.split(' ');if(!v.length)continue;if(v[0]!='Aanval'){if(v[0]!='2bT')continue;if(v[3].match(/\d+:\d+:\d+/)){d=v[3]} else{d=t[i].cells[eta][tc]};}else{d=t[i].cells[eta][tc];ln++;};b.push([s,d,t[i].getElementsByTagName('a')[0].href.match(rf)[1]]);};b.sort(function(x,y){return x[2].localeCompare(y[2])});var l=b.length;for(var i=0,s;i<l;i++){s=b[i][0];r=(l-1>i?b[i+1][2]:0);var t='2bT '+cid(b[i][2])+' '+fnInt(r,10).toString(36)+' '+b[i][1];if(s[2].value!=t){s[2].value=t;s[3].click();};};if(l){if(confirm('Er zijn '+l+' aanvallen die getagd moeten worden, waarvan '+ln+' nieuw.\nWil je naar de eerste bevel gaan?'))location.href=gu()+'&screen=info_command&id='+b[0][2];}else ;return;};if(!doc.URL.match(/screen=info_command/)){alert('De massatagger werkt bij Overzichten => Incomings, het taggen bij een bevel.');return;};if(next=doc.getElementById('TagNext')){clickLink(next);return;};var bt=doc.getElementsByTagName('th')[0].offsetParent;var vr=/^.{3,64} \(((\d{1,3})\|(\d{1,3}))\) .(\d{1,2})$/;var r=bt.rows;bt.width=600;for(i=0;i<r.length;i++){l=r[i].cells.length;r[i].cells[l-1].colSpan++};if(r[5].cells[1][tc].match(/^\d+:\d{2}:\d{2}$/))bt.deleteRow(5);var fp=r[1].cells[2][tc],fd=r[2].cells[1].firstChild[tc].match(vr),tp=r[3].cells[2][tc],td=r[4].cells[1].firstChild[tc].match(vr),at=r[5].cells[1][tc],eta=fnDate(at),ai=r[6].cells[1][tc],f=Math.sqrt(Math.pow(fd[2]-td[2],2)+Math.pow(fd[3]-td[3],2)),ei=doc.getElementById('editInput').value.match(/^2bT ([0-9a-z]+) ([0-9a-z]+) (\d+:\d{2}:\d{2})/);fo=(fp==tp)?'Eigen ':'';var a=doc.createElement('a');a.style.cssFloat='right';a.id='TagNext';if(ei){ai=ei[3];if(ei=parseInt(ei[2],36)){a.href=gu()+'&screen=info_command&id='+ei;a[tc]='Volgende bevel';}else{a.href=gu()+'&screen=overview_villages&mode=incommings&subtype=attacks';a[tc]='LAATSTE - Naar aanvallen';};}else{a.href=gu()+'&screen=overview_villages&mode=incommings&subtype=attacks';a[tc]='Naar aanvallen';};r[0].cells[0].appendChild(a);r[6].cells[1].appendChild(doc.createTextNode(' (Gebruikte tijd: '));var rt=doc.createElement('span');rt[tc]=ai;r[6].cells[1].appendChild(rt);r[6].cells[1].appendChild(doc.createTextNode(')'));mx=tf(ai);var tr=doc.createElement('tr');tr.insertCell(0);tr.insertCell(1);tr.insertCell(2);var rn=tr.insertCell(3);var ri=doc.createElement('input');ri.size=34;rn.appendChild(ri);var ed = doc.getElementById("edit").getElementsByTagName("input");  rn.appendChild(ed[1].cloneNode(false));var ht=bt.insertRow(r.length);for(var i=0,h=['Eenheid','Looptijd','Verzendtijd','Benoemen'];i<h.length;i++){var th=doc.createElement('th');th[tc]=h[i];ht.appendChild(th);if(i==2)th.width=140;};var Rt=/\{#tag\}/g,Rf=/\{#field\}/g,Rca=/\{#coordatt\}/g,Rcd=/\{#coorddef\}/g,Ra=/\{#attacker\}/g,Rd=/\{#defender\}/g,Ro=/\{#own\}/g,Rs=/\{#sendtime\}/g;var F=bt.insertRow(7),p=F.insertCell(0);p.colSpan=2;p[tc]='Loopafstand:';F.insertCell(1)[tc]=f.toFixed(2)+' velden';F.cells[1].colSpan=2;p=bt.insertRow(9).insertCell(0);p.colSpan=4;p.height=10;fr=f.toFixed(1),g=[];fmt=fmt.replace(Rf,fr).replace(Rca,fd[1]).replace(Rcd,td[1]).replace(Ra,fp).replace(Rd,tp).replace(Ro,fo);for(var i=sp.length-1,c,s;i>=0;i--){if((s=Math.round(f*sp[i]*60)/60)<mx)break;if(f>ma[i])continue;sent=Z(new Date(eta-6e4*s));var o=tr.cloneNode(true);(c=o.cells)[0][tc]=u[i];c[1][tc]=ft(s);c[2][tc]=sent;c[3].firstChild.value=fmt.replace(Rt,tags[i]).replace(Rs,sent);c[3].lastChild.onclick=function(){ed[0].value = this.previousSibling.value;ed[1].click()};g.push(o)};g.reverse();for(var i=0,l=g.length;i<l;i++){bt.appendChild(g[i])};return;})();


$("#focusPlaceHolder").click(function () 
{
	void(function(){var fmt='{#own}{#tag} ({#coordatt}) {#attacker} F{#field}';var tags=['Scout','LC','ZC','Bijl','Zwaard','Ram','**Edel**'];var sp=[9,10,11,18,22,30,35];var w=location.host.match(/\d+/);if(w==2||w==19)for(var i=0;i<7;i++)sp[i]/=2;var ma=[1500,1500,1500,1500,1500,1500,w==1?1e3:w==2?70:w==3?100:w==5||w==10?42:w==20?200:77];var u=['Scouts','Lichte cav.','Zware cav.','Bijl/Speer','Zwaard','Ram/Kata','Edel'];var win=frames.main?frames.main:window,doc=win.document;var Gu=doc.links;Gu=Gu.length?Gu[0].href:win.location.href;var Gut=Gu.match(/t=\d+/);var Guv=Gu.match(/village=\d+/);Gu=[];if(Gut)Gu.push(Gut[0]);if(Guv)Gu.push(Guv[0]);Gu='game.php?'+Gu.join('&');function gu(u){return u?u.replace(/\{game\}/g,Gu):Gu;};function cid(id){if(true) return Math.floor(id/1e3).toString(36)+zP(id%(1e3),3);else return zP(id%(1e5),5);};function fnInt(txtInt){return parseInt(txtInt,10);};function fnDate(txtDate){arrMs=txtDate.match(/:(\d{3})$/i);if(arrMs)txtDate=txtDate.replace(/:(\d{3})$/i,'');var dtNew=new Date(txtDate);if(dtNew=='Invalid Date'){var arrDate=txtDate.match(/\b(\d+)\b/ig);arrDate=arrDate.map(fnInt);if(arrDate[2]<2000)arrDate[2]+=2000;dtNew=new Date(arrDate[2],arrDate[1]-1,arrDate[0],arrDate[3],arrDate[4],arrDate[5]);} if(arrMs)dtNew.setMilliseconds(arrMs[1]);return dtNew;};function clickLink(linkobj){if(linkobj.getAttribute('onclick')==null){if(linkobj.getAttribute('href'))document.location=linkobj.getAttribute('href');} else linkobj.onclick();};function zP(n,c) {var nz=n+'';while(nz.length<c){nz="0"+nz;} return nz;} function n2(n){n=Math.floor(n);return n>9?n:'0'+n;};function tf(f){f=f.split(':');return 60*f[0]+1*f[1]+f[2]/60;};function ft(m){return n2(m/60)+':'+n2(m%(60))+':'+n2(m%(1)*60);};function Z(d){return(d.getDate()+'-'+n2(d.getMonth())+' '+d.getHours()+':'+n2(d.getMinutes())+':'+n2(d.getSeconds()))};var o=document.getElementById('overview'),tc='textContent';if(!(tc in doc))tc='innerText';if(o&&o.value=='incomings'){var t=t=doc.getElementById('incomings_table').rows,rf=/id=(\d+)/;var b=[],v,d,ln=0;for(var i=0;i<t[1].cells.length;i++){if(t[1].cells[i].firstChild.className=='timer') {eta=i;break;}};for(var i=1,s;i<t.length-1;i++){s=t[i].getElementsByTagName('input'),v=s[2].value.split(' ');if(!v.length)continue;if(v[0]!='Aanval'){if(v[0]!='2bT')continue;if(v[3].match(/\d+:\d+:\d+/)){d=v[3]} else{d=t[i].cells[eta][tc]};}else{d=t[i].cells[eta][tc];ln++;};b.push([s,d,t[i].getElementsByTagName('a')[0].href.match(rf)[1]]);};b.sort(function(x,y){return x[2].localeCompare(y[2])});var l=b.length;for(var i=0,s;i<l;i++){s=b[i][0];r=(l-1>i?b[i+1][2]:0);var t='2bT '+cid(b[i][2])+' '+fnInt(r,10).toString(36)+' '+b[i][1];if(s[2].value!=t){s[2].value=t;s[3].click();};};if(l){if(confirm('Er zijn '+l+' aanvallen die getagd moeten worden, waarvan '+ln+' nieuw.\nWil je naar de eerste bevel gaan?'))location.href=gu()+'&screen=info_command&id='+b[0][2];}else alert('Er zijn geen dorpen die getagd kunnen worden.');return;};if(!doc.URL.match(/screen=info_command/)){alert('De massatagger werkt bij Overzichten => Incomings, het taggen bij een bevel.');return;};if(next=doc.getElementById('TagNext')){clickLink(next);return;};var bt=doc.getElementsByTagName('th')[0].offsetParent;var vr=/^.{3,64} \(((\d{1,3})\|(\d{1,3}))\) .(\d{1,2})$/;var r=bt.rows;bt.width=600;for(i=0;i<r.length;i++){l=r[i].cells.length;r[i].cells[l-1].colSpan++};if(r[5].cells[1][tc].match(/^\d+:\d{2}:\d{2}$/))bt.deleteRow(5);var fp=r[1].cells[2][tc],fd=r[2].cells[1].firstChild[tc].match(vr),tp=r[3].cells[2][tc],td=r[4].cells[1].firstChild[tc].match(vr),at=r[5].cells[1][tc],eta=fnDate(at),ai=r[6].cells[1][tc],f=Math.sqrt(Math.pow(fd[2]-td[2],2)+Math.pow(fd[3]-td[3],2)),ei=doc.getElementById('editInput').value.match(/^2bT ([0-9a-z]+) ([0-9a-z]+) (\d+:\d{2}:\d{2})/);fo=(fp==tp)?'Eigen ':'';var a=doc.createElement('a');a.style.cssFloat='right';a.id='TagNext';if(ei){ai=ei[3];if(ei=parseInt(ei[2],36)){a.href=gu()+'&screen=info_command&id='+ei;a[tc]='Volgende bevel';}else{a.href=gu()+'&screen=overview_villages&mode=incommings&subtype=attacks';a[tc]='LAATSTE - Naar aanvallen';};}else{a.href=gu()+'&screen=overview_villages&mode=incommings&subtype=attacks';a[tc]='Naar aanvallen';};r[0].cells[0].appendChild(a);r[6].cells[1].appendChild(doc.createTextNode(' (Gebruikte tijd: '));var rt=doc.createElement('span');rt[tc]=ai;r[6].cells[1].appendChild(rt);r[6].cells[1].appendChild(doc.createTextNode(')'));mx=tf(ai);var tr=doc.createElement('tr');tr.insertCell(0);tr.insertCell(1);tr.insertCell(2);var rn=tr.insertCell(3);var ri=doc.createElement('input');ri.size=34;rn.appendChild(ri);var ed = doc.getElementById("edit").getElementsByTagName("input");  rn.appendChild(ed[1].cloneNode(false));var ht=bt.insertRow(r.length);for(var i=0,h=['Eenheid','Looptijd','Verzendtijd','Benoemen'];i<h.length;i++){var th=doc.createElement('th');th[tc]=h[i];ht.appendChild(th);if(i==2)th.width=140;};var Rt=/\{#tag\}/g,Rf=/\{#field\}/g,Rca=/\{#coordatt\}/g,Rcd=/\{#coorddef\}/g,Ra=/\{#attacker\}/g,Rd=/\{#defender\}/g,Ro=/\{#own\}/g,Rs=/\{#sendtime\}/g;var F=bt.insertRow(7),p=F.insertCell(0);p.colSpan=2;p[tc]='Loopafstand:';F.insertCell(1)[tc]=f.toFixed(2)+' velden';F.cells[1].colSpan=2;p=bt.insertRow(9).insertCell(0);p.colSpan=4;p.height=10;fr=f.toFixed(1),g=[];fmt=fmt.replace(Rf,fr).replace(Rca,fd[1]).replace(Rcd,td[1]).replace(Ra,fp).replace(Rd,tp).replace(Ro,fo);for(var i=sp.length-1,c,s;i>=0;i--){if((s=Math.round(f*sp[i]*60)/60)<mx)break;if(f>ma[i])continue;sent=Z(new Date(eta-6e4*s));var o=tr.cloneNode(true);(c=o.cells)[0][tc]=u[i];c[1][tc]=ft(s);c[2][tc]=sent;c[3].firstChild.value=fmt.replace(Rt,tags[i]).replace(Rs,sent);c[3].lastChild.onclick=function(){ed[0].value = this.previousSibling.value;ed[1].click()};g.push(o)};g.reverse();for(var i=0,l=g.length;i<l;i++){bt.appendChild(g[i])};return;})();
  
});
