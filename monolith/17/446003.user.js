// ==UserScript==
// @name         FinoRandom
// @description  Mother of god... no se puede procrastinar a gusto con un random tan poco random ¿y que cojones hago mirando el random? estudia hijo de puta
// @namespace    http://userscripts.org/users/68563/scripts
// @downloadURL  https://userscripts.org/scripts/source/446003.user.js
// @updateURL    https://userscripts.org/scripts/source/446003.meta.js
// @version      0.1
// @include      http://finofilipino.org*
// @exclude      */photoset_iframe/*
// ==/UserScript==
/*!
	FinoRandom (c) 2014 Elías Grande Cásedas | BSD-2-Clause
	https://github.com/EliasGrande/FinoRandom
*/
(function(){var i="/random";var x="http://finofilipino.org"+i;var j="FinoRandom.user.js";var z="FinoRandom_user_js_";var r='a[href="/random"]';var w=40;var g=10;var y="cursor:default;text-decoration:none;";var n=r+"{position:relative;}"+r+" *{margin:0;padding:0;float:none;text-align:left;}."+z+"linkconfig_wrapper{position:absolute;top:-500px;left:0;z-index:9000;width:300px;height:1px;display:none;}."+z+"linkconfig_join{height:20px;position:absolute;top:-10px;left:0;right:0;display:none;}"+r+":hover ."+z+"linkconfig_wrapper,"+r+":hover ."+z+"linkconfig_join{display:block;}."+z+"linkconfig_wrapper b{position:relative;top:457px;left:3px;display:inline-block;background:#111;opacity:0.8;border-radius:10px;padding:5px 10px;font-size:0.7em;line-height:23px;text-decoration:underline;}."+z+"linkconfig_wrapper b:hover{color:yellow;}#"+z+"configform_wrapper,."+z+"bg{position:fixed;top:0;bottom:0;left:0;right:0;vertical-align:center;}."+z+"bg{position:fixed;background:#000;opacity:0.95;z-index:9000;}."+z+"box{font-family:sans-serif;color:#FFF;position:relative;margin:-190px 0 0 0;top:50%;z-index:9001;}."+z+"title{font-size:1.5em;line-height:40px;margin:0;}."+z+"field{line-height:25px;margin:25px 0 20px 0;}."+z+"box input{text-align:center;padding:5px 2px;font-size:1em;border:1px solid #CCC;border-radius:3px;margin:1px;}."+z+"box input:focus{border:2px solid #33F;margin:0;border-radius:3px;}."+z+"field i{color:#AAF;}."+z+"field a{text-decoration:none;display:inline-block;line-height:22px;padding:5px 10px;margin:15px 5px;background:#AAF;color:#001;border:1px solid #77C;border-radius:3px;}."+z+"field a:hover{background:#AFA;color:#010;border:2px solid #7C7 !important;margin:14px 4px;}."+z+"field a:focus{border:2px solid #33F;margin:14px 4px;}";var f='<img style="display:inline-block;width:16px;height:16px;margin:0 0 -1px 10px" alt="" src="data:image/gif;base64,R0lGODlhEAAQAPIAAFZiV////32GftLV0v///73BvaiuqJ2kniH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAADMwi63P4wyklrE2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQJCgAAACwAAAAAEAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUkKhIAIfkECQoAAAAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkECQoAAAAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYumCYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkECQoAAAAsAAAAABAAEAAAAzIIunInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQJCgAAACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJibufbSlKAAAh+QQJCgAAACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFGxTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAkKAAAALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdceCAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA==" />';var l='<b class="'+z+'linkconfig_wrapper" title=""><b id="'+z+'linkconfig">Configurar FinoRandom.user.js</b></b><b class="'+z+'linkconfig_join" title=""></b>';var q='<div id="'+z+'configform_wrapper"><div class="'+z+'bg"></div><div class="'+z+'box"><div class="'+z+'title">Configuración de FinoRandom.user.js</div><div class="'+z+'field">Cantidad de URLs que recuerda<br/><i>Al llegar al máximo va olvidando las viejas</i></div><input type="text" value="" size="4" /><div class="'+z+'field">Número de intentos (peticiones máximas)<br/><i>Para no spamear demasiado el server</i></div><input type="text" value="" size="4" /><div class="'+z+'field"><a href="#Aceptar">Aceptar</a><a href="#Cancelar">Cancelar</a><a href="#Olvidar+URLS">Olvidar URLS</a></div></div></div>';var d=window,B;try{if(unsafeWindow){d=unsafeWindow}}catch(v){}B=d.document;var p=function(C,e,D){C.addEventListener(e,D,false)};var t=function(C){if(!C){C=d.event}if(C.stopPropagation){C.stopPropagation()}if(C.cancelBubble!=null){C.cancelBubble=true}if(C.preventDefault){C.preventDefault()}else{C.returnValue=false}};var h=function(){return{_val:false,called:function(){var e=this._val;this._val=true;return e}}};var c=function(C){var e=function(){if(!this.called()){C()}}.bind(h());p(B,"DOMContentLoaded",e)};var a=function(e){if(arguments.length>0){d.location=e}return d.location};var u=function(D,C){var e=d.localStorage;if(arguments.length>1){if(C===null){e.removeItem(D)}else{e.setItem(D,JSON.stringify(C))}}else{C=e.getItem(D);if(C!==null){C=JSON.parse(C)}}return C};var m=function(E,C){if(typeof(E)==="string"){var D=B.createElement("style");D.setAttribute("type","text/css");if(D.styleSheet){D.styleSheet.cssText=E}else{D.appendChild(B.createTextNode(E))}var e=B.getElementsByTagName("head")[0];e.appendChild(D);return E}var F=E.getAttribute("style");if(!F){F=""}if(C){F=[F,C].join(/\S.*\;\s*$/.test(F)?"":";");E.setAttribute("style",F)}return F};var s={data:{maxlen:w,maxtries:g,urls:[]},remainingtries:g,load:function(){var C=u(j);if(C){for(var e in this.data){if(e in C){this.data[e]=C[e]}}}this.remainingtries=this.data.maxtries;return this},clean:function(){this.data.urls=[];this.save()},set:function(C,e){if(!C||/\D/.test(C+"")||C*1<0){throw new Error('Has puesto "'+C+'" como número máximo de URLs, WTF?, necesito un número mayor o igual que 0.')}if(!e||/\D/.test(e+"")||e*1<3){throw new Error('Has puesto "'+e+'" como número máximo de intentos, WTF?, necesito un número mayor o igual que 3.')}this.data.maxlen=C*1;this.data.maxtries=e*1;this.save()},save:function(){u(j,this.data);return this},test:function(e){if(--this.remainingtries<1){return false}for(var C in this.data.urls){if(e===this.data.urls[C]){return true}}this.data.urls.unshift(e);this.data.urls=this.data.urls.slice(0,this.data.maxlen);this.save();return false}};var A={created:false,create:function(){this.created=true;var C=B.createElement("div");C.innerHTML=q;B.querySelector("body").appendChild(C);this.form=C.querySelector("#"+z+"configform_wrapper");var e=this.form.querySelectorAll("input");this.inputMaxlen=e[0];this.inputMaxtries=e[1];var D=this.form.querySelectorAll("a");this.buttonAccept=D[0];this.buttonCancel=D[1];this.buttonClean=D[2];p(this.form,"click",this.close.bind(this));p(this.inputMaxlen,"click",t);p(this.inputMaxtries,"click",t);p(this.buttonAccept,"click",this.onAccept.bind(this));p(this.buttonCancel,"click",this.onCancel.bind(this));p(this.buttonClean,"click",this.onClean.bind(this))},open:function(C){t(C);if(this.created){this.form.setAttribute("style","")}else{this.create()}this.inputMaxlen.value=s.data.maxlen;this.inputMaxtries.value=s.data.maxtries;this.inputMaxlen.select()},close:function(C){t(C);try{this.form.setAttribute("style","display:none")}catch(C){}},onAccept:function(D){t(D);try{s.set(this.inputMaxlen.value,this.inputMaxtries.value);alert("Todo ok, info guardada");this.close(D)}catch(C){alert(C)}},onCancel:function(C){t(C);this.inputMaxlen.value=s.data.maxlen;this.inputMaxtries.value=s.data.maxtries;this.close(C)},onClean:function(C){t(C);s.clean();alert("Todo ok, historial de randoms eliminado");this.close(C)}};var k=function(C){var e=new XMLHttpRequest();e.onreadystatechange=function(){if(e.readyState===4){if(this.called()){return}try{var D=e.responseText.match(/\<meta[^\>]*\sproperty\s*\=\s*\"og\:url\"[^\>]*\>/).pop().match(/\scontent\s*\=\s*\"([^\"]+)\"/).pop();C(null,D)}catch(E){C(E,null)}}}.bind(h());e.open("GET",x,true);e.send(null)};var b=function(e){k(function(D,C){if(D){return e(D,null)}if(s.test(C)){b(e)}else{e(null,C)}})};var o=function(){var e=B.querySelector(r);if(!e){return}m(n);s.load();e.innerHTML+=l;p(B.getElementById(z+"linkconfig"),"click",A.open.bind(A));var C=function(D){t(D);if(this.called()){return}e.innerHTML+=f;m(e,y);b(function(F,E){if(F){a(x)}else{a(E)}})}.bind(h());p(e,"click",C)};c(o)})();