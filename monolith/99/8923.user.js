// ==/UserScript==

(function() {	function createFrag(html, after) {
		var range = document.createRange();
		range.setStartAfter(after);
		var frag = range.createContextualFragment(html);
		return frag;
	}	if (/game\.php\?.*screen=place.*try=confirm/.test(document.location)) {		var tds = document.getElementsByTagName("a");				var xv, yv, name, m;		for (k in tds) {			if (m = /^(.*) \((\d{3})\|(\d{3})\) [CK]\d{2}/.exec(tds[k].innerHTML)) {				xv = Number(m[2]);				yv = Number(m[3]);				name = m[1];				break;			}		}				if (xv != null && yv != null) {			var wid = /tw(\d+).tribalwars.net/;			wid = wid[1];			var vid = /\?village=(\d+)/.exec(document.location);			vid = vid[1];			GM_setValue("twrally."+wid+"."+vid+".name", name);			GM_setValue("twrally."+wid+"."+vid+".x", xv);			GM_setValue("twrally."+wid+"."+vid+".y", yv);		}	}	else if (/game\.php\?.*screen=place/.test(document.location)) {				var vid = /\?village=(\d+)/.exec(document.location);		vid = vid[1];				//alert(document.forms);		//var a = document.getElementByName("units");				var form = null;		for (k in document.forms) {			if (/game\.php\?.*try=confirm/.test(document.forms[k].action)) {				form = document.forms[k];				break;			}		}				if (form == null)			return;				var eles = form.elements;				var xe, ye;				for (k in eles) {			if (eles[k].name == "x")				xe = eles[k];			else if (eles[k].name == "y")				ye = eles[k];		}				if (xe.value != '' || ye.value != '') {			return;		}				var xs = GM_getValue("twrally."+wid+"."+vid+".x");		var ys = GM_getValue("twrally."+wid+"."+vid+".y");				if (xs == null || ys == null)			return;				xe.value = xs;		ye.value = ys;				GM_log(xe.parentNode.rowSpan);		xe.parentNode.rowSpan = 1;		xe.parentNode.valign = 'top';				a = function() {			document.getElementById("last_name").style.display = "none";		}				xe.setAttribute('id', "xv");		ye.setAttribute('id', "yv");				xe.setAttribute('onblur', "if (document.getElementById('xv').value == '') { document.getElementById('xv').value = "+xs+";}; if (document.getElementById('xv').value == '"+xs+"' && document.getElementById('yv').value == '"+ys+"') {document.getElementById('last_name').style.display = 'inline'}");		ye.setAttribute('onblur', "if (document.getElementById('yv').value == '') { document.getElementById('yv').value = "+ys+";}; if (document.getElementById('xv').value == '"+xs+"' && document.getElementById('yv').value == '"+ys+"') {document.getElementById('last_name').style.display = 'inline'}");				xe.setAttribute('onkeydown', "document.getElementById('last_name').style.display = 'none';");		xe.setAttribute('onfocus', "document.getElementById('last_name').style.display = 'none'; if (document.getElementById('xv').value == "+xs+") document.getElementById('xv').value = '';");				ye.setAttribute('onkeydown', "document.getElementById('last_name').style.display = 'none';");		ye.setAttribute('onfocus', "document.getElementById('last_name').style.display = 'none'; if (document.getElementById('yv').value == "+ys+") document.getElementById('yv').value = '';");				//xe.parentNode.pa				xe.parentNode.appendChild(createFrag("<br><span style='color: gray; font-size: x-small;' id='last_name'>" + GM_getValue("twrally."+wid+"."+vid+".name") + "</span>",xe.parentNode));	}	else if (/game\.php\?.*screen=report.*view=\d+/.test(document.location)) {		var tds = document.getElementsByTagName("th");				var brow;				var iron, clay, wood;		for (var k in tds) {			if (tds[k].innerHTML != "Buildings:") continue;						brow = tds[k].parentNode;						GM_log(brow.parentNode);						var report=tds[k].nextSibling;						var m = /Timber camp\s+\(Level (\d+)\)/.exec(report.textContent);						if (m == null)				wood = 7;			else				wood = m[1];							var m = /Clay pit\s+\(Level (\d+)\)/.exec(report.textContent);						if (m == null)				clay = 7;			else				clay = m[1];							var m = /Iron mine\s+\(Level (\d+)\)/.exec(report.textContent);						if (m == null)				iron = 7;			else				iron = m[1];		}				var tr = document.createElement("tr");		var th = document.createElement("th");		var td = document.createElement("td");		tr.appendChild(th);		tr.appendChild(td);				th.innerHTML = "Resource production: ";				const production = new Array();		production['1'] = new Array(7,30,35,41,47,55,64,74,86,100,117,136,158,184,214,249,289,337,391,455,530,616,717,833,969,1127,1311,1525,1774,2063,2400);		production['2'] = new Array(7,45,52,61,71,82,96,111,130,151,175,204,237,276,321,373,434,505,587,683,794,924,1075,1250,1454,1691,1967,2288,2661,3095,3600);				var wid;				wid = /^http:\/\/tw(\d+)\.tribalwars\.net/.exec(document.location);		wid = wid[1];				var img = document.createElement("img");		img.src = "http://tw2.tribalwars.net/graphic/holz.png";				td.appendChild(img);		td.appendChild(document.createTextNode(production[wid][Number(wood)] + ' '));				var img = document.createElement("img");		img.src = "http://tw2.tribalwars.net/graphic/lehm.png";				td.appendChild(img);		td.appendChild(document.createTextNode(production[wid][Number(clay)] + ' '));				var img = document.createElement("img");		img.src = "http://tw2.tribalwars.net/graphic/eisen.png";				td.appendChild(img);		td.appendChild(document.createTextNode(production[wid][Number(iron)] + ' '));				var sp = document.createElement("span");				sp.style.color = "gray";		sp.appendChild(document.createTextNode(" (" + (production[wid][Number(wood)] + production[wid][Number(clay)] + production[wid][Number(iron)]) + ")"));				td.appendChild(sp);				//var ci = 		GM_log(brow);		if (brow.nextSibling) {
			brow.parentNode.insertBefore(tr, brow.nextSibling);		}
		else {
			brow.parentNode.appendChild(tr);
		}	}})();