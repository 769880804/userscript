// ==UserScript==
// @id             Jnu
// @name           暨南大学图书馆豆瓣插件firefox拓展版
// @version        Beta1.0
// @namespace      
// @author         zyt
// @description    暨南大学图书馆豆瓣插件firefox版（支持珠海校区）
// @include        about:addons
// @include        http://book.douban.com/subject/*
// @include        http://202.116.13.244/search~S1*chx?/*
// @include        http://202.116.24.97/cgi-bin/DispBibDetail*
// @exclude        http://movie.douban.com/
// @exclude        http://music.douban.com/
// @exclude        http://book.douban.com/
// @exclude        http://www.douban.com/*
// @exclude        http://9.douban.com/*
// @exclude        http://*.douban.com/subject/*/edit
// @exclude        http://*.douban.com/subject/*/update_image
// @exclude        http://*.douban.com/subject/*/edit?mine
// @exclude        http://*.douban.com/subject/*/new_version
// @exclude        http://*.douban.com/subject/*/offers
// @exclude        http://*.douban.com/subject/*/new_offer
// @exclude        http://*.douban.com/subject/offer/*/
// @exclude        http://*.douban.com/subject/*/cinema?view=ticket
// @exclude        http://*.douban.com/subject/*/doulists
// @exclude        http://*.douban.com/subject/*/all_photos
// @exclude        http://*.douban.com/subject/*/mupload
// @exclude        http://*.douban.com/subject/*/comments
// @exclude        http://*.douban.com/subject/*/reviews
// @exclude         http://*.douban.com/subject/*/new_review
// @exclude         http://*.douban.com/subject/*/group_collectors
// @exclude         http://*.douban.com/subject/*/discussion/
// @exclude         http://*.douban.com/subject/*/wishes
// @exclude        http://*.douban.com/subject/*/doings
// @exclude        http://*.douban.com/subject/*/collections
// @run-at         document-end
// ==/UserScript==
(function(){var a={};a.Init=function(){var b=location.href;if(b.search(/http:\/\/book.douban.com\/subject/)!=-1){a.douban()}else{if(b.search(/http:\/\/202.116.13.244\/search\~S1\*chx\?/)!=-1){a.jnu_Benbu()}else{a.jnu_ZhuHai()}}};a.douban=function(){var b=document.getElementById("wrapper");var b=b.childNodes;var e;for(var c=0;c<b.length;c++){if(String(b[c].tagName).toLowerCase()=="h1"){b=b[c];break}}b=b.getElementsByTagName("span")[0];var d=b.childNodes[0].textContent;a.get_Jnu_Benbu_Info(d);a.get_Jnu_ZhuHai_Info(d)};a.get_Douban_Info=function(e,b){var d=null;var c="http://book.douban.com/subject_search?search_text="+e+"&cat=1003";GM_xmlhttpRequest({method:"GET",url:c,onload:function(h){if(h.status==200){var n=h.responseText;var g=document.createElement("div");var o=n.search("<body");var k=n.search("</body>");n=n.slice(o,k);o=n.search(">");n=n.slice(o+1,n.length);g.innerHTML="<div style='display:none;'>"+n+"</div>";document.body.appendChild(g);var j=document.getElementById("content").getElementsByClassName("article")[0].getElementsByTagName("table");for(var l=0;l<j.length;l++){var f=j[l].getElementsByTagName("td")[1].getElementsByTagName("a")[0];var m=f.textContent;if(m==e){j=j[l];break}}if(j.length&&j.length>1){j=null}if(b=="jnu_Benbu"){a.insertTo_Benbu(j)}else{a.insertTo_ZhuHai(j)}}},onerror:function(){}})};a.jnu_Benbu=function(){var f=document.body.innerHTML;var e=f.search("<!-- next row for fieldtag=t -->");f=f.slice(e,f.length);e=0;var b=f.search("</tr>");f=f.slice(e,b);e=f.search("</td>");f=f.slice(e+String("</td>").length,f.length);e=f.search("<strong>");b=f.lastIndexOf("</strong>");f=f.slice(e,b)+"</strong>";var c=document.createElement("div");c.innerHTML="<div style='display:none;'>"+f+"</div>";f=c.textContent;var d=f;d=d.slice(d.lastIndexOf(">")+1,d.length);a.get_Douban_Info(d,"jnu_Benbu")};a.insertTo_DouBan=function(d){var e=document.getElementById("interest_sect_level");e.innerHTML=d+e.innerHTML;var c=document.getElementById("icrt_jnu_block").getElementsByTagName("a");for(var b=0;b<c.length;b++){c[b].setAttribute("target","_blank")}};a.insertTo_Benbu=function(d){var e=document.getElementById("ml");if(!d){e.innerHTML="<div style='color:green;font-size:15px;'><p>\u6ca1\u6709\u5728\u8c46\u74e3\u4e0a\u627e\u5230\u8fd9\u672c\u4e66\uff01</p></div>"+e.innerHTML}d.innerHTML="<div id='icrt_jnu_block' style='padding-top:10px;padding-bottom:10px;margin:15px 0px;border-top:1px dotted gray;border-bottom: 1px dotted gray;'><p style='color:green;font-size:17px;'>\u8fd9\u672c\u4e66\u5728\u8c46\u74e3\u4e0a\u60c5\u51b5:</p><table>"+d.innerHTML+"</table></div></div>";var c=document.getElementById("icrt_jnu_block").getElementsByTagName("a");for(var b=0;b<c.length;b++){c[b].setAttribute("target","_blank")}e.innerHTML=d.innerHTML+e.innerHTML};a.get_Jnu_Benbu_Info=function(d){var c=null;var b="http://202.116.13.244/search*chx/?searchtype=X&searcharg=+"+d+"&x=0&y=0";GM_xmlhttpRequest({method:"GET",url:b,onload:function(g){if(g.status==200){var j=g.responseText;var f=j.search("\u8bf7\u586b\u8868\u3001\u9009\u62e9\u9650\u5236\u8303\u56f4\u3001\u7136\u540e\u8f7b\u70b9\u63d0\u4ea4\u3002");if(f==-1){var h=j;var i=j.search("<!--{nohitmsg}-->");j=j.slice(i,j.length);var e=j.search("</span>");j=j.slice(0,e);i=j.search("<a");e=j.search("</a>");j=j.slice(i,e);i=j.lastIndexOf(">");j=j.slice(i+1,j.length);if(j!=d){j=h;if(j.search('id="items_for_sms"')!=-1){i=j.search('id="items_for_sms"');i=j.lastIndexOf("<div",i);j=j.slice(i,j.length);i=j.search("<table");e=j.search("</table>");j=j.slice(i,e);j+="</table>";a.insertTo_DouBan("<div id='icrt_block'  style='padding-top:10px;padding-bottom:10px;margin:15px 0px;border-top:1px dotted gray;border-bottom: 1px dotted gray;'><p style='color:green;font-size:18px;' class='icrt_block_title'>\u66a8\u5927\u56fe\u4e66\u9986(\u672c\u90e8)\u54ea\u91cc\u6709\u8fd9\u672c\u4e66\uff1f</p>"+j+"</div>");return}a.insertTo_DouBan("<div id='icrt_block' style='padding-top:10px;padding-bottom:10px;margin:15px 0px;border-top:1px dotted gray;border-bottom: 1px dotted gray;'><p style='color:green;font-size:18px;' class='icrt_block_title'>\u6ca1\u6709\u8fd9\u672c\u4e66\uff01<a class='icrt_go' href='http://lib.jnu.edu.cn/users/goBookOpac.action'>\u628a\u8fd9\u672c\u4e66\u8350\u8d2d\u7ed9\u66a8\u5927\u56fe\u4e66\u9986</a></p></div>");return}j=h;i=j.search("<!-- This File Last Changed: 01 July 2008 -->");j=j.slice(i,j.length);i=j.search("<table");e=j.search("</table>");j=j.slice(i,e);j+="</table>";a.insertTo_DouBan("<div id='icrt_block' style='padding-top:10px;padding-bottom:10px;margin:15px 0px;border-top:1px dotted gray;border-bottom: 1px dotted gray;'><p style='color:green;font-size:18px;' class='icrt_block_title'>\u66a8\u5927\u56fe\u4e66\u9986(\u672c\u90e8)\u54ea\u91cc\u6709\u8fd9\u672c\u4e66\uff1f</p>"+j+"</div>")}else{a.insertTo_Benbu("<div id='icrt_block' style='padding-top:10px;padding-bottom:10px;margin:15px 0px;border-top:1px dotted gray;border-bottom: 1px dotted gray;'><p style='color:green;font-size:18px;' class='icrt_block_title'>\u6ca1\u6709\u8fd9\u672c\u4e66\uff01<a class='icrt_go' href='http://lib.jnu.edu.cn/users/goBookOpac.action'>\u628a\u8fd9\u672c\u4e66\u8350\u8d2d\u7ed9\u66a8\u5927\u56fe\u4e66\u9986</a></p></div>")}}},onerror:function(){}})};a.jnu_ZhuHai=function(){var d=document.getElementsByTagName("td");var f;for(var e=0,b=d.length;e<b;e++){var c=d[e].getElementsByTagName("b")[0];if(c){c=c.textContent;if(c.search("\u9898\u3000\u540d:")!=-1){f=d[e].getElementsByTagName("a")[0].textContent;break}}}a.get_Douban_Info(f,"jnu_ZhuHai")};a.get_Jnu_ZhuHai_Info=function(c){var b="http://202.116.24.97/cgi-bin/IlaswebBib?v_index=TITLE&v_value="+c+"&B12.x=0&B12.y=0";GM_xmlhttpRequest({method:"GET",url:b,headers:{"User-agent":"Mozilla/4.0 (compatible) Greasemonkey",Accept:" text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",},onload:function(d){if(d.status==200){var e=d.responseText}},onerror:function(){}})};a.insertTo_ZhuHai=function(c){var d=document.getElementsByTagName("font");for(var b=0;b<d.length;b++){if(d[b].textContent=="\u6b22\u8fce\u60a8\u4f7f\u7528\u66a8\u5357\u5927\u5b66\u73e0\u6d77\u5b66\u9662\u7f51\u4e0a\u56fe\u4e66\u9986"){d=d[b]}}if(!c){d.innerHTML=d.innerHTML+"<div style='color:green;font-size:15px;'><p>\u6ca1\u6709\u5728\u8c46\u74e3\u4e0a\u627e\u5230\u8fd9\u672c\u4e66\uff01</p></div>"}d.innerHTML=d.innerHTML+"<div id='icrt_jnu_block' style='padding-top:10px;padding-bottom:10px;margin:15px 0px;border-top:1px dotted gray;border-bottom: 1px dotted gray;'><p style='color:green;font-size:17px;'>\u8fd9\u672c\u4e66\u5728\u8c46\u74e3\u4e0a\u7684\u60c5\u51b5</p><table>"+c.innerHTML+"</table></div>"};a.Init()})();
