// ==UserScript==
// @name        SalvaBozza
// @description Effettua bozza topics
// @version     1.1
// @include     *.forumfree.it/*
// @include     *.forumcommunity.net/*
// @include     *.blogfree.net/*
// ==/UserScript==
function oldLayout(){return"BackCompat"==document.compatMode}var storageObj = {}; if(-1!=$(location).attr("href").indexOf("&t="))var sezId=$(location).attr("href").split("&f=")[1].split("&t=")[0],topicId=$(location).attr("href").split("&t=")[1],controlPost=!0;else sezId=$(location).attr("href").split("&f=")[1],controlPost=!1; $(function(){if(oldLayout())-1!=$(location).attr("href").indexOf("?act=Post&CODE=")&&($(".forminput[tabindex='11']").after("&nbsp;<input class='forminput' value='Salva Bozza' id='saveMessage' type='button'><div id='restoreMess' class='rest_mess'></div>"),controlPost?(a="t"+topicId,c=$(".nav li:last-child a").html(),d=$(".nav li:last-child").prev().find("a").html(),c=' in risposta al topic "<i>'+c+'</i>" (ID '):(c=a="",d=$(".nav li:last-child a").html()),null!=localStorage.getItem("messaggioBozzaf"+ sezId+a)?(a=localStorage.getItem("messaggioBozzaf"+sezId+a),a=JSON.parse(a),e=null==a.topicid?"":a.topicid+")",$("#restoreMess").html('Esiste un bozza creata il <span class="restore_time" style="font-weight: bold">'+a.date+'</span> nella sezione "<i>'+d+'</i>" (ID '+a.sezid+")"+c+e+': <a class="restorebutt" style="cursor: pointer"><b>Ripristina</b></a>.')):$("#restoreMess").html("Non esiste una bozza salvata. Per crearla clicca su <b>Salva Bozza</b>."));else if(-1!=$(location).attr("href").indexOf("?act=Post&CODE=")){$(".forminput[name='preview']").after("&nbsp;<input class='forminput' value='Salva Bozza' id='saveMessage' type='button'><div id='restoreMess' class='rest_mess'></div>"); if(controlPost)var a="t"+topicId,c=$(".nav li:last-child a").html(),d=$(".nav li:last-child").prev().find("a").html(),c=' in risposta al topic "<i>'+c+'</i>" (ID ';else c=a="",d=$(".nav li:last-child a").html();if(null!=localStorage.getItem("messaggioBozzaf"+sezId+a)){var a=localStorage.getItem("messaggioBozzaf"+sezId+a),a=JSON.parse(a),e=null==a.topicid?"":a.topicid+")";$("#restoreMess").html('Esiste un bozza creata il <span class="restore_time" style="font-weight: bold">'+a.date+'</span> nella sezione "<i>'+ d+'</i>" (ID '+a.sezid+")"+c+e+': <a class="restorebutt" style="cursor: pointer"><b>Ripristina</b></a>.')}else $("#restoreMess").html("Non esiste una bozza salvata. Per crearla clicca su <b>Salva Bozza</b>.")}}); $(document).on("click","#saveMessage",function(){if(controlPost)var a="t"+topicId,c=$(".nav li:last-child a").html(),d=$(".nav li:last-child").prev().find("a").html(),c=' in risposta al topic "<i>'+c+'</i>" (ID ',e=topicId+")";else c=a="",d=$(".nav li:last-child a").html(),e="";if(""==$("#Post").val())return alert("Non c'\u00e8 nulla da salvare!"),!1;if("Non esiste una bozza salvata. Per crearla clicca su <b>Salva Bozza</b>."!=$("#restoreMess").html()&&!confirm("Sicuro di voler sovrascrivere la bozza?"))return!1; var b=new Date,f=10>b.getDate()?"0"+b.getDate():b.getDate(),g=10>b.getMonth()+1?"0"+(b.getMonth()+1):b.getMonth()+1,h=10>b.getHours()?"0"+b.getHours():b.getHours(),k=10>b.getMinutes()?"0"+b.getMinutes():b.getMinutes(),b=f+"/"+g+"/"+b.getFullYear()+" "+h+":"+k;storageObj.date=b;storageObj.sezid=sezId;storageObj.topicid=topicId;$("#restoreMess").html('Esiste un bozza creata il <span class="restore_time" style="font-weight: bold">'+b+'</span> nella sezione "<i>'+d+'</i>" (ID '+sezId+")"+c+e+': <a class="restorebutt" style="cursor: pointer"><b>Ripristina</b></a>.'); storageObj.post=$("#Post").val();null!=localStorage.getItem("messaggioBozzaf"+sezId+a)&&localStorage.removeItem("messaggioBozzaf"+sezId+a);localStorage.setItem("messaggioBozzaf"+sezId+a,JSON.stringify(storageObj));alert("Bozza Salvata.")}); $(document).on("click",".restorebutt",function(){var a=controlPost?"t"+topicId:"";null==localStorage.getItem("messaggioBozzaf"+sezId+a)&&alert("Non esiste un ripristino.");a=localStorage.getItem("messaggioBozzaf"+sezId+a);a=JSON.parse(a);$("#Post").val(a.post);alert("Ripristino effettuato, adesso puoi salvare le modifiche.")});