// ==UserScript==
// @name    Input Field Autosaver
// @author  Witiko
// @version 1.0.5
// @include *
// ==/UserScript==
var header="IFS;location:"+location.href.replace(location.hash,"")+";",cache={name:{},className:{},id:{},all:{},html:[],htmlContent:[]};function save(){if(!document||!document.body)return;var c=getElements(),currentElements=[],saved,string;for(var d in localStorage){if(d.indexOf(header)==0)currentElements.push(d)};c.each(function(a,b){if((a.offsetWidth||a.offsetHeight)&&((a.value&&a.value!=a.defaultValue)||(a.contentEditable==="true"&&a.innerHTML&&a.innerHTML!="<br>"&&((string=cache.html.indexOf(a))==-1||a.innerHTML!=cache.htmlContent[string])))){if(!saved&&!a.id&&!a.name&&!a.className)saved=true;if(a.id){string=getElements("id",a.id).indexOf(a);string=header+"contentType:"+(a.contentEditable==="true"?"HTML":"text")+";identificatorType:id;identificator:"+a.id+"^"+string+"^"+getElements("id",a.id).length}else if(a.name){string=getElements("name",a.name).indexOf(a);string=header+"contentType:"+(a.contentEditable==="true"?"HTML":"text")+";identificatorType:name;identificator:"+a.name+"^"+string+"^"+getElements("name",a.name).length}else if(a.className){string=getElements("className",a.className).indexOf(a);string=header+"contentType:"+(a.contentEditable==="true"?"HTML":"text")+";identificatorType:class;identificator:"+a.className+"^"+string+"^"+getElements("className",a.className).length}else{string=header+"contentType:"+(a.contentEditable==="true"?"HTML":"text")+";identificatorType:index;identificator:"+b};localStorage.setItem(string,a.contentEditable==="true"?a.innerHTML:a.value);if((string=currentElements.indexOf(string))>-1)currentElements.remove(string)}});if(saved){string=header+"length";localStorage.setItem(string,c.length);if((string=currentElements.indexOf(string))>-1)currentElements.remove(string)};currentElements.each(function(a){localStorage.removeItem(a)})};function load(){var c=getElements(),currentElements={},saved,string,object,lengthEquals=false;for(var d in localStorage){if(d.indexOf(header+"length")==0){if(c.length==Number(localStorage.getItem(d)))lengthEquals=true}else if(d.indexOf(header)==0)currentElements[d]=localStorage.getItem(d)};c.each(function(a){if(a.contentEditable==="true"){cache.html.push(a);cache.htmlContent.push(a.innerHTML)}});for(var d in currentElements){object={};string=d.replace(header,"").split(";").each(function(a,b){a=a.split(":");object[a[0]]=a[1]});switch(object.identificatorType){case"id":string=object.identificator.split("^");if(Number(string[2])==getElements("id",string[0]).length)getElements("id",string[0])[Number(string[1])][object.contentType=="HTML"?"innerHTML":"value"]=currentElements[d];break;case"name":string=object.identificator.split("^");if(Number(string[2])==getElements("name",string[0]).length)getElements("name",string[0])[Number(string[1])][object.contentType=="HTML"?"innerHTML":"value"]=currentElements[d];break;case"class":string=object.identificator.split("^");if(Number(string[2])==getElements("className",string[0]).length)getElements("className",string[0])[Number(string[1])][object.contentType=="HTML"?"innerHTML":"value"]=currentElements[d];break;default:if(!lengthEquals)break;c[Number(object.identificator)][object.contentType=="HTML"?"innerHTML":"value"]=currentElements[d]}}};NodeList.prototype.toArray=function(){for(var a=0,length=this.length,array=[];a<length;a++){array.push(this[a])};return array};Array.prototype.each=function(a){if(typeof a!="function"||this.length==0)return this;for(var b=0;b<this.length;b++){if(a.call(this,this[b],b)==false)break};return this};Array.prototype.remove=function(a,b){var c=this.slice((b||a)+1||this.length);this.length=a<0?this.length+a:a;return this.push.apply(this,c)};function getElements(a,b){switch(a){case"id":if(!cache.id[b])cache.id[b]=document.querySelectorAll("input#"+b+":not([type = \"file\"]):not([type = \"password\"]):not([type = \"hidden\"]):not([type = \"radio\"]):not([type = \"checkbox\"]):not([type = \"submit\"]):not([type = \"button\"]), textarea#"+b+", #"+b+"[contenteditable = \"true\"]");return cache.id[b].toArray();case"name":if(!cache.name[b])cache.name[b]=document.querySelectorAll("input[name = \""+b+"\"]:not([type = \"file\"]):not([type = \"password\"]):not([type = \"hidden\"]):not([type = \"radio\"]):not([type = \"checkbox\"]):not([type = \"submit\"]):not([type = \"button\"]), textarea[name = \""+b+"\"], [name = \""+b+"\"][contenteditable = \"true\"]");return cache.name[b].toArray();case"className":if(!cache.className[b])cache.className[b]=document.querySelectorAll("input."+b+":not([type = \"file\"]):not([type = \"password\"]):not([type = \"hidden\"]):not([type = \"radio\"]):not([type = \"checkbox\"]):not([type = \"submit\"]):not([type = \"button\"]), textarea."+b+", ."+b+"[contenteditable = \"true\"]");return cache.className[b].toArray();default:if(!cache.all[b])cache.all[b]=document.querySelectorAll("input:not([type = \"file\"]):not([type = \"password\"]):not([type = \"hidden\"]):not([type = \"radio\"]):not([type = \"checkbox\"]):not([type = \"submit\"]):not([type = \"button\"]), textarea, [contenteditable = \"true\"]");return cache.all[b].toArray()}};load();window.addEventListener("beforeunload",save,false);