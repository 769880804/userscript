// ==UserScript==                                                                                                                                                                                                                               
// @name        Trackmaster Sub-Task Hider                                                                                                                                                                                                      
// @match     https://*/*                                                                                                                                                                                                                       
// @match     https://trackmaster.istockphoto.com/*                                                                                                                                                                                             
                                                                                                                                                                                                                                                
// ==/UserScript==                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                
$(document).ready(function() {                                                                                                                                                                                                                  
    var filterStatus,                                                                                                                                                                                                                           
        unfilterStatus,                                                                                                                                                                                                                         
        statusTypes = ['Open', 'In Progress', 'Reopeneded', 'Ops Review', 'Closed', 'Merge Requested', 'Unassigned', 'Queued', 'Assigned - Dev', 'Dev Review', 'QA Required', 'Assigned - QA', 'QA Review', 'Verified', 'Merged', 'Deployed', 'Assigned - Ops', 'Assigned - Ops - ON HOLD', 'Assigned - Dev - ON HOLD', 'Assigned - QA - ON HOLD', 'Scheduled', 'Assigned - CCC', 'Pending', 'SRCH Review', 'SRCH Assigned'],                                                                   
        selectedFilters = [];                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                
    filterStatus = function(index) {                                                                                                                                                                                                            
        $('.nav.status:contains("' + statusTypes[index] + '")').parent().hide();                                                                                                                                                                
    };                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                
    unfilterStatus = function(index) {                                                                                                                                                                                                          
        $('.nav.status:contains("' + statusTypes[index] + '")').parent().show();                                                                                                                                                                
    };                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                
    if (localStorage && localStorage.getItem('subtaskFilters')) {                                                                                                                                                                               
        selectedFilters = localStorage.getItem('subtaskFilters').split(',').map(function(x) {return parseInt(x, 10); });                                                                                                                        
                                                                                                                                                                                                                                                
        $.each(selectedFilters, function(index, value) { filterStatus(value); });                                                                                                                                                               
    }                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                
    $('#isFilter').remove();                                                                                                                                                                                                                    
    $('#isFilterList').remove();                                                                                                                                                                                                                
                                                                                                                                                                                                                                                
    $('.tabs.horizontal .tab-title:contains("Sub-Tasks:")').parent().append("<li id='isFilter'><a href='#'><strong>Hide<span style='background-image: url(../../../images/menu_indicator_for_light_backgrounds.gif);display:inline-block; height:4px; width:7px; vertical-align:middle; margin-left:5px;'></span></strong></a></li>");                                                                                                                                                          
                                                                                                                                                                                                                                                
    $('#isFilter a').click(function() {                                                                                                                                                                                                         
        var header = $('#isFilter'),                                                                                                                                                                                                            
            offset = header.offset(),                                                                                                                                                                                                           
            filterList = '';                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                
        if ($('#isFilterList').length <= 0) {                                                                                                                                                                                                   
            filterList += '<ul style="list-style-type:none;padding:0;margin:0;">';                                                                                                                                                              
            $.each(statusTypes, function(index, value) {                                                                                                                                                                                        
                var checked = '';                                                                                                                                                                                                               
                                                                                                                                                                                                                                                
                if ($.inArray(index, selectedFilters) !== -1) {                                                                                                                                                                                 
                    checked = 'checked="checked"';                                                                                                                                                                                              
                }                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                
                filterList += '<li style="padding:0;margin:0"><input type="checkbox" id="status_' + index + '" ' + checked + ' /><label style="margin-left:5px" for="status_' + index + '">' + value + '</label></li>';                         
            });                                                                                                                                                                                                                                 
            filterList += '</ul>';                                                                                                                                                                                                              
                                                                                                                                                                                                                                                
            $('body').append('<div id="isFilterList" style="z-index:1000;padding:5px;border:1px solid #bbb;background:#fff;display:none;position:absolute;left:' + offset.left + 'px; top: ' + (offset.top + header.height()) + 'px">' + filterList + '</div>');                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                
            $('#isFilterList li input').click(function(evt) {                                                                                                                                                                                   
                var index = $(this).attr('id').replace('status_', '');                                                                                                                                                                          
                                                                                                                                                                                                                                                
                evt.preventDefault();                                                                                                                                                                                                           
                                                                                                                                                                                                                                                
                if ($(this).is(':checked')) {                                                                                                                                                                                                   
                    filterStatus(index);                                                                                                                                                                                                        
                    if ($.inArray(index, selectedFilters) === -1) {                                                                                                                                                                             
                        selectedFilters.push(index);                                                                                                                                                                                            
                    }                                                                                                                                                                                                                           
                } else {                                                                                                                                                                                                                        
                    unfilterStatus(index);                                                                                                                                                                                                      
                    selectedFilters = $.grep(selectedFilters, function(value) { return value !== index; });                                                                                                                                     
                }                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                
                if (localStorage) {                                                                                                                                                                                                             
                    localStorage.setItem('subtaskFilters', selectedFilters.join(','));                                                                                                                                                          
                }                                                                                                                                                                                                                               
            });                                                                                                                                                                                                                                 
        }                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                
        $('#isFilterList').slideToggle();                                                                                                                                                                                                       
    });                                                                                                                                                                                                                                         
});  