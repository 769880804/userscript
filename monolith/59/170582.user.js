// ==UserScript==
// @name Imported Counter
// @namespace Avalon
// @description Keeps track of certain stats.
// @include http://thelostrunes.com/game.php
// @include	http://www.thelostrunes.com/game.php
// ==/UserScript==

function addGlobalJS(js){
	var head, script;
	head = document.getElementsByTagName('head')[0];
	if (!head) { return; }
	script = document.createElement('script');
	script.type = 'text/javascript';
	script.innerHTML = js;
	head.appendChild(script);
}

document.getElementById("left1").innerHTML += '<table style="margin-bottom: 8px;" align="center" cellpadding="0" cellspacing="0"><tbody><tr><td colspan="2" align="center"><br><b>Battle Statistics</b></td></tr><tr><td><span class="heading1">Levels:</span></td><td align="right" width="80"><span id="add_lvlcount" class="heading2">0</span></td></tr><tr><td><span class="heading1">Ratio:</span></td><td align="right" width="80"><span id="percent_wins" class="heading2">50.00</span><span class="heading2" > %</span></td></tr><tr><td><span class="heading1">Kills:</span></td><td align="right" width="80"><span id="add_killinc" class="heading2">0</span></td></tr><tr><td><span class="heading1">Defeats:</span></td><td align="right" width="80"><span id="add_deathinc" class="heading2">0</span></td></tr><tr><td><span class="heading1">My Gold:</span></td><td align="right"><span id="add_goldinc" class="heading2">0</span></td></tr><tr><td><span class="heading1">My Xp:</span></td><td align="right"><span id="add_expinc" class="heading2">0</span></td></tr><tr><td><span class="heading1">Clan Xp:</span></td><td align="right"><span id="add_expclan" class="heading2">0</span></td></tr><tr><td colspan="2" align="center"><input type="checkbox" id="pause" value="pause"/><span class="heading1">Enable Beast & Boss mode</span></td></tr><tr><td>[<a href="javascript: reset(1);">Reset Kills/Defeats</a>]</td><td align="right">[<a href="javascript: reset(2);">Reset ALL</a>]</td></tr></tbody></table>';

addGlobalJS("function addThouCommas (num) {var array = num.toString().split('');var index = -3;while (array.length + index > 0) {array.splice(index, 0, ',');index -= 4;}return array.join('');}");

addGlobalJS("function handleResponse1(){if((http.readyState == 4 && whichHandle == 1) || (recap.readyState == 4 && whichHandle == 2)){ccheck = 0;if(whichHandle == 1){var response = $.trim(http.responseText);}else{var response = $.trim(recap.responseText);}var update = new Array();if(response.indexOf('|' != -1)){update = response.split('|');var totalUpdates = (update.length / 2);var currentUpdate = 1;var var1 = 0;var var2 = 1;while(currentUpdate <= totalUpdates){if(update[var1] == 'at'){actioninprogress = 1;actiontimer(update[var2]);}else if(update[var1] == 'special'){if(update[var2] == 'aterror'){alert('Please wait until your previous action is complete!');if(document.getElementById('battlebutton')){document.getElementById('battlebutton').disabled = false;}}if(update[var2] == 'banned'){alert('Your account is currently banned. Check your e-mail for further details.');window.location = 'http://www.thelostrunes.com/';}if(update[var2] == 'autoattack'){autoattack = 1;}if(update[var2] == 'disautoattack'){autoattack = 0;}if(update[var2] == 'secchkfail'){alert('You have failed too many security checks and have been logged out.');window.location = 'http://www.thelostrunes.com/index.php?logout';}}else if(update[var1] == 'specialmobid'){autoattackid = update[var2];}else if(update[var1] == 'tradeskills'){actioninprogress = 0;init_tradeskill(update[var2]);}else if(update[var1] == 'securitycheck'){autots = 0;actiontimer(2000);showRecaptcha('recaptcha_div');}else if(update[var1]=='teleported'){landNav(0);}else{document.getElementById(update[var1]).innerHTML = update[var2];if(document.getElementById('pause').checked==0){/*sort counter variables*/var mysearchtxt = 'You defeated the'; var wheretosearch = update[var2];var mysearchtest = wheretosearch.search(mysearchtxt);if (mysearchtest != -1){/*win, add to kill counter*/var mykillinc = document.getElementById('add_killinc').innerHTML;var mykillinc_int = mykillinc.replace(/,/gi,'');mykillinc_int = parseFloat(mykillinc_int);var mydeathinc = document.getElementById('add_deathinc').innerHTML;var mydeathinc_int = mydeathinc.replace(/,/gi, '');mydeathinc_int = parseFloat(mydeathinc_int);var myexpinc = document.getElementById('add_expinc').innerHTML;myexpinc = myexpinc.replace(/,/gi,'');var myexpinc_int = parseFloat(myexpinc);var myexpclan = document.getElementById('add_expclan').innerHTML;myexpclan = myexpclan.replace(/,/gi,'');var myexpclan_int = parseFloat(myexpclan);/*get gold/exp*/var mygoldinc = document.getElementById('add_goldinc').innerHTML;mygoldinc = mygoldinc.replace(/,/gi,'');var mygoldinc_int = parseFloat(mygoldinc);var newBattleText = wheretosearch.replace('<span style=\"color: #FFCC33;\">', '<span id=\"goldObtained\" style=\"color: #FFCC33;\">');newBattleText = newBattleText.replace('<span style=\"color: #FFCC33;\">', '<span id=\"clanGold\" style=\"color: #FFCC33;\">');newBattleText = newBattleText.replace('<span style=\"color: #FFFFFF;\">', '<span id=\"expObtained\" style=\"color: #FFFFFF;\">');newBattleText = newBattleText.replace('<span style=\"color: #FFFFFF;\">', '<span id=\"clanExp\" style=\"color: #FFFFFF;\">');newBattleText = newBattleText.replace(/ gold<\\/span>/gi, '</span>');newBattleText = newBattleText.replace(/ experience<\\/span>/gi, '</span>');newBattleText = newBattleText.replace(/,/gi, '');document.getElementById('contentmain').innerHTML = newBattleText;var addMyGold = document.getElementById('goldObtained').innerHTML;addMyGold = addMyGold.replace(/,/gi,'');var addMyExp = document.getElementById('expObtained').innerHTML;var addClanExp = document.getElementById('clanExp').innerHTML;document.getElementById('contentmain').innerHTML = wheretosearch;document.getElementById('add_killinc').innerHTML = addThouCommas(mykillinc_int + parseFloat(1));var temp_percent_wins = 100 * ((mykillinc_int + 1) / (mykillinc_int + mydeathinc_int + 1));document.getElementById('percent_wins').innerHTML = temp_percent_wins.toFixed(2);/*check for lvl up*/var lvltxtsearch = 'Congratulations, you are now level';lvltxtsearch = wheretosearch.search(lvltxtsearch);if (lvltxtsearch != -1){var lvlcntupdate = document.getElementById('add_lvlcount').innerHTML;lvlcntupdate = lvlcntupdate.replace(/,/gi, '');lvlcntupdate = parseFloat(lvlcntupdate) + 1;lvlcntupdate = addThouCommas(lvlcntupdate);document.getElementById('add_lvlcount').innerHTML = lvlcntupdate;}document.getElementById('add_goldinc').innerHTML = addThouCommas(mygoldinc_int + parseFloat(addMyGold));document.getElementById('add_expinc').innerHTML = addThouCommas(myexpinc_int + parseFloat(addMyExp));document.getElementById('add_expclan').innerHTML = addThouCommas(myexpclan_int + parseFloat(addClanExp));}/*check for battle defeat text*/mysearchtxt2 = 'You were defeated';var mysearchtest2 = wheretosearch.search(mysearchtxt2);if(mysearchtest2 != -1){/*defeat, add to counter*/var mydeathinc = document.getElementById('add_deathinc').innerHTML;var mydeathinc_int = mydeathinc.replace(/,/gi, '');mydeathinc_int = parseFloat(mydeathinc_int);document.getElementById('add_deathinc').innerHTML = mydeathinc_int + 1;var mykillinc = document.getElementById('add_killinc').innerHTML;var mykillinc_int = mykillinc.replace(/,/gi,'');mykillinc_int = parseFloat(mykillinc_int);var temp_percent_wins = 100 * ((mykillinc_int) / (mykillinc_int + mydeathinc_int + 1));document.getElementById('percent_wins').innerHTML = temp_percent_wins.toFixed(2);}}}currentUpdate = currentUpdate + 1;var1 = var1 + 2;var2 = var2 + 2;}if (actioninprogress == 0){document.getElementById('actiontimer').innerHTML = '0.0';}}}}");

addGlobalJS("function reset(n){document.getElementById('percent_wins').innerHTML = 0; document.getElementById('add_killinc').innerHTML = 0; document.getElementById('add_deathinc').innerHTML = 0; if (n==2){document.getElementById('add_lvlcount').innerHTML = 0; document.getElementById('add_goldinc').innerHTML = 0; document.getElementById('add_expinc').innerHTML = 0; document.getElementById('add_expclan').innerHTML = 0;}}");