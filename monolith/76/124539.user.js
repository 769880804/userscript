// ==UserScript==
// @name           Yahoo! Answer - Extended Editor
// @namespace      http://userscripts.org/users/106844
// @description    Adds a Wikipedia-style special characters box to Y!A default editor
// @include        http://*answers.yahoo.com/question/answer*
// ==/UserScript==

(function() {

if (!document.getElementById('yan-answer-answer')) return;

if (typeof(GM_deleteValue)=='undefined') {
	save = function(key,value) { localStorage.setItem(key,value) }
	load = function(key,def) { return localStorage.getItem(key)||def; }
	style = function(css) { document.getElementsByTagName('head')[0].appendChild(create('style&type=text/css',css)); }
}
else {
	save = function(key,value) { GM_setValue(key,value); }
	load = function(key,def) { return GM_getValue(key,def); }
	style = function(css) { GM_addStyle(css); }
}

var last, answer;
if (!(last=load('lastUsed'))) {
	save('lastUsed','Symbols');
	last = 'Symbols';
}

F = function(exp) {
	return document.evaluate(exp,document.body,null,9,null).singleNodeValue;
}

var content = {'Symbols':'~ | &#161; &#191; &#8224; &#8225; &#8596; &#8593; &#8595; &#8226; &#182; # &#189; &#8531; &#8532; &#188; &#190; &#8539; &#8540; &#8541; &#8542; &#8734; &#8216; &#8217; &#8220; &#8221; &#8249; &#8250; &#171; &#187; &#164; &#8371; &#3647; &#8373; &#162; &#8353; &#8354; $ &#8363; &#8367; &#8364; &#8352; &#8355; &#402; &#8372; &#8365; &#8356; &#8499; &#8357; &#8358; &#8470; &#8359; &#8368; &#163; &#6107; &#8360; &#8362; &#2547; &#8366; &#8361; &#165; &#9824; &#9827; &#9829; &#9830; &#178; &#179; &#9837; &#9839; &#9838; &#169; &#174; &#8482;',
			   'Latin':'A a &#193; &#225; &#192; &#224; &#194; &#226; &#196; &#228; &#461; &#462; &#258; &#259; &#256; &#257; &#195; &#227; &#197; &#229; &#260; &#261; &#198; &#230; &#482; &#483; B b C c &#262; &#263; &#266; &#267; &#264; &#265; &#268; &#269; &#199; &#231; D d &#270; &#271; &#272; &#273; &#7692; &#7693; &#208; &#240; E e &#201; &#233; &#200; &#232; &#278; &#279; &#202; &#234; &#203; &#235; &#282; &#283; &#276; &#277; &#274; &#275; &#7868; &#7869; &#280; &#281; &#399; &#601; F f G g &#288; &#289; &#284; &#285; &#286; &#287; &#290; &#291; H h &#292; &#293; &#294; &#295; &#7716; &#7717; I i &#304; &#305; &#205; &#237; &#204; &#236; &#206; &#238; &#207; &#239; &#463; &#464; &#300; &#301; &#298; &#299; &#296; &#297; &#302; &#303; J j &#308; &#309; K k &#310; &#311; L l &#313; &#314; &#319; &#320; &#317; &#318; &#315; &#316; &#321; &#322; &#7734; &#7735; &#7736; &#7737; M m &#7746; &#7747; N n &#323; &#324; &#327; &#328; &#209; &#241; &#325; &#326; &#7750; &#7751; O o &#211; &#243; &#210; &#242; &#212; &#244; &#214; &#246; &#465; &#466; &#334; &#335; &#332; &#333; &#213; &#245; &#490; &#491; &#336; &#337; &#216; &#248; &#338; &#339; P p Q q R r &#340; &#341; &#344; &#345; &#342; &#343; &#7770; &#7771; &#7772; &#7773; S s &#346; &#347; &#348; &#349; &#352; &#353; &#350; &#351; &#7778; &#7779; &#223; T t &#356; &#357; &#354; &#355; &#7788; &#7789; &#222; &#254; U u &#218; &#250; &#217; &#249; &#219; &#251; &#220; &#252; &#467; &#468; &#364; &#365; &#362; &#363; &#360; &#361; &#366; &#367; &#370; &#371; &#368; &#369; &#471; &#472; &#475; &#476; &#473; &#474; &#469; &#470; V v W w &#372; &#373; X x Y y &#221; &#253; &#374; &#375; &#376; &#255; &#7928; &#7929; &#562; &#563; Z z &#377; &#378; &#379; &#380; &#381; &#382; &#223; &#208; &#240; &#222; &#254; &#399; &#601;',
			   'Greek':'&#902; &#940; &#904; &#941; &#905; &#942; &#906; &#943; &#908; &#972; &#910; &#973; &#911; &#974; &#913; &#945; &#914; &#946; &#915; &#947; &#916; &#948; &#917; &#949; &#918; &#950; &#919; &#951; &#920; &#952; &#921; &#953; &#922; &#954; &#923; &#955; &#924; &#956; &#925; &#957; &#926; &#958; &#927; &#959; &#928; &#960; &#929; &#961; &#931; &#963; &#962; &#932; &#964; &#933; &#965; &#934; &#966; &#935; &#967; &#936; &#968; &#937; &#969; &#8124; &#8115; &#8116; &#8122; &#8048; &#8114; &#8118; &#8119; &#7944; &#7936; &#8072; &#8064; &#7945; &#7937; &#8073; &#8065; &#7948; &#7940; &#8076; &#8068; &#7946; &#7938; &#8074; &#8066; &#7950; &#7942; &#8078; &#8070; &#7949; &#7941; &#8077; &#8069; &#7947; &#7939; &#8075; &#8067; &#7951; &#7943; &#8079; &#8071; &#8136; &#8050; &#7960; &#7952; &#7961; &#7953; &#7964; &#7956; &#7962; &#7954; &#7965; &#7957; &#7963; &#7955; &#8140; &#8131; &#8132; &#8138; &#8052; &#8130; &#8134; &#8135; &#7976; &#7968; &#8088; &#8080; &#7977; &#7969; &#8089; &#8081; &#7980; &#7972; &#8092; &#8084; &#7978; &#7970; &#8090; &#8082; &#7982; &#7974; &#8094; &#8086; &#7981; &#7973; &#8093; &#8085; &#7979; &#7971; &#8091; &#8083; &#7983; &#7975; &#8095; &#8087; &#8154; &#8054; &#8150; &#7992; &#7984; &#7993; &#7985; &#7996; &#7988; &#7994; &#7986; &#7998; &#7990; &#7997; &#7989; &#7995; &#7987; &#7999; &#7991; &#8184; &#8056; &#8008; &#8000; &#8009; &#8001; &#8012; &#8004; &#8010; &#8002; &#8013; &#8005; &#8011; &#8003; &#8164; &#8172; &#8165; &#8170; &#8058; &#8166; &#8016; &#8025; &#8017; &#8020; &#8018; &#8022; &#8029; &#8021; &#8027; &#8019; &#8031; &#8023; &#8188; &#8179; &#8180; &#8186; &#8060; &#8178; &#8182; &#8183; &#8040; &#8032; &#8104; &#8096; &#8041; &#8033; &#8105; &#8097; &#8044; &#8036; &#8108; &#8100; &#8042; &#8034; &#8106; &#8098; &#8046; &#8038; &#8110; &#8102; &#8045; &#8037; &#8109; &#8101; &#8043; &#8035; &#8107; &#8099; &#8047; &#8039; &#8111; &#8103;',
			   'Cyrillic':'&#1040; &#1072; &#1041; &#1073; &#1042; &#1074; &#1043; &#1075; &#1168; &#1169; &#1027; &#1107; &#1044; &#1076; &#1026; &#1106; &#1045; &#1077; &#1025; &#1105; &#1028; &#1108; &#1046; &#1078; &#1047; &#1079; &#1029; &#1109; &#1048; &#1080; &#1030; &#1110; &#1031; &#1111; &#1049; &#1081; &#1032; &#1112; &#1050; &#1082; &#1036; &#1116; &#1051; &#1083; &#1033; &#1113; &#1052; &#1084; &#1053; &#1085; &#1034; &#1114; &#1054; &#1086; &#1055; &#1087; &#1056; &#1088; &#1057; &#1089; &#1058; &#1090; &#1035; &#1115; &#1059; &#1091; &#1038; &#1118; &#1060; &#1092; &#1061; &#1093; &#1062; &#1094; &#1063; &#1095; &#1039; &#1119; &#1064; &#1096; &#1065; &#1097; &#1066; &#1098; &#1067; &#1099; &#1068; &#1100; &#1069; &#1101; &#1070; &#1102; &#1071; &#1103; &#1240; &#1241; &#1256; &#1257; &#1170; &#1171; &#1174; &#1175; &#1178; &#1179; &#1180; &#1181; &#1186; &#1187; &#1198; &#1199; &#1200; &#1201; &#1202; &#1203; &#1208; &#1209; &#1210; &#1211; &#1172; &#1173; &#1250; &#1251; &#1262; &#1263; &#1176; &#1177; &#1184; &#1185; &#1188; &#1189; &#1194; &#1195; &#1232; &#1233; &#1234; &#1235; &#1236; &#1237; &#1238; &#1239; &#1264; &#1265; &#1266; &#1267; &#1272; &#1273; &#1216; &#1182; &#1183; &#1190; &#1191; &#1192; &#1193; &#1196; &#1197; &#1204; &#1205; &#1206; &#1207; &#1212; &#1213; &#1214; &#1215; &#1217; &#1218; &#1219; &#1220; &#1223; &#1224; &#1227; &#1228; &#1242; &#1243; &#1244; &#1245; &#1246; &#1247; &#1248; &#1249; &#1252; &#1253; &#1254; &#1255; &#1258; &#1259; &#1268; &#1269;',
			   'Hebrew':'&#1488; &#1489; &#1490; &#1491; &#1492; &#1493; &#1494; &#1495; &#1496; &#1497; &#1498; &#1499; &#1500; &#1501; &#1502; &#1503; &#1504; &#1505; &#1506; &#1507; &#1508; &#1509; &#1510; &#1511; &#1512; &#1513; &#1514; &#1523; &#1524; &#1520; &#1521; &#1522;',
			   'Arabic':'&#1575; &#1576; &#1578; &#1579; &#1580; &#1581; &#1582; &#1583; &#1584; &#1585; &#1586; &#1587; &#1588; &#1589; &#1590; &#1591; &#1592; &#1593; &#1594; &#1601; &#1602; &#1603; &#1604; &#1605; &#1606; &#1607; &#1608; &#1610;',
			   'IPA':'&#648; &#598; &#607; &#609; &#610; &#673; &#660; &#632; &#946; &#952; &#240; &#643; &#658; &#597; &#657; &#642; &#656; &#231; &#669; &#611; &#967; &#641; &#295; &#661; &#668; &#674; &#614; &#625; &#627; &#626; &#331; &#628; &#651; &#633; &#635; &#624; &#665; &#11377; &#640; &#638; &#637; &#620; &#622; &#634; &#621; &#654; &#671; &#653; &#613; &#615; &#700; &#595; &#599; &#644; &#608; &#667; &#664; &#448; &#451; &#450; &#449; &#616; &#649; &#623; &#618; &#655; &#650; &#248; &#600; &#629; &#612; &#601; &#603; &#339; &#604; &#606; &#652; &#596; &#230; &#592; &#630; &#593; &#594; &#688; &#689; &#695; &#690; &#736; &#740; &#704; &#7498; k &#794; &#8319; &#737; &#712; &#716; &#720; &#721; t &#810; d &#810; s &#826; s &#827; &#952; &#828; s &#812; n &#805; &#331; &#778; a &#804; a &#816; &#946; &#798; &#725; r &#797; &#724; o &#734; &#602; &#605; e &#792; e &#793; u &#799; i &#800; &#618; &#776; e &#829; &#596; &#825; &#596; &#796; n &#809; &#601; &#774; &#601; &#815; &#601; &#771; &#567; &#771; &#619; z &#820; &#601; &#779; &#601; &#769; &#601; &#772; &#601; &#768; &#601; &#783; &#601; &#780; &#601; &#770; &#601; &#7620; &#601; &#7621; &#601; &#7623; &#601; &#7622; &#601; &#7624; &#601; &#7625; t &#865; &#643; d &#865; &#658; t &#860; &#620; &#8255; &#741; &#742; &#743; &#744; &#745; &#42779; &#42780; | &#8214; &#8599; &#8600; k &#840; s &#846;',
			   'Math and logic':'&#8722; &#215; &#247; &#8901; &#176; &#8727; &#8728; &#177; &#8723; &#8804; &#8805; &#8800; &#8801; &#8773; &#8796; &#8797; &#8784; &#8771; &#8776; &#8853; &#8855; &#8656; &#8660; &#8658; &#8734; &#8592; &#8596; &#8594; &#8810; &#8811; &#8733; &#8730; &#8740; &#8768; &#9669; &#9659; &#8905; &#8906; &#8904; &#8756; &#8757; &#8614; &#172; &#8743; &#8744; &#8891; &#8704; &#8707; &#8712; &#8713; &#8715; &#8838; &#8840; &#8842; &#8834; &#8836; &#8839; &#8841; &#8843; &#8835; &#8837; &#8746; &#8745; &#8721; &#8719; &#8720; &#8242; &#8747; &#8748; &#8749; &#8750; &#8711; &#8706; &#8710; &#8709; &#8450; &#8461; &#8469; &#8473; &#8474; &#8477; &#8484; &#8501; &#8970; &#8971; &#8968; &#8969; &#8868; &#8869; &#8866; &#8867; &#8871; &#9633; &#8736; &#12296; &#12297;'};
	   
create = function(string,innerHTML) {
	var element = document.createElement(string.match(/^[^.#&$]+/)[0]), matches = string.match(/[.#&$][^.#&$]+/g);
	for (var i in matches)
	{
		var x = matches[i];
		switch (x.charAt(0)) {
			case '.': element.className = x.substr(1); break;
			case '#': element.id = x.substr(1); break;
			case '&':
				var parameters = x.substr(1).match(/[^=]+/g);
				element.setAttribute(parameters[0],parameters[1]);
				break;
			case '$':
				var parameters = x.substr(1).match(/[^=]+/g);
				element.setAttribute('style',(element.getAttribute('style')||' ') + parameters[0] + ':' + parameters[1] + ';');
				break;
		}
	}
	if (innerHTML) element.innerHTML = innerHTML;
	return element;
}

startEditor = function() {
	var label = F('.//label[@for="yan-answer-source"]'), textArea = document.querySelector('textarea#yan-answer-answer');
	var editor = create('div.editor$padding=5px'), selector = create('select'), body = create('span');
	editor.style.bordeColor = '#9b9b97';
	label.parentNode.insertBefore(editor,label);
	for (var x in content) {
		selector.appendChild(create('option&value=' + x,x));
		var container = create('span.symbols$display=none#' + x);
		var tokens = content[x].split(' ');
		for (var i in tokens) container.appendChild(create('a.symbol$cursor=pointer',tokens[i]));
		body.appendChild(container);
	}
	selector.addEventListener('change',function() {
		F('.//span[@id="' + last + '"]').style.display = 'none';
		F('.//span[@id="' + this.value + '"]').style.display = 'inline';
		save('lastUsed',this.value);
		last = this.value;	
	},false);
	editor.appendChild(selector);
	editor.appendChild(create('span',' '));
	editor.appendChild(body);
	body.addEventListener('click',function(e) {
		if (e.target.className.toLowerCase()=='symbol') {
			var value = textArea.value, start = textArea.selectionStart;
			if (start) textArea.value = value.substring(0,start) + e.target.innerHTML + value.substring(textArea.selectionEnd,value.length);
			else textArea.value += e.target.innerHTML;
			textArea.focus();
			if (start) textArea.setSelectionRange(start+1,start+1);
		}
	},false);
	style('.symbol:after { content: " " } .editor { border: 1px solid #9b9b97 !important; }');
	for (var i=0;i<selector.childNodes.length;i++) if (selector.childNodes[i].value==last) selector.selectedIndex = i;
	F('.//span[@id="' + last + '"]').style.display = 'inline';
}

startEditor();
})();