// ==UserScript==
// @name           Ikariam Simple Finance Report
// @version        0.3
// @namespace      GrAndAG
// @description    Ikariam Simple Finance Report
// @require        http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js
// @require        http://www.betawarriors.com/bin/gm/57756user.js
// @include        http://s*.ikariam.*/index.php*
// @exclude        http://support*.ikariam.*/*

// @history        0.3 Added german and italian translations; Changed method of finance page detection
// @history        0.2 Added french and spanish translations
// @history        0.1 Initial release
// ==/UserScript==

//-----------------------------------------------------------------------------
ScriptUpdater.check(79634, '0.3');

//-----------------------------------------------------------------------------
const languages = {
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "arabic":       { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "bosnian":      { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "bulgarian":    { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "chinese":      { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "czech":        { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "danish":       { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "dutch":        { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  "english":      { upkeep: "Upkeep", onmove: "On manoeuvres" },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "finish":       { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  "french":       { upkeep: "Entretien", onmove: "Déplacement" },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  "german":       { upkeep: "Unterhalt" , onmove: "auf Mission" },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "greek":        { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "hebrew":       { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "hungarian":    { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "italian":      { upkeep: "Mantenimento", onmove: "Spostamento" },
  "italian":      { upkeep: "Mantenimento", onmove: "In missione" },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "norwegian":    { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "korean":       { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "latvian":      { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "lithuanian":   { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "pinoy":        { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "polish":       { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "portuguese":   { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "romanian":     { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  "russian":      { upkeep: "Содержание", onmove: "На манёврах" },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "serbian":      { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "slovak":       { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "slovene":      { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  "spanish":      { upkeep: "Mantenimiento", onmove: "En misión" },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "swedish":      { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "turkish":      { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "ukranian":     { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "urdu":         { },
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//  "vietnamese":   { }
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
};

var language = languages[getLanguage()];
if (typeof(language) == 'undefined') {
  language = languages.english;
}

var separator = unsafeWindow.LocalizationStrings['thousandSeperator'];

//-----------------------------------------------------------------------------
function getLanguage() {
  var lang = 'english';
  $("script").each( function() {
    var langMatch = /LocalizationStrings\['language'\]\s+=\s+'([a-zA-Z]+)';/g.exec( this.innerHTML );
    if ( langMatch ) {
      lang = {
      ar:  "spanish",    by:  "russian",  br:  "portugese",  bg:  "bulgarian",
      cl:  "spanish",    cn:  "chinese",  co:  "spanish",    cz:  "czech",
      dk:  "danish",     en:  "english",  fi:  "finish",     fr:  "french",
      de:  "german",     gr:  "greek",    it:  "italian",    hk:  "chinese",
      hu:  "hungarian",  il:  "hebrew",   kr:  "korean",     lv:  "latvian",
      lt:  "lithuanian", mx:  "spanish",  nl:  "dutch",      no:  "norwegian",
      pk:  "urdu",       pe:  "spanish",  ph:  "pinoy",      pt:  "portuguese",
      pl:  "polish",     ro:  "romanian", ru:  "russian",    rs:  "serbian",
      sk:  "slovak",     si:  "slovene",  es:  "spanish",    se:  "swedish",
      tw:  "chinese",    tr:  "turkish",  ua:  "ukranian",   ae:  "arabic",
      us:  "english",    ve:  "spanish",  vn:  "vietnamese", ba:  "bosnian"
      }[langMatch[1]] || 'english';
    }
    delete langMatch;
  });
  return lang;
}

//-----------------------------------------------------------------------------
function toInt(string) {  // Parses a string of format 123,456 to an int in format 123456
  return parseInt(string.replace(RegExp('\\'+separator,'g'),""));
}

//-----------------------------------------------------------------------------
function formatNum(num) {  // Parses an int of format 123456 to an string in format 123,456 
	var string = String(num);
	var temp = "";
	var lentxt = string.length - ((String(Math.abs(num))).length) ; // different length between String and number 
	
	for (j=string.length ; j > lentxt; j = j-3) {
		if (j-3 <= lentxt ) {
      temp = string.substring(0 , j) + temp;
    } else {
      temp = separator + string.substr(j-3, 3) + temp;
    }
	}
	return temp;
}

//-----------------------------------------------------------------------------
function neg(num) {
  return (num=='0')?num:('-'+num);
}
//-----------------------------------------------------------------------------
function main() {
  var titles = new Array(), 
      upkeep = new Array(), 
      onmove = new Array(),
      result = new Array();
  var sigma = "";
  var value;
      
  $("#mainview table[id=upkeepReductionTable]").each( function() {
    if (titles.length == 0) {
      $("tr:odd", this).find("td.reason").each( function() {
        titles.push($(this).html());
      });
      sigma = titles.pop();
    }
    if (upkeep.length == 0) {
      $("tr.altbottomLine, tr.result", this).find("td.hidden").each( function() {
        upkeep.push($(this).text());
      });
    } else if (onmove.length == 0) {
      $("tr.altbottomLine, tr.result", this).find("td.hidden").each( function() {
        onmove.push($(this).text());
      });
    } else if (result.length == 0) {
      $("tr.result", this).find("td.hidden").each( function() {
        result.push($(this).text());
      });
      //titles.push($("th:first", this).text());
      titles.push("&nbsp;");
    }
  }).remove();
  
  var html = "";
  html += '<table id="balance" class="table01" border="0px" cellpadding="0" cellspacing="0">\n';
  html += '<tbody>\n<tr><th>&nbsp;</th><th>'+language.upkeep+'</th><th>'+language.onmove+'</th><th>&nbsp;</th></tr>\n';
  for (i = 0; i < titles.length; i++) {
    html += '<tr'+((i%2)?' class="alt"':'')+'>';
    html += '<td class="city">'+titles[i]+'</td>\n';
    html += '<td class="value res">'+neg(upkeep[i])+'</td>\n';
    html += '<td class="value res">'+neg(onmove[i])+'</td>\n';
    html += '<td class="hidden">'+neg(formatNum(toInt(upkeep[i])+toInt(onmove[i])))+'</td>\n</tr>\n';
  }
  html += '<tr class="result"><td class="sigma">'+sigma+'</td><td class="value res">&nbsp;</td><td class="value res">&nbsp;</td><td class="hidden"><b>'+result[result.length-1]+'</b></td></tr>\n';
  html += '</tbody></table>\n';

  $("#mainview table[id=balance]:last").after(html);
}


//-----------------------------------------------------------------------------
$("body#finances").each( function() {
  main();
});
//-----------------------------------------------------------------------------

