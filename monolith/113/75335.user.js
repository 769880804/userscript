// ==UserScript==
// @name           fuwatto
// @namespace      fuwatto
// @description    fuwatto
// @include        http://hermes-ir.lib.hit-u.ac.jp/*
// @include        http://eprints.lib.hokudai.ac.jp/*
// @include        http://eprints.math.sci.hokudai.ac.jp/*
// @include        http://s-ir.sap.hokkyodai.ac.jp/*
// @include        http://ir.lib.muroran-it.ac.jp/*
// @include        http://barrel.ih.otaru-uc.ac.jp/*
// @include        http://ir.obihiro.ac.jp/*
// @include        http://kitir.lib.kitami-it.ac.jp/*
// @include        http://amcor.asahikawa-med.ac.jp/*
// @include        http://repository.ul.hirosaki-u.ac.jp/*
// @include        http://ir.iwate-u.ac.jp/*
// @include        http://ir.library.tohoku.ac.jp/*
// @include        http://air.lib.akita-u.ac.jp/*
// @include        http://repo.lib.yamagata-u.ac.jp/*
// @include        http://ir.lib.fukushima-u.ac.jp/*
// @include        http://ir.lib.ibaraki.ac.jp/*
// @include        https://www.tulips.tsukuba.ac.jp/*
// @include        http://www.tsukuba-tech.ac.jp/*
// @include        http://uuair.lib.utsunomiya-u.ac.jp/*
// @include        https://gair.media.gunma-u.ac.jp/*
// @include        http://sucra.saitama-u.ac.jp/*
// @include        http://mitizane.ll.chiba-u.jp/*
// @include        http://repository.dl.itc.u-tokyo.ac.jp/*
// @include        http://repository.tufs.ac.jp/*
// @include        https://ir.u-gakugei.ac.jp/*
// @include        http://t2r2.star.titech.ac.jp/*
// @include        http://teapot.lib.ocha.ac.jp/*
// @include        http://hermes-ir.lib.hit-u.ac.jp/*
// @include        http://oacis.lib.kaiyodai.ac.jp/*
// @include        http://kamome.lib.ynu.ac.jp/*
// @include        http://repository.lib.niigata-u.ac.jp/*
// @include        http://repository.lib.juen.ac.jp/*
// @include        http://utomir.lib.u-toyama.ac.jp/*
// @include        http://dspace.lib.kanazawa-u.ac.jp/*
// @include        https://dspace.jaist.ac.jp/*
// @include        http://repo.flib.fukui-u.ac.jp/*
// @include        http://www.lib.yamanashi.ac.jp/*
// @include        http://soar-ir.shinshu-u.ac.jp/*
// @include        http://repository.lib.gifu-u.ac.jp/*
// @include        http://ir.lib.shizuoka.ac.jp/*
// @include        http://hikumano.hama-med.ac.jp/dspace
// @include        http://ir.nul.nagoya-u.ac.jp/*
// @include        http://akf.nul.nagoya-u.ac.jp/*
// @include        http://repository.aichi-edu.ac.jp/*
// @include        http://repo.lib.nitech.ac.jp/*
// @include        http://miuse.mie-u.ac.jp/*
// @include        http://libdspace.biwako.shiga-u.ac.jp/*
// @include        http://repository.shiga-med.ac.jp/*
// @include        http://repository.kulib.kyoto-u.ac.jp/*
// @include        http://ir.kyokyo-u.ac.jp/*
// @include        http://repository.lib.kit.ac.jp/*
// @include        http://ir.library.osaka-u.ac.jp/*
// @include        http://ir.lib.osaka-kyoiku.ac.jp/*
// @include        http://www.lib.kobe-u.ac.jp/*
// @include        http://repository.hyogo-u.ac.jp/*
// @include        http://near.nara-edu.ac.jp/*
// @include        http://nwudir.lib.nara-wu.ac.jp/*
// @include        http://library.naist.jp/*
// @include        http://repository.lib.tottori-u.ac.jp/*
// @include        http://www.lib.shimane-u.ac.jp/*
// @include        http://escholarship.lib.okayama-u.ac.jp/*
// @include        http://eprints.lib.okayama-u.ac.jp/*
// @include        http://ir.lib.hiroshima-u.ac.jp/*
// @include        http://petit.lib.yamaguchi-u.ac.jp/*
// @include        http://www.lib.kagawa-u.ac.jp/repo_index.html
// @include        https://ir.kochi-u.ac.jp/*
// @include        http://libir.fukuoka-edu.ac.jp/*
// @include        https://qir.kyushu-u.ac.jp/*
// @include        http://ds.lib.kyutech.ac.jp/*
// @include        http://portal.dl.saga-u.ac.jp/*
// @include        http://naosite.lb.nagasaki-u.ac.jp/*
// @include        http://reposit.lib.kumamoto-u.ac.jp/*
// @include        http://ir.lib.oita-u.ac.jp/*
// @include        http://ir.lib.miyazaki-u.ac.jp/*
// @include        http://ir.kagoshima-u.ac.jp/*
// @include        http://repo.lib.nifs-k.ac.jp/*
// @include        http://ir.lib.u-ryukyu.ac.jp/*
// @include        http://ir.cc.sapmed.ac.jp/dspace
// @include        http://dlisv03.media.osaka-cu.ac.jp/G0000007repository
// @include        http://repository.osakafu-u.ac.jp/*
// @include        http://ginmu.naramed-u.ac.jp/*
// @include        http://kutarr.lib.kochi-tech.ac.jp/*
// @include        http://libir.josai.ac.jp/*
// @include        http://serve.seigakuin-univ.ac.jp/*
// @include        http://www.agulin.aoyama.ac.jp/*
// @include        http://koara.lib.keio.ac.jp/*
// @include        http://131.113.30.71:8080/dspace/*
// @include        http://libw01.kokushikan.ac.jp/*
// @include        http://arch.slcn.ac.jp/*
// @include        http://ir.tdc.ac.jp/*
// @include        http://ir.jikei.ac.jp/*
// @include        http://ir.twmu.ac.jp/*
// @include        http://gbs3.rds.toyo.ac.jp/*
// @include        http://dspace.bunka.ac.jp/dspace
// @include        http://rose.lib.hosei.ac.jp/*
// @include        http://m-repo.lib.meiji.ac.jp/*
// @include        http://dspace.wul.waseda.ac.jp/*
// @include        http://klibredb.lib.kanagawa-u.ac.jp/*
// @include        http://opac.kanto-gakuin.ac.jp/*
// @include        http://www.kait-r.com:8080/dspace/*
// @include        http://elib.doshisha.ac.jp/*
// @include        http://kuir.jm.kansai-u.ac.jp/*
// @include        http://kurepo.clib.kindai.ac.jp/*
// @include        http://kgur.kwansei.ac.jp/*
// @include        http://libir.mukogawa-u.ac.jp/*
// @include        http://repo.nara-u.ac.jp/*
// @include        http://cur-ren.cjc.ac.jp/*
// @include        http://repository.ipu-japan.ac.jp/*
// @include        http://repo.beppu-u.ac.jp/*
// @include        http://bud.beppu-u.ac.jp/*
// @include        http://r-cube.ritsumei.ac.jp/*
// @include        http://ir.okiu.ac.jp/*
// @include        http://repository.tsuyama-ct.ac.jp/*
// @include        http://nifs-repository.nifs.ac.jp/*
// @include        http://ir.minpaku.ac.jp/*
// @include        https://ir.ide.go.jp/*
// @include        http://dspace.itri.aist.go.jp/*
// @include        http://repository.nabunken.go.jp/*
// @include        http://harp.lib.hiroshima-u.ac.jp/*
// @include        http://crf.flib.u-fukui.ac.jp/*
// @include        http://ypir.lib.yamaguchi-u.ac.jp/*
// @include        http://nirr.lib.niigata-u.ac.jp/*
// @include        http://okinawa-repo.lib.u-ryukyu.ac.jp/*
// @include        http://ir.soken.ac.jp/*
// ==/UserScript==
/* original--- $Id: widget.js,v 1.15 2010/03/14 14:27:07 masao Exp $ 
 * Fuwatto Search Widget
 * written by Masao Takaku
 */


 
//jqueryのおまじない
(function(d, func) {
    var check = function() {
        if (typeof unsafeWindow.jQuery == 'undefined') return false;
        func(unsafeWindow.jQuery); return true;
        }
    if (check()) return;
    var s = d.createElement('script');
    s.type = 'text/javascript';
    s.src = 'http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js';
    d.getElementsByTagName('head')[0].appendChild(s);
    (function() {
        if (check()) return;
        setTimeout(arguments.callee, 100);
        })();
    })(document, function($) {
    // ここにメインの処理を書く
if ($('a[href$=".pdf"]').attr("href")) {

var BASEURL = 'http://fuwat.to/';
//var BASEURL = 'http://localhost/~masao/private/cvswork/fuwatto/cinii.rb';


function fuwatto_widget( opt )
	{
	var url = opt.url || absolutePath($('a[href$=".pdf"]').attr("href"));
	//var url = $("a").attr("href");
	// alert(absolutePath(url));
	var database = opt.database || 'cinii';
	// var database = opt.database || 'opac-hit-u';
	var width = opt.width || 'auto';
	var height = opt.height || 'auto';
	var count = opt.count || 5;
	var title = opt.title || "関連文献";
	var d = document;
	var s = d.createElement('div');
	s.id = "fuwatto_result";
	d.body.appendChild(s);
	$('#fuwatto_result').before('<h3>' + title + '</h3>');
	$('#fuwatto_result').after('<h4><a href="' + BASEURL + database + '">powered by ふわっと' + database + '関連検索</a></h3>');
	$('<div style="width:'+width+';height:'+height+';border:solid 1px gray;padding:4px;overflow:auto;" id="fuwatto_result">').appendTo('#fuwatto_result');

	var requestUrl = BASEURL + database + '?callback=?&format=json&url=' + url + '&count=' + count;
	GM_xmlhttpRequest({
		method: 'GET',
		url: requestUrl,
		onload: function(x) {
			// alert(x.responseText);
			var r = eval('(' + x.responseText + ')');
			var list = '<ol>';
			for(var i = 0, l = r.entries.length; i < l; i++) {//var url in r.entries) {
				var link = r.entries[i].url;
				var text = r.entries[i].title;
				list += '<li><a href="' + link+ '">' + text + '...</a></li>';
			}
		list += '</ol>';
		$("#fuwatto_result").empty();
		$("#fuwatto_result").append( list );
			}
	});
	}
	
fuwatto_widget({});
}
    });

function absolutePath(path){
  var e = document.createElement('span');
  e.innerHTML = '<a href="' + path + '" />';
  return e.firstChild.href;
}

