// ==UserScript== 
// @name          decryptPhpBB 
// @version       0.1
// @namespace     http://www.noname.net
// @description   Permite leer el contenido de mensajes cifrados.
// @run-at 	  document-end
// @include       http://www.elotrolado.net/* 
// @exclude              

// ==/UserScript== 

var Aes={};Aes.Cipher=function(e,a){var d=4;var h=a.length/d-1;var g=[[],[],[],[]];for(var f=0;f<4*d;f++){g[f%4][Math.floor(f/4)]=e[f]}g=Aes.AddRoundKey(g,a,0,d);for(var c=1;c<h;c++){g=Aes.SubBytes(g,d);g=Aes.ShiftRows(g,d);g=Aes.MixColumns(g,d);g=Aes.AddRoundKey(g,a,c,d)}g=Aes.SubBytes(g,d);g=Aes.ShiftRows(g,d);g=Aes.AddRoundKey(g,a,h,d);var b=new Array(4*d);for(var f=0;f<4*d;f++){b[f]=g[f%4][Math.floor(f/4)]}return b};Aes.KeyExpansion=function(f){var d=4;var b=f.length/4;var g=b+6;var e=new Array(d*(g+1));var h=new Array(4);for(var c=0;c<b;c++){var a=[f[4*c],f[4*c+1],f[4*c+2],f[4*c+3]];e[c]=a}for(var c=b;c<(d*(g+1));c++){e[c]=new Array(4);for(var k=0;k<4;k++){h[k]=e[c-1][k]}if(c%b==0){h=Aes.SubWord(Aes.RotWord(h));for(var k=0;k<4;k++){h[k]^=Aes.Rcon[c/b][k]}}else{if(b>6&&c%b==4){h=Aes.SubWord(h)}}for(var k=0;k<4;k++){e[c][k]=e[c-b][k]^h[k]}}return e};Aes.SubBytes=function(b,a){for(var d=0;d<4;d++){for(var e=0;e<a;e++){b[d][e]=Aes.Sbox[b[d][e]]}}return b};Aes.ShiftRows=function(d,a){var b=new Array(4);for(var e=1;e<4;e++){for(var f=0;f<4;f++){b[f]=d[e][(f+e)%a]}for(var f=0;f<4;f++){d[e][f]=b[f]}}return d};Aes.MixColumns=function(h,f){for(var k=0;k<4;k++){var e=new Array(4);var d=new Array(4);for(var g=0;g<4;g++){e[g]=h[g][k];d[g]=h[g][k]&128?h[g][k]<<1^283:h[g][k]<<1}h[0][k]=d[0]^e[1]^d[1]^e[2]^e[3];h[1][k]=e[0]^d[1]^e[2]^d[2]^e[3];h[2][k]=e[0]^e[1]^d[2]^e[3]^d[3];h[3][k]=e[0]^d[0]^e[1]^e[2]^d[3]}return h};Aes.getWater=function(){return location.href.substring(0,25)};Aes.AddRoundKey=function(f,a,d,b){for(var e=0;e<4;e++){for(var g=0;g<b;g++){f[e][g]^=a[d*4+g][e]}}return f};Aes.getKeyWater=function(){return(Aes.getWater())};Aes.SubWord=function(a){for(var b=0;b<4;b++){a[b]=Aes.Sbox[a[b]]}return a};Aes.getSetKey=function(f){var d=document.getElementById(f);var e=getElementsByClass("postprofile",d)[0].childNodes.item(1).childNodes.item(1).innerHTML;var a="",c,b=0;for(c=e.length-1;c>=0;c--){a=a+e.charAt(c)}return(a.concat(a))};Aes.RotWord=function(a){var c=a[0];for(var b=0;b<3;b++){a[b]=a[b+1]}a[3]=c;return a};Aes.Sbox=[99,124,119,123,242,107,111,197,48,1,103,43,254,215,171,118,202,130,201,125,250,89,71,240,173,212,162,175,156,164,114,192,183,253,147,38,54,63,247,204,52,165,229,241,113,216,49,21,4,199,35,195,24,150,5,154,7,18,128,226,235,39,178,117,9,131,44,26,27,110,90,160,82,59,214,179,41,227,47,132,83,209,0,237,32,252,177,91,106,203,190,57,74,76,88,207,208,239,170,251,67,77,51,133,69,249,2,127,80,60,159,168,81,163,64,143,146,157,56,245,188,182,218,33,16,255,243,210,205,12,19,236,95,151,68,23,196,167,126,61,100,93,25,115,96,129,79,220,34,42,144,136,70,238,184,20,222,94,11,219,224,50,58,10,73,6,36,92,194,211,172,98,145,149,228,121,231,200,55,109,141,213,78,169,108,86,244,234,101,122,174,8,186,120,37,46,28,166,180,198,232,221,116,31,75,189,139,138,112,62,181,102,72,3,246,14,97,53,87,185,134,193,29,158,225,248,152,17,105,217,142,148,155,30,135,233,206,85,40,223,140,161,137,13,191,230,66,104,65,153,45,15,176,84,187,22];Aes.Rcon=[[0,0,0,0],[1,0,0,0],[2,0,0,0],[4,0,0,0],[8,0,0,0],[16,0,0,0],[32,0,0,0],[64,0,0,0],[128,0,0,0],[27,0,0,0],[54,0,0,0]];var AesCtr={};AesCtr.decrypt=function(u,e,q){var n=16;if(!(q==128||q==192||q==256)){return""}u=Base64.decode(u);e=Utf8.encode(e);var o=q/8;var k=new Array(o);for(var p=0;p<o;p++){k[p]=isNaN(e.charCodeAt(p))?0:e.charCodeAt(p)}var v=Aes.Cipher(k,Aes.KeyExpansion(k));v=v.concat(v.slice(0,o-16));var f=new Array(8);ctrTxt=u.slice(0,8);for(var p=0;p<8;p++){f[p]=ctrTxt.charCodeAt(p)}var s=Aes.KeyExpansion(v);var g=Math.ceil((u.length-8)/n);var h=new Array(g);for(var t=0;t<g;t++){h[t]=u.slice(8+t*n,8+t*n+n)}u=h;var a=new Array(u.length);for(var t=0;t<g;t++){for(var r=0;r<4;r++){f[15-r]=((t)>>>r*8)&255}for(var r=0;r<4;r++){f[15-r-4]=(((t+1)/4294967296-1)>>>r*8)&255}var m=Aes.Cipher(f,s);var d=new Array(u[t].length);for(var p=0;p<u[t].length;p++){d[p]=m[p]^u[t].charCodeAt(p);d[p]=String.fromCharCode(d[p])}a[t]=d.join("")}var l=a.join("");l=Utf8.decode(l);return l};var Base64={};Base64.code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";Base64.encode=function(p,r){r=(typeof r=="undefined")?false:r;var g,b,a,t,q,m,l,h,k=[],f="",o,s,n;var d=Base64.code;s=r?p.encodeUTF8():p;o=s.length%3;if(o>0){while(o++<3){f+="=";s+="\0"}}for(o=0;o<s.length;o+=3){g=s.charCodeAt(o);b=s.charCodeAt(o+1);a=s.charCodeAt(o+2);t=g<<16|b<<8|a;q=t>>18&63;m=t>>12&63;l=t>>6&63;h=t&63;k[o/3]=d.charAt(q)+d.charAt(m)+d.charAt(l)+d.charAt(h)}n=k.join("");n=n.slice(0,n.length-f.length)+f;return n};Base64.decode=function(p,e){e=(typeof e=="undefined")?false:e;var g,b,a,q,m,k,h,s,l=[],r,o;var f=Base64.code;o=e?p.decodeUTF8():p;for(var n=0;n<o.length;n+=4){q=f.indexOf(o.charAt(n));m=f.indexOf(o.charAt(n+1));k=f.indexOf(o.charAt(n+2));h=f.indexOf(o.charAt(n+3));s=q<<18|m<<12|k<<6|h;g=s>>>16&255;b=s>>>8&255;a=s&255;l[n/4]=String.fromCharCode(g,b,a);if(h==64){l[n/4]=String.fromCharCode(g,b)}if(k==64){l[n/4]=String.fromCharCode(g)}}r=l.join("");return e?r.decodeUTF8():r};var Utf8={};Utf8.encode=function(a){var b=a.replace(/[\u0080-\u07ff]/g,function(e){var d=e.charCodeAt(0);return String.fromCharCode(192|d>>6,128|d&63)});b=b.replace(/[\u0800-\uffff]/g,function(e){var d=e.charCodeAt(0);return String.fromCharCode(224|d>>12,128|d>>6&63,128|d&63)});return b};Utf8.decode=function(b){var a=b.replace(/[\u00c0-\u00df][\u0080-\u00bf]/g,function(e){var d=(e.charCodeAt(0)&31)<<6|e.charCodeAt(1)&63;return String.fromCharCode(d)});a=a.replace(/[\u00e0-\u00ef][\u0080-\u00bf][\u0080-\u00bf]/g,function(e){var d=((e.charCodeAt(0)&15)<<12)|((e.charCodeAt(1)&63)<<6)|(e.charCodeAt(2)&63);return String.fromCharCode(d)});return a};var listaCargada=false;var idAreaTexto="message";function getElementsByClass(g,e,a){var d=new Array();if(e==null){e=document}if(a==null){a="*"}var c=e.getElementsByTagName(a);var b=c.length;var f=new RegExp("(^|\\s)"+g+"(\\s|$)");for(i=0,j=0;i<b;i++){if(f.test(c[i].className)){d[j]=c[i];j++}}return d}function desencryptEOLit(e){var b=document.getElementById(e);var d=getElementsByClass("content",b);var c=prompt("Password: ");if(c){var a=d[0].textContent.split("[");if(c!=AesCtr.decrypt(a[1],c,256)){alert("Lo siento, sigue intentándolo")}else{d[0].innerHTML=Utf8.decode(reversehtmlentities(AesCtr.decrypt(a[0],c,256)))}}}function marcaDeAgua(d){var b=document.getElementById(d);var c=getElementsByClass("content",b);var a=c[0].textContent.split("[");if(a[2]){if(AesCtr.decrypt(a[2],Aes.getKeyWater(),256)==Aes.getWater()){c[0].innerHTML=a[0]+"["+a[1];return true}else{return false}}else{return false}}function ponerCandado(f){var d=document.getElementById(f);var b=getElementsByClass("profile-icons",d,"ul");var c=document.createElement("a");c.setAttribute("href","javascript:void(0)");c.addEventListener("click",function(){desencryptEOLit(f);return false},false);var e=new Image();e.setAttribute("id","imagenCandado");e.setAttribute("src","http://i43.tinypic.com/9krscy.jpg");e.setAttribute("onmouseover",'this.src="http://i44.tinypic.com/i36yyr.jpg"');e.setAttribute("onmouseout",'this.src="http://i43.tinypic.com/9krscy.jpg"');e.setAttribute("title","jum...");c.appendChild(e);var a=document.createElement("li");a.appendChild(c);if(f.indexOf("post")!=-1){b[0].appendChild(a)}else{b[1].appendChild(a)}}function ponerBotonDesencriptar(){var b=getElementsByClass("post columfixed bg1");b=b.concat(getElementsByClass("post columfixed bg2"));b=b.concat(getElementsByClass("post pm"));var a;for(a=0;a<b.length;a++){if(marcaDeAgua(b[a].getAttribute("id"))){ponerCandado(b[a].getAttribute("id"))}}}function parejas(b,a){this.character=b;this.code=a}var pares=new Array();pares[0]=new parejas("ñ","&ntilde;");pares[1]=new parejas("á","&aacute;");pares[2]=new parejas("é","&eacute;");pares[3]=new parejas("í","&iacute;");pares[4]=new parejas("ó","&oacute;");pares[5]=new parejas("ú","&uacute;");pares[6]=new parejas("\\n"," <br> ");function htmlentities(a){for(var b=0,c=pares.length;b<c;b++){a=a.replace(new RegExp(pares[b].character,"g"),pares[b].code)}return a}function reversehtmlentities(a){for(var b=0,c=pares.length;b<c;b++){if(b<6){a=a.replace(new RegExp(pares[b].code,"g"),pares[b].character)}}return replaceText(a)}function replaceText(g){var p=/\[list\=([a-z]|\d|[A-Z])\]/g;g=g.replace(p,"[list]");g=g.replace(new RegExp("(\\[spoiler\\])","g"),'<span class="spoiler" title="Clic para mostrar u ocultar el spoiler, ten en cuenta que podría desvelarte un argumento o trama."><input type="button" value="Mostrar spoiler" onclick="return toggleSpoiler(this.parentNode)"><blockquote class="spoilertext">');g=g.replace(new RegExp("(\\[\\/spoiler\\])","g"),"</blockquote></span>");var o=/\[size=(.*?)\](.*?)\[\/size\]/gi;g=g.replace(o,'<span style="font-size: $1%; line-height: 116%;">$2</span>');var f=/[^(\[img\]|[url(?:\=?)(.*?)\]|([flash=(\d+)\,(\d+)\]))](\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;var e=/[^(\[img\]|[url(?:\=?)(.*?)\]|([flash=(\d+)\,(\d+)\]))](^|[^\/])(www\.[\S]+(\b|$))/gim;g=g.replace(f,'<a class="postlink" href="$1" target="_blank">$1</a>');g=g.replace(e,'<a class="postlink" href="http://$2" target="_blank">$2</a>');var s=/\[img\](.*?)\[\/img\]/gi;g=g.replace(s,'<a href="$1" target="_blank"><img src="$1" /></a>');var a=/\[flash=(\d+)\,(\d+)\](.*?)\[\/flash\]/gi;g=g.replace(a,'<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="$1" height="$2"><param name="movie" value="$3" /><param name="wmode" value="transparent" /><param name="allowFullScreen" value="true" /><param name="allowscriptaccess" value="always" /><!--[if !IE]>--><object type="application/x-shockwave-flash" data="$3" width="$1" height="$2"><param name="wmode" value="transparent" /><param name="allowFullScreen" value="true" /><!--<![endif]--><p>Parece que tu navegador no soporta Flash, o no tienes el plugin instalado. Puedes instalarlo desde <a href="http://www.adobe.com/go/getflashplayer_es">la página de Adobe</a>.</p><!--[if !IE]>--></object><!--<![endif]--></object>');g=g.replace(new RegExp("(\\[i\\])","g"),'<span style="font-style:italic">');g=g.replace(new RegExp("(\\[\\/i\\])","g"),"</span>");g=g.replace(new RegExp("(\\[b\\])","g"),'<span style="font-weight:bold">');g=g.replace(new RegExp("(\\[\\/b\\])","g"),"</span>");g=g.replace(new RegExp("(\\[list\\])","g"),"<ul>");g=g.replace(new RegExp("(\\[\\/list\\])","g"),"</ul>");g=g.replace(new RegExp("(\\[u\\])","g"),'<span style="text-decoration:underline">');g=g.replace(new RegExp("(\\[\\/u\\])","g"),"</span>");g=g.replace(new RegExp("(\\[code\\])","g"),'<dl class="codebox"><dt>Código: <a href="#" onclick="selectCode(this); return false;">Seleccionar todo</a></dt><dd><code>');g=g.replace(new RegExp("(\\[\\/code\\])","g"),"</code></dd></dl>");var m=/\[quote="(.*?)"\]/gi;var l=/\[\/quote\]/gi;g=g.replace(m,"<blockquote><div><cite>$1 escribió:</cite>");g=g.replace(l,"</div></blockquote>");var d=/\[\*\]/g;var c=/\[\/\*\]/g;g=g.replace(d,"<li>");g=g.replace(c,"</li>");var b=/<\/li>.<br>/g;g=g.replace(b,"</li>");var n=/<\/blockquote>.<br>/g;g=g.replace(n,"</blockquote>");var r=/\[color=#(.*?)\]/gi;var q=/\[\/color\]/gi;g=g.replace(r,'<span style="color: #$1">');g=g.replace(q,"</span>");var k=/\[url](https?:\/\/|ftp:\/\/)?(.*?)\[\/url\]/gi;var h=/\[url=(https?:\/\/|ftp:\/\/)?(.*?)\](.*?)\[\/url\]/gi;g=g.replace(k,'<a class="postlink" href="http://$2" target="_blank">$2</a>');g=g.replace(h,'<a class="postlink" href="http://$2" target="_blank">$3</a>');return g}ponerBotonDesencriptar();
