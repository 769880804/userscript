// ==UserScript==
// @name                CFF
// @version             2.2
// @description         Sortiere und filtere deine Ãœberweisungsmappe
// @include             http://*.de.kapihospital.com/main.php*
// @exclude             http://forum.de.kapihospital.com/*
// ==/UserScript==

var isMSIE = /*@cc_on!@*/0;
tinysort={inc_out_schalter:"referral_send",referral_send_pats:0,referral_reci_pats:0,referral_send_sorted:"",referral_send_sorted_dir:0,referral_reci_sorted:"",referral_reci_sorted_dir:0,referral_send_current_filter_index:-1,referral_reci_current_filter_index:-1,referral_send_current_kh_filter:"",referral_reci_current_kh_filter:"",raum_abk:"Beh. R\u00f6n. Ult. Ort. Psy. Ekg. Ope. Lab. Dun. Gum. Tom. Tro. Nuk. Zah.".split(" "),rraeume:"br rr ur or pt ekg op lab dk gum tom tro nuk zm".split(" "),
raumliste:{br:["e2bd9b",4,3,6,5,12,11,10],rr:["a3a6de",1,2,18,58,73],ur:["b48dc4",26,44,30,113,94,99,52,75],or:["e0e19a",48,66,49,80,103,110,55,60],pt:["74b077",8,9,34,88,96,27,33,108,50],ekg:["bce3b3",71,67,79,37,83,100,41,46],op:["d9d9d9",19,39,77,107,40,101,53,65],lab:["ffffff",61,21,86,22,98,38,105,43,74],dk:["666468",36,45,78,84,56,90,111,20,32,76],gum:["556c7c",35,31,82,93,95,57,24,64],tom:["dcc6a1",29,16,91,13,97,106,63,72],tro:["707b58",51,15,87,7,104,14,114,47,17],nuk:["a296a3",69,54,23,
81,112,92,42,109,59],zm:["a5dbdf",68,28,85,102,89,62,70]},switch_view:function(){var a;switch(tinysort.inc_out_schalter){case "referral_send":jQuery("#referral_send").hide();jQuery("#referral_reci").show();jQuery("#schalter").text("ankommende Patienten").css("background","#7fc1c1");tinysort.inc_out_schalter="referral_reci";a=tinysort[tinysort.inc_out_schalter+"_current_filter_index"];tinysort.show_filterrow(a);tinysort.set_patient_number(tinysort.referral_reci_pats);break;case "referral_reci":jQuery("#referral_reci").hide(),
jQuery("#referral_send").show(),jQuery("#schalter").text("\u00fcberwiesene Patienten").css("background","#df9355"),tinysort.inc_out_schalter="referral_send",a=tinysort[tinysort.inc_out_schalter+"_current_filter_index"],tinysort.show_filterrow(a),tinysort.set_patient_number(tinysort.referral_send_pats)}},set_patient_number:function(a){var b=document.getElementById(tinysort.inc_out_schalter).children.length;!a&&2<b&&(a=b-5);b=jQuery("#schalter").text().split("/");b=b[0].replace(/^\s*/,"").replace(/\s*$/,
"");jQuery("#schalter").text(b+" / "+a)},init_tinysort:function(){var a;if("undefined"!=typeof jQuery&&(a=document.getElementById("referrals"))&&!a.ts_2976)a.ts_2976=!0,tinysort.init_mappe()},init_mappe:function(){var a,b,c,d;if(2<jQuery("#referral_send div").length)jQuery("#referral_send > div").slice(1,5).css({cursor:"hand",cursor:"pointer"}).on("click",function(){isMSIE?tinysort.init_sort(this.innerText.replace(/^\s*/,"").replace(/\s*$/,""),-1):tinysort.init_sort(this.textContent.replace(/^\s*/,
"").replace(/\s*$/,""),-1)});if(2<jQuery("#referral_reci div").length)jQuery("#referral_reci > div").slice(1,5).css({cursor:"hand",cursor:"pointer"}).on("click",function(){isMSIE?tinysort.init_sort(this.innerText.replace(/^\s*/,"").replace(/\s*$/,""),-1):tinysort.init_sort(this.textContent.replace(/^\s*/,"").replace(/\s*$/,""),-1)});tinysort.init_filter();a=tinysort.inc_out_schalter;if(b=tinysort.referral_send_sorted||!1)tinysort.inc_out_schalter="referral_send",tinysort.referral_send_sorted="",c=
tinysort.referral_send_sorted_dir||0,tinysort.referral_send_sorted_dir="",c&&tinysort.init_sort(b,c);if(b=tinysort.referral_reci_sorted||!1)tinysort.inc_out_schalter="referral_reci",tinysort.referral_reci_sorted="",c=tinysort.referral_reci_sorted_dir||0,tinysort.referral_reci_sorted_dir="",c&&tinysort.init_sort(b,c);b=tinysort.referral_send_current_filter_index;0<=b&&(tinysort.inc_out_schalter="referral_send",(d=tinysort.referral_send_current_kh_filter||!1)?tinysort.filter_list(d):tinysort.filter_room(b),
"referral_send"==a&&tinysort.show_filterrow(b));b=tinysort.referral_reci_current_filter_index;0<=b&&(tinysort.inc_out_schalter="referral_reci",(d=tinysort.referral_reci_current_kh_filter||!1)?tinysort.filter_list(d):tinysort.filter_room(b),"referral_reci"==a&&tinysort.show_filterrow(b));tinysort.inc_out_schalter=a;"referral_send"==tinysort.inc_out_schalter?jQuery("#schalter").text("\u00fcberwiesene Patienten").css("background","#df9355"):jQuery("#schalter").text("ankommende Patienten").css("background",
"#7fc1c1");tinysort.set_patient_number(tinysort[tinysort.inc_out_schalter+"_pats"])},init_filter:function(){var a,b,c,d,e,f;jQuery("#referral_reci_head").remove();jQuery("#referral_send_head").remove();jQuery("#referrals > br").remove();"referral_send"==tinysort.inc_out_schalter?jQuery("#referral_reci").hide():jQuery("#referral_send").hide();a=jQuery("<div>");a.css({position:"absolute",width:"535px","background-color":"#df9355",height:"15px",border:"1px solid black","text-align":"center","line-height":"15px",
cursor:"hand",cursor:"pointer",left:"30px",bottom:"50px"});a.attr("id","schalter");a.text("\u00fcberwiesene Patienten");jQuery("#referrals").after(a);jQuery("#schalter").on("click",function(){tinysort.switch_view()});a=jQuery("<div>");a.attr("id","filtertable");a.css({width:"535",height:"20px",position:"absolute",overflow:"hidden",background:"#444444",top:"50px",left:"30px","z-index":"9"});b=jQuery("<table>").css({width:"100%","text-align":"center",height:"15px",margin:"0",border:"1px solid black"});
c=jQuery("<tr>").css({cursor:"hand",cursor:"pointer"});e=0;for(f=tinysort.raum_abk.length;e<f;e+=1)d=jQuery("<td>").text(tinysort.raum_abk[e]).css({width:"35","background-color":"#"+tinysort.raumliste[tinysort.rraeume[e]][0]}),isMSIE&&d.css("font-size","xx-small"),c.append(d);a.append(b.append(c));jQuery("#schalter").after(a);jQuery("#filtertable td").each(function(){jQuery(this).on("click",function(){tinysort.show_filterrow(this.cellIndex);tinysort.filter_room(this.cellIndex)})});a=jQuery("<td>").text("X").css({width:"35",
"background-color":"#ff0000"}).on("click",tinysort.remove_filter);isMSIE&&a.css("font-size","xx-small");jQuery("#filtertable tr").append(a);a=jQuery("<div>");a.attr("id","kh_filter");a.css({width:"535",height:"17px",position:"absolute",top:"72px",left:"30px","z-index":"8","text-align":"center"});e=0;for(f=tinysort.rraeume.length;e<f;e++){ll=tinysort.raumliste[tinysort.rraeume[e]].length;b=jQuery("<table>");b.css({display:"none",margin:"1px auto"});c=jQuery("<tr>");for(j=1;j<ll;j++)d=jQuery("<td>").on("click",
tinysort.filter_list),d.attr("id","f_"+tinysort.raumliste[tinysort.rraeume[e]][j]),d.attr("class","d_a_15 d_"+tinysort.raumliste[tinysort.rraeume[e]][j]+"_15"),d.css({"margin-left":"2px",padding:"0px",width:"15px",height:"15px",cursor:"hand",cursor:"pointer"}),c.append(d);b.append(c);a.append(b)}jQuery("#filtertable").after(a)},remove_filter:function(){var a,b,c;a=document.getElementById(tinysort.inc_out_schalter).children;b=5;for(c=a.length;b<c;b++)a[b].style.display="";a=tinysort[tinysort.inc_out_schalter+
"_current_filter_index"];jQuery("#kh_filter table").slice(a,a+1).hide();tinysort[tinysort.inc_out_schalter+"_current_filter_index"]=-1;tinysort[tinysort.inc_out_schalter+"_current_kh_filter"]="";tinysort[tinysort.inc_out_schalter+"_pats"]=0;tinysort.set_patient_number(0)},filter_list:function(a){var b,c,d,e,f;b=document.getElementById(tinysort.inc_out_schalter).children;this.id?(tinysort[tinysort.inc_out_schalter+"_current_kh_filter"]=this.id,c="d_"+this.id.replace("f_","")+"_15"):a&&(c="d_"+a.replace("f_",
"")+"_15");f=0;a=5;for(d=b.length;a<d;a++)e=b[a].innerHTML.toString(),e=e.split(c).length,2==e?(f+=1,b[a].style.display=""):b[a].style.display="none";tinysort[tinysort.inc_out_schalter+"_pats"]=f;tinysort.set_patient_number(f)},filter_room:function(a){var b,c,d,e,f,g,i,h;b=document.getElementById(tinysort.inc_out_schalter).children;h=0;c=5;for(e=b.length;c<e;c++){g=b[c].innerHTML.toString();f=tinysort.raumliste[tinysort.rraeume[a]].length;i=!1;for(d=0;d<f;d++)if(-1!=g.search("d_"+tinysort.raumliste[tinysort.rraeume[a]][d]+
"_15")){b[c].style.display="";i=!0;h+=1;break}i||(b[c].style.display="none")}tinysort[tinysort.inc_out_schalter+"_pats"]=h;tinysort[tinysort.inc_out_schalter+"_current_filter_index"]=a;tinysort[tinysort.inc_out_schalter+"_current_kh_filter"]="";tinysort.set_patient_number(h)},show_filterrow:function(a){a=parseInt(a,10);if(this.cellIndex)tinysort[tinysort.inc_out_schalter+"_current_filter_index"]=this.cellIndex;else if(0<=a)tinysort[tinysort.inc_out_schalter+"_current_filter_index"]=a;else{jQuery("#kh_filter").animate({top:"-=22"},
200,function(){jQuery("#kh_filter table").each(function(){jQuery(this).hide()})});jQuery("#kh_filter").animate({top:"+=22"},200);return}jQuery("#kh_filter").animate({top:"-=22"},200,function(){jQuery("#kh_filter table").each(function(){jQuery(this).hide()});a=tinysort[tinysort.inc_out_schalter+"_current_filter_index"];jQuery("#kh_filter table").slice(a,a+1).show()});jQuery("#kh_filter").animate({top:"+=22"},200)},sort_out:function(a,b){var c,d,e;c=document.getElementById(tinysort.inc_out_schalter);
a.sort(function(a,c){return a[1]>c[1]?1*b:a[1]<c[1]?-1*b:0});d=0;for(e=a.length;d<e;d++)c.appendChild(a[d][0])},reverse_sort:function(){var a,b;a=document.getElementById(tinysort.inc_out_schalter);for(b=a.children.length-2;4<b;b--)a.appendChild(a.children[b]);1==tinysort[tinysort.inc_out_schalter+"_sorted_dir"]?tinysort[tinysort.inc_out_schalter+"_sorted_dir"]=-1:tinysort[tinysort.inc_out_schalter+"_sorted_dir"]=1},init_sort:function(a,b){var c,d,e,f,g=[];f=document.getElementById(tinysort.inc_out_schalter).children;
if(tinysort[tinysort.inc_out_schalter+"_sorted"]==a)tinysort.reverse_sort();else{switch(a){case "Patientenname":c=5;for(d=f.length;c<d;c++)g[c-5]=isMSIE?[f[c],f[c].children[0].innerText]:[f[c],f[c].children[0].textContent];break;case "Krankheiten":c=5;for(d=f.length;c<d;c++)e=f[c].innerHTML.toString().split("d_a_15"),g[c-5]=[f[c],e.length-1];break;case "Empf\u00e4nger":case "Absender":c=5;for(d=f.length;c<d;c++)g[c-5]=isMSIE?[f[c],f[c].children[2].innerText.toLowerCase()]:[f[c],f[c].children[2].textContent.toLowerCase()];
break;case "Kosten":c=5;for(d=f.length;c<d;c++)g[c-5]=isMSIE?[f[c],parseFloat(f[c].children[3].innerText.replace(" hT","").replace(".","").replace(",","."))]:[f[c],parseFloat(f[c].children[3].textContent.replace(" hT","").replace(".","").replace(",","."))];break;default:return}tinysort.sort_out(g,b);tinysort[tinysort.inc_out_schalter+"_sorted_dir"]=b;tinysort[tinysort.inc_out_schalter+"_sorted"]=a}}};
function typeOf(a){var b=typeof a;"object"===b&&(a?a instanceof Array&&(b="array"):b="null");return b}
function injectify(a,b,c){var d="";switch(typeOf(a)){case "number":d=c?d+(b+" = "+a.toString()+";\n"):d+("var "+b+" = "+a.toString()+";\n");break;case "string":d=c?d+(b+' = "'+a.toString()+'";\n'):d+("var "+b+' = "'+a.toString()+'";\n');break;case "boolean":d=c?d+(b+" = "+a.toString()+";\n"):d+("var "+b+" = "+a.toString()+";\n");break;case "function":c?d+=b+" = "+a.toString()+";\n":(c=a.toString(),c=c.match(/(?![function]).+(?=\()/),c=c[0].replace(/\s+/g,""),d=""==c?d+("var "+b+" = "+a.toString()+
";\n"):d+(a.toString()+";\n"));break;case "array":var d=c?d+(b+" = [];\n"):d+("var "+b+" = [];\n"),e;for(e in a)a.hasOwnProperty(e)&&(d+=injectify(a[e],b+"["+e+"]",!0));break;case "object":for(e in d=c?d+(b+" = {};\n"):d+("var "+b+" = {};\n"),a)a.hasOwnProperty(e)&&(d+=injectify(a[e],b+"."+e,!0))}return d}function inject(a,b){var c,d,e="";c=0;for(d=a.length;c<d;c+=1)e+=injectify(a[c],b[c],!1);return e}
function injectScriptStart(a){function b(a){var b=document.createElement("script");b.id="CFFScriptStart";b.type="text/javascript";isMSIE?b.innerText+="("+a.toString()+")();\n":b.textContent+="("+a.toString()+")();\n";document.body.appendChild(b)}var c=document.querySelector("#KHAddedJQuery");(c=document.querySelector("#CFFJQuery")||c)?b(a):setTimeout(function(){injectScriptStart(a)},400)}function injectStartReady(){initSampleScriptFunction=window.setInterval("tinysort.init_tinysort();",100)}
function injectScript(){var a=inject([tinysort],["tinysort"]),b=document.createElement("script");b.id="ContractFolderFilter";b.type="text/javascript";isMSIE?(b.innerText+=a+"\n",b.innerText+="var isMSIE = /*@cc_on!@*/0;\n"):(b.textContent+=a+"\n",b.textContent+="var isMSIE = /*@cc_on!@*/0;\n");document.body.appendChild(b)}function initSampleScript(){window.setInterval("tinysort.init_tinysort();",100);window.clearInterval(initSampleScript)}
function addJQuery(a){var b=document.createElement("script");b.id="CFFJQuery";b.type="text/javascript";b.src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js";isMSIE?b.addEventListener("load",function(){var b=document.createElement("script");b.id="CFFScriptStart";b.type="text/javascript";b.innerText="("+a.toString()+")();";document.body.appendChild(b)},!1):b.addEventListener("load",function(){var b=document.createElement("script");b.id="CFFScriptStart";b.type="text/javascript";b.textContent=
"("+a.toString()+")();";document.body.appendChild(b)},!1);document.body.appendChild(b)}function readyJQuery(){jQuery.noConflict()}addJQuery(readyJQuery);injectScript();injectScriptStart(injectStartReady);