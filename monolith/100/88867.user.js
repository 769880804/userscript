// ==UserScript==
// @name           photozoom facebook
// @namespace      photozoom facebook
// @include        http://www.facebook.com/*
// ==/UserScript==

var RG3=RG3||{};RG3.util=RG3.util||{newElement:function(c,a,d){d=d||window.document;var b=d.createElement(c);if(a){this.setProperties(b,a)}return b},setProperties:function(c,b){for(var a in b){this.setProperty(c,a,b[a])}},setProperty:function(b,a,c){if((a=="style"||a=="styles")&&typeof(c)=="object"){return RG3.util.setStyles(b,c)}else{if(a=="html"){a="innerHTML"}else{if(a=="text"){a="textContent"}}}return b[(a=="class"?"className":a)]=c},camelCase:function(a){return a.replace(/-\D/g,function(b){return b.charAt(1).toUpperCase()})},setStyles:function(b,c){for(var a in c){this.setStyle(b,a,c[a])}return b},setStyle:function(a,c,b){if(c=="opacity"){if(a.style.opacity!==undefined){a.style.opacity=b}else{if(a.style.MozOpacity!==undefined){a.style.MozOpacity=b}else{if(a.style.msFilter!==undefined){a.style.msFilter="progid:DXImageTransform.Microsoft.Alpha(Opacity="+(b*100)+")"}else{if(a.style.filter!==undefined){a.style.filter="alpha(opacity="+(b*100)+")"}}}}}else{if(c=="box-shadow"){this.setStyle(a,"-moz-box-shadow",b);this.setStyle(a,"-webkit-box-shadow",b);a.style[this.camelCase(c)]=b;return a}else{if(c=="float"){c="cssFloat"}a.style[this.camelCase(c)]=b}}return a},getEvent:function(a){return !a?a=window.event:a},preventEventDefault:function(a){a=this.getEvent(a);if(a){if(a.preventDefault){a.preventDefault()}else{a.returnValue=false;a.cancelBubble=true}}},getEventTarget:function(a){if(a.target){targ=a.target}else{if(a.srcElement){targ=a.srcElement}}if(targ.nodeType==3){targ=targ.parentNode}return targ},addEvent:function(b,c,a){if(b.addEventListener){b.addEventListener(c,a,false)}else{if(window.attachEvent){b.attachEvent("on"+c,a)}else{b["on"+c]=a}}},removeEvent:function(b,c,a){if(b.removeEventListener){b.removeEventListener(c,a,false)}else{if(window.detachEvent){b.detachEvent("on"+c,a)}else{b["on"+c]=a}}},splat:function(a){return(typeof(a))?((!a.push&&!a.callee)?[a]:a):[]},extendArray:function(d,c){for(var b=0,a=c.length;b<a;b++){d.push(c[b])}return d},bind:function(c,b,a){return this.createFn(b,{bind:c,"arguments":a})},createFn:function(c,b){var a=c;b=b||{};return function(e){var d=b.arguments,f;d=(d!=undefined)?RG3.util.splat(d):arguments;if(b.event){d=RG3.util.extendArray(d,[e||window.event])}f=function(){return a.apply(b.bind||null,d)};return f()}},setOptions:function(b,a){a=a||{};for(var c in b){b[c]=(typeof(a[c])!=="undefined")?a[c]:b[c]}return b}};RG3.phototip=function(a){return this.init(a)};RG3.phototip.prototype={options:{padding:5,offset:10,gutter:5},setOptions:function(a){RG3.util.setOptions(this.options,a)},update:function(a){RG3.util.setOptions(this.options,a)},init:function(a){this.setOptions(a);this.tooltip=document.body.appendChild(RG3.util.newElement("div",{"class":"rg3fbpz-tooltip",styles:{display:"none",padding:this.options.padding+"px"}}));this.tooltipImg=this.tooltip.appendChild(RG3.util.newElement("img",{"class":"rg3fbpz-image",styles:{position:"relative","z-index":2}}));this.tooltipTitle=this.tooltip.appendChild(RG3.util.newElement("div",{"class":"rg3fbpz-title"}));this.open=false;this.coords=null;this.binds={onImgLoad:RG3.util.bind(this,this.onImgLoad),onImgReady:RG3.util.bind(this,this.onImgReady)}},onImgLoad:function(){RG3.util.removeEvent(this.tooltipImg,"load",this.binds.onImgLoad)},onImgReady:function(){if(this.tooltipImg.naturalWidth&&this.tooltipImg.naturalWidth>0){this.setPosition();if(this.tooltipTitle.textContent&&this.tooltipTitle.textContent.length>0){RG3.util.setStyles(this.tooltipTitle,{opacity:1})}}else{if(this.tooltipImg.src&&this.tooltipImg.src.length>0){setTimeout(this.binds.onImgReady,50)}}},setPosition:function(){var e=this.coords,h,g="auto",c={x:window.scrollX,y:window.scrollY},f=false,b,d,a;if(this.open&&e){g=(e.x+c.x+this.options.offset);a={x:document.body.clientWidth,y:document.body.clientHieight};d={x:this.tooltipImg.naturalWidth,y:this.tooltipImg.naturalHeight};b=((e.x+this.options.offset)+(d.x+(this.options.padding*2)))<a.x-this.options.gutter;if(!b){f=e.x-this.options.offset-(d.x+(this.options.padding*2))>this.options.gutter}if(b||f){RG3.util.setStyles(this.tooltipImg,{width:"auto",height:"auto"})}if(!b&&f){g=(e.x+c.x)-this.options.offset-(d.x+(this.options.padding*2))}else{if(!b&&!f){if(e.x<=(a.x/2)){RG3.util.setStyles(this.tooltipImg,{width:(a.x-(e.x+this.options.offset+(this.options.padding*2)+this.options.gutter))+"px",height:"auto"})}else{g=c.x+this.options.gutter;RG3.util.setStyles(this.tooltipImg,{width:(e.x-this.options.offset-(this.options.padding*2)-this.options.gutter)+"px",height:"auto"})}}}h=(e.y+c.y-(this.tooltip.offsetHeight/2));if(h>window.innerHeight+window.scrollY-this.tooltip.offsetHeight-this.options.gutter){h=window.innerHeight+window.scrollY-this.tooltip.offsetHeight-this.options.gutter}if(h<window.scrollY+this.options.gutter){h=window.scrollY+this.options.gutter;if(this.tooltip.offsetHeight>window.innerHeight-(this.options.gutter*2)){RG3.util.setStyles(this.tooltipImg,{height:(window.innerHeight-(this.options.padding*2)-(this.options.gutter*2))+"px",width:"auto"});b=((e.x+this.options.offset)+this.tooltip.offsetWidth)<a.x-this.options.gutter;if(b){g=(e.x+c.x)+this.options.offset}else{g=(e.x+c.x)-this.tooltip.offsetWidth-this.options.offset}}}RG3.util.setStyles(this.tooltip,{top:parseInt(h)+"px",left:parseInt(g)+"px"})}},set:function(b,a){RG3.util.setProperty(this.tooltipTitle,"text",a||"");RG3.util.setStyles(this.tooltipTitle,{opacity:0});RG3.util.addEvent(this.tooltipImg,"load",this.binds.onImgLoad);this.tooltipImg.src=b;this.binds.onImgReady()},show:function(a){this.coords=a;this.binds.onImgReady();RG3.util.setStyles(this.tooltip,{display:"block"});this.open=true},move:function(a){this.coords=a;this.setPosition()},hide:function(){this.tooltip.style.display="none";this.open=false;RG3.util.setStyles(this.tooltipTitle,{opacity:0});if(this.tooltipImg.src){this.tooltipImg.removeAttribute("src");RG3.util.setStyles(this.tooltipImg,{width:"auto",height:"auto"})}}};RG3.fbPhotoZoom=function(a){return this.init(a)};RG3.fbPhotoZoom.prototype={init:function(a){this["name"]="Facebook Photo Zoom";this.tooltip=new RG3.phototip();this.enabled=a;this.currentImg=null;this.icon=null;this.icons={on:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8%2F9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAXFJREFUeNpi%2FP%2F%2FPwMymDJlyv9Xr14xEAPExMQYWI6cf4ostgOkuaioiEFAQACv5g8fPjD09fUxsGCTBGnObNiE14DpDX5gmgnZdmwKmZgYGcK9dBnKU20Z%2BHjYMeUJ%2BdNAQ5LBwUyRQUFakMFcXxanATtwGcDDzQZn83Kxke6CD59%2BwNnvPn7HasAOfAZcuf2S4c%2Fff2D2hRvPMeRZbl8%2BZPT%2B%2FXusmrk52RjcbVQYWJghDg1w1mJYt%2Fsqw6cvPxEGgDRHhIcz8PDwggV6ulrANCjggly1GFhZmeGKzfVlGIx1pBh2HLqNMAAcUEDNPfOPMHBxsMITCSjqsAGQa3wc1cFq4AbAgJOFEsOpn2LgFEZ0UkYW%2BP7jN4OJbcDrbYduMZQk2jDMmTuHwczO%2FxwuA2wMpT3gBihICTAoyggCUx4Tg6q8MCHLPVDC4MuXzwwh7jpwWX8nTbAYPo1wAwQFBRlWrFyJ1RqQHC6NMAAQYADaHmfCJgAfvAAAAABJRU5ErkJggg%3D%3D",off:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8%2F9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAZdJREFUeNpi%2Bf%2F%2FPwMymDJlyv9Xr14xEAPExMQYWI6cf4ostgOkuaioiEFAQACv5g8fPjD09fUxsGCTBGnObNiE14DpDX5gmgnZdmwKmZgYGcK9dBnKU20Z%2BHjYMeUJ%2BdNAQ5LBwUyRQUFakMFcXxanATtwGcDDzQZn83Kxke6CD59%2BwNnvPn7HasAOfAZcuf2S4c%2Fff2D2hRvPMeRZbl8%2BZPT%2B%2FXusmrk52RjcbVQYWJghDg1w1mJYt%2Fsqw6cvPxGKeidMffX0%2BZtXHz%2F%2FBOPa2tr%2FILBi66X%2Fv379%2BY8Mjjg5%2Fd%2FAwADHixUU%2FoPTAQ8PL0PP%2FCMMXBys8EQCijp08GbfPgZ%2FYMrdyMgIp1ESkpOFEsOpn2LgFIYNGAMxsmZwGCAr%2BP7jN4OJbcDrbYduMZQk2jDMmTuHwczO%2FxxM%2Fm1zsztOFyhICTAoyggCUx4Tg6q8MFYXsOgavQFqEmGAugQUg2ADvnz5zBDirgNX6O%2BkCRZDB38unxPFMFRQUJBhxcqVWG0EyYGAjaG0B5iBlvVBACDAAHFtphFIakqbAAAAAElFTkSuQmCC"};this.ctrlDown=false;this.shiftDown=false;this.mouseDown=false;RG3.util.addEvent(document.body,"drag",RG3.util.bind(this,this.onMouseDrag));RG3.util.addEvent(document.body,"dragstart",RG3.util.bind(this,this.onMouseDown));RG3.util.addEvent(document.body,"dragend",RG3.util.bind(this,this.onMouseUp));RG3.util.addEvent(document.body,"mousedown",RG3.util.bind(this,this.onMouseDown));RG3.util.addEvent(document.body,"mouseup",RG3.util.bind(this,this.onMouseUp));RG3.util.addEvent(document.body,"mousemove",RG3.util.bind(this,this.onMouseMove));RG3.util.addEvent(document.body,"mousewheel",RG3.util.bind(this,this.onMouseMove));RG3.util.addEvent(document.body,"keydown",RG3.util.bind(this,this.onKeyDown));RG3.util.addEvent(document.body,"keyup",RG3.util.bind(this,this.onKeyUp));this.binds={createAppIcon:RG3.util.bind(this,this.createAppIcon)};this.appIconAttempts=0;this.binds.createAppIcon()},toggle:function(){this.enabled=!this.enabled;proxy.setEnabled(this.enabled);if(!this.enabled){this.tooltip.hide()}this.updateAppIcon()},getNewSrc:function(a){var b=null;if(/_[aqst]\.(jpe?g)$/.test(a)){b=a.replace(/_[aqst]\.(jpe?g)$/i,"_n.$1")}else{if(/[aqst][\d_]+\.(jpe?g)$/.test(a)){b=a.replace(/[aqst]([\d_]+)\.(jpe?g)$/i,"n$1.$2")}else{if(/^.*?safe_image\.php\?.*?url\=(.*)$/i.test(a)){b=decodeURIComponent(a.replace(/^.*?safe_image\.php\?.*?url\=(.*)$/i,"$1"))}}}return b},onMouseMove:function(f){if(!this.mouseDown&&!this.mouseDownCoords){var h=null,a,b,c,g,d=RG3.util.getEventTarget(RG3.util.getEvent(f));if(d.localName.toLowerCase()=="img"&&d.src){a=d.src;g=d._title||(d.title&&d.title.length>0?d.title:(d.alt&&d.alt.length>0?d.alt:""))}else{if(d.localName.toLowerCase()=="i"&&d.style.backgroundImage){a=d.style.backgroundImage.replace(/^\s*url\(([^\)]+)\).*$/i,"$1");g=d._title||(d.parentNode&&d.parentNode.parentNode&&d.parentNode.parentNode.title&&d.parentNode.parentNode.title.length>0?d.parentNode.parentNode.title:"")}else{if(d.localName.toLowerCase()=="a"&&d.className.indexOf("album_link")>-1&&d.parentNode.className.indexOf("album_thumb")>-1&&d.parentNode.style.backgroundImage){a=d.parentNode.style.backgroundImage.replace(/^\s*url\(([^\)]+)\).*$/i,"$1");g=""}}}if(this.enabled&&a&&!/\/vthumb/i.test(a)&&(h=this.getNewSrc(a))){if(!this.currentImg||this.currentImg.oSrc!==a){this.tooltip.hide();this.currentImg={src:h,oSrc:a};b=d.parentNode;if(!g&&b&&(b.getAttribute("class")||"").indexOf("uiTooltip")>-1){c=b.querySelector('*[class^="uiTooltip"]');c.style.display="none";c.setAttribute("class","");g=c.firstChild&&c.firstChild.innerText?c.firstChild.innerText:""}d._title=g;RG3.util.setProperties(d,{title:"",alt:""});RG3.util.setProperties(b,{title:"",alt:""});RG3.util.setProperties(b.parentNode,{title:"",alt:""});this.tooltip.set(this.currentImg.src,d._title)}if(!this.tooltip.open&&this.currentImg.src){RG3.util.setProperties(d,{title:"",alt:""});RG3.util.setProperties(d.parentNode,{title:"",alt:""});RG3.util.setProperties(d.parentNode.parentNode,{title:"",alt:""});this.tooltip.show({x:f.clientX,y:f.clientY},d)}this.tooltip.move({x:f.clientX,y:f.clientY})}else{this.hideTooltip()}}else{if(this.tooltip.open&&Math.abs(f.x-this.mouseDownCoords.x)>5||Math.abs(f.y-this.mouseDownCoords.y)>5){this.hideTooltip()}}},hideTooltip:function(){this.tooltip.hide();this.currentImg=null},onKeyDown:function(a){if(a.keyCode=="17"){this.ctrlDown=true}if(a.keyCode=="16"){this.shiftDown=true}if(a.keyCode=="90"&&this.ctrlDown&&this.shiftDown){this.toggle()}},onKeyUp:function(a){if(a.keyCode=="17"){this.ctrlDown=false}if(a.keyCode=="16"){this.shiftDown=false}},onMouseDrag:function(a){this.hideTooltip()},onMouseDown:function(a){this.mouseDown=true;this.mouseDownCoords={x:a.x,y:a.y}},onMouseUp:function(a){this.mouseDown=false;this.mouseDownCoords=null},createAppIcon:function(){var a,b,c=document.querySelecto(".fbDockWrapper.fbDockWrapperBottom.fbDockWrapperRight");this.appIconAttempts=this.appIconAttempts+1;if(!this.icon&&c){a=RG3.util.newElement("div",{"class":"rg3fbpz-icon"});this.icon={};this.icon.image=RG3.util.newElement("i",{styles:{"background-image":"url("+this.icons[(this.enabled?"on":"off")]+")"}});this.icon.tooltip=RG3.util.newElement("strong",{text:this["name"]});b=RG3.util.newElement("div",{"class":"rg3fbpz-titletip"});b.appendChild(this.icon.tooltip);a.appendChild(this.icon.image);a.appendChild(b);c.appendChild(a);RG3.util.addEvent(a,"click",RG3.util.bind(this,this.toggle));this.updateAppIcon()}else{if(!this.icon&&this.appIconAttempts<100){setTimeout(this.binds.createAppIcon,500)}}},updateAppIcon:function(){if(this.icon){RG3.util.setStyles(this.icon.image,{"background-image":"url("+this.icons[(this.enabled?"on":"off")]+")"});RG3.util.setProperty(this.icon.tooltip,"text",this["name"]+(this.enabled?" (on)":" (off)"))}}};var photozoom,proxy={initialize:function(a){if(!photozoom){photozoom=new RG3.fbPhotoZoom(a)}}};if(typeof(chrome)!="undefined"&&chrome.extension){proxy.setEnabled=function(a){chrome.extension.sendRequest({name:"setEnabled",value:a})};proxy.setCurrentImage=function(a){chrome.extension.sendRequest({name:"setCurrentImage",value:a})};chrome.extension.sendRequest({name:"isEnabled"},function(a){proxy.initialize(a.value)})}else{if(typeof(safari)!="undefined"){proxy.setEnabled=function(a){safari.self.tab.dispatchMessage("request",{name:"setEnabled",value:a})};proxy.setCurrentImage=function(a){safari.self.tab.dispatchMessage("request",{name:"setCurrentImage",value:a})};function messageHandler(b){var a=b.message;if(a.method&&proxy[a.method]){proxy[a.method](a.value)}else{if(a.name=="getCurrentImage"){safari.self.tab.dispatchMessage("request",{name:"sendCurrentImage",value:photozoom?photozoom.getCurrentImage():null})}}}safari.self.addEventListener("message",messageHandler,false);safari.self.tab.dispatchMessage("request",{name:"isEnabled",method:"initialize"})}};