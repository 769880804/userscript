// ==UserScript==
// @name           t163repost
// @namespace      http://t.163.com/rok
// @description    repost to t.163.com 
// @version        1.33
// @author         forumz
// @include        http://comment.*.163.com/*
// @include        http://t.163.com/article/user/checkLogin.do*
// @require        http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js
// ==/UserScript==

var t163rp_version="1.33";var t_rdate="2011-04-20";GM_addStyle((<><![CDATA[.t_rpbtn{padding:2px 5px 2px 5px;cursor:pointer;background:#0079B2;color:#E6F1F9;margin:0 0 0 20px;-moz-border-radius:5px;font-size:0.8em;}.t_rpbtndo{float:right;margin:0 20px 0 20px;font-weight:bold;}.t_closebtn{height:16px;font-size:14px;font-weight:bold;cursor:pointer;display:inline-block;padding:2px 8px 2px 8px;background:#0079B2;color:#E6F1F9;-moz-border-radius:5px;-moz-box-shadow:1px 2px 5px#333;}.t_rp_frame{width:750px;height:450px;border:0;}.t_rp_div{padding:10px 10px 10px 10px;background:#f0f0f0;border:1px solid#fff;-moz-box-shadow:2px 5px 15px#333;-moz-border-radius:10px;width:750px;height:450px;}#t163m_rthint{font-family:Arial,sans-serif,宋体!important;font-size:16px!important;font-weight:bold;padding:5px 10px 5px 10px;position:fixed;top:20px;-moz-border-radius:5px;display:inline-block;opacity:0.7;z-index:99999}.t_rthint_n{color:#fff!important;background:#000!important;}.t_rthint_f{background:#880000!important;color:#ffffdd!important;}]]></>).toString());var loadpic='data:image/gif,GIF89a%10%00%10%00%F2%00%00%FF%FF%FF%00%00%00%C2%C2%C2BBB%00%00%00bbb%82%82%82%92%92%92!%FE%1ACreated%20with%20ajaxload.info%00!%F9%04%00%0A%00%00%00!%FF%0BNETSCAPE2.0%03%01%00%00%00%2C%00%00%00%00%10%00%10%00%00%033%08%BA%DC%FE0%CAIk%13c%08%3A%08%19%9C%07N%98f%09E%B11%C2%BA%14%99%C1%B6.%60%C4%C2q%D0-%5B%189%DD%A6%079%18%0C%07Jk%E7H%00%00!%F9%04%00%0A%00%01%00%2C%00%00%00%00%10%00%10%00%00%034%08%BA%DC%FEN%8C!%20%1B%84%0C%BB%B0%E6%8ADqBQT%601%19%20%60LE%5B%1A%A8%7C%1C%B5u%DF%EDa%18%07%80%20%D7%18%E2%86C%19%B2%25%24*%12%00!%F9%04%00%0A%00%02%00%2C%00%00%00%00%10%00%10%00%00%036%08%BA2%23%2B%CAA%C8%90%CC%94V%2F%06%85c%1C%0E%F4%19N%F1IBa%98%ABp%1C%F0%0A%CC%B3%BD%1C%C6%A8%2B%02Y%ED%17%FC%01%83%C3%0F2%A9d%1A%9F%BF%04%00!%F9%04%00%0A%00%03%00%2C%00%00%00%00%10%00%10%00%00%033%08%BAb%25%2B%CA2%86%91%EC%9CV_%85%8B%A6%09%85!%0C%041D%87a%1C%11%AAF%82%B0%D1%1F%03bR%5D%F3%3D%1F08%2C%1A%8F%C8%A4r9L%00%00!%F9%04%00%0A%00%04%00%2C%00%00%00%00%10%00%10%00%00%032%08%BAr&quot;%2BJ%E7d%14%F0%18%F3L%81%0C%26v%C3%60%5CbT%94%85%84%B9%1EhYB)%CF%CA%40%10%03%1E%E9%3C%1F%C3%26%2C%1A%8F%C8%A4R%92%00%00!%F9%04%00%0A%00%05%00%2C%00%00%00%00%10%00%10%00%00%033%08%BA%20%C2%909%17%E3t%E7%BC%DA%9E0%19%C7%1C%E0!.B%B6%9D%CAW%AC%A21%0C%06%0B%14sa%BB%B05%F7%95%01%810%B0%09%89%BB%9Fm)J%00%00!%F9%04%00%0A%00%06%00%2C%00%00%00%00%10%00%10%00%00%032%08%BA%DC%FE%F0%09%11%D9%9CU%5D%9A%01%EE%DAqp%95%60%88%DDa%9C%DD4%96%85AF%C50%14%90%60%9B%B6%01%0D%04%C2%40%10%9B1%80%C2%D6%CE%91%00%00!%F9%04%00%0A%00%07%00%2C%00%00%00%00%10%00%10%00%00%032%08%BA%DC%FE0%CAI%ABeB%D4%9C)%D7%1E%08%08%C3%20%8E%C7q%0E%0410%A9%CA%B0%AEP%18%C2a%18%07V%DA%A5%02%20ub%18%82%9E%5B%11%90%00%00%3B%00%00%00%00%00%00%00%00%00';;(function($){if(/1\.(0|1|2)\.(0|1|2)/.test($.fn.jquery)||/^1.1/.test($.fn.jquery)){alert('blockUI requires jQuery v1.2.3 or later!  You are using v'+$.fn.jquery);return}$.fn._fadeIn=$.fn.fadeIn;var noOp=function(){};var mode=document.documentMode||0;var setExpr=$.browser.msie&&(($.browser.version<8&&!mode)||mode<8);var ie6=$.browser.msie&&/MSIE 6.0/.test(navigator.userAgent)&&!mode;$.blockUI=function(opts){install(window,opts)};$.unblockUI=function(opts){remove(window,opts)};$.growlUI=function(title,message,timeout,onClose){var $m=$('<div class="growlUI"></div>');if(title)$m.append('<h1>'+title+'</h1>');if(message)$m.append('<h2>'+message+'</h2>');if(timeout==undefined)timeout=3000;$.blockUI({message:$m,fadeIn:700,fadeOut:1000,centerY:false,timeout:timeout,showOverlay:false,onUnblock:onClose,css:$.blockUI.defaults.growlCSS})};$.fn.block=function(opts){return this.unblock({fadeOut:0}).each(function(){if($.css(this,'position')=='static')this.style.position='relative';if($.browser.msie)this.style.zoom=1;install(this,opts)})};$.fn.unblock=function(opts){return this.each(function(){remove(this,opts)})};$.blockUI.version=2.33;$.blockUI.defaults={message:'<h1>Please wait...</h1>',title:null,draggable:true,theme:false,css:{padding:0,margin:0,width:'30%',top:'40%',left:'35%',textAlign:'center',color:'#000',border:'3px solid #aaa',backgroundColor:'#fff',cursor:'wait'},themedCSS:{width:'30%',top:'40%',left:'35%'},overlayCSS:{backgroundColor:'#000',opacity:0.6,cursor:'wait'},growlCSS:{width:'350px',top:'10px',left:'',right:'10px',border:'none',padding:'5px',opacity:0.6,cursor:'default',color:'#fff',backgroundColor:'#000','-webkit-border-radius':'10px','-moz-border-radius':'10px','border-radius':'10px'},iframeSrc:/^https/i.test(window.location.href||'')?'javascript:false':'about:blank',forceIframe:false,baseZ:1000,centerX:true,centerY:true,allowBodyStretch:true,bindEvents:true,constrainTabKey:true,fadeIn:200,fadeOut:400,timeout:0,showOverlay:true,focusInput:true,applyPlatformOpacityRules:true,onBlock:null,onUnblock:null,quirksmodeOffsetHack:4};var pageBlock=null;var pageBlockEls=[];function install(el,opts){var full=(el==window);var msg=opts&&opts.message!==undefined?opts.message:undefined;opts=$.extend({},$.blockUI.defaults,opts||{});opts.overlayCSS=$.extend({},$.blockUI.defaults.overlayCSS,opts.overlayCSS||{});var css=$.extend({},$.blockUI.defaults.css,opts.css||{});var themedCSS=$.extend({},$.blockUI.defaults.themedCSS,opts.themedCSS||{});msg=msg===undefined?opts.message:msg;if(full&&pageBlock)remove(window,{fadeOut:0});if(msg&&typeof msg!='string'&&(msg.parentNode||msg.jquery)){var node=msg.jquery?msg[0]:msg;var data={};$(el).data('blockUI.history',data);data.el=node;data.parent=node.parentNode;data.display=node.style.display;data.position=node.style.position;if(data.parent)data.parent.removeChild(node)}var z=opts.baseZ;var lyr1=($.browser.msie||opts.forceIframe)?$('<iframe class="blockUI" style="z-index:'+(z++)+';display:none;border:none;margin:0;padding:0;position:absolute;width:100%;height:100%;top:0;left:0" src="'+opts.iframeSrc+'"></iframe>'):$('<div class="blockUI" style="display:none"></div>');var lyr2=$('<div class="blockUI blockOverlay" style="z-index:'+(z++)+';display:none;border:none;margin:0;padding:0;width:100%;height:100%;top:0;left:0"></div>');var lyr3,s;if(opts.theme&&full){s='<div class="blockUI blockMsg blockPage ui-dialog ui-widget ui-corner-all" style="z-index:'+z+';display:none;position:fixed">'+'<div class="ui-widget-header ui-dialog-titlebar blockTitle">'+(opts.title||'&nbsp;')+'</div>'+'<div class="ui-widget-content ui-dialog-content"></div>'+'</div>'}else if(opts.theme){s='<div class="blockUI blockMsg blockElement ui-dialog ui-widget ui-corner-all" style="z-index:'+z+';display:none;position:absolute">'+'<div class="ui-widget-header ui-dialog-titlebar blockTitle">'+(opts.title||'&nbsp;')+'</div>'+'<div class="ui-widget-content ui-dialog-content"></div>'+'</div>'}else if(full){s='<div class="blockUI blockMsg blockPage" style="z-index:'+z+';display:none;position:fixed"></div>'}else{s='<div class="blockUI blockMsg blockElement" style="z-index:'+z+';display:none;position:absolute"></div>'}lyr3=$(s);if(msg){if(opts.theme){lyr3.css(themedCSS);lyr3.addClass('ui-widget-content')}else lyr3.css(css)}if(!opts.applyPlatformOpacityRules||!($.browser.mozilla&&/Linux/.test(navigator.platform)))lyr2.css(opts.overlayCSS);lyr2.css('position',full?'fixed':'absolute');if($.browser.msie||opts.forceIframe)lyr1.css('opacity',0.0);var layers=[lyr1,lyr2,lyr3],$par=full?$('body'):$(el);$.each(layers,function(){this.appendTo($par)});if(opts.theme&&opts.draggable&&$.fn.draggable){lyr3.draggable({handle:'.ui-dialog-titlebar',cancel:'li'})}var expr=setExpr&&(!$.boxModel||$('object,embed',full?null:el).length>0);if(ie6||expr){if(full&&opts.allowBodyStretch&&$.boxModel)$('html,body').css('height','100%');if((ie6||!$.boxModel)&&!full){var t=sz(el,'borderTopWidth'),l=sz(el,'borderLeftWidth');var fixT=t?'(0 - '+t+')':0;var fixL=l?'(0 - '+l+')':0}$.each([lyr1,lyr2,lyr3],function(i,o){var s=o[0].style;s.position='absolute';if(i<2){full?s.setExpression('height','Math.max(document.body.scrollHeight, document.body.offsetHeight) - (jQuery.boxModel?0:'+opts.quirksmodeOffsetHack+') + "px"'):s.setExpression('height','this.parentNode.offsetHeight + "px"');full?s.setExpression('width','jQuery.boxModel && document.documentElement.clientWidth || document.body.clientWidth + "px"'):s.setExpression('width','this.parentNode.offsetWidth + "px"');if(fixL)s.setExpression('left',fixL);if(fixT)s.setExpression('top',fixT)}else if(opts.centerY){if(full)s.setExpression('top','(document.documentElement.clientHeight || document.body.clientHeight) / 2 - (this.offsetHeight / 2) + (blah = document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop) + "px"');s.marginTop=0}else if(!opts.centerY&&full){var top=(opts.css&&opts.css.top)?parseInt(opts.css.top):0;var expression='((document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop) + '+top+') + "px"';s.setExpression('top',expression)}})}if(msg){if(opts.theme)lyr3.find('.ui-widget-content').append(msg);else lyr3.append(msg);if(msg.jquery||msg.nodeType)$(msg).show()}if(($.browser.msie||opts.forceIframe)&&opts.showOverlay)lyr1.show();if(opts.fadeIn){var cb=opts.onBlock?opts.onBlock:noOp;var cb1=(opts.showOverlay&&!msg)?cb:noOp;var cb2=msg?cb:noOp;if(opts.showOverlay)lyr2._fadeIn(opts.fadeIn,cb1);if(msg)lyr3._fadeIn(opts.fadeIn,cb2)}else{if(opts.showOverlay)lyr2.show();if(msg)lyr3.show();if(opts.onBlock)opts.onBlock()}bind(1,el,opts);if(full){pageBlock=lyr3[0];pageBlockEls=$(':input:enabled:visible',pageBlock);if(opts.focusInput)setTimeout(focus,20)}else center(lyr3[0],opts.centerX,opts.centerY);if(opts.timeout){var to=setTimeout(function(){full?$.unblockUI(opts):$(el).unblock(opts)},opts.timeout);$(el).data('blockUI.timeout',to)}};function remove(el,opts){var full=(el==window);var $el=$(el);var data=$el.data('blockUI.history');var to=$el.data('blockUI.timeout');if(to){clearTimeout(to);$el.removeData('blockUI.timeout')}opts=$.extend({},$.blockUI.defaults,opts||{});bind(0,el,opts);var els;if(full)els=$('body').children().filter('.blockUI').add('body > .blockUI');else els=$('.blockUI',el);if(full)pageBlock=pageBlockEls=null;if(opts.fadeOut){els.fadeOut(opts.fadeOut);setTimeout(function(){reset(els,data,opts,el)},opts.fadeOut)}else reset(els,data,opts,el)};function reset(els,data,opts,el){els.each(function(i,o){if(this.parentNode)this.parentNode.removeChild(this)});if(data&&data.el){data.el.style.display=data.display;data.el.style.position=data.position;if(data.parent)data.parent.appendChild(data.el);$(el).removeData('blockUI.history')}if(typeof opts.onUnblock=='function')opts.onUnblock(el,opts)};function bind(b,el,opts){var full=el==window,$el=$(el);if(!b&&(full&&!pageBlock||!full&&!$el.data('blockUI.isBlocked')))return;if(!full)$el.data('blockUI.isBlocked',b);if(!opts.bindEvents||(b&&!opts.showOverlay))return;var events='mousedown mouseup keydown keypress';b?$(document).bind(events,opts,handler):$(document).unbind(events,handler)};function handler(e){if(e.keyCode&&e.keyCode==9){if(pageBlock&&e.data.constrainTabKey){var els=pageBlockEls;var fwd=!e.shiftKey&&e.target==els[els.length-1];var back=e.shiftKey&&e.target==els[0];if(fwd||back){setTimeout(function(){focus(back)},10);return false}}}if($(e.target).parents('div.blockMsg').length>0)return true;return $(e.target).parents().children().filter('div.blockUI').length==0};function focus(back){if(!pageBlockEls)return;var e=pageBlockEls[back===true?pageBlockEls.length-1:0];if(e)e.focus()};function center(el,x,y){var p=el.parentNode,s=el.style;var l=((p.offsetWidth-el.offsetWidth)/2)-sz(p,'borderLeftWidth');var t=((p.offsetHeight-el.offsetHeight)/2)-sz(p,'borderTopWidth');if(x)s.left=l>0?(l+'px'):'0';if(y)s.top=t>0?(t+'px'):'0'};function sz(el,p){return parseInt($.css(el,p))||0}})(jQuery);t_repost();$('document').ready(function(){});function t_repost(){$('<span id="t163rp_send" class="t_rpbtn"> 转发到t163 </span>').appendTo('body').hide();$('#t163rp_send').click(function(){$('#shadeWin').css('visibility','hidden');var tinfo=t_getrpinfo();if(tinfo[0]!=''&&tinfo[1]!=''){tTitle=encodeURIComponent(tinfo[0]);tUrl='http://comment.news.163.com/reply/transfer.jsp?title='+tTitle+'&url='+tinfo[1];var sleft=(document.documentElement.clientWidth-550)/2;$.blockUI({message:'<img src="'+loadpic+'" />　载入中,请稍候,若无响应请点击背景返回后再试一次.',css:{padding:'5px',border:'',width:'520px',left:sleft+'px',cursor:'default',backgroundColor:'#fff'},overlayCSS:{backgroundColor:'#000',opacity:0.4}});$('.blockOverlay').click(function(){$.unblockUI();});var rpframe=$('<iframe class="t_rp_frame" src="'+tUrl+'" ></iframe>').appendTo('body').hide();$(rpframe).one('load',function(){$.unblockUI();$('#repostWin').css('visibility','hidden');var stop=(document.documentElement.clientHeight-480-20)/2;var sleft=(document.documentElement.clientWidth-750)/2;$.blockUI({message:'<div id="t163rp_repost" class="t_rp_div"></div><div align="center" style="margin-top:5px"><span id="t163rp_close" class="t_closebtn"> 返　回 </span></div>',css:{top:stop+'px',left:sleft+'px',border:'',width:'750px',height:'500px',cursor:'default',},overlayCSS:{backgroundColor:'#000',cursor:'pointer',opacity:0.4}});rpframe.appendTo($('#t163rp_repost')).show();$('#t163rp_close').click(function(){$.unblockUI();});$('.blockPage').css('background-color','transparent');$('.blockOverlay').click(function(){$.unblockUI();});});}});$('#t163rp_send').insertAfter($('#repostWin div.title span.text')).show();$('<span id="t163rp_sdo" class="t_rpbtn t_rpbtndo">　t163转　</span>').appendTo('body').hide();$('#t163rp_sdo').click(function(){var rtTxt=$('#boxArea').val();t_rtSend(rtTxt);});$('#t163rp_sdo').insertAfter($('#loginedSendBtn')).show();};function t_rtHintpos(){var iW=$('#t163m_rthint').width()+20;var iH=$('#t163m_rthint').height()+10;var ileft=(document.documentElement.clientWidth-iW)/2;$('#t163m_rthint').css('top',(document.documentElement.clientHeight-iH-200)/2+'px').css('left',ileft+'px');};function t_rtHint(iMode){var hint='';switch(iMode){case 0:case-1:if(iMode==0){hint='发送'}else{hint='对话载入'};hint+='失败，请重试';break;case 1:hint='发送成功';break;case 2:hint='发送中，请稍候';break;default:break;};if($('#t163m_rthint').length==0){$('<div id="t163m_rthint" class="t_rthint_n">'+hint+'</div>').appendTo('body').hide();t_rtHintpos();};if(iMode>1){$('#t163m_rthint').show();}else{$('#t163m_rthint').fadeOut(100,function(){$('#t163m_rthint').text(hint);t_rtHintpos();var hold=1000;if(iMode<=0){$('#t163m_rthint').removeClass('t_rthint_n').addClass('t_rthint_f');hold=2000;}$('#t163m_rthint').fadeIn(200,function(){setTimeout(t_rtHintOut,hold);});});};};function t_rtHintOut(){$('#t163m_rthint').fadeOut(200,function(){$('#t163m_rthint').remove();});};function t_rtSend(iMsg){var ajax=new XMLHttpRequest();ajax.open('post','http://t.163.com/statuses/update.json',true);ajax.setRequestHeader('Content-type','application/x-www-form-urlencoded; charset=UTF-8');ajax.onload=function(){if(ajax.status!=200||ajax.responseText.length==0){t_rtHint(0);return;};t_rtHint(1);};var rtMsg='status='+encodeURIComponent(iMsg);rtMsg+='&in_reply_to_status_id=&source='+encodeURIComponent('<a href="http://userscripts.org/scripts/show/86292">t163repost</a>');ajax.send(rtMsg);t_rtHint(2);};function t_getrpinfo(){var tinfo=new Array();var tmp=$('#repostWin div.body').find('span.docTitle');if(tmp.length>0){tinfo[0]=tmp.text();}else{tinfo[0]=''}tmp=$('#repostWin div.body').find('a.repostUrl');if(tmp.length>0){tinfo[1]=tmp.attr('href');}else{tinfo[1]='';}return tinfo;};


//helper method to auto update
function autoUpdateFromUserscriptsDotOrg(SCRIPT) {
  
  // Update code from Junk Blocker: http://loonyone.livejournal.com/
  // usage example
  // autoUpdateFromUserscriptsDotOrg({
  //   url: 'http://userscripts.org/scripts/source/688.user.js',
  //   version: "1.2",
  // });

  try {
    if (!GM_getValue) return; // Older version of Greasemonkey. Can't run.

    // avoid a flood of dialogs e.g. when opening a browser with multiple tabs set to homepage
    // and a script with * includes or opening a tabgrop
    var DoS_PREVENTION_TIME = 2 * 60 * 1000;
    var isSomeoneChecking = GM_getValue('CHECKING', null);
    var now = new Date().getTime();
    GM_setValue('CHECKING', now.toString());

    if (!SCRIPT.forceUpdate && isSomeoneChecking && (now - isSomeoneChecking) < DoS_PREVENTION_TIME) return;

    // check daily
    var ONE_DAY = 24 * 60 * 60 * 1000;
    //var ONE_WEEK = 7 * ONE_DAY;
    //var TWO_WEEKS = 2 * ONE_WEEK;
    var lastChecked = GM_getValue('LAST_CHECKED', null);
    if (!SCRIPT.forceUpdate && lastChecked && (now - lastChecked) < ONE_DAY) return;

    GM_xmlhttpRequest({
      method: 'GET',
  	  url: SCRIPT.url + '?source', // don't increase the 'installed' count just for update checks
  	  onload: function(result) {
    	  if (!result.responseText.match(/@version\s+([\d.]+)/)) return;     // did not find a suitable version header
    
    	  var theOtherVersion = parseFloat(RegExp.$1);
    	  if (theOtherVersion <= parseFloat(SCRIPT.version))       
        {
          // no updates or older version on userscripts.orge site
          if(SCRIPT.forceUpdate)
          {
            alert("您当前所安装的 v" + SCRIPT.version + " 是最新版本，无需更新。")
          }
          return;
        }
        //find the name of the script
        result.responseText.match(/@name\s+(.+)/);
        var scriptName = RegExp.$1;
    
    	  if (window.confirm('检查到 Greasemonkey 脚本 "' + scriptName + '" 最新版本为 v' + theOtherVersion + '\n您当前安装的版本是 v' + SCRIPT.version + ' .\n\n立即更新?\n')) {
    	    GM_openInTab(SCRIPT.url);   // better than location.replace as doing so might lose unsaved data
    	  }
  	 }
    });
    GM_setValue('LAST_CHECKED', now.toString());
  } catch (ex) {
  }
}

function update(forceUpdate)
{
  autoUpdateFromUserscriptsDotOrg({
    url: 'http://userscripts.org/scripts/source/86292.user.js',
    version: t163rp_version,
    forceUpdate: forceUpdate
  });
}

update(false);

GM_registerMenuCommand('Update t163repost',function(){update(true)});