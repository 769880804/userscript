// ==UserScript==
// @name           AvatarGoodness
// @version        192.168.0.5
// @include 
// ==/UserScript==
//
var updateManagerDts={ALLIANCE:8405,WORLD:913,PLAYER:1321,MAT:1322,QUEST:5122,COMO:5121,REPORT:5121,TIME:512,RESO:3527,VIS:3527,ALL_AT:3311,CITY:2333,CHAT:1},__refTime=0,__slipTime=0,__elapsedTime=0,__lastTime=0;function avaSuiteInitPre0(){}
function avaSuiteInit0(){console.warn("I am in avaInit - yay!");webfrontend.gui.Queue.prototype._createDummyContainers=function(b,d,e){};console.log("passed here");"webkit"==qx.core.Environment.get("engine.name")&&(qx.bom.client.CssAnimation.getKeyFrames=function(){for(var b=qx.bom.Style.VENDOR_PREFIXES,d=[],e=0;e<b.length;e++){var f="@"+qx.bom.Style.getCssName(b[e])+"-keyframes";d.push(f)}"webkit"===qx.core.Environment.get("engine.name")?d.push("@keyframes"):d.unshift("@keyframes");b=qx.bom.Stylesheet.createElement();
for(e=0;e<d.length;e++)try{return qx.bom.Stylesheet.addRule(b,d[e]+" name",""),d[e]}catch(g){}return null});qx.ui.core.Blocker.prototype.block=function(){};console.log("passed here 05");var b=webfrontend.config.Config.getInstance().getChat();b.setUseStickyChannelsDefault(!0);b.setUseStickyChannels(!0);b.setShowWhisperNotifications(!0);console.log("passed here 01");b=webfrontend.config.Config.getInstance().zoomInfo;b.city.aFactors=[4,2,1,0.875,0.75,0.65,0.5,0.3];b.city.iCurrent=5;b.city.iDefault=5;
console.log("passed here 03");b.region.aFactors=[2,1.5,1.25,1,0.9,0.8,0.7,0.6,0.5,0.4,0.35,0.3,0.225];b.region.iCurrent=4;b.region.iDefault=4;b.world.aFactors=[2,1.5,1,0.8,0.5,0.35];b.world.iCurrent=2;b.world.iDefault=2;qx.ui.window.Manager.prototype.syncWidget=function(){for(var b=this.getDesktop(),d=b.getWindows(),e=this._minZIndex,f=e+2*d.length,g=e+4*d.length,h=null,k=0,l=d.length;k<l;k++){var m=d[k];m.isVisible()&&(h=h||m,m.isModal()?(m.setZIndex(g),g+=2,h=m):m.isAlwaysOnTop()?m.getWidth()>7*
qx.bom.Viewport.getWidth()/8&&m.getHeight()>7*qx.bom.Viewport.getHeight()/8?m.setZIndex(10):(m.setZIndex(f),f+=2):(m.setZIndex(e),e+=2),!h.isModal()&&m.isActive()||m.getZIndex()>h.getZIndex())&&(h=m)}b.setActiveWindow(h)};console.log("passed here 05");setTimeout(function(){function b(){0<webfrontend.data.ServerTime.getInstance().refTime?(webfrontend.net.UpdateManager.getInstance().removeConsumer("TIME"),webfrontend.data.ServerTime.prototype.dispatchResults=function(b){var c=(new Date).getTime(),d=
b.Ref-__refTime,e=c-__lastTime;__refTime&&(__slipTime+=d,__elapsedTime+=e);this.refTime=b.Ref;__lastTime=c;__refTime=b.Ref;console.error("New server Time. Slip Rate: "+100*__slipTime/__elapsedTime+" Ref: "+b.Ref/1E3+"<- thisSlip: "+d/e+" total: "+__slipTime/1E3+" diff: "+this.diff+" server step "+this.getServerStep());this.stepTime=b.Step;this.diff=b.Diff;this.serverOffset=36E5*b.o},webfrontend.net.UpdateManager.getInstance().addConsumer("TIME",webfrontend.data.ServerTime.getInstance()),hijackSendCommand(),
webfrontend.data.ServerTime.prototype.getRequestDetails=function(b){return(new Date).getTime().toString()}):setTimeout(b,1E3)}function d(){var b=this.getUpdateService(),c=this.getInstanceGuid(),d=(new Date).getTime();if(!(this.waitForResponse&&d<this.requestSendTime+8E3)){var e=this.getMaxPollSkip(d-this.userActivityTime);if(this.pollSkip<e)this.pollSkip++;else{this.requestSendTime=d;this.waitForResponse=1;this.pollSkip=0;e=new qx.util.StringBuilder(2048);!0==this.userActivity&&(this.userActivity=
!1,e.add("UA:\f"));e.add("TM:",this.lastPoolNetTime.toString(),",",this.lastProcessingTime.toString(),",",this.lastProcessingDetails,"\f");for(var f in this.requester){var g=this.requester[f];d>(g.nextUpdateTime||0)&&(g.nextUpdateTime=d+(g.updateDt||0),e.add(f,":",g.func.call(g.obj,this.requestCounter),"\f"))}f=new qx.util.StringBuilder(2048);f.add('{"session":"',c,'","requestid":"',this.requestCounter,'","requests":',qx.lang.Json.stringify(e.get()),"}");this.requestCounter++;var h=this;/lordofultima\.com/i.test(document.domain)?
(a=new qx.io.remote.Request(b+"/Service.svc/ajaxEndpoint/Poll","POST","application/json"),a.setProhibitCaching(!1),a.setRequestHeader("Content-Type","application/json"),a.setData(f.get()),a.setTimeout(1E4),a.addListener("completed",this.completeRequest,this),a.addListener("failed",this.failRequest,this),a.addListener("timeout",this.timeoutRequest,this),a.send()):GM_xmlhttpRequest({method:"POST",url:b+"/Service.svc/ajaxEndpoint/Poll",data:f.get(),timeout:1E4,headers:{"Content-Type":"application/json"},
onerror:h.failRequest.bind(h),ontimeout:h.timeoutRequest.bind(h),onload:function(b){b=""!=b.responseText?qx.lang.Json.parse(b.responseText):{};h.completeRequest(b)}})}}}function e(){for(var b in updateManagerDts)f.requester[b]&&(f.requester[b].updateDt=updateManagerDts[b])}var f=webfrontend.net.UpdateManager.getInstance();webfrontend.data.ReportHeaderDataModel.prototype._loadRowData=function(b,c){var d=this;0>d.getFolder()?d._onRowDataLoaded(null):(null==d.getPlayerName()&&d.setPlayerName(webfrontend.data.Player.getInstance().getName()),
webfrontend.net.CommandManager.getInstance().sendCommand("ReportGetHeader",{sPlayerName:d.getPlayerName(),city:d.getCity(),start:b,end:c,sort:d.getSortColumnIndex()-1,ascending:d.isSortAscending(),mask:d.getMask()},d,function(b,c){d._onLoadRowDataCompleted(b,c&&0!=c.length?c:null)}))};b();console.debug("Replaced Update");webfrontend.net.UpdateManager.prototype.onStartUpdate=d.bind(f);webfrontend.net.UpdateManager.prototype.pollNow=function(b){b&&(this.requester[b].nextUpdateTime=0);this.pollSkip=
1024;d.call(this)};try{console.debug("registered :"),console.dir(f.requester)}catch(g){console.dir(g),console.error("not registered :(")}var h=f.timer;f.timer=new qx.event.Timer(979);h.stop();webfrontend.net.UpdateManager.prototype.getMaxPollSkip=function(b){return 500>b||1E3>b||2E3>b?0:15E3>b?1:3E4>b?2:6E4>b?3:4};f.timer.addListener("interval",d.bind(f),f);h.dispose();f.timer.start();e();setTimeout(e,2E4);setTimeout(e,12E4)},2E3);qx.core.Init.getApplication().scriptErrorMsg=null;qx.core.Init.getApplication().scriptErrorUrl=
null}var savedFarmServiceURL;function globalErrorHandler(b,c,d,e){try{console.trace(),console.error(b+c+":"+d.toString()+":"+e.toString())}catch(f){console.trace(),console.dir(f)}}var ava;
(function(b){var c=function(){return function(){this.avaSuiteVersion=avaSuiteVersion;this.imageSource="410784";this.sortByReference=this.wantCastleCustomizations=this.hideAvaTools=!1;this.showChatAlertPhrases=this.showWhisperAlert=this.showChatAlert=!0;this.chatAlertPhrases="";this.showCityBuildings=2;this.enableClosestHub=!0;this.hubTemplates=[{name:"Castle",res:{wood:2E5,stone:2E5,iron:3E5,food:7E5}},{name:"Res City",res:{wood:12E4,stone:12E4,iron:0,food:0}},{name:"Hub",res:{wood:1E6,stone:1E6,
iron:1E6,food:1E6}},{name:"Finished Res",res:{wood:0,stone:0,iron:0,food:0}}];this.showConsole=this.wantDisqus=this.tjsHideCursor=this.autostartTjs=!1;this.useLookOut360=!0;this.disqusPos=[10,10,500,160]}}();b.Options=c;var d=function(){function d(){this.coord=new WorldViewCoord(0,0);this.LOC_CONTAINER_INDEX=4;this.ORIG_CHILD_COUNT=6;this.RETURN_TIME_INDEX=3;this.CMD_LIST_INDEX=1;this.cityBuildings=null;this.SEND_WOOD=1;this.SEND_STONE=2;this.SEND_BOTH=3;this.DO_NOT_SUPPORT_UNITS={1:!0,19:!0}}d.getInstance=
function(){return avaMain};d.prototype.loadOptions=function(){this.options||(this.options=new c);var b=localStorage.getItem("Ava_options");paDebug(b);if(b)try{var d=qx.lang.Json.parse(b),e;for(e in d)"undefined"!=typeof this.options[e]?this.options[e]=d[e]:console.log("extra data:  "+e+" "+d[e])}catch(k){localStorage.removeItem("Ava_options"),console.log(k)}savedFarmServiceURL=FarmServiceURL;FarmServiceURL=this.options.wantCastleCustomizations?savedFarmServiceURL:null;this.options.imageSource&&/lordofultima\.com/i.test(document.domain)&&
(b=this.options.imageSource,d=webfrontend.config.Config.getInstance(),e=d.getImageSource(),e=e.replace(/\d{6}/,b),d.setImageSource(e));this.app.setUserData("Ava_options",this.options);console.log("loaded")};d.prototype.updateCmdInfoView=function(){for(var b=qx.core.Init.getApplication().getCityInfoView().container.getChildren(),c=0;c<b.length;c++)if("CityCommandInfoView"==b[c].basename){this.cCmdInfoView=b[c];break}};d.prototype.initialize=function(){paDebug("ava.Main.initialize");this.app=qx.core.Init.getApplication();
this.app.getPlayerData();this.playerName=webfrontend.data.Player.getInstance().getName();this.loadOptions();this.panel=new b.ExtraTools;this.addPanel(this.panel);this.cancelOrders=new b.CancelOrderPanel;this.setupCityInfoView()};d.prototype.setupCityInfoView=function(){if(qx.core.Init.getApplication().cityInfoView){this.updateCmdInfoView();this.cCmdInfoView.commandHeaderData.header.add(this.cancelOrders,{left:155,top:7});var c,g;b.alerts.getInstance().init();var h=this.app,k=(h.cityDetailView||h.getCityDetailView()).actionArea;
c=new qx.ui.container.Composite;c.setLayout(new qx.ui.layout.HBox(4));k.add(c);g=new qx.ui.form.Button("Attack");g.orderId=3;g.setToolTipText("Assault selected city with all Available units");g.addListener("execute",avaContextMenu.sendTroops,avaContextMenu);var l=new qx.ui.form.Button("Plunder");l.orderId=2;l.setToolTipText("Plunder selected city with all Available units");l.addListener("execute",avaContextMenu.sendTroops,avaContextMenu);var m=new qx.ui.form.Button("Siege");m.orderId=5;m.setToolTipText("Siege selected city with all Available units");
m.addListener("execute",avaContextMenu.sendTroops,avaContextMenu);var n=new qx.ui.form.Button("Support");n.orderId=4;n.setToolTipText("Support selected city with all Available units");n.addListener("execute",avaContextMenu.sendTroops,avaContextMenu);c.add(g,{flex:1});c.add(l,{flex:1});c.add(m,{flex:1});c.add(n,{flex:1});c=new qx.ui.container.Composite;c.setLayout(new qx.ui.layout.HBox);g=new qx.ui.basic.Label;g.setAlignY("middle");g.setRich(!0);g.setFont("bold");c.setMaxHeight(0);g.setMaxHeight(0);
c.setVisibility("hidden");c.add(g);k.add(c);k=b.RaidReporter.getInstance();h=h.getReportPage();h.origOnReport=h._onReport;h._onReport=k.interceptOnReport;this.updateCmdInfoView();this.calcReturnTimes();h=new qx.ui.layout.HBox(3);h=new qx.ui.container.Composite(h);this.app.getForumPostPage().getChildren()[0].add(h,{top:45,left:400});k=new qx.ui.form.Button("Scroll To Top");k.set({width:90,appearance:"button-text-small",toolTipText:"Scroll to top of thread"});k.addListener("click",this.scrollToTop,
!1);h.add(k);k=new qx.ui.form.Button("Scroll To Bottom");k.set({width:90,appearance:"button-text-small",toolTipText:"Scroll to bottom of thread"});k.addListener("click",this.scrollToBottom,!1);h.add(k);this.createWorldViewEnhancments();b.Inception.getInstance().init();b.Chat.getInstance().init();emotifyIcons();b.Chat.getInstance().addChatMessage(" is not broken ;) - good times for all",!0);this.panel.showOptionsPage();qx.core.Init.getApplication().switchOverlay(null);this.cityBuildings=new b.CityBuildings;
this.panel.getLayoutParent().addBefore(this.cityBuildings.bldgsCont,this.panel);webfrontend.data.City.getInstance().addListener("changeVersion",this.cityBuildings.updateCityBuildings,this.cityBuildings);this.app.visMain.addListener("changeMapLoaded",function(){2==d.getInstance().options.showCityBuildings&&this.cityBuildings.updateCityBuildings()},this);this.cityBuildings.updateCityBuildings()}else setTimeout(this.setupCityInfoView.bind(this),2E3)};d.prototype.updateCity=function(){var b=this.cCmdInfoView.getChildren()[this.CMD_LIST_INDEX].getChildren();
if(b)for(var c=0;c<b.length;c++){var d=b[c].getChildren()[this.LOC_CONTAINER_INDEX].getChildren()[1].getChildren()[0];d.getChildren().length>this.ORIG_CHILD_COUNT&&d.removeAt(this.RETURN_TIME_INDEX)}this.calcReturnTimes()};d.prototype.calcReturnTimes=function(){this.cCmdInfoView||this.updateCmdInfoView();var b=this.cCmdInfoView.getChildren()[this.CMD_LIST_INDEX].getChildren(),c=webfrontend.data.City.getInstance().getUnitOrders();if(c)for(var d=0;d<c.length;d++){var e=c[d];if(9!=e.type&&4!=e.type&&
5!=e.type&&1==e.state){var l=e.end-e.start,m=webfrontend.Util.getDateTimeString(webfrontend.data.ServerTime.getInstance().getStepTime(e.end+l)),e=new qx.ui.container.Composite;e.setLayout(new qx.ui.layout.Canvas);l=new qx.ui.basic.Label("Returns:");l.setTextColor("text-darkbrown");var n=new qx.ui.core.Spacer;n.setWidth(7);m=new qx.ui.basic.Label(m);m.setTextColor("text-deepdarkbrown");m.set({font:"bold"});e.add(l);e.add(n);e.add(m,{left:70});l=b[d].getChildren()[this.LOC_CONTAINER_INDEX].getChildren()[1].getChildren()[0];
l.getChildren().length>this.ORIG_CHILD_COUNT&&l.removeAt(this.RETURN_TIME_INDEX);l.addAt(e,this.RETURN_TIME_INDEX)}}};d.prototype.scrollToTop=function(){try{var b=qx.core.Init.getApplication().getForumPostPage(),c=b.getChildren().length-1;b.getChildren()[c].getChildren()[1].scrollToY(0)}catch(d){paDebug(d)}};d.prototype.scrollToBottom=function(){try{var b=qx.core.Init.getApplication().getForumPostPage(),c=b.getChildren().length-1;b.getChildren()[c].getChildren()[1].scrollToY(99999)}catch(d){paDebug(d)}};
d.prototype.sendToChat=function(b,c){var d="",e=qx.core.Init.getApplication().chat;!c&&e&&e.chatLine.getValue()&&(d=e.chatLine.getValue(),d=d.substr(0,e.chatLine.getTextSelectionStart())+b+d.substr(e.chatLine.getTextSelectionEnd()),b="");e.chatLine.setValue(d+b)};d.prototype.updateWorldViewCoord=function(){var b=this.app.worldViewToolTip,c=null,d="",e=null,e=b.x-b.getWorldView().getContentLocation().left,l=b.y-b.getWorldView().getContentLocation().top,m=b.getVisMain().GetXCoordFromViewPosition(e),
n=b.getVisMain().GetYCoordFromViewPosition(l),b=b.getVisMain().GetTooltipText(e,l),p=l=0;b.match(/<td>Player:<\/td><td>(.+?) <span dir="ltr">(.+?)<\/td>/)?(c=b.match(/<td>Player:<\/td><td>(.+?) <span dir="ltr">(.+?)<\/td>/)[1],b.match(/<td>Alliance:<\/td><td>(.+?) <span dir="ltr">(.+?)<\/td>/)&&(d=b.match(/<td>Alliance:<\/td><td>(.+?) <span dir="ltr">(.+?)<\/td>/)[1]),e="City"):b.match(/<td>Score:<\/td><td>.+?<\/td>/)?e="LawlessCity":b.match(/<td width="75">Type:<\/td><td>.+?<\/td>/)?(e="Dungeon",
b.match(/<td>Level:<\/td><td>(.+?)<\/td>/)&&(l=b.match(/<td>Level:<\/td><td>(.+?)<\/td>/)[1]),b.match(/<td>Progress:<\/td><td>(.+?)%<\/td>/)&&(p=b.match(/<td>Progress:<\/td><td>(.+?)%<\/td>/)[1])):b.match(/<td width="75">Name:<\/td><td>.+?<\/td>/)?(e="Boss",b.match(/<td>Level:<\/td><td>(.+?)<\/td>/)&&(l=b.match(/<td>Level:<\/td><td>(.+?)<\/td>/)[1]),b.match(/<td width="75">Name:<\/td><td>(.+?)<\/td>/)&&(c=b.match(/<td width="75">Name:<\/td><td>(.+?)<\/td>/)[1])):e="FreeSlot";this.coord.x=m;this.coord.y=
n;this.coord.playerName=c;this.coord.allianceName=d;this.coord.type=e;this.coord.level=l;this.coord.progress=p;this.coord.city="City"==e;this.coord.lawless="LawlessCity"==e;this.coord.boss="Boss"==e;this.coord.dungeon="Dungeon"==e;this.coord.attackable="City"==e||"Boss"==e||"Dungeon"==e||"LawlessCity"==e;return this.coord};d.prototype.findObject=function(b,c,d){d=d||!1;for(var e in b){if(b[e]instanceof c)return b[e];if(d&&"object"==typeof b[e]){var l=this.findObject(b[e],c,d);if(null!=l)return l}}return null};
d.prototype.createWorldViewEnhancments=function(){this.worldViewMinBtn=(new qx.ui.form.Button("")).set({icon:"webfrontend/ui/icons/icon_chat_resize_smaller.png",padding:4,minWidth:10,width:29});this.worldViewMinBtn.setLayoutProperties({top:3,right:9});this.worldViewMinBtn.addListener("execute",function(b){0<this.app.worldMapConfig.getLayoutProperties().top?(this.app.worldMapConfig.setLayoutProperties({top:null,height:4}),this.worldViewMinBtn.setIcon("webfrontend/ui/icons/icon_chat_resize.png")):(this.app.worldMapConfig.setLayoutProperties({top:187,
height:null}),this.worldViewMinBtn.setIcon("webfrontend/ui/icons/icon_chat_resize_smaller.png"))},this);this.worldViewMinBtn.addListener("appear",function(b){0<this.app.worldMapConfig.getLayoutProperties().top?this.worldViewMinBtn.setIcon("webfrontend/ui/icons/icon_chat_resize_smaller.png"):this.worldViewMinBtn.setIcon("webfrontend/ui/icons/icon_chat_resize.png")},this);null==this.app.worldMapConfig&&(this.app.worldMapConfig=(new webfrontend.gui.WorldMapConfig).set({width:400}),this.app.worldMapConfig.setLayoutProperties({top:187,
left:0,bottom:0}));this.app.worldMapConfig.setMinHeight(0);this.app.worldMapConfig.add(this.worldViewMinBtn)};d.prototype.addPanel=function(b){var c=qx.core.Init.getApplication().getCityInfoView().buildingQueue;c.getLayoutParent().addBefore(b,c)};return d}();b.Main=d;b.Main=d})(ava||(ava={}));var avaMain;
function avaSuiteInit1(){console.log("passed here 2");window.onerror=globalErrorHandler;avaMain=new ava.Main;console.log("passed here3");avaMain.initialize();console.log("passed here4");avaInitContextMenu();console.log("passed here5");avaInitRaids();avaMain.options.wantDisqus&&disqusShow(!0);tjsInit(avaMain.options.autostartTjs);avaMain.options.showConsole&&setTimeout(qx.log.appender.Console.show.bind(qx.log.appender.Console),8E3);avaMain.options.useLookOut360&&avaMailInit();qx.ui.window.Window.prototype.setModal=
function(b){};updateVersion()}var cityMruSize=32;
(function(b){var c=function(){function c(){}c.prototype.sendTroops=function(c){try{try{var d=c.getCurrentTarget(),g=webfrontend.data.City.getInstance(),h=qx.core.Init.getApplication(),k=(h.cityDetailView||h.getCityDetailView()).city,l=g.units;c=[];for(var m in l)DO_NOT_ATTACK_UNITS[m]||2==d.orderId&&DO_NOT_PLUNDER_UNITS[m]||0<l[m].count&&c.push({t:m,c:l[m].count});var n=cityIdToCoords(k?k.get_Coordinates():b.Main.getInstance().coord.toNumber()),p={cityid:g.getId(),units:c,targetPlayer:k?k.get_PlayerName():
b.Main.getInstance().coord.playerName,targetCity:n.format(),order:d.orderId,transport:1,timeReferenceType:1,referenceTimeUTCMillis:0,raidTimeReferenceType:0,raidReferenceTimeUTCMillis:0};webfrontend.net.CommandManager.getInstance().sendCommand("OrderUnits",p,this,this.sentTroops)}catch(q){paError(q)}}catch(r){paError(r)}};c.prototype.sentTroops=function(b,c){try{0!=c.r0?(cityStatusText&&(cityStatusRow.setMaxHeight(20),cityStatusText.setMaxHeight(20),cityStatusRow.setVisibility("visible"),cityStatusText.setValue("Troops won't go."),
window.setTimeout(clearCityStatusText,2E3)),paDebug("Troops won't go")):cityStatusText&&(cityStatusRow.setMaxHeight(20),cityStatusText.setMaxHeight(20),cityStatusRow.setVisibility("visible"),cityStatusText.setValue("Troops Sent."),window.setTimeout(clearCityStatusText,2E3))}catch(d){paError(d)}};c.prototype.onTroopsSent=function(b,c){try{b||0!=c&&paDebug("Troops won't go")}catch(d){paDebug("onTroopsSent: "+d)}};c.prototype.createRaidApplyToAll=function(){var b=this,c=qx.core.Init.getApplication().getOrderDetailPage();
c.applyAllBtn=new qx.ui.form.Button("Apply to all");c.applyAllBtn.set({marginRight:4,marginLeft:9});c.applyAllThisDungeonBtn=new qx.ui.form.Button("Apply to all this dungeon");c.applyAllBtn.onTroopsSent=this.onTroopsSent;c.applyAllBtn.addListener("execute",function(c){var d=avaMain.findObject(qx.core.Init.getApplication().getOrderDetailPage(),webfrontend.gui.OrderDetail.RaidTimeDisplay);c=d.getRaidMode();var d=d.getStepTime(),f=webfrontend.data.City.getInstance().unitOrders,l;for(l in f)8==f[l].type&&
webfrontend.net.CommandManager.getInstance().sendCommand("UnitOrderSetRecurringOptions",{cityid:webfrontend.data.City.getInstance().getId(),id:f[l].id,isDelayed:f[l].isDelayed,recurringType:c,recurringEndStep:d},b,b.onTroopsSent)},this);c.applyAllThisDungeonBtn.onTroopsSent=this.onTroopsSent;c.applyAllThisDungeonBtn.addListener("execute",function(d){var h=avaMain.findObject(qx.core.Init.getApplication().getOrderDetailPage(),webfrontend.gui.OrderDetail.RaidTimeDisplay);d=h.getRaidMode();var h=h.getStepTime(),
k=c.getOrderId(),l=0,m=webfrontend.data.City.getInstance().unitOrders,n;for(n in m)m[n].id==k&&(l=m[n].city);for(n in m)8==m[n].type&&m[n].city==l&&webfrontend.net.CommandManager.getInstance().sendCommand("UnitOrderSetRecurringOptions",{cityid:webfrontend.data.City.getInstance().getId(),id:m[n].id,isDelayed:m[n].isDelayed,recurringType:d,recurringEndStep:h},b,b.onTroopsSent)},this);c.addListenerOnce("appear",addApplyAllButtons)};c.prototype.createContextMenu=function(){var c=this;this.worldContext=
new qx.ui.menu.Menu;this.worldContext.setIconColumnWidth(0);this.copyMenu=new qx.ui.menu.Menu;this.copyMenu.setIconColumnWidth(0);this.infoMenu=new qx.ui.menu.Menu;this.infoMenu.setIconColumnWidth(0);this.selectCityBtn=new qx.ui.menu.Button("Switch to City");this.viewReportsBtn=new qx.ui.menu.Button("View Reports");this.killBossBtn=new qx.ui.menu.Button("Kill Boss");this.raidDungeonBtn=new qx.ui.menu.Button("Raid");this.mruMenu=new qx.ui.menu.Menu("Recent Cities");this.mruMenuBtnSub=new qx.ui.menu.Button("Recent Cities",
null,null,this.mruMenu);this.mruMenu.setIconColumnWidth(0);this.mruCity=[];for(var d=0;d<cityMruSize;++d){var g=new qx.ui.menu.Button("City"+d);g.id=d;this.mruCity.push(g);var h=function(b){b=this.id;var c=getCityMru();console.log(b);if(b=c[b])console.log(b),b=b.substr(b.lastIndexOf("(")),console.log(b),(new Coord(b)).openCity(!0)};g.addListener("execute",h,g);1==d&&this.mruMenuBtnSub.addListener("execute",h,g);this.mruMenu.add(g)}this.sendArmyBtn=new qx.ui.menu.Button("Send Army");this.plunderBtn=
new qx.ui.menu.Button("Plunder With All");this.scoutBtn=new qx.ui.menu.Button("Scout With All");this.supportBtn=new qx.ui.menu.Button("Support With All");this.copyBtn=new qx.ui.menu.Button("Copy to Chat");this.copyBtnSub=new qx.ui.menu.Button("Copy to Chat",null,null,this.copyMenu);this.copyCoordBtn=new qx.ui.menu.Button("Coordinates");this.copyPlayerBtn=new qx.ui.menu.Button("Player");this.copyAllianceBtn=new qx.ui.menu.Button("Alliance");this.sendResBtn=new qx.ui.menu.Button("Send Resources");this.infoPlayerBtn=
new qx.ui.menu.Button("Player Info");this.worldContext.add(this.mruMenuBtnSub);this.worldContext.add(this.infoPlayerBtn);this.whisperBtn=new qx.ui.menu.Button("Whisper");this.worldContext.add(this.selectCityBtn);this.worldContext.add(this.viewReportsBtn);this.worldContext.add(this.killBossBtn);this.worldContext.add(this.raidDungeonBtn);this.worldContext.add(this.sendArmyBtn);this.worldContext.add(this.plunderBtn);this.worldContext.add(this.scoutBtn);this.worldContext.add(this.supportBtn);this.worldContext.add(this.sendResBtn);
this.worldContext.add(this.whisperBtn);this.worldContext.add(this.copyBtnSub);this.copyMenu.add(this.copyCoordBtn);this.copyMenu.add(this.copyPlayerBtn);this.copyMenu.add(this.copyAllianceBtn);qx.core.Init.getApplication().worldView.setContextMenu(this.worldContext);qx.core.Init.getApplication().worldView.addListener("beforeContextmenuOpen",function(b){c.updateWorldViewContext()},this);this.plunderBtn.orderId=2;this.plunderBtn.addListener("execute",this.sendTroops,this);this.scoutBtn.orderId=1;this.scoutBtn.addListener("execute",
this.sendTroops,this);this.supportBtn.orderId=4;this.supportBtn.addListener("execute",this.sendTroops,this);this.sendArmyBtn.addListener("execute",function(b){avaMain.coord&&avaMain.app.showSendArmy(avaMain.coord.x,avaMain.coord.y)},this);this.killBossBtn.addListener("execute",function(c){var d=b.RaidingWindow.getInstance();c=d.pickBossRaider().t;var e=new BossType;e.BossType=getBossType(avaMain.coord.playerName);e.BossLevel=avaMain.coord.level;d=d.getUnitsToKill(c,e);e=webfrontend.data.City.getInstance().getUnitTypeInfo(c);
d<=e.count&&(e=[],e.push({t:c,c:Math.floor(d)}),webfrontend.net.CommandManager.getInstance().sendCommand("OrderUnits",{cityid:webfrontend.data.City.getInstance().getId(),units:e,targetPlayer:"",targetCity:avaMain.coord.toString(),order:8,transport:1,timeReferenceType:1,referenceTimeUTCMillis:0,raidTimeReferenceType:0,raidReferenceTimeUTCMillis:0}))},this);this.sendResBtn.addListener("execute",function(b){avaMain.coord&&avaMain.coord.city&&avaMain.app.showTrade(avaMain.coord.x,avaMain.coord.y)},this);
this.selectCityBtn.addListener("execute",function(b){avaMain.coord&&avaMain.coord.city&&avaMain.coord.playerName==avaMain.playerName&&qx.core.Init.getApplication().cityBar.citiesSelect.setSelectedCityId(avaMain.coord.getId())},this);this.viewReportsBtn.addListener("execute",function(b){avaMain.coord&&avaMain.coord.type&&avaMain.app.showInfoPage(avaMain.app.getCityInfoPage(),{id:avaMain.coord.getId()})},this);this.raidDungeonBtn.addListener("execute",function(c){if(avaMain.coord&&avaMain.coord.dungeon){c=
b.RaidingWindow.getInstance();var d=qx.bom.Viewport.getWidth(window),e=qx.bom.Viewport.getHeight(window);c.setWidth(500);c.setHeight(500);c.show();c.moveTo(d-500,e-525)}},this);this.infoPlayerBtn.addListener("execute",function(b){avaMain.coord&&avaMain.coord.type&&avaMain.app.showInfoPage(avaMain.app.getPlayerInfoPage(),{name:avaMain.coord.playerName})},this);this.copyBtnSub.addListener("execute",function(b){avaMain.coord&&avaMain.sendToChat("[city]"+webfrontend.gui.Util.formatCoordinates(avaMain.coord.x,
avaMain.coord.y)+"[/city]")},this);this.copyCoordBtn.addListener("execute",function(b){avaMain.coord&&avaMain.sendToChat("[coords]"+webfrontend.gui.Util.formatCoordinates(avaMain.coord.x,avaMain.coord.y)+"[/coords]")},this);this.copyPlayerBtn.addListener("execute",function(b){avaMain.coord&&avaMain.coord.city&&avaMain.sendToChat("[player]"+avaMain.coord.playerName+"[/player]")},this);this.copyAllianceBtn.addListener("execute",function(b){avaMain.coord&&avaMain.coord.city&&avaMain.sendToChat("[alliance]"+
avaMain.coord.allianceName+"[/alliance]")},this)};c.prototype.updateWorldViewContext=function(){this.selectCityBtn.setVisibility("excluded");this.infoPlayerBtn.setVisibility("excluded");this.viewReportsBtn.setVisibility("excluded");this.killBossBtn.setVisibility("excluded");this.raidDungeonBtn.setVisibility("excluded");this.sendArmyBtn.setVisibility("excluded");this.plunderBtn.setVisibility("excluded");this.scoutBtn.setVisibility("excluded");this.sendResBtn.setVisibility("excluded");this.copyBtn.setVisibility("excluded");
this.copyBtnSub.setVisibility("excluded");this.supportBtn.setVisibility("excluded");for(var b=0;b<cityMruSize;++b){var c=this.mruCity[b],d=getCityMru();d[b]&&(c.setLabel(d[b]),1==b&&this.mruMenuBtnSub.setLabel(d[b]))}this.whisperBtn.setVisibility("excluded");if("r"==avaMain.app.visMain.mapmode||"w"==avaMain.app.visMain.mapmode)b=avaMain.updateWorldViewCoord(),this.sendArmyBtn.setVisibility(b.attackable&&(b.city||b.lawless)?"visible":"excluded"),this.plunderBtn.setVisibility(b.attackable&&(b.city||
b.lawless)&&b.playerName!=avaMain.playerName?"visible":"excluded"),this.scoutBtn.setVisibility(b.attackable&&(b.city||b.lawless)&&b.playerName!=avaMain.playerName?"visible":"excluded"),this.supportBtn.setVisibility(b.attackable&&(b.city||b.lawless)?"visible":"excluded"),this.sendArmyBtn.setVisibility(b.attackable&&(b.city||b.lawless)?"visible":"excluded"),this.viewReportsBtn.setVisibility(b.attackable?"visible":"excluded"),this.selectCityBtn.setVisibility(b.city&&b.playerName==avaMain.playerName?
"visible":"excluded"),this.infoPlayerBtn.setVisibility(b.city&&b.playerName?"visible":"excluded"),this.sendResBtn.setVisibility(b.city&&b.playerName?"visible":"excluded"),this.killBossBtn.setVisibility(b.boss?"visible":"excluded"),this.raidDungeonBtn.setVisibility(b.dungeon?"visible":"excluded"),this.copyBtn.setVisibility(b?"visible":"excluded"),this.copyBtnSub.setVisibility(b?"visible":"excluded"),this.copyPlayerBtn.setVisibility(b&&b.city&&b.playerName?"visible":"excluded"),this.copyAllianceBtn.setVisibility(b&&
b.allianceName?"visible":"excluded")};return c}();b.ContextMenu=c})(ava||(ava={}));var avaContextMenu=new ava.ContextMenu;function avaInitContextMenu(){avaContextMenu.createRaidApplyToAll();avaContextMenu.createContextMenu()}function Mod10(b){return 10*Math.floor(b/10)}var incomingAttackInfo=function(){return function(){}}();
function formatIncomingDate(b){webfrontend.data.ServerTime.getInstance().getDiff();webfrontend.config.Config.getInstance().getTimeZoneOffset();var c=webfrontend.data.ServerTime.getInstance().getServerOffset(),d=6E4*-(new Date).getTimezoneOffset();b.setTime(b.getTime()+c-d);c=(new Date(Date.now())).getDate();c=b.getDate()-c;0>c&&(c+=31);var e=b.getHours(),d=b.getMinutes();b=b.getSeconds();e=padNN(e);d=padNN(d);b=padNN(b);return c+" "+e+":"+d+":"+b}
function FormatTime(b){var c=Math.floor(1/36E5*b);b-=36E5*c;var d=Math.floor(1/6E4*b);b=Math.floor(b-6E4*d);return padNN(c)+":"+padNN(d)+":"+padNN(b)}function formatReportId(b){var c="";if(16==b.length){var c=b.substring(0,4),d=b.substring(4,8),e=b.substring(8,12);b=b.substring(12);c=c+"-"+d+"-"+e+"-"+b}return c}
var dispatchRedrawGrid,columnInfo=[{s:"MG",hidden:!0},{s:"Int",width:40},{s:"Player",linkStyle:!0},{s:"City",linkStyle:!0},{s:"Cont",width:40},{s:"Coords",hidden:!0,linkStyle:!0},{s:"Time",width:120},{s:"Attacker",linkStyle:!0},{s:"AttAlli",linkStyle:!0},{s:"AttCity",linkStyle:!0},{s:"AttCoords",hidden:!0,linkStyle:!0},{s:"Spotted",width:120},{s:"Baron",width:60},{s:"SE",width:60},{s:"Infantry",width:60},{s:"Cav",width:60},{s:"Scout",width:60},{s:"Ship",width:60},{s:"TravelT",width:120},{s:"AttackTS"},
{s:"DefendTs"}];
qx.Class.define("ava.IncomingAttacksWindow",{type:"singleton",extend:qx.ui.window.Window,construct:function(){this.base(arguments,"Alliance Incoming Attacks");this.buildUI();this.addListener("appear",this.onOpen,this);this.addListener("disappear",this.onClose,this)},members:{_filterOwn:null,serverTime:null,_table:null,_contSelect:null,_incomingAttacks:[],_outgoingAttacks:[],_allianceBonuses:[],onClose:function(){removeConsumerX("ALL_AT",this.dispatchResults,this)},getAllianceBonuses:function(){webfrontend.net.CommandManager.getInstance().sendCommand("AllianceGetRange",{start:0,
end:1E3,continent:-1,sort:7,ascending:!0,type:2},this,function(b,c){if(b&&null!=c)for(var d=c.length,e=0;e<d;++e){var f=c[e],g=c[e].i.toString(),h=Number(f.cp)/2;this._allianceBonuses[g]={};this._allianceBonuses[g].ics=Math.min(h,50);h=Number(f.op)/2;this._allianceBonuses[g].sse=Math.min(h,50);h=Number(f.sp)/2;this._allianceBonuses[g].b=Math.min(h,50);this._allianceBonuses[g].n=f.n;this._allianceBonuses[g].at=f.at}})},onOpen:function(){this.getAllianceBonuses();addConsumerX("ALL_AT",this.dispatchResults,
this,"a")},buildUI:function(){this.getAllianceBonuses();qx.core.Init.getApplication();this.serverTime=webfrontend.data.ServerTime.getInstance();var b=webfrontend.data.Player.getInstance().getName();this.setLayout(new qx.ui.layout.VBox(10));this.set({allowMaximize:!0,allowMinimize:!0,showMaximize:!0,showMinimize:!0,showStatusbar:!0,showClose:!0,contentPadding:5,useMoveFrame:!0,resizable:!0});dispatchRedrawGrid=new qx.util.DeferredCall(this.redrawGrid,this);console.log("incoming build ui");var c=new qx.ui.tabview.TabView,
d=new qx.ui.tabview.Page("Incoming Grid","");d.setLayout(new qx.ui.layout.VBox);var e=new qx.ui.container.Composite;e.setLayout(new qx.ui.layout.HBox(5));e.set({width:1200});d.add(e);this._filterOwn=new qx.ui.form.CheckBox("Show only my cities");this._filterOwn.setToolTipText("Show only my cities");this._filterOwn.initValue(!1);e.add(this._filterOwn);this._filterOwn.addListener("changeValue",function(){paDebug("change Value1");dispatchRedrawGrid.schedule()});this._contSelect=new qx.ui.form.SelectBox;
this._contSelect.setMaxWidth(100);e.add(this._contSelect);this._contSelect.setMaxWidth(300);this._contSelect.addListener("changeValue",function(){paDebug("change Value2");dispatchRedrawGrid.schedule()});this._table=new qx.ui.table.model.Simple;e=columnInfo.map(function(b){return b.s});this._table.setColumnIds(e);this._table.setColumns(e);this._table.setCaseSensitiveSorting(!1);var e=(new qx.ui.table.Table(this._table)).set({height:400}),f=new qx.ui.table.cellrenderer.Conditional;f.addRegex("^[\\?]",
"center","blue","text-decoration:underline","normal",null);(new qx.ui.table.cellrenderer.Conditional).addRegex("[!]","center","blue","text-decoration:underline","normal",null);var g=new qx.ui.table.cellrenderer.Image,h=new qx.ui.table.cellrenderer.Default;h.setDefaultCellStyle("text-decoration:underline;color:blue");for(var k=e.getTableColumnModel(),l=0;l<columnInfo.length;++l){var m=columnInfo[l];k.setColumnVisible(l,m.hidden?!1:!0);m.linkStyle&&k.setDataCellRenderer(l,h);k.setColumnWidth(l,m.width?
m.width:90)}k.setDataCellRenderer(0,g);k.setDataCellRenderer(17,f);e.onCellClick=function(c){var d=this.getTableModel().getValue(c.getColumn(),c.getRow()),e=c.getColumn(),f=c.getRow();switch(e){case 2:case 7:var g=qx.core.Init.getApplication();g.showInfoPage(g.getPlayerInfoPage(),{name:d});break;case 5:case 10:(new Coord(d)).showOnMap();break;case 3:case 9:c=this.getTableModel().getValue(3==e?5:10,f).toString();(new Coord(c)).showOnMap();break;case 8:qx.core.Init.getApplication().showAllianceInfo(webfrontend.gui.Alliance.Info.MainWindow.tabs.info,
{name:d});break;case 9:d=this.getTableModel().getValue(10,f);d=d.split(":");1<d.length&&(d=convertCoordinatesToId(d[0],d[1]),qx.core.Init.getApplication().showInfoPage(g.getCityInfoPage(),{id:d,onlyCity:!0,showLocation:!0}));break;case 17:if("?"==d){var d=this.getTableModel().getValue(18,c.getRow()),e=this.getTableModel().getValue(2,c.getRow())==b,h=this.getTableModel().getValue(10,c.getRow()),k=this.getTableModel().getValue(5,c.getRow()).split(":"),f=k[0],g=k[1];convertCoordinatesToId(f,g);k=h.split(":");
h=convertCoordinatesToId(k[0],k[1]);k=new Date(this.getTableModel().getValue(6,c.getRow()));c=new Date(this.getTableModel().getValue(11,c.getRow()));c=k.getTime()-c.getTime();c=Math.ceil(c/1E3);0!=Number(f)&&0!=Number(g)&&this.checkForShipAttack(h,f,g,c,e,d)}}};e.checkForShipAttack=this.checkForShipAttack;e.addListener("cellClick",e.onCellClick,e);d.add(e);c.add(d);this.add(c);c=qx.bom.Viewport.getWidth(window);d=qx.bom.Viewport.getHeight(window);this.set({width:c-160,height:Math.floor(0.45*d)})},
refresh:function(){},getRequestDetails:function(b){return"a"},redrawGrid:function(){var b=ava.IncomingAttacksWindow.getInstance();if(!(0>=b._incomingAttacks.length)){var c=[],d=b._table.getSortColumnIndex(),e=b._table.isSortAscending(),f=webfrontend.data.Alliance.getInstance().getId(),g=b._contSelect.getSelection(),g=g&&0<g.length?g[0].getModel():"-1";parseInt(g);for(var h=b._filterOwn.getValue(),k=0;k<b._incomingAttacks.length;k++){var l=b._incomingAttacks[k],m="     ".split(" "),n=0,p=cityIdToCont(l.tc),
q=cityIdToCont(l.c);if(!("-1"!=g&&p!=g||h&&l.tpn!=webfrontend.data.Player.getInstance().getName())){var r=0,n=convertIdToCoordinatesObject(l.c),r=convertIdToCoordinatesObject(l.tc),r=l.m?b.findMoongateDistance(r.x,r.y):getDist(r,n),n=b.serverTime.getStepTime(l.es)-b.serverTime.getStepTime(l.ds),t=n/r/1E3,r=0!=l.ta,u="?";if(r)for(q=0;q<m.length;++q)m[q]="sge:"+l.cp;else try{var s=[8,10,20,30,40],v=[0,0,0,0,0],w=l.a.toString();b._allianceBonuses.hasOwnProperty(w)&&(v[0]=b._allianceBonuses[w].ics,v[1]=
b._allianceBonuses[w].ics,v[2]=b._allianceBonuses[w].ics,v[3]=b._allianceBonuses[w].sse,v[4]=b._allianceBonuses[w].b);for(var y=5,x=0,z=!1,A=0;5>A;++A){var B=100*(60*s[A]-1)/t-v[A];m[A]=99>Math.abs(B)?Math.abs(B).toString()+"%":"--";if(55>B&&-5<B){var C=0<B?B-5*Math.floor(B/5+0.25):-B;Math.abs(C)<y&&(y=Math.abs(C),z=!0,x=A)}}3>y&&(m[x]="0%!");u=p!=q?"*":"?";z||(u=3600>=l.es-l.ds?"-":"?")}catch(E){paError(E)}convertIdToCoordinateString(l.tc);c.push([l.m?"webfrontend/world/icon_wm_city_moongate.png":
"",f==l.a?"Yes":"No",l.tpn,l.tcn,p,convertIdToCoordinateString(l.tc),formatIncomingDate(b.serverTime.getStepTime(l.es)),l.pn,l.an,l.cn,convertIdToCoordinateString(l.c),formatIncomingDate(b.serverTime.getStepTime(l.ds)),m[4],m[3],m[2],m[1],m[0],u,(r?"~":"")+FormatTime(n),l.ta,l.td])}}b._table.setData(c);0<=d&&b._table.sortByColumn(d,e);console.log("redraw Grid leave")}},coordsFromCluster:function(b,c){var d=Math.floor(b/32);return 32*(b-32*d)+(c&65535)|32*d+(c>>16)<<16},findMoongateDistance:function(b,
c){ava.RaidingWindow.getInstance();var d=0;obfuscatedNames.update();var e=webfrontend.data.Server.getInstance().getContinentFromCoords(b,c),f;for(f in obfuscatedNames.worldData.d){var g=safeGetProperty(obfuscatedNames.worldData.d[f][obfuscatedNames.objData],"d");if(g)for(var h in g){var k=g[h];if(4==k.Type&&1<k.eMoongateState)try{var l=this.coordsFromCluster(f,h),k=l&65535,m=l>>16;if(webfrontend.data.Server.getInstance().getContinentFromCoords(k,m)==e){d=Math.sqrt(Math.pow(k-b,2)+Math.pow(m-c,2));
break}}catch(n){paError(n)}}if(0!=d)break}return d},isOnWater:function(b,c){webfrontend.net.CommandManager.getInstance().sendCommand("GetPublicCityInfo",{id:b},c,function(b,c){if(b&&null!=c){var f=convertCoordinatesToId(c.x,c.y);this.cities[f]=c.w}})},cities:null,dispatchResults:function(b,c){if(null!=b){new qx.util.StringBuilder(2048);var d;b.hasOwnProperty("a")?d=b.a:b[0].hasOwnProperty("a")&&(d=b[0].a);c._incomingAttacks=d.slice(0);for(var e="",f=c._contSelect.hasChildren(),g=c._contSelect.getChildren(),
h=c._contSelect.getSelection(),k=0,l=0;l<d.length;++l){var m=padNN(cityIdToCont(d[l].tc));0>e.indexOf(":"+m)&&(e+=":"+m)}d=e.split(":");d.sort();f?(g[0].setLabel("World"),g[0].setModel(-1)):c._contSelect.addAt(new qx.ui.form.ListItem("World",null,-1),0);g=c._contSelect.getChildren();for(f=1;f<d.length;++f)e=d[f],g.length>f?(g[f].setLabel(e),g[f].setModel(e)):(c._contSelect.add(new qx.ui.form.ListItem(e,null,e)),g=c._contSelect.getChildren()),h&&0<h.length&&String(e)==h[0].$$user_label&&(k=f);g.length>
d.length&&c._contSelect.removeAt(d.length-1);c._contSelect.setSelection([g[k]]);c._table.setData([]);dispatchRedrawGrid.schedule()}}}});function GetTogetherName(){var b=webfrontend.data.Player.getInstance().getName();b||(b="NoAvatar");return b}var tjsRoom="AvatarAllianceShagroom",dsqDivId="disqus_thread",dsqWin,tjsUrl="http://togetherjs.com/versions/0.1HOTDISH/togetherjs/togetherjsPackage.js";window.TogetherJSConfig_autoStart=!1;window.TogetherJSConfig_findRoom={prefix:tjsRoom,max:16};
window.TogetherJSConfig_isSamePage=function(){return!0};window.TogetherJSConfig_suppressJoinConfirmation=!0;window.TogetherJSConfig_dontShowClicks=!0;window.TogetherJSConfig_enableAnalytics=!1;window.TogetherJSConfig_siteName="Gossip Central";window.TogetherJSConfig_useMinimizedCode=!0;window.TogetherJSConfig_enableShortcut=!0;window.TogetherJSConfig_toolName="Gossip Central";window.TogetherJSConfig_suppressInvite=!1;window.TogetherJSConfig_disableSessionLoad=!0;window.disqus_shortname="AvatarAlliance";
window.disqus_identifier="AvatarSuiteShagRoom";window.disqus_title="Suite Shag Room";window.disqus_url="http://avatar-alliance.com/source/index.html";function paDebug(b){avaDebug&&window.console&&"function"==typeof console.debug&&console.log(b)}function paError(b){if(window.console&&"function"==typeof console.error){console.error(b);console.trace();debugger}}
qx.Class.define("qx.log.appender.Util",{statics:{toHtml:function(b){var c=[],d,e,f;c.push("<span class='offset'>",this.formatOffset(b.offset,6),"</span> ");b.object?(d=b.win.qx.core.ObjectRegistry.fromHashCode(b.object))&&c.push("<span class='object' title='Object instance with hash code: "+d.$$hash+"'>",d.classname,"[",d.$$hash,"]</span>: "):b.clazz&&c.push("<span class='object'>"+b.clazz.classname,"</span>: ");for(var g=b.items,h=0,k=g.length;h<k;h++)if(d=g[h],e=d.text,e instanceof Array){for(var l=
[],m=0,n=e.length;m<n;m++)f=e[m],"string"===typeof f?l.push("<span>"+this.escapeHTML(f)+"</span>"):f.key?l.push("<span class='type-key'>"+f.key+"</span>:<span class='type-"+f.type+"'>"+this.escapeHTML(f.text)+"</span>"):l.push("<span class='type-"+f.type+"'>"+this.escapeHTML(f.text)+"</span>");c.push("<span class='type-"+d.type+"'>");"map"===d.type?c.push("{",l.join(", "),"}"):c.push("[",l.join(", "),"]");c.push("</span>")}else c.push("<span class='type-"+d.type+"'>"+this.escapeHTML(e)+"</span> ");
d=document.createElement("div");d.innerHTML=c.join("");d.className="level-"+b.level;return d},formatOffset:function(b,c){for(var d=b.toString(),e=(c||6)-d.length,f="",g=0;g<e;g++)f+="0";return f+d},escapeHTML:function(b){return String(b).replace(/[<>&"']/g,this.__escapeHTMLReplace)},__escapeHTMLReplace:function(b){return{"<":"&lt;",">":"&gt;","&":"&amp;","'":"&#39;",'"':"&quot;"}[b]||"?"},toText:function(b){return this.toTextArray(b).join(" ")},toTextArray:function(b){var c=[];c.push(this.formatOffset(b.offset,
6));if(b.object){var d=b.win.qx.core.ObjectRegistry.fromHashCode(b.object);d&&c.push(d.classname+"["+d.$$hash+"]:")}else b.clazz&&c.push(b.clazz.classname+":");b=b.items;for(var e,f=0,g=b.length;f<g;f++)if(d=b[f],e=d.text,d.trace&&0<d.trace.length&&("function"==typeof this.FORMAT_STACK?(qx.log.Logger.deprecatedConstantWarning(qx.log.appender.Util,"FORMAT_STACK","Use qx.dev.StackTrace.FORMAT_STACKTRACE instead"),e+="\n"+this.FORMAT_STACK(d.trace)):e+="\n"+d.trace),e instanceof Array){for(var h=[],
k=0,l=e.length;k<l;k++)h.push(e[k].text);"map"===d.type?c.push("{",h.join(", "),"}"):c.push("[",h.join(", "),"]")}else c.push(e);return c}}});
qx.Class.define("qx.log.appender.Console",{statics:{dsqWin:null,__main:null,__log:null,__cmd:null,__lastCommand:null,init:function(){var b=isChaos();qx.bom.Stylesheet.createElement([".qxconsole{tabindex:1;z-index:9000;width:600px;height:300px;top:59px;right:0px;position:absolute;border-left:1px solid black;color:black;border-bottom:1px solid black;color:black;font-family:Consolas,Monaco,monospace;font-size:11px;line-height:1.2;}.qxconsole .control{background:#cdcdcd;border-bottom:1px solid black;padding:4px 8px;}.qxconsole .control a{text-decoration:none;color:black;}.qxconsole .messages{background:white;height:100%;width:100%;overflow:auto;}.qxconsole .messages div{padding:0px 4px;}.qxconsole .messages .user-command{color:blue}.qxconsole .messages .user-result{background:white}.qxconsole .messages .user-error{background:#FFE2D5}.qxconsole .messages .level-debug{background:white}.qxconsole .messages .level-info{background:#DEEDFA}.qxconsole .messages .level-warn{background:#FFF7D5}.qxconsole .messages .level-error{background:#FFE2D5}.qxconsole .messages .level-user{background:#E3EFE9}.qxconsole .messages .type-string{color:black;font-weight:normal;}.qxconsole .messages .type-number{color:#155791;font-weight:normal;}.qxconsole .messages .type-boolean{color:#15BC91;font-weight:normal;}.qxconsole .messages .type-array{color:#CC3E8A;font-weight:bold;}.qxconsole .messages .type-map{color:#CC3E8A;font-weight:bold;}.qxconsole .messages .type-key{color:#565656;font-style:italic}.qxconsole .messages .type-class{color:#5F3E8A;font-weight:bold}.qxconsole .messages .type-instance{color:#565656;font-weight:bold}.qxconsole .messages .type-stringify{color:#565656;font-weight:bold}.qxconsole .command{background:white;padding:2px 4px;border-top:1px solid black;}.qxconsole .command input{width:100%;border:0 none;font-family:Consolas,Monaco,monospace;font-size:11px;line-height:1.2;}.qxconsole .command input:focus{outline:none;}",b?
".qxconsole .teamspeak div{padding:0px 4px;}":""].join(""));console.log("IsChaos: ",isChaos());var b=['<div  class="qxconsole" id="qxconsole">','<div class="control"><a href="javascript:qx.log.appender.Console.clear()">Clear</a></div>','<div class="messages"></div>','<div class="command"><input type="text"/></div>','<div class="teamspeak">',b?'<iframe src = "http://cache.www.gametracker.com/components/html0/?host=108.61.18.130:7050&bgColor=333333&fontColor=CCCCCC&titleBgColor=222222&titleColor=FF9900&borderColor=555555&linkColor=FFCC00&borderLinkColor=222222&showMap=0&currentPlayersHeight=160&showCurrPlayers=1&showTopPlayers=0&showBlogs=1&width=320" frameborder = "0"  width = "320" height = "600" ></iframe>':
"","</div>","</div>"],c=document.createElement("div");c.id="avaExt";c.innerHTML=b.join("");b=c.children.item("qxconsole");document.body.appendChild(b);this.__main=b;this.__log=b.childNodes[1];this.__cmd=b.childNodes[2].firstChild;this.__onResize();qx.log.Logger.register(this);qx.core.ObjectRegistry.register(this)},dispose:function(){qx.event.Registration.removeListener(document.documentElement,"keypress",this.__onKeyPress,this);qx.log.Logger.unregister(this)},clear:function(){this.__log.innerHTML=
""},process:function(b){this.__log.appendChild(qx.log.appender.Util.toHtml(b));this.__scrollDown()},__scrollDown:function(){this.__log.scrollTop=this.__log.scrollHeight},toggle:function(){this.__main||this.init();if("block"!=this.__main.style.display)return this.show(),!0;this.__main.style.display="none";return!1},show:function(){this.__main?(this.__main.style.display="block",this.__log.scrollTop=this.__log.scrollHeight):this.init()},hide:function(){this.__main&&(this.__main.style.display="none")},
__history:[],execute:function(){var b=this.__cmd.value;if(""!=b)if("clear"==b)this.clear();else{var c=document.createElement("div");c.innerHTML=qx.log.appender.Util.escapeHTML(">>> "+b);c.className="user-command";this.__history.push(b);this.__lastCommand=this.__history.length;this.__log.appendChild(c);this.__scrollDown();try{var d=eval(b)}catch(e){qx.log.Logger.error(e,"hello")}void 0!==d&&qx.log.Logger.debug(d,"bad")}},__onResize:function(b){this.__log.style.height=this.__main.clientHeight-this.__main.firstChild.offsetHeight-
this.__main.lastChild.offsetHeight+"px"},__onKeyPress:function(b){var c=b.getKeyIdentifier();if("F7"==c||"D"==c&&b.isCtrlPressed())this.toggle(),b.preventDefault();this.__main&&qx.dom.Hierarchy.contains(this.__main,b.getTarget())&&("Enter"==c&&""!=this.__cmd.value&&(this.execute(),this.__cmd.value=""),"Up"==c||"Down"==c)&&(this.__lastCommand+="Up"==c?-1:1,this.__lastCommand=Math.min(Math.max(0,this.__lastCommand),this.__history.length),this.__cmd.value=this.__history[this.__lastCommand]||"",this.__cmd.select())}},
defer:function(b){qx.event.Registration.addListener(document.documentElement,"keypress",b.__onKeyPress,b)}});var tjsButton,unitTypes="ballista barge baron berserker catapult cityguard crossbow frigate guardian knight mage paladin ram ranger scout templar wargalleon warlock".split(" "),tjsHideCursor;
function tjsInit(b){var c=document.domain;0<c.indexOf(".")&&(c=c.split(".")[0]);0<c.indexOf("-")&&(c=c.split("-")[0]);tjsHideCursor=avaMain.options.tjsHideCursor;b&&(window.TogetherJSConfig_autoStart=!0);ava.Main.getInstance();window.TogetherJSConfig_ignoreForms=!0;localStorage["togetherjs.settings.avatar"]||(b="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons/units/icon_units_"+unitTypes[Math.round(Math.random()*(unitTypes.length-1))]+".png",console.log(b),localStorage["togetherjs.settings.avatar"]=
'"'+b+'"');b='"'+avaMain.playerName+'"';localStorage["togetherjs.settings.defaultName"]!=b&&(localStorage["togetherjs.settings.defaultName"]=b,localStorage["togetherjs.settings.name"]=b);qx.bom.Stylesheet.createElement(".AvaTogetherJs{z-index:90000;width:32;height:32;top:28px;right:170px;position:absolute;background:transparent}");b=['<div id="AvaTogetherJs" class="AvaTogetherJs">','<button onclick="tjsToggle();  return false;">','<img transparent alt="good times." src="http://benalman.com/code/projects/javascript-emotify/shared/emoticons/Yahoo.AdiumEmoticonset/5.gif" />',
'<img transparent alt="good times." hidden src="http://benalman.com/code/projects/javascript-emotify/shared/emoticons/Yahoo.AdiumEmoticonset/6.gif" />','<img transparent alt="Yea!." hidden  src="http://benalman.com/code/projects/javascript-emotify/shared/emoticons/Yahoo.AdiumEmoticonset/67.gif" />',"</button>",'<button onclick="(qx.log.appender.Console.toggle)();  return false;">','<img transparent alt="fun fun fun." src="http://benalman.com/code/projects/javascript-emotify/shared/emoticons/Yahoo.AdiumEmoticonset/pirate.gif" />',
"</button>",'<button onclick="disqusToggle( );  return false;">','<img transparent alt="happiness." src="http://benalman.com/code/projects/javascript-emotify/shared/emoticons/Yahoo.AdiumEmoticonset/'+Math.floor(115.99999*Math.random())+'.gif"/>',"</button>","</div>"];c=document.createElement("div");c.id="avaExt";c.innerHTML=b.join("");document.body.appendChild(c);tjsButton=document.getElementsByClassName("AvaTogetherJs")[0].firstChild;setTimeout(function(){$(function(){})},1E3)}
function dsqEmbed(){var b=document.createElement("script"),c=function(){var b=document.createElement("script");b.type="text/javascript";b.async=!0;b.src="//"+window.disqus_shortname+".disqus.com/embed.js;";document.body.appendChild(b)}.toString();b.innerHTML="(function"+c.substr(c.indexOf("("))+")()";b.type="text/javascript";document.body.appendChild(b)}
function dsqInit(){var b=qx.bom.Viewport.getWidth(window),c=qx.bom.Viewport.getHeight(window),d=7*b/8,c=31*c/32,b=b/2;dsqWin=new qx.ui.window.Window("Suite Shag Room");dsqWin.setLayout(new qx.ui.layout.Grow);var e=new qx.ui.core.Widget,f=new qx.ui.container.Scroll;f.set({minWidth:b,minHeight:200,width:b,height:c,maxWidth:d,maxHeight:c,allowGrowX:!0,allowGrowY:!0,allowShrinkX:!0,allowShrinkY:!0,allowStretchX:!0,allowStretchY:!0});e.set({minWidth:b,minHeight:8E3,width:b,height:8E3,maxWidth:d,maxHeight:8E3,
allowGrowX:!0,allowGrowY:!1,allowShrinkX:!0,allowShrinkY:!1,allowStretchX:!0,allowStretchY:!1,backgroundColor:15329769});f.add(e);dsqWin.set({zIndex:900010,allowClose:!0,useMoveFrame:!0,useResizeFrame:!0,showStatusbar:!1,movable:!0,allowStretchX:!0,allowStretchY:!0,allowGrowX:!0,allowGrowY:!0,allowShrinkX:!0,allowShrinkY:!0,backgroundColor:15329769,minWidth:b,minHeight:200,width:b,height:200,maxWidth:d,maxHeight:c});dsqWin.add(f);qx.core.Init.getApplication().getDesktop().add(dsqWin,{right:4,bottom:10});
e.getContentElement().setAttribute("id",dsqDivId);d=document.createElement("script");d.async=!0;d.type="text/javascript";d.src="//"+window.disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(d);setTimeout(dsqEmbed,3E3)}function disqusShow(b){dsqWin||dsqInit();if(b)return dsqWin.open(),!0;dsqWin.close();return!1}function disqusToggle(){disqusShow(dsqWin?"visible"!=dsqWin.getVisibility():!0)}var startingTjs;
function tjsRunAgressive(b){var c=tjsButton.children[0],d=tjsButton.children[1],e=tjsButton.children[2];TogetherJS.running?(c.hidden=!0,d.hidden=!1,e.hidden=!0,startingTjs=!1):(c.hidden=1!=b%3,d.hidden=2!=b%3,e.hidden=0!=b%3,0==(b&3)&&TogetherJS(tjsButton),setTimeout(tjsRunAgressive,0==b?1500:3E3,b+1))}
function tjsToggle(){var b=tjsButton.children[0],c=tjsButton.children[1],d=tjsButton.children[2];console.log(TogetherJS.running);console.dir(TogetherJS);startingTjs||(TogetherJS?TogetherJS.running?(b.hidden=!1,c.hidden=!0,d.hidden=!0,TogetherJS(tjsButton)):(startingTjs=!0,tjsRunAgressive(0)):setTimeout(tjsToggle,1E3))}function tjsShow(b){b!=TogetherJS.running&&tjsToggle()}
var TreeHandler=function(){function b(){}b.prototype.getValues=function(b){var d=[];"string"==typeof b||"number"==typeof b||"boolean"==typeof b?d.push(b):"array"==typeof b&&d.push("["+b.join()+"]");return d};b.prototype.getChildren=function(b){return b};return b}(),TreePropType;(function(b){b[b.text=0]="text";b[b.bool=1]="bool";b[b["float"]=2]="float";b[b["int"]=3]="int"})(TreePropType||(TreePropType={}));var treeColumnCount=1;
function createTree(b,c,d){function e(b,d){var e=0;g[d]=b;var f=c.getValues(b),k;for(k in f){var r=f[k];e<treeColumnCount&&(h.setColumnData(d,e+1,r),e+=1)}}function f(b){b=b.getData();var d=c.getChildren(g[b.nodeId]),f;for(f in d){var k=d[f],q=h.addBranch(b.nodeId,f);g[q]=k;e(k,q)}}d=new qx.ui.treevirtual.TreeVirtual(["this"].concat(d.map(function(b){return b.columnName})));d.set({});d.setAlwaysShowOpenCloseSymbol(!0);var g={},h=d.getDataModel(),k=h.addBranch(null,c.root.toString(),!1);e(c.root,k);
h.setData();d.addListener("treeOpenWithContent",f);d.addListener("treeClose",function(b){b=b.getData();h.prune(b,!1)});d.addListener("treeOpenWhileEmpty",f);d.addListener("changeSelection",function(b){b=b.getData();for(var c=0;c<b.length;c++);});b=new qx.ui.window.Window(b);b.setLayout(new qx.ui.layout.Grow);b.set({showMaximize:!0,showMinimize:!0,allowMaximize:!0,maxWidth:qx.bom.Viewport.getWidth(window),maxHeight:qx.bom.Viewport.getHeight(window),width:qx.bom.Viewport.getWidth(window)/2,height:qx.bom.Viewport.getHeight(window)/
3});b.add(d);avaMain.app.desktop.add(b);b.open()}function createObjectTree(b,c,d){"undefined"===typeof d&&(d=[{type:0,columnName:"V"}]);var e=new TreeHandler;e.root=c;createTree(b,e,d)}var requestHandler=function(){function b(b){this.req=b;addConsumerX(b,this.process,this,"a")}b.prototype.process=function(b){removeConsumerX(this.req,this.process,this);createObjectTree("Data",b)};return b}();function treeTest(){}
function createVirtueIntelTree(){webfrontend.net.CommandManager.getInstance().sendCommand("AllianceGetRange",{start:0,end:1E3,continent:-1,sort:7,ascending:!0,type:2},this,function(b,c){var d={};if(b&&null!=c){for(var e=c.length,f=0;f<e;++f){var g=c[f];d[g.n]={baronCap:Math.min(50,0.5*g.sp),offenseBonus:Math.min(50,0.5*g.hp),defenseBonus:Math.min(50,0.5*g.fp),sseBonus:Math.min(50,0.5*g.vp),miscBonus:Math.min(50,0.5*g.up),compasion:g.cp,sacrifice:g.fp,honor:g.hp,justice:g.jp,honesty:g.op,sprituality:g.sp,
humility:g.up,valour:g.vp,compasionPalace:g.c,sacrificePalace:g.f,honorPalace:g.h,justicePalace:g.j,honestyPalace:g.o,spritualityPalace:g.s,humilityPalace:g.u,valourPalace:g.v}}createObjectTree("Virtue Intel",d)}})}var __scheduleTimeOffset=0,priorOnCommandDone;
function hijackSendCommand(){function b(c,d,e){var f=webfrontend.data.City.getInstance(),g=f.getUnitOrders();if(g)for(var h=g.length;0<=--h;){var k=g[h];if(k.city==(new Coord(c.targetCity)).getId()&&k.units[0].count==c.units[0].c&&k.units[0].type==Number(c.units[0].t)&&k.isDelayed){var l=webfrontend.data.ServerTime.getInstance(),m=Number(l.getStepTime(2==c.timeReferenceType?k.start:k.end)),m=c.referenceTimeUTCMillis-m,l=c.referenceTimeUTCMillis-l.getStepTime(l.getServerStep()),m=m-Math.round(l*__slipTime/
__elapsedTime);console.log("slip: "+l/1E3/60/60+" "+l*__slipTime/__elapsedTime/1E3/60);if(-36E5>m){var n=webfrontend.net.CommandManager.getInstance();__scheduleTimeOffset=m;n.sendCommand("CancelUnitOrder",{cityid:f.getId(),id:k.id,isDelayed:k.isDelayed},null,null);c.referenceTimeUTCMillis+=m;var p={obj:d.obj,func:d.func,context:d.g,command:d.b,isReplace:!0};/lordofultima\.com/i.test(document.domain)?(d=new qx.io.remote.Request(n.getCommandService()+"/Service.svc/ajaxEndpoint/OrderUnits","POST","application/json"),
d.setProhibitCaching(!1),d.setRequestHeader("Content-Type","application/json"),d.setData(qx.lang.Json.stringify(c)),d.setTimeout(1E4),d.addListener("completed",n.onCommandDone,p),d.addListener("failed",n.onCommandFail,p),d.addListener("timeout",n.onCommandTimeout,p),d.addListener("aborted",n.onCommandAborted,p),d.send()):GM_xmlhttpRequest({method:"POST",url:n.getCommandService()+"/Service.svc/ajaxEndpoint/OrderUnits",data:qx.lang.Json.stringify(c),timeout:1E4,headers:{"Content-Type":"application/json"},
onerror:n.onCommandFail.bind(p),ontimeout:n.onCommandTimeout.bind(p),onload:function(b){b=""!=b.responseText?qx.lang.Json.parse(b.responseText):{};n.onCommandDone.call(p,b)}});webfrontend.net.UpdateManager.getInstance().pollNow("CITY");return}}}5<e||setTimeout(b,1E3,c,d,e+1)}priorOnCommandDone=webfrontend.net.CommandManager.prototype.onCommandDone;webfrontend.net.CommandManager.prototype.onCommandDone=function(c){if(/OrderUnits/i.test(this.command)&&!this.isReplace&&__slipTime>0.125*__elapsedTime){var d;
d=/lordofultima\.com/i.test(document.domain)?qx.lang.Json.parse(c._target.$$user_data):qx.lang.Json.parse(this.data);if(0<d.referenceTimeUTCMillis&&3==d.timeReferenceType||2==d.timeReferenceType)webfrontend.net.UpdateManager.getInstance().pollNow("CITY"),setTimeout(b,1E3,d,this,0)}priorOnCommandDone.call(this,c)}}
qx.Class.define("ava.ExtraTools",{extend:qx.ui.container.Composite,construct:function(){paDebug("Ava init panel");this.base(arguments);this.buildPanelUI("AvaSuite X."+versionRelNotes.length+"  ")},members:{content:null,closeAvaToolsBtn:null,titleRow:null,cityInfoImg:null,city:null,optionsPage:null,options:null,deleteFoodCityResButton:null,deleteResButton:null,BaronRow:null,MissingResourcesRow:null,reportsButton:null,closestHubButton:null,templatesSelBox:null,getContent:function(){return this.content},
toggleAvaTools:function(){var b="hidden";64!=this.getMaxHeight()?(b="visible",this.closeImage.setSource(webfrontend.config.Config.getInstance().getImagePath("ui/icons/icon_chat_resize.png")),this.closeAvaToolsBtn.setToolTipText("Show Ava Tools"),this.setMaxHeight(64)):(this.closeImage.setSource(webfrontend.config.Config.getInstance().getImagePath("ui/icons/icon_chat_resize_smaller.png")),this.setMaxHeight(242),this.closeAvaToolsBtn.setToolTipText("Hide Ava Tools"));this.showCombatButtonBtn.setVisibility(b);
this.showRaidButtonBtn.setVisibility(b);this.showIncomingAttacksBtn.setVisibility(b);this.AvaToolsOptionsBtn.setVisibility(b);this.showAllianceInfoBtn.setVisibility(b);this.showPalaceItemsBtn.setVisibility(b)},addContent:function(b,c){this.content.add(b,c)},buildPanelUI:function(b){this.setLayout(new qx.ui.layout.Canvas);this.set({marginTop:3,marginBottom:3});this.titleRow=new qx.ui.container.Composite;this.titleRow.setLayout(new qx.ui.layout.HBox(0));this.titleRow.set({width:325});this.add(this.titleRow,
{left:8,top:6});b=new qx.ui.basic.Label(b);b.set({font:"bold",textColor:"#82CC82",paddingTop:2});this.titleRow.add(b);this.content=new qx.ui.container.Composite;this.content.setLayout(new qx.ui.layout.VBox(5));this.content.set({width:322,marginBottom:8});this.add(this.content,{top:35,left:8});paDebug("Ava init panel1x0");this.AvaToolsOptionsBtn=new qx.ui.form.Button("O");this.AvaToolsOptionsBtn.set({visibility:"hidden",appearance:"button-text-small",toolTipText:"Options"});this.AvaToolsOptionsBtn.addListener("execute",
this.showOptionsPage,this);this.titleRow.add(this.AvaToolsOptionsBtn);this.showIncomingAttacksBtn=new qx.ui.form.Button("I");this.showIncomingAttacksBtn.set({visibility:"hidden",width:16,appearance:"button-text-small",toolTipText:"Incoming Attacks Window"});this.showIncomingAttacksBtn.addListener("execute",this.showIncomingAttacks,this);this.titleRow.add(this.showIncomingAttacksBtn);this.showCombatButtonBtn=new qx.ui.form.Button("C");this.showCombatButtonBtn.set({visibility:"hidden",width:16,appearance:"button-text-small",
toolTipText:"Combat/PvP Attack Setup Window"});this.showCombatButtonBtn.addListener("execute",this.showCombatWindow,this);this.titleRow.add(this.showCombatButtonBtn);this.showRaidButtonBtn=new qx.ui.form.Button("R");this.showRaidButtonBtn.set({visibility:"hidden",appearance:"button-text-small",toolTipText:"AvaRaid - for fun and profit"});this.showRaidButtonBtn.addListener("execute",this.showRaidingWindow,this);this.titleRow.add(this.showRaidButtonBtn);/lordofultima\.com/i.test(document.domain)&&(this.showAuthButtonBtn=
new qx.ui.form.Button("Z"),this.showAuthButtonBtn.set({visibility:"visible",appearance:"button-text-small",toolTipText:"Auth here please. (experimental - do not use.)"}),this.showAuthButtonBtn.addListener("execute",authenticateClient,this),this.titleRow.add(this.showAuthButtonBtn));this.showAzExpButtonBtn=b=new qx.ui.form.Button("D");b.set({visibility:"visible",appearance:"button-text-small",toolTipText:"Toggle Disqus (experimental)"});b.addListener("execute",treeTest);this.titleRow.add(this.showAzExpButtonBtn);
this.showConsoleButton=new qx.ui.form.Button(";");this.showConsoleButton.set({visibility:"visible",appearance:"button-text-small",toolTipText:"Show the Javascript Console (experimental)"});this.showConsoleButton.addListener("execute",qx.log.appender.Console,this);this.titleRow.add(this.showConsoleButton);this.showAllianceInfoBtn=new qx.ui.form.Button("A");this.showAllianceInfoBtn.set({visibility:"hidden",appearance:"button-text-small",toolTipText:"Alliance Info"});this.showAllianceInfoBtn.addListener("execute",
this.showAllianceInfo,this);this.titleRow.add(this.showAllianceInfoBtn);this.showMailingListBtn=new qx.ui.form.Button("M");this.showMailingListBtn.set({appearance:"button-text-small",toolTipText:"Mailing Lists Window"});this.showMailingListBtn.addListener("execute",this.showMailingLists,this);this.titleRow.add(this.showMailingListBtn);this.showPalaceItemsBtn=new qx.ui.form.Button("P");this.showPalaceItemsBtn.set({visibility:"hidden",appearance:"button-text-small",toolTipText:"Palace Items Window"});
this.showPalaceItemsBtn.addListener("execute",this.showPalaceItems,this);this.titleRow.add(this.showPalaceItemsBtn);this.aboutAvaToolsBtn=new qx.ui.form.Button("?");this.aboutAvaToolsBtn.set({appearance:"button-text-small",toolTipText:"About AvaSuite"});this.aboutAvaToolsBtn.addListener("execute",this.showHelp,this);this.titleRow.add(this.aboutAvaToolsBtn);this.closeImage=new qx.ui.basic.Image(webfrontend.config.Config.getInstance().getImagePath("ui/icons/icon_chat_resize_smaller.png"));this.closeImage.setWidth(16);
this.closeImage.setHeight(16);this.closeImage.setScale(!0);this.closeImage.setAlignY("middle");this.closeAvaToolsBtn=new qx.ui.form.Button;this.closeAvaToolsBtn.set({width:15,appearance:"button-text-small",toolTipText:"Hide Ava Tools"});this.closeAvaToolsBtn.addListener("click",this.toggleAvaTools,this);this.closeAvaToolsBtn._add(this.closeImage);this.titleRow.add(this.closeAvaToolsBtn);ava.Main.getInstance().options.hideAvaTools&&this.addListenerOnce("appear",function(){ava.Main.getInstance().panel.toggleAvaTools()});
var c=qx.core.Init.getApplication();b=c.getCityInfoView().buildingQueue.header;var d=new qx.ui.form.Button("+");d.set({width:22,appearance:"button-text-small",toolTipText:"Click to Fill build queue"});d.addListener("execute",this.fillBuildingQueue,this);b.add(d,{left:5,top:33});d=new qx.ui.form.Button("#");d.set({width:22,appearance:"button-text-small",toolTipText:"Click to Convert all builds"});d.addListener("execute",this.payBuildingQueue,this);b.add(d,{left:28,top:33});d=new qx.ui.form.Button("-");
d.set({width:22,appearance:"button-text-small",toolTipText:"Click to remove a cottage"});d.addListener("execute",this.removeCottage,this);b.add(d,{left:49,top:33});this.deleteResButton=new qx.ui.form.Button;this.deleteResButton.set({width:22,appearance:"button-text-small",toolTipText:"Click to remove res nodes from the center"});this.deleteResButton.addListener("execute",this.removeCenterRes,this);d=new qx.ui.basic.Image(webfrontend.config.Config.getInstance().getImagePath("ui/icons/icon_playerinfo_townicon_castle_land.png"));
d.setWidth(18);d.setHeight(15);d.setScale(!0);d.setAlignY("middle");this.deleteResButton._add(d);b.add(this.deleteResButton,{left:72,top:33});this.deleteFoodCityResButton=new qx.ui.form.Button;this.deleteFoodCityResButton.set({width:22,appearance:"button-text-small",toolTipText:"Click to remove res nodes for a food city"});this.deleteFoodCityResButton.addListener("execute",this.removeResNode,this);d=new qx.ui.basic.Image(webfrontend.config.Config.getInstance().getImagePath("ui/icons_ressource_voidFood_16.png"));
d.setWidth(16);d.setHeight(15);d.setScale(!0);d.setAlignY("middle");this.deleteFoodCityResButton._add(d);b.add(this.deleteFoodCityResButton,{left:250,top:33});paDebug("Ava init panelx1");b=new qx.ui.container.Composite(new qx.ui.layout.HBox(2));this.optionsPage=new ava.optionsPage;this.addContent(b);b=new qx.ui.container.Composite(new qx.ui.layout.HBox(10));paDebug("Ava init panelx2");d=new qx.ui.form.Button("Options");d.set({width:50,appearance:"button-text-small",toolTipText:"Ava Tools Options"});
d.addListener("click",this.showOptionsPage,this);b.add(d);d=new qx.ui.form.Button("i");d.set({width:20,appearance:"button-text-small",toolTipText:"Incoming attack info"});d.addListener("execute",this.showIncomingAttacks,this);b.add(d);d=new webfrontend.gui.MinisterInfo.Trade;c.ministerInfoWidget={};c.ministerInfoWidget[4]=d;d.addListenerOnce("appear",function(){var b=qx.core.Init.getApplication();if(b.hasOwnProperty("ministerInfoWidget")&&(b=b.ministerInfoWidget[4]._tabView.getChildren(),2<b.length&&
(b=b[2].getChildren(),1<b.length))){var b=b[1].getChildren()[1],c=new qx.ui.container.Composite(new qx.ui.layout.HBox(1)),d=new qx.ui.form.Button("Set hub");d.setToolTipText("Sets trade settings to use the closest city by land in a City Group containing 'hub' in its name with resource amounts selected.");c.add(d);var h=new qx.ui.form.Button("Set res");h.setToolTipText("Sets trade settings to use the amounts selected.");c.add(h);var k=(new qx.ui.form.SelectBox).set({alignY:"middle",tabIndex:1,width:200}),
l=ava.Main.getInstance();l.hubSelBox=k;for(var m=l.options.hubTemplates,n=0;n<m.length;++n){var p=m[n],q=new qx.ui.form.ListItem(p.name,null,n);q.entry=p;k.add(q)}k.setAlignY("middle");c.add(k);ava.Main.getInstance().selBox=k;d.addListener("execute",function(){ava.Main.getInstance().panel.findClosestHub()},k);h.addListener("execute",function(){ava.Main.getInstance().panel.setHubAmounts()},k);b.addAfter(c,b.getChildren()[0]);ava.Main.getInstance().panel.useClosestHubButton=c;l.options.enableClosestHub||
c.setVisibility("excluded")}},d);c=new qx.ui.form.Button("Combat");c.set({width:50,appearance:"button-text-small",toolTipText:"Shows Advanced Commands window."});c.addListener("execute",this.showCombatWindow,this);b.add(c);c=new qx.ui.form.Button("Analysis");c.set({width:50,appearance:"button-text-small",toolTipText:"Analysis"});c.addListener("execute",this.showAnalysisWindow,this);b.add(c);ava.ResAnalysisWindow.getInstance();c=new qx.ui.form.Button("Raid");c.set({width:50,appearance:"button-text-small",
toolTipText:"AvaRaid for fun and profit."});c.addListener("execute",this.showRaidingWindow,this);b.add(c);ava.RaidingWindow.getInstance();this.addContent(b);b=new qx.ui.container.Composite(new qx.ui.layout.HBox(10));this.reportsButton=new qx.ui.form.Button("Alliance");this.reportsButton.set({width:50,appearance:"button-text-small",toolTipText:"Alliance Info"});this.reportsButton.addListener("execute",this.showAllianceInfo,this);b.add(this.reportsButton);this.reportsButton.addListener("execute",this.showAllianceInfo,
this);b.add(this.reportsButton);c=new qx.ui.form.Button("Mail Lists");c.set({width:60,appearance:"button-text-small",toolTipText:"Get alliance mailing lists"});c.addListener("execute",this.showMailingLists,this);b.add(c);c=new qx.ui.form.Button("Send Res");c.set({width:55,appearance:"button-text-small",toolTipText:"Send Resources"});c.addListener("execute",this.showFillWithResources,this);b.add(c);c=new qx.ui.form.Button("Palace");c.set({width:50,appearance:"button-text-small",toolTipText:"Use palace items below your level."});
c.addListener("execute",this.showPalaceItems,this);b.add(c);d=new qx.ui.form.Button("VirtIntel");c.set({width:50,appearance:"button-text-small",toolTipText:"Alliance Virtue related Intel."});d.addListener("execute",createVirtueIntelTree,this);b.add(d);this.addContent(b);this.BaronRow=new qx.ui.container.Composite(new qx.ui.layout.HBox(1));this.BaronLabel=new qx.ui.basic.Label(" ");this.BaronLabel.setRich(!0);this.BaronLabel.setValue('<div style="-moz-transform: scaleX(1);background-image:url(http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/theme/tree/open.png);background-repeat:no-repeat;width:16px;height:16px;font-weight:bold;padding-left:15px;"><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons/units/icon_units_baron.png"  style="align:absmiddle;-moz-transform: scaleX(1); width: 16px; height: 16px; padding-left:4px;" /></div>');
this.BaronLabel.setToolTipText("Total / Current / Recruiting / Available");this.BaronLabel.addListener("click",this.toggleTable);this.BaronRow.add(this.BaronLabel);this.BaronValue=new qx.ui.basic.Label("");this.BaronValue.setRich(!0);this.BaronValue.setValue("<div style='margin-left: 10px;'>0/0/0/0</div>");this.BaronValue.setToolTipText("Total / Current / Recruiting / Available");this.BaronRow.add(this.BaronValue);this.CastleLabel=new qx.ui.basic.Label(" ");this.CastleLabel.setRich(!0);this.CastleLabel.setValue('<div style="-moz-transform: scaleX(1);background-image:url(http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons/icon_playerinfo_townicon_castle_land.png);background-repeat:no-repeat;;width:21px;height:16px;font-weight:bold;margin-left:10px;"></div>');
this.CastleLabel.setToolTipText("Current/Needed");this.BaronRow.add(this.CastleLabel);this.CastleValue=new qx.ui.basic.Label("");this.CastleValue.setRich(!0);b=webfrontend.data.Tech.getInstance().getBonus("baronCount",webfrontend.data.Tech.research)+3;c=Math.floor((b-3)/4)+1;b=webfrontend.data.Player.getInstance();this.CastleValue.setValue("<div style='margin-left: 4px;'>"+b.getNumCastles()+"/"+c+"</div>");this.CastleValue.setToolTipText("Current/Needed");this.BaronRow.add(this.CastleValue);c=webfrontend.data.Alliance.getInstance().getNumOutgoingAttacks();
this.outgoing=new qx.ui.basic.Label("");this.outgoing.setRich(!0);this.outgoing.setValue("<div style='margin-left: 4px;'>Outgoing Attacks: "+c+"</div>");this.BaronRow.add(this.outgoing);this.addContent(this.BaronRow);3<=b.getTitle()&&(this.MissingResourcesRow=new qx.ui.container.Composite(new qx.ui.layout.HBox(1)),this.MissingResourcesValue=new qx.ui.basic.Label(" "),this.MissingResourcesValue.setRich(!0),this.MissingResourcesRow.add(this.MissingResourcesValue),this.addContent(this.MissingResourcesRow));
b=new qx.ui.container.Composite(new qx.ui.layout.HBox(1));c=qx.core.Init.getApplication().cityBar.citiesSelect;c.prevSort=c.getSortedPlayerCities;c=ava.Main.getInstance();citySort=new qx.ui.form.CheckBox("Sort cities by reference");citySort.setToolTipText("Sort cities by reference when checked");citySort.initValue(c.options.sortByReference);citySort.addListener("click",this.toggleCityControls);b.add(citySort);this.addContent(b);c.options.sortByReference&&(citySort.setValue(!0),this.toggleCityControls());
setTimeout(this.updateCurBarons.bind(this),5E3);b=webfrontend.data.Player.getInstance();3<=b.getTitle()&&setTimeout(this.updateNeededResources.bind(this),8E3)},showOptionsPage:function(){var b=qx.core.Init.getApplication().getCurrentOverlay(),b=null!=b?b.basename:"";qx.core.Init.getApplication().switchOverlay("optionsPage"==b?null:this.optionsPage)},setHubAmounts:function(){var b=webfrontend.net.CommandManager.getInstance();webfrontend.data.Player.getInstance();var c=ava.Main.getInstance().selBox.getSelection()[0].entry,
d=webfrontend.net.UpdateManager.getInstance().requester.MAT.obj;d.getCitiesTradeStates();var e=webfrontend.data.City.getInstance().getId(),f=d.getResourceOptions(),g=d.getBDeliverSameTarget(),h=d.getBDisableIncomingTradeRequest(),k=d.getBRequestSameTarget(),l=d.getBDisableOutgoingTradeRequest(),m=d.getBProtectResourcesFromRequests(),n=d.getCartTransportReserveCapacity(),d=d.getShipTransportReserveCapacity();b.sendCommand("CityAutoTradeParamsSet",{cityid:e,autoTradeParams:{dst:g,rst:k,dir:h,dor:l,
r:[{t:1,r:f["1"].requestCityId,s:f["1"].surplusMode,d:f["1"].deliverCityId,p:c.res.wood},{t:2,r:f["2"].requestCityId,s:f["2"].surplusMode,d:f["2"].deliverCityId,p:c.res.stone},{t:3,r:f["3"].requestCityId,s:f["3"].surplusMode,d:f["3"].deliverCityId,p:c.res.iron},{t:4,r:f["4"].requestCityId,s:f["4"].surplusMode,d:f["4"].deliverCityId,p:c.res.food}],ptr:m,rcr:n,rsr:d}},null,function(b,c){})},findClosestHub:function(){for(var b=webfrontend.net.CommandManager.getInstance(),c=webfrontend.data.Player.getInstance(),
d,e=0;e<c.citygroups.length;++e)if(0<=c.citygroups[e].n.toLowerCase().indexOf("hub")&&0<c.citygroups[e].c.length){d=c.citygroups[e].c;break}b.sendCommand("GetDistance",{target:webfrontend.data.City.getInstance().getId()},this,function(e,g){for(var h=0,k=99999,l=0;l<d.length;++l)for(var m=0;m<g.length;++m)g[m].s==d[l]&&0<g[m].l&&g[m].l<k&&(k=g[m].l,h=d[l]);if(0!=h){c.getCities();var k=ava.Main.getInstance().hubSelBox.getSelection()[0].entry,n=webfrontend.net.UpdateManager.getInstance().requester.MAT.obj,
l=n.getResourceOptions(),m=n.getBDeliverSameTarget(),p=n.getBDisableIncomingTradeRequest(),q=n.getBRequestSameTarget(),r=n.getBDisableOutgoingTradeRequest(),t=n.getBProtectResourcesFromRequests(),u=n.getCartTransportReserveCapacity(),n=n.getShipTransportReserveCapacity();b.sendCommand("CityAutoTradeParamsSet",{cityid:webfrontend.data.City.getInstance().getId(),autoTradeParams:{dst:m,rst:q,dir:p,dor:r,r:[{t:1,r:h,s:2,d:h,p:k.res.wood},{t:2,r:q?0:h,s:l["2"].surplusMode,d:m?0:h,p:k.res.stone},{t:3,r:q?
0:h,s:l["3"].surplusMode,d:m?0:h,p:k.res.iron},{t:4,r:q?0:h,s:l["4"].surplusMode,d:m?0:h,p:k.res.food}],ptr:t,rcr:u,rsr:n}},null,function(b,c){})}else h=new qx.ui.window.Window("Set hub"),h.setLayout(new qx.ui.layout.VBox(2)),h.set({showMaximize:!1,showMinimize:!1,allowMaximize:!1,width:150,height:80}),h.lbl=(new qx.ui.basic.Label("No hub found")).set({rich:!0}),h.add(h.lbl),k=new qx.ui.container.Composite(new qx.ui.layout.HBox(2)),h.add(k),l=(new qx.ui.form.Button("Close")).set({appearance:"button-text-small",
width:80,paddingLeft:5,paddingRight:5,paddingTop:0,paddingBottom:0}),l.win=h,k.add(l),l.addListener("click",function(){this.win.hide()}),h.addListener("close",function(){},this),h.center(),h.open()})},removeResNode:function(){this.getCity();var b=webfrontend.data.Player.getInstance().getMaxBuildQueueSize(),c=webfrontend.data.City.getInstance().buildQueue,b=b-(null!=c?c.length:0),c=0,d=500;this.deleteFoodCityResButton.setEnabled(!1);for(var e=0;e<this.city.length&&c<b;e++)this.city[e]&&900<=this.city[e][2]&&
903!=this.city[e][2]&&0==this.city[e][1]&&(this.doInsertInBuildQueue(902==this.city[e][2]?27:901==this.city[e][2]?29:903==this.city[e][2]?30:28,this.city[e][0],d),d+=1E3,++c);window.setTimeout(function(){this.deleteFoodCityResButton.setEnabled(!0)}.bind(this),d)},insertInBuildQueue:function(b,c){webfrontend.net.CommandManager.getInstance().sendCommand("UpgradeBuilding",{cityid:webfrontend.data.City.getInstance().getId(),buildingid:c,buildingtype:b,isPaid:!0},null,function(){})},doInsertInBuildQueue:function(b,
c,d){var e=this;setTimeout(function(){try{e.insertInBuildQueue(b,c)}catch(d){paDebug(d)}},d)},removeCenterRes:function(){this.getCityCenter();var b=webfrontend.data.Player.getInstance().getMaxBuildQueueSize(),c=webfrontend.data.City.getInstance().buildQueue,b=b-(null!=c?c.length:0),c=0,d=500;this.deleteResButton.setEnabled(!1);for(var e=0;e<this.city.length&&c<b;e++)this.city[e]&&900<=this.city[e][2]&&0==this.city[e][1]&&(this.doInsertInBuildQueue(902==this.city[e][2]?27:901==this.city[e][2]?29:903==
this.city[e][2]?30:28,this.city[e][0],d),d+=1E3,++c);window.setTimeout(function(){this.deleteResButton.setEnabled(!0)}.bind(this),d)},removeCottage:function(){this.getCity();for(var b=[],c=!1,d=0;d<this.city.length;d++)this.city[d]&&4==this.city[d][2]&&10>=this.city[d][1]&&-1<this.city[d][1]&&(c||b.push(this.city[d]),23==this.city[d][2]&&(c=!0));0<b.length?(b.sort(function(b,c){return b[1]-c[1]}),webfrontend.net.CommandManager.getInstance().sendCommand("DemolishBuilding",{cityid:webfrontend.data.City.getInstance().getId(),
buildingid:b[0][0]},this,this.sentCommand)):showMsgWindow("Remove Cottage","No cottages Available to remove.")},sentCommand:function(b,c){c||showMsgWindow("Remove","No building queue slots Available.")},getCity:function(){var b=qx.core.Init.getApplication();if("c"==b.visMain.mapmode){var c=b.visMain.cells;if(c[0]){var b=webfrontend.data.City.getInstance(),d=b.getOnWater(),e=[],f;for(f in c){var g=c[f].entities,h;for(h in g)"CityWallLevel"!=g[h].basename&&"CityObject"!=g[h].basename&&(null!=g[h].selectNode2&&
null!=g[h].selectNode3?(880>g[h].selectNode.getY()?e.push([g[h],256*g[h].selectNode2.getY()+g[h].selectNode2.getX()+1,g[h].visId]):e.push([g[h],256*g[h].selectNode3.getY()+g[h].selectNode3.getX()+1,g[h].visId]),e.push([g[h],256*g[h].selectNode.getY()+g[h].selectNode.getX(),g[h].visId]),e.push([g[h],256*g[h].selectNode.getY()+g[h].selectNode.getX()+1,g[h].visId]),e.push([g[h],256*g[h].selectNode2.getY()+g[h].selectNode2.getX(),g[h].visId]),e.push([g[h],256*g[h].selectNode3.getY()+g[h].selectNode3.getX(),
g[h].visId])):(g[h].getType&&51<g[h].getType()&&60>g[h].getType()&&(e.push([g[h],256*g[h].selectNode.getY()+g[h].selectNode.getX()+1,g[h].visId]),e.push([g[h],256*g[h].selectNode.getY()+g[h].selectNode.getX()+2,g[h].visId]),e.push([g[h],256*(g[h].selectNode.getY()+80)+g[h].selectNode.getX(),g[h].visId]),e.push([g[h],256*(g[h].selectNode.getY()+80)+g[h].selectNode.getX()+1,g[h].visId]),e.push([g[h],256*(g[h].selectNode.getY()+80)+g[h].selectNode.getX()+2,g[h].visId]),e.push([g[h],256*(g[h].selectNode.getY()+
160)+g[h].selectNode.getX(),g[h].visId]),e.push([g[h],256*(g[h].selectNode.getY()+160)+g[h].selectNode.getX()+1,g[h].visId]),e.push([g[h],256*(g[h].selectNode.getY()+160)+g[h].selectNode.getX()+2,g[h].visId])),e.push([g[h],256*g[h].selectNode.getY()+g[h].selectNode.getX(),g[h].visId])))}e.sort(function(b,c){return b[1]-c[1]});console.debug("helllo");this.city=Array(441);h=[0,1,19,20,21,41,399,419,420,421,439,440];f=[352,353,373,374,375,395,396,397,398,417,418,438];for(c=0;c<this.city.length;c++)this.city[c]=
null;for(c=0;c<h.length;c++)this.city[h[c]]=[-1,-1,-1];if(d)for(h=0;h<f.length;h++)this.city[f[h]]=[-1,-1,-2];try{for(h=f=0;h<e.length;h++){for(;null!=this.city[f];)f++;void 0!=e[h][0].getResType?this.city[f]=[e[h][0].getId(),this.checkBuilding(e[h][0].getId()),e[h][0].getResType()+900]:void 0!=e[h][0].getType?this.city[f]=void 0!=e[h][0].getLevel?[e[h][0].getId(),e[h][0].getLevel()+this.checkBuilding(e[h][0].getId()),e[h][0].getType()]:[e[h][0].getId(),b.getWallLevel()+this.checkBuilding("wall"),
e[h][0].getType()]:void 0!=e[h][0].getPlaceId&&(null!=e[h][0].drawNode?void 0!=e[h][0].drawNode.image?-1!=e[h][0].drawNode.image.indexOf("tower")?this.city[f]=[e[h][0].getPlaceId(),0,99]:this.city[f]=[e[h][0].getPlaceId(),0,98]:"EffectNode"==e[h][0].drawNode.basename&&(this.city[f]=[e[h][0].getPlaceId(),0,99]):d&&/\b(331|332|351|354|372|376|394|416)\b/.test(f)?this.city[f]=[e[h][0].getPlaceId(),0,97]:this.city[f]=[e[h][0].getPlaceId(),0,98])}for(h=0;h<this.city.length;h++)if(null==this.city[h]){this.city=
Array(441);window.setTimeout(function(){ava.Main.getInstance().panel.getCity()},1E3);return}this.cityId=b.getId()}catch(k){paDebug(k)}}else window.setTimeout(function(){ava.Main.getInstance().panel.getCity()},1E3)}},getCityCenter:function(){var b=qx.core.Init.getApplication();if("c"==b.visMain.mapmode){var c=b.visMain.cells;if(c[0]){var b=webfrontend.data.City.getInstance(),d=b.getOnWater(),e=[],f;for(f in c){var g=c[f].entities,h;for(h in g)"CityWallLevel"!=g[h].basename&&"CityObject"!=g[h].basename&&
(null!=g[h].selectNode2&&null!=g[h].selectNode3?(880>g[h].selectNode.getY()?e.push([g[h],256*g[h].selectNode2.getY()+g[h].selectNode2.getX()+1,g[h].visId]):e.push([g[h],256*g[h].selectNode3.getY()+g[h].selectNode3.getX()+1,g[h].visId]),e.push([g[h],256*g[h].selectNode.getY()+g[h].selectNode.getX(),g[h].visId]),e.push([g[h],256*g[h].selectNode.getY()+g[h].selectNode.getX()+1,g[h].visId]),e.push([g[h],256*g[h].selectNode2.getY()+g[h].selectNode2.getX(),g[h].visId]),e.push([g[h],256*g[h].selectNode3.getY()+
g[h].selectNode3.getX(),g[h].visId])):(g[h].getType&&51<g[h].getType()&&60>g[h].getType()&&(e.push([g[h],256*g[h].selectNode.getY()+g[h].selectNode.getX()+1,g[h].visId]),e.push([g[h],256*g[h].selectNode.getY()+g[h].selectNode.getX()+2,g[h].visId]),e.push([g[h],256*(g[h].selectNode.getY()+80)+g[h].selectNode.getX(),g[h].visId]),e.push([g[h],256*(g[h].selectNode.getY()+80)+g[h].selectNode.getX()+1,g[h].visId]),e.push([g[h],256*(g[h].selectNode.getY()+80)+g[h].selectNode.getX()+2,g[h].visId]),e.push([g[h],
256*(g[h].selectNode.getY()+160)+g[h].selectNode.getX(),g[h].visId]),e.push([g[h],256*(g[h].selectNode.getY()+160)+g[h].selectNode.getX()+1,g[h].visId]),e.push([g[h],256*(g[h].selectNode.getY()+160)+g[h].selectNode.getX()+2,g[h].visId])),e.push([g[h],256*g[h].selectNode.getY()+g[h].selectNode.getX(),g[h].visId])))}e.sort(function(b,c){return b[1]-c[1]});this.city=Array(441);h=[0,1,19,20,21,41,399,419,420,421,439,440];f=[352,353,373,374,375,395,396,397,398,417,418,438];for(c=0;c<this.city.length;c++)this.city[c]=
null;for(c=0;c<h.length;c++)this.city[h[c]]=[-1,-1,-1];if(d)for(h=0;h<f.length;h++)this.city[f[h]]=[-1,-1,-2];try{for(h=f=0;h<e.length;h++){for(;null!=this.city[f];)f++;if(void 0!=e[h][0].getResType){var k=e[h][0].selectNode.getX(),l=e[h][0].selectNode.getY();this.city[f]=480<l&&1280>l&&768<k&&2048>k?[e[h][0].getId(),this.checkBuilding(e[h][0].getId()),e[h][0].getResType()+900]:[e[h][0].getId(),0,0]}else void 0!=e[h][0].getType?this.city[f]=void 0!=e[h][0].getLevel?[e[h][0].getId(),e[h][0].getLevel()+
this.checkBuilding(e[h][0].getId()),e[h][0].getType()]:[e[h][0].getId(),b.getWallLevel()+this.checkBuilding("wall"),e[h][0].getType()]:void 0!=e[h][0].getPlaceId&&(null!=e[h][0].drawNode?void 0!=e[h][0].drawNode.image?-1!=e[h][0].drawNode.image.indexOf("tower")?this.city[f]=[e[h][0].getPlaceId(),0,99]:this.city[f]=[e[h][0].getPlaceId(),0,98]:"EffectNode"==e[h][0].drawNode.basename&&(this.city[f]=[e[h][0].getPlaceId(),0,99]):d&&/\b(331|332|351|354|372|376|394|416)\b/.test(f)?this.city[f]=[e[h][0].getPlaceId(),
0,97]:this.city[f]=[e[h][0].getPlaceId(),0,98])}for(h=0;h<this.city.length;h++)if(null==this.city[h]){this.city=Array(441);window.setTimeout(function(){ava.Main.getInstance().panel.getCityCenter()},1E3);break}}catch(m){paDebug(m)}}else window.setTimeout(function(){ava.Main.getInstance().panel.getCity()},1E3)}},checkBuilding:function(b){try{var c=webfrontend.data.City.getInstance().getBuildQueue(),d=0;if(null!=c)for(var e=0;e<c.length;e++){if(c[e].building==b&&(2==c[e].state||5==c[e].state))return-11;
c[e].building==b&&d++;23==c[e].type&&"wall"==b&&d++}}catch(f){paDebug(f)}return d},update:function(b,c){this.updateContent(b,c)},findObject:function(b,c,d){d=d||!1;for(var e in b){if(b[e]instanceof c)return b[e];if(d&&"object"==typeof b[e]){var f=this.findObject(b[e],c,d);if(null!=f)return f}}return null},toggleCityControls:function(){citySort.getValue()?qx.core.Init.getApplication().cityBar.citiesSelect.getSortedPlayerCities=function(){var b=this.prevSort();b.sort(function(b,d){return b.city.reference!=
d.city.reference?b.city.reference.toUpperCase()<d.city.reference.toUpperCase()?-1:1:b.iId<d.iId?-1:1});return b}:qx.core.Init.getApplication().cityBar.citiesSelect.getSortedPlayerCities=function(){return this.prevSort()};qx.core.Init.getApplication().cityBar.citiesSelect.fillCityItems()},toggleTable:function(){var b=ava.Main.getInstance().panel;if(3<=webfrontend.data.Player.getInstance().getTitle()){var c=b.MissingResourcesValue.getValue();0<=b.BaronLabel.getValue().indexOf("open")?(b.BaronLabel.setValue('<div style="-moz-transform: scaleX(1);background-image:url(resource/webfrontend/theme/tree/closed.png);background-repeat:no-repeat;width:16px;height:16px;font-weight:bold;padding-left:15px;"><img src="resource/webfrontend/ui/icons/units/icon_units_baron.png"  style="align:absmiddle;-moz-transform: scaleX(1); width: 16px; height: 16px; padding-left:4px;" /></div>'),
b.MissingResourcesValue.setValue(c.replace("margin-left: 5px","display:none;margin-left: 5px"))):(b.BaronLabel.setValue('<div style="-moz-transform: scaleX(1);background-image:url(resource/webfrontend/theme/tree/open.png);background-repeat:no-repeat;width:16px;height:16px;font-weight:bold;padding-left:15px;"><img src="resource/webfrontend/ui/icons/units/icon_units_baron.png"  style="align:absmiddle;-moz-transform: scaleX(1); width: 16px; height: 16px; padding-left:4px;" /></div>'),b.MissingResourcesValue.setValue(c.replace("display:none;margin-left: 5px",
"margin-left: 5px")))}},updateCurBarons:function(){var b=ava.Main.getInstance().panel,c=webfrontend.data.Player.getInstance(),d=webfrontend.data.Tech.getInstance(),e=c.getBarons(),f=c.getBaronsIdle(),g=c.getBaronsQueue(),h=d.getBonus("baronCount",webfrontend.data.Tech.research)-(c.getNumCities()-1+f+g);b.BaronValue.setValue("<div style='margin-left: 10px;'>"+e+"/"+f+"/"+g+"/"+h+"</div>");d=d.getBonus("baronCount",webfrontend.data.Tech.research)+3;d=Math.floor((d-3)/4)+1;b.CastleValue.setValue("<div style='margin-left: 4px;'>"+
c.getNumCastles()+"/"+d+"</div>");c=webfrontend.data.Alliance.getInstance().getNumOutgoingAttacks();b.outgoing.setValue("<div style='margin-left: 4px;'>Outgoing Attacks: "+c+"</div>");setTimeout(this.updateCurBarons.bind(this),8E3)},formatNumber:function(b){b=String(b).replace(/\,/g,"");var c=b.indexOf(".");0<=c&&(b=b.substring(0,c));if(0==b.length)return"";for(var c="",d=0,e=b.length;d<e;++d)0<c.length&&0==(b.length-d)%3&&(c+=","),c+=b.substring(d,d+1);return c},updateNeededResources:function(){var b=
ava.Main.getInstance().panel,c=webfrontend.data.Player.getInstance(),d=c.getTitle(),e,f;null==f&&(f=webfrontend.data.Tech.getInstance());var g=f.getBonus("baronCount",webfrontend.data.Tech.research)+3;if(3<=d){var h=c.getVoidResources();if(h){d=c.getGold();f.getBonus("baronCount",webfrontend.data.Tech.research);for(var k=c.getTechTree(),l=0;l<k.length;l++){var m=f.getTreeInfoByStepId(k[l]);if(40==m.tree){m.level+=2;var n=f.getStepInfoByTreeId(40,m.level);e=n.data.g;n=n.data.r[5]}}f=Math.floor((g-
3)/4)+1;var c=c.getNumCastles(),k=new qx.util.StringBuilder(200),l=this.MissingResourcesValue.getValue(),m=4*n+e/1E3,p=Math.min(n,h[3][1])+Math.min(n,h[2][1])+Math.min(n,h[1][1])+Math.min(n,h[0][1])+Math.min(e/1E3,d/1E3),m=Math.floor(100*Math.min(100,p/m*100))/100,p=h[3][1],q=h[2][1],r=h[1][1],h=h[0][1],t=Math.max(0,n-p),u=Math.max(0,n-q),s=Math.max(0,n-r),n=Math.max(0,n-h);e=Math.max(0,e-d);0==(g-5)%4?c>=f?k.add("<span style='v-align: middle'>Free</span>"):(k.add(String(f-c)," more castles or "),
0<l.indexOf("display:none")?k.add('<table style="display:none;margin-left: 5px; max-width: 322px; border:1px dotted  #8B693E;" cellspacing="0">'):k.add('<table style="margin-left: 5px;max-width: 322px; border:1px dotted  #8B693E;" cellspacing="0">'),k.add('<tbody><tr alt="PR needed for TA ('+m+'%)" title="PR needed for TA ('+m+'%)">'),k.add('<td style=\'padding: 3px;border-bottom:1px dotted  #8B693E;\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_voidWood_16.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+
this.formatNumber(t)+"</td>"),k.add('<td style=\'padding: 3px;border-bottom:1px dotted  #8B693E;\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_voidStone_16.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+this.formatNumber(u)+"</td>"),k.add('<td style=\'padding: 3px;border-bottom:1px dotted  #8B693E;\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_voidIron_16.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+
this.formatNumber(s)+"</td>"),k.add('<td style=\'padding: 3px;border-bottom:1px dotted  #8B693E;\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_voidFood_16.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+this.formatNumber(n)+"</td>"),k.add('<td style=\'padding: 3px;border-bottom:1px dotted #8B693E;\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_gold.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+
this.formatNumber(e)+"</td>"),k.add("</tr><tr>"),k.add("<td style='padding: 3px;' alt='"+this.formatNumber(p)+"' title='"+this.formatNumber(p)+'\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_voidWood_16.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+(1E6<p?"> 1 mio.":this.formatNumber(p))+"</td>"),k.add("<td style='padding: 3px;' alt='"+this.formatNumber(q)+"' title='"+this.formatNumber(q)+
'\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_voidStone_16.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+(1E6<q?"> 1 mio.":this.formatNumber(q))+"</td>"),k.add("<td style='padding: 3px; alt='"+this.formatNumber(r)+"' title='"+this.formatNumber(r)+'\'\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_voidIron_16.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+
(1E6<r?"> 1 mio.":this.formatNumber(r))+"</td>"),k.add("<td style='padding: 3px; alt='"+this.formatNumber(h)+"' title='"+this.formatNumber(h)+'\'\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_voidFood_16.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+(1E6<h?"> 1 mio.":this.formatNumber(h))+"</td>"),k.add("<td style='padding: 3px; alt='"+this.formatNumber(d)+"' title='"+this.formatNumber(d)+
'\'\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_gold.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+(1E9<d?"> 1 bio.":this.formatNumber(d))+"</td>"),k.add("</tr></tbody></table>")):(0<l.indexOf("display:none")?k.add('<table style="display:none;margin-left: 5px;border:1px dotted #8B693E;" cellspacing="0">'):k.add('<table style="margin-left: 5px;max-width: 322px; border:1px dotted #8B693E;" cellspacing="0">'),
k.add('<tbody><tr alt="PR needed for TA ('+m+'%)" title="PR needed for TA ('+m+'%)">'),k.add('<td style=\'padding: 3px;border-bottom:1px dotted  #8B693E;\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_voidWood_16.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+this.formatNumber(t)+"</td>"),k.add('<td style=\'padding: 3px;border-bottom:1px dotted  #8B693E;\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_voidStone_16.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+
this.formatNumber(u)+"</td>"),k.add('<td style=\'padding: 3px;border-bottom:1px dotted  #8B693E;\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_voidIron_16.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+this.formatNumber(s)+"</td>"),k.add('<td style=\'padding: 3px;border-bottom:1px dotted  #8B693E;\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_voidFood_16.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+
this.formatNumber(n)+"</td>"),k.add('<td style=\'padding: 3px;border-bottom:1px dotted #8B693E;\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_gold.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+this.formatNumber(e)+"</td>"),k.add("</tr><tr>"),k.add("<td style='padding: 3px;' alt='"+this.formatNumber(p)+"' title='"+this.formatNumber(p)+'\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_voidWood_16.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+
(1E6<p?"> 1 mio.":this.formatNumber(p))+"</td>"),k.add("<td style='padding: 3px;' alt='"+this.formatNumber(q)+"' title='"+this.formatNumber(q)+'\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_voidStone_16.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+(1E6<q?"> 1 mio.":this.formatNumber(q))+"</td>"),k.add("<td style='padding: 3px; alt='"+this.formatNumber(r)+"' title='"+this.formatNumber(r)+
'\'\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_voidIron_16.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+(1E6<r?"> 1 mio.":this.formatNumber(r))+"</td>"),k.add("<td style='padding: 3px; alt='"+this.formatNumber(h)+"' title='"+this.formatNumber(h)+'\'\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_voidFood_16.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+
(1E6<h?"> 1 mio.":this.formatNumber(h))+"</td>"),k.add("<td style='padding: 3px; alt='"+this.formatNumber(d)+"' title='"+this.formatNumber(d)+'\'\'><img src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/ui/icons_ressource_gold.png" style="align:absmiddle;-moz-transform: scaleX(1); width: 10px; height: 10px; padding-right:2px;">'+(1E9<d?"> 1 bio.":this.formatNumber(d))+"</td>"),k.add("</tr></tbody></table>"));b.MissingResourcesValue.setValue(k.get())}}setTimeout(this.updateNeededResources.bind(this),
3E4)},showIncomingAttacks:function(){ava.IncomingAttacksWindow.getInstance().show()},fillBuildingQueue:function(){var b=webfrontend.data.City.getInstance();webfrontend.net.CommandManager.getInstance().sendCommand("BuildingQueueFill",{cityid:b.getId()},null,function(b){})},payBuildingQueue:function(){var b=webfrontend.data.City.getInstance();webfrontend.net.CommandManager.getInstance().sendCommand("BuildingQueuePayAll",{cityid:b.getId()},null,function(){})},showCombatWindow:function(){var b=ava.CombatWindow.getInstance();
b.center();b.open()},showHelp:function(){resetVersion();updateVersion()},showFillWithResources:function(){var b=ava.FillWithResourcesWindow.getInstance();b.buildUI();b.center();b.show()},showAllianceInfo:function(){var b=ava.LastLogin.getInstance();b.center();b.show()},showReports:function(){var b=ava.PlayerReportsWindow.getInstance();b.center();b.show()},showPalaceItems:function(){var b=ava.PalaceItemsWindow.getInstance();setTimeout(function(){b.show();b.moveTo(500,200)},500)},showMailingLists:function(){var b=
ava.AllianceMailingListWindow.getInstance();b.center();b.show()},showAnalysisWindow:function(){var b=ava.PlayerReportsWindow.getInstance();b.center();b.show()},showRaidingWindow:function(){var b=ava.RaidingWindow.getInstance();qx.bom.Viewport.getWidth(window);qx.bom.Viewport.getHeight(window);b.show()}}});function serializeQuery(b){var c=[],d;for(d in b)c.push(d+"="+b[d]);return c.join("&")}
var EMOTICON_RE,lookup=[],emoticons={},emotifyEmoticons=function(b,c){var d,e=[],f,g;if(c){for(d in c)c.hasOwnProperty(d)&&(emoticons[d]=c[d],emoticons[d][0]=b+emoticons[d][0]);for(d in emoticons)if(emoticons.hasOwnProperty(d)){if(2<emoticons[d].length){f=emoticons[d].slice(2).concat(d);for(g=f.length;g--;)f[g]=f[g].replace(/(\W)/g,"\\$1");f=f.join("|");lookup.push({name:d,regexp:RegExp("^"+f+"$")})}else f=d.replace(/(\W)/g,"\\$1");e.push(f)}EMOTICON_RE=RegExp("(^|\\s)("+e.join("|")+")(?=(?:$|\\s))",
"g")}return emoticons},emotify=function(b,c){c=c||function(b,c,f,g){c=(c+", "+f).replace(/"/g,"&quot;").replace(/</g,"&lt;");return'<img src="'+b+'" title="'+c+'" alt="" class="smiley" style="vertical-align: -20%;"/>'};return b.replace(EMOTICON_RE,function(b,e,f){var g=0,h=f,k=emoticons[f];if(!k){for(;g<lookup.length&&!lookup[g].regexp.test(f);)g++;h=lookup[g].name;k=emoticons[h]}return k?e+c(k[0],k[1],h,f):b})},emotifyIcons=function(){emotifyEmoticons("http://benalman.com/code/projects/javascript-emotify/shared/emoticons/Yahoo.AdiumEmoticonset/",
{">:)":"19.gif devil >:-) &gt;:-) &gt;:) :]".split(" "),":)":"1.gif happy :-) *g *g* *G *G*".split(" "),":(":["2.gif","sad",":-(",":/"],";)":["3.gif","winking",";-)"],":D":"4.gif;big grin;xD;:-D;*gg*;gg;GG;*GG*".split(";"),";;)":["5.gif","batting eyelashes"],">:D<":["6.gif","big hug","&gt;:D&lt;",":DD","xDD"],":-/":["7.gif","confused",":/"],":x":["8.gif","love struck",":X"],':">':["9.gif","blushing",':"&gt;'],":P":["10.gif","tongue",":p",":-p",":-P"],":-*":["11.gif","kiss",":*"],"=((":["12.gif","broken heart"],
":-O":["13.gif","surprise",":O","*huh*"],"X(":["14.gif","angry"],":>":["15.gif","smug",":&gt;"],"B-)":["16.gif","cool"],":-S":["17.gif","worried"],"#:-S":["18.gif","whew!","#:-s"],":((":["20.gif","crying",":-((",":'(",":'-("],":))":["21.gif","laughing",":-))"],":|":["22.gif","straight face",":-|"],"/:)":["23.gif","raised eyebrow","/:-)"],"=))":["24.gif","rolling on the floor"],"O:-)":["25.gif","angel","O:)"],":-B":["26.gif","nerd"],"=;":["27.gif","talk to the hand"],"I-)":["28.gif","sleepy"],"8-|":["29.gif",
"rolling eyes"],"L-)":["30.gif","loser"],":-&":["31.gif","sick"],":-$":["32.gif","don't tell anyone"],"[-(":["33.gif","not talking"],":O)":["34.gif","clown"],"8-}":["35.gif","silly","8}","8)"],"<:-P":["36.gif","party","<:-p","&lt;:-P","&lt;:-p"],"(:|":["37.gif","yawn"],"=P~":["38.gif","drooling"],":-?":["39.gif","thinking"],"#-o":["40.gif","d'oh","#-O"],"=D>":["41.gif","applause","=D&gt;"],":-SS":["42.gif","nailbiting",":-ss"],"@-)":["43.gif","hypnotized"],":^o":["44.gif","liar"],":-w":["45.gif",
"waiting",":-W"],":-<":["46.gif","sigh",":-&lt;"],">:P":["47.gif","phbbbbt",">:p","&gt;:P","&gt;:p"],"<):)":["48.gif","cowboy","&lt;):)"],":@)":["49.gif","pig"],"3:-O":["50.gif","cow","3:-o"],":(|)":["51.gif","monkey"],"~:>":["52.gif","chicken","~:&gt;"],"@};-":["53.gif","rose"],"%%-":["54.gif","good luck"],"**==":["55.gif","flag"],"(~~)":["56.gif","pumpkin"],"~O)":["57.gif","coffee"],"*-:)":["58.gif","idea"],"8-X":["59.gif","skull"],"=:)":["60.gif","bug"],">-)":["61.gif","alien","&gt;-)"],":-L":["62.gif",
"frustrated",":L"],"[-O<":["63.gif","praying","[-O&lt;"],"$-)":["64.gif","money eyes"],':-"':["65.gif","whistling"],"b-(":["66.gif","feeling beat up"],":)>-":["67.gif","peace sign",":)&gt;-"],"[-X":["68.gif","shame on you"],"\\:D/":["69.gif","dancing"],">:/":["70.gif","bring it on","&gt;:/"],";))":["71.gif","hee hee"],"o->":["72.gif","hiro","o-&gt;"],"o=>":["73.gif","billy","o=&gt;"],"o-+":["74.gif","april"],"(%)":["75.gif","yin yang"],":-@":["76.gif","chatterbox"],"^:)^":["77.gif","not worthy"],
":-j":["78.gif","oh go on"],"(*)":["79.gif","star"],":)]":["100.gif","on the phone"],":-c":["101.gif","call me"],"~X(":["102.gif","at wits' end"],":-h":["103.gif","wave"],":-t":["104.gif","time out"],"8->":["105.gif","daydreaming","8-&gt;"],":-??":["106.gif","I don't know"],"%-(":["107.gif","not listening"],":o3":["108.gif","puppy dog eyes"],X_X:["109.gif","I don't want to see","x_x"],":!!":["110.gif","hurry up!"],"\\m/":["111.gif","rock on!"],":-q":["112.gif","thumbs down"],":-bd":["113.gif","thumbs up"],
"^#(^":["114.gif","it wasn't me"],":bz":["115.gif","bee"],":ar!":["pirate.gif","pirate"],"[..]":["transformer.gif","transformer"]})};
qx.Class.define("ava.Inception",{type:"singleton",extend:qx.core.Object,construct:function(b){this.base(arguments)},members:{init:function(){qx.core.Init.getApplication().chat._outputMsg=this.outputMsgIntercept;webfrontend.gui.Util._convertBBCode=webfrontend.gui.Util.convertBBCode;webfrontend.gui.Util.convertBBCode=this.convertBBCode},convertBBCode:function(b,c,d){var e="",f=/^<img src="[^"]*" title="[^"]*" alt="" class="smiley" style="[^"]*"\/>$/gi;null!==b&&(c?(b=b.replace(/\[youtube\](.*?)\[\/youtube\]/gi,
"[url]http://www.youtube.com/v/$1[/url]"),b=b.replace(/\[youtube=([0-9]*?)\](.*?)\](.*?)\[\/youtube\]/gi,"[url]http://www.youtube.com/v/$2[/url]"),b=b.replace(/\[img\](.*?)\[\/img\]/gi,"[url]$1[/url]"),b=b.replace(/\[img=([0-9]*?)x([0-9]*?)\](.*?)\[\/img\]/gi,"[url]$3[/url]"),b=b.replace(/\[url=([^\]]*?)\](.*?)\[\/url\]/gi,"[url]$1[/url]"),b=b.replace(/\[pre\]([\s\S]*?)\[\/pre\]/gi,"$1")):(b=b.replace(/\[youtube\](.*?)\[\/youtube\]/gi,'<iframe width="425" height="350" src="http://www.youtube.com/embed/$1?theme=dark&color=red&modestbranding=1&rel=0&showinfo=0&iv_load_policy=3" frameborder="0" allowfullscreen></iframe>'),
b=b.replace(/\[youtube=([0-9]*?)\](.*?)\[\/youtube\]/gi,'<iframe width="425" height="350" src="http://www.youtube.com/embed/$2?theme=dark&color=red&modestbranding=1&rel=0&showinfo=0&iv_load_policy=3&start=$1" frameborder="0" allowfullscreen></iframe>'),b=b.replace(/\[img\](.*?)\[\/img\]/gi,'<img title="" alt="" class="image" src="$1">'),b=b.replace(/\[img=([0-9]*?)x([0-9]*?)\](.*?)\[\/img\]/gi,'<img width="$1" height="$2" title="" alt="" class="image" src="$3">'),b=b.replace(/\[url=([^\]]*?)\](.*?)\[\/url\]/gi,
"<a href=# onClick=\"webfrontend.gui.Util.openLink('$1');\">$2</a>"),b=b.replace(/\[pre\]([\s\S]*?)\[\/pre\]/gi,"<pre>$1</pre>")),e=emotify(b,null),!c&&f.test(e)&&(e="&thinsp;"+e));return webfrontend.gui.Util._convertBBCode(e,c,d)},outputMsgIntercept:function(b,c,d){/!LoU\.[a-zA-Z]*/i.test(b)&&(console.log(b),alert(b));this.__proto__._outputMsg.call(this,b,c,d)}}});
qx.Class.define("ava.Chat",{type:"singleton",extend:qx.core.Object,construct:function(b){this.base(arguments)},members:{init:function(){webfrontend.data.Alliance.getInstance();this.chat=webfrontend.data.Chat.getInstance();this.chat.addListener("newMessage",this.onNewMessage,this)},chat:null,onNewMessage:function(b){},addChatMessage:function(b,c){console.info(b);var d=c?avaSuiteVersion+" [Ava]: ":"",e=webfrontend.config.Config.getInstance().getChat(),d='<font size="'+e.getFontSize()+'" color="'+e.getChannelColor("Info")+
'" style="word-wrap: break-word;">'+d+emotify(b,null)+"</font>",f,g;e.getTimeStamp()&&(f=webfrontend.data.ServerTime.getInstance(),(g=f.getServerStep())&&(d='<font color="'+e.getTimeStampColor()+'">'+webfrontend.Util.getDateTimeString(f.getStepTime(g),!1,!0)+" "+d));qx.core.Init.getApplication().chat._outputMsg(d,"SYSTEM",7)}}});
qx.Class.define("ava.alerts",{type:"singleton",extend:qx.core.Object,construct:function(b){this.base(arguments)},members:{_outputMsg:null,_msgWin:null,playerName:null,cMain:null,init:function(){webfrontend.data.Alliance.getInstance();this._outputMsg=qx.core.Init.getApplication().chat._outputMsg;qx.core.Init.getApplication().chat._outputMsg=this.outputMsgIntercept;this.chat=webfrontend.data.Chat.getInstance();this.chat.addListener("newMessage",this.onNewMessage,this);this.playerName=webfrontend.data.Player.getInstance().getName().toLowerCase();
this.playerNameOrig=webfrontend.data.Player.getInstance().getName();this.cMain=ava.Main.getInstance()},chat:null,onNewMessage:function(b){b=b.getData();if("privateout"!=b.c&&(this.cMain.options.showWhisperAlert||this.cMain.options.showChatAlert||this.cMain.options.showChatAlertPhrases)){var c=webfrontend.data.ServerTime.getInstance(),d=c.getServerStep();if(d){var e="",f="",g=!1,h=removeBBcode(b.m);this.cMain.options.showChatAlert&&0<=b.m.toLowerCase().indexOf(this.playerName)&&(e+=this.playerName,
f+=this.playerNameOrig,g=!0);"privatein"==b.c&&this.cMain.options.showWhisperAlert&&(g=!0);if(this.cMain.options.showChatAlertPhrases)for(var k=this.cMain.options.chatAlertPhrases.split(","),l=0;l<k.length;++l){var m=k[l].toLowerCase().trim(),n=k[l].trim();0<m.length&&(0<=h.toLowerCase().indexOf(m)||0<=h.toLowerCase().indexOf(n))&&(e+=(0<e.length?"|":"")+m,f+=(0<f.length?"|":"")+n,g=!0)}if(g){var g=RegExp(e,"g"),p=e.split("|"),q=f.split("|"),h=h.replace(g,function(b){for(var c=0;c<p.length;++c)if(p[c].toLowerCase()==
b.toLowerCase())return"<span style='font-weight: bold;'>"+q[c]+"</span>"}),h="privatein"==b.c?"["+b.s+"] whispers to you: "+h:"_a"==b.c?"[Alliance]["+b.s+"]: "+h:"[Continent]["+b.s+"]: "+h;b=webfrontend.Util.getDateTimeString(c.getStepTime(d),!1,!0)+" "+h;this.addChatAlertMessage(b)}}}},outputMsgIntercept:function(b,c,d){this.__proto__._outputMsg.call(this,b,c,d)},clearMessages:function(){this._msgWin&&this._msgWin.lbl.setValue("")},showMessageWindow:function(b){if(null==this._msgWin){b=new qx.ui.window.Window(b&&
0!=b.length?b:"Ava Messages");b.setLayout(new qx.ui.layout.Grow);b.set({showMaximize:!1,showMinimize:!1,allowMaximize:!1,width:300,height:200});var c=new qx.ui.container.Scroll;b.lbl=(new qx.ui.basic.Label("")).set({rich:!0});c.add(b.lbl);b.add(c);var d=this;b.addListener("close",function(){d._msgWin=null},this);b.show();var c=qx.bom.Viewport.getWidth(window),e=qx.bom.Viewport.getHeight(window);b.moveTo(c-320,e-225);this._msgWin=b}},addMessage:function(b){this.showMessageWindow();this._msgWin.lbl.setValue(this._msgWin.lbl.getValue()+
b+"<br>")},addChatAlertMessage:function(b){this.showMessageWindow("Chat Alert");this._msgWin.lbl.setValue(this._msgWin.lbl.getValue()+b+"<br>")}}});var avaDebug=!0,consumerMessages=[],messageParam=[],messageVersion=[],messageThisObj=[],started=!1;function padNN(b){var c=b.toString();10>b&&(c="0"+b);return c}function isChaos(){var b=webfrontend.data.Alliance.getInstance().getName();return/Chaos/.test(b)}
function avaInitRaids(){var b=[50,300,2E3,4E3,1E4,15E3,2E4,3E4,45E3,6E4],c=[10,100,450,1500,3500,6E3,13E3,2E4,35E3,6E4],d=qx.locale.Manager.getInstance().getLocale();if("en"!=d||"de"!=d||"pl"!=d)d="en";var e=qx.core.Init.getApplication(),f=webfrontend.res.Main.getInstance(),g=e.tr("tnf:name:").charAt(0),h=e.tr("tnf:type:").charAt(0),k=e.tr("tnf:level:");e.tr("tnf:progress:");var l={en:{weak:"Weakness"},de:{weak:"Schwche"},pl:{weak:"????????"}}[d].weak+":</td><td>",m=f.units["6"].dn+":</td><td>",n=
f.units["7"].dn+":</td><td>",p=f.units["10"].dn+":</td><td>",q=f.units["11"].dn+":</td><td>",r=f.units["12"].dn+":</td><td>",t=f.units["16"].dn+":</td><td>",u=f.units["17"].dn+":</td><td>",s=51+e.tr("tnf:name:").length,v=51+e.tr("tnf:type:").length,w=9+e.tr("tnf:level:").length,y=f.attackTypes["2"].dn,x=f.attackTypes["1"].dn,z=f.attackTypes["4"].dn,A=f.attackTypes["3"].dn,B=f.dungeons["6"].dn.charAt(0),C=f.dungeons["8"].dn.charAt(0),E=f.dungeons["7"].dn.charAt(0),G=f.dungeons["12"].dn.charAt(0),Y=
f.dungeons["5"].dn.charAt(0),Z=f.dungeons["4"].dn.charAt(0),aa=f.dungeons["3"].dn.charAt(0),ba=f.dungeons["2"].dn.charAt(0);setTimeout(function(){ava.RaidingWindow.getInstance().buildUI();ava.IdleRaidUnitsTable.getInstance().buildUI()},8E3);e.worldViewToolTip.addListener("appear",function(){try{var d=e.worldViewToolTip,f=d.getMode();if("c"!=f&&"d"!=f){var F=d.getLabel();if(null!=F||42<F.length){var O=F.charAt(42);if(O==g){var H,L=F.charAt(s);H=L==B?y:L==C?x:L==E?z:L==G?A:"";var K=F.indexOf(k,s)+w,
D=F.charAt(K);"1"==D&&"0"==F.charAt(K+1)&&(D="10");webfrontend.gui.Util.formatNumbers(b[parseInt(D)-1]);var I=new qx.util.StringBuilder(20),ca=webfrontend.data.Tech.getInstance().getBonus("unitDamage",webfrontend.data.Tech.research,6),P=webfrontend.data.Tech.getInstance().getBonus("unitDamage",webfrontend.data.Tech.shrine,6),P=webfrontend.data.Tech.getInstance().getBonus("unitDamage",webfrontend.data.Tech.shrine,6),f=(P+ca)/100+1,da=webfrontend.data.Tech.getInstance().getBonus("unitDamage",webfrontend.data.Tech.research,
6),Q=(webfrontend.data.Tech.getInstance().getBonus("unitDamage",webfrontend.data.Tech.shrine,6)+da)/100+1,ea=webfrontend.data.Tech.getInstance().getBonus("unitDamage",webfrontend.data.Tech.research,10),R=(webfrontend.data.Tech.getInstance().getBonus("unitDamage",webfrontend.data.Tech.shrine,10)+ea)/100+1,fa=webfrontend.data.Tech.getInstance().getBonus("unitDamage",webfrontend.data.Tech.research,11),S=(webfrontend.data.Tech.getInstance().getBonus("unitDamage",webfrontend.data.Tech.shrine,11)+fa)/100+
1,ga=webfrontend.data.Tech.getInstance().getBonus("unitDamage",webfrontend.data.Tech.research,12),T=(webfrontend.data.Tech.getInstance().getBonus("unitDamage",webfrontend.data.Tech.shrine,12)+ga)/100+1,ha=webfrontend.data.Tech.getInstance().getBonus("unitDamage",webfrontend.data.Tech.research,16),ia=(webfrontend.data.Tech.getInstance().getBonus("unitDamage",webfrontend.data.Tech.shrine,16)+ha)/100+1,ja=webfrontend.data.Tech.getInstance().getBonus("unitDamage",webfrontend.data.Tech.research,17),ka=
(webfrontend.data.Tech.getInstance().getBonus("unitDamage",webfrontend.data.Tech.shrine,17)+ja)/100+1,M=webfrontend.gui.Util.formatNumbers(b[D-1]/f);"Infantry"==H&&(M=webfrontend.gui.Util.formatNumbers(b[D-1]/f*0.67));var U=webfrontend.gui.Util.formatNumbers(b[D-1]/Q*0.72);"Magic"==H&&(U=webfrontend.gui.Util.formatNumbers(b[D-1]/Q*0.4824));var V=webfrontend.gui.Util.formatNumbers(b[D-1]/R*0.83);"Cavalry"==H&&(V=webfrontend.gui.Util.formatNumbers(b[D-1]/R*0.5561));var W=webfrontend.gui.Util.formatNumbers(b[D-
1]/S*0.55);"Cavalry"==H&&(W=webfrontend.gui.Util.formatNumbers(b[D-1]/S*0.67*0.55));var X=webfrontend.gui.Util.formatNumbers(b[D-1]/T*0.42);"Magic"==H&&(X=webfrontend.gui.Util.formatNumbers(b[D-1]/T*0.2814));if("Artillery"==H){var la=webfrontend.gui.Util.formatNumbers(b[D-1]/ia*0.03),ma=webfrontend.gui.Util.formatNumbers(b[D-1]/ka*0.003);I.add(F,'<table cellspacing="0"><tr><td width="75">',l,H,"</td></tr><tr><td>",t,la,"</td></tr><tr><td>",u,ma,"</td></tr></table>")}else I.add(F,'<table cellspacing="0"><tr><td width="75">',
l,H,"</td></tr><tr><td>",m,M,"</td></tr></td></tr><tr><td>",p,V,"</td></tr></td></tr><tr><td>",q,W,"</td></tr><tr><td>",r,X,"</td></tr><tr><td>",n,U,"</td></tr></table>");d.setLabel(I.get())}else if(O==h){var N=F.charAt(v);H=N==Y?y:N==Z?x:N==aa?z:N==ba?A:"";K=F.indexOf(k,v)+w;D=F.charAt(K);"1"==D&&"0"==F.charAt(K+1)&&(D="10");var J=F.substr(F.indexOf("Progress")+18,2);"%"==J.substr(1,1)&&(J=J.substr(0,1));J=webfrontend.gui.Util.formatNumbers((0.0175*J+1.0875)*c[D-1]);M=webfrontend.gui.Util.formatNumbers(c[D-
1]);I=new qx.util.StringBuilder(20);I.add(F,'<table cellspacing="0"><tr><td width="75">',l,H,"</td></tr><tr><td>","Unit TS:</td><td>",M,"</td></tr><tr><td>","TS + pct:</td><td>",J,"</td></tr></table>");d.setLabel(I.get())}}}}catch(na){paError(na)}},this)}
function formatDate(b){webfrontend.data.ServerTime.getInstance();var c=new Date;c.setTime(b);webfrontend.data.ServerTime.getInstance().getDiff();webfrontend.config.Config.getInstance().getTimeZoneOffset();b=webfrontend.data.ServerTime.getInstance().getServerOffset();var d=6E4*-(new Date).getTimezoneOffset();c.setTime(c.getTime()+b-d);var d=c.getHours(),e=c.getMinutes();b=c.getSeconds();d=padNN(d);e=padNN(e);b=padNN(b);return c.getFullYear()+"/"+(c.getMonth()+1)+"/"+c.getDate()+" "+d+":"+e+":"+b}
function showMsgWindow(b,c){var d=new qx.ui.window.Window(b);d.setLayout(new qx.ui.layout.VBox(2));d.set({showMaximize:!1,showMinimize:!1,allowMaximize:!1,width:400,height:80});var e=(new qx.ui.basic.Label(c)).set({rich:!0});d.add(e);e=new qx.ui.container.Composite(new qx.ui.layout.HBox(2));d.add(e);var f=(new qx.ui.form.Button("Close")).set({appearance:"button-text-small",width:80,paddingLeft:5,paddingRight:5,paddingTop:0,paddingBottom:0});f.win=d;e.add(f);f.addListener("click",function(){this.win.hide()});
d.addListener("close",function(){},this);d.center();d.open()}function checkMsgs(){var b=new qx.util.StringBuilder(2048),c=!1,d;for(d in consumerMessages)null!=consumerMessages[d]&&"object"==typeof consumerMessages[d]&&(b.add(d,":",messageParam[d][0],"\f"),c=!0);c?pollMessages(b.get()):started=!1}
function pollMessages(b){var c=webfrontend.net.UpdateManager.getInstance();if(c.waitForResponse)setTimeout(checkMsgs,421);else{var d=new qx.util.StringBuilder(2048);d.add('{"session":"',c.getInstanceGuid(),'","requestid":"',c.requestCounter,'","requests":',qx.lang.Json.stringify(b),"}");c.requestCounter++;if(/lordofultima\.com/i.test(document.domain))b=new qx.io.remote.Request(c.getUpdateService()+"/Service.svc/ajaxEndpoint/Poll","POST","application/json"),b.setProhibitCaching(!1),b.setRequestHeader("Content-Type",
"application/json"),b.setData(d.get()),b.setTimeout(1E4),b.addListener("completed",pollCompleted),b.addListener("failed",pollFailed),b.addListener("timeout",pollTimeout),b.send();else{var e=this;GM_xmlhttpRequest({method:"POST",url:c.getUpdateService()+"/Service.svc/ajaxEndpoint/Poll",data:d.get(),timeout:1E4,headers:{"Content-Type":"application/json"},onerror:e.pollFailed.bind(e),ontimeout:e.pollTimeout.bind(e),onload:function(b){b=""!=b.responseText?qx.lang.Json.parse(b.responseText):{};e.pollCompleted(b)}})}}}
function pollFailed(b){window.setTimeout(checkMsgs,3E3)}function pollTimeout(b){window.setTimeout(checkMsgs,3E3)}
function pollCompleted(b){if(null!=b)try{var c;c=/lordofultima\.com/i.test(document.domain)?b.getContent():b;if(null!=c)for(b=0;b<c.length;b++)try{var d=c[b];if(d.hasOwnProperty("C")){var e=d.C;if(consumerMessages[e])for(var f=consumerMessages[e],g=0;g<f.length;++g){var h=messageVersion[e];if(d.D&&d.D.hasOwnProperty("v")){if(d.D.v==h[g])continue;h[g]=d.D.v}else if(d.hasOwnProperty("v")){if(d.v==h[g])continue;h[g]=d.v}var k=messageThisObj[e];window.setTimeout(f[g].bind(k[g],d.D,k[g]),0)}}}catch(l){paDebug(l)}}catch(m){paDebug(m)}finally{window.setTimeout(checkMsgs,
1711)}}function addConsumerX(b,c,d,e){if(consumerMessages[b])for(var f=consumerMessages[b],g=messageVersion[b],h=messageThisObj[b],k=messageParam[b],l=0;null!=f&&l<f.length;++l)f[l]==c&&(f.splice(l,1),g.splice(l,1),h.splice(l,1),k.splice(l,1));else consumerMessages[b]=[],messageVersion[b]=[],messageThisObj[b]=[],messageParam[b]=[];f=consumerMessages[b];g=f.length;f[g]=c;messageVersion[b][g]="";messageThisObj[b][g]=d;messageParam[b][g]=e;started||(started=!0,checkMsgs())}
function removeConsumerX(b,c,d){assert(c);assert(d);assert(b);if(consumerMessages[b])for(var e=consumerMessages[b],f=messageVersion[b],g=messageThisObj[b],h=messageParam[b];;){for(var k=!0,l=0;null!=e&&l<e.length;++l)if(e[l]==c){console.assert(g[l]==d);e.splice(l,1);f.splice(l,1);g.splice(l,1);h.splice(l,1);0==e.length&&(consumerMessages[b]=null,messageVersion[b]=null,messageThisObj[b]=null,messageParam[b]=null);k=!1;break}if(k)break}}var UnitsT=function(){return function(){}}();
qx.Class.define("ava.CityBuildings",{extend:qx.core.Object,construct:function(){this.base(arguments);this.bldgsCont=new qx.ui.container.Composite(new qx.ui.layout.VBox(4));this.row=new qx.ui.container.Composite(new qx.ui.layout.HBox(8));this.row.setWidth(338);this.bldgsCont.add(this.row);this.row2=new qx.ui.container.Composite(new qx.ui.layout.HBox(8));this.row2.setWidth(338);this.bldgsCont.add(this.row2);this.row3=new qx.ui.container.Composite(new qx.ui.layout.HBox(8));this.row3.setWidth(338);this.bldgsCont.add(this.row3);
this.row4=new qx.ui.container.Composite(new qx.ui.layout.HBox(8));this.row4.setWidth(338);this.bldgsCont.add(this.row4)},members:{bldgsCont:null,bldgsContBgr:null,lastId:"",prevCount:0,row:null,row2:null,row3:null,row4:null,cMain:null,bS:null,app:null,updateCityBuildings:function(){var b=webfrontend.data.City.getInstance();null==this.app&&(this.app=qx.core.Init.getApplication());null==this.bS&&(this.bS=webfrontend.res.Main.getInstance());null==this.cMain&&(this.cMain=ava.Main.getInstance());if(this.bS&&
b&&this.cMain)if(0==this.cMain.options.showCityBuildings||2==this.cMain.options.showCityBuildings&&"c"!=this.app.visMain.mapmode)this.bldgsCont.setVisibility("excluded");else{this.bldgsCont.setVisibility("visible");var c=b.getBuildingCount();if(c!=this.prevCount||this.lastId!=b.getId()){console.log("UpdateCity");this.prevCount=c;this.lastId=b.getId();this.row.removeAll();this.row2.removeAll();this.row3.removeAll();this.row4.removeAll();this.row2.setVisibility("excluded");this.row3.setVisibility("excluded");
this.row4.setVisibility("excluded");var c=0,d;for(d in this.bS.buildings){var e=b.getBuildingCountByType(d);if(0<e&&5!=this.bS.buildings[d].t){var f=new qx.ui.basic.Label(" ");f.setRich(!0);var g=this.bS.buildings[d].dn;f.setValue('<img alt="'+g+'" title="'+g+'" src="http://eaassets-a.akamaihd.net/lougame/cdn/410784/resource/webfrontend/'+this.bS.getFileInfo(this.bS.buildings[Number(d)].mimg).url+'" style="align:absmiddle;-moz-transform: scaleX(1); width: 28px; height: 28px; padding-left:4px;" /><br/><span style="margin-left: '+
(10<e?10:15)+'px;">'+e+"</span>");++c;8>=c?this.row.add(f):16>=c?(this.row2.add(f),this.row2.setVisibility("visible")):24>=c?(this.row3.add(f),this.row3.setVisibility("visible")):(this.row4.add(f),this.row4.setVisibility("visible"))}}this.bldgsCont.setVisibility("visible")}}}}});var cityStatusText,cityStatusRow;
function clearCityStatusText(){cityStatusText&&cityStatusRow&&(cityStatusRow.setMaxHeight(0),cityStatusText.setMaxHeight(0),cityStatusRow.setVisibility("hidden"),cityStatusText.setValue(""))}function findTextNode(b){var c,d;for(d=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null,!1).nextNode();d;)d.data==b&&(c=d);return c}
function addApplyAllButtons(){var b=qx.core.Init.getApplication(),c=b.getOrderDetailPage(),d=new qx.ui.layout.HBox(3),d=new qx.ui.container.Composite(d);d.add(c.applyAllBtn);d.add(c.applyAllThisDungeonBtn);for(var e in b.getOrderDetailPage())if(b.getOrderDetailPage()[e]instanceof webfrontend.gui.OrderDetail.RaidTimeDisplay){for(var c=b.getOrderDetailPage()[e],f=c.getLayoutParent().getLayoutChildren(),g,h=0;h<f.length;++h)if(f[h]==c){g=f[h+2];break}g&&(g=g.getLayoutChildren()[1],g.getLayoutParent().addAfter(d,
g))}}function refreshItems(){ava.PalaceItemsWindow.getInstance().fillItemRow()}function waitForItem(){window.setTimeout(refreshItems,3E3)}
qx.Class.define("ava.PalaceItemsWindow",{type:"singleton",extend:qx.ui.window.Window,construct:function(){var b=this;b.base(arguments,"Use Palace Items");setTimeout(function(){b.buildUI();b.addListener("appear",b.fillItemRow,b)},0)},members:{_returnTime:null,palaceItemMessageLabel:null,palaceItemRow:null,buildUI:function(){avaMain.app.desktop.add(this);qx.core.Init.getApplication();this.setLayout(new qx.ui.layout.VBox(2));this.set({allowMaximize:!1,allowMinimize:!1,showMaximize:!1,showMinimize:!1,
showStatusbar:!0,showClose:!0,contentPadding:5,useMoveFrame:!0,resizable:!0});this.setWidth(350);var b=new qx.ui.basic.Label("Select the city then click the item to apply");b.set({font:"bold"});this.add(b);this.palaceItemRow=b=new qx.ui.container.Composite;b.setLayout(new qx.ui.layout.HBox);this.add(b);this.palaceItemMessageLabel=b=new qx.ui.basic.Label("");b.set({minWidth:30,allowGrowX:!0,font:"bold",textColor:"red",toolTipText:"Hello"});var c=new qx.ui.container.Composite;c.setLayout(new qx.ui.layout.HBox);
c.add(b);this.add(c);b=new qx.ui.form.Button("Close");b.addListener("execute",this.hide,this);c=new qx.ui.container.Composite;c.setLayout(new qx.ui.layout.HBox);c.add(b);this.add(c)},fillItemRow:function(){console.debug("fillItemRow");this.palaceItemRow.removeAll();this.palaceItemMessageLabel.setValue("");for(var b=webfrontend.data.Inventory.getInstance(),c=webfrontend.res.Main.getInstance(),d=0,e=webfrontend.data.Player.getInstance().getTitle(),f=178;188>f;++f){var g=!1;switch(f){case 178:case 183:g=
10<=e;break;case 179:case 184:g=9<=e;break;case 180:case 185:g=8<=e;break;case 181:case 186:g=7<=e;break;case 182:case 187:g=6<=e}if(b.hasItem(f)&&g){++d;for(var h=b.getInventorySorted(),k=g=0;k<h.length;++k)if(h[k].id==f){g=h[k].count;break}h=new qx.ui.basic.Image(webfrontend.config.Config.getInstance().getImagePath(c.imageFiles[c.items[f].i]));h.itemId=String(f);h.thisObj=this;h.set({padding:5,toolTipText:"You own "+String(g)+" artifact"+(1<g?"s":"")+" <br/>"+c.items[f].dn+"<br/>"+c.items[f].sds});
h.setWidth(40);h.setHeight(40);h.setScale(!0);this.palaceItemRow.add(h);h.addListener("click",this.useItem,this)}}0==d&&this.palaceItemMessageLabel.setValue("No useable palace items found")},useItem:function(b){b=b.getCurrentTarget();var c=b.itemId,d=qx.core.Init.getApplication(),d=(d.cityDetailView||d.getCityDetailView()).city,e=webfrontend.data.Alliance.getInstance().getName().toLowerCase();d&&d.get_IsEnlighted()?d.get_AllianceName().iCompare(e)?this.palaceItemMessageLabel.setValue("Enlightend city must belong to "+
e):webfrontend.data.Inventory.getInstance().hasItem(c)?(e=webfrontend.res.Main.getInstance(),d=d.get_Coordinates(),this.palaceItemMessageLabel.setValue("Please wait, using 1 "+e.items[c].dn),webfrontend.net.CommandManager.getInstance().sendCommand("UseItem",{itemid:c,amount:1,target:[{t:e.items[c].tt,i:d}]},b.thisObj,waitForItem)):this.palaceItemMessageLabel.setValue("You do not own the item selected"):this.palaceItemMessageLabel.setValue("Select an enlightened city")}}});
qx.Class.define("ava.AllianceMailingListWindow",{type:"singleton",extend:qx.ui.window.Window,construct:function(b,c){this.base(arguments,"Mailing Lists");this.buildUI();this.addListener("appear",this.getAllianceMailingLists,this)},members:{_wcText:null,_lists:null,_continents:null,_count:0,buildUI:function(){var b=qx.core.Init.getApplication();this.setLayout(new qx.ui.layout.VBox(10));this.set({allowMaximize:!1,allowMinimize:!1,showMaximize:!1,showMinimize:!1,showStatusbar:!1,showClose:!1,contentPadding:5,
useMoveFrame:!0,resizable:!0});this.setWidth(400);webfrontend.gui.Util.formatWinClose(this);var c=(new qx.ui.basic.Label("Alliance Mailing Lists")).set({font:"bold"});this.add(c);this._wcText=new qx.ui.form.TextArea;this._wcText.set({readOnly:!0,allowGrowY:!1,autoSize:!1,tabIndex:303,height:280});b.setElementModalInput(this._wcText);this._wcText.setValue("Loading...");this.add(this._wcText);b=new qx.ui.form.Button("Close");b.addListener("execute",this.hide,this);this.add(b)},getAllianceMailingLists:function(){var b=
webfrontend.data.Alliance.getInstance().getId();this._count=0;webfrontend.net.CommandManager.getInstance().sendCommand("GetPublicAllianceMemberList",{id:b},this,this.gotAlliancePlayers)},gotAlliancePlayers:function(b,c){if(b){this._lists=[];this._continents=[];var d=webfrontend.net.CommandManager.getInstance();this._count=c.length;for(var e=0;e<c.length;++e)d.sendCommand("GetPublicPlayerInfo",{id:c[e].i},this,this.gotPlayerInfo)}},gotPlayerInfo:function(b,c){--this._count;if(b){for(var d=webfrontend.data.Server.getInstance(),
e=c.c,f=0;f<e.length;++f){for(var g=d.getContinentFromCoords(e[f].x,e[f].y),h=!1,k=0;k<this._continents.length;++k)if(this._continents[k]==g){h=!0;break}h||(this._continents[this._continents.length]=g);this._lists[g]||(this._lists[g]="");0>this._lists[g].indexOf(c.n)&&(this._lists[g]+=(0<this._lists[g].length?";":"")+c.n)}if(0==this._count)for(this._wcText.setValue(""),f=0;f<this._continents.length;++f)this._wcText.setValue(this._wcText.getValue()+"Continent "+this._continents[f]+"\r\n"+this._lists[this._continents[f]]+
"\r\n\r\n")}}}});
qx.Class.define("ava.ReturnByWindow",{type:"singleton",extend:qx.ui.window.Window,construct:function(){this.base(arguments,"Return raids by");this.buildUI()},members:{_returnTime:null,buildUI:function(){qx.core.Init.getApplication();this.setLayout(new qx.ui.layout.VBox(2));this.set({allowMaximize:!1,allowMinimize:!1,showMaximize:!1,showMinimize:!1,showStatusbar:!1,showClose:!1,contentPadding:5,useMoveFrame:!0,resizable:!1});this.setWidth(200);webfrontend.gui.Util.formatWinClose(this);var b=(new qx.ui.basic.Label("Return all raids by:")).set({font:"bold"});
this.add(b);this._returnTime=new ava.TimePicker("Return time:");this.add(this._returnTime);b=new qx.ui.container.Composite;b.setLayout(new qx.ui.layout.HBox);this.add(b);var c=new qx.ui.form.Button("Apply");c.addListener("execute",this.returnRaidsBy,this);b.add(c);c=new qx.ui.form.Button("Apply to all");c.set({marginLeft:5,marginRight:5,toolTipText:"Apply all raids in current city group."});var d=this;c.addListener("execute",function(){addConsumerX("COMO",d.returnAllRaidsBy,d,"a")},this);b.add(c);
c=new qx.ui.form.Button("Close");c.addListener("execute",this.hide,this);b.add(c)},sendReturnOrder:function(b){webfrontend.net.CommandManager.getInstance().sendCommand("UnitOrderSetRecurringOptions",b,null,function(b,d){})},returnOrder:function(b,c){var d=this;setTimeout(function(){d.sendReturnOrder(b)},c)},hasCity:function(b,c){var d=!1,e;for(e in b)if(c==e){d=!0;break}return d},showContinueMessage:function(b,c,d,e){var f=new qx.ui.window.Window("Continue?");f.setLayout(new qx.ui.layout.VBox(2));
f.set({showMaximize:!1,showMinimize:!1,allowMaximize:!1,width:400,height:80});f.lbl=(new qx.ui.basic.Label(b)).set({rich:!0});f.add(f.lbl);b=new qx.ui.container.Composite(new qx.ui.layout.HBox(2));f.add(b);var g=(new qx.ui.form.Button("Yes")).set({appearance:"button-text-small",width:80,paddingLeft:5,paddingRight:5,paddingTop:0,paddingBottom:0});g.win=f;g.requestArray=d;b.add(g);g.addListener("click",function(){ava.Chat.getInstance().addChatMessage(c,!1);for(var b=this.requestArray,d=500,f=0;f<b.length;f++)e.returnOrder(qx.lang.Json.parse(b[f]),
d),d+=1E3;this.win.hide()});d=(new qx.ui.form.Button("No")).set({appearance:"button-text-small",width:80,paddingLeft:5,paddingRight:5,paddingTop:0,paddingBottom:0});d.win=f;b.add(d);d.addListener("click",function(){this.win.hide()});f.addListener("close",function(){},this);f.center();f.open()},returnAllRaidsBy:function(b,c){if(null!=b){removeConsumerX("COMO",c.returnAllRaidsBy,c);for(var d=c._returnTime.getValue().getTime(),d=new Date(d),e=qx.core.Init.getApplication(),d=d.getTime(),f=webfrontend.data.ServerTime.getInstance().getServerStep(),
g=webfrontend.Util.getCurrentTime().getTime(),d=f+(Math.floor((d-g)/1E3)+1),g=webfrontend.data.Player.getInstance(),f=g.cities,h,e=e.cityBar.citiesSelect.getSelectedGroupId(),k=0;k<g.citygroups.length;++k)if(g.citygroups[k].i==e){h=g.citygroups[k].c;break}if(!h){h=[];for(var l in f)h.push(Number(l))}l=0;e=[];for(g=0;g<b.length;g++)if(k=b[g],k.hasOwnProperty("c")&&0<=h.indexOf(k.i)&&(0==f.length||c.hasCity(f,k.i)))for(var m=0;m<k.c.length;m++){var n=k.c[m];8==n.t&&(++l,e.push('{"cityid":'+k.i+', "id":'+
n.i+', "isDelayed":'+(0==n.s)+', "recurringType": 2, "recurringEndStep": '+d+"}"))}0<l?(f=l,h=Math.floor(f/3600),d=Math.floor((f-3600*h)/60),f=Math.floor(f-3600*h-60*d),h=padNN(h)+":"+padNN(d)+":"+padNN(f),c.showContinueMessage("Are you sure? "+l+" orders will be sent.  This will take approximately "+h+"."," Sending "+l+" orders.  This will take approximately "+h+".",e,c)):ava.Chat.getInstance().addChatMessage(" No raids found.",!1);c.hide()}},returnRaidsBy:function(){var b=this._returnTime.getValue().getTime(),
b=new Date(b);qx.core.Init.getApplication().cityBar.citiesSelect.getSelectedGroupId();var b=b.getTime(),c=webfrontend.data.ServerTime.getInstance().getServerStep(),d=webfrontend.Util.getCurrentTime().getTime(),b=c+(Math.floor((b-d)/1E3)+1),c=webfrontend.data.City.getInstance().unitOrders,e;for(e in c)8==c[e].type&&webfrontend.net.CommandManager.getInstance().sendCommand("UnitOrderSetRecurringOptions",{cityid:webfrontend.data.City.getInstance().getId(),id:c[e].id,isDelayed:c[e].isDelayed,recurringType:2,
recurringEndStep:b},null,function(){});this.hide()}}});var shrineNames="Inactive Compassion Honesty Honor Humility Justice Sacrifice Spirituality Valor".split(" ");
qx.Class.define("ava.CombatTools",{type:"static",statics:{NOW_TIMING_ID:1,DEPATATURE_TIMING_ID:2,ARRIVAL_TIMING_ID:3,ORDER_CANCEL_PERIOD_S:600,DEFAULT_MIN_TS:3E3,UNITS:{CITY_GUARD:{type:"1",name:"City Guard",ts:0,kind:"g",defensive:!0},BALLISTA:{type:"2",name:"Ballista",ts:10,kind:"s",defensive:!0},RANGER:{type:"3",name:"Ranger",ts:1,kind:"l",off:"i",defensive:!0},GUARDIAN:{type:"4",name:"Guardian",ts:1,kind:"l",off:"i",defensive:!0},TEMPLAR:{type:"5",name:"Templar",ts:1,kind:"l",off:"i",defensive:!0},
BERSEKER:{type:"6",name:"Berseker",ts:1,kind:"l",off:"i",defensive:!1},MAGE:{type:"7",name:"Mage",ts:1,kind:"l",off:"m",defensive:!1},SCOUT:{type:"8",name:"Scout",ts:2,kind:"c",off:"c",defensive:!1},XBOW:{type:"9",name:"Crossbow",ts:2,kind:"l",off:"c",defensive:!0},PALADIN:{type:"10",name:"Paladin",ts:2,kind:"l",off:"c",defensive:!0},KNIGHT:{type:"11",name:"Knight",ts:2,kind:"l",off:"c",defensive:!1},WARLOCK:{type:"12",name:"Warlock",ts:2,kind:"l",off:"m",defensive:!1},RAM:{type:"13",name:"Ram",ts:10,
kind:"s",off:"s",forceSiege:!0,defensive:!1},CATAPULT:{type:"14",name:"Catapult",ts:10,kind:"s",off:"d",forceSiege:!0,defensive:!1},FRIGATE:{type:"15",name:"Frigate",ts:100,kind:"t",transport:500,off:"s",defensive:!1},SLOOP:{type:"16",name:"Sloop",ts:100,kind:"w",off:"s",defensive:!0},GALLEON:{type:"17",name:"War Galleon",ts:400,kind:"w",off:"d",forceSiege:!0,defensive:!1},BARON:{type:"19",name:"Baron",ts:1,kind:"b",off:"d",forceSiege:!0,defensive:!1},DRAGON:{type:"77",name:"dragon",ts:1E4,kind:"l",
off:"c",forceSiege:!1,defensive:!1}},_unitsByType:null,getUnitByType:function(b){if(null==this._unitsByType){var c={};qx.lang.Object.getValues(this.UNITS).forEach(function(b){c[b.type]=b});this._unitsByType=c}return this._unitsByType[b]},getAvailableUnits:function(b,c,d,e){var f=b.getUnits();b=b.getUnitOrders();var g={all:[],land:[],scout:[],siege:[],ships:[],transport:[],baron:[]},h={};if(null==f)return g;qx.lang.Object.keys(f).forEach(function(b){if(b!=this.UNITS.CITY_GUARD.type){var c=f[b];if(0<
c.total){var m=this.getUnitByType(b);if(!d||!m.defensive)if(!e||"w"!=m.kind&&"t"!=m.kind)switch(b={type:b,name:m.name,count:c.total,unitTS:m.ts,kind:m.kind,unitCapacity:m.transport,off:m.off,forceSiege:m.forceSiege,defensive:m.defensive},g.all.push(b),h[b.type]=b,m.kind){case "l":g.land.push(b);break;case "c":g.scout.push(b);break;case "s":g.siege.push(b);break;case "t":g.transport.push(b);break;case "w":g.ships.push(b);break;case "b":g.baron.push(b)}}}},this);null!=b&&b.forEach(function(b){c&&0!=
b.state||b.units.forEach(function(b){var c=h[b.type];void 0!=c&&(c.count-=b.count)})},this);return g},orderUnits:function(b,c,d,e,f,g){var h=webfrontend.data.City.getInstance();c=removeBBcode(c).trim();if(!c.match(/^\d{3}:\d{3}$/))throw Error("Invalid target format '"+c+"'");var k=[],l=!1;b.forEach(function(b){if(!(1>b.count)){l=l||15<=b.type&&17>=b.type;if(DO_NOT_ATTACK_UNITS[b.type])throw Error("Invalid unit ordered to attack");if(2==d&&DO_NOT_PLUNDER_UNITS[b.type])throw Error("Invalid unit ordered to plunder");
k.push({t:b.type,c:b.count})}});if(1>k.length)throw Error("No units selected");b={cityid:h.getId(),units:k,targetCity:c,order:d,transport:l?2:1,timeReferenceType:e,referenceTimeUTCMillis:f+1E3,raidTimeReferenceType:0,raidReferenceTimeUTCMillis:0};webfrontend.net.CommandManager.getInstance().sendCommand("OrderUnits",b,null,g)},getOrder:function(b,c){var d=b.getUnitOrders();if(null!=d)for(var e=0;e<d.length;e++)if(d[e].id==c)return d[e];return null},canOrderBeCancelled:function(b){var c=webfrontend.data.ServerTime.getInstance();
return 2!=b.state&&b.start>c.getServerStep()-this.ORDER_CANCEL_PERIOD_S},cancelUnitOrder:function(b,c,d){var e=webfrontend.data.City.getInstance(),f=this.getOrder(e,b);if(null==f)paError("Order not found");else{if(!this.canOrderBeCancelled(f))throw Error("Order cannot be cancelled");b={cityid:e.getId(),id:b,isDelayed:0==f.state};webfrontend.net.CommandManager.getInstance().sendCommand("CancelUnitOrder",b,null,function(b,e){c.call(d,e?null:Error("Error executing CancelUnitOrder command"))})}},cancelRaidOrder:function(b,
c,d){var e=webfrontend.data.City.getInstance(),f=this.getOrder(e,b);if(null==f)paDebug("Order not found");else{if(8!=f.type)throw Error("Order is not a raid");b={cityid:e.getId(),id:b,isDelayed:0==f.state,recurringType:0};webfrontend.net.CommandManager.getInstance().sendCommand("UnitOrderSetRecurringOptions",b,null,function(b,e){c.call(d,e?null:Error("Error executing UnitOrderSetRecurringOptions command"))})}},cancelOrder:function(b,c,d){var e=webfrontend.data.City.getInstance(),e=this.getOrder(e,
b);if(null==e)paDebug("Order not found");else if(this.canOrderBeCancelled(e))this.cancelUnitOrder(b,c,d);else if(8==e.type)this.cancelRaidOrder(b,c,d);else throw Error("Order cannot be cancelled");},cancelOrders:function(b,c,d){var e=this,f=[].concat(b),g=0,h;h=function(b){if(b)c.call(d,b);else{var l=f.pop();l?(paDebug("Next cancelOrder in "+g),setTimeout(function(){g=500;ava.CombatTools.cancelOrder(l,h,e)},g)):c.call(d,null)}};h(null)},prepareRealAttackUnits:function(b,c,d,e,f,g,h){var k=webfrontend.data.City.getInstance(),
l={totalTS:0,units:[],isPartial:!1};if(void 0==h||null==h)h=this.getMinAttackStrength(k.getUnitLimit());k=b.land;e&&(k=b.baron.concat(b.land));if(c){if(0<b.siege.length)throw Error("NAval attack is not possible with siege engines");var m=0;k.forEach(function(b){m+=b.count*b.unitTS});var n=0;b.transport.forEach(function(b){n+=b.count*b.unitCapacity});if(!g&&n<m)throw Error("Not enough ships to carry your troops");var p=n;l.units=b.transport.concat(b.ships);l.isPartial=!1;f&&(k=k.concat(b.scout));k.forEach(function(b){if(p>
b.unitTS){var c=qx.lang.Object.clone(b);c.count=Math.min(c.count,Math.floor(p/b.unitTS));l.isPartial=l.isPartial||c.count<b.count;l.units.push(c);p-=c.count*c.unitTS}})}else l.units=k.concat(b.siege),f&&(l.units=l.units.concat(b.scout));d||(console.log("!seige"),[].concat(l.units).forEach(function(b){"b"!=b.kind&&"d"==b.off&&l.units.splice(l.units.indexOf(b),1)}));if(1>l.units.length)throw Error("No troops Available");l.units.forEach(function(b){l.totalTS+=b.count*b.unitTS});if(l.totalTS<h)throw Error("Not enough troops Available");
return l},prepareFakeAttackUnits:function(b,c,d,e){var f=webfrontend.data.City.getInstance();if(void 0==d||null==d)d=this.getMinAttackStrength(f.getUnitLimit());var g={totalTS:0,units:[]},f=function(b,c){return c.count*c.unitTS-b.count*b.unitTS},h=b.land;if(c){f=h.concat(b.ships).sort(f);if(1>f.length)throw Error("No troops Available");c=f[0];if("w"!=c.kind){if(1>b.transport.length)throw Error("No ships Available");b=b.transport[0];e=Math.ceil(d/(b.unitTS+b.unitCapacity));f=Math.ceil((d-e*b.unitTS)/
c.unitTS);if(c.count<f)throw Error("Not enough troops Available");if(b.count<e)throw Error("Not enough ships to carry your troops");d=qx.lang.Object.clone(c);d.count=f;c=qx.lang.Object.clone(b);c.count=e;g.units=[d,c]}else{b=Math.ceil(d/c.unitTS);if(c.count<b)throw Error("Not enough troops Available");d=qx.lang.Object.clone(c);d.count=b;g.units=[d]}}else{f=h.concat(b.siege).sort(f);if(1>f.length)throw Error("No troops Available");c=f[0];b=Math.ceil(d/c.unitTS);for(h=0;h<f.length;++h)if("13"==f[h].type){c=
f[h];b=Math.ceil(d/c.unitTS);f[h].count<b&&(c=f[0],b=Math.ceil(d/c.unitTS));break}if(c.count<b)throw Error("Not enough troops Available");d=qx.lang.Object.clone(c);d.count=b;g.units=e?[d,{type:"19",name:"Baron",count:1,unitTS:1,kind:"b",off:"d",forceSiege:!0,defensive:!1}]:[d]}g.units.forEach(function(b){g.totalTS+=b.count*b.unitTS});return g},prepareScoutAttackUnits:function(b,c,d,e,f){var g=webfrontend.data.City.getInstance();if(void 0==f||null==f)f=this.getMinAttackStrength(g.getUnitLimit());var h=
{totalTS:0,units:[]};if(1>b.scout.length)throw Error("No scouts Available");g=qx.lang.Object.clone(b.scout[0]);if(g.count*g.unitTS<f)throw Error("Not enough troops Available");d&&(g.count=Math.ceil(f/g.unitTS));if(c){if(1>b.transport.length)throw Error("No ships Available");b=qx.lang.Object.clone(b.transport[0]);c=b.count*b.unitCapacity;if(c<f)throw Error("Not enough ships to carry your troops");if(e)g.count=Math.floor(c/g.unitTS);else{e=Math.ceil(g.count*g.unitTS/b.unitCapacity);if(b.count<e)throw Error("Not enough ships to carry your troops");
b.count=e}h.units.push(b)}h.units.push(g);h.units.forEach(function(b){h.totalTS+=b.count*b.unitTS});return h},getUnitBonus:function(b){var c=webfrontend.data.Tech.getInstance().getBonus("unitDamage",webfrontend.data.Tech.research,Number(b));b=webfrontend.data.Tech.getInstance().getBonus("unitDamage",webfrontend.data.Tech.shrine,Number(b));return(c+b)/100},getUnitBaseDamage:function(b){return webfrontend.res.Main.getInstance().units[b].av},getUnitDamage:function(b){var c=this.getUnitBaseDamage(b);
b=this.getUnitBonus(b);return Math.floor(c*(1+b))},getMinAttackStrength:function(b){var c=3E3,c=2E4>=b?1:4E4>=b?200:6E4>=b?500:8E4>=b?800:1E5>=b?1E3:12E4>=b?1200:16E4>=b?1600:2E5>=b?2E3:24E4>=b?2500:3E3;b=webfrontend.data.Player.getInstance().getNumCities();100<=b?c=Math.max(1600,c):50<=b?c=Math.max(1200,c):20<=b?c=Math.max(800,c):10<=b?c=Math.max(500,c):5<=b?c=Math.max(200,c):2<=b&&(c=Math.max(20,c));return c},getMajorAttackType:function(b){var c;for(c=0;c<b.length;c++)if(b[c].forceSiege)return"d";
b=[].concat(b).sort(function(b,c){return c.count*c.unitTS-b.count*b.unitTS});for(c=0;c<b.length;c++)if(-1<"lswc".indexOf(b[c].kind))return b[c].off;throw Error("Unable to determine attack type");},convertGameTimeToUtc:function(b,c){if(!(b instanceof Date))return null;c=null!=c?c:webfrontend.config.Config.getInstance().getTimeZone();var d=webfrontend.config.Config.getInstance().getTimeZoneOffset(),e=webfrontend.data.ServerTime.getInstance().getServerOffset(),f=6E4*-(new Date).getTimezoneOffset(),g=
webfrontend.data.ServerTime.getInstance().getDiff();switch(c){case 0:return b.getTime()-f-g;case 1:return b.getTime()-e;case 2:return b.getTime()-d;default:throw Error("Unknown time settings");}},convertUtcToGameTime:function(b,c){if(isNaN(b))return null;c=null!=c?c:webfrontend.config.Config.getInstance().getTimeZone();var d=webfrontend.config.Config.getInstance().getTimeZoneOffset(),e=webfrontend.data.ServerTime.getInstance().getServerOffset(),f=6E4*-(new Date).getTimezoneOffset(),g=webfrontend.data.ServerTime.getInstance().getDiff();
switch(c){case 0:return new Date(b+f+g);case 1:return new Date(b+e);case 2:return new Date(b+d);default:throw Error("Unknown time settings");}},getErrorMessage:function(b){return 0==b?"Success":50335744==b?"Someone killed the poor boss before you could attack :(":b&4194304?"The chosen time is in the past":b&1?"No target or unreachable by moongate":b&2?"Not enough units":b&4?"Not enough troops":b&16?"Target city has no castle":b&524288?"Target is not reachable on water":b&1024?"Dungeons can only be raided":
b&131072?"Boss is Dead :(":"Unknown error "+b}}});
qx.Class.define("ava.BossUtils",{type:"static",extend:qx.lang.Object,construct:function(){this.base(arguments)},statics:{BOSS_DEFENSE_STRONG:[2500,15E3,1E5,2E5,5E5,75E4,1E6,15E5,225E4,3E6],BOSS_DEFENSE_WEAK:[1700,1E4,68E3,132E3,332E3,5E5,68E4,1E6,15E5,2E6],requestBossInfo:function(b,c,d){var e={cityid:webfrontend.data.City.getInstance().getId(),x:b,y:c};webfrontend.net.CommandManager.getInstance().sendCommand("GetOrderTargetInfo",e,null,function(e,g){var h=ava.BossUtils.getBossInfo(g);h?(h.name=h.cn,
h.coords=normalizeCoords(b+":"+c),d(h)):paDebug("Unable to get target info")})},getBossInfo:function(b){var c=b.cn.match(/^([^:]+):(\d+)$/);if(null==c)return null;c=Number(c[2]);switch(b.t){case 6:return{weakness:"c",level:c,water:!1};case 7:return{weakness:"i",level:c,water:!1};case 8:return{weakness:"i",level:c,water:!1};case 12:return{weakness:"sd",level:c,water:!0};default:return null}},prepareAttack:function(b){var c=webfrontend.data.City.getInstance(),c=ava.CombatTools.getAvailableUnits(c,!1),
c=[].concat(b.water?c.ships:c.land);c.forEach(function(b){var c=ava.CombatTools.getUnitDamage(b.type);0<c&&(b.dmg=c)});c.sort(function(b,c){return c.count*c.dmg-b.count*b.dmg});for(var d,e=0;e<c.length&&(d=this.getOrder(b,c[e]),null==d);e++);if(null==d)throw Error("No unit to attack with");return d},getOrder:function(b,c){var d;d=-1<b.weakness.indexOf(c.off)?ava.BossUtils.BOSS_DEFENSE_WEAK[b.level-1]:ava.BossUtils.BOSS_DEFENSE_STRONG[b.level-1];d=Math.ceil(d/c.dmg);if(c.count<d)return null;var e=
qx.lang.Object.clone(c);e.count=d;return[e]},sendAttack:function(b,c,d){var e=this;this.requestBossInfo(b,c,function(b){var c=e.prepareAttack(b);ava.CombatTools.orderUnits(c,b.coords,8,1,0,function(b,c){var e=ava.CombatTools.getErrorMessage(c);paDebug("Hunt result="+e);d&&d(b,c,e)})})}}});
qx.Class.define("ava.AttackOrder",{extend:qx.ui.container.Composite,construct:function(){this.base(arguments);var b={label:"Plunder",type:2},c={label:"Siege",type:5},d={label:"Assault",type:3},e={label:"Scout",type:1};this.ATTACK_ACTIONS=[];this.ATTACK_ACTIONS.push({name:"fake",label:"Fake",allowed:[c,d,b,e],tooltip:"Minimal troop count will be sent."});this.ATTACK_ACTIONS.push({name:"capture",label:"Capture",allowed:[c,d],tooltip:"Barons will be included in the attack, if Available. No Catapults or Galleons will be sent, only Rams."});
this.ATTACK_ACTIONS.push({name:"fakecap",label:"Fake Cap",allowed:[c,b],tooltip:"Minimal troop count will be sent. One barons will be included in the attack, if Available."});this.ATTACK_ACTIONS.push({name:"demo",label:"Demolish",allowed:[c,d],tooltip:"Catapults and Galleons will be included in the attack."});this.ATTACK_ACTIONS.push({name:"attack",label:"Attack",allowed:[c,b,d],tooltip:"Simple attack, no Catapults, Galleons or Barons will be included. Rams will be used, if Available."});this.ATTACK_ACTIONS.push({name:"scout",
label:"Scout",allowed:[e],tooltip:"Only scouts will be sent."});this.buildUI();this.selectAction(this.ATTACK_ACTIONS[0])},events:{attack:"qx.event.type.Data",changeValue:"qx.event.type.Event"},members:{ATTACK_ACTIONS:null,_attackButton:null,_actionButton:null,_coordsText:null,_toggleButton:null,_noteText:null,_counterLabel:null,_selectedAction:null,_selectedTypeIndex:-1,_applyingValue:!1,buildUI:function(){var b=this,c=qx.core.Init.getApplication();this.setLayout(new qx.ui.layout.HBox(5));var d=new qx.ui.menu.Menu;
this.ATTACK_ACTIONS.forEach(function(c){var e=new qx.ui.menu.Button(c.label);e.addListener("execute",function(){b.selectAction(c)});d.add(e)});this._attackButton=new qx.ui.form.Button("[Select]");this._attackButton.set({appearance:"button-text-small",width:80});this._attackButton.addListener("execute",this.fireAttack,this);this._actionButton=new qx.ui.form.MenuButton("?",null,d);this._actionButton.set({appearance:"button-text-small",width:20});var e=new qx.ui.container.Composite;e.setLayout(new qx.ui.layout.HBox(1));
e.add(this._attackButton);e.add(this._actionButton);this._toggleButton=new qx.ui.form.Button("[Select]");this._toggleButton.set({appearance:"button-text-small",width:60,toolTipText:"Siege Engines and Baron will always siege the target, regardless the option."});this._toggleButton.addListener("execute",this.onModeToggle,this);this._coordsText=new qx.ui.form.TextField;this._coordsText.set({width:60,marginTop:1,maxLength:40,toolTipText:"Coordinates in xxx:yyy format."});c.setElementModalInput(this._coordsText);
this._coordsText.addListener("changeValue",this.onNormalizeCoords,this);this._coordsText.addListener("changeValue",this.fireChangeValue,this);this.centerImage=new qx.ui.basic.Image(webfrontend.config.Config.getInstance().getImagePath("ui/icons/icon_buildings_centerview.png"));this.centerImage.setWidth(18);this.centerImage.setHeight(12);this.centerImage.setScale(!0);this.centerImage.setAlignY("middle");this.centerViewBtn=new qx.ui.form.Button;this.centerViewBtn.set({width:20,appearance:"button-text-small",
toolTipText:"Go to city"});this.centerViewBtn.addListener("click",this.findCity,this);this.centerViewBtn._add(this.centerImage);this._noteText=new qx.ui.form.TextField;this._noteText.set({width:210,toolTipText:"Just a note."});this._noteText.addListener("changeValue",this.fireChangeValue,this);c.setElementModalInput(this._noteText);this._counterLabel=new qx.ui.basic.Label;this._counterLabel.set({minWidth:30,allowGrowX:!0,toolTipText:"Indicative count of attacks you have sent to this target. DblClick to remove last entry. I=Infrantry, C=CAvalry, M=Magic, D=Siege Engines"});
this._counterLabel.addListener("dblclick",this.removeLastCount,this);this.add(e);this.add(this._coordsText);this.add(this._toggleButton);this.add(this.centerViewBtn);this.add(this._noteText);this.add(this._counterLabel)},findCity:function(){var b=String(this._noteText.getValue()||""),c=/[0-9][0-9][0-9]:[0-9][0-9]/i,d=/[0-9][0-9]:[0-9][0-9][0-9]/i,e=/[0-9][0-9]:[0-9][0-9]/i;if(b=(b.match(/[0-9][0-9][0-9]:[0-9][0-9][0-9]/i)||b.match(c)||b.match(d)||b.match(e)).join())c=b[0].split(":"),b=Number(c[0]),
c=Number(c[1]),d=convertCoordinatesToId(b,c),(e=webfrontend.data.Player.getInstance().getCities())&&e.hasOwnProperty(d)&&webfrontend.data.City.getInstance().setRequestId(d),webfrontend.gui.Util.showMapModeViewPos("r",0,b,c)},selectAction:function(b){this._selectedAction=b;this._attackButton.setLabel(b.label.toUpperCase());this._attackButton.setToolTipText(b.tooltip);this._selectedTypeIndex=-1;this.onModeToggle()},onModeToggle:function(){var b=this._selectedAction.allowed;this._selectedTypeIndex++;
this._selectedTypeIndex>=b.length&&(this._selectedTypeIndex=0);this._toggleButton.setLabel(b[this._selectedTypeIndex].label);this.fireChangeValue()},onNormalizeCoords:function(b){var c=normalizeCoords(b.getData());null!=c&&c!=b.getData()&&(b.stopPropagation(),this._coordsText.setValue(c))},fireAttack:function(){var b=this.getValue();null!=b&&this.fireDataEvent("attack",b)},fireChangeValue:function(){this._applyingValue||this.fireEvent("changeValue")},setAttackEnabled:function(b){this._attackButton.setEnabled(b)},
getValue:function(){var b=normalizeCoords(this._coordsText.getValue()),c=this._selectedAction.allowed[this._selectedTypeIndex],d=(this._noteText.getValue()||"").trim();return null==b||null==c?null:{attack:this._selectedAction.name,type:c.type,target:b,note:d}},setValue:function(b){null==b&&(b={fake:!0});this._applyingValue=!0;var c=this._actionByName(b.attack);this.selectAction(c);for(var c=this._selectedAction.allowed,d=this._selectedTypeIndex=0;d<c.length;d++)if(c[d].type==b.type){this._selectedTypeIndex=
d;break}this._toggleButton.setLabel(c[this._selectedTypeIndex].label);c=normalizeCoords(b.target);this._coordsText.setValue(c);this._noteText.setValue(b.note||"");this.fireChangeValue()},setActionEnabled:function(b){this._attackButton.setEnabled(b)},getActionEnabled:function(){return this._attackButton.getEnabled()},addCount:function(b){var c=this._counterLabel.getValue()||"";this._counterLabel.setValue(c+b)},removeLastCount:function(){var b=this._counterLabel.getValue()||"";0<b.length&&this._counterLabel.setValue(b.substr(0,
b.length-1))},resetCount:function(){this._counterLabel.resetValue()},_actionByName:function(b){for(var c=0;c<this.ATTACK_ACTIONS.length;c++)if(this.ATTACK_ACTIONS[c].name==b)return this.ATTACK_ACTIONS[c];return this.ATTACK_ACTIONS[0]}}});
qx.Class.define("ava.TimePicker",{extend:qx.ui.container.Composite,construct:function(b){this.base(arguments);this.buildUI(b)},properties:{value:{check:"Date",init:new Date(0),apply:"_applyValue"}},events:{changeValue:"qx.event.type.Data"},members:{_dateSelect:null,_hourText:null,_minuteText:null,_secondText:null,_applyingValue:!1,_updatingValue:!1,buildUI:function(b){var c=qx.core.Init.getApplication();this.setLayout(new qx.ui.layout.HBox(5));null!=b&&(b=new qx.ui.basic.Label(b),b.set({width:60,
allowGrowX:!1}),this.add(b));this._hourText=new qx.ui.form.TextField("0");this._hourText.set({width:26,maxLength:2});this._hourText.addListener("changeValue",this._onValidateHour,this._hourText);c.setElementModalInput(this._hourText);this.add(this._hourText);this._minuteText=new qx.ui.form.TextField("0");this._minuteText.set({width:26,maxLength:2});this._minuteText.addListener("changeValue",this._onValidateMinute,this._minuteText);c.setElementModalInput(this._minuteText);this.add(this._minuteText);
this._secondText=new qx.ui.form.TextField("0");this._secondText.set({width:26,maxLength:2});this._secondText.addListener("changeValue",this._onValidateMinute,this._secondText);c.setElementModalInput(this._secondText);this.add(this._secondText);this._dateSelect=new qx.ui.form.SelectBox;this._dateSelect.set({width:90});this._dateSelect.add(new qx.ui.form.ListItem("Today",null,0));this._dateSelect.add(new qx.ui.form.ListItem("Tomorrow",null,1));this._dateSelect.add(new qx.ui.form.ListItem("2 Days",null,
2));this._dateSelect.add(new qx.ui.form.ListItem("3 Days",null,3));this._dateSelect.add(new qx.ui.form.ListItem("4 Days",null,4));this._dateSelect.add(new qx.ui.form.ListItem("5 Days",null,5));this._dateSelect.add(new qx.ui.form.ListItem("6 Days",null,6));this._dateSelect.add(new qx.ui.form.ListItem("7 Days",null,7));this.add(this._dateSelect);this._hourText.addListener("changeValue",this._updateValue,this);this._minuteText.addListener("changeValue",this._updateValue,this);this._secondText.addListener("changeValue",
this._updateValue,this);this._dateSelect.addListener("changeSelection",this._updateValue,this)},fireChangeValue:function(){this.fireDataEvent("changeValue",this.getValue())},_applyValue:function(b){if(!this._updatingValue){webfrontend.data.ServerTime.getInstance().getServerStep();var c=webfrontend.Util.getCurrentTime().getTime(),d=new Date(c),c=new Date(b.getTime());d.setHours(0);d.setMinutes(0);d.setSeconds(0);d.setMilliseconds(0);c.setHours(0);c.setMinutes(0);c.setSeconds(0);c.setMilliseconds(0);
d=Math.floor(d.getTime()/864E5);c=Math.floor(c.getTime()/864E5)-d;this._applyingValue=!0;this._hourText.setValue(String(b.getHours()));this._minuteText.setValue(String(b.getMinutes()));this._secondText.setValue(String(b.getSeconds()));this._dateSelect.setModelSelection([c]);this.fireChangeValue()}},_updateValue:function(){if(!this._applyingValue){var b=Number(this._hourText.getValue()),c=Number(this._minuteText.getValue()),d=Number(this._secondText.getValue()),e=this._dateSelect.getSelection()[0].getModel(),
e=Number(e);webfrontend.data.ServerTime.getInstance().getServerStep();var f=webfrontend.Util.getCurrentTime().getTime(),e=new Date(f+864E5*e);e.setHours(b);e.setMinutes(c);e.setSeconds(d);e.setMilliseconds(0);this._updatingValue=!0;this.setValue(e);this.fireChangeValue()}},_onValidateHour:function(b){var c=Math.floor(Number(b.getData()));23<c?(b.stopPropagation(),this.setValue("23")):0>c||isNaN(c)?(b.stopPropagation(),this.setValue("0")):String(c)!=b.getData()&&(b.stopPropagation(),this.setValue(String(c)))},
_onValidateMinute:function(b){var c=Math.floor(Number(b.getData()));59<c?(b.stopPropagation(),this.setValue("59")):0>c||isNaN(c)?(b.stopPropagation(),this.setValue("0")):String(c)!=b.getData()&&(b.stopPropagation(),this.setValue(String(c)))}}});
qx.Class.define("ava.CancelOrderPanel",{extend:qx.ui.container.Composite,construct:function(){this.base(arguments);this.buildUI()},statics:{getOrderList:function(b){var c=webfrontend.data.City.getInstance().getUnitOrders(),d=[];null!=c&&c.forEach(function(c){b(c)&&d.push(c.id)});return d},cancelAll:function(b,c){var d=this.getOrderList(function(b){return ava.CombatTools.canOrderBeCancelled(b)||8==b.type&&0!=b.recurringType});paDebug("Orders to cancel: "+d.length);ava.CombatTools.cancelOrders(d,b,
c)},cancelAllRaids:function(b,c){var d=this.getOrderList(function(b){return 8==b.type&&(0!=b.recurringType||ava.CombatTools.canOrderBeCancelled(b))});paDebug("Orders to cancel: "+d.length);ava.CombatTools.cancelOrders(d,b,c)}},members:{_cancelRaidsButton:null,_cancelRaidsSelect:null,buildUI:function(){this.setLayout(new qx.ui.layout.VBox(5));var b=new qx.ui.container.Composite;b.setLayout(new qx.ui.layout.HBox(2));b.set({width:118});this._cancelRaidsSelect=(new qx.ui.form.SelectBox).set({width:80,
maxWidth:80,toolTipText:"Cancel all raid orders or alter to return in the specified number of hours.",paddingTop:0,paddingBottom:0});this._cancelRaidsSelect.add(new qx.ui.form.ListItem("C Raids",null,0));this._cancelRaidsSelect.add(new qx.ui.form.ListItem("C All",null,1));this._cancelRaidsSelect.add(new qx.ui.form.ListItem("C all city group raids",null,110));this._cancelRaidsSelect.add(new qx.ui.form.ListItem("Complete",null,100));this._cancelRaidsSelect.add(new qx.ui.form.ListItem("Set rtn time",
null,2));this._cancelRaidsSelect.add(new qx.ui.form.ListItem("Rtn 6h",null,6));this._cancelRaidsSelect.add(new qx.ui.form.ListItem("Rtn 12h",null,12));this._cancelRaidsSelect.add(new qx.ui.form.ListItem("Rtn 18h",null,18));this._cancelRaidsSelect.add(new qx.ui.form.ListItem("Rtn 24h",null,24));this._cancelRaidsSelect.add(new qx.ui.form.ListItem("Rtn 36h",null,36));this._cancelRaidsSelect.add(new qx.ui.form.ListItem("Rtn 48h",null,48));this._cancelRaidsSelect.add(new qx.ui.form.ListItem("Rtn 72h",
null,72));this._cancelRaidsSelect.setMaxListHeight(500);this._cancelRaidsButton=new qx.ui.form.Button("Go");this._cancelRaidsButton.set({width:23,maxWidth:23,appearance:"button-text-small",toolTipText:"Apply to raid orders."});this._cancelRaidsButton.addListener("execute",this.cancelAllRaids,this);b.add(this._cancelRaidsSelect);b.add(this._cancelRaidsButton);this.add(b);b=new qx.ui.container.Composite;b.setLayout(new qx.ui.layout.HBox(2));b.set({width:100});this.add(b)},_setButtonsEnabled:function(b){this._cancelRaidsButton.setEnabled(!0)},
returnBy:function(){var b=ava.ReturnByWindow.getInstance();b.center();b.show();this._setButtonsEnabled(!0)},cancelAll:function(){confirm("Do you want to cancel all orders?")?(this._setButtonsEnabled(!1),this.self(arguments).cancelAll(function(b){this._setButtonsEnabled(!0);b&&paDebug(b)},this)):this._setButtonsEnabled(!0)},cancelAllRaids:function(){this._setButtonsEnabled(!1);var b=this._cancelRaidsSelect.getSelection()[0].getModel();if(0==b)this.self(arguments).cancelAllRaids(function(b){this._setButtonsEnabled(!0);
b&&paDebug(b)},this);else if(1==b)this.cancelAll();else if(2==b)this.returnBy();else if(100==b){var c=webfrontend.data.City.getInstance().unitOrders,d=webfrontend.net.CommandManager.getInstance(),e;for(e in c)8==c[e].type&&d.sendCommand("UnitOrderSetRecurringOptions",{cityid:webfrontend.data.City.getInstance().getId(),id:c[e].id,isDelayed:c[e].isDelayed,recurringType:1,recurringEndStep:webfrontend.Util.getCurrentTime().getTime()},this,function(b){b&&paDebug(b)});this._setButtonsEnabled(!0)}else if(110==
b)addConsumerX("COMO",this.cancelRaids,this,"a");else{c=webfrontend.data.ServerTime.getInstance();d=webfrontend.Util.getCurrentTime();d.setHours(d.getHours()+parseInt(b));b=d.getTime();c=c.getServerStep();d=webfrontend.Util.getCurrentTime().getTime();b=c+(Math.floor((b-d)/1E3)+1);c=webfrontend.data.City.getInstance().unitOrders;d=webfrontend.net.CommandManager.getInstance();for(e in c)8==c[e].type&&d.sendCommand("UnitOrderSetRecurringOptions",{cityid:webfrontend.data.City.getInstance().getId(),id:c[e].id,
isDelayed:c[e].isDelayed,recurringType:2,recurringEndStep:b},this,function(b){b&&paDebug(b)});this._setButtonsEnabled(!0)}},sendCancelOrder:function(b){webfrontend.net.CommandManager.getInstance().sendCommand("UnitOrderSetRecurringOptions",b,null,function(b,d){})},cancelOrder:function(b,c){var d=this;setTimeout(function(){d.sendCancelOrder(b)},c)},hasCity:function(b,c){var d=!1,e;for(e in b)if(c==e){d=!0;break}return d},showContinueMessage:function(b,c,d,e){var f=new qx.ui.window.Window("Continue?");
f.setLayout(new qx.ui.layout.VBox(2));f.set({showMaximize:!1,showMinimize:!1,allowMaximize:!1,width:400,height:80});f.lbl=(new qx.ui.basic.Label(b)).set({rich:!0});f.add(f.lbl);b=new qx.ui.container.Composite(new qx.ui.layout.HBox(2));f.add(b);var g=(new qx.ui.form.Button("Yes")).set({appearance:"button-text-small",width:80,paddingLeft:5,paddingRight:5,paddingTop:0,paddingBottom:0});g.win=f;g.requestArray=d;b.add(g);g.addListener("click",function(){ava.Chat.getInstance().addChatMessage(c,!1);for(var b=
this.requestArray,d=200,f=0;f<b.length;f++)e.cancelOrder(qx.lang.Json.parse(b[f]),d),d+=200;this.win.hide()});d=(new qx.ui.form.Button("No")).set({appearance:"button-text-small",width:80,paddingLeft:5,paddingRight:5,paddingTop:0,paddingBottom:0});d.win=f;b.add(d);d.addListener("click",function(){this.win.hide()});f.addListener("close",function(){},this);f.center();f.open()},cancelRaids:function(b,c){if(null!=b){removeConsumerX("COMO",c.cancelRaids,c);var d=webfrontend.data.ServerTime.getInstance(),
e=webfrontend.data.Player.getInstance().cities;new qx.util.StringBuilder(2048);for(var f=0,g=qx.core.Init.getApplication(),h=webfrontend.data.Player.getInstance(),k,g=g.cityBar.citiesSelect.getSelectedGroupId(),l=0;l<h.citygroups.length;++l)if(h.citygroups[l].i==g){k=h.citygroups[l].c;break}if(!k){k=[];for(var m in e)k.push(Number(m))}h=[];for(m=0;m<b.length;m++)if(g=b[m],g.hasOwnProperty("c")&&0<=k.indexOf(g.i)&&(0==e.length||c.hasCity(e,g.i)))for(l=0;l<g.c.length;l++){var n=g.c[l];8==n.t&&(0!=n.r||
2!=n.s&&n.es>d.getServerStep()-600)&&(++f,h.push('{"cityid":'+g.i+', "id":'+n.i+', "isDelayed":'+(0==n.s)+', "recurringType": 0}'))}0<f?(k=f,d=Math.floor(k/3600),e=Math.floor((k-3600*d)/60),k=Math.floor(k-3600*d-60*e),d=padNN(d)+":"+padNN(e)+":"+padNN(k),c.showContinueMessage("Are you sure? "+f+" orders will be sent.  This will take approximately "+d+"."," Sending "+f+" cancel orders.  This will take approximately "+d+".",h,c)):ava.Chat.getInstance().addChatMessage(" No raids found to be cancelled.",
!1)}c._setButtonsEnabled(!0)}}});
qx.Class.define("ava.CombatWindow",{type:"singleton",extend:qx.ui.window.Window,construct:function(){this.base(arguments,"Combat Tool");this._rows=[];this.buildUI();this.loadData();this._listener_cityChanged=webfrontend.data.City.getInstance().addListener("changeVersion",function(){this.isVisible()&&(this.refresh(),this._setActionEnabled(!0),this._lock_safeguard=null)},this);this.addListener("appear",function(){this.refresh();this.resetMessage()},this);this.addListener("changeActive",function(b){b.getData()||
this.storeData()},this)},destruct:function(){var b=webfrontend.data.City.getInstance();this._listener_cityChanged&&b.removeListenerById(this._listener_cityChanged)},members:{_addButton:null,_resetButton:null,_messageLabel:null,_AvailableLabel:null,_includeActive:null,_allowPartial:null,_useScouts:null,_useSmallestForFakes:null,_excludeDefenseCheck:null,_forceMsCheck:null,_travelModeGroup:null,_rows:null,_magicTime:null,_infTime:null,_cavTime:null,_siegeTime:null,_copyButton:null,_listener_cityChanged:null,
_lock_safeguard:null,buildUI:function(){this.setLayout(new qx.ui.layout.VBox(5));this.set({allowMaximize:!1,allowMinimize:!1,showMaximize:!1,showMinimize:!1,showStatusbar:!1,showClose:!1,contentPadding:5,useMoveFrame:!0,resizable:!1,minWidth:545});webfrontend.gui.Util.formatWinClose(this);this._messageLabel=new qx.ui.basic.Label;this._messageLabel.set({textColor:"#D10600",wrap:!0});this.add(this._messageLabel);this._magicTime=new ava.TimePicker("Magic");this._cavTime=new ava.TimePicker("CAvalry");
this._infTime=new ava.TimePicker("Infantry");this._siegeTime=new ava.TimePicker("Siege");this._copyButton=new qx.ui.form.Button("Copy");this._copyButton.set({appearance:"button-text-small"});this._copyButton.addListener("execute",this.copyTimes,this);var b=new qx.ui.container.Composite;b.setLayout(new qx.ui.layout.HBox(5));b.add(this._magicTime);b.add(this._copyButton);var c=new qx.ui.container.Composite(new qx.ui.layout.VBox(5));c.add(b);c.add(this._cavTime);c.add(this._infTime);c.add(this._siegeTime);
var d=new qx.ui.form.Button("Import/Export");d.set({appearance:"button-text-small",allowGrowX:!1,toolTipText:"Import or export attacks configuration."});d.addListener("execute",function(){var b=ava.CombatWindowExport.getInstance();b.center();b.open()},this);this._resetButton=new qx.ui.form.Button("Reset");this._resetButton.set({appearance:"button-text-small",allowGrowX:!1,toolTipText:"Resets all values in the dialog."});this._resetButton.addListener("execute",function(){confirm("Are you sure you want to throw away all your plans?")&&
this.reset()},this);b=new qx.ui.container.Composite(new qx.ui.layout.HBox(5));b.add(d);b.add(this._resetButton);this._includeActive=new qx.ui.form.CheckBox("Include units out of the city");this._includeActive.setToolTipText("If checked, units currently out of the city (raiding/plundering etc) will be included into commands. You are supposed to get them home in time by yourself.");this._includeActive.initValue(!0);this._includeActive.addListener("changeValue",this.refresh,this);this._allowPartial=
new qx.ui.form.CheckBox("Allow partial nAval attack");this._allowPartial.setToolTipText("When there are not enough Frigates to carry your troops, it allows to send only part of the army that will fit on the ships. Has no effect on land attacks.");this._useScouts=new qx.ui.form.CheckBox("Include scouts in the attacks");this._useScouts.setToolTipText("All Available scouts will be sent along other units. If there will be enough scouts, they will be also used for fakes.");this._useScouts.setValue(!0);
this._useScouts.addListener("changeValue",this.refresh,this);this._useSmallestForFakes=new qx.ui.form.CheckBox("Prefer smallest stack for fakes instead of largest");this._useSmallestForFakes.setToolTipText("By default, unit you have the most of is used for fakes. This changes the order.");this._useSmallestForFakes.setEnabled(!1);this._useSmallestForFakes.exclude();this._forceMsCheck=new qx.ui.form.CheckBox("Always use 3000 min TS");this._forceMsCheck.set({toolTipText:"Always use 3000 min TS."});this._forceMsCheck.setValue(!0);
this._excludeDefenseCheck=new qx.ui.form.CheckBox("Exclude Defense");this._excludeDefenseCheck.set({toolTipText:"Don't use defensive troops."});this._excludeDefenseCheck.setValue(!0);this._excludeDefenseCheck.addListener("changeValue",this.refresh,this);var e=new qx.ui.basic.Label("Travel mode"),f=new qx.ui.form.RadioButton("Auto");f.set({model:"auto",toolTipText:"Units will be sent on foot if the target is on the same continent. Otherwise ships will be used."});var g=new qx.ui.form.RadioButton("Navy");
g.set({model:"navy",toolTipText:"Units will be send on Frigates even to the target on the same continent. Does not affect ships."});var h=new qx.ui.form.RadioButton("Land (Moongate)");h.set({model:"land",toolTipText:"Units will be sent on foot even if the target is on different continent. Does not use ships at all."});d=new qx.ui.container.Composite(new qx.ui.layout.Grid(5,2));d.add(e,{row:0,column:0});d.add(f,{row:0,column:1});d.add(g,{row:1,column:1});d.add(h,{row:2,column:1});this._travelModeGroup=
new qx.ui.form.RadioGroup(f,g,h);this._travelModeGroup.addListener("changeSelection",this.refresh,this);e=new qx.ui.container.Composite(new qx.ui.layout.VBox(5));e.add(b);e.add(this._includeActive);e.add(this._allowPartial);e.add(this._useScouts);e.add(this._useSmallestForFakes);e.add(this._forceMsCheck);e.add(this._excludeDefenseCheck);e.add(d);b=new qx.ui.container.Composite(new qx.ui.layout.HBox(40));b.add(c);b.add(e);this.add(b);c=this._AvailableLabel=new qx.ui.basic.Label;c.set({width:250,wrap:!0});
b=new qx.ui.form.Button("Refresh");b.set({appearance:"button-text-small"});b.addListener("execute",this.refresh,this);d=new qx.ui.form.Button("RC");d.set({appearance:"button-text-small",toolTipText:"Reset the indicative counter."});d.addListener("execute",this.resetCounter,this);e=new qx.ui.container.Composite;e.setLayout(new qx.ui.layout.HBox(5));e.add(c);e.add(b);e.add((new qx.ui.core.Widget).set({height:1}),{flex:1});e.add(d);this.add(e);this.scrollContainer=(new qx.ui.container.Scroll).set({width:550,
height:20});this.scrollContainer.setMaxHeight(300);this.scrollContainer.setMinHeight(20);this.insideScrollContainer=new qx.ui.container.Composite;this.scrollArea=new qx.ui.layout.VBox;this.insideScrollContainer.setLayout(this.scrollArea);this.scrollContainer.add(this.insideScrollContainer);this.add(this.scrollContainer);c=this._addButton=new qx.ui.form.Button("Add");c.set({appearance:"button-text-small",allowGrowX:!1,toolTipText:"Adds new target field."});c.addListener("execute",this.addRow,this);
this.add(c);c=new qx.ui.basic.Label("<em>Note: Send fake before real attacks.</em>");c.setRich(!0);this.add(c);this.addRow()},addRow:function(){var b=new ava.AttackOrder;b.addListener("attack",this.onAttack,this);this.scrollContainer.setHeight(this.scrollContainer.getHeight()+23);this.insideScrollContainer.add(b);this._rows.push(b);15<this._rows.length&&this._addButton.setEnabled(!1);return b},_removeRow:function(b){this.insideScrollContainer.remove(b);this.scrollContainer.setHeight(this.scrollContainer.getHeight()-
23);b.dispose()},_setActionEnabled:function(b){this._rows.forEach(function(c){c.setActionEnabled(b)})},reset:function(){this._rows.forEach(this._removeRow,this);this._rows=[];this.addRow();this._addButton.setEnabled(!0);this._magicTime.resetValue();this._cavTime.resetValue();this._infTime.resetValue();this._siegeTime.resetValue();this._includeActive.setValue(!1);this._allowPartial.setValue(!1);this._useScouts.setValue(!0);this._useSmallestForFakes.setValue(!1);this._forceMsCheck.setValue(!0);this._excludeDefenseCheck.setValue(!0);
this._travelModeGroup.resetSelection()},resetCounter:function(){this._rows.forEach(function(b){b.resetCount()},this)},refresh:function(){var b=webfrontend.data.City.getInstance(),c=ava.CombatTools,d=this._includeActive.getValue(),e=this._excludeDefenseCheck.getValue(),f="land"==this.getTravelMode(),g="";c.getAvailableUnits(b,d,e,f).all.forEach(function(b){0<b.count&&(0<g.length&&(g+=", "),g+=b.count+" "+b.name)});0==g.length&&(g="No troops Available");this._AvailableLabel.setValue(g)},onAttack:function(b){var c=
this,d=b.getData(),e=b.getTarget(),f=this.getAttackDetails(d.target,d.type,d.attack);b=this.getMinAttackTS();if(0<b&&"fake"!=d.attack&&"fakecap"!=d.attack&&f.attackTS<b)throw Error("Minimal troop count for the attack not met");c._setActionEnabled(!1);var g=c._lock_safeguard=Math.random();paDebug("Attack lock = "+g);setTimeout(function(){paDebug("Attack lock timeout: _this._lock_safeguard="+c._lock_safeguard+" lockId="+g);c._lock_safeguard==g&&c._setActionEnabled(!0)},1E4);ava.CombatTools.orderUnits(f.units,
f.target,f.type,f.timingType,f.time,function(b,d){if(0==d.r0){var g=f.isPartial?"Partial attack sent":"Attack sent",g=g+(" ("+f.attackTS+" TS)");c.setMessage(g);e.addCount((f.attackType||"").toUpperCase())}else paDebug(d.r0+":"+d.r1),g=ava.CombatTools.getErrorMessage(d.r0),c.setMessage("Unable to dispatch troops: "+g),c._setActionEnabled(!0),c._lock_safeguard=null});this.storeData()},getTravelMode:function(){var b=this._travelModeGroup.getSelection()[0];return b?b.getModel():null},getAttackTimes:function(){var b=
webfrontend.data.ServerTime.getInstance().getServerOffset(),c=6E4*-(new Date).getTimezoneOffset(),d=(new Date(this._siegeTime.getValue().getTime()-b+c)).getTime();return{i:(new Date(this._infTime.getValue().getTime()-b+c)).getTime(),m:(new Date(this._magicTime.getValue().getTime()-b+c)).getTime(),c:(new Date(this._cavTime.getValue().getTime()-b+c)).getTime(),s:d,d:d}},getAttackDetails:function(b,c,d){var e=webfrontend.data.City.getInstance(),f=webfrontend.data.Server.getInstance(),g=ava.CombatTools,
h=this._includeActive.getValue(),k=this._useScouts.getValue(),l=this._excludeDefenseCheck.getValue(),m=this._allowPartial.getValue(),n=this.getTravelMode(),p=this._forceMsCheck.getValue()?ava.CombatTools.DEFAULT_MIN_TS:null,h=g.getAvailableUnits(e,h,l,"land"==n),l="navy"==n||0<h.ships.length;l||"land"==n||(n=new Coord(b),f=f.getContinentFromCoords(n.x,n.y),n=(new Coord(e.getId())).getCont(),l=f!=n);if(l&&!e.getOnWater())throw Error("Unable to launch nAval attack from land-locked castle");e=null;"fake"==
d||"fakecap"==d?(k&&(e=g.prepareScoutAttackUnits(h,l,!0,!1,p),c=1),null==e&&(e=g.prepareFakeAttackUnits(h,l,p,"fakecap"==d))):e="scout"==d?g.prepareScoutAttackUnits(h,l,!1,m,p):g.prepareRealAttackUnits(h,l,"demo"==d,"capture"==d,k,m,p);d=g.getMajorAttackType(e.units);k=this.getAttackTimes()[d];if(null==k)throw Error("Unknown time of the attack");"d"==d&&(c=5);return{target:b,type:c,units:e.units,attackTS:e.totalTS,timingType:g.ARRIVAL_TIMING_ID,time:k,isPartial:e.isPartial,attackType:d}},copyTimes:function(){var b=
this._magicTime.getValue();this._cavTime.setValue(b);this._infTime.setValue(b);this._siegeTime.setValue(b)},getMinAttackTS:function(){return 1},resetMessage:function(){this._messageLabel.setValue("")},setMessage:function(b){this._messageLabel.setValue(b||"")},getData:function(){var b=ava.CombatTools,c={times:{magic:b.convertGameTimeToUtc(this._magicTime.getValue()),inf:b.convertGameTimeToUtc(this._infTime.getValue()),cav:b.convertGameTimeToUtc(this._cavTime.getValue()),siege:b.convertGameTimeToUtc(this._siegeTime.getValue())},
targets:[],includeActive:this._includeActive.getValue(),allowPartial:this._allowPartial.getValue(),useScouts:this._useScouts.getValue(),useSmallestForFakes:this._useSmallestForFakes.getValue(),excludeDefense:this._excludeDefenseCheck.getValue(),forceMs:this._forceMsCheck.getValue(),travelMode:this.getTravelMode()};this._rows.forEach(function(b){b=b.getValue();null!=b&&c.targets.push(b)});return c},setData:function(b){var c=this,d=ava.CombatTools;this.reset();if(b.times){var e=(new Date).getTime();
b.times.magic&&b.times.magic>e&&this._magicTime.setValue(d.convertUtcToGameTime(b.times.magic));b.times.inf&&b.times.inf>e&&this._infTime.setValue(d.convertUtcToGameTime(b.times.inf));b.times.cav&&b.times.cav>e&&this._cavTime.setValue(d.convertUtcToGameTime(b.times.cav));b.times.siege&&b.times.siege>e&&this._siegeTime.setValue(d.convertUtcToGameTime(b.times.siege))}b.targets&&0<b.targets.length&&(this._rows.forEach(this._removeRow,this),this._rows=[],b.targets.forEach(function(b){c.addRow().setValue(b)}));
this._includeActive.setValue(null!=b.includeActive?b.includeActive:!0);this._allowPartial.setValue(!!b.allowPartial);this._useScouts.setValue(null!=b.useScouts?b.useScouts:!0);this._useSmallestForFakes.setValue(!!b.useSmallestForFakes);this._excludeDefenseCheck.setValue(!!b.excludeDefense);this._forceMsCheck.setValue(!!b.forceMs);this._travelModeGroup.setModelSelection([b.travelMode||"auto"])},getStoragePath:function(){return"ava.CombatWindow."+webfrontend.data.Player.getInstance().getId()},storeData:function(){var b=
this.getStoragePath(),c=this.getData();localStorage.setItem(b,qx.lang.Json.stringify(c));paDebug("CombatWindow data stored")},loadData:function(){var b=this.getStoragePath(),b=qx.lang.Json.parse(localStorage.getItem(b));null!=b?(this.setData(b),paDebug("CombatWindow data loaded")):(this.reset(),paDebug("CombatWindow data had no data to load"))}}});
qx.Class.define("ava.CombatWindowExport",{type:"singleton",extend:qx.ui.window.Window,construct:function(){this.base(arguments,"Commands Import/Export");this.buildUI()},statics:{ORDER_TYPES:{1:"scout",2:"plunder",3:"assault",4:"support",5:"siege"},_formatTime:function(b){b=ava.CombatTools.convertUtcToGameTime(b,1);var c=qx.lang.String.pad(String(b.getFullYear()),4,"0")+"/",c=c+(qx.lang.String.pad(String(b.getMonth()+1),2,"0")+"/"),c=c+(qx.lang.String.pad(String(b.getDate()),2,"0")+" "),c=c+(qx.lang.String.pad(String(b.getHours()),
2,"0")+":"),c=c+(qx.lang.String.pad(String(b.getMinutes()),2,"0")+":");return c+=qx.lang.String.pad(String(b.getSeconds()),2,"0")},_parseTime:function(b){return(b=b.match(/^\s*(\d{4})\/?(\d{1,2})\/?(\d{1,2})\s+(\d{1,2}):(\d{1,2}):(\d{1,2})\s*$/))?ava.CombatTools.convertGameTimeToUtc(new Date(b[1],b[2]-1,b[3],b[4],b[5],b[6],0),1):null},dataToString:function(b,c){var d=[],e=webfrontend.data.Server.getInstance().getName();d.push(e.replace(/\s*\(.*\)\s*/,""));b.times&&(e=(new Date).getTime(),b.times.magic&&
b.times.magic>e&&d.push("Magic "+this._formatTime(b.times.magic)),b.times.cav&&b.times.cav>e&&d.push("Cavalry "+this._formatTime(b.times.cav)),b.times.inf&&b.times.inf>e&&d.push("Infantry "+this._formatTime(b.times.inf)),b.times.siege&&b.times.siege>e&&d.push("Siege "+this._formatTime(b.times.siege)));b.targets&&0<b.targets.length&&b.targets.forEach(function(b){var c=b.note&&0<b.note.length?" - "+b.note:"";d.push(qx.lang.String.capitalize(b.target+" "+b.attack+" "+(ava.CombatWindowExport.ORDER_TYPES[b.type]||
b.type))+c)});return d.join(c)},parseData:function(b,c){var d={times:{magic:0,inf:0,cav:0,siege:0},targets:[]};b.split(c).forEach(function(b){b=removeBBcode(b).trim();var c;if(c=b.match(/^magic\s+(.*)$/i))b=ava.CombatWindowExport._parseTime(c[1]),null!=b&&(d.times.magic=b);else if(c=b.match(/^infantry\s+(.*)$/i))b=ava.CombatWindowExport._parseTime(c[1]),null!=b&&(d.times.inf=b);else if(c=b.match(/^cavalry\s+(.*)$/i))b=ava.CombatWindowExport._parseTime(c[1]),null!=b&&(d.times.cav=b);else if(c=b.match(/^siege\s+(.*)$/i))b=
ava.CombatWindowExport._parseTime(c[1]),null!=b&&(d.times.siege=b);else if(b=b.match(/^(\d{1,3}:\d{1,3})\s+(fake|capture|demo|attack|scout)\s+(plunder|siege|assault|scout)\b\s*(.*)$/i))c=qx.lang.Object.getKeyFromValue(ava.CombatWindowExport.ORDER_TYPES,b[3].toLowerCase()),d.targets.push({target:b[1],attack:b[2].toLowerCase(),type:c,note:(b[4]||"").replace(/^\s*-\s*/,"")})});1>qx.lang.Object.getValues(d.times).length&&delete d.times;1>d.targets.length&&delete d.targets;return d}},members:{_compactCheck:null,
_contentText:null,_importButton:null,_exportButton:null,_closeButton:null,buildUI:function(){var b=qx.core.Init.getApplication();this.setLayout(new qx.ui.layout.VBox(5));this.set({allowMaximize:!1,allowMinimize:!1,showMaximize:!1,showMinimize:!1,showStatusbar:!1,showClose:!1,contentPadding:5,useMoveFrame:!0,resizable:!0});this.set({width:250,height:300});webfrontend.gui.Util.formatWinClose(this);var c=new qx.ui.basic.Label("<em>Note: Time is always in Server Time</em>");c.setRich(!0);this.add(c,{flex:0});
c=this._contentText=new qx.ui.form.TextArea("");b.setElementModalInput(c);this.add(c,{flex:1});b=this._compactCheck=new qx.ui.form.CheckBox("Compact");b.set({toolTipText:"Use single-line format."});b.addListener("changeValue",this.exportData,this);this.add(b,{flex:0});b=this._exportButton=new qx.ui.form.Button("Refresh");b.set({width:80,toolTipText:"Generate text from the Advanced Commands window."});b.addListener("execute",this.exportData,this);c=this._importButton=new qx.ui.form.Button("Import!");
c.set({width:80,toolTipText:"Import data into the dialog."});c.addListener("execute",this.importData,this);var d=this._closeButton=new qx.ui.form.Button("Close");d.set({width:80,toolTipText:"Closes the dialog."});d.addListener("execute",this.hide,this);var e=new qx.ui.container.Composite;e.setLayout(new qx.ui.layout.HBox(5));e.set({alignX:"right"});e.add(b);e.add(c);e.add(d);this.add(e,{flex:0})},exportData:function(){this._contentText.setValue("");var b=this._compactCheck.getValue()?"|":"\n",c=ava.CombatWindow.getInstance().getData(),
b=ava.CombatWindowExport.dataToString(c,b);this._contentText.setValue(b);this._contentText.selectAllText();this._contentText.focus()},importData:function(){var b=this._contentText.getValue(),b=ava.CombatWindowExport.parseData(b,/[\n|]/),c=ava.CombatWindow.getInstance();c.setData(b);c._forceMsCheck.setValue(!0)}}});var citySort=null;function stricmp(b,c){var d=b.toLowerCase(),e=c.toLowerCase();return d<e?-1:d==e?0:1}
function addOption(b,c,d,e){d=new qx.ui.form.CheckBox(d);d.setValue(avaMain.options[c]);d.addListener("click",function(){var b=this.getValue()?!0:!1;avaMain.options[c]=b;e&&e(b)},d);b.tabPages[0].vbox.add(d)}
qx.Class.define("ava.optionsPage",{extend:webfrontend.gui.OverlayWidget,type:"singleton",construct:function(){this.base(arguments);webfrontend.gui.OverlayWidget.call(this);var b=this,c=qx.core.Init.getApplication();b.clientArea.setLayout(new qx.ui.layout.Canvas);b.setTitle("Ava Tools Options");b.tabView=(new qx.ui.tabview.TabView).set({contentPaddingLeft:15,contentPaddingRight:10,contentPaddingTop:10,contentPaddingBottom:10});b.tabPages=[{name:"General",page:null,vbox:null}];for(var d=0;d<this.tabPages.length;d++){var e=
new qx.ui.tabview.Page(this.tabPages[d].name);e.setLayout(new qx.ui.layout.Canvas);var f=new qx.ui.container.Composite(new qx.ui.layout.VBox(10)),g=new qx.ui.container.Scroll(f);e.add(g,{top:0,left:0,right:0,bottom:0});this.tabPages[d].vbox=f;this.tabPages[d].page=e}var e=ava.Main.getInstance(),h=new qx.ui.form.CheckBox("Hide Ava Tools panel at load");e.options.hideAvaTools&&h.setValue(!0);h.addListener("click",function(){ava.Main.getInstance().options.hideAvaTools=h.getValue()?!0:!1},h);this.tabPages[0].vbox.add(h);
addOption(b,"sortByReference","Sort by reference at start");addOption(b,"enableClosestHub","Enable TM buttons",function(b){null!=ava.Main.getInstance().panel.useClosestHubButton&&ava.Main.getInstance().panel.useClosestHubButton.setVisibility(b?"visible":"excluded")});d=new qx.ui.container.Composite(new qx.ui.layout.HBox(4));f=new qx.ui.basic.Label("Name");f.setAlignY("middle");d.add(f);b.nameTxt=new qx.ui.form.TextField;b.nameTxt.set({toolTipText:"Name of the preset"});b.nameTxt.setAlignY("middle");
c.setElementModalInput(b.nameTxt);b.nameTxt.setValue("");d.add(b.nameTxt);f=new qx.ui.basic.Label("Wood");f.setAlignY("middle");d.add(f);b.woodTxt=new qx.ui.form.TextField;b.woodTxt.set({width:60,toolTipText:"Amount of wood to set"});b.woodTxt.setAlignY("middle");c.setElementModalInput(b.woodTxt);b.woodTxt.setValue("0");d.add(b.woodTxt);f=new qx.ui.basic.Label("Stone");f.setAlignY("middle");d.add(f);b.stoneTxt=new qx.ui.form.TextField;b.stoneTxt.set({width:60,toolTipText:"Amount of stone to set"});
c.setElementModalInput(b.stoneTxt);b.stoneTxt.setAlignY("middle");b.stoneTxt.setValue("0");d.add(b.stoneTxt);f=new qx.ui.basic.Label("Iron");f.setAlignY("middle");d.add(f);b.ironTxt=new qx.ui.form.TextField;b.ironTxt.set({width:60,toolTipText:"Amount of iron to set"});c.setElementModalInput(b.ironTxt);b.ironTxt.setAlignY("middle");b.ironTxt.setValue("0");d.add(b.ironTxt);f=new qx.ui.basic.Label("Food");f.setAlignY("middle");d.add(f);b.foodTxt=new qx.ui.form.TextField;b.foodTxt.set({width:60,toolTipText:"Amount of food to set"});
c.setElementModalInput(b.foodTxt);b.foodTxt.setAlignY("middle");b.foodTxt.setValue("0");d.add(b.foodTxt);b.tabPages[0].vbox.add(d);d=new qx.ui.container.Composite(new qx.ui.layout.HBox(4));b.selBox=(new qx.ui.form.SelectBox).set({alignY:"middle",tabIndex:1,width:200});var k=new qx.ui.form.ListItem("New Item",null,-1);k.entry={name:"Add New Item",wood:0,stone:0,iron:0,food:0};b.selBox.add(k);for(var l=e.options.hubTemplates,c=0;c<l.length;++c)f=l[c],k=new qx.ui.form.ListItem(f.name,null,c),k.entry=
f,b.selBox.add(k);b.selBox.setAlignY("middle");d.add(b.selBox);b.selBox.addListener("changeSelection",function(c){null!=c&&0<c.getData().length&&(c=c.getData()[0].entry,b.nameTxt.setValue("Add New Item"==c.name?"":c.name),b.woodTxt.setValue(c.res.wood.toString()),b.stoneTxt.setValue(c.res.stone.toString()),b.ironTxt.setValue(c.res.iron.toString()),b.foodTxt.setValue(c.res.food.toString()))},b);f=new qx.ui.form.Button("Save");f.setToolTipText("Save amounts for later use.");f.selBox=b.selBox;f.addListener("execute",
function(){for(var c=ava.Main.getInstance(),d=b.nameTxt.getValue(),e=b.woodTxt.getValue(),f=b.stoneTxt.getValue(),g=b.ironTxt.getValue(),h=b.foodTxt.getValue(),l=c.options.hubTemplates,m=!1,n=0;n<l.length;++n){var p=l[n];p.name==d&&(m=!0,p.res.wood=isNaN(e)?0:parseInt(e),p.res.stone=isNaN(f)?0:parseInt(f),p.res.iron=isNaN(g)?0:parseInt(g),p.res.food=isNaN(h)?0:parseInt(h))}m||(c.options.hubTemplates[c.options.hubTemplates.length]={name:d.trim(),res:{wood:isNaN(e)?0:parseInt(e),stone:isNaN(f)?0:parseInt(f),
iron:isNaN(g)?0:parseInt(g),food:isNaN(h)?0:parseInt(h)}});b.selBox.removeAll();k=new qx.ui.form.ListItem("Add New Item",null,-1);k.entry={name:"Add New Item",res:{wood:0,stone:0,iron:0,food:0}};b.selBox.add(k);l=c.options.hubTemplates;for(n=0;n<l.length;++n)p=l[n],d=p.name,k=new qx.ui.form.ListItem(d,null,n),k.entry=p,b.selBox.add(k);if(null!=c.hubSelBox)for(c.hubSelBox.removeAll(),n=0;n<l.length;++n)p=l[n],d=p.name,k=new qx.ui.form.ListItem(d,null,n),k.entry=p,c.hubSelBox.add(k)},b);d.add(f);console.debug("erere1");
f=new qx.ui.form.Button("Remove");f.setToolTipText("Remove the selected entry.");f.selBox=b.selBox;f.addListener("execute",function(){var c=ava.Main.getInstance();if(-1!=b.getSelection()[0].getModel()){var d=b.getSelection()[0].entry;l=c.options.hubTemplates;for(var e=0;e<l.length;++e){var f=l[e];if(f.name==d.name){l.splice(e,1);break}}b.removeAll();k=new qx.ui.form.ListItem("Add New Item",null,-1);k.entry={name:"Add New Item",wood:0,stone:0,iron:0,food:0};b.add(k);l=c.options.hubTemplates;for(e=
0;e<l.length;++e)f=l[e],k=new qx.ui.form.ListItem(f.name,null,e),k.entry=f,b.add(k)}},b.selBox);d.add(f);b.tabPages[0].vbox.add(d);console.debug("33");c=new qx.ui.container.Composite(new qx.ui.layout.HBox);c.add(new qx.ui.core.Spacer(20));f=new qx.ui.basic.Label("Show city buildings window");c.add(f);c.add(new qx.ui.core.Spacer(10));for(var f=new qx.ui.form.RadioGroup,m=["Disabled","Always on","On in city view"],d=0;d<m.length;d++)g=new qx.ui.form.RadioButton(m[d]),g.setUserData("id",d),g.setGroup(f),
c.add(g),c.add(new qx.ui.core.Spacer(10));f.setSelection([f.getChildren()[e.options.showCityBuildings]]);f.addListener("changeSelection",function(){ava.Main.getInstance().options.showCityBuildings=this.getSelection()[0].getUserData("id");var b=qx.core.Init.getApplication();ava.Main.getInstance().cityBuildings.bldgsCont.setVisibility(1==ava.Main.getInstance().options.showCityBuildings||2==ava.Main.getInstance().options.showCityBuildings&&"c"==b.visMain.mapmode?"visible":"excluded");ava.Main.getInstance().cityBuildings.updateCityBuildings()},
f);b.tabPages[0].vbox.add(c);addOption(b,"showChatAlert","Alert if name mentioned in chat");addOption(b,"showWhisperAlert","Alert if someone whispers");addOption(b,"showChatAlertPhrases","Alert if one of these phrases is mentioned in chat");d=new qx.ui.form.TextField;d.setMaxWidth(300);d.set({toolTipText:"Notify me if any of these phrases are mentioned in chat. (comma or semicolon separated list)"});d.setValue(e.options.chatAlertPhrases);d.addListener("changeValue",function(){ava.Main.getInstance().options.chatAlertPhrases=
this.getValue()},d);b.tabPages[0].vbox.add(d);b.tabPages[0].vbox.add(new qx.ui.core.Spacer(0,10));addOption(b,"wantDisqus","launch Disqus on startup",function(b){b=disqusShow(b);ava.Main.getInstance().options.wantDisqus=b});addOption(b,"autostartTjs","Show TogetherJS on startup",function(b){tjsShow(b)});addOption(b,"tjsHideCursor","Disable flying fingers");addOption(b,"wantCastleCustomizations","Want Castle Customizations",function(b){FarmServiceURL=b?savedFarmServiceURL:null});addOption(b,"useLookOut360",
"Enables mail client: useLookOut360 (requires restart)");c=new qx.ui.container.Composite(new qx.ui.layout.HBox);c.add(new qx.ui.core.Spacer(20));f=new qx.ui.basic.Label("Image Source");c.add(f);c.add(new qx.ui.core.Spacer(10));f=new qx.ui.form.RadioGroup;e=" 410784 409443 409442 409441 405046 400184".split(" ");for(d=0;d<e.length;d++)g=new qx.ui.form.RadioButton(e[d]),g.setUserData("id",e[d]),g.setGroup(f),c.add(g),c.add(new qx.ui.core.Spacer(10));try{var e=[],n=f.getChildren(),p;for(p in n)n[p].$$user_label==
ava.Main.getInstance().options.imageSource&&e.push(n[p]);e.length&&f.setSelection(e)}catch(q){}f.addListener("changeSelection",function(){ava.Main.getInstance().options.imageSource=this.getSelection()[0].getUserData("id")},f);b.tabPages[0].vbox.add(c);h=new qx.ui.form.CheckBox("Show Console");addOption(b,"showConsole","Show Console",function(b){b?qx.log.appender.Console.show():qx.log.appender.Console.hide()});c=new qx.ui.container.Composite(new qx.ui.layout.HBox);f=(new qx.ui.form.Button("Save")).set({width:90,
marginLeft:30});f.addListener("click",b.saveOptions,b);c.add(f);b.expImpWin=b.createExpImpWindow();f=(new qx.ui.form.Button("Export")).set({appearance:"button-text-small",marginLeft:280});f.addListener("click",function(){var c=ava.Main.getInstance().options;b.expImpWin.setCaption("Export");b.expImpWin.setUserData("id",2);b.expImpWin.getUserData("lab").setValue("You can save _this string in a text file and import it later when needed.");b.expImpWin.getUserData("ta").setValue(qx.lang.Json.stringify(c));
b.expImpWin.open()},b);c.add(f);f=(new qx.ui.form.Button("Import")).set({appearance:"button-text-small"});f.addListener("click",function(){b.expImpWin.setCaption("Import");b.expImpWin.setUserData("id",1);b.expImpWin.getUserData("lab").setValue("Insert saved Options into text field and press OK.");b.expImpWin.getUserData("ta").setValue("");b.expImpWin.open()},b);c.add(f);for(d=0;d<b.tabPages.length;d++)b.tabView.add(b.tabPages[d].page);b.clientArea.add(b.tabView,{top:0,right:3,bottom:30,left:3});b.clientArea.add(c,
{right:3,bottom:3,left:3});b.tabView.setSelection([b.tabView.getChildren()[0]])},members:{tabView:null,tabPages:null,clrSel:null,expImpWin:null,woodTxt:null,stoneTxt:null,ironTxt:null,foodTxt:null,nameTxt:null,selBox:null,createExpImpWindow:function(){var b=this,c=new qx.ui.window.Window("");c.setLayout(new qx.ui.layout.VBox(10));c.set({showMaximize:!1,showMinimize:!1,allowMaximize:!1});c.setWidth(450);c.setHeight(200);qx.core.Init.getApplication().getRoot().add(c,{left:250,top:200});var d=new qx.ui.basic.Label("");
c.add(d);c.setUserData("lab",d);d=ava.Main.getInstance().options;d=new qx.ui.form.TextArea(qx.lang.Json.stringify(d));d.addListener("click",function(){this.selectAllText()});c.add(d,{height:65});c.setUserData("ta",d);d=(new qx.ui.form.Button("OK")).set({maxWidth:50,alignX:"center"});d.addListener("click",function(){var c=b.getUserData("id");if(1==c){var c=b.getUserData("ta").getValue(),d=qx.lang.Json.parse(c);"object"==typeof d&&null!=d?(ava.Main.getInstance().options=qx.lang.Json.parse(c),paDebug(":AvaLoad Options"),
paDebug(c),localStorage.setItem("Ava_options",c),b.close()):console.error("Inserted string is invalid");ava}else 2==c&&b.close()},c);c.add(d);return c},saveOptions:function(){var b=ava.Main.getInstance().options,b=qx.lang.Json.stringify(b);localStorage.setItem("Ava_options",b);paDebug(b);qx.core.Init.getApplication().switchOverlay(null);b=ava.Main.getInstance();if(null!=b.hubSelBox){var c=b.options.hubTemplates;b.hubSelBox.removeAll();for(var d=0;d<c.length;++d){var e=c[d],f=new qx.ui.form.ListItem(e.name,
null,d);f.entry=e;b.hubSelBox.add(f)}}}}});function DumpClass(b){var c="",d;for(d in b)if("undefined"===typeof b.__proto__[d])var e=b[d],c="function"==typeof e?c+(d.toSource()+" : "+e.toSource()+";\n"):"object"==typeof e?c+(d.toSource()+" : "+e.toSource()+";\n"):c+("var "+d.toSource()+" : "+typeof e+";\n");return c}function NativeContext(){qx.ui.root.Abstract.prototype.setNativeContextMenu(!0)}
var azureClient,azureTable,obfuscatedNames=function(){function b(){}b.update=function(){if(!b.worldData){var c=webfrontend.net.UpdateManager.getInstance().requester.WORLD.obj,d;for(d in c)if(c[d]instanceof Object&&c[d].hasOwnProperty("d")&&c[d].hasOwnProperty("c")){b.worldData=c[d];break}}if("none"==b.objData&&b.worldData)for(var e in b.worldData.d){for(d in b.worldData.d[e]){c=b.worldData.d[e][d];if(c.hasOwnProperty("d"))for(var f in c.d){c.d[f].hasOwnProperty("Type")?b.objData=d:c.d[f].hasOwnProperty("Alliance")?
b.playerData=d:b.allianceData=d;break}if("none"!=b.objData&&"none"!=b.playerData&&"none"!=b.allianceData)break}break}};b.worldData=null;b.objData="none";b.playerData="none";b.allianceData="none";return b}(),__e;(function(b){b[b.avaRaidManual=0]="avaRaidManual";b[b.avaRaidDefault=1]="avaRaidDefault";b[b.avaRaidAuto=2]="avaRaidAuto";b[b.avaRaidAutoSlow=3]="avaRaidAutoSlow"})(__e||(__e={}));
function dungName(b){switch(b){case 2:return"Sea";case 3:return"Hill";case 4:return"Mountain";case 5:return"Forest"}return"Unknown"}
var dung=function(){return function(b,c,d,e,f){this.get_Type=function(){return this.type};this.get_Level=function(){return this.level};this.get_Progress=function(){return this.progress};this.get_Coordinates=function(){return this.coords};this.get_Distance=function(){return this.distance};this.get_Id=function(){return this.id};this.type=b;this.level=c;this.progress=d;this.id=this.coords=e;this.distance=f}}(),MessageWindow=function(){function b(b,d,e,f,g){"undefined"===typeof d&&(d=350);"undefined"===
typeof e&&(e=-350);"undefined"===typeof f&&(f=420);"undefined"===typeof g&&(g=200);this.name=b;this.xPos=d;this.yPos=e;this.width=f;this.height=g;this.isOpen=!1}b.prototype.Show=function(){var b=this;if(!this.isOpen)if(this.win)this.isOpen=!0,this.win.open();else{this.win=new qx.ui.window.Window(this.name);this.win.setLayout(new qx.ui.layout.Grow);this.win.set({showMaximize:!0,showMinimize:!1,allowMaximize:!0,width:this.width,height:this.height});var d=new qx.ui.container.Scroll;this.txt=new qx.ui.basic.Label("----------------------------------");
this.txt.set({rich:!0});this.win.add(d);d.add(this.txt);this.isOpen=!0;this.win.addListener("close",function(){return b.isOpen=!1});this.win.open();this.win.moveTo(this.xPos+qx.bom.Viewport.getWidth(window)/2-160,this.yPos/4+qx.bom.Viewport.getHeight(window)/2-120)}};b.prototype.Clear=function(){this.txt&&this.txt.setValue("")};b.prototype.Append=function(b){this.Show();this.txt.setValue(this.txt.getValue()+"<br>"+b+"<br>")};b.prototype.prepend=function(b){this.Show();this.txt.setValue(b+"<br><br>"+
this.txt.getValue())};b.prototype.Set=function(b){this.Clear();this.Append(b)};b.prototype.Hide=function(){this.isOpen&&this.win&&this.win.hide()};return b}(),azureMessages=new MessageWindow("AvatarAzure",0,-600),raidingMessages=new MessageWindow("AvaRaid",0,300);function setAzureMessage(b){webfrontend.ui.MessageBox.messageBox({title:"AvatarAzure",text:b,textRich:!0,minWidth:300,maxWidth:400})}
function RaidingWindowEnumProperties(b,c){for(var d in b.__proto__)void 0!=b.__proto__.__proto__[d]||"string"!=typeof b[d]&&"number"!=typeof b[d]&&"boolean"!=typeof b[d]||"$"==d[0]||"_"==d[0]||(console.log(typeof b[d]+":"+d.toString()+"->"+b[d].toString()),c(b,d))}function GetStoreName(b,c){return"__s."+b.classname+"."+c.toString()}
function RaidingWindowSave(){var b=ava.RaidingWindow.getInstance();RaidingWindowEnumProperties(b,function(b,d){localStorage.setItem(GetStoreName(b,d),b[d])});b.pvpTable&&(localStorage.avaMru=qx.lang.Json.stringify(b.getMru()))}function ParseBool(b){return"string"!=typeof b?b:"true"==b||"True"==b||0<parseInt(b,10)}function loadMru(){var b=ava.RaidingWindow.getInstance();if(b.pvpTable){var c=localStorage.avaMru;c&&(c=qx.lang.Json.parse(c),b.setMru(c))}else setTimeout(loadMru,3E3)}
function RaidingWindowLoad(){try{var b=ava.RaidingWindow.getInstance();console.log("LoadingMembers");RaidingWindowEnumProperties(b,function(b,c){var f=localStorage.getItem(GetStoreName(b,c));null!=f&&(console.log(c.toString()+" <- "+f.toString()),b[c]="number"==typeof b[c]?parseFloat(f):"boolean"==typeof b[c]?"true"==f||"True"==f||0<parseInt(f,10):f)});loadMru()}catch(c){}}
function CreateCheckBox(b,c,d,e,f){var g=(new qx.ui.form.CheckBox(c)).set({marginLeft:5,marginRight:5});g.setToolTipText(e);g.setValue(ParseBool(b[c]));d.add(g,f);g.addListener("changeValue",function(d){b[c]=d.getData();RaidingWindowSave()});return g}
qx.Class.define("ava.RaidReporter",{type:"singleton",extend:qx.core.Object,statics:{dungeonLoot:{"Giant Spider":25,Thief:33,Centaur:70,Troll:290,Skeleton:25,Ghoul:33,Gargoyle:135,Daemon:340,Orc:30,Troglodyte:40,Ettin:120,Minotaur:250,"Pirate Dhow":75,"Pirate Sloop":250,"Pirate Frigate":650,"Pirate War Galleon":1400}},members:{interceptOnReport:function(b,c,d){var e=qx.core.Init.getApplication(),f=e.getReportPage();f.origOnReport(b,c,d);if(null!=c){b=f.reportBody.getChildren();for(var g=0;g<b.length;g++)if(b[g]instanceof
qx.ui.core.Spacer){b=c.h.t.substr(0,5);b.charAt(1);b.charAt(4);var h=webfrontend.res.Main.getInstance();if(c.hasOwnProperty("r")&&null!=c.r&&c.hasOwnProperty("a")&&null!=c.a){var k={0:0,1:0,2:0,3:0,4:0},l={0:0,1:0,2:0,3:0,4:0};b=0;var m=!1;d=0;var n=[],p=webfrontend.res.Main.getInstance(),q=null,r=0;if(c.hasOwnProperty("r")&&null!=c.r)for(var t=0;t<c.r.length;t++)if(0<=c.r[t].t)k[c.r[t].t]=c.r[t].v;else{var u=Math.abs(c.r[t].t),r=c.r[t].v,q=new qx.ui.basic.Image("webfrontend/"+p.imageFiles[p.items[u].i]);
q.itemId=String(u);q.set({padding:2,toolTipText:p.items[u].dn+"<br/>"+p.items[u].sds});q.setWidth(30);q.setHeight(30);q.setScale(!0)}if(c.hasOwnProperty("a")&&null!=c.a)for(t=0;t<c.a.length;t++)if(p=c.a[t],0==p.r){if(null!=p.u)for(u=0;u<p.u.length;u++){var s=p.u[u].t;if(h.units.hasOwnProperty(s)){var s=h.units[s],v=p.u[u].o-p.u[u].l,w;for(w in s.res)l[w]+=s.res[w]*v;l[0]+=s.g*v}}}else if(null!=p.u){for(u=0;u<p.u.length;u++)s=p.u[u].t,h.units.hasOwnProperty(s)&&(s=h.units[s],ava.RaidReporter.dungeonLoot.hasOwnProperty(s.dn)&&
(b+=ava.RaidReporter.dungeonLoot[s.dn]*p.u[u].o,n[u]={},n[u].armytype=s.dn,n[u].armysize=p.u[u].o,m=!0));m&&(d=p.c[0].i)}w=k[0]+k[1]+k[2]+k[3]+k[4];n=new qx.ui.container.Composite;n.setLayout(new qx.ui.layout.HBox(5));q&&(t=new qx.ui.basic.Label,t.setAlignY("middle"),t.setRich(!0),t.setFont("bold"),t.setValue("+"+r),t.setTextColor("green"),n.add(q),n.add(t),n.add((new qx.ui.core.Spacer).set({width:5})));for(t=1;5>=t;t++)q=5==t?0:t,r=k[q]-l[q],q=new qx.ui.basic.Label,q.setAlignY("middle"),q.setRich(!0),
q.setFont("bold"),0==r?q.setValue("+0"):0<=r?(q.setValue("+"+webfrontend.gui.Util.formatNumbers(r).toString()),q.setTextColor("green")):(q.setValue(webfrontend.gui.Util.formatNumbers(r).toString()),q.setTextColor("red")),5==t?r=new qx.ui.basic.Image(webfrontend.config.Config.getInstance().getUIImagePath("ui/icons_ressource_gold.png")):(r=h.getFileInfo(h.resources[t].i),r=new qx.ui.basic.Image(r.url)),r.setWidth(30),r.setHeight(30),r.setScale(!0),n.add(r),n.add(q),n.add((new qx.ui.core.Spacer).set({width:5}));
h=new qx.ui.basic.Label("Report Summary:");h.setRich(!0);h.setAppearance("textheader_main1_serif");e.getReportPage().reportBody.addAt(h,g++);e.getReportPage().reportBody.addAt(n,g++);m&&(h="",e=!0,c.rcc<b?(c=(w-k[0])/b*100,k="green",60>c?k="red":80>c?k="#AF7817":100<c&&(e=!1),h='<b style="color:'+k+'">'+c+"%  Underkill:</b>  Gained "+c.toFixed(2)+"% of "+webfrontend.gui.Util.formatNumbers(b).toString()):(c=b/c.rcc*100,k="green",75>c?k="red":90>c?k="#AF7817":100<c&&(e=!1),h='<b style="color:'+k+'">'+
c+"%  Overkill:</b>  Only "+c.toFixed(2)+"% of troops needed for max loot ("+webfrontend.gui.Util.formatNumbers(b).toString()+")"),e&&(c=new qx.ui.basic.Label,c.setRich(!0),c.setAllowGrowX(!0),c.setValue(h),f.reportBody.addAt(c,g++)));f.reportBody.addAt((new qx.ui.core.Spacer).set({height:5}),g++);f.reportBody.addAt((new qx.ui.core.Widget).set({backgroundColor:"#c4a77b",height:2,allowGrowX:!0}),g++);m&&(f=ava.RaidingWindow.getInstance(),null!=f.curDungeon&&f.curDungeon.get_Coordinates()==d&&(f.dungeonLootInfo.hasOwnProperty(d)?
(g=f.dungeonLootInfo[d],m=g.n,c=g.l/(m+1)*m+b/(m+1),g.n=m+1,g.l=Math.floor(c),b>g.mx&&(g.mx=b),b<g.mn&&(g.mn=b)):f.dungeonLootInfo[d]=void 0,f.updateDungeonRaidInfo(d)))}break}}}}});
qx.Class.define("ava.LastLogin",{type:"singleton",extend:qx.ui.window.Window,construct:function(){this.base(arguments,"Alliance Info");this.buildUI()},members:{donations:null,mDataArray:null,mDataRank:null,buildUI:function(){qx.core.Init.getApplication();this.setLayout(new qx.ui.layout.VBox(2));this.set({allowMaximize:!1,allowMinimize:!1,showMaximize:!1,showMinimize:!1,showStatusbar:!1,showClose:!0,contentPadding:5,useMoveFrame:!0,resizable:!1});this.setWidth(930);var b=new qx.ui.basic.Label("Alliance Members Info");
b.set({font:"bold"});this.add(b);b=new qx.ui.table.model.Simple;b.setColumns("id;;;status;name;title;score;cities;role;lastLogin;Donations;Donations Rank;World Rank".split(";"));b.setCaseSensitiveSorting(!1);b.sortByColumn(1,!0);this.loginTable=new qx.ui.table.Table(b);this.loginTable.onCellClick=function(b){var c=this.getTableModel().getValue(b.getColumn(),b.getRow());switch(b.getColumn()){case 4:b=qx.core.Init.getApplication(),b.showInfoPage(b.getPlayerInfoPage(),{name:c})}};this.loginTable.addListener("cellClick",
this.loginTable.onCellClick,this.loginTable);b=this.loginTable.getTableColumnModel();b.setColumnVisible(0,!1);b.setColumnWidth(1,60);b.setColumnVisible(1,!1);b.setColumnVisible(2,!1);b.setColumnWidth(3,64);b.setColumnWidth(4,120);b.setColumnWidth(5,64);b.setColumnWidth(6,80);b.setColumnWidth(7,44);b.setColumnWidth(8,100);b.setColumnWidth(9,110);b.setColumnWidth(10,90);b.setColumnWidth(11,90);b.setColumnWidth(12,70);var c=new qx.ui.table.cellrenderer.Default;c.setDefaultCellStyle("text-decoration:underline;color:blue;cursor:pointer");
b.setDataCellRenderer(4,c);this.add(this.loginTable,{flex:1});this.addListener("appear",this.onOpen,this)},onOpen:function(){var b=this.loginTable.getTableModel();b.removeRows(0,b.getRowCount());b.addRows([[0,"Loading..."]]);webfrontend.data.Alliance.getInstance().getMemberData();this.mDataArray=[];webfrontend.net.CommandManager.getInstance().sendCommand("AllianceResourceStatistic",{sortColumnIndex:-1,ascending:!0,start:0,end:500},this,this.gotDonations)},gotDonations:function(b,c){this.donations=
[];if(b&&null!=c)for(var d=0;d<c.length;++d){var e=c[d];this.donations[e.pn]=[e.r,e.ra]}webfrontend.net.CommandManager.getInstance().sendCommand("AllianceGetMemberInfos",{},this,this.fillLoginTable)},fillLoginTable:function(b,c){var d=this.loginTable.getTableModel();if(!1==b||null==c)0==e.length&&d.setData([["No data."]]);else{var e=[];webfrontend.data.Alliance.getInstance().getMemberData();for(var f=webfrontend.data.Alliance.getInstance().getRoles(),g=["offline","online","afk","hidden"],h=new qx.util.format.DateFormat("yyyy.MM.dd HH:mm"),
k=webfrontend.res.Main.getInstance().playerTitles,l=0;l<c.length;l++){var m=c[l],n=new Date(m.l);n.setHours(n.getHours()+webfrontend.data.ServerTime.getInstance().getServerOffset()/1E3/60/60);e.push([m.i,"","",g.hasOwnProperty(m.o)?g[m.o]:m.o,m.n,k[m.t].dn,m.p,m.c,null!=f?f[m.r].Name:m.r,h.format(n),this.donations.hasOwnProperty(m.n)?this.donations[m.n][0]:"",this.donations.hasOwnProperty(m.n)?this.donations[m.n][1]:"",m.ra])}0==e.length?d.setData([["No data."]]):(d.setData(e),d.sortByColumn(4,!0))}}}});
qx.Class.define("ava.FillWithResourcesWindow",{type:"singleton",extend:qx.ui.window.Window,construct:function(){this.base(arguments,"Fill With Resources")},members:{WOOD:1,STONE:2,IRON:3,FOOD:4,initialized:!1,toX:null,toY:null,sbResType:null,maxResourcesInput:null,maxTravelTimeInput:null,cbAllowSameContinent:null,cbAllowOtherContinent:null,cbPalaceSupport:null,lblTarget:null,cityInfos:{},progressLabel:null,timer:null,activateOverlay:function(b){},buildUI:function(){if(!this.initialized){this.initialized=
!0;this.setLayout(new qx.ui.layout.Dock);this.set({width:500,minWidth:200,maxWidth:1600,height:350,minHeight:200,maxHeight:600,allowMaximize:!1,allowMinimize:!1,showMaximize:!1,showMinimize:!1,showStatusbar:!1,showClose:!0,caption:"Fill With Resoruces",resizeSensitivity:7,contentPadding:0});var b=new qx.ui.container.Composite;b.setLayout(new qx.ui.layout.VBox(5));webfrontend.res.Main.getInstance();var c=new qx.ui.container.Scroll;b.add(c,{flex:!0});c.add(this.createForm());b.add(this.createFooter());
this.add(b);this.moveTo(400,200);b=qx.core.Init.getApplication();b=b.cityDetailView||b.getCityDetailView();b.hasOwnProperty("originalSetCity1")||(b.originalSetCity1=b.setCity,b.fill=this,b.setCity=this.interceptSetCity)}},createFooter:function(){var b=new qx.ui.groupbox.GroupBox;b.setLayout(new qx.ui.layout.Flow(5,5));var c=new qx.ui.form.Button("Request Resources");c.setWidth(160);b.add(c);c.addListener("click",this.searchTarget,this);this.progressLabel=new qx.ui.basic.Label("");b.add(this.progressLabel);
return b},interceptSetCity:function(b){var c=qx.core.Init.getApplication(),c=c.cityDetailView||c.getCityDetailView();c.hasOwnProperty("originalSetCity1")&&c.originalSetCity1(b);b=convertIdToCoordinatesObject(b.get_Coordinates());c.fill.toX.setValue(""+b.x);c.fill.toY.setValue(""+b.y)},fillResources:function(){var b=parseInt(this.toX.getValue(),10),c=parseInt(this.toY.getValue(),10);0==b&&0==c?showMsgWindow("Fill with Resoruces","Invalid destination"):(b=convertCoordinatesToId(b,c),void 0==this.cityInfos[b]||
null==this.cityInfos[b]?showMsgWindow("Fill with Resoruces","Invalid destination"):(c=this.cityInfos[b],b={maxResourcesToBeSent:parseInt(this.maxResourcesInput.getValue()),cityId:b,maxTravelTime:parseInt(this.maxTravelTimeInput.getValue()),targetPlayer:c.pn,palaceSupport:this.cbPalaceSupport.getValue(),resType:parseInt(this.sbResType.getSelection()[0].getModel()),allowSameContinent:this.cbAllowSameContinent.getValue(),allowOtherContinent:this.cbAllowOtherContinent.getValue()},this.populateCityWithResources(b)))},
populateCityWithResources:function(b){webfrontend.net.CommandManager.getInstance().sendCommand("TradeSearchResources",{cityid:b.cityId,resType:b.resType,minResource:1E4,maxTime:b.maxTravelTime*webfrontend.data.ServerTime.getInstance().getStepsPerHour()},this,this._processTradeSearchResources,b)},_processTradeSearchResources:function(b,c,d){if(!1!=b&&null!=c){this.progressLabel.setValue("Sent resources: 0");b=[];for(var e=[],f=convertIdToCoordinatesObject(d.cityId),g=0;g<c.length;g++){var h=c[g],k=
convertIdToCoordinatesObject(h.i);h.i==d.cityId||h.sg||f.getCont()==k.getCont()&&!d.allowSameContinent||f.getCont()!=k.getCont()&&!d.allowOtherContinent||(b.push(h),0<h.lt&&e.push({cityIndex:b.length-1,capacity:h.la,travelTime:h.lt,land:!0}),0<h.st&&e.push({cityIndex:b.length-1,capacity:h.sa,travelTime:h.st,land:!1}))}e.sort(function(b,c){return b.travelTime>c.travelTime?1:b.travelTime<c.travelTime?-1:0});c=d.maxResourcesToBeSent;for(var g=h=0,l=e.length;g<l;g++){var m=e[g],n=b[m.cityIndex],k=convertIdToCoordinatesObject(n.i);
if(0>=c)break;k=Math.min(n.rc,m.capacity,c);0>=k||(m={cityid:n.i,tradeTransportType:m.land?1:2,targetPlayer:d.targetPlayer,targetCity:f.toString(),palaceSupport:d.palaceSupport,res:[]},m.res.push({t:d.resType,c:k}),h+=k,n.rc-=k,c-=k,this.progressLabel.setValue("Sent resources: "+h),webfrontend.net.CommandManager.getInstance().sendCommand("TradeDirect",m,this,this._onTradeDirectSendDone,m))}}},_onTradeDirectSendDone:function(b,c,d){},createForm:function(){var b=new qx.ui.container.Composite(new qx.ui.layout.Dock),
c=new qx.ui.groupbox.GroupBox;c.setLayout(new qx.ui.layout.Grid(20,10));b.add(c);var d=0;c.add(new qx.ui.basic.Label("Resource Type"),{row:d,column:0});this.sbResType=(new qx.ui.form.SelectBox).set({width:320,height:28});this.sbResType.add(new qx.ui.form.ListItem("Wood",null,this.WOOD));this.sbResType.add(new qx.ui.form.ListItem("Stone",null,this.STONE));this.sbResType.add(new qx.ui.form.ListItem("Iron",null,this.IRON));this.sbResType.add(new qx.ui.form.ListItem("Food",null,this.FOOD));c.add(this.sbResType,
{row:d,column:1});d++;c.add(new qx.ui.basic.Label("to"),{row:d,column:0});var e=new qx.ui.container.Composite(new qx.ui.layout.HBox(5));this.toX=new qx.ui.form.TextField("");this.toX.setWidth(40);e.add(this.toX);this.toY=new qx.ui.form.TextField("");this.toY.setWidth(40);e.add(this.toY);var f=new qx.ui.form.Button("Current City");f.setWidth(120);c.add(f);f.addListener("click",this.setCurrentCityAsTarget,this);e.add(f);c.add(e,{row:d,column:1});d++;c.add(new qx.ui.basic.Label("Max Resources to Send"),
{row:d,column:0});e=new qx.ui.container.Composite(new qx.ui.layout.HBox(5));this.maxResourcesInput=new webfrontend.ui.SpinnerInt(0,0,1E8);this.maxResourcesInput.setWidth(100);e.add(this.maxResourcesInput);e.add(this._createIncreaseAmountBtn("500k",5E5));e.add(this._createIncreaseAmountBtn("1M",1E6));e.add(this._createIncreaseAmountBtn("5M",5E6));e.add(this._createIncreaseAmountBtn("10M",1E7));c.add(e,{row:d,column:1});d++;c.add(new qx.ui.basic.Label("Max Travel Time"),{row:d,column:0});e=new qx.ui.container.Composite(new qx.ui.layout.HBox(5));
this.maxTravelTimeInput=new webfrontend.ui.SpinnerInt(24,1,96);this.maxTravelTimeInput.setWidth(100);e.add(this.maxTravelTimeInput);e.add(this._createMaxTravelTimeBtn("24h",24));e.add(this._createMaxTravelTimeBtn("48h",48));e.add(this._createMaxTravelTimeBtn("96h",96));c.add(e,{row:d,column:1});d++;this.cbAllowSameContinent=new qx.ui.form.CheckBox("Include cities from the same continent as target");this.cbAllowSameContinent.setToolTipText("Include cities from the same continent as target");this.cbAllowSameContinent.setValue(!0);
c.add(this.cbAllowSameContinent,{row:d,column:1});d++;this.cbAllowOtherContinent=new qx.ui.form.CheckBox("Include cities from other continents than target");this.cbAllowOtherContinent.setToolTipText("Include cities from other continents than target");this.cbAllowOtherContinent.setValue(!0);c.add(this.cbAllowOtherContinent,{row:d,column:1});d++;this.cbPalaceSupport=new qx.ui.form.CheckBox("Palace delivery");this.cbPalaceSupport.setToolTipText("Sends resources as palace deliver (wood and stone only)");
this.cbPalaceSupport.setValue(!1);c.add(this.cbPalaceSupport,{row:d,column:1});return b},_createMaxTravelTimeBtn:function(b,c){var d=(new qx.ui.form.Button(b)).set({appearance:"button-recruiting",font:"bold",width:50});d.addListener("click",function(b){this.maxTravelTimeInput.setValue(c)},this);return d},_createIncreaseAmountBtn:function(b,c){var d=(new qx.ui.form.Button(b)).set({appearance:"button-recruiting",font:"bold",width:50});d.addListener("click",function(b){this.maxResourcesInput.setValue(this.maxResourcesInput.getValue()+
c)},this);return d},searchTarget:function(){var b=parseInt(this.toX.getValue(),10),c=parseInt(this.toY.getValue(),10),b=convertCoordinatesToId(b,c);webfrontend.net.CommandManager.getInstance().sendCommand("GetPublicCityInfo",{id:b},this,this._onCityInfo,b)},_onCityInfo:function(b,c,d){b&&null!=c&&(this.cityInfos[d]=c,this.fillResources())},setCurrentCityAsTarget:function(){var b=webfrontend.data.City.getInstance(),b=convertIdToCoordinatesObject(b.getId());this.toX.setValue(""+b.x);this.toY.setValue(""+
b.y)},_updateSendingProgress:function(){}}});var distWantModifier=0.675,distReallyWantModifier=0.375;function unitShortName(b){switch(b){case 3:return"Rng";case 4:return"Grd";case 5:return"Tmp";case 6:return"Zrk";case 7:return"Mge";case 9:return"Xbw";case 10:return"Pal";case 11:return"Knt";case 12:return"Lck";case 15:return"Frg";case 16:return"Slp";case 17:return"WG"}return webfrontend.res.Main.getInstance().units[b].dn}
function dungShortName(b){switch(b){case 2:return"Sea";case 3:return"Hil";case 4:return"Mtn";case 5:return"For"}return"Unk"}
qx.Class.define("ava.IdleRaidUnitsTable",{extend:qx.ui.table.Table,implement:[webfrontend.net.IUpdateConsumer],type:"singleton",construct:function(){console.debug("Idle raid Units ctor");var b=new qx.ui.table.model.Simple;b.setColumns("CityID TS Type City Ref Cont Coords %TS".split(" "));this.tableModel=b;qx.ui.table.Table.call(this,b,{tableColumnModel:function(b){return new qx.ui.table.columnmodel.Resize(b)}});this.addListener("cellClick",this.onCellClick,this);b=this.getTableColumnModel();b.setColumnVisible(0,
!1);var c=new qx.ui.table.cellrenderer.Default;c.setDefaultCellStyle("text-decoration:underline;color:blue");b.setDataCellRenderer(3,c);b.setDataCellRenderer(6,c)},members:{curRow:0,curId:0,onCellClick:function(b){this.curRow=b.getRow();var c=new Coord(this.getTableModel().getValue(0,this.curRow));this.curId=c.getId();switch(b.getColumn()){default:case 3:c.openCity(!0);break;case 6:c.showOnMap()}},updateCityTS:function(b,c){for(var d=this.getTableModel(),e=0;e<d.getRowCount();e++)if(d.getValue(0,
e)==b){d.setValue(1,e,c);break}},buildUI:function(){},refresh:function(){removeConsumerX("COMO",this.DispatchResultsRw,this);addConsumerX("COMO",this.DispatchResultsRw,this,"a")},getRequestDetails:function(b){return"a"},DispatchResultsRw:function(b){var c=ava.RaidingWindow.getInstance(),d=ava.IdleRaidUnitsTable.getInstance();assert(d==this);c.autoUpdate||removeConsumerX("COMO",this.DispatchResultsRw,this);if(null!=b){var e=webfrontend.res.Main.getInstance();webfrontend.data.Server.getInstance();var f=
webfrontend.data.Player.getInstance().cities,d=d.getTableModel(),g=webfrontend.data.City.getInstance().getId();c.rnf&&(c.rnf.length=0);c.rnmts&&(c.rnmts.length=0);var h=0,k=[],l=c.cityGroups.getSelection();0<l.length&&(l=l[0].cids);var m=c.excludeIf.getValue(),n=c.excludeShips,p="",q=!1,r=Number(c.excludeTs.getValue()),t=d.getSortColumnIndex(),u=d.isSortAscending();if(0<m.length)for(var p=m.split(","),s=0;s<p.length;++s)if(0<p[s].length){q=!0;break}for(m=0;m<b.length;m++){var v=b[m];if(v.hasOwnProperty("c")&&
(0==l.length||0<=l.indexOf(v.i))){for(var w=new Coord(v.i),y=!0,x="",z=0,A=0,B=0;B<v.c.length;B++)if(s=v.c[B],0==s.i)for(var C=0;C<s.u.length;C++){var E=e.units[s.u[C].t],G=s.u[C].c;0<G&&0<E.c&&(!n||E.ls)&&(y||(x+=","),x+=unitShortName(s.u[C].t),z+=G*E.uc,A+=G*E.uc,y=!1,v.i==g&&(h+=G))}else if(0>parseInt(s.i,10))for(C=0;C<s.u.length;C++)E=e.units[s.u[C].t],G=s.u[C].c,0<G&&0<E.c&&(!n||E.ls)&&(z-=G*E.uc,v.i==g&&(h-=G));else for(C=0;C<s.u.length;C++)E=e.units[s.u[C].t],G=s.u[C].c,0<G&&0<E.c&&(!n||E.ls)&&
(A+=G*E.uc);if(!y){y=w.getCont();B="";f.hasOwnProperty(v.i)&&(B=f[v.i].reference);C=0<r&&z<r;if(q)for(s=0;!C&&s<p.length;++s)C=0<=B.indexOf(p[s]);C||(A=Math.floor(100*Math.min(100,z/A*100))/100,100==A&&c.rnf&&c.rnf.push([v.i,z,x,v.n,B,y,w.format(),A]),3E4<=z&&c.rnmts&&c.rnmts.push([v.i,z,x,v.n,B,y,w.format(),A]),k.push([v.i,z,x,v.n,B,y,w.format(),A]))}}v.i==g&&c.bossUnitLabel.setValue(c.formatNumber(h))}d.setData(k);d.sortByColumn(0<=t?t:"1",0<=t?u:!1);c.nextIdleCityButton.setEnabled(!0)}}}});
function getGains(){var b=0,c=0,d=0,e=0,f=0,g=0,h=0,k=0,l=0,m=ava.RaidingWindow.getInstance(),n=webfrontend.data.City.getInstance(),p=n.getOrderLimit()-m.getAllocatedOrders(),q=m.hasSeaOnly();if(0<p&&!q)for(var r in n.units)switch(p=n.units[r].count,r){case "5":c=p;break;case "6":b=p;break;case "3":d=p;break;case "7":h=p;break;case "12":k=p;break;case "4":l=p;break;case "9":g=p;break;case "10":e=p;break;case "11":f=p}n={For:1,Mtn:1,Hil:1,Sea:1};d+=l;Math.max(d,c,e,f,g,b,h,k)!=b&&Math.max(d,c,e,f,
g,b,h,k)!=h&&Math.max(d,c,e,f,g,b,h,k)!=k&&(Math.max(d,c,e,f,g,b,h,k)==d?d>2*b?(n.For=8192,n.Hil=8192):d>b?(n.For=4,n.Hil=4):2*d>b&&(n.For=1.5,n.Hil=1.5):Math.max(d,c,e,f,g,b,h,k)==c?(n.For=8192,n.Hil=8192):Math.max(d,c,e,f,g,b,h,k)==e?(n.Hil=m.pallysAreWimps?8192:2,n.Mtn=m.pallysAreWimps?8192:2):Math.max(d,c,e,f,g,b,h,k)==g&&(n.Hil=8129,n.Mtn=8192));b=this.reallyWant?distWantModifier:distReallyWantModifier;m.wantFor&&(n.For*=b);m.wantHil&&(n.Hil*=b);m.wantMtn&&(n.Mtn*=b);return n}
qx.Class.define("ava.RaidingWindow",{type:"singleton",extend:qx.ui.window.Window,construct:function(){this.base(arguments,"Raiding")},members:{_wcText:null,_lists:null,_continents:null,_count:0,wcLabel:null,curDungeon:null,bossUnitLabel:null,bossTable:null,bossUnitImage:null,bossRaider:null,pvpTable:null,dungeonLootInfo:{},ratioMode:"count",wantAutoRaid:!1,AvaRaidMode:1,wantFor:!1,wantHil:!1,raidDuration:"72 Hours",pallysAreWimps:!1,wantMtn:!1,conserverIfTcLow:!0,refreshBoss:!1,refreshDung:!0,reallyWant:!1,
conserveIfnotFull:!1,RaidNJump:!0,autoUpdate:!1,excludeShips:!1,split:!1,tabview:null,dungeonProgressData:[[[[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],
[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1]],[[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,
-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,
-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[1243,1243],[1243,1243],[1243,1243],[1243,1243],[1243,1243],[1243,1243],[1243,1243],[1243,1243],[1243,1243],[1243,1243],[1243,1243],[1243,1243],[1243,1243],[-1,-1],[-1,-1]],[[2400,2400],[2448,2443],[2492,2485],[2538,2528],[2584,2572],[2637,2614],[2686,2658],[2736,2702],[2785,2746],[2833,2789],[2882,2833],[2930,2876],[2978,2920],[3027,2964],[3076,3008],[3124,3051],[3073,3004],[2999,2938],[2910,2857],[3213,3130],[3303,
3212],[3389,3289],[3335,3242],[3249,3166],[3140,3070],[3486,3378],[3583,3465],[3675,3547],[3740,3606],[3797,3656],[3847,3702],[3899,3748],[3948,3792],[3997,3836],[4045,3880],[4094,3924],[4142,3967],[4191,4011],[4239,4054],[4288,4098],[4336,4142],[4313,4137],[4274,4122],[4224,4099],[4455,4266],[4533,4329],[4608,4391],[4666,4441],[4720,4488],[4670,4459],[4595,4413],[4504,4355],[4811,4588],[4902,4662],[4988,4733],[5050,4787],[5106,4836],[5157,4881],[5208,4926],[5257,4970],[5306,5014],[5355,5058],[5403,
5102],[5452,5146],[5500,5189],[5548,5233],[5597,5277],[5645,5320],[5693,5363],[5742,5407],[5791,5451],[5839,5494],[5888,5538],[5936,5582],[5985,5626],[6033,5669],[6082,5713],[6130,5756],[6179,5800],[6227,5844],[6276,5888],[6324,5931],[6372,5974],[6421,6018],[6470,6062],[6518,6105],[6567,6149],[6615,6193],[6664,6237],[6712,6280],[6761,6324],[6809,6367],[6858,6411],[6906,6455],[6955,6499],[7003,6542],[7056,6590],[7111,6640],[7199,6719],[7199,6719]],[[8450,7651],[8550,8075],[8568,8073],[8869,8344],[8742,
8395],[8581,8135],[8333,8012],[8704,8264],[8924,8444],[8857,8530],[9423,8953],[9561,9165],[9819,9252],[9845,9335],[9721,9375],[10088,9616],[9852,9535],[9834,9425],[9178,8989],[9341,9118],[9290,9090],[9961,9615],[10695,10349],[11270,10662],[11570,10905],[11791,11086],[11697,11059],[11406,10942],[11035,10781],[11699,11351],[12250,11663],[12536,11888],[12564,11957],[12328,11883],[12004,11759],[12384,12044],[12974,12419],[13159,12563],[13275,12667],[13362,12773],[13193,12685],[12962,12553],[13741,13210],
[13861,13391],[13944,13552],[14326,13806],[14408,13946],[14457,14071],[14567,14054],[14378,13922],[14130,13749],[15072,14491],[15185,14643],[15245,14765],[15042,14728],[15418,15002],[15410,15066],[15862,15296],[15787,15245],[15644,15149],[15936,15622],[15984,15645],[15696,15515],[15471,15252],[16083,15732],[15978,15665],[17038,16510],[17128,16603],[16752,16320],[16162,15867],[16373,16054],[17466,17020],[17821,17481],[18111,17918],[18725,18509],[18537,18137],[18573,18137],[18960,18200],[19259,18576],
[19552,18819],[19460,18825],[19563,18946],[19668,19067],[19895,19265],[20141,19535],[20403,19829],[20261,19873],[20382,19848],[20250,19769],[20092,19672],[19898,19563],[20630,20132],[20863,20339],[21026,20542],[21023,20670],[20974,20780],[21154,20888],[21585,21138],[21970,21422],[21970,21422]],[[26425,23718],[24475,24074],[26081,24752],[27174,25026],[27689,25290],[28020,25494],[28245,25683],[28496,26159],[28171,26180],[27026,25731],[28204,26555],[27736,26427],[29604,27505],[29600,27543],[28501,26969],
[27627,27057],[28953,28535],[29508,28818],[31141,29995],[32095,30627],[31648,30335],[32880,30678],[33908,31392],[34848,32595],[34145,32495],[32879,32261],[33475,33154],[34460,34062],[34033,33395],[35182,33937],[35483,34562],[36239,35037],[35249,34595],[36758,35624],[38750,37001],[38586,37217],[37996,37214],[39942,39049],[40913,39495],[40756,39641],[41860,40054],[41905,40127],[43310,41309],[42836,41351],[41776,40941],[41899,40728],[43620,41629],[44363,42467],[44652,42896],[44322,42889],[46417,44515],
[46017,44603],[44167,43642],[43214,42940],[43180,43061],[45818,45761],[46624,46324],[47792,47171],[47605,46293],[45317,44319],[45482,44158],[45552,45148],[47361,47124],[48671,48302],[49295,48645],[50885,49887],[50605,50041],[53388,52465],[54605,53120],[55249,53878],[55194,53666],[56697,55034],[57585,55931],[57308,55362],[58346,55507],[57030,55385],[55809,55128],[56799,56158],[57862,56765],[59721,57957],[59761,58192],[60228,58555],[60907,58367],[60898,58079],[59842,58149],[61610,59614],[61710,60035],
[61961,60846],[63901,62428],[64853,63625],[64940,62951],[65350,63221],[66020,64035],[66783,65075],[66647,65533],[65295,63669],[64473,62896],[67432,64880],[68705,66410],[68705,66410]],[[60325,53311],[57625,52897],[59896,53827],[60113,54285],[59386,54478],[56899,53738],[58966,55425],[61035,57252],[61641,57482],[61805,57709],[61600,58122],[60395,57145],[58150,56433],[58953,57957],[61248,60204],[62326,60973],[63237,62087],[63714,62598],[65162,63029],[67214,65231],[68937,66182],[70317,68691],[74460,71410],
[79956,74332],[81224,75100],[81700,75409],[80526,74643],[81748,76102],[78960,75074],[77921,75508],[78064,76453],[78068,76477],[78911,78378],[79487,78673],[78121,76844],[81534,78933],[79768,77704],[81343,78580],[81523,79875],[88205,85117],[94305,88608],[96055,89614],[96772,89873],[98012,91730],[94423,89840],[87763,86047],[88674,87783],[89979,88780],[93633,91647],[99793,96788],[100009,98308],[101700,99364],[101311,97604],[95496,93287],[97960,94751],[99497,96485],[105470,100733],[108520,103506],[107499,
102581],[108628,102502],[105969,100637],[103928,101243],[109553,106598],[118404,114735],[121895,120367],[123503,122089],[122767,120569],[125002,120772],[127561,123220],[128752,122983],[131508,125865],[135333,128021],[134730,128674],[135445,129409],[133276,129589],[133041,129228],[127452,123963],[129063,124296],[125655,121714],[131219,125077],[131455,126535],[135428,130203],[135500,131522],[135811,131850],[140492,135007],[140755,136598],[140522,138154],[139643,136151],[144381,138636],[145835,140081],
[145014,140461],[143759,139706],[141819,138737],[148234,143747],[149920,146062],[152180,145788],[153629,146738],[154959,147672],[156845,149270],[156845,149270]],[[119725,106135],[120400,107908],[118692,108203],[117708,108522],[120897,110849],[123364,111833],[126952,115481],[124362,115237],[120809,115010],[117723,113784],[119276,115977],[116497,115E3],[120876,119523],[125664,124218],[128836,126845],[131641,127535],[139649,133028],[135692,132370],[134035,132160],[136333,134744],[146006,142716],[148683,
144477],[149760,143386],[145840,141674],[150070,144953],[157435,150394],[155051,151567],[157195,155538],[158476,156268],[164305,161026],[166920,160512],[166470,161624],[164737,158362],[156089,154134],[161367,159668],[169428,166477],[173573,167250],[183049,174271],[184183,176225],[186785,180501],[191202,184320],[196806,185373],[197399,186421],[195841,186052],[191657,184553],[194389,184093],[193871,183717],[192208,180363],[188311,179196],[182718,176525],[184195,178925],[194236,186284],[200102,192011],
[207703,196269],[200720,190301],[198782,190500],[198898,193863],[219143,210685],[237390,222537],[239788,223743],[237941,224797],[235994,225107],[235203,226683],[242247,228928],[245085,231573],[247363,235026],[241417,236014],[247551,242375],[252199,246483],[259882,252857],[256820,249972],[253406,251104],[240149,238622],[245492,244388],[255081,253904],[260865,258926],[270290,266619],[269315,263619],[271029,266967],[266497,259837],[271776,260251],[268983,260906],[268061,258517],[267422,260565],[272058,
261134],[287217,271292],[297591,278011],[300762,282777],[304505,286510],[309152,289465],[305890,286262],[305822,286998],[305942,290944],[304503,292470],[296983,292643],[292206,289126],[298783,294490],[308447,300110],[311285,297177],[311285,297177]],[[214600,188677],[210350,187532],[213989,193938],[213678,197545],[208667,196387],[208774,200690],[210035,200085],[222282,205427],[225307,207035],[219390,205087],[219114,208357],[230733,218774],[235094,221640],[234872,222614],[240009,227025],[243968,234245],
[248972,238593],[252105,237630],[250975,241057],[249392,242858],[261766,251597],[263697,248206],[261168,247105],[262526,251248],[279536,263502],[279064,267268],[286516,273050],[289616,279172],[291980,282013],[292235,277335],[301909,286236],[306524,290818],[318699,297947],[323709,300829],[324025,302468],[318792,303167],[328013,309482],[328128,312539],[327428,306690],[321942,302962],[326563,306768],[327482,311218],[335657,317790],[321350,311363],[310249,303670],[317315,309778],[339426,329464],[346855,
341763],[356011,345844],[371122,351070],[397642,369708],[401348,379462],[390145,373207],[395353,378739],[400054,386160],[415417,397031],[410333,394683],[409960,392268],[432765,403468],[443905,414245],[443907,414696],[445569,417628],[440139,413290],[444953,423487],[441043,428832],[446479,441380],[442953,438109],[454278,445409],[461067,443285],[458076,434010],[468776,438302],[476285,442196],[466020,437097],[470461,441010],[488601,459229],[503580,478719],[500125,490263],[484976,477876],[502477,496584],
[512534,510436],[514702,510356],[504183,496535],[506140,488789],[512735,497040],[531464,509119],[532259,519954],[543662,527701],[536457,517434],[518192,508932],[509838,497151],[528825,506445],[541619,519720],[558726,532109],[563297,544992],[567209,542141],[554545,539156],[543496,521533],[541984,520795],[557960,528295],[557960,528295]],[[351275,310377],[353850,312821],[355088,317854],[356676,320891],[360136,323300],[368405,328848],[370835,331360],[372010,332020],[371437,333860],[373974,336908],[381069,
344963],[387967,352314],[391665,354810],[397105,358944],[406921,366454],[413098,373575],[417360,380402],[424532,387390],[434959,396558],[440951,403991],[450837,410235],[449602,412004],[452875,419292],[462177,428585],[471659,435342],[486755,444364],[492018,449555],[494584,450120],[494268,454576],[495171,460950],[511896,471241],[516800,474072],[521359,478717],[526164,484187],[519501,481391],[520231,483644],[518179,483987],[530459,496708],[546729,511765],[554205,524826],[562118,529576],[563357,522583],
[571363,528361],[590014,540300],[624051,568512],[632124,588953],[646459,597011],[663948,611415],[664308,614261],[663110,610832],[677746,619594],[677783,619257],[690587,632090],[694112,642214],[709386,658254],[717058,660285],[724952,666644],[734108,667010],[732081,670985],[723460,668484],[716065,667785],[722308,672433],[729443,674154],[753039,688017],[756728,696539],[752781,699307],[745449,698046],[762199,713551],[782422,730105],[782952,743706],[774170,755296],[787387,762704],[823343,793007],[822009,
770486],[815586,772E3],[835279,788218],[834038,792621],[832800,795280],[846530,797824],[845206,800196],[846243,811858],[872765,836361],[890370,833943],[888712,836606],[874064,827794],[872199,837342],[894056,871463],[909069,883898],[903262,865E3],[904306,853327],[884190,837446],[880659,836541],[872744,833578],[878847,847103],[909584,872769],[910073,888862],[903893,873202],[911034,870815],[913314,869055],[913314,869055]],[[533250,477043],[514100,486999],[539791,489432],[536191,492700],[525671,493011],
[528443,501279],[546175,514271],[559729,527934],[550622,534312],[565133,545332],[579856,556449],[610050,568271],[622076,577182],[640042,588456],[645989,598753],[641769,607081],[633953,614861],[635174,612180],[651623,620732],[637434,620131],[656285,642897],[662812,643813],[698678,667919],[707025,686521],[715402,698554],[723926,717386],[727783,717350],[738136,721392],[739619,710459],[734107,707591],[777006,731533],[784927,735743],[790454,738545],[791563,738843],[818404,764728],[830237,776296],[835137,
787078],[836829,796096],[837037,804635],[862390,814655],[875555,831362],[898429,865325],[922106,903864],[936950,917269],[916715,886427],[916572,889773],[931402,892281],[942671,907187],[954812,924754],[951939,911609],[952557,916516],[952285,922023],[975551,929292],[986434,937301],[1009440,963827],[1033765,994553],[1059728,1028267],[1037178,990485],[1040796,991617],[1044839,993452],[1051885,999768],[1059646,1007158],[1072335,1021525],[1086197,1037561],[1100868,1054743],[1098108,1047405],[1105824,1060246],
[1113929,1074846],[1132315,1106923],[1149217,1115960],[1169790,1142158],[1154899,1110236],[1159621,1111835],[1164762,1114426],[1172175,1120962],[1199140,1153257],[1230703,1191716],[1265459,1234406],[1223272,1183102],[1221347,1185701],[1219819,1189833],[1231486,1186403],[1239654,1191881],[1248511,1198500],[1257133,1206363],[1265778,1214627],[1274402,1223119],[1285120,1232290],[1296300,1241637],[1307815,1251098],[1311077,1258273],[1318828,1266702],[1326657,1275153],[1335005,1283751],[1343475,1292383],
[1352030,1301039],[1361575,1310667],[1371351,1320515],[1386450,1335720],[1386450,1335720]]],[[[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],
[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1]],[[690,690],[703,702],[715,712],[729,725],[742,737],[755,749],[769,761],[783,774],[797,787],[811,799],[825,812],
[839,824],[853,837],[867,849],[881,862],[895,875],[908,887],[922,899],[936,912],[950,924],[964,937],[978,950],[992,962],[1006,975],[1020,987],[1034,1E3],[1048,1012],[1062,1025],[1076,1038],[1090,1050],[1104,1063],[1118,1075],[1132,1088],[1145,1100],[1159,1113],[1173,1125],[1187,1137],[1201,1150],[1215,1163],[1229,1175],[1243,1188],[1257,1200],[1271,1213],[1285,1226],[1299,1238],[1313,1251],[1327,1263],[1341,1276],[1355,1289],[1368,1301],[1358,1297],[1341,1288],[1322,1278],[1400,1334],[1396,1334],
[1386,1330],[1363,1317],[1450,1380],[1476,1401],[1501,1421],[1519,1436],[1536,1451],[1550,1464],[1564,1476],[1578,1489],[1592,1502],[1605,1514],[1619,1527],[1633,1539],[1647,1552],[1661,1564],[1675,1577],[1689,1589],[1703,1602],[1717,1615],[1731,1627],[1745,1640],[1759,1652],[1773,1665],[1787,1677],[1801,1690],[1815,1703],[1828,1715],[1842,1727],[1798,1695],[1741,1652],[1674,1602],[1770,1677],[1728,1644],[1671,1600],[1863,1754],[1909,1791],[1950,1825],[1974,1846],[1976,1860],[1972,1873],[1966,1885],
[2025,1904],[2070,1931],[2070,1931]],[[2970,2835],[3060,3060],[2988,2917],[2971,2915],[3051,2964],[3031,2953],[2922,2870],[3058,2989],[2945,2900],[3109,3046],[3078,3027],[3381,3300],[3476,3393],[3563,3477],[3626,3541],[3681,3599],[3732,3654],[3782,3707],[3831,3759],[3802,3741],[3757,3707],[3699,3662],[3942,3892],[4022,3973],[4099,4051],[4157,4112],[4210,4167],[4261,4221],[4310,4274],[4359,4326],[4407,4378],[4348,4324],[4266,4248],[4165,4154],[4487,4474],[4578,4569],[4666,4659],[4729,4725],[4787,4783],
[4844,4839],[4900,4892],[4955,4944],[5010,4996],[5065,5048],[5096,5078],[5072,5058],[5033,5024],[5083,5068],[5274,5244],[5359,5323],[5435,5394],[5422,5382],[5341,5311],[5235,5217],[5428,5400],[5630,5580],[5734,5675],[5816,5750],[5881,5811],[5942,5868],[5999,5922],[6056,5975],[6112,6027],[6167,6078],[6222,6130],[6277,6182],[6333,6233],[6388,6285],[6443,6336],[6498,6388],[6553,6439],[6608,6491],[6663,6542],[6588,6453],[6484,6331],[6188,6033],[6370,6257],[6244,6153],[6782,6653],[6925,6787],[7053,6907],
[7134,6983],[7131,6993],[7104,6984],[7062,6964],[7302,7155],[7313,7174],[7305,7180],[7267,7163],[7518,7359],[7607,7434],[7690,7507],[7755,7566],[7815,7621],[7873,7675],[7930,7727],[7990,7784],[8054,7843],[8154,7937],[8154,7937]],[[9990,9378],[9840,9840],[9864,9600],[10078,9697],[9976,9608],[9660,9370],[10299,9865],[10347,9915],[11035,10534],[11300,10791],[11543,11030],[11734,11226],[11911,11410],[12079,11586],[12244,11759],[12406,11930],[12569,12102],[12731,12273],[12893,12444],[13053,12614],[13215,
12785],[13106,12729],[12936,12622],[12722,12479],[13442,13124],[13551,13259],[13627,13369],[14169,13838],[14406,14068],[14627,14286],[14542,14241],[14310,14095],[14012,13897],[14435,14318],[14168,14028],[13595,13520],[14149,14025],[15367,15150],[15807,15570],[16064,15845],[16193,16009],[16273,16132],[16450,16272],[16236,16107],[15947,15877],[16456,16361],[17032,16896],[16965,16862],[16761,16705],[16767,16690],[17700,17574],[18015,17882],[18297,18163],[18502,18373],[18687,18565],[18857,18744],[19023,
18919],[19187,19091],[19349,19262],[19512,19434],[19674,19605],[19835,19775],[19997,19946],[20158,20117],[20320,20288],[20287,20265],[20212,20198],[19643,19637],[19743,19736],[19356,19346],[20796,20774],[20950,20924],[21020,20991],[20928,20898],[21766,21713],[22062,21998],[22161,22096],[22156,22095],[21892,21849],[22276,22211],[22237,22176],[23035,22929],[23328,23206],[23601,23465],[23888,23760],[24227,24131],[24574,24374],[24244,23860],[23788,23164],[23401,23150],[24195,23956],[23921,23769],[23611,
23550],[24545,24487],[25464,25360],[25419,25250],[25390,25224],[25259,25108],[26542,26258],[26542,26258]],[[31410,28396],[32790,29411],[31479,29157],[30828,29045],[32639,30205],[32826,30438],[32424,30434],[31712,30274],[33379,31452],[34298,32125],[34022,32113],[34466,32427],[33808,32622],[33767,32753],[33132,31828],[34956,32975],[34952,33408],[33097,32271],[34084,33205],[35102,34028],[34618,34281],[35075,34850],[37385,36924],[38544,37702],[40497,39323],[40073,39719],[39941,39732],[40784,40698],[40168,
39966],[42031,41656],[41844,40781],[43110,41879],[43852,42031],[43318,42475],[45235,44106],[46359,44538],[45835,44296],[47395,45816],[46485,45522],[46840,45707],[46582,45724],[46088,45771],[46791,46332],[48698,47657],[50963,49166],[50469,48873],[50842,50036],[49292,48556],[50109,49855],[50205,50067],[51380,51321],[52582,52263],[53680,52738],[54120,52437],[55695,53946],[54966,53548],[55847,53547],[56011,54237],[56189,53579],[56632,55055],[57935,56276],[56673,55849],[56050,55646],[57917,57390],[56646,
55829],[58919,57861],[57540,56945],[60484,59427],[64009,62095],[65459,63309],[66512,64219],[66837,64758],[67177,65364],[67442,65945],[69045,67085],[68834,67182],[69029,67662],[70209,68161],[70832,68669],[70289,68288],[69422,67707],[68634,66832],[71353,68620],[71258,68390],[69383,68280],[71958,70818],[71524,70158],[71541,70357],[70023,69360],[72996,72220],[76730,75143],[79122,77246],[80453,77582],[78052,76469],[76033,75200],[73655,72399],[76354,74114],[79211,76141],[81666,79508],[81666,79508]],[[72150,
62745],[71580,65594],[70122,64150],[72488,65902],[72167,66872],[70873,66606],[70106,67454],[69416,67732],[71800,69316],[73346,69597],[76113,72200],[76934,73490],[77509,72721],[73898,71076],[76393,72836],[77642,73777],[77912,74597],[83166,78625],[82859,79247],[85301,81830],[86659,80960],[90887,84468],[90823,85467],[91590,87462],[93798,87831],[92049,88028],[95764,90854],[94373,91709],[96679,93288],[101653,96358],[100838,97552],[100406,95351],[101545,96640],[106456,98636],[105942,98736],[102908,97908],
[103275,99703],[103416,100912],[107339,104077],[110891,106425],[107986,106630],[105802,103839],[108601,105683],[112300,107937],[110532,108064],[114671,110225],[118901,111920],[118299,111505],[119796,113283],[123921,115090],[123867,117468],[122182,118270],[123869,119430],[124628,119337],[121497,118048],[122644,118018],[127180,120955],[124289,119359],[130969,122961],[128399,121491],[132604,124865],[132888,127860],[138820,132968],[139812,136682],[144251,139759],[147168,139315],[149721,141320],[152735,
146297],[155812,152206],[155320,151321],[156127,149867],[157662,152083],[157518,148024],[158980,148610],[161105,149546],[159759,148800],[158245,148925],[155110,151035],[159515,155125],[163217,159250],[160026,154362],[157858,155185],[161650,158509],[166125,162931],[166437,161438],[170273,164241],[171249,167922],[171083,167527],[167712,165255],[168288,163865],[172980,164756],[174049,165158],[178031,167312],[179813,168597],[181430,169882],[182763,171071],[184147,172365],[185509,173672],[187590,175685],
[187590,175685]],[[145710,127730],[140070,126769],[144371,130483],[144207,130695],[146255,132804],[146665,134693],[146795,137116],[143822,136576],[148042,138368],[148800,141032],[150498,141711],[149642,141583],[150211,144438],[156875,149117],[157527,152442],[156813,152040],[159172,156134],[165871,161840],[170659,163448],[169844,164317],[167378,160132],[164127,161902],[170705,168108],[178973,173999],[180128,169853],[187498,174142],[193295,179362],[196368,183399],[195268,184526],[207634,193285],[210539,
197725],[209742,200356],[210523,199238],[201932,196230],[200750,198229],[195568,194057],[207282,203569],[218282,209060],[228606,212521],[230939,214089],[227960,213556],[230049,216383],[225688,216744],[236271,226305],[233449,230240],[231414,229433],[230423,227134],[235372,227421],[246151,233154],[245367,232888],[241152,230529],[256080,239515],[258987,241433],[267397,248504],[271160,251838],[271990,252690],[271654,252576],[271994,255361],[283687,268426],[287394,276595],[288272,273521],[285192,275009],
[297038,282194],[291670,279609],[296385,280902],[296706,283534],[299131,291097],[303994,292761],[315149,305951],[309924,297918],[299318,293641],[294709,286389],[310548,296340],[315072,301206],[318195,306689],[320608,314137],[324046,314351],[326545,309898],[328210,311049],[329587,312929],[332009,319492],[336885,323083],[337278,328224],[334005,322438],[331121,322983],[340180,329089],[346011,335715],[346311,342791],[343086,340190],[335322,330022],[344729,333338],[354913,337817],[359791,340729],[364843,
344581],[369343,348469],[372247,353324],[369932,354017],[370078,357371],[378846,357643],[378846,357643]],[[258540,227156],[249240,230153],[261488,236793],[260876,238118],[260779,238515],[264906,243864],[268628,246620],[273111,250992],[275097,252534],[273836,253411],[269533,255038],[275436,260915],[279053,261725],[279384,264317],[274154,265831],[283966,270899],[301940,281602],[316956,295582],[316548,300568],[311680,294320],[306369,291714],[315489,295940],[323445,302232],[331389,309774],[340846,320402],
[341632,324343],[347007,336355],[349151,340812],[347876,341738],[354072,344913],[364209,349982],[366434,345181],[375584,351389],[377136,351528],[369629,351840],[385742,365158],[386872,370706],[389352,375787],[391922,375606],[403010,386323],[417986,390789],[419262,392446],[416741,393905],[417678,393727],[429614,404720],[428090,405554],[423179,405864],[436625,410361],[439079,412515],[440200,413374],[451790,430293],[471884,449564],[487167,470323],[484845,465768],[516205,483151],[522808,488230],[533592,
496995],[531086,504807],[529870,503512],[536445,510052],[544713,508752],[539450,507386],[531600,501479],[534760,506015],[543376,512706],[543131,519624],[532167,519846],[532948,520257],[522783,511311],[545611,525305],[548746,524354],[549672,525353],[539701,520255],[553100,530676],[551982,541695],[556419,539853],[574787,550703],[582987,554501],[575104,554528],[589189,562223],[593549,570852],[586992,568597],[586402,562258],[579435,557618],[575985,560483],[597593,577412],[612490,588463],[625331,597910],
[636646,595656],[625469,592591],[619053,592009],[603071,587103],[617444,602726],[609112,597369],[627426,611200],[621712,600676],[646196,608305],[666435,624376],[672204,636036],[672204,636036]],[[428430,370853],[419670,373273],[426662,381635],[431352,384942],[431378,385825],[432531,389181],[433143,393249],[439538,398137],[448237,402754],[457258,407415],[459156,410786],[460132,416257],[471887,428306],[487026,437487],[497560,446644],[506570,454565],[509542,462047],[511843,467453],[515373,470645],[517025,
474310],[531752,485823],[551939,498533],[564951,511734],[564948,520289],[567245,520761],[570058,522621],[581542,531409],[598736,542385],[600545,548790],[605240,556574],[607854,557672],[618284,566943],[628603,570867],[628852,575625],[624468,580764],[617939,578101],[617410,578831],[623700,585206],[654577,602115],[665006,611523],[673682,615225],[672685,621843],[685634,634440],[718296,664528],[759770,689841],[775566,711870],[782975,718029],[793308,725070],[796268,738206],[807724,754367],[833366,776146],
[851929,775989],[860615,778039],[857288,774788],[846961,776490],[838022,775328],[852692,787752],[868791,800842],[861979,803808],[862188,800473],[843629,801044],[854989,810280],[846878,807305],[865805,817357],[887740,827375],[914472,835929],[923173,842036],[926047,853638],[914561,859298],[920235,857584],[903520,850133],[923978,860354],[931475,867511],[925158,867772],[932749,883989],[950076,908216],[943870,907505],[931448,894375],[964690,905548],[977741,922290],[994629,949955],[1003301,968944],[993584,
947871],[985230,933555],[988968,940311],[977098,944041],[1005972,960242],[1017161,965089],[1019684,975408],[1009552,969064],[1011257,977525],[1015073,983210],[1047988,996586],[1052590,1005194],[1041338,990914],[1052111,1005714],[1096654,1022537],[1102263,1025920],[1113918,1038388],[1113918,1038388]],[[656160,582434],[579390,535504],[615839,576340],[631357,588023],[657902,609625],[651402,613625],[657924,619713],[653784,607233],[662378,616073],[708418,649532],[711964,653876],[729296,670121],[702157,
659912],[691110,666931],[719991,693491],[781600,740155],[796464,765542],[802766,761966],[796893,769165],[813642,786468],[828058,794264],[815045,804123],[809163,793965],[864091,833627],[893752,835898],[913516,847869],[917386,854920],[916624,861956],[902521,866137],[928490,881368],[922390,888120],[943581,899461],[935636,903967],[951560,914874],[997940,936774],[1017085,949911],[1033562,962324],[1046421,973602],[1059191,984732],[1071537,995702],[1085381,1016484],[1092072,1043556],[1110070,1091633],[1135305,
1115720],[1181790,1146925],[1197503,1140750],[1190137,1140576],[1209994,1167859],[1194087,1126266],[1211389,1143635],[1221512,1164146],[1181985,1161709],[1164626,1145465],[1189317,1157961],[1217612,1158822],[1233713,1167461],[1247505,1176536],[1242971,1178405],[1236148,1187848],[1226778,1198172],[1282417,1242204],[1294695,1232817],[1310675,1242683],[1307169,1243701],[1299744,1244891],[1289284,1245137],[1345154,1279194],[1368953,1299083],[1392995,1319581],[1391623,1317703],[1401059,1326622],[1410073,
1335455],[1420194,1345470],[1410758,1344295],[1397098,1340765],[1380327,1335469],[1441424,1375284],[1467426,1391542],[1494282,1407577],[1517429,1420947],[1510967,1429941],[1500381,1430022],[1466536,1416915],[1427064,1399887],[1452494,1424276],[1511552,1468928],[1525621,1487703],[1557653,1502204],[1555453,1512999],[1557712,1533775],[1555642,1520577],[1604274,1543761],[1621920,1554506],[1638316,1566530],[1650989,1577455],[1662698,1588280],[1674955,1600135],[1687228,1612209],[1706015,1630814],[1706015,
1630814]]]],buildUI:function(){console.log("starting part 2");RaidingWindowLoad();console.log("build ui raiding 0");var b=webfrontend.data.City.getInstance(),c=qx.core.Init.getApplication();this.setLayout(new qx.ui.layout.HBox(1));this.set({allowMaximize:!1,allowMinimize:!1,showMaximize:!1,showMinimize:!1,showStatusbar:!1,showClose:!0,contentPadding:5,useMoveFrame:!0,useResizeFrame:!0,alignX:"right",alignY:"bottom",width:700,height:400,nativeContextMenu:!0,resizable:!0});this.setLayoutProperties({right:0,
bottom:0});console.log("build ui raiding 2");this.setCaption(b.getName()+"  "+webfrontend.gui.Util.formatCityCoordsFromId(b.getId(),!0));this.tabview=(new qx.ui.tabview.TabView).set({maxHeight:1E3,maxWidth:2E3,nativeContextMenu:!0});this.tabview.add(this.createDungeonPage());this.tabview.add(this.createBossPage());this.tabview.add(this.createIdleUnitsPage());console.log("build ui raiding 3");this.tabview.add(this.createPvpPage());this.add(this.tabview);console.log("build ui raiding 4");b=new qx.ui.basic.Image;
b.setVisibility("hidden");this.add(b);b=c.dungeonDetailView||c.getDungeonDetailView();b.hasOwnProperty("originalSetDungeon")||(b.originalSetDungeon=b.setDungeon,b.AvaRaid=this,b.setDungeon=this.interceptSetDungeon);c=c.cityDetailView||c.getCityDetailView();c.hasOwnProperty("originalSetCity")||(c.originalSetCity=c.setCity,c.AvaRaid=this,c.setCity=this.interceptSetCity);console.log("in part 2");this.updateAvailableUnits();this.updateBossRaidCity();this.autoUpdate&&webfrontend.data.City.getInstance().addListener("changeVersion",
this.updateAvailableUnits,this);webfrontend.data.City.getInstance().addListener("changeCity",this.onCityChange,this);this.addListener("appear",this.onOpen,this);this.addListener("disappear",this.onClose,this)},onResize:function(b){b.getData()},onOpen:function(){ava.IdleRaidUnitsTable.getInstance().refresh()},onClose:function(){var b=ava.IdleRaidUnitsTable.getInstance();removeConsumerX("COMO",b.DispatchResultsRw,b)},interceptSetDungeon:function(b,c){var d=qx.core.Init.getApplication(),d=d.dungeonDetailView||
d.getDungeonDetailView();d.originalSetDungeon(b,c);d.AvaRaid.curDungeon=b;d.AvaRaid.addDungeonToRaid(b)},interceptSetCity:function(b){var c=qx.core.Init.getApplication(),c=c.cityDetailView||c.getCityDetailView();c.hasOwnProperty("originalSetCity")&&c.originalSetCity(b);c.AvaRaid.addCityToRaid(b)},getSpeed:function(b){var c=0,d=webfrontend.data.City.getInstance(),e=webfrontend.res.Main.getInstance(),f=webfrontend.data.Tech.getInstance();for(b in d.units)if(0<d.units[b].count&&0<e.units[b].c&&e.units[b].ls){c=
Math.max(0,e.units[b].s/(1+f.getBonus("unitSpeed",webfrontend.data.Tech.research,parseInt(b))/100+f.getBonus("unitSpeed",webfrontend.data.Tech.shrine,parseInt(b))/100));break}return c},getMru:function(){var b=[];if(this.pvpTable)for(var c=this.pvpTable.getTableModel(),d=c.getRowCount(),e=0;e<d;++e)b.push({name:c.getValue(0,e)+"("+c.getValue(1,e)+")",pin:"true"==c.getValue(8,e)});return b},setMru:function(b){if(this.pvpTable){var c=this.pvpTable.getTableModel(),d=[],e;for(e in b){var f=b[e],g=f.name.lastIndexOf("("),
h=new Coord(f.name.substr(g)),f=[f.name.substr(0,g),h.format(),"","","",0,0,0,f.pin,""];d.push(f)}c.setData(d)}},addCityToRaid:function(b){var c=webfrontend.data.City.getInstance().getId(),d=b.get_Coordinates?b.get_Coordinates():b.getId();webfrontend.data.Player.getInstance().getName();var e=b.get_PlayerName?b.get_PlayerName():webfrontend.data.Player.getInstance().getName(),d=new Coord(d),c=new Coord(c),c=getDist(d,c).toFixed(2),d=d.format(),f=b.get_PlayerId?b.get_PlayerId():webfrontend.data.Player.getInstance().getId(),
g=b.get_AllianceName?b.get_AllianceName():webfrontend.data.Alliance.getInstance().getName(),h=0,k=b.get_Name?b.get_Name():b.getName();++h;114<h&&(h=0);b=this.pvpTable.getTableModel();for(var l=b.getRowCount(),m="false",n=0;n<l;++n)if(b.getValue(1,n)==d){m=b.getValue(8,n);b.removeRows(n,1);break}e=[k,d,e,g,"ref",c.toString(),"max",f,m,'"http://benalman.com/code/projects/javascript-emotify/shared/emoticons/Yahoo.AdiumEmoticonset/'+h.toString()+'.gif"'];l=b.getRowCount();if(l>cityMruSize)for(c=l;--c>=
cityMruSize;)"false"==b.getValue(8,c)&&b.removeRows(c,1);b.addRows([e],0)},addDungeonToRaid:function(b,c){var d=this,e=null;if(0==webfrontend.res.Main.getInstance().dungeons[b.get_Type()].b){for(var f=new Coord(b.get_Coordinates()),g=f.format(),h=!1,k=this.targetContainer.getChildren(),l=0;l<k.length;l++)k[l].getChildren()[3].getValue()==g&&(c&&(e=k[l].getChildren()[0]),h=!0);if(!h){var e=webfrontend.data.City.getInstance(),e=new Coord(e.getId()),h=getDist(e,f).toFixed(2),e=this.dungProgressType(b.type),
l=b.get_Level()-1,m=b.get_Progress(),k=this.dungeonProgressData[e][l][m][0].toString(),l=this.dungeonProgressData[e][l][m][1].toString(),m=new qx.ui.container.Composite;m.setLayout(new qx.ui.layout.Basic);var n=new qx.ui.form.Button("Add");n.set({paddingLeft:5,paddingRight:5,paddingTop:0,paddingBottom:0});m.add(n,{top:0,left:0});var p=new qx.ui.container.Composite;p.setLayout(new qx.ui.layout.VBox);n.raidcontainer=p;n.d=b;n.addListener("click",function(){d.onAddRaidButton(this)},n);e=n;parseInt(k);
n=(new qx.ui.basic.Label("L"+b.get_Level()+" "+dungShortName(b.type))).set({rich:!0,textColor:"blue"});n.d=b;b.hasOwnProperty("get_StartStep")?(paDebug("getStartStep"),n.addListener("click",function(){d.curDungeon=this.d;webfrontend.gui.Util.openDungeonProfile(this.d)})):n.addListener("click",function(){d.curDungeon=this.d;var b=qx.core.Init.getApplication();b.showInfoPage(b.getCityInfoPage(),{id:f})});m.add(n,{top:4,left:80});m.add(new qx.ui.basic.Label(b.get_Progress()+"%"),{top:4,left:130});n=
(new qx.ui.basic.Label(g)).set({rich:!0,textColor:"blue"});n.dungX=f.x;n.dungY=f.y;n.addListener("click",function(){webfrontend.gui.Util.showMapModeViewPos("r",0,this.dungX,this.dungY)});m.add(n,{top:4,left:180});m.add(new qx.ui.basic.Label(h),{top:4,left:230});g=new qx.ui.basic.Label(k);g.addListener("click",function(){0<Number(this.getValue())&&d.addRaid(this.getLayoutParent().getChildren()[0],this.getValue())});m.add(g,{top:4,left:280});g=new qx.ui.basic.Label(l);m.add(g,{top:4,left:330});n=(new qx.ui.form.Button("X")).set({paddingLeft:5,
paddingRight:5,paddingTop:0,paddingBottom:0});n.addListener("click",function(){this.getLayoutParent().destroy();d.updateAvailableUnits()});m.add(n,{top:0,left:400});m.add(p,{top:24,left:16});this.targetContainer.add(m);this.updateDungeonRaidInfo(b.get_Coordinates())}}return e},dungProgressType:function(b){switch(b){case 4:return 1}return 0},getMinBossLevel:function(){for(var b=1,c=webfrontend.data.Player.getInstance().getTitle(),d=webfrontend.res.Main.getInstance(),e=6;1<=e;e--)if(d.dungeonLevels[e].t<
c-1){b=5<c?e+1:e;break}return b},pickBossRaider:function(){var b={t:-1,s:0},c=webfrontend.data.City.getInstance(),d=webfrontend.res.Main.getInstance(),e=webfrontend.data.Tech.getInstance(),f;for(f in c.units)if((6==f||7==f||9==f||10==f||11==f||12==f||13==f||17==f)&&0<c.units[f].count&&0<d.units[f].c&&(d.units[f].ls||17==f)){b=Math.max(0,d.units[f].s/(1+e.getBonus("unitSpeed",webfrontend.data.Tech.research,parseInt(f))/100+e.getBonus("unitSpeed",webfrontend.data.Tech.shrine,parseInt(f))/100));b={t:parseInt(f),
s:b};break}return b},formatNumber:function(b){b=String(b).replace(/\,/g,"");var c=b.indexOf(".");0<=c&&(b=b.substring(0,c));if(0==b.length)return"";for(var c="",d=0,e=b.length;d<e;++d)0<c.length&&0==(b.length-d)%3&&(c+=","),c+=b.substring(d,d+1);return c},updateBossRaidCity:function(){this.bossRaider=this.pickBossRaider();this.bossTable.bossRaider=this.bossRaider;var b="hidden",c=this.bossRaider.t;if(-1!=c){var b=webfrontend.data.City.getInstance(),d=webfrontend.res.Main.getInstance();this.bossUnitImage.setSource("webfrontend/"+
d.imageFiles[d.units[c].mimg]);c=b.getUnitTypeInfo(c);this.bossUnitLabel.setValue(this.formatNumber(c.count));b="visible"}this.bossUnitImage.setVisibility(b);this.bossUnitLabel.setVisibility(b)},coordsFromCluster:function(b,c){var d=Math.floor(b/32);return 32*(b-32*d)+(c&65535)|32*d+(c>>16)<<16},getAttackType:function(b){switch(b){case 12:case 7:return 4;case 11:case 8:case 9:case 10:return 2;case 3:case 4:case 5:case 6:return 1}return 3},getUnitsToKill:function(b,c){var d=webfrontend.data.Tech.getInstance(),
e=webfrontend.res.Main.getInstance(),f=bossUnitType(c.BossType,c.BossLevel),g=e.units[b].av,h=this.getAttackType(b),d=d.getBonus("unitDamage",webfrontend.data.Tech.research,parseInt(b))+d.getBonus("unitDamage",webfrontend.data.Tech.shrine,parseInt(b)),e=Math.ceil(4*e.units[f].def[h]/g);return e=Math.ceil(e/(1+d/100))},fillBossList:function(){webfrontend.data.Tech.getInstance();var b=webfrontend.data.City.getInstance();webfrontend.res.Main.getInstance();var c=b.getId(),b=c&65535,c=c>>16,d=this.bossRaider,
e=d.s,f=this.getMinBossLevel(),g=webfrontend.data.Server.getInstance().getContinentFromCoords(b,c),h=this.bossTable.getTableModel();if(0==e)h.setData([["No units"]]);else{h.setData([]);obfuscatedNames.update();if(obfuscatedNames.worldData&&obfuscatedNames.worldData.hasOwnProperty("d"))for(var k in obfuscatedNames.worldData.d){var l=safeGetProperty(obfuscatedNames.worldData.d[k][obfuscatedNames.objData],"d");if(l)for(var m in l){var n=this.coordsFromCluster(k,m),p=n&65535,n=n>>16;if(webfrontend.data.Server.getInstance().getContinentFromCoords(p,
n)==g||17==d.t){var q=l[m];switch(q.Type){case 3:if(q.State&&12!=q.BossType&&17!=d.t&&q.BossLevel>=f){var r=Math.sqrt((p-b)*(p-b)+(n-c)*(n-c));h.addRows([[bossName(q.BossType),q.BossLevel,p+":"+n,r.toFixed(2),webfrontend.Util.getTimespanString(r*e),this.getUnitsToKill(d.t,q)]])}else q.State&&12==q.BossType&&17==d.t&&q.BossLevel>=f&&(r=Math.sqrt((p-b)*(p-b)+(n-c)*(n-c)),h.addRows([[bossName(q.BossType),q.BossLevel,p+":"+n,r.toFixed(2),webfrontend.Util.getTimespanString(r*e),this.getUnitsToKill(d.t,
q)]]))}}}}h.sortByColumn(4,!0)}},createIdleUnitsPage:function(){var b=new qx.ui.tabview.Page("Lazy Troops");b.setLayout(new qx.ui.layout.VBox(2));var c=new qx.ui.container.Composite;c.setLayout(new qx.ui.layout.HBox);this.cityGroups=(new qx.ui.form.SelectBox).set({width:50,alignY:"middle",tabIndex:1});var d=new qx.ui.form.ListItem("All cities",null,0);d.cids=[];this.cityGroups.add(d);d=new qx.ui.basic.Image("webfrontend/ui/icons/icon_citybar_groups_hilighted.png");d.setAlignY("middle");this.cityGroups._addAt(d,
0);for(var e=webfrontend.data.Player.getInstance(),f=0;f<e.citygroups.length;++f)d=new qx.ui.form.ListItem(e.citygroups[f].n+" ["+e.citygroups[f].c.length+"]",null,e.citygroups[f].i),d.cids=e.citygroups[f].c,this.cityGroups.add(d);c.add(this.cityGroups);d=new qx.ui.form.Button("Refresh");d.addListener("click",function(){ava.IdleRaidUnitsTable.getInstance().refresh()});c.add(d);CreateCheckBox(this,"autoUpdate",c,"If unchecked, the data won't refresh until you click the refresh button.<br/>May solve some performance issues with flashing screen.");
CreateCheckBox(this,"excludeShips",c,"Won't list ships when checked");c.add(new qx.ui.core.Spacer,{flex:1});f=(new qx.ui.basic.Label).set({marginRight:4,marginLeft:4});f.setValue("Min ts");c.add(f);f=localStorage.getItem("mt__excludeTsLt");this.excludeTs=new qx.ui.form.TextField;this.excludeTs.setWidth(40);this.excludeTs.addListener("input",function(b){b=this.getValue();var c=b.match(/\d+/g),c=c?c.join(""):"";b!=c&&(this.setValue(null),this.setValue(c))},this.excludeTs);this.excludeTs.set({toolTipText:"Exclude cities where the idle ts less than _this value."});
e=qx.core.Init.getApplication();e.setElementModalInput(this.excludeTs);this.excludeTs.setValue(f&&0<f.length?f:"");c.add(this.excludeTs);this.excludeTs.addListener("changeValue",function(b){b=this.excludeTs.getValue();localStorage.setItem("mt__excludeTsLt",b)},this);f=(new qx.ui.basic.Label).set({alignY:"middle",marginRight:4,marginLeft:4});f.setValue("Exclude ref");c.add(f);f=localStorage.getItem("mt__excludeIdleRefs");this.excludeIf=new qx.ui.form.TextField;this.excludeIf.set({toolTipText:"Exclude cities where the city reference contains _this text. (comma separated list)"});
this.excludeIf.setWidth(80);e.setElementModalInput(this.excludeIf);this.excludeIf.setValue(f&&0<f.length?f:"");c.add(this.excludeIf);this.excludeIf.addListener("changeValue",function(b){b=this.excludeIf.getValue();localStorage.setItem("mt__excludeIdleRefs",b)},this);b.add(c);b.add(ava.IdleRaidUnitsTable.getInstance(),{flex:1});d.targetTable=ava.IdleRaidUnitsTable.getInstance();return b},cityGroupSelected:function(b){paDebug("Execute button: "+this.getLabel())},createBossPage:function(){var b=this,
c=new qx.ui.tabview.Page("Boss Raiding");c.setLayout(new qx.ui.layout.VBox(2));var d=new qx.ui.container.Composite;d.setLayout(new qx.ui.layout.HBox);var e=new qx.ui.form.Button("World");e.addListener("click",function(){var b=webfrontend.data.City.getInstance().getId(),c=b&65535,d=b>>16;qx.core.Init.getApplication();webfrontend.gui.Util.showMapModeViewPos("r",0,c,d);b=webfrontend.data.Server.getInstance();c=b.getContinentFromCoords(c,d);c=b.getContinentCentrePoint(c);webfrontend.gui.Util.showMapModeViewPos("w",
0,c.x,c.y)});d.add(e);e=new qx.ui.form.Button("Find Bosses");e.addListener("click",b.fillBossList,b);d.add(e);d.add(new qx.ui.core.Spacer,{flex:1});e=new qx.ui.basic.Label;e.setRich(!0);e.setAlignY("middle");b.bossUnitLabel=e;d.add(e);d.add((new qx.ui.core.Spacer).set({width:10}));e=new qx.ui.basic.Image;e.setWidth(24);e.setHeight(24);e.setScale(!0);e.setAlignY("middle");b.bossUnitImage=e;d.add(e);c.add(d);var f=new qx.ui.table.model.Simple;f.setColumns("Type Level Pos Dist Travel Units".split(" "));
f.setSortMethods(4,function(b,c){return Number(b[3])-Number(c[3])});b.bossTable=new qx.ui.table.Table(f,{tableColumnModel:function(b){return new qx.ui.table.columnmodel.Resize(b)}});b.bossTable.onCellClick=function(c){var d=new Coord(f.getValue(2,c.getRow())),e=d.x,l=d.y,m=qx.core.Init.getApplication(),n=2!=c.getColumn();n||(m.showSendArmy(e,l,!1,webfrontend.gui.SendArmyWindow.pages.raid),d.showOnMap());if(b.bossRaider&&-1!=b.bossRaider.t)if(e=m.sendArmyWidget,l=[],m=null,c=f.getValue(5,c.getRow()),
n)l.push({t:b.bossRaider.t,c:Math.floor(c)}),d={cityid:webfrontend.data.City.getInstance().getId(),units:l,targetPlayer:"",targetCity:d.format(),order:8,transport:1,timeReferenceType:1,referenceTimeUTCMillis:0,raidTimeReferenceType:0,raidReferenceTimeUTCMillis:0},raidingMessages.prepend("Boss Distpatch units "+c+" t:"+b.bossRaider.t+" s:"+b.bossRaider.s),webfrontend.net.CommandManager.getInstance().sendCommand("OrderUnits",d,null,function(b,c){c.r0&&raidingMessages.prepend("Boss: "+ava.CombatTools.getErrorMessage(c.r0))});
else for(var p in e)if(e[p]&&e[p].hasOwnProperty("1")&&e[p]["1"]&&e[p]["1"].hasOwnProperty("cityinfo")&&e[p]["1"].hasOwnProperty("ui")){m=e[p];m[b.bossRaider.t].ui.input.setValue(c);break}};b.bossTable.addListener("cellClick",b.bossTable.onCellClick,b.bossTable);d=b.bossTable.getTableColumnModel();d.setColumnVisible(3,!1);e=new qx.ui.table.cellrenderer.Default;e.setDefaultCellStyle("text-decoration:underline;color:blue");d.setDataCellRenderer(2,e);d.setDataCellRenderer(0,e);c.add(b.bossTable,{flex:1});
return c},createPvpPage:function(){var b=new qx.ui.tabview.Page("Recent Cities");b.setLayout(new qx.ui.layout.VBox(2));var c=new qx.ui.table.model.Simple;c.setColumns("City Coords Player Alliance ref Dist TS PlayerId pin Remove".split(" "));this.pvpTable=new qx.ui.table.Table(c,{tableColumnModel:function(b){return new qx.ui.table.columnmodel.Resize(b)}});this.pvpTable.onDataEdited=function(b){this.getTableModel();b.getData()};this.pvpTable.onCellClick=function(b){var c=b.getColumn(),d=b.getRow();
this.getTableModel().getValue(0,d);var e=this.getTableModel().getValue(c,d),l=qx.core.Init.getApplication();switch(c){case 8:"true"!=e?this.getTableModel().setValue(8,d,"true"):this.getTableModel().setValue(8,d,"false");break;case 2:l.showInfoPage(l.getPlayerInfoPage(),{name:e});break;case 3:l.showAllianceInfo(webfrontend.gui.Alliance.Info.MainWindow.tabs.info,{name:e});break;case 0:b=new Coord(this.getTableModel().getValue(1,d));b.openCity(!0);break;case 1:b=new Coord(e);b.showOnMap();break;case 9:"false"==
this.getTableModel().getValue(8,d)&&(this.setShowCellFocusIndicator(!1),this.getTableModel().removeRows(b.getRow(),1))}};this.pvpTable.setShowCellFocusIndicator(!1);this.pvpTable.addListener("cellClick",this.pvpTable.onCellClick,this.pvpTable);this.pvpTable.addListener("dataEdited",this.pvpTable.onDataEdited,this.pvpTable);c=this.pvpTable.getTableColumnModel();c.setColumnVisible(3,!1);var d=new qx.ui.table.cellrenderer.Image,e=new qx.ui.table.cellrenderer.Default;e.setDefaultCellStyle("text-decoration:underline;color:blue");
c.setDataCellRenderer(0,e);c.setDataCellRenderer(1,e);c.setDataCellRenderer(2,e);c.setDataCellRenderer(3,e);c.setDataCellRenderer(4,e);c.setDataCellRenderer(3,e);c.setDataCellRenderer(4,e);c.setDataCellRenderer(5,e);c.setDataCellRenderer(6,e);c.setDataCellRenderer(7,e);c.setDataCellRenderer(8,e);c.setColumnVisible(4,!1);c.setColumnVisible(5,!1);c.setColumnVisible(6,!1);c.setDataCellRenderer(9,d);b.add(new qx.ui.basic.Label("Stores a cache of all cities that you have clicked.  I.e. click the first on to go back to the most recently click city "));
c=new qx.ui.container.Composite;c.setLayout(new qx.ui.layout.HBox);c.add((new qx.ui.basic.Label("Expected Losses:")).set({alignY:"middle"}));d=(new qx.ui.form.SelectBox).set({width:55,alignY:"middle",paddingLeft:4,paddingRight:4,paddingTop:0,paddingBottom:0,marginRight:8,toolTipText:"Amount of troops to remove from subsequent plunders to account for losses from each plunder."});d.add(new qx.ui.form.ListItem("None"));d.add(new qx.ui.form.ListItem("5%"));d.add(new qx.ui.form.ListItem("10%"));d.add(new qx.ui.form.ListItem("15%"));
d.add(new qx.ui.form.ListItem("20%"));d.add(new qx.ui.form.ListItem("25%"));d.setSelection([d.getChildren()[0]]);d.pvp=this;this.lossPercent=0;d.addListener("changeSelection",function(b){this.pvp.lossPercent="None"==b.getData()[0].getLabel()?0:parseInt(b.getData()[0].getLabel())});c.add(d);c.add((new qx.ui.basic.Label("Max TS:")).set({alignY:"middle"}));d=(new qx.ui.form.SelectBox).set({width:60,alignY:"middle",paddingLeft:4,paddingRight:4,paddingTop:0,paddingBottom:0,marginRight:8,toolTipText:"Allows you to reserve some troops to account for losses rather than only assume % loss."});
d.add(new qx.ui.form.ListItem("100%"));d.add(new qx.ui.form.ListItem("95%"));d.add(new qx.ui.form.ListItem("90%"));d.setSelection([d.getChildren()[1]]);d.pvp=this;this.startingPercent=95;d.addListener("changeSelection",function(b){this.pvp.startingPercent=parseInt(b.getData()[0].getLabel())});c.add(d);d=(new qx.ui.form.Button("Plunder")).set({marginLeft:10,paddingLeft:8,paddingRight:8,paddingTop:2,paddingBottom:2,alignY:"center",enabled:!0});d.pvp=this;d.addListener("click",function(){this.pvp.pvpTable.stopEditing();
for(var b=this.pvp.getDelay5sOffsetTime(),c=this.pvp.startingPercent/100,d=this.pvp.lossPercent/100+1,e=webfrontend.data.City.getInstance(),l=e.getId(),m=l&65535,n=l>>16,p=this.pvp.pvpTable.getTableModel(),q=p.getData(),r=p.getRowCount(),t=ava.CombatTools.getAvailableUnits(e,!1),e=0,u=[],s=0;s<t.land.length;++s)if(!DO_NOT_PLUNDER_UNITS[t.land[s].type]){var v=Math.floor(t.land[s].count*c);0<v&&(e=Math.max(e,this.pvp.getSpeed(t.land[s].type)),u.push({ts:t.land[s].unitTS,t:t.land[s].type,c:v}))}b=this.pvp.getDelay5sOffsetTime();
c=webfrontend.net.CommandManager.getInstance();for(s=t=0;s<r;++s)if("max"==q[s][6])for(v=parseInt(q[s][7]);0<v;--v){for(var w=[],y=0;y<u.length;++y)0<u[y].c&&(w.push({t:u[y].t,c:u[y].c}),u[y].c=Math.max(0,Math.floor(u[y].c/d)));w={cityid:l,units:w,targetPlayer:q[s][0],targetCity:q[s][4],order:2,transport:1,createCity:"",timeReferenceType:2,referenceTimeUTCMillis:b+1E3,raidTimeReferenceType:0,raidReferenceTimeUTCMillis:0,iUnitOrderOptions:0,iOrderCountRaid:0};c.sendCommand("OrderUnits",w,null,function(){});
var x=Number(String(q[s][3]).replace(",","")),w=x&65535,x=x>>16,z=Math.sqrt((m-w)*(m-w)+(n-x)*(n-x)),t=t+Math.ceil(5+2*e*z),z=Math.floor(t/3600),x=t%3600,b=Math.floor(x/60),x=x%60,x=Math.ceil(x),b=this.pvp.getDelayWithOffsetTime(z,b,x)}for(v=0;0<u.length;++y)0<u[0].c&&(v+=u[0].c*u[0].ts);y=v;for(s=z=0;s<r;++s)if("max"!=q[s][6]&&(w=parseInt(q[s][6]),0<w)){if(w>v){for(y=v=0;y<u.length;++y)b=Math.floor(u[y].c/d),u[y].c=Math.max(0,b),0<b&&(v+=b*u[y].ts);y=v;t+=Math.ceil(5+2*e*z);z=Math.floor(t/3600);
x=t%3600;b=Math.floor(x/60);x%=60;x=Math.ceil(x);b=this.pvp.getDelayWithOffsetTime(z,b,x);z=0}if(0<v&&w<v){for(var x=w/y,w=[],A=0;A<u.length;++A){var B=Math.floor(u[A].c*x);0<B&&(v-=B*u[A].ts,w.push({t:u[A].t,c:B}))}w={cityid:l,units:w,targetPlayer:q[s][0],targetCity:q[s][4],order:2,transport:1,createCity:"",timeReferenceType:2,referenceTimeUTCMillis:b+1E3,raidTimeReferenceType:0,raidReferenceTimeUTCMillis:0,iUnitOrderOptions:0,iOrderCountRaid:0};c.sendCommand("OrderUnits",w,null,function(){});x=
Number(String(q[s][3]).replace(",",""));w=x&65535;x>>=16;z=Math.max(z,Math.sqrt((m-w)*(m-w)+(n-x)*(n-x)))}}p.removeRows(0,p.getRowCount())});c.add(d);d=(new qx.ui.form.Button("Clear")).set({marginLeft:8,paddingLeft:8,paddingRight:8,paddingTop:2,paddingBottom:2,alignY:"center",enabled:!0});d.pvp=this;d.addListener("click",function(){var b=this.pvp.pvpTable.getTableModel();b.removeRows(0,b.getRowCount())});c.add(d);b.add(c);b.add(this.pvpTable,{flex:1});this.pvpTroopContainer=new qx.ui.container.Composite;
this.pvpTroopContainer.setLayout((new qx.ui.layout.HBox).set({spacing:4}));b.add(this.pvpTroopContainer);return b},createDungeonPage:function(){var b=this,c=new qx.ui.tabview.Page("Dungeons");c.setLayout(new qx.ui.layout.Dock);var d=new qx.ui.container.Composite;d.setLayout(new qx.ui.layout.VBox);d.add(new qx.ui.basic.Label("Targets"));var e=new qx.ui.container.Composite;e.setLayout(new qx.ui.layout.Basic);e.add((new qx.ui.basic.Label("Type")).set({alignY:"middle"}),{top:0,left:80});e.add((new qx.ui.basic.Label("Prog")).set({alignY:"middle"}),
{top:0,left:130});e.add((new qx.ui.basic.Label("Coords")).set({alignY:"middle"}),{top:0,left:180});e.add((new qx.ui.basic.Label("Dist")).set({alignY:"middle"}),{top:0,left:230});e.add((new qx.ui.basic.Label("Max")).set({alignY:"middle"}),{top:0,left:280});e.add((new qx.ui.basic.Label("Avg")).set({alignY:"middle"}),{top:0,left:330});var f=(new qx.ui.form.SelectBox).set({width:77,alignY:"middle",paddingLeft:4,paddingRight:4,paddingTop:0,paddingBottom:0});f.add(new qx.ui.form.ListItem("Auto"));f.add(new qx.ui.form.ListItem("Max+90%"));
f.add(new qx.ui.form.ListItem("Max+60%"));f.add(new qx.ui.form.ListItem("Max+30%"));f.add(new qx.ui.form.ListItem("Max+15%"));f.add(new qx.ui.form.ListItem("Max"));f.setSelection([f.getChildren()[0]]);b.raidAddType=f;f.addListener("changeSelection",function(b){RaidingWindowSave()});b.targetContainer=new qx.ui.container.Composite;b.targetContainer.setLayout((new qx.ui.layout.VBox).set({spacing:3}));var g=new qx.ui.container.Scroll;g.add(b.targetContainer);g.setMaxHeight(500);var h=(new qx.ui.form.Button("X")).set({paddingLeft:5,
paddingRight:5,paddingTop:0,paddingBottom:0});h.targetContainer=b.targetContainer;h.addListener("click",function(){b.targetContainer.removeAll()});e.add(h,{top:0,left:440});d.add(e);d.add((new qx.ui.core.Widget).set({backgroundColor:"#c4a77b",height:2,allowGrowX:!0,allowGrowY:!0,marginTop:4,marginBottom:2}));c.add(d,{edge:"north"});c.add(g,{edge:"center",width:"100%",height:"100%"});e=new qx.ui.container.Composite;e.setLayout(new qx.ui.layout.VBox);e.add((new qx.ui.core.Widget).set({backgroundColor:"#c4a77b",
height:2,allowGrowX:!0,allowGrowY:!0,marginTop:4,marginBottom:4}));d=new qx.ui.container.Composite;d.setLayout((new qx.ui.layout.Grid(2,8)).set({}));g=h=0;CreateCheckBox(b,"split",d,"If checked, adds as many raids as possible.",{row:g,column:h++});CreateCheckBox(b,"wantFor",d,"If checked, forests are favoured when dungeontype is flexible.\nNote that weak infantry (i.e. temps) will tend to avoid forests - even if strongly encouraged\nCan be used with wantHil.\nExample: If a the best mountain is up to 5 away and the best forest is 7 away, it will choose the forest.\nIf the mountain is closer or the forest farther, it will choose the mountain.\nThe setting will have no effect if there a many close forest dungeons.",
{row:g,column:h++});CreateCheckBox(b,"wantHil",d,"see wantFor\nNote that weak infantry (i.e. temps) will tend to avoid hills - even if strongly encouraged\nXbows will tend to avoid hills as well",{row:g,column:h++});CreateCheckBox(b,"wantMtn",d,"see wantFor",{row:g,column:h++});CreateCheckBox(b,"reallyWant",d,"if _this is set, the Want* flags have a big impact.  Note that _this may increase casualties",{row:g,column:h++});h=0;g=1;CreateCheckBox(b,"conserveIfnotFull",d,"Cities that are low on TC and actively recruiting will raid more consveratively to miimize casualties",
{row:g,column:h++});CreateCheckBox(b,"refreshBoss",d,"Whether or not we shoud update the boss list when the city changes.  You can do it manually if you like.",{row:g,column:h++});CreateCheckBox(b,"refreshDung",d,"Whether or not we shoud update the dungeon list when the city changes.  You can do it manually if you like.",{row:g,column:h++});CreateCheckBox(b,"pallysAreWimps",d,"If set, pallys will avoid all but forest dungeons.",{row:g,column:h++});CreateCheckBox(b,"RaidNJump",d,"If checked, avaRaid will jump to the next city to start scanning for dungeons as soon as the current cities raids are dispatched.\nNote: You can press GO before the dungons show up, the list starts out hidden and it takes time to draw.  AvaRaid will wait for hidden list to populate before dispatching",
{row:g,column:h++});var k=(new qx.ui.form.SelectBox).set({width:100});k.add(new qx.ui.form.ListItem("Manual"));k.add(new qx.ui.form.ListItem("AvaRaid"));k.add(new qx.ui.form.ListItem("AvaRaidSlow"));k.add(new qx.ui.form.ListItem("AvaRaidPlus"));k.addListener("changeSelection",function(c){"AvaRaidSlow"==c.getData()[0].getLabel()?b.AvaRaidMode=3:"AvaRaid"==c.getData()[0].getLabel()?(k.setToolTipText("Selects dungeons and raids to send"),b.AvaRaidMode=1):"AvaRaidPlus"==c.getData()[0].getLabel()?b.AvaRaidMode=
2:"Manual"==c.getData()[0].getLabel()?b.AvaRaidMode=0:b.AvaRaidMode=1;RaidingWindowSave()},b);d.add(k,{row:0,column:5});b.raidModeSel=k;k.setSelection([k.getChildren()[b.AvaRaidMode]]);b.ratioMode="count";var l=(new qx.ui.form.SelectBox).set({width:100});l.add(new qx.ui.form.ListItem("Available"));l.add(new qx.ui.form.ListItem("Total"));"total"==b.ratioMode?l.setSelection([l.getChildren()[1]]):(b.ratioMode="count",l.setSelection([l.getChildren()[0]]));d.add(l,{row:g,column:h++});f.addListener("changeSelection",
function(c){"Total"==c.getData()[0].getLabel()?b.ratioMode="total":b.ratioMode="count";RaidingWindowSave();b.setTotalsReadOnly(!1)});e.add(d);b.troopContainer=new qx.ui.container.Composite;b.troopContainer.setLayout((new qx.ui.layout.HBox(5)).set({spacing:5}));e.add(b.troopContainer);e.add((new qx.ui.core.Widget).set({backgroundColor:"#c4a77b",height:2,allowGrowX:!0}));d.add(b.raidAddType,{row:g,column:h++});b.commandContainer=new qx.ui.container.Composite;b.commandContainer.setLayout((new qx.ui.layout.VBox).set({spacing:2}));
d=new qx.ui.container.Composite;d.setLayout((new qx.ui.layout.Flow).set({}));f=(new qx.ui.form.SelectBox).set({width:80,tabIndex:1});b.departOptions=f;f.add(new qx.ui.form.ListItem("Arrive",null,webfrontend.gui.SendArmyWindow.timings.arrive));f.add(new qx.ui.form.ListItem("Depart",null,webfrontend.gui.SendArmyWindow.timings.depart));f.add(new qx.ui.form.ListItem("Delay 5s",null,100));f.add(new qx.ui.form.ListItem("Now",null,webfrontend.gui.SendArmyWindow.timings.now));f.setSelection([f.getChildren()[3]]);
f.addListener("changeSelection",function(c){var d=this.getLayoutParent().getChildren(),e="visible";if("Now"==c.getData()[0].getLabel()||"Delay 5s"==c.getData()[0].getLabel())e="hidden";for(c=1;6>=c;c++)d[c].setVisibility(e);b.updateAvailableUnits()});d.add(f);d.add(b.createHMSTextField("hidden",2));d.add((new qx.ui.basic.Label(":")).set({visibility:"hidden"}));d.add(b.createHMSTextField("hidden",3));d.add((new qx.ui.basic.Label(":")).set({visibility:"hidden"}));d.add(b.createHMSTextField("hidden",
4));f=(new qx.ui.form.SelectBox).set({width:50,visibility:"hidden",tabIndex:5});f.add(new qx.ui.form.ListItem("7 days",null,7));f.add(new qx.ui.form.ListItem("6 days",null,6));f.add(new qx.ui.form.ListItem("5 days",null,5));f.add(new qx.ui.form.ListItem("4 days",null,4));f.add(new qx.ui.form.ListItem("3 days",null,3));f.add(new qx.ui.form.ListItem("2 days",null,2));f.add(new qx.ui.form.ListItem("Tomorrow",null,1));f.add(new qx.ui.form.ListItem("Today",null,0));f.setSelection([f.getChildren()[7]]);
d.add(f);f.addListener("changeSelection",function(b){localStorage.setItem("mm__delayDayOpts",b.getData()[0].getLabel())});SetSelectionFromStore(f,"mm__delayDayOpts");b.departOptions=(new qx.ui.form.SelectBox).set({width:98});b.departOptions.add(new qx.ui.form.ListItem("Stagger opt",null,0));b.departOptions.add(new qx.ui.form.ListItem("1 min",null,1));b.departOptions.add(new qx.ui.form.ListItem("2 min",null,2));b.departOptions.add(new qx.ui.form.ListItem("5 min",null,5));b.departOptions.add(new qx.ui.form.ListItem("10 min",
null,10));b.departOptions.add(new qx.ui.form.ListItem("20 min",null,20));b.departOptions.add(new qx.ui.form.ListItem("30 min",null,30));b.departOptions.add(new qx.ui.form.ListItem("45 min",null,45));b.departOptions.add(new qx.ui.form.ListItem("60 min",null,60));d.add(b.departOptions);b.nextIdleCityButton=(new qx.ui.form.Button(null,"webfrontend/theme/scrollbar/scrollbar-right.png")).set({paddingLeft:8,paddingRight:8,paddingTop:2,paddingBottom:2,marginLeft:15,marginRight:15,enabled:!1,toolTipText:"Next idle city"});
b.nextIdleCityButton.addListener("click",b.nextIdleRaidCity,b);d.add(b.nextIdleCityButton);h=(new qx.ui.form.Button("GO")).set({paddingLeft:4,paddingRight:4,paddingTop:2,paddingBottom:2,enabled:!0});b.autoRaidButton=h;b.goButton=h;h.setToolTipText("AvaRaid yay!");h.addListener("execute",b.autoRaidPleaseToggle,b);d.add(h);b.commandContainer.add(d);d=new qx.ui.container.Composite;d.setLayout((new qx.ui.layout.Flow).set({}));f=(new qx.ui.form.SelectBox).set({width:80,tabIndex:6});b.raidDurationSel=f;
f.add(new qx.ui.form.ListItem("Once",null,webfrontend.gui.SendArmyWindow.timings.once-webfrontend.gui.SendArmyWindow.timings.once));f.add(new qx.ui.form.ListItem("Return",null,webfrontend.gui.SendArmyWindow.timings.latest-webfrontend.gui.SendArmyWindow.timings.once));f.add(new qx.ui.form.ListItem("Complete",null,webfrontend.gui.SendArmyWindow.timings.completed-webfrontend.gui.SendArmyWindow.timings.once));f.add(new qx.ui.form.ListItem("24 Hours",null,8));f.add(new qx.ui.form.ListItem("48 Hours",null,
4));f.add(new qx.ui.form.ListItem("72 Hours",null,7));for(var m in f.getChildren())f.getChildren()[m].getLabel()==b.raidDuration&&f.setSelection([f.getChildren()[m]]);f.addListener("changeSelection",function(c){var d=this.getLayoutParent().getChildren(),e="hidden";"Return"==c.getData()[0].getLabel()&&(e="visible");for(var f=1;6>=f;f++)d[f].setVisibility(e);b.raidDuration=c.getData()[0].getLabel();RaidingWindowSave()});d.add(f);f=b.createHMSTextField("hidden",7);f.addListenerOnce("appear",function(){var b=
localStorage.getItem("mm__retHr");this.setValue(null!=b?b:"0");0==this.getValue().length&&this.setValue("0")},f);console.warn("1");f.addListener("input",function(){localStorage.setItem("mm__retHr",this.getValue())},f);d.add(f);d.add((new qx.ui.basic.Label(":")).set({visibility:"hidden"}));console.warn("2");f=this.createHMSTextField("hidden",8);f.addListenerOnce("appear",function(){var b=localStorage.getItem("mm__retMin");this.setValue(null!=b?b:"0");0==this.getValue().length&&this.setValue("0")},
f);f.addListener("input",function(){localStorage.setItem("mm__retMin",this.getValue())},f);d.add(f);d.add((new qx.ui.basic.Label(":")).set({visibility:"hidden"}));console.warn("3");f=this.createHMSTextField("hidden",9);f.addListenerOnce("appear",function(){var b=localStorage.getItem("mm__retSec");this.setValue(null!=b?b:"0");0==this.getValue().length&&this.setValue("0")},f);f.addListener("input",function(){localStorage.setItem("mm__retSec",this.getValue())},f);d.add(f);f=(new qx.ui.form.SelectBox).set({width:100,
visibility:"hidden"});f.add(new qx.ui.form.ListItem("7 days",null,7));f.add(new qx.ui.form.ListItem("6 days",null,6));f.add(new qx.ui.form.ListItem("5 days",null,5));f.add(new qx.ui.form.ListItem("4 days",null,4));f.add(new qx.ui.form.ListItem("3 days",null,3));f.add(new qx.ui.form.ListItem("2 days",null,2));f.add(new qx.ui.form.ListItem("Tomorrow",null,1));f.add(new qx.ui.form.ListItem("Today",null,0));f.setSelection([f.getChildren()[7]]);d.add(f);f.addListener("changeSelection",function(b){localStorage.setItem("mm__retDayOpts",
b.getData()[0].getLabel())});SetSelectionFromStore(f,"mm__retDayOpts");h=(new qx.ui.form.Button("Refresh")).set({paddingLeft:5,paddingRight:5,paddingTop:0,paddingBottom:0});h.addListener("click",b.findDungeons,b);d.add(h);b.commandContainer.add(d);e.add(this.commandContainer);c.add(e,{edge:"south"});return c},GetRaidGain:function(b){if("none"==this.ratioMode)return 1;var c=this.raidAddType.getSelection()[0].getLabel(),d=1;"Max+90%"==c?d=1.9:"Max+60%"==c?d=1.6:"Max+30%"==c?d=1.3:"Max+15%"==c?d=1.15:
"Max"==c?d=1:(c=0.01*b,d=Math.min(1,(b+70)/2*0.01),d=1+Math.min(0.5,d-c),console.log(b+" progress "+d));return d},getTotalCarry:function(b){var c=webfrontend.data.City.getInstance(),d=webfrontend.res.Main.getInstance(),e=0;if(0<c.getOrderLimit()-this.getAllocatedOrders()){for(var f={},g=0;null!=c.unitOrders&&g<c.unitOrders.length;++g)if(!0==c.unitOrders[g].isDelayed)for(var h=0;h<c.unitOrders[g].units.length;++h)f.hasOwnProperty(c.unitOrders[g].units[h].type)||(f[c.unitOrders[g].units[h].type]=0),
f[c.unitOrders[g].units[h].type]+=c.unitOrders[g].units[h].count;for(var k in c.units)g=d.units[k].c,0<g&&(d.units[k].ls&&2!=b||!d.units[k].ls&&2==b)&&(h=c.getUnitTypeInfo(k)[this.ratioMode]-this.getAllocatedUnits(k),"total"!=this.ratioMode&&f.hasOwnProperty(k)&&(h-=f[parseInt(k)]),e+=h*g)}return e},getTotalDefenseCarry:function(b){var c=webfrontend.data.City.getInstance(),d=webfrontend.res.Main.getInstance(),e=0;if(0<c.getOrderLimit()-this.getAllocatedOrders()){for(var f={},g=0;null!=c.unitOrders&&
g<c.unitOrders.length;++g)if(!0==c.unitOrders[g].isDelayed)for(var h=0;h<c.unitOrders[g].units.length;++h)f.hasOwnProperty(c.unitOrders[g].units[h].type)||(f[c.unitOrders[g].units[h].type]=0),f[c.unitOrders[g].units[h].type]+=c.unitOrders[g].units[h].count;for(var k in c.units)this.isUnitDefense(k)&&"4"!=k&&(g=d.units[k].c,0<g&&(d.units[k].ls&&2!=b||!d.units[k].ls&&2==b)&&(h=c.getUnitTypeInfo(k)[this.ratioMode]-this.getAllocatedUnits(k),"total"!=this.ratioMode&&f.hasOwnProperty(k)&&(h-=f[parseInt(k)]),
e+=h*g))}return e},isUnitDefense:function(b){var c=!0;switch(b){case "1":case "2":case "3":case "4":case "5":case "8":case "9":case "10":case "13":case "14":case "15":case "16":case "19":case "77":break;default:c=!1}return c},isDefense:function(){var b=webfrontend.data.City.getInstance(),c=!0,d;for(d in b.units)switch(d){case "1":case "2":case "3":case "4":case "5":case "8":case "9":case "10":case "13":case "14":case "15":case "16":case "19":case "77":break;default:c=!1}return c},getUnitBonus:function(b){var c=
webfrontend.data.Tech.getInstance().getBonus("unitDamage",webfrontend.data.Tech.research,Number(b));b=webfrontend.data.Tech.getInstance().getBonus("unitDamage",webfrontend.data.Tech.shrine,Number(b));return(c+b)/100},getRemainingTs:function(b){for(var c=webfrontend.data.City.getInstance(),d=webfrontend.res.Main.getInstance(),e=0,f={},g=0;null!=c.unitOrders&&g<c.unitOrders.length;++g)if(!0==c.unitOrders[g].isDelayed)for(var h=0;h<c.unitOrders[g].units.length;++h)f.hasOwnProperty(c.unitOrders[g].units[h].type)||
(f[c.unitOrders[g].units[h].type]=0),f[c.unitOrders[g].units[h].type]+=c.unitOrders[g].units[h].count;for(var k in c.units)0<d.units[k].c&&(d.units[k].ls&&2!=b||!d.units[k].ls&&2==b)&&(g=c.getUnitTypeInfo(k)[this.ratioMode]-this.getAllocatedUnits(k),"total"!=this.ratioMode&&f.hasOwnProperty(k)&&(g-=f[parseInt(k)]),e+=g);return e},hasSeaOnly:function(){var b=!1,c=webfrontend.data.City.getInstance();if(0<c.getOrderLimit()-this.getAllocatedOrders()){var b=!0,d;for(d in c.units)switch(d){case "1":case "19":case "15":case "16":case "17":break;
default:b=!1}}return b},hasSeaOffense:function(){var b=!1,c=webfrontend.data.City.getInstance();if(0<c.getOrderLimit()-this.getAllocatedOrders()){var b=!0,d;for(d in c.units)switch(d){case "17":b=!0}}return b},hasCav:function(){var b=webfrontend.data.City.getInstance();if(0<b.getOrderLimit()-this.getAllocatedOrders())for(var c in b.units)switch(c){case "9":case "10":case "12":case "11":return!0}return!1},getDungeonArray:function(b){webfrontend.res.Main.getInstance();var c=ava.RaidingWindow.getInstance();
obfuscatedNames.update();var d=[],e=webfrontend.data.City.getInstance(),e=new Coord(e.getId());e.getCont();var f=getGains(),g=c.hasSeaOnly(),h=g?70:c.hasCav()?30:15;b&&(h*=2);var k=webfrontend.data.ServerTime.getInstance().getServerStep()-75600,l;for(l in obfuscatedNames.worldData.d){var m=obfuscatedNames.worldData.d[l][obfuscatedNames.objData].d;if(m)for(var n in m){var p=m[n];if(2==p.Type){var q=p.StartStep,r=new Coord(c.coordsFromCluster(l,n)),t=r.getCont(),u=getDist(e,r),s=u+2,s=s*f[dungShortName(p.DungeonType)],
v=c.getTotalCarry(p.DungeonType),w=c.dungProgressType(p.DungeonType),w=c.dungeonProgressData[w][p.DungeonLevel-1][p.Progress][0];(p.State||b)&&(0<p.Progress||q>=k)&&Math.max(s,u)<h&&80>p.Progress&&0<w&&(b||0.75<v/w)&&(g?2==p.DungeonType&&d.push([p.DungeonType,p.DungeonLevel,p.Progress,t,s,r.x,r.y,r]):d.push([p.DungeonType,p.DungeonLevel,p.Progress,t,s,r.x,r.y,r]))}}}0<d.length&&d.sort(function(b,c){return Number(b[4])-Number(c[4])});return d},findDungeonsI:function(b){var c=ava.RaidingWindow.getInstance();
c.targetContainer.removeAll();b=c.getDungeonArray(b);for(var d=0;16>d&&d<b.length;++d){for(var e=!1,f=b[d][7].format(),g=c.targetContainer.getChildren(),h=0;h<g.length;h++)g[h].getChildren()[3].getValue()==f&&(e=!0);e||(e=new dung(b[d][0],b[d][1],b[d][2],b[d][7],b[d][4]),c.addDungeonToRaid(e))}},findDungeons:function(){this.findDungeonsI(!0)},nextIdleRaidCityI:function(b){var c=ava.IdleRaidUnitsTable.getInstance(),d=c.getTableModel();d.getRowCount()>c.curRow&&0<d.getColumnCount()&&(d.getValue(0,c.curRow)==
c.curId&&(++c.curRow,d.getRowCount()<=c.curRow&&(c.curRow=0,setTimeout(c.refresh.bind(c),2E3))),c.curId=d.getValue(0,c.curRow));(new Coord(c.curId)).openCity(b)},nextIdleRaidCity:function(){ava.RaidingWindow.getInstance().nextIdleRaidCityI(!0)},nextIdleRaidCityNoMove:function(){ava.RaidingWindow.getInstance().nextIdleRaidCityI(!1)},setTotalsReadOnly:function(b){for(var c=this.targetContainer.getChildren(),d=0;d<c.length;d++)for(var e=c[d].getChildren()[0].raidcontainer.getChildren(),f=0;f<e.length;f++)for(var g=
e[f].getChildren(),h=0;h<g.length;h++)g[h]instanceof qx.ui.form.TextField&&null==g[h].unitType&&(g[h].setReadOnly(b),g[h].setEnabled(!b))},onRaidCountInput:function(b){for(var c=webfrontend.data.City.getInstance(),d=webfrontend.res.Main.getInstance(),e=b.unitType,f={},g=0;null!=c.unitOrders&&g<c.unitOrders.length;++g)if(!0==c.unitOrders[g].isDelayed)for(var h=0;h<c.unitOrders[g].units.length;++h)f.hasOwnProperty(c.unitOrders[g].units[h].type)||(f[c.unitOrders[g].units[h].type]=0),f[c.unitOrders[g].units[h].type]+=
c.unitOrders[g].units[h].count;if(null==e){if("none"!=this.ratioMode){for(var k=Number(b.getValue()),l=0,e=b.getLayoutParent().getChildren(),g=0;g<e.length;g++)if(e[g]instanceof qx.ui.form.TextField&&null!=e[g].unitType){var m=c.getUnitTypeInfo(e[g].unitType);b=m[this.ratioMode];"total"!=this.ratioMode&&f.hasOwnProperty(e[g].unitType)&&(b-=f[parseInt(e[g].unitType)]);l+=b*d.units[e[g].unitType].c}for(g=0;g<e.length;g++)e[g]instanceof qx.ui.form.TextField&&null!=e[g].unitType&&(m=c.getUnitTypeInfo(e[g].unitType),
m=m[this.ratioMode],"total"!=this.ratioMode&&f.hasOwnProperty(e[g].unitType)&&(m-=f[parseInt(e[g].unitType)]),h=Math.floor(k/l*m),e[g].setValue(h.toString()))}}else for(m=c.getUnitTypeInfo(e),h=Number(b.getValue()),m=m[this.ratioMode],"total"!=this.ratioMode&&f.hasOwnProperty(e)&&(m-=f[parseInt(e)]),f=0==h?0:h/m,k=h*d.units[e].c,e=b.getLayoutParent().getChildren(),g=0;g<e.length;g++)e[g]instanceof qx.ui.form.TextField&&e[g]!=b&&(null==e[g].unitType?e[g].setValue(k.toString()):(c.getUnitTypeInfo(e[g].unitType),
"none"==this.ratioMode?h=Number(e[g].getValue()):(h=Math.floor(f*m),e[g].setValue(h.toString())),k+=h*d.units[e[g].unitType].c));this.updateAvailableUnits()},onAddMaxRaids:function(b){var c=b.getLayoutParent(),c=Number(c.getChildren()[5].getValue()),d=0,e=this.GetRaidGain(b.d.progress),d=Math.floor(c*e);return this.addMaxRaids(b,c,d,e)},onAddRaidButton:function(b){var c=this.raidAddType.getSelection()[0].getLabel(),d=b.getLayoutParent(),d=Number(d.getChildren()[5].getValue()),e=0,f=1;"none"!=this.ratioMode&&
("Max+90%"==c?f=1.9:"Max+60%"==c?f=1.6:"Max+30%"==c?f=1.3:"Max+15%"==c?f=1.15:"Max"==c&&(f=1));e=Math.floor(d*f);this.split?this.addSplit(b,d,e,f):this.addRaid(b,Math.floor(e))},addSplit:function(b,c,d,e){var f=webfrontend.data.City.getInstance(),g=webfrontend.res.Main.getInstance(),h=0,k=f.getOrderLimit()-this.getAllocatedOrders();if(0!=k){for(var l=b.d.get_Type(),m={},n=0;null!=f.unitOrders&&n<f.unitOrders.length;++n)if(!0==f.unitOrders[n].isDelayed)for(var p=0;p<f.unitOrders[n].units.length;++p)m.hasOwnProperty(f.unitOrders[n].units[p].type)||
(m[f.unitOrders[n].units[p].type]=0),m[f.unitOrders[n].units[p].type]+=f.unitOrders[n].units[p].count;for(var q in f.units)n=g.units[q].c,0<n&&(g.units[q].ls&&2!=l||!g.units[q].ls&&2==l)&&(p=f.getUnitTypeInfo(q)[this.ratioMode]-this.getAllocatedUnits(q),"total"!=this.ratioMode&&m.hasOwnProperty(q)&&(p-=m[parseInt(q)]),h+=p*n);e=Math.floor(c*(e-0.1));c=h/d;1>c?c=1:(c=Math.floor(c),c=1.1<h/c/d&&h/(c+1)>e&&c+1<=k?c+1:c);c>k&&(c=k);d=Math.floor(h/c);for(h=0;h<c;h++)this.addRaid(b,d)}},addMaxRaids:function(b,
c,d,e){var f=0,g=webfrontend.data.City.getInstance(),h=webfrontend.res.Main.getInstance(),k=0,l=g.getOrderLimit()-this.getAllocatedOrders();if(0==l)return 0;for(var m=b.d.type,n={},p=0;null!=g.unitOrders&&p<g.unitOrders.length;++p)if(!0==g.unitOrders[p].isDelayed)for(var q=0;q<g.unitOrders[p].units.length;++q)n.hasOwnProperty(g.unitOrders[p].units[q].type)||(n[g.unitOrders[p].units[q].type]=0),n[g.unitOrders[p].units[q].type]+=g.unitOrders[p].units[q].count;for(var r in g.units)p=h.units[r].c,0<p&&
(h.units[r].ls&&2!=m||!h.units[r].ls&&2==m)&&(q=g.getUnitTypeInfo(r)[this.ratioMode]-this.getAllocatedUnits(r),"total"!=this.ratioMode&&n.hasOwnProperty(r)&&(q-=n[parseInt(r)]),k+=q*p);e=Math.floor(c*(e-0.1));c=k/d;0.5<=c&&(1>c&&(c=1),c=Math.floor(c),c=1.1<k/c/d&&k/(c+1)>e&&c+1<=l?c+1:c);if(1<=c&&c<=l)for(k=Math.floor(k/c),k=1.1<k/d?d:k,d=0;d<c;d++)++f,this.addRaid(b,k);return f},addRaid:function(b,c){var d=b.raidcontainer,e=webfrontend.res.Main.getInstance(),f=webfrontend.data.City.getInstance(),
g=[],h=b.d.type,k;for(k in f.units)0<e.units[k].c&&(e.units[k].ls&&2!=h||!e.units[k].ls&&2==h)&&(g[g.length]=k);if(0!=g.length){f=new qx.ui.container.Composite;f.setLayout((new qx.ui.layout.HBox).set({spacing:5}));g.sort(function(b,c){return e.units[b].y-e.units[c].y});for(h=0;h<g.length;h++){k=g[h];var l=new qx.ui.basic.Image("webfrontend/"+e.imageFiles[e.units[k].simg]);l.setAlignY("middle");f.add(l);l=(new qx.ui.form.TextField("")).set({paddingTop:0,paddingBottom:0});l.setWidth(50);l.unitType=
k;l.setAlignY("middle");l.setTextAlign("right");l.rw=this;l.addListener("input",function(){this.rw.onRaidCountInput(this)});l.addListener("click",function(){this.selectAllText()});f.add(l);f.add((new qx.ui.core.Spacer).set({width:10}))}f.add((new qx.ui.core.Spacer).set({width:30}));l=(new qx.ui.form.TextField(c.toString())).set({paddingTop:0,paddingBottom:0});l.setWidth(60);l.unitType=null;l.setAlignY("middle");l.setTextAlign("right");l.rw=this;l.addListener("input",function(){this.onRaidCountInput()});
l.addListener("click",function(){this.selectAllText()});"none"==this.ratioMode&&(l.setReadOnly(!0),l.setEnabled(!1));f.add(l);g=(new qx.ui.form.Button("X")).set({paddingLeft:5,paddingRight:5,paddingTop:0,paddingBottom:0,alignY:"middle"});g.rw=this;g.addListener("click",function(){this.getLayoutParent().destroy();this.rw.updateAvailableUnits()});f.add(g);d.add(f);this.onRaidCountInput(l)}},updateDungeonRaidInfo:function(b){for(var c=(new Coord(b)).format(),d=this.targetContainer.getChildren(),e=0;e<
d.length;e++){var f=d[e];if(f.getChildren()[3].getValue()==c){this.dungeonLootInfo.hasOwnProperty(b)&&(b=this.dungeonLootInfo[b],f=f.getChildren(),f[5].setValue(b.mx),f[6].setValue(b.l));break}}},createHMSTextField:function(b,c){var d=(new qx.ui.form.TextField("0")).set({width:25,visibility:b,alignY:"middle",tabIndex:c});d.addListener("click",function(){this.selectAllText()});return d},getAllocatedUnits:function(b){for(var c=this.targetContainer.getChildren(),d=0,e=0;e<c.length;e++)for(var f=c[e].getChildren()[0].raidcontainer.getChildren(),
g=0;g<f.length;g++)for(var h=f[g].getChildren(),k=0;k<h.length;k++)h[k]instanceof qx.ui.form.TextField&&h[k].unitType==b&&(d+=Number(h[k].getValue()));return d},getAllocatedOrders:function(){for(var b=this.targetContainer.getChildren(),c=0,d=0;d<b.length;d++)for(var e=b[d].getChildren()[0].raidcontainer.getChildren(),f=0;f<e.length;f++)for(var g=e[f].getChildren(),h=0;h<g.length;h++)if(g[h]instanceof qx.ui.form.TextField&&0<Number(g[h].getValue())){c++;break}b=webfrontend.data.City.getInstance();
b.getUnitOrders()&&(c+=b.getUnitOrders().length);return c},pickAndSendRaids:function(){if(0==this.AvaRaidMode)this.sendRaids();else{this.targetContainer.removeAll();for(var b=webfrontend.data.City.getInstance().getOrderLimit()-this.getAllocatedOrders(),c=this.getDungeonArray(!1),d=0,e=0;0<c.length&&0<b;){for(var f=d=0;f<c.length&&0==d;++f){var g=new dung(c[f][0],c[f][1],c[f][2],c[f][7],c[f][4]),h=this.addDungeonToRaid(g);null!=h&&(d+=this.onAddMaxRaids(h),b-=d,e+=d,0!=this.AvaRaidMode&&raidingMessages.prepend("Raid: type: "+
dungName(g.type)+" level:"+g.level+" progress: "+g.progress+"% reps:"+d+" dist:"+Math.round(g.distance)))}if(0>=d||0>=b)break;c=this.getDungeonArray(!1)}0<e&&this.sendRaids()}},autoRaidPleaseToggle:function(){if(0==this.AvaRaidMode)this.sendRaids();else{var b=1!=this.AvaRaidMode;(this.wantAutoRaid=b?!this.wantAutoRaid:!0)||!b?(b&&(this.autoRaidButton.setTextColor("Magenta"),this.addRaidError("Please do not 'unattend'.  Do not get coffee.  Do not go to the bathroom.  You must sit through _this or you are cheating.\n")),
this.autoRaidPlease()):(this.autoRaidButton.setTextColor("red"),this.addRaidError(" Waiting for the raid threads to exit.\n\nWhen done you can turn AvaRaid back on for more raiding goodness. :) "))}},autoRaidPlease:function(){var b=this.AvaRaidMode,c=this.wantAutoRaid,d=1<b,e=Math.floor(((new Date).getTime()-webfrontend.net.UpdateManager.getInstance().userActivityTime)/1E3);c&&(b=(2==b?10:3==b?60:-1)-e,0>b||!d?(d&&this.addRaidError("Player seems to be sleeping.\nIdle for "+e+" seconds.\nTime to send the troops out to play."),
this.pickAndSendRaids(),(this.RaidNJump||d)&&this.nextIdleRaidCity()):this.addRaidError("Player has not been idle for long.  Waiting "+b+"more seconds"));d&&c?setTimeout(this.autoRaidPlease.bind(this),4E3):this.wantAutoRaid=!1;!0!=this.wantAutoRaid&&(this.autoRaidButton.setTextColor("Yellow"),this.autoRaidButton.setEnabled(!0))},sendRaids:function(){var b=ava.RaidingWindow.getInstance(),c=webfrontend.data.City.getInstance(),d=0,e=b.commandContainer.getChildren()[0],f=e.getChildren()[0].getSelection()[0].getModel(),
g=b.departOptions.getSelection()[0].getModel();f!=webfrontend.gui.SendArmyWindow.timings.now&&(100==f?(f=webfrontend.gui.SendArmyWindow.timings.depart,d=b.getDelay5sOffsetTime()):d=b.getOffsetTime(e.getChildren()[6].getSelection()[0].getModel(),Number(e.getChildren()[1].getValue()),Number(e.getChildren()[3].getValue()),Number(e.getChildren()[5].getValue())));0<g&&f==webfrontend.gui.SendArmyWindow.timings.now&&(f=webfrontend.gui.SendArmyWindow.timings.depart,d=b.getDelay5sOffsetTime());var e=0,h=b.commandContainer.getChildren()[1],
k=b.raidDurationSel.getSelection()[0].getModel();if(7==k||4==k||8==k||k+webfrontend.gui.SendArmyWindow.timings.once==webfrontend.gui.SendArmyWindow.timings.latest)7==k?(k=webfrontend.gui.SendArmyWindow.timings.latest-webfrontend.gui.SendArmyWindow.timings.once,e=b.getDelay72HrOffsetTime()):8==k?(k=webfrontend.gui.SendArmyWindow.timings.latest-webfrontend.gui.SendArmyWindow.timings.once,e=b.getDelay24HrOffsetTime()):4==k?(k=webfrontend.gui.SendArmyWindow.timings.latest-webfrontend.gui.SendArmyWindow.timings.once,
e=b.getDelay48HrOffsetTime()):e=b.getOffsetTime(h.getChildren()[6].getSelection()[0].getModel(),Number(h.getChildren()[1].getValue()),Number(h.getChildren()[3].getValue()),Number(h.getChildren()[5].getValue()));for(var h=b.targetContainer.getChildren(),l=d,m=0;m<h.length;m++)for(var n=h[m].getChildren()[0].raidcontainer.getChildren(),p=0;p<n.length;p++){for(var q=[],r=n[p],d=r.getChildren(),t=0;t<d.length;t++)d[t]instanceof qx.ui.form.TextField&&d[t].unitType&&0<Number(d[t].getValue())&&q.push({t:d[t].unitType,
c:Number(d[t].getValue())});webfrontend.net.UpdateManager.getInstance();d=l+p*g*6E4;d={cityid:c.getId(),units:q,targetPlayer:"",targetCity:h[m].getChildren()[3].getValue(),order:8,transport:1,createCity:"",timeReferenceType:f,referenceTimeUTCMillis:d,raidTimeReferenceType:k,raidReferenceTimeUTCMillis:e,iUnitOrderOptions:0,iOrderCountRaid:1};webfrontend.net.CommandManager.getInstance().sendCommand("OrderUnits",d,b,b.onRaidSent,r)}},addRaidError:function(b){raidingMessages.prepend(b)},onRaidSent:function(b,
c,d){if(b&&null!=c)if(0==c.r0&&0==c.r1)d.destroy();else{switch(c.r0){case 0:b="Successful raid sent";break;case 4:b="Not enough units.";break;case 64:b="Not enough command slots.";break;case 4194304:b="Delayed order in the past";break;case 2097152:b="War minister is not appointed.";break;default:b="Unknown Error: "+c.r0}console.log(b)}else this.addRaidError("Comm failed")},getOffsetTime:function(b,c,d,e){var f=webfrontend.Util.getCurrentTime(),g=0;0<webfrontend.config.Config.getInstance().getTimeZone()&&
(g+=f.getTimezoneOffset()/60,1==webfrontend.config.Config.getInstance().getTimeZone()?g+=webfrontend.data.ServerTime.getInstance().getServerOffset()/1E3/60/60:2==webfrontend.config.Config.getInstance().getTimeZone()&&(g+=webfrontend.config.Config.getInstance().getTimeZoneOffset()/1E3/60/60));f=new Date(f.getTime());f.setDate(f.getDate()+b);f.setHours(c-g);f.setMinutes(d);f.setSeconds(e);f.setMilliseconds(500);0==webfrontend.config.Config.getInstance().getTimeZone()&&(f=new Date(f.getTime()-webfrontend.data.ServerTime.getInstance().getDiff()));
return f.getTime()},getDelay72HrOffsetTime:function(){return this.getDelayWithOffsetTime(72,0,0)},getDelay48HrOffsetTime:function(){return this.getDelayWithOffsetTime(48,0,0)},getDelay24HrOffsetTime:function(){return this.getDelayWithOffsetTime(24,0,0)},getDelayWithOffsetTime:function(b,c,d){var e=webfrontend.Util.getCurrentTime(),f=0;0<webfrontend.config.Config.getInstance().getTimeZone()&&(f+=e.getTimezoneOffset()/60,1==webfrontend.config.Config.getInstance().getTimeZone()?f+=webfrontend.data.ServerTime.getInstance().getServerOffset()/
1E3/60/60:2==webfrontend.config.Config.getInstance().getTimeZone()&&(f+=webfrontend.config.Config.getInstance().getTimeZoneOffset()/1E3/60/60));e=new Date(e.getTime());e.setDate(e.getDate());e.setHours(e.getHours()+b-f);e.setMinutes(e.getMinutes()+c);e.setSeconds(e.getSeconds()+d+5);e.setMilliseconds(500);0==webfrontend.config.Config.getInstance().getTimeZone()&&(e=new Date(e.getTime()-webfrontend.data.ServerTime.getInstance().getDiff()));return e.getTime()},getDelay5sOffsetTime:function(){return this.getDelayWithOffsetTime(0,
0,5)},updateAvailableUnits:function(){var b=ava.RaidingWindow.getInstance();b.departOptions.getSelection()[0].getLabel();for(var c=webfrontend.data.City.getInstance(),d={},e=0;null!=c.unitOrders&&e<c.unitOrders.length;++e)if(!0==c.unitOrders[e].isDelayed)for(var f=0;f<c.unitOrders[e].units.length;++f)d.hasOwnProperty(c.unitOrders[e].units[f].type)||(d[c.unitOrders[e].units[f].type]=0),d[c.unitOrders[e].units[f].type]+=c.unitOrders[e].units[f].count;e=b.pvpTroopContainer;e.removeAll();var g=new qx.ui.basic.Image("webfrontend/ui/icons/icon_command_slots.png");
g.setWidth(16);g.setHeight(16);g.setScale(!0);g.setAlignY("middle");e.add(g);f=b.getAllocatedOrders();g=new qx.ui.basic.Label((c.getOrderLimit()-f).toString()+"/"+c.getOrderLimit());g.setRich(!0);g.setAlignY("middle");f>c.getOrderLimit()&&g.setTextColor("red");e.add(g);e.add((new qx.ui.core.Spacer).set({width:10}));var h=webfrontend.res.Main.getInstance(),f=[],k;for(k in c.units)0<h.units[k].c&&(f[f.length]=k);f.sort(function(b,c){return h.units[b].y-h.units[c].y});for(var l=0;l<f.length;l++){k=f[l];
g=new qx.ui.basic.Image("webfrontend/"+h.imageFiles[h.units[k].mimg]);g.setWidth(24);g.setHeight(24);g.setScale(!0);g.setAlignY("middle");e.add(g);var g=c.getUnitTypeInfo(k),m=g.count-b.getAllocatedUnits(k);d.hasOwnProperty(k)&&(m-=d[parseInt(k)]);g=new qx.ui.basic.Label(m+" / "+g.total);g.setRich(!0);g.setAlignY("middle");0>m&&g.setTextColor("red");e.add(g)}0==f.length&&(g=new qx.ui.basic.Label("No Available Units"),g.setRich(!0),g.setAppearance("textheader_sub1"),e.add(g));e=b.troopContainer;e.removeAll();
g=new qx.ui.basic.Image("webfrontend/ui/icons/icon_command_slots.png");g.setWidth(16);g.setHeight(16);g.setScale(!0);g.setAlignY("middle");e.add(g);f=b.getAllocatedOrders();g=new qx.ui.basic.Label((c.getOrderLimit()-f).toString()+"/"+c.getOrderLimit());g.setRich(!0);g.setAlignY("middle");f>c.getOrderLimit()&&g.setTextColor("red");e.add(g);e.add((new qx.ui.core.Spacer).set({width:10}));f=[];for(k in c.units)0<h.units[k].c&&(f[f.length]=k);f.sort(function(b,c){return h.units[b].y-h.units[c].y});for(l=
0;l<f.length;l++)k=f[l],g=new qx.ui.basic.Image("webfrontend/"+h.imageFiles[h.units[k].mimg]),g.setWidth(24),g.setHeight(24),g.setScale(!0),g.setAlignY("middle"),e.add(g),g=c.getUnitTypeInfo(k),m=g.count-b.getAllocatedUnits(k),d.hasOwnProperty(k)&&(m-=d[parseInt(k)]),g=new qx.ui.basic.Label(m+" / "+g.total),g.setRich(!0),g.setAlignY("middle"),0>m&&g.setTextColor("red"),e.add(g);0==f.length&&(g=new qx.ui.basic.Label("No Available Units"),g.setRich(!0),g.setAppearance("textheader_sub1"),e.add(g))},
updateDungeonRaidCity:function(){var b=webfrontend.data.City.getInstance();b.getId();this.setCaption(b.getName()+"  "+webfrontend.gui.Util.formatCityCoordsFromId(b.getId(),!0));this.targetContainer.removeAll();this.updateAvailableUnits()},clearPvpCities:function(){var b=this.pvpTable.getTableModel();b.removeRows(0,b.getRowCount())},onCityChange:function(){this.updateDungeonRaidCity();this.updateBossRaidCity();this.refreshBoss&&this.fillBossList();ava.RaidingWindow.getInstance().addCityToRaid(webfrontend.data.City.getInstance());
ava.RaidingWindow.getInstance().findDungeons()}}});
function ShowClientStatus(){azureClient.currentUser?(console.dir(azureClient.currentUser),azureMessages.Append("<br><br>You are signed in as "+azureClient.currentUser.userId+azureClient.currentUser.mobileServiceAuthenticationToken)):azureMessages.Append("<br>You are not yet Authenticated.<br>Please sign in with an auth provider.<br><br>iF you do not have an account, a new one will be created for you using your player name and your auth credentials.<br>")}
function WritePlayerToTable(){console.assert(null!==azureClient.currentUser);var b;b={};b.authId=azureClient.currentUser.userId;b.worldId=webfrontend.data.Server.$$instance.$$user_name;var c=webfrontend.data.Player.getInstance();webfrontend.config.Config.getInstance();var d=webfrontend.data.Alliance.$$instance;b.lastModified=new Date;b.alliance=d.$$user_name;b.allianceId=d.$$user_id;b.isOfficer=d.$$user_isOfficer;b.isAdmin=d.$$user_isAdmin;b.playerId=c.$$user_id;b.userLanguage=c.$$user_userLanguage;
b.name=c.$$user_name;b.numCastles=c.$$user_numCastles;b.points=c.$$user_points;b.creationDate=c.$$user_creationDate;b.title=c.$$user_title;b.isFemale=c.$$user_isFemale;b.accountId=c.$$user_accountId;b.nucleusId=c.$$user_nucleusId;b.substituted=c.$$user_substituted;b.substituteDayCount=c.$$user_substituteDayCount;b.rank=c.$$user_rank;b.barons=c.$$user_barons;b.baronsIdle=c.$$user_baronsIdle;b.baronsQueue=c.$$user_baronsQueue;b.ministerBuildPresent=c.$$user_ministerBuildPresent;b.ministerDefencePresent=
c.$$user_ministerDefencePresent;b.ministerMilitaryPresent=c.$$user_ministerMilitaryPresent;b.ministerTradePresent=c.$$user_ministerTradePresent;b.fameDefense=c.$$user_fameDefense;b.fameOffense=c.$$user_fameOffense;b.version=c.$$user_version;b.sessionId=webfrontend.net.UpdateManager.$$instance.$$user_sessionGuid;console.log(b);azureTable.where({name:b.name}).read().then(function(c){console.log(c);var d=null,g;for(g in c){c=c[g];if(c.authId==b.authId){d=c;break}setAzureMessage("You have already authorized an account.  If you are on multiple worlds then .. well.. I need to deal with that :(, otherwise please try authenticating with the provider that you used previously.");
return}d?(d.worldId!=b.worldId&&setAzureMessage("Warning - I are making your account on world "+b.worldId+" active for the purposes of Alliance Portal. I do not yet support logging on to multiple worlds at once because I am lazy."),b.id=d.id,azureMessages.Append("Welcome back - "+b.name),azureTable.update(b).then(function(b){console.dir(b);azureMessages.Append("[Player update complete, ref: "+b.toString()+"]")},function(b){return paDebug(b)})):(delete b.id,setAzureMessage("Welcome to the Alliance Portal, "+
b.name+".<br><br>Your temporary password is: <br><br>"+azureClient.currentUser.mobileServiceAuthenticationToken+"<br>Please memorize it."),azureTable.insert(b).then(function(b){console.dir(b);azureMessages.Append("[Player insert complete, ref: "+b.toString()+"]")},function(b){return paDebug(b)}));setAzureMessage(b.name+(b.alliance?" of "+b.alliance:"")+" is now authentic.");azureMessages.Hide()},function(b){return paDebug(b)})}var cookieAuth="lastAuthKey",cookieAuthToken="lastAuthToken";
function AuthSuccess(b){qx.bom.Cookie.set(cookieAuth,b.userId,30);console.log(b);ShowClientStatus();WritePlayerToTable()}
function authenticateClient(){function b(b,d){"undefined"===typeof d&&(d=void 0);azureClient.login(b,d).then(function(b){return AuthSuccess(b)},function(b){setAzureMessage("Something went wrong, please try again.<br>"+b.toString());paDebug(b);qx.bom.Cookie.del(cookieAuth);d=null});c.close()}azureClient||(azureClient=new WindowsAzure.MobileServiceClient("https://avalol.azure-mobile.net/","zCkmfPjSwERvuvdJexZZaNQTWAcrav37"),azureTable=azureClient.getTable("dwTable"));ShowClientStatus();if(!azureClient.currentUser){var c=
new qx.ui.window.Window("Authenticate");c.setLayout(new qx.ui.layout.VBox);c.set({width:260,height:140});var d={Microsoft:"microsoftaccount",Twitter:"twitter",Google:"google",Facebook:"facebook"},e=qx.bom.Cookie.get(cookieAuth),f=null;if(e)console.log("lastauth+"+e),f=e.split(":")[0],b(f);else{var e=void 0,g;for(g in d)e=new qx.ui.form.Button("Auth "+g),e.setWidth(180),c.add(e),e.addListener("click",b.bind(0,d[g].toString(),void 0));c.center();c.open()}}}
function azureExplorer(){azureClient.currentUser?(window.open("http://avatar-alliance.com/index.html","_blank"),azureMessages.Append("If nothing happened you may need to disable your popup blocker.")):azureMessages.Append("Please authenticate first.<br>Thank you.")}function dungProgressType(b){switch(b){case 4:return 1}return 0}function bossName(b){switch(b){case 6:return"Dragon";case 7:return"Moloch";case 8:return"Hydra";case 12:return"Octopus"}return"Unknown"}
function getBossType(b){switch(b){case "Dragon":return 6;case "Moloch":return 7;case "Hydra":return 8;case "Octopus":return 12}return 0}function bossUnitType(b,c){var d=null;switch(b){case 6:d=[33,36,39,42,45,48,49,50,51,52];break;case 8:d=[34,37,40,43,46,53,54,55,56,57];break;case 7:d=[35,38,41,44,47,58,59,60,61,62];break;case 12:d=[67,68,69,70,71,72,73,74,75,76]}return d[parseInt(c)-1]}
function SelectByName(b,c){if(null!==b)for(var d=c.getChildren(),e=0;e<d.length;++e)if(d[e].getLabel()===b){c.setSelection([d[e]]);break}}function SelectFromStorage(b,c){SelectByName(localStorage.getItem(b),c)}function SetSelection(b,c){if(null===c||void 0===c)return 0;for(var d=b.getChildren(),e=0;e<d.length;++e)if(d[e].getLabel()===c)return b.setSelection([d[e]]),e;return 0}
function SetSelectionFromStore(b,c){var d=localStorage.getItem(c);if(null!=d)return console.log(c+" == "+d.toString()),SetSelection(b,d)}function getCityMru(){return ava.RaidingWindow.getInstance().getMru().map(function(b){return b.name})}
var versionRelNotes="- Added a recent city list Allows you to rapidly jump back and forth between cities you have recently clicked or visited.<br>- You can access via right click. The default option is the last city visited, there are 8 more in a drop down.<br>- You can see more details via the Raid Box but selecting recent cities.<br>- You can select the image perforce cdn snapshop to use for world tiles under options.<br>- This can be used to disable winter or to speed things up by using an older data set with lower res tiles. I have added a few snapshop scattered over the past two years for you to try.<br>;- Added inline release notes - you can display them all by using the '?' in the panel;- Disable Castle Customizations is now optional;- Added varions options to AvaRaid.  If in doubt, leave them at their default settings;- Added option to disable the lookOut360 mail client. Please see 'options';- Default Perforce Depot is now 409442.  This has less traffic than 409443.<br>;- AvaRaid Fix:  exclude ships works.<br>- Context Menu Fix: Kill Boss fixed<br>;- One Click Boss Kill from the Boss Raing Tab.  Just click on the bosses name.<br> - The UI might fall behind, but the orders are buffered<br> - i.e. if you issue 10 attacks all at once by clicking on each boss, the attacks will appear provided that there are no errors.<br>  To see diagnostics, click on the boss Coordinates<br>;- Raid City Group filtering works again.<br>- Boss Kill prints out attacks, warnings and errors<br>;- 'Virtue Intel' feature<br>  - Displays the faith for each virtue of every alliance.<br>  - Displays the level of the highest level palace for each virtue<br>  - Displays attack bonuses for offense, defense, SE+WG and others<br>  - Displays Baron Cap bonus from spirituality<br>;- Fix for Modal Dialogs: Blockers pushed back.<br> - i.e. Sub Login<br>This will let you get around all modal windows.<br> - You may have to press esc or tab to change focus<br>- Palace Artifact Tool is back<br>;- Mru is now saved across runs<br> - More settings from the raid widndow are saved<br> - Added 'Auto' Mode for raiding troop count selection.  Choses a multiplier based on progress of the dungeon.".split(";"),relNotePrefix=
"192.168.0.",avaCurrentVersion=versionRelNotes.length,relNotesWindow=new MessageWindow("Release Notes",600,-500,400,280),avaSuiteVersion=relNotePrefix+avaCurrentVersion.toString();function resetVersion(){localStorage.avaSuiteLastVersion=0}
function updateVersion(){var b=localStorage.avaSuiteLastVersion||0;if(b!=avaCurrentVersion){for(relNotesWindow.Clear();b<avaCurrentVersion;++b)versionRelNotes[b]&&relNotesWindow.prepend(relNotePrefix+b+"<br>"+versionRelNotes[b]);relNotesWindow.prepend("Avatar Suite: Happiness incarnate.<br>You are free to use, abuse, enjoy and mock this code for all of eternity.<br>");localStorage.avaSuiteLastVersion=avaCurrentVersion}}
(function(b){qx.Class.define("ava.MailApp",{extend:qx.ui.window.Window,construct:function(){this.base(arguments,"lookOut");this.set({width:600,height:500,allowMaximize:!1,allowMinimize:!1,resizable:!0,caption:"lookOut 360",showMaximize:!1,showMinimize:!1,showStatusbar:!1,showClose:!1,contentPadding:0,useMoveFrame:!0});this.setLayout(new qx.ui.layout.Canvas);var b=new qx.ui.basic.Image("webfrontend/ui/win_mainoverlay_paper.jpg");b.setAllowGrowX(!0);b.setAllowShrinkX(!0);b.setAllowGrowY(!0);b.setAllowShrinkY(!0);
b.setScale(!0);this.options=this.doptions={height:500,width:qx.bom.Viewport.getWidth(window)-420,x:410,y:100};this.loadOptions();this.set({width:this.options.width,height:this.options.height});this.moveTo(this.options.x,this.options.y);this.add(b,{top:0,bottom:0,right:0,left:0});this.composeid=0;this.__FolderIcons=[];this.__FolderIcons["@In"]="webfrontend/ui/icons/icon_mail_folder_open_small.png";this.__FolderIcons["@Out"]="webfrontend/ui/icons/icon_mail_folder_open_small.png";this.__FolderIcons["@System"]=
"webfrontend/ui/icons/icon_mail_folder_open_small.png";this.____jF=[];this.____jF["@In"]="Inbox";this.____jF["@Out"]="Outbox";this.____jF["@System"]="System";this.___jG=(new qx.ui.tree.Tree).set({height:54,width:130,font:"font_headline_serif_groupbox",textColor:"textcol-groupbox",openMode:"none"});this.___jG.addListener("changeSelection",this.___jV,this);this.add(this.___jG,{left:5,top:5});this.___jH=(new webfrontend.data.MailHeaderDataModel).set({blockConcurrentLoadRowCount:!1});this.___jH.setColumns(["",
"Subject","From","Received"],["c","s","f","d"]);this.___jH.sortByColumn(3,!1);this.___jI=(new webfrontend.ui.CustomTable(this.___jH)).set({columnVisibilityButtonVisible:!1,statusBarVisible:!1,width:420});this.___jI.addListener("cellClick",this.___jS,this);this.___jI.setAllowGrowX(!1);this.___jI.setAllowShrinkX(!1);b=this.___jI.getTableColumnModel();b.setColumnWidth(0,32);b.setColumnWidth(1,150);b.setColumnWidth(2,90);b.setColumnWidth(3,125);b.setDataCellRenderer(0,new qx.ui.table.cellrenderer.Boolean);
b.setDataCellRenderer(1,new qx.ui.table.cellrenderer.Html);b.setDataCellRenderer(2,new qx.ui.table.cellrenderer.Html);b.setDataCellRenderer(3,new qx.ui.table.cellrenderer.Html);this.add(this.___jI,{left:5,top:60,right:5,bottom:39});this.___jH.addListener("loadRowComplete",this.__ka,this);this.___jDD=!0;this.___jN=this.___jM=0;this.___jJ=(new qx.ui.form.CheckBox("Select All")).set({font:"bold"});this.add(this.___jJ,{left:5,bottom:14});this.___jJ.addListener("click",this.___jP,this);this.___jK=(new qx.ui.form.Button("Delete")).set({width:75,
appearance:"button-text-small",enabled:!1});this.___jK.addListener("click",this.___jT,this);this.add(this.___jK,{bottom:12,left:90});this.___jL=(new qx.ui.form.Button("Mark Unread")).set({width:75,appearance:"button-text-small",enabled:!1});this.___jL.addListener("click",this.___jU,this);this.add(this.___jL,{bottom:12,left:165});this.___jL2=(new qx.ui.form.Button("Mark Read")).set({width:75,appearance:"button-text-small",enabled:!1});this.___jL2.addListener("click",this.___jU2,this);this.add(this.___jL2,
{bottom:12,left:240});this.tabView=(new qx.ui.tabview.TabView).set({contentPaddingLeft:15,contentPaddingRight:10,contentPaddingTop:10,contentPaddingBottom:10});this.tabPages=[];this.add(this.tabView,{top:34,right:3,bottom:30,left:440});this.createCompose(!1,0);webfrontend.net.CommandManager.getInstance().sendCommand("IGMGetFolders",null,this,this.___jW,this.___jO);webfrontend.data.Mail.getInstance().addListener("changeUnread",this.___jY,this);var b=qx.core.Init.getApplication().chat.contextMenu,d;
for(d in b)try{if(b[d]&&b[d].length&&5==b[d].length){b[d][2].removeListener("execute",qx.core.Init.getApplication().chat._onMail,qx.core.Init.getApplication().chat);b[d][2].addListener("execute",this._onSendChatEmail,this);break}}catch(e){}webfrontend.gui.Util.formatWinClose(this);qx.core.Init.getApplication().getTitleWidget().mailButton.removeListener("execute",qx.core.Init.getApplication().getTitleWidget().onMail,qx.core.Init.getApplication().getTitleWidget());qx.core.Init.getApplication().getTitleWidget().mailButton.addListener("execute",
this.DisplayMail,this);var f=this;webfrontend.gui.PlayerInfo.MainWindow.prototype.onSendMail=function(){f.createCompose(this.__rF.sName,0)}},members:{loadOptions:function(){var b=localStorage.getItem("MailApp");if(b){try{this.options=qx.lang.Json.parse(b)}catch(d){}for(var e in this.doptions)this.options[e]||(this.options[e]=this.doptions[e])}else b=qx.lang.Json.stringify(this.options),localStorage.setItem("MailApp",b)},saveOptions:function(){this.options.width=this.getWidth();this.options.height=
this.getHeight();this.options.x=this.getLayoutProperties().left;this.options.y=this.getLayoutProperties().top;var b=qx.lang.Json.stringify(this.options);localStorage.setItem("MailApp",b)},__ka:function(){var b=this.___jI.getFocusedRow();null!=b&&this.___jS({getColumn:function(){return 1},getRow:function(){return b}})},__kb:function(b,d){d.c=this.s;return d},__kc:function(){var b=this.___jH.hasSelected();this.___jK.setEnabled(b);this.___jL.setEnabled(b);this.___jL2.setEnabled(b)},___jP:function(){var b=
!this.___jH.getSelectAll();this.___jH.resetSelected(!1);this.___jH.setSelectAll(b);this.___jH.iterateCachedRows(this.__kb,{s:b});this.___jH.fireDataEvent("dataChanged",{firstColumn:0,lastColumn:0,firstRow:0,lastRow:this.___jH.getRowCount()});this.__kc()},___jQ:function(b,d,e){b&&e.cnt==this.___jM&&(b=qx.core.Init.getApplication(),b.getInfoNavigatorWidget().bulkRemovePages(b.getMailPage(),e),this.___jH.setSelectAll(!1),this.___jH.resetSelected(!0,!0),this.___jI.getSelectionModel().resetSelection(),
this.___jJ.setValue(!1),this.__kc(),0!=d&&webfrontend.ui.MessageBox.messageBox({title:"Deleting Error",text:"Error occurred while deleting Messages",buttons:1}))},___jR:function(b,d,e){b&&e.cnt==this.___jN&&(this.___jH.setSelectAll(!1),this.___jH.resetSelected(!0,!1),this.___jJ.setValue(!1),this.__kc(),b||webfrontend.ui.MessageBox.messageBox({title:"Mark Unread Error",text:"Error occurred while marking messages unread",buttons:1}))},___jS:function(b){var d=this.___jH.getRowData(b.getRow());if(null!=
d){if(0==b.getColumn())d.c=!d.c,this.___jH.setValue(0,b.getRow(),d.c),this.___jH.setSelected(d.i,d.c);else{var e=qx.core.Init.getApplication();d.r||(d.r=1,d.s=d.s.substring(3,d.s.length-4),d.f=d.f.substring(3,d.f.length-4),d.d=d.d.substring(3,d.d.length-4),this.___jH.setValue(1,b.getRow(),d.s),webfrontend.net.CommandManager.getInstance().sendCommand("IGMSetReadFlag",{msgId:d.i,flag:1},this,function(b){}),e.title.resetUnreadMailMarker());d.viewIn=this.___jDD;d.id=d.i;this.checkforTab(d.i)?this.switchtoTab(d.i):
(this.createTab(d),this.getMessage(d.id))}this.__kc()}},___jT:function(b){this.___jM++;b=[];this.___jH.hasSelected()?b=this.___jH.getSelectedIds():(b=[this.___jH.getRowData(this.___jI.getFocusedRow()).id],this.___jI.setFocusedCell(0,-1,!1));webfrontend.net.CommandManager.getInstance().sendCommand("IGMBulkDeleteMsg",{ids:b,f:this.___jH.getFolder(),a:this.___jH.getSelectAll()},this,this.___jQ,{cnt:this.___jM,ids:b,a:this.___jH.getSelectAll()})},___jU:function(b){this.___jN++;b=[];this.___jH.hasSelected()?
b=this.___jH.getSelectedIds():(b=[this.___jH.getRowData(this.___jI.getFocusedRow()).id],this.___jI.setFocusedCell(0,-1,!1));webfrontend.net.CommandManager.getInstance().sendCommand("IGMBulkSetReadFlag",{msgIds:b,flag:0,f:this.___jH.getFolder(),all:this.___jH.getSelectAll()},this,this.___jR,{cnt:this.___jN,ids:b,a:this.___jH.getSelectAll()})},___jU2:function(b){this.___jN++;b=[];this.___jH.hasSelected()?b=this.___jH.getSelectedIds():(b=[this.___jH.getRowData(this.___jI.getFocusedRow()).id],this.___jI.setFocusedCell(0,
-1,!1));webfrontend.net.CommandManager.getInstance().sendCommand("IGMBulkSetReadFlag",{msgIds:b,flag:1,f:this.___jH.getFolder(),all:this.___jH.getSelectAll()},this,this.___jR,{cnt:this.___jN,ids:b,a:this.___jH.getSelectAll()})},___jV:function(b){this.___jI.getSelectionModel().resetSelection();b=b.getData();this.___jH.resetSelected(!1);this.___jH.setSelectAll(!1);"@Out"==b[0].getUserData("name")?(this.___jDD=!1,this.___jH.setColumns(["","Subject","To","Message Sent"],["c","s","to","d"]),this.___jH.setDirection(!1)):
this.___jDD||(this.___jDD=!0,this.___jH.setColumns(["","Subject","From","Received"],["c","s","f","d"]),this.___jH.setDirection(!0));var d=b[0].getUserData("ID");0<b.length&&d&&(this.currentFolder=d,this.___jH.setFolder(d));this.___jI.setFocusedCell(0,-1,!1);this.__kc()},___jW:function(b,d,e){if(!1==b)webfrontend.ui.MessageBox.messageBox({title:"Communication Error",text:"Please Try Again",buttons:1});else if(null!=d&&e==this.___jO){b=(new qx.ui.tree.TreeFolder("Mailbox")).set({icon:"webfrontend/ui/icons/icon_mail_folder_open.png"});
b.setOpen(!0);this.___jG.setRoot(b);this.___jG.toggleHideRoot();e=d.length;for(var f=0;f<e;f++){var g="",g=this.____jF.hasOwnProperty(d[f].n)?this.____jF[d[f].n]:d[f].n,g=new qx.ui.tree.TreeFile(g);g.setUserData("name",d[f].n);g.setUserData("ID",d[f].i);this.__FolderIcons.hasOwnProperty(d[f].n)?g.setIcon(this.__FolderIcons[d[f].n]):g.setIcon("webfrontend/ui/icons_ressource_iron_16.png");b.add(g);"@In"==d[f].n&&this.___jG.setSelection([g])}}},___jY:function(b){this.___jH.getSelectAll();this.___jDD&&
b.getData()>b.getOldData()&&this.___jH.reloadData()},__ES:function(b,d){for(var e=this.tabView.getSelection()[0].id,f=0;f<this.tabPages.length&&this.tabPages[f].id!=e;f++);e="";switch(d){case 0:e=qx.bom.String.escape(this.tabPages[f].page.to.getValue().trim());break;case 1:e=qx.bom.String.escape(this.tabPages[f].page.cc.getValue().trim())}var g="";if(-1!=e.indexOf(";")){for(var h=e.split(";"),k=h.length,l=0;l<k;l++)if(h[l].trim()==b)return;";"!=e.charAt(e.length-1)&&(g+="; ")}else{if(e==b)return;
0<e.length&&(g+="; ")}g+=b;switch(d){case 0:this.tabPages[f].page.to.setValue(this.tabPages[f].page.to.getValue()+g);break;case 1:this.tabPages[f].page.cc.setValue(this.tabPages[f].page.cc.getValue()+g)}},__Tv:function(b){switch(b.type){case 0:this.__ES(b.name,b.fieldType);break;case 1:for(var d=webfrontend.data.Alliance.getInstance().getOfficers(),e=d.length,f=0;f<e;f++)this.__ES(d[f].n,b.fieldType);case 2:d=webfrontend.data.Alliance.getInstance().getLeaders();e=d.length;for(f=0;f<e;f++)this.__ES(d[f].n,
b.fieldType);break;case 3:d=webfrontend.data.Alliance.getInstance().getMemberData();e=d.length;for(f=0;f<e;f++)this.__ES(d[f].n,b.fieldType);break;case 4:for(d=[],b.hasOwnProperty("players")&&(d=b.players),f=0;f<e;f++)this.__ES(d[f],b.fieldType)}},__Tw:function(){this.__Tr.isVisible()?this.__Tr.close():this.__Tr.open()},__Tw2:function(){this.__Tr.isVisible()?this.__Tr.close():this.__Tr.open()},_onSendChatEmail:function(b){this.createCompose(qx.core.Init.getApplication().chat.contextPlayer,0);this.isVisible()||
this.open()},_onSendEmail:function(b){this.createCompose(b._target._lblNameValue.getValue(),0);this.isVisible()||this.open()},checkforTab:function(b){for(var d=0;d<this.tabPages.length;d++)if(this.tabPages[d].id==b)return!0;return!1},switchtoTab:function(b){for(var d=0;d<this.tabPages.length;d++)this.tabPages[d].id==b&&this.tabView.setSelection([this.tabView.getChildren()[d]])},createTab:function(b){var d=this.tabPages.length,e=qx.bom.String.toText(b.s),f=e;10<e.length&&(f=f.substring(0,10)+"...");
for(var g="",h=0;h<b.cc.length;h++)0<h&&(g+="; "),g+=b.cc[h];this.tabPages[d]={name:f,page:null,vbox:null};f=new qx.ui.tabview.Page(this.tabPages[d].name);f.setLayout(new qx.ui.layout.Canvas);var h=new qx.ui.container.Composite(new qx.ui.layout.VBox(0)),k=new qx.ui.container.Composite(new qx.ui.layout.HBox),l=(new qx.ui.basic.Label("Subject")).set({paddingTop:4,maxWidth:50});k.add(l);k.add(new qx.ui.core.Spacer(10));l=(new qx.ui.basic.Label(e)).set({paddingTop:4,maxWidth:300});k.add(l);h.add(k);k=
new qx.ui.container.Composite(new qx.ui.layout.HBox);l=(new qx.ui.basic.Label("Date:")).set({paddingTop:0});k.add(l);k.add(new qx.ui.core.Spacer(18));l=(new qx.ui.basic.Label(this.removeHTML(b.d))).set({paddingTop:0});k.add(l);h.add(k);k=new qx.ui.container.Composite(new qx.ui.layout.HBox);l=(new qx.ui.basic.Label("From:")).set({paddingTop:0});k.add(l);k.add(new qx.ui.core.Spacer(18));l=(new qx.ui.basic.Label(this.BBCodePlayers(b.f))).set({paddingTop:0,rich:!0});k.add(l);h.add(k);k=new qx.ui.container.Composite(new qx.ui.layout.HBox);
l=(new qx.ui.basic.Label("To:")).set({paddingTop:0});k.add(l);k.add(new qx.ui.core.Spacer(30));e=this.PlayerToolTip(b.to);l=(new qx.ui.basic.Label(this.BBCodePlayers(b.to))).set({paddingTop:0,maxWidth:500,rich:!0,toolTipText:e});k.add(l);h.add(k);k=new qx.ui.container.Composite(new qx.ui.layout.HBox);l=(new qx.ui.basic.Label("CC:")).set({paddingTop:0,paddingBottom:20});k.add(l);k.add(new qx.ui.core.Spacer(30));e=this.PlayerToolTip(g);l=(new qx.ui.basic.Label(this.BBCodePlayers(g))).set({paddingTop:0,
maxWidth:500,rich:!0,toolTipText:e});k.add(l);h.add(k);this.tabPages[d].Message=new qx.ui.basic.Label("");h.add(webfrontend.gui.Util.getScrollableRichTextBoxDynamic(this.tabPages[d].Message),{flex:1});g=new qx.ui.container.Scroll(h);f.add(g,{top:0,left:0,right:0,bottom:25});g=new qx.ui.form.Button("Reply");g.set({width:55,appearance:"button-text-small"});g.addListener("click",this.Reply,this);f.add(g,{top:0,right:5});g=new qx.ui.form.Button("Reply All");g.set({width:55,appearance:"button-text-small"});
g.addListener("click",this.ReplyAll,this);f.add(g,{top:18,right:5});g=new qx.ui.form.Button("Forward");g.set({width:55,appearance:"button-text-small"});g.addListener("click",this.ForwardFromMessage,this);f.add(g,{top:36,right:5});g=new qx.ui.form.Button("Delete");g.set({width:55,appearance:"button-text-small"});g.addListener("click",this.DeleteFromMessage,this);f.add(g,{bottom:0,left:0});g=new qx.ui.form.Button("Close");g.set({width:55,appearance:"button-text-small"});g.addListener("click",this.CloseTab,
this);f.add(g,{top:54,right:5});f.id=b.id;this.tabPages[d].bw=b;this.tabPages[d].vbox=h;this.tabPages[d].page=f;this.tabPages[d].id=b.id;this.tabView.add(this.tabPages[d].page);this.switchtoTab(b.id)},PlayerToolTip:function(b){b=this.removeHTML(b);b=b.split(";");var d=[],e=0,f;for(f in b){if("indexOf"==f)break;9<e?(d.push("</br>"+b[f].trim()),e=0):d.push(b[f].trim());e++}return b=d.join("; ")},BBCodePlayers:function(b){b=this.removeHTML(b);b=b.split(";");var d=[],e=0,f;for(f in b){if("indexOf"==f)break;
8>e&&d.push("[player]"+b[f].trim()+"[/player]");e++}7<e&&d.push(e-8+" more...");b=d.join("; ");return b=webfrontend.gui.Util.convertBBCode(webfrontend.gui.Util.generateBBCode(b))},createCompose:function(b,d){this.composeid++;var e=this.composeid,f=this.tabPages.length,g=webfrontend.data.Player.getInstance().getName(),h="",k="Compose",l="",m="",n="";if(0!=d){if(3==d)h="Fwd: "+qx.bom.String.toText(b.bw.s);else if(2==d){h="Re:"==qx.bom.String.toText(b.bw.s).slice(0,3)?qx.bom.String.toText(b.bw.s):"Re: "+
qx.bom.String.toText(b.bw.s);m=qx.bom.String.toText(b.bw.f)+"; "+qx.bom.String.toText(b.bw.to);m=m.replace(g+"; ","");m=m.replace(g+";","");m=m.replace(g,"");n="";for(l=0;l<b.bw.cc.length;l++)0<l&&(n+="; "),n+=b.bw.cc[l];n=n.replace(g+";","");n=n.replace(g,"")}else h="Re:"==qx.bom.String.toText(b.bw.s).slice(0,3)?qx.bom.String.toText(b.bw.s):"Re: "+qx.bom.String.toText(b.bw.s),m=qx.bom.String.toText(b.bw.f);k=h;10<h.length&&(k=k.substring(0,10)+"...");l=b.Message.getValue();l="\n\n[hr]\nFrom: "+qx.bom.String.toText(b.bw.f)+
"\nSent: "+qx.bom.String.toText(b.bw.d)+"\nSubject: "+qx.bom.String.toText(b.bw.s)+"\n\n"+qx.bom.String.toText(l)}else b&&(m=qx.bom.String.toText(b));this.__Tr=new webfrontend.gui.Mail.Contacts.MainWindow({callbackFunction:this.__Tv,opener:this});this.cc=this.receiver="";this.tabPages[f]={name:k,page:null,vbox:null};b=new qx.ui.tabview.Page(this.tabPages[f].name);b.setLayout(new qx.ui.layout.Canvas);var g=new qx.ui.container.Composite(new qx.ui.layout.VBox(0)),k=new qx.ui.container.Composite(new qx.ui.layout.HBox),
p=new qx.ui.form.Button("To");p.set({width:32,appearance:"button-text-small"});p.addListener("click",this.__Tw,this);k.add(p);k.add(new qx.ui.core.Spacer(13));b.to=new qx.ui.form.TextField(m);b.to.setWidth(300);b.to.setMaxLength(3E3);b.to.set({tabIndex:301});b.to.addListener("focusout",this.hotkeys,this);b.to.addListener("focusin",this.nohotkeys,this);k.add(b.to);g.add(k);k=(new qx.ui.container.Composite(new qx.ui.layout.HBox)).set({paddingTop:5});p=new qx.ui.form.Button("CC");p.set({width:32,appearance:"button-text-small"});
p.addListener("click",this.__Tw2,this);k.add(p);k.add(new qx.ui.core.Spacer(13));b.cc=new qx.ui.form.TextField(n);b.cc.setWidth(250);b.cc.setMaxLength(3E3);b.cc.set({tabIndex:302});b.cc.addListener("focusout",this.hotkeys,this);b.cc.addListener("focusin",this.nohotkeys,this);k.add(b.cc);k.add(avaMain.panel.showMailingListBtn);g.add(k);k=(new qx.ui.container.Composite(new qx.ui.layout.HBox)).set({paddingTop:5,paddingBottom:5});p=(new qx.ui.basic.Label("Subject")).set({paddingTop:4,maxWidth:50});k.add(p);
k.add(new qx.ui.core.Spacer(9));b.subject=new qx.ui.form.TextField(h);b.subject.setWidth(300);b.subject.setMaxLength(100);b.subject.set({tabIndex:303});b.subject.addListener("focusout",this.hotkeys,this);b.subject.addListener("focusin",this.nohotkeys,this);k.add(b.subject);k.add(new qx.ui.core.Spacer(14));g.add(k);g.add((new qx.ui.container.Composite(new qx.ui.layout.HBox)).set({paddingTop:5,paddingBottom:0}));b.message=(new qx.ui.form.TextArea(l)).set({allowGrowX:!0,allowGrowY:!0,minHeight:200,maxLength:3E3,
tabIndex:304});b.message.addListener("focusout",this.hotkeys,this);b.message.addListener("focusin",this.nohotkeys,this);b.message.addListener("input",this._ComposeInput,this);b.message.toggleLiveUpdate();g.add(b.message,{flex:1});h=new qx.ui.container.Scroll(g);b.add(h,{top:0,left:0,right:0,bottom:25});h=new qx.ui.container.Composite((new qx.ui.layout.HBox(10)).set({alignY:"middle",alignX:"right"}));m=new qx.ui.basic.Label("Available characters:");h.add(m);b.charCount=new qx.ui.basic.Label("");h.add(b.charCount);
b.add(h,{bottom:0,left:0});var h=(new qx.ui.container.Composite(new qx.ui.layout.VBox)).set({marginTop:0}),m=webfrontend.gui.Util.getBBCodeHBox(b.message,this,275),q;for(q in m)if(m[q]instanceof Array&&3==m[q].length)for(var r in m[q][2])if(m[q][2][r]instanceof Array&&1==m[q][2][r].length){m[q][2][r][0].setVisibility(!1);break}h.add(m);b.add(h,{top:0,left:350});q=new qx.ui.form.Button("Send");q.set({width:55,appearance:"button-text-small"});q.addListener("click",this.Send,this);b.add(q,{top:0,right:5});
q=new qx.ui.form.Button("Close");q.set({width:55,appearance:"button-text-small"});1==e&&q.set({enabled:!1});q.addListener("click",this.CloseTab,this);b.add(q,{top:54,right:5});b.id=e;this.tabPages[f].vbox=g;this.tabPages[f].page=b;this.tabPages[f].id=e;this.tabView.add(this.tabPages[f].page);this.switchtoTab(e);this._ComposeInput()},_ComposeInput:function(){for(var b=this.tabView.getSelection()[0].id,d=0;d<this.tabPages.length;d++)if(this.tabPages[d].id==b){this.tabPages[d].page.charCount.setValue((3E3-
this.tabPages[d].page.message.getValue().length).toString());break}},nohotkeys:function(){qx.core.Init.getApplication().allowHotKey=!1},hotkeys:function(){qx.core.Init.getApplication().allowHotKey=!0},CloseTab:function(){var b=this.tabView.getSelection()[0].id;if(1!=b){this.tabView.remove(this.tabView.getSelection()[0]);for(var d=0;d<this.tabPages.length;d++)if(this.tabPages[d].id==b){qx.lang.Array.remove(this.tabPages,this.tabPages[d]);break}}},Send:function(){var b=this.tabView.getSelection()[0];
""!=b.to.getValue()&&webfrontend.net.CommandManager.getInstance().sendCommand("IGMBulkSendMsg",{targets:b.to.getValue(),ccTargets:b.cc.getValue(),subject:b.subject.getValue(),body:b.message.getValue()},this,this._SendComplete,b.id)},_SendComplete:function(b,d,e){1<e?this.CloseTab():(this.tabPages[0].page.subject.setValue(""),this.tabPages[0].page.to.setValue(""),this.tabPages[0].page.cc.setValue(""),this.tabPages[0].page.message.setValue(""))},DeleteFromMessage:function(){var b=[this.tabView.getSelection()[0].id];
webfrontend.net.CommandManager.getInstance().sendCommand("IGMBulkDeleteMsg",{ids:b,f:this.___jH.getFolder(),a:this.___jH.getSelectAll()},this);this.CloseTab();this.___jH.reloadData()},ForwardFromMessage:function(){for(var b=this.tabView.getSelection()[0].id,d=0;d<this.tabPages.length;d++)if(this.tabPages[d].id==b){this.createCompose(this.tabPages[d],3);break}},Reply:function(){for(var b=this.tabView.getSelection()[0].id,d=0;d<this.tabPages.length;d++)if(this.tabPages[d].id==b){this.createCompose(this.tabPages[d],
1);break}},ReplyAll:function(){for(var b=this.tabView.getSelection()[0].id,d=0;d<this.tabPages.length;d++)if(this.tabPages[d].id==b){this.createCompose(this.tabPages[d],2);break}},removeHTML:function(b){b=b.replace(/&(lt|gt);/g,function(b,c){return"lt"==c?"<":">"});return b.replace(/<\/?[^>]+(>|$)/g,"")},getMessage:function(b){webfrontend.net.CommandManager.getInstance().sendCommand("IGMGetMsg",{id:b},this,this._onMessage,b)},_onMessage:function(b,d,e){if(!1!=b)for(b=0;b<this.tabPages.length;b++)this.tabPages[b].id==
e&&(d=webfrontend.Util.convertSpecialChars(d),d=webfrontend.gui.Util.convertBBCode(webfrontend.gui.Util.generateBBCode(d)),d='<div style="word-wrap: break-word;">'+d+"</div>",this.tabPages[b].Message.setValue(d))},addButton:function(){var b=new qx.ui.form.Button("Mail");b.set({width:50,appearance:"button-text-small",toolTipText:"lookOut"});b.addListener("click",this.DisplayMail,this);qx.core.Init.getApplication().serverBar.add(b,{top:2,left:720})},DisplayMail:function(){this.saveOptions();this.isVisible()?
this.close():(this.___jH.reloadData(),this.open())}}})})(ava||(ava={}));var mailApp;function avaMailInit(){console.debug("init Mail");mailApp=new ava.MailApp}(function(b){})(ava||(ava={}));
qx.Class.define("ava.ResAnalysisWindow",{type:"singleton",extend:qx.ui.window.Window,construct:function(b,c){this.base(arguments,"Res Analysis");this.buildUI();this.addListener("appear",this.getPlayerReports,this)},members:{_wcText:null,_lists:null,_continents:null,_count:0,buildUI:function(){var b=qx.core.Init.getApplication();this.setLayout(new qx.ui.layout.VBox(10));this.set({allowMaximize:!1,allowMinimize:!1,showMaximize:!1,showMinimize:!1,showStatusbar:!1,showClose:!1,contentPadding:5,useMoveFrame:!0,
resizable:!0});this.setWidth(400);webfrontend.gui.Util.formatWinClose(this);var c=(new qx.ui.basic.Label("Alliance Mailing Lists")).set({font:"bold"});this.add(c);this._wcText=new qx.ui.form.TextArea;this._wcText.set({readOnly:!0,allowGrowY:!1,autoSize:!1,tabIndex:303,height:280});b.setElementModalInput(this._wcText);this._wcText.setValue("Loading...");this.add(this._wcText);b=new qx.ui.form.Button("Close");b.addListener("execute",this.hide,this);this.add(b)},getPlayerReports:function(){console.log("In getPlayerReports");
webfrontend.net.CommandManager.getInstance()},gotAlliancePlayers:function(b,c){if(b){this._lists=[];this._continents=[];var d=webfrontend.net.CommandManager.getInstance();this._count=c.length;for(var e=0;e<c.length;++e)d.sendCommand("GetPublicPlayerInfo",{id:c[e].i},this,this.gotPlayerInfo)}},gotPlayerInfo:function(b,c){--this._count;if(b){for(var d=webfrontend.data.Server.getInstance(),e=c.c,f=0;f<e.length;++f){for(var g=d.getContinentFromCoords(e[f].x,e[f].y),h=!1,k=0;k<this._continents.length;++k)if(this._continents[k]==
g){h=!0;break}h||(this._continents[this._continents.length]=g);this._lists[g]||(this._lists[g]="");0>this._lists[g].indexOf(c.n)&&(this._lists[g]+=(0<this._lists[g].length?";":"")+c.n)}if(0==this._count)for(this._wcText.setValue(""),f=0;f<this._continents.length;++f)this._wcText.setValue(this._wcText.getValue()+"Continent "+this._continents[f]+"\r\n"+this._lists[this._continents[f]]+"\r\n\r\n")}}}});
var playerIds=null,cityIds=null,cityArray=null,reportIds=null,playerIx=0,cityIx=0,reportIx=0,wcTextBox=null,wcTextBox1=null,wcTextBox2=null,wcTextBox3=null,wcTextBox4=null,wcTableModel=null,wcLabel2=null,wcLabel3=null,wcpTextBox=null,numDays=null,myAllianceName=null,commandManager=null,server=null,dNow=new Date,resTotal=[0,0,0,0,0],resTotalsPerHour=[0,0,0,0,0],numDungeons=[0,0,0,0],underkillString="",resLeftOnTable=0,numReports=null;
function setNumReports(b,c){try{b?(numReports=c,getPlayerOwnReports()):alert("THERE HAS BEEN FAIL!!!!")}catch(d){alert(d.message)}}
function gotOwnPlayerReportHeader(b,c){console.log("In gotOwnPlayerReportHeader");if(b){alert("Number of Reports Retrieved: "+c.length+"\n this might take a while");for(var d=0;d<c.length;++d){var e=webfrontend.data.ServerTime.getInstance().getServerOffset(),f=6E4*-(new Date).getTimezoneOffset(),g=new Date;g.setTime(Number(c[d].d)+e-f);0<(g.getTime()-dNow.getTime())/1E3&&(reportIds[reportIds.length]=String(c[d].i))}}sendOwnReportCommands()}
function getPlayerOwnReports(){if(numReports){console.log("In getPlayerOwnReports");var b=webfrontend.data.ServerTime.getInstance().getServerOffset(),c=6E4*-(new Date).getTimezoneOffset();dNow.setTime((new Date).getTime()+b-c);dNow.setDate(dNow.getDate()-Number(numDays));wcpTextBox.setValue("scan own reports");if(5500>numReports)commandManager.sendCommand("ReportGetHeader",{sPlayerName:webfrontend.data.Player.getInstance().getName(),folder:0,city:webfrontend.data.City.getInstance().getId(),start:0,
end:numReports,sort:1,ascending:!1,mask:200703},this,gotOwnPlayerReportHeader);else for(b=numReports-4E3,c=numReports/4E3;0<c;c--)b=numReports-4E3,commandManager.sendCommand("ReportGetHeader",{sPlayerName:webfrontend.data.Player.getInstance().getName(),folder:0,city:webfrontend.data.City.getInstance().getId(),start:b,end:numReports,sort:1,ascending:!1,mask:200703},this,gotOwnPlayerReportHeader),numReports-=4E3}else commandManager.sendCommand("ReportGetCount",{city:webfrontend.data.City.getInstance().getId(),
mask:200703},this,setNumReports)}function getPlayerOwnReportCities(){console.log("In getPlayerOwnReportCities");cityIds.length>cityIx?(wcpTextBox.setValue("retrieve cityId["+cityIds[cityIx]+"]"),commandManager.sendCommand("GetPublicCityInfo",{id:cityIds[cityIx++]},this,gotPlayerOwnCityInfo),window.setTimeout(getPlayerOwnReportCities,1E3)):wcpTextBox.setValue("Done.")}
function gotPlayerOwnCityInfo(b,c){console.log("In gotPlayerOwnCityInfo");if(b){var d=RegExp("##"+convertCoordinatesToId(c.x,c.y)+"ll##","g"),e=RegExp("##"+convertCoordinatesToId(c.x,c.y)+"hc##","g");wcTextBox.setValue(wcTextBox.getValue().replace(d,"0"==c.w?"true":"false"));wcTextBox.setValue(wcTextBox.getValue().replace(e,"0"==c.s?"false":"true"));wcTextBox1.setValue(wcTextBox1.getValue().replace(d,"0"==c.w?"onWater":"landlocked"));wcTextBox1.setValue(wcTextBox1.getValue().replace(e,"0"==c.s?"noCastle":
"hasCastle"));console.log(resTotal);d=/##0ll##/g;e=/##0hc##/g;wcTextBox.setValue(wcTextBox.getValue().replace(d,"MISSING CITY"));wcTextBox.setValue(wcTextBox.getValue().replace(e,"MISSING CITY"));wcTextBox1.setValue(wcTextBox1.getValue().replace(d,"MISSING CITY"));wcTextBox1.setValue(wcTextBox1.getValue().replace(e,"MISSING CITY"))}}
function sendOwnReportCommands(){console.log("In sendOwnReportCommands");reportIds.length>reportIx?(wcpTextBox.setValue("retrieve reportId["+reportIds[reportIx]+"]"),commandManager.sendCommand("GetReport",{id:reportIds[reportIx++]},this,gotOwnPlayerReport),window.setTimeout(sendOwnReportCommands,1E3)):getPlayerOwnReportCities()}function numberWithCommas(b){return b.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}
function gotOwnPlayerReport(b,c){webfrontend.res.Main.getInstance();new String;var d=formatReportId(c.sid),e=/Hill/,f=/Forest/,g=/Mountain/,h=/ship/,k=/Boss/;if(b&&null!=c.h.l&&!k.test(c.h.l)&&null!=c.r&&null!=c.rcc){f.test(c.h.l)&&numDungeons[0]++;e.test(c.h.l)&&numDungeons[1]++;g.test(c.h.l)&&numDungeons[2]++;h.test(c.h.l)&&numDungeons[3]++;wcpTextBox.setValue("got report ["+formatDate(c.h.d)+"] ");console.log(formatDate(c.h.d));for(h=0;5>h;h++)0==c.r[h].t?resTotal[0]+=c.r[h].v:1==c.r[h].t?resTotal[1]+=
c.r[h].v:2==c.r[h].t?resTotal[2]+=c.r[h].v:3==c.r[h].t?resTotal[3]+=c.r[h].v:4==c.r[h].t&&(resTotal[4]+=c.r[h].v);k=c.a[0].u;g=c.a[1].u;f=e=0;console.log(k.length);for(h=0;h<k.length;h++)3==k[h].t||4==k[h].t||5==k[h].t||6==k[h].t||7==k[h].t?f+=k[h].l:9==k[h].t||10==k[h].t||11==k[h].t||12==k[h].t?f+=2*k[h].l:15==k[h].t||16==k[h].t?f+=100*k[h].l:17==k[h].t&&(f+=400*k[h].l);for(h=0;h<g.length;h++)switch(g[h].t){case 20:e+=25*g[h].o;break;case 21:e+=33*g[h].o;break;case 23:e+=135*g[h].o;break;case 24:e+=
340*g[h].o;break;case 25:e+=30*g[h].o;break;case 26:e+=40*g[h].o;break;case 27:e+=120*g[h].o;break;case 28:e+=250*g[h].o;break;case 29:e+=25*g[h].o;break;case 30:e+=33*g[h].o;break;case 31:e+=70*g[h].o;break;case 32:e+=290*g[h].o;break;case 63:e+=650*g[h].o;break;case 64:e+=75*g[h].o;break;case 65:e+=250*g[h].o;break;case 66:e+=1400*g[h].o;break;default:console.log("Unknown Type: "+g[h].t),console.log("Unknown Type Lost: "+g[h].l),console.log("Unknown Type ID : "+c.sid)}g=c.a[0].c[0];h=webfrontend.gui.Util.formatCityCoordsFromId(g.i,
!0);console.log(h);if(c.rcc<e)try{console.log("");console.log("");var l=[[g.i,webfrontend.gui.Util.formatCityCoordsFromId(g.i,!0)+" "+g.n,f,d,(c.rcc/e*100).toFixed(2),""]];console.log("rowData: ");console.log(l);underkillString=g.n+" Raid: "+d+" Percentage: "+(c.rcc/e*100).toFixed(2)+"% \n"+underkillString;wcTextBox3.setValue(underkillString);wcTableModel.addRows(l);resLeftOnTable+=e-c.rcc;wcTextBox4.setValue(numberWithCommas(resLeftOnTable)+" Efficiency: "+(100-resLeftOnTable/(resTotal[1]+resTotal[2]+
resTotal[3]+resTotal[4])).toFixed(2)+"%")}catch(m){alert(m.message)}d=["Gold/hr ","Wood/hr ","Stone/hr ","Iron/hr  ","Food/hr "];l="";e=numberWithCommas(resTotal[0])+" Gold \n"+numberWithCommas(resTotal[1])+" Wood \n"+numberWithCommas(resTotal[2])+" Stone \n"+numberWithCommas(resTotal[3])+" Iron \n"+numberWithCommas(resTotal[4])+" Food \n";for(f=0;5>f;f++)g=numberWithCommas((resTotal[f]/(24*numDays)).toFixed(2))+" "+d[f]+" \n",l+=g;wcTextBox.setValue(e);wcTextBox1.setValue(l);wcTextBox2.setValue(" Forest Dungeons: "+
numDungeons[0]+"\n Hill Dungeons: "+numDungeons[1]+"\n Mountain Dungeons: "+numDungeons[2]+"\n Sea Dungeons: "+numDungeons[3]+" \n Total Number of Raids: "+numberWithCommas(numDungeons[0]+numDungeons[1]+numDungeons[2]+numDungeons[3]));console.log(resTotal)}}
qx.Class.define("ava.PlayerReportsWindow",{type:"singleton",extend:qx.ui.window.Window,construct:function(){this.base(arguments,"Dungeon Raiding Summary");this.buildUI()},members:{_wcpText:null,_wcText:null,_wcText1:null,cityArray:null,onCellClick:function(b){console.log(this._tableModel);console.log(this._tableModel.getValue(0,b.getRow()));this.curRow=b.getRow();this.curId=this._tableModel.getValue(0,this.curRow);var c=webfrontend.gui.Util.formatCityCoordsFromId(this.curId,!0);switch(b.getColumn()){case 1:try{var d=
this._tableModel.getValue(0,b.getRow());webfrontend.data.City.getInstance().setRequestId(d);var e=/\d\d\d:\d\d\d/.exec(c),f=e[0].substring(0,3),g=e[0].substring(4,7);webfrontend.gui.Util.showMapModeViewPos("r",0,f,g)}catch(h){console.log("ERROR!"),console.log(h.message)}break;case 5:try{var d=this._tableModel.getValue(0,b.getRow()),k=this._tableModel.getValue(5,b.getRow());webfrontend.net.CommandManager.getInstance().sendCommand("UnitOrderSetRecurringOptions",{cityid:d,id:k,isDelayed:0,recurringType:0,
recurringEndStep:0},this,this.onTroopsSent)}catch(l){alert(l.message)}}},buildUI:function(){var b=qx.core.Init.getApplication();this.setLayout(new qx.ui.layout.HBox(2));this.set({allowMaximize:!1,allowMinimize:!1,showMaximize:!1,showMinimize:!1,showStatusbar:!1,showClose:!1,contentPadding:5,useMoveFrame:!0,resizable:!0});this.setWidth(500);webfrontend.gui.Util.formatWinClose(this);var c=new qx.ui.container.Composite(new qx.ui.layout.VBox(10)),d=new qx.ui.container.Composite(new qx.ui.layout.VBox(10));
this.add(c);this.add(d);var e=(new qx.ui.basic.Label("Dungeon Reports")).set({font:"bold"});c.add(e);this._wcpText=new qx.ui.form.TextArea;this._wcpText.set({readOnly:!0,allowGrowY:!1,autoSize:!1,tabIndex:302,height:30});b.setElementModalInput(this._wcpText);this._wcpText.setValue("");c.add(this._wcpText);wcpTextBox=this._wcpText;e=(new qx.ui.basic.Label("Total Res Gathered in past 24 hours")).set({font:"bold"});c.add(e);this._wcText=new qx.ui.form.TextArea;this._wcText.set({readOnly:!0,allowGrowY:!1,
autoSize:!1,tabIndex:303,height:100});b.setElementModalInput(this._wcText);this._wcText.setValue("Click Go to Generate Data");c.add(this._wcText);wcTextBox=this._wcText;e=(new qx.ui.basic.Label("Estimated Dungeon Resource Income per Hour")).set({font:"bold"});c.add(e);this._wcText1=new qx.ui.form.TextArea;this._wcText1.set({readOnly:!0,allowGrowY:!1,autoSize:!1,tabIndex:303,height:100});b.setElementModalInput(this._wcText1);this._wcText1.setValue("Click Go to Generate Data");c.add(this._wcText1);
wcTextBox1=this._wcText1;wcLabel2=(new qx.ui.basic.Label("Reports by Dungeon Type")).set({font:"bold"});c.add(wcLabel2);this._wcText2=new qx.ui.form.TextArea;this._wcText2.set({readOnly:!0,allowGrowY:!1,autoSize:!1,tabIndex:303,height:100});b.setElementModalInput(this._wcText1);this._wcText2.setValue("Click Go to Generate Data");c.add(this._wcText2);wcTextBox2=this._wcText2;wcLabel3=(new qx.ui.basic.Label("Low Profit Reports")).set({font:"bold"});d.add(wcLabel3);this._wcText3=new qx.ui.form.TextArea;
this._wcText3.set({readOnly:!0,allowGrowY:!1,autoSize:!1,tabIndex:303,height:300});b.setElementModalInput(this._wcText3);this._wcText3.setValue("Click Go to Generate Data");wcTextBox3=this._wcText3;c=this._tableModel=new qx.ui.table.model.Simple;c.setColumns("CityID;City;TS;Report;Percent;Order ID".split(";"));c.setColumnEditable(1,!0);c.setColumnEditable(2,!0);c.setColumnSortable(1,!1);wcTableModel=this._tableModel;c=this._table=new qx.ui.table.Table(c);c.set({width:200,height:300,decorator:null});
c.addListener("cellClick",this.onCellClick,this);d.add(c);c=new qx.ui.basic.Label("Res Lost due to Underkill: ");c.set({font:"bold"});d.add(c);this._wcText4=new qx.ui.form.TextArea;this._wcText4.set({readOnly:!0,allowGrowY:!1,autoSize:!1,tabIndex:303,height:30});b.setElementModalInput(this._wcText3);this._wcText4.setValue("Click Go to Generate Data");d.add(this._wcText4);wcTextBox4=this._wcText4;c=new qx.ui.container.Composite(new qx.ui.layout.HBox(2));e=new qx.ui.basic.Label("Number of days to get");
e.set({font:"bold"});c.add(e,{left:13,top:8});this._numDays=new qx.ui.form.TextField;this._numDays.set({toolTipText:"Number of days to get"});b.setElementModalInput(this._numDays);this._numDays.setValue("1");c.add(this._numDays);numDays="1";this._numDays.addListener("changeValue",this.setNumDays,this);b=new qx.ui.form.Button("Go");b.addListener("execute",this.getplayerReports,this);c.add(b);b=new qx.ui.form.Button("Clear");b.addListener("execute",this.clearData,this);c.add(b);b=new qx.ui.form.Button("Close");
b.addListener("execute",this.hide,this);c.add(b);d.add(c);myAllianceName=webfrontend.data.Alliance.getInstance().getName().toLowerCase()},clearData:function(){console.log(this._tableModel);this._tableModel.removeRows(0,this._tableModel.getRowCount())},setNumDays:function(b){numDays=this._numDays.getValue()},getplayerReports:function(){this.clearData();console.log("In getplayerReports");resTotal=[0,0,0,0,0];resTotalsPerHour=[0,0,0,0,0];numDungeons=[0,0,0,0];resLeftOnTable=0;this.cityArray=[];server=
webfrontend.data.Server.getInstance();playerIds=[];cityIds=[];cityArray=[];reportIds=[];reportIx=cityIx=reportIx=playerIx=0;reportIds=[];commandManager=webfrontend.net.CommandManager.getInstance();getPlayerOwnReports()}}});
var VTreeNode=function(){return function(){}}(),__extends=this.__extends||function(b,c){function d(){this.constructor=b}for(var e in c)c.hasOwnProperty(e)&&(b[e]=c[e]);d.prototype=c.prototype;b.prototype=new d},Coord=function(){function b(b,d){if("number"==typeof b&&"number"==typeof d)this.x=b,this.y=d;else if("number"==typeof b&&"undefined"==typeof d)this.x=b&65535,this.y=b>>16;else if("string"==typeof b&&"string"==typeof d)this.x=parseInt(b),this.y=parseInt(d);else if("undefined"==typeof d){var e=
b.toString().match(/(\d{1,3}:\d{1,3})/);if(null==e)throw"bad coordinate"+b;e=e[0].split(":");this.x=parseInt(e[0]);this.y=parseInt(e[1])}else debugger}b.prototype.toNumber=function(){return Math.floor(this.x)|Math.floor(this.y)<<16};b.prototype.toString=function(){return zeroPad3(this.x.toString())+":"+zeroPad3(this.y.toString())};b.prototype.format=function(){return this.toString()};b.prototype.getId=function(){return this.toNumber()};b.prototype.toArray=function(){return[this.x,this.y]};b.prototype.length=
function(){return Math.sqrt(this.length2())};b.prototype.length2=function(){return this.x*this.x+this.y*this.y};b.prototype.getCont=function(){return webfrontend.data.Server.getInstance().getContinentFromCoords(this.y,this.x)};b.prototype.showOnMap=function(){webfrontend.gui.Util.showMapModeViewPos("r",0,this.x,this.y)};b.prototype.openCity=function(b){webfrontend.data.City.getInstance().setRequestId(this.getId());b&&this.showOnMap()};b.prototype.showCityInfo=function(b,d){"undefined"===typeof b&&
(b=!0);"undefined"===typeof d&&(d=!0);var e=qx.core.Init.getApplication();e.showInfoPage(e.getCityInfoPage(),{id:this.getId(),onlyCity:b,showLocation:d})};return b}();function safeGetProperty(b,c){return b&&b.hasOwnProperty(c)?b[c]:null}function zeroPad3(b){return 1==b.length?"00"+b:2==b.length?"0"+b:b}function getDist(b,c){var d=b.x-c.x,e=b.y-c.y;return Math.sqrt(d*d+e*e)}function convertCoordinatesToId(b,c){return(new Coord(b,c)).getId()}
function convertIdToCoordinateString(b){return(new Coord(b)).format()}function convertIdToCoordinatesObject(b){return new Coord(b)}function cityIdToCoords(b){return convertIdToCoordinatesObject(b)}function removeBBcode(b){return b.replace(/\[\/?\w+\]/g,"")}function normalizeCoords(b){b=removeBBcode(b).trim();return(new Coord(b)).toString()}function cityIdToCont(b){return(new Coord(b)).getCont()}var WorldCoord=function(b){function c(){b.apply(this,arguments)}__extends(c,b);return c}(Coord);
function assert(b){b||(console.trace(),console.assert(b))}var WorldViewCoord=function(b){function c(){b.apply(this,arguments)}__extends(c,b);return c}(Coord),ORDER_STATE;(function(b){b[b.OUTGOING=1]="OUTGOING";b[b.RETURNING=2]="RETURNING"})(ORDER_STATE||(ORDER_STATE={}));var BossType=function(){return function(){}}(),DO_NOT_ATTACK_UNITS={1:!0,19:!0},DO_NOT_PLUNDER_UNITS={2:!0,13:!0,14:!0,77:!0};
function startup1(b){null==qx.core.Init.getApplication().chat||"undefined"==typeof webfrontend.res.Main?(console.warn("chat not found, retry again soon.  Attempts: "+b),20>b&&window.setTimeout(startup1,5>b?1E3:5E3,b+1)):(console.debug("dependencies found.  initialize AvaSuite1"),avaSuiteInit1())}
function startup0(b){"undefined"==typeof qx.core.Init.getApplication||null==qx.core.Init.getApplication()||"undefined"==typeof webfrontend.gui||"undefined"==typeof webfrontend.gui.CityInfoView||"undefined"==typeof ava||"undefined"==typeof webfrontend.gui.OverlayWidget?(console.warn("qx or webfrontend  not found, retry again soon.  Attempts: "+b),20>b&&window.setTimeout(startup0,5>b?1E3:5E3,b+1)):(console.debug("dependencies found.  initialize AvaSuite"),avaSuiteInit0(),startup1(0))}
(function(){console.log("AvaSuitePre:  yay!\n\n...\nits lonely in here.");if(/lordofultima\.com/i.test(document.domain)){var b=document.createElement("script");b.id="AvatarSuiteExt";b.async=!0;b.type="text/javascript";b.src="http://code.jquery.com/jquery-2.1.0.min.js";document.body.appendChild(b)}startup0(0);/lordofultima\.com/i.test(document.domain)&&(b=document.createElement("script"),b.id="AvatarSuiteExt2",b.async=!0,b.type="text/javascript",b.src="http://ajax.aspnetcdn.com/ajax/mobileservices/MobileServices.Web-1.1.0.min.js",
document.body.appendChild(b));b=document.createElement("script");b.id="togetherjs";b.async=!0;b.type="text/javascript";b.src="https://togetherjs.com/versions/0.1HOTDISH/togetherjs.js";document.body.appendChild(b)})();
