// ==UserScript==
// @name        SpyShare
// @namespace   SpyShareNamespace
// @author	 [TSN]Kanly
// @include     *.ogame.gameforge.com/game/*
// @require     http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js
// @resource  	meta http://userscripts.org/scripts/source/372993.meta.js
// @version     1.0
// ==/UserScript==

var SSR={},noSpyShareTxt="\n\n If you see this message then you don't have the SpyShare Tool, it is not active/working or Commander is not activated. For more info check the[url=http://userscripts.org/scripts/show/372993] SpyShare Page[/url]";function main(){SSR.Data.init();SSR.Updater.check();SSR.Init.init()}
SSR.Updater={scriptId:372993,updStr:"",scriptName:"",checkD:1,checkH:0,checkM:0,checkS:0,checkInterval:0,currVersion:0,parseVersion:function(a){return parseInt(a.match(/@uso:version\s+\d+/)[0].match(/\d+/))},call:function(a){GM_xmlhttpRequest({method:"GET",url:"https://userscripts.org/scripts/source/"+this.scriptId+".meta.js",onload:function(b){SSR.Updater.compare(b.responseText,a)}})},compare:function(a,b){a.match(/@uso:version\s+\d+/)[0].match(/\d+/)>this.currVersion?confirm("A new version of the "+
this.scriptName+" user script is available. Do you want to update?")?(SSR.Storage.store(this.updStr,(new Date).getTime()+""),top.location.href="https://userscripts.org/scripts/source/"+this.scriptId+".user.js"):confirm("Do you want to turn off auto updating for this script?")?(SSR.Storage.store(this.updStr,"off"),GM_registerMenuCommand("Auto Update "+this.scriptName,function(){SSR.Storage.store(SSR.Updater.updStr,(new Date).getTime()+"");SSR.Updater.call(!0)}),alert("Automatic updates can be re-enabled for this script from the User Script Commands submenu.")):
SSR.Storage.store(this.updStr,(new Date).getTime()+""):(b&&alert("No updates available for "+this.scriptName),SSR.Storage.store(this.updStr,(new Date).getTime()+""))},check:function(){var a=GM_getResourceText("meta"),b=(new Date).getTime();this.scriptName=a.match(/@name\s+(.*)\s*\n/i)[1];this.currVersion=a.match(/@uso:version\s+\d+/)[0].match(/\d+/);this.updStr="updated_"+this.scriptId;this.checkInterval=1E3*(60*(60*(60*(24*this.checkD+this.checkH)+this.checkH)+this.checkM)+this.checkS);a=SSR.Storage.get(this.updStr,
0);"off"===a?GM_registerMenuCommand("Enable "+this.scriptName+" updates",function(){SSR.Storage.store(SSR.Updater.updStr,(new Date).getTime()+"");SSR.Updater.call(!0)}):b>parseInt(a)+this.checkInterval&&(SSR.Storage.store(this.updStr,b+""),this.call());GM_registerMenuCommand("Check "+this.scriptName+" for updates",function(){SSR.Storage.store(SSR.Updater.updStr,(new Date).getTime()+"");SSR.Updater.call(!0)})}};
SSR.Data={universe:"",playerId:0,buddies:[],page:"",allianceName:"",init:function(){SSR.Data.playerId=document.getElementsByName("ogame-player-id")[0].content;SSR.Data.universe=document.getElementsByName("ogame-universe")[0].content;SSR.Data.allianceName=document.getElementsByName("ogame-alliance-tag")[0].content;SSR.Data.page=(unsafeWindow.location+"").match(/page=[^&]+((?=&)|(?=#)|)/g)[0].replace("page=","")}};
SSR.Storage={getPrefix:function(){return SSR.Data.universe+"::"+SSR.Data.playerId+":::"},store:function(a,b){GM_setValue(SSR.Storage.getPrefix()+a,b)},get:function(a,b){return GM_getValue(SSR.Storage.getPrefix()+a,b)},remove:function(a){GM_deleteValue(SSR.Storage.getPrefix()+a)}};
SSR.Init={init:function(){!1!==SSR.Init.hasCommander()&&(SSR.Buddies.getBuddies(),"messages"===SSR.Data.page&&(GM_addStyle(SSR.shareSection.getCss()),SSR.Utils.waitForKeyElements("#mailz",SSR.Reports.fullSpyReports,!1),SSR.Utils.waitForKeyElements(".read.messagebox",SSR.Reports.widgetMessagePopUp,!1)))},hasCommander:function(){var a=!1;$("#officers").find("a.tooltipHTML.on").each(function(){-1!=$(this).attr("class").indexOf("commander")&&(a=!0)});return a}};
SSR.Reports={widgetMessagePopUp:function(a){var b=!1,c=!1,e=!1;a.find('.infohead th[scope="row"]').next().text().match(/\[spyShare\]/g)?b=!0:(kk=a.find(".textWrapper .note").text().match(/_SPY_SHARE_/g))&&kk&&2===kk.length?e=b=!0:!1===$('.infohead span.playerName a[target="_parent"]').exists()&&$(".defenseattack.spy").exists()&&(c=!0);if(!1!==b||!1!==c)b?(b=a.find(".note .other.newMessage"),!1===b.exists()&&!0===e&&(b=a.find(".textWrapper .note")),b=b.text(),b=b.match(/_SPY_SHARE_.+_SPY_SHARE_/g)[0].replace(/_SPY_SHARE_/g,
""),b=JSON.decode(b),a.find(".showMsgNavi").remove(),a.find(".answerHeadline.open").remove(),a.find(".answerForm").remove(),a.find(".note").html(SSR.Reports.formSharedReportHtml(b))):c&&(a.find(".defenseattack.spy").parent().append(SSR.shareSection.getHtml(!0)),a.find(".textWrapper").css("max-height","none"),SSR.shareSection.initEvents(a))},fullSpyReports:function(a){$('[id^="spioDetails_"]').each(function(){$(this).find(".defenseattack.spy").parent().append(SSR.shareSection.getHtml(!0))});SSR.shareSection.initEvents(a)},
formSharedReportHtml:function(a){function b(a,b){var f='<table cellpadding="0" cellspacing="0" class="fleetdefbuildings spy"><tbody><tr><th class="area" colspan="4">'+a+"</th></tr>",c=0,k;for(k in b)b.hasOwnProperty(k)&&(0===c%2&&(f+="<tr>"),f+='<td class="key">'+k+'</td><td class="value">'+b[k]+"</td>",1===c%2&&(f+="</tr>"),c++);return f+"</tbody></table>"}var c="",c=function(a){return'<table cellpadding="0" cellspacing="0" class="material spy"><tbody><tr><th class="area" style="color: #6f9fc8" colspan="6" plunder_status='+
a.pl_st+'><span style="float: left; color: '+a.act_clr+';" title='+a.act_title+">&nbsp;&nbsp;"+a.act+"</span>"+a.part1+'<a target="_parent" href="javascript:showGalaxy('+SSR.Utils.formatCoords(a.coords,!0)+')">'+SSR.Utils.formatCoords(a.coords,!1)+"</a>"+a.part2+"<span class="+a.tar_class+">"+a.player+"</span>)"+a.part3+"</th></tr>"}(a.header),c=c+function(a){return'<tr class="areadetail"><td colspan="6"><table class="fragment spy2"><tbody><tr><td class="item">'+a[0].name+"</td><td>"+a[0].value+'</td><td class="item">'+
a[1].name+"</td><td>"+a[1].value+'</td></tr><tr><td class="item">'+a[2].name+"</td><td>"+a[2].value+'</td><td class="item">'+a[3].name+"</td><td>"+a[3].value+"</td></tr></tbody></table>"}(a.resources),e;for(e in a.data)a.data.hasOwnProperty(e)&&"resources"!==e&&(c+=b(e+"",a.data[e]));return c},extractSpyReportData:function(a){var b={},c=[],e={},d={},g={};a.siblings(".aktiv.spy").each(function(){var a=$(this);d.act_title=a.find("th.area").text();a.find("font").exists()?(d.act_clr=a.find("font").attr("color"),
d.act=a.find("font").text()):(d.act_clr="#848484",d.act="-- ")});a.siblings(".material.spy").find("th.area").each(function(){var a=$(this);d.pl_st=!0===a.is("[plunder_status]")?a.attr("plunder_status"):"0";a.find("span:last").each(function(){d.player=$(this).text();d.tar_class=$(this).attr("class")});var a=a.text(),a=a.replace(d.act,""),a=a.replace(d.player,""),b=a.match(/\[[^\]]+\]/g);b&&b[0]?(d.coords=b[0].match(/\d+/g),a=a.replace(b,"")):d.coords=["0","0","0"];(b=a.match(/\([^\)]+/g))&&b[0]?(d.part2=
b[0],a=a.replace(b,"")):d.part2="(Player: ";(b=a.match(/[^\)]+(.+)/))&&b[1]?(d.part3=b[1].replace(")",""),a=a.replace(b[1],"")):d.part3=" no time available";d.part1=a});b.header=d;a.siblings(".material.spy").find(".fragment.spy2").each(function(){$(this).find("td").each(function(){var a=$(this);"item"===a.attr("class")?e.name=a.text():(e.value=a.text(),c.push(e),e={})})});b.resources=c;a.siblings(".fleetdefbuildings.spy").each(function(){var a=$(this).find("th.area").text(),b={};$(this).find("td.key").each(function(){b[$(this).text()]=
$(this).next().text()});g[a]=b});b.data=g;return b}};
SSR.Buddies={getBuddies:function(){SSR.Data.buddies=JSON.decode(SSR.Storage.get("myBuddies","[]"));SSR.Utils.waitForKeyElements("#buddylist",SSR.Buddies.extractBuddies,!1);0===SSR.Data.buddies.length&&SSR.Buddies.requestBuddies()},requestBuddies:function(){SSR.Utils.sendRequest({method:"GET",url:"http://"+SSR.Data.universe+"/game/index.php?page=buddies&action=9&ajax=1",host:SSR.Data.universe,acc:"*/*",ref:"http://"+SSR.Data.universe+"/game/index.php?page=overview",contType:"application/x-www-form-urlencoded",
payload:"",onloadFun:SSR.Buddies.parseBuddiesStr})},parseBuddiesStr:function(a){a=$.parseHTML(a);SSR.Buddies.extractBuddies($(a,"table#buddylist"))},extractBuddies:function(a){SSR.Data.buddies.length=0;a.find("tbody tr").each(function(){var a=$(this),c=a.find("span:first").text(),a=a.find(".deleteBuddy").attr("id");SSR.Data.buddies.push({id:a,name:c})});SSR.Storage.remove("myBuddies");SSR.Storage.store("myBuddies",JSON.encode(SSR.Data.buddies))}};
SSR.shareSection={getCss:function(){return'a.sendShareInfo.ok {color: green;}a.sendShareInfo.err {color: red;}td.blockTD {display: inline-block;}.dropdown-check-list {display: inline-block;font-family: Verdana,Arial,SunSans-Regular,Sans-Serif;font-size: 12px;}.dropdown-check-list .anchor {position: relative;cursor: pointer;display: inline-block;padding: 5px 50px 5px 10px;background-color: #23282d;border: 1px solid #000;color:#6f9fc8;-webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;}.dropdown-check-list .anchor:after {position: absolute;content: "";border-left: 2px solid lawnGreen;border-top: 2px solid lawnGreen;padding: 5px;right: 10px;top: 20%;-moz-transform: rotate(-135deg);-ms-transform: rotate(-135deg);-o-transform: rotate(-135deg);-webkit-transform: rotate(-135deg);transform: rotate(-135deg);}.dropdown-check-list.visible .anchor:after {top: 40%;-moz-transform: rotate(45deg);-ms-transform: rotate(45deg);-o-transform: rotate(45deg);-webkit-transform: rotate(45deg);transform: rotate(45deg);}.dropdown-check-list ul.items {padding: 2px;display: none;margin: 0;border: 1px solid #000;border-top: none;background-color: #161A1F;color: #848484;}.dropdown-check-list ul.items li, .dropdown-check-list ul.items input {cursor: pointer;list-style: none;-webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;}.dropdown-check-list.visible li.groupHeader {color: #6f9fc8;}.dropdown-check-list.visible .items {display: block;}'},getHtml:function(a){var b=
"";a&&(b+='<table cellpadding="0" cellspacing="0" class="spy"><tbody><tr><th class="area" colspan="4">Share it</th></tr>');b+="<tr><td>"+SSR.shareSection.getListHtml()+'</td><td class="blockTD"><a class="btn_blue share_button">Share</a></td><td class="blockTD"><a class="sendShareInfo"></a></td></tr>';a&&(b+="</tbody></table>");return b},getListHtml:function(){var a='<div class="shareList dropdown-check-list"><span class="anchor">Share With</span><ul class="items">';0!==SSR.Data.buddies.length&&(a+=
'<li class="groupHeader"><input type="checkbox" data="Friend" class="shareGroup"/>All Friends </li>');for(var b in SSR.Data.buddies)a+='<li><input type="checkbox" data="'+SSR.Data.buddies[b].id+'" class="share Friend" />'+SSR.Data.buddies[b].name+"</li>";a+='<li class="groupHeader"><input type="checkbox" id="allianceShare" data="Ally" class="shareGroup" />'+SSR.Data.allianceName+" Alliance </li>";return a+"</ul></div>"},updateShareNote:function(a,b,c){"err"===b?a.parent().siblings().find("a.sendShareInfo").removeClass("ok").addClass("err"):
a.parent().siblings().find("a.sendShareInfo").removeClass("err").addClass("ok");a.parent().siblings().find("a.sendShareInfo").text(c)},initEvents:function(a){a.find(".shareList .anchor").click(function(a){a=$(this).parent();a.hasClass("visible")?a.removeClass("visible"):a.addClass("visible")});a.find(".shareList input:checkbox.shareGroup").click(function(a){a=$(this);var c=a.is(":checked"),e=a.attr("data");c?a.parent().siblings().find("input:checkbox."+e).not(":checked").click():a.parent().siblings().find("input:checkbox:checked."+
e).click()});a.find("a.share_button").click(function(a){var c=$(this),e=[],d=!1;a.preventDefault();c.parent().siblings().find("input:checked.share").each(function(){e.push($(this).attr("data"))});d=c.parent().siblings().find("#allianceShare:checked").exists();0===e.length&&!1===d?SSR.shareSection.updateShareNote(c,"err","No destination selected!"):(info=SSR.Reports.extractSpyReportData(c.closest("table")),SSR.Utils.sendSharedMessages(c,e,"[spyShare] "+info.header.player+" ["+SSR.Utils.formatCoords(info.header.coords,
!1)+"]","_SPY_SHARE_"+JSON.encode(info)+"_SPY_SHARE_"+noSpyShareTxt,d))})}};
SSR.Utils={sendRequest:function(a){var b={"Accept-Language":"en-us,en;q=0.5","Accept-Encoding":"gzip, deflate",Connection:"keep-alive"};b.Accept=a.acc&&""!==a.acc?a.acc:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8";a.host&&(b.Host=a.host);a.ref&&(b.Referer=a.ref);a.contType&&(b["Content-Type"]=a.contType);GM_xmlhttpRequest({method:a.method,url:a.url,headers:b,data:a.payload,onload:function(b){if(a.onloadFun)a.onloadFun(b.responseText)},onabort:function(b){if(a.onabortFun)a.onabortFun(b.responseText)},
onerror:function(b){if(a.onerrorFun)a.onerrorFun(b.responseText)},ontimeout:function(b){if(a.ontimeoutFun)a.ontimeoutFun(b.responseText)}})},sendSharedMessages:function(a,b,c,e,d){function g(){SSR.Utils.sendRequest({method:"POST",url:"http://"+SSR.Data.universe+"/game/index.php?page=messages&to="+b[k],host:SSR.Data.universe,acc:"",ref:"http://"+SSR.Data.universe+"/game/index.php?page=messages",contType:"application/x-www-form-urlencoded",payload:"betreff="+c+"&text="+e,onloadFun:f})}function f(c){h++;
k++;SSR.shareSection.updateShareNote(a,"ok",h+"/"+p+" messages sent!");k<b.length&&unsafeWindow.setTimeout(g,300)}var h=0,k=0,p=b.length;d?(p++,k=-1,SSR.Utils.sendRequest({method:"POST",url:"http://"+SSR.Data.universe+"/game/index.php?page=allianceBroadcast",host:SSR.Data.universe,acc:"",ref:"http://"+SSR.Data.universe+"/game/index.php?page=alliance",contType:"application/x-www-form-urlencoded",payload:"empfaenger=200&&text="+e+"&ajax=1",onloadFun:f})):g(b[k])},formatCoords:function(a,b){var c=b?
",":":";return parseInt(a[0])+c+parseInt(a[1])+c+parseInt(a[2])},waitForKeyElements:function(a,b,c,e){var d;(d="undefined"==typeof e?$(a):$(e).contents().find(a))&&0<d.length?(d.each(function(){var a=$(this);a.data("alreadyFound")||(unsafeWindow.setTimeout(function(){b(a)},100),a.data("alreadyFound",!0))}),d=!0):d=!1;var g=SSR.Utils.waitForKeyElements.controlObj||{},f=a.replace(/[^\w]/g,"_"),h=g[f];d&&c&&h?(clearInterval(h),delete g[f]):h||(h=setInterval(function(){SSR.Utils.waitForKeyElements(a,
b,c,e)},2E3),g[f]=h);SSR.Utils.waitForKeyElements.controlObj=g}};
JSON=new function(){this.encode=function(){var a=arguments.length?arguments[0]:this,c,m;if(null===a)c="null";else if(void 0!==a&&(m=h[typeof a](a)))switch(m){case Array:c=[];for(var n=0,l=0,q=a.length;l<q;l++)void 0!==a[l]&&(m=JSON.encode(a[l]))&&(c[n++]=m);c="[".concat(c.join(","),"]");break;case Boolean:c=String(a);break;case Date:c='"'.concat(a.getFullYear(),"-",b(a.getMonth()+1),"-",b(a.getDate()),"T",b(a.getHours()),":",b(a.getMinutes()),":",b(a.getSeconds()),'"');break;case Function:break;case Number:c=
isFinite(a)?String(a):"null";break;case String:c='"'.concat(a.replace(e,g).replace(d,f),'"');break;default:n=0;c=[];for(l in a)void 0!==a[l]&&(m=JSON.encode(a[l]))&&(c[n++]='"'.concat(l.replace(e,g).replace(d,f),'":',m));c="{".concat(c.join(","),"}")}return c};var a={"\b":"b","\t":"t","\n":"n","\f":"f","\r":"r",'"':'"',"\\":"\\","/":"/"},b=function(a){return 10>a?"0".concat(a):a},c=["","000","00","0",""],e=/(\x5c|\x2F|\x22|[\x0c-\x0d]|[\x08-\x0a])/g,d=/([\x00-\x07]|\x0b|[\x0e-\x1f])/g,g=function(b,
c){return"\\".concat(a[c])},f=function(a,b){var d=b.charCodeAt(0).toString(16);return"\\u".concat(c[d.length],d)},h={"boolean":function(){return Boolean},"function":function(){return Function},number:function(){return Number},object:function(a){return a instanceof a.constructor?a.constructor:null},string:function(){return String},undefined:function(){return null}};this.decode=function(a,b){return"string"!=typeof a||!a.length||b&&!/^[,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]*$/.test(a.replace(/\\./g,"@").replace(/"[^"\\\n\r]*"/g,
""))?{}:eval("("+a+")")}};$.fn.exists=function(){return 0!==this.length};document.body&&main();