// ==UserScript==
// @name           eSim Damage Calculator Mini
// @version        0.4
// @namespace      localhost
// @author         Heff (modified by cryst216 and calin)
// @description    A small tool to calculate potential damage of a player when viewing their profile.
// @match          http://*.e-sim.org/profile.html?id=*
// @icon           http://e-sim.home.pl/eworld/img/favicon.png
// @downloadURL    http://userscripts.org/scripts/source/182894.user.js
// @updateURL      http://userscripts.org/scripts/source/182894.meta.js
// ==/UserScript==

function addJQuery(f){var b=document.createElement("script");b.setAttribute("src","http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js");b.addEventListener("load",function(){var b=document.createElement("script");b.textContent="("+f.toString()+")();";document.body.appendChild(b)},!1);document.body.appendChild(b)}
function main(){function f(a){$.ajax({url:"militaryUnit.html?id="+a,success:function(a){var b=$(a).find(".battleDiv:first > div:eq(3) a[href^='battle.html?id=']:first");0<b.length?0===$(a).find(".battleDiv:first > div:eq(3) > b:contains('World War')").length?(a=$(a).find(".battleDiv:first").parent().parent().find(".flags-medium:last"),0<a.length&&$("#muOrder").html("<a target='_blank' href='"+b.attr("href")+"'>"+b.text()+"</a> , for <div class='"+a.attr("class").replace(/medium/g,"small")+"'></div> side.")):
(a=$(a).find(".battleDiv:first").parent().parent().find("> img:last"),0<a.length&&$("#muOrder").html("<a target='_blank' href='"+b.attr("href")+"'>"+b.text()+"</a> , for <img class='flags-small' src='"+a.attr("src")+"' style='width:21px;height:16px;'> side.")):($("#muOrder").html("None."),$("#muBonus").attr("checked",!1))},error:function(b,c,d){$("#muOrder").html("Failed, wait 2 sec to try again...");console.log("!Error - errorThrown:"+d+"; jqXHR:"+b);setTimeout(function(){$("#muOrder").html("Loading...");
f(a)},2E3)}})}function b(){var a=parseFloat($("#weaponQ").val());2==$("#buildingType").val()&&(a*=1+0.05*parseInt($("#buildingQ").val()));$("#steroidBonus").is(":checked")?a*=1.2:$("#steroidDebuff").is(":checked")&&(a*=0.8);$("#tankBonus").is(":checked")&&(a*=1.2);$("#swrbunkBonus").is(":checked")?a*=1.25:$("#swrbunkDebuff").is(":checked")&&(a*=0.8);$("#muBonus").is(":checked")&&(a*=e);$("#regionBonus").is(":checked")&&(a*=1.2);$("#surroundDebuff").is(":checked")&&(a*=0.8);var a=a*(1+l),b=Math.round(q*
a*5),a=Math.round(r*a*5);$("#estBerserkMin").html(g(b));$("#estBerserkMax").html(g(a));var b=(b+a)/10,a=parseFloat($("#healthNum").val()),a=a+50*parseInt($("#foodNum").val()),a=a+50*parseInt($("#giftNum").val()),c=10;3==$("#buildingType").val()&&(c-=0.5*parseInt($("#buildingQ").val()));a=Math.floor(a/c);a=a*(1-m)/(1-n);h=a*b;$("#estTimes").html(Math.round(a));$("#estTotal").html(g(Math.round(h)));$("#percentage").html(Math.round(100*k/h))}function c(a){$(a).parent().css("background-color","rgb(219, 219, 219)");
$(a).parent().css("border","1px solid rgba(0, 0, 0, 0.7)");$(a).parent().css("box-shadow","0 0 5px rgba(0, 0, 0, 0.5), 0 -12px 12px rgba(144, 169, 1156, 0.2) inset");$(a).parent().css("webkit-box-shadow","0 0 5px rgba(0, 0, 0, 0.5), 0 -12px 12px rgba(144, 169, 1156, 0.2) inset")}function d(a){$(a).parent().removeAttr("style");$(a).parent().attr("style","width:100%;")}function g(a){a=(a+"").split(".");return a[0].replace(/(\d{1,3})(?=(\d{3})+$)/g,"$1,")+(2==a.length?"."+a[1]:"")}$.fn.exists=function(){return 0!==
this.length};$("#profileEquipment").parent().css({height:"390px"}).append(' <div id="dmgCalc" class="testDivwhite" style="height: 160px; width: 480px;"> <table style="font-size:12px"> <tr> <td> <table style="width:100%"> <tr> <td> <b>Weapon:</b> </td> <td> <b>Region Building:</b> </td> <td> <b>Food:</b> </td> <td> <b>Gift:</b> </td> <td> <b>Health:</b> </td> </tr> <tr> <td> <select id="weaponQ" style="height:18px; padding:2px; font-size:12px"> <option value="0.5">None</option> <option value="1.2" selected="selected">Q1</option> <option value="1.4">Q2</option> <option value="1.6">Q3</option> <option value="1.8">Q4</option> <option value="2.0">Q5</option> </select> </td> <td><select id="buildingType" style="height:18px; padding:2px; font-size:12px"> <option value="1">None</option> <option value="2">DS</option> <option value="3">Hosp.</option> </select> <select id="buildingQ" style="height:18px; padding:2px; font-size:12px"> <option value="0"></option> <option value="1">Q1</option> <option value="2">Q2</option> <option value="3">Q3</option> <option value="4">Q4</option> <option value="5">Q5</option> </select> </td> <td><input type="number" min="0" id="foodNum" value="15" style="position:relative; height:18px; top:-5px; max-width:36px; padding:2px; font-size:12px"> </td> <td><input type="number" min="0" id="giftNum" value="15" style="position:relative; height:18px; top:-5px; max-width:36px; padding:2px; font-size:12px"> </td> <td><input type="number" min="0" max="100" step="10" id="healthNum" value="100" style="position:relative; height:18px; top:-5px; max-width:40px; padding:2px; font-size:12px"> </td> </tr> </table> <table style="white-space:nowrap; width:100%"> <tr> <td><div class="statsLabel smallStatsLabel greenLabel" style="width:100%" title="Bunker / Sewer guide Buff"> <b>Core:</b> <input type="checkbox" id="swrbunkBonus" value="1.25"> </div> </td> <td><div class="statsLabel smallStatsLabel greenLabel" style="width:100%" title="Tank Buff"> <b>Tank:</b> <input type="checkbox" id="tankBonus" value="1.2"> </div> </td> <td><div class="statsLabel smallStatsLabel greenLabel" style="width:100%" title="Steroid Buff"><b>Steroid:</b> <input type="checkbox" id="steroidBonus" value="1.2"> </div> </td> <td><div class="statsLabel smallStatsLabel greenLabel" style="width:100%" title="Location region Buff"> <b>Region:</b> <input type="checkbox" id="regionBonus" value="1.2" checked="checked"> </div> </td> <td><div class="statsLabel smallStatsLabel greenLabel" style="width:100%" title="Military unit order Buff"> <b>MU:</b> <input type="checkbox" id="muBonus" value="1" checked="checked"> </div> </td> </tr> <tr> <td><div class="statsLabel smallStatsLabel redLabel" style="width:100%" title="Bunker / Sewer guide Debuff"> <b>Core:</b> <input type="checkbox" id="swrbunkDebuff" value="0.8"> </div> </td> <td><div class="statsLabel smallStatsLabel redLabel" style="width:100%" title="Tank Debuff"> <b>Tank:</b> <input type="checkbox" id="tankDebuff" value="1"> </div> </td> <td><div class="statsLabel smallStatsLabel redLabel" style="width:100%" title="Steroid Debuff"> <b>Steroid:</b> <input type="checkbox" id="steroidDebuff" value="0.8"> </div> </td> <td colspan="2"><div class="statsLabel smallStatsLabel redLabel" style="width:100%" title="Surrounded Debuff - If no route to core regions."> <b>Surrounded:</b> <input type="checkbox" id="surroundDebuff" value="0.8"> </div> </td> </tr> </table><table style="margin:5px auto; width:100%"> <tr> <td align="center" style="width:70px"> <b>MU Order:</b> </td> <td> <div id="muOrder" style="display:inline-block; position:relative; margin:0px auto">Loading...</div> </td> </tr> </table></td> <td> <div> <b>Est. Berserk</b> <br> <div class="help equipmentBlueBox" style="position:relative; width:106px"> <b id="estBerserkMin">0</b> / <b id="estBerserkMax">0</b></div> </div> <div> <b>Est. DMG.</b> (<b id="estTimes">0</b><img style="width:13px; height:13px;" src="http://e-sim.home.pl/testura/img/productIcons/Weapon.png">) <br> <div class="help equipmentBlueBox" style="position:relative; width:106px"> <b id="estTotal">0</b> </div> </div> <div> <b>Today DMG.</b> (<b id="percentage">0</b>%) <br> <div class="help equipmentBlueBox" style="position:relative; width:106px"> <b id="dmgToday">0</b> </div> </div> </td> </tr> </table> </div> ');
var k=0,h=1,q=parseInt($("#hitHelp b:first").text().replace(",","")),r=parseInt($("#hitHelp b:last").text().replace(",","")),l=$("#criticalHelp .equipmentStats:first").text(),l=parseFloat(l.replace("%",""))/100,m=$("#missHelp .equipmentStats:first").text(),m=parseFloat(m.replace("%",""))/100,n=$("#avoidHelp .equipmentStats:first").text(),n=parseFloat(n.replace("%",""))/100;$.getJSON("apiCitizenById.html?id="+function(){var a={};window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(b,c,d){a[c]=
d});return a}().id).done(function(a){k=a.damageToday;$("#dmgToday").html(g(k));$("#percentage").html(Math.round(100*k/h));b()});var e=1.2;if($('.testDivblue > a[href^="militaryUnit.html?id="]').exists()){var p=$('.testDivblue > a[href^="militaryUnit.html?id="]:first').attr("href").split("?id=").pop();$.getJSON("apiMilitaryUnitById.html?id="+p).done(function(a){switch(a.militaryUnitType){case "Novice":e=1.05;break;case "Regular":e=1.1;break;case "Veteran":e=1.15;break;case "Elite":e=1.2}b()});setTimeout(function(){f(p)},
200)}else $("#muOrder").html("No military unit."),$("#muBonus").attr("checked",!1),e=1;(function(){c("#tankBonus");$("#tankBonus").prop("disabled",!0);$("#buildingQ").prop("disabled",!0);for(var a=$(".testDivblue:has('.bigAvatar') .smallhelp"),e=0;e<a.length;e++)switch(a.eq(e).attr("src").match(/(steroids|tank|spa|vacations|bunker|resistance)\_(positive|negative)/ig)[0]){case "vacations_positive":$("#foodNum").val("25");break;case "vacations_negative":$("#foodNum").val("0");break;case "spa_positive":$("#giftNum").val("25");
break;case "spa_negative":$("#giftNum").val("0");break;case "steroids_positive":d("#steroidBonus");$("#steroidBonus").prop("disabled",!1);$("#steroidBonus").attr("checked",!0);c("#steroidDebuff");$("#steroidDebuff").prop("disabled",!0);$("#steroidDebuff").attr("checked",!1);break;case "steroids_negative":d("#steroidDebuff");$("#steroidDebuff").prop("disabled",!1);$("#steroidDebuff").attr("checked",!0);c("#steroidBonus");$("#steroidBonus").prop("disabled",!0);$("#steroidBonus").attr("checked",!1);
break;case "tank_positive":c("#tankDebuff");$("#tankDebuff").prop("disabled",!0);$("#tankDebuff").attr("checked",!1);d("#tankBonus");$("#tankBonus").prop("disabled",!1);$("#tankBonus").attr("checked",!0);$("#weaponQ").val("2.0");break;case "tank_negative":d("#tankDebuff");$("#tankDebuff").prop("disabled",!1);$("#tankDebuff").attr("checked",!0);c("#tankBonus");$("#tankBonus").prop("disabled",!0);$("#weaponQ").prop("disabled",!0);$("#weaponQ").val("0.5");break;case "bunker_positive":case "resistance_positive":$("#swrbunkDebuff").is(":checked")?
($("#swrbunkDebuff").attr("checked",!1),d("#swrbunkBonus"),$("#swrbunkBonus").prop("disabled",!1)):($("#swrbunkBonus").attr("checked",!0),c("#swrbunkDebuff"),$("#swrbunkDebuff").prop("disabled",!0),c("#surroundDebuff"),$("#surroundDebuff").prop("disabled",!0));break;case "bunker_negative":case "resistance_negative":$("#swrbunkBonus").is(":checked")?($("#swrbunkBonus").attr("checked",!1),d("#swrbunkDebuff"),$("#swrbunkDebuff").prop("disabled",!1),d("#surroundDebuff"),$("#surroundDebuff").prop("disabled",
!1)):($("#swrbunkDebuff").attr("checked",!0),c("#swrbunkBonus"),$("#swrbunkBonus").prop("disabled",!0))}b()})();$("#weaponQ").change(function(){2!=$("#weaponQ").val()?(c("#tankBonus"),$("#tankBonus").prop("disabled",!0),$("#tankBonus").is(":checked")&&($("#tankBonus").attr("checked",!1),d("#tankDebuff"),$("#tankDebuff").prop("disabled",!1))):(d("#tankBonus"),$("#tankBonus").prop("disabled",!1));b()});$("#buildingType").change(function(){1==$("#buildingType").val()?($("#buildingQ").prop("disabled",
!0),$("#buildingQ").val("0")):$("#buildingQ").prop("disabled",!1);b()});$("#buildingQ").change(function(){b()});$("#foodNum").change(function(){0>parseInt($("#foodNum").val())&&$("#foodNum").val("0");b()});$("#giftNum").change(function(){0>parseInt($("#giftNum").val())&&$("#giftNum").val("0");b()});$("#healthNum").change(function(){0>parseFloat($("#healthNum").val())?$("#healthNum").val("0.0"):100<parseFloat($("#healthNum").val())&&$("#healthNum").val("100.0");b()});$("#regionBonus").change(function(){b()});
$("#muBonus").change(function(){b()});$("#swrbunkBonus").change(function(){$("#swrbunkBonus").is(":checked")?(c("#swrbunkDebuff"),$("#swrbunkDebuff").prop("disabled",!0),c("#surroundDebuff"),$("#surroundDebuff").prop("disabled",!0)):(d("#swrbunkDebuff"),$("#swrbunkDebuff").prop("disabled",!1),d("#surroundDebuff"),$("#surroundDebuff").prop("disabled",!1));b()});$("#tankBonus").change(function(){$("#tankBonus").is(":checked")?(c("#tankDebuff"),$("#tankDebuff").prop("disabled",!0)):(d("#tankDebuff"),
$("#tankDebuff").prop("disabled",!1));b()});$("#steroidBonus").change(function(){$("#steroidBonus").is(":checked")?(c("#steroidDebuff"),$("#steroidDebuff").prop("disabled",!0)):(d("#steroidDebuff"),$("#steroidDebuff").prop("disabled",!1));b()});$("#surroundDebuff").change(function(){$("#surroundDebuff").is(":checked")?(c("#swrbunkBonus"),$("#swrbunkBonus").prop("disabled",!0)):$("#swrbunkDebuff").is(":checked")||(d("#swrbunkBonus"),$("#swrbunkBonus").prop("disabled",!1));b()});$("#swrbunkDebuff").change(function(){$("#swrbunkDebuff").is(":checked")?
(c("#swrbunkBonus"),$("#swrbunkBonus").prop("disabled",!0)):$("#surroundDebuff").is(":checked")||(d("#swrbunkBonus"),$("#swrbunkBonus").prop("disabled",!1));b()});$("#tankDebuff").change(function(){$("#tankDebuff").is(":checked")?(c("#tankBonus"),$("#weaponQ").prop("disabled",!0),$("#tankBonus").prop("disabled",!0),$("#weaponQ").val("0.5")):$("#weaponQ").prop("disabled",!1);b()});$("#steroidDebuff").change(function(){$("#steroidDebuff").is(":checked")?(c("#steroidBonus"),$("#steroidBonus").prop("disabled",
!0)):(d("#steroidBonus"),$("#steroidBonus").prop("disabled",!1));b()})}addJQuery(main);

