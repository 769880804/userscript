// ==UserScript==
// @name            The West - Common tools [SOM]
// @description     The West - Common tools for SOM scripts [SOM - Scripts-O-Maniacs]
// @namespace       http://scripts-o-maniacs.leforum.eu/
// @author          Danosaure
// @release         Danosaure
// @include         http://*.the-west.*/game.php*
// @include         http://userscripts.org/scripts/review/120825*
// @include         http://userscripts.org/scripts/source/120825.meta.js*
// @version         1.12
// @copyright       2011, Danosaure (http://scripts-o-maniacs.leforum.eu/)
// @website         http://scripts-o-maniacs.leforum.eu
//
// @history         1.12|2012.05.15     Added compability with server 1.36.
// @history         1.12|2012.05.15     Corrected history display.
// @history         1.11|2012.04.08     Display same version history logs.
// @history         1.10|2012.03.24     jQuery-fied update window.
// @history         1.10|2012.03.11     Code review for expansion. May require to reinstall other SOM scripts using this script.
// @history         1.0.5|2011.12.23    Fix pour l'iframe.
// @history         1.0.4|2011.12.20    Modifications for include testing to avoid error.
// @history         1.0.3|2011.12.19    Modified to look like the one in TWPro+.
// @history         1.0.2|2011.12.19    Cleaning up iframe.
// @history         1.0.1|2011.12.19    First functional version.
// @history         1.0.0|2011.12.18    Created
// ==/UserScript==

if((window.location.href.indexOf(".the-west.")!=-1)&&(window.location.href.indexOf("game.php")!=-1)){(function(b){var c=document;var a=c.createElement("script");a.type="application/javascript";a.textContent="("+b.toString()+")()";(c.body||c.head||c.documentElement).appendChild(a);a.parentNode.removeChild(a);})(function(){if(undefined!==window.SOM){new HumanMessage("CommonTools: Loading conflict. Disable other versions of this script.");return;}window.SOM=new Object();if(undefined===String._repeat){String.prototype._repeat=function(a){return new Array(isNaN(a)?1:++a).join(this);};}if(undefined===String._format){String.prototype._format=function(){var a=arguments;return this.replace(/\{\d+\}/g,function(b){return a[b.match(/\d+/)];});};}if(undefined===String._join){String.prototype._join=function(a){return a.join(this);};}if(undefined===String._startswith){String.prototype._startswith=function(a){return(this.substr(0,a.length)==a);};}if(undefined===String._endswith){String.prototype._endswith=function(a){return(this.substr(-a.length)==a);};}SOM.NB_HISTORY=1;SOM.DELTA_MAJ=24*60*60;SOM.USO_URL="http://userscripts.org";SOM.getObject=function(a,d){var b=localStorage.getItem(a);if(b==null){return d;}if((b[0]=="{")&&(b[b.length-1]=="}")){try{return JSON.parse(b);}catch(c){return b;}}return b;};SOM.setObject=function(a,b){if(typeof(b)=="object"){b=JSON.stringify(b);}localStorage.setItem(a,b);};SOM.delObject=function(a){return localStorage.removeItem(a);};SOM.jqElement=function(a,c){var b=jQuery("<"+a+">");if(c){c.append(b);}return b;};SOM.createElement=function(a,c){var b;if(typeof(a)=="string"){b=document.createElement(a);if(undefined!==c){c.appendChild(b);}}else{b=document.createElement(c);if(undefined!==a){a.appendChild(b);}}return b;};SOM.createTextNode=function(c,b){var a;if(typeof(c)=="string"){a=document.createTextNode(c);if(undefined!==b){b.appendChild(a);}}else{a=document.createTextNode(b);if(undefined!==c){c.appendChild(a);}}return a;};SOM.popup=function(a,b){a.get(0).addMousePopup(new MousePopup("<b>"+b+"</b>"));};if(undefined!==SOM.Tools){new HumanMessage("Conflict loading. Disable other versions of this script.",{type:"error"});return;}SOM.Tools=new Object();SOM.Tools.is_safari=((navigator.userAgent.toLowerCase().indexOf("chrome")==-1)&&(navigator.userAgent.toLowerCase().indexOf("safari")!=-1));SOM.Script=function(d,b,a,c){this.identifiant=d;this.VERSION=b;this.NUMERO_SCRIPT=a;this.auteur=c;this.compteur=1;this.registered=false;this.interval=null;this.checked=false;this.uso_version=null;this.uso_release=null;this.uso_history=null;};SOM.Script.prototype.toString=function(){return"<Script {0} "._format(this.identifiant)+"v{0} "._format(this.VERSION)+"({0}) "._format(this.NUMERO_SCRIPT)+"compteur={0} "._format(this.compteur)+"registered={0} "._format(this.registered)+"checked={0} "._format(this.checked)+">";};SOM.Script.prototype.maj=function(){clearInterval(SOM.Tools.CACHE.interval_maj_suite);var a="{0}/scripts/source/{1}.meta.js"._format(SOM.USO_URL,this.NUMERO_SCRIPT);if(SOM.Tools.is_safari){a="{0}/scripts/review/{1}"._format(SOM.USO_URL,this.NUMERO_SCRIPT);}var b=SOM.jqElement("iframe",jQuery(document.body)).attr("id","som_{0}_maj"._format(this.NUMERO_SCRIPT)).attr("src",a).css({display:"none"});window.addEventListener("message",this.maj_suite(this,b));};SOM.Script.prototype.maj_suite=function(b,a){return function(d){if(d.origin!=SOM.USO_URL){return;}var f=unescape(d.data);if(f.match(/\/\/ @uso:script\s+(\d+)/)[1]!=b.NUMERO_SCRIPT){return;}a.remove();b.checked=true;b.uso_version=f.match(/\/\/ @version\s+(.*)/)[1];if(b.uso_version!=b.VERSION){b.uso_release=f.match(/\/\/ @release\s+(.*)/);if(b.uso_release!==null){b.uso_release=b.uso_release[1];}b.uso_history=f.match(/\/\/ @history\s+(.*)/g);}};};SOM.D=Object();SOM.D.actif=false;SOM.D.i=0;SOM.D.w=function(d,a){if(!SOM.D.actif){return null;}if(undefined===d){d="";}var c="    "._repeat(SOM.D.i);var b="{0}| {1}";if(a){b="{0}{1}";}console.log(b._format(c,"\n{0}| "._format(c)._join(d.split("\n"))));return null;};SOM.D.indent=function(a){SOM.D.w("--\\ {0}"._format((undefined===a)?"":a),true);SOM.D.i+=1;};SOM.D.unindent=function(a){SOM.D.i=Math.max(SOM.D.i-1,0);SOM.D.w("--/ {0}"._format((undefined===a)?"":a),true);};SOM.Tools.CACHE=new Array();SOM.Tools.verifier_maj=function(){clearInterval(SOM.Tools.CACHE.interval_maj);for(var b in SOM.Tools.CACHE){if(b._startswith("TheWest")&&b._endswith("[SOM]")){var a=SOM.Tools.CACHE[b];a.maj();}}SOM.Tools.CACHE.interval_maj_suite=setInterval(SOM.Tools.verifier_maj_suite,5000);};SOM.Tools.verifier_maj_suite=function(){clearInterval(SOM.Tools.CACHE.interval_maj_suite);SOM.setObject("SOM_MAJ",new Date().getTime()/1000);var h=function(n,o,q,m){var p=arguments.callee;return function(v){var t,z;var A=0;var y=null;var w,s,r,u,x;for(t=m;((t<q.length)&&(A<=SOM.NB_HISTORY));t++){z=q[t].match(/\/\/ @history\s+(.*)/)[1];ligne_info=z.match(/^([a-zA-Z0-9.\-\|\/]*)\s(.*)/);info_hist=ligne_info[1].split("|");if(info_hist[0]==y){x=SOM.jqElement("li",u).css({fontSize:"10px"}).text(ligne_info[2]);}else{if(A==SOM.NB_HISTORY){break;}y=info_hist[0];A++;w=SOM.jqElement("tr",n);s=SOM.jqElement("td",w).attr("colspan","3").css({border:"1px solid #666",fontSize:"12px",verticalAlign:"top"});r=SOM.jqElement("b",s).css({marginLeft:"5px"}).text(info_hist[0]);if(2<=info_hist.length){r=SOM.jqElement("span",s).css({cssFloat:"right",fontSize:"10px",fontStyle:"italic",marginRight:"5px"}).text(info_hist[1]);}SOM.jqElement("br",s);u=SOM.jqElement("ul",s).css({marginBottom:"5px"});x=SOM.jqElement("li",u).css({fontSize:"10px"}).text(ligne_info[2]);}}if(t<q.length){o.click(p(n,o,q,t)).text("[+"+Math.min(SOM.NB_HISTORY,q.length-t)+"]");}else{o.hide();}};};var j=SOM.jqElement("div");var l=SOM.jqElement("table",j).css({width:"100%"});var c=true;var f=true;var e,i,k,g,b,d;for(var a in SOM.Tools.CACHE){if(a._startswith("TheWest")&&a._endswith("[SOM]")){e=SOM.Tools.CACHE[a];if(!e.checked){return;}if(e.VERSION==e.uso_version){continue;}f=false;if(!c){i=SOM.jqElement("tbody",l);k=SOM.jqElement("tr",i);g=SOM.jqElement("td",k).attr("colspan","3");SOM.jqElement("hr",g);}c=false;i=SOM.jqElement("tbody",l);k=SOM.jqElement("tr",i);g=SOM.jqElement("td",k).attr("colspan","3").css({fontWeight:"bold"}).text(a);k=SOM.jqElement("tr",i);g=SOM.jqElement("td",k).css({fontSize:"9px"}).text("Installed: {0}"._format(e.VERSION));g=SOM.jqElement("td",k).css({fontSize:"9px"}).text("Available: {0}"._format(e.uso_version));g=SOM.jqElement("td",k);b=SOM.jqElement("span");h(i,b,e.uso_history,0)();k=SOM.jqElement("tr",i);g=SOM.jqElement("td",k).css({fontSize:"9px"});b=SOM.jqElement("a",g).attr("target","_blank").attr("href","{0}/scripts/show/{1}"._format(SOM.USO_URL,e.NUMERO_SCRIPT)).text("Web page");g=SOM.jqElement("td",k).css({fontSize:"9px"}).text("Author: {0}"._format(e.auteur));g=SOM.jqElement("td",k);if(SOM.Tools.is_safari){d="{0}/scripts/show/{1}"._format(SOM.USO_URL,e.NUMERO_SCRIPT);}else{d="{0}/scripts/source/{1}.user.js"._format(SOM.USO_URL,e.NUMERO_SCRIPT);}SOM.jqElement("a",g).attr("target","_blank").attr("href",d).text("Install");}}if(!f){showMessage(j.get(0),'[<a href="http://scripts-o-maniacs.leforum.eu" target="_blank">SOM</a>] Updater',500,undefined,[["OK"]]);}};SOM.Tools.enregistrer=function(a,d,e,f){a="TheWest-"+a+" [SOM]";clearInterval(SOM.Tools.CACHE.interval_maj);var i=new Date().getTime()/1000;var b=SOM.getObject("SOM_MAJ");SOM.D.w("next_maj={0}"._format(b));if((undefined===b)||((parseFloat(b)+SOM.DELTA_MAJ)<=i)){SOM.Tools.CACHE.interval_maj=setInterval(SOM.Tools.verifier_maj,2000);}var c="{0}/scripts/show/{1}"._format(SOM.USO_URL,e);var g=function(){var k=SOM.Tools.CACHE[a];k.compteur+=1;if(k.compteur>5){clearInterval(k.interval);}else{if((undefined===window.TheWestApi)||(undefined===TheWestApi.version)){return;}else{var j=TheWestApi.register(a,a,"1.34","1.36",f,c);if(j){clearInterval(k.interval);k.registered=true;}else{new HumanMessage("{0} not registered."._format(a),{type:"error"});}}}};var h=SOM.Tools.CACHE[a];if(undefined===h){h=new SOM.Script(a,d,e,f);SOM.Tools.CACHE[a]=h;h.interval=setInterval(g,2000);return h;}else{new HumanMessage(a+": Loading conflict. Disable other version of this script.");return null;}};SOM.Tools.enregistrer("CommonTools","1.12","120825","Danosaure");});}else{(function(b){var c=document;var a=c.createElement("script");a.type="application/javascript";a.textContent="("+b.toString()+")()";(c.body||c.head||c.documentElement).appendChild(a);a.parentNode.removeChild(a);})(function(){if(window.parent.postMessage){window.parent.postMessage("120825"+String(escape(document.body.textContent)),"*");}});}