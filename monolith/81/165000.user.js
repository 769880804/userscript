// ==UserScript==
// @name           Hogs of Destiny presents UpUp.us Price Gun
// @namespace      http://hogsofdestiny.com/kol/pricegun/
// @description    Calculates the value of your inventory, closet, store, display case and ancestral storage.
// @include        http://*kingdomofloathing.com/charsheet.php*
// @include        http://*kingdomofloathing.com/account.php*
// @include        http://*kingdomofloathing.com/mallstore.php*
// @include        http://*kingdomofloathing.com/displaycollection.php*
// @include        http://*kingdomofloathing.com/clan_stash.php*
// @include        http://127.0.0.1:*/charsheet.php*
// @include        http://127.0.0.1:*/account.php*
// @include        http://127.0.0.1:*/mallstore.php*
// @include        http://127.0.0.1:*/displaycollection.php*
// @include        http://127.0.0.1:*/clan_stash.php*
// @resource       newDoc http://img136.imageshack.us/img136/1412/newdoc.png
// @require        http://jqueryjs.googlecode.com/files/jquery-1.3.2.min.js
// @require        http://jqueryjs.googlecode.com/svn-history/r5844/trunk/plugins/tablesorter/2.0/jquery.tablesorter.min.js
// ==/UserScript==

/* 
credits - 
Mall prices generated by custom python backend script: http://sites.google.com/site/pricegunrepository/files/pricegun.zip
Other price lists made available by Adiamante: http://forums.kingdomofloathing.com/vb/showthread.php?t=176197
Old Item database pulled from Max Demian's Item Database: http://max.subfighter.com/kol/texts/itemdb.txt
New item database pulled from KOLMafia's SVN: http://kolmafia.sourceforge.net/
Tab code from A List Apart's Sliding Doors of CSS: http://alistapart.com/articles/slidingdoors/
Leader line stuff from http://www.fu2k.org/alex/css/test/DotLeader.mhtml
Table sorting code from http://www.joostdevalk.nl/code/sortable-table/
Misc. fixes and skill/familiar/consumption code added by Aetheri
Additional fixes by Eyeber
*/

var currentVersion = parseFloat(GM_getValue('currentVersion', "0.70"));

//define variables
var isFirstRun = GM_getValue('isFirstRun', true);
var maxTableHeight = 400;

var prices = {};
var items = {};
var familiars = {};
var useFamiliars = GM_getValue('useFamiliars',false);
var skills = {};
var useSkills = GM_getValue('useSkills',false);
var useConsumption = GM_getValue('useConsumption',false);
var inProgress = false;
var readoutWindow;

var bigCss, smallCss;
var JQCss;

var ssheet = document.styleSheets[document.styleSheets.length - 1];
//TODO: remove for final build
if(isFirstRun){
	GM_get('hogsofdestiny.com/kol/pricegun/bigReadout.css',
		function(response){bigCss = response;
				GM_setValue('bigCss', bigCss);});
	GM_get('hogsofdestiny.com/kol/pricegun/smallReadoutNew.css',
		function(response){smallCss = response;
				GM_setValue('smallCss', smallCss);});
	GM_get('hogsofdestiny.com/kol/pricegun/jquery-ui-1.7.2.custom.css',
		function(response){JQCss = response;
				GM_setValue('JQCss', JQCss);});

	GM_setValue('isFirstRun', false);
}
else{
	bigCss = GM_getValue('bigCss', '');
	smallCss = GM_getValue('smallCss', '');
	JQCss = GM_getValue('JQCss', '');
}


//define functions
var generateValueWindow, getCharacterData, doCloset, doFamiliars, doHagnks, doConsumption, doDC, doOtherSkills, doStore;
var generateNewGroups, newCheck, generateReadout, fillTableBody, sortByColumn;
var createDocWin, createTotalDocWin, getParent, rowStripe, statusMessage, getItemList, unstoreItemList;
var getVersion, getSkills, getFamiliars, getPriceList, getOtherPriceList, unstorePriceList;
var sortbyTotal, comparisonGenerator, swap, parseFromForm, parseFromInventory, addCommas, toggle, GM_get, isEmpty, merge, setParser;
var getDescNum, initTablesorter;


/*
 * Main body of the script
 */

switch(document.location.pathname) {
	case "/account.php":
	
	/* ------------
			preferences
	   ------------ */

		(function(){
		 	// load image data
			var pixel = "data:image/gif;base64,R0lGODlhAQABAID%2FAMDAwAAAACH5BAEAAAAALAAAAAABAAEAQAICRAEAOw%3D%3D";
			var loadingGraphic = "data:image/gif;base64,R0lGODlhEgASAJECAMDAwNvb2%2F%2F%2F%2FwAAACH%2FC05FVFNDQVBFMi4wAwEAAAAh%2BQQFCgACACwAAAAAEgASAAACMpSPqQmw39o7IYjo6qpacpt8iKhoITiiG0qWnNGepjCv7u3WMfxqO0%2FrqVa1CdCIRBQAACH5BAUKAAIALAcAAQAIAAYAAAIOVCKZd2osAFhISmcnngUAIfkEBQoAAgAsCwADAAYACAAAAg5UInmnm4ZeAuBROq%2BtBQAh%2BQQFCgACACwLAAcABgAIAAACD5QTJojH2gQAak5jKdaiAAAh%2BQQFCgACACwHAAsACAAGAAACDpQdcZgKIFp4Lzq6RF0FACH5BAUKAAIALAMACwAIAAYAAAIOFCCZd2osQlhISmcnngUAIfkEBQoAAgAsAQAHAAYACAAAAg4UIHmnm4ZeCuFROq%2BtBQAh%2BQQFCgACACwBAAMABgAIAAACD5QBJojH2kQIak5jKdaiAAA7";
			var checkGraphic = "data:image/gif;base64,R0lGODlhEgASAJEDAMjIyH19fQcHB%2F%2F%2F%2FyH5BAEAAAMALAAAAAASABIAAAI5nI%2BJMuwNH1M0zWoxAmFp3kHaEJQeGR5lABgXmq7tCXbyedTlnOV3n%2BDwFC%2FDEDcCJotJV%2BQpaRQAADs%3D";
			//create 'links' to update price and item lists
			var updatePricesProgress = $("<img src='" + pixel +
							"' style='margin-left:5px; vertical-align:middle' width='18' height='18'></img>");
			var updatePrices = $("<input title='No reason to run more than once in 24 hours' class='button' type='button'" +
							"value='Update Item Prices' style='width:12em'></input>")
				.click(function(evt) {
					if(inProgress === undefined || inProgress === false) {
						inProgress = true;
						getPriceList(function done() {
							inProgress = false;
							updatePricesProgress.attr('src', checkGraphic);
						});
						updatePricesProgress.attr('src', loadingGraphic);
					}
					evt.preventDefault();
				});


			var updateItemsProgress = $("<img src='" + pixel +
							"' style='margin-left:5px; vertical-align:middle' width='18' height='18'></img>");
			var updateItems = $("<input title='No reason to run more than once in 24 hours' class='button' type='button'" +
							"value='Update Item List' style='width:12em'></input>")
				.click(function(evt) {
					if(inProgress === undefined || inProgress === false) {
						inProgress = true;
						getItemList(function done() {
							inProgress = false;
							updateItemsProgress.attr('src', checkGraphic);
						});
						updateItemsProgress.attr('src', loadingGraphic);
					}
					evt.preventDefault();
				});


			//create form for updating item and price lists
			var updateForm = $("<form style='display: none; line-height: 1em'></form>")
					.append(updatePrices)
					.append(updatePricesProgress)
					.append("<br><br>")
					.append(updateItems)
					.append(updateItemsProgress)

			//create form for updating script location
			var updateLocation = $("<input style='display:none' type='text' size='61' value='" + 
				GM_getValue('dataLocation',"http://hogsofdestiny.com/kol/pricegun/dailyprice.log") + "'></input>");

			var updateLocationButton = $("<input class='button' style='display:none' type='button' value='Change Location'></input>")
				.click(function(evt){
					GM_setValue('dataLocation', updateLocation.attr('value'));
				});

			//create dropdown to change location between presets
			var presetLocations = {"HoD Hosted" : "http://hogsofdestiny.com/kol/pricegun/dailyprice.log",
				"(defunct) LogiKoL: Coldfront" : "numero.logikol.com/coldfront.txt",
				"(defunct) LogiKoL: The Items of Loathing" : "numero.logikol.com/iol.txt",
				"(defunct) LogiKoL: KoLmafia" : "numero.logikol.com/mafia.txt",
				"(defunct) LogiKoL: Lo Mein" : "numero.logikol.com/lomein.txt",
				"(defunct) LogiKoL: Hi Mein" : "numero.logikol.com/himein.txt"};
			var locationSelector = $("<select style='display:none'><option value='none'>Choose a location or enter one manually</option></select>");
			for(var loc in presetLocations){
				if(presetLocations.hasOwnProperty(loc)){
					locationSelector.append("<option value='" + presetLocations[loc] + "'>" + loc + "</option>");
				}	
			}
			locationSelector.bind('change',
				function(evt){
					var newValue = this.options[this.selectedIndex].value;
					updateLocation.attr('value', (newValue == 'none') ? updateLocation.attr('value') : newValue);
			});
	
			//create main wrapper form
			var main_wrapper = $("<div class='indent'></div>")
				//create form, and button to toggle it
				.append($("<div style='cursor:pointer; text-decoration:underline' class='opt'>Update item information</div>")
					.click(function(){
						toggle(updateForm);
					}))
				.append(updateForm)
				//create 'link' to toggle location input
				.append($("<div style='cursor:pointer; text-decoration:underline' class='opt'>Change location of price list</div>")
					.click(function(){
						toggle(updateLocation);
						toggle(updateLocationButton);
						toggle(locationSelector);
					}))
				.append(updateLocation)
				.append(locationSelector)
				.append(updateLocationButton)
				// Create checkboxes and accompanying text for optional items (skills, familiars, consumption)
				.append($("<div class='opt'>Count familiars in terrarium towards total meat.</div>")
					.prepend($("<input type='checkbox' " + (useFamiliars ? "checked='checked'" : "") + "'></input>")
								.click(function(){
									useFamiliars = !useFamiliars;
									GM_setValue('useFamiliars', useFamiliars);
								})))
				.append($("<div class='opt'>Count skills gained from items towards total meat.</div>")
					.prepend($("<input type='checkbox' " + (useSkills ? "checked='checked'" : "") + "'></input>")
								.click(function(){
									useSkills = !useSkills;
									GM_setValue('useSkills', useSkills);
								})))
				.append($("<div class='opt'>Count food and drink consumed towards total meat.</div>")
					.prepend($("<input type='checkbox' " + (useConsumption ? "checked='checked'" : "") + "'></input>")
								.click(function(){
									useConsumption = !useConsumption;
									GM_setValue('useConsumption', useConsumption);
								})))
				.appendTo($("<div><div class='subhead'>Price Gun:</div><p></div>")).parent();
			if($("#scripts").length){
				$("#scripts > a").click(function (e){
					e.stopPropagation();
					$("#guts").append(main_wrapper);
				});
			}
			else{
				$("<li id='scripts'><a href='#'><img src='http://images.kingdomofloathing.com/itemimages/cmonkey1.gif'" + 
				  "align='absmiddle' border='0' style='padding-right:10px' />Scripts</a></li>")	
					.appendTo($("ul"));
				$("#scripts > a").click(function (e){
					e.stopPropagation();
					$("#tabs li").removeClass("active");
					$("#scripts").addClass("active");
					$("#guts").html("<div class='scaffold'></div>")
						.append(main_wrapper);
				});
			}
		})();
		break;
	case "/charsheet.php":
	
	/* ------------
			Character Sheet
	   ------------ */
	
		var list = {'inventory' : [], 'store' : [], 'closet' : [], 'hagnks' : [], 'dc' : [],
					'familiar' : [], 'skill' : [], 'consumption' : []};	
		var totalMeat = {'inventory' : 0, 'store' : 0, 'closet' : 0, 'hagnks' : 0, 'dc' : 0,
					'familiar' : 0, 'skill' : 0, 'consumption' : 0};	
		var activetab = 0;
		
		var playerName = $('a:first').text();
		var target = $('td tr td tr:contains("Meat:")');
		var newRow = target.clone();
		$("b", newRow).text(addCommas(GM_getValue('totalValue_'+playerName,'uncalculated'))).addClass('statusLocation');
		$("td:first", newRow).text("").append($("<span title='Click to run value check' style='cursor:pointer'>Total Value:</span>")
												.click(generateValueWindow));
		target.after(newRow);
		GM_addStyle(bigCss);
		GM_addStyle(JQCss);
		GM_addStyle(".zeropriced{display:none}");
		ssheet = document.styleSheets[document.styleSheets.length - 1];
		break;	
	case "/displaycollection.php":
	
		/* ------------
			Display Cases
	   ------------ */
	  
		(function(){
			var caseRan, amtSpan;
			// Helper functions
			function checkCurrentCase() {
				//create tool tip span for cloning
				var ttSpan = $("<span class='tooltipSpan'>Price probably out of date</span>");
				statusMessage("parsing case",true);
		
				function doVal(item,val,isHardcoded) {
					var span = document.createElement('span');
					var newCell = $("<td class='leaderLineRight'></td>");

					if(isHardcoded) {
						newCell.append($("<span class='tooltipHolder'>" + addCommas(val) + "*</span>")
										.append(ttSpan.clone()));
						newCell.addClass("tooltipCell");
					} else {
						newCell.text(addCommas(val));
					}
					
					newCell.appendTo(item.parentNode.parentNode);
					//change item.parentNode.nextSibling's background image
					item.parentNode.nextSibling.className+=" leaderLine";
					while(item.parentNode.nextSibling.firstChild) {
						span.appendChild(item.parentNode.nextSibling.firstChild);
					}
					item.parentNode.nextSibling.appendChild(span);
				}
	
				function createShelfRow(name,amt,num) {
					$("#shelfList").append("<tr class='" + ((num + 1) % 2 === 0 ? "even" : "odd") + "'><td>" +
											(num > 0 ? "<a class='shelfLink' href='#shelf_" + num.toString() + "'>" +
											num.toString() + '. ' + name + "</a>" : name) + "</td><td>" + addCommas(amt) + "</td></tr>");
				}
				var totalValue = 0;
				var numShelves = 0;

				var s=document.getElementsByTagName('center')[2].getElementsByTagName('a');
				for(var i=0;i<s.length;i++) {
					if(s[i].href.indexOf('toggle("shelf') != -1) {
						//shelf link
						numShelves++;
						s[i].name = "shelf_"+numShelves;
						var shelfValue = 0;
						var images = getParent(s[i],"table").getElementsByTagName('img');

						var itemList = getItemsFromImages(images), nv, q;
						for(var b=0;b<images.length;b++) {
							if((nv=images[b].parentNode.nextSibling.firstChild.nextSibling) && (q=/\(([0-9,]*)\)/.exec(nv.nodeValue))){
								q=q[1].replace(/,/g,'')*1;
							} else{
								q=1;
							}
							var itemValue = q * itemList[b].value;
							shelfValue += itemValue;
							doVal(images[b], itemValue, itemList[b].isHardcoded);
						}

						//create Shelf Info
						createShelfRow(s[i].textContent,shelfValue,numShelves);
						totalValue+=shelfValue;
						$("<span class='shelfValueSpan'>(" + addCommas(shelfValue) + ")</span>").appendTo(getParent(s[i],"td"));
						//s[i].parentNode.parentNode.insertBefore(shelfValueSpan,s[i].parentNode.parentNode.firstChild);
					}
				}
				if(numShelves === 0) {
					createShelfRow("No Shelves","0",-1);
				}
				caseRan = true;
				//check for no shelves, and create 
				amtSpan.text(addCommas(totalValue));
				amtSpan.attr('title', 'Toggle Shelf Price Table');
			}

			function beginCurrentCase() {
				var lock = {'returnPriceList' : true, 'returnItemList' : true};
				function checkLock(){
					lock[arguments.callee.caller.name] = false;
					for(var func in lock){
						if(lock.hasOwnProperty(func) && lock[func] === true){
							return;
						}
					}
					checkCurrentCase();
				}
				if(!caseRan && (typeof inProgress == "undefined" || inProgress === false)) {
					statusMessage('getting price list');
					inProgress = true;
					unstorePriceList(checkLock);
					statusMessage('getting item list');
					unstoreItemList(checkLock);
				} else if (caseRan) {
					toggle($('#shelfListHolder'));
					//toggle table holder display
				}
			}

			// Display code

			GM_addStyle(JQCss);
			GM_addStyle(smallCss);
			var caseSite = "http://www.jickenwings.org/collections/index.cgi?query_type=player&query_value=";
			var playerId = /who=(\d*)/.exec(document.getElementsByTagName('a')[0].search)[1];

			amtSpan = $("<span class='meatAmt hoverUnderline statusLocation' title='Calculate display case value'>uncalculated</span>")
				.click(beginCurrentCase);

			$("<div class='ui-widget-content' style='width:400px'>" +
				"<div id='shelfListHolder'><table id='shelfList' cellpadding='0' cellspacing='0'></table></div>" +
				"<div class='ui-widget-header' style='text-align:center'>DC Info: <a class='dcLink hoverUnderline' href='" +
					caseSite + playerId +"'>Display Case Database</a></div></div>")
				.prepend($("<div class='ui-widget-header' style='text-align:center'>Total: </div>")
					.append(amtSpan))
				.prependTo("center:eq(1)");
			caseRan = false;
		})();
		break;	
	case "/mallstore.php":
	
		/* ------------
			Mall stores
	   ------------ */

		(function(){
			var storeran, storeTotalAmtSpan, storePriceAmtSpan;
			// Helper functions
			function checkCurrentStore() {
				statusMessage("parsing store",true);
	
				var totalValue = 0;
				var totalPrices = 0;
				var itemTypes = 0;
				var itemQuantities = 0;

				var s=document.getElementsByTagName('input');
				for(var i=0;i<s.length;i++) {
					if(s[i].type == "radio") {
						itemTypes++;
						var q,p,f;

						var row = getParent(s[i],'tr');
						var priceCell = row.cells[3];
						var itemQ = (q=/\(([0-9,]+)\)/.exec(row.cells[2].lastChild.nodeValue))?q[1].replace(/,/g,'')*1:0;
						var itemPrice = (p=/([0-9,]+) Meat/.exec(priceCell.firstChild.nodeValue))?p[1].replace(/,/g,'')*1:0;
						var itemInfo = s[i].value-itemPrice;
						itemInfo+="";
						var itemNumber = itemInfo.substring(0,itemInfo.length-9)*1;
						if(itemPrice>=999999999){itemPrice=0;}

						var itemValue=(f=prices[itemNumber])?f[0]*1:0;
						totalValue += itemValue*itemQ;
						priceCell.title = "Diff: " +addCommas(itemPrice-itemValue)+" meat";
						priceCell.style.cursor = "help";

						itemQuantities+=itemQ;
						totalPrices+=itemQ*itemPrice;
					}
				}

				$("#shelfList").text((itemTypes === 0 ? 'No items in store.' : 'Store contains ' + addCommas(itemQuantities) +
						' items of ' + addCommas(itemTypes)+' types.'))
				$(".meatAmt:eq(0)").text(addCommas(totalValue));
				$(".meatAmt:eq(1)").text(addCommas(totalPrices));

				storeran=true;

				$("#shelfList").css("display", "block");
			}

			function beginCurrentStore() {
				if(!storeran && (typeof inProgress == "undefined" || inProgress === false)) {
					statusMessage('getting price list');
					inProgress = true;
					unstorePriceList(checkCurrentStore);
				} else if (storeran) {
					toggle($("#shelfList"));
				}
			}
			// Display code
			GM_addStyle(smallCss);
			GM_addStyle(JQCss);

			$("<div class='ui-widget-content' style='cursor:pointer; width:400px'>" +
				"<div class='ui-widget-header'>Store Value Total: <span class='meatAmt statusLocation'>uncalculated</span></div>" +
				"<div id='shelfList' style='display:none'></div>" +
				"<div class='ui-widget-header'>Store Price Total: <span class='meatAmt'>uncalculated</span></div></div>")
				.click(beginCurrentStore)
				.prependTo("center:eq(" + ($("center").length - 2).toString() + ")");

			storeran = false;
		})();
		break;
	case "/clan_stash.php":
	
	/* ------------
			Clan Stash
	   ------------ */

		(function(){
			var stashran;
			// Helper functions
			function checkStash() {
				statusMessage("parsing stash");
				var totalValue = 0;
				var itemTypes = 0;
				var itemQuantities = 0;

				var result = parseFromForm('takegoodies', 0, []);

				$(".statusLocation").text(addCommas(result.total));
				var tbody = document.createElement('tbody');
				fillTableBody(tbody, result.list);
				initTablesorter();
				$("#shelfList")
					.height((result.list.length < 20) ? 'auto' : maxTableHeight)
					.append("<thead><tr><th>Name</th><th>Quantity</th><th>Price</th><th>Total</th></tr></thead><tfoot></tfoot>")
					.append(tbody)
					.tablesorter({headers: {1:{sorter:'commas'}, 2:{sorter:'commas'}, 3:{sorter:'commas'}}});
				stashran=true;
				toggle($("#shelfList"));

				//$("#shelfList").css("display", "block").text(itemTypes === 0 ? "No items in stash" :
				//	"Stash contains " + addCommas(itemQuantities) + ' items of ' + addCommas(itemTypes) + ' types.');
			}

			function beginStash() {
				if(!stashran && (inProgress === undefined || inProgress === false)) {
					inProgress = true;
					unstorePriceList(checkStash);
				} else if (stashran) {
					toggle($("#shelfList"));
				}
			}
			// Display code
			
			GM_addStyle(smallCss);
			GM_addStyle(JQCss);

			$("<div class='ui-widget-content' style='cursor:pointer; width:400px'>" +
				"<div class='ui-widget-header'>Stash Value Total: <span class='meatAmt statusLocation'>uncalculated</span></div>" +
				"<div id='shelfListHolder'><table id='shelfList' style='display:none' cellpadding='0' cellspacing='0'></table></div></div>")
				.click(beginStash)
				.prependTo("center:eq(" + ($("center").length - 2).toString() + ")");

			stashran = false;
		})();
		break;
}
					



function generateValueWindow(clear) {
	var lock = {'returnPriceList' : true, 'returnItemList' : true};
	function checkLock(){
		lock[arguments.callee.caller.name] = false;
		for(var func in lock){
			if(lock.hasOwnProperty(func) && lock[func] === true){
				return;
			}
		}
		//check for existing data
		var storedLists=eval(GM_getValue("lastLists_"+playerName,[]));
		if(storedLists.length>0) {
			generateNewGroups(storedLists);
		}
		else {
			getCharacterData();
		}
	}

	//if window exists already
	var showWindow;
	if((showWindow=document.getElementById('readoutWindow')) !== null) {
		//if window is hidden
		if(showWindow.style.display=="none") {
			//unhide window
			showWindow.style.display="block";
		}
	} else {
		//window doesn't exist (yet)
		if(typeof inProgress == "undefined" || inProgress === false) {
			inProgress = true;
			
			//verify price list
			statusMessage("verifying price list");
			unstorePriceList(checkLock);
			unstoreItemList(checkLock);
		}
	}
}

function getCharacterData(){
	var lock = {'closet_consumables' : true, 'closet_equip' : true, 'closet_misc' : true, 'familiars' : true, 'hagnks_meat' : true,
				'hagnks_consumables' : true, 'hagnks_equip' : true, 'hagnks_misc' : true, 'DC' : true, 'store' : true, 'inventory' : true};
	function checkLock(lockName){
		lock[lockName] = false;
		for(var func in lock){
			if(lock.hasOwnProperty(func) && lock[func] === true){
				return;
			}
		}
		statusMessage("sorting lists");
		list.inventory.sort(sortbyTotal);
		list.hagnks.sort(sortbyTotal);
		list.closet.sort(sortbyTotal);
		GM_setValue("lastLists_" + playerName,
						[list.inventory,list.closet,list.store,list.hagnks,list.dc,list.familiar,list.skill,list.consumption].toSource());
		generateReadout();
	}

	// Optional locks must be set before the normal xmlhttprequests are made 
	if(useConsumption){
		lock.consumption = true;
		doConsumption(checkLock);
	}
	if(useSkills){
		lock.other_skills = true;
		doOtherSkills(checkLock);
	}
	var items_by_id = {};

	// Inventory
	GM_get(document.location.host + "/api.php?what=inventory&for=pricegun", function(details){ var JSONresponse = JSON.parse(details);
		for(var id in JSONresponse){
			var quantity = JSONresponse[id] * 1, value, isHardcoded;
			if(!(value = prices[id])){value=0;}else{value=value[0];}
			if(!(isHardcoded = prices[id])){isHardcoded=false;}else{isHardcoded=isHardcoded[1];}
			var total = quantity * value;
			var name = (items_by_id[id] === undefined) ? "Unknown item #"+id+" (try updating the item list)" : items_by_id[id];
			totalMeat.inventory += total;
			list.inventory.push([name, quantity, value, total, id, isHardcoded]);
		}
		checkLock('inventory');
	});

	doCloset(checkLock);
	doFamiliars(checkLock);
	doHagnks(checkLock);
	doDC(checkLock);
	doStore(checkLock);

	for each(var item in items){
		items_by_id[item[0]] = item[1];
//		GM_log("items_by_id["+item[0]+"] = "+item[1]);
	}
	// Everything below this relies on information from the character sheet
	// Count meat currently on hand
	var pageInfo = document.body.innerHTML.toString().replace(/,/g,'');
	var inventoryMeat = /Meat:<\/td><td><b>(\d*)</.exec(pageInfo)[1];
	if(inventoryMeat*1>0) {
		totalMeat.inventory+=inventoryMeat*1;
		list.inventory.push(["Meat", parseInt(inventoryMeat, 10), 1, parseInt(inventoryMeat, 10),undefined,false]);
	}

	//do current equipment
	var images = document.getElementsByTagName('img');
	var equipmentList = new Array; //[[item.name, 1, item.value, item.value, item.id, item.isHardcoded] for each (item in getItemsFromImages(images))];
	for each (item in getItemsFromImages(images)) {
		var matched = false;
		for(var i = 0; i < equipmentList.length; i++) {
			if(equipmentList[i][4] == item.id) {
				equipmentList[i][1]++;
				equipmentList[i][3] = parseInt(equipmentList[i][3], 10) + parseInt(item.value, 10);
				matched = true;
			}
		}
		if(!matched) {
			equipmentList.push([item.name, 1, item.value, item.value, item.id, item.isHardcoded]);
		}
	}
	for(var i = 0; i < equipmentList.length; i++){
		totalMeat.inventory += parseInt(equipmentList[i][3], 10);
	}
	merge(list.inventory, equipmentList);
	if(useSkills){
		// Gets skills listed on character sheet
		statusMessage("checking skills", true);
		var a = $("a[onclick]").get();
		for(var i = 0; i < a.length; i++){
			var skillID = /whichskill=(\d*)/.exec(a[i].getAttribute('onclick'));
			if(skillID === null){
				skillID = /skill\((\d*)\)/.exec(a[i].getAttribute('onclick'));
				if(skillID === null){break;}
			}
			skillID = skillID[1];
			if(skillID in skills){
				var val = (val = prices[skills[skillID].itemID]) ? val[0] : 0;
				totalMeat.skill += val * 1;
				list.skill.push([skills[skillID].name, 1, val, val, skills[skillID].itemID, false]);
			}
		}
	}
}

function doCloset(callback) {
	var sections = {};
	var firstRun = true;
	function pushCloset(responseText, details) {
		setParser(responseText);
		if(firstRun){
			var closetMeat;
			if((closetMeat = /Your closet contains <b>(\d*)<\/b> meat/.exec(responseText.replace(/,/g,'')))){closetMeat=closetMeat[1];}
			if(closetMeat*1>0) {
				totalMeat.closet+=closetMeat*1;
				list.closet.push(["Meat",closetMeat,1,closetMeat,undefined,false]);
			}

			var sectionRegex = /sections\["(.*?)"\]\s*=\s*(.*?);/g;
			var section_match = sectionRegex.exec(responseText);
			while(section_match){
				sections[section_match[1]] = section_match[2];
				section_match = sectionRegex.exec(responseText);
			}
			firstRun = false;
		}
		//Somewhat unfortunate variable name choice here. Has nothing to do with 'sections' above.
		var section_map = {"1":"consumables", "2":"equip", "3":"misc"};
		var section_num = details.finalUrl.charAt(details.finalUrl.length - 1);
		var result = parseFromInventory(totalMeat.closet, list.closet, section_num, 'closet_' + section_map[section_num], "closet.php", sections, callback, "closet");
		if(result.ajax_calls == 0){
			totalMeat.closet = result.total;
			//Check locks
			if(typeof callback == "function"){
				callback('closet_' + section_map[section_num]);
			}
		}
	}
	statusMessage("checking closet",true);
	GM_get(document.location.host + "/closet.php?which=1",pushCloset);
	GM_get(document.location.host + "/closet.php?which=2",pushCloset);
	GM_get(document.location.host + "/closet.php?which=3",pushCloset);
}

function doHagnks(callback) {
	var sections = {};
	var firstRun = true;
	function pushHagnksItems(responseText, details) {
		setParser(responseText);
		if(firstRun){
			firstRun = false;
			var sectionRegex = /sections\["(.*?)"\]\s*=\s*(.*?);/g;
			var section_match = sectionRegex.exec(responseText);
			while(section_match){
				sections[section_match[1]] = section_match[2];
				section_match = sectionRegex.exec(responseText);
			}
		}
		
		//Somewhat unfortunate variable name choice here. Has nothing to do with 'sections' above.
		var section_map = {"1":"consumables", "2":"equip", "3":"misc"};
		var section_num = details.finalUrl.charAt(details.finalUrl.length - 1);
		var result = parseFromInventory(totalMeat.hagnks, list.hagnks, section_num, 'hagnks_' + section_map[section_num], "storage.php", sections, callback, "hagnks");
		
		if(result.ajax_calls == 0){
			totalMeat.hagnks = result.total;
			//Check locks
			if(typeof callback == "function"){
				callback('hagnks_' + section_map[section_num]);
			}
		}
	}
	function pushHagnksMeat(details){
		var hagnksMeat;
		if((hagnksMeat = /You have (\d*) meat in long-term storage/.exec(details.replace(/,/g,'')))){hagnksMeat=parseInt(hagnksMeat[1], 10);}
		if(hagnksMeat > 0) {
			totalMeat.hagnks+=hagnksMeat;
			list.hagnks.push(["Meat",undefined,undefined,hagnksMeat,undefined,false]);
		}
		if(typeof callback == "function"){
			callback('hagnks_meat');
		}
	}
	statusMessage("checking hagnks",true);
	GM_get(document.location.host + "/storage.php?which=1",pushHagnksItems);
	GM_get(document.location.host + "/storage.php?which=2",pushHagnksItems);
	GM_get(document.location.host + "/storage.php?which=3",pushHagnksItems);
	GM_get(document.location.host + "/storage.php?which=5",pushHagnksMeat);
}

function doStore(callback) {
	function pushStore(details) {
		setParser(details);
		var a=$('a', $("#parser")).get();
		statusMessage("checking "+a.length+" store items",false);
		for(var i=0;i<a.length;i++) {
			var id, info;
//			if(a[i].href && (id=/take&whichitem=(\d*)/.exec(a[i].href)) && (id=id[1])) {
			if(a[i].href && (a[i].firstChild.nodeValue.indexOf("1") >= 0) && (id=/removeitem&itemid=(\d*)/.exec(a[i].href)) && (id=id[1])) {
				var q,itemName,val,total,isHardcoded;
				//info = a[i].parentNode.previousSibling.previousSibling.previousSibling.firstChild.nodeValue;
				q = parseInt(a[i].parentNode.parentNode.previousSibling.previousSibling.previousSibling.firstChild.nodeValue.replace(/,/, ""), 10);
				//if((q=/\((\d*)\)/.exec(info))){q=q[1];}else{q=1;}
				//itemName = info.split(' (')[0];
				itemName = a[i].parentNode.parentNode.previousSibling.previousSibling.previousSibling.previousSibling.firstChild.firstChild.nodeValue;
				//GM_log("q: "+q+", itemName: "+itemName);
				if(!(val = prices[id])){val=0;}else{val=val[0];}
				if(!(isHardcoded = prices[id])){isHardcoded=false;}else{isHardcoded=isHardcoded[1];}
				total=q*val;
				totalMeat.store+=total;
				list.store.push([itemName,q,val,total,id,isHardcoded]);
			}
		}
		statusMessage("sorting store list",false);
		list.store.sort(sortbyTotal);
		//Check locks
		if(typeof callback == "function"){
			callback('store');
		}
	}
	statusMessage("checking store",true);
	//GM_get(document.location.host + "/managestore.php",pushStore);
	GM_get(document.location.host + "/backoffice.php?which=1",pushStore);
}

function doFamiliars(callback) {
	function pushFam(details) {
		setParser(details);
		//fix for: no terrarium and no familiars to take from terrarium (I think)
		var images = $("form[name='newfam'] img").get();
		statusMessage("checking " + images.length + " familiar items",false);
		var famItems = new Array; //[[item.name, 1, item.value, item.value, item.id, item.isHardcoded] for each (item in getItemsFromImages(images))];
		for each (item in getItemsFromImages(images)) {
			var matched = false;
			for(var i = 0; i < famItems.length; i++) {
				if(famItems[i][4] == item.id) {
					famItems[i][1]++;
					famItems[i][3] = parseInt(famItems[i][3], 10) + parseInt(item.value, 10);
					matched = true;
				}
			}
			if(!matched) {
				famItems.push([item.name, 1, item.value, item.value, item.id, item.isHardcoded]);
			}
		}

		for(var i = 0; i < famItems.length; i++){
			totalMeat.inventory += parseInt(famItems[i][3], 10);
		}
		merge(list.inventory, famItems);

		if(useFamiliars){
			statusMessage("checking terrarium", true);
			// TODO: Possible performance problem (using contexts with jquery)
			var b = $("img", $("#parser"));
			for(var j = 0; j < b.length; j++){	
				if((clk = b[j].getAttribute('onclick')) && clk.indexOf('fam') != -1) {
					var currentFamiliar = familiars[/fam\((\d*)\)/.exec(clk)[1]];
					if(currentFamiliar !== undefined){
						val = (val = prices[currentFamiliar.itemID]) ? val[0] : 0;
						totalMeat.familiar += val * 1;
						list.familiar.push([currentFamiliar.name, 1, val, val, currentFamiliar.itemID, false]);
					}
				}
			}
			statusMessage("sorting familiar list");
			list.familiar.sort(sortbyTotal);
		}
		
		//Check locks
		if(typeof callback == "function"){
			callback("familiars");
		}
	}
	statusMessage("checking familiar equipment",true);
	GM_get(document.location.host + "/familiar.php",pushFam);
}				
					

function doConsumption(callback){
	// Gets items listed on consumption page
	function pushConsumption(details){
		setParser(details);
		// TODO: is this really okay?
		var consumptionItems = $('a.nounder', $("#parser")).get();
		for(var i = 0; i < consumptionItems.length;i++){
			var descNum = /\((\d+)\)/.exec(consumptionItems[i].getAttribute('href'));
			if(descNum !== null){
				var currentItem;
				descNum = descNum[1];
				if((currentItem = items[descNum])){
					var val = (val = prices[currentItem[0]]) ? val[0] : 0;
					var num = parseInt(consumptionItems[i].parentNode.nextSibling.textContent.replace(',',''), 10);
					totalMeat.consumption += val * num;
					list.consumption.push([currentItem[1], num, val, val * num, currentItem[0], false]);
				}
			}
		}
		statusMessage("sorting consumption list");
		list.consumption.sort(sortbyTotal);
		//Check locks
		if(typeof callback == "function"){
			callback('consumption');
		}
	}
	statusMessage("checking consumption data", true);
	GM_get(document.location.host + "/showconsumption.php",pushConsumption);
}

function doDC(callback) {
	function pushDC(details) {
		setParser(details);
		var returned = parseFromForm('takegoodies',totalMeat.dc,list.dc);
		totalMeat.dc = returned.total;
		list.dc = returned.list;
		statusMessage("sorting display case list");
		list.dc.sort(sortbyTotal);

		//Check locks
		if(typeof callback == "function"){
			callback('DC');
		}
	}
	statusMessage("checking display case",true);
	GM_get(document.location.host + "/managecollection.php",pushDC);
}

function doOtherSkills(callback){
	// Gets skills listed in 'use skills' page (necessary for bookshelf skills, mostly)
	function pushOtherSkills(details){
		setParser(details);
		var a = $("select[name='whichskill'] option[value]").get();
		for(var i = 0; i < a.length; i++){
			var skillID = a[i].getAttribute('value');
			if(skillID in skills){
				var foundSkill = false;
				for(var k = 0; k < list.skill.length && !foundSkill; k++){
					if(list.skill[k][4] == skills[skillID].itemID){
						foundSkill = true;
					}
				}
				if(!foundSkill){
					var val = (val = prices[skills[skillID].itemID]) ? val[0] : 0;
					totalMeat.skill += val * 1;
					list.skill.push([skills[skillID].name, 1, val, val, skills[skillID].itemID, false]);
				}
			}
		}
		statusMessage("sorting skill list");
		list.skill.sort(sortbyTotal);
		
		//Check locks
		if(typeof callback == "function"){
			callback('other_skills');
		}
	}
	GM_get(document.location.host + "/skills.php",pushOtherSkills);
}



function generateNewGroups(storedLists) {
	var listArray = ["inventory","closet","store","hagnks","dc","familiar","skill","consumption"];
	for(var i=0;i<storedLists.length;i++){
		var currentList = storedLists[i];
		var sectionTotal = 0;
		for(var a=0;a<currentList.length;a++) {
			var total;
			if(currentList[a][0]!="Meat") {
				var val, isHardcoded;
				var id=currentList[a][4];
				var q=currentList[a][1];
				if(!(isHardcoded = prices[id])){isHardcoded=false;}else{isHardcoded=isHardcoded[1];}
				if(!(val = prices[id])){val=0;}else{val=val[0];}
				total=q*val;
				currentList[a][2]=val;
				currentList[a][3]=total*1;
				currentList[a][5]=isHardcoded;
			} else {
				total=currentList[a][3]*1;
			}
			
			sectionTotal+=total;
		}
		currentList.sort(sortbyTotal);
		list[listArray[i]] = currentList;
		totalMeat[listArray[i]] = sectionTotal;
	}
	generateReadout();
}

function newCheck() {
	//clear variables?
	if(typeof inProgress == "undefined" || inProgress === false) {
		inProgress = true;
		GM_setValue("lastLists_"+playerName,"[]");
		list = {'inventory' : [], 'store' : [], 'closet' : [], 'hagnks' : [], 'dc' : [],
				'familiar' : [], 'skill' : [], 'consumption' : []};	
		totalMeat = {'inventory' : 0, 'store' : 0, 'closet' : 0, 'hagnks' : 0, 'dc' : 0,
					'familiar' : 0, 'skill' : 0, 'consumption' : 0};	
		readoutWindow.remove();
		getCharacterData();
	}	
}

function generateReadout() {
	var i, w, totalWorth;
	statusMessage('creating display');
	var listArray = [["TOTAL",undefined],["Inv","inventory"],["Closet","closet"],["Store","store"],["Hagnk's","hagnks"],["Case","dc"]];
	var windowSize = 36;
	if(useFamiliars){
		listArray.push(["Fam", "familiar"]);
	}
	if(useSkills){
		listArray.push(["Skills", "skill"]);
	}
	if(useConsumption){
		listArray.push(["Cons.", "consumption"]);
	}
	readoutWindow = $("<div id='readoutWindow' style=' position:absolute; top:10em; left:3em'" +
						" class='ui-tabs ui-widget ui-widget-content'></div>");
	
	var headerList = $("<ul class='ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header' style='border-color:black'></ul>");
	$("<img style='float:right' src='http://images.kingdomofloathing.com/closebutton.gif'></img>").click(
					function(e){$('#readoutWindow').css('display', 'none');}).appendTo(headerList);
	for(i=0;i<listArray.length;i++) {
		$("<li id='tab_" + i + "' class='ui-state-default" + ((i == 0) ? " ui-tabs-selected ui-state-active" : "") +
		  "'>" + listArray[i][0] + "</li>")
			.click(function(e){
				var swapId=(e.target.id=="")?e.target.parentNode.id:e.target.id;
				swap(swapId.replace('tab_',''));
			})
			.appendTo(headerList);
	}
	
	if(parseFloat(GM_getValue('newestVersion',  0)) > currentVersion) {
		$("<a style='border: 2px black solid; font-family: Arial, Helvetica, sans-serif; font-size: 11pt; font-weight: bold;" +
		  "background-color: #FFFFFF;color: #000000;text-decoration:none;padding:0px 8px;position:absolute;right:17px' target='_blank'" +
		  "href='" + GM_getValue('scriptLocation','http://hogsofdestiny.com/kol/pricegun/pricegun2.user.js') + "'>Update</a>")
			.appendTo(headerList);
	}
	readoutWindow.append(headerList);
	
	var contentWrapper=document.createElement('div');
	contentWrapper.id = "contentWrapper";
	
	
	//for each tab
	var meatDiv;
	for(i=0;i<listArray.length;i++) {
		var content = $("<div class='ui-tabs-panel ui-widget-content' id='content_" + i.toString() +
						"' style='border-style:none solid solid; border-color:black;'></div>");
		if(i === 0) {
			//TOTAL tab
			//create force new check link
			$("<div class='total' style='width: 25em; cursor: pointer; margin-left: auto; margin-right: auto; " +
							"text-align: center;'><b>Force new item check</b></div>").click(newCheck).appendTo(content);
			// end new link

			totalWorth = 0;
			for(w = 1; w < listArray.length; w++) {
				var sectionMeat = totalMeat[listArray[w][1]];
				totalWorth+=sectionMeat * 1;
				meatDiv = $("<div class='total'><span class='subtotalLabel'>" + listArray[w][0] + " Total:</span>" +
							"<span class='meatAmt'><b> " + addCommas(sectionMeat) + "</b></span>" + 
							"<img class='newWinImg' title='Display data in new window' name='newWinImg_" + w.toString() +
							"' src='" + GM_getResourceURL("newDoc") + "'></img></div>");	
				$("img", meatDiv).click(createDocWin);

				meatDiv.appendTo(content);
			}
		
			meatDiv = $("<div class='grandtotal'><span class='grandtotalLabel'>Grand Total:</span>" +
							"<span class='meatAmt'><b> " + addCommas(totalWorth) + "</b></span>" + 
							"<img class='newWinImg' title='Display data in new window' src='" +
							GM_getResourceURL("newDoc") + "'></img></div>");	
			$("img", meatDiv).click(createTotalDocWin);

			meatDiv.appendTo(content);
		} else {
			//All tabs following Total
			content.addClass('ui-tabs-hide');
	
			$("<div class='total'><span class='subTotalLabel'>" + listArray[i][0] + " Subtotal:</span><span class='meatAmt'><b>"
				+ addCommas(totalMeat[listArray[i][1]]) + "</b></span></div>")
				.append($("<img class='newWinImg' title='Display data in new window' name='newWinImg_" + i.toString() +
							"' src='" + GM_getResourceURL("newDoc") + "'></img>").click(createDocWin)).appendTo(content);
			content.append($("<br />"));

			//header
			var headerRow = $("<tr class='ui-widget-header' title='" + listArray[i][1] + "' style='display:block'></tr>")
				.append($("<th>Item</th>").click(sortByColumn))
				.append($("<th>Q</th>").click(sortByColumn))
				.append($("<th>Price</th>").click(sortByColumn))
				.append($("<th>Extension</th>").click(sortByColumn)
					.append($("<span class='arrowDown'></span>")));
		
			//body
			var tbody = document.createElement('tbody');
			tbody.style.display = 'block';
			var zeroPricedItems = fillTableBody(tbody, list[listArray[i][1]]);

			//footer
			var footer = $("<tfoot class='footer ui-widget-header'><tr><td colspan='4'><span>Toggle " + zeroPricedItems.toString() +
							" zero meat item(s)</span></td></tr></tfoot>");
			$("span", footer).click(function(e){
				var tbody = getParent(e.target,"table").tBodies[0]
				//var ssheet = document.styleSheets[document.styleSheets.length - 1];
				ssheet.disabled = !ssheet.disabled;
				rowStripe(tbody);
				//fix height. This is a godawful hack for missing max-height for table elements.
				if(tbody.scrollHeight<=maxTableHeight){tbody.style.height = "";}else{tbody.style.height = maxTableHeight +"px";}
			});

			$("<table cellpadding='0' cellspacing='0' class='shelfList'></table>")
				.append($("<thead></thead>").append(headerRow))
				.append(footer)
				.append(tbody)
				.wrap("<div class='shelfListHolder ui-widget-content'></div>").parent()
				.appendTo(content);
		}
		content.appendTo(contentWrapper);
	}
	readoutWindow.append(contentWrapper).appendTo(document.body);

	// GM_setValue can't handle integers larger than 32 bits
	GM_setValue('totalValue_'+playerName, totalWorth.toString());
/*
	totalWorth = totalWorth >= Math.pow(2,31) ? (Math.pow(2,31) - 1) : totalWorth; 
		
	GM_setValue('totalValue_'+playerName,totalWorth);
*/
	$(".statusLocation").text(addCommas(GM_getValue('totalValue_'+playerName,'uncalculated')));
	inProgress = false;
}

function fillTableBody(tbody, currentList){
	var row, cell;
	if(currentList.length === 0) {
		//create null row
		row = document.createElement('tr');
		row.className = "odd";
		cell = document.createElement('td');
		cell.colSpan = 4;
		cell.appendChild(document.createTextNode('Nothing of interest...'));
		
		row.appendChild(cell);
		tbody.appendChild(row);
		return 0;		
	}
	else{
		var zeroPricedItems = 0;
		var html = [];
		var isOdd = true;
		if(!document.styleSheets[document.styleSheets.length - 1].disabled){
			for(var x=0;x<currentList.length;x++) {
				if(currentList[x][3]*1 === 0) {
					html.push("<tr class='zeropriced'><td>");
					zeroPricedItems++;
				}
				else{
					html.push("<tr class='" + (isOdd ? "odd" : "even") +"'><td>");
					isOdd = !isOdd;
				}
				html.push(currentList[x][0]);
				html.push("</td>");
				for(var y=1;y<=3;y++) {
					html.push("<td>");
					html.push(currentList[x][y] !== undefined ? addCommas(currentList[x][y]) : "\u00a0");
					html.push("</td>");
				}
				html.push("</tr>");
			}
		}
		else{
			// This wouldn't be necessary if I could be sure that the compiler would hoist
			// the if check out of the for loop.
			for(var x=0;x<currentList.length;x++) {
				if(currentList[x][3]*1 === 0) {
					html.push("<tr class='zeropriced " + (isOdd ? "odd" : "even") + "'><td>");
					zeroPricedItems++;
				}
				else{
					html.push("<tr class='" + (isOdd ? "odd" : "even") +"'><td>");
				}
				isOdd = !isOdd;
				html.push(currentList[x][0]);
				html.push("</td>");
				for(var y=1;y<=3;y++) {
					html.push("<td>");
					html.push(currentList[x][y] !== undefined ? addCommas(currentList[x][y]) : "\u00a0");
					html.push("</td>");
				}
				html.push("</tr>");
			}
		}
		$(tbody).html(html.join(""));
		return zeroPricedItems;
	}
}

function sortByColumn(evt) {
	var i;
	var sortTarget = (evt.target.nodeName !="th")?getParent(evt.target,"th"):evt.target;
	var descending = sortTarget.title == 'descending';
	sortTarget.title = descending ? 'ascending' : 'descending';
	var arrowSpan = getParent(evt.target,"tr").getElementsByTagName('span')[0];
	arrowSpan.className = (descending)?"arrowUp":"arrowDown";
	sortTarget.appendChild(arrowSpan);

	var tbody = document.createElement('tbody');
	tbody.style.display = 'block';
	var table = getParent(sortTarget,"table");

	var children = sortTarget.parentNode.childNodes;
	for(i = 0; i < children.length; i++){
		if(children[i] == sortTarget){break;}
	}
	var currentList = list[sortTarget.parentNode.title];
	currentList.sort(comparisonGenerator(i, descending));
	fillTableBody(tbody, currentList);
	// Why 20 items? That's how many fit on my screen, and it takes too long if 
	// you wait until you actually append the list to check the height.
	tbody.style.height = (currentList.length < 20) ? '' : maxTableHeight +"px";

	table.removeChild(table.tBodies[0]);
	table.appendChild(tbody);
}

function createDocWin(evt) {
	var listArray = [["Inventory","inventory"],["Closet","closet"],["Store","store"],["Hagnk's","hagnks"],["Display Case","dc"]];
	if(useFamiliars){
		listArray.push(["Familiars", "familiar"]);
	}
	if(useSkills){
		listArray.push(["Skills", "skill"]);
	}
	if(useConsumption){
		listArray.push(["Cons.", "consumption"]);
	}
	if(evt.target.name) {
		var targetItem = evt.target.name.replace("newWinImg_","")*1-1;
		var currentList = list[listArray[targetItem][1]];
		var currentName = listArray[targetItem][0];
		var myDocWrite = "";
		var currentListLength =currentList.length;
		for(var i=0;i<currentListLength;i++){
			myDocWrite+="\n";
			myDocWrite+=currentList[i].slice(0,4).join("\t");		
		}
		var readoutWindow = window.open("","_blank","scrollbars=1,resizable=1,status=1,width=600,height=600");
		readoutWindow.document.open("text/plain");
		readoutWindow.document.write("UpUp.us Pricegun: "+currentName+" List\n");
		readoutWindow.document.write("Item Name\tQuantity\tPrice\tExtension");
		readoutWindow.document.write(myDocWrite);
		readoutWindow.document.close();
	}
}
function createTotalDocWin(evt) {
	var listArray = [["Inventory","inventory"],["Closet","closet"],["Store","store"],["Hagnk's","hagnks"],["Display Case","dc"]];
	if(useFamiliars){
		listArray.push(["Familiars", "familiar"]);
	}
	if(useSkills){
		listArray.push(["Skills", "skill"]);
	}
	if(useConsumption){
		listArray.push(["Cons.", "consumption"]);
	}
	var myDocWrite = "";
	var listArrayLength=listArray.length;
	for(var a=0;a<listArrayLength;a++) {
		var currentList = list[listArray[a][1]];
		var currentName = listArray[a][0];
		myDocWrite+="\n\n"+currentName+" List\n";
		myDocWrite+="Item Name\tQuantity\tPrice\tExtension";
		var currentListLength=currentList.length;
		for(var i=0;i<currentListLength;i++){
			myDocWrite+="\n";
			myDocWrite+=currentList[i].slice(0,4).join("\t");		
		}
	}
	var readoutWindow = window.open("","_blank","scrollbars=1,resizable=1,status=1,width=600,height=600");
	readoutWindow.document.open("text/plain");
	readoutWindow.document.write("UpUp.us Pricegun: All Items");
	readoutWindow.document.write(myDocWrite);
	readoutWindow.document.close();
}

function getParent(el, pTagName) {
	if (el == null) {
		return null;
	} else if (el.nodeType == 1 && el.tagName.toLowerCase() == pTagName.toLowerCase()) {	// Gecko bug, supposed to be uppercase
		return el;
	} else {
		return getParent(el.parentNode, pTagName);
	}
}

function rowStripe(tbody) {
	var visibleRows=0;
	var nodes=tbody.childNodes;
	var len=nodes.length;
	for(var i=0;i<len;i++) {
		var item=nodes[i];
		if(item.style.display != "none") {
			visibleRows++;
			var zeropriced = (item.className.indexOf("z") == -1) ? "" : " zeropriced"; 
			if(visibleRows % 2 === 0) {
				item.className = "even" + zeropriced;
			} else {
				item.className = "odd" + zeropriced;
			}
		}		
	}
}

				
/* -------------
   utility functions
   ------------- */
   
function statusMessage(message,clear) {
	$(".statusLocation").text(message + "...");
}
function getItemList(callback) {
	function parseItems(itemList) {
		statusMessage('parsing item list');
		
		var currentTime = parseInt(new Date().getTime()/60000, 10);
		GM_setValue("lastItemUpdate",currentTime);
		
		//remove trailing tabs
		itemList = itemList.replace(/\t\r\n/g,'\r\n');
		//remove trailing spaces from lines
		itemList = itemList.replace(/ \r\n/g,'\r\n');
		//remove trailing spaces from item and description Ids
		itemList = itemList.replace(/ \t/g,'\t');
		//remove carriage returns
		itemList = itemList.replace(/\r/g,'');
		//split by line
		var a=itemList.split('\n');
		
		for(var i=0;i<a.length;i++){
			if(/[0-9]/.test(a[i].charAt(0))) { 
				var split = a[i].split('\t'); 
//				GM_log("split[0] = "+split[0]+", split[1] = "+split[1]+", split[3] = "+split[3]);
				if(split[0] && split[1] && split[2]){
//					items[split[1]]=[split[0],split[3]];
					items[split[2]]=[split[0],split[1]];
//					GM_log("items["+split[2]+"]=["+split[0]+","+split[1]+"]");
				}
			}
		}
		GM_setValue('storedItemList',items.toSource());
		if( typeof callback=='function' ){
			callback();
		}
	}
	statusMessage('retrieving item list');
	//use kolmafia's item list:
//	GM_get("kolmafia.svn.sourceforge.net/svnroot/kolmafia/src/data/itemdescs.txt",parseItems);
	GM_get("svn.code.sf.net/p/kolmafia/code/src/data/items.txt",parseItems);
//	GM_get("sourceforge.net/p/kolmafia/code/HEAD/tree/src/data/items.txt?format=raw", parseItems); //newest
}

function unstoreItemList(callback) {
	var storedItemList;
	function returnItemList(skip) {
		if(!skip) {
			storedItemList = eval(GM_getValue('storedItemList','({})'));
		}
		items = storedItemList;
		if( typeof callback=='function' ){
			callback();			 
		}
	}
	storedItemList = eval(GM_getValue('storedItemList','({})'));
	
	var currentTime = parseInt(new Date().getTime()/60000, 10);
	var lastUpdate = GM_getValue("lastItemUpdate",1);
	
	//check every 3 weeks.
	if(isEmpty(storedItemList) || (currentTime-lastUpdate)>30240) {
		//if there's no itemlist
		getItemList(returnItemList);
	} else {
		returnItemList(true);
	}
}

function getVersion(){
	var versionLocation = "hogsofdestiny.com/kol/pricegun/VERSION";
	function parseVersion(responseText){
		var results = /([0-9.]+) ([\w.\/:_\-]+)/gi.exec(responseText);
		if(results !== null){
			var newestVersion = results[1];
			var scriptLocation = results[2];
			GM_setValue('newestVersion',newestVersion);
			GM_setValue('scriptLocation',scriptLocation);
			if(newestVersion == currentVersion.toString()) {// Runs the first time a version check happens after a new version is downloaded
				GM_setValue('currentVersion', (currentVersion + 0.0001).toString());
				GM_get('hogsofdestiny.com/kol/pricegun/bigReadout.css',
					function(response){bigCss = response;
									   GM_setValue('bigCss', bigCss);});
				
			}
		}
	}
	GM_get(versionLocation, parseVersion);
}

function getSkills(){
	var skillLocation = "hogsofdestiny.com/kol/pricegun/skilldata.txt";
	function parseSkills(skillList){
		var skillMap = {};
		var a=skillList.split(/\r?\n/);
//		var a=skillList.split('\r\n');
		for(var i=0;i<a.length;i++){
			//for each line of file
			var split = a[i].split('\t');
			var currentskill = {};
			currentskill.name = split[1];
			currentskill.itemID = split[0];
			skillMap[split[2]] = currentskill;
		}
		GM_setValue('storedSkillMap',skillMap.toSource());
	}
	GM_get(skillLocation, parseSkills);
}

function getFamiliars(){
	var familiarLocation = "hogsofdestiny.com/kol/pricegun/familiardata.txt";
	function parseFamiliars(familiarList){
		var familiarMap = {};
		var a=familiarList.split(/\r?\n/);
//		var a=familiarList.split('\r\n');
		for(var i=0;i<a.length;i++){
			//for each line of file
			var split = a[i].split('\t');
			var currentfamiliar = {};
			currentfamiliar.name = split[2];
			currentfamiliar.itemID = split[0];
			familiarMap[split[1]] = currentfamiliar;
		}
		GM_setValue('storedFamiliarMap',familiarMap.toSource());
	}
	GM_get(familiarLocation, parseFamiliars);
}

function getPriceList(callback) {
	var tempPrices = {};
	function parsePrices(pricelist) {
		statusMessage('parsing price list');
		
		var currentTime = parseInt(new Date().getTime()/60000, 10);
		GM_setValue("lastPriceUpdate",currentTime);
		
		//parse prices from file
		var a=pricelist.split('\r\n');
		
		// Check for type of pricelist
		if(/# U\+2468/.test(a[1])){
			for(var i=0;i<a.length;i++){
				//for each line of file
				var split = a[i].split('\t');
		
				if(/[0-9]/.test(a[i].charAt(0))) {
					// Normal price
					if(split.length==2) {
						tempPrices[split[0]]=[split[1],false];
					}
				}
			}
			GM_setValue('storedPriceList',tempPrices.toSource());
		}
		else{
			getOtherPriceList(pricelist);
		}
		
		if(typeof callback=='function'){
			callback();
		}
	}
	statusMessage("retrieving version information");
	getVersion();
	
	statusMessage("retrieving skill information");
	getSkills();
	
	statusMessage("retrieving familiar information");
	getFamiliars();
	
	statusMessage("retrieving new price list");
	var dataLocation = GM_getValue('dataLocation',"http://hogsofdestiny.com/kol/pricegun/dailyprice.log");
	if(/^http:\/\//.test(dataLocation)){
		GM_get(dataLocation.slice(7),parsePrices);
	}
	else{
		GM_get(dataLocation,parsePrices);
	}
}

function getOtherPriceList(pricelist){
	var tempPrices = {};
	var tempComboCases = [];
	var tempSpecialCases = {};

	var foundStatic = false;
	var foundHardcoded = false;
	var foundCombo = false;

	var split;	
	//parse prices from file
	var a=pricelist.split('\r\n');

	for(var i=0;i<a.length;i++){
		//for each line of file
		
		if(/[0-9]/.test(a[i].charAt(0))) {
			//if line starts with a number
			
			split = a[i].split(' '); 
			if(split.length==6) {
				if(foundStatic){
					tempPrices[split[1]]=[split[5],true];
				} else {
					tempPrices[split[1]]=[split[5],false];
				}
			}
			
		} else if(a[i].indexOf('hardcoded as below') != -1) {
			foundStatic = true;
		} else if (a[i].indexOf('specialHardcoded') != -1) {
			foundStatic = false;
			foundHardcoded = true;
		} else if (a[i].indexOf('specialCombo') != -1) {
			foundStatic = false;
			foundHardcoded = false;
			foundCombo = true;
			//check for hardcoded lines
		} else if (/# [0-9]$/.test(a[i].substring(0,3))) {
			//line begins with # number
			//hardcoded or combo
			//split line by spaces
			split = a[i].split(' ');
			if(foundHardcoded) {
				if(split.length==3) {
					tempSpecialCases[split[1]] = split[2];
				}
				//split hardcoded
			} else if (foundCombo) {
				if(split.length>2) {
					tempComboCases.push(split.slice(1));
				}
			}
		}
	}
	
	//push hard coded prices
	for(var id in tempSpecialCases) {
		if(tempPrices[id] === undefined){
			tempPrices[id] = [tempSpecialCases[id],false];
		} else {
			tempPrices[id][0] = Math.min(tempSpecialCases[id],tempPrices[id][0]);
		}
	}
	
	//push hardcoded combinations (ex: prevent skewered limes outpricing TPS + lime)
	for(var f=0;f<tempComboCases.length;f++) {
		var totalPrice=0;
		var fail=false;
		var item = tempComboCases[f];
		var p, tempMin;
		id = item[0];
		switch(item[1]) {
			//item is worth no more than sum of its parts
			case "+":
				for(i=2;i<item.length;i++) {
					if((p=tempPrices[item[i]])){totalPrice += p[0]*1;}else{fail=true;}
				}
				if(!fail){tempPrices[id]=[Math.min(totalPrice,tempPrices[id]?tempPrices[id][0]:Infinity),tempPrices[id]?tempPrices[id][1]:false];}
			break;
			case "*":
				//item worth the value of another item * a number.
				if((p=tempPrices[item[2]])){totalPrice=p[0]*item[3];} else {fail=true;}
				if(!fail){tempPrices[id]=[Math.min(totalPrice,tempPrices[id]?tempPrices[id][0]:Infinity),tempPrices[id]?tempPrices[id][1]:false];}
			break;
			case "=":
				if((p=tempPrices[item[2]])){tempPrices[id]=[Math.min(p[0],tempPrices[id]?tempPrices[id][0]:Infinity),tempPrices[id]?tempPrices[id][1]:false];}
			break;
			case "==":
				//all items in a group worth the group's lowest item price
				tempMin=Infinity;
				var tempDated=false;
				for(i=2;i<item.length;i++) {
					if((p=tempPrices[item[i]])){
						if(p[0]*1<tempMin) {
							tempDated=p[1];
							tempMin=p[0]*1;
						}
					}
				}
				if(tempMin==Infinity){tempMin=0;}
				for(i=2;i<item.length;i++) {
					tempPrices[item[i]]=[tempMin,tempDated];
				}
			break;
			case "min":
				//one item worth the lowest price of a group.
				tempMin=tempPrices[id]?tempPrices[id][0]:Infinity;
				for(i=2;i<item.length;i++) {
					if((p=tempPrices[item[i]])){tempMin=Math.min(tempMin,p[0]*1);}
				}
				if(tempMin<Infinity){tempPrices[id]=[tempMin,false];}
			break;
		}
	}
	GM_setValue('storedPriceList',tempPrices.toSource());
}

function unstorePriceList(callback) {
	var storedPriceList, storedFamiliarMap, storedSkillMap;
	function returnPriceList(skip) {
		if(!skip) {
			storedPriceList = eval(GM_getValue('storedPriceList','({})'));
			storedFamiliarMap = eval(GM_getValue('storedFamiliarMap','({})'));
			storedSkillMap = eval(GM_getValue('storedSkillMap','({})'));
		}
		prices = storedPriceList;
		familiars = storedFamiliarMap;
		skills = storedSkillMap;

		if( typeof callback=='function' ){
			callback();			
		}
	}
	// Note: Also gets familiar and skill lists as well.
	storedPriceList = eval(GM_getValue('storedPriceList','({})'));
	storedFamiliarMap = eval(GM_getValue('storedFamiliarMap','({})'));
	storedSkillMap = eval(GM_getValue('storedSkillMap','({})'));
	
	var currentTime = new Date().getTime()/60000;
	
	var lastUpdate = GM_getValue("lastPriceUpdate",currentTime);
	
	if(isEmpty(storedPriceList) || (currentTime-lastUpdate)>2400) {
		//if there's no price list, special list, or if it's been more than x hours since the last update...
		getPriceList(returnPriceList);
	} else {
		returnPriceList(true);
		//return storedPriceList;
	}
}


function sortbyTotal(a,b) {
	var x=a[3] * 1;
	var y=b[3] * 1;
	if (y<x){return -1;}
	if (y>x){return 1;}
	var c=a[0].toLowerCase();
	var d=b[0].toLowerCase();
	if (c<d){return -1;}
	if (c>d){return 1;}
	return y-x;
}
function comparisonGenerator(colNum, isDescending){
	function sortbyCol(a,b){
		var x, y, d = isDescending?-1:1; 
		if(colNum !== 0){
			x = a[colNum]*1;
			y = b[colNum]*1;
		}
		else{
			x = a[0].toLowerCase();
			y = b[0].toLowerCase();
		}
		if (y < x){return -1*d;}
		if (y > x){return d;}
		return 0;
	}
	return sortbyCol;
}

function swap(tab) {
	$("#tab_" + activetab).removeClass("ui-state-active ui-tabs-selected");
	$("#content_" + activetab).addClass("ui-tabs-hide");
	activetab = tab;
	$("#tab_" + activetab).addClass("ui-state-active ui-tabs-selected");
	$("#content_" + activetab).removeClass("ui-tabs-hide");

	if(tab !== "0") {
		// more ugly workarounds for missing table max-height 
		var tbody = document.getElementById("content_"+activetab).getElementsByTagName('tbody')[0];
		if(tbody.scrollHeight<=maxTableHeight){tbody.style.height = "";}else{tbody.style.height = maxTableHeight +"px";}
		var headers = $("#content_" + activetab + " th");
		if(headers[0].style.width == ""){
			var cells = $("#content_" + activetab + " tbody td");
			for(var i = 0; i < headers.length && i < cells.length; i++){
				headers[i].style.width = cells[i].clientWidth + "px";
			}
		}
	}
}

function parseFromForm(formname,sectionTotal,sectionList) {
	var opts = $("form[name='" + formname + "'] option").get();
	for(var i=1;i < opts.length;i++) {
		var id,info,q,itemName,total,isHardcoded, val;
		id=opts[i].value;
		info=opts[i].textContent;
		if((q=/\((\d*)\)/.exec(info))){q=q[1];}else{q=1;}
		itemName = info.split(' (')[0];
		if(!(val = prices[id])){val=0;}else{val=val[0];}
		if(!(isHardcoded = prices[id])){isHardcoded=false;}else{isHardcoded=isHardcoded[1];}
		total=q*val;
		sectionTotal+=total;
		sectionList.push([itemName,q,val,total,id,isHardcoded]);
	}
	return {total:sectionTotal,list:sectionList};
}

function parseFromInventory(sectionTotal, sectionList, sectionNum, lockName, pageName, sections, callback, name){
	// Again, somewhat unfortunate argument naming. 'sections' is a mapping from inventory section headers to strings.
	// The section in the first third argument's name refers to sections in the equip/consumables/misc sense.
	function parsePage(item_list){
		var pageTotal = 0;
		for(var i = 0; i < item_list.length; i++){
			var value, isHardcoded, nextSibling = item_list[i].nextSibling;
			var id = item_list[i].parentNode.id.slice(1);
			while(nextSibling.nodeType != 1){
				nextSibling = nextSibling.nextSibling;
			}

			var quantity = nextSibling.textContent.length > 0 ? nextSibling.textContent.slice(1, -1) : "1";
			if(!(value = prices[id])){value=0;}else{value=value[0];}
			if(!(isHardcoded = prices[id])){isHardcoded=false;}else{isHardcoded=isHardcoded[1];}
			var total = value * quantity;
			sectionList.push([item_list[i].firstChild.textContent, quantity, value, total, id, isHardcoded]);
			pageTotal += total;
		}
		return pageTotal;
	}

	var localTotal = parsePage($("b.ircm", $("#parser")));
	var collapsed_sections = $(".collapsed", $("#parser"));
	var ajax_sent = 0;
	
	for(var i = 0; i < collapsed_sections.length; i++){
        // The first condition checks that the items in the section are hidden (if they are, the text '(click to open)' will be there)
        // The second condition checks that the section itself is visible
        // The third condition checks that the items are not already loaded into the page
		if(collapsed_sections[i].textContent.length > 0){
			var parent_table = $(collapsed_sections[i]).closest("table");
			if(parent_table[0].style.display != "none" && $("b.ircm", parent_table).length == 0){
				ajax_sent++;
				GM_get(document.location.host + "/" + pageName + "?ajax=1&which=" + sectionNum + "&section=" +
						sections[collapsed_sections[i].previousSibling.textContent.slice(0, -1)],
					   function(responseText){
							setParser(responseText);
							localTotal += parsePage($("b.ircm", $("#parser")));
							ajax_sent--;
							if(ajax_sent == 0 && typeof callback == "function"){
								totalMeat[name] += localTotal;
								callback(lockName);
							}	
					   });
			}
		}
	}
	
	return {"total":localTotal + sectionTotal, "ajax_calls":ajax_sent};
}

function addCommas(nCma) {
	nCma += '';
	var x = nCma.split('.');
	var x1 = x[0];
	var x2 = x.length > 1 ? '.' + x[1] : '';
	var rgx = /(\d+)(\d{3})/;
	while (rgx.test(x1)) {
		x1 = x1.replace(rgx, '$1' + ',' + '$2');
	}
	return x1 + x2;
}

function toggle(item){
	if (!item){return;}
	if(item instanceof jQuery){
		$(item).css('display', $(item).css('display') == 'none' ? 'block' : 'none');
	}
	else{
		item.style.display = (item.style.display == "none") ? "block" : "none";
	}
}
function GM_get( dest, callback )
{
	GM_xmlhttpRequest({
	  method: 'GET',
	  url: 'http://' + dest,
	  headers: {"Referer": "http://127.0.0.1:60080/game.php"},
		onload:function(details) {
			if( typeof callback=='function' ){
				callback(details.responseText, details);
			}
		}
	});
}

function isEmpty(obj){
	for(var property in obj){if(obj.hasOwnProperty(property)){return false;}}
	return true;
}

// Merges two lists of items together and handles duplicates.
// The resulting list takes the place of the first list.
// Input lists may be unsorted.
function merge(list1, list2){
	var i, j, l1length = list1.length, l2length = list2.length;
	for(i = 0; i < l2length; i++){
		for(j = 0; j < l1length; j++){
			if(list1[j][4] === list2[i][4]){
				//list1[j][1]++;
				list1[j][1] += list2[i][1];
				list1[j][3] = list1[j][1] * list1[j][2];
				break;
			}
		}
		if(j === l1length){
			list1.push([item for each (item in list2[i])]);
		}
	}
}

//Sets up parser element for use by other functions.
//Old way doesn't work with jquery and contexts that encompass large numbers of nodes
function setParser(response){
	var div = $("#parser").length == 0 ? document.createElement('div') : $("#parser").remove().get(0);
	// Not jquery since jquery automatically evaluates script elements, apparently.
	div.innerHTML = response;
	div.id = "parser";
	var parser = $(div);
	$("script", parser).remove();
	parser.appendTo(document.body);
	parser.css({'display':'none'});
}

// 
function getItemsFromImages(images){
	var localItems = items, localPrices = prices;
	var itemList = [], numImages = images.length;
	for(var i = 0; i < numImages; i++){
		var onclick;
		if((onclick = images[i].getAttribute('onclick')) && onclick.indexOf('descitem') != -1){
			var descNum = /descitem\((\d*).*?\)/.exec(onclick)[1];
			var currentItem = localItems[descNum], value, isHardcoded;
			if(currentItem !== undefined){
				var item = {quantity:0, totalValue:0, name:currentItem[1], id:currentItem[0]};
				var price = localPrices[item.id];
				if(price !== undefined){
					item.value = price[0];
					item.isHardcoded = price[1];
				}
				else{
					item.value = 0;
					item.isHardcoded = false;
				}
				itemList.push(item);
			}
			else{
				itemList.push({name:'', quantity:0, value:0, totalValue:0, isHardcoded:false});
			}
		}
	}
	return itemList;
}

function initTablesorter(){
	$.tablesorter.addParser({ 
		id: 'commas', 
		is: function(s) { 
			// return false so this parser is not auto detected 
			return false; 
		}, 
		format: function(s) { 
			return s.replace(/,/g,''); 
		}, 
		type: 'numeric' 
	});
}
