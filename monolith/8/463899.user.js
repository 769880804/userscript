// ==UserScript==
// @name        SHD TV Favorite
// @namespace   http://userscripts.org/scripts/show/463899
// @include     http*://scenehd.org/
// @include     http*://scenehd.org/index.php
// @require     http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js
// @version     1.3
// @grant       GM_addStyle
// @grant       GM_xmlhttpRequest
// ==/UserScript==
function latestEp(a){var b=a.seasons[0].episodes,c=new Date;c=Math.floor(c.getTime()/1e3);for(var d=0;d<b.length;d++)if(b[d].first_aired_utc>c||0===b[d].first_aired){if(0!==d||!a.seasons[1])return[b[d-1],b[d]];if(!a.seasons[1])return["Upcoming Show","TBA"];for(var e=0;e<a.seasons[1].episodes.length;e++){if(a.seasons[1].episodes[e].first_aired_utc>c)return[a.seasons[1].episodes[e-1],a.seasons[1].episodes[e]];if(e+1===a.seasons[1].episodes.length)return[a.seasons[1].episodes[e],"TBA"]}}else if(d+1===b.length)return[b[d],"TBA"]}function applyInfo(a){for(i=0;i<a.length;i++){var d,e,f,g,b=a[i].index,c=a[i].latestEpisode;switch(c[0]){case"Upcoming Show":d=c[0]+", "+a[i].title,e=c[1];break;default:f=new Date(1e3*c[0].first_aired_utc).toLocaleDateString(),d='<b>LatestEp:</b> <a href="browse.php?imdb='+a[i].imdb_id.slice(2)+'&sort=5&cat=5,7">'+c[0].season+"x"+c[0].episode+"</a>, <b>Title:</b> "+c[0].title+", <b>Aired:</b> "+f+" <b> Status:</b> "+a[i].status,g="TBA"!==c[1]?secondsToTime(c[1].first_aired_utc-Date.now()/1e3):c[1]}QUERIES["IMG"+b].attr("src",a[i].images.banner),QUERIES["DES"+b].html(d),QUERIES["COLHEAD"+b].html("#"+b+", Next Ep In: "+g)}}function fetchInfo(a){var b=[],c=function(c){var d=$.parseJSON(c.responseText);d.latestEpisode=latestEp(d),d.index=getKeyByValue(a,d.tvdb_id),b.push(d),b.length===objectLength(a)&&(localStorage.setItem("objArray",JSON.stringify(b)),localStorage.setItem("time",Date.now()+36e5),applyInfo(b))};if(0===objectLength(a))placeInput();else for(var d=1;3>=d;d++)if(void 0!==a[d]){var e="https://api.trakt.tv/show/summary.json/3e877ccdcfe2928e6aa155db1a78a6d4/"+a[d]+"/extended";GM_xmlhttpRequest({url:e,method:"GET",onload:c})}}function placeInput(){for(var a=1;3>=a;a++)QUERIES["DES"+a].html()||(QUERIES["IMG"+a].attr("src","https://i.imgur.com/xYtQDX0.jpg"),QUERIES["DES"+a].append('<input class="tvShowText" type="search" size="28" placeholder="TVShow Name or IMDb ID" list="TVshowslist" name="'+a+'"/>').append('<datalist id="TVshowslist"></datalist>').append('<input class="addButton" type="submit" value="add">').append('<img id="spinning" style="display: none;" src="https://i.imgur.com/hl267XX.gif">'))}function main(){placeInput(),GM_addStyle(".tvBanner {position: relative;} .theX {position: absolute; top: 5px; left: 5; width: 4%; color: #990012; font-size: 8px; cursor: pointer;}");var a=Date.now(),b=localStorage.getItem("time");if(b=null!==b?b:a+36e5,a>b){var c=JSON.parse(localStorage.getItem("shows"));c=null!==c?c:{},fetchInfo(c)}else{var d=JSON.parse(localStorage.getItem("objArray")),c=JSON.parse(localStorage.getItem("shows"));if(d=null!==d?d:[],d.length>0&&d.length===objectLength(c))applyInfo(d);else{var c=JSON.parse(localStorage.getItem("shows"));c=null!==c?c:{},fetchInfo(c)}}}$("#sida").prepend('<div class="TVFavorite" style="margin: 0 auto 5px auto; width: 850px;"><table cellpadding="3"><tbody><tr><td class="colhead" id="colhead1"><b>#1</b></td><td class="colhead" id="colhead2"><b>#2</b></td><td class="colhead" id="colhead3"><b>#3</b></td></tr><tr><td><div id="banner1" class="tvBanner"><img border="0" width="276" id="img1" src=""></div></td><td><div id="banner2" class="tvBanner"><img border="0" width="276" id="img2" src=""></div></td><td><div id="banner3" class="tvBanner"><img border="0" width="276" id="img3" src=""></div></td></tr><tr><td id="des1"></td><td id="des2"></td><td id="des3"></td></tr></tbody></table></div>'),QUERIES={COLHEAD1:$("#colhead1"),COLHEAD2:$("#colhead2"),COLHEAD3:$("#colhead3"),IMG1:$("#img1"),IMG2:$("#img2"),IMG3:$("#img3"),DES1:$("#des1"),DES2:$("#des2"),DES3:$("#des3")};var objectLength=function(a){var c,b=0;for(c in a)a.hasOwnProperty(c)&&b++;return b},getKeyByValue=function(a,b){var c;for(c in a)if(a.hasOwnProperty(c)&&a[c]===b)return c},secondsToTime=function(a){return parseInt(a/86400)+"d "+new Date(1e3*(a%86400)).toUTCString().replace(/.*(\d{2}):(\d{2}):(\d{2}).*/,"$1h $2m")};main(),$(".addButton").on("click",function(){var a=$($(this).parent()[0]).find(".tvShowText")[0],b=$(a).val(),c="https://api.trakt.tv/show/summary.json/3e877ccdcfe2928e6aa155db1a78a6d4/"+b.replace(/ /g,"-"),d=$($($(this).parent()[0]).find("#spinning")[0]);d.show(),GM_xmlhttpRequest({url:c,method:"GET",onload:function(b){var c=$(a).attr("name"),e=$.parseJSON(b.responseText),f=$("#TVshowslist");if("failure"===e.status){d.hide(),$(d.parent()[0]).append(" <span>try again!</span>");var g=$($(d.parent()[0]).find("span")[0]);g.fadeOut("slow",function(){g.remove()})}else{var h=JSON.parse(localStorage.getItem("shows"));h=null!==h?h:{},h[c]=e.tvdb_id,localStorage.setItem("shows",JSON.stringify(h)),f.empty(),main()}}})}),$(".tvShowText").keyup(function(a){var b=a.which||a.KeyCode,c=[40,37,38,39,32];if(c.indexOf(b)>-1);else if(13===b)$($($($($(this)[0]).parent())[0]).find(".addButton")[0]).click();else{var d=$($(this).parent()[0]).find(".tvShowText")[0],e=$(d).val();GM_xmlhttpRequest({url:"https://api.trakt.tv/search/shows.json/3e877ccdcfe2928e6aa155db1a78a6d4?limit=5&query="+e.replace(/ /g,"-"),method:"GET",onload:function(a){var b=$.parseJSON(a.responseText),c=$("#TVshowslist");if(c.empty(),null!=b)for(var d=0;d<b.length;d++)c.append('<option value="'+b[d].title+'">')}})}}),$(".tvBanner").hover(function(){"https://i.imgur.com/xYtQDX0.jpg"!=$($(this).find("img")[0]).attr("src")&&($(this).append('<div class="theX">[X]</div>'),$(".theX").on("click",function(){var a=$($(this).parent()[0]).attr("id").slice(6),b=JSON.parse(localStorage.getItem("shows"));b=null!==b?b:{},delete b[a],localStorage.setItem("shows",JSON.stringify(b)),window.location.reload()}))},function(){$(".theX").off(),$($(this).find("div")[0]).remove()});