// ==UserScript==
// @name        Mogul Project 2014
// @namespace   mogul_project
// @version     1.3.5
// @author      Industrials
// @description Mogul Project is a new way to earn subscribers for your erepublik newspaper! Mogul Project runs on userscript, that makes this all posible. It detects subscriptions and synchronizes data with database.
// @include     http://www.erepublik.com*
// @include     http://e.5v5.lv/mogul_dashboard*
// @require     http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js
// @require     https://cdnjs.cloudflare.com/ajax/libs/alertify.js/0.3.11/alertify.min.js
// @exclude     /^http(.*)://www\.erepublik\.com/(.*)/(get-gold|loyalty/program|gold-bonus|map)(.*)/
// @resource    mogulCss http://e.5v5.lv/css/mogul.min.css
// @resource    bootstrap https://googledrive.com/host/0B3BZg10JinisX0ZJbHFVOUJHZEE
// @licenses    http://creativecommons.org/licenses/by-nc-nd/4.0/
// @downloadURL https://userscripts.org/scripts/source/417220.user.js
// @updateURL   https://userscripts.org/scripts/source/417220.meta.js
// @grant       GM_xmlhttpRequest
// @grant       GM_addStyle
// @grant       GM_getResourceText
// @grant       GM_setValue
// @grant       GM_getValue
// @grant       GM_deleteValue
// @grant       GM_info
// ==/UserScript==
function subunsub(a,b){b=void 0!=b?b:!1;var c=$("a.user_avatar").attr("href"),e=new RegExp("^(.+)/citizen/profile/([0-9]+)$");d=0==b?url.match(erepNewspaper)[4]:b,GM_xmlhttpRequest({method:"POST",url:server+"subscribe",data:"user="+c.match(e)[2]+"&paper="+d+"&s="+a,headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(a){"sub"==a.responseText?alertify.success("+1 PP"):"unsub"==a.responseText?alertify.error("-1 PP"):"null"==a.responseText&&alertify.log("Sorry, owner of this newspaper has 0 points")}})}function createShout(){getUserSubs(GM_getValue("userId"),function(a){message=a>30?"I have already earned "+a+" subscribers with MogulProject!\nCome and join us.\nhttp://goo.gl/LeXnJc":"MogulProject 2014 Fast, free and easy subs\nCome and join us.\nhttp://goo.gl/LeXnJc",postToFriends(message,function(a){a.message?(giveShout(function(a){1==a&&alertify.success("+1 PP")}),alertify.success("Success!"),GM_setValue("shout",!0),$("#shout").parent("div.panel").hide("slow")):alertify.error("Failed to post")})})}function createBasicContent(){$("div#ajaxContent").prepend('<div class="row" style="padding:10px;max-width:800px;margin:10px auto;"><div class="col-xs-6"><a href="http://www.erepublik.com/en"><img src="http://www.erepublik.com/images/modules/misc/logo.png" /></a></div><div class="col-xs-6" ><a href="http://www.erepublik.com/mogul-project-versus/"><img class="pull-right" src="http://i.imgur.com/JTZTDjn.png" /></a></div></div>'),$("div#content").html('<div class="row"><div id="eversusContent"></div></div>'),$("div#eversusContent").html("Loading...")}function directNull(){void 0===GM_getValue("userId")?window.location.replace("http://www.erepublik.com/en"):void 0===GM_getValue("_token")&&window.location.replace("http://www.erepublik.com/en")}function getValidNewspaperCount(a){GM_xmlhttpRequest({method:"GET",url:server+"getValidNewspapers?user="+GM_getValue("userId"),onload:function(b){var c=JSON.parse(b.responseText);"function"==typeof a&&a.call(this,c.data.length)}})}function setSessionData(a){setUserId(a),setToken()}function setUserId(a){var b=GM_getValue("userId");void 0===b&&GM_setValue("userId",a),b!=a&&(GM_deleteValue("userId"),GM_setValue("userId",a))}function setToken(){GM_deleteValue("_token"),GM_setValue("_token",$("#_token").val())}function mpClick(){GM_deleteValue("allowrefresh"),GM_setValue("allowrefresh",!1)}function npStatus(a){getValidNewspaperCount(function(b){0==b?(GM_deleteValue("npstatus"),GM_setValue("npstatus",!1)):(GM_deleteValue("npstatus"),GM_setValue("npstatus",!0)),"function"==typeof a&&a.call(this,GM_getValue("npstatus"))})}function npdotRefresh(a){$("div.newspaper_head div.actions").prepend('<div class="dot-holder"></div>'),a=void 0!=a?a:url.match(erepNewspaper)[4],time=setInterval(function(){isNewspaperInList(GM_getValue("userId"),a,function(a){"yes"==a?setNPDOT("valid"):"no"==a?setNPDOT("invalid"):"unknown"==a?setNPDOT("unknown"):clearInterval(time)})},2e3)}function giveShout(a){GM_xmlhttpRequest({method:"POST",url:server+"giveShout",data:"user="+GM_getValue("userId"),headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(b){"function"==typeof a&&a.call(this,JSON.parse(b.responseText))}})}function hasShouted(a){GM_xmlhttpRequest({method:"GET",url:server+"hasShouted?user="+GM_getValue("userId"),onload:function(b){"function"==typeof a&&a.call(this,b.responseText)}})}function setNPDOT(a){$("div.dot-holder").html('<div class="paper-'+a+'"></div>')}function doToggle(){toggleVisibility(GM_getValue("userId"),function(a){"false"==a?alertify.error("You can't toggle your visibility when you're out of the list."):"invisible"==a?(alertify.success("You're now invisible."),$("#visibilitybadge").removeClass("label-primary").removeClass("label-default").addClass("label-default").html("Invisible"),togglebadge()):"visible"==a&&(alertify.success("You're now visible."),$("#visibilitybadge").removeClass("label-primary").removeClass("label-default").addClass("label-primary").html("Visible"),$("#toggleinfo").hide("slow"))},0)}function togglebadge(){isToggled(userId,function(a){1==a&&$("#visibilitybadge").parent(".clearfix").append(' <span id="toggleinfo" style="margin:15px 0 0 5px;" class="pull-left label label-info">Toggle is on</span>')})}function setMogulPage(a,b){GM_xmlhttpRequest({method:"GET",url:"http://e.5v5.lv/mogul2/index/"+a,onload:function(a){var c=a.responseText;$("div#ajaxContent").append('<div class="afty">'+c+"</div>"),"function"==typeof b&&b.call(this,c)}})}function isToggled(a,b){GM_xmlhttpRequest({method:"GET",url:server+"isToggleOn?user="+a,onload:function(a){"function"==typeof b&&b.call(this,a.responseText)}})}function getVersion(a){GM_xmlhttpRequest({method:"GET",url:"http://e.5v5.lv/mogul/getVersion/",onload:function(b){"function"==typeof a&&a.call(this,b.responseText)}})}function toggleVisibility(a,b,c){c="undefined"!=typeof c?c:0,a="undefined"!=typeof a?a:GM_getValue("userId"),GM_xmlhttpRequest({method:"GET",url:server+"toggleVisibility/"+a+"/"+c,onload:function(a){var c=a.responseText;"function"==typeof b?b.call(this,c):void 0===typeof b&&("false"==c?alertify.error("You can't toggle your visibility when you're out of the list."):"invisible"==c?alertify.success("You're now invisible."):"visible"==c&&alertify.success("You're now visible."))}})}function checkVersion(a,b){a="undefined"!=typeof a?a:0,getVersion(function(c){if(a){if(a){var d=new Object;d.version=GM_info.script.version,d.data=c,"function"==typeof b&&b.call(this,d)}}else GM_info.script.version!=c&&$("body").prepend('<div style="height:20px;width:100%;text-align:center;display:block;background-color:#5BBCE1;color:#FFF;font-family:Open Sans Condensed,sans;text-transform:uppercase;font-weight:bold;">Your version of MogulProject is outdated ('+GM_info.script.version+")! Please update to version "+c+"</div>")})}function refresh(){getValidNewspaperCount(function(a){GM_xmlhttpRequest({method:"GET",url:"http://request.mogul.webperons.lv/central/newspapers/"+GM_getValue("userId"),onload:function(b){$("title").text("["+a+"] Media Mogul Project 2014"),$("#ajaxContent").html(b.responseText),$("#ajaxContent").prepend('<div class="alert" style="border-left:3px #5BC0DE solid;">This page is in autorefresh mode (every 25s)</div>')}})}),setTimeout(refresh,25e3)}function getSubscribersCount(a,b){var c=new RegExp("<em>([0-9]+)</em>");GM_xmlhttpRequest({method:"GET",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:27.0) Gecko/20100101 Firefox/27.0"},url:"http://www.erepublik.com/en/newspaper/"+a+"/1",onload:function(a){"function"==typeof b&&b.call(this,a.responseText.match(c)[1])}})}function getNewspaperId(a,b){GM_xmlhttpRequest({method:"GET",url:server+"getNewspaperId/"+a,onload:function(a){"function"==typeof b&&b.call(this,a.responseText)}})}function getUserSubs(a,b){GM_xmlhttpRequest({method:"GET",url:server+"getUserSubs/"+a,onload:function(a){"function"==typeof b&&b.call(this,a.responseText)}})}function isNewspaperInList(a,b,c){GM_xmlhttpRequest({method:"GET",url:server+"isNewspaperInList/"+a+"/"+b,onload:function(a){"function"==typeof c&&c.call(this,a.responseText)}})}function postToFriends(a,b){GM_xmlhttpRequest({method:"POST",url:"http://www.erepublik.com/en/main/wall-post/create/",data:"post_message="+a+"&_token="+GM_getValue("_token"),headers:{"Content-Type":"application/x-www-form-urlencoded","User-agent":"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:27.0) Gecko/20100101 Firefox/27.0",Accept:"application/json, text/javascript, */*; q=0.01",Host:"www.erepublik.com",Referer:"http://www.erepublik.com/en/"},onload:function(a){"function"==typeof b&&b.call(this,JSON.parse(a.responseText))}})}var server="http://request.mogul.webperons.lv/grab/",url=$(location).attr("href"),erepNewspaper=new RegExp("^(http://|https://)?(www)?.erepublik.com/(.+)/newspaper/[a-zA-Z0-9-]+-([0-9]+)/1$"),mogulPage=new RegExp("^(http://|https://)?(www.)?erepublik.com/mogul-project-versus.?$"),newspaperPage=new RegExp("^(http://)?e.5v5.lv/mogul_dashboard/earn.?$");if(autoSub=new RegExp("^(http://|https://)?(www.)?erepublik.com/mogul-project-autosub.?$"),articlePage=new RegExp("^(http://|https://)?(www.)?erepublik.com/(.+)/article/(.+)-([0-9]+)/(.+)$"),erepIndex=new RegExp("^(http://|https://)?(www.)?erepublik.com/(.+)$"),mogulDashboard=new RegExp("^(http://)?e.5v5.lv/mogul_dashboard.?$"),erepIndex.test(url)){var mogulcss=GM_getResourceText("mogulCss");GM_addStyle(mogulcss);var d=new Date,userHref=$("a.user_avatar").attr("href"),regex=new RegExp("^(.+)/citizen/profile/([0-9]+)$");setSessionData(userHref.match(regex)[2]),$("div.sidebar").append('<div class="mpbutton"><a id="mp" target="_blank" href="http://e.5v5.lv/mogul_dashboard">Mogul Project</a> <a target="_blank" href="http://e.5v5.lv/mogul_dashboard/earn"><span class="badget">List</span></a></div>')}if(mogulDashboard.test(url)){directNull();var userId=GM_getValue("userId");setMogulPage(userId,function(){document.getElementById("earnPoints").href="http://e.5v5.lv/mogul_dashboard/earn",$("#shout").show(),toggleVisibility(userId,function(a){"true"==a&&($("#namefield").append(' <a id="togglevis" class="btn btn-xs btn-default">Toggle visibility</a>'),document.getElementById("togglevis").addEventListener("click",doToggle,!1))},1),togglebadge(),document.getElementById("shout").addEventListener("click",createShout,!1)}),checkVersion(1,function(a){a.version!=a.data&&$("#menuListener").append(' <a class="btn btn-xs btn-warning" href="http://userscripts.org/scripts/source/417220.user.js">Download version '+a.data+'</a> <span class="label label-danger">Your version of MogulProject is outdated!</span>')})}if(articlePage.test(url)){var mogulcss=GM_getResourceText("mogulCss");GM_addStyle(mogulcss);var newspaperId=$("#newspaper_id").val();$("a.subscribeToNewspaper").click(function(){time=setInterval(function(){$("a.unsubscribeFromNewspaper").is(":visible")&&(subunsub("sub",newspaperId),clearInterval(time))},1e3)}),$("a.unsubscribeFromNewspaper").click(function(){subunsub("unsub",newspaperId)})}newspaperPage.test(url)&&(directNull(),refresh()),erepNewspaper.test(url)&&($("a.subscribeToNewspaper").click(function(){time=setInterval(function(){$("a.unsubscribeFromNewspaper").is(":visible")&&(subunsub("sub"),clearInterval(time))},1e3)}),$("a.unsubscribeFromNewspaper").click(function(){subunsub("unsub")}));