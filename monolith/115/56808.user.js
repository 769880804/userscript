// ==UserScript==
// @name           chacha.vn leecher
// @namespace      tiger2wander.blogspot.com
// @author         Uoc Nguyen
// @email          tiger2wander@gmail.com
// @description    Chacha.vn download link leecher
//                 How to use: load chacha.vn playlist page then right click to Grease Monkey
//                 on the status bar. Select User Script Commands -> Generate Unix Shell Script
//                 A diaglog will show up and ask you for script template which will be use for
//                 generate shell script for you. When you have done, click ok then another
//                 dialog will show up and give you generated shell script use for download all
//                 song in playlist. Select all content then copy and paste it to a file then 
//                 save file like: leecher.sh
//                 You may do chmod command also: chmod +x leecher.sh
//                 then launch it using this command: ./leecher.sh
//                 Wait until files download to your computer!
//                 Have fun!
// @include        http://chacha.vn/*
// ==/UserScript==

function leechDownloadData() {
  try {
    var dlLinks = window.document.body.getElementsByClassName('save_to');
    var songList = window.document.body.getElementsByClassName('song');
    var result = '';
    for (var i=0; i<dlLinks.length; i++) {
      var dlLink = dlLinks[i].getElementsByClassName('addfav')[0];
      var songName = songList[i].innerHTML.replace(/(^\s+)|(\s+$)/g, '');
      result += dlLink.href + ' "' + songName + '"\n';
    }
    alert(result);
  } catch (e) {
    GM_log('x. Bugs');
    GM_log(e.toString());
  }
}

function leechGeneratedUnixShellScript() {
  try {
    var defaultPattern = 'echo "Download: %s";%ncurl -C - -o "%s" "%l";';
    var dlLinks = window.document.body.getElementsByClassName('save_to');
    var songList = window.document.body.getElementsByClassName('song');
    var pattern = window.prompt('Enter script template: \n%s: song name\n%l: link\n%n: new line', defaultPattern);
    if (!pattern) {
      pattern = defaultPattern;
    }
    var result = '#!/bin/bash\n'
               + '# @author Uoc Nguyen\n'
               + '# @copyright 2009\n'
               + '# Generated by grease monkey script\n'
               + '# Working url: ' + window.location.href + '\n';
    for (var i=0; i<dlLinks.length; i++) {
      var dlLink = dlLinks[i].getElementsByClassName('addfav')[0].href;
      var songName = songList[i].innerHTML.replace(/(^\s+)|(\s+$)/g, '') + '.mp3';
      var command = pattern.replace(/\%s/g, songName);
      command = command.replace(/\%l/g, dlLink);
      command = command.replace(/\%n/g, '\n');
      result += "\n" + command;
    }
    alert(result);
  } catch (e) {
    GM_log('x. Bugs');
    GM_log(e.toString());
  }
}

function leechSongList() {
  try {
    var songList = window.document.body.getElementsByClassName('song');
    var result = '';
    for (var i=0; i<songList.length; i++) {
      var songName = songList[i].innerHTML.replace(/(^\s+)|(\s+$)/g, '');
      result += songName + '.mp3\n';
    }
    alert(result);
  } catch (e) {
    GM_log('x. Bugs');
    GM_log(e.toString());
  }
}

GM_registerMenuCommand('Leech raw data', leechDownloadData);
GM_registerMenuCommand('Generate unix shell script', leechGeneratedUnixShellScript);
GM_registerMenuCommand('Leech song list', leechSongList);
