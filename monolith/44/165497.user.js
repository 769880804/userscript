// ==UserScript==
// @name        Strategus Tool Belt (STB)
// @namespace   chy_strat
// @include     http://strategus.c-rpg.net/news.php*
// @downloadURL http://userscripts.org/scripts/source/165497.user.js
// @updateURL   http://userscripts.org/scripts/source/165497.meta.js
// @version     2.0.9
// ==/UserScript==

function addJQuery(e){var t=document.createElement("script");t.setAttribute("src","http://code.jquery.com/jquery-2.0.0.min.js");t.addEventListener("load",function(){var t=document.createElement("script");t.textContent="window.jq=jQuery.noConflict(true);("+e.toString()+")();";document.body.appendChild(t)},false);document.body.appendChild(t)}function main(){function v(e){e=e.replace(/[^-a-zA-Z0-9,&\s]+/ig,"");e=e.replace(/-/gi,"_");e=e.replace(/\s/gi,"-");return e}function m(e,t,n){if(e!==undefined){if(t){e=e.split(t);e=e[1]}if(n){e=e.split(n);e=e[0]}}return e}function g(e,t){var n=0;if(e!==null){for(var r=0;r<e.length;r++){if(e[r].id==t)n=e[r]}}return n}function y(e,t){var n=0;if(e!==null){for(var r=0;r<e.length;r++){if(e[r].name==t)n=e[r]}}return n}function b(e){return g(f,e)}function w(e){return JSON.stringify(e)}function E(e){return JSON.parse(e)}function S(e){return localStorage.getItem(e)}function x(e,t){localStorage.setItem(e,t)}function T(e){localStorage.removeItem(e)}function N(){if(jq(location).attr("href")=="http://strategus.c-rpg.net/news.php?inv")return true;else return false}function C(){if(jq(location).attr("href")=="http://strategus.c-rpg.net/news.php?info"||jq(location).attr("href").indexOf("http://strategus.c-rpg.net/news.php?msg=")!=-1)return true;else return false}function k(){lt("cat00","img/equip_inv.png","Trade",Array());lt("cat01","img/equip_horse.png","Horse",Array(1,2,3,4,10,5,6,7,6049,6051,6050,8,524,525,6048,9,526,527));lt("cat02","img/equip_throw.png","Throwing",Array(23,25,26,28,29,32,34,5142,46,47,48,36,38,30,539,40,42,44));lt("cat03",a,"Siege",Array(528,536,534,529,537,535,538,6176,539));lt("cat04","img/equip_body.png","Body Armor",Array(364,369,366,367,368,370,372,373,374,375,376,412,413,371,378,377,379,431,432,5393,5498,381,382,384,383,386,385,390,389,4722,391,5169,387,388,394,392,399,393,395,396,397,398,6060,416,400,417,5500,419,472,418,403,434,420,5501,437,438,3971,404,440,6059,365,401,402,414,415,421,422,423,424,425,426,427,428,429,430,433,5394,5919,442,443,3130,444,3137,4952,445,4723,5502,447,405,454,5738,5741,5507,407,408,409,410,411,459,5506,441,448,450,458,461,4947,4948,4949,4950,4951,446,5916,460,451,4957,439,5505,4958,5918,449,455,457,5739,5740,5742,456,6058,452,435,6062,6061,406,4955,453,4720,6063,4956,5504,5509,5499,462,463,4953,4954,436,3972,5917,469,5496,464,465,466,467,5508,473,474,475,4721,476,477,478,480,5503,5497,468,547,541,545,471,380,470,479));lt("cat05","img/equip_head.png","Head Armor",Array(273,283,255,256,257,258,259,260,261,262,279,280,284,5915,263,295,268,264,265,266,267,294,298,299,5162,270,272,274,275,276,277,278,309,495,6057,271,286,281,285,5484,5168,287,288,289,290,291,292,312,348,282,269,300,293,296,5914,302,297,301,307,303,5159,5160,5161,304,353,5155,5156,5157,5163,5164,5165,305,317,319,321,306,308,311,3968,5733,310,326,347,349,350,5158,5730,5737,314,323,313,320,322,330,549,4938,5385,5386,315,324,325,5486,5487,5913,5494,6056,318,327,329,328,5492,5736,338,5483,5488,5489,5734,5910,494,5493,5731,331,504,546,5490,332,335,4944,5491,333,363,4939,4942,5166,334,336,337,361,3969,4941,4945,5167,5482,5735,5912,316,339,359,4943,5485,362,5384,340,360,507,6055,341,4940,5495,5732,5911,6054,342,503,540,5885,343,4946,5388,5389,506,5390,5391,5392,344,345,346,351,352,356,5154,354,355,357,5387,358,509,492,5383));lt("cat06","img/equip_leg.png","Leg Armor",Array(218,219,220,5479,5480,5727,6052,5906,222,223,221,224,4936,225,226,228,5153,227,229,5907,230,3966,4937,5729,5728,234,5908,235,238,6053,233,3967,5909,236,232,4935,244,237,231,239,243,240,242,241));lt("cat07","img/equip_hand.png","Hand Armor",Array(245,246,5884,253,251,252,247,248,249,550,543,542,254,5481,533));lt("cat08","img/equip_polearm.png","Polearm",Array(552,89,90,91,491,132,101,92,111,5371,93,94,99,100,123,95,107,116,103,133,104,108,4754,96,109,4753,112,98,120,122,110,102,5856,118,5855,113,106,5857,119,105,114,5858,117,4692,124,115,97,126,128,531,532,530));lt("cat09","img/equip_twohand.png","Two Handed",Array(502,129,130,137,131,136,139,134,138,519,147,143,189,140,142,149,135,150,148,146,144,517,518,145,152,151,153,154,158,141,155,156,3320,157,159,522,521,160));lt("cat10","img/equip_onehand.png","One Handed",Array(489,161,162,164,165,166,168,500,3322,167,173,172,551,171,554,169,163,5900,178,174,170,5372,177,180,175,184,179,185,187,183,181,190,186,499,191,188,200,192,197,196,201,182,176,205,206,202,194,3195,195,3194,193,207,516,203,211,209,208,204,6022,213,198,520,215,212,3192,214,3196,3298,217,3190,216,210,3193,3323,199,510,523,6021,3191,4755));lt("cat11","img/equip_shield.png","Shield",Array(490,497,488,508,52,49,53,58,51,50,54,60,59,55,74,75,79,56,57,62,80,505,496,498,61,493,72,64,66,70,73,548,501,77,85,76,6019,71,83,86,81,82,78,63,65,67,68,69,84,6018,87,6020,544,88));lt("cat12","img/equip_bow.png","Bow",Array(17,16,18,19,21,5141,22,20));lt("cat13","img/equip_arrow.png","Arrow",Array(481,482,484,483));lt("cat14","img/equip_crossbow.png","Crossbow",Array(11,12,13,14,15));lt("cat15","img/equip_bolt.png","Bolt",Array(485,486))}function L(e){var t=c[0];for(var n=0;n<c.length;n++){for(var r=0;r<c[n].items.length;r++){if(c[n].items[r]==e){t=c[n];break}}}return t}function A(){var e=-1;jq("#inv_page").prepend('<span id="stb_loader"><img src="http://i.imgur.com/2VBbgpI.gif" alt="loader" /><b style="color:#bf9000">Loading items...</b></span>');jq("#inv_page .item").each(function(t){var n=jq(this).children().children().attr("rel");var r=m(n,"php?i=","&m=");n=jq(this).children(".desc").children("div").children().attr("name");if(null!==n&&undefined!==n){var i=m(n,"[","]");var s=jq(this).children().children(".name").html();n=jq(this).children().children().attr("rel");var o=m(n,"&m=");if(!r){r=e;e--}at(r,s);ft(i,r,o)}});jq("#stb_loader").html('<b style="color:green">Items loaded !</b>')}function O(e){if(!e)var t='fieldset table[name="transfertable"]:first ';else var t='fieldset table[name="transfertable"]:last ';jq(t+"tr:first").remove();jq(t+"tr").each(function(t){var n=m(jq(this).children().children("input").attr("name"),"[","]");var r=m(jq(this).children().children("span").html(),null," (all)");var a=m(jq(this).children().children().html(),null,":");if(n=="troops"||n=="gold"){if(n=="troops")var c=i;else if(n=="gold")var c=s;else var c=u;var h=M(n,0,a,c,n,r,"");jq(this).parent().append(h);jq(this).remove()}else{var p=y(f,a);var d=g(l,n);if(p.id===undefined)var v=0;else var v=p.id;if(p.id<=0){var b=o;var w="cat00"}else{if(!v)var b=u;else var b="loadimage.php?id="+v+"&lvl="+d.level;var w=L(v).id}if(!e)L(v).addCount(r);else L(v).addCount(r,true);if(d==0)var h=M(v,0,a,b,n,r,w);else var h=M(v,d.level,a,b,n,r,w);jq(this).parent().append(h);jq(this).remove()}})}function M(e,t,n,r,i,s,o){if(e>0)var u='rel="itemstats.php?i='+e+"&m="+t+'"';else var u="";return block='<div id="'+e+'" cat="'+o+'" name="'+n+'" level="'+t+'" class="item"><div class="header"><img '+u+' height="70" width="70" class="itemstats" title="'+n+'" src="'+r+'"><div class="name">'+n+'</div></div><div class="desc"><center><a class="abutton"><img style="vertical-align:middle" src="img/ic_minus.png"></a><input value="0" name="transfer['+i+']" id="hero_transfer_item_'+i+'" class="in"><a class="abutton"><img style="vertical-align:middle" src="img/ic_plus.png"></a><br><a class="setTotal" count="'+s+'" href="">'+s+" (all)</a></center></div></div>"}function _(e,t,n,r,i,s){if(e>0)var o='rel="itemstats.php?i='+e+"&m="+t+'"';else var o="";var u="loadimage.php?id="+e+"&lvl="+t;return block='<div id="'+e+'" cat="'+s+'" name="'+n+'" level="'+t+'" class="item"><div class="header"><img '+o+' height="70" width="70" class="itemstats" title="'+n+'" src="'+u+'"><div class="name">'+n+'</div></div><div class="desc"><center><a class="abutton"><img style="vertical-align:middle" src="img/ic_minus.png"></a><input value="'+r+'" class="in"><a class="abutton"><img style="vertical-align:middle" src="img/ic_plus.png"></a><br><a class="setTotal" count="'+i+'" href="">'+i+" (all)</a></center></div></div>"}function D(){$('fieldset select[name="transfer_target"]:first option').tinysort();$('fieldset select[name="transfer_target"]:last option').tinysort()}function P(){$('fieldset table[name="transfertable"]:first .item').tinysort({attr:"cat"},{attr:"name"},{attr:"level",order:"desc"});$('fieldset table[name="transfertable"]:last .item').tinysort({attr:"cat"},{attr:"name"})}function H(){jq("fieldset table[name='transfertable']:first .item").each(function(){if(jq(this).attr("level")>0){jq(this).css("background-color",e)}else if(jq(this).attr("level")<0){jq(this).css("background-color",t)}})}function B(){var e='<div class="block"><div id="STB_Filters" style="padding-left:20px; padding-right:20px;"><h2>STB Filters</h2></div></div>';jq("#sub").append(e);for(var t=0;t<c.length;t++){e='<img class="filter-buttons" width="35" src="'+c[t].img+'" alt="'+c[t].name+'" id="'+c[t].id+'" />';jq("#STB_Filters").append(e)}e='<img class="filter-buttons selected" style="background-color:'+r+';" width="35" src="'+c[0].img+'" alt="All" id="cat-1" /><br>		SEARCH <input id="filter-search-bar" type="text" value="Search" style="width: 100%" /><br>		DISPLAY LOOMLEVEL			<select name="loomComparator">				<option value=">"> > </option>				<option selected value=">="> &#8805; </option>				<option value="="> = </option>				<option value="!="> &#8800; </option>				<option value="<="> &#8804; </option>				<option value="<"> < </option>			</select>			<select name="loomLevel">				<option value="3"> 3 </option>				<option value="2"> 2 </option>				<option value="1"> 1 </option>				<option value="0"> 0 </option>				<option value="-1"> -1 </option>				<option value="-2"> -2 </option>				<option value="-3"> -3 </option>				<option selected value="-4"> -4 </option>			</select>';jq("#STB_Filters").append(e)}function F(){var e='<div class="block"><div id="STB_Export" style="padding-left:20px; padding-right:20px;"><h2>STB Armoury</h2></div></div>';jq("#sub").append(e);e='<select id="presetList">			<option value="">Select a preset</option>		</select>		<input id="presetButton" title="Use|Load the selected preset of items" type="button" value="Use">		<input id="deletePresetButton" title="Delete|Delete the selected preset" type="button" value="Delete">		<input id="exportInput" type="text"><input id="exportButton" title="Export|Generate a string code that represent your current item selection" type="button" value="Export">		<input id="importInput" type="text"><input id="importButton" title="Import|Import the string code which represent a certain item selection" type="button" value="Import">		<input id="saveInput" type="text"><input id="saveButton" title="Save To|Choose a name for your actual preset and save it" type="button" value="Save To">		';jq("#STB_Export").append(e)}function I(){if(jq("#filter-search-bar").val()=="Search")var e="";else var e=jq("#filter-search-bar").val();var t=jq(".filter-buttons.selected").attr("id");var n=jq('select[name="loomLevel"] option:selected').val();var r=jq('select[name="loomComparator"] option:selected').val();jq(".item").each(function(){if(jq(this).attr("name").toLowerCase().indexOf(e.toLowerCase())!=-1){if(t!="cat-1"){if(jq(this).attr("cat")!=t)jq(this).hide();else if(q(r,n,jq(this)))jq(this).show();else jq(this).hide()}else{if(q(r,n,jq(this)))jq(this).show();else jq(this).hide()}}else{jq(this).hide()}})}function q(e,t,n){if(e==">")if(n.attr("level")>t)return true;else return false;if(e==">=")if(n.attr("level")>=t)return true;else return false;if(e=="=")if(n.attr("level")==t)return true;else return false;if(e=="!=")if(n.attr("level")!=t)return true;else return false;if(e=="<=")if(n.attr("level")<=t)return true;else return false;if(e=="<")if(n.attr("level")<t)return true;else return false}function R(e){if(e){jq('input[name="transfer_do"]:last').after('				<input type="button" title="Select All|Every items in your inventory will be selected" value="Select All" name="select_all">				<input type="button" title="Unselect All|Every items in your inventory will be unselected" value="Unselect All" name="unselect_all">				<input type="button" title="Invert All|Every items you had not selected will become selected" value="Invert All" name="invert_all">				<input style="width:50px" type="text" name="split">%				<input type="button" title="Split|Every items in your inventory will be selected in the % amount you put in the box" value="Split" name="split_button">				')}else{jq('input[name="transfer_do"]:first').after('				<input type="button" title="Select All|Every items in your inventory will be selected" value="Select All" name="select_all">				<input type="button" title="Unselect All|Every items in your inventory will be unselected" value="Unselect All" name="unselect_all">				<input type="button" title="Invert All|Every items you had not selected will become selected" value="Invert All" name="invert_all">				<input style="width:50px" type="text" name="split">%				<input type="button" title="Split|Every items in your inventory will be selected in the % amount you put in the box" value="Split" name="split_button">				')}}function U(e){jq(e).each(function(){var e=jq(this).children(".desc").children();if(jq(this).attr("cat")!=""&&jq(this).css("display")!="none"){e.children("input").attr("value",0)}})}function z(e){jq(e).each(function(){var e=jq(this).children(".desc").children();if(jq(this).attr("cat")!=""&&jq(this).css("display")!="none"){e.children("input").attr("value",e.children(".setTotal").attr("count"))}})}function W(e){jq(e).each(function(){var e=jq(this).children(".desc").children();if(jq(this).attr("cat")!=""){e.children("input").val(e.children(".setTotal").attr("count")-e.children("input").val())}})}function X(){var e=jq('fieldset table[name="transfertable"]').length;return e}function V(e){if(e)var t=jq('fieldset table[name="transfertable"]:last');else var t=jq('fieldset table[name="transfertable"]:first');jq(t).parent().prepend('<div class="STB_CategoriesCount"><div></div><div></div><div></div><div></div></div><div class="clear"></div>');for(var n=0;n<c.length;n++){if(e)var r=c[n].countFief;else var r=c[n].countInv;var i='<div class="line" id="'+c[n].id+'"><img width="20" src="'+c[n].img+'" alt="'+c[n].name+' Icon" /> '+c[n].name+" ("+r+')<span class="current" val="'+r+'"></span> <span style="color:green;" class="plus"></span> <span style="color:red;" class="less"></span> <span style="color:orange;" class="total"></span></div>';if(n<4)t.parent().children(".STB_CategoriesCount").children("div:nth-child(1)").append(i);if(n>=4&&n<8)t.parent().children(".STB_CategoriesCount").children("div:nth-child(2)").append(i);if(n>=8&&n<12)t.parent().children(".STB_CategoriesCount").children("div:nth-child(3)").append(i);if(n>=12)t.parent().children(".STB_CategoriesCount").children("div:nth-child(4)").append(i)}}function J(e,t){jq(e).each(function(){var e=jq(this).children(".desc").children();if(jq(this).attr("cat")!=""){e.children("input").attr("value",Math.round(parseInt(e.children(".setTotal").attr("count"))*t/100))}})}function K(e,t){if(!e)var e="";if(!t)var t=[];jq('fieldset table[name="transfertable"]:first .item').each(function(){if(jq(this).children(".desc").children().children("input").val()!=0&&jq(this).children(".desc").children().children("input").val()!=""&&jq(this).attr("cat")!=""&&jq(this).attr("id")>=0){if(e)var n=[jq(this).attr("id"),jq(this).attr("level"),jq(this).children(".desc").children().children("input").val(),jq(this).children(".desc").children().children(".setTotal").attr("count"),e];else var n=[jq(this).attr("id"),jq(this).attr("level"),jq(this).children(".desc").children().children("input").val(),jq(this).children(".desc").children().children(".setTotal").attr("count")];t.push(n)}});return w(t)}function Q(e){var t=JSON.parse(e);jq.each(t,function(e,t){var n=jq('fieldset table[name="transfertable"]:first .item#'+t["0"]+'[level="'+t[1]+'"]');if(n.length>0||d){var r=parseInt(t[2])-parseInt(n.children(".desc").children().children(".setTotal").attr("count"));if(r<=0){n.children(".desc").children().children("input").attr("value",t[2])}else{if(d){var i=g(f,t[0]);var s=L(i.id);var o=_(i.id,t[1],i.name,t[2],t[2],s.id);jq('fieldset table[name="transfertable"]:first tbody').append(o)}else{alert("Missing "+r+" "+n.attr("name"));n.children(".desc").children().children("input").attr("value",n.children(".desc").children().children(".setTotal").attr("count"))}}}else{if(g(f,t[0]).name!==undefined)var u=g(f,t[0]).name;else var u=t[0]+" (unknown)";alert("Missing item : "+u)}})}function G(e){if(v(e)==""||v(e)>10)alert("Invalid preset name (null or too long)");else{if(K()=="[]")alert("Selection can't be null");else{if(S("STB_Preset")){x("STB_Preset",K(v(e),E(S("STB_Preset"))))}else x("STB_Preset",K(v(e)));jq("#presetList").append('<option value="'+v(e)+'">'+v(e)+"</option>")}}}function Y(){if(S("STB_Preset")){var e=E(S("STB_Preset"));var t="";jq.each(e,function(e,n){if(t!=n[4]){jq("#presetList").append('<option value="'+n[4]+'">'+n[4]+"</option>");t=n[4]}})}}function Z(e){if(S("STB_Preset")){var t=E(S("STB_Preset"));var n=[];jq.each(t,function(t,r){if(r[4]==e){var i=[r[0],r[1],r[2],r[3]];n.push(i)}});Q(w(n))}}function et(e){if(S("STB_Preset")){var t=E(S("STB_Preset"));var n=[];jq.each(t,function(t,r){if(r[4]!=e){n.push(r)}else{jq('#presetList option[value="'+e+'"]').remove()}});x("STB_Preset",w(n))}}function tt(){var e=X();var t=[];jq("fieldset table[name='transfertable']:first .item").each(function(){if(undefined===t[jq(this).attr("cat")])t[jq(this).attr("cat")]=jq(this).children(".desc").children().children("input").val();else t[jq(this).attr("cat")]=parseInt(t[jq(this).attr("cat")])+parseInt(jq(this).children(".desc").children().children("input").val())});jq.each(c,function(n,r){if(undefined===t[r.id])var i=0;else var i=t[r.id];jq(".STB_CategoriesCount:first #"+r.id+" span.less").text("-"+i);jq(".STB_CategoriesCount:first #"+r.id+" span.less").attr("val",i);if(e==2){jq(".STB_CategoriesCount:last #"+r.id+" span.plus").text("+"+i);jq(".STB_CategoriesCount:last #"+r.id+" span.plus").attr("val",i)}});if(e==2){t=[];jq("fieldset table[name='transfertable']:last .item").each(function(){if(undefined===t[jq(this).attr("cat")])t[jq(this).attr("cat")]=jq(this).children(".desc").children().children("input").val();else t[jq(this).attr("cat")]=parseInt(t[jq(this).attr("cat")])+parseInt(jq(this).children(".desc").children().children("input").val())});jq.each(c,function(e,n){if(undefined===t[n.id])var r=0;else var r=t[n.id];jq(".STB_CategoriesCount:last #"+n.id+" span.less").text("-"+r);jq(".STB_CategoriesCount:last #"+n.id+" span.less").attr("val",r);jq(".STB_CategoriesCount:first #"+n.id+" span.plus").text("+"+r);jq(".STB_CategoriesCount:first #"+n.id+" span.plus").attr("val",r)})}jq.each(c,function(t,n){if(e==2){var r=parseInt(jq(".STB_CategoriesCount:first #"+n.id+" span.current").attr("val"))+parseInt(jq(".STB_CategoriesCount:first #"+n.id+" span.plus").attr("val"))-parseInt(jq(".STB_CategoriesCount:first #"+n.id+" span.less").attr("val"));jq(".STB_CategoriesCount:first #"+n.id+" span.total").text("="+r);r=parseInt(jq(".STB_CategoriesCount:last #"+n.id+" span.current").attr("val"))+parseInt(jq(".STB_CategoriesCount:last #"+n.id+" span.plus").attr("val"))-parseInt(jq(".STB_CategoriesCount:last #"+n.id+" span.less").attr("val"));jq(".STB_CategoriesCount:last #"+n.id+" span.total").text("="+r)}else{var r=parseInt(jq(".STB_CategoriesCount:first #"+n.id+" span.current").attr("val"))-parseInt(jq(".STB_CategoriesCount:first #"+n.id+" span.less").attr("val"));jq(".STB_CategoriesCount:first #"+n.id+" span.total").text("="+r)}})}function nt(){d=true;jq("fieldset").append('<input style="display:none;" type="submit" value="Transfer" name="transfer_do"><table name="transfertable"><tbody></tbody></table>')}function rt(){jq(".item .setTotal").click(function(e){e.preventDefault();jq(this).parent().children("input").attr("value",jq(this).attr("count"));tt()});jq(".item .abutton").click(function(e){e.preventDefault();if(jq(this).children().attr("src")=="img/ic_minus.png")if(parseInt(jq(this).parent().children("input").val())-1>=0)jq(this).parent().children("input").val(parseInt(jq(this).parent().children("input").val())-1);else jq(this).parent().children("input").val(0);else jq(this).parent().children("input").val(parseInt(jq(this).parent().children("input").val())+1);tt()})}function it(){var e=[];jq("fieldset table[name='transfertable']:first .item").each(function(){if("Gold"!=jq(this).attr("name")&&"Troops"!=jq(this).attr("name")){var t=[jq(this).attr("id"),jq(this).attr("level"),jq(this).children(".desc").children().children(".setTotal").attr("count")];e.push(t)}});x("chyTempLoom",w(e))}function st(){if(null!==S("chyTempLoom")){var e=E(S("chyTempLoom"));jq("fieldset table[name='transfertable']:last .item").each(function(){var t=jq(this).attr("id");var n=jq(this).children(".desc").children().children(".setTotal").attr("count");var r=false;var i=jq(this);var s;jq.each(e,function(e,i){if(t==i[0]){if(n==i[2]){r=true;s=i[1]}}});if(r){if(0<t){var o=m(i.children(".desc").children().children("input").attr("name"),"[","]");if(0==g(h,o)){ct(o,s);i.attr("level",s);i.children().children().attr("src","loadimage.php?id="+t+"&lvl="+s);i.children().children().attr("rel","itemstats.php?i="+t+"&m="+s)}else{var u=g(h,o);if(u.level!=s){u.level=s;i.attr("level",s);i.children().children().attr("src","loadimage.php?id="+t+"&lvl="+s);i.children().children().attr("rel","itemstats.php?i="+t+"&m="+s)}}}}})}}function ot(){jq("fieldset table[name='transfertable']:last .item").each(function(){var e=m(jq(this).children(".desc").children().children("input").attr("name"),"[","]");var t=jq(this).attr("id");var n=jq(this).children(".desc").children().children(".setTotal").attr("count");var r=false;var i=jq(this);var s;jq.each(h,function(n,r){if(e==r.id){i.attr("level",r.level);i.children().children().attr("src","loadimage.php?id="+t+"&lvl="+r.level);i.children().children().attr("rel","itemstats.php?i="+t+"&m="+r.level)}})})}function ut(){jq('input[name="allowTransfer"]').attr("title","Allow incoming Transfer for 60 minutes|Allow players not inside your faction to transfer any items to you for one hour");jq('input[name="changeSleepTime"]').attr("title","Save|Save the nighttime setting, which is the time when battles cant take place if you are attacked");jq('input[name="goods[do]"]').attr("title","Buy Goods!|Buy the selected amount of goods and transfers it in your inventory");jq('input[value="Change Troop Cap"]').attr("title","Change Troop Cap|Increase/decrease your maximum number of troops; you automatically recruit troops up to that cap");jq('a[href="stuck.php"]').attr("title","Zoom|Click to see your exact position on the strategus map, pixel per pixel");$('input[name="allowTransfer"]').cluetip({splitTitle:"|"});$('input[name="changeSleepTime"]').cluetip({splitTitle:"|"});$('input[name="goods[do]"]').cluetip({splitTitle:"|"});$('input[value="Change Troop Cap"]').cluetip({splitTitle:"|"});$('a[href="stuck.php"]').cluetip({splitTitle:"|"});$("#STB_Export input[type=button]").cluetip({splitTitle:"|"});$("fieldset input[type=button]").cluetip({splitTitle:"|"});$('fieldset table[name="transfertable"] .item .header img').cluetip()}function at(e,t){var n={id:e,name:t};f.push(n)}function ft(e,t,n){if(!n)n=0;var r={id:e,idItem:t,level:n};l.push(r)}function lt(e,t,n,r){var i={id:e,img:t,name:n,items:r,countInv:0,countFief:0,addCount:function(e,t){if(t){i.countFief+=parseInt(e)}else{i.countInv+=parseInt(e)}}};c.push(i)}function ct(e,t){var n={id:e,level:t};h.push(n)}const e="rgba(0, 100, 0, 0.2)";const t="rgba(100, 0, 0, 0.2)";const n="rgba(0, 0, 0, 0.2)";const r="rgba(0, 0, 0, 0.5)";const i="http://i.imgur.com/lzkgfYe.png";const s="http://i.imgur.com/GsvcGtg.png";const o="http://i.imgur.com/o5WoZPb.png";const u="http://i.imgur.com/TSKPuy0.png";const a="http://i.imgur.com/k5t4Gi2.png";var f=[];var l=[];var c=[];var h=[];var p={};var d=false;(function(e,t){function h(e){return e&&e.toLowerCase?e.toLowerCase():e}function p(e,t){for(var r=0,i=e.length;r<i;r++){if(e[r]==t){return!n}}return n}var n=!1,r=null,i=parseFloat,s=Math.min,o=/(-?\d+\.?\d*)$/g,u=/(\d+\.?\d*)$/g,a=[],f=[],l=function(e){return typeof e=="string"},c=Array.prototype.indexOf||function(e){var t=this.length,n=Number(arguments[1])||0;n=n<0?Math.ceil(n):Math.floor(n);if(n<0){n+=t}for(;n<t;n++){if(n in this&&this[n]===e){return n}}return-1};e.tinysort={id:"TinySort",version:"1.5.2",copyright:"Copyright (c) 2008-2013 Ron Valstar",uri:"http://tinysort.sjeiti.com/",licensed:{MIT:"http://www.opensource.org/licenses/mit-license.php",GPL:"http://www.gnu.org/licenses/gpl.html"},plugin:function(){var e=function(e,t){a.push(e);f.push(t)};e.indexOf=c;return e}(),defaults:{order:"asc",attr:r,data:r,useVal:n,place:"start",returns:n,cases:n,forceStrings:n,ignoreDashes:n,sortFunction:r}};e.fn.extend({tinysort:function(){var d,v,m=this,g=[],y=[],b=[],w=[],E=0,S,x=[],T=[],N=function(t){e.each(a,function(e,n){n.call(n,t)})},C=function(t,r){var s=0;if(E!==0){E=0}while(s===0&&E<S){var a=w[E],c=a.oSettings,p=c.ignoreDashes?u:o;N(c);if(c.sortFunction){s=c.sortFunction(t,r)}else{if(c.order=="rand"){s=Math.random()<.5?1:-1}else{var d=n,v=!c.cases?h(t.s[E]):t.s[E],m=!c.cases?h(r.s[E]):r.s[E];if(!A.forceStrings){var g=l(v)?v&&v.match(p):n,y=l(m)?m&&m.match(p):n;if(g&&y){var b=v.substr(0,v.length-g[0].length),x=m.substr(0,m.length-y[0].length);if(b==x){d=!n;v=i(g[0]);m=i(y[0])}}}s=a.iAsc*(v<m?-1:v>m?1:0)}}e.each(f,function(e,t){s=t.call(t,d,v,m,s)});if(s===0){E++}}return s};for(d=0,v=arguments.length;d<v;d++){var k=arguments[d];if(l(k)){if(x.push(k)-1>T.length){T.length=x.length-1}}else{if(T.push(k)>x.length){x.length=T.length}}}if(x.length>T.length){T.length=x.length}S=x.length;if(S===0){S=x.length=1;T.push({})}for(d=0,v=S;d<v;d++){var L=x[d],A=e.extend({},e.tinysort.defaults,T[d]),O=!(!L||L==""),M=O&&L[0]==":";w.push({sFind:L,oSettings:A,bFind:O,bAttr:!(A.attr===r||A.attr==""),bData:A.data!==r,bFilter:M,$Filter:M?m.filter(L):m,fnSort:A.sortFunction,iAsc:A.order=="asc"?1:-1})}m.each(function(n,r){var i=e(r),s=i.parent().get(0),o,u=[];for(j=0;j<S;j++){var a=w[j],f=a.bFind?a.bFilter?a.$Filter.filter(r):i.find(a.sFind):i;u.push(a.bData?f.data(a.oSettings.data):a.bAttr?f.attr(a.oSettings.attr):a.oSettings.useVal?f.val():f.text());if(o===t){o=f}}var l=c.call(b,s);if(l<0){l=b.push(s)-1;y[l]={s:[],n:[]}}if(o.length>0){y[l].s.push({s:u,e:i,n:n})}else{y[l].n.push({e:i,n:n})}});e.each(y,function(e,t){t.s.sort(C)});e.each(y,function(t,r){var i=r.s.length,o=[],u=i,a=[0,0];switch(A.place){case"first":e.each(r.s,function(e,t){u=s(u,t.n)});break;case"org":e.each(r.s,function(e,t){o.push(t.n)});break;case"end":u=r.n.length;break;default:u=0}for(d=0;d<i;d++){var f=p(o,d)?!n:d>=u&&d<u+r.s.length,l=(f?r.s:r.n)[a[f?0:1]].e;l.parent().append(l);if(f||!A.returns){g.push(l.get(0))}a[f?0:1]++}});m.length=0;Array.prototype.push.apply(m,g);return m}});e.fn.TinySort=e.fn.Tinysort=e.fn.tsort=e.fn.tinysort})(jQuery);jq(document).ready(function(){if(N()){if(null!==S("chyItemsString"))f=E(S("chyItemsString"));if(null!==S("chyPlayerItemsString"))l=E(S("chyPlayerItemsString"));A();x("chyItemsString",w(f));x("chyPlayerItemsString",w(l))}if(C()){var e=X();if(e==0){nt()}D();k();B();R();F();Y();f=E(S("chyItemsString"));l=E(S("chyPlayerItemsString"));O();V();if(e==2){O(true);R(true);V(true)}rt();if(null!==S("chyFiefItems")){h=E(S("chyFiefItems"));ot()}st();x("chyFiefItems",w(h));it();P();H();ut();jq(".filter-buttons").click(function(){jq(".filter-buttons").each(function(){jq(this).removeClass("selected");jq(this).css({"background-color":"transparent"})});jq(this).css({"background-color":r});jq(this).addClass("selected");I()});jq(".filter-buttons").hover(function(){if(jq(this).attr("class")!="filter-buttons selected")jq(this).css({"background-color":n})},function(){if(jq(this).attr("class")!="filter-buttons selected")jq(this).css({"background-color":"transparent"})});jq("#filter-search-bar").keyup(function(){I()});jq('select[name="loomComparator"]').change(function(){I()});jq('select[name="loomLevel"]').change(function(){I()});jq('input[name="select_all"]').click(function(e){e.preventDefault();z(jq(this).parent().children("table").children().children(".item"));tt()});jq('input[name="unselect_all"]').click(function(e){e.preventDefault();U(jq(this).parent().children("table").children().children(".item"));tt()});jq('input[name="invert_all"]').click(function(e){e.preventDefault();W(jq(this).parent().children("table").children().children(".item"));tt()});jq('input[name="split_button"]').click(function(e){e.preventDefault();J(jq(this).parent().children("table").children().children(".item"),jq(this).parent().children('input[name="split"]').val());tt()});jq("#exportButton").click(function(e){e.preventDefault();jq("#exportInput").attr("value",K())});jq("#importButton").click(function(e){e.preventDefault();Q(jq("#importInput").val());H();$('fieldset table[name="transfertable"]:first .item .header img').cluetip();rt();tt()});jq("#saveButton").click(function(e){e.preventDefault();G(jq("#saveInput").val())});jq("#presetButton").click(function(e){e.preventDefault();Z(jq("#presetList").val());H();$('fieldset table[name="transfertable"]:first .item .header img').cluetip();rt();tt()});jq("#deletePresetButton").click(function(e){e.preventDefault();et(jq("#presetList").val())});jq(".item .in").keyup(function(){tt()});jq(".clear").css({clear:"both"});jq(".filter-buttons").css({cursor:"pointer","padding-right":"15px","padding-left":"15px"});jq(".STB_CategoriesCount").css({"margin-bottom":"50px"});jq(".STB_CategoriesCount div").css({display:"block","float":"left"});jq(".STB_CategoriesCount .line").css({width:"300px",display:"table"})}})}addJQuery(main)