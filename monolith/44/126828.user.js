// ==UserScript==
// @id             ASfGM
// @name           Auto Google Music Share
// @version        1.20
// @namespace      simon
// @author         Simon Chan
// @description    Share what you're listening to Google+.
// @match          https://play.google.com/music/*
// @match          https://plus.google.com/*
// @run-at         document-end
// ==/UserScript==
var d = document, formatText, GplusPost; if (d.location.host == "play.google.com" && !window.frameElement) { var classNames = { menu: "song-menu" }, cNs = classNames, aC = "appendChild", aE = "addEventListener", cE = "createElement", cL = "classList", cN = "className", ds = "display", eC = "getElementsByClassName", eI = "getElementById", MO = window.MutationObserver || window.WebKitMutationObserver || window.MozMutationObserver, s = "style", sA = "setAttribute"; function DOMInsertedEventHandler(n) { return function (t) { t.forEach(function (t) { t.addedNodes.length == 1 && n(t.addedNodes[0]) }) } } new MO(DOMInsertedEventHandler(function (n) { var i, e; if (n[cL].contains(cNs.menu)) { i = d[cE]("div"), i[cN] = "goog-menuitem", i[sA]("role", "memuitem"), i[sA]("style", "-webkit-user-select: none;"), i[aE]("mouseover", function () { i[cL].add("goog-menuitem-highlight") }, !0), i[aE]("mouseout", function () { i[cL].remove("goog-menuitem-highlight") }, !0); function a(n, t) { return n && n != "" && (!n.match || n.match(/\S*/)) ? t + n : "" } var t, f, r, u, l = 0, h = 0, c = 0, o = 0; function v() { t[s].left = (c = (innerWidth - t.clientWidth) / 2) + "px", t[s].top = (o = (innerHeight - t.clientHeight) / 2) + "px" } i[aE]("click", function () { var i, e; if (!t) { function p(n) { t[s].left = (c = Math.max(0, Math.min(c + n.clientX - l, innerWidth - t.clientWidth))) + "px", t[s].top = (o = Math.max(0, Math.min(o + n.clientY - h, innerHeight - t.clientHeight))) + "px", l = n.clientX, h = n.clientY } function y() { d.removeEventListener("mousemove", p, !1), d.removeEventListener("mouseup", y, !1) } t = d[eC]("modal-dialog")[0].cloneNode(!0), i = t[eC]("modal-dialog-title-text")[0], i.textContent = "Share now playing", i[aE]("mousedown", function (n) { n.button == 0 && (d[aE]("mousemove", p, !1), d[aE]("mouseup", y, !1), l = n.clientX, h = n.clientY) }, !1), t.querySelector('button[name="cancel"]')[aE]("click", function () { f[s][ds] = t[s][ds] = "none" }, !1), u = t[eC]("goog-buttonset-default")[0], u.name = "share", u.textContent = "Share", u[aE]("click", function () { GplusPost(r.value), f[s][ds] = t[s][ds] = "none" }, !1), e = t[eC]("modal-dialog-content")[0], e.innerHTML = "", r = d.createElement("textarea"), r[s].width = "300px", r[s].height = "100px", e[aC](r), d.body[aC](t), f = d[eC]("modal-dialog-bg")[0], f[s].width = "100%", f[s].height = "100%" } d[eC](cNs.menu)[0][s][ds] = "none", GM_xmlhttpRequest({ method: "POST", url: "https://play.google.com/music/services/loadalltracks?u=0&" + d.cookie.match(/xt=[^;]*/)[0], onload: function (n) { var i = eval("(" + n.responseText + ")"), f = d[eI]("playerSongTitle").childNodes[0].innerHTML, t; for (t in i.playlist) if (i.playlist[t].title == f) { formatText = "#NowPlaying \n" + i.playlist[t].artist + " - " + i.playlist[t].title + a(i.playlist[t].album, "\n *Album:* ") + a(i.playlist[t].genre, "\n *Genre:* ") + a(i.playlist[t].year, "\n *Year:* ") + function () { return i.playlist[t].totalTracks == "0" ? "" : "\n *Track #* " + i.playlist[t].track + "/" + i.playlist[t].totalTracks }(), formatText = formatText.replace(/-([^\s][^-]*[^\s])-/g, "- $1 -").replace(/-([^\s][^-]*[^\s])-/g, "- $1 -"), r.value = formatText, u.disabled = !1; break } u.disabled && (r.value = "Error getting now playing data.") }, onerror: function () { r.value = "Error getting now playing data." } }), f[s][ds] = t[s][ds] = "block", v(), r.value = "loading...", u.disabled = !0 }, !1), e = d[cE]("div"), e[cN] = "goog-menuitem-content", e[sA]("style", "-webkit-user-select: none;"), e.innerHTML = "Share now playing", i[aC](e), n[aC](i) } })).observe(d.body, { childList: !0 }), formatText = "", GplusPost = function (n) { GM_xmlhttpRequest({ method: "GET", url: "https://plus.google.com/", onload: function (t) { function u(n) { for (var i = [], t = 0; t < n; t++) i.push(null); return i } var f = t.responseText.match(/AObGSA.*:\d+/), r = t.responseText.match(/oid=\"(\d+)\"/)[1], i = u(38); i[0] = n, i[1] = "oz:" + r + "." + (+new Date).toString(16) + ".0", i[6] = "[]", i[9] = !0, i[10] = i[14] = i[36] = [], i[11] = i[12] = i[16] = i[27] = i[28] = i[29] = !1, i[37] = [[[null, null, 1]]], GM_xmlhttpRequest({ method: "POST", url: "https://plus.google.com/_/sharebox/post/?spam=20&rt=j&_reqid=" + +new Date % 1e6, headers: { "Content-Type": "application/x-www-form-urlencoded;charset=utf-8" }, data: "f.req=" + encodeURIComponent(JSON.stringify(i)) + "&at=" + encodeURIComponent(f) }) } }) } }