// ==UserScript==
// @name        deviantINFO
// @namespace   Xevious
// @description Display informations about Deviant user when moving over an avatar.
// @include     http://*.deviantart.com/*
// @include     https://*.deviantart.com/*
// @exclude     http://chat.deviantart.com/chat/*
// @require     http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js
// @version     2.0
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_xmlhttpRequest
// @icon        http://fc01.deviantart.net/fs71/f/2012/042/3/e/icon_by_xeviousss-d4pdae9.png
// ==/UserScript==

!function(a){function o(){return"custom"===d.style?d.css:n[d.style]}function p(){return a('<div id="tooltipAva-container"><div id="tooltipAva"><div id="tooltipAva-firstCol">'+d.display.map(function(a){return(d.display.indexOf(a)===Math.ceil(d.display.length/2)?'</div><div id="tooltipAva-secondCol">':"")+'<span class="tooltipAva-item"><strong class="tooltipAva-label">'+b[a]+'</strong><span class="tooltipAva-result"></span></span>'}).join("")+"</div>"+'<div id="tooltipAva-status"></div>'+"</div>"+'<div id="tooltipAva-arrow"></div>'+"</div>")}function q(a,b){var c=a.attr("title"),d=a.offset();h.reset(c),void 0===i[c]?r(c):s(i[c]),j=setTimeout(function(){var a,b,c,f,g,i=h.form.outerWidth(),j=h.form.outerHeight(),k=h.arrow.outerHeight(),m=h.arrow.outerWidth();d.top-e.scrollTop()<j+k?(a=d.top+l+k,g="top-",c=-k):(a=d.top-j-k,g="bottom-",c=j),d.left-e.scrollLeft()+i>e.width()?(b=d.left-i+l,f=i-(l-m),g+="right"):(b=d.left,f=(l-m)/2,g+="left"),h.arrow.attr("class",g).css({top:c,left:f}),h.form.css({opacity:1,top:a,left:b}).stop().fadeIn(200)},b)}function r(b){var c={};k=GM_xmlhttpRequest({method:"GET",url:"http://www."+b+".deviantart.com/",onload:function(d){var e=0,f=a(d.responseText),g=f.find("#super-secret-stats").find("strong");c.deviations=g.eq(e).text().trim(),c.comments=g.eq(e+1).text().trim(),8===g.length?c.pageviews=g.eq(e+2).text().trim():(e--,c.pageviews="Blind to PV"),c.watchers=g.eq(e+4).text().trim(),c.favourites=g.eq(e+7).text().trim();var h=f.find("#super-secret-why").find(".h").not(".oobehide");c.asl=h.eq(2).text(),c.birthday=h.eq(4).text();var j=f.find("#super-secret-activity").find("strong").text();switch(j){case"Online Now":c.status="online",c.lastVisit="Online";break;case"Last Visit Unknown":c.status="invisibl",c.lastVisit="Invisible";break;case"Online (idling)":c.status="idle",c.lastVisit="Online (idling)";break;default:c.status="ago",c.lastVisit=j.substr(11).trim()}var k=/\((\d+)\)/.exec(f.find("#gmi-GBadge").attr("title"));c.badges=null!==k?k[1]:"-",i[b]=c,s(c)}})}function s(a){h.span.text(function(b){return a[d.display[b]]}),h.status.attr("class",a.status)}function y(){if("https://www.deviantart.com/settings/browsing"===location.href.substr(0,44)){a(".settings_form").children().append(F()),t=a("#settings-deviantINFO"),u=a("#cssForm-deviantINFO"),a("#delay-deviantINFO").val(d.delay),a('input[name="show-deviantINFO"]',t).val(d.display),a('input[name="style-deviantINFO"]',t).val([d.style]).change(z).next().addBack().click(A),z(),a("#saveSettings-deviantINFO").click(E);var b=h.arrow.outerHeight(),c=h.arrow.outerWidth(),g=t.closest(".fooview-inner");x={top:t.offset().top,left:g.offset().left+g.outerWidth()+20},v=a('<img style="position: absolute; top: '+x.top+"px; left: "+x.left+'px;" title="Sample" src="http://a.deviantart.net/avatars/x/e/xeviousss.png?7">').appendTo(f),h.arrow.css({top:-b,left:(l-c)/2}).attr("class","top-left"),h.form.css({opacity:1,top:x.top+l+b,left:x.left,display:"block"}).children("#tooltipAva").html(B),e.scroll(D),t.find("input, textarea").on("input change",function(){C()})}}function z(){u.toggle("custom"===a('input[name="style-deviantINFO"]:checked',t).val())}function A(a){a.ctrlKey&&(a.preventDefault(),u.val(n[this.value||this.previousSibling.value].replace(/([{;}])/g,"$1\n")),C())}function B(){var a={pageviews:"1337",deviations:"42",comments:"777",favourites:"11235",asl:"23/Male",watchers:"117",badges:"314",lastVisit:"2 days ago"};return'<div id="tooltipAva-firstCol">'+d.display.map(function(c){return(d.display.indexOf(c)===Math.ceil(d.display.length/2)?'</div><div id="tooltipAva-secondCol">':"")+'<span class="tooltipAva-item"><strong class="tooltipAva-label">'+b[c]+'</strong><span class="tooltipAva-result">'+a[c]+"</span></span>"}).join("")+"</div>"+'<div id="tooltipAva-status" class="ago"></div>'}function C(){d.display=a("input[name=show-deviantINFO]:checked").map(function(){return this.value}).get(),d.style=a("input[name=style-deviantINFO]:checked",t).val(),d.delay=a("#delay-deviantINFO").val(),d.css=u.val(),g.remove(),g=a('<style type="text/css">'+("custom"===d.style?d.css:n[d.style])+"</style>").appendTo("head"),h.form.css({position:"absolute",top:x.top+l+h.arrow.outerHeight()}),h.arrow.css("top",-h.arrow.outerHeight()),h.form.children("#tooltipAva").html(B)}function D(){var a=h.arrow.outerHeight();!w&&t.offset().top-e.scrollTop()<=50?(v.css({position:"fixed",top:50}),h.form.css({position:"fixed",top:l+50+a}),w=!0):w&&t.offset().top-e.scrollTop()>50&&(v.css({position:"absolute",top:x.top}),h.form.css({position:"absolute",top:x.top+l+a}),w=!1)}function E(b){b.preventDefault(),a("#savedThumbMenuu").css({opacity:0,display:"block",marginTop:0}).animate({opacity:1,marginTop:"-10px"},150).delay(2e3).fadeOut(200),d.save()}function F(){return'<div class="fooview ch"><div class="fooview-inner"><h3>deviantINFO</h3><div class="altaltview altaltview-wider-2" id="settings-deviantINFO"><p class="morespace"><label class="l" for="delay-deviantINFO">Delay</label><input class="itext_uplifted" name="delay-deviantINFO" id="delay-deviantINFO" style="width: 20%;" type="text"><small> ms before tooltip. Default is 200.</small></p><p><label class="l" for="show-deviantINFO">Show</label><div style="display: table"><div style="display: table-cell; padding-right: 20px;"><input type="checkbox" class="icheckbox" name="show-deviantINFO" id="show-pageviews" value="pageviews" /><label class="l_inline" for="show-pageviews">Pageviews</label><br/><input type="checkbox" class="icheckbox" name="show-deviantINFO" id="show-deviations" value="deviations" /><label class="l_inline" for="show-deviations">Deviations</label><br/><input type="checkbox" class="icheckbox" name="show-deviantINFO" id="show-comments" value="comments" /><label class="l_inline" for="show-comments">Comments</label><br/><input type="checkbox" class="icheckbox" name="show-deviantINFO" id="show-favourites" value="favourites" /><label class="l_inline" for="show-favourites">Favourites</label><br/></div><div style="display: table-cell"><input type="checkbox" class="icheckbox" name="show-deviantINFO" id="show-asl" value="asl" /><label class="l_inline" for="show-asl">Age/sex/location</label><br/><input type="checkbox" class="icheckbox" name="show-deviantINFO" id="show-watchers" value="watchers" /><label class="l_inline" for="show-watchers">Watchers</label><br/><input type="checkbox" class="icheckbox" name="show-deviantINFO" id="show-badges" value="badges" /><label class="l_inline" for="show-badges">Badges</label><br/><input type="checkbox" class="icheckbox" name="show-deviantINFO" id="show-lastVisit" value="lastVisit" /><label class="l_inline" for="show-lastVisit">Last visit</label><br/></div></div></p><p><label class="l" for="style-deviantINFO"><span class="upsell-label" data-quicktip-title="Ctrl + click to load premade styles into the textarea." data-quicktip-text="That will replace the current custom style." onmouseover="window.QuickTip && QuickTip.show(this, \'subby\')">Style</span></label><input type="radio" name="style-deviantINFO" value="deviant" id="style-deviant"><label class="l_inline" for="style-deviant">Deviant </label><input type="radio" name="style-deviantINFO" value="modernDA" id="style-modernDA"><label class="l_inline" for="style-modernDA">Modern DA </label><input type="radio" name="style-deviantINFO" value="minimark" id="style-minimark"><label class="l_inline" for="style-minimark">Minimark </label><br/><input type="radio" name="style-deviantINFO" value="custom" id="style-custom"><label class="l_inline" for="style-custom">Custom </label><br/><textarea style="display: none; width: 370px; height: 600px;" id="cssForm-deviantINFO" class="itext_uplifted">'+d.css+"</textarea>"+"</p>"+"</div>"+'<div id="savedThumbMenuu" style="display: none; position: absolute; right: 45px; padding: 5px; font-size: 10px; background-color: #3C4441; color: #afc81c; z-index: 800">saved!</div>'+'<div class="buttons ch hh">'+'<div style="text-align:right" class="rr">'+'<a href="#" class="smbutton smbutton-green" id="saveSettings-deviantINFO"><span>Save</span></a>'+"</div>"+"</div>"+"</div>"+"</div>"}var f,g,h,j,k,b={pageviews:"Pageviews",deviations:"Deviations",comments:"Comments",favourites:"Favourites",asl:"asl",watchers:"Watchers",badges:"Badges",lastVisit:"Last visit"},c={display:["pageviews","deviations","comments","favourites","asl","watchers","badges","lastVisit"],style:"deviant",css:"",delay:200,save:function(){GM_setValue("settingsDeviantINFO",JSON.stringify(d))}},d=a.extend({},c,JSON.parse(GM_getValue("settingsDeviantINFO")||"{}")),e=a(window),i=[],l=50,m=function(){var b=this;this.form=p().appendTo(f),this.span=this.form.find(".tooltipAva-result"),this.arrow=this.form.find("#tooltipAva-arrow"),this.status=this.form.find("#tooltipAva-status"),this.show=function(b){q(a(b.target),d.delay)},this.hide=function(){clearTimeout(j),j=null,k.abort(),b.form.stop().fadeOut(200)},this.reset=function(a){this.span.empty(),this.status.attr("class","default"),-1!==d.display.indexOf("asl")&&this.form.find("strong").eq(d.display.indexOf("asl")).text(a)}};a(function(){f=a("body"),g=a('<style type="text/css">'+o()+"</style>").appendTo("head"),h=new m,y(),f.on({mouseenter:h.show,mouseleave:h.hide},"img.avatar:not(.group)")});var t,u,v,x,n={deviant:"#tooltipAva-container { display: none; position: absolute; z-index: 990;}#tooltipAva { background-color: #283232; color: #EAF2EE; font-size: 10px; padding-right: 12px; display: table;}#tooltipAva-firstCol, #tooltipAva-secondCol { background-color: #3C4441; display: table-cell; padding: .5em;}.tooltipAva-result, .tooltipAva-label { display: block; line-height: 12px; height: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 110px;}.tooltipAva-label { color: #afc81c;}#tooltipAva-status { position: absolute; width: 6px; height: 6px; top: 4px; right: 3px; box-shadow: 0 0 1px #222, 0 -1px rgba(0,0,0,.5) inset, 0 1px 1px rgba(255,255,255,.5) inset;}#tooltipAva-status.default { background-color: #3C4441;}#tooltipAva-status.online { background-color: #2DBE00;}#tooltipAva-status.invisibl { background-color: #bbb;}#tooltipAva-status.idle { background-color: #E0DD1B;}#tooltipAva-status.ago { background-color: #0b99fe;}#tooltipAva-arrow { width: 0; height: 0; position: absolute; border-style: solid; border-width: 8px 8px 0 8px; border-color: #3C4441 transparent;}#tooltipAva-arrow.top-right, #tooltipAva-arrow.top-left { border-width: 0 8px 8px 8px;}#tooltipAva-arrow.bottom-right, #tooltipAva-arrow.bottom-left { border-width: 8px 8px 0 8px;}",modernDA:"#tooltipAva-container { display: none; position: absolute; z-index: 990;}#tooltipAva { background-color: #fff; color: #555; font-size: 10px; padding-left: 12px; display: table;}#tooltipAva-firstCol, #tooltipAva-secondCol { display: table-cell; padding: 4px 7px;}.tooltipAva-result, .tooltipAva-label { display: block; height: 12px; line-height: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-family: Segoe UI; max-width: 110px;}.tooltipAva-label { color: #444; text-transform:uppercase;}#tooltipAva-status { position: absolute; width: 12px; height:100%; top: 0; left: 0; background-color:#dedede;}#tooltipAva-status.default { background-color: #dedede;}#tooltipAva-status.online { background-color: #7ad736;}#tooltipAva-status.invisibl { background-color: #ccc;}#tooltipAva-status.idle { background-color: #fc7f00;}#tooltipAva-status.ago { background-color: #0b99fe;}#tooltipAva-arrow { width: 0; height: 0; position: absolute; border-width: 0 8px 8px 8px; border-style: solid; border-color: #fff transparent;}#tooltipAva-arrow.top-right, #tooltipAva-arrow.top-left { border-width: 0 8px 8px 8px;}#tooltipAva-arrow.bottom-right, #tooltipAva-arrow.bottom-left { border-width: 8px 8px 0 8px;}",minimark:'#tooltipAva-container { display: none; position: absolute; z-index: 990;}#tooltipAva { background-color: #000; color: #ccc; font-size: 10px; display: table;}#tooltipAva-firstCol, #tooltipAva-secondCol { display: table-cell; padding: 4px 7px;}.tooltipAva-result, .tooltipAva-label { height: 12px; line-height: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 110px;}.tooltipAva-result:after{ content: ""; display: block;}.tooltipAva-label { margin-right: 2px; color: #666;}#tooltipAva-status { position: absolute; display: none;}#tooltipAva-arrow { width: 0; height: 0; position: absolute; border-width: 0 4px 4px 0; border-style: solid; border-color: #000 transparent;}#tooltipAva-arrow.top-right, #tooltipAva-arrow.top-left { border-width: 0 4px 4px 0;}#tooltipAva-arrow.bottom-right, #tooltipAva-arrow.bottom-left { border-width: 4px 4px 0 0;}'},w=!1}(jQuery);