// Generated by CoffeeScript 1.3.3

/*
// ==UserScript==
// @name          diumoo helper
// @namespace     http://notimportant.org
// @require       http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.js
// @description   diumoo helper for browsers
// @copyright     2012, Sean Lee (http://notimportant.org/)
// @author        Sean Lee
// @include       http://music.douban.com/*
// @include       http://movie.douban.com/*
// @include       http://site.douban.com/*
// @version       0.1
// ==/UserScript==
*/


(function() {
  var Application, ICON_SRC, PLAYDIUMOO_GRAY_SRC, PLAYDIUMOO_SRC, SCHEME, albumButtonTemplate, albumLinkTemplate, albumTemplate, app, buttonTemplate, getLink, musicianButtonTemplate, musicianLinkTemplate, soundtrackLinkTemplate;

  if (window !== window.top) {
    return false;
  }

  SCHEME = "diumoo";

  ICON_SRC = "http://diumoo.github.com/favicon.ico";

  PLAYDIUMOO_SRC = "http://diumoo.net/static/playindiumoo.png";

  PLAYDIUMOO_GRAY_SRC = "http://diumoo.net/static/playindiumoo-gray.png";

  getLink = function(type, id) {
    return "" + SCHEME + "://" + type + "?key=" + id;
  };

  musicianLinkTemplate = function(musician_id) {
    return "<a class='diumoo-link' href=" + (getLink("musician", musician_id)) + ">diumoo</a>";
  };

  musicianButtonTemplate = function(musician_id) {
    return "<a class='diumoo_button' id='diumoo_musician_button' title='去diumoo收听'" + ("href=" + (getLink("musician", musician_id)) + ">") + "</a>";
  };

  albumButtonTemplate = function(album_id) {
    return "<a class='diumoo_button album'   title='去diumoo收听'" + ("href=" + (getLink("album", album_id)) + ">") + "</a>";
  };

  soundtrackLinkTemplate = function(movie_id) {
    return "<br><a href=" + (getLink("soundtrack", movie_id)) + ">去diumoo收听</a>";
  };

  albumLinkTemplate = function(album_id) {
    return "<a class='diumoo-link' href=" + (getLink("album", album_id)) + ">diumoo</a>";
  };

  albumTemplate = function(album_id, album_name) {
    return "<div class='infobox''>" + "<div class='ex1'><span></span></div>" + "<div class='bd'>" + "<div id='diumoo-notification'>" + ("<p>去diumoo收听 「<a href=" + (getLink("album", album_id)) + ">" + album_name + "</a>」<p>") + "</div></div>" + "<div class='ex2'><span></span></div></div>";
  };

  buttonTemplate = function(album_id) {
    return ("<a class='diumoo-icon' href='" + (getLink("album", album_id)) + "'>") + ("<img src='" + ICON_SRC + "'/>") + "</a>";
  };

  Application = (function() {

    function Application() {
      var $icon;
      this.host = window.location.host;
      this.url = window.location.href;
      this.junks = this.url.split('/');
      this.type = this.getType();
      if (this.type == null) {
        return;
      }
      switch (this.type) {
        case 'subject':
          this.injectSubjectView();
          break;
        case "doulist":
        case "tag":
        case "search":
        case "recommended":
          this.injectButtonView('div.pl2 a.start_radio');
          this.injectMusicianButtonView();
          break;
        case 'musician':
          this.injectMusicianView();
          break;
        case 'movie':
          this.injectSoundtrackView();
      }
      $icon = $('a.diumoo-icon');
      $icon.hover(function() {
        return $(this).css('background', 'white');
      });
      $icon.css('margin-left', '3px').find("img").css('width', '14px');
      $('a.diumoo-link').css({
        "margin-left": "6px"
      });
    }

    Application.prototype.getType = function() {
      var first_path, host;
      host = this.host.split('.')[0];
      if (host === "site" || host === "movie") {
        return host;
      }
      first_path = this.junks[3];
      if (first_path === 'subject' || first_path === 'tag' || first_path === 'musician' || first_path === 'people' || first_path === 'doulist') {
        return first_path;
      }
      if (this.url === "http://music.douban.com/") {
        return "home";
      } else if (first_path.slice(0, 4) === "mine") {
        return "mine";
      } else if (first_path.slice(0, 14) === "subject_search" || first_path === "search") {
        return "search";
      } else if (first_path.slice(0, 12) === "recommended") {
        return "recommended";
      }
    };

    Application.prototype.injectSubjectView = function() {
      var $album_view, album_html, album_id, album_name, start_radio_button;
      if ($('.olts').length === 0) {
        return;
      }
      album_id = this.junks[4];
      start_radio_button = $('.start_radio');
      if (start_radio_button.length !== 0) {
        start_radio_button.find('a').after(albumLinkTemplate(album_id));
      } else {
        album_name = $('h1 span').text();
        album_html = albumTemplate(album_id, album_name);
      }
      $album_view = $('#diumoo-notification');
      $album_view.css({
        "margin": "0",
        "padding": "0"
      });
      return $album_view.find('p').css({
        "line-height": "2.2em",
        "margin": "0"
      });
    };

    Application.prototype.injectMusicianView = function() {
      var $musician_link, musician_html, musician_id;
      $musician_link = $('.start_radio');
      if ($musician_link.length === 0) {
        return;
      }
      musician_id = this.junks[4];
      musician_html = musicianLinkTemplate(musician_id);
      return $musician_link.find('a').after(musician_html).css("margin-right", "3px");
    };

    Application.prototype.injectMusicianButtonView = function() {
      var $musician_div, $musician_radio_link, button, musician_button_html, musician_id, oMusician;
      $musician_div = $('div.content.musician');
      $musician_radio_link = $musician_div.find('a.start_radio_musician');
      if ($musician_radio_link.length === 0) {
        return;
      }
      musician_id = $musician_div.find('.ll.musician_title').attr("href").split("/")[4];
      musician_button_html = musicianButtonTemplate(musician_id);
      $musician_radio_link.after(musician_button_html);
      button = $("#diumoo_musician_button");
      button.css({
        "display": "inline-block",
        "width": "48px",
        "height": "18px",
        "margin-top": "4px",
        "margin-left": "16px",
        "margin-bottom": "0px",
        "background": "url(" + PLAYDIUMOO_GRAY_SRC + ")"
      });
      oMusician = $('.result-item.musician');
      if (oMusician.length) {
        return oMusician.hover(function() {
          return button.css("background", "url(" + PLAYDIUMOO_SRC + ")");
        }, function() {
          return button.css("background", "url(" + PLAYDIUMOO_GRAY_SRC + ")");
        });
      }
    };

    Application.prototype.injectSoundtrackView = function() {
      var fm_link, movie_id, soundtrack_html;
      fm_link = $('.aside a[href^="http://douban.fm"]');
      if (fm_link.length === 0) {
        return;
      }
      movie_id = this.junks[4];
      soundtrack_html = soundtrackLinkTemplate(movie_id);
      return fm_link.after(soundtrack_html).css("margin-top", "2px");
    };

    Application.prototype.injectButton = function() {
      var $item, album_button_html, album_id;
      $item = $(this);
      album_id = $item.parent().find('a')[0].href.split('/')[4];
      album_button_html = albumButtonTemplate(album_id);
      return $item.after(album_button_html);
    };

    Application.prototype.injectButtonView = function(selector) {
      var $album_buttons;
      $(selector).each(this.injectButton);
      $album_buttons = $(".diumoo_button.album");
      $album_buttons.css({
        "display": "inline-block",
        "width": "48px",
        "height": "18px",
        "margin-left": "16px",
        "margin-bottom": "-2.5px",
        "padding": "0",
        "background": "url(" + PLAYDIUMOO_GRAY_SRC + ")"
      });
      return $('.item').hover(function() {
        return $(this).find('.diumoo_button').css("background", "url(" + PLAYDIUMOO_SRC + ")");
      }, function() {
        return $(this).find('.diumoo_button').css("background", "url(" + PLAYDIUMOO_GRAY_SRC + ")");
      });
    };

    return Application;

  })();

  app = new Application();

}).call(this);
