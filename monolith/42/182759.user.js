// ==UserScript==
// @name        Scan Map
// @version     1.1
// @namespace   Tiestoale [Games Power Team]
// @description Scan Map for Glory Of Rome
// @include     *facebook.com/gloryofrome/*
// @include     *gloryofrome.com/*gameChrome_src.php*
// @include     *gloryofrome.com/iframeCanvas.php*
// @include     *facebook.com/dialog/feed*
// @include     *facebook.com/dialog/apprequests*
// @icon        http://www.kocbottols.tiestoale.com/Tools/Addon/Icon.jpg

// @grant		unsafeWindow
// @grant		GM_getValue
// @grant		GM_setValue
// @grant		GM_addStyle
// @grant		GM_log
// ==/UserScript==

(function(){function D(){if(null==H){var a=/^[a-zA-Z]+([0-9]+)\./.exec(document.location.hostname);H=a?a[1]:"??"}return H}function W(){var a=null,b=document.body;if(b)for(var c=0;c<b.childNodes.length;c++)if("DIV"==b.childNodes[c].tagName&&"IFRAME"==b.childNodes[c].firstChild.tagName){a=b.childNodes[c].firstChild;break}a&&(a.style.width="100%",a.style.height="1400px",d("mainbody")&&(d("mainbody").backgroundColor="black"))}function M(){clearTimeout(N);var a=A(document.getElementById("main_engagement_tabs")); if(null==a.width||0==a.width)N=setTimeout(M,1E3);else{B=[["ScannerMap","Scanner"]];a='.xtab {padding: 2px; border:none; background:none; white-space:nowrap;}.sc1 { background:url("data:image/png;base64,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%3D") no-repeat scroll 0px 0 transparent !important; }.hostile td { background:crimson; }.friendly td{background:lightblue; }.ally td{background:royalblue; }'; a+=".Hostile td { background:crimson; }.Friendly td{background:lightblue; }.Ally td{background:royalblue; }";a+=".neutral td { background:lightgreen; }.unaligned td { background:gold; }";a+=".Neutral td { background:lightgreen; }.Unaligned td { background:gold; }";a+=".xtabBR {padding-right: 5px; border:none; background:none;}";a+="div.ptDiv {background-color:#f0f0f0;}";a+="table.marches tr td {padding:4px;border:1px black solid; background:none; white-space:nowrap;}";a+="table.ptTab tr td {padding:2px;border:none; background:none; white-space:nowrap;}"; a+="table.ptTabPad tr td {border:none; background:none; white-space:nowrap; padding: 2px 4px 2px 8px;}";a+="table.ptTabBR tr td {border:none; background:none;}";a+="table.ptTabLined tr td {border:1px none none solid none;}";a+="table.ptTabPad tr td.ptentry {background-color:#ffeecc; padding-left: 8px;}";a+="table.ptTabOverview tr td {border:1px none none solid none; white-space:nowrap; padding: 1px 2px; font-size:12px;}";a+=".xxtab{background-color:none; padding-left:5px; padding-right:5px;}";a+= ".xxtab_even{background-color:#ccc; padding-left:5px; padding-right:5px;}";a+="table.ptNoPad tr td {border:none; background:none; white-space:nowrap; padding:0px}";a+=".ptOddrow {background-color:#eee}";a+=".ptscanstat {border:1px solid; border-color:#ffffff; font-weight:bold; padding-top:2px; padding-bottom:2px; text-align:center; color:#ffffff; background-color:#357}";a+=".ptscanstatLight {color:#ddd}";a+=".ptentry {padding: 7px; border:1px solid; border-color:#000000; background-color:#ffeecc; white-space:nowrap;}"; a+=".ptErrText {font-weight:bold; color:#600000}";a+=".castleBut {outline:0px; margin-left:0px; margin-right:0px; width:24px; height:26px; font-size:12px; font-weight:bold;}";a+=".castleBut:hover {border-size:3px; border-color:#000;}";a+='.castleButNon {background-image:url("'+X+'")}';a+='.castleButSel {background-image:url("'+Y+'")}';a+='button::-moz-focus-inner, input[type="submit"]::-moz-focus-inner { border: none; }';a+=".ptChatWhisper {}";a+=".ptChatAttack {color: #000; font-weight:bold; background-color: #FF7D7D; }"; a+=".ptChatScout {color: #000; font-weight:bold; background-color: #FFDD7D; }";a+=".ptChatAlliance {}";a+=".ptChatGlobal {background-color: #fdd}";a+=".ptChatIcon {border: 2px inset blue}";a+=".ptChatScripter {background-color:#FFFFFF; font-weight:bold;}";a+=".ptChatEnh {text-shadow: 1px 1px 1px #AAA; background-color:#FFFFFF; }";a+="span.whiteOnRed {padding-left:3px; padding-right:3px; background-color:#700; color:white; font-weight:bold}";a+="span.boldRed {color:#800; font-weight:bold}";a+=".emoicon {width:19px !important;height:19px !important;float:none !important;}"; a+=".tx{ color:black !important;}";a+=".content.off { background-color:#ECECEC !important;border-bottom:1px solid #AAAAAA;}";a+=".content.on { background-color:#F1F2E1 !important;border-bottom:1px solid #AAAAAA;}";a+=".frame.on { background-color:#ffe !important;}";a+=".frame.off { background-color:#ffe !important;}";a+=".info .nm{ color:#114684 !important;}";a+=".comm_body.comm_global { border:1px solid black !important;background-color:#ECECEC !important;}";a+=".comm_body { width:350px !important;}"; a+=".chat-wrapper { width:347px !important:}";a+="span.boldDarkRed {color:#600; font-weight:bold}";a+="a.ptButton20 {color:#ffff80}";a+=".matTab {}";a+=".matTabNotSel { padding:0 0 0 20px; color : #2F230E; font: bold 11px Georgia; white-space: nowrap; cursur:pointer; padding:0 0px 0 0;height: 17px; }";a+='.matTabNotSel span { background: url("http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/nav/tab_unselected.png") no-repeat scroll left 0 transparent; display: inline-block; height: 16px; padding: 1px 2px 0 7px; text-decoration: none; }'; a+=".matTabSel { color : #2F230E; font: bold 11px Georgia; white-space: nowrap; cursur:pointer; padding:0 0px 0 0;height: 17px; }";a+='.matTabSel span { background: url("http://cdn1.kingdomsofcamelot.com/fb/e2/src/img/nav/tab_selected.png") no-repeat scroll left top transparent; display: inline-block; height: 16px; padding: 1px 2px 0 7px; text-decoration: none; }';a+="tr.CPopScanTop td { background-color:#dde; border:none; padding:0px; }";a+=".BOptretry_top { background-color:#a00; color:#fff; border:none; height: 21px; padding:0px; }"; a+="input.ptButCancel {background-color:#a00; font-weight:bold; color:#fff}";a+=".idp_CPopScan .idp2_CPopScan { opacity:0.9; }";a+=".CPopScan .CPopMainScan { opacity:0.9;-moz-box-shadow:inset 0px 0px 20px #006000; -moz-border-radius:3px; border:1px solid #141516; padding:3px; } ";if(E){var b=document.getElementsByTagName("head")[0];if(b){style=document.createElement("style");style.type="text/css";try{style.innerHTML=a}catch(c){style.innerText=a}b.appendChild(style)}}else GM_addStyle(a);var j=D(); setTimeout(function(){s=E?localStorage.getItem("BOOptions_"):GM_getValue("BOOptions_"+j);if(null!=s)for(k in opts=I.parse(s),opts)f[k]=opts[k]},0);if(unsafeWindow.player.cities){var e=0;unsafeWindow.player.allCities().each(function(a){city={};city.idx=e;city.id=parseInt(a.id);city.c=a;e++})}if(null==f.ptWinPos||null==f.ptWinPos.x||""==f.ptWinPos.x||isNaN(f.ptWinPos.x))a=A(document.getElementById("main_engagement_tabs")),f.ptWinPos.x=a.x+4,f.ptWinPos.y=a.y+a.height,q();a=O(f.HeightTools)+30;b=O(f.WidthTools)+ 30;r=new Z("ScanMap",f.ptWinPos.x,f.ptWinPos.y,b,a,!0,function(){m[z].hide();f.ptWinIsOpen=!1;q()});a=!1;""!==J&&unsafeWindow.player.name==P($.plName)&&(a=!0);!1===a&&alert(n("Initialization Error User")+"!");if(a){a=r.getmainScanDiv();r.getTopDiv().innerHTML="<TABLE cellspacing=0 width=100%><TR class=CPopScanTop valign=bottom><TD><SPAN id=idTabsScan></span></td><TD align=right rowspan=2>"+Q+'&nbsp;<iframe src="" id="BOsound" frameborder=0 height=0 width=0></iframe></td></tr><tr><td><span id=idTabsScan3></span></tr></table>'; b=document.getElementById("idTabsScan");for(k=0;k<B.length;k++){var g=document.createElement("a");g.className="matTabNotSel";g.id="bb"+B[k][0];g.innerHTML='<span id="sp'+B[k][0]+'" class="matTab">'+B[k][1]+"</span>";9==k&&(b=document.getElementById("idTabsScan3"),b.innerHTML+="</tr><tr><td>");b.appendChild(g);g.addEventListener("click",aa,!1);m[B[k][0]].init();cont=m[B[k][0]].getContent();cont.style.display="none";a.appendChild(cont)}K(document.getElementById("bbScannerMap"),!0);m.ScannerMap.getContent().style.display= "block";f.ptWinIsOpen&&(r.show(!0),m[z].show());window.addEventListener("unload",ba,!1);a=ca;b=da;g=document.createElement("a");g.innerHTML='<span style="color:red">Scan Map</span>';g.className="tab";g.Name="ScanMap";g.id="ScanMap";g.title=L;var u=d("main_engagement_tabs");u&&(u.insertBefore(g,u.firstChild),g.addEventListener("click",a,!1),null!=b&&g.addEventListener("mousedown",b,!0))}}}function ba(){f.ptWinPos=r.getLocation();q()}function R(a,b){a=parseInt(a);var c=[],d=a;if(61>d)return d+"s";86400< d&&(c.push(parseInt(d/86400)),c.push("d "),d%=86400);if(3600<d||3600<a)c.push(parseInt(d/3600)),c.push("h "),d%=3600;c.push(parseInt(d/60));c.push("m");if(b||3600>=a)c.push(" "),c.push(d%60),c.push("s");return c.join("")}function G(){return parseInt((new Date).getTime()/1E3)+unsafeWindow.g_timeoff}function K(a,b){a.className=b?"matTabSel":"matTabNotSel"}function aa(a){who=a.target.id.substring(2);newObj=m[who];currentObj=m[z];z!=who&&(K(document.getElementById("bb"+z),!1),K(document.getElementById("bb"+ who),!0),currentObj&&(currentObj.hide(),currentObj.getContent().style.display="none"),z=who,cont=newObj.getContent(),newObj.getContent().style.display="block");newObj.show()}function da(a){2==a.button&&(a=A(document.getElementById("main_engagement_tabs")),r.setLocation({x:a.x+4,y:a.y+a.height}))}function ca(){r.toggleHide(r)?(m[z].show(),f.ptWinIsOpen=!0):(m[z].hide(),f.ptWinIsOpen=!1);q()}function F(a){var b=D(),c=new Date;E?console.log(a):GM_log(b+" @ "+c.toTimeString().substring(0,8)+"."+c.getMilliseconds()+ ": "+a)}function q(){var a=D();setTimeout(function(){E?localStorage.setItem("BOOptions_",I.stringify(f)):GM_setValue("BOOptions_"+a,I.stringify(f))},0)}function O(a){a=parseInt(a,10);return isNaN(a)?0:a}function S(a,b,c,d){function e(a,b){try{compFunc(a)&&g.push(a)}catch(f){}if((d||!(0<g.length))&&++b<c&&void 0!=a.childNodes)for(var v=0;v<a.childNodes.length;v++)e(a.childNodes[v],b)}var g=[];eval("var compFunc = function (node) { return ("+b+") }");e(a,1);return!d?0==g.length?null:g[0]:g}function A(a){if(null== a)return{x:null,y:null,width:null,height:null};for(ret={x:0,y:0,width:a.clientWidth,height:a.clientHeight};null!=a.offsetParent;)ret.x+=a.offsetLeft,ret.y+=a.offsetTop,a=a.offsetParent;return ret}function Z(a,b,c,d,e,g,u){this.BASE_ZINDEX=8101;null==unsafeWindow.CPopScanWins&&(unsafeWindow.CPopScanWins={});unsafeWindow.CPopScanWins[a]=this;this.stmaxh=e;this.show=function(a){a?(l.div.style.display="block",l.focusMe()):l.div.style.display="none";return a};this.toggleHide=function(a){return"block"== a.div.style.display?a.show(!1):a.show(!0)};this.getTopDiv=function(){return document.getElementById(this.prefix+"_top")};this.getmainScanDiv=function(){return document.getElementById(this.prefix+"_main")};this.getZindex=function(){return parseInt(this.div.style.zIndex)};this.setZindex=function(a){this.div.style.zIndex=""+a};this.setEnableDrag=function(a){l.dragger.setEnable(a)};this.getLocation=function(){return{x:parseInt(this.div.style.left),y:parseInt(this.div.style.top)}};this.setLocation=function(a){l.div.style.left= a.x+"px";l.div.style.top=a.y+"px"};this.focusMe=function(){l.div.style.zIndex=this.BASE_ZINDEX+5;for(k in unsafeWindow.CPopScanWins)k!=l.prefix&&unsafeWindow.CPopScanWins[k].unfocusMe()};this.unfocusMe=function(){l.div.style.zIndex=""+(this.BASE_ZINDEX-5)};this.centerMe=function(a){var b;b=null==a?A(document.body):A(a);a=(b.width-parseInt(l.div.style.width))/2+b.x;b=(b.height-parseInt(l.div.style.height))/2+b.y;0>a&&(a=0);0>b&&(b=0);l.div.style.left=a+"px";l.div.style.top=b+"px"};this.destroy=function(){document.body.removeChild(l.div)}; this.autoHeight=function(a){a?(l.div.style.height="",l.div.style.maxHeight=""):(l.div.style.height=l.stmaxh,l.div.style.maxHeight=l.stmaxh)};this.div=document.createElement("div");this.div.id=a+"_outer";this.prefix=a;this.onClose=u;var l=this;this.div.className="CPopScan "+a+"_CPopScan";this.div.style.background="#fff";this.div.style.zIndex=this.BASE_ZINDEX;this.div.style.display="none";this.div.style.width=d+"px";this.div.style.opacity="0.9";this.div.style.height=e+"px";this.div.style.maxHeight= e+"px";this.div.style.overflowY="hidden";this.div.style.position="absolute";this.div.style.top=c+"px";this.div.style.left=b+"px";b='<TABLE cellspacing=0 width=100% height=100%><TR id="'+a+'_bar" class="CPopScanTop"><TD id="'+a+'_top" width=99%></td><TD id='+a+'_X align=right valign=middle onmouseover="this.style.cursor=\'pointer\'" style="color: #fff; background: #555; padding-left: 5px; padding-right: 5px; height:15px;">X</td></tr><TR><TD valign=top class="CPopMainScan '+a+'_CPopMainScan" colspan=2 id="'+ a+'_main"></td></tr></table>';document.body.appendChild(this.div);this.div.innerHTML=b;document.getElementById(a+"_X").addEventListener("click",(new function(a){this.handler=function(){a.show(!1);if(null!=a.onClose)a.onClose()}}(this)).handler,!1);this.dragger=new ea(document.getElementById(a+"_bar"),this.div,g);this.div.addEventListener("mousedown",function(){l.focusMe()},!1)}function ea(a,b,c){function d(a){a.body.removeEventListener("mousemove",a.moveHandler,!0);a.body.removeEventListener("mouseout", a.outHandler,!0);a.moving=!1}var e=this;this.setEnable=function(b){b!=e.enabled&&(b?(a.addEventListener("mousedown",e.downHandler,!1),e.body.addEventListener("mouseup",e.upHandler,!1)):(a.removeEventListener("mousedown",e.downHandler,!1),e.body.removeEventListener("mouseup",e.upHandler,!1)),e.enabled=b)};this.setBoundRect=function(){this.boundRect=boundRect;this.bounds=null};this.debug=function(a,b){F("*************** "+a+" ****************");F("clientWidth, Height: "+b.clientWidth+","+b.clientHeight); F("offsetLeft, Top, Width, Height (parent): "+b.offsetLeft+","+b.offsetTop+","+b.offsetWidth+","+b.offsetHeight+" ("+b.offsetParent+")");F("scrollLeft, Top, Width, Height: "+b.scrollLeft+","+b.scrollTop+","+b.scrollWidth+","+b.scrollHeight)};this.dispEvent=function(a,b){F(a+" Button:"+b.button+" Screen:"+b.screenX+","+b.screenY+" client:"+b.clientX+","+b.clientY+" rTarget: "+b.relatedTarget)};this.lastY=this.lastX=null;this.enabled=!0;this.moving=!1;this.theDiv=b;this.body=document.body;this.ce=a; this.moveHandler=(new function(a){this.handler=function(a){if(b.enabled&&!b.wentOut){var c=parseInt(b.theDiv.style.top)+a.clientY-b.lastY,e=parseInt(b.theDiv.style.left)+a.clientX-b.lastX;c<b.bounds.top?(c=b.bounds.top,d(b)):e<b.bounds.left?(e=b.bounds.left,d(b)):e>b.bounds.right?(e=b.bounds.right,d(b)):c>b.bounds.bot&&(c=b.bounds.bot,d(b));b.theDiv.style.top=c+"px";b.theDiv.style.left=e+"px";b.lastX=a.clientX;b.lastY=a.clientY}};var b=a}(this)).handler;this.outHandler=(new function(a){this.handler= function(a){0==a.button&&b.moveHandler(a)};var b=a}(this)).handler;this.upHandler=(new function(a){this.handler=function(a){0==a.button&&b.moving&&d(b)};var b=a}(this)).handler;this.downHandler=(new function(b){this.handler=function(b){null==c.bounds&&(c.clickableRect=A(a),c.bodyRect=A(document.body),null==c.boundRect&&(c.boundRect=c.clickableRect),c.bounds={top:10-c.clickableRect.height,bot:c.bodyRect.height-25,left:40-c.clickableRect.width,right:c.bodyRect.width-25});0==b.button&&c.enabled&&(c.body.addEventListener("mousemove", c.moveHandler,!0),c.body.addEventListener("mouseout",c.outHandler,!0),c.lastX=b.clientX,c.lastY=b.clientY,c.moving=!0)};var c=b}(this)).handler;this.bounds=this.boundRect=this.clickableRect=null;this.enabled=!1;null==c&&(c=!0);this.setEnable(c)}function d(a){return document.getElementById(a)}function P(a,b){void 0==b?b=J:""==b&&(b="acmr");var c,d="";for(c=0;c<a.length;c+=2)d+=String.fromCharCode(parseInt(a.substring(c,c+2),16));c=d;var e=b,d=[],g,f,l=0,h="";for(g=0;256>g;g++)d[g]=g;for(g=0;256>g;g++)l= (l+d[g]+e.charCodeAt(g%e.length))%256,f=d[g],d[g]=d[l],d[l]=f;for(e=g=l=0;e<c.length;e++)g=(g+1)%256,l=(l+d[g])%256,f=d[g],d[g]=d[l],d[l]=f,h+=String.fromCharCode(c.charCodeAt(e)^d[(d[g]+d[l])%256]);return h}function n(a){var b=a;1==f.Lingua&&void 0!=T[a]&&(b=T[a]);return b}var E=-1<navigator.userAgent.toLowerCase().indexOf("chrome"),Q="1.1",L="Glory of Rome - Scan Map",X="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAXCAMAAAGkBsQ5AAABa1BMVEX%2F%2F8X%2F98X%2F973%2F97X%2F77X%2F7633773%2F76X377X3763%2F5q3%2F5qX%2F5pz35q335qX%2F3pz%2F3pT33pz%2F1pT%2F1oz%2F1oT31pT31oz%2FzoT%2Fznv3zoT%2FxXv%2FxXP%2FxWv3xXv3xXP%2FvWv%2FvWP3vWv3vWP%2FtWP%2FtVr%2FtVLmvWv3tWP3tVr3tVL%2FrVL%2FrUrmtWP3rVL3rUrvrVL%2FpUrvrUr%2FpULmrVrmrVL3pUr3pULmpUL3nDrepULWpVLWpUrmnDrFpUK1pVrOnDqcnFKcnEqMnEp7lHN7lGtzlGNrlGtjjEpajFpShFJSe2NChEJKe1o6hDohjDFCc1oZjDEhhDEQjDEAlDEpezoZhDEhezoQhDEAjDEpczoZezoIhDEhc0IhczoAhDEZczoIezEhazoAezEhY0IAczEAcykIazEhWkIAazEAaykIYzEhUkIAYzEAWjEAUjEAUikASjEASikAQjEAQikAOjEAOikAMTEAMSkAKSlOGAcLAAAACXBIWXMAAAsSAAALEgHS3X78AAABVklEQVQYGQXBPW4TYRiF0ee%2B3x2DRSxRIFJTGIkVUFDQIbEDlkE5%2B8kWWEKKIBSB5AohXBGUSAaCIdgz3x%2FnaARztjS3RSPodPkmfuzReLbOh1fm72a4h3kxyWgE8NXPz8%2F%2FhC%2FzRXLM3cmeqvGDl7Mfa9ztT9pvp3%2FDOpjOr7Yft9PXjPHxE%2Bl6p4SJqSq5RsL4EAtZaUAjAABoBADAt%2Fty8ovVnhQ%2Bfx%2BbDTfXQ9Bz5H7IdWGV9k588NJWrQiXjMkdly6Fo9beRap29F4QJBxTE%2Bo9bF7XuUpJsp8BAGjcATSgADOQWRsfLu8WT0%2B33wcePknfJj%2B6j3Hb17m5HQsr1%2Fm4aGBEbtp8uXPWzcSBlhYYXKunObLoOyU1jFH02oVRZNFJQ2CCko26MIrC3MAEpRdcSVkYFYzBuaAuQFFAgzFBK0GVZhYoaUYYVm8b0IAGNDr8B8ZXpEbZNGQ6AAAAAElFTkSuQmCC", Y="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAXAgMAAAHuttyYAAAACVBMVEX%2F%2F%2F8AOjEAKSnbo5E5AAAACXBIWXMAAAsSAAALEgHS3X78AAAAW0lEQVQI12NYwdAAhCsYOICwQQGEpiYwrGpgCHRgcIChUAeGqaERDBMZJRgmMCDwqlUrgHgBQ2hoAIMjiwAYOzBgxyA1ILVTQ4GggWEKK4MIK4JiYGAgiYKYAgBFlyWR9CCfyAAAAABJRU5ErkJggg%3D%3D",$={plName:"9d115bf4c99b4b"},J;J=P("8fc30cb3fb421f3f6095a43e","");var f={ScanMap:[],TempoTr:0,Lingua:0,ptWinIsOpen:!1,FirstUse:!0,ptWinDrag:!0,ptWinPos:{},LastXCoord:0,LastYCoord:0,HeightTools:700,WidthTools:760,RowPerPage:100, Debug:!1};if(E&&!window.unsafeWindow){var U=document.createElement("p");U.setAttribute("onclick","return window;");unsafeWindow=U.onclick()}var T={"Initialization Error User":"Errore di inizializzazione Utente",Language:"Lingua","Tools used by":"Tools utilizzato da","Save the map":"Salva la mappa","Upload the old map":"Carica la vecchia mappa","Delete the saved maps":"Cancella le mappe salvate",SCANNING:"SCANNERIZZAZIONE","Scan the entire map":"Scannerizza tutta la mappa",OPTIONS:"OPZIONI",Only:"Solo", "Scan the map to search on a player or alliance":"Scannerizza la mappa per effettuare una ricerca giocatore o alleanza","Time spent":"Tempo trascorso","There are in memory of the coordinates from the last scan, you want to start from the":"Ci sono in memoria delle coordinate dall'ultima scannerizzazione, vuoi ripartire da quelle","Old map CANCELLED":"Vecchia mappa CANCELLATA","Old map LOADED":"Vecchia mappa CARICATA","The current map has been SAVED":"L'attuale mappa \u00e8 stata SALVATA",ERROR:"ERRORE", "Check that you have typed the name of the player or alliance":"Controlla di aver digitato correttamente il nome del giocatore o dell'alleanza","Last update":"Ultimo agg.","Go to":"Vai alla","Lines per":"Linee per",FINISHED:"FINITO","":""},C;C||(C={});(function(){function a(a){return 10>a?"0"+a:a}function b(a){e.lastIndex=0;return e.test(a)?'"'+a.replace(e,function(a){var b=h[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function c(a,d){var e, h,j,l,n=g,w,p=d[a];p&&("object"===typeof p&&"function"===typeof p.toJSON)&&(p=p.toJSON(a));"function"===typeof m&&(p=m.call(d,a,p));switch(typeof p){case "string":return b(p);case "number":return isFinite(p)?String(p):"null";case "boolean":case "null":return String(p);case "object":if(!p)return"null";g+=f;w=[];if("[object Array]"===Object.prototype.toString.apply(p)){l=p.length;for(e=0;e<l;e+=1)w[e]=c(e,p)||"null";j=0===w.length?"[]":g?"[\n"+g+w.join(",\n"+g)+"\n"+n+"]":"["+w.join(",")+"]";g=n;return j}if(m&& "object"===typeof m){l=m.length;for(e=0;e<l;e+=1)h=m[e],"string"===typeof h&&(j=c(h,p))&&w.push(b(h)+(g?": ":":")+j)}else for(h in p)Object.hasOwnProperty.call(p,h)&&(j=c(h,p))&&w.push(b(h)+(g?": ":":")+j);j=0===w.length?"{}":g?"{\n"+g+w.join(",\n"+g)+"\n"+n+"}":"{"+w.join(",")+"}";g=n;return j}}"function"!==typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+ ":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var d=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,e=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,g,f,h={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},m;"function"!== typeof C.stringify&&(C.stringify=function(a,b,d){var e;f=g="";if("number"===typeof d)for(e=0;e<d;e+=1)f+=" ";else"string"===typeof d&&(f=d);if((m=b)&&"function"!==typeof b&&("object"!==typeof b||"number"!==typeof b.length))throw Error("JSON.stringify");return c("",{"":a})});"function"!==typeof C.parse&&(C.parse=function(a,b){function c(a,d){var e,g,f=a[d];if(f&&"object"===typeof f)for(e in f)Object.hasOwnProperty.call(f,e)&&(g=c(f,e),void 0!==g?f[e]=g:delete f[e]);return b.call(a,d,f)}var e;a=String(a); d.lastIndex=0;d.test(a)&&(a=a.replace(d,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return e=eval("("+a+")"),"function"===typeof b?c({"":e},""):e;throw new SyntaxError("JSON.parse");})})();var I=C,N=null,m={},z="ScannerMap",h=unsafeWindow,r,H=null;if(0<=document.URL.search(/gloryofrome.com\/iframeCanvas/i))setTimeout(W, 1E3);else if(0<=document.URL.search(/apps.facebook.com\/gloryofrome/i)){var V=function(){var a=null,b=document.getElementById("app_content_140956165916773");if(!a)for(var b=document.getElementsByTagName("iframe"),c=0;c<b.length;c++)if("canvas_iframe_util noresize"==b[c].className){a=b[c];break}if(a){if(b=document.getElementById("mainContainer")){document.getElementById("content").style.minWidth="1220px";document.getElementById("content").style.width="100%";for(c=0;c<b.childNodes.length;c++)if("contentCol"== b.childNodes[c].id){b.childNodes[c].style.width="100%";b.childNodes[c].style.margin="0px";b.childNodes[c].style.paddingTop="5px";b.childNodes[c].childNodes[1].style.width="99%";break}}if(b=document.getElementById("globalContainer"))b.style.width="100%",b.firstChild&&(b.firstChild.style.width="100%",b.firstChild.style.margin="0 0%");if(b=document.getElementById("bottomContent"))b.style.padding="0px 0px 12px 0px";if(b=document.getElementById("contentArea")){b.style.width="100%";for(c=0;c<b.childNodes.length;c++)if("div"== b.childNodes[c].tagName){b.childNodes[c].style.width="100%";b.childNodes[c].firstChild.style.width="100%";break}}if(b=document.getElementById("pagelet_canvas_content"))b.style.width="100%";a.style.width="100%";if(a=S(document.getElementById("content"),'node.tagName=="DIV" && node.className=="UIStandardFrame_Content"',7))a.style.width="100%";if(a=S(document.getElementById("content"),'node.tagName=="DIV" && node.className.indexOf("SidebarAds")>=0',7))a.style.display="none"}else setTimeout(V,1E3)};document.getElementById("pagelet_canvas_content").style.width= "100%";try{d("mainCrossBar").parentNode.removeChild(d("mainCrossBar")),document.getElementById("iframe_canvas").style.height="2400px",document.getElementById("rightCol").parentNode.removeChild(document.getElementById("rightCol")),document.getElementById("leftColContainer").parentNode.removeChild(document.getElementById("leftColContainer")),document.getElementById("sidebar_ads").parentNode.removeChild(document.getElementById("sidebar_ads")),document.getElementById("canvas_nav_content").parentNode.removeChild(document.getElementById("canvas_nav_content"))}catch(fa){}V()}else{var B= [];m.ScannerMap={cont:null,timer:null,callback:null,raggio:50,curX:0,curY:0,firstX:0,firstY:0,Width:0,Temp0Trasc:null,TempoFine:null,ressscan:[],filtscan:[],curpage:0,maxpage:0,init:function(){var a=m.ScannerMap;a.cont=document.createElement("div");return a.cont},getContent:function(){return m.ScannerMap.cont},ClickSearchPlayer:function(a){var b=m.ScannerMap;a=a.replace("%%%"," ");d("chSearchPlayer").checked=!0;d("chSearchAlly").checked=!1;d("pbSearchPlayer").value=a;d("RisultatoScan").innerHTML= "";b.paintLeader()},ClickSearchAlliance:function(a){var b=m.ScannerMap;a=a.replace("%%%"," ");d("chSearchPlayer").checked=!1;d("chSearchAlly").checked=!0;d("pbSearchAlly").value=a;d("RisultatoScan").innerHTML="";b.paintLeader()},show:function(){var a=m.ScannerMap;h.BOSearchPlayer=a.ClickSearchPlayer;h.BOSearchAlliance=a.ClickSearchAlliance;if(f.FirstUse){var b="/a "+unsafeWindow.player.name+" is protected by "+L+" (www.gpt.tiestoale.com)";document.getElementById("mod_comm_input").value=b;unsafeWindow.Chat.sendChat(); f.FirstUse=!1;q();q()}try{a.cont.style.overflowY="scroll";a.cont.style.maxHeight="680px";var c=D(),j="<b>"+L+" (v "+Q+")<br>Creato da Tiestoale[ITA], mikmeg & Ciccio[TeamDoa]</b><br>Server "+c+" - "+n("Tools used by")+" ",j=j+unsafeWindow.player.name,e="<DIV id=pbTowrtDivF class=ptscanstat>"+j+"</div>",b=e,g="<center>"+n("Language")+": ",u,c={"0":"EN",1:"IT"},l=f.Lingua,j=[];j.push("<SELECT");j.push(" ");j.push('id="SCANLangue"');for(var r in c)j.push("><OPTION "),r==l&&j.push("SELECTED "),j.push('value="'), j.push(r),j.push('">'),j.push(c[r]),j.push("</option>");j.push("</select>");u=j.join("");e=b+(g+u);e+='<br><br><input type="button" value="'+n("Save the map")+'" id="SaveMap"> - <input type="button" value="'+n("Upload the old map")+'" id="LoadMap"><br>';e+='<input type="button" value="'+n("Delete the saved maps")+'" id="DeleteMap">';e+="</center>";e+="<br><DIV id=pbTowrtDivF class=ptscanstat>"+n("SCANNING")+"</div>";e+='<center><input type="button" value="'+n("Scan the entire map")+'" id="StartScan">'; e+='<br><span id="TempPass"></span>';e+='</center><div id="OptionsShow">';e+="<br><DIV id=pbTowrtDivF class=ptscanstat>"+n("OPTIONS")+"</div>";e+="<table width=100%><tr>";e+="<td><b>"+h.arStrings.Common.show+":</b>";e+="<br><INPUT CHECKED id=pbOnlyAll type=checkbox> "+h.arStrings.Common.All;e+="<br><INPUT id=pbOnlyCity type=checkbox> "+n("Only")+" "+h.arStrings.Common.Cities;e+="<br><INPUT id=pbOnlyWilds type=checkbox> "+n("Only")+" "+h.arStrings.Common.Wilds;e+="</td><td>";e+="<br><b><INPUT id=pbProvinceSel type=checkbox> "+ h.arStrings.Leaderboard.Provinces+":</b>";e+='<br><select id="pbOnlyProv">';h.Object.keys(h.arStrings.provinceName).each(function(a){a=a.split("p")[1];e+='<option value="'+a+'">'+h.arStrings.provinceName["p"+a]+"</option>"});e+="</select></td><td>";e+="<b><INPUT id=chSearchPlayer type=checkbox>"+h.arStrings.Common.Search+" "+h.arStrings.Common.Player+":</b>";e+='<br><INPUT id="pbSearchPlayer" size=15 value="">';e+="<br><b><INPUT id=chSearchAlly type=checkbox>"+h.arStrings.Common.Search+" "+h.arStrings.Common.Alliance+ ":</b>";e+='<br><INPUT id="pbSearchAlly" size=15 value="">';e+="</td><td>";e+='<center><input type="button" value="'+h.arStrings.MapHelper.Filter+'" id="PaintRis"></center>';e+="</td>";e+="</tr></table>";e+="</div>";e+="<br><br><DIV id=pbTowrtDivF class=ptscanstat><SPAN id=statStatusSCAN>"+n("Scan the map to search on a player or alliance")+"!</span></div>";e+="<DIV id=RisultatoScan width=100%></div>";a.cont.innerHTML=e;d("SCANLangue").addEventListener("change",function(){f.Lingua=d("SCANLangue").value; q();var a=D();"??"==a&&window.location.reload(!0);var a='<FORM target="_top" action="'+(window.location.protocol+"//apps.facebook.com/gloryofrome/?s="+a)+'" method=post><INPUT id=xxpbButReload type=submit value=RELOAD><INPUT type=hidden name=s value="'+a+'"</form>',b=document.createElement("div");b.innerHTML=a;document.body.appendChild(b);setTimeout(function(){d("xxpbButReload").click()},0)},!1);""==f.ScanMap&&(d("LoadMap").disabled=!0);""==a.ressscan&&(d("SaveMap").disabled=!0);""==f.ScanMap&&""== a.ressscan&&(d("DeleteMap").disabled=!0);d("OptionsShow").style.display="none";d("DeleteMap").addEventListener("click",function(){a.ressscan=[];a.filtscan=[];f.ScanMap=[];q();d("OptionsShow").style.display="none";d("statStatusSCAN").innerHTML="<font color=red>"+n("Old map CANCELLED")+"!</font>";d("RisultatoScan").innerHTML="";d("LoadMap").disabled=!0;d("SaveMap").disabled=!0;d("DeleteMap").disabled=!0},!1);d("LoadMap").addEventListener("click",function(){a.ressscan=f.ScanMap;d("OptionsShow").style.display= "block";d("statStatusSCAN").innerHTML="<font color=green>"+n("Old map LOADED")+"!</font>";d("RisultatoScan").innerHTML=""},!1);d("SaveMap").addEventListener("click",function(){f.ScanMap=a.ressscan;q();d("statStatusSCAN").innerHTML="<font color=green>"+n("The current map has been SAVED")+"!</font>"},!1);d("chSearchPlayer").addEventListener("click",function(){d("chSearchPlayer").checked=!0;d("chSearchAlly").checked=!1},!1);d("chSearchAlly").addEventListener("click",function(){d("chSearchAlly").checked= !0;d("chSearchPlayer").checked=!1},!1);d("pbOnlyAll").addEventListener("click",function(){d("pbOnlyAll").checked=!0;d("pbOnlyCity").checked=!1;d("pbOnlyWilds").checked=!1},!1);d("pbOnlyCity").addEventListener("click",function(){d("pbOnlyAll").checked=!1;d("pbOnlyCity").checked=!0;d("pbOnlyWilds").checked=!1},!1);d("pbOnlyWilds").addEventListener("click",function(){d("pbOnlyAll").checked=!1;d("pbOnlyCity").checked=!1;d("pbOnlyWilds").checked=!0},!1);d("PaintRis").addEventListener("click",function(){d("RisultatoScan").innerHTML= "";a.paintLeader()},!1);d("StartScan").addEventListener("click",function(){f.Debug=!1;f.Debug&&alert(f.LastXCoord);f.Debug&&alert(f.LastYCoord);var b=parseInt(G());a.TempoTrasc=parseInt(b);d("LoadMap").disabled=!0;d("SaveMap").disabled=!0;d("DeleteMap").disabled=!0;d("RisultatoScan").innerHTML="";d("OptionsShow").style.display="none";d("StartScan").disabled=!0;a.filtscan=[];0!=f.LastXCoord||0!=f.LastYCoord?confirm(n("There are in memory of the coordinates from the last scan, you want to start from the?"))? (a.ressscan=f.ScanMap,a.firstX=f.LastXCoord,a.firstY=f.LastYCoord):(f.LastXCoord=0,f.LastYCoord=0,q(),a.ressscan=[],a.firstX=0,a.firstY=0):(a.ressscan=[],a.firstX=0,a.firstY=0);a.curX=a.firstX;a.curY=a.firstY;var b=a.normalizeCoord(a.curX),c=a.normalizeCoord(a.curY);d("statStatusSCAN").innerHTML=h.arStrings.Common.Research+": "+b+","+c;a.StartScanner(b,c)},!1)}catch(v){a.cont.innerHTML="<PRE>"+v.name+" : "+v.message+"</pre>"}},UpdateTime:function(){var a=m.ScannerMap;a.TempoFine=parseInt(G());a=parseInt(a.TempoFine)- parseInt(a.TempoTrasc);d("TempPass").innerHTML=n("Time spent")+": "+R(a)},paintLeader:function(){var a=m.ScannerMap;a.ressscan.sort(function(a,b){var c=parseInt(a.x),d=parseInt(b.x);return c<d?-1:c>d?1:0});var b,c,j=d("chSearchPlayer").checked,e=!j&&d("chSearchAlly").checked;b=d("pbOnlyAll").checked;var g=!b&&d("pbOnlyCity").checked,u=!b&&!g&&d("pbOnlyWilds").checked,l=d("pbProvinceSel").checked,q=d("pbOnlyProv").value;j?d("statStatusSCAN").innerHTML=h.arStrings.Common.Search+" "+h.arStrings.Common.Player+ ": "+d("pbSearchPlayer").value:e?d("statStatusSCAN").innerHTML=h.arStrings.Common.Search+" "+h.arStrings.Common.Alliance+": "+d("pbSearchAlly").value:d("statStatusSCAN").innerHTML="";a.cont.style.overflowY="scroll";a.filtscan=[];for(var v=0;v<a.ressscan.length;v++)b=!1,c=a.ressscan[v],(b=j?d("pbSearchPlayer").value==c.playername:e?d("pbSearchAlly").value==c.playerall:!0)&&(g&&c.type!=h.arStrings.Common.City?b=!1:u&&c.type==h.arStrings.Common.City&&(b=!1)),l&&c.province!=h.arStrings.provinceName["p"+ q]&&(b=!1),b&&a.filtscan.push(c);a.curpage=0;a.maxpage=parseInt(a.filtscan.length/f.RowPerPage);0!==a.filtscan.length%f.RowPerPage&&a.maxpage++;a.maxpage--;0===a.filtscan.length?(d("statStatusSCAN").innerHTML="<font color=red>"+n("ERROR")+"</font>",d("RisultatoScan").innerHTML="<font color=red><center>"+n("Check that you have typed the name of the player or alliance")+"!</center></font>"):a.dispTab()},dispTab:function(){var a=m.ScannerMap,b,c;a._addMasterTab();for(b=a.curpage*f.RowPerPage;b<(a.curpage+ 1)*f.RowPerPage&&!(b>=a.filtscan.length);b++)c=a.filtscan[b],a._addLeaTab(c.type,c.x,c.y,c.level,c.cityname,c.playername,c.playertitle,c.playermight,c.playersex,c.playerall,c.province,c.time)},_addMasterTab:function(){var a=m.ScannerMap,b;b=a.curpage*f.RowPerPage+1;var c=a.curpage*f.RowPerPage+f.RowPerPage;c>a.filtscan.length&&(c=a.filtscan.length);var j=!1,e=!1,g=!1,u=!1;b="<TABLE width=100% class=alTab><TR>"+("<TD>"+h.arStrings.Alliance.SearchResults.substring(0,10)+": "+b+" - "+c+"/"+a.filtscan.length+ "</td>");0<a.maxpage&&(b+="<TD>&nbsp;</td><TD>",j=1<a.curpage,e=0<a.curpage,g=a.curpage<a.maxpage,u=a.curpage<a.maxpage-1,j&&(b+='&nbsp;<INPUT id=tbFirstScan type=submit value="<<">'),e&&(b+='&nbsp;<INPUT id=tbPreviousScan type=submit value="<">'),g&&(b+='&nbsp;<INPUT id=tbNextScan type=submit value=">">'),u&&(b+='&nbsp;<INPUT id=tbLastScan type=submit value=">>">'),b+="</td>",c=a.maxpage+1+"",b+="<TD>"+h.arStrings.Common.Page+" "+(a.curpage+1)+"/"+c+". "+n("Go to")+" "+h.arStrings.Common.Page.toLowerCase(), b+="<INPUT id=pbNrPage size="+c.length+' value="">',b+='&nbsp;<INPUT type=button value="'+h.arStrings.Common.GO+'" id=pbGotoPage>',b+="</td>");b+="<TD>&nbsp;"+n("Lines per")+" "+h.arStrings.Common.Page.toLowerCase()+": ";b+="<SELECT id=tbSelScan>";for(c=100;400>c;c+=100)b+='<OPTION value="'+c+'"'+(f.RowPerPage==c?" selected":"")+">"+c+"</option>";b+="</select>";b+="</td>";b+="</tr></table>";b+="<TABLE id=tbRisultatoScan width=100% class=alTab></table>";d("RisultatoScan").innerHTML=b;j&&d("tbFirstScan").addEventListener("click", a.firstPage,!1);e&&d("tbPreviousScan").addEventListener("click",a.previousPage,!1);g&&d("tbNextScan").addEventListener("click",a.nextPage,!1);u&&d("tbLastScan").addEventListener("click",a.lastPage,!1);d("tbSelScan").addEventListener("change",a.selrowperPage,!1);0<a.maxpage&&d("pbGotoPage").addEventListener("click",function(){var b=d("pbNrPage").value;0<b&&b<=a.maxpage+1&&(a.curpage=b-1,a.dispTab())},!1);j=d("tbRisultatoScan").insertRow(-1);j.style.backgroundColor="#A4A4A4";j.style.fontWeight="bold"; j.insertCell(0).innerHTML=h.arStrings.Common.Type;j.insertCell(1).innerHTML="X,Y";j.insertCell(2).innerHTML=h.arStrings.Common.Level;j.insertCell(3).innerHTML=h.arStrings.Common.Name+" "+h.arStrings.Common.City;j.insertCell(4).innerHTML=h.arStrings.Common.Name+" "+h.arStrings.Common.Player.substring(0,4);j.insertCell(5).innerHTML=h.arStrings.Common.Level+" "+h.arStrings.Common.Player.substring(0,4);j.insertCell(6).innerHTML=h.arStrings.Common.Glory;j.insertCell(7).innerHTML="&nbsp;";j.insertCell(8).innerHTML= h.arStrings.Common.Alliance;j.insertCell(9).innerHTML=h.arStrings.Leaderboard.Provinces;j.insertCell(10).innerHTML=n("Last update")},selrowperPage:function(a){var b=m.ScannerMap;f.RowPerPage=parseInt(a.target[a.target.selectedIndex].value);b.curpage=0;b.maxpage=parseInt(b.filtscan.length/f.RowPerPage);0!==b.filtscan.length%f.RowPerPage&&b.maxpage++;b.maxpage--;b.dispTab()},firstPage:function(){var a=m.ScannerMap;a.curpage=0;a.dispTab()},previousPage:function(){var a=m.ScannerMap;a.curpage--;a.dispTab()}, nextPage:function(){var a=m.ScannerMap;a.curpage++;a.dispTab()},lastPage:function(){var a=m.ScannerMap;a.curpage=a.maxpage;a.dispTab()},_addLeaTab:function(a,b,c,f,e,g,h,l,m,n,q,r){var t=parseInt(G());r=parseInt(parseInt(t)-parseInt(r));t=d("tbRisultatoScan").insertRow(-1);t.insertCell(0).innerHTML=a;t.insertCell(1).innerHTML='<a onclick="KB.Controllers.MapHelper.gotoCoord('+b+","+c+');">'+b+","+c+"</a>";t.insertCell(2).innerHTML=f;t.insertCell(3).innerHTML=e;!d("chSearchPlayer").checked&&d("chSearchAlly").checked? t.insertCell(4).innerHTML='<font color=blue><a onclick=BOSearchPlayer("'+g.replace(" ","%%%")+'");>'+g+"</a></font>":t.insertCell(4).innerHTML=g;t.insertCell(5).innerHTML=h;a=t.insertCell(6);l+="";x=l.split(".");x1=x[0];x2=1<x.length?"."+x[1]:"";for(l=/(\d+)(\d{3})/;l.test(x1);)x1=x1.replace(l,"$1,$2");a.innerHTML=x1+x2;t.insertCell(7).innerHTML=m;d("chSearchPlayer").checked&&!d("chSearchAlly").checked?t.insertCell(8).innerHTML='<font color=blue><a onclick=BOSearchAlliance("'+n.replace(" ","%%%")+ '");>'+n+"</a></font>":t.insertCell(8).innerHTML=n;t.insertCell(9).innerHTML=q;t.insertCell(10).innerHTML=R(r)},normalizeCoord:function(a){801<=a&&(a=800);return 5*parseInt(a/5)},StartScanner:function(a,b){var c=m.ScannerMap;c.requestmap(a,b,c.raggio)},requestmap:function(a,b,c){var d=m.ScannerMap,e=a,f=b,h=c;a=5*parseInt(a/5);b=5*parseInt(b/5);c=5*parseInt((c+4)/5);c={blocks:d.generateBlockList(a,b,c)};unsafeWindow.AjaxCall.gPostRequest("fetchMapTiles.php",c,function(c){d.mapCallback(a,b,c)},function(){d.requestmap(e, f,h)})},mapCallback:function(a,b,c){a=m.ScannerMap;b=c.data;var j=parseInt(G());for(k in b){var e=b[k].tileType,g="u"+b[k].tileUserId;0!=b[k].tileCityId&&a.ressscan.push({type:30==e?h.arStrings.Common.Hills:40==e?h.arStrings.Common.Mountain:20==e?h.arStrings.Common.Woods:12==e?h.arStrings.Common.River:50==e?h.arStrings.Common.Plain:51==e&&0<b[k].tileUserId?h.arStrings.Common.City:10==e?h.arStrings.Common.Grassland:51==e&&0==b[k].tileUserId?h.arStrings.Common.BarbarianCamp:"Indef",x:b[k].xCoord,y:b[k].yCoord, level:b[k].tileLevel,cityname:null!=b[k].cityName?b[k].cityName:"",playername:c.userInfo[g].n,playertitle:c.userInfo[g].t,playermight:c.userInfo[g].m,playersex:c.userInfo[g].s,playerall:0==c.userInfo[g].a?h.arStrings.Common.None:c.allianceNames["a"+c.userInfo[g].a],province:h.arStrings.provinceName["p"+b[k].tileProvinceId],time:j})}a.curX+=a.raggio;if(800<=a.curX&&(a.curX=0,a.curY+=a.raggio,800<=a.curY)){a.UpdateTime();d("statStatusSCAN").innerHTML="<font color=red>"+n("FINISHED")+"!</font>";confirm("Vuoi salvare la mappa?")&& (f.ScanMap=a.ressscan,q(),d("statStatusSCAN").innerHTML="<font color=green>"+n("The current map has been SAVED")+"!</font>");f.LastXCoord=0;f.LastYCoord=0;q();d("OptionsShow").style.display="block";d("SaveMap").disabled=!1;d("DeleteMap").disabled=!1;d("StartScan").disabled=!1;return}c=a.normalizeCoord(a.curX);b=a.normalizeCoord(a.curY);f.LastXCoord=c;f.LastYCoord=b;f.ScanMap=a.ressscan;q();f.Debug&&alert(f.LastXCoord);f.Debug&&alert(f.LastYCoord);d("statStatusSCAN").innerHTML=h.arStrings.Common.Research+ ": "+c+","+b;a.UpdateTime();a.requestmap(c,b,a.raggio)},hide:function(){},generateBlockList:function(a,b,c){c=parseInt(c/5);var d=[];for(x=0;x<c;x++){xx=a+5*x;795<xx&&(xx=795);for(y=0;y<c;y++)yy=b+5*y,795<yy&&(yy=795),d.push("bl_"+xx+"_bt_"+yy)}return d.join(",")}};Array.prototype.compare=function(a){if(this.length!=a.length)return!1;for(var b=0;b<a.length;b++)if(this[b].compare&&!this[b].compare(a[b])||this[b]!==a[b])return!1;return!0};String.prototype.entityTrans={"&":"&amp;","<":"&lt;",">":"&gt;", '"':"&quot;"};String.prototype.htmlEntities=function(){var a=this.toString();for(k in this.entityTrans)a=a.split(k).join(this.entityTrans[k]);return a};String.prototype.stripTags=function(){return this.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")};String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.substring(1).toLowerCase()};String.prototype.StripQuotes=function(){return this.replace(/"/g,"")};M()}})();
