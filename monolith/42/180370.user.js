// ==UserScript==
// @name        musicme
// @namespace   music.me
// @description This script allows you to download musics on 'Music Me'
// @include     http://www.musicme.com/*
// @version     1.0
// @grant       GM_xmlhttpRequest
// ==/UserScript==

function Encrypt(e){e=e||null;var t=null;var n=0;var r=null;var i=null;var s=0;var o=0;if(e==null){return null}t="";o=0;while(o<10){t=t+RandomByte();o++}n=0;while(n<10){r=RandomByte();t=t+r;n++;if(n%2==0&&(r=="8"||r=="B")){break}}i=BaseEncrypt(e);s=i.length/2+i.length/2%2;t=t+i.substr(s);t=t+i.substr(0,s);o=0;while(o<8){t=t+RandomByte();o++}return t}function Decrypt(e){e=e||null;var t=0;var n=null;var r=0;var i=null;if(e==null){return null}if(e.length<=19){return null}var e=e.substr(10,e.length-18);t=0;while(t<10){n=e.charAt(t);t++;if(t%2==0&&(n=="8"||n=="B")){break}}e=e.substr(t);r=e.length/2-e.length/2%2;e=e.substr(r)+e.substr(0,r);i=BaseDecrypt(e);return i}function BaseEncrypt(e){e=e||null;var t=null;var n=0;var r=0;var i=null;if(e==null){return null}t=[];n=0;while(n<e.length){r=e.charCodeAt(n);r=r^CRYPT_KEY;t.push(r.toString(16));n++}return t.join("").toUpperCase()}function BaseDecrypt(e){e=e||null;var t=null;var n=0;var r=null;var i=0;var s=null;if(e==null){return null}t=[];n=0;while(n<e.length/2){r=e.substr(2*n,2);i=parseInt(r,16);i=i^CRYPT_KEY;t.push(String.fromCharCode(i));n++}return t.join("")}function RandomByte(){var e="123456789ABCDEF";return e.charAt(parseInt(Math.random()*e.length,10))}function InitDecoder(){DECODER.filesize=0;DECODER.prevTagSize=4;DECODER.tagHeaderLen=11;DECODER.AAC_HeaderWritten=false;DECODER.duration=0;DECODER.buf=[]}function downloadTrk(e,t){var n=e["barcode"];var r=e["isSample"]||false;var i=e["album"];var s=e["name"];var o=e["title"];var u=n.split("-");var a=u[1].split("_");var f=u[0];var l=a[0];var c=a[1];var h="["+i+"]"+l+"_"+c+" - "+s+" - "+o+".aac";var p="http://streamer.musicme.com/streamgateway/getstream/";var d="uid="+escape(getCookie("VID"))+"&nt="+c+"&upc="+f+"&nd="+l+"&type="+(r?"Sample":"Audio");var v=p+Encrypt(d);if(__DEBUG)console.log("requestURL = "+v+" Params = "+d);GM_xmlhttpRequest({method:"GET",url:v,onload:function(e){if(e.status==404){alert("Le fichier n'existe pas sur le serveur... :-(");return}var n=(new DOMParser).parseFromString(Decrypt(e.responseText),"text/xml");var r=getFragmentsUrlFromManifest(n);if(__DEBUG)console.log(r+"\n");var i=getNumberOfFragments(n);if(__DEBUG)console.log("fragCount = "+i);var s=function(e){var t=new Blob(e,{type:"application/octet-stream"});var n=URL.createObjectURL(t);var r=document.createElement("a");r.setAttribute("href",n);r.setAttribute("download",h||"Download.aac");var i=document.createEvent("MouseEvents");i.initMouseEvent("click",true,true,window,1,0,0,0,0,false,false,false,false,0,null);r.dispatchEvent(i)};downloadFragments(r,i,s,t)}})}function downloadFragments(e,t,n,r){var s=[];var o=new Object;o.nbAdded=0;if(__DEBUG){var u=(new Date).getTime();console.log("Processing...")}for(i=1;i<=t;i++){GM_xmlhttpRequest({addObj:o,method:"GET",url:e+i,onprogress:function(e){if(e.lengthComputable){var n=(e.loaded/e.total+this.addObj.nbAdded)/t*100;if(__DEBUG)console.log("[onprogress] (progressDiv.style.width <= parseInt(percent)) : "+(parseInt(r.style.width.replace("%",""))<=parseInt(n))+" "+parseInt(r.style.width.replace("%",""))+" "+parseInt(n));if(r&&parseInt(r.style.width.replace("%",""))<=parseInt(n))r.style.width=parseInt(n)+"%"}else console.log("Length of the response is not computable")},onload:function(i){var o=parseInt(i.finalUrl.substr(e.length));processFragment(i.responseText,o,this.addObj.nbAdded==0,s);if(++this.addObj.nbAdded==t){if(__DEBUG){var a=(new Date).getTime()-u;console.log("The downloading and decoding process took "+a+" ms");console.log("The file size is "+DECODER.filesize/(1024*1024)+" MB");console.log("The song duration is "+DECODER.duration+" s")}if(n)n([].concat.apply([],s))}var f=this.addObj.nbAdded/t*100;if(__DEBUG)console.log("[onload] (progressDiv.style.width <= parseInt(percent)) : "+(parseInt(r.style.width.replace("%",""))<=parseInt(f))+" "+parseInt(r.style.width.replace("%",""))+" "+parseInt(f));if(r&&parseInt(r.style.width.replace("%",""))<=parseInt(f))r.style.width=parseInt(f)+"%"},overrideMimeType:"text/plain; charset=x-user-defined"})}return true}function getFragmentsUrlFromManifest(e){var t=e.getElementsByTagName("media")[0].attributes;for(i in t){if(t[i].nodeName=="url")return t[i].nodeValue+"Seg1-Frag"}return null}function getNumberOfFragments(e){encodedBootstrap=e.getElementsByTagName("bootstrapInfo")[0].childNodes[0].nodeValue;bootstrapInfo=window.atob(encodedBootstrap.replace(/\t/g,"").replace(/\n/g,""));data=[0,"",0];ReadBoxHeader(bootstrapInfo,data);pos=data[0];boxType=data[1];if(boxType=="abst")return ParseBootstrapBox(bootstrapInfo,pos)}function ReadBoxHeader(e,t){var n=t[0]||0;var r=t[1];var i=t[2];i=ReadInt32(e,n);r=e instanceof Array?substr(e,n+4,4).join(""):substr(e,n+4,4);if(i==1){i=ReadInt64(e,n+8)-16;n+=16}else{i-=8;n+=8}if(i<=0)i=0;t[0]=n;t[1]=r;t[2]=i}function ParseBootstrapBox(e,t){version=ReadByte(e,t);flags=ReadInt24(e,t+1);bootstrapVersion=ReadInt32(e,t+4);byte=ReadByte(e,t+8);profile=(byte&192)>>6;if((byte&32)>>5){__live=true;__metadata=false}update=(byte&16)>>4;if(!update){__segTable=[];__fragTable=[]}timescale=ReadInt32(e,t+9);currentMediaTime=ReadInt64(e,t+13);smpteTimeCodeOffset=ReadInt64(e,t+21);t+=29;posTab=[t];movieIdentifier=ReadString(e,posTab);t=posTab[0];serverEntryCount=ReadByte(e,t++);posTab=[t];for(i=0;i<serverEntryCount;i++)serverEntryTable[i]=ReadString(e,posTab);t=posTab[0];qualityEntryCount=ReadByte(e,t++);posTab=[t];for(i=0;i<qualityEntryCount;i++)qualityEntryTable[i]=ReadString(e,posTab);drmData=ReadString(e,posTab);metadata=ReadString(e,posTab);t=posTab[0];segRunTableCount=ReadByte(e,t++);segTable=[];for(i=0;i<segRunTableCount;i++){data=[t,"",0];ReadBoxHeader(e,data);t=data[0];boxType=data[1];boxSize=data[2];if(boxType=="asrt"){segTable[i]=ParseAsrtBox(e,t);return segTable[i]["fragmentsPerSegment"]}t+=boxSize}}function ParseAsrtBox(e,t){segTable=[];version=ReadByte(e,t);flags=ReadInt24(e,t+1);qualityEntryCount=ReadByte(e,t+4);t+=5;posTab=[t];for(i=0;i<qualityEntryCount;i++)qualitySegmentUrlModifiers[i]=ReadString(e,posTab);t=posTab[0];segCount=ReadInt32(e,t);t+=4;for(i=0;i<segCount;i++){firstSegment=ReadInt32(e,t);segTable[firstSegment]=[];segEntry=segTable[firstSegment];segEntry["firstSegment"]=firstSegment;segEntry["fragmentsPerSegment"]=ReadInt32(e,t+4);if(__DEBUG)console.log("FRAGMENTS : "+segEntry["fragmentsPerSegment"]);if(segEntry["fragmentsPerSegment"]&2147483648)segEntry["fragmentsPerSegment"]=0;t+=8}return segTable}function DecodeFragment(e,t,n){var n=n||[];n[t-1]=[];var r="";var i=0;var s="";var o=0;var u=[i,s,o];var a=0;var f=e.length;while(i<f){ReadBoxHeader(e,u);i=u[0];s=u[1];o=u[2];if(s=="mdat"){f=i+o;break}i+=o;u[0]=i}while(i<f){var l=ReadByte(e,i);var c=ReadInt24(e,i+1);a=ReadInt24(e,i+4);a=a|ReadByte(e,i+7)<<24;if(a&2147483648)a&=2147483647;var h=DECODER.tagHeaderLen+c+DECODER.prevTagSize;switch(l){case AUDIO:var p=ReadByte(e,i+DECODER.tagHeaderLen);var d=(p&240)>>4;if(d==CODEC_ID_AAC){var v=ReadByte(e,i+DECODER.tagHeaderLen+1);if(v==AAC_SEQUENCE_HEADER){if(!DECODER.AAC_HeaderWritten){DECODER.AAC_Profile=ReadBits(e,(i+DECODER.tagHeaderLen+2)*8,5)-1;DECODER.sampleRateIndex=ReadBits(e,(i+DECODER.tagHeaderLen+2)*8+5,4);DECODER.channelConfig=ReadBits(e,(i+DECODER.tagHeaderLen+2)*8+9,4);WriteByte(DECODER.buf,0,255);WriteByte(DECODER.buf,1,241);var m=(DECODER.AAC_Profile<<6&255)+(DECODER.sampleRateIndex<<2&60)+(DECODER.channelConfig>>2);WriteByte(DECODER.buf,2,m);WriteByte(DECODER.buf,6,252);DECODER.AAC_HeaderWritten=true}break}else if(!DECODER.AAC_HeaderWritten){break}}if(c>0){var g=c+5;var y=(DECODER.channelConfig<<6&255)+(g>>11);WriteByte(DECODER.buf,3,y);WriteByte(DECODER.buf,4,g>>3&255);var b=((g&7)<<5&255)+31;WriteByte(DECODER.buf,5,b);n[t-1][n[t-1].length]=str2ab(DECODER.buf.join("")+substr(e,i+DECODER.tagHeaderLen+2,c-2));DECODER.filesize+=g}break;case SCRIPT_DATA:break;default:console.log("default")}i+=h}DECODER.duration=Math.round(a/1e3);return true}function processFragment(e,t,n,r){if(__DEBUG)console.log("start processFragment : "+t);if(n)InitDecoder();DecodeFragment(e,t,r);if(__DEBUG)console.log("end processFragment : "+t)}function ReadBits(e,t,n){var r=1+parseInt((n-1)/8);var s=t%8>8-n%8;if(s)r++;var o=0;var u=(n+t)%8;if(t!=0&&u==0)u=8;var a=parseInt(t/8);for(i=0;i<r;i++){if(r-i-1>0){if(r-i-1>1||!s){o+=((ReadByte(e,r-i-1+a)>>8-u)+(ReadByte(e,r-i-2+a)<<u)&255)*Math.pow(256,i)}else if(s){o+=((ReadByte(e,r-i-1+a)>>8-u)+((ReadByte(e,r-i-2+a)<<t%8&255)>>t%8-u))*Math.pow(256,i)}}else if(!s){o+=((ReadByte(e,r-i-1+a)<<t%8&255)>>8-u+t%8)*Math.pow(256,i)}}return o}function ReadByte(e,t){return charCodeAt(e,t)}function ReadInt24(e,t){var n=256;return charCodeAt(e,t)*Math.pow(n,2)+charCodeAt(e,t+1)*n+charCodeAt(e,t+2)}function ReadInt32(e,t){var n=256;return charCodeAt(e,t)*Math.pow(n,3)+charCodeAt(e,t+1)*Math.pow(n,2)+charCodeAt(e,t+2)*n+charCodeAt(e,t+3)}function ReadInt64(e,t){return ReadInt32(e,t)*4294967296+ReadInt32(e,t+4)}function ReadString(e,t){var n=t[0];len=0;while(e[n+len]!=String.fromCharCode(0))len++;e=substr(e,n,len);n+=len+1;t[0]=n;return e}function charCodeAt(e,t){if(e instanceof Array){return e[t].charCodeAt(0)&255}else{return e.charCodeAt(t)&255}}function substr(e,t,n){if(e instanceof Array){return e.slice(t,t+n)}else{return e.substr(t,n)}}function WriteByte(e,t,n){e[t]=String.fromCharCode(n)}function WriteInt24(e,t,n){e[t]=String.fromCharCode((n&16711680)>>16);e[t+1]=String.fromCharCode((n&65280)>>8);e[t+2]=String.fromCharCode(n&255)}function WriteInt32(e,t,n){e[t]=String.fromCharCode((n&4278190080)>>24);e[t+1]=String.fromCharCode((n&16711680)>>16);e[t+2]=String.fromCharCode((n&65280)>>8);e[t+3]=String.fromCharCode(n&255)}function getCookie(e){var t=document.cookie;var n=t.indexOf(" "+e+"=");if(n==-1){n=t.indexOf(e+"=")}if(n==-1){t=null}else{n=t.indexOf("=",n)+1;var r=t.indexOf(";",n);if(r==-1){r=t.length}t=unescape(t.substring(n,r))}return t}function ab2str(e){return String.fromCharCode.apply(null,new Uint8Array(e))}function str2ab(e){var t=new ArrayBuffer(e.length);var n=new Uint8Array(t);for(var r=0,i=e.length;r<i;r++){n[r]=e.charCodeAt(r)&255}return t}var CRYPT_KEY=170;var AUDIO=8;var SCRIPT_DATA=18;var CODEC_ID_AAC=10;var AAC_SEQUENCE_HEADER=0;var DECODER=new Object;var __DEBUG=false;var mainFrame=parent.frames["frmmain"].document;var audioFrame=parent.frames["frmaudio"].document;var observeDOM=function(e,t){if(window.MutationObserver||window.WebKitMutationObserver){var n=new MutationObserver(function(r,i){if(r[0].addedNodes.length||r[0].removedNodes.length)n.disconnect();t();n.observe(e,{childList:true,subtree:true})});n.observe(e,{childList:true,subtree:true});return n}else if(window.addEventListener){e.addEventListener("DOMNodeInserted",t,false);e.addEventListener("DOMNodeRemoved",t,false)}return null};var addDlLinks=function(){var listens=mainFrame.getElementsByClassName("trktic");if(listens.length!=0){var addAlbumDlLinks=function(e){var t=e.getElementsByTagName("track");var n=0;for(n=0;n<listens.length-1;n++){__obs.disconnect();var r=listens[n];var i=r.parentNode;var s=mainFrame.createElement("td");s.className="trktchk";i.appendChild(s);var o=mainFrame.createElement("div");s.appendChild(o);var u=mainFrame.createElement("a");var a=mainFrame.createElement("img");u.style.cursor="pointer";u.infos=getTrackInfoFromTracksList(["name","album","title"],t,n);u.onclick=function(e){var t=e.target.parentNode.parentNode.parentNode.parentNode;var n=t.id.substr(3);this.infos["barcode"]=n.substr(n.indexOf("-")+1);this.infos["isSample"]=e.target.id.indexOf("smpl")!=-1;var r=document.createElement("div");r.id="overlaydiv-"+this.infos["barcode"];r.style.position="absolute";r.style.width="229px";r.style.height="14px";r.style.zIndex="10";r.style.borderStyle="solid";r.style.borderWidth="1px";var i=document.createElement("div");r.appendChild(i);i.id="progressdiv-"+this.infos["barcode"];i.style.backgroundColor="#005";i.style.opacity=".3";i.style.position="relative";i.style.width="0%";i.style.height="100%";__obs.disconnect();var s;if(s=document.getElementById("overlaydiv-"+this.infos["barcode"])){if(s.firstChild.style.width=="100%"){t.getElementsByClassName("trktnm")[0].removeChild(document.getElementById("overlaydiv-"+this.infos["barcode"]))}else{__obs.observe(document.getElementById("disctl"),{childList:true,subtree:true});return}}t.getElementsByClassName("trktnm")[0].appendChild(r);__obs.observe(document.getElementById("disctl"),{childList:true,subtree:true});downloadTrk(this.infos,i)};o.appendChild(u);r.childNodes[0].childNodes.length!=0?a.id=r.childNodes[0].childNodes[0].childNodes[0].id:a.id="icstrm";a.src="http://mmcdn2.hosting-media.net/pict/v5/ic_trk_dl_g2.gif";a.align="right";a.border="0";u.appendChild(a);__obs.observe(document.getElementById("disctl"),{childList:true,subtree:true})}};var albumBarcode="";if(mainFrame.getElementsByClassName("tldiscs")[0].childNodes.length==1){albumBarcode=mainFrame.getElementsByClassName("hlnk")[0].onclick.toString().split("'")[1]+"-01"}else{albumBarcode=mainFrame.getElementsByClassName("tldiscsel")[0].onclick.toString().split("'")[1]}getPlaylistXML(albumBarcode,addAlbumDlLinks)}var infoBoxes=mainFrame.getElementsByClassName("itemcoltrkinfo");var mainDiv,btnDivs,dlDiv,aTags;var i,j=0;for(j=0;j<infoBoxes.length;j++){mainDiv=infoBoxes[j];btnDivs=mainDiv.getElementsByClassName("cdbtn");if(btnDivs.length==2){btnDivs[1].id.indexOf("cddltxt")!=-1?dlDiv=btnDivs[1]:dlDiv=btnDivs[0]}else if(btnDivs.length==1){if(btnDivs[0].id.indexOf("cdstreamtxt")!=-1){var barcode=btnDivs[0].childNodes[1].childNodes[0].childNodes[0].childNodes[1].childNodes[0].getAttribute("onclick").split("'")[1];dlDiv=createAndAppendDlDiv(barcode,mainDiv)}else{dlDiv=btnDivs[0]}}else{var titleLink=mainDiv.getElementsByClassName("in")[0];var splitTemp=titleLink.href.split("-");if(splitTemp[splitTemp.length-1].split(".")[0].length==2){var masterId=splitTemp[splitTemp.length-2];var discId=splitTemp[splitTemp.length-1].split(".")[0]}else{var masterId=splitTemp[splitTemp.length-1].split(".")[0];var discId="01"}eval("//"+audioFrame.body.getElementsByTagName("script")[1].textContent.split(";")[1]);var xmlhttp=new XMLHttpRequest;xmlhttp.myTitle=titleLink.textContent;xmlhttp.mainDiv=mainDiv;xmlhttp.onreadystatechange=function(){if(this.readyState==4&&this.status==200){var e=this.responseXML;var t=e.getElementsByTagName("title");var n=0;var r="";if(this.myTitle.indexOf("...")==this.myTitle.length-3)this.myTitle=substr(this.myTitle,0,this.myTitle.length-3);for(n=0;n<t.length;n++){if(t[n].textContent.indexOf(this.myTitle)!=-1){r=t[n].parentNode.getElementsByTagName("barcode")[0].textContent;if(__DEBUG)console.log(r+" : "+t[n].textContent+" myTitle : "+this.myTitle);break}}if(r!=""){var i=createAndAppendDlDiv(r,this.mainDiv);setDlDivOnClick(i)}}};xmlhttp.open("GET","http://www.musicme.com/_flash/player/make_playlist.php?type=cbs&cbs="+masterId+"-"+discId+"&mode=0&winid="+_winId,true);xmlhttp.send();continue}setDlDivOnClick(dlDiv)}};var createAndAppendDlDiv=function(e,t){var n='<table><tbody><tr><td><a onclick="'+"'"+e+'" style="cursor: pointer;"><img vspace="0" border="0" src="http://mmcdn2.hosting-media.net/pict/v5/ic_trk_dl_g2.gif"></a></td><td style="padding-left:2px;vertical-align:middle"><a onclick="'+"'"+e+'" class="ultxt buytxt" style="cursor: pointer;">0.00 €</a></td></tr></tbody></table>';var r=document.createElement("div");t.appendChild(r);r.innerHTML=n;r.className="cdbtn";r.id="cddltxt";return r};var setDlDivOnClick=function(e){aTags=e.getElementsByTagName("a");for(i=0;i<aTags.length;i++){aTags[i].onclick=void 0;aTags[i].removeAttribute("href");aTags[i].style.cursor="pointer"}e.onclick=function(e){var t,n;if(e.target.tagName.toLowerCase()=="img"){t=e.target.parentNode.getAttribute("onclick").split("'")[1];n=e.target.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode}else{t=e.target.getAttribute("onclick").split("'")[1];n=e.target.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode}var r=function(e){var r=e.getElementsByTagName("track");var i=getTrackInfoFromTracksList(["name","album","title"],r,0);var s=n.getElementsByClassName("cdbtn");i["isSample"]=s.length==1&&s[0].id.indexOf("cddltxt")!=-1;i["barcode"]=t;var o=document.createElement("div");o.id="overlaydiv-"+t;o.style.position="relative";o.style.width="96%";o.style.height="88%";o.style.zIndex="10";o.style.borderStyle="solid";o.style.borderWidth="2px";var u=document.createElement("div");o.appendChild(u);u.id="progressdiv"+t;u.style.backgroundColor="#005";u.style.opacity=".4";u.style.position="relative";u.style.width="0%";u.style.height="100%";u.onclick=function(e){if(e.target.style.width=="100%")e.target.parentNode.parentNode.removeChild(e.target.parentNode)};n.parentNode.appendChild(o);downloadTrk(i,u)};getPlaylistXML(t,r)}};var getPlaylistXML=function(barcode,callback){eval("//"+audioFrame.body.getElementsByTagName("script")[1].textContent.split(";")[1]);var xmlhttp=new XMLHttpRequest;xmlhttp.onreadystatechange=function(){if(this.readyState==4&&this.status==200){var e=this.responseXML;callback(e)}};xmlhttp.open("GET","http://www.musicme.com/_flash/player/make_playlist.php?type=cbs&cbs="+barcode+"&mode=0&winid="+_winId,true);xmlhttp.send()};var getTrackInfoFromTracksList=function(e,t,n){var r=[];var i=0;for(i=0;i<e.length;i++){var s=e[i];var o=t[n].getElementsByTagName(s);r[s]="";var u="";for(var a=0;a<o.length;a++){var f=document.createElement("div");f.innerHTML=o[a].textContent;r[s]+=u+f.firstChild.nodeValue;u=" & "}}return r};if(mainFrame.getElementById("disctl")){var theader=mainFrame.getElementById("disctl").previousSibling;if(theader.childNodes[1].childNodes[0].childNodes.length==11){var headerTd=mainFrame.createElement("td");theader.childNodes[1].childNodes[0].appendChild(headerTd);headerTd.outerHTML='<td class="trkhchk"><div><img hspace="0" src="http://mmcdn2.hosting-media.net/pict/v5/ic_halfdisc.gif"></div></td>'}}addDlLinks();var __obs=observeDOM(document.getElementById("disctl"),addDlLinks)