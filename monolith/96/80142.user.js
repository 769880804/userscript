// ==UserScript==
// @name           EasyGame
// @namespace      minotor45
// @description    Gestion compte Ogame plus facile
// @version        3.2.0
// @author         minotor45
// @include        http://*.ogame.*
// @exclude        http://pixelzirkus*
// ==/UserScript==

(function(e,t){function i(e,t,n){e=parseInt(e);t=parseInt(t);n=parseInt(n);return(t-e).mod(24)<(n-e).mod(24)||e.mod(24)==n.mod(24)}function s(e,t){var n="";n+="http://"+g.metas.get("universe")+"/game/index.php?page="+e;if(t)n+="&"+t;return n}function o(e,n){var i="";i+="http://"+g.metas.get("universe")+"/api/";i+=e+".xml";if(n!=t)i+="?"+r.param(n);return i}function u(t,n){setTimeout(function(){e.location.replace(s(t))},n)}function a(t,n){if(t!=k.Current().getId()){setTimeout(function(){e.location.replace(s(g.global.page,"cp="+t))},n)}else u(g.global.page,n)}function f(e,t){return Math.random()*(t-e)+e}function l(e){if(e==t)return 0;return parseInt(e.toString().replace(/[^0-9-]/g,""))}function c(t){return e.tsdpkt(Math.round(t))}function h(e,t){return Math.ceil((e==3?20:10)*t*Math.pow(1.1,t))}function p(){var e=Math.round(100*(r.now()-g.gbdd.load("dateinstallMaJ",0))/864e5)/100;var t=Math.floor(e);if(t<0)return"";var n=Math.floor(24*(e-t));return" ("+t+" j "+n+" h)"}function d(){if(g.gbdd.load("currentVersion","")<g.version){var e=g.gbdd.load("lastVersion","");if(e!=""&&e<"3.0.0")localStorage.clear();g.gbdd.save("lastVersion",g.gbdd.load("currentVersion",""));g.gbdd.save("currentVersion",g.version);g.gbdd.save("aJours",true);g.gbdd.save("dateinstallMaJ",r.now());g.gbdd.save("datecheckMaJ",r.now())}var t=g.gbdd.load("datecheckMaJ",0);var n=g.gbdd.load("aJours",true);if(n&&l(t)+8*3600*1e3<r.now()){g.gbdd.save("aJours",true);g.gbdd.save("datecheckMaJ",r.now())}if(!n){if(g.gbdd.load("currentVersion","")!=g.version){g.query("getChangelog",function(e){var t='<tr><th><a href="http://userscripts.org/scripts/source/'+g.number+'.user.js">';t+="<br />Installer la derniere version "+p()+"</a></th></tr>";t+=e.log;r("<span>").attr("id","affichagechangelog").makebox("Changelog : "+g.name+" v"+e.lastVersion,t)})}else g.gbdd.save("aJours",true)}}function v(e,t,n,r){var i,s,o;if(!t)i=r/100;else{o=e+C.prodCEF(t,n,r);s=C.prodCEF(t,n,100);if(e>=0)i=o/s;else{i=-o/s;if(i>1)i=0}if(i<0)i=-i;i=Math.ceil(i*10)/10;if(i>1)i=1;if(i<.1)i=0}return Math.ceil(100*i)}function m(){function n(){var e=r("meta[name]").toArray();for(var t=0;t<e.length;t++)this[e[t].name.substr(6).changeKey()]=e[t].content}function i(t){var n=e.name+"-";if(t)n+="global";else if(e.global.getMode()!="game")n+=e.global.getMode();else n+=e.metas.get("universe")+"-"+e.metas.get("playerId");this.key=n}function s(){}function o(){}var e=this;n.prototype={exists:function(e){return this[e]!=t},get:function(e){return this[e]}};this.metas=new n;s.prototype={def_lng:"FR",langs:{FR:{options:{save:"Sauvegarder",actions:{vide_colo:{dest_planet:"Destination",ress_priority:"Priorité des ressources",type_transport:"Type de transporteur",min_transport:"Nombre minimum de transporteur",vide_colo_auto:"Vider les colonies si inactif"},activite:{vide_colo_auto_heure:"Heure de vidage",active_activite_if_inactif:'Activer "activité" si inactif',duree_avant_activite_compte:'Durée avant d\'activé "activité"'},lance_expe:{min_heure:"Heure début",max_heure:"Heure fin"}},modules:{mine_a_faire:{enabled:"Afficher le module",level_max_4:"Niveau max. CES",level_max_14:"Niveau max. robo",level_max_15:"Niveau max. nanite",level_max_212:"Nombre max. Sat."}},autres:{affichage_module:{show_stock_ress:"Afficher le stock des ressources",show_ress_dyna:"Afficher stock ressources en dynamique",show_bilan_expe:"Afficher le bilan des expéditions",lien_direct_galaxie:"Liens directs dans la galaxie"},commandant:{hide_mmogame:"Cacher la barre mmogame",hide_build_faster:"Cache les boutons construction rapide",hide_build_am:"Cache les boutons construction avec AM",show_button_max:"Afficher bouton max",basique_color_menu:"Couleur classique bouton menu",remove_pub:"Supprimer TOUTES les pubs"}}},actions:{vide_colo:{on:"Vider les ressources des colonies ?",off:"Stopper le vidage des colonies ?"},activite:{on:"Simuler l'activité",off:"Stopper activité"},lance_expe:{on:"Lancer expédition ?",off:"Stopper expédition ?",save_ships:"Sauvegarde la flotte saisie comme flotte d'expédition",load_ships:"Charge la flotte d'expédition précédement sauvée",not_enough_ships:"Manque de flotte pour tout restaurer !"}},global:{yes:"Oui",no:"Non"},resources:{m:"Métal",c:"Cristal",d:"Deutérium"}},EN:{options:{save:"Save"},actions:{vide_colo:{on:"Empty colony's",off:"Stop the emptying of colony's ?"},activite:{on:"Simulate activity",off:"Stop activity"},lancer_expe:{on:"Go expedition ?",off:"Stop expedition ?",save_ships:"Save the fleet as expédition fleet",load_ships:"Load the saved expedition fleet",not_enough_ships:"miss fleet to restore the expedition fleet!"}},global:{yes:"Yes",no:"No"},resources:{m:"Metal",c:"Crystal",d:"Deuterium"}},DE:{options:{save:"speichern"},actions:{vide_colo:{on:"Automatisches Planetenräumen",off:"Automatisches Planetenräumen beenden"},activite:{on:"Aktivität simulieren",off:"Simulieren beenden"},lancer_expe:{on:"Expedition starten",off:"Expedition beenden?",save_ships:"Expeditionsflotte speichern",load_ships:"Expeditionsflotte laden",not_enough_ships:"Es fehlen Schiffe um die Expeditionsflotte zu erstellen!"}},global:{yes:"Ja",no:"Nicht"},resources:{m:"Metall",c:"Kristall",d:"Deuterium"}}},get:function(t,n){n=!n?e.metas.get("language"):n;n=n.toUpperCase();var r=t.split(".");var i=r.length;var s=this.langs[n];if(!s){if(n==this.def_lng)return false;s=this.langs[this.def_lng]}for(var o=0;o<i;++o){s=s[r[o]];if(!s){if(n!=this.def_lng)return this.get(t,this.def_lng);return false}}return s}};this.lang=new s;o.prototype={url:location.href,page:location.href.pick(/page=([^&#]+)/),getMode:function(){if(location.href.find(/board/))return"board";else if(!e.metas.exists("session"))return"portal";else return"game"}};i.prototype={key:"default",load:function(n,r){var i=localStorage.getItem(this.key+"-"+n);if(!i){if(r!=t)return r}else{try{return JSON.parse(i)}catch(s){e.log(s,"load("+n+")")}}return null},save:function(e,t){localStorage.setItem(this.key+"-"+e,JSON.stringify(t))},remove:function(e){localStorage.removeItem(this.key+"-"+e)},clear:function(){localStorage.clear()}};this.global=new o;this.bdd=new i;this.gbdd=new i(true);this.lang=new s}function y(){function t(){this.time=g.bdd.load("actua_time");this.interval=null;this.setTime=function(e){this.time=e;g.bdd.save("actua_time",this.time);if(this.time)this.start();else this.stop()};this.addTime=function(e){this.setTime(r.now()+e)};this.remaining=function(){var e=Math.floor((this.time-r.now())/1e3);if(e<0)return 0;return e};this.start=function(){var e=this.remaining();this.stop();if(e){var t,i,s;t=Math.floor(e/3600);e=e-3600*t;i=Math.floor(e/60);s=e-60*i;if(i<10)i="0"+i;if(s<10)s="0"+s;r("#compteur").html(t+":"+i+":"+s);this.interval=setInterval(function(){n.start()},1e3)}};this.stop=function(){if(this.interval)clearInterval(this.interval)}}function s(e,t){o(e);g.bdd.save("tempo_action",t)}function o(e){if(e)g.bdd.save("tempo_cp",k.Current().getId());g.bdd.save("action_script",e)}var n=new t;var c={};c.activite=function(){var e=f(0,100),t;if(e<=50)t=f(18e5,36e5);else if(e<=80)t=f(6e5,18e5);else t=f(12e4,6e5);t.toFixed(2);n.addTime(t);u("overview",t)};c.vide_colo=function(){var t=k.getCpPlanets().length;var i=f(4e3,9e3);i.toFixed(2);n.addTime(i);var o=l(g.bdd.load("vide_colo.num_planet"));if(o<=t){if(o==-1){g.bdd.save("vide_colo.num_planet",0);s(g.bdd.load("tempo_action",""),"");setTimeout("location.reload(true);",1234)}else if(o==t){g.bdd.save("vide_colo.num_planet",o+1);u("overview",i)}else if(g.bdd.load("vide_colo_"+k.byNum(o,"planet").getId()+"_to",0)==0){if(g.global.page!="overview")u("overview",i);else{g.bdd.save("vide_colo.num_planet",o+1);a(k.byNum(o+1,"planet").getId(),i)}}else if(r.inArray(g.global.page,["fleet1","fleet2","fleet3"])<0)u("fleet1",i);else if(k.Current().getInfo("num")!=o)a(k.byNum(o,"planet").getId(),i);else if(!k.Current().isPlanet())a(k.byNum(o,"planet").getId(),i);else{if(g.global.page=="fleet1"){var c=g.bdd.load("type_transport",203);var h=k.Current().getUsefulTransport();var p=(new C(c)).getValue();var d=g.bdd.load("min_transport",15);if(h>=d&&p>=d){h=h>p?p:h;F.setFleet(c,h);setTimeout(function(){r("#continue").click()},i)}else{g.bdd.save("vide_colo.num_planet",o+1);u("overview",i)}}else if(g.global.page=="fleet2"){var v=k.get(g.bdd.load("vide_colo_"+k.byNum(o,"planet").getId()+"_to",0));var m=b.byAddr(v.getInfo("coord"));r("#galaxy").val(m.galaxy);r("#system").val(m.system);r("#position").val(m.position);r("#speed").val(10);e.updateVariables();if(v.isPlanet())r("#pbutton").click();else r("#mbutton").click();setTimeout(function(){r("#continue").click()},i)}else if(g.global.page=="fleet3"){r("#missionButton3").click();var y=g.bdd.load("ress_priority","123");setTimeout(function(){r(".max:eq("+(y[0]-1)+")").trigger("click");r(".max:eq("+(y[1]-1)+")").trigger("click");r(".max:eq("+(y[2]-1)+")").trigger("click")},500);g.bdd.save("vide_colo.num_planet",o+1);setTimeout(function(){r("#start").click()},i)}}}else{g.bdd.save("vide_colo.num_planet",-1);a(g.bdd.load("tempo_cp",k.byNum(0,"planet").getId()),i)}};c.lance_expe=function(){var e=f(4e3,9e3);e.toFixed(2);n.addTime(e);var t=(new Date).getHours();var s=i(g.bdd.load("lance_expe_min_heure",7),t,g.bdd.load("lance_expe_max_heure",23));if(!s){u("overview",e);o("activite")}else if(r.inArray(g.global.page,["overview","movement","fleet1","fleet2","fleet3","messages"])<0)u("overview",e);else if(k.Current().getId()!=g.bdd.load("tempo_cp"))a(g.bdd.load("tempo_cp"),e);else{if(g.global.page=="messages"){e*=10;n.addTime(e);u("overview",e)}else if(g.global.page=="movement"){if(S.nbExpe()<S.maxExpe())u("fleet1",e);else u("overview",e)}else if(g.global.page=="overview"){var l=(new S(x.byType(15))).EndMin().getTime()-r.now();var c,h;if(l>0){c=f(0,100);if(l>=63e5)h=Math.floor(Math.random()*(5e4*c-3e5)+l+3e5);else if(c<=50)h=f(1.1*l,1.5*l);else if(c<=80)h=f(1.1*l,1.4*l);else h=f(.6*l,l)}else h=e;h.toFixed(2);n.addTime(h);u("fleet1",h)}else if(g.global.page=="fleet1"){if(S.nbExpe()>=S.maxExpe())u("movement",e);else{if(!F.loadExpe())alert("Flotte non sauver");else setTimeout(function(){r("#continue").click()},e)}}else if(g.global.page=="fleet2"){var p=b.byAddr(k.Current().getInfo("coord"));if(Math.floor(Math.random()*100)<=70){if(Math.floor(Math.random()*100)<=50)p[1]--;else p.system++;p.system=Math.max(Math.min(p.system,B.dataServerData().systems),1)}r("#galaxy").val(p.galaxy);r("#system").val(p.system);r("#position").val(16);setTimeout(function(){r("#continue").click()},e)}else setTimeout(function(){r("#start").click()},e)}};this.run=function(e){try{c[e]()}catch(t){g.log(t,"run")}};this.button=function(e,t){function n(e,t){var n;if(e=="vide_colo"){if(t)n="http://i.imgur.com/L8CXZ.gif";else n="http://i.imgur.com/1Hvgc.gif"}else if(e=="activite"){if(t)n="http://i.imgur.com/pPSbt.gif";else n="http://i.imgur.com/r4B3m.gif"}else if(e=="lance_expe"){if(t)n="http://i.imgur.com/GM5ED.gif";else n="http://i.imgur.com/Lkke1.gif"}var r="margin:0 5px;float:left;width:32px;height:32px;";r+="background:url("+n+") no-repeat";return r}function s(e,t,n){r("#"+e).click(function(){if(confirm(g.lang.get("actions."+t+"."+n))){if(n=="off")o("");else{o(t);if(t=="vide_colo")g.bdd.save("vide_colo.num_planet",0);if(t=="lance_expe"){var e=(new Date).getHours();var r=i(g.bdd.load("lance_expe_min_heure",7),e,g.bdd.load("lance_expe_max_heure",23));if(!r){alert("Vous ne pouvez pas lancer d'expédition, verifier les contraintes temps.");o("");return false}}}location.reload(true)}})}var u=e+"-"+(t?"on":"off");r("<span>").attr("id",u).appendTo("#menuscript");if(e!="actua_to")r("#"+u).html('<a href="javascript:;" class="tooltip tooltipRight " style="'+n(e,t)+'" title="'+g.lang.get("actions."+e+"."+(t?"on":"off"))+'"></a>');else r("#"+u).html('<span id="compteur"></span>');s(u,e,t?"on":"off");return this};var h=r("<li>");h.append('<span class="menu_icon">'+'<a target="_blank" title="UserScripts" class="tooltipRight" href="http://userscripts.org/scripts/show/'+g.number+'">'+'<div class="menuImage shop"></div>'+"</a>"+"</span>");h.append('<a href="javascript:void();" id="option_script" title="Option du script" class="tooltip tooltipRight menubutton"><span class="textlabel">'+g.name+" "+g.version+"</span></a>");r("#menuscript").addStyle({padding:"10px 5px",width:"126px",height:"inherit",background:"rgb(10, 13, 15)","border-radius":"5px"});r("#menuTable").append(h).append('<li id="menuscript"></li>');var p=g.bdd.load("action_script","");if(!e.vacation){if(!p)this.button("vide_colo",true).button("activite",true).button("lance_expe",true);else this.button("actua_to").button(p,false);if(p){this.run(p);var d=n.remaining();if(d){n.start();if(p!="vide_colo"){if(g.bdd.load("vide_colo_auto",0)&&r.inArray(g.global.page,["fleet1","fleet2","fleet3","movement"])<0){var v=new Date;var m=new Date(v.getTime()+d);var y=new Date(v.getTime());y.setHours(g.bdd.load("vide_colo_auto_heure",19));y.setMinutes(10);var w=0,E;r.each(k.getCpPlanets(),function(e,t){E=k.get(t);if(w<E.getCurrentStocks().usefulTransport())w=E.getCurrentStocks().usefulTransport()});if(w>=g.bdd.load("min_transport",15)){if(v.getTime()>=y.getTime()){s("vide_colo",p);location.reload(true)}else if(m.getTime()>y.getTime()+6e5){var T=y.getTime()-v.getTime();var N=f(.8*T,1.1*T);N.toFixed(2);n.addTime(N);setTimeout("location.reload(true);",N)}}}}}}}if(g.bdd.load("active_activite_if_inactif",1)==1&&!p){var L=g.bdd.load("duree_avant_activite_compte",60)*60*1e3;var A=f(.8*L,1.2*L);A.toFixed(2);setTimeout(function(){o("activite");location.reload(true)},A)}r("#option_script").click(function(){if(!r("#optionPanel").length){var t=r("<ul>").addClass("tabsbelow");var n=r('<div id="options_overlay"></div>').hide();var i=r('<div id="optionPanel"></div>');n.appendTo("body");n.append(i);i.append(t);var s={options:{},addTab:function(e,n){t.append('<li><a href="#'+e+'">'+n+"</a></li>");i.append('<div id="'+e+'" class="wrap"></div>');return this},addBar:function(e,t){var n=r('<div class="category fieldwrapper alt bar">');n.append('<label class="styled textBeefy">'+t+"</label>");r("#"+e).append(n).append('<div class="group bborder" style="display:none"></div>').find(".group:eq(0)").show();return this},addContent:function(e,t,n){r("#"+e).find(".category:eq("+t+")").next().append(n);return this},make:function(e,t,n,r,i){var s="";s+='<div class="fieldwrapper">';s+='<label class="styled textBeefy">'+n+" : </label>";s+='<div class="thefield">';s+=i();s+="</div>";s+="</div>";return this.addContent(e,t,s)},makeSelect:function(e,t,n,i,s,o){this.make(e,t,i,n,function(){var e="";e+='<select id="'+n+'" name="'+n+'" size="1" class="w150">';r.each(s,function(t,n){e+='<option value="'+t+'" '+(o==t?'selected="selected"':"")+">"+n+"</option>"});e+="</select>";return e})},makeInput:function(e,t,n,r,i){this.make(e,t,r,n,function(){return'<input class="textInput" id="'+n+'" name="'+n+'" type="text" value="'+i+'">'})}};s.addTab("tab1","Actions");s.addTab("tab2","Modules");s.addTab("tab3","Autres");s.addBar("tab1","Vidage colonies");var o="";o+='<div class="fieldwrapper">';o+='<label class="styled textBeefy">'+g.lang.get("options.actions.vide_colo.dest_planet")+" : </label>";o+='<div class="fieldwrapper" style="text-align:center;">';r.each(k.getCpPlanets(),function(e,t){var n=k.get(t);o+='<label class="styled textBeefy">'+n.display()+"</label>";o+='<div class="thefield">';o+='<select id="vide_colo_'+this+'_to" name="vide_colo_'+t+'_to" size="1" class="w150">';var i=g.bdd.load("vide_colo_"+t+"_to",0);o+='<option value="0"'+(i==0?'selected="selected"':"")+">----</option>";r.each(k.getCpCoord(),function(e,t){if(n.getId()!=t)o+='<option value="'+t+'" '+(i==t?'selected="selected"':"")+">"+k.get(t).display()+"</option>"});o+="</select>";o+="</div>"});o+="</div>";o+="</div>";s.addContent("tab1",0,o);s.makeSelect("tab1",0,"ress_priority",g.lang.get("options.actions.vide_colo.ress_priority"),{123:"MCD",132:"MDC",213:"CMD",231:"CDM",312:"DMC",321:"DCM"},g.bdd.load("ress_priority","123"));s.makeSelect("tab1",0,"type_transport",g.lang.get("options.actions.vide_colo.type_transport"),{202:"PT",203:"GT"},g.bdd.load("type_transport",203));s.makeInput("tab1",0,"min_transport",g.lang.get("options.actions.vide_colo.min_transport"),g.bdd.load("min_transport",15));s.makeSelect("tab1",0,"vide_colo_auto",g.lang.get("options.actions.vide_colo.vide_colo_auto"),{1:g.lang.get("global.yes"),0:g.lang.get("global.no")},g.bdd.load("vide_colo_auto",0));s.addBar("tab1","Activité");s.makeInput("tab1",1,"vide_colo_auto_heure",g.lang.get("options.actions.activite.vide_colo_auto_heure"),g.bdd.load("vide_colo_auto_heure",19));s.makeSelect("tab1",1,"active_activite_if_inactif",g.lang.get("options.actions.activite.active_activite_if_inactif"),{1:g.lang.get("global.yes"),0:g.lang.get("global.no")},g.bdd.load("active_activite_if_inactif",1));s.makeInput("tab1",1,"duree_avant_activite_compte",g.lang.get("options.actions.activite.duree_avant_activite_compte"),g.bdd.load("duree_avant_activite_compte",60));s.addBar("tab1","Expédition");s.makeInput("tab1",2,"lance_expe_min_heure",g.lang.get("options.actions.lance_expe.min_heure"),g.bdd.load("lance_expe_min_heure",7));s.makeInput("tab1",2,"lance_expe_max_heure",g.lang.get("options.actions.lance_expe.max_heure"),g.bdd.load("lance_expe_max_heure",23));s.addBar("tab2","Mine a faire");s.makeSelect("tab2",0,"mine_a_faire",g.lang.get("options.modules.mine_a_faire.enabled"),{1:g.lang.get("global.yes"),0:g.lang.get("global.no")},g.bdd.load("mine_a_faire",1));s.makeInput("tab2",0,"level_max_4",g.lang.get("options.modules.mine_a_faire.level_max_4"),g.bdd.load("level_max_4",31));s.makeInput("tab2",0,"level_max_14",g.lang.get("options.modules.mine_a_faire.level_max_14"),g.bdd.load("level_max_14",10));s.makeInput("tab2",0,"level_max_15",g.lang.get("options.modules.mine_a_faire.level_max_15"),g.bdd.load("level_max_15",4));s.makeInput("tab2",0,"level_max_212",g.lang.get("options.modules.mine_a_faire.level_max_212"),g.bdd.load("level_max_212",200));s.addBar("tab3","Affichage module");s.makeSelect("three",0,"show_stock_ress",g.lang.get("options.autres.affichage_module.show_stock_ress"),{1:g.lang.get("global.yes"),0:g.lang.get("global.no")},g.bdd.load("show_stock_ress",1));s.makeSelect("tab3",0,"show_ress_dyna",g.lang.get("options.autres.affichage_module.show_ress_dyna"),{1:g.lang.get("global.yes"),0:g.lang.get("global.no")},g.bdd.load("show_ress_dyna",0));s.makeSelect("tab3",0,"lien_direct_galaxie",g.lang.get("options.autres.affichage_module.lien_direct_galaxie"),{1:g.lang.get("global.yes"),0:g.lang.get("global.no")},g.bdd.load("lien_direct_galaxie",0));s.addBar("tab3","Commandant");s.makeSelect("tab3",1,"hide_mmogame",g.lang.get("options.autres.commandant.hide_mmogame"),{1:g.lang.get("global.yes"),0:g.lang.get("global.no")},g.bdd.load("hide_mmogame",1));s.makeSelect("tab3",1,"hide_build_faster",g.lang.get("options.autres.commandant.hide_build_faster"),{1:g.lang.get("global.yes"),0:g.lang.get("global.no")},g.bdd.load("hide_build_faster",1));s.makeSelect("tab3",1,"show_button_max",g.lang.get("options.autres.commandant.show_button_max"),{1:g.lang.get("global.yes"),0:g.lang.get("global.no")},g.bdd.load("show_button_max",1));s.makeSelect("tab3",1,"basique_color_menu",g.lang.get("options.autres.commandant.basique_color_menu"),{1:g.lang.get("global.yes"),0:g.lang.get("global.no")},g.bdd.load("basique_color_menu",1));s.makeSelect("tab3",1,"remove_pub",g.lang.get("options.autres.commandant.remove_pub"),{1:g.lang.get("global.yes"),0:g.lang.get("global.no")},g.bdd.load("remove_pub",1));s.makeSelect("tab3",1,"hide_build_am",g.lang.get("options.autres.commandant.hide_build_am"),{1:g.lang.get("global.yes"),0:g.lang.get("global.no")},g.bdd.load("hide_build_am",1));i.append('<input type="button" id="valider" class="btn_blue" value="'+g.lang.get("options.save")+'" />');var u=r("#valider");u.wrap('<div class="textCenter" />');u.click(function(){i.find("[name]").each(function(){g.bdd.save(r(this).attr("name"),r(this).val())});e.fadeBox("Vos options EasyGame ont bien été enregistrés.",false);return false});r("#optionPanel").tabs({activate:function(){e.Tipped.hide(r("input:not(:visible)"));e.Tipped.show(r("input:visible"))},active:0});r(this).addClass("overlay").data("overlay-inline","#options_overlay")}r(".bar","#optionPanel").hover(function(){r(this).addClass("bar-hover")},function(){r(this).removeClass("bar-hover")});r("div.wrap > div.bar","#optionPanel").click(function(){r(this).next("div.group:hidden").slideDown("fast",function(){e.Tipped.show(r(":input:visible"))}).siblings("div.group:visible").slideUp("fast",function(){e.Tipped.hide(r(":input:not(:visible)"))})});r("select").ogameDropDown()})}function b(e){var t=this;r.each(b.key,function(n,r){t[r]=r in e?e[r]:1});this.display=function(){return"["+this.galaxy+":"+this.system+":"+this.position+"]"}}function w(e){this.id=l(e);this.name=B.dataLocalization().missions[e]||""}function E(){S.update()}function S(e){this.getFleets=function(){var t={};r.each(e,function(e,n){r.each(n.getFleets(),function(e,n){if(!t[e])t[e]=0;t[e]+=n})});return t};this.Resources=function(){var t=new T;r.each(e,function(e,n){t.add(n.Resources())});return t};this.EndMin=function(){var t,n=null;r.each(e,function(e,r){t=r.getTimeRemaining();if(!n)n=t;else n=Math.min(t,n)});return new Date(n+r.now())}}function x(e){this.data=S.dataFlights[e]||{}}function T(e){e=e||{};var t=this;var n="f"in e?e.f:1;r.each(T.key,function(r,i){t[i]=i in e?e[i]*n:0})}function N(e,t){function r(){var e=n.Build.id;if(e>=1&&e<200){if(e==199)return 3;else if(e==124)return 1.75;if(e==2)return 1.6;else if(e==12)return 1.8;else if(e==1||e==3||e==4)return 1.5;else return 2}return 1}this.Build=e;this.level=parseInt(t);var n=this;this.getCapacity=function(){return this.level*this.Build.getCapacity()};this.Cost=function(){var e=r();var t=this.Build.id;var n;if(t==407||t==408){if(t==408)n={m:5,c:5,f:1e4};else n={m:1,c:1,f:1e4};return new T(n)}if(t>200&&t<300||t>400&&t<600){switch(t){case 202:n={m:2,c:2,f:1e3};break;case 203:n={m:6,c:6,f:1e3};break;case 204:n={m:3,c:1,f:1e3};break;case 205:n={m:6,c:4,f:1e3};break;case 206:n={m:20,c:7,d:2,f:1e3};break;case 207:n={m:45,c:15,f:1e3};break;case 208:n={m:10,c:20,d:10,f:1e3};break;case 209:n={m:10,c:6,d:2,f:1e3};break;case 210:n={c:1,f:1e3};break;case 211:n={m:50,c:25,d:15,f:1e3};break;case 212:n={c:20,d:5,f:100};break;case 213:n={m:60,c:50,d:15,f:1e3};break;case 214:n={m:5,c:4,d:1,f:1e6};break;case 215:n={m:30,c:40,d:15,f:1e3};break;case 401:n={m:2,f:1e3};break;case 402:n={m:15,c:5,f:100};break;case 403:n={m:6,c:2,f:1e3};break;case 404:n={m:20,c:15,d:2,f:1e3};break;case 405:n={m:2,c:6,f:1e3};break;case 406:n={m:5,c:5,d:3,f:1e4};break;case 502:n={m:8,d:2,f:1e3};break;case 503:n={m:125,c:25,d:100,f:100};break}n.f*=this.level;return new T(n)}if(t>100&&t<200){switch(t){case 106:n={m:200,c:1e3,d:200};break;case 108:n={c:400,d:600};break;case 109:n={m:800,c:200};break;case 110:n={m:200,c:600};break;case 111:n={m:1e3,c:0};break;case 113:n={c:800,d:400};break;case 114:n={c:4,d:2,f:1e3};break;case 115:n={m:400,d:600};break;case 117:n={m:2e3,c:4e3,d:600};break;case 118:n={m:10,c:20,d:6,f:1e3};break;case 120:n={m:200,c:100};break;case 121:n={m:1e3,c:300,d:100};break;case 122:n={m:2,c:4,d:1,f:1e3};break;case 123:n={m:24,c:40,d:16,f:1e4};break;case 124:n={m:4,c:8,d:4,f:1e3};break;case 199:n={};break}if(!("f"in n))n.f=1;n.f=n.f*Math.pow(e,this.level-1);return new T(n)}switch(t){case 1:n={m:60,c:15};break;case 2:n={m:48,c:24};break;case 3:n={m:225,c:75};break;case 4:n={m:75,c:30};break;case 12:n={m:900,c:360,d:180};break;case 14:n={m:400,c:120,d:200};break;case 15:n={m:10,c:5,d:1,f:1e5};break}if(!("f"in n))n.f=1;n.f=n.f*Math.pow(e,this.level-1);return new T(n)}}function C(e){this.id=parseInt(e);var t=B.dataLocalization();if(r.isEmptyObject(t))this.name="";else this.name=t.techs[e]}function k(e){this.planet=k.planets[e].planet||{};this.cp=e}function L(){}function M(){function t(e){if(!e.id)return"Veuillez vérifier vos réglage";var t=e.level_up;if(r.inArray(e.id,C.ships)==-1)t+=n.builds[e.id];var i;if(e.id=="12_percent"){i=new C(12);t+="%"}else i=new C(e.id);var s="";s+=i.name+"("+t+")";if(r.inArray(e.id,[1,2,3,4,12,212,113,"12_percent"])>=0)s+=" => Rst.Enr.:"+c(e.reste);if(e.id!="12_percent")s+=" Transpo:"+c(i.getCost(t).usefulTransport());return s}this.builds=[];var n=this;this.init=function(){if(!e.vacation&&k.Current().isPlanet()&&g.bdd.load("mine_a_faire",1)){this.nb_planet=k.getCpPlanets().length;r.each([1,2,3,4,12,14,15,212,113,122,124],function(e,t){n.builds[t]=(new C(t)).getValue()});this.builds["12_percent"]=l(k.Current().getBuild(12).percent);this.level_max=[];this.level_max[212]=l(g.bdd.load("level_max_212",200));this.level_max[14]=l(g.bdd.load("level_max_14",10));this.level_max[15]=l(g.bdd.load("level_max_15",4));this.level_max[4]=l(g.bdd.load("level_max_4",25));this.t_max=k.Current().getInfo("t_max");var i="",s;for(var o=0;o<10;o++){s=this.Mine_a_faire();i+="<div>"+t(s)+"</div>";if(s.id)this.builds[s.id]=this.builds[s.id]+s.level_up;this.nb_planet=Math.floor((this.builds[124]+3)/2)}r("#header_text").after(r("<div>",{id:"minesafaire"}).css({marginTop:"30px",background:"rgba(0,0,0,.65)"}).html(i));r("#minesafaire").find("div").css({fontWeight:"bold",color:"white",margin:"0 0 5px 75px",textAlign:"left"})}};this.Gestion_energie=function(e,t){var n=t-e;var r=(new C(4)).getCost(this.builds[4]+1).c;var i=4*(new C(12)).getCost(this.builds[12]+1).c;var s=2/this.nb_planet*(new C(113)).getCost(this.builds[113]+1).c;var o=Math.ceil(n/C.prodSat(1))+1;if(o+this.builds[212]>this.level_max[212])o=this.level_max[212]-this.builds[212];var u=2*(new C(212)).getCost(o).c;var a=[],f=[],l=[];a[4]=C.prodCES(this.builds[4]);a[12]=C.prodCEF(this.builds[12],this.builds[113],this.builds["12_percent"]);f[4]=C.prodCES(this.builds[4]+1)-a[4];f[12]=C.prodCEF(this.builds[12]+1,this.builds[113],this.builds["12_percent"])-a[12];f[113]=C.prodCEF(this.builds[12],this.builds[113]+1,this.builds["12_percent"])-a[12];f[212]=C.prodSat(o);if(this.builds[4]>=this.level_max[4])l[4]=0;else l[4]=f[4]/r;if(this.builds[12]==0&&this.builds[4]<28)l[12]=0;else l[12]=f[12]/i;if(l[4]*1e4<4)l[12]=f[12]/i;l[113]=f[113]/s;if(u==0||o+this.builds[212]>this.level_max[212]||o<0)l[212]=0;else l[212]=f[212]/u;var c="";var h=0;var p,d=1;if(l[4]>=l[12]&&l[4]>=l[113]&&l[4]>=l[212])p=4;else if(l[12]>=l[4]&&l[12]>=l[113]&&l[12]>=l[212])p=12;else if(l[113]>=l[4]&&l[113]>=l[12]&&l[113]>=l[212])p=113;else if(l[212]>=l[4]&&l[212]>=l[12]&&l[212]>=l[113]){p=212;d=o}if(p){h=f[p];c=e+h}var m=v(n,this.builds[12],this.builds[113],this.builds["12_percent"]);var g=Math.floor(10*(m-this.builds["12_percent"]))/10;if(g){c=t+C.prodCEF(this.builds[12],this.builds[113],g);p="12_percent";d=g}return{id:p,level_up:d,reste:c}};this.Gestion_temps=function(){var e=(1+this.builds[14]+2)/(1+this.builds[14]);var t=2;var n=Math.pow(1.3,this.builds[14])*(new C(14)).getCost(this.builds[15]+1).c;var r=(new C(15)).getCost(this.builds[15]+1).c;var i=[];if(this.level_max[14]<this.builds[14]+1)i[14]=0;else i[14]=e/n;if(this.level_max[15]<this.builds[15]+1||this.builds[14]<10)i[15]=0;else i[15]=t/r;if(i[14]||i[15]){if(i[14]>i[15])return{build_id:14,level:this.builds[14]+1};else if(i[15]>=i[14])return{build_id:15,level:this.builds[15]+1}}return{build_id:null,build_level:null}};this.Mine_a_faire=function(){function y(e,t,n){return e/5e3*2/(t+1)*Math.pow(.5,n)/g.metas.get("universeSpeed")}var e={};r.each(C.mines,function(t,r){e[r]=(new C(r)).getCost(n.builds[r]+1)});e[122]=(new C(122)).getCost(this.builds[122]+1);e[124]=(new C(124)).getCost(this.builds[124]+1);if(this.builds[124]%2)e[124].add((new C(124)).getCost(this.builds[124]+2));var t=[];t[1]=1.25*e[1].c;t[2]=e[2].c;t[3]=1.5*e[3].c;t[124]=e[124].c*(3/2)/(this.nb_planet+1);t[122]=10*e[122].c*2/this.nb_planet;var i=999*24;var s=[];r.each(C.mines,function(e,t){s[t]=h(t,n.builds[t])});var o=s[1]+s[2]+s[3];var u=[];u[4]=C.prodCES(this.builds[4]);u[12]=C.prodCEF(this.builds[12],this.builds[113],this.builds["12_percent"]);u[212]=C.prodSat(this.builds[212]);var a=u[4]+u[12]+u[212];var f=a-o;var l;var c;var p,d=1;if(t[1]<=t[2]&&t[1]<=t[3])p=1;else if(t[3]<t[1]&&t[3]<=t[2])p=3;else p=2;c=h(p,this.builds[p]+1)-s[p];var m=f-c;l=y(e[p].m+e[p].c,this.builds[14],this.builds[15]);if(r.inArray(p,[1,2])>=0&&t[122]<=t[p])p=122;else if(t[124]<=t[p])p=124;if(p==124||p==122){m=f;l=0}if(l>i){var b=this.Gestion_temps();p=b.id;d=b.level_up}else{var w=v(-m,this.builds[12],this.builds[113],this.builds["12_percent"]);var E=Math.floor(10*(w-this.builds["12_percent"]))/10;if(E){m=f-u[12]+C.prodCEF(this.builds[12],this.builds[113],w);p="12_percent";d=E}else if(m<0)return this.Gestion_energie(f,c)}return{id:p,level_up:d,reste:m}};this.init()}function _(){}function D(){this.check()}function P(){var e=this;r("#officers").find("a").each(function(){e[this.href.pick(/openDetail=([0-9]+)/)]=r(this).hasClass("on")})}var n=0;var r=e.jQuery;if(!r)throw new Error("jQuery is not initialized.");Math.clamp=function(e,t,n){return Math.min(Math.max(e,t),n)};Number.prototype.mod=function(e){return(this%e+e)%e};String.prototype.pick=function(e,n){var r;return(r=this.match(e))?r[r.length-1&&1]:n===t?false:n};Number.prototype.pick=function(e,t){String.prototype.pick.call(this.toString(),e,t)};String.prototype.find=function(e){return this.search(e)>-1};String.prototype.changeKey=function(){return this.replace(new RegExp("-([a-z]){1}","gi"),function(e){return e.substr(1).toUpperCase()})};r.fn.addStyle=function(e,t){var n={};if(typeof e=="object")n=e;else n[e]=t;var i="";r.each(n,function(e,t){i+=e+":"+t+" !important;"});r("head").append(r("<style>",{type:"text/css"}).html(this.selector+" {"+i+" } "));return this};r.fn.makebox=function(e,t){var n='<div class="content-box-xl" style="margin:0 0 5px 0;width:670px;float:left;overflow:hidden;">';n+='<div class="header" style="background:url(http://gf3.geo.gfsrv.net/cdnef/77c5d0b60f22b387b9dc90e2c4a30e.gif) no-repeat;';n+='height:32px;font-size:11px;text-transform:uppercase;">';n+='<h3 style="color:#6F9FC8;font-size:11px;font-weight:700;padding-top:11px;width:670px;text-align:center;">';n+=e;n+="</h3></div>";n+='<div class="content" style="background:url(http://gf1.geo.gfsrv.net/cdn03/db530b4ddcbe680361a6f837ce0dd7.gif) repeat-y;padding:5px 20px;">';n+='<table cellpadding="0" cellspacing="0">';n+="<tbody><tr>";n+='<td colspan="2" class="idle">';n+=t;n+="</td>";n+="</tr>";n+="</tbody></table>";n+="</div>";n+='<div class="footer" style="background:url(http://gf3.geo.gfsrv.net/cdnef/77c5d0b60f22b387b9dc90e2c4a30e.gif) no-repeat transparent 0 -100px"></div>';n+="</div>";return this.html(n).insertAfter(".content-box-s:eq(2)")};r("div.alt").addStyle({background:'url("http://gf1.geo.gfsrv.net/cdn0b/d55059f8c9bab5ebf9e8a3563f26d1.gif") no-repeat scroll 0% 0% #13181D',border:"1px solid #000000",height:"22px",lineHeight:"22px",padding:"0 0 0 25px"});r("div.bar-hover").addStyle({background:'url("http://gf1.geo.gfsrv.net/cdn0b/d55059f8c9bab5ebf9e8a3563f26d1.gif") no-repeat scroll 0% 0% #23282D',border:"1px solid #13181D",color:"#A7AFB7",cursor:"pointer",height:"22px",lineHeight:"22px",padding:"0 0 0 25px"});r("div.bar-hover label").addStyle("cursor","pointer");m.prototype={name:"EasyGame",version:"3.2.0",number:80142,server:"http://easygame.alwaysdata.net/",forum:"http://easygame.forumactif.org/",analytic:"UA-32703683-1",query:function(e,t,n,i){if(typeof t=="function"){i=n;n=t;t={}}var s={};s=r.extend(s,{mode:e,url:this.global.url});s=r.extend(s,{dataUser:{pseudo:this.metas.get("playerName"),uni:this.metas.get("universe"),player_id:this.metas.get("playerId"),lastVersion:this.gbdd.load("currentVersion",""),currentVersion:this.version}});s=r.extend(s,t);r.ajax({url:this.server+"index.php",type:"POST",dataType:"json",crossDomain:true,data:s,success:function(e){if(e){if(e.success)if(n)n(e);else if(i)i()}},error:function(e){if(i)i(e)}})},sendMsg:function(e,t){this.query("alert",{subject:e,message:t})},log:function(e,t){var r=e.message?e.toSource():e;if(n)alert(r+"\n\n"+e+"\n\n\nCom:"+t);if(console.log)console.log(r);this.sendMsg("log",r)}};var g=new m;b.key=["galaxy","system","position","type"];b.byAddr=function(e){var t=e.split(":");return new b({galaxy:l(t[0]),system:l(t[1]),position:l(t[2])})};E.prototype={getFleets:function(){var e={},t,n=this;r.each(C.ships,function(r,i){if(t=n.getFleet(i))e[i]=t});return e},setFleet:function(t,n){n=Math.min(n,(new C(t)).getValue());if(!n)n="";if(g.global.page=="fleet1"){r("#ship_"+t).val(n);e.checkShips("shipsChosen");A.actualiseDetail()}else if(n){if(!H.exists("am"+t))H.append("am"+t,'[name="details"]');H.set("am"+t,n)}},getFleet:function(e){var t;if(g.global.page=="fleet1")t=r("#ship_"+e).val();else t=H.get("am"+e);return l(t)||0},loadExpe:function(){var e=true,t,n=this;r.each(C.ships,function(r,i){t=l(g.bdd.load("shipexp"+i,0));e=t<=(new C(i)).getValue()&&e;n.setFleet(i,t)});return e},CostFleets:function(){var e=new T;r.each(this.getFleets(),function(t,n){e.add((new C(t)).getCost(n))});return e},getCapacity:function(){var e=0;r.each(this.getFleets(),function(t,n){e+=n*(new C(t)).getCapacity()});return e}};S.types=function(){var e=[];r.each(S.dataFlights,function(t,n){if(r.inArray(n.type,e)<0)e.push(n.type)});return e.sort()};S.update=function(){var e={};var t,n,i,s;r(".fleetDetails").each(function(){t=r(this).data();t.endTime=t.arrivalTime;t=r.extend(t,r(".openDetails .openCloseDetails",this).data());i=t.missionId;t={inReturn:t.returnFlight,type:t.missionType,endTime:t.endTime,fleets:{},resources:{}};var o="fleets",u;n=r(".fleetinfo tr",this);n.each(function(e){if(e&&e!=n.length-(3+1)){if(e==n.length-3)o="resources";if(o=="resources")u=T.key[e-(n.length-3)];else u=C.idByName(r("td:eq(0)",this).html().replace(":",""));if(u)t[o][u]=l(r(".value",this).html())}});s=b.byAddr(r(".originCoords a",this).html());if(r(".originPlanet .planet",this).length)s.type=1;else if(r(".originPlanet .moon",this).length)s.type=3;else if(r(".originPlanet .tf",this).length)s.type=2;t.startCoord=s;s=b.byAddr(r(".destinationCoords a",this).html());if(r(".destinationPlanet .planet",this).length)s.type=1;else if(r(".destinationPlanet .moon",this).length)s.type=3;else if(r(".destinationPlanet .tf",this).length)s.type=2;t.endCoord=s;e[i]=t});if(g.global.page=="movement"){S.dataFlights=e;g.bdd.save("data_fleet_movement",S.dataFlights)}else if(g.global.page=="fleet1"){var o=r("#slots").find(".fleft").eq(0).find(".advice").text().split("/");if(!l(o[0])){S.dataFlights=[];g.bdd.save("data_fleet_movement",S.dataFlights)}}};x.prototype={inReturn:function(){return this.data.inReturn},End:function(){return new Date(1e3*this.data.endTime)},getTimeRemaining:function(){return this.End().getTime()-r.now()},getFleets:function(){return this.data.fleets},Resources:function(){return new T(this.data.resources)}};x.by=function(e,t){var n={};r.each(S.dataFlights,function(r,i){if(i[e]==t)n[r]=new x(r)});return n};x.byinReturn=function(e){return x.by("inReturn",e)};x.byType=function(e){return x.by("type",e)};S.nbExpe=function(){if(g.global.page=="fleet1")return l(r("#slots").find(".fleft").eq(1).find(".advice").text().split("/")[0]);var e=0;r.each(x.byType(15),function(){e++});return e};S.maxExpe=function(){if(g.global.page=="fleet1")return l(r("#slots").find(".fleft").eq(1).find(".advice").text().split("/")[1]);return Math.floor(Math.pow(L.get(124),.5))};T.prototype={sum:function(){return this.m+this.c+this.d},pts:function(){return Math.floor(this.sum()/1e3)},usefulTransport:function(){return Math.ceil(this.sum()/(new C(g.bdd.load("type_transport",203))).getCapacity())},add:function(e){var t=this;if(e instanceof T)r.each(T.key,function(n,r){t[r]+=e[r]});return this},clone:function(){return r.extend(true,{},this)},multiply:function(e){var t=this;r.each(T.key,function(n,r){t[r]*=e});return this},cdr:function(){var e=this.clone();e.d=0;return e.multiply(B.dataServerData().debrisFactor)},nbRc:function(){return Math.ceil(this.cdr().sum()/(new C(209)).getCapacity())},styles:function(e){var t=this;var n=[],i;r.each(T.key,function(r,s){i=!e[s]?0:t[s]/e[s];if(i<.9)n[s]={color:"#99CC00"};else if(i>=.9&&i<1)n[s]={color:"#D29D00"};else n[s]={color:"#D43635"}});return n}};T.key=["m","c","d"];C.prototype={getValue:function(){if(r.inArray(this.id,C.techs)>=0)return L.get(this.id);else return k.Current().getBuild(this.id).value},getCapacity:function(){switch(this.id){case 202:return 5e3;case 203:return 25e3;case 204:return 50;case 205:return 100;case 206:return 800;case 207:return 1500;case 208:return 7500;case 209:return 2e4;case 211:return 500;case 213:return 2e3;case 214:return 1e6;case 215:return 750}return 0},Level:function(e){return new N(this,e)},getCost:function(e){return this.Level(e).Cost()}};C.ships=[202,203,204,205,206,207,208,209,210,211,212,213,214,215];C.techs=[106,108,109,110,111,113,114,115,117,118,120,121,122,123,124,199];C.mines=[1,2,3];C.energies=[4,12,212,113];C.prodSat=function(e){var t=k.Current().getInfo("t_max");var n=j.enabled("ingenieur")?1.1:1;return Math.floor(Math.floor(t/6+70/3)*e*n)};C.prodCES=function(e){var t=j.enabled("ingenieur")?1.1:1;return Math.floor(t*20*e*Math.pow(1.1,e))};C.prodCEF=function(e,t,n){var r=j.enabled("ingenieur")?1.1:1;return Math.floor(r*n/100*30*e*Math.pow(1.05+t/100,e))};C.idByName=function(e){var t=B.dataLocalization();var n=null;if(!r.isEmptyObject(t))r.each(t.techs,function(t,r){if(r==e)n=t});return n};r.extend(k,{planets:g.bdd.load("planets",{}),cp_planets:g.bdd.load("planets::cp_planets",[]),cp_moons:g.bdd.load("planets::cp_moons",[]),coords:g.bdd.load("planets::coords",{}),update:function(){var e=0;var t=k.planets;k.cp_planets=[];k.cp_moons=[];k.coords={};k.planets={};r(".smallplanet").each(function(n){var i=r(".planetlink",this).attr("href").pick(/cp=([^&#]+)/);var s=r(".moonlink",this);var o=r(".planet-name",this).html().trim();var u=r(".planet-koords",this).html().trim().substr(1).replace("]","");if(!t[i])k.planets[i]={planet:{}};else k.planets[i]=t[i];k.planets[i]=k.get(i);k.planets[i].addInfo({num:n,id:i,name:o,coord:u,type:"planet"});k.addPlanet(n,i,u);if(s.length){var a=s.attr("href").pick(/cp=([^&#]+)/);var f=s.attr("title").split("</B>")[0].substr(3).replace("["+u+"]","");if(!t[a])k.planets[a]={planet:{}};else k.planets[a]=t[a];k.planets[a]=k.get(a);k.planets[a].addInfo({num:e,id:a,name:f,coord:u,type:"moon"});k.addMoon(e,a,u);e++}});k.save();k.Current().update()},get:function(e){return new this(e)},Current:function(){return this.get(g.metas.get("planetId"))},getCpPlanets:function(){return this.cp_planets},getCpMoons:function(){return this.cp_moons},getCpType:function(e){return e=="planet"?this.getCpPlanets():this.getCpMoons()},byNum:function(e,t){var n=this.getCpType(t);return this.get(n[Math.clamp(0,e,n.length)]||1e3)},getProduction:function(){var e=new T;r.each(k.getCpPlanets(),function(t,n){e.add(k.get(n).getProduction())});return e},addPlanet:function(e,t,n){this.cp_planets[e]=t;this.coords[n]=this.coords[n]||[];if(r.inArray(t,this.coords)<0)this.coords[n].push(t)},addMoon:function(e,t,n){this.cp_moons[e]=t;this.coords[n]=this.coords[n]||[];if(r.inArray(t,this.coords)<0)this.coords[n].push(t)},getAllCp:function(){return r.merge(r.merge([],k.getCpPlanets()),k.getCpMoons())},getCpCoord:function(){var e=[];r.each(this.coords,function(t,n){r.each(n,function(t,n){e.push(n)})});return e},getCurrentStocks:function(){var e=new T;r.each(this.getAllCp(),function(t,n){e.add(k.get(n).getCurrentStocks())});return e},save:function(){g.bdd.save("planets",k.planets);g.bdd.save("planets::cp_planets",this.cp_planets);g.bdd.save("planets::cp_moons",this.cp_moons);g.bdd.save("planets::coords",this.coords)},getUrlsInstall:function(){var e=[];r.each(this.getAllCp(),function(t,n){e=r.merge(e,k.get(n).getUrlsInstall())});return e},nbUrlVisit:function(){var e=0;r.each(this.getAllCp(),function(t,n){e+=k.get(n).nbUrlVisit()});return e},nbUrlVisitTotal:function(){var e=0;r.each(this.getAllCp(),function(t,n){e+=k.get(n).nbUrlVisitTotal()});return e}});k.prototype={addInfo:function(e,t){if(!this.planet)this.planet={};if(!this.planet.info)this.planet.info={};if(typeof e=="object")this.planet.info=r.extend({},this.planet.info,e);else{this.planet.info=r.extend({},this.planet.info);this.planet.info[e]=t}},update:function(){var t=this;if(this.cp==g.metas.get("planetId")){this.planet.resources={};this.setLastVisit();r.each(T.key,function(e,n){t.updateResource(n)});if(r.inArray(g.global.page,["resources","station","shipyard","defense","fleet1"])>=0){this.setLastVisit(g.global.page);var n=r(".buildingimg");if(!n.length&&g.global.page=="fleet1"){r.each(C.ships,function(e,n){if(n!=212){if(!t.planet.builds)t.planet.builds={};if(!t.planet.builds[n])t.planet.builds[n]={};t.planet.builds[n].lastupdate=r.now();t.planet.builds[n].value=0}})}else{n.each(function(){if(!t.planet.builds)t.planet.builds={};var e=g.global.page=="fleet1"?r(this).parent().attr("id").substr(6):r(".detail_button",this).attr("ref");if(!t.planet.builds[e])t.planet.builds[e]={};t.planet.builds[e].lastupdate=r.now();t.planet.builds[e].value=l(r(".level",this).html())})}}else if(g.global.page=="overview"){this.setLastVisit(g.global.page);var i=e.textContent[1].split("(");var s=i[1].split("</span>/<span>");var o=e.textContent[3].split(" ");this.addInfo({diametre:l(i[0]),case_occupe:l(s[0]),case_total:l(s[1]),t_max:l(o[o.length-1])})}else if(g.global.page=="resourceSettings"){this.setLastVisit(g.global.page);r('.list [name^="last"]').each(function(){var e=r(this).attr("name").substr(4);if(!t.planet.builds)t.planet.builds={};if(!t.planet.builds[e])t.planet.builds[e]={};t.planet.builds[e].percent=r(this).val()})}}k.planets[this.cp].planet=this.planet;k.save()},getInfo:function(e){return this.planet.info[e]||false},getId:function(){return this.getInfo("id")},isPlanet:function(){return this.getInfo("type")=="planet"},getBuild:function(e){if(!this.planet.builds[e])return{value:0,lastupdate:0};return this.planet.builds[e]},getResource:function(e){return this.planet.resources[e]},getProduction:function(){var e={},t=this;r.each(T.key,function(n,r){e[r]=t.getResource(r).production});return new T(e)},getLimit:function(){var e={},t=this;r.each(T.key,function(n,r){e[r]=t.getResource(r).limit});return new T(e)},getAvailable:function(){var e={},t=this;r.each(T.key,function(n,r){e[r]=t.getResource(r).available});return new T(e)},getCurrentStocks:function(){var e=(r.now()-l(this.getLastVisit()))/1e3;var t={};var n=this.getAvailable();var i=this.getLimit();var s=this.getProduction();r.each(T.key,function(r,o){t[o]=n[o];if(t[o]<i[o]){if(parseInt(t[o]+s[o]*e)>i[o])t[o]=i[o];else t[o]=parseInt(t[o]+s[o]*e)}});return new T(t)},getUsefulTransport:function(){return this.getCurrentStocks().usefulTransport()},updateResource:function(t){var n,i,s,o;var u;var a="metalTicker"in e;switch(t){case"m":if(a)n=e.metalTicker.config;else n=r("#metal_box").attr("title");break;case"c":if(a)n=e.crystalTicker.config;else n=r("#crystal_box").attr("title");break;case"d":if(a)n=e.deuteriumTicker.config;else n=r("#deuterium_box").attr("title");break;default:alert("type non valide("+t+")")}if(a)this.planet.resources[t]=n;else{u=r(n.substr(n.indexOf("|")+2));i=l(u.find("tr:eq(0)").find("span").html());s=l(u.find("tr:eq(1)").find("span").html());o=l(u.find("tr:eq(2)").find("span").html())/3600;this.planet.resources[t]={available:i,limit:s,production:o}}},display:function(){return this.getInfo("name")+" (["+this.getInfo("coord")+"])"},getLastVisit:function(e){if(!this.planet.lastvisitpage)return 0;if(!e){if(!this.planet.lastvisitpage.value)return 0;return this.planet.lastvisitpage.value}if(!this.planet.lastvisitpage[e])return 0;return this.planet.lastvisitpage[e]},setLastVisit:function(e){if(!this.planet.lastvisitpage)this.planet.lastvisitpage={};if(!e)this.planet.lastvisitpage.value=r.now();else this.planet.lastvisitpage[e]=r.now()},getUrlsInstall:function(){var e="";if(k.Current().getId()!=this.getId())e="cp="+this.getId();var t=[];if(!this.planet.lastvisitpage)this.planet.lastvisitpage={};if(!this.planet.lastvisitpage.overview)t.push(s("overview",e));if(!this.planet.lastvisitpage.resources&&this.isPlanet())t.push(s("resources",e));if(!this.planet.lastvisitpage.station)t.push(s("station",e));if(!this.planet.lastvisitpage.shipyard)t.push(s("shipyard",e));if(!this.planet.lastvisitpage.defense)t.push(s("defense",e));if(!this.planet.lastvisitpage.resourceSettings&&this.isPlanet())t.push(s("resourceSettings",e));return t},nbUrlVisit:function(){return this.nbUrlVisitTotal()-this.getUrlsInstall().length},nbUrlVisitTotal:function(){return this.isPlanet()?6:4}};r.extend(L,{technos:g.bdd.load("technos",{}),get:function(e){return l(this.technos[e])},update:function(){if(g.global.page=="research"){L.technos={};r(".buildingimg").each(function(){L.technos[r("a.detail_button",this).attr("ref")]=r(".level",this).html().pick(/(\d+)/)});L.technos.lastupdate=r.now();g.bdd.save("technos",L.technos)}},getUrlInstall:function(){var e=[];if(r.isEmptyObject(this.technos))e.push(s("research"));return e}});S.dataFlights=g.bdd.load("data_fleet_movement")||{};var A={nb_bouton:0,actualiseDetail:function(){var e=F.CostFleets();var t=e.cdr();var n="";n+='<span id="capa">'+c(F.getCapacity())+" Capa</span><br />";n+='<span id="points">'+c(e.pts())+" Points</span><br />";r("#listeinfoflotte").html(n+'<span id="detailcdr" title="'+(c(t.m)+" "+g.lang.get("resources.m"))+" "+(c(t.c)+" "+g.lang.get("resources.c"))+" => "+c(e.nbRc())+' recyclo">Equivalent CDR =></span>')},addEvent:function(){var e=r("<div>",{id:"listeinfoflotte"}).width("150").css({overflow:"hidden",padding:"5px 10px"});r("#continue").after(e);r(".fleetValues,.tooltip").each(function(){r(this).keyup(function(){A.actualiseDetail()});r(this).click(function(){A.actualiseDetail()})});this.actualiseDetail()},bouton:function(e){this.nb_bouton++;var t;var n;var i;switch(e){case"S":t="sauverflotteexpe";n=g.lang.get("actions.lance_expe.save_ships");i="http://i.imgur.com/vnlER.gif";break;case"R":t="restaurerflotteexpe";n=g.lang.get("actions.lance_expe.load_ships");i="http://i.imgur.com/C6eSy.gif";break;case"GT":t="nombreptgtvidercolo";n="Sélectionne le bon nombre de GT pour vider vos colonies";i="http://nsa20.casimages.com/img/2010/08/28/100828124048177904.jpg";break;case"PT":t="nombreptgtvidercolo";n="Sélectionne le bon nombre de PT pour vider vos colonies";i="http://nsa20.casimages.com/img/2010/08/28/100828123944566392.jpg";break}r(".secondcol").append('<span id="'+t+'"><a href="javascript:void(0);" class="tooltip button_fleet1 tooltipRight" title="'+n+'"></a></span>');r(".button_fleet1").css({margin:"0 5px","float":"right",display:"block",width:"32px",height:"32px",overflow:"hidden"});r("#"+t+" a").css({background:"url("+i+") no-repeat"});return this},init:function(){if(g.global.page=="fleet1"){this.addEvent();var e=r(".secondcol").css("padding","5px");e.hide();e.find(".clearfloat").remove();r(".send_none,.send_all").css({"float":"left",margin:"0 5px"});if(g.bdd.load("type_transport",203)==203)this.bouton("GT");else this.bouton("PT");this.bouton("R").bouton("S");e.width(42*(2+this.nb_bouton));e.show();r("#sauverflotteexpe").click(function(){var e=0,t;r.each(C.ships,function(n,r){t=F.getFleet(r);g.bdd.save("shipexp"+r,t);e+=t});g.bdd.save("nbshipexp",e)});r("#restaurerflotteexpe").click(function(){if(!F.loadExpe())alert(g.lang.get("actions.lance_expe.not_enough_ships"))});r("#nombreptgtvidercolo").click(function(){var e=k.Current().getUsefulTransport();if(e>=g.bdd.load("min_transport",15))F.setFleet(g.bdd.load("type_transport",203),e)})}}};var O={make:function(){r("<span>").attr("id","lesstock").makebox("Les Stock ressources","");var e=r("#lesstock");e.hide();e.find("table").addStyle({margin:"0 20px",color:"white"});e.find("tr").addStyle("height","20px")},calcul:function(){function o(e,n,i,s){if(s==t)s="";var o=r("<tr>");var u;u=r("<td>").html(n);if(s["titre"])u.css(s["titre"]);o.append(u);r.each(T.key,function(e,t){u=r("<td>").html(c(i[t]));if(s[t])u.css(s[t]);o.append(u)});u=r("<td>").html(c(i.sum())+' <span style="font-size:9px">('+c(i.usefulTransport())+")</span>");if(s["T"])u.css(s["T"]);o.append(u);e.append(o)}var e=r("#lesstock");var n=new T;var i=e.find(".idle").empty();var s=r("<tr>");s.append(r("<th>").width(130));s.append(r("<th>").width(105).html(g.lang.get("resources.m")));s.append(r("<th>").width(105).html(g.lang.get("resources.c")));s.append(r("<th>").width(105).html(g.lang.get("resources.d")));s.append(r("<th>").width(135).html("Total (Transpo)"));i.append(s);r.each(k.getCpCoord(),function(e,t){var r=k.get(t);n.add(r.getCurrentStocks());o(i,r.display(),r.getCurrentStocks(),r.getCurrentStocks().styles(r.getLimit()))});var u=[];u["titre"]={color:"red"};o(i,"Total a quai",n,u);var a;var f=new T;r.each(S.types(),function(e,t){a=new S(x.byType(t));if(a.Resources().sum()>0)o(i,"Total "+(new w(t)).name,a.Resources());f.add(a.Resources())});n.add(f);if(f.sum())o(i,"Total en vol",f);o(i,"Total compte",n,u);var l=k.getProduction();o(i,"Prod total",l.multiply(24*60*60));e.show()},init:function(){if(g.bdd.load("show_stock_ress",1)==1){this.make();if(g.bdd.load("show_ress_dyna",0)==1)setInterval(O.calcul,1e3);else O.calcul()}}};_.prototype={Selector:function(e){return r('[type="hidden"][name="'+e+'"]')},exists:function(e){return this.Selector(e).length},get:function(e){return this.Selector(e).val()},set:function(e,t){return this.Selector(e).val(t)},append:function(e,t){return r(t).append(r("<input />",{name:e,type:"hidden"}))}};D.prototype={xml2array:function(e,t){var n=r(e).children();var i={};var s=0;r.each(["id","name","type","score","coords","size","ships","timestamp","alliance","status","player","position","href"],function(n,o){if(r(e).attr(o)){if(t=="techs"){alert(o+" "+r(e).attr(o))}i[o]=r(e).attr(o);s++}});var o=n.length;if(!o){if(e.textContent){if(!s)i=e.textContent;else i["value"]=e.textContent}}else{var u=false;if(r.inArray(t,["players","universe","alliances","universes"])>=0){i=[];u=true}n.each(function(){var e=D.prototype.xml2array(this,this.tagName);var n=this.tagName;if(r.inArray(t,["techs","missions","planets","positions"])>=0){if(r.inArray(t,["techs","missions"])>=0)i[e.id]=e.value;else if(t=="planets")i[e.id]=e;else if(t=="positions")i[e.type]=e}else if(u){var s={};s[n]=e;i.push(s)}else i[n]=e})}return i},callback:function(e,t,n){var i=this.xml2array(e,t)[t];g.bdd.save("api."+t+(n?"."+r.param(n):"")+".lastupdate",r.now());g.bdd.save("api."+t+(n?"."+r.param(n):""),i)},check:function(){var e=this;r.each([{deltaUpdate:8,name:"playerData",params:{id:g.metas.get("playerId")}},{deltaUpdate:24*6,name:"localization"},{deltaUpdate:24*6,name:"serverData"}],function(t,n){var i=e.get(n.name,n.params);if((r.now()-i.lastupdate)/(1e3*3600)>=n.deltaUpdate)e.load(n.name,n.params)})},load:function(e,t){var n=this;r.ajax({type:"GET",url:o(e,t),dataType:"xml",success:function(r){n.callback(r,e,t)}})},get:function(e,t){return{lastupdate:g.bdd.load("api."+e+(t?"."+r.param(t):"")+".lastupdate",0),data:g.bdd.load("api."+e+(t?"."+r.param(t):""),{})}},dataLocalization:function(){return this.get("localization").data},dataServerData:function(){return this.get("serverData").data}};P.prototype={enabled:function(e){if(e=="commandant")e="2";else if(e=="amiral")e="3";else if(e=="ingenieur")e="4";else if(e=="geologue")e="5";else if(e=="technocrate")e="6";return this[e]}};try{var H=new _;if(g.gbdd.load("dateinstallMaJ",0)==0)g.gbdd.save("dateinstallMaJ",r.now());if(g.global.getMode()=="game"){k.update();L.update();var B=new D;var j=new P;if(k.getUrlsInstall().length||L.getUrlInstall().length){r(function(){var t=r.merge(k.getUrlsInstall(),L.getUrlInstall());var n=f(1300,3500);n.toFixed(2);r("#menuTable").append('<li id="menuscript"></li>');r("#menuscript").addStyle({padding:"5px",width:"126px",height:"inherit",background:"rgb(10, 13, 15)","border-radius":"5px","text-align":"center"}).html("Installation<br /><br />"+Math.round(1e4*k.nbUrlVisit()/k.nbUrlVisitTotal())/100+" %");setTimeout(function(){e.location.replace(t[0])},n)})}else{var F=new E;if(g.bdd.load("hide_mmogame",1)==1){r("body.no-commander").addStyle({backgroundPosition:"0% 0",margin:"0"});r("#mmonetbar").addStyle("display","none");r("body.no-commander .contentBoxBody").addStyle("top","0")}if(g.bdd.load("hide_build_faster",1)==1)r(".build-faster").addStyle("display","none");if(g.bdd.load("basique_color_menu",1)==1)r(".premiumHighligt span").addStyle("color","inherit");if(g.bdd.load("remove_pub",1)==1)r("#banner_skyscraper").addStyle("display","none");r(document).ajaxSuccess(function(t,n,i){var o=i.url.pick(/page=([^&#]+)/);if(o=="allianceOverview"){r(function(){var e=r("<span>");e.attr("id","boutonBBcode").css("cursor","pointer").html("Liste Membres");r("#allyData").find("table").after(e);r("#boutonBBcode").click(function(){var e=[],t,n,i,s="";r("#member-list").find("tbody").find("tr").each(function(s){t=r.trim(r(this).find("td").html());n=l(r(this).find("td").eq(3).attr("title"));if(!n)alert("erreur");i=l(r(this).find("td").eq(3).find("a").html());e[s]=[t,n,i]});for(var o=0;o<e.length;o++)s+=o+1+"	"+e[o][0]+"			"+e[o][1]+"				"+e[o][2]+"\n";alert(s)})})}else if(o=="galaxyContent"){if(!j.enabled("commandant")){var u=r("#galaxytable");var a=l(u.data("galaxy"));var f=l(u.data("system"));var h=s("fleet1","galaxy="+a+"&system="+f);u.find(".row").each(function(){var t=r(this);var n=t.find(".microplanet");var i=t.find(".debris");var s=t.find(".moon");var o=t.find(".playername");var u=l(t.find(".position").html());var c=Math.min(l(i.find(".debris-recyclers").html()),(new C(209)).getValue());if(c){var p=i.find(".ListLinks").find("a");p.attr("href",h+"&position="+u+"&type=2&mission=8&am209="+c);p.removeAttr("onclick")}if(n.length&&!o.hasClass("vacation")&&!o.hasClass("js_no_action")&&!o.hasClass("noob")){var d=n.find(".ListLinks");var v=r("<a>");v.attr("href",h+"&position="+u+"&type=1&mission=1&am210=1");v.html("Crach sonde");d.append(v);d.find("li:last").next().wrap("<li>");if(s.length){var m=s.find(".ListLinks");if(m.length){var g=r("<a>");g.click(function(){e.sendShips(6,a,f,u,3,10);return false}).html("Espionner").attr("href","javascript:void(0);");m.append(g).find("li:last").next().wrap("<li>");v=r("<a>");v.attr("href",h+"&position="+u+"&type=3&mission=1&am210=1");v.html("Crach sonde");m.append(v);m.find("li:last").next().wrap("<li>")}}}})}}else if(r.inArray(o,["resources","shipyard","defense","research","station"])>=0){r(function(){if(g.bdd.load("hide_build_am",1)==1){r(".premium_info,.build-it_premium,.fill_capacity_info").addStyle("display","none");r("#description").find(".clearfloat").addStyle("display","none")}var e=r('[name="type"]',"#detail").val();var t=(new C(e)).getCost(1);var n=[],i;r.each(T.key,function(e,r){if(t[r])n.push(k.Current().getResource(r).available/t[r])});if(!n.length)i=0;else{i=n[0];var s=n.length;for(var o=1;o<s;o++)if(n[o]<i)i=n[o]}i=Math.floor(i);var u=r("#number");if(!j.enabled("commandant")&&g.bdd.load("show_button_max",1)==1){r(".enter #number","#detail").after('<div style="vertical-align:top"><a id="maxlink" class="tooltipRight tooltipRight" title="Nombre maximum" href="javascript:void(0);"></a></div>');r("#maxlink").html("max. "+i).click(function(){u.val(i).trigger("change")})}u.on("keyup change focus",function(){var e=0;var n=t.clone().multiply(r(this).val()||1);var i=n.styles(k.Current().getAvailable());r.each(T.key,function(t,s){if(n[s])r(".cost:eq("+e++ +")").html(c(n[s])).css(i[s])});r("#transpo_build").html(c(n.usefulTransport()))});var a=r("<li>");a.html("Nombre de transporteur: ");var f=r("<span>",{"class":"time",id:"transpo_build"});var l;if(g.global.page=="resources"&&e!=212||g.global.page=="research"||g.global.page=="station"){if(g.global.page=="research")l=L.get(e)+1;else l=(new C(e)).getValue()+1}else l=1;var h=(new C(e)).getCost(l);f.html(c(h.usefulTransport()));a.append(f);r(".production_info").append(a)})}});A.init();if(g.global.page=="resources"){new M;r(".detail_button").click(function(){setTimeout(function(){if(r("#detail").css("display")=="none")r("#minesafaire").show();else r("#minesafaire").hide()},200)})}r(function(){try{r(y)}catch(e){g.log(e,"ActionManager")}if(g.global.page=="overview"){new d;O.init()}})}}else if(g.global.getMode()=="portal"){r("#loginSubmit").before('<div class="input-wrap"><label for="logauto">Connexion auto : <input id="logauto" type="checkbox"></label></div>');r("#loginSubmit").click(function(e){g.gbdd.save("uni",r("#serverLogin").val());g.gbdd.save("login",r("#usernameLogin").val());g.gbdd.save("pass",r("#passwordLogin").val());g.gbdd.save("logauto",r("#logauto").attr("checked")=="checked");return true});if(g.gbdd.load("logauto")){r("#logauto").attr("checked","checked");var I=f(6e4,45e4);I.toFixed(2);r("#serverLogin").val(g.gbdd.load("uni"));r("#usernameLogin").val(g.gbdd.load("login"));r("#passwordLogin").val(g.gbdd.load("pass"));setTimeout(function(){r("#loginForm").trigger("submit")},I)}}}catch(q){g.log(q,"script")}})(unsafeWindow||window)