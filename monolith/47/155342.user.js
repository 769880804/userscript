// ==UserScript==
// @name       Imperion Helper
// @namespace  http://www.panduke.com/
// @version    0.6
// @description  Map scanner and helper. As you viewing planets IH store data to local database for better reports. 
// @match      http://*.imperion.*
// @copyright  2012+, panduke
// @exclude        http://forum.imperion.*/*
// @exclude        http://wiki.imperion.*/*
// @exclude        http://portal.imperion.*/*
// @exclude        http://*.imperion.*/login/*
// @exclude        http://*.imperion.*/supportExternal/*
// ==/UserScript==
(function(f){function g(a,c){for(var j=a.length;j--;)if(a[j]===c)return j;return-1}function l(t,f){var e,l,n,s,b;e=t.keyCode;-1==g(r,e)&&r.push(e);if(93==e||224==e)e=91;if(e in a)for(n in a[e]=!0,j)j[n]==e&&(k[n]=!0);else if(k.filter.call(this,t)&&e in c)for(s=0;s<c[e].length;s++)if(l=c[e][s],l.scope==f||"all"==l.scope){b=0<l.mods.length;for(n in a)if(!a[n]&&-1<g(l.mods,+n)||a[n]&&-1==g(l.mods,+n))b=!1;(0==l.mods.length&&!a[16]&&!a[18]&&!a[17]&&!a[91]||b)&&!1===l.method(t,l)&&(t.preventDefault?t.preventDefault():
t.returnValue=!1,t.stopPropagation&&t.stopPropagation(),t.cancelBubble&&(t.cancelBubble=!0))}}function k(a,e,f){var g,k,s,b;void 0===f&&(f=e,e="all");a=a.replace(/\s/g,"");g=a.split(",");""==g[g.length-1]&&(g[g.length-2]+=",");for(s=0;s<g.length;s++){k=[];a=g[s].split("+");if(1<a.length){k=a.slice(0,a.length-1);for(b=0;b<k.length;b++)k[b]=j[k[b]];a=[a[a.length-1]]}a=a[0];a=A[a]||a.toUpperCase().charCodeAt(0);a in c||(c[a]=[]);c[a].push({shortcut:g[s],scope:e,method:f,key:g[s],mods:k})}}function m(a,
c,j){a.addEventListener?a.addEventListener(c,j,!1):a.attachEvent&&a.attachEvent("on"+c,function(){j(window.event)})}var e,c={},a={16:!1,18:!1,17:!1,91:!1},n="all",j={"\u21e7":16,shift:16,"\u2325":18,alt:18,option:18,"\u2303":17,ctrl:17,control:17,"\u2318":91,command:91},A={backspace:8,tab:9,clear:12,enter:13,"return":13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,"delete":46,home:36,end:35,pageup:33,pagedown:34,",":188,".":190,"/":191,"`":192,"-":189,"=":187,";":186,"'":222,"[":219,
"]":221,"\\":220},r=[];for(e=1;20>e;e++)j["f"+e]=111+e;for(e in j)k[e]=!1;m(document,"keydown",function(a){l(a,n)});m(document,"keyup",function(c){c=c.keyCode;var e,f=g(r,c);0<=f&&r.splice(f,1);if(93==c||224==c)c=91;if(c in a)for(e in a[c]=!1,j)j[e]==c&&(k[e]=!1)});m(window,"focus",function(){for(e in a)a[e]=!1;for(e in j)k[e]=!1});var q=f.key;f.key=k;f.key.setScope=function(a){n=a||"all"};f.key.getScope=function(){return n||"all"};f.key.deleteScope=function(a){var j,e,g;for(j in c){e=c[j];for(g=
0;g<e.length;)e[g].scope===a?e.splice(g,1):g++}};f.key.filter=function(a){a=(a.target||a.srcElement).tagName;return"INPUT"!=a&&"SELECT"!=a&&"TEXTAREA"!=a};f.key.isPressed=function(a){if("string"==typeof a){if(1!=a.length)return!1;a=a.toUpperCase().charCodeAt(0)}return-1!=g(r,a)};f.key.getPressedKeyCodes=function(){return r};f.key.noConflict=function(){var a=f.key;return f.key=q,a};"undefined"!=typeof module&&(module.exports=key)})(window.frames);
(function(f,g){var l=f.document,k,m=function(c,a,e){var j=this,f,m,q,t,p,v={updated:[]};if(this.listContainer="string"==typeof c?l.getElementById(c):c){this.items=[];this.visibleItems=[];this.matchingItems=[];this.filtered=this.searched=!1;this.list=null;this.templateEngines={};this.page=a.page||200;this.i=a.i||1;m={start:function(a,b){b.plugins=b.plugins||{};this.classes(b);f=new t(j,b);this.callbacks(b);this.items.start(a,b);j.update();this.plugins(b.plugins)},classes:function(a){a.listClass=a.listClass||
"list";a.searchClass=a.searchClass||"search";a.sortClass=a.sortClass||"sort"},callbacks:function(a){j.list=k.getByClass(a.listClass,j.listContainer,!0);k.addEvent(k.getByClass(a.searchClass,j.listContainer),"keyup",j.search);p=k.getByClass(a.sortClass,j.listContainer);k.addEvent(p,"click",j.sort)},items:{start:function(a,b){if(b.valueNames){var d=this.get(),h=b.valueNames;b.indexAsync?this.indexAsync(d,h):this.index(d,h)}a!==g&&j.add(a)},get:function(){for(var a=j.list.childNodes,b=[],d=0,h=a.length;d<
h;d++)a[d].data===g&&b.push(a[d]);return b},index:function(a,b){for(var d=0,h=a.length;d<h;d++)j.items.push(new q(b,a[d]))},indexAsync:function(a,b){var d=a.splice(0,100);this.index(d,b);0<a.length?setTimeout(function(){m.items.indexAsync(a,b)},10):j.update()}},plugins:function(a){for(var b={templater:f,init:m,initialItems:void 0,Item:q,Templater:t,sortButtons:p,events:v,reset:z},d=0;d<a.length;d++)a[d][1]=a[d][1]||{},j[a[d][1].name||a[d][0]]=j.plugins[a[d][0]].call(j,b,a[d][1])}};this.add=function(a,
b){b&&y(a,b);var d=[],h=!1;a[0]===g&&(a=[a]);for(var w=0,c=a.length;w<c;w++)h=null,a[w]instanceof q?(h=a[w],h.reload()):(h=j.items.length>j.page?!0:!1,h=new q(a[w],g,h)),j.items.push(h),d.push(h);j.update();return d};var y=function(a,b,d){var h=a.splice(0,100);d=d||[];d=d.concat(j.add(h));0<a.length?setTimeout(function(){y(a,b,d)},10):(j.update(),b(d))};this.show=function(a,b){this.i=a;this.page=b;j.update()};this.remove=function(a,b,d){for(var h=0,w=0,c=j.items.length;w<c;w++)j.items[w].values()[a]==
b&&(f.remove(j.items[w],d),j.items.splice(w,1),c--,h++);j.update();return h};this.get=function(a,b){for(var d=[],h=0,c=j.items.length;h<c;h++){var x=j.items[h];x.values()[a]==b&&d.push(x)}return 0==d.length?null:1==d.length?d[0]:d};this.sort=function(a,b){var d=null,h=a.target||a.srcElement,c=!1;b=b||{};h===g?(d=a,c=b.asc||!1):(d=k.getAttribute(h,"data-sort"),c=k.hasClass(h,"asc")?!1:!0);for(var x=0,B=p.length;x<B;x++)k.removeClass(p[x],"asc"),k.removeClass(p[x],"desc");c?(h!==g&&k.addClass(h,"asc"),
c=!0):(h!==g&&k.addClass(h,"desc"),c=!1);b.sortFunction=b.sortFunction?b.sortFunction:function(b,a){return k.sorter.alphanum(b.values()[d].toLowerCase(),a.values()[d].toLowerCase(),c)};j.items.sort(b.sortFunction);j.update()};this.search=function(a,b){j.i=1;var d=[],h,c,x,B,e;b=b===g?j.items[0].values():b;a=a===g?"":a;h=a.target||a.srcElement;a=h===g?(""+a).toLowerCase():""+h.value.toLowerCase();e=j.items;a=a.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");f.clear();if(""===a)z.search(),j.searched=!1;
else{j.searched=!0;for(var k=0,l=e.length;k<l;k++){h=!1;c=e[k];B=c.values();for(var n in b)B.hasOwnProperty(n)&&null!==b[n]&&(x=null!=B[n]?B[n].toString().toLowerCase():"",""!==a&&-1<x.search(a)&&(h=!0));h?(c.found=!0,d.push(c)):c.found=!1}}j.update();return j.visibleItems};this.filter=function(a){j.i=1;z.filter();if(a===g)j.filtered=!1;else{j.filtered=!0;for(var b=j.items,d=0,h=b.length;d<h;d++){var c=b[d];c.filtered=a(c)?!0:!1}}j.update();return j.visibleItems};this.size=function(){return j.items.length};
this.clear=function(){f.clear();j.items=[]};this.on=function(a,b){v[a].push(b)};var z={filter:function(){for(var a=j.items,b=a.length;b--;)a[b].filtered=!1},search:function(){for(var a=j.items,b=a.length;b--;)a[b].found=!1}};this.update=function(){var a=j.items,b=a.length;j.visibleItems=[];j.matchingItems=[];f.clear();for(var d=0;d<b;d++)a[d].matching()&&j.matchingItems.length+1>=j.i&&j.visibleItems.length<j.page?(a[d].show(),j.visibleItems.push(a[d]),j.matchingItems.push(a[d])):(a[d].matching()&&
j.matchingItems.push(a[d]),a[d].hide());for(a=v.updated.length;a--;)v.updated[a]()};q=function(a,b,d){var h=this,c={};this.filtered=this.found=!1;this.values=function(a,b){if(a!==g){for(var d in a)c[d]=a[d];!0!==b&&f.set(h,h.values())}else return c};this.show=function(){f.show(h)};this.hide=function(){f.hide(h)};this.matching=function(){return j.filtered&&j.searched&&h.found&&h.filtered||j.filtered&&!j.searched&&h.filtered||!j.filtered&&j.searched&&h.found||!j.filtered&&!j.searched};this.visible=
function(){return h.elm.parentNode?!0:!1};b===g?d?h.values(a,d):h.values(a):(h.elm=b,a=f.get(h,a),h.values(a))};t=function(a,b){b.engine=b.engine===g?"standard":b.engine.toLowerCase();return new j.constructor.prototype.templateEngines[b.engine](a,b)};m.start(e,a)}};m.prototype.templateEngines={};m.prototype.plugins={};m.prototype.templateEngines.standard=function(c,a){var e=k.getByClass(a.listClass,c.listContainer,!0),j=function(c){if(c===g){c=e.childNodes;for(var j=0,f=c.length;j<f;j++)if(c[j].data===
g)return c[j];return null}return-1!==c.indexOf("<")?(j=l.createElement("div"),j.innerHTML=c,j.firstChild):l.getElementById(a.item)}(a.item),f=this,m={created:function(a){a.elm===g&&f.create(a)}};this.get=function(a,c){m.created(a);for(var j={},e=0,f=c.length;e<f;e++){var g=k.getByClass(c[e],a.elm,!0);j[c[e]]=g?g.innerHTML:""}return j};this.set=function(a,c){m.created(a);for(var j in c)if(c.hasOwnProperty(j)){var e=k.getByClass(j,a.elm,!0);e&&(e.innerHTML=c[j])}};this.create=function(a){if(a.elm===
g){var c=j.cloneNode(!0);c.id="";a.elm=c;f.set(a,a.values())}};this.remove=function(a){e.removeChild(a.elm)};this.show=function(a){m.created(a);e.appendChild(a.elm)};this.hide=function(a){a.elm!==g&&a.elm.parentNode===e&&e.removeChild(a.elm)};this.clear=function(){if(e.hasChildNodes())for(;1<=e.childNodes.length;)e.removeChild(e.firstChild)}};var e=this;k={getByClass:l.getElementsByClassName?function(c,a,e){return e?a.getElementsByClassName(c)[0]:a.getElementsByClassName(c)}:function(c,a,e){var j=
[];null==a&&(a=l);a=a.getElementsByTagName("*");var f=a.length;c=RegExp("(^|\\s)"+c+"(\\s|$)");for(var g=0,k=0;g<f;g++)if(c.test(a[g].className)){if(e)return a[g];j[k]=a[g];k++}return j},addEvent:l.addEventListener?function(c,a,f){if(c&&!(c instanceof Array)&&!c.length&&!k.isNodeList(c)&&0!==c.length||c===e)c.addEventListener(a,f,!1);else if(c&&c[0]!==g)for(var j=c.length,l=0;l<j;l++)k.addEvent(c[l],a,f)}:l.attachEvent?function(c,a,f){if(c&&!(c instanceof Array)&&!c.length&&!k.isNodeList(c)&&0!==
c.length||c===e)c.attachEvent("on"+a,function(){return f.call(c,e.event)});else if(c&&c[0]!==g)for(var j=c.length,l=0;l<j;l++)k.addEvent(c[l],a,f)}:void 0,getAttribute:function(c,a){var e=c.getAttribute&&c.getAttribute(a)||null;if(!e)for(var j=c.attributes.length,f=0;f<j;f++)a[f]!==g&&a[f].nodeName===a&&(e=a[f].nodeValue);return e},isNodeList:function(c){var a=Object.prototype.toString.call(c);return"object"===typeof c&&/^\[object (HTMLCollection|NodeList|Object)\]$/.test(a)&&(0==c.length||"object"===
typeof c[0]&&0<c[0].nodeType)?!0:!1},hasClass:function(c,a){return-1<(this.getAttribute(c,"class")||this.getAttribute(c,"className")||"").search(a)},addClass:function(c,a){if(!this.hasClass(c,a)){var e=this.getAttribute(c,"class")||this.getAttribute(c,"className")||"",e=(e+" "+a+" ").replace(/\s{2,}/g," ");c.setAttribute("class",e)}},removeClass:function(c,a){if(this.hasClass(c,a)){var e=this.getAttribute(c,"class")||this.getAttribute(c,"className")||"",e=e.replace(a,"");c.setAttribute("class",e)}},
sorter:{alphanum:function(c,a,e){if(c===g||null===c)c="";if(a===g||null===a)a="";c=c.toString().replace(/&(lt|gt);/g,function(a,c){return"lt"==c?"<":">"});c=c.replace(/<\/?[^>]+(>|$)/g,"");a=a.toString().replace(/&(lt|gt);/g,function(a,c){return"lt"==c?"<":">"});a=a.replace(/<\/?[^>]+(>|$)/g,"");c=this.chunkify(c);a=this.chunkify(a);for(var j=0;c[j]&&a[j];j++)if(c[j]!==a[j]){var f=Number(c[j]),k=Number(a[j]);return e?f==c[j]&&k==a[j]?f-k:c[j]>a[j]?1:-1:f==c[j]&&k==a[j]?k-f:c[j]>a[j]?-1:1}return c.length-
a.length},chunkify:function(c){for(var a=[],e=0,j=-1,f=0,g,k;g=(k=c.charAt(e++)).charCodeAt(0);)g=45==g||46==g||48<=g&&57>=g,g!==f&&(a[++j]="",f=g),a[j]+=k;return a}}};f.List=m;f.ListJsHelpers=k})(window);
window.picoModal=function(f){var g=function(){var f=[];return{watch:function(g){f.push(g)},trigger:function(){for(var g=0;g<f.length;g++)setTimeout(f[g],1)}}},l=function(g){var m=f.createElement("div");(g||f.body).appendChild(m);var e={elem:m,child:function(){return l(m)},stylize:function(c){c=c||{};"undefined"!=typeof c.opacity&&(c.filter="alpha(opacity="+100*c.opacity+")");for(var a in c)c.hasOwnProperty(a)&&(m.style[a]=c[a]);return e},clazz:function(c){m.className+=c;return e},html:function(c){m.innerHTML=
c;return e},getWidth:function(){return m.clientWidth},onClick:function(c){m.attachEvent?m.attachEvent("onclick",c):m.addEventListener("click",c);return e},destroy:function(){f.body.removeChild(m);return e}};return e};return function(f){"string"===typeof f&&(f={content:f,closeButton:!0});var m,e=f.overlayStyles,c=g(),e=l().clazz("pico-overlay").stylize({display:"block",position:"fixed",top:"0px",left:"0px",height:"100%",width:"100%",opacity:0.5,zIndex:1E4,background:"#000"}).stylize(e).onClick(c.trigger);
m={elem:e.elem,destroy:e.destroy,onClick:c.watch};var a=g(),n=l().clazz("pico-content").stylize({display:"block",position:"fixed",zIndex:10001,left:"50%",top:"50px",backgroundColor:"white",padding:"20px",borderRadius:"5px"}).html(f.content),c=f.width||n.getWidth();n.stylize({width:c+"px",margin:"0 0 0 "+(-(c/2)+"px")}).stylize(f.modalStyles);c=function(){a.trigger();m.destroy();n.destroy()};m.onClick(c);var j;f.closeButton&&(j=n.child().html("&#xD7;").clazz("pico-close").stylize({borderRadius:"2px",
cursor:"pointer",height:"15px",width:"15px",position:"absolute",top:"5px",right:"5px",fontSize:"16px",textAlign:"center",lineHeight:"15px",background:"#CCC"}).stylize(f.closeStyles).onClick(c));return{modalElem:n.elem,closeElem:j.elem,overlayElem:m.elem,close:c,onClose:a.watch}}}(document);var TAFFY,exports,T;
(function(){var f,g,l,k,m,e,c,a,n,j,A,r,q,t,p;if(!TAFFY){m=1;e={};c=function(a){return TAFFY.isArray(a)||TAFFY.isObject(a)?a:JSON.parse(a)};a=function(a,d,h){var c,e,f,j;if(a&&(T.isArray(a)&&1===a.length||!T.isArray(a)))d(T.isArray(a)?a[0]:a,0);else{c;e;f=0;a=T.isArray(a)?a:[a];for(j=a.length;f<j;f++)if(e=a[f],!T.isUndefined(e)||h)if(c=d(e,f),c===T.EXIT)break}};n=function(a,d){var h=0,c,e;for(e in a)if(a.hasOwnProperty(e)&&(c=d(a[e],e,h++),c===T.EXIT))break};e.extend=function(a,d){e[a]=function(){return d.apply(this,
arguments)}};j=function(b){var d;return T.isString(b)&&/[t][0-9]*[r][0-9]*/i.test(b)||T.isObject(b)&&b.___id&&b.___s?!0:T.isArray(b)?(d=!0,a(b,function(a){if(!j(a))return d=!1,TAFFY.EXIT}),d):!1};r=function(b,d){var h=!0;a(d,function(d){switch(T.typeOf(d)){case "function":if(!d.apply(b))return h=!1,TAFFY.EXIT;break;case "array":h=1===d.length?r(b,d[0]):2===d.length?r(b,d[0])||r(b,d[1]):3===d.length?r(b,d[0])||r(b,d[1])||r(b,d[2]):4===d.length?r(b,d[0])||r(b,d[1])||r(b,d[2])||r(b,d[3]):!1,4<d.length&&
a(d,function(a){r(b,a)&&(h=!0)})}});return h};A=function(b){var d=[];T.isString(b)&&/[t][0-9]*[r][0-9]*/i.test(b)&&(b={___id:b});if(T.isArray(b))return a(b,function(a){d.push(A(a))}),function(){var b=this,c=!1;a(d,function(a){r(b,a)&&(c=!0)});return c};if(T.isObject(b))return T.isObject(b)&&b.___id&&b.___s&&(b={___id:b.___id}),n(b,function(b,c){T.isObject(b)||(b={is:b});n(b,function(b,h){var e=[];("hasAll"===h?function(a,d){d(a)}:a)(b,function(a){var d=!0;e.push(function(){var b=this[c];0===h.indexOf("!")&&
"!="!==h&&"!=="!==h&&(d=!1,h=h.substring(1,h.length));return(b="regex"===h?a.test(b):"lt"===h||"<"===h?b<a:"gt"===h||">"===h?b>a:"lte"===h||"<="===h?b<=a:"gte"===h||">="===h?b>=a:"left"===h?0===b.indexOf(a):"leftnocase"===h?0===b.toLowerCase().indexOf(a.toLowerCase()):"right"===h?b.substring(b.length-a.length)===a:"rightnocase"===h?b.toLowerCase().substring(b.length-a.length)===a.toLowerCase():"like"===h?0<=b.indexOf(a):"likenocase"===h?0<=b.toLowerCase().indexOf(a.toLowerCase()):"==="===h||"is"===
h?b===a:"=="===h?b==a:"!=="===h?b!==a:"!="===h?b!=a:"isnocase"===h?b.toLowerCase?b.toLowerCase()===a.toLowerCase():b===a:"has"===h?T.has(b,a):"hasall"===h?T.hasAll(b,a):-1===h.indexOf("is")&&!TAFFY.isNull(b)&&!TAFFY.isUndefined(b)&&!TAFFY.isObject(a)&&!TAFFY.isArray(a)?a===b[h]:T[h]&&T.isFunction(T[h])&&0===h.indexOf("is")?T[h](b)===a:T[h]&&T.isFunction(T[h])?T[h](b,a):!1)&&!d?!1:!b&&!d?!0:b})});1===e.length?d.push(e[0]):d.push(function(){var b=this,d=!1;a(e,function(a){a.apply(b)&&(d=!0)});return d})})}),
function(){var b=this,c=!0,c=1===d.length&&!d[0].apply(b)?!1:2===d.length&&(!d[0].apply(b)||!d[1].apply(b))?!1:3===d.length&&(!d[0].apply(b)||!d[1].apply(b)||!d[2].apply(b))?!1:4===d.length&&(!d[0].apply(b)||!d[1].apply(b)||!d[2].apply(b)||!d[3].apply(b))?!1:!0;4<d.length&&a(d,function(a){r(b,a)||(c=!1)});return c};if(T.isFunction(b))return b};t=function(a,d){var h=function(a,b){var h=0;T.each(d,function(d){var c,e,f;c=d.split(" ");d=c[0];c=1===c.length?"logical":c[1];if("logical"===c)e=q(a[d]),f=
q(b[d]),T.each(e.length<=f.length?e:f,function(a,b){if(e[b]<f[b])return h=-1,TAFFY.EXIT;if(e[b]>f[b])return h=1,TAFFY.EXIT});else if("logicaldesc"===c)e=q(a[d]),f=q(b[d]),T.each(e.length<=f.length?e:f,function(a,b){if(e[b]>f[b])return h=-1,TAFFY.EXIT;if(e[b]<f[b])return h=1,TAFFY.EXIT});else{if("asec"===c&&a[d]<b[d])return h=-1,T.EXIT;if("asec"===c&&a[d]>b[d])return h=1,T.EXIT;if("desc"===c&&a[d]>b[d])return h=-1,T.EXIT;if("desc"===c&&a[d]<b[d])return h=1,T.EXIT}0===h&&"logical"===c&&e.length<f.length?
h=-1:0===h&&"logical"===c&&e.length>f.length?h=1:0===h&&"logicaldesc"===c&&e.length>f.length?h=-1:0===h&&"logicaldesc"===c&&e.length<f.length&&(h=1);if(0!==h)return T.EXIT});return h};return a&&a.push?a.sort(h):a};var v={},y=0;q=function(a){1E3<y&&(v={},y=0);var d;if(!(d=v["_"+a])){d=String(a);var h=[],c="_",e="",f,j,g;f=0;for(j=d.length;f<j;f++)g=d.charCodeAt(f),48<=g&&57>=g||46===g?"n"!==e&&(e="n",h.push(c.toLowerCase()),c=""):"s"!==e&&(e="s",h.push(parseFloat(c)),c=""),c+=d.charAt(f);h.push("n"===
e?parseFloat(c):c.toLowerCase());h.shift();v["_"+a]=h;y++;d=h}return d};p=function(){this.context({results:this.getDBI().query(this.context())})};e.extend("filter",function(){var b=TAFFY.mergeObj(this.context(),{run:null}),d=[];a(b.q,function(a){d.push(a)});b.q=d;a(arguments,function(a){b.q.push(A(a));b.filterRaw.push(a)});return this.getroot(b)});e.extend("order",function(b){b=b.split(",");var d=[];a(b,function(a){d.push(a.replace(/^\s*/,"").replace(/\s*$/,""))});b=TAFFY.mergeObj(this.context(),
{sort:null});b.order=d;return this.getroot(b)});e.extend("limit",function(b){var d=TAFFY.mergeObj(this.context(),{}),h;d.limit=b;d.run&&d.sort&&(h=[],a(d.results,function(a,d){if(d+1>b)return TAFFY.EXIT;h.push(a)}),d.results=h);return this.getroot(d)});e.extend("start",function(b){var d=TAFFY.mergeObj(this.context(),{}),h;d.start=b;d.run&&d.sort&&!d.limit?(h=[],a(d.results,function(a,d){d+1>b&&h.push(a)}),d.results=h):d=TAFFY.mergeObj(this.context(),{run:null,start:b});return this.getroot(d)});e.extend("update",
function(b,d,h){var c=!0,e={},f=arguments,j;TAFFY.isString(b)&&(2===arguments.length||3===arguments.length)?(e[b]=d,3===arguments.length&&(c=h)):(e=b,2===f.length&&(c=d));j=this;p.call(this);a(this.context().results,function(a){var b=e;TAFFY.isFunction(b)?b=b.apply(TAFFY.mergeObj(a,{})):T.isFunction(b)&&(b=b(TAFFY.mergeObj(a,{})));TAFFY.isObject(b)&&j.getDBI().update(a.___id,b,c)});this.context().results.length&&this.context({run:null});return this});e.extend("remove",function(b){var d=this,h=0;p.call(this);
a(this.context().results,function(a){d.getDBI().remove(a.___id);h++});this.context().results.length&&(this.context({run:null}),d.getDBI().removeCommit(b));return h});e.extend("count",function(){p.call(this);return this.context().results.length});e.extend("callback",function(a,d){if(a){var h=this;setTimeout(function(){p.call(h);a.call(h.getroot(h.context()))},d||0)}return null});e.extend("get",function(){p.call(this);return this.context().results});e.extend("stringify",function(){return JSON.stringify(this.get())});
e.extend("first",function(){p.call(this);return this.context().results[0]||!1});e.extend("last",function(){p.call(this);return this.context().results[this.context().results.length-1]||!1});e.extend("sum",function(){var b=0,d=this;p.call(d);a(arguments,function(h){a(d.context().results,function(a){b+=a[h]})});return b});e.extend("min",function(b){var d=null;p.call(this);a(this.context().results,function(a){if(null===d||a[b]<d)d=a[b]});return d});var z,s;z=function(a,d,c){var e;2===c.length?(a=a[c[0]],
e="===",d=d[c[1]]):(a=a[c[0]],e=c[1],d=d[c[2]]);switch(e){case "===":return a===d;case "!==":return a!==d;case "<":return a<d;case ">":return a>d;case "<=":return a<=d;case ">=":return a>=d;case "==":return a==d;case "!=":return a!=d;default:throw String(e)+" is not supported";}};s=function(a,d){var c={},e,f;for(e in a)a.hasOwnProperty(e)&&(c[e]=a[e]);for(e in d)d.hasOwnProperty(e)&&"___id"!==e&&"___s"!==e&&(f=!TAFFY.isUndefined(c[e])?"right_":"",c[f+String(e)]=d[e]);return c};e.extend("join",function(a){var d,
c,e=arguments,f=e.length,j=[];if("function"!==typeof a.filter)if(a.TAFFY)d=a();else throw"TAFFY DB or result not supplied";else d=a;this.context({results:this.getDBI().query(this.context())});TAFFY.each(this.context().results,function(a){d.each(function(d){var b;b=!0;c=1;a:for(;c<f;c++)if(b=e[c],b="function"===typeof b?b(a,d):"object"===typeof b&&b.length?z(a,d,b):!1,!b)break a;b&&j.push(s(a,d))})});return TAFFY(j)()});e.extend("max",function(b){var d=null;p.call(this);a(this.context().results,function(a){if(null===
d||a[b]>d)d=a[b]});return d});e.extend("select",function(){var b=[],d=arguments;p.call(this);1===arguments.length?a(this.context().results,function(a){b.push(a[d[0]])}):a(this.context().results,function(c){var e=[];a(d,function(a){e.push(c[a])});b.push(e)});return b});e.extend("distinct",function(){var b=[],d=arguments;p.call(this);1===arguments.length?a(this.context().results,function(c){var e=c[d[0]],f=!1;a(b,function(a){if(e===a)return f=!0,TAFFY.EXIT});f||b.push(e)}):a(this.context().results,
function(c){var e=[],f=!1;a(d,function(a){e.push(c[a])});a(b,function(b){var c=!0;a(d,function(a,d){if(e[d]!==b[d])return c=!1,TAFFY.EXIT});if(c)return f=!0,TAFFY.EXIT});f||b.push(e)});return b});e.extend("supplant",function(b,d){var c=[];p.call(this);a(this.context().results,function(a){c.push(b.replace(/\{([^\{\}]*)\}/g,function(d,b){var c=a[b];return"string"===typeof c||"number"===typeof c?c:d}))});return!d?c.join(""):c});e.extend("each",function(b){p.call(this);a(this.context().results,b);return this});
e.extend("map",function(b){var d=[];p.call(this);a(this.context().results,function(a){d.push(b(a))});return d});TAFFY=T=function(b){var d=[],h={},f=1,g={template:!1,onInsert:!1,onUpdate:!1,onRemove:!1,onDBChange:!1,storageName:!1,forcePropertyCase:null,cacheSize:100,name:""},l=new Date,k=0,p=0,s={},q,v,u;v=function(b){var c=[],e=!1;if(0===b.length)return d;a(b,function(b){T.isString(b)&&/[t][0-9]*[r][0-9]*/i.test(b)&&d[h[b]]&&(c.push(d[h[b]]),e=!0);T.isObject(b)&&b.___id&&(b.___s&&d[h[b.___id]])&&
(c.push(d[h[b.___id]]),e=!0);T.isArray(b)&&a(b,function(b){a(v(b),function(a){c.push(a)})})});e&&1<c.length&&(c=[]);return c};q={dm:function(a){a&&(l=a,s={},p=k=0);g.onDBChange&&setTimeout(function(){g.onDBChange.call(d)},0);g.storageName&&setTimeout(function(){localStorage.setItem("taffy_"+g.storageName,JSON.stringify(d))});return l},insert:function(b,e){var j=[],l=[],k=c(b);a(k,function(b,c){var k,C;if(T.isArray(b)&&0===c)return a(b,function(a){j.push("lower"===g.forcePropertyCase?a.toLowerCase():
"upper"===g.forcePropertyCase?a.toUpperCase():a)}),!0;T.isArray(b)?(k={},a(b,function(a,b){k[j[b]]=a}),b=k):T.isObject(b)&&g.forcePropertyCase&&(C={},n(b,function(a,d){C["lower"===g.forcePropertyCase?d.toLowerCase():"upper"===g.forcePropertyCase?d.toUpperCase():d]=b[d]}),b=C);f++;b.___id="T"+String("000000"+m).slice(-6)+"R"+String("000000"+f).slice(-6);b.___s=!0;l.push(b.___id);g.template&&(b=T.mergeObj(g.template,b));d.push(b);h[b.___id]=d.length-1;g.onInsert&&(e||TAFFY.isUndefined(e))&&g.onInsert.call(b);
q.dm(new Date)});return u(l)},sort:function(b){d=t(d,b.split(","));h={};a(d,function(a,b){h[a.___id]=b});q.dm(new Date);return!0},update:function(a,b,c){var e={},f,j,k;g.forcePropertyCase&&(n(b,function(a,b){e["lower"===g.forcePropertyCase?b.toLowerCase():"upper"===g.forcePropertyCase?b.toUpperCase():b]=a}),b=e);f=d[h[a]];b=T.mergeObj(f,b);j={};k=!1;n(b,function(a,b){if(TAFFY.isUndefined(f[b])||f[b]!==a)j[b]=a,k=!0});k&&(g.onUpdate&&(c||TAFFY.isUndefined(c))&&g.onUpdate.call(b,d[h[a]],j),d[h[a]]=
b,q.dm(new Date))},remove:function(a){d[h[a]].___s=!1},removeCommit:function(b){var c;for(c=d.length-1;-1<c;c--)d[c].___s||(g.onRemove&&(b||TAFFY.isUndefined(b))&&g.onRemove.call(d[c]),h[d[c].___id]=void 0,d.splice(c,1));h={};a(d,function(a,b){h[a.___id]=b});q.dm(new Date)},query:function(b){var c,e,h,f,j;g.cacheSize&&(e="",a(b.filterRaw,function(a){if(T.isFunction(a))return e="nocache",TAFFY.EXIT}),""===e&&(e=JSON.stringify(T.mergeObj(b,{q:!1,run:!1,sort:!1}))));if(!b.results||!b.run||b.run&&q.dm()>
b.run){h=[];if(g.cacheSize&&s[e])return s[e].i=k++,s[e].results;0===b.q.length&&0===b.index.length?a(d,function(a){h.push(a)}):(c=v(b.index),a(c,function(a){(0===b.q.length||r(a,b.q))&&h.push(a)}));c=h}else c=b.results;if(0<b.order.length&&(!b.run||!b.sort))c=t(c,b.order);if(c.length&&(b.limit&&b.limit<c.length||b.start))f=[],a(c,function(a,d){if(!b.start||b.start&&d+1>=b.start)if(b.limit)if(j=b.start?d+1-b.start:d,j<b.limit)f.push(a);else{if(j>b.limit)return TAFFY.EXIT}else f.push(a)}),c=f;g.cacheSize&&
"nocache"!==e&&(p++,setTimeout(function(){var a,b;p>=2*g.cacheSize&&(p=0,a=k-g.cacheSize,b={},n(function(d,c){d.i>=a&&(b[c]=d)}),s=b)},0),s[e]={i:k++,results:c});return c}};u=function(){var b,d;b=TAFFY.mergeObj(TAFFY.mergeObj(e,{insert:void 0}),{getDBI:function(){return q},getroot:function(a){return u.call(a)},context:function(a){a&&(d=TAFFY.mergeObj(d,a.hasOwnProperty("results")?TAFFY.mergeObj(a,{run:new Date,sort:new Date}):a));return d},extend:void 0});d=this&&this.q?this:{limit:!1,start:!1,q:[],
filterRaw:[],index:[],order:[],results:!1,run:null,sort:null,settings:g};a(arguments,function(a){j(a)?d.index.push(a):d.q.push(A(a));d.filterRaw.push(a)});return b};m++;b&&q.insert(b);u.insert=q.insert;u.merge=function(b,d,c){var e={},h=[],f={};c=c||!1;d=d||"id";a(b,function(a){var b;e[d]=a[d];h.push(a[d]);(b=u(e).first())?q.update(b.___id,a,c):q.insert(a,c)});f[d]=h;return u(f)};u.TAFFY=!0;u.sort=q.sort;u.settings=function(a){a&&(g=TAFFY.mergeObj(g,a),a.template&&u().update(a.template));return g};
u.store=function(a){var b;localStorage&&(a&&((b=localStorage.getItem("taffy_"+a))&&0<b.length&&u.insert(b),0<d.length&&setTimeout(function(){localStorage.setItem("taffy_"+g.storageName,JSON.stringify(d))})),u.settings({storageName:a}));return u};return u};T.each=a;T.eachin=n;T.extend=e.extend;TAFFY.EXIT="TAFFYEXIT";TAFFY.mergeObj=function(a,d){var c={};n(a,function(d,e){c[e]=a[e]});n(d,function(a,b){c[b]=d[b]});return c};TAFFY.has=function(b,d){var c=!0,e;if(b.TAFFY){if(c=b(d),0<c.length)return!0}else switch(T.typeOf(b)){case "object":if(T.isObject(d))n(d,
function(a,e){if(!0===c&&!T.isUndefined(b[e])&&b.hasOwnProperty(e))c=T.has(b[e],d[e]);else return c=!1,TAFFY.EXIT});else if(T.isArray(d))a(d,function(a,e){if(c=T.has(b,d[e]))return TAFFY.EXIT});else if(T.isString(d))if(TAFFY.isUndefined(b[d]))break;else return!0;return c;case "array":if(T.isObject(d))a(b,function(a,e){c=T.has(b[e],d);if(!0===c)return TAFFY.EXIT});else if(T.isArray(d))a(d,function(e,f){a(b,function(a,e){c=T.has(b[e],d[f]);if(!0===c)return TAFFY.EXIT});if(!0===c)return TAFFY.EXIT});
else if(T.isString(d)||T.isNumber(d))for(e=0;e<b.length;e++)if(c=T.has(b[e],d))return!0;return c;case "string":if(T.isString(d)&&d===b)return!0;break;default:if(T.typeOf(b)===T.typeOf(d)&&b===d)return!0}return!1};TAFFY.hasAll=function(b,d){var c=TAFFY,e;return c.isArray(d)?(e=!0,a(d,function(a){e=c.has(b,a);if(!1===e)return TAFFY.EXIT}),e):c.has(b,d)};TAFFY.typeOf=function(a){var d=typeof a;"object"===d&&(a?"number"===typeof a.length&&!a.propertyIsEnumerable("length")&&(d="array"):d="null");return d};
TAFFY.getObjectKeys=function(a){var d=[];n(a,function(a,b){d.push(b)});d.sort();return d};TAFFY.isSameArray=function(a,d){return TAFFY.isArray(a)&&TAFFY.isArray(d)&&a.join(",")===d.join(",")?!0:!1};TAFFY.isSameObject=function(a,d){var c=TAFFY,e=!0;c.isObject(a)&&c.isObject(d)?c.isSameArray(c.getObjectKeys(a),c.getObjectKeys(d))?n(a,function(f,g){if(!(c.isObject(a[g])&&c.isObject(d[g])&&c.isSameObject(a[g],d[g])||c.isArray(a[g])&&c.isArray(d[g])&&c.isSameArray(a[g],d[g])||a[g]===d[g]))return e=!1,
TAFFY.EXIT}):e=!1:e=!1;return e};f="String Number Object Array Boolean Null Function Undefined".split(" ");g=function(a){return function(c){return TAFFY.typeOf(c)===a.toLowerCase()?!0:!1}};for(l=0;l<f.length;l++)k=f[l],TAFFY["is"+k]=g(k)}})();"object"===typeof exports&&(exports.taffy=TAFFY);function flatten(f){var g={},l=function(f,m){var e,c,a;for(c in f)f.hasOwnProperty(c)&&(e=f[c],a=m?m+"$"+c:c,"[object Object]"===e.toString()?l(e,a):g[a]=e)};l(f);return g}
function namespace(f,g,l){g=g.split("$");var k,m;k=0;for(m=g.length;k<m;k++)"undefined"===typeof f[g[k]]&&(f[g[k]]={}),k===m-1&&(f[g[k]]=l),f=f[g[k]];return f}function unflatten(f){var g={},l;for(l in f)f.hasOwnProperty(l)&&namespace(g,l,f[l]);return g}function extend(f,g){for(var l in g)g.hasOwnProperty(l)&&(f[l]=g[l])}var ImpHelper={},IH=ImpHelper;IH.global=window.frames;IH.global.IH=IH;IH.html={};
IH.html.getTable=function(f,g){var l=g||"";l&&(l="<thead>"+l+"</thead>");return'<table width="100%" border="1" style="table-layout: fixed; border-collapse: collapse;">'+l+'<tbody class="list">'+f+"</tbody></table>"};IH.Planet=function(f){extend(this,f)};IH.Planet.prototype.toFlat=function(){return flatten(this)};
IH.init=function(){IH.db={};IH.db.planets=TAFFY();IH.db.planets.store("planets");IH.picoWindows={};IH.picoWindows.counter=0;IH.picoWindows.genID=function(f,g){this.counter++;f.ID="picoWindow_"+this.counter;IH.global[g]&&IH.global[g].close();IH.global[g]=f;f.onClose(function(){delete IH.global[g]})}};IH.processData=function(f,g,l){"/map/index/system/"===f&&IH.processPlanets(l.planets,l.id_system);"/stream/report/index/"===f&&GM_log(l)};
IH.processPlanets=function(f){var g,l=0,k=0,m,e;if(0!==f.length){for(g in f)m=new IH.Planet(f[g]),e=IH.db.planets({id_planet:m.id_planet}),0<e.get().length?(e.update(m.toFlat()),l++):(IH.db.planets.insert(m.toFlat()),k++);GM_log("planets: inserted = "+k+", updated = "+l)}};IH.scan=function(){};IH.showModal=function(f,g){var l=picoModal({content:"<style>a {color: #00C};</style>"+f,closeButton:!0,overlayStyles:{backgroundColor:"#222",opacity:0.75}});IH.picoWindows.genID(l,g)};
IH.showInfo=function(f,g,l){f=picoModal({content:"<style>a {color: #00C};</style><h1>"+(g||"Information message")+"</h1><br />"+f,closeButton:!0,overlayStyles:{backgroundColor:l||"#0F0",opacity:0.5}});IH.picoWindows.genID(f,"pw_info")};
IH.showModalTable=function(f,g){var l,k,m,e;e=f.fields;m="<tr>";k='<tr><tr><th colspan="'+e.length+'"><input type="text" class="search" placeholder="Search in columns" /></th></tr>';for(l=0;l<e.length;l++)k=k+'<th class="sort" data-sort="'+e[l].name+'">'+e[l].title+"</th>",m=e[l].href?m+'<td class="'+e[l].name+'"><a href="'+e[l].href+'">{'+e[l].name+"}</a></td>":m+'<td class="'+e[l].name+'">{'+e[l].name+"}</td>";k+="</tr>";m+="</tr>";f.defaultSort&&(g=g.order(f.defaultSort));l=g.supplant(m);k=IH.html.getTable(l,
k);k=k.replace(/{[^}]*}/g,"");IH.showModal("<h2>"+f.title+'</h2><br><div id="dataList1" style="width: 700px; height: 500px; overflow: auto">'+k+"</div>","pw_table");e={valueNames:e.map(function(c){return c.name})};new List("dataList1",e)};
IH.information=function(f){if(1===f){f=IH.db.planets({account_name:{isUndefined:!1}});var g={title:"Colonized or annexed planets",fields:[{name:"name",title:"Name",href:"/map/index/index/stage/ORB/targetPlanetId/{id_planet}",canSort:!0},{name:"annexed",title:"Annexed",canSort:!0},{name:"account_name",title:"Player",canSort:!0},{name:"map_info$info$alliance_name",title:"Aliance",canSort:!0},{name:"account_kind",title:"Type",canSort:!0}]};IH.showModalTable(g,f)}else 2===f?(f=IH.db.planets({account_name:{isUndefined:!1}},
{annexed:{isUndefined:!0}}),g={title:"Players planets",fields:[{name:"name",title:"Name",href:"/map/index/index/stage/ORB/targetPlanetId/{id_planet}",canSort:!0},{name:"account_name",title:"Player",canSort:!0},{name:"map_info$info$alliance_name",title:"Aliance",canSort:!0},{name:"account_kind",title:"Type",canSort:!0}]},IH.showModalTable(g,f)):3===f?(f=IH.db.planets({map_info$bonuses$0$caption:{isUndefined:!1}},{map_info$bonuses$1$caption:{isUndefined:!1}}),g={title:"Special bonuses of planets",defaultSort:"map_info$bonuses$0$caption desc, map_info$bonuses$0$value desc, map_info$bonuses$1$caption desc, map_info$bonuses$1$value desc",
fields:[{name:"name",title:"Name",href:"/map/index/index/stage/ORB/targetPlanetId/{id_planet}",canSort:!0},{name:"account_name",title:"Player",canSort:!0},{name:"map_info$bonuses$0$caption",title:"Bonus 1",canSort:!0},{name:"map_info$bonuses$0$value",title:"Value 1",canSort:!0},{name:"map_info$bonuses$1$caption",title:"Bonus 2",canSort:!0},{name:"map_info$bonuses$1$value",title:"Value 2",canSort:!0}]},IH.showModalTable(g,f)):4===f?(g={title:"Annexation production",defaultSort:"map_info$production$caption desc",
fields:[{name:"name",title:"Name",href:"/map/index/index/stage/ORB/targetPlanetId/{id_planet}",canSort:!0},{name:"account_name",title:"Player",canSort:!0},{name:"map_info$production$caption",title:"Caption",canSort:!0},{name:"map_info$production$resources$metal",title:"Metal",canSort:!0},{name:"map_info$production$resources$crystal",title:"Metal",canSort:!0},{name:"map_info$production$resources$tritium",title:"Tritium",canSort:!0}]},f=IH.db.planets({map_info$production$caption:{isUndefined:!1}}),
IH.showModalTable(g,f)):IH.showModal('<h2>Informations from local storage</h2><br><div style="width: 700px; height: 500px; overflow: auto"><a href="#" onclick="IH.information(1); ">Colonized or annexed planets</a><br><a href="#" onclick="IH.information(2); ">Players planets</a><br><a href="#" onclick="IH.information(3); ">Special bonuses of planets</a><br><a href="#" onclick="IH.information(4); ">Annexation production (search able, sort able)</a><br></div>',"pw_main")};
IH.global.key("ctrl+i",function(){IH.information();return!1});IH.global.key("ctrl+e",function(){IH.showInfo("<textarea cols='100' rows='25'>"+IH.db.planets().stringify()+"</textarea>","Export");return!1});IH.global.key("ctrl+d",function(){IH.showInfo("<textarea cols='100' rows='25' id='ih_importArea'></textarea><br><input type='button' value='import' onclick='IH.planet_import();' />","Import");return!1});
IH.planet_import=function(){var f=document.getElementById("ih_importArea");IH.db.planets.merge(f.value,"id_planet");IH.showInfo("Import ok")};IH.init();GM_log("********************** injecting ImpHelper **********************");var Imperion=window.frames.Imperion,injectListener={};injectListener.tmpSend=Imperion.Util.Request.send;
Imperion.Util.Request.send=function(f,g,l,k,m){var e=l;l=function(c,a){GM_log([f,g,l,k,m,c,a]);IH.processData(f,g,c.jsonDataDefault.data);e.apply(this,[c,a])};injectListener.tmpSend.apply(this,[f,g,l,k,m])};