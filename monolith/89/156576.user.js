// ==UserScript==
// @name	Tieba Float Movable
// @namespace	http://gera2ld.blog.163.com/
// @author	Gerald <gera2ld@163.com>
// @icon	http://s.gravatar.com/avatar/a0ad718d86d21262ccd6ff271ece08a3?s=80
// @version	1.2.8
// @description	贴吧可移动悬浮窗
// @homepage	http://userscripts.org/scripts/show/156576
// @downloadURL	https://userscripts.org/scripts/source/156576.user.js
// @updateURL	https://userscripts.org/scripts/source/156576.meta.js
// @include	http://tieba.baidu.com/*
// @exclude	http://tieba.baidu.com/tb/*
// @require	http://userscripts.org/scripts/source/186749.user.js
// @grant	GM_getValue
// @grant	GM_setValue
// @grant	GM_registerMenuCommand
// ==/UserScript==
function t(t,e){var i={};args.forEach(function(t){i[t]=/^-?\d+px/.test(e[t])?e[t]:"20px"}),t.css(i)}function e(e,i){var o=$(e);o.mousedown&&(e.moving=!1,args=["right","bottom"],o.mousedown(function(n){["DIV","TD"].indexOf(n.target.tagName)<0||"true"==n.target.contentEditable||(n.preventDefault(),n.stopPropagation(),e.x=n.pageX,args.indexOf("left")>=0?e.x-=parseInt(o.css("left")):e.x+=parseInt(o.css("right")),e.y=n.pageY,args.indexOf("top")>=0?e.y-=parseInt(o.css("top")):e.y+=parseInt(o.css("bottom")),e.moving||$(document).mousemove(function(i){if(e.moving){var n={};for(var l in args){var p=args[l];if("left"==p)n[p]=i.pageX-e.x;else if("right"==p)n[p]=e.x-i.pageX;else if("top"==p)n[p]=i.pageY-e.y;else{if("bottom"!=p)continue;n[p]=e.y-i.pageY}n[p]+="px"}t(o,n)}i.preventDefault()}).mouseup(function(){if(e.moving){e.moving=!1;var t={};for(var n in args){var l=args[n];t[l]=o.css(l)}utils.setObj("mcss_"+i,t),$(document).unbind("mousemove").unbind("mouseup")}}),e.moving=!0)}),t(o,utils.getObj("mcss_"+i,{})))}function i(t){$(t).unbind("mousedown").css({left:"",right:"",top:"",bottom:""})}unsafeWindow.PosterContext&&unsafeWindow.PosterContext.isPostAllowed()&&utils.wait(unsafeWindow,"test_editor",function(o){function n(){utils.unminify&&(k.hide(),b.show(),o.focus(),delete utils.unminify)}function l(){b.hide(),k.show(),utils.unminify=n}function p(){"normal"!=y&&x?m.html(".edui-popup{bottom:44px;top:auto !important;}.edui-popup-caret{bottom:-8px;top:auto !important;transform:scale(1,-1);}"):m.html("")}function r(t){if(t&&("dblclick"==t.type?y="open"==y?"close":"open":(y="normal"==y?"open":"normal",p()),utils.setObj("float",y)),!t||"click"==t.type){if("normal"==y)return c.html(""),u.html(""),g.html("<span><em>悬 浮</em></span>"),b.unbind("dblclick"),i(b[0]),b.prop("title",""),h.attr("style",f),O.hide(),void 0;c.html(d),g.html("<span><em>停 靠</em></span>"),v&&b.unbind("dblclick").dblclick(r),e(b[0],"float"),h.prop("style",""),w?(l(),O.show()):(n(),O.hide())}v&&"open"!=y?(u.html("#tb_rich_poster{width:360px;}#tb_rich_poster *{max-width:360px;}#ueditor_replace{min-height:24px !important;width:310px !important;}.poster_success{top:0 !important;left:40px !important;}.editor_bottom_panel,.edui-toolbar{display:none;}.editor_textfield{padding:0 !important;}.old_style_wrapper{width:330px !important;}"),b.attr("title","双击展开")):(u.html("#tb_rich_poster{width:635px;}#tb_rich_poster *{max-width:635px;}#ueditor_replace{min-height:50px !important;}.poster_success{top:50px !important}"),v&&b.attr("title","双击精简"))}function s(){utils.popup.show({html:'<h3>贴吧悬浮窗脚本设置</h3><label><input type=checkbox id=allowUp>编辑框中的弹出窗口向上弹出</label><br><label><input type=checkbox id=allowMinify>自动隐藏悬浮窗口到右下角</label><br><label style="margin-left:20px;">从右下角呼出快捷键：'+utils.getLink("hotkey",{title:"帮助",html:"(?)"})+'<input id=shortcut style="width:60px"></label><br><label><input type=checkbox id=allowSimple>双击悬浮窗口使其精简或展开</label><br><button id=btReset>重置悬浮窗位置</button>',className:"ge_opt",init:function(e){e.querySelector("#btReset").onclick=function(){t(b,{})},utils.bindProp($("#allowUp",e),"checked","allowUp",0,function(){x=this.checked,p()}),utils.bindProp($("#allowMinify",e),"checked","allowMinify",0,function(){w=this.checked}),utils.bindProp($("#shortcut",e),"value","hk-float",0,function(){_&&utils.shortcut(_),_=this.value,a()}),utils.bindProp($("#allowSimple",e),"checked","allowSimple",0,function(){v=this.checked})},dispose:function(){r()}})}function a(){_&&utils.shortcut(_,n)}var d="#tb_rich_poster{border:3px double grey;position:fixed !important;z-index:10001;background-color:#E7EAEB;}#tb_rich_poster .editor_wrapper{margin-left:2px;}.poster_head,#bdInputObjWrapper,.tb_poster_placeholder,.poster_signature,.poster_draft_status,.poster_reply{display:none !important;}#tb_rich_poster,.editor_bottom_panel{margin-bottom:0 !important;}#tb_rich_poster,.poster_body,.poster_component{padding:0 !important;}",u=utils.addStyle(),c=utils.addStyle(),m=utils.addStyle(),h=o.$body,b=$("#tb_rich_poster"),f=h.attr("style"),g=utils.addSButton().click(r),_=utils.getObj("hk-float",""),y=utils.getObj("float","normal"),x=utils.getObj("allowUp",!0),w=utils.getObj("allowMinify",!0),v=utils.getObj("allowSimple",!0),k=$('<div id=btUnminify style="position:fixed;bottom:0;right:0;background:white;padding-top:40px;z-index:10;">◀</div>').appendTo(document.body).hide().mouseover(n),O=$('<div style="position:absolute;border:1px solid gray;background:inherit;height:100%;cursor:pointer;right:0;" title="最小化">▶</div>').appendTo($('<div style="position:relative;background:inherit;height:100%;">').appendTo($('<div style="position:absolute;top:0;background:inherit;height:100%;">').appendTo(b))).hide().click(l);r(),p(),a(),GM_registerMenuCommand("悬浮窗设置",s),$(".j_quick_reply").click(n)});