// ==UserScript==
// @name           Extreme Markup Editor for Bloggerâ„¢
// @namespace      https://github.com/harai/
// @description    Write blog posts with Extreme Markup, which resembles Hatena Markup and is much easier to use than Markdown.
// @include        http://www.blogger.com/blogger.g*
// @include        https://www.blogger.com/blogger.g*
// @version 1.5.1
// ==/UserScript==
//
//  Copyright (C) 2013 Akihiro HARAI
//  Originally created by edvakf
//
//   The JavaScript code in this page is free software: you can
//   redistribute it and/or modify it under the terms of the GNU
//   General Public License (GNU GPL) as published by the Free Software
//   Foundation, either version 3 of the License, or (at your option)
//   any later version.  The code is distributed WITHOUT ANY WARRANTY;
//   without even the implied warranty of MERCHANTABILITY or FITNESS
//   FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
//
//   As additional permission under GNU GPL version 3 section 7, you
//   may distribute non-source (e.g., minimized or compacted) forms of
//   that code without the copy of the GNU GPL normally required by
//   section 4, provided you include this license notice and a URL
//   through which recipients can access the Corresponding Source.
//
// This script makes use of:
//   text-hatena.js 
//     http://tech.nitoyon.com/javascript/application/texthatena/download.html
//   blogger-hatena-syntax.user.js 
//     https://gist.github.com/edvakf/346427
Object.extend=function(a,b){for(property in b)a[property]=b[property];return a};String.times=function(a,b){for(var c="",d=0;d<b;d++)c+=a;return c};String._escapeHTML=function(a){a=a.replace(/\&/g,"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");a=a.replace(/"/g,"&quot;");a=a.replace(/\'/g,"&#39;");return a=a.replace(/\\/g,"&#92;")};
String._escapeInsideLink=function(a){a=a.replace(/\[/g,"&#91;");a=a.replace(/\]/g,"&#93;");a=a.replace(/\(\(/g,"&#40;&#40;");a=a.replace(/\)\)/g,"&#41;&#41;");return a=a.replace(/\n/,"")};String._escapeInsidePre=function(a){a=a.replace(/\&/g,"&amp;");a=a.replace(/</g,"&lt;");return a=a.replace(/>/g,"&gt;")};String._unescapeHTML=function(a){a=a.replace(/&amp;/g,"&");a=a.replace(/&lt;/g,"<");a=a.replace(/&gt;/g,">");return a=a.replace(/&quot;/g,'"')};
String._escapeUrlInsideBracket=function(a){a=a.replace(/\[/g,"%5B");a=a.replace(/\]/g,"%5D");var b=!0;return a=a.replace(/\:/g,function(){return b?(b=!1,":"):"%3A"})};Hatena=function(a){this.self={doc:a.doc}};Hatena.prototype={parse:function(a){var b=new Hatena_Context({text:a,doc:this.self.doc});Hatena_AliasNode.registerAliases(a,b);a=new Hatena_SectionNode;a._new({context:b});a.parse();0!=b.getFootnotes().length&&(a=new Hatena_FootnoteNode,a._new({context:b}),a.parse());return b.getResult()}};
Hatena_Context=function(a){this.self={text:a.text,resultLines:[],footnotes:[],noparagraph:!1,aliases:{},indent:0,indentStr:"    ",doc:a.doc};this.init()};
Hatena_Context.prototype={init:function(){this.setInputText(this.self.text)},hasNext:function(){return null!=this.self.lines&&this.self.lines.length-1>this.self.index},peek:function(){return this.self.lines[this.self.index+1]},next:function(){return this.self.lines[++this.self.index]},setInputText:function(a){this.self.text=a.replace(/\r/g,"");this.self.lines=this.self.text.split("\n");this.self.index=-1},getResult:function(){return this.self.resultLines.join("\n")},putLine:function(a){if(this.self.noparagraph)this.self.resultLines.push(a);
else{var b=String.times(this.self.indentStr,this.self.indent);this.self.resultLines.push(b+a)}},putLineWithoutIndent:function(a){this.self.resultLines.push(a)},getLastPut:function(){return this.self.resultLines[this.self.resultLines.length-1]},addFootnote:function(a){this.self.footnotes.push(a)},getFootnotes:function(){return this.self.footnotes},isParagraphSuppressed:function(){return this.self.noparagraph},suppressParagraph:function(a){this.self.noparagraph=a},getAlias:function(a){return this.self.aliases[a]||
null},addAlias:function(a,b){this.self.aliases[a]={url:b}},indent:function(a,b){var c=null==b?1:b;this.self.indent+=c;var d=a();this.self.indent-=c;return d},getDocument:function(){return this.self.doc}};Hatena_Node=function(){};Hatena_Node.prototype={pattern:"",_new:function(a){null==a&&(a=[]);this.self={context:a.context}},parse:function(){alert("die")},canParse:function(a){return a.match(this.pattern)}};Hatena_AliasNode=function(){};
Hatena_AliasNode.registerAliases=function(a,b){a.replace(/\[alias:([\w-]+):(https?:\/\/[^\]\s]+?)\]/mg,function(a,d,e){b.addAlias(d,e);return""})};Hatena_AliasNode.replaceAliasesInLine=function(a){return a.replace(/\[alias:([\w-]+):(https?:\/\/[^\]\s]+?)\]/g,function(a,c,d){return""})};Hatena_AliasNode.prototype=Object.extend(new Hatena_Node,{pattern:/^\[alias:([\w-]+):(https?:\/\/[^\]\s]+?)\]\s*$/,parse:function(){this.self.context.next()}});
Hatena_LinkNode={replaceLinksInLine:function(a){return a.replace(/\[(https?:\/\/[^\]\s]+?)(?::([^\]\n]*))?\]/g,function(a,c,d){return'<a href="'+String._escapeHTML(c)+'">'+(d?d:c)+"</a>"})}};
Hatena_InLine={parseFootnotePart:function(a,b){a=Hatena_TexNode.replaceTexInLine(a);a=Hatena_GimageNode.replaceGimagesInLine(a,b);return Hatena_LinkNode.replaceLinksInLine(a)},parsePart:function(a,b){return Hatena_FootnoteNode.parseFootnotesInLine(a,b).map(function(a){if(!a.parseMore)return a.text;a=a.text;a=Hatena_AliasNode.replaceAliasesInLine(a);return Hatena_InLine.parseFootnotePart(a,b)}).join("")}};Hatena_BrNode=function(){};
Hatena_BrNode.prototype=Object.extend(new Hatena_Node,{parse:function(){var a=this.self.context;if(0==a.next().length){var b=String.times(a.indentStr,a.indent);a.getLastPut()==b+"<br />"||a.getLastPut()==b?a.putLine("<br />"):a.putLineWithoutIndent("",!0)}}});Hatena_CDataNode=function(){};Hatena_CDataNode.prototype=Object.extend(new Hatena_Node,{parse:function(){var a=this.self.context;a.putLine(a.next())}});Hatena_DlNode=function(){};
Hatena_DlNode.prototype=Object.extend(new Hatena_Node,{pattern:/^\:((?:<[^>]+>|\[\].+?\[\]|\[[^\]]+\]|\[\]|[^\:<\[]+)+)\:(.+)$/,parse:function(){var a=this,b=this.self.context;b.putLine("<dl>");b.indent(function(){for(var c=null;b.hasNext()&&(c=a.canParse(b.peek()));)b.next(),b.putLine("<dt>"+Hatena_InLine.parsePart(c[1],b)+"</dt>"),b.putLine("<dd>"+Hatena_InLine.parsePart(c[2],b)+"</dd>")});b.putLine("</dl>")}});Hatena_FootnoteNode=function(){};
Hatena_FootnoteNode.parseFootnotesInLine=function(a,b){for(var c=a.split("(("),d=[],e="",f=0;f<c.length;f++)if(0==f)e+=c[f];else{var g=c[f].split("))",2);if(2!=g.length)e+="(("+c[f];else{var l=c[f-f],n=g[0],g=c[f].substr(g[0].length+2);l.match(/\)$/)&&g.match(/^\(/)?e+="(("+g:(b.addFootnote(n),l=b.getFootnotes().length,n=Hatena_InLine.parseFootnotePart(n),n=n.replace(/<.*?>/g,""),d.push({parseMore:!0,text:e}),e='<span class="footnote"><a href="#f'+l+'" title="'+String._escapeHTML(n)+'" name="fn'+
l+'">*'+l+"</a></span>",d.push({parseMore:!1,text:e}),e=g)}}""!==e&&d.push({parseMore:!0,text:e});return d};Hatena_FootnoteNode.prototype=Object.extend(new Hatena_Node,{parse:function(){var a=this.self.context;0!=a.getFootnotes().length&&(a.putLine('<div class="footnote">'),a.indent(function(){for(var b=a.getFootnotes(),c=0;c<b.length;c++){var d=c+1,d='<p class="footnote"><a href="#fn'+d+'" name="f'+d+'">*'+d+"</a>: "+Hatena_InLine.parseFootnotePart(b[c],a)+"</p>";a.putLine(d)}}),a.putLine("</div>"))}});
Hatena_H4Node=function(){};Hatena_H4Node.prototype=Object.extend(new Hatena_Node,{pattern:/^\*((?:[^\*]).*)$/,parse:function(a){var b=this.self.context;b.next();b.putLine('<h4 class="emeb">'+Hatena_InLine.parsePart(a[1],b)+"</h4>")}});Hatena_H5Node=function(){};Hatena_H5Node.prototype=Object.extend(new Hatena_Node,{pattern:/^\*\*((?:[^\*]).*)$/,parse:function(a){var b=this.self.context;b.next();b.putLine('<h5 class="emeb">'+Hatena_InLine.parsePart(a[1],b)+"</h5>")}});Hatena_H6Node=function(){};
Hatena_H6Node.prototype=Object.extend(new Hatena_Node,{pattern:/^\*\*\*((?:[^\*]).*)$/,parse:function(a){var b=this.self.context;b.next();b.putLine('<h6 class="emeb">'+Hatena_InLine.parsePart(a[1],b)+"</h6>")}});Hatena_ListNode=function(){};
Hatena_ListNode.prototype=Object.extend(new Hatena_Node,{pattern:/^([\-\+]+)([^>\-\+].*)$/,parse:function(a){var b=this,c=b.self.context,d=a[1].length;a="-"==a[1].substr(0,1)?"ul":"ol";c.putLine("<"+a+">");var e;c.indent(function(){for(;e=c.peek();){var a;if(!(a=b.canParse(e)))break;if(a[1].length==d){c.next();var g,l;(g=c.peek())&&(l=b.canParse(g))&&l[1].length>d?c.putLine("<li>"+Hatena_InLine.parsePart(a[2],c)):c.putLine("<li>"+Hatena_InLine.parsePart(a[2],c)+"</li>")}else if(a[1].length>d)c.indent(function(){var b=
new Hatena_ListNode;b._new({context:c});b.parse(a)}),c.putLine("</li>");else break}});c.putLine("</"+a+">")}});Hatena_PNode=function(){};Hatena_PNode.prototype=Object.extend(new Hatena_Node,{parse:function(){var a=this.self.context;a.putLine("<p>"+Hatena_InLine.parsePart(a.next(),a)+"</p>")}});Hatena_PreNode=function(){};
Hatena_PreNode.prototype=Object.extend(new Hatena_Node,{pattern:/^>\|$/,endPattern:/(.*)\|<$/,parse:function(a){a=this.self.context;a.next();a.putLine("<pre>");for(var b="";a.hasNext();){var c;if(c=a.peek().match(this.endPattern)){b=c[1];a.next();break}a.putLineWithoutIndent(Hatena_InLine.parsePart(a.next(),a))}a.putLineWithoutIndent(Hatena_InLine.parsePart(b,a)+"</pre>")}});Hatena_SuperpreNode=function(){};
Hatena_SuperpreNode.prototype=Object.extend(new Hatena_Node,{pattern:/^>\|(\S*)\|$/,endPattern:/^\|\|<$/,parse:function(a){var b=this.self.context;b.next();for(b.putLine(""!==a[1]?'<pre class="prettyprint lang-'+a[1]+'">':"<pre>");b.hasNext();){if(b.peek().match(this.endPattern)){b.next();break}b.putLineWithoutIndent(String._escapeInsidePre(b.next()))}b.putLineWithoutIndent("</pre>")}});Hatena_TableNode=function(){};
Hatena_TableNode.prototype=Object.extend(new Hatena_Node,{pattern:/^\|([^\|]*\|(?:[^\|]*\|)+)$/,parse:function(){var a=this,b=a.self.context;b.putLine("<table>");b.indent(function(){for(;b.hasNext()&&a.canParse(b.peek());){var c=b.next();b.putLine("<tr>");var d=c.split("|");d.pop();d.shift();b.indent(function(){for(var a=0;a<d.length;a++){var c=d[a];c.match(/^\*(.*)/)?b.putLine("<th>"+Hatena_InLine.parsePart(RegExp.$1,b)+"</th>"):b.putLine("<td>"+Hatena_InLine.parsePart(c,b)+"</td>")}});b.putLine("</tr>")}});
b.putLine("</table>")}});Hatena_SectionNode=function(){};
Hatena_SectionNode.prototype=Object.extend(new Hatena_Node,{childNodes:"h6 h5 h4 blockquote dl list pre superpre table tagline tag gimage alias more tex".split(" "),parse:function(){for(var a=this.self.context,b=this._getChildNodes();a.hasNext();)this._parseWithFoundNode(a.peek(),b)},_getChildNodes:function(a){var b=this.self.context;return(a||this.childNodes).map(function(a){a="Hatena_"+a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()+"Node";a=eval("new "+a+"()");a._new({context:b});return a})},
_parseWithFoundNode:function(a,b){var c=this._findNode(a,b);c.node.parse(c.match)},_findNode:function(a,b){for(var c=this.self.context,d=0;d<b.length;d++){var e=b[d],f;if(f=e.canParse(a))return{node:e,match:f}}e=0==a.length?new Hatena_BrNode:c.isParagraphSuppressed()?new Hatena_CDataNode:new Hatena_PNode;e._new({context:c});return{node:e,match:null}}});Hatena_BlockquoteNode=function(){};
Hatena_BlockquoteNode.prototype=Object.extend(new Hatena_SectionNode,{pattern:/^>(?:(https?:\/\/.*?)(:.*)?)?>$/,endPattern:/^<<$/,childNodes:"h4 h5 h6 blockquote dl list pre superpre table gimage alias tex".split(" "),parse:function(a){var b=this,c=b.self.context,d=null,e=null;if(a[1]){var f=a[1];a=String._escapeHTML(a[2]?a[2].substr(1):f);e='<blockquote title="'+a+'" cite="'+f+'">';d='<cite><a href="'+f+'">'+a+"</a></cite>"}else e="<blockquote>";c.next();var g=b._getChildNodes();c.putLine(e);c.indent(function(){for(;c.hasNext();){if(c.peek().match(b.endPattern)){c.next();
break}b._parseWithFoundNode(c.peek(),g)}d&&c.putLine(d)});c.putLine("</blockquote>")}});Hatena_TagNode=function(){};
Hatena_TagNode.prototype=Object.extend(new Hatena_SectionNode,{pattern:/^>(<.*)$/,endPattern:/^(.*>)<$/,childNodes:"h4 h5 h6 blockquote dl list pre superpre table gimage alias tex".split(" "),parse:function(a){var b=this,c=this.self.context;c.next();c.suppressParagraph(!0);var d=b._getChildNodes();for(c.putLine(Hatena_InLine.parsePart(a[1],c));c.hasNext();){if(a=c.peek().match(b.endPattern)){c.next();c.putLine(Hatena_InLine.parsePart(a[1],c));break}c.indent(function(){b._parseWithFoundNode(c.peek(),
d)})}c.suppressParagraph(!1)}});Hatena_TaglineNode=function(){};Hatena_TaglineNode.prototype=Object.extend(new Hatena_SectionNode,{pattern:/^>(<.*>)<$/,parse:function(a){var b=this.self.context;b.next();b.putLine(Hatena_InLine.parsePart(a[1],b))}});Hatena_GimageNode=function(){};Hatena_GimageNode.replaceGimagesInLine=function(a,b){return a.replace(/\[gimage:([\w-]+)(?::([^\]]+))?\]/g,function(a,d,e){a=Hatena_GimageNode.getParameters(a,d,e,b,!0);return Hatena_GimageNode.getImgTag(a)})};
Hatena_GimageNode.getParameters=function(a,b,c,d,e){var f=[],g=null,l="";c.split(/,/).forEach(function(a){2>f.length&&a.match(/^\d+$/)?f.push(+a):null===g&&-1!==["center","left","right"].indexOf(a)?g=a:l=a});var n=c=null;switch(f.length){case 0:break;case 1:c=f[0];n=f[0];break;case 2:f[1]<f[0]?(c=f[1],n=f[0]):(c=f[0],n=f[1]);break;default:throw"error";}b=d.getAlias(b);var h=d=null;null!==b&&(d=b.url,h=c?b.url.replace(/\/s\d+\//,"/s"+c+"/"):d);return{alt:l,size:c,frameSize:n,pos:g,originalUrl:d,url:h,
isInline:e,matchStr:a}};Hatena_GimageNode.getImgTag=function(a){if(null==a.url)return a.matchStr;var b=a.isInline?"":'<div class="emebImage"><a href="'+String._escapeHTML(a.originalUrl)+'">',c=a.isInline?"":"</a></div>";return b+'<img src="'+String._escapeHTML(a.url)+'" alt="'+String._escapeHTML(a.alt)+'" />'+c};
Hatena_GimageNode.prototype=Object.extend(new Hatena_SectionNode,{pattern:/^\[gimage:([\w-]+)(?::([^\]]+))?\]\s*$/,childNodes:["tagline","tag"],denyChildNodes:"h6 h5 h4 blockquote dl list pre superpre table gimage alias more".split(" "),canParse:function(a){a=a.match(this.pattern);return null==a?null:this.self.context.getAlias(a[1])?a:null},parse:function(a){var b=this,c=b.self.context;c.next();var d=Hatena_GimageNode.getParameters(a[0],a[1],a[2],c,!1),e=Hatena_GimageNode.getImgTag(d),f=b._getChildNodes(),
g=b._getChildNodes(b.denyChildNodes);c.putLine("<figure"+function(){var a="";"center"===d.pos?a+=' class="emebCenter"':"left"===d.pos?a+=' class="emebLeft"':"right"===d.pos&&(a+=' class="emebRight"');null!==d.frameSize&&(a+=' style="width: '+d.frameSize+'px;"');return a}()+">");c.indent(function(){c.putLine(e);for(var a=!1;c.hasNext();){var d=b._findNode(c.peek(),f,g);if(null==d)break;a||(c.putLine("<figcaption>"),a=!0);c.indent(function(){d.node.parse(d.match)})}a&&c.putLine("</figcaption>")});c.putLine("</figure>")},
_findNode:function(a,b,c){for(var d=this.self.context,e=0;e<b.length;e++){var f=b[e],g;if(g=f.canParse(a))return{node:f,match:g}}for(e=0;e<c.length;e++)if(c[e].canParse(a))return null;if(0==a.length)return null;f=d.isParagraphSuppressed()?new Hatena_CDataNode:new Hatena_PNode;f._new({context:d});return{node:f,match:null}}});Hatena_MoreNode=function(){};
Hatena_MoreNode.prototype=Object.extend(new Hatena_SectionNode,{pattern:/^={3,}\s*$/,parse:function(a){a=this.self.context;a.next();a.putLineWithoutIndent("\x3c!-- more --\x3e");a.putLineWithoutIndent('\x3c!--emPreview--\x3e<div class="previewOnly">&lt;!-- more --&gt;</div>\x3c!--/emPreview--\x3e')}});Hatena_TexNode=function(){};Hatena_TexNode.replaceTexInLine=function(a){return a.replace(/\[tex:([^\]]+)\]/g,function(a,c){return Hatena_TexNode.getTag(c,!0)})};
Hatena_TexNode.getTag=function(a,b){a=a.replace(/script/g,"scri pt");return b?'<script type="math/tex">'+a+"\x3c/script>":'<script type="math/tex; mode=display">'+a+"\x3c/script>"};Hatena_TexNode.prototype=Object.extend(new Hatena_SectionNode,{pattern:/^\[tex:([^\]]+)\]\s*$/,parse:function(a){var b=this.self.context;b.next();b.putLine(Hatena_TexNode.getTag(a[1],!1))}});var bloggerHatenaMarkup=function(){function a(){var a=n.parse(k.value);m.innerHTML=a;b(a);w.process()}function b(a){a=a.replace(/\x3c!--emPreview--\x3e.*?\x3c!--\/emPreview--\x3e/mg,"");h.value=C+a+"\n\x3c!--ExtremeMarkup\n"+k.value.replace(/-{2,}/g,function(a){return"{{"+a.length+" hyphens}}"})+"\nExtremeMarkup--\x3e";d(h)}var c=function(a,b){var c=a.selectionStart,d=a.selectionEnd,e=a.value;a.value=e.substring(0,c)+b+e.substring(d);c+=b.length;a.setSelectionRange(c,c);a.focus()},d=function(a){0!=
a.value.indexOf("\n")&&(a.value="\n"+a.value);a.setSelectionRange(0,0)},e=function(a){var b=a.value.indexOf("\n");-1===b&&(b=a.value.length);return a.value.substring(0,b)},f=function(){var a=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},g=function(a){var b=function(){a()||setTimeout(b,100)};b()},l=function(){for(var a=document.getElementsByTagName("iframe"),b=0;b<a.length;b++)if(0!==a[b].offsetWidth&&"html-image-picker"===
a[b].src.substr(-17,17))return!0;return!1},n=new Hatena({doc:document}),h=null,k=null,r=null,s=null,m=null,q=null,t=function(a){return function(){a.initialize&&a.initialize();var b=new MutationObserver(function(){a.continueObserving&&a.continueObserving()||(b.disconnect(),a.postObserving&&a.postObserving(),a.nextState&&a.nextState()())});b.observe(a.observingNode(),a.observingType)}},A=t({name:"postingHtmlBoxHiddenState",observingNode:function(){return document.body},observingType:{attributes:!0,
subtree:!0},continueObserving:function(){return 0===h.offsetWidth},postObserving:function(){var a=function(){h.value.match(/^\s*$/)?setTimeout(a,100):y()};y();a()},nextState:function(){return z}}),E=t({name:"imageDialogShownState",observingNode:function(){return document.body},observingType:{childList:!0,attributes:!0,subtree:!0},continueObserving:function(){var a;(a=l())||(a=document.getElementById(":w")||document.getElementById(":x"),a=!!a&&0!==a.offsetWidth);return a},postObserving:function(){p.isEnabled()&&
D()},nextState:function(){return z}}),z=t({name:"postingHtmlBoxShownState",observingNode:function(){return document.body},observingType:{childList:!0,attributes:!0,subtree:!0},continueObserving:function(){return 0!==h.offsetWidth&&!l()},nextState:function(){if(l())return E;if(0!==h.offsetWidth)throw"does not happen";p.disable();return A}}),D=function(){var b=function(a){var b=a.map(function(a){return"[gimage:"+a.id+":"+a.size+(null!==a.pos?","+a.pos:"")+"]\n"}).join("");c(k,b);b=k.selectionStart;
k.setSelectionRange(k.value.length,k.value.length);a=a.map(function(a){return"\n[alias:"+a.id+":"+a.url+"]"}).join("");c(k,a);k.setSelectionRange(b,b)},d=function(){var a=e(h);if(0===a.length)return null;var b=document.createElement("div");b.innerHTML=a;for(var a=function(a){var b=null,c=null,d=null,x=function(a){if("left"===a.style.clear||"right"===a.style.clear)b=a.style.clear;d=a.href;a=a.firstElementChild.src.match(/\/s(\d+)\//);null!==a&&(c=parseInt(a[1]))};"DIV"==a.tagName?(b="center",x(a.firstElementChild)):
x(a);return{pos:b,size:c,url:d,id:f()}},c=[],d=0;d<b.childNodes.length;d++)c.push(a(b.childNodes[d]));return c}();null!=d&&(b(d),a())},u=function(){var a=null;return{startLoading:function(){a&&clearTimeout(a);a=setTimeout(function(){r.style.display="none"},1E4);r.style.display="block"},finishLoading:function(){a&&clearTimeout(a);r.style.display="none"},isLoading:function(){return"block"===r.style.display}}}(),p=function(){var a=!1,b=function(b){a=b;h.disabled=b;s.checked=b;k.disabled=!b;B.resize();
b?(v.start(),d(h)):v.stop()};return{init:function(){v.init();s.addEventListener("click",function(c){b(!a)},!1);b(!1)},enable:function(){b(!0)},disable:function(){b(!1)},isEnabled:function(){return a}}}(),v=function(){var b=null,c=!1;return{init:function(){k.addEventListener("input",function(){c&&(clearTimeout(b),b=setTimeout(a,500))},!1)},start:function(){c||(c=!0)},stop:function(){c&&(c=!1,clearTimeout(b))}}}(),B=function(){var a=function(){var a=h.parentNode;0!==a.clientWidth&&(h.style.height=p.isEnabled()?
"0%":"90%",h.style.visibility=p.isEnabled()?"hidden":"visible",900>a.clientWidth?(m.style.cssFloat="none",m.style.width="100%",q.style.cssFloat="none",q.style.width="100%",q.style.height=p.isEnabled()?"50%":"10%",m.style.height=p.isEnabled()?"50%":"0%"):(1400>a.clientWidth?(m.style.width="60%",m.style.cssFloat="right",q.style.width="40%"):(m.style.width="50%",m.style.cssFloat="right",q.style.width="50%"),q.style.cssFloat="left",q.style.height=p.isEnabled()?"100%":"10%",m.style.height=p.isEnabled()?
"100%":"10%"))};return{init:function(){window.addEventListener("resize",a);a()},resize:a}}(),w=function(){var a=null;return{init:function(){(function(){var a=document.createElement("script");a.type="text/x-mathjax-config";a.textContent="MathJax.Hub.Config({ skipStartupTypeset: true });";document.getElementsByTagName("head")[0].appendChild(a)})();(function(){var a=document.createElement("script");a.type="text/javascript";a.src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML-full";
document.getElementsByTagName("head")[0].appendChild(a)})();a=function(){var a=document.createElement("div");a.id="mathjaxBrigde";a.style.display="none";document.body.appendChild(a);return a}();(function(){var a=document.createElement("script");a.type="text/javascript";a.textContent="document.getElementById('mathjaxBrigde').addEventListener('click', function() {\n    MathJax.Hub.Process(document.getElementById('emPreview'));\n});";document.body.appendChild(a)})()},process:function(){var b=new MouseEvent("click",
{view:window});a.dispatchEvent(b)}}}(),F=function(){w.init();(function(){var a=document.createElement("style");a.textContent='\n#postingHtmlBox {\n-moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box;\n}\n#emPreview address,#emPreview blockquote,#emPreview body,#emPreview dd,#emPreview div,#emPreview dl,#emPreview dt,#emPreview fieldset,#emPreview form,#emPreview frame,#emPreview frameset,#emPreview h1,#emPreview h2,#emPreview h3,#emPreview h4,#emPreview h5,#emPreview h6,#emPreview noframes,#emPreview ol,#emPreview p,#emPreview ul,#emPreview center,#emPreview dir,#emPreview hr,#emPreview menu,#emPreview pre{display:block;unicode-bidi:embed;}\n#emPreview li{display:list-item;}\n#emPreview head{display:none;}\n#emPreview table{display:table;}\n#emPreview tr{display:table-row;}\n#emPreview thead{display:table-header-group;}\n#emPreview tbody{display:table-row-group;}\n#emPreview tfoot{display:table-footer-group;}\n#emPreview col{display:table-column;}\n#emPreview colgroup{display:table-column-group;}\n#emPreview td,#emPreview th{display:table-cell;}\n#emPreview caption{display:table-caption;}\n#emPreview th{font-weight:bolder;text-align:center;}\n#emPreview caption{text-align:center;}\n#emPreview body{margin:8px;}\n#emPreview h1,#emPreview h2,#emPreview h3,#emPreview h4{font-size:2em;margin:0.67em 0;}\n#emPreview h5{font-size:1.5em;margin:0.75em 0;}\n#emPreview h6{font-size:1.17em;margin:0.83em 0;}\n#emPreview p,#emPreview blockquote,#emPreview ul,#emPreview fieldset,#emPreview form,#emPreview ol,#emPreview dl,#emPreview dir,#emPreview menu{margin:1.12em 0;}\n#emPreview h1,#emPreview h2,#emPreview h3,#emPreview h4,#emPreview h5,#emPreview h6,#emPreview b,#emPreview strong{font-weight:bolder;}\n#emPreview blockquote{margin-left:40px;margin-right:40px;}\n#emPreview i,#emPreview cite,#emPreview em,#emPreview var,#emPreview address{font-style:italic;}\n#emPreview pre,#emPreview tt,#emPreview code,#emPreview kbd,#emPreview samp{font-family:monospace;}\n#emPreview pre{white-space:pre;}\n#emPreview button,#emPreview textarea,#emPreview input,#emPreview select{display:inline-block;}\n#emPreview big{font-size:1.17em;}\n#emPreview small,#emPreview sub,#emPreview sup{font-size:0.83em;}\n#emPreview sub{vertical-align:sub;}\n#emPreview sup{vertical-align:super;}\n#emPreview table{border-spacing:2px;}\n#emPreview thead,#emPreview tbody,#emPreview tfoot{vertical-align:middle;}\n#emPreview td,#emPreview th,#emPreview tr{vertical-align:inherit;}\n#emPreview s,#emPreview strike,#emPreview del{text-decoration:line-through;}\n#emPreview hr{border:1px inset;}\n#emPreview ol,#emPreview ul,#emPreview dir,#emPreview menu,#emPreview dd{margin-left:40px;}\n#emPreview ol{list-style-type:decimal;}\n#emPreview ol ul,#emPreview ul ol,#emPreview ul ul,#emPreview ol ol{margin-top:0;margin-bottom:0;}\n#emPreview u,#emPreview ins{text-decoration:underline;}\n#emPreview br:before{content:"A";white-space:pre-line;}\n#emPreview center{text-align:center;}\n#emPreview :link,#emPreview :visited{text-decoration:underline;}\n#emPreview :focus{outline:thin dotted invert;}\n#emPreview figure{display:block;margin-top:1em;margin-bottom:1em;margin-left:40px;margin-right:40px;}\n#emPreview div.previewOnly{margin:10px;font-size:13px;font-weight:bold;color:#888;}\n#emPreview h4,#emPreview h5,#emPreview h6{clear:both;}\n#emPreview figure.emebLeft{clear:left;float:left;}\n#emPreview figure.emebRight{clear:right;float:right;}\n#emPreview figure.emebCenter{clear:both;margin-left:auto;margin-right:auto;}\n#emPreview figure>div.emebImage{text-align:center;}\n#emPreview ol ul,#emPreview ul,#emPreview ul ul{list-style-type: disc;}\n#emPreview ol,#emPreview ul ol,#emPreview ol ol{list-style-type: decimal;}\n#emPreview dt{font-weight:bold;}\n#emPreview table,#emPreview th,#emPreview td{border:1px solid black;border-collapse:collapse;}\n#emPreview th,#emPreview td{padding:5px;}\n#emPreview pre,#emPreview table{margin:15px;}';
document.head.appendChild(a)})();(function(){var a=h.parentElement;a.appendChild(function(){q=document.createElement("div");q.setAttribute("style","position:relative;display:block;-moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box;");q.appendChild(function(){s=document.createElement("input");s.setAttribute("type","checkbox");s.setAttribute("id","emEditorCheckbox");var a=document.createElement("label");a.setAttribute("for","emEditorCheckbox");a.appendChild(document.createTextNode("Use Extreme Markup"));
var b=document.createElement("div");b.setAttribute("style","height:30px;padding:5px;");b.appendChild(s);b.appendChild(a);b.appendChild(function(){var a=document.createElement("a");a.href="http://extreme-markup.blogspot.jp/p/syntax-and-features.html";a.target="_blank";a.textContent="[Usage]";a.style="margin-left: 10px";return a}());return b}());q.appendChild(function(){k=document.createElement("textarea");k.setAttribute("id","emEditor");k.setAttribute("style","width:100%;height:100%;resize:none;display:block;-moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box;");
r=document.createElement("div");r.setAttribute("style","position: absolute;left: 20px;top: 20px;z-index: 10;display: none;font-weight: bold;font-size: 20px;background-color: cyan;padding: 10px;padding: 10px;");r.appendChild(document.createTextNode("Fetching the title..."));var a=document.createElement("div");a.setAttribute("style","top:30px;bottom:0;position:absolute;width:100%;-moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box;");a.appendChild(k);a.appendChild(r);
return a}());return q}());a.appendChild(function(){m=document.createElement("div");m.setAttribute("id","emPreview");m.setAttribute("style","border:solid black 1px;padding:5px;overflow:scroll;-moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box;");return m}())})();p.init();(function(){(function(){var a=document.createElement("div");a.id="hatenaLinkContainer";a.style.display="none";a.addEventListener("click",function(){if(u.isLoading()){u.finishLoading();var c=a.getAttribute("data-url"),
d=a.getAttribute("data-title");b(c,String._escapeHTML(d))}});document.body.appendChild(a);var c=document.createElement("script");c.setAttribute("type","application/javascript");c.textContent="function bloggerHatenaMarkup_linkCallback(j) {\nvar hlc = document.getElementById('hatenaLinkContainer');\nhlc.setAttribute('data-url', j.targetUrl);\nhlc.setAttribute('data-title', j.pageTitle);\nvar event = new MouseEvent('click', { 'view': window });\nhlc.dispatchEvent(event);\n}";document.body.appendChild(c);
return a})();var b=function(b,d){var e="["+String._escapeUrlInsideBracket(b)+":"+String._escapeInsideLink(d)+"]";c(k,e);a()};g(function(){var c=null;return(c=document.getElementById("link"))?(c.addEventListener("click",function(){if(p.isEnabled()){var c=e(h);if(""!==c){var d=document.createElement("div");d.innerHTML=c;c=d.firstElementChild.href;d=k.value.substring(k.selectionStart,k.selectionEnd);""===d?(c="http://www.pagesynopsis.com/pageinfo?callback=bloggerHatenaMarkup_linkCallback&targetUrl="+
encodeURI(c),d=document.createElement("script"),d.setAttribute("type","application/javascript"),d.setAttribute("src",c),document.body.appendChild(d),u.startLoading(),a()):b(c,d)}}}),!0):!1})})();(function(){[{id:"bold",sTag:"<strong>",eTag:"</strong>"},{id:"italic",sTag:"<i>",eTag:"</i>"},{id:"strikeThrough",sTag:"<strike>",eTag:"</strike>"},{id:"BLOCKQUOTE",sTag:"\n>>\n",eTag:"\n<<\n"}].forEach(function(b){g(function(){var c=null;return(c=document.getElementById(b.id))?(c.addEventListener("click",
function(){if(p.isEnabled()){var c=k,d=b.sTag,e=b.eTag,f=c.selectionStart,g=c.selectionEnd,h=c.value;c.value=h.substring(0,f)+d+h.substring(f,g)+e+h.substring(g);c.setSelectionRange(f+d.length,g+d.length);c.focus();a()}}),!0):!1})})})();B.init()},G=function(a){a=a.match(/\n\x3c!--ExtremeMarkup\r?\n([\s\S]*)\nExtremeMarkup--\x3e/);return null===a?null:a[1].replace(/\{\{(\d+) hyphens\}\}/g,function(a,b){return String.times("-",+b)})},y=function(){var b=G(h.value);null===b?(k.value="",m.innerHTML="",
p.disable()):(k.value=b,a(),p.enable())};t({name:"initState",observingNode:function(){return document.body},observingType:{childList:!0,subtree:!0},continueObserving:function(){return!(h=document.getElementById("postingHtmlBox"))},postObserving:function(){F()},nextState:function(){return A}})();var C='\n<style type="text/css" scoped="scoped">\nh4.emeb,h5.emeb,h6.emeb{clear:both;}\nfigure.emebLeft{clear:left;float:left;}\nfigure.emebRight{clear:right;float:right;}\nfigure.emebCenter{clear:both;margin-left:auto;margin-right:auto;}\nfigure>div.emebImage{text-align:center;}\n</style>\n'};
bloggerHatenaMarkup();
