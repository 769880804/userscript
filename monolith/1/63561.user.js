// ==UserScript==
// @name           tweet this
// @namespace      twitter
// @description    integrates twitter with the set page
// @include        http://www.flickr.com/photos/*/sets/*
// ==/UserScript==
(function(){
	var set = unsafeWindow.page_set;
	var Y = unsafeWindow.YAHOO;
	var dom = Y.util.Dom;
	var h = document.getElementsByTagName('head')[0];
	var OAuth = null;
	
	// sha1.js and oauth.js from http://oauth.googlecode.com/svn/code/javascript
	var sha1_js = 'data:application/javascript;base64,LyoKICogQSBKYXZhU2NyaXB0IGltcGxlbWVudGF0aW9uIG9mIHRoZSBTZWN1cmUgSGFzaCBBbGdvcml0aG0sIFNIQS0xLCBhcyBkZWZpbmVkCiAqIGluIEZJUFMgUFVCIDE4MC0xCiAqIFZlcnNpb24gMi4xYSBDb3B5cmlnaHQgUGF1bCBKb2huc3RvbiAyMDAwIC0gMjAwMi4KICogT3RoZXIgY29udHJpYnV0b3JzOiBHcmVnIEhvbHQsIEFuZHJldyBLZXBlcnQsIFlkbmFyLCBMb3N0aW5ldAogKiBEaXN0cmlidXRlZCB1bmRlciB0aGUgQlNEIExpY2Vuc2UKICogU2VlIGh0dHA6Ly9wYWpob21lLm9yZy51ay9jcnlwdC9tZDUgZm9yIGRldGFpbHMuCiAqLwoKLyoKICogQ29uZmlndXJhYmxlIHZhcmlhYmxlcy4gWW91IG1heSBuZWVkIHRvIHR3ZWFrIHRoZXNlIHRvIGJlIGNvbXBhdGlibGUgd2l0aAogKiB0aGUgc2VydmVyLXNpZGUsIGJ1dCB0aGUgZGVmYXVsdHMgd29yayBpbiBtb3N0IGNhc2VzLgogKi8KdmFyIGhleGNhc2UgPSAwOyAgLyogaGV4IG91dHB1dCBmb3JtYXQuIDAgLSBsb3dlcmNhc2U7IDEgLSB1cHBlcmNhc2UgICAgICAgICovCnZhciBiNjRwYWQgID0gIiI7IC8qIGJhc2UtNjQgcGFkIGNoYXJhY3Rlci4gIj0iIGZvciBzdHJpY3QgUkZDIGNvbXBsaWFuY2UgICAqLwp2YXIgY2hyc3ogICA9IDg7ICAvKiBiaXRzIHBlciBpbnB1dCBjaGFyYWN0ZXIuIDggLSBBU0NJSTsgMTYgLSBVbmljb2RlICAgICAgKi8KCi8qCiAqIFRoZXNlIGFyZSB0aGUgZnVuY3Rpb25zIHlvdSdsbCB1c3VhbGx5IHdhbnQgdG8gY2FsbAogKiBUaGV5IHRha2Ugc3RyaW5nIGFyZ3VtZW50cyBhbmQgcmV0dXJuIGVpdGhlciBoZXggb3IgYmFzZS02NCBlbmNvZGVkIHN0cmluZ3MKICovCmZ1bmN0aW9uIGhleF9zaGExKHMpe3JldHVybiBiaW5iMmhleChjb3JlX3NoYTEoc3RyMmJpbmIocykscy5sZW5ndGggKiBjaHJzeikpO30KZnVuY3Rpb24gYjY0X3NoYTEocyl7cmV0dXJuIGJpbmIyYjY0KGNvcmVfc2hhMShzdHIyYmluYihzKSxzLmxlbmd0aCAqIGNocnN6KSk7fQpmdW5jdGlvbiBzdHJfc2hhMShzKXtyZXR1cm4gYmluYjJzdHIoY29yZV9zaGExKHN0cjJiaW5iKHMpLHMubGVuZ3RoICogY2hyc3opKTt9CmZ1bmN0aW9uIGhleF9obWFjX3NoYTEoa2V5LCBkYXRhKXsgcmV0dXJuIGJpbmIyaGV4KGNvcmVfaG1hY19zaGExKGtleSwgZGF0YSkpO30KZnVuY3Rpb24gYjY0X2htYWNfc2hhMShrZXksIGRhdGEpeyByZXR1cm4gYmluYjJiNjQoY29yZV9obWFjX3NoYTEoa2V5LCBkYXRhKSk7fQpmdW5jdGlvbiBzdHJfaG1hY19zaGExKGtleSwgZGF0YSl7IHJldHVybiBiaW5iMnN0cihjb3JlX2htYWNfc2hhMShrZXksIGRhdGEpKTt9CgovKgogKiBQZXJmb3JtIGEgc2ltcGxlIHNlbGYtdGVzdCB0byBzZWUgaWYgdGhlIFZNIGlzIHdvcmtpbmcKICovCmZ1bmN0aW9uIHNoYTFfdm1fdGVzdCgpCnsKICByZXR1cm4gaGV4X3NoYTEoImFiYyIpID09ICJhOTk5M2UzNjQ3MDY4MTZhYmEzZTI1NzE3ODUwYzI2YzljZDBkODlkIjsKfQoKLyoKICogQ2FsY3VsYXRlIHRoZSBTSEEtMSBvZiBhbiBhcnJheSBvZiBiaWctZW5kaWFuIHdvcmRzLCBhbmQgYSBiaXQgbGVuZ3RoCiAqLwpmdW5jdGlvbiBjb3JlX3NoYTEoeCwgbGVuKQp7CiAgLyogYXBwZW5kIHBhZGRpbmcgKi8KICB4W2xlbiA+PiA1XSB8PSAweDgwIDw8ICgyNCAtIGxlbiAlIDMyKTsKICB4WygobGVuICsgNjQgPj4gOSkgPDwgNCkgKyAxNV0gPSBsZW47CgogIHZhciB3ID0gQXJyYXkoODApOwogIHZhciBhID0gIDE3MzI1ODQxOTM7CiAgdmFyIGIgPSAtMjcxNzMzODc5OwogIHZhciBjID0gLTE3MzI1ODQxOTQ7CiAgdmFyIGQgPSAgMjcxNzMzODc4OwogIHZhciBlID0gLTEwMDk1ODk3NzY7CgogIGZvcih2YXIgaSA9IDA7IGkgPCB4Lmxlbmd0aDsgaSArPSAxNikKICB7CiAgICB2YXIgb2xkYSA9IGE7CiAgICB2YXIgb2xkYiA9IGI7CiAgICB2YXIgb2xkYyA9IGM7CiAgICB2YXIgb2xkZCA9IGQ7CiAgICB2YXIgb2xkZSA9IGU7CgogICAgZm9yKHZhciBqID0gMDsgaiA8IDgwOyBqKyspCiAgICB7CiAgICAgIGlmKGogPCAxNikgd1tqXSA9IHhbaSArIGpdOwogICAgICBlbHNlIHdbal0gPSByb2wod1tqLTNdIF4gd1tqLThdIF4gd1tqLTE0XSBeIHdbai0xNl0sIDEpOwogICAgICB2YXIgdCA9IHNhZmVfYWRkKHNhZmVfYWRkKHJvbChhLCA1KSwgc2hhMV9mdChqLCBiLCBjLCBkKSksCiAgICAgICAgICAgICAgICAgICAgICAgc2FmZV9hZGQoc2FmZV9hZGQoZSwgd1tqXSksIHNoYTFfa3QoaikpKTsKICAgICAgZSA9IGQ7CiAgICAgIGQgPSBjOwogICAgICBjID0gcm9sKGIsIDMwKTsKICAgICAgYiA9IGE7CiAgICAgIGEgPSB0OwogICAgfQoKICAgIGEgPSBzYWZlX2FkZChhLCBvbGRhKTsKICAgIGIgPSBzYWZlX2FkZChiLCBvbGRiKTsKICAgIGMgPSBzYWZlX2FkZChjLCBvbGRjKTsKICAgIGQgPSBzYWZlX2FkZChkLCBvbGRkKTsKICAgIGUgPSBzYWZlX2FkZChlLCBvbGRlKTsKICB9CiAgcmV0dXJuIEFycmF5KGEsIGIsIGMsIGQsIGUpOwoKfQoKLyoKICogUGVyZm9ybSB0aGUgYXBwcm9wcmlhdGUgdHJpcGxldCBjb21iaW5hdGlvbiBmdW5jdGlvbiBmb3IgdGhlIGN1cnJlbnQKICogaXRlcmF0aW9uCiAqLwpmdW5jdGlvbiBzaGExX2Z0KHQsIGIsIGMsIGQpCnsKICBpZih0IDwgMjApIHJldHVybiAoYiAmIGMpIHwgKCh+YikgJiBkKTsKICBpZih0IDwgNDApIHJldHVybiBiIF4gYyBeIGQ7CiAgaWYodCA8IDYwKSByZXR1cm4gKGIgJiBjKSB8IChiICYgZCkgfCAoYyAmIGQpOwogIHJldHVybiBiIF4gYyBeIGQ7Cn0KCi8qCiAqIERldGVybWluZSB0aGUgYXBwcm9wcmlhdGUgYWRkaXRpdmUgY29uc3RhbnQgZm9yIHRoZSBjdXJyZW50IGl0ZXJhdGlvbgogKi8KZnVuY3Rpb24gc2hhMV9rdCh0KQp7CiAgcmV0dXJuICh0IDwgMjApID8gIDE1MTg1MDAyNDkgOiAodCA8IDQwKSA/ICAxODU5Nzc1MzkzIDoKICAgICAgICAgKHQgPCA2MCkgPyAtMTg5NDAwNzU4OCA6IC04OTk0OTc1MTQ7Cn0KCi8qCiAqIENhbGN1bGF0ZSB0aGUgSE1BQy1TSEExIG9mIGEga2V5IGFuZCBzb21lIGRhdGEKICovCmZ1bmN0aW9uIGNvcmVfaG1hY19zaGExKGtleSwgZGF0YSkKewogIHZhciBia2V5ID0gc3RyMmJpbmIoa2V5KTsKICBpZihia2V5Lmxlbmd0aCA+IDE2KSBia2V5ID0gY29yZV9zaGExKGJrZXksIGtleS5sZW5ndGggKiBjaHJzeik7CgogIHZhciBpcGFkID0gQXJyYXkoMTYpLCBvcGFkID0gQXJyYXkoMTYpOwogIGZvcih2YXIgaSA9IDA7IGkgPCAxNjsgaSsrKQogIHsKICAgIGlwYWRbaV0gPSBia2V5W2ldIF4gMHgzNjM2MzYzNjsKICAgIG9wYWRbaV0gPSBia2V5W2ldIF4gMHg1QzVDNUM1QzsKICB9CgogIHZhciBoYXNoID0gY29yZV9zaGExKGlwYWQuY29uY2F0KHN0cjJiaW5iKGRhdGEpKSwgNTEyICsgZGF0YS5sZW5ndGggKiBjaHJzeik7CiAgcmV0dXJuIGNvcmVfc2hhMShvcGFkLmNvbmNhdChoYXNoKSwgNTEyICsgMTYwKTsKfQoKLyoKICogQWRkIGludGVnZXJzLCB3cmFwcGluZyBhdCAyXjMyLiBUaGlzIHVzZXMgMTYtYml0IG9wZXJhdGlvbnMgaW50ZXJuYWxseQogKiB0byB3b3JrIGFyb3VuZCBidWdzIGluIHNvbWUgSlMgaW50ZXJwcmV0ZXJzLgogKi8KZnVuY3Rpb24gc2FmZV9hZGQoeCwgeSkKewogIHZhciBsc3cgPSAoeCAmIDB4RkZGRikgKyAoeSAmIDB4RkZGRik7CiAgdmFyIG1zdyA9ICh4ID4+IDE2KSArICh5ID4+IDE2KSArIChsc3cgPj4gMTYpOwogIHJldHVybiAobXN3IDw8IDE2KSB8IChsc3cgJiAweEZGRkYpOwp9CgovKgogKiBCaXR3aXNlIHJvdGF0ZSBhIDMyLWJpdCBudW1iZXIgdG8gdGhlIGxlZnQuCiAqLwpmdW5jdGlvbiByb2wobnVtLCBjbnQpCnsKICByZXR1cm4gKG51bSA8PCBjbnQpIHwgKG51bSA+Pj4gKDMyIC0gY250KSk7Cn0KCi8qCiAqIENvbnZlcnQgYW4gOC1iaXQgb3IgMTYtYml0IHN0cmluZyB0byBhbiBhcnJheSBvZiBiaWctZW5kaWFuIHdvcmRzCiAqIEluIDgtYml0IGZ1bmN0aW9uLCBjaGFyYWN0ZXJzID4yNTUgaGF2ZSB0aGVpciBoaS1ieXRlIHNpbGVudGx5IGlnbm9yZWQuCiAqLwpmdW5jdGlvbiBzdHIyYmluYihzdHIpCnsKICB2YXIgYmluID0gQXJyYXkoKTsKICB2YXIgbWFzayA9ICgxIDw8IGNocnN6KSAtIDE7CiAgZm9yKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGggKiBjaHJzejsgaSArPSBjaHJzeikKICAgIGJpbltpPj41XSB8PSAoc3RyLmNoYXJDb2RlQXQoaSAvIGNocnN6KSAmIG1hc2spIDw8ICgzMiAtIGNocnN6IC0gaSUzMik7CiAgcmV0dXJuIGJpbjsKfQoKLyoKICogQ29udmVydCBhbiBhcnJheSBvZiBiaWctZW5kaWFuIHdvcmRzIHRvIGEgc3RyaW5nCiAqLwpmdW5jdGlvbiBiaW5iMnN0cihiaW4pCnsKICB2YXIgc3RyID0gIiI7CiAgdmFyIG1hc2sgPSAoMSA8PCBjaHJzeikgLSAxOwogIGZvcih2YXIgaSA9IDA7IGkgPCBiaW4ubGVuZ3RoICogMzI7IGkgKz0gY2hyc3opCiAgICBzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoYmluW2k+PjVdID4+PiAoMzIgLSBjaHJzeiAtIGklMzIpKSAmIG1hc2spOwogIHJldHVybiBzdHI7Cn0KCi8qCiAqIENvbnZlcnQgYW4gYXJyYXkgb2YgYmlnLWVuZGlhbiB3b3JkcyB0byBhIGhleCBzdHJpbmcuCiAqLwpmdW5jdGlvbiBiaW5iMmhleChiaW5hcnJheSkKewogIHZhciBoZXhfdGFiID0gaGV4Y2FzZSA/ICIwMTIzNDU2Nzg5QUJDREVGIiA6ICIwMTIzNDU2Nzg5YWJjZGVmIjsKICB2YXIgc3RyID0gIiI7CiAgZm9yKHZhciBpID0gMDsgaSA8IGJpbmFycmF5Lmxlbmd0aCAqIDQ7IGkrKykKICB7CiAgICBzdHIgKz0gaGV4X3RhYi5jaGFyQXQoKGJpbmFycmF5W2k+PjJdID4+ICgoMyAtIGklNCkqOCs0KSkgJiAweEYpICsKICAgICAgICAgICBoZXhfdGFiLmNoYXJBdCgoYmluYXJyYXlbaT4+Ml0gPj4gKCgzIC0gaSU0KSo4ICApKSAmIDB4Rik7CiAgfQogIHJldHVybiBzdHI7Cn0KCi8qCiAqIENvbnZlcnQgYW4gYXJyYXkgb2YgYmlnLWVuZGlhbiB3b3JkcyB0byBhIGJhc2UtNjQgc3RyaW5nCiAqLwpmdW5jdGlvbiBiaW5iMmI2NChiaW5hcnJheSkKewogIHZhciB0YWIgPSAiQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVphYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ejAxMjM0NTY3ODkrLyI7CiAgdmFyIHN0ciA9ICIiOwogIGZvcih2YXIgaSA9IDA7IGkgPCBiaW5hcnJheS5sZW5ndGggKiA0OyBpICs9IDMpCiAgewogICAgdmFyIHRyaXBsZXQgPSAoKChiaW5hcnJheVtpICAgPj4gMl0gPj4gOCAqICgzIC0gIGkgICAlNCkpICYgMHhGRikgPDwgMTYpCiAgICAgICAgICAgICAgICB8ICgoKGJpbmFycmF5W2krMSA+PiAyXSA+PiA4ICogKDMgLSAoaSsxKSU0KSkgJiAweEZGKSA8PCA4ICkKICAgICAgICAgICAgICAgIHwgICgoYmluYXJyYXlbaSsyID4+IDJdID4+IDggKiAoMyAtIChpKzIpJTQpKSAmIDB4RkYpOwogICAgZm9yKHZhciBqID0gMDsgaiA8IDQ7IGorKykKICAgIHsKICAgICAgaWYoaSAqIDggKyBqICogNiA+IGJpbmFycmF5Lmxlbmd0aCAqIDMyKSBzdHIgKz0gYjY0cGFkOwogICAgICBlbHNlIHN0ciArPSB0YWIuY2hhckF0KCh0cmlwbGV0ID4+IDYqKDMtaikpICYgMHgzRik7CiAgICB9CiAgfQogIHJldHVybiBzdHI7Cn0K';
	var oauth_js = 'data:application/javascript;base64,LyoKICogQ29weXJpZ2h0IDIwMDggTmV0ZmxpeCwgSW5jLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLgogKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICoKICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMAogKgogKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsCiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgogKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKi8KCi8qIEhlcmUncyBzb21lIEphdmFTY3JpcHQgc29mdHdhcmUgZm9yIGltcGxlbWVudGluZyBPQXV0aC4KCiAgIFRoaXMgaXNuJ3QgYXMgdXNlZnVsIGFzIHlvdSBtaWdodCBob3BlLiAgT0F1dGggaXMgYmFzZWQgYXJvdW5kCiAgIGFsbG93aW5nIHRvb2xzIGFuZCB3ZWJzaXRlcyB0byB0YWxrIHRvIGVhY2ggb3RoZXIuICBIb3dldmVyLAogICBKYXZhU2NyaXB0IHJ1bm5pbmcgaW4gd2ViIGJyb3dzZXJzIGlzIGhhbXBlcmVkIGJ5IHNlY3VyaXR5CiAgIHJlc3RyaWN0aW9ucyB0aGF0IHByZXZlbnQgY29kZSBydW5uaW5nIG9uIG9uZSB3ZWJzaXRlIGZyb20KICAgYWNjZXNzaW5nIGRhdGEgc3RvcmVkIG9yIHNlcnZlZCBvbiBhbm90aGVyLgoKICAgQmVmb3JlIHlvdSBzdGFydCBoYWNraW5nLCBtYWtlIHN1cmUgeW91IHVuZGVyc3RhbmQgdGhlIGxpbWl0YXRpb25zCiAgIHBvc2VkIGJ5IGNyb3NzLWRvbWFpbiBYTUxIdHRwUmVxdWVzdC4KCiAgIE9uIHRoZSBicmlnaHQgc2lkZSwgc29tZSBwbGF0Zm9ybXMgdXNlIEphdmFTY3JpcHQgYXMgdGhlaXIKICAgbGFuZ3VhZ2UsIGJ1dCBlbmFibGUgdGhlIHByb2dyYW1tZXIgdG8gYWNjZXNzIG90aGVyIHdlYiBzaXRlcy4KICAgRXhhbXBsZXMgaW5jbHVkZSBHb29nbGUgR2FkZ2V0cywgYW5kIE1pY3Jvc29mdCBWaXN0YSBTaWRlYmFyLgogICBGb3IgdGhvc2UgcGxhdGZvcm1zLCB0aGlzIGxpYnJhcnkgc2hvdWxkIGNvbWUgaW4gaGFuZHkuCiovCgovLyBUaGUgSE1BQy1TSEExIHNpZ25hdHVyZSBtZXRob2QgY2FsbHMgYjY0X2htYWNfc2hhMSwgZGVmaW5lZCBieQovLyBodHRwOi8vcGFqaG9tZS5vcmcudWsvY3J5cHQvbWQ1L3NoYTEuanMKCi8qIEFuIE9BdXRoIG1lc3NhZ2UgaXMgcmVwcmVzZW50ZWQgYXMgYW4gb2JqZWN0IGxpa2UgdGhpczoKICAge21ldGhvZDogIkdFVCIsIGFjdGlvbjogImh0dHA6Ly9zZXJ2ZXIuY29tL3BhdGgiLCBwYXJhbWV0ZXJzOiAuLi59CgogICBUaGUgcGFyYW1ldGVycyBtYXkgYmUgZWl0aGVyIGEgbWFwIHtuYW1lOiB2YWx1ZSwgbmFtZTI6IHZhbHVlMn0KICAgb3IgYW4gQXJyYXkgb2YgbmFtZS12YWx1ZSBwYWlycyBbW25hbWUsIHZhbHVlXSwgW25hbWUyLCB2YWx1ZTJdXS4KICAgVGhlIGxhdHRlciByZXByZXNlbnRhdGlvbiBpcyBtb3JlIHBvd2VyZnVsOiBpdCBzdXBwb3J0cyBwYXJhbWV0ZXJzCiAgIGluIGEgc3BlY2lmaWMgc2VxdWVuY2UsIG9yIHNldmVyYWwgcGFyYW1ldGVycyB3aXRoIHRoZSBzYW1lIG5hbWU7CiAgIGZvciBleGFtcGxlIFtbImEiLCAxXSwgWyJiIiwgMl0sIFsiYSIsIDNdXS4KCiAgIFBhcmFtZXRlciBuYW1lcyBhbmQgdmFsdWVzIGFyZSBOT1QgcGVyY2VudC1lbmNvZGVkIGluIGFuIG9iamVjdC4KICAgVGhleSBtdXN0IGJlIGVuY29kZWQgYmVmb3JlIHRyYW5zbWlzc2lvbiBhbmQgZGVjb2RlZCBhZnRlciByZWNlcHRpb24uCiAgIEZvciBleGFtcGxlLCB0aGlzIG1lc3NhZ2Ugb2JqZWN0OgogICB7bWV0aG9kOiAiR0VUIiwgYWN0aW9uOiAiaHR0cDovL3NlcnZlci9wYXRoIiwgcGFyYW1ldGVyczoge3A6ICJ4IHkifX0KICAgLi4uIGNhbiBiZSB0cmFuc21pdHRlZCBhcyBhbiBIVFRQIHJlcXVlc3QgdGhhdCBiZWdpbnM6CiAgIEdFVCAvcGF0aD9wPXglMjB5IEhUVFAvMS4wCiAgIChUaGlzIGlzbid0IGEgdmFsaWQgT0F1dGggcmVxdWVzdCwgc2luY2UgaXQgbGFja3MgYSBzaWduYXR1cmUgZXRjLikKICAgTm90ZSB0aGF0IHRoZSBvYmplY3QgInggeSIgaXMgdHJhbnNtaXR0ZWQgYXMgeCUyMHkuICBUbyBlbmNvZGUKICAgcGFyYW1ldGVycywgeW91IGNhbiBjYWxsIE9BdXRoLmFkZFRvVVJMLCBPQXV0aC5mb3JtRW5jb2RlIG9yCiAgIE9BdXRoLmdldEF1dGhvcml6YXRpb24uCgogICBUaGlzIG1lc3NhZ2Ugb2JqZWN0IG1vZGVsIGhhcm1vbml6ZXMgd2l0aCB0aGUgYnJvd3NlciBvYmplY3QgbW9kZWwgZm9yCiAgIGlucHV0IGVsZW1lbnRzIG9mIGFuIGZvcm0sIHdob3NlIHZhbHVlIHByb3BlcnR5IGlzbid0IHBlcmNlbnQgZW5jb2RlZC4KICAgVGhlIGJyb3dzZXIgZW5jb2RlcyBlYWNoIHZhbHVlIGJlZm9yZSB0cmFuc21pdHRpbmcgaXQuIEZvciBleGFtcGxlLAogICBzZWUgY29uc3VtZXIuc2V0SW5wdXRzIGluIGV4YW1wbGUvY29uc3VtZXIuanMuCiAqLwoKLyogVGhpcyBzY3JpcHQgbmVlZHMgdG8ga25vdyB3aGF0IHRpbWUgaXQgaXMuIEJ5IGRlZmF1bHQsIGl0IHVzZXMgdGhlIGxvY2FsCiAgIGNsb2NrIChuZXcgRGF0ZSksIHdoaWNoIGlzIGFwdCB0byBiZSBpbmFjY3VyYXRlIGluIGJyb3dzZXJzLiBUbyBkbwogICBiZXR0ZXIsIHlvdSBjYW4gbG9hZCB0aGlzIHNjcmlwdCBmcm9tIGEgVVJMIHdob3NlIHF1ZXJ5IHN0cmluZyBjb250YWlucwogICBhbiBvYXV0aF90aW1lc3RhbXAgcGFyYW1ldGVyLCB3aG9zZSB2YWx1ZSBpcyBhIGN1cnJlbnQgVW5peCB0aW1lc3RhbXAuCiAgIEZvciBleGFtcGxlLCB3aGVuIGdlbmVyYXRpbmcgdGhlIGVuY2xvc2luZyBkb2N1bWVudCB1c2luZyBQSFA6CgogICA8c2NyaXB0IHNyYz0ib2F1dGguanM/b2F1dGhfdGltZXN0YW1wPTw/PXRpbWUoKT8+IiAuLi4KCiAgIEFub3RoZXIgb3B0aW9uIGlzIHRvIGNhbGwgT0F1dGguY29ycmVjdFRpbWVzdGFtcCB3aXRoIGEgVW5peCB0aW1lc3RhbXAuCiAqLwoKdmFyIE9BdXRoOyBpZiAoT0F1dGggPT0gbnVsbCkgT0F1dGggPSB7fTsKCk9BdXRoLnNldFByb3BlcnRpZXMgPSBmdW5jdGlvbiBzZXRQcm9wZXJ0aWVzKGludG8sIGZyb20pIHsKICAgIGlmIChpbnRvICE9IG51bGwgJiYgZnJvbSAhPSBudWxsKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGZyb20pIHsKICAgICAgICAgICAgaW50b1trZXldID0gZnJvbVtrZXldOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBpbnRvOwp9CgpPQXV0aC5zZXRQcm9wZXJ0aWVzKE9BdXRoLCAvLyB1dGlsaXR5IGZ1bmN0aW9ucwp7CiAgICBwZXJjZW50RW5jb2RlOiBmdW5jdGlvbiBwZXJjZW50RW5jb2RlKHMpIHsKICAgICAgICBpZiAocyA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgaWYgKHMgaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICAgICB2YXIgZSA9ICIiOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyArK3MpIHsKICAgICAgICAgICAgICAgIGlmIChlICE9ICIiKSBlICs9ICcmJzsKICAgICAgICAgICAgICAgIGUgKz0gT0F1dGgucGVyY2VudEVuY29kZShzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZTsKICAgICAgICB9CiAgICAgICAgcyA9IGVuY29kZVVSSUNvbXBvbmVudChzKTsKICAgICAgICAvLyBOb3cgcmVwbGFjZSB0aGUgdmFsdWVzIHdoaWNoIGVuY29kZVVSSUNvbXBvbmVudCBkb2Vzbid0IGRvCiAgICAgICAgLy8gZW5jb2RlVVJJQ29tcG9uZW50IGlnbm9yZXM6IC0gXyAuICEgfiAqICcgKCApCiAgICAgICAgLy8gT0F1dGggZGljdGF0ZXMgdGhlIG9ubHkgb25lcyB5b3UgY2FuIGlnbm9yZSBhcmU6IC0gXyAuIH4KICAgICAgICAvLyBTb3VyY2U6IGh0dHA6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vZG9jcy9Db3JlX0phdmFTY3JpcHRfMS41X1JlZmVyZW5jZTpHbG9iYWxfRnVuY3Rpb25zOmVuY29kZVVSSUNvbXBvbmVudAogICAgICAgIHMgPSBzLnJlcGxhY2UoL1whL2csICIlMjEiKTsKICAgICAgICBzID0gcy5yZXBsYWNlKC9cKi9nLCAiJTJBIik7CiAgICAgICAgcyA9IHMucmVwbGFjZSgvXCcvZywgIiUyNyIpOwogICAgICAgIHMgPSBzLnJlcGxhY2UoL1woL2csICIlMjgiKTsKICAgICAgICBzID0gcy5yZXBsYWNlKC9cKS9nLCAiJTI5Iik7CiAgICAgICAgcmV0dXJuIHM7CiAgICB9CiwKICAgIGRlY29kZVBlcmNlbnQ6IGZ1bmN0aW9uIGRlY29kZVBlcmNlbnQocykgewogICAgICAgIGlmIChzICE9IG51bGwpIHsKICAgICAgICAgICAgLy8gSGFuZGxlIGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCwgd2hpY2ggaXMgZGVmaW5lZCBieQogICAgICAgICAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9odG1sNC9pbnRlcmFjdC9mb3Jtcy5odG1sI2gtMTcuMTMuNC4xCiAgICAgICAgICAgIHMgPSBzLnJlcGxhY2UoL1wrL2csICIgIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQocyk7CiAgICB9CiwKICAgIC8qKiBDb252ZXJ0IHRoZSBnaXZlbiBwYXJhbWV0ZXJzIHRvIGFuIEFycmF5IG9mIG5hbWUtdmFsdWUgcGFpcnMuICovCiAgICBnZXRQYXJhbWV0ZXJMaXN0OiBmdW5jdGlvbiBnZXRQYXJhbWV0ZXJMaXN0KHBhcmFtZXRlcnMpIHsKICAgICAgICBpZiAocGFyYW1ldGVycyA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBwYXJhbWV0ZXJzICE9ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHJldHVybiBPQXV0aC5kZWNvZGVGb3JtKHBhcmFtZXRlcnMgKyAiIik7CiAgICAgICAgfQogICAgICAgIGlmIChwYXJhbWV0ZXJzIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgICAgcmV0dXJuIHBhcmFtZXRlcnM7CiAgICAgICAgfQogICAgICAgIHZhciBsaXN0ID0gW107CiAgICAgICAgZm9yICh2YXIgcCBpbiBwYXJhbWV0ZXJzKSB7CiAgICAgICAgICAgIGxpc3QucHVzaChbcCwgcGFyYW1ldGVyc1twXV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbGlzdDsKICAgIH0KLAogICAgLyoqIENvbnZlcnQgdGhlIGdpdmVuIHBhcmFtZXRlcnMgdG8gYSBtYXAgZnJvbSBuYW1lIHRvIHZhbHVlLiAqLwogICAgZ2V0UGFyYW1ldGVyTWFwOiBmdW5jdGlvbiBnZXRQYXJhbWV0ZXJNYXAocGFyYW1ldGVycykgewogICAgICAgIGlmIChwYXJhbWV0ZXJzID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHt9OwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIHBhcmFtZXRlcnMgIT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIE9BdXRoLmdldFBhcmFtZXRlck1hcChPQXV0aC5kZWNvZGVGb3JtKHBhcmFtZXRlcnMgKyAiIikpOwogICAgICAgIH0KICAgICAgICBpZiAocGFyYW1ldGVycyBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgIHZhciBtYXAgPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIgcCA9IDA7IHAgPCBwYXJhbWV0ZXJzLmxlbmd0aDsgKytwKSB7CiAgICAgICAgICAgICAgICB2YXIga2V5ID0gcGFyYW1ldGVyc1twXVswXTsKICAgICAgICAgICAgICAgIGlmIChtYXBba2V5XSA9PT0gdW5kZWZpbmVkKSB7IC8vIGZpcnN0IHZhbHVlIHdpbnMKICAgICAgICAgICAgICAgICAgICBtYXBba2V5XSA9IHBhcmFtZXRlcnNbcF1bMV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1hcDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBhcmFtZXRlcnM7CiAgICB9CiwKICAgIGdldFBhcmFtZXRlcjogZnVuY3Rpb24gZ2V0UGFyYW1ldGVyKHBhcmFtZXRlcnMsIG5hbWUpIHsKICAgICAgICBpZiAocGFyYW1ldGVycyBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgIGZvciAodmFyIHAgPSAwOyBwIDwgcGFyYW1ldGVycy5sZW5ndGg7ICsrcCkgewogICAgICAgICAgICAgICAgaWYgKHBhcmFtZXRlcnNbcF1bMF0gPT0gbmFtZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJhbWV0ZXJzW3BdWzFdOyAvLyBmaXJzdCB2YWx1ZSB3aW5zCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gT0F1dGguZ2V0UGFyYW1ldGVyTWFwKHBhcmFtZXRlcnMpW25hbWVdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KLAogICAgZm9ybUVuY29kZTogZnVuY3Rpb24gZm9ybUVuY29kZShwYXJhbWV0ZXJzKSB7CiAgICAgICAgdmFyIGZvcm0gPSAiIjsKICAgICAgICB2YXIgbGlzdCA9IE9BdXRoLmdldFBhcmFtZXRlckxpc3QocGFyYW1ldGVycyk7CiAgICAgICAgZm9yICh2YXIgcCA9IDA7IHAgPCBsaXN0Lmxlbmd0aDsgKytwKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGxpc3RbcF1bMV07CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB2YWx1ZSA9ICIiOwogICAgICAgICAgICBpZiAoZm9ybSAhPSAiIikgZm9ybSArPSAnJic7CiAgICAgICAgICAgIGZvcm0gKz0gT0F1dGgucGVyY2VudEVuY29kZShsaXN0W3BdWzBdKQogICAgICAgICAgICAgICsnPScrIE9BdXRoLnBlcmNlbnRFbmNvZGUodmFsdWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZm9ybTsKICAgIH0KLAogICAgZGVjb2RlRm9ybTogZnVuY3Rpb24gZGVjb2RlRm9ybShmb3JtKSB7CiAgICAgICAgdmFyIGxpc3QgPSBbXTsKICAgICAgICB2YXIgbnZwcyA9IGZvcm0uc3BsaXQoJyYnKTsKICAgICAgICBmb3IgKHZhciBuID0gMDsgbiA8IG52cHMubGVuZ3RoOyArK24pIHsKICAgICAgICAgICAgdmFyIG52cCA9IG52cHNbbl07CiAgICAgICAgICAgIGlmIChudnAgPT0gIiIpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlcXVhbHMgPSBudnAuaW5kZXhPZignPScpOwogICAgICAgICAgICB2YXIgbmFtZTsKICAgICAgICAgICAgdmFyIHZhbHVlOwogICAgICAgICAgICBpZiAoZXF1YWxzIDwgMCkgewogICAgICAgICAgICAgICAgbmFtZSA9IE9BdXRoLmRlY29kZVBlcmNlbnQobnZwKTsKICAgICAgICAgICAgICAgIHZhbHVlID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5hbWUgPSBPQXV0aC5kZWNvZGVQZXJjZW50KG52cC5zdWJzdHJpbmcoMCwgZXF1YWxzKSk7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IE9BdXRoLmRlY29kZVBlcmNlbnQobnZwLnN1YnN0cmluZyhlcXVhbHMgKyAxKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGlzdC5wdXNoKFtuYW1lLCB2YWx1ZV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbGlzdDsKICAgIH0KLAogICAgc2V0UGFyYW1ldGVyOiBmdW5jdGlvbiBzZXRQYXJhbWV0ZXIobWVzc2FnZSwgbmFtZSwgdmFsdWUpIHsKICAgICAgICB2YXIgcGFyYW1ldGVycyA9IG1lc3NhZ2UucGFyYW1ldGVyczsKICAgICAgICBpZiAocGFyYW1ldGVycyBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgIGZvciAodmFyIHAgPSAwOyBwIDwgcGFyYW1ldGVycy5sZW5ndGg7ICsrcCkgewogICAgICAgICAgICAgICAgaWYgKHBhcmFtZXRlcnNbcF1bMF0gPT0gbmFtZSkgewogICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtZXRlcnMuc3BsaWNlKHAsIDEpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtZXRlcnNbcF1bMV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzLnB1c2goW25hbWUsIHZhbHVlXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwYXJhbWV0ZXJzID0gT0F1dGguZ2V0UGFyYW1ldGVyTWFwKHBhcmFtZXRlcnMpOwogICAgICAgICAgICBwYXJhbWV0ZXJzW25hbWVdID0gdmFsdWU7CiAgICAgICAgICAgIG1lc3NhZ2UucGFyYW1ldGVycyA9IHBhcmFtZXRlcnM7CiAgICAgICAgfQogICAgfQosCiAgICBzZXRQYXJhbWV0ZXJzOiBmdW5jdGlvbiBzZXRQYXJhbWV0ZXJzKG1lc3NhZ2UsIHBhcmFtZXRlcnMpIHsKICAgICAgICB2YXIgbGlzdCA9IE9BdXRoLmdldFBhcmFtZXRlckxpc3QocGFyYW1ldGVycyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIE9BdXRoLnNldFBhcmFtZXRlcihtZXNzYWdlLCBsaXN0W2ldWzBdLCBsaXN0W2ldWzFdKTsKICAgICAgICB9CiAgICB9CiwKICAgIC8qKiBGaWxsIGluIHBhcmFtZXRlcnMgdG8gaGVscCBjb25zdHJ1Y3QgYSByZXF1ZXN0IG1lc3NhZ2UuCiAgICAgICAgVGhpcyBmdW5jdGlvbiBkb2Vzbid0IGZpbGwgaW4gZXZlcnkgcGFyYW1ldGVyLgogICAgICAgIFRoZSBhY2Nlc3NvciBvYmplY3Qgc2hvdWxkIGJlIGxpa2U6CiAgICAgICAge2NvbnN1bWVyS2V5Oidmb28nLCBjb25zdW1lclNlY3JldDonYmFyJywgYWNjZXNzb3JTZWNyZXQ6J251cm4nLCB0b2tlbjona3JlbG0nLCB0b2tlblNlY3JldDonYmxhaCd9CiAgICAgICAgVGhlIGFjY2Vzc29yU2VjcmV0IHByb3BlcnR5IGlzIG9wdGlvbmFsLgogICAgICovCiAgICBjb21wbGV0ZVJlcXVlc3Q6IGZ1bmN0aW9uIGNvbXBsZXRlUmVxdWVzdChtZXNzYWdlLCBhY2Nlc3NvcikgewogICAgICAgIGlmIChtZXNzYWdlLm1ldGhvZCA9PSBudWxsKSB7CiAgICAgICAgICAgIG1lc3NhZ2UubWV0aG9kID0gIkdFVCI7CiAgICAgICAgfQogICAgICAgIHZhciBtYXAgPSBPQXV0aC5nZXRQYXJhbWV0ZXJNYXAobWVzc2FnZS5wYXJhbWV0ZXJzKTsKICAgICAgICBpZiAobWFwLm9hdXRoX2NvbnN1bWVyX2tleSA9PSBudWxsKSB7CiAgICAgICAgICAgIE9BdXRoLnNldFBhcmFtZXRlcihtZXNzYWdlLCAib2F1dGhfY29uc3VtZXJfa2V5IiwgYWNjZXNzb3IuY29uc3VtZXJLZXkgfHwgIiIpOwogICAgICAgIH0KICAgICAgICBpZiAobWFwLm9hdXRoX3Rva2VuID09IG51bGwgJiYgYWNjZXNzb3IudG9rZW4gIT0gbnVsbCkgewogICAgICAgICAgICBPQXV0aC5zZXRQYXJhbWV0ZXIobWVzc2FnZSwgIm9hdXRoX3Rva2VuIiwgYWNjZXNzb3IudG9rZW4pOwogICAgICAgIH0KICAgICAgICBpZiAobWFwLm9hdXRoX3ZlcnNpb24gPT0gbnVsbCkgewogICAgICAgICAgICBPQXV0aC5zZXRQYXJhbWV0ZXIobWVzc2FnZSwgIm9hdXRoX3ZlcnNpb24iLCAiMS4wIik7CiAgICAgICAgfQogICAgICAgIGlmIChtYXAub2F1dGhfdGltZXN0YW1wID09IG51bGwpIHsKICAgICAgICAgICAgT0F1dGguc2V0UGFyYW1ldGVyKG1lc3NhZ2UsICJvYXV0aF90aW1lc3RhbXAiLCBPQXV0aC50aW1lc3RhbXAoKSk7CiAgICAgICAgfQogICAgICAgIGlmIChtYXAub2F1dGhfbm9uY2UgPT0gbnVsbCkgewogICAgICAgICAgICBPQXV0aC5zZXRQYXJhbWV0ZXIobWVzc2FnZSwgIm9hdXRoX25vbmNlIiwgT0F1dGgubm9uY2UoNikpOwogICAgICAgIH0KICAgICAgICBPQXV0aC5TaWduYXR1cmVNZXRob2Quc2lnbihtZXNzYWdlLCBhY2Nlc3Nvcik7CiAgICB9CiwKICAgIHNldFRpbWVzdGFtcEFuZE5vbmNlOiBmdW5jdGlvbiBzZXRUaW1lc3RhbXBBbmROb25jZShtZXNzYWdlKSB7CiAgICAgICAgT0F1dGguc2V0UGFyYW1ldGVyKG1lc3NhZ2UsICJvYXV0aF90aW1lc3RhbXAiLCBPQXV0aC50aW1lc3RhbXAoKSk7CiAgICAgICAgT0F1dGguc2V0UGFyYW1ldGVyKG1lc3NhZ2UsICJvYXV0aF9ub25jZSIsIE9BdXRoLm5vbmNlKDYpKTsKICAgIH0KLAogICAgYWRkVG9VUkw6IGZ1bmN0aW9uIGFkZFRvVVJMKHVybCwgcGFyYW1ldGVycykgewogICAgICAgIG5ld1VSTCA9IHVybDsKICAgICAgICBpZiAocGFyYW1ldGVycyAhPSBudWxsKSB7CiAgICAgICAgICAgIHZhciB0b0FkZCA9IE9BdXRoLmZvcm1FbmNvZGUocGFyYW1ldGVycyk7CiAgICAgICAgICAgIGlmICh0b0FkZC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICB2YXIgcSA9IHVybC5pbmRleE9mKCc/Jyk7CiAgICAgICAgICAgICAgICBpZiAocSA8IDApIG5ld1VSTCArPSAnPyc7CiAgICAgICAgICAgICAgICBlbHNlICAgICAgIG5ld1VSTCArPSAnJic7CiAgICAgICAgICAgICAgICBuZXdVUkwgKz0gdG9BZGQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld1VSTDsKICAgIH0KLAogICAgLyoqIENvbnN0cnVjdCB0aGUgdmFsdWUgb2YgdGhlIEF1dGhvcml6YXRpb24gaGVhZGVyIGZvciBhbiBIVFRQIHJlcXVlc3QuICovCiAgICBnZXRBdXRob3JpemF0aW9uSGVhZGVyOiBmdW5jdGlvbiBnZXRBdXRob3JpemF0aW9uSGVhZGVyKHJlYWxtLCBwYXJhbWV0ZXJzKSB7CiAgICAgICAgdmFyIGhlYWRlciA9ICdPQXV0aCByZWFsbT0iJyArIE9BdXRoLnBlcmNlbnRFbmNvZGUocmVhbG0pICsgJyInOwogICAgICAgIHZhciBsaXN0ID0gT0F1dGguZ2V0UGFyYW1ldGVyTGlzdChwYXJhbWV0ZXJzKTsKICAgICAgICBmb3IgKHZhciBwID0gMDsgcCA8IGxpc3QubGVuZ3RoOyArK3ApIHsKICAgICAgICAgICAgdmFyIHBhcmFtZXRlciA9IGxpc3RbcF07CiAgICAgICAgICAgIHZhciBuYW1lID0gcGFyYW1ldGVyWzBdOwogICAgICAgICAgICBpZiAobmFtZS5pbmRleE9mKCJvYXV0aF8iKSA9PSAwKSB7CiAgICAgICAgICAgICAgICBoZWFkZXIgKz0gJywnICsgT0F1dGgucGVyY2VudEVuY29kZShuYW1lKSArICc9IicgKyBPQXV0aC5wZXJjZW50RW5jb2RlKHBhcmFtZXRlclsxXSkgKyAnIic7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGhlYWRlcjsKICAgIH0KLAogICAgLyoqIENvcnJlY3QgdGhlIHRpbWUgdXNpbmcgYSBwYXJhbWV0ZXIgZnJvbSB0aGUgVVJMIGZyb20gd2hpY2ggdGhlIGxhc3Qgc2NyaXB0IHdhcyBsb2FkZWQuICovCiAgICBjb3JyZWN0VGltZXN0YW1wRnJvbVNyYzogZnVuY3Rpb24gY29ycmVjdFRpbWVzdGFtcEZyb21TcmMocGFyYW1ldGVyTmFtZSkgewogICAgICAgIHBhcmFtZXRlck5hbWUgPSBwYXJhbWV0ZXJOYW1lIHx8ICJvYXV0aF90aW1lc3RhbXAiOwogICAgICAgIHZhciBzY3JpcHRzID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3NjcmlwdCcpOwogICAgICAgIGlmIChzY3JpcHRzID09IG51bGwgfHwgIXNjcmlwdHMubGVuZ3RoKSByZXR1cm47CiAgICAgICAgdmFyIHNyYyA9IHNjcmlwdHNbc2NyaXB0cy5sZW5ndGgtMV0uc3JjOwogICAgICAgIGlmICghc3JjKSByZXR1cm47CiAgICAgICAgdmFyIHEgPSBzcmMuaW5kZXhPZigiPyIpOwogICAgICAgIGlmIChxIDwgMCkgcmV0dXJuOwogICAgICAgIHBhcmFtZXRlcnMgPSBPQXV0aC5nZXRQYXJhbWV0ZXJNYXAoT0F1dGguZGVjb2RlRm9ybShzcmMuc3Vic3RyaW5nKHErMSkpKTsKICAgICAgICB2YXIgdCA9IHBhcmFtZXRlcnNbcGFyYW1ldGVyTmFtZV07CiAgICAgICAgaWYgKHQgPT0gbnVsbCkgcmV0dXJuOwogICAgICAgIE9BdXRoLmNvcnJlY3RUaW1lc3RhbXAodCk7CiAgICB9CiwKICAgIC8qKiBHZW5lcmF0ZSB0aW1lc3RhbXBzIHN0YXJ0aW5nIHdpdGggdGhlIGdpdmVuIHZhbHVlLiAqLwogICAgY29ycmVjdFRpbWVzdGFtcDogZnVuY3Rpb24gY29ycmVjdFRpbWVzdGFtcCh0aW1lc3RhbXApIHsKICAgICAgICBPQXV0aC50aW1lQ29ycmVjdGlvbk1zZWMgPSAodGltZXN0YW1wICogMTAwMCkgLSAobmV3IERhdGUoKSkuZ2V0VGltZSgpOwogICAgfQosCiAgICAvKiogVGhlIGRpZmZlcmVuY2UgYmV0d2VlbiB0aGUgY29ycmVjdCB0aW1lIGFuZCBteSBjbG9jay4gKi8KICAgIHRpbWVDb3JyZWN0aW9uTXNlYzogMAosCiAgICB0aW1lc3RhbXA6IGZ1bmN0aW9uIHRpbWVzdGFtcCgpIHsKICAgICAgICB2YXIgdCA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCkgKyBPQXV0aC50aW1lQ29ycmVjdGlvbk1zZWM7CiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IodCAvIDEwMDApOwogICAgfQosCiAgICBub25jZTogZnVuY3Rpb24gbm9uY2UobGVuZ3RoKSB7CiAgICAgICAgdmFyIGNoYXJzID0gT0F1dGgubm9uY2UuQ0hBUlM7CiAgICAgICAgdmFyIHJlc3VsdCA9ICIiOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgdmFyIHJudW0gPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBjaGFycy5sZW5ndGgpOwogICAgICAgICAgICByZXN1bHQgKz0gY2hhcnMuc3Vic3RyaW5nKHJudW0sIHJudW0rMSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9Cn0pOwoKT0F1dGgubm9uY2UuQ0hBUlMgPSAiMDEyMzQ1Njc4OUFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFRaYWJjZGVmZ2hpa2xtbm9wcXJzdHV2d3h5eiI7CgovKiogRGVmaW5lIGEgY29uc3RydWN0b3IgZnVuY3Rpb24sCiAgICB3aXRob3V0IGNhdXNpbmcgdHJvdWJsZSB0byBhbnlvbmUgd2hvIHdhcyB1c2luZyBpdCBhcyBhIG5hbWVzcGFjZS4KICAgIFRoYXQgaXMsIGlmIHBhcmVudFtuYW1lXSBhbHJlYWR5IGV4aXN0ZWQgYW5kIGhhZCBwcm9wZXJ0aWVzLAogICAgY29weSB0aG9zZSBwcm9wZXJ0aWVzIGludG8gdGhlIG5ldyBjb25zdHJ1Y3Rvci4KICovCk9BdXRoLmRlY2xhcmVDbGFzcyA9IGZ1bmN0aW9uIGRlY2xhcmVDbGFzcyhwYXJlbnQsIG5hbWUsIG5ld0NvbnN0cnVjdG9yKSB7CiAgICB2YXIgcHJldmlvdXMgPSBwYXJlbnRbbmFtZV07CiAgICBwYXJlbnRbbmFtZV0gPSBuZXdDb25zdHJ1Y3RvcjsKICAgIGlmIChuZXdDb25zdHJ1Y3RvciAhPSBudWxsICYmIHByZXZpb3VzICE9IG51bGwpIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gcHJldmlvdXMpIHsKICAgICAgICAgICAgaWYgKGtleSAhPSAicHJvdG90eXBlIikgewogICAgICAgICAgICAgICAgbmV3Q29uc3RydWN0b3Jba2V5XSA9IHByZXZpb3VzW2tleV07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gbmV3Q29uc3RydWN0b3I7Cn0KCi8qKiBBbiBhYnN0cmFjdCBhbGdvcml0aG0gZm9yIHNpZ25pbmcgbWVzc2FnZXMuICovCk9BdXRoLmRlY2xhcmVDbGFzcyhPQXV0aCwgIlNpZ25hdHVyZU1ldGhvZCIsIGZ1bmN0aW9uIE9BdXRoU2lnbmF0dXJlTWV0aG9kKCl7fSk7CgpPQXV0aC5zZXRQcm9wZXJ0aWVzKE9BdXRoLlNpZ25hdHVyZU1ldGhvZC5wcm90b3R5cGUsIC8vIGluc3RhbmNlIG1lbWJlcnMKewogICAgLyoqIEFkZCBhIHNpZ25hdHVyZSB0byB0aGUgbWVzc2FnZS4gKi8KICAgIHNpZ246IGZ1bmN0aW9uIHNpZ24obWVzc2FnZSkgewogICAgICAgIHZhciBiYXNlU3RyaW5nID0gT0F1dGguU2lnbmF0dXJlTWV0aG9kLmdldEJhc2VTdHJpbmcobWVzc2FnZSk7CiAgICAgICAgdmFyIHNpZ25hdHVyZSA9IHRoaXMuZ2V0U2lnbmF0dXJlKGJhc2VTdHJpbmcpOwogICAgICAgIE9BdXRoLnNldFBhcmFtZXRlcihtZXNzYWdlLCAib2F1dGhfc2lnbmF0dXJlIiwgc2lnbmF0dXJlKTsKICAgICAgICByZXR1cm4gc2lnbmF0dXJlOyAvLyBqdXN0IGluIGNhc2Ugc29tZW9uZSdzIGludGVyZXN0ZWQKICAgIH0KLAogICAgLyoqIFNldCB0aGUga2V5IHN0cmluZyBmb3Igc2lnbmluZy4gKi8KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uIGluaXRpYWxpemUobmFtZSwgYWNjZXNzb3IpIHsKICAgICAgICB2YXIgY29uc3VtZXJTZWNyZXQ7CiAgICAgICAgaWYgKGFjY2Vzc29yLmFjY2Vzc29yU2VjcmV0ICE9IG51bGwKICAgICAgICAgICAgJiYgbmFtZS5sZW5ndGggPiA5CiAgICAgICAgICAgICYmIG5hbWUuc3Vic3RyaW5nKG5hbWUubGVuZ3RoLTkpID09ICItQWNjZXNzb3IiKQogICAgICAgIHsKICAgICAgICAgICAgY29uc3VtZXJTZWNyZXQgPSBhY2Nlc3Nvci5hY2Nlc3NvclNlY3JldDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdW1lclNlY3JldCA9IGFjY2Vzc29yLmNvbnN1bWVyU2VjcmV0OwogICAgICAgIH0KICAgICAgICB0aGlzLmtleSA9IE9BdXRoLnBlcmNlbnRFbmNvZGUoY29uc3VtZXJTZWNyZXQpCiAgICAgICAgICAgICArIiYiKyBPQXV0aC5wZXJjZW50RW5jb2RlKGFjY2Vzc29yLnRva2VuU2VjcmV0KTsKICAgIH0KfSk7CgovKiBTaWduYXR1cmVNZXRob2QgZXhwZWN0cyBhbiBhY2Nlc3NvciBvYmplY3QgdG8gYmUgbGlrZSB0aGlzOgogICB7dG9rZW5TZWNyZXQ6ICJsYWtqc2RmbGtqLi4uIiwgY29uc3VtZXJTZWNyZXQ6ICJRT1VFV1JJLi4iLCBhY2Nlc3NvclNlY3JldDogInhjbXZ6Yy4uLiJ9CiAgIFRoZSBhY2Nlc3NvclNlY3JldCBwcm9wZXJ0eSBpcyBvcHRpb25hbC4KICovCi8vIENsYXNzIG1lbWJlcnM6Ck9BdXRoLnNldFByb3BlcnRpZXMoT0F1dGguU2lnbmF0dXJlTWV0aG9kLCAvLyBjbGFzcyBtZW1iZXJzCnsKICAgIHNpZ246IGZ1bmN0aW9uIHNpZ24obWVzc2FnZSwgYWNjZXNzb3IpIHsKICAgICAgICB2YXIgbmFtZSA9IE9BdXRoLmdldFBhcmFtZXRlck1hcChtZXNzYWdlLnBhcmFtZXRlcnMpLm9hdXRoX3NpZ25hdHVyZV9tZXRob2Q7CiAgICAgICAgaWYgKG5hbWUgPT0gbnVsbCB8fCBuYW1lID09ICIiKSB7CiAgICAgICAgICAgIG5hbWUgPSAiSE1BQy1TSEExIjsKICAgICAgICAgICAgT0F1dGguc2V0UGFyYW1ldGVyKG1lc3NhZ2UsICJvYXV0aF9zaWduYXR1cmVfbWV0aG9kIiwgbmFtZSk7CiAgICAgICAgfQogICAgICAgIE9BdXRoLlNpZ25hdHVyZU1ldGhvZC5uZXdNZXRob2QobmFtZSwgYWNjZXNzb3IpLnNpZ24obWVzc2FnZSk7CiAgICB9CiwKICAgIC8qKiBJbnN0YW50aWF0ZSBhIFNpZ25hdHVyZU1ldGhvZCBmb3IgdGhlIGdpdmVuIG1ldGhvZCBuYW1lLiAqLwogICAgbmV3TWV0aG9kOiBmdW5jdGlvbiBuZXdNZXRob2QobmFtZSwgYWNjZXNzb3IpIHsKICAgICAgICB2YXIgaW1wbCA9IE9BdXRoLlNpZ25hdHVyZU1ldGhvZC5SRUdJU1RFUkVEW25hbWVdOwogICAgICAgIGlmIChpbXBsICE9IG51bGwpIHsKICAgICAgICAgICAgdmFyIG1ldGhvZCA9IG5ldyBpbXBsKCk7CiAgICAgICAgICAgIG1ldGhvZC5pbml0aWFsaXplKG5hbWUsIGFjY2Vzc29yKTsKICAgICAgICAgICAgcmV0dXJuIG1ldGhvZDsKICAgICAgICB9CiAgICAgICAgdmFyIGVyciA9IG5ldyBFcnJvcigic2lnbmF0dXJlX21ldGhvZF9yZWplY3RlZCIpOwogICAgICAgIHZhciBhY2NlcHRhYmxlID0gIiI7CiAgICAgICAgZm9yICh2YXIgciBpbiBPQXV0aC5TaWduYXR1cmVNZXRob2QuUkVHSVNURVJFRCkgewogICAgICAgICAgICBpZiAoYWNjZXB0YWJsZSAhPSAiIikgYWNjZXB0YWJsZSArPSAnJic7CiAgICAgICAgICAgIGFjY2VwdGFibGUgKz0gT0F1dGgucGVyY2VudEVuY29kZShyKTsKICAgICAgICB9CiAgICAgICAgZXJyLm9hdXRoX2FjY2VwdGFibGVfc2lnbmF0dXJlX21ldGhvZHMgPSBhY2NlcHRhYmxlOwogICAgICAgIHRocm93IGVycjsKICAgIH0KLAogICAgLyoqIEEgbWFwIGZyb20gc2lnbmF0dXJlIG1ldGhvZCBuYW1lIHRvIGNvbnN0cnVjdG9yLiAqLwogICAgUkVHSVNURVJFRCA6IHt9CiwKICAgIC8qKiBTdWJzZXF1ZW50bHksIHRoZSBnaXZlbiBjb25zdHJ1Y3RvciB3aWxsIGJlIHVzZWQgZm9yIHRoZSBuYW1lZCBtZXRob2RzLgogICAgICAgIFRoZSBjb25zdHJ1Y3RvciB3aWxsIGJlIGNhbGxlZCB3aXRoIG5vIHBhcmFtZXRlcnMuCiAgICAgICAgVGhlIHJlc3VsdGluZyBvYmplY3Qgc2hvdWxkIHVzdWFsbHkgaW1wbGVtZW50IGdldFNpZ25hdHVyZShiYXNlU3RyaW5nKS4KICAgICAgICBZb3UgY2FuIGVhc2lseSBkZWZpbmUgc3VjaCBhIGNvbnN0cnVjdG9yIGJ5IGNhbGxpbmcgbWFrZVN1YmNsYXNzLCBiZWxvdy4KICAgICAqLwogICAgcmVnaXN0ZXJNZXRob2RDbGFzczogZnVuY3Rpb24gcmVnaXN0ZXJNZXRob2RDbGFzcyhuYW1lcywgY2xhc3NDb25zdHJ1Y3RvcikgewogICAgICAgIGZvciAodmFyIG4gPSAwOyBuIDwgbmFtZXMubGVuZ3RoOyArK24pIHsKICAgICAgICAgICAgT0F1dGguU2lnbmF0dXJlTWV0aG9kLlJFR0lTVEVSRURbbmFtZXNbbl1dID0gY2xhc3NDb25zdHJ1Y3RvcjsKICAgICAgICB9CiAgICB9CiwKICAgIC8qKiBDcmVhdGUgYSBzdWJjbGFzcyBvZiBPQXV0aC5TaWduYXR1cmVNZXRob2QsIHdpdGggdGhlIGdpdmVuIGdldFNpZ25hdHVyZSBmdW5jdGlvbi4gKi8KICAgIG1ha2VTdWJjbGFzczogZnVuY3Rpb24gbWFrZVN1YmNsYXNzKGdldFNpZ25hdHVyZUZ1bmN0aW9uKSB7CiAgICAgICAgdmFyIHN1cGVyQ2xhc3MgPSBPQXV0aC5TaWduYXR1cmVNZXRob2Q7CiAgICAgICAgdmFyIHN1YkNsYXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHN1cGVyQ2xhc3MuY2FsbCh0aGlzKTsKICAgICAgICB9OwogICAgICAgIHN1YkNsYXNzLnByb3RvdHlwZSA9IG5ldyBzdXBlckNsYXNzKCk7CiAgICAgICAgLy8gRGVsZXRlIGluc3RhbmNlIHZhcmlhYmxlcyBmcm9tIHByb3RvdHlwZToKICAgICAgICAvLyBkZWxldGUgc3ViY2xhc3MucHJvdG90eXBlLi4uIFRoZXJlIGFyZW4ndCBhbnkuCiAgICAgICAgc3ViQ2xhc3MucHJvdG90eXBlLmdldFNpZ25hdHVyZSA9IGdldFNpZ25hdHVyZUZ1bmN0aW9uOwogICAgICAgIHN1YkNsYXNzLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IHN1YkNsYXNzOwogICAgICAgIHJldHVybiBzdWJDbGFzczsKICAgIH0KLAogICAgZ2V0QmFzZVN0cmluZzogZnVuY3Rpb24gZ2V0QmFzZVN0cmluZyhtZXNzYWdlKSB7CiAgICAgICAgdmFyIFVSTCA9IG1lc3NhZ2UuYWN0aW9uOwogICAgICAgIHZhciBxID0gVVJMLmluZGV4T2YoJz8nKTsKICAgICAgICB2YXIgcGFyYW1ldGVyczsKICAgICAgICBpZiAocSA8IDApIHsKICAgICAgICAgICAgcGFyYW1ldGVycyA9IG1lc3NhZ2UucGFyYW1ldGVyczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBDb21iaW5lIHRoZSBVUkwgcXVlcnkgc3RyaW5nIHdpdGggdGhlIG90aGVyIHBhcmFtZXRlcnM6CiAgICAgICAgICAgIHBhcmFtZXRlcnMgPSBPQXV0aC5kZWNvZGVGb3JtKFVSTC5zdWJzdHJpbmcocSArIDEpKTsKICAgICAgICAgICAgdmFyIHRvQWRkID0gT0F1dGguZ2V0UGFyYW1ldGVyTGlzdChtZXNzYWdlLnBhcmFtZXRlcnMpOwogICAgICAgICAgICBmb3IgKHZhciBhID0gMDsgYSA8IHRvQWRkLmxlbmd0aDsgKythKSB7CiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzLnB1c2godG9BZGRbYV0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBPQXV0aC5wZXJjZW50RW5jb2RlKG1lc3NhZ2UubWV0aG9kLnRvVXBwZXJDYXNlKCkpCiAgICAgICAgICsnJicrIE9BdXRoLnBlcmNlbnRFbmNvZGUoT0F1dGguU2lnbmF0dXJlTWV0aG9kLm5vcm1hbGl6ZVVybChVUkwpKQogICAgICAgICArJyYnKyBPQXV0aC5wZXJjZW50RW5jb2RlKE9BdXRoLlNpZ25hdHVyZU1ldGhvZC5ub3JtYWxpemVQYXJhbWV0ZXJzKHBhcmFtZXRlcnMpKTsKICAgIH0KLAogICAgbm9ybWFsaXplVXJsOiBmdW5jdGlvbiBub3JtYWxpemVVcmwodXJsKSB7CiAgICAgICAgdmFyIHVyaSA9IE9BdXRoLlNpZ25hdHVyZU1ldGhvZC5wYXJzZVVyaSh1cmwpOwogICAgICAgIHZhciBzY2hlbWUgPSB1cmkucHJvdG9jb2wudG9Mb3dlckNhc2UoKTsKICAgICAgICB2YXIgYXV0aG9yaXR5ID0gdXJpLmF1dGhvcml0eS50b0xvd2VyQ2FzZSgpOwogICAgICAgIHZhciBkcm9wUG9ydCA9IChzY2hlbWUgPT0gImh0dHAiICYmIHVyaS5wb3J0ID09IDgwKQogICAgICAgICAgICAgICAgICAgIHx8IChzY2hlbWUgPT0gImh0dHBzIiAmJiB1cmkucG9ydCA9PSA0NDMpOwogICAgICAgIGlmIChkcm9wUG9ydCkgewogICAgICAgICAgICAvLyBmaW5kIHRoZSBsYXN0IDogaW4gdGhlIGF1dGhvcml0eQogICAgICAgICAgICB2YXIgaW5kZXggPSBhdXRob3JpdHkubGFzdEluZGV4T2YoIjoiKTsKICAgICAgICAgICAgaWYgKGluZGV4ID49IDApIHsKICAgICAgICAgICAgICAgIGF1dGhvcml0eSA9IGF1dGhvcml0eS5zdWJzdHJpbmcoMCwgaW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBwYXRoID0gdXJpLnBhdGg7CiAgICAgICAgaWYgKCFwYXRoKSB7CiAgICAgICAgICAgIHBhdGggPSAiLyI7IC8vIGNvbmZvcm1zIHRvIFJGQyAyNjE2IHNlY3Rpb24gMy4yLjIKICAgICAgICB9CiAgICAgICAgLy8gd2Uga25vdyB0aGF0IHRoZXJlIGlzIG5vIHF1ZXJ5IGFuZCBubyBmcmFnbWVudCBoZXJlLgogICAgICAgIHJldHVybiBzY2hlbWUgKyAiOi8vIiArIGF1dGhvcml0eSArIHBhdGg7CiAgICB9CiwKICAgIHBhcnNlVXJpOiBmdW5jdGlvbiBwYXJzZVVyaSAoc3RyKSB7CiAgICAgICAgLyogVGhpcyBmdW5jdGlvbiB3YXMgYWRhcHRlZCBmcm9tIHBhcnNlVXJpIDEuMi4xCiAgICAgICAgICAgaHR0cDovL3N0ZXZlbmxldml0aGFuLmNvbS9kZW1vL3BhcnNldXJpL2pzL2Fzc2V0cy9wYXJzZXVyaS5qcwogICAgICAgICAqLwogICAgICAgIHZhciBvID0ge2tleTogWyJzb3VyY2UiLCJwcm90b2NvbCIsImF1dGhvcml0eSIsInVzZXJJbmZvIiwidXNlciIsInBhc3N3b3JkIiwiaG9zdCIsInBvcnQiLCJyZWxhdGl2ZSIsInBhdGgiLCJkaXJlY3RvcnkiLCJmaWxlIiwicXVlcnkiLCJhbmNob3IiXSwKICAgICAgICAgICAgICAgICBwYXJzZXI6IHtzdHJpY3Q6IC9eKD86KFteOlwvPyNdKyk6KT8oPzpcL1wvKCg/OigoW146QFwvXSopOj8oW146QFwvXSopKT9AKT8oW146XC8/I10qKSg/OjooXGQqKSk/KSk/KCgoKD86W14/I1wvXSpcLykqKShbXj8jXSopKSg/Olw/KFteI10qKSk/KD86IyguKikpPykvIH19OwogICAgICAgIHZhciBtID0gby5wYXJzZXIuc3RyaWN0LmV4ZWMoc3RyKTsKICAgICAgICB2YXIgdXJpID0ge307CiAgICAgICAgdmFyIGkgPSAxNDsKICAgICAgICB3aGlsZSAoaS0tKSB1cmlbby5rZXlbaV1dID0gbVtpXSB8fCAiIjsKICAgICAgICByZXR1cm4gdXJpOwogICAgfQosCiAgICBub3JtYWxpemVQYXJhbWV0ZXJzOiBmdW5jdGlvbiBub3JtYWxpemVQYXJhbWV0ZXJzKHBhcmFtZXRlcnMpIHsKICAgICAgICBpZiAocGFyYW1ldGVycyA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgdmFyIGxpc3QgPSBPQXV0aC5nZXRQYXJhbWV0ZXJMaXN0KHBhcmFtZXRlcnMpOwogICAgICAgIHZhciBzb3J0YWJsZSA9IFtdOwogICAgICAgIGZvciAodmFyIHAgPSAwOyBwIDwgbGlzdC5sZW5ndGg7ICsrcCkgewogICAgICAgICAgICB2YXIgbnZwID0gbGlzdFtwXTsKICAgICAgICAgICAgaWYgKG52cFswXSAhPSAib2F1dGhfc2lnbmF0dXJlIikgewogICAgICAgICAgICAgICAgc29ydGFibGUucHVzaChbIE9BdXRoLnBlcmNlbnRFbmNvZGUobnZwWzBdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICArICIgIiAvLyBiZWNhdXNlIGl0IGNvbWVzIGJlZm9yZSBhbnkgY2hhcmFjdGVyIHRoYXQgY2FuIGFwcGVhciBpbiBhIHBlcmNlbnRFbmNvZGVkIHN0cmluZy4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKyBPQXV0aC5wZXJjZW50RW5jb2RlKG52cFsxXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLCBudnBdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzb3J0YWJsZS5zb3J0KGZ1bmN0aW9uKGEsYikgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhWzBdIDwgYlswXSkgcmV0dXJuICAtMTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYVswXSA+IGJbMF0pIHJldHVybiAxOwogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgdmFyIHNvcnRlZCA9IFtdOwogICAgICAgIGZvciAodmFyIHMgPSAwOyBzIDwgc29ydGFibGUubGVuZ3RoOyArK3MpIHsKICAgICAgICAgICAgc29ydGVkLnB1c2goc29ydGFibGVbc11bMV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gT0F1dGguZm9ybUVuY29kZShzb3J0ZWQpOwogICAgfQp9KTsKCk9BdXRoLlNpZ25hdHVyZU1ldGhvZC5yZWdpc3Rlck1ldGhvZENsYXNzKFsiUExBSU5URVhUIiwgIlBMQUlOVEVYVC1BY2Nlc3NvciJdLAogICAgT0F1dGguU2lnbmF0dXJlTWV0aG9kLm1ha2VTdWJjbGFzcygKICAgICAgICBmdW5jdGlvbiBnZXRTaWduYXR1cmUoYmFzZVN0cmluZykgewogICAgICAgICAgICByZXR1cm4gdGhpcy5rZXk7CiAgICAgICAgfQogICAgKSk7CgpPQXV0aC5TaWduYXR1cmVNZXRob2QucmVnaXN0ZXJNZXRob2RDbGFzcyhbIkhNQUMtU0hBMSIsICJITUFDLVNIQTEtQWNjZXNzb3IiXSwKICAgIE9BdXRoLlNpZ25hdHVyZU1ldGhvZC5tYWtlU3ViY2xhc3MoCiAgICAgICAgZnVuY3Rpb24gZ2V0U2lnbmF0dXJlKGJhc2VTdHJpbmcpIHsKICAgICAgICAgICAgYjY0cGFkID0gJz0nOwogICAgICAgICAgICB2YXIgc2lnbmF0dXJlID0gYjY0X2htYWNfc2hhMSh0aGlzLmtleSwgYmFzZVN0cmluZyk7CiAgICAgICAgICAgIHJldHVybiBzaWduYXR1cmU7CiAgICAgICAgfQogICAgKSk7CgpPQXV0aC5jb3JyZWN0VGltZXN0YW1wRnJvbVNyYygpOwo=';

	var oauth_client = {
		'consumerKey': 'dtsfN6UjMAXBlQScsA4nQ',
		'consumerSecret': 'fcaVVNkiRL75INMmcpMJhWH5AOx67QPhKKk6oamEf2o',
		'serviceProvider': {
			'signatureMethod': 'HMAC-SHA1',
			'requestTokenURL': 'http://twitter.com/oauth/request_token',
			'userAuthorizationURL': 'http://twitter.com/oauth/authorize',
			'accessTokenURL': 'http://twitter.com/oauth/access_token',
			'updateStatusURL': 'http://twitter.com/statuses/update.json'
		}
	}

	function load_script(src) {
		var s = document.createElement('script');
		s.src = src
		s.type = 'text/javascript';
		h.appendChild(s);
	}
	
	function get_short_url(xhr, callback) {
		if(xhr) {
			try {
				r = JSON.parse(xhr.responseText);
			} catch(e) {
				GM_log(e);
				return;
			}
			if(r.statusCode == "OK" && r.results[unsafeWindow.location.href]) {
				var short_url = r.results[unsafeWindow.location.href].shortUrl;
				if(typeof callback == 'function') {
					callback.call(null, short_url);
				}
			}
			return;
		}
		
		var user = GM_getValue('jmp.user', null);
		var key = GM_getValue('jmp.key', null);
		if(!user) {
			user = prompt('j.mp user:');
			GM_setValue('jmp.user', user);
		}
		if(!key) {
			key = prompt('j.mp API key:');
			GM_setValue('jmp.key', key);
		}
		
		var jmp = ['http://api.j.mp/shorten?version=2.0.1&longUrl=', unsafeWindow.location.href, '&login=', user, '&apiKey=', key].join('');
		var xhr = GM_xmlhttpRequest({
			url: jmp,
			method: 'GET',
			onload: function(x) { get_short_url(x, callback); }
		});
	}
	
	function setup_ui(short_url) {
		if(!short_url) {
			return;
		}
		var bb = dom.get('gray_set_button_bar');
		var ul = dom.getChildrenBy(bb, function(x){return x.nodeName == 'UL' && dom.hasClass(x, 'gray_menu_buttons');})[0];

		var li = document.createElement('li');
		li.id = 'candy_set_button_tweet';
		li.className = 'no_menu_li';
		li.innerHTML = '<span class="button"><span class="left padded"><a onclick="return false;">Tweet this</a></span><img width="2" height="22" class="gray_button_no_caret" src="http://l.yimg.com/g/images/gray_button_no_caret_default.gif"></span>';

		var img = li.getElementsByClassName('gray_button_no_caret')[0];
		li.addEventListener('mouseover', function(){dom.addClass(li, 'hover'); img.src='http://l.yimg.com/g/images/gray_button_no_caret_hover.gif';}, false);
		li.addEventListener('mouseout', function(){dom.removeClass(li, 'hover'); img.src='http://l.yimg.com/g/images/gray_button_no_caret_default.gif';}, false);
		
		var lnk = li.getElementsByTagName('a')[0];
		lnk.addEventListener('click', function(e){
			get_tokens(function(){ 
				var srv = oauth_client.serviceProvider;
				
				var msg = {};
				msg.action = srv.updateStatusURL;
				msg.method = 'POST';

				var st = prompt('Status', set.title)
				st = st && st.trim();

				if(st) {
					st = st.substring(0, 140 - 1 - short_url.length) + ' ' + short_url;
					OAuth.setParameter(msg, 'status', st);
					send_request(msg, function(){ alert('Posted :D'); });
				}
			});
			var d = document.createElement('div');
			d.innerHTML = '';
			e.preventDefault();
		}, false);

		ul.appendChild(li);
	}

	function get_tokens(callback) {
		if(!unsafeWindow.OAuth) {
			return;
		}

		OAuth = unsafeWindow.OAuth;

		var msg = {};
		var srv = oauth_client.serviceProvider;

		oauth_client.token = GM_getValue('oauth.token', null);
		oauth_client.tokenSecret = GM_getValue('oauth.tokenSecret', null);

		if(oauth_client.token && oauth_client.tokenSecret) {
			if(typeof callback == 'function') {
				callback.call();
			}
			return;
		}

		oauth_client.token = GM_getValue('oauth.r_token', null);
		oauth_client.tokenSecret = GM_getValue('oauth.r_tokenSecret', null);

		msg.method = 'POST';

		function rt_received(xhr) {
			rt = OAuth.decodeForm(xhr.responseText);

			oauth_client.token = OAuth.getParameter(rt, 'oauth_token');
			oauth_client.tokenSecret = OAuth.getParameter(rt, 'oauth_token_secret');

			GM_setValue('oauth.r_token', oauth_client.token);
			GM_setValue('oauth.r_tokenSecret', oauth_client.tokenSecret);
			
			if(confirm('You need to allow this application to access Twitter first\n\n You will need to refresh this page afterwards')) {
				window.open(srv.userAuthorizationURL + '?oauth_token=' + oauth_client.token);
			}
		}

		function at_received(xhr) {
			at = OAuth.decodeForm(xhr.responseText);

			oauth_client.token = OAuth.getParameter(at, 'oauth_token');
			oauth_client.tokenSecret = OAuth.getParameter(at, 'oauth_token_secret');

			if(!oauth_client.token) {
				GM_log(xhr.responseText);
				return;
			}

			GM_setValue('oauth.token', oauth_client.token);
			GM_setValue('oauth.tokenSecret', oauth_client.tokenSecret);

			GM_setValue('oauth.r_token', false);
			GM_setValue('oauth.r_tokenSecret', false);

			if(typeof callback == 'function') {
				callback.call();
			}
		}

		if(oauth_client.token && oauth_client.tokenSecret) {
			msg.action = srv.accessTokenURL;
			var pin = prompt('Please enter the PIN you got from Twitter');
			pin = pin && pin.trim();
			if(!pin) {
				return;
			}
			OAuth.setParameter(msg, 'oauth_verifier', pin);
			send_request(msg, at_received);
		} else {
			msg.action = srv.requestTokenURL;
			send_request(msg, rt_received);
		}


	}

	function send_request(m, callback) {
		var data = m.parameters && OAuth.formEncode(m.parameters);
		OAuth.setTimestampAndNonce(m);
		OAuth.completeRequest(m, oauth_client);

		var tok = GM_xmlhttpRequest({
			'url': m.action, 
			'method': m.method,
			'headers': {
				'Authorization': OAuth.getAuthorizationHeader('', m.parameters),
				'Content-type': 'application/x-www-form-urlencoded'
			},
			'data': data || '',
			'onload': callback
		});
	}
	
	get_short_url(null, setup_ui);
	load_script(sha1_js);
	load_script(oauth_js);
})()
