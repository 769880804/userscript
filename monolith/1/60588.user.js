// ==UserScript==
// @name	GARDIJSKA 2. Gardijska Brigada
// @version	0.5d
// @include	http://*.erepublik.com/*
// @exclude	http://wiki.erepublik.com/*
// @exclude	http://blog.erepublik.com/*
// ==/UserScript==
var SCRIPT_VERSION='0.5d',DIVISION_URL='Gardijska-Brigade/2._Gardijska_Brigada',DIVISION_NAME='GARDIJSKA 2. Gardijska Brigada',DIVISION_LOGO='/images/parts/icon_military_93.gif',PASSKEY='4ae5afaf82ce3a962064520eb9b37f26',_d=document,URL=_d.URL,EREP_URL=URL.split('.')[0]+'.erepublik.com/'+URL.replace('http://','').split('/')[1].split('#')[0],EREP_DAY=_$('strong',$('clock'),0).innerHTML,gm_KEY=CB_getValue('AUTH_KEY_fc2dd700ca3d98a176328e033a7787d7',''),LANG=Array('orders','You are not authorized to see GARDIJSKA 2. Gardijska Brigada day #','Click here to authenticate','New version available for','Install version'),LAST_UPDATE_CHECK=CB_getValue('UPDATE_CHECK_fc2dd700ca3d98a176328e033a7787d7',0),is_opera = undefined != window.opera;

if(URL.indexOf(EREP_URL) > -1 && !$('citizen_password')){if(true==CB_getValue('AUTHENTICATE_fc2dd700ca3d98a176328e033a7787d7')){request_auth()}else if(undefined != $('homepage')){if(gm_KEY.indexOf(EREP_DAY)>-1){authorized()}else{not_authorized()}}if(URL.indexOf('/do_work')>-1){log_work()}}

function authorized(){update_check();CB_xmlhttpRequest('http://bularca.ro/erep_tools/army/index.php/'+DIVISION_URL+'/orders/?passkey='+PASSKEY+'&'+gm_KEY.split('#')[1]+'='+_$('a',$('menu2'),1).href.split('/')[6],true);}
function not_authorized(){show_orders(LANG[1]+EREP_DAY+' '+LANG[0]+'. <a href="javascript:void(0);" id="auth_link_fc2dd700ca3d98a176328e033a7787d7">'+LANG[2]+'</a>.');$('auth_link_fc2dd700ca3d98a176328e033a7787d7').addEventListener('click',function(){CB_setValue('AUTHENTICATE_fc2dd700ca3d98a176328e033a7787d7',true);request_auth()},false)}
function request_auth(auth_key,auth_val,url_key,url_val){url='http://bularca.ro/erep_tools/army/index.php/'+DIVISION_URL+'/orders/?request_auth&passkey='+PASSKEY;if(auth_key&&auth_val&&url_key&&url_val){url+='&'+auth_key+'='+auth_val+'&'+url_key+'='+url_val}CB_xmlhttpRequest(url,true);}
function request_auth_step_2(auth_key,auth_val,url_key,url_val){window.setTimeout(function(){request_auth(auth_key,auth_val,url_key,url_val)},0)}
function authenticate(auth_key,auth_val){window.setTimeout(function(){CB_setValue('AUTH_KEY_fc2dd700ca3d98a176328e033a7787d7',EREP_DAY+'#'+auth_key);CB_setValue('AUTHENTICATE_fc2dd700ca3d98a176328e033a7787d7',false);goto('')},0)}
function abort_auth(){deauthenticate();goto('')}
function deauthenticate(){window.setTimeout(function(){CB_setValue('AUTH_KEY_fc2dd700ca3d98a176328e033a7787d7','');CB_setValue('AUTHENTICATE_fc2dd700ca3d98a176328e033a7787d7',false)},0)}
function do_auth(){window.setTimeout(function(){CB_setValue('AUTHENTICATE_fc2dd700ca3d98a176328e033a7787d7',true)},0)}
function show_orders(orders,show_heading){wrap=_d.createElement('div'),latest=$('latestnews');if(!show_heading){heading=''}else{heading='<div class="title" style="float:left;"><h1 class="sIFR-replaced"><embed class="sIFR-flash" height="28" width="250" src="/flash/delicious.swf" quality="best" flashvars="txt='+DIVISION_NAME+':&textcolor=#737373&hovercolor=null&linkcolor=null&w=250&h=28" wmode="transparent" bgcolor="transparent" sifr="true" type="application/x-shockwave-flash" style="width: 250px; height: 28px;"/></h1></div>'}content='<div class="latest_events" style="float:left;"><div class="item elem"><div class="iconholder"><img class="test" src="'+DIVISION_LOGO+'" alt="'+DIVISION_NAME+'"/></div><div class="holder"><p>'+orders+'</p></div></div>';wrap.innerHTML=heading+content;latest.insertBefore(wrap,latest.firstChild)}
function log_work(){company_id=$('company_id');if(!company_id){return}CB_xmlhttpRequest('http://bularca.ro/erep_tools/army/index.php/'+DIVISION_URL+'/work/?passkey='+PASSKEY+'&company_id='+company_id.value+'&citizen_id='+_$('a',$('menu2'),1).href.split('/')[6]+'&citizen_name='+_$('img',$('miniprofile'),0).alt+'&productivity='+_$('span',$('trivia'),0).innerHTML+'&wellness='+$('wellnessvalue').innerHTML,false);}
function goto(url){if(url.indexOf('http')<0){url=EREP_URL+url}top.location=url}
function $(_id){return _d.getElementById(_id)}
function _$(_tag,_parent,_index){if(!_parent){_parent=_d}result=_parent.getElementsByTagName(_tag);if(undefined!=_index){return result[_index]}return result}
function trigger_update_check(){window.setTimeout(function(){update_check(true)},0)}
function update_check(forced){currentTime=Math.round(new Date().getTime()/1000);if(!forced && currentTime<(LAST_UPDATE_CHECK+3600*24)){return}CB_setValue('UPDATE_CHECK_fc2dd700ca3d98a176328e033a7787d7',currentTime);CB_xmlhttpRequest('http://bularca.ro/erep_tools/army/index.php/'+DIVISION_URL+'/orders/?update_check='+SCRIPT_VERSION+'&passkey='+PASSKEY+'&army_division=GARDIJSKA/2._Gardijska_Brigada&lang='+LANG[3]+' "GARDIJSKA-2._Gardijska_Brigada orders" script. '+LANG[4],true);}
function CB_getValue(name,default_value){if('function'==typeof GM_getValue){return GM_getValue(name,default_value)}var cookieJar=document.cookie.split("; ");for(var x=0;x<cookieJar.length;x++){var oneCookie=cookieJar[x].split("=");if(oneCookie[0]==escape(name)){try{eval("var value='"+unescape(oneCookie[1])+"'");}catch(e){return default_value}if('true' == value){return true}if('false' == value){return false}return value}}return default_value}
function CB_setValue(name,value){if('function'==typeof GM_setValue){return GM_setValue(name,value)}document.cookie=escape(name)+"="+escape(value)+";expires="+(new Date(new Date().getTime()+1000*31536000).toGMTString())+";path=/";}
function CB_xmlhttpRequest(request_uri,request_onload_callback){if(request_onload_callback){request_onload_callback=function(response){eval(response.responseText)}}else{request_onload_callback=function(){}}if('function' ==typeof GM_xmlhttpRequest){GM_xmlhttpRequest({method:'GET',url:request_uri,onload:request_onload_callback});return}if(is_opera){var script=_d.createElement('script');script.src=request_uri.replace('orders/','orders/orders.js');$('footer').appendChild(script);return}var xmlhttp=new XMLHttpRequest();xmlhttp.open('GET',request_uri);xmlhttp.onload=request_onload_callback;xmlhttp.send();}