scr_meta=<><![CDATA[ 
// ==UserScript==
// @name 	Travian AutoTask GotGs FX
// @namespace   Travian
// @author 	congxz6688, deFox, Tuga, v_kir, ptitfred06, Rhayader, GotGs
// @version 	4.0.55
// @description Updated Version of Travian Auto Task with some of my fixes and enhancements. Functions: AutoResourceUpgrade, AutoTransport, AutoNewBuild, AutoDemolish, AutoAttack, AutoTrain, CustomTransport, AutoParty.
// @license 	GNU General Public License
// @include 	http://*.travian.*/*
// @include 	http://travian.*/*
// @exclude 	http://*.travian*.*/hilfe.php*
// @exclude 	http://*.travian*.*/index.php*
// @exclude 	http://*.travian*.*/anleitung.php*
// @exclude 	http://*.travian*.*/impressum.php*
// @exclude 	http://*.travian*.*/anmelden.php*
// @exclude 	http://*.travian*.*/gutscheine.php*
// @exclude 	http://*.travian*.*/spielregeln.php*
// @exclude 	http://*.travian*.*/links.php*
// @exclude 	http://*.travian*.*/geschichte.php*
// @exclude 	http://*.travian*.*/tutorial.php*
// @exclude 	http://*.travian*.*/manual.php*
// @exclude 	http://*.travian*.*/ajax.php*
// @exclude 	http://*.travian*.*/ad/*
// @exclude 	http://*.travian*.*/chat/*
// @exclude 	http://*.travian*.*/activate.php*
// @exclude 	http://*.travian*.*/support.php*
// @exclude 	http://*forum.travian*.*
// @exclude 	http://*board.travian*.*
// @exclude 	http://*shop.travian*.*
// @exclude	http://*answers.travian*.*
// @exclude  	http://*help.travian*.*/*
// @exclude 	http://*.getter-tools.*
// @exclude	http://www.gettertools.com/*
// @exclude	http://www.travian.ws/*
// @exclude	http://travian-utils.com/*
// @exclude	http://travianbox.com/*
// @exclude 	*.css*
// @exclude 	*.js*
// ==/UserScript==
]]></>.toString();

/*
 * TODO::
 *
 *
*) Anti-farm not working (detection of incoming attack is not working, ow code for evading attack is okay, hence changes are only needed for detecting attack)
	--> detect changes in incoming attacks from dorf1.php
	--> only when new attacks are found, open up rally point to find out new attack's landing times.
	--> restrict minimum time interval for attack detect to 15 mins. setting this to very low value has adverse affects on the script's performance and does not provide any diplomatic advantage.
	--> reinforcements which are currently in the village which is being attacked, should be sent back home.
	--> freshenIncomingAttackAndTroops()

*) Troop Detection
	--> Restrict minimum time interval for troops check to 30 mins. Setting this to a lower value has no significance as script intelligently calculates when to check for troops again.
	--> _troopsCheckElapseTime

*) Custom Time Zone Problem
	--> Disable the option for setting custom time zone from greasemonkey menu.
	--> The solution to this is to detect player's server time zone setting from profile page.
		--> also detect date format.
	--> modify code such that when ever you read a date/time from server pages, it is assumed to be in the server's time zone.
	--> modify code (or overload date function) so that when ever it creates a new date, it does so in server's time zone.
	--> getDateAndTimeFromText(), _serverTimeZoneCorrection

*) Speed Server Problem
	--> Allow users to setup there server type ( 1x, 2x, 3x, 5x, 10x ).
		--> getTroopSpeedFactor(), getMerchantSpeedFactor()

*) Troop custom speed Problem (Tournament Square Problem)
	--> Allow users to set custom troop speed for each village ( or check for tournament square ).
		--> getTroopSpeedFactor(), getMerchantSpeedFactor()

*) Building Fully Upgraded Problem
	--> Handle the error when a building is fully upgraded, add a new error for this so that users can customize it when encountered via manual language translation.
	--> aLangErrorText[], aLangErrorTextComDef[]

*) New Build pre-requisite problem
	--> when all pre-requisites for a new building is not met
		--> check how we can improve this by not deleting the problem task
		--> check how difficult it is to find out what other buildings are required and add them at the top of the tasklist.
	--> startBuildnow(), HttpRequire()

*) Task-List sorted problem
	--> check whether the task-list is sorted on each display?
	--> if so, find other way to keep the task-list sorted.
	--> createTaskListTable()

*) Auto Resource Problem
	--> check if there is some easy way to not delete auto resource task when all non-crop resources are maxed, but crops upgrade is disabled with a few crop fields not maxed.
	--> startBuildnow(), HttpRequire(), startBuildOrSetTime()

*) Hero Adventure Enhancement
	--> (Auto Rotate Hero for more adventures) 
		--> Auto move hero to other villages when adventures in current village are all exhausted.
		--> When moved to a new village, wait for more than normal threshold for new adventures to appear.
	--> Reduce the hero adventure check interval as it does not add much overhead.
	--> checkSendHeroForAdventure()

*) Travian Helper
	--> Auto check for helper status at the begining of the game to auto receive rewards and completion of quests.
	--> Auto schedule / execute quests.
	--> eachTimedo()()

*) Market Auto Trading Problem
	--> Allow users to reserve some merchants for personal use, ie do not use the reserved merchants for auto/custom transport.
	--> ie execute auto/custom transport if number of merchants in current village is more than what is reserved.
	--> startTrainNow(), startCustomTranNow()

*) Auto Add Farms, Report Analysis, Auto Farming & Auto Scouting
	--> [Auto Add Farms]
		--> download map.sql.gz file from the server, and analyze it to facilitate auto-addition of farms.
		--> this file is generated on a daily basis, and contains the most recent snapshot of the server.
		--> the format of this file is mentioned at the bottom of autotask script.
	--> [Auto Farm] -- Create a new option for auto-farming in attack scheduler form
		--> when enabled, it should disable all other options in the attack scheduler form.
		--> when enabled, script should automatically decide the following
			--> frequency of attacks
			--> number of troops to send for attack
			--> auto scout (randomly from same or other village) farm for strategic info.
		--> task list entry name should be 'auto attack/raid' instead of only attack/raid.
		--> auto attack/raid entries should be shown with a separte background color than the normal attack/raid for easy identification.
	--> [Report Analysis] 
		--> Auto Disable attacks on farms which has casualties
			--> this should be available as a separate option in attack scheduler for both auto-farming and manually scheduled attacks.
			--> disabled attacks should be shown with a separate background color in task list.
		--> Auto Train troops to replenish loss, this should be available as a separate option for individual villages.
	--> [Auto Scout]
		--> For Auto Farm Tasks, auto adjust attack frequency & troop count based on farms's activity
			--> auto scout to find farm's resource production
				--> scout again if activity on farm ( population change, im's from farm )
			--> based on farms resource production, send optimal number of troops at calculated intervals to gather all resources before farm overflows.
				--> auto adjust troop count and frequency based on earnings from farm.
					--> if earning is less, increase frequency and decrease troop count.
						--> this prevents others from farming your farms.
					--> if earning is equivalent to what is computed resource production of farm, decrease frequency and increase troop count.
						--> this keeps your troops safe if someone accidently reinforces the farm.
						--> this also reduces the load on the script, and other tasks get execution slots.
		--> Maintain a small history of population of farms
			--> when farm's population increases, decrease frequency and increase troop count.
				--> this keeps your troops safe, and hinders the growth of your farm.
			--> when farm's population is not chaning for sometime
				--> scout multiple times to calcuate farm's resource production
				--> adjust frequency to prevent others from stealing resources from your farm
				--> decrease troop count if necessary after some threshold.
		--> Scouting farms randomly to find who's generating defence troops.
			--> once spotted based on players choice
				--> either disable farming there
				--> or increase both troops count and frequency
		--> eachTimedo()
 * 
 *
 *
 */

function functionMain() {
	//GM_log ( "functionMain():: Started! document.readyState: " + document.readyState );
	/*if ( document.readyState != "complete" ) { // TODO: this is never going to work, as firefox never gets the complete event!!!
		return;
	}*/

var crtVersion="Ver GotGs FX 4.0.55";

/**
 * Date:
 *   30 Jun 2009 - 10 July 2011
 * Authors:
 *   Original version by congxz6688.
 *   Some modifications and fixups by deFox, ptitfred06.
 *   Translations integration by Tuga.
 *   Major changes by GotGs
 *   Auto/Custom Transport improved by Henri
 *   Editing scheduled attack tasks by Drumst1x
 * Copying and copyrights: 
 *     This program is free software; you can redistribute it and/or modify
 *     it under the terms of the GNU General Public License as published by
 *     the Free Software Foundation; either version 2 of the License, or
 *     (at your option) any later version.
 * Changelog:
 *
 *  25/10/2011 Ver 4.0.55 GotGs
 *		-- fix for getallVillagePos() by Bigfoot
 *  22/10/2011 Ver 4.0.54 GotGs
 *  		-- added a list of todos
 *  		-- this probably will be my last update to this script unless i come back to travian
 *  19/10/2011 Ver 4.0.53 GotGs
 *  		-- added edit link for custom transports (author blablubbb)
 *  		-- users can now choose from a few in-built alarm sounds.
 *  19/10/2011 Ver 4.0.52 GotGs
 *  		-- incorporated changes by blablubbb
 *  			-- Highlight existing Attacks in Attack-List, when in Detail view of a village
 *  			-- Edit-Button for auto transports
 *  17/10/2011 Ver 4.0.51 GotGs
 *  		-- reverting back to 4.0.49, will need to check thoroughly what can be removed
 *  17/10/2011 Ver 4.0.50 GotGs
 *  		-- removed some junk code not required here
 *  17/10/2011 Ver 4.0.49 GotGs
 *  		-- message lists
 * 	 		-- corrected toggling of message lists on non-login windows
 * 	 		-- now by default messages are not show on non-login windows
 *  		-- incorporated Drumst1x fix for new rally point layout
 *  17/10/2011 Ver 4.0.48 GotGs
 *  		-- incorporated changes suggested by blablubbb
 *  			-- display link to manual translations in error messages
 *  			-- change default alarm sound
 *  			-- a few translations for .de
 *  		-- message and error history
 *	  		-- added message history size check
 *  			-- corrected un-necessary processing of history
 *  10/07/2011 Ver 4.0.47 GotGs
 *  		-- translations for .in
 *  		-- INIT() now refreshes the current page in a few random secs on error
 *  		-- added caution for time-zone correction option
 *  22/06/2011 Ver 4.0.46 GotGs
 *  		-- translations for .cc, .cn, .hk, .tw
 *  21/06/2011 Ver 4.0.45 GotGs
 *  		-- cosmetic changes
 *  21/06/2011 Ver 4.0.44 GotGs
 *  		-- translations for .de
 *  21/06/2011 Ver 4.0.43 GotGs
 *  		-- cosmetic changes
 *  17/06/2011 Ver 4.0.42 GotGs
 *  		-- cosmetic changes
 *  17/06/2011 Ver 4.0.41 GotGs
 *  		-- analyzeRallyPoint() fix for ts3.hk
 *  17/06/2011 Ver 4.0.40 GotGs
 *  		-- can now edit scheduled attack tasks
 *  16/06/2011 Ver 4.0.39 GotGs
 *  		-- analyzeRallyPoint() fix for ts3.hk
 *  10/06/2011 Ver 4.0.38 GotGs
 *  		-- fixed some log links for T4.
 *  01/06/2011 Ver 4.0.37 GotGs
 *  		-- correction to Indonesian translations.
 *  01/06/2011 Ver 4.0.36 GotGs
 *  		-- added Indonesian translations.
 *  30/05/2011 Ver 4.0.35 GotGs
 *  		-- cosmetic changes
 *  30/05/2011 Ver 4.0.34 GotGs
 *  		-- minor fixes
 *  27/05/2011 Ver 4.0.33 GotGs
 *  		-- hero adventure bug fix
 *  26/05/2011 Ver 4.0.32 GotGs
 *  		-- hero adventure bug fix
 *  24/05/2011 Ver 4.0.31 GotGs
 *  		-- cosmetic changes
 *  		-- added farm finder memory
 *  		-- added oasis troop search
 *  		-- new-build building pre-requisite problem resolved for now, problematic new-build task is now deleted
 *  20/05/2011 Ver 4.0.30 GotGs
 *  		-- task[4] is not defined for auto-resource task!
 *  		-- now checking for building / resource max level before attempting upgrade
 *  		-- corrected troop time calculation for speed servers
 *  16/05/2011 Ver 4.0.29 GotGs
 *  		-- randomizing village selection when executing tasks
 *  15/05/2011 Ver 4.0.28 GotGs
 *  		-- max server time diff allowed now can be set from greasemonkey menu
 *  		-- auto-resource improvemed to handle end case scenario when resource tiles are at max level
 *  		-- t4 error logs for rally point messages now have correct urls
 *  		-- warehouse/granary are now upgraded to prevent resource overflow when they are 90% full instead of 80% full
 *  		-- t4 crop finder fix for some servers
 *  		-- auto-updater now opens userscripts page when new version is available instead of installing the script directly which looks freaky
 *  		-- parties can now be scheduled even when the 1st level of the building is under construction.
 *  		-- armoury bug-fix for t4.
 *  30/04/2011 Ver 4.0.27 GotGs
 *  		-- disabled alarm on script-auto re-start
 *  30/04/2011 Ver 4.0.26 GotGs
 *  		-- build/upgrade next level computation fix for .hu broke other servers, fixed here.
 *  28/04/2011 Ver 4.0.25 GotGs
 *  		-- build/upgrade next level computation corrected for .hu
 *  28/04/2011 Ver 4.0.24 GotGs
 *  		-- auto-updater fix
 *  25/04/2011 Ver 4.0.23 GotGs
 *  		-- auto-resource bug-fix
 *  25/04/2011 Ver 4.0.22 GotGs
 *  		-- mail alarm fixed
 *  24/04/2011 Ver 4.0.21 GotGs
 *  		-- cosmetic changes
 *  		-- custom transport min-resource that can be sent can now be configured from greasemonkey menu
 *  23/04/2011 Ver 4.0.20 GotGs
 *  		-- removed minimum resource restriction of 500 for custom-transport
 *  23/04/2011 Ver 4.0.19 GotGs
 *  		-- custom-transport bug-fix
 *  22/04/2011 Ver 4.0.18 GotGs
 *  		-- in t3.6 analyzeRallyPoint() now differentiates between incoming reinforcements and attacks
 *  21/04/2011 Ver 4.0.17 GotGs
 *  		-- getVillageId() bug fix
 *  20/04/2011 Ver 4.0.16 GotGs
 *  		-- added dumping of debug text to printStackTrace() which can be used to dump dom
 *  		-- now throwing when TS_getRequest() or TS_postRequest() fails
 *  		-- now dumping dom when throwing from getVillageId(), getAllVillageNewdids(), TS_getRequest(), TS_postRequest()
 *  18/04/2011 Ver 4.0.15 GotGs
 *  		-- cosmetic changes
 *  18/04/2011 Ver 4.0.14 GotGs
 *  		-- crop finder for t3.6
 *  18/04/2011 Ver 4.0.13 GotGs
 *  		-- cosmetic changes
 *  		-- demolition improved
 *  17/04/2011 Ver 4.0.12 GotGs
 *  		-- travian.ir coordinates problem
 *  17/04/2011 Ver 4.0.11 GotGs
 *  		-- risky attack check corrected
 *  		-- auto-updater fixed
 *  15/04/2011 Ver 4.0.10 GotGs
 *  		-- analyzeRallyPoint() mid-night problem
 *  15/04/2011 Ver 4.0.9 GotGs
 *  		-- auto-check for new version fixed
 *  15/04/2011 Ver 4.0.8 GotGs
 *  		-- trying to fix mid-night problem
 *  14/04/2011 Ver 4.0.7 GotGs
 *  		-- minor correction in refreshMapData()
 *  14/04/2011 Ver 4.0.6 GotGs
 *  		-- troops improve bug-fix
 *  14/04/2011 Ver 4.0.5 GotGs
 *  		-- now when anti-farm is disabled, script should not complain about anti-farm coordinates
 *  		-- attempting to handle the case when hero is dead
 *  14/04/2011 Ver 4.0.4 GotGs
 *  		-- refreshMapData() improved
 *  		-- now for reinforcements troops availability check is done
 *  		-- attack form improved
 *  		-- crop upgrade for auto-resource can now be enabled / disabled for each village
 *  13/04/2011 Ver 4.0.3 GotGs
 *  		-- minor fixes here & there
 *  12/04/2011 Ver 4.0.2 GotGs
 *  		-- auto start duration reduced to approx 2 mins, user can always close and re-open login window when required to pause/un-pause the script.
 *  11/04/2011 Ver 4.0.1 GotGs
 *  		-- granary and warehouse resource cap bug fix
 *  11/04/2011 Ver 4.0.0 GotGs
 *  		-- auto resource upgrade bug fix
 *  		-- incorporated suggestion by Rhayader
 *  10/04/2011 Ver 3.0.99 GotGs
 *  		-- added crop error check to gatheStats()
 *  10/04/2011 Ver 3.0.98 GotGs
 *  		-- transport improvement
 *  10/04/2011 Ver 3.0.97 GotGs
 *  		-- cosmetic changes
 *  10/04/2011 Ver 3.0.96 GotGs
 *  		-- minor changes to rally point check
 *  10/04/2011 Ver 3.0.95 GotGs
 *  		-- minor configurations
 *  		-- t4 crop finder
 *  		-- auto updation
 *  09/04/2011 Ver 3.0.94 GotGs
 *  		-- cosmetic changes
 *  09/04/2011 Ver 3.0.93 GotGs
 *  		-- more language corrections / improvements
 *  09/04/2011 Ver 3.0.92 GotGs
 *  		-- lang it corrections as provided by baldo.
 *  08/04/2011 Ver 3.0.91 GotGs
 *  		-- can now enable/disable resource overflow check for individual villages.
 *  08/04/2011 Ver 3.0.90 GotGs
 *  		-- attempting to fix BuildingData not initialized problem.
 *  07/04/2011 Ver 3.0.89 GotGs
 *  		-- lang sk added for Slovak servers
 *  07/04/2011 Ver 3.0.88 GotGs
 *  		-- added anti-farm customizations
 *  07/04/2011 Ver 3.0.87 GotGs
 *  		-- improved auto/custom market transfer
 *  		-- auto troops improve fixed
 *  		-- gid id problem, now travian links are not displayed if there is a gid in url
 *  		-- auto party fixed
 *  		-- now gets resources for sale from market before incoming attack
 *  		-- on t4 getHeroSpeed() is now not called on hero mansion
 *  06/04/2011 Ver 3.0.86 GotGs
 *  		-- removing "\n" from building names and errors read from travian pages.
 *  05/04/2011 Ver 3.0.85 GotGs
 *  		-- cosmetic changes
 *  04/04/2011 Ver 3.0.84 GotGs
 *  		-- lang it corrections
 *  		-- disabled min troops count check for scouting
 *  04/04/2011 Ver 3.0.83 GotGs
 *  		-- improved getIncomingResources()
 *  03/04/2011 Ver 3.0.82 GotGs
 *  		-- cosmetic changes
 *  03/04/2011 Ver 3.0.81 GotGs
 *  		-- improvements to auto-custom transport
 *  03/04/2011 Ver 3.0.80 GotGs
 *  		-- attack bug fix (herere problem)
 *  01/04/2011 Ver 3.0.79 GotGs
 *  		-- analyze rally point bug fix
 *  		-- merchant auto & custom transfers bug-fix
 *  31/03/2011 Ver 3.0.78 GotGs
 *  		-- auto-login is a heachace
 *  30/03/2011 Ver 3.0.77 GotGs
 *  		-- getbuildurl bug-fix
 *  		-- added Server Time Zone Correction
 *  		-- new build tasks for which pre-requisites have not been met are not deleted now
 *  		-- changed default plus build enabled to false
 *  30/03/2011 Ver 3.0.76 GotGs
 *  		-- lang greece (gr) correction
 *  30/03/2011 Ver 3.0.75 GotGs
 *  		-- lang greece (gr) correction
 *  30/03/2011 Ver 3.0.74 GotGs
 *  		-- lang greece (gr) added
 *  30/03/2011 Ver 3.0.73 GotGs
 *  		-- minor bug-fixes
 *  29/03/2011 Ver 3.0.72 GotGs
 *  		-- auto-login and build completion time fix for t4
 *  29/03/2011 Ver 3.0.71 GotGs
 *  		-- bug fix for attack
 *  28/03/2011 Ver 3.0.70 GotGs
 *  		-- attempting to fix script hang
 *  		-- improved lang translation form
 *  28/03/2011 Ver 3.0.69 GotGs
 *  		-- auto-login fix for t4
 *  28/03/2011 Ver 3.0.68 GotGs
 *  		-- t4 anti-farm bug fix
 *  27/03/2011 Ver 3.0.67 GotGs
 *  		-- t4 language translations for lang it
 *  26/03/2011 Ver 3.0.66 GotGs
 *  		-- minor bug-fixes
 *  26/03/2011 Ver 3.0.65 GotGs
 *  		-- lang translations reporting bug-fix
 *  26/03/2011 Ver 3.0.64 GotGs
 *  		-- cosmetic changes
 *  26/03/2011 Ver 3.0.63 GotGs
 *  		-- lang translations reporting improved
 *  26/03/2011 Ver 3.0.62 GotGs
 *  		-- minor changes
 *  25/03/2011 Ver 3.0.61 GotGs
 *  		-- some language specific bug-fixes
 *  25/03/2011 Ver 3.0.60 GotGs
 *  		-- vlist problem for travian version 4
 *  		-- a number of other fixes for travian version 4
 *  24/03/2011 Ver 3.0.59 GotGs
 *  		-- some fixes to catch language translations for error messages
 *  23/03/2011 Ver 3.0.58 GotGs
 *  		-- login button fix
 *  23/03/2011 Ver 3.0.57 GotGs
 *  		-- minor bug fixes
 *  23/03/2011 Ver 3.0.56 GotGs
 *  		-- attempt to make script work on travian server 4.0, currently build, new build, train, attack & anti-farm work on t4.0
 *  		-- a number of bug-fixes for travian 3.6 related to non-roman attack
 *  19/03/2011 Ver 3.0.55 GotGs
 *  		-- attack bug-fix
 *  18/03/2011 Ver 3.0.54 GotGs
 *  		-- improved error checks
 *  18/03/2011 Ver 3.0.53 GotGs
 *  		-- bug fix in refreshBuildingState()
 *  		-- bug fix in getthebuildUrl() for new-build
 *  18/03/2011 Ver 3.0.52 GotGs
 *  		-- commented out all references to onActivitySkipTime
 *  		-- corrected current build completion timer bug in refreshBuildingState()
 *  18/03/2011 Ver 3.0.51 GotGs
 *  		-- bug-fixes in addCropTaskAtTop() & addBuildingTaskAtTop()
 *  		-- can not enable/disable plus double build from menu
 *  		-- improved lack of crop & small warehouse/granary error handling
 *  16/03/2011 Ver 3.0.50 GotGs
 *  		-- other races resource/building already at required level fix
 *  16/03/2011 Ver 3.0.49 GotGs
 *  		-- bug-fixes related to adding of crop task at top
 *  16/03/2011 Ver 3.0.48 GotGs
 *  		-- some bug-fixes related to name2gid
 *  12/03/2011 Ver 3.0.47 GotGs
 *  		-- minor changes
 *  12/03/2011 Ver 3.0.46 GotGs
 *  		-- improved auto-login
 *  12/03/2011 Ver 3.0.45 GotGs
 *  		-- improved analyzeRallyPoint
 *  12/03/2011 Ver 3.0.44 GotGs
 *  		-- improved auto-login
 *  11/03/2011 Ver 3.0.43 GotGs
 *  		-- corrected display of doing status
 *  		-- improved attack
 *  11/03/2011 Ver 3.0.42 GotGs
 *  		-- removed unnecessary task element copy statements when cloning task using slice
 *  11/03/2011 Ver 3.0.41 GotGs
 *  		-- eliminating double call to analyzeRallyPoint()
 *  11/03/2011 Ver 3.0.40 GotGs
 *  		-- i hate greasemonkey, bug-fix in getthebuildUrl
 *  11/03/2011 Ver 3.0.39 GotGs
 *  		-- bug fix in printFooterMsg for non-romans
 *  11/03/2011 Ver 3.0.38 GotGs
 *  		-- next build level computation improved
 *  11/03/2011 Ver 3.0.37 GotGs
 *  		-- bug-fix for non-json supporting browsers
 *  10/03/2011 Ver 3.0.36 GotGs
 *  		-- attacks improved
 *  10/03/2011 Ver 3.0.35 GotGs
 *  		-- pause/unpause improvement
 *  10/03/2011 Ver 3.0.34 GotGs
 *  		-- xpath changes
 *  08/03/2011 Ver 3.0.33 GotGs
 *  		-- corrected building level check in getthebuildUrl
 *  07/03/2011 Ver 3.0.32 GotGs
 *  		-- some bug fixes in getBuildCompletionTimesFromDorf1Or2() and rally point analysis
 *  07/03/2011 Ver 3.0.31 GotGs
 *  		-- added cluster maps
 *  07/03/2011 Ver 3.0.30 GotGs
 *  		-- minor corrections & bug fixes
 *  07/03/2011 Ver 3.0.29 GotGs
 *  		-- attempt to correct mid-night problem in analyzeRallyPoint
 *  07/03/2011 Ver 3.0.28 GotGs
 *  		-- cosmetic changes
 *  06/03/2011 Ver 3.0.27 GotGs
 *  		-- added a couple of try/catch statements
 *  05/03/2011 Ver 3.0.26 GotGs
 *  		-- minor graphical changes
 *  05/03/2011 Ver 3.0.25 GotGs
 *  		-- improved scheduling of upgrade/new build tasks
 *  		-- added aLangAllBuildAltWithId
 *  		-- added Henri's build/upgrade scheduling logic as a separate function which can be enabled / disabled from menu
 *  05/03/2011 Ver 3.0.24 GotGs
 *  		-- improved scheduling of upgrade/new build tasks
 *  04/03/2011 Ver 3.0.23 GotGs
 *  		-- improved anti-farm
 *  		-- corrected httprequire
 *  		-- improved attack scheduling
 *  04/03/2011 Ver 3.0.22 GotGs
 *  		-- incorporated henri's changes
 *  03/03/2011 Ver 3.0.21 GotGs
 *  		-- improved anti-farm
 *  03/03/2011 Ver 3.0.20 GotGs
 *  		-- improved anti-farm
 *  02/03/2011 Ver 3.0.19 GotGs
 *  		-- tasks are now deleted from task list only if they exists.
 *  		-- now attack alarm plays only if resources are above cranny limit.
 *  		-- can now build multiple crannies
 *  		-- rectified new build bug in httprequire
 *  02/03/2011 Ver 3.0.18 GotGs
 *  		-- improved anti-farm
 *  02/03/2011 Ver 3.0.17 GotGs
 *  		-- train troop bug fixed
 *  		-- httprequire bug fixed
 *  02/03/2011 Ver 3.0.16 GotGs
 *  		-- anti-farm now active by default
 *  		-- a couple of changes to post data for training & attack
 *  01/03/2011 Ver 3.0.15 GotGs
 *  		-- a number of changes to build/upgrade schedule mechanism.
 *  25/02/2011 Ver 3.0.14 GotGs
 *  		-- incorporated Henri's auto-res, auto-transfer & custom-transfer changes.
 *  25/02/2011 Ver 3.0.13 GotGs
 *  		-- enabled conversion of anchors, disabled by default, now can be enabled/disabled from greasemonkey menu.
 *  25/02/2011 Ver 3.0.12 GotGs
 *  		-- cosmetic changes to random parameters
 *  		-- httprequire now checks for build errors
 *  		-- added newdid to a couple of http requests
 *  25/02/2011 Ver 3.0.11 GotGs
 *  		-- now users can do language translations at there end
 *  		-- corrected hero handling in analyzeRallyPoint function
 *  24/02/2011 Ver 3.0.10 GotGs
 *  		-- now aLangAllResInDorf1 is initialized automatically
 *  24/02/2011 Ver 3.0.9 GotGs
 *  		-- now building all source & all build string automatically
 *  23/02/2011 Ver 3.0.8 GotGs
 *  		-- minor bug fixes which usually stop the script.
 *  		-- trying to make script work with lang ae.
 *  23/02/2011 Ver 3.0.7 GotGs
 *  		-- bug fixes in analyze rally point to count hero.
 *  23/02/2011 Ver 3.0.6 GotGs
 *  		-- improved next rally point load time calculation.
 *  22/02/2011 Ver 3.0.5 GotGs
 *  		-- minor changes to training mechanism
 *  		-- bug fix for next rally point load mechanism
 *  21/02/2011 Ver 3.0.4 GotGs
 *  		-- added support for plus account double build (add build to loop). visiting plus.php?id=3 automatically checks & sets double build.
 *  		-- can now configure delay time for next build attempt in case of insufficient resources from greasemonkey menu.
 *  21/02/2011 Ver 3.0.3 GotGs
 *  		-- script now tries to load rally point less aggressively when we do not have the rally point, and shows a message to user to build rally point.
 *  20/02/2011 Ver 3.0.2 GotGs
 *  		-- auto-login improved
 *  20/02/2011 Ver 3.0.1 GotGs
 *  		-- auto-login fixed
 *  18/02/2011 Ver 3.0.0 GotGs
 *  		-- now plays sound on captcha and can also set custom alarm
 *  		-- now attack start time displayed in task-list is not incremented when delaying on not enough troops
 *  		-- added strict order modes 0, 1 & 2 for scheduling attacks
 *  13/02/2011 Ver 2.0.2e015 GotGs
 *  		-- map improvements multiple scheduled attacks count rectified
 *  13/02/2011 Ver 2.0.2e014 GotGs
 *  		-- attempting to make map improvements compatible with beyond.
 *  		-- user can now enable/disable map improvements.
 *  13/02/2011 Ver 2.0.2e013 GotGs
 *  		-- some improvements to maps
 *  12/02/2011 Ver 2.0.2e011 GotGs
 *  		-- can now set interval for troops refresh
 *  		-- elementary anti-farm
 *  11/02/2011 Ver 2.0.2e010 GotGs
 *  		-- can now reset troops count by visiting a2b.php when having multiple villages.
 *  10/02/2011 Ver 2.0.2e009 GotGs
 *  		-- village list fix, now should work for players with multiple villages
 *  10/02/2011 Ver 2.0.2e008 GotGs
 *  		-- can now schedule attacks to villages with beginners protection 
 *  		-- login window now loads a different page randomly on refresh instead of only the profile page
 *  08/02/2011 Ver 2.0.2e007 GotGs
 *  		-- should now work with Travian3 Beyond - ML&CN Chrome (http://userscripts.org/scripts/show/92494) if Auto-Task is listed 
 *  			before Beyond in greasemoneky script list order.
 *  07/02/2011 Ver 2.0.2e006 GotGs
 *  		-- can now define custom sleep intervals via greasemonkey menu.
 *  06/02/2011 Ver 2.0.2e005 GotGs
 *  		-- can now toggle logs display.
 *  05/02/2011 Ver 2.0.2e004 GotGs
 *  		-- better error handling and display of logs.
 *  		-- now refreshing login window on any upgrade or new build to refresh stats.
 *  		-- reduced random interval for upgrades/new builds from 5 mins to 2 mins when workers at work.
 *  04/02/2011 Ver 2.0.2e003 GotGs 
 *  		-- auto task now iterates only on login window, login window is automatically set to profile page while running.
 *  		-- auto login improved, and now it can be disabled from greasemonkey menu
 *  		-- auto task now gathers all necessary stats before starting iteration
 *  		-- this version might still not work with Travian3 Beyond - ML&CN Chrome (http://userscripts.org/scripts/show/92494)
 *  03/02/2011 Ver 2.0.2e002 GotGs -- auto task now works with Travian3 Beyond - ML&CN Chrome (http://userscripts.org/scripts/show/92494)
 *  02/02/2011 Ver 2.0.2e001 GotGs -- bug fix, added missing "/" between host & params in profile url
 *  02/02/2011 Ver 2.0.2e GotGs -- now auto-task iterates only on the profile page.
 *  02/02/2011 Ver 2.0.2d GotGs -- now getting available troops count from a2b.php instead of dorf1.php
 *  29/01/2011 Ver 2.0.2c001 GotGs -- Solved an issue with page reload.
 *  27/01/2011 Ver 2.0.2c GotGs -- Eliminating unnecessary http request while figuring out available troops for attacks/raids. Randomized task run interval.
 *  24/01/2011 Ver 2.0.2b Some fixes for Auto Resource by GotGs
 *  22/01/2011 Ver 2.0.2a Some fixes for Auto Resource by GotGs
 *  22/01/2011 Ver 2.0.2 Some fixes and enhancements by GotGs
 *  02/06/2010 Ver 2.0.1 Forking from CPD by Rhayader, fixed autotrain issue
 *  02/06/2010 Ver 2.0.0d Case "us" language change by shadowx360
 *  23/05/2010 Ver 1.2.0 AUtotransport work again . Thanks to Rhayader / change value line 3164 concerning ID villages.
 *  05/05/2010 Ver 1.1.4d Add ligne from shadowx360 concerning village master.
 *  28/04/2010 Ver 1.1.4a Update for FR "Bûcherons change by Bûcheron"
 *  25/04/2010   Ver 1.1.4 Update for Fr "update Écurie no display".
 *  16/04/2010  Ver 1.1.3 Update LV languague
 *  02/04/2010  Ver 1.1.2 Add US language by shadowx360
 *  31 Mar 2010 Ver 1.1.1 ID village on 2 digit  by Rhayader
 *  30 Mar 2010 Ver 1.1.0
 *     - replace text for START / STOP task list. in AlllangTaskOfText The : (".",".","START","STOP")
 *     - modify the format time in attack task. (Replace -> "Fois", " Mois", " Jour" by "Fois", "/", " ")
 *     - correct the full time in windows attack define.
 *
 *  27 Mar 2010 , update "Ttr" language by SARLAK
 *
 *  25 Mar 2010, ptitfred06
 *     - auto party no work need check.
 *     - unlock the NEW BUILD option.
 *     - add comment in script for all poeple can personnalize. (what can be change / what can't be change)
 *     - Change text in TASK list to have display more easy.
 *     - changement des texts dans la zone de taches. 
 *
 * 25 Mar 2010 ------------------------------------------------------- Update and change is managed by ptitfred06
 *
 *  01 Feb 2010, v_kir:
 *     - Fixed some names in "rs" (by rsinisa)
 *     - Fixed error in Russian
 *   30 Jan 2010, v_kir:
 *     - Fixed some names in Russian (by MMX)
 *   24-28 Jan 2010, v_kir:
 *     - Adapted for FireFox 3.6
 *   01 Oct 2009, deFox:
 *     - Fixed some names in all languages
 *     - Replaced auto-login code with more complex one
 *     - Prepared to unify XPath requests
 *   30 Sep 2009, Tuga:
 *     - Added "mx,cl,net" servers support
 *   30 Sep 2009, deFox:
 *     - Added "rs" servers support
 *     - Fixed bug in "send troops" attack type
 *   27 Sep 2009, deFox:
 *     - Added LohoC's german language support
 *     - Modified Xlang variable names to be more unique
 *     - Some cosmetic changes in code
 *   25 Sep 2009, deFox:
 *     - Fixed troops sending code due to Travian T3.5 update
 *   OLD Script : Earlier changes log: http://userscripts.org/scripts/show/67160
 */

// Basic constants
const XPFirst = XPathResult.FIRST_ORDERED_NODE_TYPE; // 9

const XPList = XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE; // 6
const XPOrdList = XPathResult.ORDERED_NODE_SNAPSHOT_TYPE; // 7

const XPSnap = XPList; // 6
const XPOrdSnap = XPOrdList; // 7

const XPIterate = XPathResult.UNORDERED_NODE_ITERATOR_TYPE; // 4
const XPOrdItert = XPathResult.ORDERED_NODE_ITERATOR_TYPE; // 5

const XPNumber = XPathResult.NUMBER_TYPE; // 1
const XPBool = XPathResult.BOOLEAN_TYPE; // 3
const XPString = XPathResult.STRING_TYPE; // 2

const XPAny = XPathResult.ANY_TYPE; // 0
const XPAnyUnordered = XPathResult.ANY_UNORDERED_NODE_TYPE; // 8

// Configuration

// Determines if the script should automatically 'press' login button if logged out
var autoLogin = GM_getValue(currentServer() + "_scriptAutoLogin", "1") == "1" ? true : false;

// Logging - for debugging purposes.
var logDebugMessages = true;

// Selecting language
Xlang="com";

// Preparing visual style for script's GUI
var cssStyle = "";
cssStyle += "#tasklisttable_wrapper table { border:0px #000000 !important; background-color:HoneyDew !important; }";
cssStyle += "table#tasklisttable th { border:0px !important; font-weight:bolder; margin:10px; padding-top:8px; }";
cssStyle += "table#tasklisttable tr td { border:0px #000000 !important; margin:20px; background-color:HoneyDew !important; padding: 1px; }";
cssStyle += "table#tasklisttable hr { border-style: none none solid; margin-top: 1px !important; margin-bottom: 1px !important; }";
cssStyle += "table#mytablee { border:0px #000000 !important; background-color:Lavender !important; }";
cssStyle += "table#mytablee tr td { border:0px #000000 !important; margin:20px; background-color:Lavender !important; }";
cssStyle += "table#mytablee hr { border-style: none none solid; margin-top: 1px !important; margin-bottom: 1px !important; }";
cssStyle += ".floatClose { float:right; padding:2px 4px; color:white; margin:-5px -15px 0 0; }";
cssStyle += ".floatToggle { float:left; padding:2px 0px; color:white; margin:-5px 0px 0 0; }";
cssStyle += "#closeautran { position:relative; top:1px; left:150px; }"
cssStyle += "#autoResdiv, #translimit, #resremain, #ovrflwchk, #cropUpgrdEnabled { padding:0px 3px; }";
cssStyle += "#createnewurl { margin:0px 0px 0px 0px; position:relative; top:6px; border-style:ridge; border-width:2px; color:green; }";
cssStyle += "#createUrl, #partylnk, #createImprove, #cropFinderLink { margin:0px 0px 0px 0px; position:relative; top:-5px; border-style:ridge; border-width:2px; color:green; }";
cssStyle += "#autotransbtn, #attackbtn, #trainlnk, #customtransbtn { margin:0px 0px 0px 20px; position:relative; top:-4px; border-style:ridge; border-width:2px; color:green; }";
cssStyle += "#attackBeginnerProtectionLnk { margin:20px 0px 0px 5px; position:relative; top:4px; border-style:ridge; border-width:2px; color:green; }";
cssStyle += "#autotransbtn:active, #attackbtn:active, #demolishlnk:active, #createUrl:active, #createImprove:active, #createnewurl:active, #trainlnk:active, #customtransbtn:active, #partylnk:active, #attackBeginnerProtectionLnk:active, #cropFinderLink { border-style:groove; border-width:3px; }";
cssStyle += "#crop_finder_form, #updataform, #printmsg, #transform, #translimitform, #demolistform, #attackform, #trainform, #customtransform, #resremainform, #partyform, #langTranslateForm { padding:10px 30px; }";
cssStyle += "#testAlarmForm, #showInfoBubbleForm, #alarmForm, #showLoginBubbleForm { padding:2px 2px; z-index: 10000}";
cssStyle += "#printerrormsg { padding:10px 30px; background-color:LightCoral; }";
cssStyle += "#ovrflwchk { padding:0px 3px 15px 3px; }";
cssStyle += "#mytablee { margin:10px 0px 10px 0px; }";
cssStyle += "#crtvill, #hero { margin:0px 0px 10px 0px; }";
cssStyle += "#demolishdiv { margin: 0px 0px 0px 0px; }";
cssStyle += "#taskForm_wrapper, #tranForm_wrapper, #tranlmtform_wrapper, #demolistform_wrapper, #attackform_wrapper, #trainform_wrapper, #customtransform_wrapper, #resremainform_wrapper, #partyform_wrapper { position:fixed; max-width:900px !important; min-width:260px !important; min-height:50px !important; background-color:HoneyDew; margin:0; color:black; border:1px #000000 solid; z-index:10000; -moz-border-radius:5px; }";
cssStyle += "#MSG_wrapper, #Error_MSG_wrapper { position:absolute; max-width:900px !important; min-width:260px !important; min-height:50px !important; background-color:HoneyDew; margin:0; color:black; border:1px #000000 solid; z-index:10000; -moz-border-radius:5px; }";
cssStyle += "#test_alarm_wrapper { position:absolute; max-width:900px !important; min-width:10px !important; min-height:10px !important; background-color:HoneyDew; margin:0; color:black; border:1px #000000 solid; z-index:10000; -moz-border-radius:5px; }";
cssStyle += "#show_info_bubble_wrapper, #show_login_bubble_wrapper { position:absolute; max-width:900px !important; min-width:10px !important; min-height:10px !important; background-color:LightCoral; margin:0; color:black; border:1px #000000 solid; z-index:10000; -moz-border-radius:5px; }";
cssStyle += "#alarm_wrapper { position:absolute; max-width:900px !important; min-width:10px !important; min-height:10px !important; background-color:LightCoral; margin:0; color:black; border:1px #000000 solid; z-index:10000; -moz-border-radius:5px; }";
// GotGs 2011.01.15 -- all-time visible wrappers probably should be absolute, while input wrappers should be fixed.
cssStyle += "#tasklisttable_wrapper, #langTranslate_wrapper, #crop_finder_wrapper { position:absolute; padding:10px 20px 10px 20px; min-width:260px !important; background-color:HoneyDew; margin:0; color:black; border:1px #000000 solid; z-index:10000; -moz-border-radius:5px; }";
cssStyle += "#improveform_wrapper { position:fixed; padding:10px 20px 10px 20px; min-width:260px !important; min-height:50px !important; background-color:HoneyDew; margin:0; color:black; border:1px #000000 solid; z-index:10000; -moz-border-radius:5px; }";
cssStyle += ".handle { cursor:move; }";
cssStyle += "#autoResform1, #changeit, #changeit2, #changeit3, #changeit4, #deletealltask, #clicktostart, #verdisp { color:green; }";
cssStyle += "#autoResform2, #clicktopause { color:DarkGoldenRod; }";
cssStyle += "#demolishlnk { color:red; border-style:ridge; border-width:2px; }";
// GotGs 2011.01.15 -- adding css style for tasklisttable tool-ip.
cssStyle += "#tasklisttable_wrapper a.spantooltip { border-bottom:5px brown; text-decoration:none; } ";
cssStyle += "#tasklisttable_wrapper a.spantooltip:hover { position:relative; } ";
cssStyle += "#tasklisttable_wrapper a.spantooltip span { display:none; } ";
cssStyle += "#tasklisttable_wrapper a.spantooltip:hover span { display:block; font-size:x-small; text-align:left; position:absolute; top:0px; left:-300px; padding:5px; margin:10px; z-index:10000; background:#f0f0f0; border:1px dotted #c0c0c0; opacity:0.925; } ";
GM_addStyle(cssStyle);

// Definitions of images
var deleteBtn = "data:image/gif;base64,R0lGODlhDAAMANU2AN4ZCtAgFNAgHdsgA9waCs4cDMwkHPNfHcspJ9oYCsoYDc8pINAYCvg0AORNOeFFPtA7O+c+QNRTU8BMSb4gHN5lTNooGsc1N+g+PuEkJOhOKLlVWOwxD9MlGtUiFMwjFcI7LtcfDPY9ANs5L+JMSOxhJLRDO+YfDdYEAPdvHORZRMkZC9EcDcwXE8ssLtonG9gbG+M8EOEZGdkZDNwVCb0pKwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAADYALAAAAAAMAAwAQAZJQNNgYisajzZVDHRMBJC2TEvxOY40HNfRsEJGYBKS51gS1aA2gCXVQEApDONDBikuCmgMioV2vC5FMx1GFQchG0g0BDYnAmhFQQA7";
var movedownBtn = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAARCAIAAABbzbuTAAAABmJLR0QAAAAAAAD5Q7t%2FAAAACXBIWXMAAA7EAAAOxAGVKw4bAAACXklEQVR42p2S20vTYRjH%2FTuCiEBLWwepoC4kLSWdxZrImBeri7IjokS6eaFikGCZHaxBB5DWPNVwREKm2GSz1FKHXghFsYFaJnP%2B3Obv9B6ep3ezgsKbenkv3ovv5%2F0%2Bz%2Fd50vAfT9p%2FARwRgHPKASmg%2FdZQY%2FuHGmfAfn%2F4Skt%2Fb2BBp2tCw1BFDn8AjAPh6BqRL7S%2BPX97vKJt%2FM7Lrx7%2FHGHyxgBloFG8ObBqaRq1NgfLmt%2FXdnx55gtTrmwAADBhIQBHz%2FzxhjFjfbC4fuzio9keX3hjh9%2BAEBXWvjtin8y3%2B22tY52Dn%2F920IQWOCMqIbJCFdvd2QOXBnMqRw9d9p%2B4Nu4eCQMhqCmUIVCeclAlVYcE4CrHmI6lTVM7T3r3nHq193RfQc2bdv%2FiMkcJMMqRMzkJgK5OhyN55W2mmtcWe8BcN2mwegyW3l1lvXkVQ6bq4eLq%2FlJH91Wnh2KqJAYYB%2BybiRQ7BjaXeDPNXZnm7vW7zdSZWeI5XBU41%2FBCJZigqcEBEd1IVI8%2F9s4UVPnSC93pRU%2B2H3NlGF0ZRe59Zzz5lc9VikiiMvBfKXEmnNYAG53e%2FWf9Weanu00Pth51Zlm92UV1UV1kmBDpiFrSfqaKYsq6iEsGtFa6cmxdm3Ifbim4l21uiWrJmpFzBE7Xd4kgUmEBmhiDpqnilVt6Y4fJbTBe%2F7SoMK4AASESRVDUUz0kd46rlMTi0tL8XOjjdGAilH6w3NkxPBGcCoVmI0uRRFxlVCApACkBjgSAUE5kRqm2EpOicenb9%2FnlpYWVhKKQpIKLjxn8ABAenc7LXVdbAAAAAElFTkSuQmCC";
var moveupBtn = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAASCAIAAADdWck9AAAABmJLR0QAAAAAAAD5Q7t%2FAAAACXBIWXMAAA7EAAAOxAGVKw4bAAACbElEQVR42pVT70tTURj2f4joexGrT0XfggqGrabUIrLol4FiOiiwMCxZzQyMROzDqMD8gShCiLQNdQi2cc1tZrrmls1i1lzLLFzzunbv7r3nx9u5Zw360Jdd7j3ncN7nOe97n%2Bc9ZVDiU1Y6gRI2Uf6yL5fbyGHoHhbSEs3kRAoEA%2BBitJhBh1OdSQhDj05F4yJ09npEzDeBFKC0kIFT2UGIYoIw9UbWfXGp6dns2JJ8xzGGCA9ixCb8D4Ew9KYC75KZ0ZDY4JirfrxgfRpxL%2BOO%2FilRBU3T8%2BDiP7A1wQQ%2BpdV7g4GLDwTL%2FZljbcGqzojFLjhjuNcVUhA%2FFAjPkJcVTVtH5OYT4VJ7qKI1YLLNmO2zZnuQrc0t4%2B3OzPD0SlZDNC%2FqhDyGtErqWp22odSNgbX6nsRxW8B463X57elznYt1PcvW59GWvmA4kVZ4TWUYlNjKdyGUmpj%2F6gonr%2FWnDjf6jE3BQ43eK45YlzsxFln1vF32BZdQUdYMgEQJxpTKCFm7Px%2BoGd9fPbmv2n2%2BYyGwKCuACdW4FyonEF1WShVCqapAreODoWpk75nxPWdHTrf5%2FXMIQZ5QmYmKQCmq9FcpYLuX26OGkwMGy9DuE%2F2nmv3CQjYPTJ%2BcPmD4D%2BHC3cjOo327TINsrLg%2B7XvzQ2UhKgF3nMvK7GcaU8yagBEqmye3Gx%2FtMHZtO%2FLw4NUXr%2FxfkE6QQYdRTtDNp5qm%2FM7KP9e3ymtcphpPZb3XVOupbPC8nJgVJVHTcgyGeHPoJbFqVDW%2FtSX92pDDH1fno8m5SDIUS72Pf1vbUDezaVWR9O4pOF3qffgDH4Xh0bQHBfwAAAAASUVORK5CYII%3D";
var sCloseBtn = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAVCAIAAAAmdTLBAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH1gYKECMhBqiEGQAAADJ0RVh0Q29tbWVudABFcnN0ZWxsdCB2b24gRmxvcmlhbiBTY2hyZWllciBtaXQgVGhlIEdJTVCOHcWrAAADLUlEQVR42pWUPYhdRRiG32/OuTdZXTcas0n2ZiVVYBttLFLFQuNPZTQgiIIphGBAtNTC0lZBRRQVEYWoBAyk8ActRFCRLa3SpNH9icm699695+6Z+X5ei7Obtc1UH+/MM+/M9w4jJD0wnNi9czVuZ3iwSlKbQ5ohP3rzn+FGTBvmlqbUgpRgBQDdAbC0AOAepbV2ezI3v/Txd+nuQ0Jy4+3XqsMDqeqYjHxryJJRCiPgRneAMKU7rbBktlNrtoaj0WrvrpMXlxMAH29Kf5/0+6hqqXtS16h7SImpkqqSVCHVkipIQqq6NanuTdZXDs7VNQA2WzEZS12znTJvM2eWQi1UpSnDqQUgtcCVpnRHSqmqACQA1BKToY83oxnPPvz0/BvvR9OwaaKZeDOO8TC2NmP077FPfjzw/CvM23STlKTu3eKV04bbE+a8/8FTAI6+dTG00Aq00DK1LF78HcDs6bNwAwPcSaHjc5TCXKh6/fVz3cTggytwQzjc7vt6uRP/OrOEcGEAAXKHB8DcRm5pCvf1V5/pxGOf/kT64pd/7MBPnoArXEEXUrDLRztFyVCFOSMoXH35TMcsfvFrV6ycXUqJIiFwoUmYROz6mzK30LJ7Nwq5+tITt57a6rP3S6IIk0TqeBrC9/oXVhjOcGGIAAmDD7+/xQ+++jMl7PmHwlXC9vrHkqkFYWSQXHjvSkeun3+oK458tizdFjAJEytpz98KNdMK3Ri+8M43O/CFRwBef/EkALlj7sila4IQBlzFC013+bLjT9WFdy938NqFx0CCBHjj3AOdePjyqoSmDv7f+Qtzy9JS8/SXbwGsnT8NN3b5hzP8xnMnALQ/fI5wmkELzQAIyWun5qsD98jMbNq3X6oaAjAEAYRQJYpYFi+wgtKyFMtlPPWrW3zqatQAVEu020kqiZCqliQIh6CLOoXCi1iBFahRzdTVQh0A6pujaA4OuHkDyqqfUdWAgCFCYQi9gsNVwukqZjQ35UghC8cByDSTG3///MKjo7WVfq+mSEhCRJVEAKFXdAlPDPdAeMUozjh6/PFLv/UPDYRkVuzr3dbfh5sjv3OmmunjP4EhhHJu9NM9AAAAAElFTkSuQmCC";
var sToggleBtn = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAVCAIAAAAmdTLBAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH2AIECzU72HQ0pgAAAAd0RVh0QXV0aG9yAKmuzEgAAAAMdEVYdERlc2NyaXB0aW9uABMJISMAAAAKdEVYdENvcHlyaWdodACsD8w6AAAADnRFWHRDcmVhdGlvbiB0aW1lADX3DwkAAAAJdEVYdFNvZnR3YXJlAF1w/zoAAAALdEVYdERpc2NsYWltZXIAt8C0jwAAAAh0RVh0V2FybmluZwDAG+aHAAAAB3RFWHRTb3VyY2UA9f+D6wAAAAh0RVh0Q29tbWVudAD2zJa/AAAABnRFWHRUaXRsZQCo7tInAAABAElEQVR4nMWUS28SURTHzwwMr+HRWgjE0Iw8grQmUFEbi9agK/UTmK607cZF1y5cNI2fwJULExemK5MmmjQxaoyNTcCmMZbIQxGKvFpgAAcuMAwwMy5MSKkTE4OJZ3lyfufe8z//e7FK6QuMEPgo8D/g5ZLZdLEVTtXjGZSn2wBgNWmmKJ3XYbBZyGOV2O/zb+3RyRJ+0eMyTxjkhLzNAd1gk1l6/3tq1qkIzJj+dP7WHo364ws3XKSS6PSA7YEMA71a47JRJDkWjEYB6KMthvh0sZUq4wvXXVo1wfUglthff/acqSNBhDOe87OXb9qd09tfdylLazDIEB9O1ee8HlJFdPuQQdCaoAAAAQBJREFUO6xsvn7H1NG023HO57NOnkpWMSU5pjRS4VRhwA/pH8+gkyZ9lwcGcS9evs0Xir4Lc5f8fpvTGS+pUIfnBFE7YY5nkPT983RbQcjZLjx6sp7O5gUBdnZCoQ8hQcR4XsRx2b3V+x/L2l9LkdaP5UAUYfH2UqsHqAVZurq58RShBmkwrqzc/ZTB+qqh+iHeatJUmh2dSs32odmDNg/B928Qapww25YXb4XzuKgAttO0mjTS/BSlS2arp23WNgdsFz7HIrl04sq83z8fiBQIUYB+H5jD0gylGyBD+nkdhkTy2wHd4HnoCrD9amN56Y7efi1yQIgAwEPrByNWM16HQZq3WbZurWsAAABQSURBVMizdmI3EsvVmMcP19YerFawSZyQAQEiAQ2OKeWiV93qoy6W9m8wwarHKYPRrNBqBRFQu1krl/haJuBWH/OvBA8jvp+/iv/9f4zK/wTjEhrpKy4sPAAAAABJRU5ErkJggg%3D%3D";
var sDotImage = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAIAAABLbSncAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfWCAEPMRHyz/o7AAAAB3RJTUUH1ggBDzEimB54XQAAAAlwSFlzAAALEgAACxIB0t1+/AAAAC1JREFUeNpj3HCHIaC4lgEVbOhtZmDwr/2PAYCCTAw4AD0kWIAuYwxAFwUKAgD5ORvzCLKXagAAAABJRU5ErkJggg%3D%3D";


// Xlang specific declarations
var aLangAllBuildWithId, aLangAllBuildAltWithId, aLangAddTaskText, aLangTaskKind, maxlevel, name2gid;
var aLangGameText, aLangRaceName, aLangTaskOfText, aLangErrorText, aLangOtherText;
var aLangResources, aLangAttackType;
var aLangTroops = new Array(3);

var /*aLangAllResInDorf1,*/ allsourceString, allbuildString, allString;

var aTravianVersion = "";

/**********************************************************
 * Default values for language specific vars.
 */
var	aLangAllBuildWithIdComDef,			// building / resource tile names as shown in build.php, used for logic, translation required
	aLangAllBuildAltWithIdComDef,			// building / resource tile names as shown in tool-tips in dorf1.php and dorf2.php, used for logic, translation required
	aLangGameTextComDef,				// used for logic and display, translation required
	aLangRaceNameComDef,				// used for getMainVillageid(), translation required
	aLangErrorTextComDef,				// used for logic & display, translation required
	aLangResourcesComDef,				// used for display only, however translation can be done
	aLangAttackTypeComDef;				// used for display only, however translation can be done
var	aLangTroopsComDef = new Array(3);		// used for logic & display, translation required

var gatLangSeparator = "#|||%||*||%|||#";

aLangAllBuildWithIdComDef = ["Woodcutter", "Clay Pit", "Iron Mine", "Cropland", "", "Sawmill", "Brickyard", "Iron Foundry", "Grain Mill", "Bakery", "Warehouse", "Granary", "Blacksmith", "Armoury", "Tournament Square", "Main Building", "Rally point", "Marketplace", "Embassy", "Barracks", "Stable", "Workshop", "Academy", "Cranny", "Town Hall", "Residence", "Palace", "Treasury", "Trade Office", "Great Barracks", "Great Stable", "City Wall", "Earth Wall", "Palisade", "Stonemason's Lodge", "Brewery", "Trapper", "Hero's Mansion", "Great Warehouse", "Great Granary", "Wonder Of The World", "Horse Drinking Pool"];
aLangAllBuildAltWithIdComDef = ["Woodcutter", "Clay Pit", "Iron Mine", "Cropland", "", "Sawmill", "Brickyard", "Iron Foundry", "Grain Mill", "Bakery", "Warehouse", "Granary", "Blacksmith", "Armoury", "Tournament Square", "Main Building", "Rally Point", "Marketplace", "Embassy", "Barracks", "Stable", "Workshop", "Academy", "Cranny", "Town Hall", "Residence", "Palace", "Treasury", "Trade Office", "Great Barracks", "Great Stable", "City Wall", "Earth Wall", "Palisade", "Stonemason's Lodge", "Brewery", "Trapper", "Hero's Mansion", "Great Warehouse", "Great Granary", "Wonder Of The World", "Horse Drinking Pool"];
aLangGameTextComDef = ["Lvl", "Merchants", "ID", "Capital", "Start time", "this timeseting is unuseful now.", "to", "Village", "transport", "from", "Transport to", "Transport from", "Return from", "resources", "building", "Construct new building", "empty", "level"];
aLangRaceNameComDef = ["Romans", "Teutons", "Gauls"];
aLangErrorTextComDef = ["Too few resources.", "The workers are already at work.", "Construction completed", "Starting construction", "In development", "Your Warehouse is too small. Please upgrade your Warehouse to continue your construction", "Your Granary is too small. Please upgrade your Granary to continue your construction", "Enough resources", "Lack of food: extend cropland first", "There is already a celebration going on"];
aLangResourcesComDef = ["lumber", "clay", "iron", "crop"];
aLangTroopsComDef[0] = ["Legionnaire", "Praetorian", "Imperian", "Equites Legati", "Equites Imperatoris", "Equites Caesaris", "Battering Ram", "Fire Catapult", "Senator", "Settler", "Hero"];
aLangTroopsComDef[1] = ["Clubswinger", "Spearman", "Axeman", "Scout", "Paladin", "Teutonic Knight", "Ram", "Catapult", "Chief", "Settler", "Hero"];
aLangTroopsComDef[2] = ["Phalanx", "Swordsman", "Pathfinder", "Theutates Thunder", "Druidrider", "Haeduan", "Ram", "Trebuchet", "Chieftain", "Settler", "Hero"];
aLangAttackTypeComDef = ["Reinforce", "Attack", "Raid"];

var aLangTaskListCmds, aLangGreaseMenuItemText;

// GotGs 2011.01.15 -- a few commands added in the tasklist.
aLangTaskListCmds = [
/*   0*/	"Pause Attack",
/*   1*/	"Un-Pause Attack",
/*   2*/	"Pause Cata Attack",
/*   3*/	"Un-Pause Cata Attack",
/*   4*/	"Pause Upgrades",
/*   5*/	"Un-Pause Upgrades",
/*   6*/	"Pause Resource Upgrades",
/*   7*/	"Un-Pause Resource Upgrades",
/*   8*/	"Pause Building Upgrades",
/*   9*/	"Un-Pause Building Upgrades",
/*  10*/	"Pause Market Transfers",
/*  11*/	"Un-Pause Market Transfers",
/*  12*/	"Pause Troops Training",
/*  13*/	"Un-Pause Troops Training",
/*  14*/	"Pause Partying",
/*  15*/	"Un-Pause Partying",
/*  16*/	"Pause Troops Upgrade",
/*  17*/	"Un-Pause Troops Upgrade"
	];

// mp3 require quicktime / flash plugin on firefox
var defaultSoundUlrs = [];
defaultSoundUlrs.push ( { key: "baby-cry", url: "http://funny-stuff.audio4fun.com/download/ringtonesstore/225.mp3", description: "baby cry" } );
defaultSoundUlrs.push ( { key: "beep-sound", url: "http://funny-stuff.audio4fun.com/download/sounds/31815.mp3", description: "beep, sort of" } );
defaultSoundUlrs.push ( { key: "bird-chirping", url: "http://funny-stuff.audio4fun.com/download/sounds/18894.mp3", description: "bird chirping" } );
defaultSoundUlrs.push ( { key: "very-low", url: "http://funny-stuff.audio4fun.com/download/ringtonesstore/1332.mp3", description: "very low sound" } );
defaultSoundUlrs.push ( { key: "heli-copter", url: "http://funny-stuff.audio4fun.com/download/sounds2/31952.mp3", description: "helicopter" } );
defaultSoundUlrs.push ( { key: "fog-horn", url: "http://funny-stuff.audio4fun.com/download/sounds/17341.mp3", description: "fog horn" } );
defaultSoundUlrs.push ( { key: "night-cricket", url: "http://funny-stuff.audio4fun.com/download/sounds/20533.mp3", description: "night cricket" } );

var defSoundUrlsWithKey = "";
for ( var iCtr = 0; iCtr < defaultSoundUlrs.length; iCtr++ ) {
	defSoundUrlsWithKey += defaultSoundUlrs[iCtr].key + " -- " + defaultSoundUlrs[iCtr].description + "\n";
}

// ogg audio files works natively on firefox with html5 audio tag
//defaultSoundUlrs.push ( { key: "horse-sound", url: "http://www.w3schools.com/html5/horse.ogg", description: "horse sound" } );

aLangGreaseMenuItemText = [
/*   0*/	"GAT: Set time interval for script run (user)", 
/*   1*/	"Set time interval for script to run in seconds,\nthe default value is 20 seconds, please enter the new time (min 5 seconds, max 30 seconds):\n\n", 
/*   2*/	"Set time interval for auto-transport,\nthe default value is 30 minutes, please enter the new time in minutes:\n\n",
/*   3*/	"GAT: Enable / disable Auto-login (server)",
/*   4*/	"Enter 1 to enable auto-login, 0 to disable:\n\n",
/*   5*/	"GAT: Set intervals to skip on user activity (user)",
/*   6*/	"Enter intervals to skip on useractivity:\n\n",
/*   7*/	"GAT: Set script sleep times (user)",
/*   8*/	"Set the script sleep times by specifying sleep start & end times separated by ','.\nYou can specify multiple intervals separated by ';'.\nExample: 00:00:00,03:00:00;12:00:00,13:00:00.\n\n",
/*   9*/	"GAT: Enable / disable Anti-Farm (user)",
/*  10*/	"Enter 1 to enable anti-farm, 0 to disable.\nWhen enabled, make sure anti-farm coordinates are set, else Auto-Task will fail and stop working!\n\n",
/*  11*/	"GAT: Set Anti-Farm coordinates (user)",
/*  12*/	"Enter anti-farm coordinates as x,y.\nYou can enter multiple coordinates separated by ';'.\neg. 2,3;9,8\n\nIMPORTANT: To evade attacks on your villages, your troops will be sent to \"RAID\" the village / oasis present at the entered coordinates. The troops sent for raid will be called back after a few seconds, however to be on the safe side enter coordinates of a village / oasis which you are certain has no troops.\n\n",
/*  13*/	"GAT: Set attack detect interval (user)",
/*  14*/	"Enter attack detect interval in minutes:\nThis specifies how often script will check for incoming attacks.\n\n",
/*  15*/	"GAT: Set troops update interval (user)",
/*  16*/	"Enter max troops update interval in minutes:\nTroops count are updated automatically on attacks and troops arrrival.\nMax troop update interval specifies a max duration for which troops count may not get updated.\n\n",
/*  17*/	"GAT: Set map info recalculate interval (user)",
/*  18*/	"Enter map info recalculate interval in milli-seconds:\nThis specifies how often script updates info in maps when you move around.\n\n",
/*  19*/	"GAT: Enable / disable map enhancements (user)",
/*  20*/	"Enter 1 to enable map enhancements, 0 to disable:\nWhen enabled script marks the villages on map with the count of scheduled attacks.\n\n",
/*  21*/	"GAT: Enable / disable captha alarm (server)",
/*  22*/	"Enter 1 to enable captcha alarm, 0 to disable:\nAlso make sure that the url of the audio file is set!\n\n",
/*  23*/	"GAT: Set sound url for alarm (server)",
/*  24*/	"Enter url of a wav/mp3/ogg file (basically any audio supported by your browser) to be used as alarm\nor else enter any one of the following codes to use one of the pre-configured sounds:\n"+ defSoundUrlsWithKey +"\n",
/*  25*/	"GAT: Set alarm looping (server)",
/*  26*/	"Enter 1 to loop alarm, 0 to disable:\nWhen looping is enabled, alarm is played continuously untill stopped explicitly by clicking in the window playing the alarm.\n\n",
/*  27*/	"GAT: Set attack scheduling mode (user)",
/*  28*/	"Enter attack scheduling mode, 0 for normal mode, 1 for strict order based on start time, 2 for strict order based on time required for attack.\nIn strict order mode 1 & 2, repeat interval becomes irrevelant.\nIn strict order mode 2, attack tasks in task-list is sorted based on time required for attack.\n\n",
/*  29*/	"GAT: Set custom alarm (user)",
/*  30*/	"Enter time for custom alarm in the format displayed below:\n\n",
/*  31*/	"GAT: Set time interval for login window refresh (user)",
/*  32*/	"Set time interval for login window refresh ,\ndefault is 20 minutes, please insert the new time in minutes:\n\n",
/*  33*/	"GAT: Set time interval for auto-transport (user)",
/*  34*/	"GAT: Reset all bubble positions (user)",
/*  35*/	"GAT: Set incoming attack alarm (user)",
/*  36*/	"Enter time for incoming attack alarm in mins:\nAn alarm will be played if next incoming attack is due in below entered duration and you have resources more than 0.6 times of your cranny capacity.\nEnter 0 to disable.\n\n",
/*  37*/	"GAT: Play alarm on new mail (user)",
/*  38*/	"Enter 1 to play alarm on new mail, 0 to disable.\n\n",
/*  39*/	"GAT: Set build/upgrade/train delay time (user)",
/*  40*/	"Enter build/upgrade/train delay time in mins (default is 60 mins):\nWhen not enough resources, a build/upgrade/train is delayed by this interval.\n\n",
/*  41*/	"GAT: Do manual language translations (server)",
/*  42*/	"GAT: Enable / disable convert anchors (user)",
/*  43*/	"Enter 1 to enable conversion of anchors, 0 to disable:\nWhen enabled all native travian links will be converted to include the newdid of the current village, and hence disable jumping of villages when you are navigating while auto-task is working.\nThis may or may not convert links created by other scripts, and may or may not break other scripts, hence use at your own risk!\nTo convert links created by other scripts, try moving those scripts above auto-task in greasemonkey script list.\n\n",
/*  44*/	"GAT: Enable / disable stats collection from non-login windws (user)",
/*  45*/	"Enter 1 to enable stats collection from non-login windows, 0 to disable.\nWhen enabled, stats are collected from rally point, dorf1.php & dorf2.php when user opens these pages manually.\nThis is disabled by default.\n\n",
/*  46*/	"GAT: Set custom alarm text (user)",
/*  47*/	"Enter custom alarm text:\n\n",
/*  48*/	"GAT: Enable / disable resource overflow check (user)",
/*  49*/	"Enter 1 to enable resource overflow check, 0 to disable.\nWhen enabled, warehouse & granary will be upgraded automatically when required.\n\n",
/*  50*/	"GAT: Choose build logic to use (user)",
/*  51*/	"Enter 0 for standard build logic (supports plus double build), 1 for new build logic:\n\n",
/*  52*/	"GAT: Enable / disable debug mode (server)",
/*  53*/	"Enter 1 to enable debug mode, 0 to disable:\n\n",
/*  54*/	"GAT: Set alarm duration (user)",
/*  55*/	"Enter alarm duration in mins, default value is 1 min:\n\n",
/*  56*/	"GAT: Enable / disable plus double build (user)",
/*  57*/	"Enter 1 to enable plus double build (only works with standard build logic), 0 to disable (default is disabled):\n\n",
/*  58*/	"GAT: Enable / disable half troops for raids (user)",
/*  59*/	"Enter 1 to enable raids with half troops, 0 to disable:\nWhen enabled, raids are sent even if only half the specified troops are available (default is disabled).\n\n",
/*  60*/	"GAT: Set min crop for Auto-Resource to maintain (user)",
/*  61*/	"Enter minimun crop for Auto-Resource to maintain (default is 20):\n\n",
/*  62*/	"GAT: Set non-crop upgrade level for Auto-Resource in 15C villages (user)",
/*  63*/	"Enter non-crop upgrade level for Auto-Resource in 15C villages (default is 7):\nEnter 0 to disable upgrading of non-crop resource tiles in 15C\n\n",
/*  64*/	"GAT: Enable / disable hero adventure (user)",
/*  65*/	"Enter 1 to enable automatic hero adventure, 0 to disable (default is enabled):\n\n",
/*  66*/	"GAT: Set min health for hero adventure (user)",
/*  67*/	"Enter min health of hero for hero adventures (default is 50):\nIf hero health is less than this minimum, it won't be sent for adventure.\n\n",
/*  68*/	"GAT: Set Server Time Zone Correction (user)",
/*  69*/	"Enter time zone correction (used for debugging purpose):\neg: +2:30 or -9:30\n\nIMPORTANT: Do not use this option to set your time-zone as it is currently buggy!!\n\n",
/*  70*/	"GAT: Enable / disable minimum troops count check (user)",
/*  71*/	"Enter 1 to enable minimum troops count check, 0 to disable (default is enabled):\n\n",
/*  72*/	"GAT: Set troops to send out for anti-farm (user)",
/*  73*/	"Enter troops to send out for anti-farm in the format shown below:\n\n'1' means, the specified troop kind will be sent out to evade attack.\n\n'0' means, the specified troop kind will not be sent out to evade attack.\n\n'-ve value', eg '-1000' means, the specified troop kind will not be sent out to evade attack if you have a min of 1000 troops of that kind.\n\nIf more than one troop-kind has -ve values, then minimums for all troop-kinds must be met, otherwise all troops are sent out to evade attack.\n\nSay you are a teuton, and you have 1500 clubs (1st troop type) & 1500 spears (2nd troop type). Note here that clubs are offensive and spears are defensive. So you won't want to defend with clubs and you will wish to send them out when there is an incoming attack. On the other hand, you will wish to defend using spears. so here is what you will set up:\n\n1,0,1,1,1,1,1,1,1,1,1 (remember there are a total of 11 troop types, last one is hero)\n\nHere the 1st '1' means, clubs will be sent out to evade attack.\nAnd the 2nd '0' means, spears will be retained to defend the attack.\n\nAnother example...\nSay now you have 1500 clubs, and but only 300 spears, however you have scheduled another 300 spears to be trained in your barrack. Now because you do not have enough spears you do not wish to defend with them untill you have atleast 500 spears. So here is what you will set up:\n\n1,-500,1,1,1,1,1,1,1,1,1\n\nHere the 2nd '-500' means, spears will be sent out to evade attack untill you have atleast 500 of them. Once you have 500 spears, they will not be sent out and will be retained to defend the attack.\n\n ",
/*  74*/	"GAT: Set minimum resources to transfer via custom-transport (user)",
/*  75*/	"Enter minimum resources to transfer via custom-transport, default is 100:\n\n",
/*  76*/	"GAT: Set allowed server time difference (server)",
/*  77*/	"Enter the allowed server time difference in seconds (default is 20 secs):\nFilling in a large value may have un-desirable effects on the script's functionality!\n\n",
/*  78*/	"GAT: Set message list max size (server)",
/*  79*/	"Enter the message list max size (min value 100), enter -1 to enable unlimited message list:\n\n",
/*  80*/	"GAT: Set error message list max size (server)",
/*  81*/	"Enter the error message list max size (min value 100), enter -1 to enable unlimited error list:\n\n"
    	];

// =============================================================================
// VAR FOR beyond
// =============================================================================
var crtPage = window.location.href;
var TB3O = new Object();
	TB3O.TBStartTime = new Date().getTime();
	TB3O.version = '3.8.8.9.6.1';
	TB3O.TBEndTime = TB3O.TBStartTime;
	TB3O.usoL = 'http://userscripts.org/scripts/';
	TB3O.usoNo = '28129';
	TB3O.url = TB3O.usoL + 'source/' + TB3O.usoNo + '.user.js';
	TB3O.shN = 'TB3-ML&CN';
	TB3O.sn = 'Waiting for the storm';
	TB3O.usoA = TB3O.usoL + 'show/' + TB3O.usoNo;
	TB3O.origMap = true;
	TB3O.BrT = "";
	TB3O.TBTRT = function() {return TB3O.TBEndTime - TB3O.TBStartTime;};
	TB3O.versionText = function() {return TB3O.version + " - " + TB3O.sn;};
	TB3O.nTARbT = '';
	TB3O.nTASb = '';
	TB3O.nTAUb = '';
	TB3O.nTANb = '';
	TB3O.FmapServer = '';
	TB3O.FmapLanguage = '';
	TB3O.boolIsThisNPC = false;
	TB3O.boolIsNPCExluded = false;
	TB3O.T35 = false;
	TB3O.M35 = 0;
	TB3O.avBKS = false;
	TB3O.boolShowNPCLink = crtPage.indexOf(".org") == -1;
	TB3O.gServer;
	TB3O.fullServerName;
	TB3O.UserID = '0';
	TB3O.plAc = false;
	TB3O.AVP = 0;
	TB3O.Mcap = 0;
	TB3O.VillageRes = '';
	TB3O.hOffBonus = 0;
	TB3O.speed = false;
	TB3O.tPpH = [0, 0, 0, 0, 0];//total production per hour for all villages -> requires to open all villages on a regular basis to get current data
	TB3O.d2spB = [0, 0, 0, 0, 0, 0, 0, 0, 0];//cpbuilding, barracks, big barracks, workshop, stable, big stable, tournament square, townhall, horse drinking through
	//crt coords
	TB3O.xCrt = -1000;
	TB3O.yCrt = -1000;
	//CN colors (CN_COL_TXT, CN_COL_NEUTRAL, CN_COL_MAX_LVL, CN_COL_NO_UPG, CN_COL_UPG_VIA_NPC)
	TB3O.CNc = ['#000000', '#FDF8C1', '#7DFF7D', '#FF9696', '#FFC84B'];
	TB3O.DFc = ['#000000', 'white'];

	TB3O.wH = window.innerHeight;
	TB3O.wW = window.innerWidth;

	TB3O.isTtB = false;

	TB3O.lng = 'fr';
	var ddX = '680';
	//doc direction
	var docDir = ['left', 'right'];
	//if (document.defaultView.getComputedStyle(document.body, null).getPropertyValue("direction") == 'rtl') {docDir = ['right', 'left']; ddX = '100';};


	TB3O.OD = [
	'0', '0', '1', '0', '1', '1', '1', '1', '1', '1',
	'0', '0', '1', '1', '1', '1', '1', '1', '1', '1',
	'1', '1', '1', '1', '0', '0', '1', '0', '1', '0',
	'1', '1', '1', '1', '1', '1', '0', '1', '1', '1',
	'1', '1', '0', '1', '1', '1', '1', '0', '0', '0',
	'3', '0', '0', '1', '1', '0', '1', '1', '0', '0', 
	'1', '1', '0', '1', '0', '',  '',  '',  '',  '0',
	'1', '1', '1', '1', '1', ddX + '|150', ddX + '|170', ddX + '|210', ddX + '|190', ddX + '|220',
	'1', '1', '1', '1', '1', '1', '1', '0', ddX + '|500', ddX + '|500', ddX + '|500'];

	TB3O.O = TB3O.OD;
	//link to the profile
	var spLnk = '';
	//link to the barracks
	var bksLnk = 'build.php?gid=19';
	//available races
	avRace = ['Romans', 'Teutons', 'Gauls'];
	//merchants speed (normal servers)
	var mts = {'Romans': 16, 'Teutons': 12, 'Gauls': 24};
	//user information: username(0), race(1), disprace(2), capital name(3), capital vid(4), capital newdid (5), capitalxy(6), deltaRaceImg (7)
	TB3O.U = ['', '', '', '', '', '', '', 1];
	//available languages
	var arAvLang = ['Server language', 'ae', 'ar', 'ba', 'bg', 'br', 'cl', 'cn', 'cz', 'de', 'dk', 'el', 'en', 'es', 'fi', 'fr', 'gr', 'hk', 'hr', 'hu', 'id', 'il', 'ir', 'it', 'jp', 'kr', 'lt', 'lv', 'mx', 'my', 'nl', 'no', 'ph', 'pl', 'pt', 'ro', 'rs', 'ru', 'si', 'sk', 'th', 'tr', 'tw', 'ua', 'vn'];

var vNames = '';
	//link to the profile
	var spLnk = '';
	//link to the barracks
	var bksLnk = 'build.php?gid=19';
	//available races
	avRace = ['Romans', 'Teutons', 'Gauls'];
	//merchants speed (normal servers)
	var mts = {'Romans': 16, 'Teutons': 12, 'Gauls': 24};
	//user information: username(0), race(1), disprace(2), capital name(3), capital vid(4), capital newdid (5), capitalxy(6), deltaRaceImg (7)
	TB3O.U = ['', '', '', '', '', '', '', 1];
	//available languages
	var arAvLang = ['Server language', 'ae', 'ar', 'ba', 'bg', 'br', 'cl', 'cn', 'cz', 'de', 'dk', 'el', 'en', 'es', 'fi', 'fr', 'gr', 'hk', 'hr', 'hu', 'id', 'il', 'ir', 'it', 'jp', 'kr', 'lt', 'lv', 'mx', 'my', 'nl', 'no', 'ph', 'pl', 'pt', 'ro', 'rs', 'ru', 'si', 'sk', 'th', 'tr', 'tw', 'ua', 'vn'];
	//village information
	function xVillage(aName, vID, newdid, x, y, vLink) {this.vName = aName;this.vID = vID;this.vNewdid = newdid;this.vx = x;this.vy = y;this.vLink = vLink; return this;};
	//a building being upgraded
	function xBiP(aName, tEnd) {var txtLvl = aName[1].replace(")", "");var lvl = txtLvl.split(" ");this.name = aName[0];this.txtLvl = txtLvl;this.lvl = lvl[1];this.endTime = tEnd; return this;};
	function xTiT(aType, aName, t1) {this.type = aType;this.name = aName;this.t1 = t1;var aD = new Date();aD.setTime(aD.getTime());this.crtDate = aD; return this;};
	function yTiT(tType, intNo, strName) {this.tType = tType;this.intNo = intNo;this.strName = strName; return this;};
	//a troop movement (from dorf1.php)
	function xTrMov(iT, no, fT) {this.type = iT;this.no = no;this.fT = fT; return this;};
	function xTtT(tType, necRes, tTime, aRes) {this.necRes = necRes;this.tType = tType;this.tTime = tTime;this.aRes = aRes; return this;};

	var vList = new Array();
	//active village
	var actV = new xVillage('', 0, 0, -1000, -1000, '');

	var arrTtT = new Array();
	var vNames = '';
	var defaultMF = [5, 5, 4, 2, 4];
	var marketFilters;
	var localGP = "";
	var wsSName;
	var wsURLCropFinderLinkV2 = "http://crop-finder.com/";
	var wsAnalyser =	[["World Analyser", "http://www.travian.ws/analyser.pl?s="], ["Travian Utils", "http://travian-utils.com/?s="], ["Travianbox.com", "http://travianbox.com/stats/"]];
	var mapAnalyser =	[["Travmap", "http://travmap.shishnet.org/"], ["Flash map", "http://travian.org.ua/"]];
	var repSite =		[["Travilog", "http://travilog.org.ua/"], ["T-Reports.net", "http://travian-reports.net/"]];
	var warsimLink = 	["warsim.php", "http://travian.kirilloid.ru/warsim.php"];

	var wsURLTravianBox = "http://travianbox.com";
	var urlNow = window.location.pathname + window.location.search;
	jsVoid = 'javaScript:void(0)';
	xGIF = "a/x.gif";
	dlright1 = 'lright1';
	dmid = 'lmidall';
	dTop5 = 'ltop5';
	dTop1 = 'ltop1';
	dmid2 = 'lmid2';
	dleft = 'lleft';
	dmid1 = 'lmid1';
	dmap = 'map1';
	gIc = new Array();

	crtResUnits = new Array(5);//current resource units
	capacity = new Array(4);//capacity of the warehouse/granary
	prodPerHour = new Array(7);//production per hour for the four resource types
	timeToFill = [[-1, ""], [-1, ""], [-1, ""], [-1, ""]];//time to fill the warehouse/granary

	NPCResources = 'npcResources';
	NPCbacklinkName = 'npcBackLink';
	NPCURL = '/build.php?gid=17&t=3';


var BuildType = { field:0, building:1, all:2 };
var Race = { roman:0, teuton:1, gaul:2 };
var bCost = [[0],//dummy
[//lumberCost gid = 1
[0,0,0,0,0,0],
[40,100,50,60,1,2],
[65,165,85,100,1,3],
[110,280,140,165,2,4],
[185,465,235,280,2,5],
[310,780,390,465,2,6],
[520,1300,650,780,3,8],
[870,2170,1085,1300,4,10],
[1450,3625,1810,2175,4,12],
[2420,6050,3025,3630,5,14],
[4040,10105,5050,6060,6,16],//10
[6750,16870,8435,10125,7,18],
[11270,28175,14090,16905,9,20],
[18820,47055,23525,28230,11,22],
[31430,78580,39290,47150,13,24],
[52490,131230,65615,78740,15,26],
[87660,219155,109575,131490,18,29],
[146395,365985,182995,219590,22,32],
[244480,611195,305600,366715,27,35],
[408280,1020695,510350,612420,32,38],
[681825,1704565,852280,1022740,38,41],//20
[1138650,2846620,1423310,1707970,38,44],
[1901540,4753855,2376925,2852315,38,47],
[3175575,7938935,3969470,4763360,38,50],
[5303210,13258025,6629015,7954815,38,53],
[8856360,22140900,11070450,13284540,38,56]//25
],
[//clayCost gid = 2
[0,0,0,0,0,0],
[80,40,80,50,1,2],
[135,65,135,85,1,3],
[225,110,225,140,2,4],
[375,185,375,235,2,5],
[620,310,620,390,2,6],
[1040,520,1040,650,3,8],
[1735,870,1735,1085,4,10],
[2900,1450,2900,1810,4,12],
[4840,2420,4840,3025,5,14],
[8080,4040,8080,5050,6,16],//10
[13500,6750,13500,8435,7,18],
[22540,11270,22540,14090,9,20],
[37645,18820,37645,23525,11,22],
[62865,31430,62865,39290,13,24],
[104985,52490,104985,65615,15,26],
[175320,87660,175320,109575,18,29],
[292790,146395,292790,182995,22,32],
[488955,244480,488955,305600,27,35],
[816555,408280,816555,510350,32,38],
[1363650,681825,1363650,852280,38,41],//20
[2277295,1138650,2277295,1423310,38,44],
[3803085,1901540,3803085,2376925,38,47],
[6351150,3175575,6351150,3969470,38,50],
[10606420,5303210,10606420,6629015,38,53],
[17712720,8856360,17712720,11070450,38,56]//25
],
[//ironCost gid = 3
[0,0,0,0,0,0],
[100,80,30,60,1,3],
[165,135,50,100,1,5],
[280,225,85,165,2,7],
[465,375,140,280,2,9],
[780,620,235,465,2,11],
[1300,1040,390,780,3,13],
[2170,1735,650,1300,4,15],
[3625,2900,1085,2175,4,17],
[6050,4840,1815,3630,5,19],
[10105,8080,3030,6060,6,21],//10
[16870,13500,5060,10125,7,24],
[28175,22540,8455,16905,9,27],
[47055,37645,14115,28230,11,30],
[78580,62865,23575,47150,13,33],
[131230,104985,39370,78740,15,36],
[219155,175320,65745,131490,18,39],
[365985,292790,109795,219590,22,42],
[611195,488955,183360,366715,27,45],
[1020695,816555,306210,612420,32,48],
[1704565,1363650,511370,1022740,38,51],//20
[2846620,2277295,853985,1707970,38,54],
[4753855,3803085,1426155,2852315,38,57],
[7938935,6351150,2381680,4763360,38,60],
[13258025,10606420,3977410,7954815,38,63],
[22140900,17712720,6642270,13284540,38,66]//25
],
[//cropCost gid = 4
[0,0,0,0,0,0],
[70,90,70,20,1,0],
[115,150,115,35,1,0],
[195,250,195,55,2,0],
[325,420,325,95,2,0],
[545,700,545,155,2,0],
[910,1170,910,260,3,1],
[1520,1950,1520,435,4,2],
[2535,3260,2535,725,4,3],
[4235,5445,4235,1210,5,4],
[7070,9095,7070,2020,6,5],//10
[11810,15185,11810,3375,7,6],
[19725,25360,19725,5635,9,7],
[32940,42350,32940,9410,11,8],
[55005,70720,55005,15715,13,9],
[91860,118105,91860,26245,15,10],
[153405,197240,153405,43830,18,12],
[256190,329385,256190,73195,22,14],
[427835,550075,427835,122240,27,16],
[714485,918625,714485,204140,32,18],
[1193195,1534105,1193195,340915,38,20],//20
[1992635,2561960,1992635,569325,38,22],
[3327700,4278470,3327700,950770,38,24],
[5557255,7145045,5557255,1587785,38,26],
[9280620,11932225,9280620,2651605,38,28],
[15498630,19926810,15498630,4428180,38,30]//25
],
[//sawmillCost gid = 5
[0,0,0,0,0,0],
[520,380,290,90,1,4],
[935,685,520,160,1,6],
[1685,1230,940,290,2,8],
[3035,2215,1690,525,2,10],
[5460,3990,3045,945,2,12]
],
[//brickyardCost gid = 6
[0,0,0,0,0,0],
[440,480,320,50,1,3],
[790,865,575,90,1,5],
[1425,1555,1035,160,2,7],
[2565,2800,1865,290,2,9],
[4620,5040,3360,525,2,11]
],
[//ironFoundryCost gid = 7
[0,0,0,0,0,0],
[200,450,510,120,1,6],
[360,810,920,215,1,9],
[650,1460,1650,390,2,12],
[1165,2625,2975,700,2,15],
[2100,4725,5355,1260,2,18]
],
[//grainMillCost gid = 8
[0,0,0,0,0,0],
[500,440,380,1240,1,3],
[900,790,685,2230,1,5],
[1620,1425,1230,4020,2,7],
[2915,2565,2215,7230,2,9],
[5250,4620,3990,13015,2,11]
],
[//bakeryCost gid = 9
[0,0,0,0,0,0],
[1200,1480,870,1600,1,4],
[2160,2665,1565,2880,1,6],
[3890,4795,2820,5185,2,8],
[7000,8630,5075,9330,2,10],
[12595,15535,9135,16795,2,12]
],
[//warehouseCost gid = 10
[0,0,0,0,0,0],
[130,160,90,40,1,1],
[165,205,115,50,1,2],
[215,260,145,65,2,3],
[275,335,190,85,2,4],
[350,430,240,105,2,5],
[445,550,310,135,3,6],
[570,705,395,175,4,7],
[730,900,505,225,4,8],
[935,1155,650,290,5,9],
[1200,1475,830,370,6,10],//10
[1535,1890,1065,470,7,12],
[1965,2420,1360,605,9,14],
[2515,3095,1740,775,11,16],
[3220,3960,2230,990,13,18],
[4120,5070,2850,1270,15,20],
[5275,6490,3650,1625,18,22],
[6750,8310,4675,2075,22,24],
[8640,10635,5980,2660,27,26],
[11060,13610,7655,3405,32,28],
[14155,17420,9800,4355,38,30]//20
],
[//granaryCost gid = 11
[0,0,0,0,0,0],
[80,100,70,20,1,1],
[100,130,90,25,1,2],
[130,165,115,35,2,3],
[170,210,145,40,2,4],
[215,270,190,55,2,5],
[275,345,240,70,3,6],
[350,440,310,90,4,7],
[450,565,395,115,4,8],
[575,720,505,145,5,9],
[740,920,645,185,6,10],//10
[945,1180,825,235,7,12],
[1210,1510,1060,300,9,14],
[1545,1935,1355,385,11,16],
[1980,2475,1735,495,13,18],
[2535,3170,2220,635,15,20],
[3245,4055,2840,810,18,22],
[4155,5190,3635,1040,22,24],
[5315,6645,4650,1330,27,26],
[6805,8505,5955,1700,32,28],
[8710,10890,7620,2180,38,30]//20
],
[//blacksmithCost gid = 12
[0,0,0,0,0,0],
[170,200,380,130,2,4],
[220,255,485,165,3,6],
[280,330,625,215,3,8],
[355,420,795,275,4,10],
[455,535,1020,350,5,12],
[585,685,1305,445,6,15],
[750,880,1670,570,7,18],
[955,1125,2140,730,9,21],
[1225,1440,2740,935,10,24],
[1570,1845,3505,1200,12,27],//10
[2005,2360,4485,1535,15,30],
[2570,3020,5740,1965,18,33],
[3290,3870,7350,2515,21,36],
[4210,4950,9410,3220,26,39],
[5390,6340,12045,4120,31,42],
[6895,8115,15415,5275,37,46],
[8825,10385,19730,6750,44,50],
[11300,13290,25255,8640,53,54],
[14460,17015,32325,11060,64,58],
[18510,21780,41380,14155,77,62]//20
],
[//armouryCost gid = 13
[0,0,0,0,0,0],
[130,210,410,130,2,4],
[165,270,525,165,3,6],
[215,345,670,215,3,8],
[275,440,860,275,4,10],
[350,565,1100,350,5,12],
[445,720,1410,445,6,15],
[570,925,1805,570,7,18],
[730,1180,2310,730,9,21],
[935,1515,2955,935,10,24],
[1200,1935,3780,1200,12,27],//10
[1535,2480,4840,1535,15,30],
[1965,3175,6195,1965,18,33],
[2515,4060,7930,2515,21,36],
[3220,5200,10150,3220,26,39],
[4120,6655,12995,4120,31,42],
[5275,8520,16630,5275,37,46],
[6750,10905,21290,6750,44,50],
[8640,13955,27250,8640,53,54],
[11060,17865,34880,11060,64,58],
[14155,22865,44645,14155,77,62]//20
],
[//tournamentSquareCost gid = 14
[0,0,0,0,0,0],
[1750,2250,1530,240,1,1],
[2240,2880,1960,305,1,2],
[2865,3685,2505,395,2,3],
[3670,4720,3210,505,2,4],
[4700,6040,4105,645,2,5],
[6015,7730,5255,825,3,6],
[7695,9895,6730,1055,4,7],
[9850,12665,8615,1350,4,8],
[12610,16215,11025,1730,5,9],
[16140,20755,14110,2215,6,10],//10
[20660,26565,18065,2835,7,12],
[26445,34000,23120,3625,9,14],
[33850,43520,29595,4640,11,16],
[43330,55705,37880,5940,13,18],
[55460,71305,48490,7605,15,20],
[70990,91270,62065,9735,18,22],
[90865,116825,79440,12460,22,24],
[116305,149540,101685,15950,27,26],
[148875,191410,130160,20415,32,28],
[190560,245005,166600,26135,38,30]//20
],
[//mainBuildingCost gid = 15
[0,0,0,0,0,0],
[70,40,60,20,2,2],
[90,50,75,25,3,3],
[115,65,100,35,3,4],
[145,85,125,40,4,5],
[190,105,160,55,5,6],
[240,135,205,70,6,8],
[310,175,265,90,7,10],
[395,225,340,115,9,12],
[505,290,430,145,10,14],
[645,370,555,185,12,16],//10
[825,470,710,235,15,18],
[1060,605,905,300,18,20],
[1355,775,1160,385,21,22],
[1735,990,1485,495,26,24],
[2220,1270,1900,635,31,26],
[2840,1625,2435,810,37,29],
[3635,2075,3115,1040,44,32],
[4650,2660,3990,1330,53,35],
[5955,3405,5105,1700,64,38],
[7620,4355,6535,2180,77,41]//20
],
[//rallyPointCost gid = 16
[0,0,0,0,0,0],
[110,160,90,70,1,1],
[140,205,115,90,1,2],
[180,260,145,115,2,3],
[230,335,190,145,2,4],
[295,430,240,190,2,5],
[380,550,310,240,3,6],
[485,705,395,310,4,7],
[620,900,505,395,4,8],
[795,1155,650,505,5,9],
[1015,1475,830,645,6,10],//10
[1300,1890,1065,825,7,12],
[1660,2420,1360,1060,9,14],
[2130,3095,1740,1355,11,16],
[2725,3960,2230,1735,13,18],
[3485,5070,2850,2220,15,20],
[4460,6490,3650,2840,18,22],
[5710,8310,4675,3635,22,24],
[7310,10635,5980,4650,27,26],
[9360,13610,7655,5955,32,28],
[11980,17420,9800,7620,38,30]//20
],
[//marketplaceCost gid = 17
[0,0,0,0,0,0],
[80,70,120,70,4,4],
[100,90,155,90,4,6],
[130,115,195,115,5,8],
[170,145,250,145,6,10],
[215,190,320,190,7,12],
[275,240,410,240,9,15],
[350,310,530,310,11,18],
[450,395,675,395,13,21],
[575,505,865,505,15,24],
[740,645,1105,645,19,27],//10
[945,825,1415,825,22,30],
[1210,1060,1815,1060,27,33],
[1545,1355,2320,1355,32,38],
[1980,1735,2970,1735,39,41],
[2535,2220,3805,2220,46,44],
[3245,2840,4870,2840,55,48],
[4155,3635,6230,3635,67,52],
[5315,4650,7975,4650,80,56],
[6805,5955,10210,5955,96,60],
[8710,7620,13065,7620,115,64]//20
],
[//embassyCost gid = 18
[0,0,0,0,0,0],
[180,130,150,80,5,3],
[230,165,190,100,6,5],
[295,215,245,130,7,7],
[375,275,315,170,8,9],
[485,350,405,215,10,11],
[620,445,515,275,12,13],
[790,570,660,350,14,15],
[1015,730,845,450,17,17],
[1295,935,1080,575,21,19],
[1660,1200,1385,740,25,21],//10
[2125,1535,1770,945,30,24],
[2720,1965,2265,1210,36,27],
[3480,2515,2900,1545,43,30],
[4455,3220,3715,1980,51,33],
[5705,4120,4755,2535,62,36],
[7300,5275,6085,3245,74,39],
[9345,6750,7790,4155,89,42],
[11965,8640,9970,5315,106,45],
[15315,11060,12760,6805,128,48],
[19600,14155,16335,8710,153,51]//20
],
[//barracksCost gid = 19
[0,0,0,0,0,0],
[210,140,260,120,1,4],
[270,180,335,155,1,6],
[345,230,425,195,2,8],
[440,295,545,250,2,10],
[565,375,700,320,2,12],
[720,480,895,410,3,15],
[925,615,1145,530,4,18],
[1180,790,1465,675,4,21],
[1515,1010,1875,865,5,24],
[1935,1290,2400,1105,6,27],//10
[2480,1655,3070,1415,7,30],
[3175,2115,3930,1815,9,33],
[4060,2710,5030,2320,11,36],
[5200,3465,6435,2970,13,39],
[6655,4435,8240,3805,15,42],
[8520,5680,10545,4870,18,46],
[10905,7270,13500,6230,22,50],
[13955,9305,17280,7975,27,54],
[17865,11910,22120,10210,32,58],
[22865,15245,28310,13065,38,62]//20
],
[//stableCost gid = 20
[0,0,0,0,0,0],
[260,140,220,100,2,5],
[335,180,280,130,3,8],
[425,230,360,165,3,11],
[545,295,460,210,4,14],
[700,375,590,270,5,17],
[895,480,755,345,6,20],
[1145,615,970,440,7,23],
[1465,790,1240,565,9,26],
[1875,1010,1585,720,10,29],
[2400,1290,2030,920,12,32],//10
[3070,1655,2595,1180,15,36],
[3930,2115,3325,1510,18,40],
[5030,2710,4255,1935,21,44],
[6435,3465,5445,2475,26,48],
[8240,4435,6970,3170,31,52],
[10545,5680,8925,4055,37,56],
[13500,7270,11425,5190,44,60],
[17280,9305,14620,6645,53,64],
[22120,11910,18715,8505,64,68],
[28310,15245,23955,10890,77,72]//20
],
[//workshopCost gid = 21
[0,0,0,0,0,0],
[460,510,600,320,4,3],
[590,655,770,410,4,5],
[755,835,985,525,5,7],
[965,1070,1260,670,6,9],
[1235,1370,1610,860,7,11],
[1580,1750,2060,1100,9,13],
[2025,2245,2640,1405,11,15],
[2590,2870,3380,1800,13,17],
[3315,3675,4325,2305,15,19],
[4245,4705,5535,2950,19,21],//10
[5430,6020,7085,3780,22,24],
[6950,7705,9065,4835,27,27],
[8900,9865,11605,6190,32,30],
[11390,12625,14855,7925,39,33],
[14580,16165,19015,10140,46,36],
[18660,20690,24340,12980,55,39],
[23885,26480,31155,16615,67,42],
[30570,33895,39875,21270,80,45],
[39130,43385,51040,27225,96,48],
[50090,55535,65335,34845,115,51]//20
],
[//academyCost gid = 22
[0,0,0,0,0,0],
[220,160,90,40,5,4],
[280,205,115,50,6,6],
[360,260,145,65,7,8],
[460,335,190,85,8,10],
[590,430,240,105,10,12],
[755,550,310,135,12,15],
[970,705,395,175,14,18],
[1240,900,505,225,17,21],
[1585,1155,650,290,21,24],
[2030,1475,830,370,25,27],//10
[2595,1890,1065,470,30,30],
[3325,2420,1360,605,36,33],
[4255,3095,1740,775,43,36],
[5445,3960,2230,990,51,39],
[6970,5070,2850,1270,62,42],
[8925,6490,3650,1625,74,46],
[11425,8310,4675,2075,89,50],
[14620,10635,5980,2660,106,54],
[18715,13610,7655,3405,128,58],
[23955,17420,9800,4355,153,62]//20
],
[//crannyCost gid = 23
[0,0,0,0,0,0],
[40,50,30,10,1,0],
[50,65,40,15,1,0],
[65,80,50,15,2,0],
[85,105,65,20,2,0],
[105,135,80,25,2,0],
[135,170,105,35,3,1],
[175,220,130,45,4,2],
[225,280,170,55,4,3],
[290,360,215,70,5,4],
[370,460,275,90,6,5]//10
],
[//townhallCost gid = 24
[0,0,0,0,0,0],
[1250,1110,1260,600,6,4],
[1600,1420,1615,770,7,6],
[2050,1820,2065,985,9,8],
[2620,2330,2640,1260,10,10],
[3355,2980,3380,1610,12,12],
[4295,3815,4330,2060,15,15],
[5500,4880,5540,2640,18,18],
[7035,6250,7095,3380,21,21],
[9005,8000,9080,4325,26,24],
[11530,10240,11620,5535,31,27],//10
[14755,13105,14875,7085,37,30],
[18890,16775,19040,9065,45,33],
[24180,21470,24370,11605,53,36],
[30950,27480,31195,14855,64,39],
[39615,35175,39930,19015,77,42],
[50705,45025,51110,24340,92,46],
[64905,57635,65425,31155,111,50],
[83075,73770,83740,39875,133,54],
[106340,94430,107190,51040,160,58],
[136115,120870,137200,65335,192,62]//20
],
[//residenceCost gid = 25
[0,0,0,0,0,0],
[580,460,350,180,2,1],
[740,590,450,230,3,2],
[950,755,575,295,3,3],
[1215,965,735,375,4,4],
[1555,1235,940,485,5,5],
[1995,1580,1205,620,6,6],
[2550,2025,1540,790,7,7],
[3265,2590,1970,1015,9,8],
[4180,3315,2520,1295,11,9],
[5350,4245,3230,1660,12,10],//10
[6845,5430,4130,2125,15,12],
[8765,6950,5290,2720,18,14],
[11220,8900,6770,3480,21,16],
[14360,11390,8665,4455,26,18],
[18380,14580,11090,5705,31,20],
[23530,18660,14200,7300,37,22],
[30115,23885,18175,9345,44,24],
[38550,30570,23260,11965,53,26],
[49340,39130,29775,15315,64,28],
[63155,50090,38110,19600,77,30]//20
],
[//palaceCost gid = 26
[0,0,0,0,0,0],
[550,800,750,250,6,1],
[705,1025,960,320,7,2],
[900,1310,1230,410,9,3],
[1155,1680,1575,525,10,4],
[1475,2145,2015,670,12,5],
[1890,2750,2575,860,15,6],
[2420,3520,3300,1100,18,7],
[3095,4505,4220,1405,21,8],
[3965,5765,5405,1800,26,9],
[5075,7380,6920,2305,31,10],//10
[6495,9445,8855,2950,37,12],
[8310,12090,11335,3780,45,14],
[10640,15475,14505,4835,53,16],
[13615,19805,18570,6190,64,18],
[17430,25355,23770,7925,77,20],
[22310,32450,30425,10140,92,22],
[28560,41540,38940,12980,111,24],
[36555,53170,49845,16615,133,26],
[46790,68055,63805,21270,160,28],
[59890,87110,81670,27225,192,30]//20
],
[//treasuryCost gid = 27
[0,0,0,0,0,0],
[2880,2740,2580,990,7,4],
[3630,3450,3250,1245,9,6],
[4570,4350,4095,1570,10,8],
[5760,5480,5160,1980,12,10],
[7260,6905,6505,2495,15,12],
[9145,8700,8195,3145,18,15],
[11525,10965,10325,3960,21,18],
[14520,13815,13010,4990,26,21],
[18295,17405,16390,6290,31,24],
[23055,21930,20650,7925,37,27],//10
[29045,27635,26020,9985,45,30],
[36600,34820,32785,12580,53,33],
[46115,43875,41310,15850,64,36],
[58105,55280,52050,19975,77,39],
[73210,69655,65585,25165,92,42],
[92245,87760,82640,31710,111,46],
[116230,110580,104125,39955,133,50],
[146450,139330,131195,50340,160,54],
[184530,175560,165305,63430,192,58],
[232505,221205,208285,79925,230,62]//20
],
[//tradeOfficeCost gid = 28
[0,0,0,0,0,0],
[1400,1330,1200,400,4,3],
[1790,1700,1535,510,4,5],
[2295,2180,1965,655,5,7],
[2935,2790,2515,840,6,9],
[3760,3570,3220,1075,7,11],
[4810,4570,4125,1375,9,13],
[6155,5850,5280,1760,11,15],
[7880,7485,6755,2250,13,17],
[10090,9585,8645,2880,15,19],
[12915,12265,11070,3690,19,21],//10
[16530,15700,14165,4720,22,24],
[21155,20100,18135,6045,27,27],
[27080,25725,23210,7735,32,30],
[34660,32930,29710,9905,39,33],
[44370,42150,38030,12675,46,36],
[56790,53950,48680,16225,55,39],
[72690,69060,62310,20770,67,42],
[93045,88395,79755,26585,80,45],
[119100,113145,102085,34030,96,48],
[152445,144825,130670,43555,115,51]//20
],
[//greatBarrackCost gid = 29
[0,0,0,0,0,0],
[630,420,780,360,1,4],
[805,540,1000,460,1,6],
[1030,690,1280,590,2,8],
[1320,880,1635,755,2,10],
[1690,1125,2095,965,2,12],
[2165,1445,2680,1235,3,15],
[2770,1845,3430,1585,4,18],
[3545,2365,4390,2025,4,21],
[4540,3025,5620,2595,5,24],
[5810,3875,7195,3320,6,27],//10
[7440,4960,9210,4250,7,30],
[9520,6345,11785,5440,9,33],
[12185,8125,15085,6965,11,36],
[15600,10400,19310,8915,13,39],
[19965,13310,24720,11410,15,42],
[25555,17035,31640,14605,18,46],
[32710,21810,40500,18690,22,50],
[41870,27915,51840,23925,27,54],
[53595,35730,66355,30625,32,58],
[68600,45735,84935,39200,38,62]//20
],
[//greatStableCost gid = 30
[0,0,0,0,0,0],
[780,420,660,300,2,5],
[1000,540,845,385,3,8],
[1280,690,1080,490,3,11],
[1635,880,1385,630,4,14],
[2095,1125,1770,805,5,17],
[2680,1445,2270,1030,6,20],
[3430,1845,2905,1320,7,23],
[4390,2365,3715,1690,9,26],
[5620,3025,4755,2160,10,29],
[7195,3875,6085,2765,12,32],//10
[9210,4960,7790,3540,15,36],
[11785,6345,9975,4535,18,40],
[15085,8125,12765,5805,21,44],
[19310,10400,16340,7430,26,48],
[24720,13310,20915,9505,31,52],
[31640,17035,26775,12170,37,56],
[40500,21810,34270,15575,44,60],
[51840,27915,43865,19940,53,64],
[66355,35730,56145,25520,64,68],
[84935,45735,71870,32665,77,72]//20
],
[//citywallCost gid = 31
[0,0,0,0,0,0],
[70,90,170,70,1,0],
[90,115,220,90,1,0],
[115,145,280,115,2,0],
[145,190,355,145,2,0],
[190,240,455,190,2,0],
[240,310,585,240,3,1],
[310,395,750,310,4,2],
[395,505,955,395,4,3],
[505,650,1225,505,5,4],
[645,830,1570,645,6,5],//10
[825,1065,2005,825,7,6],
[1060,1360,2570,1060,9,7],
[1355,1740,3290,1355,11,8],
[1735,2230,4210,1735,13,9],
[2220,2850,5390,2220,15,10],
[2840,3650,6895,2840,18,12],
[3635,4675,8825,3635,22,14],
[4650,5980,11300,4650,27,16],
[5955,7655,14460,5955,32,18],
[7620,9800,18510,7620,38,20]//20
],
[//earthwallCost gid = 32
[0,0,0,0,0,0],
[120,200,0,80,1,0],
[155,255,0,100,1,0],
[195,330,0,130,2,0],
[250,420,0,170,2,0],
[320,535,0,215,2,0],
[410,685,0,275,3,1],
[530,880,0,350,4,2],
[675,1125,0,450,4,3],
[865,1440,0,575,5,4],
[1105,1845,0,740,6,5],//10
[1415,2360,0,945,7,6],
[1815,3020,0,1210,9,7],
[2320,3870,0,1545,11,8],
[2970,4950,0,1980,13,9],
[3805,6340,0,2535,15,10],
[4870,8115,0,3245,18,12],
[6230,10385,0,4155,22,14],
[7975,13290,0,5315,27,16],
[10210,17015,0,6805,32,18],
[13065,21780,0,8710,38,20]//20
],
[//palisadeCost gid = 33
[0,0,0,0,0,0],
[160,100,80,60,1,0],
[205,130,100,75,1,0],
[260,165,130,100,2,0],
[335,210,170,125,2,0],
[430,270,215,160,2,0],
[550,345,275,205,3,1],
[705,440,350,265,4,2],
[900,565,450,340,4,3],
[1155,720,575,430,5,4],
[1475,920,740,555,6,5],//10
[1890,1180,945,710,7,6],
[2420,1510,1210,905,9,7],
[3095,1935,1545,1160,11,8],
[3960,2475,1980,1485,13,9],
[5070,3170,2535,1900,15,10],
[6490,4055,3245,2435,18,12],
[8310,5190,4155,3115,22,14],
[10635,6645,5315,3990,27,16],
[13610,8505,6805,5105,32,18],
[17420,10890,8710,6535,38,20]//20
],
[//stonemasonCost gid = 34
[0,0,0,0,0,0],
[155,130,125,70,1,2],
[200,165,160,90,1,3],
[255,215,205,115,2,4],
[325,275,260,145,2,5],
[415,350,335,190,2,6],
[535,445,430,240,3,8],
[680,570,550,310,4,10],
[875,730,705,395,4,12],
[1115,935,900,505,5,14],
[1430,1200,1155,645,6,16],//10
[1830,1535,1475,825,7,18],
[2340,1965,1890,1060,9,20],
[3000,2515,2420,1355,11,22],
[3840,3220,3095,1735,13,24],
[4910,4120,3960,2220,15,26],
[6290,5275,5070,2840,18,29],
[8050,6750,6490,3635,22,32],
[10300,8640,8310,4650,27,35],
[13185,11060,10635,5955,32,38],
[16880,14155,13610,7620,38,41]//20
],
[//breweryCost gid = 35
[0,0,0,0,0,0],
[1460,930,1250,1740,5,6],
[2045,1300,1750,2435,6,9],
[2860,1825,2450,3410,7,12],
[4005,2550,3430,4775,8,15],
[5610,3575,4800,6685,10,18],
[7850,5000,6725,9360,12,22],
[10995,7000,9410,13100,14,26],
[15390,9805,13175,18340,17,30],
[21545,13725,18445,25680,21,34],
[30165,19215,25825,35950,25,38]//10
],
[//trapperCost gid = 36
[0,0,0,0,0,0],
[100,100,100,100,1,4],
[130,130,130,130,1,6],
[165,165,165,165,2,8],
[210,210,210,210,2,10],
[270,270,270,270,2,12],
[345,345,345,345,3,15],
[440,440,440,440,4,18],
[565,565,565,565,4,21],
[720,720,720,720,5,24],
[920,920,920,920,6,27],//10
[1180,1180,1180,1180,7,30],
[1510,1510,1510,1510,9,33],
[1935,1935,1935,1935,11,36],
[2475,2475,2475,2475,13,39],
[3170,3170,3170,3170,15,42],
[4055,4055,4055,4055,18,46],
[5190,5190,5190,5190,22,50],
[6645,6645,6645,6645,27,54],
[8505,8505,8505,8505,32,58],
[10890,10890,10890,10890,38,62]//20
],
[//herosMansionCost gid = 37
[0,0,0,0,0,0],
[700,670,700,240,1,2],
[930,890,930,320,1,3],
[1240,1185,1240,425,2,4],
[1645,1575,1645,565,2,5],
[2190,2095,2190,750,2,6],
[2915,2790,2915,1000,3,8],
[3875,3710,3875,1330,4,10],
[5155,4930,5155,1765,4,12],
[6855,6560,6855,2350,5,14],
[9115,8725,9115,3125,6,16],//10
[12125,11605,12125,4155,7,18],
[16125,15435,16125,5530,9,20],
[21445,20525,21445,7350,11,22],
[28520,27300,28520,9780,13,24],
[37935,36310,37935,13005,15,24],
[50450,48290,50450,17300,18,27],
[67100,64225,67100,23005,22,30],
[89245,85420,89245,30600,27,33],
[118695,113605,118695,40695,32,36],
[157865,151095,157865,54125,37,39]//20
],
[//greatWarehouseCost gid = 38
[0,0,0,0,0,0,0],
[650,800,450,200,1,1],
[830,1025,575,255,1,2],
[1065,1310,735,330,2,3],
[1365,1680,945,420,2,4],
[1745,2145,1210,535,2,5],
[2235,2750,1545,685,3,6],
[2860,3520,1980,880,4,7],
[3660,4505,2535,1125,4,8],
[4685,5765,3245,1440,5,9],
[5995,7380,4150,1845,6,10],//10
[7675,9445,5315,2360,7,12],
[9825,12090,6800,3020,9,14],
[12575,15475,8705,3870,11,16],
[16095,19805,11140,4950,13,18],
[20600,25355,14260,6340,15,20],
[26365,32450,18255,8115,18,22],
[33750,41540,23365,10385,22,24],
[43200,53170,29910,13290,27,26],
[55295,68055,38280,17015,32,28],
[70780,87110,49000,21780,38,30]//20
],
[//greatGranaryCost gid = 39
[0,0,0,0,0,0],
[400,500,350,100,1],
[510,640,450,130,1,2],
[655,820,575,165,2,3],
[840,1050,735,210,2,4],
[1075,1340,940,270,2,5],
[1375,1720,1205,345,3,6],
[1760,2200,1540,440,4,7],
[2250,2815,1970,565,4,8],
[2880,3605,2520,720,5,9],
[3690,4610,3230,920,6,10],//10
[4720,5905,4130,1180,7,12],
[6045,7555,5290,1510,9,14],
[7735,9670,6770,1935,11,16],
[9905,12380,8665,2475,13,18],
[12675,15845,11090,3170,15,20],
[16225,20280,14200,4055,18,22],
[20770,25960,18175,5190,22,24],
[26585,33230,23260,6645,27,26],
[34030,42535,29775,8505,32,28],
[43555,54445,38110,10890,38,30]//20
],
[//WWCost gid = 40
[0,0,0,0,0,0],
[66700,69050,72200,13200,0,1],
[68535,70950,74185,13565,0,2],
[70420,72900,76225,13935,0,3],
[72355,74905,78320,14320,0,4],
[74345,76965,80475,14715,0,5],
[76390,79080,82690,15120,0,6],
[78490,81255,84965,15535,0,7],
[80650,83490,87300,15960,0,8],
[82865,85785,89700,16400,0,9],
[85145,88145,92165,16850,0,10],//10
[87485,90570,94700,17315,0,12],
[89895,93060,97305,17790,0,14],
[92365,95620,99980,18280,0,16],
[94905,98250,102730,18780,0,18],
[97515,100950,105555,19300,0,20],
[100195,103725,108460,19830,0,22],
[102950,106580,111440,20375,0,24],
[105785,109510,114505,20935,0,26],
[108690,112520,117655,21510,0,28],
[111680,115615,120890,22100,0,30],//20
[114755,118795,124215,22710,0,33],
[117910,122060,127630,23335,0,36],
[121150,125420,131140,23975,0,39],
[124480,128870,134745,24635,0,42],
[127905,132410,138455,25315,0,45],
[131425,136055,142260,26010,0,48],
[135035,139795,146170,26725,0,51],
[138750,143640,150190,27460,0,54],
[142565,147590,154320,28215,0,57],
[146485,151650,158565,28990,0,60],//30
[150515,155820,162925,29785,0,64],
[154655,160105,167405,30605,0,68],
[158910,164505,172010,31450,0,72],
[163275,169030,176740,32315,0,76],
[167770,173680,181600,33200,0,80],
[172380,178455,186595,34115,0,84],
[177120,183360,191725,35055,0,88],
[181995,188405,197000,36015,0,92],
[186995,193585,202415,37005,0,96],
[192140,198910,207985,38025,0,100],//40
[197425,204380,213705,39070,0,105],
[202855,210000,219580,40145,0,110],
[208430,215775,225620,41250,0,115],
[214165,221710,231825,42385,0,120],
[220055,227805,238200,43550,0,125],
[226105,234070,244750,44745,0,130],
[232320,240505,251480,45975,0,135],
[238710,247120,258395,47240,0,140],
[245275,253915,265500,48540,0,145],
[252020,260900,272800,49875,0,150],//50
[258950,268075,280305,51245,0,156],
[266070,275445,288010,52655,0,162],
[273390,283020,295930,54105,0,168],
[280905,290805,304070,55590,0,174],
[288630,298800,312430,57120,0,180],
[296570,307020,321025,58690,0,186],
[304725,315460,329850,60305,0,192],
[313105,324135,338925,61965,0,198],
[321715,333050,348245,63670,0,204],
[330565,342210,357820,65420,0,210],//60
[339655,351620,367660,67220,0,217],
[348995,361290,377770,69065,0,224],
[358590,371225,388160,70965,0,231],
[368450,381435,398835,72915,0,238],
[378585,391925,409800,74920,0,245],
[388995,402700,421070,76985,0,252],
[399695,413775,432650,79100,0,259],
[410685,425155,444550,81275,0,266],
[421980,436845,456775,83510,0,273],
[433585,448860,469335,85805,0,280],//70
[445505,461205,482240,88165,0,288],
[457760,473885,495505,90590,0,296],
[470345,486920,509130,93080,0,304],
[483280,500310,523130,95640,0,312],
[496570,514065,537520,98270,0,320],
[510225,528205,552300,100975,0,328],
[524260,542730,567490,103750,0,336],
[538675,557655,583095,106605,0,344],
[553490,572990,599130,109535,0,352],
[568710,588745,615605,112550,0,360],//80
[584350,604935,632535,115645,0,369],
[600420,621575,649930,118825,0,378],
[616930,638665,667800,122090,0,387],
[633895,656230,686165,125450,0,396],
[651330,674275,705035,128900,0,405],
[669240,692820,724425,132445,0,414],
[687645,711870,744345,136085,0,423],
[706555,731445,764815,139830,0,432],
[725985,751560,785850,143675,0,441],
[745950,772230,807460,147625,0,450],//90
[766460,793465,829665,151685,0,460],
[787540,815285,852480,155855,0,470],
[809195,837705,875920,160140,0,480],
[831450,860745,900010,164545,0,490],
[854315,884415,924760,169070,0,500],
[877810,908735,950190,173720,0,510],
[901950,933725,976320,178495,0,520],
[926750,959405,1000000,183405,0,530],
[952235,985785,1000000,188450,0,540],
[1000000,1000000,1000000,193630,0,550]//100
],
[//horsedtCost gid = 41
[0,0,0,0,0,0],
[780,420,660,540,4,5],
[1000,540,845,690,4,8],
[1280,690,1080,885,5,11],
[1635,880,1385,1130,6,14],
[2095,1125,1770,1450,7,17],
[2680,1445,2270,1855,9,20],
[3430,1845,2905,2375,11,23],
[4390,2365,3715,3040,13,26],
[5620,3025,4755,3890,15,29],
[7195,3875,6085,4980,19,31],//10
[9210,4960,7790,6375,22,35],
[11785,6345,9975,8160,27,39],
[15085,8125,12765,10445,32,43],
[19310,10400,16340,13370,39,47],
[24720,13310,20915,17115,46,51],
[31640,17035,26775,21905,55,55],
[40500,21810,34270,28040,67,59],
[51840,27915,43865,35890,80,63],
[66355,35730,56145,45940,96,67],
[84935,45735,71870,58800,115,71]//20
]
];
// =============================================================================
//  end ---- var fOR beyond.
// =============================================================================

function initializeLangVars() {
switch (Xlang) {
// --------------------------------------------------------------------------------------------------------------------------------------------------------------------
// - The 03/02/2010 ------------- by Ptitfred06
// Modification : small word to have good view in tasklist
// - Small modification on word (translation).
// - comment what can be personnalise / and what can't 
// -----------------------------------------------------------------------
	case "fr": // thanks Tuga
// Texte détécté dans les page Travian (NE PAS CHANGER / No CHANGE !!!)
		aLangAllBuildWithId = ["Bûcheron", "Carrière de terre", "Mine de fer", "Ferme", "", "Scierie", "Usine de poteries", "Fonderie", "Moulin", "Boulangerie", "Dépôt de ressources", "Silo de céréales", "Armurerie", "Usine d'armures", "Place du tournoi", "Bâtiment principal", "Place de rassemblement", "Place du Marché", "Ambassade", "Caserne", "Écurie", "Atelier", "Académie", "Cachette", "Hôtel de ville", "Résidence", "Palais", "Chambre aux trésors", "Comptoir de commerce", "Grande Caserne", "Grande Écurie", "Mur d'enceinte", "Mur de terre", "Palissade", "Tailleur de Pierres", "Brasserie", "Fabricant de pièges","Manoir du héros", "Grand dépôt de ressources", "Grand silo de céréales", "Merveille du monde", "Abreuvoir"];
		aLangAllBuildAltWithId = [/*"Bûcheron"*/, "Carrière de Terre", /*"Mine de fer"*/, "Ferme de céréales", "", /*"Scierie"*/, "Usine de Poteries", /*"Fonderie", "Moulin"*/,/* "Boulangerie"*/, /*"Dépôt de ressources"*/, /*"Silo de céréales"*/, /*"Armurerie"*/, /*"Usine d'armures"*/, /*"Place du tournoi"*/, "Bâtiment Principal", /*"Place de rassemblement"*/, "Place du marché", /*"Ambassade"*/, /*"Caserne"*/, /*"Écurie"*/, /*"Atelier"*/, /*"Académie"*/, /*"Cachette"*/, "Hôtel de Ville", /*"Résidence"*/, /*"Palais"*/, /*"Chambre aux trésors"*/, "Comptoir de commerce", "Grande Caserne", "Grande Écurie", "Mur d'enceinte", "Mur de terre", "Palissade", "Tailleur de Pierres", "Brasserie", "Fabricant de pièges","Manoir du Héros", "Grand dépôt de ressources", "Grand silo de céréales", "Merveille du monde", "Abreuvoir"];

// <-- Peu être modifié / can be personnalize
		aLangAddTaskText = ["Ajouter tache", "Type", "Village actif", "Cible", "Vers", "Mode", "Aide Const.", "Quantité de ress.", "Bouger vers le haut", "Bouger vers le bas", "Effacer", "&#160;&#160;&#160;Taches", "Bouger ", "Eliminer toutes les tâches"];
		aLangTaskKind = ["Évol ", "N Cons ", "Att ", "Rech ", "Entrai ", "Trans ", "NPC", "Dém ", "Fête"];
//  -->

// <-- Peu être modifié / can be personnalize
		aLangGameText = ["Niv", "Marchands", "Id", "Capitale", "Temps début", "this timeseting is unuseful now.", "Vers", "Village", "Transport", "de", "Transport vers", "Transport de", "Retour de", "Ressources", "Bâtiment", "Construire un nouveau bâtiment", "Vide", "Niveau"];
// original 	aLangGameText = ["Niveau", "Marchands", "Identification", "Capitale", "Inicio", "this timeseting is unuseful now.", "Vers", "Village", "Transport", "de", "Transport vers", "Transport de", "Retour de", "Ressources", "Bâtiment", "Construire un nouveau bâtiment", "Vazio", "Niveau"];
// -->	fin	

		aLangRaceName = ["Romains", "Germains","Gaulois"];
// <-- Peu être modifié
		aLangTaskOfText = ["Planifier evolution", "Planifier nouvelle construction", "RessUpD", "OFF", "Comencer", "ON", "Arreter", "La distribution des champs de ce village est ", "AutoT", "Auto transport n est pas ouvert", "Ouvert", "Transport avec succès", "Taches", "Limit", "Defaut", "Modifier", "Bois/Terre/Fer", "Céréales", "Planification de demolition", "Planif.Attaque", "Type d´attaque", "Temps de voyage", "Repeter numero de fois", "Temps de intervales","00:30:00","Cible catapulte","Aléatoire", "Inconnu", " Fois", "/", " ", "Troupes envoyées", "Planification d´entrainement","Train ubication","Planification d´entrainement fini","TransP","Setup Interval Time of Reload","This is the interval of page reload ,\n default sont 20 minutes, Insérer nouveau temps:\n\n","Remain","Planifier fête","petite fête","grande fête","Set Interval of Ressources concentration","minutes",".",".","START","STOP","Planifier entrainement","Augmenter Attaque","Augmenter Defense", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
// -->> fin
// < ne pas change / no change !!! Detected for the feedback error.
		aLangErrorText = ["Pas assez de ressources", "Les ouvriers sont déjà au travail", "Construction complète", "Début de la construction", "Dans développement", "Son Dépôt de ressources est petit. Évolue son Dépôt de ressources pour continuer sa construction", "Son silo de céréales est petit. Évolue son Silo de céréales pour continuer sa construction", "Ressources suffisantes","Une fête est déjà organisée"];
// -->> fin
		aLangOtherText = ["Il remarque important", "Seulement les champs de ressources du capitale <br/>peuvent être élevés à niveau 20. Son capital <br/> n'est pas décelable. S'il vous plaît il visite son profil.", "Raccourci ici ^_^", "Installation conclue", "Annulé", "Initier les tâches", "Upgrade avec succès", "Exécuter avec succès", "Sa race est inconnue, et son type de troupe aussi. <br/>Il visite son profil pour déterminer la race.<br/>", "S'il vous plaît il visite sa Manoir du héros pour déterminer<br/>la vitesse et le type de héros."];
		aLangResources=["Bois","Terre","Fer","Céréales"];
		aLangTroops[0] = ["Légionnaire", "Prétorien", "Impérian", "Equites Legati", "Equites Imperatoris", "Equites Caesaris", "Bélier", "Catapulte de feu", "Sénateur", "Colon", "Héros"];
		aLangTroops[1] = ["Combattant au gourdin", "Combattant à la lance", "Combattant à la hache", "Eclaireur", "Paladin", "Cavalier Teuton", "Bélier", "Catapulte", "Chef de tribu", "Colon", "Héros"];

// <-- NE PAS modifier // Utilisé dans plannification d'attaque, dans recherche de niveau suppèrieur / NO CHANGE !!
		aLangTroops[2] = ["Phalange", "Combattant à l'épée", "Eclaireur", "Eclair de Toutatis", "Cavalier druide", "Hédouin", "Bélier", "Catapulte de Guerre", "Chef", "Colon", "Héros"];
// original	aLangTroops[2] = ["Phalange", "Combattant à l'épée", "Eclaireur", "Eclair de Toutatis", "Cavalier druide", "Hédouin", "Bélier", "Catapulte de Guerre", "Chef", "Colon", "Héros"];

// <-- Peu être modifié // Label des taches / CAN BE CHANGE
// original	aLangAttackType = ["Assistance", "Attaque", "Pillage"];
		aLangAttackType = ["Ass.", "Att.", "Pill."];
// -->		
		break;
// -------------------------------------------------------------------------------------------------------------------------------

	case "cc": // 2011.02.13 -- yesren
	case "cn": // 感谢K.C.Alvis
		aLangAllBuildWithId = ["伐木场", "黏土矿", "铁矿场", "农场", "", "木材厂", "砖块厂", "铸造厂", "磨坊", "面包房", "仓库", "粮仓", "铁匠铺", "军械库", "竞技场", "中心大楼", "集结点", "市场", "大使馆", "兵营", "马厩", "工场", "研发所", "山洞", "市政厅", "行宫", "皇宫", 
			"宝库", "交易所", "大兵营", "大马厩", "罗马城墙", "日尔曼城墙", "高卢城墙", "石匠铺", "酿酒厂", "陷阱机", "英雄园", "大仓库", "大粮仓", "世界奇观", "饮马槽"];
		aLangAllBuildAltWithId = ["伐木场", "黏土矿", "铁矿场", "农场", "", "木材厂", "砖块厂", "铸造厂", "磨坊", "面包房", "仓库", "粮仓", "铁匠铺", "军械库", "竞技场", "中心大楼", "集结点", "市场", "大使馆", "兵营", "马厩", "工场", "研发所", "山洞", "市政厅", "行宫", "皇宫", 
			"宝库", "交易所", "大兵营", "大马厩", "罗马城墙", "日尔曼城墙", "高卢城墙", "石匠铺", "酿酒厂", "陷阱机", "英雄园", "大仓库", "大粮仓", "世界奇观", "饮马槽"];
		aLangAddTaskText = ["添加任务", "任务类型", "所在村", "任务对象", "目标", "模式", "支援建设", "资源集中", "上移", "下移", "删除", "任务内容", "移动", "清除所有任务"];
		aLangTaskKind = ["升级", "新建", "攻击", "研发", "训练", "运输", "活动", "拆除", "定制运输"];
		aLangGameText = ["等级", "商人", "坑号", "主村", "执行时间", "此时间设置目前无效", "到", "村庄", "运送", "回来", "向", "来自于", "从", "资源", "建筑", "建造新的建筑", "空", "等级"];
		aLangRaceName = ["罗马人", "日尔曼人", "高卢人"];
		aLangTaskOfText = ["预定升级", "预定新建", "资源自动升级", "尚未开启", "马上开启", "已经开启", "点击关闭", "该村资源田分布", "自动运输", "自动运输尚未设定", "已设定", "运送成功", "任务列表", "资源输入限额", "默认", "更改", "木/泥/铁", "粮食", "预定拆除",
			"预定发兵", "攻击类型", "到达所需时间", "重复次数", "间隔时间", "00:30:00", "投石目标", "随机", "未知", "次", "月", "日", "部队已发出","预定训练","训练设施","训练任务已执行","定制运输","设定页面刷新间隔",
			"页面刷新的间隔时间，是指隔多久执行一次页面的自动载入。\n此时间过短，会增加被系统侦测到的危险，过长则影响任务执行的效率。\n默认为20分钟，请输入新的时间间隔：\n\n","资源输出保留","预定活动","小型活动","大型活动","资源集中模式的运输间隔",
			"分钟","暂停中","开启中","开启","暂停","预定改良","改良攻击","改良防御", "资源过剩检查", "已经开启", "已经关闭", "粮田自动升级", "切换"];
		aLangErrorText = ["资源不足", "已经有建筑在建造中", "建造完成", "将马上开始全部建造", "在开发中", "建造所需资源超过仓库容量上限,请先升级你的仓库", "建造所需资源超过粮仓容量上限,请先升级你的粮仓", "资源何时充足时间提示","粮食产量不足: 需要先建造一个农场","一个活动正在举行中"];
		aLangOtherText = ["重要提示", "只有主村的资源田可以升级到20，<br />目前主村尚未识别，点击个人资料<br />页面可以解决这一问题", "五星级传送门^_^", "已经设置完成", "已经取消", "开始执行任务", "升级成功", "已顺利执行", "种族尚未确认，兵种也就无法确定，<br />请点击个人资料页面，以便侦测种族", "然后，请顺便访问英雄园，以便确认<br />英雄的种类和速度。<br />"];
		aLangResources=["木材","泥土","铁块","粮食"];
		aLangTroops[0] = ["古罗马步兵", "禁卫兵", "帝国兵", "使节骑士", "帝国骑士", "将军骑士", "冲撞车", "火焰投石器", "参议员", "拓荒者", "英雄"];
		aLangTroops[1] = ["棍棒兵", "矛兵", "斧头兵", "侦察兵", "圣骑士", "日耳曼骑兵", "冲撞车", "投石器", "执政官", "拓荒者", "英雄"];
		aLangTroops[2] = ["方阵兵", "剑士", "探路者", "雷法师", "德鲁伊骑兵", "海顿圣骑士", "冲撞车", "投石器", "首领", "拓荒者", "英雄"];
		aLangAttackType = ["支援", "攻击", "抢夺"];
		break;
		
	case "hk": // 感谢sean3808、K.C.Alvis
		aLangAllBuildWithId = ["伐木場", "泥坑", "鐵礦場", "農場","", "鋸木廠", "磚廠", "鋼鐵鑄造廠", "麵粉廠", "麵包店", "倉庫", "穀倉", "鐵匠", "盔甲廠", "競技場", "村莊大樓", "集結點", "市場", "大使館", "兵營", "馬棚", "工場", "研究院", "山洞", "村會堂", "行宮", "皇宮", "寶物庫", "交易所", "大兵營", "大馬棚", "城牆", "土牆", "木牆", "石匠鋪", "釀酒廠", "陷阱", "英雄宅", "大倉庫", "大穀倉", "世界奇觀", "放牧水槽"];
		aLangAllBuildAltWithId = ["伐木場", "泥坑", "鐵礦場", "農場","", "鋸木廠", "磚廠", "鋼鐵鑄造廠", "麵粉廠", "麵包店", "倉庫", "穀倉", "鐵匠", "盔甲廠", "競技場", "村莊大樓", "集結點", "市場", "大使館", "兵營", "馬棚", "工場", "研究院", "山洞", "城鎮廳", "行宮", "皇宮", "寶物庫", "交易所", "大兵營", "大馬棚", "城牆", "土牆", "木牆", "石匠鋪", "釀酒廠", "陷阱機", "英雄宅", "大倉庫", "大穀倉", "世界奇觀", "放牧水槽"];
		aLangAddTaskText = ["添加任務", "任務類型", "所在村", "任務對象", "目標", "模式", "支援建設", "資源集中", "上移", "下移", "刪除", "任務內容", "移動", "清除所有任務"];
		aLangTaskKind = ["升級", "新建", "攻擊", "研發", "訓練", "運輸", "平倉", "拆除", "活動"];
		aLangGameText = ["等級", "商人", "坑號", "主村", "執行時間", "該時間設置尚未啟用", "到", "村莊", "運送", "回來", "運輸到", "從", "由", "資源", "建築", "建造新的建築物", "empty", "等級"];
		aLangRaceName = ["羅馬人", "條頓人", "高盧人"];
		aLangTaskOfText = ["預定升級", "預定建築", "資源自動升級", "尚未開啟", "馬上開啟", "已經開啟", "點擊關閉", "該村資源分布", "自動運輸", "自動運輸尚未設定", "已設定", "運送成功", "任務列表", "資源輸入限額", "默認", "更改", "木/磚/鐵", "穀物", "預定拆除",
			"預定發兵", "攻擊類型", "到達所需時間", "重複次數", "間隔時間", "00:30:00", "投石目標", "隨機", "未知", "次", "月", "日", "部隊已發出","預定訓練","訓練設施","訓練任務已執行","定制運輸","設定頁面刷新間隔","頁面刷新的間隔時間，是指隔多久執行一次頁面的自動載入。\n此時間過短，會增加被系統偵測到的危險，過長則影響任務執行的效率。\n默認為20分鐘，請輸入新的時間間隔：\n\n","資源輸出保留","預定活動","小型活動","大型活動","資源集中模式的間隔時間",
			"分鐘","暫停中","開啟中","開啟","暫停","預定改良","改良攻擊","改良防御", "資源過剩檢查", "已經開啟", "已經關閉", "糧田自動升級", "切換"];
		aLangErrorText = ["資源不足", "工作正在進行中", "完全地開發", "將馬上開始全部建造", "在開發中", "倉庫需要升級", "糧倉需要升級", "資源何時充足時間提示","糧食產量不足: 需要先建造一個農場","派對進行中"];
		aLangOtherText = ["重要提示", "只有主村的資源田可以升級到20，<br/>目前主村尚未識別，點擊個人資料<br/>頁面可以解決這一問題", "五星級傳送門^_ ^", "已經設置完成", "已經取消", "開始執行任務", "升級成功", "已順利執行", "種族尚未確認，兵種也就無法確定，<br/>請點擊個人資料頁面，以便偵測種族", "然後，請順便訪問英雄園，以便確認<br/>英雄的種類和速度。<br/>"];
		aLangResources=["木材","磚塊","鋼鐵","穀物"];
		aLangTroops[0] = ["古羅馬步兵", "禁衛兵", "帝國兵", "使者騎士", "帝國騎士", "將軍騎士", "衝撞車", "火焰投石機", "參議員", "開拓者", "英雄"];
		aLangTroops[1] = ["棍棒兵", "矛兵", "斧頭兵", "偵察兵", "遊俠", "條頓騎士", "衝撞車", "投石機", "司令官", "開拓者", "英雄"];
		aLangTroops[2] = ["方陣兵", "劍士", "探路者", "雷法師", "德魯伊騎兵", "海頓聖騎", "衝撞車", "投石機", "族長", "開拓者", "英雄"];
		aLangAttackType = ["支援", "攻擊", "搶奪"];
		break;

	case "tw": // 感谢adobe、魎皇鬼、ieyp、K.C.Alvis
		aLangAllBuildWithId = ["伐木場", "泥坑", "鐵礦場", "農場", "農田", "鋸木廠", "磚廠", "鋼鐵鑄造廠", "麵粉廠", "麵包店", "倉庫", "穀倉", "鐵匠", "盔甲廠", "競技場", "村莊大樓", "集結點", "市場", "大使館", "兵營", "馬廄", "工場", "研究院", "山洞", "村會堂", "行宮", "皇宮", "寶物庫", "交易所", "大兵營", "大馬廄", "城牆", "土牆", "木牆", "石匠舖", "釀酒廠", "陷阱機", "英雄宅", "大倉庫", "大穀倉", "世界奇觀", "放牧水槽"];
		aLangAllBuildAltWithId = ["伐木場", "泥坑", "鐵礦場", "農場", "農田", "鋸木廠", "磚廠", "鋼鐵鑄造廠", "麵粉廠", "麵包店", "倉庫", "穀倉", "鐵匠", "盔甲廠", "競技場", "村莊大樓", "集結點", "市場", "大使館", "兵營", "馬廄", "工場", "研究院", "山洞", "村會堂", "行宮", "皇宮", "寶物庫", "交易所", "大兵營", "大馬廄", "城牆", "土牆", "木牆", "石匠舖", "釀酒廠", "陷阱機", "英雄宅", "大倉庫", "大穀倉", "世界奇觀", "放牧水槽"];
		aLangAddTaskText = ["添加任務", "任務類型", "所在村", "任務對象", "目標", "模式", "支援建設", "資源集中", "上移", "下移", "刪除", "任務內容", "移動", "清除所有任務"];
		aLangTaskKind = ["升級", "新建", "攻擊", "研發", "訓練", "運輸", "平倉", "拆除", "活動"];
		aLangGameText = ["等級", "商人", "坑號", "主村", "執行時間", "該時間設置尚未啟用", "到", "村莊", "運送", "回來", "運送到", "從", "由", "資源", "建築", "建造新的建築物", "empty", "等級"];
		aLangRaceName = ["羅馬人", "條頓人", "高盧人"];
		aLangTaskOfText = ["預定升級", "預定建築", "資源自動升級", "尚未開啟", "馬上開啟", "已經開啟", "點擊關閉", "該村資源分布", "自動運輸", "自動運輸尚未設定", "已設定", "運送成功", "任務列表", "資源輸入限額", "默認", "更改", "木/磚/鐵", "穀物", "預定拆除",
			"預定發兵", "攻擊類型", "到達所需時間", "重複次數", "間隔時間", "00:30:00", "投石目標", "隨機", "未知", "次", "月", "日", "部隊已發出","預定訓練","訓練設施","訓練任務已執行","定制運輸","設定頁面刷新間隔","頁面刷新的間隔時間，是指隔多久執行一次頁面的自動載入。\n此時間過短，會增加被系統偵測到的危險，過長則影響任務執行的效率。\n默認為20分鐘，請輸入新的時間間隔：\n\n","資源輸出保留","預定活動","小型活動","大型活動","資源集中模式的間隔時間",
			"分鐘","暫停中","開啟中","開啟","暫停","預定改良","改良攻擊","改良防御", "資源過剩檢查", "已經開啟", "已經關閉", "糧田自動升級", "切換"];
		aLangErrorText = ["資源不足", "已經有建築在建造中", "建造完成", "將馬上開始全部建造", "在開發中", "建造所需資源超過倉庫容量上限,請先升級你的倉庫", "建造所需資源超過糧倉容量上限,請先升級你的糧倉", "資源何時充足時間提示","糧食產量不足: 需要先建造一個農場","派對進行中"];
		aLangOtherText = ["重要提示", "只有主村的資源田可以升級到20，<br/>目前主村尚未識別，點擊個人資料<br/>頁面可以解決這一問題", "五星級傳送門^_ ^", "已經設置完成", "已經取消", "開始執行任務", "升級成功", "已順利執行", "種族尚未確認，兵種也就無法確定，<br/>請點擊個人資料頁面，以便偵測種族", "然後，請順便訪問英雄園，以便確認<br/>英雄的種類和速度。<br/>"];
		aLangResources=["木材","磚塊","鋼鐵","穀物"];
		aLangTroops[0] = ["古羅馬步兵", "禁衛兵", "帝國兵", "使者騎士", "帝國騎士", "將軍騎士", "衝撞車", "火焰投石機", "參議員", "開拓者", "英雄"];
		aLangTroops[1] = ["棍棒兵", "矛兵", "斧頭兵", "偵察兵", "遊俠", "條頓騎士", "衝撞車", "投石機", "司令官", "開拓者", "英雄"];
		aLangTroops[2] = ["方陣兵", "劍士", "探路者", "雷法師", "德魯伊騎兵", "海頓聖騎", "衝撞車", "投石機", "族長", "開拓者", "英雄"];
		aLangAttackType = ["支援", "攻擊", "搶奪"];
		break;

	case "fi": // thanks Christer82
		aLangAllBuildWithId = ["Puunhakkaaja", "Savimonttu", "Rautakaivos", "Viljapelto", "", "Saha", "Tiilitehdas", "Rautavalimo", "Mylly", "Leipomo", "Varasto", "Viljasiilo", "Aseseppä", "Haarniskapaja", "Turnausareena", "Päärakennus", "Kokoontumispiste", "Tori", "Lähetystö", "Kasarmi", "Talli", "Työpaja", "Akatemia", "Kätkö", "Kaupungintalo", "Virka-asunto", "Palatsi", "Aarrekammio", "Kauppavirasto", "Suuri kasarmi", "Suuri talli", "Kaupungin muuri", "Maamuuri", "Paaluaita", "Kivenhakkaaja", "Panimo", "Ansoittaja","Sankarin kartano", "Suuri varasto", "Suuri viljasiilo", "Maailmanihme", "Hevostenjuottoallas"];
		aLangAllBuildAltWithId = ["Puunhakkaaja", "Savimonttu", "Rautakaivos", "Viljapelto", "", "Saha", "Tiilitehdas", "Rautavalimo", "Mylly", "Leipomo", "Varasto", "Viljasiilo", "Aseseppä", "Haarniskapaja", "Turnausareena", "Päärakennus", "Kokoontumispiste", "Tori", "Lähetystö", "Kasarmi", "Talli", "Työpaja", "Akatemia", "Kätkö", "Kaupungintalo", "Virka-asunto", "Palatsi", "Aarrekammio", "Kauppavirasto", "Suuri kasarmi", "Suuri talli", "Kaupungin muuri", "Maamuuri", "Paaluaita", "Kivenhakkaaja", "Panimo", "Ansoittaja","Sankarin kartano", "Suuri varasto", "Suuri viljasiilo", "Maailmanihme", "Hevostenjuottoallas"];
		aLangAddTaskText = ["Lisää tehtävä", "Tyyli", "Kohdistettu kylä", "Tehtävän kohde", "Minne:", "Tyyppi", "Rakennustuki", "Resurssien keskittäminen", "Siirry ylös", "Siirry alas", "Poista", "&#160;&#160;&#160;Tehtävän sisältö", "Siirry ", "Poista kaikki tehtävät"];
		aLangTaskKind = ["Päivitä", "Uusi rakennus", "Hyökkäys", "Tutkimus", "Koulutus", "Kuljetus", "NPC", "Hajotus", "Juhla"];
		aLangGameText = ["Taso", "Kauppiaat", "ID", "Pääkaupunki", "Aloitusaika", "Tätä aika-asetusta ei voi nyt käyttää.", "minne:", "Kylä", "kuljetus", "mistä", "Kuljeta kylään", "Kuljeta kylästä", "Palaa kylästä", "Resurssit", "rakennus", "Rakenna uusi rakennus", "tyhjä", "taso"];
		aLangRaceName = ["Roomalaiset", "Teutonit", "Gallialaiset"];
		aLangTaskOfText = ["Aseta kentän päivitys", "Aseta uusi rakennuskohde", "Automaattinen resurssipäivitys", "Ei toimintaa", "Aloita", "Aloitettu", "Keskeytä", "Tämän kylän resurssikenttien jakauma on ", "Automaattikuljetus", "automaattikuljetusta ei ole avattu", "Avattu", "Kuljetus onnistui", "Tehtäväluettelo", "Trans_In_limit", "Perusasetus", "Muokkaa", "Puu/Savi/Rauta", "vilja", "Tehtävälistan poisto",
			"Schedule attack", "Hyökkäystyyppi", "Kuljetusaika", "toistokerrat", "Hyökkäysaikaväli","00:30:00","Katapultin kohde","Satunnainen", "Tuntematon", "kertaa", "Kuukausi", "Päivä", "Joukot on lähetetty","Aseta koulutustehtävä","Koulutuskohde","Koulutustehtävä suoritettu","waitForTranslate","setup Hyökkäysaikaväli of reload","this is the interval of page reload ,\n default is 20 minutes, please insert new time:\n\n","Trans_Out_Rmn","ScheduleParty","small party","big party","setInterval of Resources concentration",
			"minutes","pausing","running","run","pause","Schedule Improve","Improve Attack","Improve defence", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		aLangErrorText = ["Liian vähän resursseja", "Työntekijät ovat jo töissä.", "Rakennuskohde valmis", "Aloitetaan rakentaminen", "Työ kesken", "Varastosi on liian pieni. Suurenna varastoa aloittaaksesi rakentamisen", "Viljasiilosi on liian pieni. Suurenna viljasiiloa aloittaaksesi rakentamisen", "Riittävästi resursseja"];
		aLangOtherText = ["Tärkeä huomautus", "Vain pääkaupungin resurssikenttiä voidaan <br/>päivittää tasolle 20. Nyt pääkaupunkia<br/> ei voida todentaa. Päivitä profiiliasi, kiitos.", "Pikalinkki tähän ^_^", "Asennus valmis", "Peruttu", "Aloita tehtävät", "Päivitys valmis", "Tehty onnistuneesti", "Heimosi on määrittämätön, siksi joukkojesi tyyppiä <br/>Päivitä profiiliasi heimon määrittämiseksi.<br/>", "Käy Sankarin kartanossa määrittääksesi<br/> sankarisi tyypin ja nopeuden."];
		aLangResources=["waitTranslate","waitTranslate","waitTranslate","waitTranslate"];
		aLangTroops[0] = ["Legioonalainen", "Pretoriaani", "Imperiaani", "Equites Legati", "Equites Imperatoris", "Equites Caesaris", "Muurinmurtaja", "Tulikatapultti", "Senaattori", "Uudisasukas", "Sankari"];
		aLangTroops[1] = ["Nuijamies", "Keihäsmies", "Kirvessoturi", "Tiedustelija", "Paladiini", "Teutoniritari", "Muurinmurtaja", "Katapultti", "Päällikkö", "Uudisasukas", "Sankari"];
		aLangTroops[2] = ["Falangi", "Miekkasoturi", "Tunnustelija", "Teutateksen salama", "Druidiratsastaja", "Haeduaani", "Muurinmurtaja", "Heittokone", "Päällikkö", "Uudisasukas", "Sankari"];
		aLangAttackType = ["Vahvistus", "Hyökkäys", "Ryöstö"];
		break;

	case "us": // by shadowx360
		aLangAllBuildWithId = ["Woodcutter", "Clay Pit", "Iron Mine", "Wheat Field", "", "Sawmill", "Brickworks", "Iron Foundry", "Flour Mill", "Bakery", "Warehouse", "Granary", "Blacksmith", "Armory", "Tournament Square", "Main Building", "Rally Point", "Marketplace", "Embassy", "Barracks", "Stable", "Siege Workshop", "Academy", "Cranny", "Town Hall", "Residence", "Palace", "Treasury", "Trade Office", "Great Barracks", "Great Stable", "City Wall", "Earth Wall", "Palisade", "Stonemason's Lodge", "Brewery", "Trapper","Hero's Mansion", "Great Warehouse", "Great Granary", "Wonder Of The World", "Horse Drinking Pool"];
		aLangAllBuildAltWithId = ["Woodcutter", "Clay Pit", "Iron Mine", "Wheat Field", "", "Sawmill", "Brickworks", "Iron Foundry", "Flour Mill", "Bakery", "Warehouse", "Granary", "Blacksmith", "Armory", "Tournament Square", "Main Building", "Rally Point", "Marketplace", "Embassy", "Barracks", "Stable", "Siege Workshop", "Academy", "Cranny", "Town Hall", "Residence", "Palace", "Treasury", "Trade Office", "Great Barracks", "Great Stable", "City Wall", "Earth Wall", "Palisade", "Stonemason's Lodge", "Brewery", "Trapper","Hero's Mansion", "Great Warehouse", "Great Granary", "Wonder Of The World", "Horse Drinking Pool"];
		aLangAddTaskText = ["Add task", "Style", "Active village", "Task target", "To", "Mode", "Construction support", "Resources concentration", "Move up", "Move down", "Del", "   Task contents", "Move ", "Delete all the tasks"];
		aLangTaskKind = ["Upgrade", "NewBuild", "Attack", "Research", "Train", "Transport", "NPC", "Demolish", "Celebration"];
		aLangGameText = ["Lvl", "Merchants", "ID", "Capital", "Start time", "this timeseting is notuseful now.", "to", "Village", "transport", "from", "Transport to", "Transport from", "Return from", "resources", "building", "Construct a new building", "empty", "level"];
		aLangRaceName = ["Romans", "Teutons", "Gauls"];
		aLangTaskOfText = ["Schedule Upgrade", "Schedule NewBuild", "Auto ResUpD", "Not_run", "Start", "Started", "Suspend", "The resource fields distribution of this village is ", "Autotransport", "Autotransport is not opened", "Opened", "Transport successfully", "Task List", "Trans In limit", "Default", "Modify", "Wood/Clay/Iron", "Wheat", "Schedule demolition",
			"Schedule attack", "Attack type", "Travel time", "repeat times", "interval time","00:30:00","Catapult target","Random", "Unknown", "times", "Month", "Day", "Troops sent",
			"Schedule Train", "Train site", "TrainTask done", "customTransport", "setup interval time of reload","this is the interval of page reload ,\n default is 20 minutes, please insert new time:\n\n","Trans Out Rmn","ScheduleParty","small party","big party","setInterval of Resources concentration",
			"minutes", ".",".","START","STOP","Schedule Improve","Improve Attack","Improve defence", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		aLangErrorText = ["Too few resources.", "Your builders are already working", "completely upgraded", "Starting construction", "In development", "Your Warehouse is too small. Please upgrade your Warehouse to continue your construction", "Your Granary is too small. Please upgrade your Granary to continue your construction", "Enough resources","Lack of food: extend cropland first","There is already a celebration going on"];
		aLangOtherText = ["Important note", "Only the resource fields of the capital can <br/>be upgraded to level 20. Now your capital<br/> is not detected. Visit your Profile please.", "Shortcut here ^_^", "Setup completed", "Cancelled", "Start the tasks", "Upgrade successfully", "Run successfully", "Your race is unknown, therefore your troop type. <br/>Visit your Profile to determine your race.<br/>", "Please also visit your Hero's Mansion to determine<br/> the speed and the type of your hero."];
		aLangResources=["lumber","clay","iron","wheat"];
		aLangTroops[0] = ["Legionnaire", "Praetorian", "Imperian", "Equites Legati", "Equites Imperatoris", "Equites Caesaris", "Battering Ram", "Fire Catapult", "Senator", "Settler", "Hero"];
		aLangTroops[1] = ["Clubswinger", "Spearman", "Axeman", "Scout", "Paladin", "Teutonic Knight", "Ram", "Catapult", "Chief", "Settler", "Hero"];
		aLangTroops[2] = ["Phalanx", "Swordsman", "Pathfinder", "Theutates Thunder", "Druidrider", "Haeduan", "Ram", "Trebuchet", "Chieftain", "Settler", "Hero"];
		aLangAttackType = ["Reinforce", "Attack", "Raid"];
		break;

	case "in":
		switch ( aTravianVersion ) {
			case "3.6": // translations for travian version 3.6
				aLangAllBuildWithId = ["Woodcutter", "Clay Pit", "Iron Mine", "Wheat Field", "", "Sawmill", "Brickworks", "Iron Foundry", "Flour Mill", "Bakery", "Warehouse", "Granary", "Blacksmith", "Armoury", "Tournament Square", "Main Building", "Rally Point", "Marketplace", "Embassy", "Barracks", "Stable", "Siege Workshop", "Academy", "Cranny", "City Hall", "Residence", "Palace", "Treasure Chamber", "Trade Office", "Great Barracks", "Great Stable", "City Wall", "Earth Wall", "Palisade", "Stonemason", "Brewery", "Trapper", "Hero's Mansion", "Great Warehouse", "Great Granary", "Wonder Of The World", "Horse Drinking Pool"];
				aLangAllBuildAltWithId = ["Woodcutter", "Clay Pit", "Iron Mine", "Wheat Field", "", "Sawmill", "Brickworks", "Iron Foundry", "Flour Mill", "Bakery", "Warehouse", "Granary", "Blacksmith", "Armoury", "Tournament Square", "Main Building", "Rally Point", "Marketplace", "Embassy", "Barracks", "Stable", "Siege Workshop", "Academy", "Cranny", "City Hall", "Residence", "Palace", "Treasure Chamber", "Trade Office", "Great Barracks", "Great Stable", "City Wall", "Earth Wall", "Palisade", "Stonemason", "Brewery", "Trapper", "Hero's Mansion", "Great Warehouse", "Great Granary", "Wonder Of The World", "Horse Drinking Pool"];
				aLangAddTaskText = ["Add task", "Style", "Active village", "Task target", "To", "Mode", "Construction support", "Resources concentration", "Move up", "Move down", "Del", "&#160;&#160;&#160;Task contents", "Move ", "Delete all the tasks"];
				aLangTaskKind = ["Upgrade", "NewBuild", "Attack", "Research", "Train", "Transport", "NPC", "Demolish", "Celebration"];
				aLangGameText = ["Lvl", "Merchants", "ID", "Capital", "Start time", "this timeseting is unuseful now.", "to", "Village", "transport", "from", "Transport to", "Transport from", "Return from", "resources", "building", "Construct a new building", "empty", "level"];
				aLangRaceName = ["Romans", "Teutons", "Gauls"];
				aLangTaskOfText = ["Schedule Upgrade", "Schedule NewBuild", "Auto ResUpD", "Not_run", "Start", "Started", "Suspend", "The resource fields distribution of this village is ", "Autotransport", "Autotransport is not opened", "Opened", "Transport successfully", "Task List", "Trans In limit", "Default", "Modify", "Wood/Clay/Iron", "Crop", "Schedule demolition",
						"Schedule attack", "Attack type", "Travel time", "repeat times", "interval time", "00:30:00", "Catapult target", "Random", "Unknown", "times", "Month", "Day", "Troops sent",
						"Schedule Train", "Train site", "TrainTask done", "customTransport", "setup interval time of reload", "this is the interval of page reload ,\n default is 20 minutes, please insert new time:\n\n", "Trans Out Rmn", "ScheduleParty", "small party", "big party", "setInterval of Resources concentration",
						"minutes", ".", ".", "START", "STOP", "Schedule Improve", "Improve Attack", "Improve defence", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
				aLangErrorText = ["Too few resources.", "Your workers are already building something.", "Construction completed", "Starting construction", "In development", "Your Warehouse is too small. Please upgrade your Warehouse to continue your construction", "Your Granary is too small. Please upgrade your Granary to continue your construction", "Enough resources", "Food shortage: Upgrade a wheat field first", "There is already a celebration going on"];
				aLangOtherText = ["Important note", "Only the resource fields of the capital can <br/>be upgraded to level 20. Now your capital<br/> is not detected. Visit your Profile please.", "Shortcut here ^_^", "Setup completed", "Cancelled", "Start the tasks", "Upgrade successfully", "Run successfully", "Your race is unknown, therefore your troop type. <br/>Visit your Profile to determine your race.<br/>", "Please also visit your Hero's Mansion to determine<br/> the speed and the type of your hero."];
				aLangResources = ["lumber", "clay", "iron", "crop"];
				aLangTroops[0] = ["Legionnaire", "Praetorian", "Imperian", "Equites Legati", "Equites Imperatoris", "Equites Caesaris", "Battering Ram", "Fire Catapult", "Senator", "Settler", "Hero"];
				aLangTroops[1] = ["Clubswinger", "Spearman", "Axeman", "Scout", "Paladin", "Teutonic Knight", "Ram", "Catapult", "Chief", "Settler", "Hero"];
				aLangTroops[2] = ["Phalanx", "Swordsman", "Pathfinder", "Theutates Thunder", "Druidrider", "Haeduan", "Ram", "Trebuchet", "Chieftain", "Settler", "Hero"];
				aLangAttackType = ["Reinforce", "Attack", "Raid"];
				break;
			case "4.0": // translations for travian version 4.0
				aLangAllBuildWithId = ["Woodcutter", "Clay Pit", "Iron Mine", "Wheat Field", "", "Sawmill", "Brickworks", "Iron Foundry", "Flour Mill", "Bakery", "Warehouse", "Granary", "Blacksmith", "Smithy", "Tournament Square", "Main Building", "Rally Point", "Marketplace", "Embassy", "Barracks", "Stable", "Siege Workshop", "Academy", "Cranny", "City Hall", "Residence", "Palace", "Treasure Chamber", "Trade Office", "Great Barracks", "Great Stable", "City Wall", "Earth Wall", "Palisade", "Stonemason", "Brewery", "Trapper", "Hero's Mansion", "Great Warehouse", "Great Granary", "Wonder Of The World", "Horse Drinking Pool"];
				aLangAllBuildAltWithId = ["Woodcutter", "Clay Pit", "Iron Mine", "Wheat Field", "", "Sawmill", "Brickworks", "Iron Foundry", "Flour Mill", "Bakery", "Warehouse", "Granary", "Blacksmith", "Smithy", "Tournament Square", "Main Building", "Rally Point", "Marketplace", "Embassy", "Barracks", "Stable", "Siege Workshop", "Academy", "Cranny", "City Hall", "Residence", "Palace", "Treasure Chamber", "Trade Office", "Great Barracks", "Great Stable", "City Wall", "Earth Wall", "Palisade", "Stonemason", "Brewery", "Trapper", "Hero's Mansion", "Great Warehouse", "Great Granary", "Wonder Of The World", "Horse Drinking Pool"];
				aLangAddTaskText = ["Add task", "Style", "Active village", "Task target", "To", "Mode", "Construction support", "Resources concentration", "Move up", "Move down", "Del", "&#160;&#160;&#160;Task contents", "Move ", "Delete all the tasks"];
				aLangTaskKind = ["Upgrade", "NewBuild", "Attack", "Research", "Train", "Transport", "NPC", "Demolish", "Celebration"];
				aLangGameText = ["Lvl", "Merchants", "ID", "Capital", "Start time", "this timeseting is unuseful now.", "to", "Village", "transport", "from", "Transport to", "Transport from", "Return from", "resources", "building", "Construct a new building", "empty", "level"];
				aLangRaceName = ["Romans", "Teutons", "Gauls"];
				aLangTaskOfText = ["Schedule Upgrade", "Schedule NewBuild", "Auto ResUpD", "Not_run", "Start", "Started", "Suspend", "The resource fields distribution of this village is ", "Autotransport", "Autotransport is not opened", "Opened", "Transport successfully", "Task List", "Trans In limit", "Default", "Modify", "Wood/Clay/Iron", "Crop", "Schedule demolition",
						"Schedule attack", "Attack type", "Travel time", "repeat times", "interval time", "00:30:00", "Catapult target", "Random", "Unknown", "times", "Month", "Day", "Troops sent",
						"Schedule Train", "Train site", "TrainTask done", "customTransport", "setup interval time of reload", "this is the interval of page reload ,\n default is 20 minutes, please insert new time:\n\n", "Trans Out Rmn", "ScheduleParty", "small party", "big party", "setInterval of Resources concentration",
						"minutes", ".", ".", "START", "STOP", "Schedule Improve", "Improve Attack", "Improve defence", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
				aLangErrorText = ["Too few resources.", "Your workers are already building something.", "Construction completed", "Starting construction", "In development", "Your Warehouse is too small. Please upgrade your Warehouse to continue your construction", "Your Granary is too small. Please upgrade your Granary to continue your construction", "Enough resources", "Food shortage: Upgrade a wheat field first", "There is already a celebration going on"];
				aLangOtherText = ["Important note", "Only the resource fields of the capital can <br/>be upgraded to level 20. Now your capital<br/> is not detected. Visit your Profile please.", "Shortcut here ^_^", "Setup completed", "Cancelled", "Start the tasks", "Upgrade successfully", "Run successfully", "Your race is unknown, therefore your troop type. <br/>Visit your Profile to determine your race.<br/>", "Please also visit your Hero's Mansion to determine<br/> the speed and the type of your hero."];
				aLangResources = ["lumber", "clay", "iron", "crop"];
				aLangTroops[0] = ["Legionnaire", "Praetorian", "Imperian", "Equites Legati", "Equites Imperatoris", "Equites Caesaris", "Battering Ram", "Fire Catapult", "Senator", "Settler", "Hero"];
				aLangTroops[1] = ["Clubswinger", "Spearman", "Axeman", "Scout", "Paladin", "Teutonic Knight", "Ram", "Catapult", "Chief", "Settler", "Hero"];
				aLangTroops[2] = ["Phalanx", "Swordsman", "Pathfinder", "Theutates Thunder", "Druidrider", "Haeduan", "Ram", "Trebuchet", "Chieftain", "Settler", "Hero"];
				aLangAttackType = ["Reinforce", "Attack", "Raid"];
				break;
			default:
				throwLogicError ( "initializeLangVars():: Travian Version not set, when initializing language variables for \'in\'!!" );
		}
		break;

	case "sk": // by Zapo [ 2011.04.07 ]
		aLangAllBuildWithId = ["Drevorubač", "Hlinená baňa", "Železná baňa", "Obilné pole", "", "Píla", "Tehelňa", "Zlievareň", "Mlyn", "Pekáreň", "Sklad surovín", "Sýpka", "Kováč", "Zbrojnica", "Turnajové ihrisko", "Hlavná budova", "Zhromaždisko", "Trhovisko", "Ambasáda", "Kasárne", "Stajne", "Dielňa", "Akadémia", "Úkryt", "Radnica", "Rezidencia", "Palác", "Pokladnica", "Obchodná kancelária", "Veľké kasárne", "Veľká stajňa", "Mestské hradby", "Zemná hrádza", "Palisáda", "Kamenár", "Pivovar", "Pasti","Dvor hrdinov", "Veľké dielne", "Veľká sýpka", "Div sveta", "Žriedlo"];
		aLangAllBuildAltWithId = ["Drevorubač", "Hlinená baňa", "Železná baňa", "Obilné pole", "", "Píla", "Tehelňa", "Zlievareň", "Mlyn", "Pekáreň", "Sklad surovín", "Sýpka", "Kováč", "Zbrojnica", "Turnajové ihrisko", "Hlavná budova", "Zhromaždisko", "Trhovisko", "Ambasáda", "Kasárne", "Stajne", "Dielňa", "Akadémia", "Úkryt", "Radnica", "Rezidencia", "Palác", "Pokladnica", "Obchodná kancelária", "Veľké kasárne", "Veľká stajňa", "Mestské hradby", "Zemná hrádza", "Palisáda", "Kamenár", "Pivovar", "Pasti","Dvor hrdinov", "Veľké dielne", "Veľká sýpka", "Div sveta", "Žriedlo"];
		aLangAddTaskText = ["Pridaj úlohu", "Štýl", "Aktívna dedina", "Plánovaný cieľ", "To", "Mód", "Construction support", "Resources concentration", "Presuň hore", "Presuň dole", "Zmaž", "   Obsah úloh", "Posun ", "Zmaž všetky úlohy"];
		aLangTaskKind = ["Upgrade", "Nová stavba", "Útok", "Výskum", "Trénovať", "Transport", "NPC", "Búrať", "Oslavy"];
		aLangGameText = ["Lvl", "Obchodníci", "ID", "Hlavná dedina", "Start time", "nastavenie času je nepoužiteľný teraz.", "do", "Dedina", "transport", "od", "Transport do", "Transport od", "Návrat z", "suroviny", "budova", "Postaviť novú budovu", "prázdne", "úroveň"];
		aLangRaceName = ["Rimania", "Germáni", "Galovia"];
		aLangTaskOfText = ["Naplánovať Upgrade", "Naplánovať novú budovu", "Auto ResUpD", "Nebeží", "Štart", "Beží", "Suspend", "Surovinová distribúcia tejto dediny je ", "Autotransport", "Autotransport nie je otvorený", "Otvorený", "Transport úspešný", "Zoznam úloh", "Trans In limit", "Default", "Zmeň", "Drevo/Hlina/Železo", "Obilie", "Naplánuj demolíciu",
			"Naplánuj útok", "Typ útoku", "Čas cesty", "opakovať", "časový interval","00:30:00","Cieľ Katapultu","Náhodne", "Neznámy", "krát", "Mesiac", "Deň", "Poslať jednotky",
			"Naplánovať výcvik","Výcvikové miesto","Výcviková úloha hotová","customTransport","nastav časový interval obnovenia","toto je interval obnovenia stránky ,\n default je 20 minút, prosím vlož nový čas:\n\n","Trans Out Rmn","NaplánujOslavu","malá slava","veľká oslava","nastavInterval surovinovej koncentrácie",
			"minút","pozastavené","spustené","spusť","pauza","Naplánuj vylepšenie","Vylepšiť Útok","Vylepšiť Obranu", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		aLangErrorText = ["Príliš málo surovín.", "Stavitelia majú momentálne veľa práce", "Stavanie kompletné", "Začína stavanie", "Vo vývoji", "Tvoj sklad je príliš malý. Prosím zvýš tvoj Sklad na pokračovanie stavania", "Tvoja Sýpka je príliš malá. Prosím zvýš tvoju Sýpku na pokračovanie stavania", "Dostatok surovín","Nedostatok potravín: rozšír obilné polia najskôr!","There is already a celebration going on"];
		aLangOtherText = ["Dôležité poznámky", "Surovinové polia môžu byť len v hlavnej zvyšované na úroveň 20. Teraz nieje určená tvoja hlavná. Navštív tvoj Profil prosím.", "Skratka tu ^_^", "Nastavenie kompletné", "Zrušené", "Spusť úlohy", "Upgrade úspešný", "Spustenie úspešné", "Tvoj národ je neznámy, therefore your troop type. Navštív tvoj Profil na určenie tvojho národa.", "Prosím navštív tiež tvoj Dvor hrdinov na určenie rýchlosti a typu tvojho hrdinu."];
		aLangResources = ["drevo","hlina","železo","obilie"];
		aLangTroops[0] = ["Legionár", "Pretorián", "Imperián", "Equites Legáti", "Equites Imperátoris", "Equites Caesaris", "Rímske Baranidlo", "Ohnivý Katapult", "Senátor", "Osadník", "Hrdina"];
		aLangTroops[1] = ["Pálkar", "Oštepár", "Bojovník so sekerou", "Špeh", "Rytier", "Teuton jazdec", "Germánske baranidlo", "Katapult", "Kmeňový vodca", "Osadník", "Hrdina"];
		aLangTroops[2] = ["Falanx", "Šermiar", "Sliedič", "Theutates Blesk", "Druid jazdec", "Haeduan", "Drevené Baranidlo", "Vojnový Katapult", "Náčelník", "Osadník", "Hrdina"];
		aLangAttackType = ["Podpora", "Útok", "Lúpež"];
		break;

	case "id":
		switch ( aTravianVersion ) {
			case "3.6": // translations for travian version 3.6
				aLangAllBuildWithId = ["Penebangan Kayu", "Penggalian Tanah Liat", "Tambang Besi", "Ladang", "", "Penggergajian", "Pabrik Bata", "Peleburan Besi", "Penggilingan Gandum", "Toko Roti", "Gudang", "Lumbung", "Pandai Besi", "Pabrik Perisai", "Pusat Kebugaran", "Bangunan Utama", "Titik Temu", "Pasar", "Kedutaan", "Barak", "Istal", "Bengkel", "Akademi", "Cranny", "Balai Desa", "Kastil", "Istana", "Gudang Ilmu", "Kantor Dagang", "Barak Besar", "Istal Besar", "Pagar Batu", "Pagar Tanah", "Pagar kayu", "Tukang Batu", "Pabrik Bir", "Perangkap","Padepokan", "Gudang Besar", "Lumbung Besar", "Keajaiban Dunia", "Tempat Minum Kuda"];
				aLangAllBuildAltWithId = ["Penebang Kayu", "Penggalian Tanah Liat", "Tambang Besi", "Ladang", "", "Penggergajian", "Pabrik Bata", "Peleburan Besi", "Penggilingan Gandum", "Toko Roti", "Gudang", "Lumbung", "Pandai Besi", "Pabrik Perisai", "Pusat Kebugaran", "Bangunan Utama", "Titik Temu", "Pasar", "Kedutaan", "Barak", "Istal", "Bengkel", "Akademi", "Cranny", "Balai Desa", "Kastil", "Istana", "Gudang Ilmu", "Kantor Dagang", "Barak Besar", "Istal Besar", "Pagar Batu", "Pagar Tanah", "Pagar kayu", "Tukang Batu", "Pabrik Bir", "Perangkap","Padepokan", "Gudang Besar", "Lumbung Besar", "Keajaiban Dunia", "Tempat Minum Kuda"];
				aLangAddTaskText = ["Tambah Pengerjaan", "Jenis", "Desa Aktif", "Target Pengerjaan", "ke", "Mode", "Construction support", "Resources concentration", "Move up", "Move down", "Del", "   Task contents", "Move ", "Delete all the tasks"];
				aLangTaskKind = ["Menaikkan", "Dirikan", "Serang", "riset", "latih", "Kirim", "NPC", "Bongkar", "Perayaan"];
				aLangGameText = ["Tk", "Pedagang", "ID", "Ibukota", "Waktu mulai", "jangan gunakan waktu di atas", "ke", "Desa", "kirim", "dari", "Kirim ke", "Kiriman dari", "Kembali dari", "sumberdaya", "bangunan", "Mendirikan Bangunan", "kosong", "tingkat"];
				aLangRaceName = ["Romawi", "Teuton", "Galia"];
				aLangTaskOfText = ["Jadwal Menaikkan", "Jadwal Dirikan", "Auto ResUpD", "Not_run", "Start", "Started", "Suspend", "The resource fields distribution of this village is ", "Otomatis kirim", "Autotransport is not opened", "Opened", "Pengiriman Berhasil", "Task List", "Trans In limit", "Default", "Modify", "Kayu/Liat/Besi", "Gandum", "Jadwal Pembongkaran",
					"Jadwal Serangan", "Tipe serangan", "Waktu tiba", "diulang", "rentang waktu", "00:30:00", "Target catapult", "Acak", "Unknown", "times", "Month", "Day", "Pasukan terkirim",
					"Jadwal Pelatihan", "Tempat latih", "Pelatihan selesai", "Atur kirim", "setup interval time of reload","this is the interval of page reload ,\n default is 20 minutes, please insert new time:\n\n","Trans Out Rmn","Jadwal Perayaan","Perayaan kecil","Perayaan besar","setInterval of Resources concentration",
					"minutes", ".",".","START","STOP","Jadwal Pengembangan","Pengembangan serangan","Pengembangan pertahanan", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
				aLangErrorText = ["sumberdaya cukup pada", "Pekerja sedang bekerja", "sepenuhnya telah dikembangkan", "Dirikan bangunan", "Sedang Membangun", "Your Warehouse is too small. Please upgrade your Warehouse to continue your construction", "Your Granary is too small. Please upgrade your Granary to continue your construction", "sumberdaya cukup pada","Kurang makanan: kembangkan ladang terlebih dahulu","There is already a celebration going on"];
				aLangOtherText = ["Important note", "Only the resource fields of the capital can be upgraded to level 20. Now your capital is not detected. Visit your Profile please.", "Shortcut here ^_^", "Setup completed", "Cancelled", "Start the tasks", "Upgrade successfully", "Run successfully", "Your race is unknown, therefore your troop type. Visit your Profile to determine your race.", "Please also visit your Hero's Mansion to determine the speed and the type of your hero."];
				aLangResources=["Kayu","Liat","Besi","Gandum"];
				aLangTroops[0] = ["Legionnaire", "Praetorian", "Imperian", "Equites Legati", "Equites Imperatoris", "Equites Caesaris", "Battering Ram", "Fire Catapult", "Senator", "Settler", "Kesatria"];
				aLangTroops[1] = ["Clubswinger", "Spearman", "Axeman", "Scout", "Paladin", "Teutonic Knight", "Ram", "Catapult", "Chief", "Settler", "Kesatria"];
				aLangTroops[2] = ["Phalanx", "Swordsman", "Pathfinder", "Theutates Thunder", "Druidrider", "Haeduan", "Ram", "Trebuchet", "Chieftain", "Settler", "Kesatria"];
				aLangAttackType = ["Bantuan", "Serang", "Rampok"];
				break; 
			case "4.0": // translations for travian version 4.0
				aLangAllBuildWithId = ["Penebang Kayu", "Penggalian Tanah Liat", "Tambang Besi", "Ladang", "", "Pemotong Kayu", "Pabrik Bata", "Pelebur Besi", "Penggiling Gandum", "Toko Roti", "Gudang", "Lumbung", "Pandai Besi", "Pabrik Perisai", "Pusat Kebugaran", "Bangunan Utama", "Titik Temu", "Pasar", "Kedutaan", "Barak", "Istal", "Bengkel", "Akademi", "Cranny", "Balai Desa", "Kastil", "Istana", "Gudang Ilmu", "Kantor Dagang", "Barak Besar", "Istal Besar", "Pagar Batu", "Pagar Tanah", "Pagar kayu", "Tukang Batu", "Pabrik Bir", "Perangkap","Padepokan", "Gudang Besar", "Lumbung Besar", "Keajaiban Dunia", "Tempat Minum Kuda"];
				aLangAllBuildAltWithId = ["Penebang Kayu", "Penggalian Tanah Liat", "Tambang Besi", "Ladang", "", "Pemotong Kayu", "Pabrik Bata", "Pelebur Besi", "Penggiling Gandum", "Toko Roti", "Gudang", "Lumbung", "Pandai Besi", "Pabrik Perisai", "Pusat Kebugaran", "Bangunan Utama", "Titik Temu", "Pasar", "Kedutaan", "Barak", "Istal", "Bengkel", "Akademi", "Cranny", "Balai Desa", "Kastil", "Istana", "Gudang Ilmu", "Kantor Dagang", "Barak Besar", "Istal Besar", "Pagar Batu", "Pagar Tanah", "Pagar kayu", "Tukang Batu", "Pabrik Bir", "Perangkap","Padepokan", "Gudang Besar", "Lumbung Besar", "Keajaiban Dunia", "Tempat Minum Kuda"];
				aLangAddTaskText = ["Tambah Pengerjaan", "Jenis", "Desa Aktif", "Target Pengerjaan", "ke", "Mode", "Construction support", "Resources concentration", "Move up", "Move down", "Del", "   Task contents", "Move ", "Delete all the tasks"];
				aLangTaskKind = ["Menaikkan", "Dirikan", "Serang", "riset", "latih", "Kirim", "NPC", "Bongkar", "Perayaan"];
				aLangGameText = ["Tk", "Pedagang", "ID", "Ibukota", "Waktu mulai", "jangan gunakan waktu di atas", "ke", "Desa", "kirim", "dari", "Kirim ke", "Kiriman dari", "Kembali dari", "sumberdaya", "bangunan", "Mendirikan Bangunan", "kosong", "tingkat"];
				aLangRaceName = ["Romawi", "Teuton", "Galia"];
				aLangTaskOfText = ["Jadwal Menaikkan", "Jadwal Dirikan", "Auto ResUpD", "Not_run", "Start", "Started", "Suspend", "The resource fields distribution of this village is ", "Otomatis kirim", "Autotransport is not opened", "Opened", "Pengiriman Berhasil", "Task List", "Trans In limit", "Default", "Modify", "Kayu/Liat/Besi", "Gandum", "Jadwal Pembongkaran",
					"Jadwal Serangan", "Tipe serangan", "Waktu tiba", "diulang", "rentang waktu", "00:30:00", "Target catapult", "Acak", "Unknown", "times", "Month", "Day", "Pasukan terkirim",
					"Jadwal Pelatihan", "Tempat latih", "Pelatihan selesai", "Atur kirim", "setup interval time of reload","this is the interval of page reload ,\n default is 20 minutes, please insert new time:\n\n","Trans Out Rmn","Jadwal Perayaan","Perayaan kecil","Perayaan besar","setInterval of Resources concentration",
					"minutes", ".",".","START","STOP","Jadwal Pengembangan","Pengembangan serangan","Pengembangan pertahanan", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
				aLangErrorText = ["sumberdaya cukup pada", "Pekerja sedang bekerja", "sepenuhnya telah dikembangkan", "Dirikan bangunan", "Sedang Membangun", "Your Warehouse is too small. Please upgrade your Warehouse to continue your construction", "Your Granary is too small. Please upgrade your Granary to continue your construction", "sumberdaya akan cukup pada","Gandum anda dalam kondisi minus maka tidak akan pernah sampai pada jumlah sumber daya yang dibutuhkan.","There is already a celebration going on"];
				aLangOtherText = ["Important note", "Only the resource fields of the capital can be upgraded to level 20. Now your capital is not detected. Visit your Profile please.", "Shortcut here ^_^", "Setup completed", "Cancelled", "Start the tasks", "Upgrade successfully", "Run successfully", "Your race is unknown, therefore your troop type. Visit your Profile to determine your race.", "Please also visit your Hero's Mansion to determine the speed and the type of your hero."];
				aLangResources=["Kayu","Liat","Besi","Gandum"];
				aLangTroops[0] = ["Legionnaire", "Praetorian", "Imperian", "Equites Legati", "Equites Imperatoris", "Equites Caesaris", "Battering Ram", "Fire Catapult", "Senator", "Settler", "Kesatria"];
				aLangTroops[1] = ["Clubswinger", "Spearman", "Axeman", "Scout", "Paladin", "Teutonic Knight", "Ram", "Catapult", "Chief", "Settler", "Kesatria"];
				aLangTroops[2] = ["Phalanx", "Swordsman", "Pathfinder", "Theutates Thunder", "Druidrider", "Haeduan", "Ram", "Trebuchet", "Chieftain", "Settler", "Kesatria"];
				aLangAttackType = ["Bantuan", "Serang", "Rampok"];
				break;
			default:
				throwLogicError ( "initializeLangVars():: Travian Version not set, when initializing language variables for \'id\'!!" );
		}
		break;


	case "au":	
	case "uk":	
	case "com": // thanks  ieyp
	default:
		// used for logic, translation required
		aLangAllBuildWithId = aLangAllBuildWithIdComDef.slice(0);
		// used for logic, translation required
		aLangAllBuildAltWithId = aLangAllBuildAltWithIdComDef.slice(0);
		// used for display only
		aLangAddTaskText = ["Add task", "Style", "Active village", "Task target", "To", "Mode", "Construction support", "Resources concentration", "Move up", "Move down", "Del", "&#160;&#160;&#160;Task contents", "Move ", "Delete all the tasks"];
		// used for display only
		aLangTaskKind = ["Upgrade", "NewBuild", "Attack", "Research", "Train", "Transport", "NPC", "Demolish", "Celebration"];
		// used for logic and display, translation required
		aLangGameText = aLangGameTextComDef.slice(0);
		// used for getMainVillageid(), translation required
		aLangRaceName = aLangRaceNameComDef.slice(0);
		// used for display only
		aLangTaskOfText = ["Schedule Upgrade", "Schedule NewBuild", "Auto ResUpD", "Not_run", "Start", "Started", "Suspend", "The resource fields distribution of this village is ", "Autotransport", "Autotransport is not opened", "Opened", "Transport successfully", "Task List", "Trans In limit", "Default", "Modify", "Wood/Clay/Iron", "Crop", "Schedule demolition",
				"Schedule attack", "Attack type", "Travel time", "repeat times", "interval time", "00:30:00", "Catapult target", "Random", "Unknown", "times", "Month", "Day", "Troops sent",
				"Schedule Train", "Train site", "TrainTask done", "customTransport", "setup interval time of reload", "this is the interval of page reload ,\n default is 20 minutes, please insert new time:\n\n", "Trans Out Rmn", "ScheduleParty", "small party", "big party", "setInterval of Resources concentration",
				"minutes", ".", ".", "START", "STOP", "Schedule Improve", "Improve Attack", "Improve defence", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		// used for logic & display, translation required
		aLangErrorText = aLangErrorTextComDef.slice(0);
		// used for display
		aLangOtherText = ["Important note", "Only the resource fields of the capital can <br/>be upgraded to level 20. Now your capital<br/> is not detected. Visit your Profile please.", "Shortcut here ^_^", "Setup completed", "Cancelled", "Start the tasks", "Upgrade successfully", "Run successfully", "Your race is unknown, therefore your troop type. <br/>Visit your Profile to determine your race.<br/>", "Please also visit your Hero's Mansion to determine<br/> the speed and the type of your hero."];
		// used for display only, however translation can be done
		aLangResources = aLangResourcesComDef.slice(0);
		// used for logic & display, translation required
		aLangTroops[0] = aLangTroopsComDef[0].slice(0);
		aLangTroops[1] = aLangTroopsComDef[1].slice(0);
		aLangTroops[2] = aLangTroopsComDef[2].slice(0);
		// used for display only, however translation can be done
		aLangAttackType = aLangAttackTypeComDef.slice(0);
		break;

	case "pl": // partial translation by deFox
		// 2011.02.13 -- partial translation by Blaker
		aLangAllBuildWithId = ["Las", "Kopalnia gliny", "Kopalnia żelaza", "Pole zboża", "", "Tartak", "Cegielnia", "Huta stali", "Młyn", "Piekarnia", "Magazyn surowców", "Spichlerz", "Zbrojownia", "Kuźnia", "Plac turniejowy", "Główny budynek", "Miejsce zbiórki", "Rynek", "Ambasada", "Koszary", "Stajnia", "Warsztat", "Akademia", "Kryjówka", "Ratusz", "Rezydencja", "Pałac", "Skarbiec", "Targ", "Duże koszary", "Duża stajnia", "Mur obronny", "Wał ziemny", "Palisada", "Kamieniarz", "Browar", "Traper","Dwór bohatera", "Duży magazyn surowców", "Duży spichlerz", "Cud świata", "Wodopój"];
		aLangAllBuildAltWithId = ["Las", "Kopalnia gliny", "Kopalnia żelaza", "Pole zboża", "", "Tartak", "Cegielnia", "Huta stali", "Młyn", "Piekarnia", "Magazyn surowców", "Spichlerz", "Zbrojownia", "Kuźnia", "Plac turniejowy", "Główny budynek", "Miejsce zbiórki", "Rynek", "Ambasada", "Koszary", "Stajnia", "Warsztat", "Akademia", "Kryjówka", "Ratusz", "Rezydencja", "Pałac", "Skarbiec", "Targ", "Duże koszary", "Duża stajnia", "Mur obronny", "Wał ziemny", "Palisada", "Kamieniarz", "Browar", "Traper","Dwór bohatera", "Duży magazyn surowców", "Duży spichlerz", "Cud świata", "Wodopój"];
		aLangAddTaskText = ["Add task", "Style", "Active village", "Task target", "To", "Mode", "Construction support", "Resources concentration", "Move up", "Move down", "Del", "&#160;&#160;&#160;Task contents", "Move ", "Delete all the tasks"];
		aLangTaskKind = ["Upgrade", "NewBuild", "Attack", "Research", "Train", "Transport", "NPC", "Demolish", "Celebration"];
		aLangGameText = ["Lvl", "Merchants", "ID", "Capital", "Start time", "this timeseting is unuseful now.", "to", "Village", "transport", "from", "Transport to", "Transport from", "Return from", "resources", "building", "Construct new building", "empty", "level"];
		aLangRaceName = ["Rzymianie", "Germanie", "Galowie"];
		aLangTaskOfText = ["Zaplanuj Upgrade", "Zaplanuj Budowę", "Auto ResUpD", "Not_run", "Start", "Started", "Suspend", "The resource fields distribution of this village is ", "Autotransport", "Autotransport is not opened", "Opened", "Transport successfully", "Lista zadań", "Trans In limit", "Domyśl.", "Zmień", "Drewno/Glina/Żelazo", "Zboże", "Schedule demolition",
			"Zaplanuj atak", "Typ Ataku", "Czas podróży", "repeat times", "odstęp czasu", "00:30:00","Cel dla katapult", "Losowy", "Nieznany", "times", "Mies.", "Dzień", "Troops sent",
			"Zaplanuj szkolenie", "Train site", "TrainTask done", "customTransport", "setup interval time of reload","this is the interval of page reload,\n default is 20 minutes, please insert new time:\n\n","Trans Out Rmn","ScheduleParty","small party","big party","setInterval of Resources concentration",
			"minut", ".",".","START","STOP","Schedule Improve","Improve Attack","Improve defence", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		aLangErrorText = ["Zbyt mało surowców.", "The workers are already at work.", "Construction completed", "Starting construction", "In development", "Your Warehouse is too small. Please upgrade your Warehouse to continue your construction", "Your Granary is too small. Please upgrade your Granary to continue your construction", "Enough resources","Lack of food: extend cropland first","There is already a celebration going on"];
		aLangOtherText = ["Ważna wiadomość", "Tylko w stolicy można rozbudować teren do poz. 20.<br/>Aktywna wioska nie została rozpoznana jako stolica.<br/>Wejdź w Ustawienia by wywołać aktualizację.", "Szybki link ^_^", "Setup completed", "Cancelled", "Start the tasks", "Upgrade successfully", "Run successfully", "Nie udało się określić twojej rasy, stąd typy jednostek<br/>nie są znane. Wejdź w Ustawienia by skrypt wykrył twoją rasę.<br/>", "Please also visit your Hero's Mansion to determine<br/> the speed and the type of your hero."];
		aLangResources = ["drewno", "glina", "żelazo", "zboże"];
		aLangTroops[0] = ["Legionnaire", "Praetorian", "Imperian", "Equites Legati", "Equites Imperatoris", "Equites Caesaris", "Battering Ram", "Fire Catapult", "Senator", "Settler", "Hero"];
		aLangTroops[1] = ["Clubswinger", "Spearman", "Axeman", "Scout", "Paladin", "Teutonic Knight", "Ram", "Catapult", "Chief", "Settler", "Hero"];
		aLangTroops[2] = ["Falanga", "Miecznik", "Tropiciel", "Grom Teutatesa", "Jeździec druidzki", "Haeduan", "Taran", "Trebusz", "Herszt", "Osadnicy", "Bohater"];
		aLangAttackType = ["Posiłki", "Atak normalny", "Grabież"];
		break;

	case "ua":
		aLangAllBuildWithId = ["Лісоповал", "Глиняний кар'єр", "Залізна копальня", "Ферма", "", "Деревообробний завод", "Цегляний завод", "Чавуноливарний завод", "Млин", "Пекарня", "Склад", "Зернова комора", "Кузня зброї", "Кузня обладунків", "Арена", "Головна будівля", "Пункт збору", "Ринок", "Посольство", "Казарма", "Стайня", "Майстерня", "Академія", "Схованка", "Ратуша", "Резиденція", "Палац", "Скарбниця", "Торгова палата", "Велика казарма", "Велика стайня", "Міська стіна", "Земляний вал", " Огорожа", "Каменяр", "Пивна", "Капканщик","Таверна", "Великий склад", "Велика Зернова комора", "Чудо світу", "Водопій"];
		aLangAllBuildAltWithId = ["Лісоповал", "Глиняний кар'єр", "Залізна копальня", "Ферма", "", "Деревообробний завод", "Цегляний завод", "Чавуноливарний завод", "Млин", "Пекарня", "Склад", "Зернова комора", "Кузня зброї", "Кузня обладунків", "Арена", "Головна будівля", "Пункт збору", "Ринок", "Посольство", "Казарма", "Стайня", "Майстерня", "Академія", "Схованка", "Ратуша", "Резиденція", "Палац", "Скарбниця", "Торгова палата", "Велика казарма", "Велика стайня", "Міська стіна", "Земляний вал", " Огорожа", "Каменяр", "Пивна", "Капканщик","Таверна", "Великий склад", "Велика Зернова комора", "Чудо світу", "Водопій"];
		aLangAddTaskText = ["Додати завдання", "Спосіб", "Активне поселення", "Ціль завдання", "| Ціль", "Тип", "Підтримка будівництва", "Концентрація ресурсів", "Вверх", "Вниз", "", "", "", "Видалити усі завдання"];
		aLangTaskKind = ["Покращити:", "Нове завдання:", "Атакувати:", "Розвідати:", " наняти:", "Відправити ресурси:", "NPC:", "Зруйнувати:", "Урочистість:"];
		aLangGameText = [" Рівень ", "Торговці", "ID", "Столиця", "Час початку", "(тимчасово не працює)", "в", "Поселення", "Транспортування", "з", "Транспортування в", "Транспортування из", "Повернення з", "ресурси", "будівля", "Побудувати нову будівлю", "пусто", "рівень"];
		aLangRaceName = ["Римляни", "Тевтонці", "Галли"];
		aLangTaskOfText = ["Запланувати удосконалення", "Запланувати нове завдання", "Качати реурси", "Викл", "Старт", "Вкл", "стоп", "Розполілення полів в поселенні: ", "Автовідправлення", "Автовідправлення викл.", "Вкл.", "Успішно відправленно", "* Задачі *", "Обмеження ввозу", "Ні", "Змінити ", "Дерево/Глина/Залізо", "Зерно", "Запланувати зруйнування",
			"Запланувати атаку", "Тип атаки", "Час в дорозі", "повтори", "проміжок","00:30:00","Ціль катов","Випадково", "Невідомо", " раз", "/", " :дата/час: ", "Війска",
			"Запланувати найм","Train site","Навчання військ завершено","цілеве відправлення","Інтервал оновлення","Це інтервал оновлення сторінки ,\n по замовчуванню - 20 хвилин, Введіть новоий час:\n\n","Обмеження вивозу","Запланувати святкування","Малий праздник","Великий праздник","Встановлення інтервала концентрації ресурсів",
			"хвилини","зупинено","працює","старт","пауза","Schedule Improve","Improve Attack","Improve defence", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		aLangErrorText = ["Недостатньо сировини", "Всі будівельники зараз зайняті", "Це завдання зупинено повністю", "Починаю будівництво", "Процес розвитку", "Недостатня місткість складу", "Недостатня місткість Зернової комори", "Достатньо ресурсів","","Проводится урочистість"];
		aLangOtherText = ["Важливі замітки", "Тільки в столиці поля можуть бути до рівня 20. Столиця не визначена.Зайдіть в профіль будьласка", "Ссилка тут ^_^", "Настройка завершена", "Відмінено", "Почати завдання", "Удосконалення пройшло успішно", "Успішно", "Ваш народ невизначений.Будьласка зайдіть в профіль.", "Також будьласка зайдіть в таверну для визначення типу та скорості героя"];
		aLangResources=["Деревина","Глина","Залізо","Зерно"];
		aLangTroops[0] = ["Легіонер", "Преторіанець", "Імперіанець", "Кінний розвідник", "Кіннота імператора", "Кіннота Цезаря", "Таран", "Вогняна катапульта", "Сенатор", "Поселенець", "Герой"];
		aLangTroops[1] = ["Дубинник", "Списник", "Сокирник", "Скаут", "Паладин", "Тевтонський вершник", "Стінобитне знаряддя", "Катапульта", "Ватажок", "Поселенець", "Герой"];
		aLangTroops[2] = ["Фаланга", "Мечник", "Слідопит", "Тевтацький грім", "Друїд-вершник", "Едуйська кіннота", "Таран", "Катапульта", "Лідер", "Поселенець", "Герой"];
		aLangAttackType = ["Підкріплення", "Напад", "Набіг"];
		break;

	case "tr": // by karambol update the 27 Mar 2010 by SARLAK
    aLangAllBuildWithId = ["Oduncu", "Tuğla Ocağı", "Demir Madeni", "Tarla", "", "Kereste Fabrikası", "Tuğla Fırını", "Demir Dökümhanesi", "Değirmen", "Ekmek Fırını", "Hammadde deposu", "Tahıl Ambarı", "Silah Dökümhanesi", "Zırh Dökümhanesi", "Turnuva Yeri", "Merkez Binası", "Askeri Üs", "Pazar Yeri", "Elçilik", "Kışla", "Ahır", "Tamirhane", "Akademi", "Sığınak", "Belediye", "Köşk", "Saray", "Hazine", "Ticari Merkez", "Büyük Kışla", "Büyük Ahır", "Sur", "Toprak Siper", "Çit", "Taşçı", "İçecek Fabrikası", "Tuzakçı","Kahraman Kışlası", "Büyük Hammadde deposu", "Büyük Tahıl Ambarı", "Dünya Harikası", "Yalak"];
    aLangAllBuildAltWithId = ["Oduncu", "Tuğla Ocağı", "Demir Madeni", "Tarla", "", "Kereste Fabrikası", "Tuğla Fırını", "Demir Dökümhanesi", "Değirmen", "Ekmek Fırını", "Hammadde deposu", "Tahıl Ambarı", "Silah Dökümhanesi", "Zırh Dökümhanesi", "Turnuva Yeri", "Merkez Binası", "Askeri Üs", "Pazar Yeri", "Elçilik", "Kışla", "Ahır", "Tamirhane", "Akademi", "Sığınak", "Belediye", "Köşk", "Saray", "Hazine", "Ticari Merkez", "Büyük Kışla", "Büyük Ahır", "Sur", "Toprak Siper", "Çit", "Taşçı", "İçecek Fabrikası", "Tuzakçı","Kahraman Kışlası", "Büyük Hammadde deposu", "Büyük Tahıl Ambarı", "Dünya Harikası", "Yalak"];
    aLangAddTaskText = ["Görev Ekle", "Stil", "Aktif Köy", "Görev Hedefi", "Hedef", "Türü", "İnşaat Desteği", "Hammadde karışımı", "Yukarı Taşı", "Aşağı Taşı", "Sil", "Görev İçeriği", "Sırala", "Tüm görevleri sil"];  
    aLangTaskKind = ["Geliştirilen Bina :", "Yeni Bina :", "Hücum", "Araştır", "Yetiştir", "Gönder", "NPC", "Yıkılan Bina :", "Festival"];  
    aLangGameText = ["Seviye ", "Tüccar", "ID", "Başkent", "Başlangıç zamanı", "Değiştirilemez.", "buraya", "Aktif Köy", "gönder", "buradan", "Gönderiliyor", "Gönderildi", "Dönüş", "hammadde", "bina", "Yeni bina kur", "boş", "Seviye "];  
    aLangRaceName = ["Romalılar", "Cermenler", "Galyalılar"];  
    aLangTaskOfText = ["Geliştirme Zamanla", "Yeni Bina Kurulumu", "Otomatik hammadde güncelle", "Çalışmıyor", "Başlat", "Çalışıyor", "Durdur", "Bu köyün kaynak alanları dağılımıdır ", "Otomatik Gönderme", "Otomatik gönderme açılmadı", "Açıldı", "Gönderme Tamamladı", "", "Gönderme limiti", "Varsayılan", "Değiştir", "Odun/Tuğla/Demir", "Tahıl", "Yıkımı zamanla",  
        "Hücum zamanla", "Hücum Şekli", "Varış zamanı", "Tekrar Sayısı", "Tekrar Aralığı","00:30:00","Mancınık hedef","Rastgele", "Bilinmeyen", "kere", "Ay", "Gün", "Asker gönder", "Asker Yetiştir","Yetiştirilme Noktası","Eğitim görevi tamamlandı","Hammadde Gönderimi Zamanla","Gerçekleşmeyen Kurulumu Tekrarlama Süresi","Tekrar deneme süresini giriniz.\n(Varsayılan Değer: 20 Dakika)","Trans Out Rmn","Festivalzamanla","Küçük festival","Büyük festival","Hammadde Toplama Aralığı",  
        "dakikalar","Pasif","Aktif","Aktif Et","Pasif Et","Asker Gelişimi Zamanla","Silah Gelişimi","Zırh Gelişimi","saati", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];  
    aLangErrorText = ["Çok az kaynak.", "Işçi zaten iş başında.", "İnşaat tamamlandı", "İnşaat başlatılıyor", "Araştırma yapılıyor", "İnşaata Hammadde deposunu geliştirip devam ediniz.", "İnşaata Tahıl ambarını geliştirip devam ediniz.", "Yeterli hammadde","Kaynak eksikliği: önce Tarlanı geliştir","Şu anda bir festival yapılıyor zaten"];  
    aLangOtherText = ["Önemli not", "Sadece başkent için hammadde üretebilirsiniz <br/>be Güncellendi seviye 20. Şimdi Başkentin<br/> tesbit edilemedi. Profilinizi ziyaret ediniz.", "Buraya kısa yol ^_^", "Kurulum tamamlandı", "Vazgeçildi", "Görevleri başlat", "Güncelleme tamamlandı", "Çalışma tamam", "Irkınız bilinmediğinden asker türünüz belilenemedi <br/>Profilinizi ziyaret edip ırkınızı belirleyin<br/>", "Ayrıca kahraman kışlasınıda ziyaret edin<br/> Kahramanınızın hızı ve tipi."];  
    aLangResources=["Odun","Tuğla","Demir","Tahıl"];  
    aLangTroops[0] = ["Lejyoner", "Pretoryan", "Emperyan", "Equites Legati", "Equites Imperatoris", "Equites Caesaris", "Koçbaşı", "Ateş Mancınığı", "Senatör", "Göçmen", "Kahraman"];  
    aLangTroops[1] = ["Tokmak Sallayan", "Mızrakçı", "Balta Sallayan", "Casus", "Paladin", "Toyton", "Koçbaşı", "Mancınık", "Reis", "Göçmen", "Kahraman"];  
    aLangTroops[2] = ["Phalanx", "Kılıçlı", "Casus", "Toytatın Şimşeği", "Druyid", "Heduan", "Koçbaşı", "Mancınık", "Kabile Reisi", "Göçmen", "Kahraman"];  
    aLangAttackType = ["Destek", "Saldırı: Normal", "Saldırı: Yağma"];  
    break;

	case "br":
		aLangAllBuildWithId = ["Bosque", "Poço de Barro", "Mina de Ferro", "Campo de Cereais", "", "Serraria", "Alvenaria", "Fundição", "Moinho", "Padaria", "Armazém", "Celeiro", "Ferreiro", "Fábrica de Armaduras", "Praça de torneios", "Edifício principal", "Ponto de reunião militar", "Mercado", "Embaixada", "Quartel", "Cavalaria", "Oficina", "Academia", "Esconderijo", "Casa do Povo", "Residência", "Palácio", "Tesouraria", "Companhia do Comércio", "Grande Quartel", "Grande Cavalaria", "Muralha", "Barreira", "Paliçada", "Pedreiro", "Cervejaria", "Fábrica de Armadilhas","Mansão do Herói", "Grande armazém", "Grande Celeiro", "Maravilha do Mundo", "Bebedouro para cavalos"];
		aLangAllBuildAltWithId = ["Bosque", "Poço de Barro", "Mina de Ferro", "Campo de Cereais", "", "Serraria", "Alvenaria", "Fundição", "Moinho", "Padaria", "Armazém", "Celeiro", "Ferreiro", "Fábrica de Armaduras", "Praça de torneios", "Edifício principal", "Ponto de reunião militar", "Mercado", "Embaixada", "Quartel", "Cavalaria", "Oficina", "Academia", "Esconderijo", "Casa do Povo", "Residência", "Palácio", "Tesouraria", "Companhia do Comércio", "Grande Quartel", "Grande Cavalaria", "Muralha", "Barreira", "Paliçada", "Pedreiro", "Cervejaria", "Fábrica de Armadilhas","Mansão do Herói", "Grande armazém", "Grande Celeiro", "Maravilha do Mundo", "Bebedouro para cavalos"];
		aLangAddTaskText = ["Adicionar tarefa", "Estilo", "Aldeia Activa", "Alvo", "Para", "Modo", "Ajuda na Construção", "Quantidade de recursos", "Mover para cima", "Mover para baixo", "Apagar", "&#160;&#160;&#160;Tarefas", "Mover ", "Eliminar todas as tarefas"];
		aLangTaskKind = ["Evolução", "Novo construção", "Ataque", "Pesquisa", "Treino", "Transporte", "NPC", "Demolição", "Celebração"];
		aLangGameText = ["Lvl", "Mercadores", "Identificação", "Capital", "Inicio", "this timeseting is unuseful now.", "Para", "Aldeia", "Transporte", "de", "Transporte para", "Transporte de", "A regressar de", "Recursos", "Edificio", "Construir novo edifício", "Vazio", "Nivel"];
		aLangRaceName = ["Romanos", "Teutões", "Gauleses"];
		aLangTaskOfText = ["Agendar Evolução", "Agendar nova construção", "ResourcesUpD", "OFF", "Iniciar", "ON", "Parar", "A distribuição dos campos desta aldeia é ", "Autotransporte", "Autotransporte não está aberto", "Aberto", "Transporte com sucesso", "Lista de agendamento", "Limit", "Default", "Alterar", "madeira/barro/ferro", "cereal", "Agendamento de demolição",
			"Agendamento de ataque", "Tipo de ataque", "Tempo de viagem", "Repetir número de vezes", "Tempo de intervalo","00:30:00","Alvo catapulta","Aleatório", "Desconhecido", "Vezes", " Mês", " Dia", "Tropas enviadas",
			"Agendamento de treino","localização de tropas","Agendamento de treino feito","Transporte personalizado","Setup Interval Time of Reload","This is the interval of page reload ,\n default são 20 minutos, Insira novo tempo:\n\n","Remain","Agendar Celebração","pequena celebração","grande celebração","Set Interval of Resources concentration",
			"minutos","parado","ligado","ligar","parar","Schedule Improve","Improve Attack","Improve defence", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		aLangErrorText = ["Poucos recursos.", "Os trabalhadores já estão a trabalhar.", "Construção completa", "Inicio da construção", "Em desenvolvimento", "Seu Armazém é pequeno. Evolua o seu armazém para continuar a sua construção", "Seu Celeiro é pequeno. Evolua o seu Celeiro para continuar a sua construção", "Recursos suficientes","Já se encontra uma celebração em curso"];
		aLangOtherText = ["Nota importante", "Apenas os campos de recursos da capital <br/>podem ser elevados a nivel 20 . A sua capital <br/> nao está detectavel. Por favor visite o seu perfil.", "Atalho aqui ^_^", "Instalação concluída", "Cancelado", "Iniciar as tarefas", "Upgrade com sucesso", "Executar com sucesso", "Sua raça é desconhecida, e o seu tipo de tropa também. <br/>Visite o seu perfil para determinar as raça.<br/>", "Por favor visite a sua mansão do heroi para determinar<br/> a velocidade e o tipo de heroi."];
		aLangResources=["Madeira","Barro","Ferro","Cereais"];
		aLangTroops[0] = ["Legionário", "Pretoriano", "Imperiano", "Equites Legati", "Equites Imperatoris", "Equites Caesaris", "Aríete", "Catapulta de Fogo", "Senador", "Colonizador", "Heroi"];
		aLangTroops[1] = ["Salteador", "Lanceiro", "Bárbaro", "Espião", "Paladino", "Cavaleiro Teutão", "Aríete", "Catapulta", "Chefe", "Colonizador", "Heroi"];
		aLangTroops[2] = ["Falange", "Espadachim", "Batedor", "Trovão Theutate", "Cavaleiro Druida", "Haeduano", "Aríete", "Trabuquete", "Chefe de Clã", "Colonizador", "Heroi"];
		aLangAttackType = ["Reforço", "Ataque", "Assalto"];
		break;


       case "pt": // thanks RASCO and Tuga
		aLangAllBuildWithId = ["Bosque", "Poço de Barro", "Mina de Ferro", "Campo de Cereais", "", "Serração", "Alvenaria", "Fundição", "Moinho", "Padaria", "Armazém", "Celeiro", "Ferreiro", "Fábrica de Armaduras", "Praça de torneios", "Edifício principal", "Ponto de reunião militar", "Mercado", "Embaixada", "Quartel", "Cavalariça", "Oficina ", "Academia", "Esconderijo", "Casa do Povo", "Residência", "Palácio", "Tesouraria", "Companhia do Comércio", "Grande Quartel", "Grande Cavalariça", "Muralha", "Barreira", "Paliçada", "Pedreiro", "Cervejaria", "Fábrica de Armadilhas","Mansão do Herói", "Grande armazém", "Grande Celeiro", "Maravilha do Mundo", "Bebedouro para cavalos"];
		aLangAllBuildAltWithId = ["Bosque", "Poço de Barro", "Mina de Ferro", "Campo de Cereais", "", "Serração", "Alvenaria", "Fundição", "Moinho", "Padaria", "Armazém", "Celeiro", "Ferreiro", "Fábrica de Armaduras", "Praça de torneios", "Edifício principal", "Ponto de reunião militar", "Mercado", "Embaixada", "Quartel", "Cavalariça", "Oficina ", "Academia", "Esconderijo", "Casa do Povo", "Residência", "Palácio", "Tesouraria", "Companhia do Comércio", "Grande Quartel", "Grande Cavalariça", "Muralha", "Barreira", "Paliçada", "Pedreiro", "Cervejaria", "Fábrica de Armadilhas","Mansão do Herói", "Grande armazém", "Grande Celeiro", "Maravilha do Mundo", "Bebedouro para cavalos"];
		aLangAddTaskText = ["Adicionar tarefa", "Estilo", "Aldeia Activa", "Alvo", "Para", "Modo", "Ajuda na Construção", "Quantidade de recursos", "Mover para cima", "Mover para baixo", "Apagar", "&#160;&#160;&#160;Tarefas", "Mover ", "Eliminar todas as tarefas"];
		aLangTaskKind = ["Evolução", "Novo construção", "Ataque", "Pesquisa", "Treino", "Transporte", "NPC", "Demolição", "Celebração"];
		aLangGameText = ["Lvl", "Mercadores", "Identificação", "Capital", "Inicio", "this timeseting is unuseful now.", "Para", "Aldeia", "Transporte", "de", "Transporte para", "Transporte de", "A regressar de", "Recursos", "Edificio", "Construir novo edifício", "Vazio", "Nivel"];
		aLangRaceName = ["Romanos", "Teutões", "Gauleses"];
		aLangTaskOfText = ["Agendar Evolução", "Agendar nova construção", "ResourcesUpD", "OFF", "Iniciar", "ON", "Parar", "A distribuição dos campos desta aldeia é ", "Autotransporte", "Autotransporte não está aberto", "Aberto", "Transporte com sucesso", "Lista de agendamento", "Limit", "Default", "Alterar", "madeira/barro/ferro", "cereal", "Agendamento de demolição",
			"Agendamento de ataque", "Tipo de ataque", "Tempo de viagem", "Repetir número de vezes", "Tempo de intervalo","00:30:00","Alvo catapulta","Aleatório", "Desconhecido", "Vezes", " Mês", " Dia", "Tropas enviadas", "Agendamento de treino","localização de tropas","Agendamento de treino feito","Transporte personalizado","Setup Interval Time of Reload","This is the interval of page reload ,\n default são 20 minutos, Insira novo tempo:\n\n","Remain","Agendar Celebração","pequena celebração","grande celebração","Set Interval of Resources concentration","minutos",".",".","START","STOP","Schedule Improve","Improve Attack","Improve defence", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		aLangErrorText = ["Poucos recursos.", "Os trabalhadores já estão a trabalhar.", "Construção completa", "Inicio da construção", "Em desenvolvimento", "Seu Armazém é pequeno. Evolua o seu armazém para continuar a sua construção", "Seu Celeiro é pequeno. Evolua o seu Celeiro para continuar a sua construção", "Recursos suficientes","Já se encontra uma celebração em curso"];
		aLangOtherText = ["Nota importante", "Apenas os campos de recursos da capital <br/>podem ser elevados a nivel 20 . A sua capital <br/> nao está detectavel. Por favor visite o seu perfil.", "Atalho aqui ^_^", "Instalação concluída", "Cancelado", "Iniciar as tarefas", "Upgrade com sucesso", "Executar com sucesso", "Sua raça é desconhecida, e o seu tipo de tropa também. <br/>Visite o seu perfil para determinar as raça.<br/>", "Por favor visite a sua mansão do heroi para determinar<br/> a velocidade e o tipo de heroi."];
		aLangResources = ["Madeira","Barro","Ferro","Cereais"];
		aLangTroops[0] = ["Legionário", "Pretoriano", "Imperiano", "Equites Legati", "Equites Imperatoris", "Equites Caesaris", "Aríete", "Catapulta de Fogo", "Senador", "Colonizador", "Heroi"];
		aLangTroops[1] = ["Salteador", "Lanceiro", "Bárbaro", "Espião", "Paladino", "Cavaleiro Teutão", "Aríete", "Catapulta", "Chefe", "Colonizador", "Heroi"];
		aLangTroops[2] = ["Falange", "Espadachim", "Batedor", "Trovão Theutate", "Cavaleiro Druida", "Haeduano", "Aríete", "Trabuquete", "Chefe de Clã", "Colonizador", "Heroi"];
		aLangAttackType = ["Reforço", "Ataque", "Assalto"];
		break;

                case "my":
		aLangAllBuildWithId = ["Kawasan Pembalakan", "Kuari Tanat Liat", "Lombong Bijih Besi", "Ladang", "", "Kilang Papan", "Kilang Bata", "Faundri Besi", "Pengisar Bijian", "Kilang Roti", "Gudang", "Jelapang", "Kedai Senjata", "Kedai Perisai", "Gelanggang Latihan", "Bangunan Utama", "Titik Perhimpunan", "Pasar", "Kedutaan", "Berek", "Kandang Kuda", "Bengkel", "Akademi", "Gua", "Dewan Perbandaran", "Residen", "Istana", "Perbendaharaan", "Pejabat Dagangan", "Berek Besar", "Kandang Kuda Besar", "Tembok Bandar", "Tembok Tanah", "Pagar Kubu", "Kedai Tukang Batu", "Kilang Bir", "Pemerangkap","Rumah Agam Wira", "Gudang Besar", "Jelapang Besar", "Dunia Keajaiban", "Palung Kuda"];
		aLangAllBuildAltWithId = ["Kawasan Pembalakan", "Kuari Tanat Liat", "Lombong Bijih Besi", "Ladang", "", "Kilang Papan", "Kilang Bata", "Faundri Besi", "Pengisar Bijian", "Kilang Roti", "Gudang", "Jelapang", "Kedai Senjata", "Kedai Perisai", "Gelanggang Latihan", "Bangunan Utama", "Titik Perhimpunan", "Pasar", "Kedutaan", "Berek", "Kandang Kuda", "Bengkel", "Akademi", "Gua", "Dewan Perbandaran", "Residen", "Istana", "Perbendaharaan", "Pejabat Dagangan", "Berek Besar", "Kandang Kuda Besar", "Tembok Bandar", "Tembok Tanah", "Pagar Kubu", "Kedai Tukang Batu", "Kilang Bir", "Pemerangkap","Rumah Agam Wira", "Gudang Besar", "Jelapang Besar", "Dunia Keajaiban", "Palung Kuda"];
		aLangAddTaskText = ["Add task", "Style", "Active village", "Task target", "To", "Mode", "Construction support", "Resources concentration", "Move up", "Move down", "Del", "   Task contents", "Move ", "Delete all the tasks"];
		aLangTaskKind = ["Tingkatkan", "Bina bangunan", "Serang", "Selidik", "latih", "Angkut", "NPC", "musnah", "Perayaan"];
		aLangGameText = ["Tahap", "Pedagang", "ID", "Ibu Kota", "Waktu mula", "this timeseting is unuseful now.", "ke", "Kampung", "angkut", "dari", "Angkut ke", "Angkut dari", "Balik dari", "sumber", "bangunan", "Bina bangunan", "Kosong", "tahap"];
		aLangRaceName = ["Rom", "Teuton", "Gaul"];
		aLangTaskOfText = ["Schedule Upgrade", "Schedule NewBuild", "AutoResUpD", "Not_run", "Start", "Started", "Suspend", "The resource fields distribution of this village is ", "Autotransport", "Autotransport is not opened", "Opened", "Transport successfully", "Task List", "Trans_In_limit", "Default", "Modify", "Wood/Clay/Iron", "Crop", "Schedule demolition", "Schedule attack", "Attack type", "Travel time", "repeat times", "interval time","00:30:00","Catapult target","Random", "Unknown", "times", "Month", "Day", "Troops sent", "Schedule Train","Train site","TrainTask done","customTransport","setup interval time of reload","this is the interval of page reload ,\n default is 20 minutes, please insert new time:\n\n","Trans_Out_Rmn","ScheduleParty","small party","big party","setInterval of Resources concentration","minutes",".",".","START","STOP", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		aLangErrorText = ["Terlalu sedikit sumber", "Para pekerja sedang bekerja", "Construction completed", "Starting construction", "In development", "Your Warehouse is too small. Please upgrade your Warehouse to continue your construction", "Your Granary is too small. Please upgrade your Granary to continue your construction", "Enough resources","Lack of food: extend cropland first","There is already a celebration going on"];
		aLangOtherText = ["Important note", "Only the resource fields of the capital can be upgraded to level 20. Now your capital is not detected. Visit your Profile please.", "Shortcut here ^_^", "Setup completed", "Cancelled", "Start the tasks", "Upgrade successfully", "Run successfully", "Your race is unknown, therefore your troop type. Visit your Profile to determine your race.", "Please also visit your Hero's Mansion to determine the speed and the type of your hero."];
		aLangResources=["kayu","tanah liat","besi","tanaman"];
		aLangTroops[0] = ["Askar Legion", "Pengawal Pertahanan", "Askar Empayar", "Kesatria Diplomatik", "Kesatria Empayar", "Kesatria Jeneral", "Kereta Pelantak", "Tarbil Api", "Senator", "Peneroka", "Wira"];
		aLangTroops[1] = ["Askar Belantan", "Askar Lembing", "Askar Kapak", "Peninjau", "Kesatria Santo","Kesatria Teutonik", "Kereta Pelantak", "Tarbil", "Penghulu", "Peneroka", "Wira"];
		aLangTroops[2] = ["Falanks", "Askar Pedang", "Penjelajah", "Guruh Theutates", "Penunggang Druid", "Haeduan", "Kereta Pelantak", "Tarbil", "Pemimpin", "Peneroka", "Wira"];
		aLangAttackType = ["Bantuan", "Serangan: Normal", "Serangan: Serbuan"];
		break;


                case "nl":
		aLangAllBuildWithId = ["Houthakker", "Klei-afgraving", "IJzermijn", "Graanakker", "", "Zaagmolen", "Steenbakkerij", "Ijzersmederij", "Korenmolen", "Bakkerij", "Pakhuis", "Graansilo", "Wapensmid", "Uitrustingssmederij", "Toernooiveld", "Hoofdgebouw", "Verzamelenplaats", "Marktplaats", "Ambassade", "Barakken", "Stal", "Werkplaats", "Acedemie", "Schuilplaats", "Raadhuis", "Residentie", "Paleis", "Schatkamer", "Handelskantoor", "Grote Barakken", "Grote Stal", "Stadsmuur", "Muur van aarde", "Palissade", "Steenhouwerij", "Brouwerij", "Vallenzetter","Heldenhof", "Groot Pakhuis", "Grote Graansilo", "Wereldwonder", "Drinkplaats"];
		aLangAllBuildAltWithId = ["Houthakker", "Klei-afgraving", "IJzermijn", "Graanakker", "", "Zaagmolen", "Steenbakkerij", "Ijzersmederij", "Korenmolen", "Bakkerij", "Pakhuis", "Graansilo", "Wapensmid", "Uitrustingssmederij", "Toernooiveld", "Hoofdgebouw", "Verzamelenplaats", "Marktplaats", "Ambassade", "Barakken", "Stal", "Werkplaats", "Acedemie", "Schuilplaats", "Raadhuis", "Residentie", "Paleis", "Schatkamer", "Handelskantoor", "Grote Barakken", "Grote Stal", "Stadsmuur", "Muur van aarde", "Palissade", "Steenhouwerij", "Brouwerij", "Vallenzetter","Heldenhof", "Groot Pakhuis", "Grote Graansilo", "Wereldwonder", "Drinkplaats"];
		aLangAddTaskText = ["Taak toevoegen", "Type", "Gekozen dorp", "Taakdoel", "Naar", "Modus", "Bouwhulp", "Grondstofconcentratie", "Naar boven", "Naar benenden", "Del", "&#160;&#160;&#160;Doelen", "Bewegen ", "Verwijder alle taken"];  
		aLangTaskKind = ["Verbeteren", "Gebouw bouwen", "Aanvallen", "Onderzoeken", "Trainen", "Handel", "NPC", "Slopen", "Vieren"];  
		aLangGameText = ["Niveau", "Handelaren", "ID", "Hoofddorp", "Start tijd", "Deze tijdsinstelling is onbruikbaar op dit moment.", "Naar", "Dorp", "transport", "Van", "Transporteren naar", "Transporteren van", "Terugkeren van", "Grondstoffen", "Gebouw", "Nieuw gebouw bouwen", "Leeg", "Niveau"];  
                                aLangRaceName = ["Romeinen", "Germanen", "Galliërs"];  
		aLangTaskOfText = ["Upgrade plannen", "Nieuwbouw plannen", "Auto ResUpD", "Inactief", "Start", "Bezig", "Stop", "De grondverdeling van dit dorp is ", "Autotransport", "Autotransport is niet gestart", "Gestart", "Transport succesvol", "Takenlijst", "Trans In limit", "Standaard", "Aanpassen", "Hout/Klei/Ijzer", "Graan", "Slopen plannen",  
        "Aanval plannen", "Aanvalssoort", "Tijdsduur", "Herhalen", "tussentijd","00:30:00","Katapult doel","Random", "Onbekend", "keren", "Maand", "Dag", "Troepen verstuurd",  
        "Training plannen", "Trainingkant", "Trainingstaak voltooid", "Handmatig Transport", "Stel de tussentijd in","Dit is de tussentijd van de pagina herladen ,\n standaard is 20 minuten, stel a.u.b. een nieuwe tijd in:\n\n","Trans Out Rmn","Feest plannen","Klein Feest","Groot Feest","Stel tussentijd in voor grondstofconcentratie",  
        "minuten", ".",".","START","STOP","Verbetering plannen","Verbeter aanval","Verbeter uitrusting", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];  
                                aLangErrorText = ["Te weinig grondstoffen.", "Je bouwvakkers zijn al aan het werk.", "Bouwopdracht voltooid", "Bouwopdracht begint", "Bezig", "Je pakhuis is te klein. Verbeter je pakhuis om de bouwopdracht voort te zetten.", "Je graansilo is te klein. Verbeter je graansilo om de bouwopdracht voort te zetten", "Genoeg grondstoffen","Te weinig graanproductie: Verbeter eerst een graanveld","Er is al een feest gaande"];  
		aLangOtherText = ["Belangrijk bericht", "Alleen de grondstofvelden van het hoofddorp kunnen <br/>verbeterd worden tot niveau 20. Nu is je hoofddorp<br/> niet vastgesteld. Bezoek je profiel a.u.b.", "Afkorting hier ^_^", "Instellingen succesvol", "Geannuleerd", "Start de taken", "Verbetering succesvol", "Start succesvol", "Je ras is onbekend, daardoor ook je troeptype. <br/>Bezoek je profiel om je ras vast te stellen<br/>", "Bezoek a.u.b. ook je heldenhof om <br/> de snelheid en type van je held vast te stellen."];  
		aLangResources=["Hout","Klein","Ijzer","Graan"];  
		aLangTroops[0] = ["Legionair", "Praetoriaan", "Imperiaan", "Equites Legati", "Equites Imperatoris", "Equites Caesaris", "Ram", "Vuurkatapult", "Senator", "Kolonist", "Held"];  
		aLangTroops[1] = ["Knuppelvechter", "Speervechter", "Bijlvechter", "Verkenner", "Paladijn", "Germaanse Ridder", "Ram", "Katapult", "Leider", "Kolonist", "Held"];  
		aLangTroops[2] = ["Phalanx", "Zwaardvechter", "Padvinder", "Toetatis donder", "Druideruiter", "Haeduaan", "Ram", "Trebuchet", "Onderleider", "Kolonist", "Held"];  
		aLangAttackType = ["Versterking", "Aanval", "Overval"];  
		break;


case "hu": //Harrerp

		aLangAllBuildWithId = ["Favágó", "Agyagbánya", "Vasércbánya", "Búzafarm", "", "Fűrészüzem", "Agyagégető", "Vasöntöde", "Malom", "Pékség", "Raktár", "Magtár", "Fegyverkovács", "Páncélkovács", "Gyakorlótér", "Főépület", "Gyülekezőtér", "Piac", "Követség", "Kaszárnya", "Istálló", "Műhely", "Akadémia", "Rejtekhely", "Tanácsháza", "Rezidencia", "Palota", "Kincstár", "Kereskedelmi központ", "Nagy Kaszárnya", "Nagy Istálló", "Kőfal", "Földfal", "Cölöpfal", "Kőfaragó", "Sörfőzde", "Csapdakészítő", "Hősök háza", "Nagy Raktár", "Nagy Magtár", "Világcsoda","Lóitató"];
		aLangAllBuildAltWithId = ["Favágó", "Agyagbánya", "Vasércbánya", "Búzafarm", "", "Fűrészüzem", "Agyagégető", "Vasöntöde", "Malom", "Pékség", "Raktár", "Magtár", "Fegyverkovács", "Páncélkovács", "Gyakorlótér", "Főépület", "Gyülekezőtér", "Piac", "Követség", "Kaszárnya", "Istálló", "Műhely", "Akadémia", "Rejtekhely", "Tanácsháza", "Rezidencia", "Palota", "Kincstár", "Kereskedelmi központ", "Nagy Kaszárnya", "Nagy Istálló", "Kőfal", "Földfal", "Cölöpfal", "Kőfaragó", "Sörfőzde", "Csapdakészítő", "Hősök háza", "Nagy Raktár", "Nagy Magtár", "Világcsoda","Lóitató"];
		aLangAddTaskText = ["Feladat hozzáadása", "Feladat", "Aktív falu", "Feladat célja", "Ide", "Mode", "Construction support", "Resources concentration", "Fel", "Le", "Törlés", "   Feladatok", "Sorrend", "Összes feladat törlése"];
		aLangTaskKind = ["Kiépítés", "Új épület", "Támadás", "Fejlesztés", "Kiképzés", "Szállítás", "NPC", "Bontás", "Ünnep"];
		aLangGameText = ["Szint", "Kereskedők", "ID", "Capital", "Indítási idő", "az időbeállítás nem szükséges.", "ide", "Falu", "szállítás", "innen", "Szállítás ide", "Szállítás innen", "Visszaérkezés", "nyersanyag", "épület", "Új épület építése", "empty", "szint"];
		aLangRaceName = ["Római", "Germán", "Gall"];
		aLangTaskOfText = ["Időzített kiépítés", "Időzített építés", "AutoResUpD", "Not_run", "Start", "Started", "Suspend", "The resource fields distribution of this village is ", "Auto szállítás", "Autotransport is not opened", "Opened", "Szállítás kész", "Feladat lista", "Trans_In_limit", "Default", "Módosítás", "Fa/Agyag/Vasérc", "Búza", "Időzített bontás",
			"Időzítet támadás", "Támadás típus", "Utazási idő", "Ismétlés", "Idő intervallum","00:30:00","Katapult célpont","Véletlen", "Ismeretlen", "ismétlés", "Hónap", "Nap", "Egységek küldése",
			"Időzített kiképzés","Kiképzőhely","Kiképzés befejezve","Egyedi szállítás","Frissítési időintervallum beállítás","Ez az oldalfrissítési időintervallum,\n az alap 20 perc, írd be az új időt:\n\n","Trans_Out_Rmn","Időzített ünnepség","Kis ünnepség","Nagy ünnepség","setInterval of Resources concentration",
			"perc","áll","fut","indulj","állj","Időzített fejlesztés","Fegyver fejlesztés","Páncél fejlesztés", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		aLangErrorText = ["Too few resources.", "The workers are already at work.", "Építés kész", "Építés indul", "Fejlesztés folyamatban", "A raktárad túl kicsi. Építsd tovább a raktárt, hogy folytathasd az építést", "A magtárad túl kicsi. Építsd tovább a magtárt, hogy folytathasd az építést", "Elég nyersanyag","Élelemhiány: Előtte egy búzafarmot kell építened ","Jelenleg is ünnepelnek","There is already research going on"];
		aLangOtherText = ["Important note", "Only the resource fields of the capital can be upgraded to level 20. Now your capital is not detected. Visit your Profile please.", "Shortcut here ^_^", "Beállítás kész", "Cancelled", "Start the tasks", "Kiépítés kész", "Run successfully", "Your race is unknown, therefore your troop type. Visit your Profile to determine your race.", "Please also visit your Hero's Mansion to determine the speed and the type of your hero."];
		aLangResources= ["fa","agyag","vasérc","búza"];
		aLangTroops[0] = ["Légiós", "Testőr", "Birodalmi", "Equites Legati", "Equites Imperatoris", "Equites Caesaris", "Faltörő kos", "Tűzkatapult", "Szenátor", "Telepes", "Hős"]; //Római
		aLangTroops[1] = ["Buzogányos", "Lándzsás", "Csatabárdos", "Felderítő", "Paladin", "Teuton lovag", "Faltörő kos", "Katapult", "Törzsi vezető", "Telepes", "Hős"]; //Germán
		aLangTroops[2] = ["Phalanx", "Kardos", "Felderítő", "Theutat villám", "Druida lovas", "Haeduan", "Falromboló", "Harci-katapult", "Főnök", "Telepes", "Hős"]; //Gall
		aLangAttackType = ["Támogatás", "Támadás", "Rablás"];
		break;		


case "lv": //by sultāns updated the 16/04/2010
		aLangAllBuildWithId = ["Cirsma", "Māla Karjers", "Dzelzs Raktuves", "Labības Lauks", "", "Kokzāģētava", "Ķieģelu Fabrika", "Dzelzs Lietuve", "Dzirnavas", "Maiznīca", "Noliktava", "Klēts", "Ieroču kaltuve", "Bruņu kaltuve", "Turnīru laukums", "Galvenā ēka", "Pulcēšanās Vieta", "Tirgus laukums", "Vēstniecība", "Kazarmas", "Stallis", "Darbnīca", "Akadēmija", "Paslēptuve", "Rātsnams", "Rezidence", "Pils", "Dārgumu glabātuve", "Tirdzniecības Birojs", "Lielās Kazarmas", "Lielais Stallis", "Pilsētas Mūris", "Zemes Mūris", " Palisāde", "Akmeņlauztuve", "Alus Darītava", "Mednieku māja","Varoņu Savrupmāja", "Lielā Noliktava", "Liela Klēts", "Pasaules Brīnums"];
		aLangAllBuildAltWithId = ["Cirsma", "Māla Karjers", "Dzelzs Raktuves", "Labības Lauks", "", "Kokzāģētava", "Ķieģelu Fabrika", "Dzelzs Lietuve", "Dzirnavas", "Maiznīca", "Noliktava", "Klēts", "Ieroču kaltuve", "Bruņu kaltuve", "Turnīru laukums", "Galvenā ēka", "Pulcēšanās Vieta", "Tirgus laukums", "Vēstniecība", "Kazarmas", "Stallis", "Darbnīca", "Akadēmija", "Paslēptuve", "Rātsnams", "Rezidence", "Pils", "Dārgumu glabātuve", "Tirdzniecības Birojs", "Lielās Kazarmas", "Lielais Stallis", "Pilsētas Mūris", "Zemes Mūris", " Palisāde", "Akmeņlauztuve", "Alus Darītava", "Mednieku māja","Varoņu Savrupmāja", "Lielā Noliktava", "Liela Klēts", "Pasaules Brīnums"];
		aLangAddTaskText = ["Izveidot uzdevumu", "Veids", "Aktīvais ciems", "Uzdevuma mērķis", "| Mērķis", "Tips", "Celtniecības atbalsts", "Resursu koncentrācija", "Uz augšu", "Uz leju", "Izdzēst", "   Uzdevuma stāvoklis", "Pārvietot", "Dzēst visus uzdevumus"];
		aLangTaskKind = ["Uzlabot", "Jauna ēka", "Uzbrukt", "Izpētīt", "Apmācīt", "Nosūtīt resursus", "NPC", "Nojaukt", "Svinības"];
		aLangGameText = ["Līmenis", "Tirgotāji", "ID", "Galvaspilsēta", "Sākuma laiks", "Īslaicīgi nestrādā", "uz", "Ciems", "Transportēt", "no", "Transportēt uz", "Transportēt no", "Atgriezties no", "resursi", "ēka", "Būvēt jaunu ēku", "tukšs", "līmenis"];
		aLangRaceName = ["Romieši", "Ģermāņi", "Galli"];
		aLangTaskOfText = ["Ieplānot uzlabojumus", "Ieplānot jaunas ēkas celtniecību", "Uzlabot resursu laukus", "Izslēgt", "Uzsākt", "Ieslēgts", "Stop", "Resursu lauku izvietojums šajā ciemā", "Automātiska nosūtīšana", "Automātiska nosutīšana atslēgta", "Ieslēgts", "Veiksmīgi nosūtīts", "* Uzdevumi *", "Ienākošais limits", "Default", "Izmainīt", "Koks/Māls/Dzelzis", "Labība", "Ieplānot nojaukšanu",
			"Ieplānot uzbrukumu", "Uzbrukuma veids", "Laiks ceļā", "Atkartošanas laiks", "laika intervāls","00:30:00","Ar katapultām massēt","Pofig pa ko", "Nezināms", "laiki", "Mēnesis", "Diena", "Kareivji nosūtīti",
			"Ieplānot apmācību","Train site","Kareivju apmācība pabeigta","optimizēt transportēšanu","Ievadīt laiku pēc kura atkārtot iekraušanu","Šis ir intervāls lapas parlādēšanai ,\n pēc noklusējuma - 20 min., Lūdzu ievadiet jaunu laiku:\n\n","Izejošais limits","Ieplānot svinības","mazās svinības","lielās svinības","Uzstādīt laika intervālu resursu sūtīšanai",
			"minūtes", ".",".","Start", "Stop", "Ieplānot uzdevumus","Ieplānot uzbrukumus","Ieplanot aizsardzību", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		aLangErrorText = ["Nepietiek resursu", "Strādnieki jau strādā", "Būvniecība pabeigta", "Ir uzsākta būvniecība", "Attīstības stadija", "Nepietiek vietas noliktavā, lūdzu paplašiniet to", "Nepietiek vietas klētī, ludzu paplašinoiet to", "Pietiekoši resursu","","Svinības jau notiek"];
		aLangOtherText = ["Svarīgi", "Tikai galvaspilsētā resursu laukus var uzlabot uz 20Lvl. Galvaspilsāta nav noteikta. Ieejiet lūdzu savā profilā", "Shortcut here ^_^", "Iestatījumi pabeigti", "Atcelts", "Sākt uzdevumus", "Uzlabots veiksmīgi", "Viss notiek", "Jūsu rase ir unknown. Lūdzu ieejiet profilā.", "Kā arī, lūdzu ieejiet varoņu majā, lai noteiktu varoņa veidu un ātrumu"];
		aLangResources=["Koks","Māls","Dzelzs","Labība"];
		aLangTroops[0] = ["Leģionārs", "Pretorietis", "Iekarotājs", "Ziņnesis", "Romas Jātnieks", "Romas Bruņinieks", "Mūra Brucinātājs", "Uguns Katapulta", "Senators", "Kolonists", "Varonis"];
		aLangTroops[1] = ["Rungas Vēzētājs", "Šķēpnesis", "Karacirvja Vēzētājs", "Izlūks", "Bruņinieks", "Ģermāņu Bruņinieks", "Postītājs", "Katapultas", "Virsaitis", "Kolonists", "Varonis"];
		aLangTroops[2] = ["Falanga", "Zobenbrālis", "Pēddzinis", "Zibens Jātnieks", "Priesteris - Jātnieks", "Edujs", "Tarāns", "Trebušets", "Barvedis", "Kolonists", "Varonis"];
		aLangAttackType = ["Papildspēki", "Uzbrukums", "Iebrukums"];
		break;
	case "cl":
	case "mx":
	case "net": // thanks Renzo
		aLangAllBuildWithId = ["Leñador", "Barrera", "Mina", "Granja", "", "Serrería", "Ladrillar", "Fundición de Hierro", "Molino", "Panadería", "Almacén", "Granero", "Herrería", "Armería", "Plaza de torneos", "Edif. principal", "Plaza reuniones", "Mercado", "Embajada", "Cuartel", "Establo", "Taller", "Academia", "Escondite", "Ayuntamiento", "Residencia", "Palacio", "Tesoro", "Oficina de Comercio", "Cuartel Grande", "Establo Grande", "Muralla", "Terraplén", "Empalizada", "Cantero", "Cervecería", "Trampero","Hogar del héroe", "Almacén Grande", "Granero Grande", "Maravilla", "Abrevadero"];
		aLangAllBuildAltWithId = ["Leñador", "Barrera", "Mina", "Granja", "", "Serrería", "Ladrillar", "Fundición de Hierro", "Molino", "Panadería", "Almacén", "Granero", "Herrería", "Armería", "Plaza de torneos", "Edif. principal", "Plaza reuniones", "Mercado", "Embajada", "Cuartel", "Establo", "Taller", "Academia", "Escondite", "Ayuntamiento", "Residencia", "Palacio", "Tesoro", "Oficina de Comercio", "Cuartel Grande", "Establo Grande", "Muralla", "Terraplén", "Empalizada", "Cantero", "Cervecería", "Trampero","Hogar del héroe", "Almacén Grande", "Granero Grande", "Maravilla", "Abrevadero"];
		aLangAddTaskText = ["Añadir tarea", "Estilo", "Aldea activa", "Objetivo de Tarea", "Para", "Modo", "Soporte de Construcción", "Concentración de Recursos", "Ir arriba", "Ir abajo", "Borrar", "   Contenido de tarea", "Mover ", "Borrar todas las tareas"];
		aLangTaskKind = ["Subir", "Construir edificio nuevo", "Atacar", "Mejorar", "Entrenar", "Transportar", "NPC", "Demoler", "Fiesta"];
		aLangGameText = ["Nivel", "Comerciantes", "ID", "Capital", "Tiempo de Inicio", "esta prueba de tiempo no es útil.", "para", "Aldea", "transportar", "de", "Transportar a", "Transporte de", "Regreso de", "recursos", "edificio", "Construir nuevo edificio", "vacío", "nivel"];
		aLangRaceName = ["Romanos", "Germanos", "Galos"];
		aLangTaskOfText = ["Programar subida", "Programar nueva Construcción", "AutoResUpD", "OFF", "Empezar", "ON", "Suspender", "La distribución de campos de recursos de esta aldea es ", "Autotransporte", "Autotransporte no está abierto", "Abierto", "Transporte exitoso", "Lista de Tareas", "Trans_In_limit", "Por Defecto", "Modificar", "Madera/Barro/Hierro", "Cereal", "Programar demolición","Programar ataque", "Tipo de Ataque", "Tiempo de Viaje", "Número de Repeticiones", "Tiempo de intervalo","00:30:00","Objetivo de Catapulta","Al Azar", "Desconocido", "Veces", "Mes", "Día", "Tropas enviadas", "Programar Cadena","Sitio de Cadena","Tarea de Cadena completada","Transporte Custom","Establecer tiempo de intervalo de la recarga","este es el tiempo de intervalo entre cada recarga de la página,\n Por defecto es 20 minutos, por favor introduza el nuevo tiempo:\n\n","Trans_Out_Rmn","Programar Fiesta","fiesta pequeña","fiesta grande","Establecer intervalo de concentración de recursos","minutos",".",".","START","STOP", "Programar Mejora", "Mejorar Ataque", "Mejorar Defensa", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		aLangErrorText = ["Muy pocos recursos.", "Los aldeanos ya están trabajando.", "Construcción completa", "Empezando construcción", "En desarrollo", "Su almacén es muy pequeño. Por favor amplíe su almacén para continuar su construcción", "Su almacén es muy pequeño. Por favor amplíe su almacén para continuar su construcción", "Suficientes Recursos","Falta de Alimento: Amplíe una granja primero","Ya hay una fiesta en progreso","Ya hay una exploración en progreso"];
		aLangOtherText = ["Nota importante", "Solo los campos de recurso de la capital pueden ser ampliados a nivel 20. Su capital no ha sido detectada. Por favor visite su perfil.", "Atajo aquí ^_^", "Configuración completada", "Cancelado", "Empezar tareas", "Mejora Exitosa", "Ejecución exitosa", "Su raza es desconocida, asimismo su tipo de tropas. Visite su Perfil para determinar su raza.", "Por favor visite su Hogar del Heroe para determinar la velocidad y tipo de su heroe."];
		aLangResources = ["madera", "barro", "hierro", "cereal"];
		aLangTroops[0] = ["Legionario", "Pretoriano", "Imperano", "Equites Legati", "Equites Imperatoris", "Equites Caesaris", "Carnero", "Catapulta de Fuego", "Senador", "Colono", "Héroe"];
		aLangTroops[1] = ["Luchador de Porra", "Lancero", "Luchador de Hacha", "Emisario", "Paladín", "Jinete Teutón", "Ariete", "Catapulta", "Cabecilla", "Colono", "Héroe"];
		aLangTroops[2] = ["Falange", "Luchador de Espada", "Batidor", "Rayo de Teutates", "Jinete Druida", "Jinete Eduo", "Ariete", "Catapulta de Guerra", "Cacique", "Colono", "Héroe"];
		aLangAttackType = ["Refuerzo", "Ataque", "Atraco"];
		break;

	case "se": // thanks to Arias
		aLangAllBuildWithId = ["Skogshuggare", "Lergrop", "Järngruva", "Vetefält", "", "Sågverk", "Murbruk", "Järngjuteri", "Vetekvarn", "Bageri", "Magasin", "Silo", "Smedja", "Vapenkammare", "Tornerplats", "Huvudbyggnad", "Samlingsplats", "Marknadsplats", "Ambassad", "Baracker", "Stall", "Verkstad", "Akademi", "Grotta", "Stadshus", "Residens", "Palats", "Skattkammare", "Handelskontor", "Stor barack", "Stort stall", "Stadsmur", "Jordvall", "Palisad", "Stenmurare", "Bryggeri", "Fälla", "Hjältens egendom", "Stort magasin", "Stor silo", "Världsunder", "Vattenbrunn"];
		aLangAllBuildAltWithId = ["Skogshuggare", "Lergrop", "Järngruva", "Vetefält", "", "Sågverk", "Murbruk", "Järngjuteri", "Vetekvarn", "Bageri", "Magasin", "Silo", "Smedja", "Vapenkammare", "Tornerplats", "Huvudbyggnad", "Samlingsplats", "Marknadsplats", "Ambassad", "Baracker", "Stall", "Verkstad", "Akademi", "Grotta", "Stadshus", "Residens", "Palats", "Skattkammare", "Handelskontor", "Stor barack", "Stort stall", "Stadsmur", "Jordvall", "Palisad", "Stenmurare", "Bryggeri", "Fälla", "Hjältens egendom", "Stort magasin", "Stor silo", "Världsunder", "Vattenbrunn"];
		aLangAddTaskText = ["Lägg till uppgift", "Stil", "Aktiv by", "Task target", "Till", "Läge", "Kontruktions stöd", "Råvaro koncentration", "Flytta upp", "Flytta ner", "Radera", "Uppgifter", "Flytta ", "Radera alla uppgifterna"];
		aLangTaskKind = ["Uppgradering:", "Ny byggnad:", "Attack:", "Forskning:", "Träning:", "Transport:", "NPC:", "Demolish:", "Celebration:"];
		aLangGameText = ["Nivå ", "Handel", "ID", "Capital", "Start time", "this timesetting is unuseful now.", "till", "By", "Transport", "från", "Transport till", "Transport från", "Återvänder från", "Råvaror", "Byggnad", "Konstruera en ny byggnad", "Tom", "Nivå"];
		aLangRaceName = ["Romare", "Germaner", "Galler"];
		aLangTaskOfText = ["Schemalägg uppgradering", "Schemalägg ny byggnad", "Uppgradera fält", "Ej Aktiv", "Starta", "Startad", "Avbryt", "The resource fields distribution of this village is ", "Autotransport", "Autotransport is not opened", "Opened", "Transport lyckades", "Uppgifter", "Trans_In_limit", "Standard", "Ändra ", "Trä/Lera/Järn", "Vete", "Schemalägg demolition",
			"Schemalägg attack", "Attack type", "Res tid", "antal upprepningar", "interval time","00:30:00","Catapult target","Random", "Okänd", "times", "Månad", "Dag", "Trupper skickade", "Schemalägg Träning","Tränings plats","Träningen klar","Anpassad transport","Sätt intervallen för omladdning av sidan","Detta är intevallen för omladdning av sida,\n standard är 20 minuter, vänligen ange ny intervall:\n\n","Trans_Out_Rmn","Schemalägg fest","Liten fest","Stor fest","Sätt intervall av råvarukoncentration",
			"minuter",".",".","START","STOP","Schedule Improve","Improve Attack","Improve defence", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		aLangErrorText = ["För få råvaror", "Dina arbetare är redan ute på jobb", "Byggnad klar", "Påbörjar byggnad", "Under utveckling", "Ditt magasin är för litet. Vänligen uppgradera ditt magasin för att fortsätta ditt byggnadsarbete.", "Din silo är för liten. Vänligen uppgradera din silo för att fortsätta ditt byggnadsarbete.", "Tillräckligt med resurser", "Brist på mat: utöka vetefälten först", "En fest pågår redan."];
		aLangOtherText = ["Important note", "Only the resource fields of the capital can <br/>be upgraded to level 20. Now your capital<br/> is not detected. Visit your Profile please.", "Shortcut here ^_^", "Setup klar", "Avbruten", "Starta uppgifterna", "Upgrade successfully", "Run successfully", "Your race is unknown, therefore your troop type. <br/>Visit your Profile to determine your race.<br/>", "Please also visit your Hero's Mansion to determine<br/> the speed and the type of your hero."];
		aLangResources=["Trä","Lera","Järn","Vete"];
		aLangTroops[0] = ["Legionär", "Praetorian", "Imperiesoldat", "Spårare", "Imperieriddare", "Ceasarriddare", "Murbräcka", "Eld Katapult", "Senator", "Nybyggare", "Hjälte"];
		aLangTroops[1] = ["Klubbman", "Spjutman", "Yxman", "Scout", "Paladin", "Germansk Knekt", "Murbräcka", "Katapult", "Stamledare", "Nybyggare", "Hjälte"];
		aLangTroops[2] = ["Falanx", "Svärdskämpe", "Spårare", "Theutates Blixt", "Druidryttare", "Haeduan", "Murbräcka", "Krigskatapult", "Hövding", "Nybyggare", "Hjälte"];
		aLangAttackType = ["Förstärkning", "Normal", "Plundring"];
		break;

	case "it": // thanks Hamkrik, corrections by baldo 2011.04.08
		switch ( aTravianVersion ) {
			case "3.6": // translations for travian version 3.6
				// 2011.02.16 -- provided by Psea
				aLangAllBuildWithId = ["Bosco", "Pozzo d'argilla", "Miniera di ferro", "Campo di grano", "", "Segheria", "Fabbrica di Mattoni", "Fonderia", "Mulino", "Forno", "Magazzino", "Granaio", "Fabbro", "Armeria", "Arena", "Palazzo Pubblico", "Base militare", "Mercato", "Ambasciata", "Caserma", "Scuderia", "Officina", "Accademia", "Deposito Segreto", "Municipio", "Reggia", "Castello", "Camera del tesoro", "Ufficio Commerciale", "Grande Caserma", "Grande Scuderia", "Mura Cittadine", "Fortificazioni", "Palizzata", "Genio civile", "Birrificio", "Esperto di trappole", "Dimora dell'Eroe", "Grande Magazzino", "Grande Granaio", "Meraviglia", "Fonte Equestre"];
				aLangAllBuildAltWithId = ["Bosco", "Pozzo d'argilla", "Miniera di ferro", "Campo di grano", "", "Segheria", "Fabbrica di mattoni", "Fonderia", "Mulino", "Forno", "Magazzino", "Granaio", "Fabbro", "Armeria", "Arena", "Palazzo Pubblico", "Base militare", "Mercato", "Ambasciata", "Caserma", "Scuderia", "Officina", "Accademia", "Deposito Segreto", "Municipio", "Reggia", "Castello", "Camera del tesoro", "Ufficio Commerciale", "Grande Caserma", "Grande Scuderia", "Mura cittadine", "Fortificazioni", "Palizzata", "Genio civile", "Birrificio", "Esperto di trappole", "Dimora dell'Eroe", "Grande Magazzino", "Grande Granaio", "Meraviglia", "Fonte Equestre"];
				aLangAddTaskText = ["Aggiungere Compito", "Tipo", "Villaggio Attivo", "Obiettivo del Compito", "Coordinate", "Modalita'", "Supporto ampliamento risorse", "Concentrazione risorse", "SU", "GIU", "Cancella", "   Contenuto del Compito", "Muovere", "Cancella tutti i Compiti"]; 
				aLangTaskKind = ["Amplia", "Nuovo Edificio", "Attacco", "Ricerca", "Addestra", "Trasporto", "NPC", "Demolire", "Festa"]; 
				aLangGameText = ["Livello", "Mercanti", "ID", "Capitale", "Tempo di Inizio", "questa impostazione di tempo non si usa.", "Coordinate", "Villaggio", "trasporto", "dalla", "Trasporto alla", "Trasporto dalla", "Ritorno dalla", "risorse", "edifici", "Costruisci nuovo edificio", "vuoto", "livello"]; 
				aLangRaceName = ["Romani", "Teutoni", "Galli"]; 
				aLangTaskOfText = ["Programma Ampliamento", "Programma Nuovo Edificio", "AutoResUpD", "Non_attivo", "Start", "Iniziato", "Sospeso", "La distribuzione delle risorse di questo villaggio e' ", "Autotrasporto", "Autotrasporto non e aperto", "Aperto", "Trasportato con successo", "Lista Compiti", "Trans_In_limit", "Default", "Modificare", "Legno/Argilla/Ferro", "Grano", "Demolire",
					"Programma Attacco", "Tipo Attacco", "Tempo Percorso", "ripeti", "intervallo di tempo", "00:30:00", "Obiettivo Catapulta", "Random", "Sconosciuto", "volte", "Mese", "Giorno", "Truppe Inviate", "Programma Addestramento", "Edificio di addestramento", "Addestramento Finito", "Transporto Diverso", "ripeti numero volte", "questo é l'intervallo di ricarica pagina,\n default é 20 minuti, per favore inserire nuovo tempo:\n\n", "Trans_Out_Rmn", "Programma la Festa", "festa piccola", "Festa grande", "Imposta l'Intervallo di Concentrazione delle Risorse",
					"minuti", "in attesa", "corrente", "fare", "pausa", "Schedula Miglioria", "Migliora l'attacco", "Migliora la difesa", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"]; 
				aLangErrorText = ["Mancano le risorse.", "I Lavoratori Sono Pronti per Lavorare", "Edificio Completo", "Inizia Edificio", "Nella Ricerca", "Il tuo Magazzino é piccolo. Per favore amplia il magazzino per continuare la costruzione", "Il tuo Granaio e piccolo. Per favore amplia il granaio per continuare la costruzione", "Risorse sufficienti", "Mancanza di Cibo: Amplia i Campi di grano", "Pronta la Festa"]; 
				aLangOtherText = ["Nota Importante ", "Solo i Campi della Capitale possono essere ampliati al livello 20. La tua capitale non é determinata. Visita il tuo Profilo per favore.", "Shortcut here ^_^", "Setup compiuto", "Cancellato", "Inizia i Compiti", "Ampliato con successo", "Iniziato con successo", "La tua razza e' sconosciuta, anche il tipo di truppe. Visita il tuo Profilo per determinare la razza.", "Per favore visita Circolo degli eroi per determinare la velocita e il tipo di eroe."];
				aLangResources = ["legno", "argilla", "ferro", "grano"]; 
				aLangTroops[0] = ["Legionario", "Pretoriano", "Imperiano", "Emissario a cavallo", "Cavaliere del Generale", "Cavaliere di Cesare", "Ariete", "Onagro", "Senatore", "Colono", "Eroe"]; 
				aLangTroops[1] = ["Combattente", "Alabardiere", "Combattente con ascia", "Esploratore", "Paladino", "Cavaliere Teutonico", "Ariete", "Catapulta", "Comandante", "Colono", "Eroe"]; 
				aLangTroops[2] = ["Falange", "Combattente con spada", "Ricognitore", "Fulmine di Teutates", "Cavaliere druido", "Paladino di Haeduan", "Ariete", "Trabucco", "Capo tribù", "Colono", "Eroe"]; 
				aLangAttackType = ["Rinforzi", "Attacco", "Raid"];
				break;
			case "4.0": // translations for travian version 4.0
				// 2011.03.28 -- provided by Psea
				aLangAllBuildWithId = ["Bosco", "Pozzo d'argilla", "Miniera di ferro", "Campo di grano", "", "Segheria", "Fabbrica di Mattoni", "Fonderia", "Mulino", "Forno", "Magazzino", "Granaio", "Fucina", "Fucina", "Arena", "Palazzo Pubblico", "Base militare", "Mercato", "Ambasciata", "Caserma", "Scuderia", "Officina", "Accademia", "Deposito Segreto", "Municipio", "Reggia", "Castello", "Camera del tesoro", "Ufficio Commerciale", "Grande caserma", "Grande Scuderia", "Mura Cittadine", "Fortificazioni", "Palizzata", "Genio Civile", "Birrificio", "Esperto di trappole", "Dimora dell'Eroe", "Grande Magazzino", "Grande Granaio", "Meraviglia", "Fonte Equestre"];
				aLangAllBuildAltWithId = ["Bosco", "Pozzo d'argilla", "Miniera di ferro", "Campo di grano", "", "Segheria", "Fabbrica di mattoni", "Fonderia", "Mulino", "Forno", "Magazzino", "Granaio", "Fucina", "Fucina", "Arena", "Palazzo Pubblico", "Base militare", "Mercato", "Ambasciata", "Caserma", "Scuderia", "Officina", "Accademia", "Deposito Segreto", "Municipio", "Reggia", "Castello", "Camera del tesoro", "Ufficio Commerciale", "Grande Caserma", "Grande Scuderia", "Mura cittadine", "Fortificazioni", "Palizzata", "Genio Civile", "Birrificio", "Esperto di trappole", "Dimora dell'Eroe", "Grande Magazzino", "Grande Granaio", "Meraviglia", "Fonte Equestre"];
				aLangAddTaskText = ["Aggiungere Compito", "Tipo", "Villaggio Attivo", "Obiettivo del Compito", "Coordinate", "Modo", "Supporto di Costruzione", "Concentrazione risorse", "SU", "GIU", "Cancella", "   Contenuto del Compito", "Muovere", "Cancella tutti i Compiti"]; 
				aLangTaskKind = ["Amplia", "Nuovo Edificio", "Attacco", "Ricerca", "Addestra", "Trasporto", "NPC", "Demolire", "Festa"]; 
				aLangGameText = ["Livello", "Mercanti", "ID", "Capitale", "Tempo di Inizio", "Questa impostazione di tempo non si usa.", "Coordinate", "Villaggio", "Trasporto", "dalla", "Trasporto a", "Trasporto da", "In ritorno da", "Risorse", "Edifici", "Costruisci nuovo edificio", "vuoto", "livello"]; 
				aLangRaceName = ["Romani", "Teutoni", "Galli"]; 
				aLangTaskOfText = ["Programma Ampliamento", "Programma Nuovo Edificio", "AutoResUpD", "Non_attivo", "Start", "Iniziato", "Sospeso", "La distribuzione delle risorse di questo villaggio e' ", "Autotrasporto", "Autotrasporto non aperto", "Aperto", "Trasportato con successo", "Lista Compiti", "Trans_In_limit", "Default", "Modificare", "Legno/Argilla/Ferro", "Grano", "Demolire",
					"Programma Attacco", "Tipo Attacco", "Tempo Percorso", "ripeti", "intervallo di tempo", "00:30:00", "Obiettivo Catapulta", "Random", "Sconosciuto", "volte", "Mese", "Giorno", "Truppe Inviate", "Programma Addestramento", "Edificio addestramento", "Addestramento Finito", "Transporto Diverso", "Ripeti numero volte", "Questo é l'intervallo di ricarica pagina,\n default é 20 minuti, per favore inserisci il nuovo tempo:\n\n", "Trans_Out_Rmn", "Programma la Festa", "Festa piccola", "Festa grande", "Imposta l'Intervallo di Concentrazione delle Risorse",
					"minuti", "in attesa", "corrente", "fare", "pausa", "Schedula miglioria", "Migliora attacco", "Migliora difesa", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"]; 
				aLangErrorText = ["Mancano le risorse.", "I tuoi costruttori sono già occupati nella costruzione di un altro edificio", "Livello massimo raggiunto", "Inizia Edificio", "Nella Ricerca", "Il tuo Magazzino ", "Il tuo Granaio ", "Risorse disponibili", "Mancanza di cibo", "Pronta la Festa"]; 
				aLangOtherText = ["Nota Importante ", "Solo i Campi della Capitale possono essere ampliati al livello 20. La tua capitale non é determinata. Visita il tuo Profilo per favore.", "Shortcut here ^_^", "Setup compiuto", "Cancellato", "Inizia i Compiti", "Ampliato con successo", "Iniziato con successo", "La tua razza e' sconosciuta, anche il tipo di truppe. Visita il tuo Profilo per determinare la razza.", "Per favore visita il Circolo degli eroi per determinare la velocita e tipo di eroe."];
				aLangResources = ["legno", "argilla", "ferro", "grano"]; 
				aLangTroops[0] = ["Legionario", "Pretoriano", "Imperiano", "Emissario a cavallo", "Cavaliere del Generale", "Cavaliere di Cesare", "Ariete", "Onagro", "Senatore", "Colono", "Eroe"]; 
				aLangTroops[1] = ["Combattente", "Alabardiere", "Combattente con ascia", "Esploratore", "Paladino", "Cavaliere Teutonico", "Ariete", "Catapulta", "Comandante", "Colono", "Eroe"]; 
				aLangTroops[2] = ["Falange", "Combattente con spada", "Ricognitore", "Fulmine di Teutates", "Cavaliere druido", "Paladino di Haeduan", "Ariete", "Trabucco", "Capo tribù", "Colono", "Eroe"]; 
				aLangAttackType = ["Rinforzi", "Attacco", "Raid"];
				break;
			default:
				throwLogicError ( "initializeLangVars():: Travian Version not set, when initializing language variables for \'it\'!!" );
		}
		break;


	case "si": // thanks Bananana and Tuga
		aLangAllBuildWithId = ["Gozdar", "Glinokop", "Rudnik železa", "Žitno polje", "", "Žaga", "Opekarna", "Talilnica železa", "Mlin", "Pekarna", "Skladišče", "Žitnica", "Izdelovalec orožja", "Izdelovalec oklepov", "Vadbišče", "Gradbeni ceh", "Zbirališče", "Tržnica", "Ambasada", "Barake", "Konjušnica", "Izdelovalec oblegovalnih naprav", "Akademija", "Špranja", "Mestna hiša", "Rezidenca", "Palača", "Zakladnica", "Trgovski center", "Velike barake", "Velika konjušnica", "Mestno obzidje", "Zemljen zid", "Palisada", "Kamnosek", "Pivnica", "Postavljalec pasti", "Herojeva rezidenca", "Veliko skladišče", "Velika žitnica", "Čudež sveta"];
		aLangAllBuildAltWithId = ["Gozdar", "Glinokop", "Rudnik železa", "Žitno polje", "", "Žaga", "Opekarna", "Talilnica železa", "Mlin", "Pekarna", "Skladišče", "Žitnica", "Izdelovalec orožja", "Izdelovalec oklepov", "Vadbišče", "Gradbeni ceh", "Zbirališče", "Tržnica", "Ambasada", "Barake", "Konjušnica", "Izdelovalec oblegovalnih naprav", "Akademija", "Špranja", "Mestna hiša", "Rezidenca", "Palača", "Zakladnica", "Trgovski center", "Velike barake", "Velika konjušnica", "Mestno obzidje", "Zemljen zid", "Palisada", "Kamnosek", "Pivnica", "Postavljalec pasti", "Herojeva rezidenca", "Veliko skladišče", "Velika žitnica", "Čudež sveta"];
		aLangAddTaskText = ["Dodaj nalogo", "Style", "Aktivna vas", "Nadgradi", "Na", "Mode", "Construction support", "Resources concentration", "Prestavi gor", "Prestavi dol", "Izbriši", "   Naloge", "Premakni ", "Izbriši vse naloge"];
		aLangTaskKind = ["Nadgradi", "Zazidljiva parcela", "Napad", "Razišči", "Uri", "Transport", "NPC", "Demolish", "Festival"];
		aLangGameText = ["Stopnja", "Merchants", "ID", "Prestolnica", "Začetek ob", "Nastavitev časa ni pomembna.", "to", "Vas", "transport", "from", "Transport to", "Transport from", "Return from", "resources", "building", "Postavi nov objekt", "empty", "level"];
		aLangRaceName = ["Rimljani", "Tevtoni", "Galci"];
		aLangTaskOfText = ["Nadgradi kasneje", "Postavi nov objekt", "Surovine gor", "Pauza", "Začetek", "Začeto", "Prekliči", "The resource fields distribution of this village is ", "Autotransport", "Autotransport is not opened", "Opened", "Transport successfully", "Naloge", "Trans_In_limit", "Osnovno", "Spremeni", "Les/Glina/Železo", "Crop", "Podri kasneje",
			"Napadi kasneje", "Tip napada", "Do napada", "Ponovi", "Vrnitev čez","00:30:00","Tarča katapultov","Naključno", "Unknown", "times", "Month", "Day", "Enote poslane", "Uri kasneje","Mesto urjenja","Urjenje končano","customTransport","setup interval time of reload","this is the interval of page reload ,\n default is 20 minutes, please insert new time:\n\n","Trans_Out_Rmn","ScheduleParty","mali festival","veliki festival","setInterval of Resources concentration",
			"minute",".",".","START","STOP","Schedule Improve","Improve Attack","Improve defence", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		aLangErrorText = ["Primankljaj surovin.", "Delavci so že na delu.", "Zgrajeno", "Začnem z gradnjo", "V razvoju", "Seu Armazém é pequeno. Evolua o seu armazém para continuar a sua construção", "Seu Celeiro é pequeno. Evolua o seu Celeiro para continuar a sua construção", "Recursos suficientes","Já se encontra uma celebração em curso"];
		aLangOtherText = ["Pomembno!", "Samo polja v prestolnicigredo do stopnje 20 . A sua capitalnao está detectavel. Por favor visite o seu perfil.", "Atalho aqui ^_^", "Naloga uspešno dodana", "Preklicano", "Začni z nalogo", "Uspešno nadgrajeno", "Executar com sucesso", "Sua raça é desconhecida, e o seu tipo de tropa também.Visite o seu perfil para determinar as raça.", "Por favor visite a sua mansão do heroi para determinara velocidade e o tipo de heroi."];
		aLangResources=["Les","Glina","Železo","Žito"]; 
		aLangTroops[0] = ["Legionar", "Praetorijan", "Imperijan", "Izvidnik", "Equites Imperatoris", "Equites Caesaris", "Oblegovalni oven", "Ognjeni katapult", "Senator", "Kolonist", "Heroj"];
		aLangTroops[1] = ["Gorjačar", "Suličar", "Metalec sekir", "Skavt", "Paladin", "Tevtonski vitez", "Oblegovalni oven", "Mangonel", "Vodja", "Kolonist", "Heroj" ];
		aLangTroops[2] = ["Falanga", "Mečevalec", "Stezosledec", "Theutatesova Strela", "Druid", "Haeduan", "Oblegovalni oven", "Trebušet", "Poglavar", "Kolonist", "Heroj"];
		aLangAttackType = ["Okrepitev", "Napad", "Ropanje"];
		break;

	case "vn": // thanks Tuga
		aLangAllBuildWithId = ["Tiều Phu", "Mỏ Đất Sét", "Mỏ sắt", "Ruộng lúa", "", "Xưởng Gỗ", "Lò Gạch", "Lò Rèn", "Nhà Xay Lúa", "Lò Bánh", "Nhà Kho", "Kho Lúa", "Thợ Rèn", "Lò Luyện Giáp", "Võ Đài", "Nhà Chính", "Binh Trường", "Chợ", "Đại Sứ Quán", "Trại Lính", "Chuồng Ngựa", "Xưởng", "Học Viện", "Hầm Ngầm", "Tòa Thị Chính", "Lâu Đài", "Cung Điện", "Kho Bạc", "Phòng Thương Mại", "Doanh Trại Lớn", "Trại Ngựa", "Tường Thành", "Tường Đất", "Tường Rào", "Thợ Xây Đá", "Quán bia", "Hố Bẫy","Lâu đài tướng", "Nhà Kho Lớn", "Kho Lúa Lớn", "Kỳ Quan", "Tàu ngựa"];
		aLangAllBuildAltWithId = ["Tiều Phu", "Mỏ Đất Sét", "Mỏ sắt", "Ruộng lúa", "", "Xưởng Gỗ", "Lò Gạch", "Lò Rèn", "Nhà Xay Lúa", "Lò Bánh", "Nhà Kho", "Kho Lúa", "Thợ Rèn", "Lò Luyện Giáp", "Võ Đài", "Nhà Chính", "Binh Trường", "Chợ", "Đại Sứ Quán", "Trại Lính", "Chuồng Ngựa", "Xưởng", "Học Viện", "Hầm Ngầm", "Tòa Thị Chính", "Lâu Đài", "Cung Điện", "Kho Bạc", "Phòng Thương Mại", "Doanh Trại Lớn", "Trại Ngựa", "Tường Thành", "Tường Đất", "Tường Rào", "Thợ Xây Đá", "Quán bia", "Hố Bẫy","Lâu đài tướng", "Nhà Kho Lớn", "Kho Lúa Lớn", "Kỳ Quan", "Tàu ngựa"];
		aLangAddTaskText = ["Thêm nhiệm vụ", "Loại", "Tại làng", "Mục tiêu", "Tới", "Phương thức", "Tự động", "Tùy chỉnh", "Di chuyển lên", "Di chuyển xuống", "Xóa", "&#160;&#160;&#160;Nội dung công việc", "Di chuyển", "Xóa tất cả danh mục"];
		aLangTaskKind = ["Nâng cấp", "Kiến Trúc Mới", "Tấn công", "Nghiên cứu", "Huấn luyện", "Vận chuyển", "NPC", "Phá hủy", "ăn mừng"];
		aLangGameText = ["Cấp ", "Lái Buôn", "Tại vị trí", "Thủ đô", "Bắt đầu tại", "Chưa dùng được chức năng này.", "đến", "Làng", "vận chuyển", "từ", "Vận chuyển đến", "Vận chuyển từ", "Trở về từ", "Tài nguyên", "Kiến trúc", "Xây Kiến Trúc Mới", "không có gì", "Cấp"];
		aLangRaceName = ["Tộc Romans", "Tộc Teutons", "Tộc Gauls"];
		aLangTaskOfText = ["Lên lịch nâng cấp kiến trúc này", "Lên lịch xây kiến trúc này", "Tự động nâng cấp các mỏ", "Chưa kích hoạt", "Kích hoạt", "Đã kích hoạt", "Hủy", "Đây là làng loại ", "Tự động gửi tài nguyên", "Tự động gửi tài nguyên chưa được kích hoạt", "Đã được kích hoạt", "Gủi thành công", "Danh mục", "Tài nguyên bạn muốn nhận", "Mặc định", "Tùy chỉnh ", "Gỗ/Đất sét/Sắt", "Lúa", "Lên lịch phá hủy công trình",
			"Lên lịch tấn công làng này", "Loại tấn công", "Thời gian để đến nơi", "Số lần lặp lại", "Khoảng cách giữa các lần lặp lại","00:30:00","Mục tiêu cata","Ngẫu nhiên", "Chưa biết", "Giờ", "Tháng", "Ngày", "Đã gửi lính", "Lên lịch huấn luyện lính này","Train ubication","Lính đang được huấn luyện","Tùy chỉnh gửi tài nguyên","Thiết lập thời gian tải lại trang web","Đây là khoảng thởi gian tải lại trang web ,\n Mặc định là 20 phút, hãy điền vào số phút bạn muốn thay đổi:\n\n","Tài nguyên bạn muốn chừa lại","Lên lịch ăn mừng","Ăn mừng nhỏ","Ăn mừng lớn","Thiết lập khoảng thời gian bạn muốn gửi tài nguyên",
			"Phút","Đang tạm dừng","Đang thi hanh","Thi hành","Tạm dừng","Schedule Improve","Improve Attack","Improve defence", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		aLangErrorText = ["Quá ít tài nguyên.", "Công nhân đang làm nhiệm vụ khác.", "Kiến trúc đã hoàn thiên", "Bắt đầu xây dựng", "Đang xây dựng", "Nhà kho quá nhỏ. Hãy nâng cấp nhà kho mới xây dựng được kiến trúc", "Kho lúa quá nhỏ. Hãy nâng cấp kho lúa mới xây được kiến trúc", "Quá ít tài nguyên","","Hiện đang có buổi lễ ăn mừng"];
		aLangOtherText = ["Chú thích quan trọng", "Chỉ thủ đô mới có thể<br/>nâng cấp các mỏ lên level 20. THủ đô của bạn<br/> chưa thấy. hãy vào phần hồ sơ của bạn.", "Click vào đây", "Cài đặt hoàn tất", "Đã hủy", "Bắt đầu công việc", "Nâng cấp thành công", "Kích hoạt thành công", "CHưa biết bạn thuộc tộc nào. <br/>Vì vậy bạn nên vào hồ sơ để cập nhật thông tin.<br/>", "Bạn cũng nên vào Lâu Đài Tướng để cập nhật<br/> tốc đọ và loại tướng."];
		aLangResources=["Gỗ","Đất sét","Sắt","Lúa"];
		aLangTroops[0] = ["Lính Lê Dương", "Thị Vệ", "Chiến Binh Tinh Nhuệ", "Kỵ Binh Do Thám", "Kỵ Binh", "Kỵ Binh Tinh Nhuệ", "Xe Công Thành", "Máy Phóng Lửa", "Nguyên Lão", "Dân Khai Hoang", "Tướng"];
		aLangTroops[1] = ["Lính Chùy", "Lính Giáo", "Lính Rìu", "Do Thám", "Hiệp Sĩ Paladin", "Kỵ Sĩ Teutonic", "Đội Công Thành", "Máy Bắn Đá", "Thủ Lĩnh", "Dân Khai Hoang", "Tướng"];
		aLangTroops[2] = ["Lính Pha Lăng", "Kiếm Sĩ", "Do Thám", "Kỵ Binh Sấm Sét", "Tu Sĩ", "Kỵ Binh", "Máy Nện", "Máy Bắn Đá", "Tù Trưởng", "Dân Khai Hoang", "Tướng"];
		aLangAttackType = ["Tiếp viện", "Tấn công", "Cướp bóc"];
		break;

	case "ru": // by MMX
		aLangAllBuildWithId = ["Лесопилка", "Глиняный карьер", "Железный рудник", "Ферма", "", "Лесопильный завод", "Кирпичный завод", "Чугунолитейный завод", "Мукомольная мельница", "Пекарня", "Склад", "Амбар", "Кузница оружия", "Кузница доспехов", "Арена", "Главное здание", "Пункт сбора", "Рынок", "Посольство", "Казарма", "Конюшня", "Мастерская", "Академия", "Тайник", "Ратуша", "Резиденция", "Дворец", "Сокровищница", "Торговая палата", "Большая казарма", "Большая конюшня", "Стена", "Земляной вал", "Изгородь", "Каменотес", "Пивная", "Капканщик","Таверна", "Большой склад", "Большой амбар", "Чудо света", "Водопой"];
		aLangAllBuildAltWithId = ["Лесопилка", "Глиняный карьер", "Железный рудник", "Ферма", "", "Лесопильный завод", "Кирпичный завод", "Чугунолитейный завод", "Мукомольная мельница", "Пекарня", "Склад", "Амбар", "Кузница оружия", "Кузница доспехов", "Арена", "Главное здание", "Пункт сбора", "Рынок", "Посольство", "Казарма", "Конюшня", "Мастерская", "Академия", "Тайник", "Ратуша", "Резиденция", "Дворец", "Сокровищница", "Торговая палата", "Большая казарма", "Большая конюшня", "Стена", "Земляной вал", "Изгородь", "Каменотес", "Пивная", "Капканщик","Таверна", "Большой склад", "Большой амбар", "Чудо света", "Водопой"];
		aLangAddTaskText = ["Добавить задание", "Тип задания", "Активная деревня", "Цель задания", " Цель", "Тип", "Поддержка строительства", "Концентрация ресурсов", "Вверх", "Вниз", "", "", "","Снять все задания"];
		aLangTaskKind = ["Улучшить:", "Строим:", "Атаковать:", "Исследовать:", " нанять:", "Отправить ресурсы:", "NPC:", "Разрушить:", "Торжество:"];
		aLangGameText = [" ", "Торговцы", "ID", "Столица", "Время запуска", "временно не работает", "в", "Деревня", "Транспортировка", "из", "Транспортировка в", "Транспортировка из", "Отправка из", "ресурсы", "здание", "Построить новое здание", "пусто", "уровень"];
		aLangRaceName = ["Римляне", "Германцы", "Галлы"];
		aLangTaskOfText = ["Запланировать улучшение", "Запланировать новое здание", "Качать ресурсы", "Выкл", "(►)", "Вкл", "(■)", "Распределение полей в деревне: ", "Автоотправка", "Автоотправка выкл.", "Вкл.", "Успешно отправлено", "/Задания/", "Лимит ввоза", "Нет", "Правка ", "Дерево/Глина/Железо", "Зерно", "Запланировать разрушение",
			"Запланировать атаку", "Тип атаки", "Време в пути", "повторы", "через", "00:30:00", "Цель катов", "Случайно", "Неизвестно", " раз", "/", " :дата/время: ", "Войска",
			"Запланировать найм","Выбранное здание ", "Обучение войск завершено","Поставки", "Задать интревал обновления", "Это интервал обновления страницы ,\n по умолчанию - 20 минут, Введите новое время:\n\n", "Лимит вывоза", "Запланировать празднование", "Малый праздник", "Большой праздник", "Установка интервала концентрации ресов",
			"минуты", "Выключен", "Включено", "(►)", "(■)","Запланировать улучшение","Улучшить атаку","Улучшить защиту", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		aLangErrorText = ["Недостаточно сырья", "Все строители сейчас заняты", "Это здание отстроено полностью", "Начинаю строительство", "Процесс развития", "Недостаточна вместимость склада", "Недостаточна вместимость амбара", "Достаточно ресурсов", "Недостаток продовольствия: развивайте фермы.","Проводится торжество"];
		aLangOtherText = ["Важные заметки", "Только в столице поля могут быть до уровня 20.<br/>Столица не определена.Зайдите в профиль", "Ссылка тут ^_^", "<br/>Настройка завершена", "Отменено", "Начать задачи", " Улучшение прошло успешно", "Успешно", "Ваш народ неопределен.Пожалуйста зайдите в профиль.", "Также пожалуйста зайдите в таверну<br/>для определения типа и скорости героя"];
		aLangResources = ["Древесина","Глина","Железо","Зерно"];
		aLangTroops[0] = ["Легионер", "Преторианец", "Империанец", "Конный разведчик", "Конница императора", "Конница Цезаря", "Таран", "Огненная катапульта", "Сенатор", "Поселенец", "Герой"];
		aLangTroops[1] = ["Дубинщик", "Копьеносец", "Топорщик", "Скаут", "Паладин", "Тевтонская конница", "Стенобитное орудие", "Катапульта", "Вождь", "Поселенец", "Герой"];
		aLangTroops[2] = ["Фаланга", "Мечник", "Следопыт", "Тевтатский гром", "Друид-всадник", "Эдуйская конница", "Таран", "Требушет", "Предводитель", "Поселенец", "Герой"];
		aLangAttackType = ["Подкрепление", "Нападение", "Набег"];
		break;  

	case "rs": // by rsinisa
		aLangAllBuildWithId = ["Дрвосеча", "Рудник глине", "Рудник гвожђа", "Њива", "", "Пилана", "Циглана", "Ливница гвожђа", "Млин", "Пекара", "Складиште", "Силос", "Ковачница оружја", "Ковачница оклопа", "Витешка арена", "Главна зграда", "Место окупљања", "Пијаца", "Амбасада", "Касарна", "Штала", "Радионица", "Академија", "Склониште", "Општина", "Резиденција", "Палата", "Ризница", "Трговачки центар", "Велика касарна", "Велика штала", "Градски зид", "Земљани зид", "Палисада", "Каменорезац", "Пивница", "Постављач замки","Дворац хероја", "Велико складиште", "Велики силос", "Светско чудо", "Појилиште"];
		aLangAllBuildAltWithId = ["Дрвосеча", "Рудник глине", "Рудник гвожђа", "Њива", "", "Пилана", "Циглана", "Ливница гвожђа", "Млин", "Пекара", "Складиште", "Силос", "Ковачница оружја", "Ковачница оклопа", "Витешка арена", "Главна зграда", "Место окупљања", "Пијаца", "Амбасада", "Касарна", "Штала", "Радионица", "Академија", "Склониште", "Општина", "Резиденција", "Палата", "Ризница", "Трговачки центар", "Велика касарна", "Велика штала", "Градски зид", "Земљани зид", "Палисада", "Каменорезац", "Пивница", "Постављач замки","Дворац хероја", "Велико складиште", "Велики силос", "Светско чудо", "Појилиште"];
		aLangAddTaskText = ["Додај задатак", "Начин", "Активна села", "Задата мета", "на", "Мод", "Подршка изградње", "Концентрација ресурса", "Помери горе", "Помери доле", "Бриши", " Списак задатака", "Помери ", "Обриши све задатке"];
		aLangTaskKind = ["Надогради", "Нова градња", "Напад", "Истраживање", "Обучи", "Транспорт", "НПЦ", "Рушити", "Забава"];
		aLangGameText = ["ниво ", "Трговци", "ID", "Главни град", "Време почетка", "ово временско подешавање је бескорисно", " према", "Село", "транспорт", "из", "Пребацивање према", "Пребацивање из", "повратак из", "ресурси", "изградња", "Направи нову зграду", "празно", "ниво"];
		aLangRaceName = ["Римљани", "Тевтонци", "Гали"];
		aLangTaskOfText = ["Распоред за надоградњу", "Направи нови распоред", "Ауто надоградња ресурса", "Неактивно", "Покрени", "Активно", "Заустави", "Дистрибуција ресурсних поља овог села је ", "Аутотранспорт", "Аутотранспорт није отворен", "Отворен", "Транспорт успешан", "Листа задатака", "Транспорт са лимитом", "Подразумевано", "Измени", "Дрво/Гллина/Гвожђе", "Њива", "Листа рушења", "Листа напада", "Врста напада", "Време превоза", "број понављања", "Временски интервал","00:30:00","Мета катапулта","Насумично", "Непознат", " пута", ". месец, ", ". дан, у ", "Слање трупа", "Листа обуке","Место обуке","Тренинг задатак урадити","прилагођен транспорт","подеси време поновног учитавања "," ово је интервал поновног учитавања стране, \n подразумевана вредност је 20 минута, молимо Вас убаците ново време:\n \n","Остатак одлазног транспорта","Листа забава","мала забава","велика забава"," Подесите интервал концентрације ресурса ", "минути", "заустављено", "активно", "покрени", "паузирај","Распоред унапређења","Унапреди напад","Унапреди одбрану", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		aLangErrorText = ["Премало ресурса.", "Радници су већ на послу.", "Изградња завршена", "Покретање изградње", "У изградњи", "Складиште је премало. Проширите складиште како би наставили са изградњом", "Силос је премали. Проширите силос како би наставили са изградњом", "Довољно ресурса","Премало жита: прошири прво њиве","Прослава је већ у току"];
		aLangOtherText = ["Важна напомена", "Само у главном граду ресурсна поља могу бити проширена на ниво 20. Твој главни град није детектован, погледај свој профил.", "Пречица овде ^_^", "Подешавања готова", "Отказано", "Покрени задатке", "Надоградња успешна", "Покретање успешно", "Ваше племе је непознато, стога и врста трупа. Погледајте свој профил да видите који сте народ.","Такође посетите дворац хероја да сазнате брзину и тип свог хероја "];
		aLangResources=["дрво","глина","гвожђе","жито"];
		aLangTroops[0] = ["Легионар", "Преторијанац", "Империјанац", "Извиђач", "Императорова коњица", "Цезарева коњица", "Ован", "Ватрени катапулт", "Сенатор", "Насељеник", "Херој"];
		aLangTroops[1] = ["Батинар", "Копљаник", "Секираш", "Извиђач", "Паладин", "Тевтонски витез", "Ован", "Катапулт", "Поглавица", "Насељеник", "Херој"];
		aLangTroops[2] = ["Фаланга", "Мачевалац", "Извиђач", "Галски витез", "Друид", "Коњаник", "Ован", "Катапулт", "Старешина", "Насељеник", "Херој"];
		aLangAttackType = ["Појачање", "Нормалан", "Пљачка"];
		break;

	case "ba": // thanks  ieyp
		aLangAllBuildWithId = ["Drvosječa", "Rudnik gline", "Rudnik željeza", "Poljoprivredno imanje", "", "Pilana", "Ciglana", "Livnica", "Mlin", "Pekara", "Skladište", "Silos", "Oruzarnica", "Kovacnica oklopa", "Mejdan", "Glavna zgrada", "Mesto okupljanja", "Pijaca", "Ambasada", "Kasarna", "Stala", "Radionica", "Akademija", "Skloniste", "Opstina", "Rezidencija", "Palata", "Riznica", "Trgovacki centar", "Velika kasarna", "Velika stala", "Gradski zid", "Zemljani zid", "Taraba", "Kamenorezac", "Pivnica", "Zamkar","Dvorac heroja", "Veliko skladiste", "Veliki silos", "WW", "Pojiliste"];
		aLangAllBuildAltWithId = ["Drvosječa", "Rudnik gline", "Rudnik željeza", "Poljoprivredno imanje", "", "Pilana", "Ciglana", "Livnica", "Mlin", "Pekara", "Skladište", "Silos", "Oruzarnica", "Kovacnica oklopa", "Mejdan", "Glavna zgrada", "Mesto okupljanja", "Pijaca", "Ambasada", "Kasarna", "Stala", "Radionica", "Akademija", "Skloniste", "Opstina", "Rezidencija", "Palata", "Riznica", "Trgovacki centar", "Velika kasarna", "Velika stala", "Gradski zid", "Zemljani zid", "Taraba", "Kamenorezac", "Pivnica", "Zamkar","Dvorac heroja", "Veliko skladiste", "Veliki silos", "WW", "Pojiliste"];
		aLangAddTaskText = ["Dodaj zadatak", "Nacin", "Aktivna sela", "Zadata meta", "Prema", "Mod", "Podrska izgradnje", "Koncentracija resursa", "Pomeri gore", "Pomeri dole", "Del", "&#160;&#160;&#160;Task contents", "Pomeri ", "Obrisi sve zadatke"];
		aLangTaskKind = ["Unapredi", "Nova izgradnja", "Napad", "Istrazivanje", "Obuci", "Transport", "NPC", "Rusiti", "Zabava"];
		aLangGameText = ["Lvl", "Trgovci", "ID", "Glavni grad", "Vreme pocetka", "ovo vremensko podesavanje je beskorisno", "prema", "Selo", "transport", "iz", "Prebacivanje prema", "Prebacivanje iz", "povratak iz", "resursi", "izgradnja", "Napravi novu zgradu", "prazno", "nivo"];
		aLangRaceName = ["Rimljani", "Teutonci", "Gali"];
		aLangTaskOfText = ["Raspored za nadogradnju", "Napravi novi raspored", "AutoResUpD", "Not_run", "Pokreni", "Pokrenuto", "Zaustavi", "Distribucija resursnih polja ovog sela je ", "Autotransport", "Autotransport is not opened", "Opened", "Transport successfully", "Task List", "Transport sa limitom", "Podrazumevano", "Izmeni", "Drvo/Glina/Gvozdje", "Njiva", "Lista rusenja",
			"Lista napada", "Vrsta napada", "Vreme prevoza", "broj ponavljanja", "Vremenski interval","00:30:00","Meta katapulta","Nasumicno", "Nepoznat", "times", "Mesec", "Dan", "Slanje trupa", "Lista obuke","Mesto obuke","TreningZadatak uraditi","prilagodenTransport","podesi vreme ponovnog ucitavanja "," ovo je interval ponovnog ucitavanja strane, \n podrazumevan vrednost je 20 minuta, molimo vas ubacite novo vreme:\n  \n","Trans_Out_Rmn","Lista zabava","mala zabava","velika zabava"," Podesite interval koncentracie resursa ",
			"minuti", "zaustavljanje", "pokrece se", "pokreni", "pauza","Schedule Improve","Improve Attack","Improve defence", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		aLangErrorText = ["Premalo resursa. Buahaha :D", "Radnici su vec na poslu :P", "Izgradnja zavrsena", "Pokretanje izgradnje", "U izgradnji", "Skladiste je premalo. Prosirite skladiste kako bi nastavili sa izgradnjom", "Silos je malecak. Prosirite silos kako bi nastavili sa izgradnjom", "Dovoljno resursa","Premalo zita, prvo prosiri njive","Proslava je u toku"];
		aLangOtherText = ["Vazna napomena", "Samo u glavnom gradu mozete <br/> prosiriti resursna polja preko nivoa 10. Tvoj glavni grad <br/> nije otkriven, poseti svoj profil.", "Precica ovde ^^", "Podesavanja gotova", "Otkazano", "Pokreni zadatke", "Nadogradnja uspesna", "Pokretanje uspesno", "Vase pleme je nepoznato, stoga I tip trupa. Posetite <br/> svoj profil da vidite pleme. <br/>","Posetite dvorac heroja da saznate <br/> brzinu I tip svog heroja "];
		aLangResources=["drvo","glina","gvozdje","zito"];
		aLangTroops[0] = ["Legionar", "Pretorijanac", "Imperijanac", "Izvidjac", "Imperatorova konjica", "Cezareva konjica", "Ovan", "Vatreni katapult", "Senator", "Naseljenik", "Heroj"];
		aLangTroops[1] = ["Batinar", "Kopljanik", "Sekiras", "Izvidjac", "Paladin", "Tetutonski vitez", " Ovan ", "Katapult", "Poglavica", "Naseljenik", "Heroj"];
		aLangTroops[2] = ["Falanga", "Macevalac", "Izvidjac", "Teutateov grom", "Druid", "Heduan", " Ovan ", "Katapult", "Staresina", "Naseljenik", "Heroj"];
		aLangAttackType = ["Pojacanje", "Normalan", "Pljacka"];
		break;

	case "org":
	case "de": // by LohoC et al.
		switch ( aTravianVersion ) {
			case "3.6": // translations for travian version 3.6
				aLangAllBuildWithId = ["Holzfäller","Lehmgrube","Eisenmine","Getreidefarm","","Sägewerk","Lehmbrennerei","Eisengießerei","Getreidemühle","Bäckerei","Rohstofflager","Kornspeicher","Waffenschmiede","Rüstungsschmiede","Turnierplatz","Hauptgebäude","Versammlungsplatz","Marktplatz","Botschaft","Kaserne","Stall","Werkstatt","Akademie","Versteck","Rathaus","Residenz","Palast","Schatzkammer","Handelskontor","Große Kaserne","Großer Stall","Stadtmauer","Erdwall","Palisade","Steinmetz","Brauerei","Fallensteller","Heldenhof","Großes Rohstofflager","Großer Kornspeicher","Weltwunder","Pferdetränke"];
				aLangAllBuildAltWithId = ["Holzfäller","Lehmgrube","Eisenmine","Getreidefarm","","Sägewerk","Lehmbrennerei","Eisengießerei","Getreidemühle","Bäckerei","Rohstofflager","Kornspeicher","Waffenschmiede","Rüstungsschmiede","Turnierplatz","Hauptgebäude","Versammlungsplatz","Marktplatz","Botschaft","Kaserne","Stall","Werkstatt","Akademie","Versteck","Rathaus","Residenz","Palast","Schatzkammer","Handelskontor","Große Kaserne","Großer Stall","Stadtmauer","Erdwall","Palisade","Steinmetz","Brauerei","Fallensteller","Heldenhof","Großes Rohstofflager","Großer Kornspeicher","Weltwunder","Pferdetränke"];
				aLangAddTaskText = ["Aufgabe hinzufügen","Style","Aktives Dorf","Aufgaben Ziel","nach","Modus","Baubetreuung","Ressourcenkonzentration","Rauf","Runter","Entfernen","   Aufgaben Inhalte","Bewegen ","alle Aufgaben Löschen"];
				aLangTaskKind = ["Upgrade","Neues Gebäude","Angriff","Forschung","ausbilden","Transport","NPC","Zerstören","Fest"];
				aLangGameText = ["Lvl","Händler","ID","Hauptdorf","Startzeit","diese Zeiteinstellung ist nicht sinnvoll.","nach","Dorf","Transport","von","Transport nach","Transport von","Rückkehr aus","Rohstoffe","Gebäude","Neues Gebäude errichten","leer","Stufe"];
				aLangRaceName = ["Römer","Germane","Gallier"];
				aLangTaskOfText = ["Zeitplan Upgrade","Zeitplan Neu Bauen","AutoResRauf","Pausiert","Start","Laufend","Unterbrechen","Es wird Gebaut ","Autotransport","Autotransport ist nicht An","AN","Transport Erfolgreich","Aufgabenliste","Transportlimit (-)","Vorgabe","Ändern ","Holz/Lehm/Eisen","G3D","Zeitplan Abriss",
					"Zeitplan Angriff","Angriffsart","Laufzeit","Wiederholungen","Intervalzeit","00:30:00","Katapultziel","Zufall","Unbekannt","mal","Monat","Tag","Truppen senden","Zeitplan Ausbildung","Ausbildungsseite","Ausbildungsauftrag abgeschlossen","Manueller Transport","Setzte Intervalzeit für Reload","Dies ist der Interval zum Seitenreload ,\n Standard sind 20 Minuten, Bitte trage eine neue ein:\n\n","Transportlimit (+)","Partyplanung","Kleine Party","Große Party","Setzte den Interval der Ressourcenkonzentration",
					"Minuten",".",".","START","STOP","Zeitplan Verbessern","Angriff verbessern","Verteidigung verbessern", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
				aLangErrorText = ["Zu wenig Rohstoffe","Es wird bereits gebaut","vollständig ausgebaut","Starte Konstruktion","In Entwicklung","Zuerst Rohstofflager ausbauen","Zuerst Kornspeicher ausbauen","Genug Rohstoffe","Nahrungsmangel: Erst eine Getreidefarm ausbauen","Es wird bereits gefeiert."];
				aLangOtherText = ["Wichtige Notiz","Nur die Ressourcenfelder der Hauptstadt können<br/>bis Stufe 20 ausgebaut werden. Zur zeit ist deine Hauptstadt<br/>nicht identifiziert. Bitte besuche dein Profil.","Shortcut here ^_^","Setup fertiggestellt","Abgebrochen","Starte die Aufgaben","Upgrade war erfolgreich","Starten war erfolgreich","Deine Rasse ist unbekannt.<br/>Bitte besuche dein Profil.<br/>","Bitte besuche auch deinen Heldenhof um<br/>die Geschwindigkeit und die Art deines Helden zu bestimmen."];
				aLangResources = ["Holz","Lehm","Eisen","Getreide"];
				aLangTroops[0] = ["Legionär","Prätorianer","Imperianer","Equites Legati","Equites Imperatoris","Equites Caesaris","Rammbock","Feuerkatapult","Senator","Siedler","Held"];
				aLangTroops[1] = ["Keulenschwinger","Speerkämpfer","Axtkämpfer","Kundschafter","Paladin","Teutonen Reiter","Ramme","Katapult","Stammesführer","Siedler","Held"];
				aLangTroops[2] = ["Phalanx","Schwertkämpfer","Späher","Theutates Blitz","Druidenreiter","Haeduaner","Rammholz","Kriegskatapult","Häuptling","Siedler","Held"];
				aLangAttackType = ["Unterstützung","Angriff: Normal","Angriff: Raubzug"];
			break;
			case "4.0": // translations for travian version 4.0
				aLangAllBuildWithId = ["Holzfäller","Lehmgrube","Eisenmine","Getreidefarm","","Sägewerk","Lehmbrennerei","Eisengießerei","Getreidemühle","Bäckerei","Rohstofflager","Kornspeicher","Waffenschmiede","Schmiede","Turnierplatz","Hauptgebäude","Versammlungsplatz","Marktplatz","Botschaft","Kaserne","Stall","Werkstatt","Akademie","Versteck","Rathaus","Residenz","Palast","Schatzkammer","Handelskontor","Große Kaserne","Großer Stall","Stadtmauer","Erdwall","Palisade","Steinmetz","Brauerei","Fallensteller","Heldenhof","Großes Rohstofflager","Großer Kornspeicher","Weltwunder","Pferdetränke"];
				aLangAllBuildAltWithId = ["Holzfäller","Lehmgrube","Eisenmine","Getreidefarm","","Sägewerk","Lehmbrennerei","Eisengießerei","Getreidemühle","Bäckerei","Rohstofflager","Kornspeicher","Waffenschmiede","Schmiede","Turnierplatz","Hauptgebäude","Versammlungsplatz","Marktplatz","Botschaft","Kaserne","Stall","Werkstatt","Akademie","Versteck","Rathaus","Residenz","Palast","Schatzkammer","Handelskontor","Große Kaserne","Großer Stall","Stadtmauer","Erdwall","Palisade","Steinmetz","Brauerei","Fallensteller","Heldenhof","Großes Rohstofflager","Großer Kornspeicher","Weltwunder","Pferdetränke"];
				aLangAddTaskText = ["Aufgabe hinzufügen","Style","Aktives Dorf","Aufgaben Ziel","nach","Modus","Baubetreuung","Ressourcenkonzentration","Rauf","Runter","Entfernen","   Aufgaben Inhalte","Bewegen ","alle Aufgaben Löschen"];
				aLangTaskKind = ["Upgrade","Neues Gebäude","Angriff","Forschung","ausbilden","Transport","NPC","Zerstören","Fest"];
				aLangGameText = ["Lvl","Händler","ID","Hauptdorf","Startzeit","diese Zeiteinstellung ist nicht sinnvoll.","nach","Dorf","Transport","von","Transport nach","Transport von","Rückkehr aus","Rohstoffe","Gebäude","Neues Gebäude errichten","leer","Stufe"];
				aLangRaceName = ["Römer","Germane","Gallier"];
				aLangTaskOfText = ["Zeitplan Upgrade","Zeitplan Neu Bauen","AutoResRauf","Pausiert","Start","Laufend","Unterbrechen","Es wird Gebaut ","Autotransport","Autotransport ist nicht An","AN","Transport Erfolgreich","Aufgabenliste","Transportlimit (-)","Vorgabe","Ändern ","Holz/Lehm/Eisen","G3D","Zeitplan Abriss",
					"Zeitplan Angriff","Angriffsart","Laufzeit","Wiederholungen","Intervalzeit","00:30:00","Katapultziel","Zufall","Unbekannt","mal","Monat","Tag","Truppen senden","Zeitplan Ausbildung","Ausbildungsseite","Ausbildungsauftrag abgeschlossen","Manueller Transport","Setzte Intervalzeit für Reload","Dies ist der Interval zum Seitenreload ,\n Standard sind 20 Minuten, Bitte trage eine neue ein:\n\n","Transportlimit (+)","Partyplanung","Kleine Party","Große Party","Setzte den Interval der Ressourcenkonzentration",
					"Minuten",".",".","START","STOP","Zeitplan Verbessern","Angriff verbessern","Verteidigung verbessern", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
				aLangErrorText = ["Zu wenig Rohstoffe","Es wird bereits gebaut","vollständig ausgebaut","Starte Konstruktion","In Entwicklung","Zuerst Rohstofflager ausbauen","Zuerst Kornspeicher ausbauen","Genug Rohstoffe","Nahrungsmangel: Erst eine Getreidefarm ausbauen","Es wird bereits gefeiert."];
				aLangOtherText = ["Wichtige Notiz","Nur die Ressourcenfelder der Hauptstadt können<br/>bis Stufe 20 ausgebaut werden. Zur zeit ist deine Hauptstadt<br/>nicht identifiziert. Bitte besuche dein Profil.","Shortcut here ^_^","Setup fertiggestellt","Abgebrochen","Starte die Aufgaben","Upgrade war erfolgreich","Starten war erfolgreich","Deine Rasse ist unbekannt.<br/>Bitte besuche dein Profil.<br/>","Bitte besuche auch deinen Heldenhof um<br/>die Geschwindigkeit und die Art deines Helden zu bestimmen."];
				aLangResources = ["Holz","Lehm","Eisen","Getreide"];
				aLangTroops[0] = ["Legionär","Prätorianer","Imperianer","Equites Legati","Equites Imperatoris","Equites Caesaris","Rammbock","Feuerkatapult","Senator","Siedler","Held"];
				aLangTroops[1] = ["Keulenschwinger","Speerkämpfer","Axtkämpfer","Kundschafter","Paladin","Teutonen Reiter","Ramme","Katapult","Stammesführer","Siedler","Held"];
				aLangTroops[2] = ["Phalanx","Schwertkämpfer","Späher","Theutates Blitz","Druidenreiter","Haeduaner","Rammholz","Kriegskatapult","Häuptling","Siedler","Held"];
				aLangAttackType = ["Unterstützung","Angriff: Normal","Angriff: Raubzug"];
			break;
			default:
				throwLogicError ( "initializeLangVars():: Travian Version not set, when initializing language variables for \'de\' or \'org\'!!" );
		}
		break;

	case "ir": // nekooee
		aLangAllBuildWithId = ["هیزم شکن", "آجرسازی", "معدن آهن", "گندم زار", "", "چوب بری", "آجر پزی", "ذوب آهن", "آسیاب", "نانوایی", "انبار", "انبار غذا", "اسلحه سازی", "زره سازی", "میدان تمرین", "ساختمان اصلی", "اردوگاه", "بازار", "سفارتخانه", "سربازخانه", "اصطبل", "کارگاه", "دارالفنون", "مخفیگاه", "تالار شهر", "اقامتگاه", "قصر", "خزانه", "دفتر تجارت", "سربازخانه بزرگ", "اصطبل بزرگ", "دیوار شهر", "دیوار گلی", "پرچین", "سنگتراشی", "آبجوسازی", "تله ساز","عمارت قهرمان", "انبار بزرگ", "انبار غذای بزگ", "عمارت جادو", "آبخوری اسب ها"];
		aLangAllBuildAltWithId = ["هیزم شکن", "آجرسازی", "معدن آهن", "گندم زار", "", "چوب بری", "آجر پزی", "ذوب آهن", "آسیاب", "نانوایی", "انبار", "انبار غذا", "اسلحه سازی", "زره سازی", "میدان تمرین", "ساختمان اصلی", "اردوگاه", "بازار", "سفارتخانه", "سربازخانه", "اصطبل", "کارگاه", "دارالفنون", "مخفیگاه", "تالار شهر", "اقامتگاه", "قصر", "خزانه", "دفتر تجارت", "سربازخانه بزرگ", "اصطبل بزرگ", "دیوار شهر", "دیوار گلی", "پرچین", "سنگتراشی", "آبجوسازی", "تله ساز","عمارت قهرمان", "انبار بزرگ", "انبار غذای بزگ", "عمارت جادو", "آبخوری اسب ها"];
		aLangAddTaskText = ["اضافه کردن وظیفه", "شیوه", "دهکده فعال", "هدف کاری", "به سوی", "روش", "پشتیبانی از سازه ها", "ارسال معمولی (تمرکز منابع)", "بالا بردن", "پایین آوردن", "حذف", "&#160;&#160;&#160;محتوای وظیفه", "حرکت کردن", "پاک کردن تمام وظایف"];
		aLangTaskKind = ["ارتقاء دادن", "بنای جدید", "حمله", "تحقیق", "تربیت کردن", "انتقال دادن", "تعدیل منابع", "تخریب کردن", "برگزاری جشن"];
		aLangGameText = ["سطح", "بازرگانان", "شماره", "رئیس", "زمان شروع", "این تنظیم زمان در حال حاضر بی فایده است.", "به سوی", "دهکده", "انتقال دادن", "از", "انتقال به", "انتقال از", "بازگشت از", "منابع", "ساخنمان", "بنای ساختمان جدید", "خالی کردن", "سطح"];
		aLangRaceName = ["رومی ها" ,"توتن ها" ,"گول ها"];
		aLangTaskOfText = ["برنامه ارتقاء", "برنامه ساختمان جدید", "آپدیت اتوماتیک منابع", "در حال اجرا نمی باشد", "شروع", "شروع شده", "معلق کردن", "جدول توزیع منابع در این روستا هست ", "ارسال خودکار منابع", "حمل و نقل خودکار باز نمی باشد", "باز شده", "حمل و نقل با موفقیت", "لیست وظایف", "محدودیت انتقال", "پیشفرض", "اصلاح کردن", "چوب/خشت/آهن", "گندم", "برنامه تخریب",
			"برنامه حمله", "نوع حمله", "زمان سفر", "زمان تکرار", "فاصله زمانی","00:30:00","هدف منجنیق","تصادفی", "نامعلوم", "زمان", "ماه", "روز", "سربازان فرستاده شدند", "برنامه آموزش","محل آموزش","وظیفه آموزش انجام شد","ارسال سفارشی منابع"," فاصله زمانی از زمان راه اندازی مجدد"," این فاصله زمانی از صفحه بارگذاری شده است,\n پیشفرض 20 دقیقه می باشد, لطفا مقدار جدید را وارد کنید زمان:\n\n","Trans_Out_Rmn","برنامه جشن","جشن کوچک","جشن بزرگ"," تنظیم فاصله زمانی حمل معمولی در قسمت ارسال خودکار",
			"دقیقه", "در حال مکث", "در حرکت", "ادامه دادن", "مکث","Schedule Improve","Improve Attack","Improve defence", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		aLangErrorText = ["کمبود منابع.", "کارگران مشغول کار می باشند.", "ساخت و ساز پایان یافته", "ساخت و ساز شروع شد", "در حال توسعه", "انبار شما کوچک است لطفا انبار را ارتقاء دهید تا ساخت و ساز ادامه پیدا کند", "انبار غذای شما کوچک است لطفا انبار غذا را ارتقاء دهید تا ساخت و ساز ادامه یابد", "منابع کافی","کمبود مواد غذایی: ابتدا گندم زار را ارتقاء دهید","در حال حاضر یک جشن در حال برگذاری است"];
		aLangOtherText = ["توجه داشته باشید", "فقط منابع در دهکده پایتخت می توانند <br/>تا سطح 20 ارتقاء یابند. اکنون پایتخت شما<br/> تشخیص داده نشده است. لطفا از پروفایل خود دیدن کنید.", "دسترسی آسان در اینجا ^_^", "تنظیمات کامل شد", "لغو شد", "وظیفه آغاز شد", "ارتقاء با موفقیت انجام شد", "حرکت با موفقیت انجام شد", "نژاد شما معلوم نیست, بنابراین نوع لشکرتون مشخص نیست. <br/>برای مشخص شدن نژادتون از پروفایل خود دیدن کنید.<br/>", "همچنین لطفا دیدن کنید از عمارت قهرمان برای مشخص شدن <br/> سطح و نوع آن."];
		aLangResources=["گندم","آهن","خشت","چوب"];
		aLangTroops[0] = ["لژیونر", "محافظ", "شمشیرزن", "خبرچین", "شوالیه", "شوالیه سزار", "دژکوب", "منجنیق آتشین", "سناتور", "مهاجر", "قهرمان"];
		aLangTroops[1] = ["گرزدار", "نیزه دار", "تبرزن", "جاسوس", "دلاور", "شوالیه توتن", "دژکوب", "منجنیق", "رئیس", "مهاجر", "قهرمان"];
		aLangTroops[2] = ["سرباز پیاده", "شمشیرزن", "ردیاب", "رعد", "کاهن سواره", "شوالیه گول", "دژکوب", "منجنیق", "رئیس قبیله", "مهاجر", "قهرمان"];
		aLangAttackType = ["پشتیبانی", "حمله عادی", "حمله غارت"];
		break;

	case "ae": // By Dream1, SnTraL (2011.02.24)
		aLangAllBuildWithId = ["الحطاب", "حفرة الطين", "منجم حديد", "حقل القمح", "", "معمل النجاره", "مصنع البلوك", "مصنع الحديد", "المطاحن", "المخابز", "المخزن", "مخزن الحبوب", "الحداد", "مستودع الدروع", "ساحة البطولة", "المبنى الرئيسي", "نقطة التجمع", "السوق", "السفارة", "الثكنه", "الإسطبل", "المصانع الحربية", "الأكاديمية الحربية", "المخبأ", "البلدية", "السكن", "القصر", "الخزنة", "المكتب التجاري", "الثكنة الكبيرة", "الإسطبل الكبير", "حائط المدينة", "الحائط الأرضي", "الحاجز", "الحجّار", "المعصرة", "الصياد", "قصر الأبطال", "المخزن الكبير", "مخزن الحبوب الكبير", "معجزة العالم", "بِئْر سقي الخيول"];
		aLangAllBuildAltWithId = ["الحطاب", "حفرة الطين", "منجم حديد", "حقل القمح", "", "معمل النجاره", "مصنع البلوك", "مصنع الحديد", "المطاحن", "المخابز", "المخزن", "مخزن الحبوب", "الحداد", "مستودع الدروع", "ساحة البطولة", "المبنى الرئيسي", "نقطة التجمع", "السوق", "السفارة", "الثكنه", "الإسطبل", "المصانع الحربية", "الأكاديمية الحربية", "المخبأ", "البلدية", "السكن", "القصر", "الخزنة", "المكتب التجاري", "الثكنة الكبيرة", "الإسطبل الكبير", "حائط المدينة", "الحائط الأرضي", "الحاجز", "الحجّار", "المعصرة", "الصياد", "قصر الأبطال", "المخزن الكبير", "مخزن الحبوب الكبير", "معجزة العالم", "بِئْر سقي الخيول"];
		aLangAddTaskText = ["أضافة مهمة", "النمط", "القرية النشطة", "المهمة المستهدفة", "الى", "نمط", "دعم للبناء", "تكثيف الموارد", "تحريك للاعلى", "تحريك للاسفل", "حذف", "&#160;&#160;&#160;محتوى المهمه", "تحريك ", "حذف جميع المهام"];
		aLangTaskKind = ["تطوير", "تشييد مبنى", "هجوم", "بحث", "تدريب", "نقل", "تاجر المبادله", "هدم", "الاحتفال"];
		aLangGameText = ["مستوى", "التجار", "المعرف", "العاصمة", "بداية الوقت", "هذا الاعداد في الوقت الحالي عديم الفائدة.", " إلى", "القرية", "نقل", "من", "نقل الى", "نقل من", "العودة من", "الموارد", "المباني", "تشييد", "فارغ", "المستوى"];
		aLangRaceName = ["الرومان", "الجرمان", "الإغريق"];
		aLangTaskOfText = ["الجدول الزمني للترقية", "الجدول الزمني لبناء جديد", "التطوير التلقائي", "لايعمل", "بدأ", "أبتداء", "توقف مؤقتا", "الحقول / المباني توزيع لقرية ", "النقل التلقائي", "لم يتم فتح النقل التلقائي", "فتح", "تم النقل بنجاح", "قائمة المهام", "Trans_In_limit", "أفتراضي", "تعديل", "خشب/طين/حديد", "قمح", "الجدول الزمني للهدم",
			"الجدول الزمني للهجوم", "نوع الهجوم", "وقت الذهاب", "عدد مرات التكرار", "الفاصل الزمني","00:30:00","هدف المقاليع","عشوائي", "غير معروف", "مرات", "شهر", "يوم", "القوات ارسلت", "الجدول الزمني للتدريب","مكان تدريب","مهمة التدريب تمت","الجدول الزمني للنقل","إعداد الفاصل الزمني للتحديث","هذا هو الفاصل الزمني لتحديث الصفحة ,\n الافتراضي هو 20 دقيقة,يرجى وضع فاصل زمني جديد:\n\n","Trans_Out_Rmn","الجدول الزمني للإحتفال","إحتفال صغير","إحتفال كبير","تعيين الفاصل الزمني لتركيز الموارد",
			"دقائق", "متوقف", "يعمل", "تشغيل", "أيقاف","Schedule Improve","Improve Attack","Improve defence", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
		aLangErrorText = ["الموارد قليلة جداً.", "العمال مشغولون الآن.", "البناء منجز", "بدء البناء", "في التطوير", "يجب رفع مستوى المخزن أولاً ", "يجب رفع مستوى مخزن الحبوب أولاً ", "الموارد كافية","","يوجد احتفال جارية بالفعل"];
		aLangOtherText = ["ملاحظات هامه", "فقط حقول الموارد في العاصمة <br/>يتم ترقيتهم الى مستوى 20 .<br/> لم يتم معرفة العاصمه. يرجاء زيارة بطاقة العضويه.", "الاختصار هنا ^_^", "أكتمال الإعدادات", "ألغي", "بدء المهام", "تم التطوير بنجاح", "تم التشغيل بنجاح", "القبيلة غير معروفه, لابد من معرفة نوع القوات. <br/>يرجاء زيارة بطاقة العضويه لتحديد نوع القبيله.<br/>", "يرجاء ايضاً زيارة قصر الابطال<br/> لتحديد سرعة ونوع بطلك."];
		aLangResources=["الخشب","الطين","الحديد","القمح"];
		aLangTroops[0] = ["جندي أول", " حراس الإمبراطور", "جندي مهاجم", "فرقة تجسس", "سلاح الفرسان", "فرسان القيصر", "الكبش", "المقلاع الناري", "حكيم", "مستوطن", "البطل"]; //الرومان
		aLangTroops[1] = ["مقاتل بهراوة", "مقاتل برمح", "مقاتل بفأس", "الكشاف", "مقاتل القيصر", "فرسان الجرمان", "محطمة الأبواب", "المقلاع", "الزعيم", "مستوطن", "البطل"]; //الجرمان
		aLangTroops[2] = ["الكتيبة", "مبارز", "المستكشف", "رعد الجرمان", "فرسان السلت", "فرسان الهيدوانر", "محطمة الأبواب الخشبية", "المقلاع الحربي", "رئيس", "مستوطن", "البطل"]; //الإغريق
		aLangAttackType = ["مساندة", "هجوم: كامل", "هجوم: للنهب"];
		break;

	case "gr": // by adonis_gr (2011.03.30)
		switch ( aTravianVersion ) {
			case "3.6": // translations for travian version 3.6
				aLangAllBuildWithId = ["Ξυλοκόπος", "Ορυχείο πηλού", "Ορυχείο σιδήρου", "Χωράφι σιταριού", "Περιοχή", "Πριονιστήριο", "Πηλοποιείο", "Χυτήριο σιδήρου", "Μύλος σιταριού", "Αρτοποιείο", "Αποθήκη πρώτων υλών", "Σιταποθήκη", "Οπλοποιείο", "Πανοπλοποιείο", "Πλατεία αθλημάτων", "Κεντρικό κτίριο", "Πλατεία συγκεντρώσεως", "Αγορά", "Πρεσβεία", "Στρατόπεδο", "Στάβλος", "Εργαστήριο", "Ακαδημία", "Κρυψώνα", "Δημαρχείο", "Μἐγαρο", "Παλάτι", "Θησαυροφυλάκιο", "Εμπορικό γραφείο", "Μεγάλο Στρατόπεδο", "Μεγάλος Στάβλος", "Τείχος Πόλεως", "Χωμάτινο τεἰχος", "Τείχος με πάσσαλους", "Λιθοδὀμος", "Ζυθοποιείο", "Τοποθέτης παγίδων", "Περιοχή ηρώων", "Μεγάλη Αποθήκη", "Μεγάλη Σιταποθήκη", "Παγκόσμιο Θαύμα", "Μέρος ποτίσματος αλόγων"];
				aLangAllBuildAltWithId = ["Ξυλοκόπος", "Ορυχείο πηλού", "Ορυχείο σιδήρου", "Χωράφι σιταριού", "Περιοχή", "Πριονιστήριο", "Πηλοποιείο", "Χυτήριο σιδήρου", "Μύλος σιταριού", "Αρτοποιείο", "Αποθήκη πρώτων υλών", "Σιταποθήκη", "Οπλοποιείο", "Πανοπλοποιείο", "Πλατεία αθλημάτων", "Κεντρικό κτίριο", "Πλατεία συγκέντρωσης", "Αγορά", "Πρεσβεία", "Στρατόπεδο", "Στάβλος", "Εργαστήριο", "Ακαδημία", "Κρυψώνα", "Δημαρχείο", "Μἐγαρο", "Παλάτι", "Θησαυροφυλάκιο", "Εμπορικό γραφείο", "Μεγάλο Στρατόπεδο", "Μεγάλος Στάβλος", "Τείχος Πόλεως", "Χωμάτινο τεἰχος", "Τείχος με πάσσαλους", "Λιθοδὀμος", "Ζυθοποιείο", "Τοποθέτης παγίδων", "Περιοχή ηρώων", "Μεγάλη Αποθήκη", "Μεγάλη Σιταποθήκη", "Παγκόσμιο Θαύμα", "Μέρος ποτίσματος αλόγων"];
				aLangAddTaskText = ["Προσθηκη Εργασίας", "Style", "Ενεργό χωριό", "στοχος εργασίας", "Προς", "λειτουργία", "Construction support", "Resources concentration", "Μετακίνηση πάνω", "Μετακίνηση κάτω", "Διαγραφή", " Περιεχομενο εργασιών", "Move ", "Διαγραφή όλων των εργασιών"];
				aLangTaskKind = ["αναβάθμισης", "Κατασκευή κτηρίου", "Επίθεση", "Έρευνα", "εκπαίδευση", "αποστολή", "NPC", "κατεδάφιση", "γιορτή"];
				aLangGameText = ["επίπεδο", "Έμποροι", "ID", "Πρωτεύουσα", "Start time", "this timeseting is unuseful now.", "προς", "χωριό", "αποστολή", "από", "αποστολή προς", "αποστολή απο", "Επιστροφή απο", "πρώτες ύλες", "κτήριο", "Κατασκευή νέου κτηρίου", "κενό", "επίπεδο"];
				aLangRaceName = ["Ρωμαίοι", "Τεύτονες", "Γαλάτες"];
				aLangTaskOfText = ["Πρόγραμμα αναβάθμισης", "Πρόγραμμα Κατασκευή νέου κτηρίου", "Αυτοματη Αναβ. Υλών", "Not_run", "Έναρξη", "Ξεκίνησε", "Αναστολή", "The resource fields distribution of this village is ", "Αυτοματη αποστολή", "αύτοματη αποστολή είναι ανενεργή", "Ανοιχτό", "αποστολή επιτυχής", "Λίστα Εργασιών", "Trans In limit", "Προεπιλογή", "Τροποποίηση", "Ξύλο/Πηλός/Σιδήρος", "Σιτάρι", "Πρόγραμμα κατεδάφισης",
						"Προγραμματισμος επίθεσης", "Τυπος επίθεσης", "διάρκεια", "επανάληψεις", "Ενδιάμεσο χρονικό διάστημα", "00:30:00", "Στόχος καταπέλτη", "Τυχαίος", "Άγνωστο", "φορές", "Μήνας", "Ημέρα", "Στρατεύματα εστάλησαν",
						"Προγραμματησμος εκπαίδευσης", "Μέρος εκπαίδευσης", "εκπαίδευση Ολοκληρώθηκε", "προσαρμοσμένη αποστολή", "setup interval time of reload", "this is the interval of page reload ,\n default is 20 minutes, please insert new time:\n\n", "Trans Out Rmn", "Προγραμματισμος γιορτων", "Μικρή γιορτή", "Μεγάλη Γιορτή", "Set Interval of Resources concentration",
						"λεπτά", ".", ".", "Έναρξη", "Διακοπή", "Schedule Improve", "Βελτίωση Επίθεσης", "Βελτίωση άμυνας", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
				aLangErrorText = ["Πάρα πολύ λίγες πρώτες ύλες", "Ήδη εκτελούνται εργασίες", "Κατασκευή ολοκληρώθηκε", "Εναρξη Κατασκευής", "Σε εξέλιξη", "Η Αποθήκη πρώτων υλών σας ειναι πολύ μικρή. Παρακαλώ αναβάθμιστε την Αποθήκη πρώτων υλών για να συνεχιστεί η κατασκευή σας", "Η Σιταποθήκη σας ειναι πολύμικρή. Παρακαλώ αναβάθμιστε την σιταποθήκη για να συνεχιστεί η κατασκευή σας", "Αρκετες Πρώτες ύλες", "Έλλειψη τροφής: Αναβαθίστε πρώτα ενα Χωράφι σιταριού", "Πραγματοποιείται ήδη μία γιορτή"];
				aLangOtherText = ["Important note", "Μονο οι ύλες της Πρωτεύουσας μπορούν να αναβάθμιστουν στο επίπεδο 20. Now your Πρωτεύουσα is not detected. Visit your Profile please.", "Shortcut here ^_^", "Setup completed", "Ακυρωμένο", "Έναρξη των εργασιών", "Επιτυχής αναβάθμιση", "Εκτελέστηκε με επιτυχία", "Your race is unknown, therefore your troop type. Visit your Profile to determine your race.", "Please also visit your Περιοχή ηρώων to determine the speed and the type of your hero."];
				aLangResources = ["Ξύλο", "Πηλός", "Σίδερο", "Σιτάρι"];
				aLangTroops[0] = ["Λεγεωνάριοι", "Πραιτοριανός", "Ιμπεριανός", "Equites Legati", "Equites Imperatoris", "Equites Caesaris", "Πολιορκητικός κριός", "Καταπέλτης φωτιάς", "Γερουσιαστής", "Άποικος", "Hero"];
				aLangTroops[1] = ["Μαχητές με ρόπαλα", "Μαχητής με Ακόντιο", "Μαχητής με Τσεκούρι", "Ανιχνευτής", "Παλατινός", "Τεύτονας ιππότης", "Πολιορκητικός κριός", "Καταπέλτης", "Φύλαρχος", "Άποικος", "Hero"];
				aLangTroops[2] = ["Φάλαγγες", "Μαχητής με Ξίφος", "Ανιχνευτής", "Αστραπή του Τουτατή", "Δρυίδης", "Ιδουανός", "Πολιορκητικός κριός", "Πολεμικός καταπέλτης", "Αρχηγός", "Άποικος", "Hero"];
				aLangAttackType = ["Ενίσχυση", "Επίθεση: Κανονική", "Επίθεση: Επιδρομή"];
				break;
			case "4.0": // translations for travian version 4.0
				aLangAllBuildWithId = ["Ξυλοκόπος", "Ορυχείο πηλού", "Ορυχείο σιδήρου", "Χωράφι σιταριού", "Περιοχή", "Πριονιστήριο", "Πηλοποιείο", "Χυτήριο σιδήρου", "Μύλος σιταριού", "Αρτοποιείο", "Αποθήκη πρώτων υλών", "Σιταποθήκη", "Σιδηρουργείο", "Σιδηρουργείο", "Πλατεία αθλημάτων", "Κεντρικό κτίριο", "Πλατεία συγκεντρώσεως", "Αγορά", "Πρεσβεία", "Στρατόπεδο", "Στάβλος", "Εργαστήριο", "Ακαδημία", "Κρυψώνα", "Δημαρχείο", "Μἐγαρο", "Παλάτι", "Θησαυροφυλάκιο", "Εμπορικό γραφείο", "Μεγάλο Στρατόπεδο", "Μεγάλος Στάβλος", "Τείχος Πόλεως", "Χωμάτινο τεἰχος", "Τείχος με πάσσαλους", "Λιθοδὀμος", "Ζυθοποιείο", "Τοποθέτης παγίδων", "Περιοχή ηρώων", "Μεγάλη Αποθήκη", "Μεγάλη Σιταποθήκη", "Παγκόσμιο Θαύμα", "Μέρος ποτίσματος αλόγων"];
				aLangAllBuildAltWithId = ["Ξυλοκόπος", "Ορυχείο πηλού", "Ορυχείο σιδήρου", "Χωράφι σιταριού", "Περιοχή", "Πριονιστήριο", "Πηλοποιείο", "Χυτήριο σιδήρου", "Μύλος σιταριού", "Αρτοποιείο", "Αποθήκη πρώτων υλών", "Σιταποθήκη", "Σιδηρουργείο", "Σιδηρουργείο", "Πλατεία αθλημάτων", "Κεντρικό κτίριο", "Πλατεία συγκέντρωσης", "Αγορά", "Πρεσβεία", "Στρατόπεδο", "Στάβλος", "Εργαστήριο", "Ακαδημία", "Κρυψώνα", "Δημαρχείο", "Μἐγαρο", "Παλάτι", "Θησαυροφυλάκιο", "Εμπορικό γραφείο", "Μεγάλο Στρατόπεδο", "Μεγάλος Στάβλος", "Τείχος Πόλεως", "Χωμάτινο τεἰχος", "Τείχος με πάσσαλους", "Λιθοδὀμος", "Ζυθοποιείο", "Τοποθέτης παγίδων", "Περιοχή ηρώων", "Μεγάλη Αποθήκη", "Μεγάλη Σιταποθήκη", "Παγκόσμιο Θαύμα", "Μέρος ποτίσματος αλόγων"];
				aLangAddTaskText = ["Προσθηκη Εργασίας", "Style", "Ενεργό χωριό", "στοχος εργασίας", "Προς", "λειτουργία", "Construction support", "Resources concentration", "Μετακίνηση πάνω", "Μετακίνηση κάτω", "Διαγραφή", " Περιεχομενο εργασιών", "Move ", "Διαγραφή όλων των εργασιών"];
				aLangTaskKind = ["αναβάθμισης", "Κατασκευή κτηρίου", "Επίθεση", "Έρευνα", "εκπαίδευση", "αποστολή", "NPC", "κατεδάφιση", "γιορτή"];
				aLangGameText = ["επίπεδο", "Έμποροι", "ID", "Πρωτεύουσα", "Start time", "this timeseting is unuseful now.", "προς", "χωριό", "αποστολή", "από", "αποστολή προς", "αποστολή απο", "Επιστροφή απο", "πρώτες ύλες", "κτήριο", "Κατασκευή νέου κτηρίου", "κενό", "επίπεδο"];
				aLangRaceName = ["Ρωμαίοι", "Τεύτονες", "Γαλάτες"];
				aLangTaskOfText = ["Πρόγραμμα αναβάθμισης", "Πρόγραμμα Κατασκευή νέου κτηρίου", "Αυτοματη Αναβ. Υλών", "Not_run", "Έναρξη", "Ξεκίνησε", "Αναστολή", "The resource fields distribution of this village is ", "Αυτοματη αποστολή", "αύτοματη αποστολή είναι ανενεργή", "Ανοιχτό", "αποστολή επιτυχής", "Λίστα Εργασιών", "Trans In limit", "Προεπιλογή", "Τροποποίηση", "Ξύλο/Πηλός/Σιδήρος", "Σιτάρι", "Πρόγραμμα κατεδάφισης",
						"Προγραμματισμος επίθεσης", "Τυπος επίθεσης", "διάρκεια", "επανάληψεις", "Ενδιάμεσο χρονικό διάστημα", "00:30:00", "Στόχος καταπέλτη", "Τυχαίος", "Άγνωστο", "φορές", "Μήνας", "Ημέρα", "Στρατεύματα εστάλησαν",
						"Προγραμματησμος εκπαίδευσης", "Μέρος εκπαίδευσης", "εκπαίδευση Ολοκληρώθηκε", "προσαρμοσμένη αποστολή", "setup interval time of reload", "this is the interval of page reload ,\n default is 20 minutes, please insert new time:\n\n", "Trans Out Rmn", "Προγραμματισμος γιορτων", "Μικρή γιορτή", "Μεγάλη Γιορτή", "Set Interval of Resources concentration",
						"λεπτά", ".", ".", "Έναρξη", "Διακοπή", "Schedule Improve", "Βελτίωση Επίθεσης", "Βελτίωση άμυνας", "ResOvrFlow Chk", "Enabled", "Disabled", "AutoRes Crop Upgrd", "Toggle"];
				aLangErrorText = ["Πάρα πολύ λίγες πρώτες ύλες", "Ήδη εκτελούνται εργασίες", "Κατασκευή ολοκληρώθηκε", "Εναρξη Κατασκευής", "Σε εξέλιξη", "Η Αποθήκη πρώτων υλών σας ειναι πολύ μικρή. Παρακαλώ αναβάθμιστε την Αποθήκη πρώτων υλών για να συνεχιστεί η κατασκευή σας", "Η Σιταποθήκη σας ειναι πολύμικρή. Παρακαλώ αναβάθμιστε την σιταποθήκη για να συνεχιστεί η κατασκευή σας", "Αρκετές πρώτες", "Έλλειψη τροφής : Αναβαθμίστε πρώτα ένα χωράφι σιταριού", "Πραγματοποιείται ήδη μία γιορτή"];
				aLangOtherText = ["Important note", "Μονο οι ύλες της Πρωτεύουσας μπορούν να αναβάθμιστουν στο επίπεδο 20. Now your Πρωτεύουσα is not detected. Visit your Profile please.", "Shortcut here ^_^", "Setup completed", "Ακυρωμένο", "Έναρξη των εργασιών", "Επιτυχής αναβάθμιση", "Εκτελέστηκε με επιτυχία", "Your race is unknown, therefore your troop type. Visit your Profile to determine your race.", "Please also visit your Περιοχή ηρώων to determine the speed and the type of your hero."];
				aLangResources = ["Ξύλο", "Πηλός", "Σίδερο", "Σιτάρι"];
				aLangTroops[0] = ["Λεγεωνάριοι", "Πραιτοριανός", "Ιμπεριανός", "Equites Legati", "Equites Imperatoris", "Equites Caesaris", "Πολιορκητικός κριός", "Καταπέλτης φωτιάς", "Γερουσιαστής", "Άποικος", "Hero"];
				aLangTroops[1] = ["Μαχητές με ρόπαλα", "Μαχητής με Ακόντιο", "Μαχητής με Τσεκούρι", "Ανιχνευτής", "Παλατινός", "Τεύτονας ιππότης", "Πολιορκητικός κριός", "Καταπέλτης", "Φύλαρχος", "Άποικος", "Hero"];
				aLangTroops[2] = ["Φάλαγγες", "Μαχητής με Ξίφος", "Ανιχνευτής", "Αστραπή του Τουτατή", "Δρυίδης", "Ιδουανός", "Πολιορκητικός κριός", "Πολεμικός καταπέλτης", "Αρχηγός", "Άποικος", "Hero"];
				aLangAttackType = ["Ενίσχυση", "Επίθεση: Κανονική", "Επίθεση: Επιδρομή"];
				break;
		}
}

initializeLangSpecificDependentVars();

}

function throwLogicError ( msg ) {
	TS_debug ( msg );
	var errObj = new Error () ;
	errObj.name = "Logic Error";
	errObj.message = msg;
	throw errObj;
}

var nServerType = -1;         // 0 - normal, 1 - speed (3x),   2 - 2x,  3 - 5x, 4 - 10x
var nMerchantSpeedFactor =    [ 1,           3,                2,       5,      10];
var nMerchantCapacityFactor = [ 1,           3,                2,       5,      10];
var nTroopSpeedFactor =       [ 1,           2,                1,       2,      3];

function getServerType() {
	try {
		if ( nServerType == -1 ) {
			var strFirst = window.location.hostname.split(".")[0];
			var strFirst2 = strFirst.slice(-2);
		
			// find server type
			nServerType = 0;
			if ( strFirst.indexOf("speed") !== -1 || strFirst.indexOf("vip") !== -1 || strFirst.indexOf("research") !== -1 ) {
				nServerType = 1;
			}
			else if ( strFirst2 === "x2" ) {
				nServerType = 2;
			}
			else if ( strFirst2 === "x3" ) {
				nServerType = 1;
			}
			else if ( strFirst2 === "x5" ) {
				nServerType = 3;
			}
		}
		return nServerType;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getServerType():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getMerchantSpeedFactor() {
	return nMerchantSpeedFactor [ getServerType() ];
}

function getTroopSpeedFactor() {
	return nTroopSpeedFactor [ getServerType() ];
}

/**********************************************************
 * Functions used only for language translations
 */

function toggleTableInLangForm( tableId ) {
	if ( $(tableId+"_table") ) {
		if ( $(tableId+"_tablebody").style.display.indexOf("none") != -1 ) {
			$(tableId+"_tablecaption").innerHTML = "<b style='color: #71D000;' > Hide translations for " + tableId + " :</b>";
			$(tableId+"_tablebody").style.display = "";
			$(tableId+"_tablehead").style.display = "";
		}
		else {
			$(tableId+"_tablecaption").innerHTML = "<b style='color: #71D000;' > Show translations for " + tableId + " :</b>";
			$(tableId+"_tablebody").style.display = "none";
			$(tableId+"_tablehead").style.display = "none";
		}
	}
	return false;
}

function createTableForLangForm( tableId, referenceValuesArr, defaultValuesArr, customValuesArr, captionToolTip ) {
	var table1 = document.createElement("table");		table1.id = tableId + "_table";

	var t1caption = document.createElement("caption");
	var t1capspan = document.createElement("span");		t1capspan.id = tableId+ "_tablecaption";
	t1capspan.innerHTML = "<b style='color: #71D000;' > Show translations for " + tableId + " :</b>";
	t1capspan.addEventListener("click", function() { toggleTableInLangForm(tableId); return false; }, true );
	t1capspan.title = captionToolTip;
	t1caption.appendChild(t1capspan);

	//t1caption.innerHTML = "<h4 style='color: #71D000;' > Show translations for " + tableId + " :</h4>";
	//t1caption.title = "Click here to toggle display of this table.";
	//t1caption.addEventListener("click", function() { toggleTableInLangForm(tableId); return false; }, true );

	var t1head = document.createElement("thead");	t1head.id = tableId + "_tablehead"; t1head.setAttribute("style", "display:none");
	var t1hr = document.createElement("tr");
	var t1h1 = document.createElement("th"); t1h1.innerHTML = "'com' reference values";	t1hr.appendChild(t1h1);
	var t1h2 = document.createElement("th"); t1h2.innerHTML = "'" + Xlang + "' default values";	t1hr.appendChild(t1h2);
	var t1h3 = document.createElement("th"); t1h3.innerHTML = "'" + Xlang + "' custom values";	t1hr.appendChild(t1h3);
	t1head.appendChild(t1hr);
	table1.appendChild(t1caption);
	table1.appendChild(t1head);
	var t1body = document.createElement("tbody");
	t1body.id = tableId + "_tablebody"; t1body.setAttribute("style", "display:none");
	for ( var ctr = 0 ; ctr < referenceValuesArr.length ; ctr++ ) {
		var tr = document.createElement("tr");
		var td1 = document.createElement("td");
		var inputElem1 = "<input type='textarea' readonly='readonly' id='" + tableId + "_ref_" + ctr + "' style='width:300px;' value=\"" + 
					referenceValuesArr[ctr] + "\" />";
		td1.innerHTML += inputElem1;
		tr.appendChild(td1);
		var td2 = document.createElement("td");
		var inputElem2 = "<input type='textarea' readonly='readonly' id='" + tableId + "_def_" + ctr + "' style='width:300px;' value=\"" + 
					defaultValuesArr[ctr] + "\" />";
		td2.innerHTML += inputElem2;
		tr.appendChild(td2);
		var td3 = document.createElement("td");
		var inputElem3 = "<input type='textarea' id='" + tableId + "_cus_" + ctr + "' style='width:300px;' value=\"" +
					( (customValuesArr[ctr] != null) ? customValuesArr[ctr] : "" ) + "\" />";
		td3.innerHTML += inputElem3;
		tr.appendChild(td3);
		t1body.appendChild(tr);
	}
	table1.appendChild(t1body);

	return table1;
}

//////////
// this function displays a form for user to fill in the translations
//
function getLangTranslationsFromUser() {
	checkLang(); // find lang to use

	// if form already exists, then return
	if ( $("langTranslate_wrapper") != null )
		return;

	// first re-initialize lang vars.
	initializeLangVars();

	// create form
	var langTranslateForm = document.createElement("form");
	langTranslateForm.id = "langTranslateForm";

	// add close button
	var floatClose = "<a id='clearLangTransBubble' href='#' " +
				"class='floatClose' title='Close the Log window.'><img src='" + sCloseBtn + "' alt='X' /></a>";
	langTranslateForm.innerHTML += floatClose;
	langTranslateForm.innerHTML += "<br/>";

	// add heading
	langTranslateForm.innerHTML += "<h2 style='text-align:center;'>Enter translations for language '" + Xlang + "' [Travian Version " + aTravianVersion +" ]:</h2>";

	// get values from cookie
	var aLangAllBuildWithIdCook = GM_getValue( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangAllBuildWithId", "" );
	var aLangAllBuildAltWithIdCook = GM_getValue( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangAllBuildAltWithId", "" );
	var aLangGameTextCook = GM_getValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangGameText", "" );
	var aLangRaceNameCook = GM_getValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangRaceName", "" );
	var aLangErrorTextCook = GM_getValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangErrorText", "" );
	var aLangResourcesCook = GM_getValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangResources", "" );
	var aLangTroopsCook = new Array(3);
	aLangTroopsCook[0] = GM_getValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangTroops0", "" );
	aLangTroopsCook[1] = GM_getValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangTroops1", "" );
	aLangTroopsCook[2] = GM_getValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangTroops2", "" );
	var aLangAttackTypeCook = GM_getValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangAttackType", "" );

	aLangAllBuildWithIdCook = aLangAllBuildWithIdCook.split(gatLangSeparator);
	var toolTip1 = "Resource tiles or building names as shown on build page (build.php)";
	//flag ( "getLangTranslationsFromUser():: " + toolTip1 );
	var table1 = createTableForLangForm( "aLangAllBuildWithId", aLangAllBuildWithIdComDef, aLangAllBuildWithId, aLangAllBuildWithIdCook, toolTip1 );
	var div1 = document.createElement("div");
	div1.style.textAlign = "center";
	var span1 = document.createElement("span");
	span1.innerHTML = "<br/><b>" + toolTip1 + ":</b>"; 
	div1.appendChild(span1);
	div1.appendChild(table1);
	langTranslateForm.appendChild(div1);

	aLangAllBuildAltWithIdCook = aLangAllBuildAltWithIdCook.split(gatLangSeparator);
	var toolTip11 = "Resource tiles or building names as shown in tool-tips on dorf1.php and dorf2.php pages";
	//flag ( "getLangTranslationsFromUser():: " + toolTip11 );
	var table11 = createTableForLangForm( "aLangAllBuildAltWithId", aLangAllBuildAltWithIdComDef, aLangAllBuildAltWithId, aLangAllBuildAltWithIdCook, toolTip11 );
	var div11 = document.createElement("div");
	div11.style.textAlign = "center";
	var span11 = document.createElement("span");
	span11.innerHTML = "<br/><b>" + toolTip11 + ":</b>"; 
	div11.appendChild(span11);
	div11.appendChild(table11);
	langTranslateForm.appendChild(div11);

	aLangGameTextCook = aLangGameTextCook.split(gatLangSeparator);
	var toolTip2 = "Most important here is construct new building, transport from, transport to, return from";
	//flag ( "getLangTranslationsFromUser():: " + toolTip2 );
	var table2 = createTableForLangForm( "aLangGameText", aLangGameTextComDef, aLangGameText, aLangGameTextCook, toolTip2 );
	var div2 = document.createElement("div");
	div2.style.textAlign = "center";
	var span2 = document.createElement("span");
	span2.innerHTML = "<br/><b>" + toolTip2 + ":</b>"; 
	div2.appendChild(span2);
	div2.appendChild(table2);
	langTranslateForm.appendChild(div2);

	aLangRaceNameCook = aLangRaceNameCook.split(gatLangSeparator);
	var toolTip3 = "Race names";
	//flag ( "getLangTranslationsFromUser():: " + toolTip3 );
	var table3 = createTableForLangForm( "aLangRaceName", aLangRaceNameComDef, aLangRaceName, aLangRaceNameCook, toolTip3 );
	var div3 = document.createElement("div");
	div3.style.textAlign = "center";
	var span3 = document.createElement("span");
	span3.innerHTML = "<br/><b>" + toolTip3 + ":</b>"; 
	div3.appendChild(span3);
	div3.appendChild(table3);
	langTranslateForm.appendChild(div3);

	aLangErrorTextCook = aLangErrorTextCook.split(gatLangSeparator);
	var toolTip4 = "Errors shown by travian";
	//flag ( "getLangTranslationsFromUser():: " + toolTip4 );
	var table4 = createTableForLangForm( "aLangErrorText", aLangErrorTextComDef, aLangErrorText, aLangErrorTextCook, toolTip4 );
	var div4 = document.createElement("div");
	div4.style.textAlign = "center";
	var span4 = document.createElement("span");
	span4.innerHTML = "<br/><b>" + toolTip4 + ":</b>"; 
	div4.appendChild(span4);
	div4.appendChild(table4);
	langTranslateForm.appendChild(div4);

	aLangResourcesCook = aLangResourcesCook.split(gatLangSeparator);
	var toolTip5 = "Resource names";
	//flag ( "getLangTranslationsFromUser():: " + toolTip5 );
	var table5 = createTableForLangForm( "aLangResources", aLangResourcesComDef, aLangResources, aLangResourcesCook, toolTip5 );
	var div5 = document.createElement("div");
	div5.style.textAlign = "center";
	var span5 = document.createElement("span");
	span5.innerHTML = "<br/><b>" + toolTip5 + ":</b>"; 
	div5.appendChild(span5);
	div5.appendChild(table5);
	langTranslateForm.appendChild(div5);

	for ( var itr = 0 ; itr < 3 ; itr++ ) {
		aLangTroopsCook[itr] = aLangTroopsCook[itr].split(gatLangSeparator);
		var toolTip6 = "Troop names for ";
		switch ( itr ) {
			case 0: toolTip6 += "Romans"; break;
			case 1: toolTip6 += "Teutons"; break;
			case 2: toolTip6 += "Gauls"; break;
		}
		//flag ( "getLangTranslationsFromUser():: " + toolTip6 );
		var table6 = createTableForLangForm( "aLangTroops"+itr, aLangTroopsComDef[itr], aLangTroops[itr], aLangTroopsCook[itr], toolTip6 );
		var div6 = document.createElement("div");
		div6.style.textAlign = "center";
		var span6 = document.createElement("span");
		span6.innerHTML = "<br/><b>" + toolTip6 + ":</b>"; 
		div6.appendChild(span6);
		div6.appendChild(table6);
		langTranslateForm.appendChild(div6);
	}

	aLangAttackTypeCook = aLangAttackTypeCook.split(gatLangSeparator);
	var toolTip7 = "Attack types";
	//flag ( "getLangTranslationsFromUser():: " + toolTip7 );
	var table7 = createTableForLangForm( "aLangAttackType", aLangAttackTypeComDef, aLangAttackType, aLangAttackTypeCook, toolTip7 );
	var div7 = document.createElement("div");
	div7.style.textAlign = "center";
	var span7 = document.createElement("span");
	span7.innerHTML = "<br/><b>" + toolTip7 + ":</b>"; 
	div7.appendChild(span7);
	div7.appendChild(table7);
	langTranslateForm.appendChild(div7);

	// add ok button
	var tSubmitBtn = document.createElement("input");
	tSubmitBtn.name = "submitBtn";
	tSubmitBtn.value = "OK";
	tSubmitBtn.type = "button";
	tSubmitBtn.addEventListener('click', getLangTranslationsFromForm, true);
	langTranslateForm.appendChild(tSubmitBtn);

	// create wrapper
	var mWrapper = document.createElement("div");
	mWrapper.id = "langTranslate_wrapper";
	mWrapper.appendChild(langTranslateForm);

	// set position of wrapper
	var formCoords = getOption("LANG_TRANSLATE_POSITION", "50px_50px");
	formCoords = formCoords.split("_");
	mWrapper.style.top = formCoords[0];
	mWrapper.style.left = formCoords[1];
	mWrapper.style.width = "1000px";

	// add wrapper to body
	document.body.appendChild(mWrapper);
	$("clearLangTransBubble").addEventListener("click", closeLangTranslationsForm, true);
	// make wrapper draggable
	makeDraggable($("langTranslateForm"));
	//makeDraggable($("langTranslate_wrapper"));
}

function closeLangTranslationsForm() {
	customizeLangFromCookie();
	if ( $("langTranslate_wrapper") )
		document.body.removeChild($("langTranslate_wrapper"));
	return false;
}

function getLangTranslationsFromForm() {
	// get all translations from form and set in cookie
	var aLangAllBuildWithIdCook = new Array(aLangAllBuildWithIdComDef.length);
	for ( var ctr = 0 ; ctr < aLangAllBuildWithIdComDef.length ; ctr++ ) {
		var newValue = $("aLangAllBuildWithId_cus_"+ctr).value;
		if ( newValue != null && newValue != "" ) {
			aLangAllBuildWithIdCook[ctr] = newValue;
		}
	}
	GM_setValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangAllBuildWithId", aLangAllBuildWithIdCook.join(gatLangSeparator) );

	var aLangAllBuildAltWithIdCook = new Array(aLangAllBuildAltWithIdComDef.length);
	for ( var ctr = 0 ; ctr < aLangAllBuildAltWithIdComDef.length ; ctr++ ) {
		var newValue = $("aLangAllBuildAltWithId_cus_"+ctr).value;
		if ( newValue != null && newValue != "" ) {
			aLangAllBuildAltWithIdCook[ctr] = newValue;
		}
	}
	GM_setValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangAllBuildAltWithId", aLangAllBuildAltWithIdCook.join(gatLangSeparator) );

	var aLangGameTextCook = new Array(aLangGameTextComDef.length);
	for ( var ctr = 0 ; ctr < aLangGameTextComDef.length ; ctr++ ) {
		var newValue = $("aLangGameText_cus_"+ctr).value;
		if ( newValue != null && newValue != "" ) {
			aLangGameTextCook[ctr] = newValue;
		}
	}
	GM_setValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangGameText", aLangGameTextCook.join(gatLangSeparator) );

	var aLangRaceNameCook = new Array(aLangRaceNameComDef.length);
	for ( var ctr = 0 ; ctr < aLangRaceNameComDef.length ; ctr++ ) {
		var newValue = $("aLangRaceName_cus_"+ctr).value;
		if ( newValue != null && newValue != "" ) {
			aLangRaceNameCook[ctr] = newValue;
		}
	}
	GM_setValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangRaceName", aLangRaceNameCook.join(gatLangSeparator) );

	var aLangErrorTextCook = new Array(aLangErrorTextComDef.length);
	for ( var ctr = 0 ; ctr < aLangErrorTextComDef.length ; ctr++ ) {
		var newValue = $("aLangErrorText_cus_"+ctr).value;
		if ( newValue != null && newValue != "" ) {
			aLangErrorTextCook[ctr] = newValue;
		}
	}
	GM_setValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangErrorText", aLangErrorTextCook.join(gatLangSeparator) );

	var aLangResourcesCook = new Array(aLangResourcesComDef.length);
	for ( var ctr = 0 ; ctr < aLangResourcesComDef.length ; ctr++ ) {
		var newValue = $("aLangResources_cus_"+ctr).value;
		if ( newValue != null && newValue != "" ) {
			aLangResourcesCook[ctr] = newValue;
		}
	}
	GM_setValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangResources", aLangResourcesCook.join(gatLangSeparator) );

	var aLangTroopsCook = new Array(3);
	for ( var itr = 0 ; itr < 3 ; itr ++ ) {
		aLangTroopsCook[itr] = new Array(aLangTroopsComDef[itr].length);
		for ( var ctr = 0 ; ctr < aLangTroopsComDef[itr].length ; ctr++ ) {
			var newValue = $("aLangTroops"+itr+"_cus_"+ctr).value;
			if ( newValue != null && newValue != "" ) {
				aLangTroopsCook[itr][ctr] = newValue;
			}
		}
		GM_setValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangTroops"+itr, aLangTroopsCook[itr].join(gatLangSeparator) );
	}

	var aLangAttackTypeCook = new Array(aLangAttackTypeComDef.length);
	for ( var ctr = 0 ; ctr < aLangAttackTypeComDef.length ; ctr++ ) {
		var newValue = $("aLangAttackType_cus_"+ctr).value;
		if ( newValue != null && newValue != "" ) {
			aLangAttackTypeCook[ctr] = newValue;
		}
	}
	GM_setValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangAttackType", aLangAttackTypeCook.join(gatLangSeparator) );

	// all done, now remove the form
	closeLangTranslationsForm();
	return false;
}

//////////
// gets translations from cookie and set them to lang variables
//
function customizeLangFromCookie () {
	checkLang(); // find lang to use

	// first re-initialize lang vars.
	initializeLangVars();

	var aLangAllBuildWithIdCook = GM_getValue( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangAllBuildWithId", "" );
	var aLangAllBuildAltWithIdCook = GM_getValue( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangAllBuildAltWithId", "" );
	var aLangGameTextCook = GM_getValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangGameText", "" );
	var aLangRaceNameCook = GM_getValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangRaceName", "" );
	var aLangErrorTextCook = GM_getValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangErrorText", "" );
	var aLangResourcesCook = GM_getValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangResources", "" );
	var aLangTroopsCook = new Array(3);
	aLangTroopsCook[0] = GM_getValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangTroops0", "" );
	aLangTroopsCook[1] = GM_getValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangTroops1", "" );
	aLangTroopsCook[2] = GM_getValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangTroops2", "" );
	var aLangAttackTypeCook = GM_getValue ( "_translation_" + Xlang + "_" + aTravianVersion + "_aLangAttackType", "" );

	if ( aLangAllBuildWithIdCook != "" ) {
		aLangAllBuildWithIdCook = aLangAllBuildWithIdCook.split(gatLangSeparator);
		for ( var ctr = 0 ; ctr < aLangAllBuildWithIdComDef.length ; ctr++ ) {
			if ( aLangAllBuildWithIdCook[ctr] != "" && aLangAllBuildWithIdCook[ctr] != null ) {
				aLangAllBuildWithId[ctr] = aLangAllBuildWithIdCook[ctr]
			}
		}
	}

	if ( aLangAllBuildAltWithIdCook != "" ) {
		aLangAllBuildAltWithIdCook = aLangAllBuildAltWithIdCook.split(gatLangSeparator);
		for ( var ctr = 0 ; ctr < aLangAllBuildAltWithIdComDef.length ; ctr++ ) {
			if ( aLangAllBuildAltWithIdCook[ctr] != "" && aLangAllBuildAltWithIdCook[ctr] != null ) {
				aLangAllBuildAltWithId[ctr] = aLangAllBuildAltWithIdCook[ctr]
			}
		}
	}
	
	if ( aLangGameTextCook != "" ) {
		aLangGameTextCook = aLangGameTextCook.split(gatLangSeparator);
		for ( var ctr = 0 ; ctr < aLangGameTextComDef.length ; ctr++ ) {
			if ( aLangGameTextCook[ctr] != "" && aLangGameTextCook[ctr] != null ) {
				aLangGameText[ctr] = aLangGameTextCook[ctr]
			}
		}
	}

	if ( aLangRaceNameCook != "" ) {
		aLangRaceNameCook = aLangRaceNameCook.split(gatLangSeparator);
		for ( var ctr = 0 ; ctr < aLangRaceNameComDef.length ; ctr++ ) {
			if ( aLangRaceNameCook[ctr] != "" && aLangRaceNameCook[ctr] != null ) {
				aLangRaceName[ctr] = aLangRaceNameCook[ctr]
			}
		}
	}

	if ( aLangErrorTextCook != "" ) {
		aLangErrorTextCook = aLangErrorTextCook.split(gatLangSeparator);
		for ( var ctr = 0 ; ctr < aLangErrorTextComDef.length ; ctr++ ) {
			if ( aLangErrorTextCook[ctr] != "" && aLangErrorTextCook[ctr] != null ) {
				aLangErrorText[ctr] = aLangErrorTextCook[ctr]
			}
		}
	}

	if ( aLangResourcesCook != "" ) {
		aLangResourcesCook = aLangResourcesCook.split(gatLangSeparator);
		for ( var ctr = 0 ; ctr < aLangResourcesComDef.length ; ctr++ ) {
			if ( aLangResourcesCook[ctr] != "" && aLangResourcesCook[ctr] != null ) {
				aLangResources[ctr] = aLangResourcesCook[ctr]
			}
		}
	}

	if ( aLangTroopsCook[0] != "" && aLangTroopsCook[1] != "" && aLangTroopsCook[2] != "" ) {
		for ( var itr = 0 ; itr < 3 ; itr++ ) {
			aLangTroopsCook[itr] = aLangTroopsCook[itr].split(gatLangSeparator);
			for ( var ctr = 0 ; ctr < aLangTroopsComDef[itr].length ; ctr++ ) {
				if ( aLangTroopsCook[itr][ctr] != "" && aLangTroopsCook[itr][ctr] != null ) {
					aLangTroops[itr][ctr] = aLangTroopsCook[itr][ctr]
				}
			}
		}
	}

	if ( aLangAttackTypeCook != "" ) {
		aLangAttackTypeCook = aLangAttackTypeCook.split(gatLangSeparator);
		for ( var ctr = 0 ; ctr < aLangAttackTypeComDef.length ; ctr++ ) {
			if ( aLangAttackTypeCook[ctr] != "" && aLangAttackTypeCook[ctr] != null ) {
				aLangAttackType[ctr] = aLangAttackTypeCook[ctr]
			}
		}
	}

	initializeLangSpecificDependentVars();
}


function initializeLangSpecificDependentVars() {
	// initialize aLangAllResInDorf1
	//aLangAllResInDorf1 = aLangAllBuildWithId.slice(0,4); // no more required

	// initialize allsourceString, allbuildString & allString...
	allsourceString = aLangAllBuildWithId.slice(0,4).join ( gatLangSeparator ) + gatLangSeparator + aLangAllBuildAltWithId.slice(0,4).join ( gatLangSeparator );
	allbuildString = aLangAllBuildWithId.slice(5).join ( gatLangSeparator ) + gatLangSeparator + aLangAllBuildAltWithId.slice(5).join ( gatLangSeparator );
	allString = allsourceString + gatLangSeparator + allbuildString;

	// compulsorily do everytime to incorporate manual language translations
	//name2gid = getCookie("name2gid");
	//if(!name2gid)
	if ( getuid() != null ) { // getuid() returns null on login page
		name2gid = {};
		for(var i = 0; i < aLangAllBuildWithId.length; i++)
		{
			var gid = ( i < 4 ) ? i+1 : i;
			gid = ( i == 4 ) ? 0 : gid;
			name2gid [ aLangAllBuildWithId[i] ] = gid; 
			if ( aLangAllBuildAltWithId )
			{
	//			TS_debug("aLangAllBuildAltWithId return true " +aLangAllBuildAltWithId);
				var altStr = aLangAllBuildAltWithId[i];	
				if(altStr && altStr != "")
					name2gid [ altStr ] = gid;
			}
		}
		setCookie("name2gid",name2gid);
	}
}

/******************************************************
 * Setting game parameters which are not language-specific
 */
// initialize maxlevel, used only by createNewbuildLnk() & createbuildlink()
var maxlevel = ["10", "10", "10", "10", "0", "5", "5", "5", "5", "5", "20", "20", "20", "20", "20", "20", "20", "20", "20", "20", "20", "20", "20", "10", "20", "20", "20", "20", "20", "20", "20", "20", "20", "20", "20", "10", "20", "20", "20", "20", "100", "20"];

// initialize troopspeed for all race types
var troopspeed = new Array(3);
troopspeed[0] = ["6", "5", "7", "16", "14", "10", "4", "3", "4", "5", ""]; 	// Romain
troopspeed[1] = ["7", "7", "6", "9", "10", "9", "4", "3", "4", "5", ""]; 	// Germain
troopspeed[2] = ["7", "6", "17", "19", "16", "13", "4", "3", "5", "5", ""]; 	// Gaulois

var serverTimeDiff = 0; // desktop time - server time

var crannyCapacity = [ 0, 100, 130, 170, 220, 280, 360, 460, 600, 770, 1000 ]; 

var mts = new Array(3);
mts[0]	= 16;
mts[1]	= 12;
mts[2]	= 24;

var myhost = "http://" + window.location.hostname;

function getLoginButton(doc) {
	//flag ( "getLoginButton():: Started!" );
	var loginButton = find(".//input[ @value='login' and @id='btn_login' ]", XPFirst, doc); // login button // travian version 3.6
	if ( loginButton == null ) { // travian version 4.0
		//loginButton = find(".//button[ @value='Login' and @type='submit' ]", XPFirst, doc); // login button
		var xpathLoginButtonT4 = ".//button[ @id='s1' and @name='s1' and @type='submit' and contains(@onclick,'screen.width') and contains(@onclick,'screen.height') ]";
		loginButton = find(xpathLoginButtonT4, XPFirst, doc); // login button
		/*loginButton = find(".//button[ @id='s1' and @name='s1' and @type='submit' ]", XPFirst, doc); // login button
		if ( loginButton ) { // if login button exists
			var lowResolutionCheckBox = find ( ".//input [ @id='lowRes' and @type='checkbox' and @name='lowRes']", XPFirst, doc); // low resolution check box
			if ( lowResolutionCheckBox == null ) // if low resolution check box exists, then it is login page
				return loginButton;
				return null;
		}*/
	}
	if ( loginButton != null )
		return loginButton;
	else
		return null;
}

// Auto login code
if (autoLogin) {
	loginCheck(document);
}
else {
	// if auto login not enabled and current page is login page then hot-wire the login button.
	var loginButton = getLoginButton(document);
	if ( (loginButton != null) ) { // if login button exists, hot-wire the login button.
		loginButton.addEventListener("click", hotwireLoginButton, false);
	}
}

function hotwireLoginButton() {
	GM_setValue(currentServer() + '_loginDetected', "1"); // set login page detected.
	self.window.name = "LoginWindow--" + Math.ceil(Math.random()*100000);
	GM_setValue(currentServer() + '_loginWindow', self.window.name);
	return true;
}

// some global variables...
var taskdoing = "0";
var pagefreshInterval = 0; // pagefreshInterval is used for when to relad page.
var transsInterval = 0; // transsInterval is used for by Auto Transport (Construction Support / Resource Concentration).
var scriptRunInterval = 0; // scriptRunInterval is used for when to run this (auto-task) script.

var buildidid = ""; // global variable
var bbName = ""; // global variable

//  GotGs 2011.01.15 -- Probably not being used anywhere hence commenting out
//  var mybar = document.createElement("div");
//  mybar.style.width = "100%";
//  mybar.style.backgroundColor = "silver";
//  mybar.style.position = "fixed";
//  mybar.style.bottom = "0";
//  mybar.style.textAlign = "center";
//  document.body.insertBefore(mybar, document.body.lastChild.nextSibling);

 /***************** Stack Trace Function ***********************/

function printStackTrace(text) {
	//logDebugMessages = GM_getValue ( currentServer() + "_debugMode", "0" ) == "1" ? true : false;
	logDebugMessages = true;
	if (logDebugMessages) {
		var callstack = [];
		var isCallstackPopulated = false;
		try {
			i.dont.exist+=0; //doesn't exist- that's the point
		} 
		catch(e) {
			if (e.stack) { //Firefox
				var lines = e.stack.split("\n");
				for (var i=0, len=lines.length; i<len; i++) {
					if (lines[i].match(/^\s*[A-Za-z0-9\-_\$]+\(/)) {
						callstack.push(lines[i]);
					}
				}
				//Remove call to printStackTrace()
				callstack.shift();
				isCallstackPopulated = true;
			}
			else if (window.opera && e.message) { //Opera
				var lines = e.message.split("\n");
				for (var i=0, len=lines.length; i<len; i++) {
					if (lines[i].match(/^\s*[A-Za-z0-9\-_\$]+\(/)) {
						var entry = lines[i];
						//Append next line also since it has the file info
						if (lines[i+1]) {
							entry += " at " + lines[i+1];
							i++;
						}
						callstack.push(entry);
					}
				}
				//Remove call to printStackTrace()
				callstack.shift();
				isCallstackPopulated = true;
			}
		}
		if (!isCallstackPopulated) { //IE and Safari
			var currentFunction = arguments.callee.caller;
				while (currentFunction) {
					var fn = currentFunction.toString();
					var fname = fn.substring(fn.indexOf("function") + 8, fn.indexOf("(")) || "anonymous";
					callstack.push(fname);
					currentFunction = currentFunction.caller;
				}
		}
		GM_log ( "STACK TRACE:: \n" + callstack.join("\n") );
		if ( text ) {
			GM_log ( text );
		}
	}
}

/***************** Functions adopted from "Travian: Antifarm\Troop saver" script **************************/
/**
 * XPath wrapper - simplifies searching for items in the document.
 */
function find(xpath, xpres, startnode)
{
	if (!startnode) {startnode = document;}
	var ret = document.evaluate(xpath, startnode, null, xpres, null);
	if (ret == null) return null;
	return  xpres == XPFirst ? ret.singleNodeValue : ret;
}

/**
 * A function to log debug mesages into Javascript console.
 */
function TS_debug(text) {
	logDebugMessages = GM_getValue ( currentServer() + "_debugMode", "0" ) == "1" ? true : false;
	if (logDebugMessages) {
		var d = new Date();

		var curr_hour = d.getHours();
		curr_hour = curr_hour + "";
		if (curr_hour.length == 1) {  curr_hour = "0" + curr_hour; }

		var curr_min = d.getMinutes();
		curr_min = curr_min + "";			
		if (curr_min.length == 1) { curr_min = "0" + curr_min; }

		var curr_sec = d.getSeconds();
		curr_sec = curr_sec + "";
		if (curr_sec.length == 1) { curr_sec = "0" + curr_sec; }

		var curr_msec = d.getMilliseconds();
		curr_msec = curr_msec + "";
		switch ( curr_msec.length ) {
			case 0: curr_msec = "000"; break;
			case 1: curr_msec = "00" + curr_msec; break;
			case 2: curr_msec = "0" + curr_msec; break;
		}
		
		if ( self.window.name == GM_getValue(currentServer()+ '_loginWindow', "noLoginWindow") ) {
			GM_log(currentServer() + " " + curr_hour + ":" + curr_min + ":" + curr_sec + "." + curr_msec + " || LW || " + text);
		}
		else {
			GM_log(currentServer() + " " + curr_hour + ":" + curr_min + ":" + curr_sec + "." + curr_msec + " " + text);
		}
	}
}

function getFormHidVal(doc, name) {
	var ex = ".//input[@type='hidden'][@name='" + name + "']";
	var tag = find(ex, XPFirst, doc);
	if (tag == null)
		return 0;
	return(tag.value);
}

/**
 * Returns XPath node of the first form on page, or null if no form.
 */
function getFormNode(doc) {
	var tag;
	tag = find(".//form", XPFirst, doc);
	if (tag == null)
		return null;
		return tag;
}

var showAlert = false;

function flag(mess) {	
	if (showAlert) {
		alert(mess);
	}	
	else { 
		TS_debug(mess);
	}
}

/**
 * Sends given 'post' request, with given callback function and data.
 */
function TS_postRequest(reqUrl,reqData,reqCallback,p1,p2,p3,p4,p5,p6) {
	try {
		//flag ( "TS_postRequest():: Started! reqUrl: " + reqUrl );
		//TS_debug("POST: "+reqUrl+" "+reqData);
		GM_xmlhttpRequest({
			method: "POST",
			url: reqUrl,
			headers:{'Content-type':'application/x-www-form-urlencoded',},
			data:encodeURI(reqData),
			onload: function(responseDetails) {
				var aElem = document.createElement("div");
				aElem.innerHTML = responseDetails.responseText;
				//flag ( "TS_postRequest():: aElem.innerHTML: " + aElem.innerHTML );
				if ( gatherStats(aElem.innerHTML) ) {
					// attempt reloading page, captcha ll be found there too and script will stop.
					window.location.replace(myhost + "/spieler.php");
				}
				else {
					refreshPageInfo(aElem);	
					reqCallback(aElem,p1,p2,p3,p4,p5,p6);
				}
			},
			onerror: function(responseDetails) {
				var aElem = document.createElement("div");
				aElem.innerHTML = responseDetails.responseText;
				if ( gatherStats(aElem.innerHTML) ) {
					// attempt reloading page, captcha ll be found there too and script will stop.
					window.location.replace(myhost + "/spieler.php");
				}
				else {
					var msg = "TS_postRequest():: Post Request to server failed! reqUrl: " + reqUrl;
					printStackTrace( "TS_postRequest():: Error! aElem.innerHTML: " + aElem.innerHTML );
					throwLogicError ( msg );
					//reqCallback(aElem,p1,p2,p3,p4,p5,p6);
				}
			}
		});
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>TS_postRequest():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

/**
 * Sends given 'get' request, with given callback function.
 */
function TS_getRequest(reqUrl,reqCallback,p1,p2,p3,p4,p5,p6) {
	try {
		//flag ( "TS_getRequest():: Started! reqUrl: " + reqUrl );
		//TS_debug("GET REQUEST: "+reqUrl);
		GM_xmlhttpRequest({
			method: "GET",
			url: reqUrl,
			headers: {'Accept': 'application/atom+xml,application/xml,text/xml',},
			onload: function(responseDetails) {
				var aElem = document.createElement("div");
				aElem.innerHTML = responseDetails.responseText;
				//flag ( "TS_getRequest():: aElem.innerHTML: " + aElem.innerHTML );
				if ( gatherStats(aElem.innerHTML) ) {
					// attempt reloading page, captcha ll be found there too and script will stop.
					window.location.replace(myhost + "/spieler.php");
				}
				else {
					refreshPageInfo(aElem);
					reqCallback(aElem,p1,p2,p3,p4,p5,p6);
				}
			},
			onerror: function(responseDetails) {
				var aElem = document.createElement("div");
				aElem.innerHTML = responseDetails.responseText;
				if ( gatherStats(aElem.innerHTML) ) {
					// attempt reloading page, captcha ll be found there too and script will stop.
					window.location.replace(myhost + "/spieler.php");
				}
				else {
					var msg = "TS_getRequest():: Get Request to server failed! reqUrl: " + reqUrl;
					printStackTrace( "TS_getRequest():: Error! aElem.innerHTML: " + aElem.innerHTML );
					throwLogicError ( msg );
					//reqCallback(aElem,p1,p2,p3,p4,p5,p6);
				}
			}
		});
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>TS_getRequest():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

/*
 * Checks if the player is in login screen.
 * If so, and there's field for name and password, then 'clicks' login button.
 */
function getLoginPass(doc) {
	//flag ( "getLoginPass():: Started!" );
	var passButton = find(".//input[@type='password' and contains(@value, '*')]", XPFirst, doc);
	if ( passButton == null ) { // dunn know if there is a better for this...!!!!
		passButton = find(".//input[@type='password' and @value]", XPFirst, doc);
		if ( passButton == null )
			return null;
		else { // if password field exists
			if ( passButton.value == "" ) { // if pwd field is empty return null
				// this repeated check is required for external password managers
				var randominter = Math.ceil ( Math.random() * 5*1000 + 5*1000 ); // random ( 5 sec ) + 5 sec
				showLoginBubble("Wait -- Checking password field in " + Math.round(randominter/1000 *100) / 100 + " seconds...");
				window.setTimeout ( function() { loginCheck(doc); doc = null; }, randominter ); // check for pwd again in few seconds
				return null;
			}
			else { // if pwd field is not empty, return passButton so that we can proceed with auto-login
				return passButton;
			}
		}
	}
	return passButton;
}

function loginCheck(doc) {
	//flag ( "loginCheck():: Started!" );
	var loginButton = getLoginButton(doc);
	var passButton = getLoginPass(doc);
	if ( (loginButton != null) && (passButton != null) ) { // if login button exists & password is filled in..
		flag ( "loginCheck():: Login Page Detected! Attempting login..." );
		GM_setValue(currentServer() + '_loginDetected', "1"); // set login page detected.
		self.window.name = "LoginWindow--" + Math.ceil(Math.random()*100000);
		GM_setValue(currentServer() + '_loginWindow', self.window.name);
		var randominter = Math.ceil ( Math.random() * 5*1000 + 5*1000 ); // random ( 5 sec ) + 5 sec
		showLoginBubble("Wait -- Attempting Login in " + Math.round(randominter/1000 *100) / 100 + " seconds...");
		window.setTimeout ( function() { 
					flag ( "loginCheck(): Clicking on Login Button..." );
					loginButton.click(); 
				},
				randominter );
		
	}
	else if ( (loginButton != null) ) { // if login button but pwd not filled in, just hot-wire the login button.
		loginButton.removeEventListener('click', hotwireLoginButton, false); // not sure if this is need
		loginButton.addEventListener("click", hotwireLoginButton, false);
	}
	else if ( window.location.href.indexOf("logout.php") > 0 ) { // if logout page
		flag ( "loginCheck():: Logout Detected! Attempting login again..." );
		var randominter = Math.ceil ( Math.random() * 5*1000 + 5*1000 ); // random ( 5 sec ) + 5 sec
		showLoginBubble("Wait -- Loading login page in " + Math.round(randominter/1000 *100) / 100 + " seconds...");
		window.setTimeout ( function() { 
					window.location.href = "http://"+window.location.href.split("/")[2]+"/login.php";
				},
				randominter );
	}
	else { // if not login or logout page
		if ( Number(GM_getValue(currentServer() + '_loginDetected', "0")) > 0 ) { // login process going on
			/*if ( GM_getValue(myacc() + '_fetchingSingleTownNEWDID') )	
				GM_deleteValue(myacc() + '_fetchingSingleTownNEWDID');*/
		}
	}
	//flag ( "loginCheck():: Finished!" );
}

/******************* End of "Travian: Antifarm\Troop saver" adoption **************************/

/**
 * Updates the Xlang variable, which is used in language initialization.
 */	
function checkLang() {
	var host = window.location.hostname;
	hosts = host.split(".");
	Xlang = hosts[hosts.length-1];
}

//shortcut to get an element by id
function $(id,aElem) {
	if(!aElem) {
		return document.getElementById(id);
	}
	else {
		return document.evaluate('id("'+id+'")',aElem,null,XPFirst,null).singleNodeValue;
	}
}

function setCookie(aName,aValue,vid)
{
	nC = myacc() + ((vid && vid != undefined)? "_"+vid:"") + "_" + aName;
	if(!aValue) GM_deleteValue(nC);
	else {
		try {
			GM_setValue(nC,JSON.stringify(aValue));
		}
		catch (e){
			GM_setValue(nC,uneval(aValue));
		}
	}
}

function getCookie(aName,vid,dValue)
{
	nC = myacc() + (vid? "_"+vid:"") + "_" + aName;
	var ret = GM_getValue(nC);
	if(ret) {
		try{ ret = JSON.parse(ret); } catch(e) { ret = eval(ret); }
		return ret;
	} else { return dValue; }
}

//shortcut for Xpath query of document.evaluate
function $g(xpath, xpres, startnode)
{
	if (!startnode) {startnode = document;}
	var ret = document.evaluate(xpath, startnode, null, xpres, null);
	if (ret == null) return null;
	return  xpres == XPFirst ? ret.singleNodeValue : ret;
}

function h1in() {
	var h1 = document.getElementsByTagName("h1")[0];
	return h1;
}

function herere() {
	return currentServer() + "_" + getuid() + "_" + currentID();
}

function myacc() {
	//flag ( "myacc():: Started!");
	//printStackTrace();
	return currentServer() + "_" + getuid();
}

// gets the current village newdid
// if aElem is specified, then gets village newdid from aElem ow gets from the current document
var var_current_id = "";
function currentID() {
	//flag ( "currentID():: Started!" );
	if ( var_current_id == "" || var_current_id == null || var_current_id == undefined ) {
		var_current_id = getVillageId(document.body);
	}

	return var_current_id;

}

//given a page finds the current village id based on the dot
function getVillageId(aElem) {
	try {
		var xpathVillageId = "";
		switch ( aTravianVersion ) {
			case "3.6":
				xpathVillageId = ".//table[@id='vlist']//td[@class='dot hl']/following-sibling::td[@class='link']//a";
				break;
			case "4.0":
				xpathVillageId = './/div[@id="villageList"]//li[contains(@class,"active")]/a[contains(@class,"active")]';
				break;
			default:
				throwLogicError ( "getVillageId():: Travian Version not set!!" );
		}
		theboys = $g ( xpathVillageId, XPFirst, aElem );
		//TS_debug(" resultat evaluate currentID : " + theboys + " --- " + theboys.singleNodeValue);
		if ( theboys!= null ) {
			theUrl = theboys.href.match(/newdid=\d{1,}/)[0];
			getit = theUrl.toString().match(/\d{1,}/)[0];
			return getit;
		}
		else {
			if ( getAllVillageNewdids().length > 1 )
				throwLogicError ( "getVillageId():: Cannot get village id from aElem!" );
			return GM_getValue(myacc() + '_singleTownNEWDID');
		}
	}
	catch ( err ) {
		printStackTrace ( "getVillageId():: Error! aElem.innerHTML: " + aElem.innerHTML );
		var msg = "<b>getVillageId():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

/**
 * Returns name of the active village.
 */
var var_current_village_name = "";
function currentVillageName() {
	try {
		//flag ( "currentVillageName():: Started!");
		if ( var_current_village_name == "" || var_current_village_name == null || var_current_village_name == undefined ) {
			var xpathVillageName = "";
			switch ( aTravianVersion ) {
				case "3.6":
					xpathVillageName = ".//table[@id='vlist']//td[@class='link']//a[contains(@href,"+ currentID()+")]";
					break;
				case "4.0":
					xpathVillageName = './/div[@id="villageList"]//li[@class="entry active"]/a[@class="active"]';
					break;
				default:
					throwLogicError ( "currentVillageName():: Travian Version not set!!" );
			}
			var theVillageName = find ( xpathVillageName, XPFirst );
			if ( theVillageName != null ) {
				var_current_village_name = theVillageName.innerHTML;
				return theVillageName.innerHTML;
			}
			else {
				var_current_village_name = GM_getValue(myacc() + "_mainvillageName");
				return GM_getValue(myacc() + "_mainvillageName");
			}
		}
		else {
			return var_current_village_name;
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>currentVillageName():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

var var_get_uid = null;
function getuid() {
	//flag ( "getuid():: Started!" );
	var loginButton = getLoginButton(document);
	if ( loginButton != null ) // when login page return null
		return null;
	if ( var_get_uid == "" || var_get_uid == null || var_get_uid == undefined ) {
		var tag = document.evaluate('.//div[@id="side_navi"]//a[contains(@href,"spieler.php")]', document, null, XPFirst, null).singleNodeValue;
		if ( tag != null ) {
			aTravianVersion = "3.6";
			var_get_uid = tag.href.match(/\buid=\d{1,}\b/)[0].split("=")[1];
		}
		else {
			tag = document.evaluate('.//div[@id="side_info"]//a[contains(@href,"spieler.php")]', document, null, XPFirst, null).singleNodeValue;
			if ( tag != null ) {
				var_get_uid = tag.href.match(/\buid=\d{1,}\b/)[0].split("=")[1];
				aTravianVersion = "4.0";
			}
			else {
				var_get_uid = null;
			}
		}
	}
	//flag ( "getuid():: var_get_uid: " + var_get_uid );
	return var_get_uid;
}

var var_all_new_dids = new Array();
function getAllVillageNewdids() {
	try {
		//flag ( "getAllVillageNewdids():: Started!" );
		if ( var_all_new_dids == null || var_all_new_dids == undefined || var_all_new_dids.length == 0 ) {
			var allNewdids = new Array();
			var xpathVillageNewdids = "";
			switch ( aTravianVersion ) {
				case "3.6":
					xpathVillageNewdids = ".//table[@id='vlist']/tbody/tr/td[@class='link']//a";
					break;
				case "4.0":
					xpathVillageNewdids = './/div[@id="villageList"]//li/a[contains(@href,"newdid=")]';
					break;
				default:
					throwLogicError ( "getAllVillageNewdids():: Travian Version not set!!" );
			}
			var allvillages = find ( xpathVillageNewdids, XPSnap );
			if ( ( aTravianVersion == "3.6" && allvillages.snapshotLength > 1 ) 
					|| aTravianVersion == "4.0" ) { //multi-villages
				if ( allvillages.snapshotLength == 0 ) {
					throwLogicError ( "getAllVillageNewdids():: Cannot get village newdids!!" );
				}
				for (var i = 0; i < allvillages.snapshotLength; i++) {
					if (allvillages.snapshotItem(i).href.indexOf("newdid") != -1) {
						newdiddd = allvillages.snapshotItem(i).href.match(/\bnewdid=\d{1,}\b/)[0].match(/\d{1,}/)[0]; // by Rhayader
						thenewlength = allNewdids.push(newdiddd); //+ ":" + thevillagenum;
					}
					else
						throwLogicError ( "getAllVillageNewdids():: Cannot get newdid!" );
				}
			} 
			else { // single village // only for travian 3.6
				if ( GM_getValue(myacc() + '_singleTownNEWDID', "") != "" )
					allNewdids[0] = GM_getValue(myacc() + '_singleTownNEWDID');
				else
					throwLogicError ( "getAllVillageNewdids():: _singleTownNEWDID is not set!!" );
			}
			var_all_new_dids = allNewdids;
		}
		return var_all_new_dids;
	}
	catch ( err ) {
		printStackTrace ( "getAllVillageNewdids():: Error! document.body.innerHTML: " + document.body.innerHTML );
		var msg = "<b>getAllVillageNewdids():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// get the 1st village newdid from dorf3.php, this is called only once when a login is detected.
function getSingleVillageNum() {
	//flag ( "getSingleVillageNum():: Started!" );
	if ( window.location.href.indexOf("dorf3.php") != -1 ) {
		var theString = document.body.innerHTML.match(/newdid=\d{1,}/);
		var villageNum = theString.toString().match(/\d{1,}/);
		GM_setValue(myacc() + '_singleTownNEWDID', villageNum.toString());
	}
/*	if (!GM_getValue(myacc() + '_singleTownNEWDID')) {
		GM_xmlhttpRequest({
			method: 'GET',
			url: myhost + "/dorf3.php",
			onload: function(result){
				if ( gatherStats(result.responseText) ) {
					// attempt reloading page, captcha ll be found there too and script will stop.
					window.location.replace(myhost + "/spieler.php");
					return false;
				}
				var theString = result.responseText.match(/newdid=\d{1,}/);
				var villageNum = theString.toString().match(/\d{1,}/);
				GM_setValue(myacc() + '_singleTownNEWDID', villageNum.toString());
			}
		});
	}*/
}

function getErrorInfor()
{
	var errors = GM_getValue( myacc() + "_currentError", "");
	return errors;
}

function getthebuildUrl(vil, task) {
	try {
		flag ( "getthebuildUrl():: Started! vil: " + vil + ", id: " + task[1] );
		//TS_debug("getthebuildUrl: Starting, task = "+task + " Village : " + vil);

		var buildgid = "";
		if ( task[0] == "1" ) // new build task
			buildgid = task[3];
		else // upgrade task
			buildgid = getGidFromName(task[4]);
		var cropError = checkCropWarehouseGranaryError ( vil, "_cropError" );
		var warehouseError = checkCropWarehouseGranaryError ( vil, "_warehouseError" );
		var granaryError = checkCropWarehouseGranaryError ( vil, "_granaryError" );
		if ( cropError && parseInt(buildgid) != 4 ) { // if crop error
			GM_setValue( myacc() + "_currentError", aLangErrorText[8] ); // set error: lack of food, extend crop land first.
			return false;
		}
		if ( warehouseError && parseInt(buildgid) != 10 && parseInt(buildgid) != 38 ) { // if warehouseError
			GM_setValue( myacc() + "_currentError", aLangErrorText[5] ); // set error: warehouse is too small.
			return false;
		}
		if ( granaryError && parseInt(buildgid) != 11 && parseInt(buildgid) != 39 ) { // if granaryError
			GM_setValue( myacc() + "_currentError", aLangErrorText[6] ); // set error: granary is too small.
			return false;
		}

		GM_setValue( myacc() + "_currentError", "" );
		function callback() {};

		var url = myhost + "/build.php?newdid=" + vil + "&id=" + task[1];
		//flag ( "getthebuildUrl():: opening url: " + url );
		var getbuildurl = new XMLHttpRequest();
		getbuildurl.open('GET', url, false);
		getbuildurl.onreadystatechange = callback;
		getbuildurl.send(null);

		function callback() {
			if (getbuildurl.readyState == 4) {
				if (getbuildurl.status == 200) {
					flag ( "getthebuildUrl():: callback started!" );

					var aDoc = document;//.implementation.createDocument("", "", null);
					//var aDoc = document/*.implementation.createDocument("", "", null)*/;
					var aElem = aDoc.createElement("div");
					aElem.innerHTML = getbuildurl.responseText;
					//aDoc.appendChild(aElem);
					if ( gatherStats(aElem.innerHTML) ) {
						var lvlErrMsg = "Captcha Found!";
						GM_setValue( myacc() + "_currentError", lvlErrMsg );
						// attempt reloading page, captcha ll be found there too and script will stop.
						window.location.replace(myhost + "/spieler.php");
						return false;
					}

					refreshPageInfo(aElem);
					TS_debug("end refreshPageInfo");

					switch (task[0]) { // 0_id_level_time_name   upgrade building / resources
						case "0":
							var xpathPageHeading = "";
							var xpathCurrentLevel = "";
							var xpathNextLevel = "";
							var xpathBuildAnchor = "";
							var xpathReqRes = "";
							switch ( aTravianVersion ) {
								case "3.6":
									xpathPageHeading = "id('build')/h1";
									xpathCurrentLevel = "id('build')/h1/span[@class='level']";
									xpathNextLevel = ".//p[@id='contract']";
									xpathBuildAnchor = 'id("build")//a[ contains(@href,"?a='+task[1]+'") and @class="build" ]';
									xpathReqRes = './/p[@id="contract"]/span[@class="none"]/..';
									break;
								case "4.0":
									xpathPageHeading = "id('contentOuterContainer')//h1";
									xpathCurrentLevel = "id('contentOuterContainer')//h1/span[@class='level']";
									xpathNextLevel = ".//div[@id='contract']/div[@class='contractText']";
									xpathBuildAnchor = 'id("build")//button[ contains(@onclick,"?a='+task[1]+'") and @class="build" ]';
									xpathReqRes = './/*[@id="contract"]//span[@class="none"]/../../div[@class="contractCosts"]/div';
									break;
								default:
									throwLogicError ( "getthebuildUrl():: Travian Version not set!!" );
							}
							var h1i = aDoc.evaluate ( xpathPageHeading, aElem, null, XPFirst, null );
							// if build page not found then return error
							if ( h1i.singleNodeValue == null || h1i.singleNodeValue.innerHTML == "" 
								|| getbuildurl.responseText == null || getbuildurl.responseText == "" ) {
								var errMsg = "Build page not found, cannot upgrade!";
								GM_setValue( myacc() + "_currentError", errMsg );
								flag ( "getthebuildUrl():: Error : " + errMsg );
								return false;
							}
							// if construction page then return error
							if ( h1i.singleNodeValue.innerHTML.replace(/\n/g,"").indexOf(aLangGameText[15]) != -1 ) {
								var errMsg = "Construction page found, cannot upgrade!";
								GM_setValue( myacc() + "_currentError", errMsg );
								flag ( "getthebuildUrl():: Error: " + errMsg );
								return false;
							}
							if ( getBuildType ( parseInt(task[1]) ) == BuildType.building ) { // perform check for building only
								// if not the required building/resource then return error
								if ( h1i.singleNodeValue.innerHTML.replace(/\n/g,"").indexOf ( task[4] ) == -1 ) {
									var errMsg = "Some other building/resource found, cannot upgrade!";
									TS_debug("found: " + h1i.singleNodeValue.innerHTML + " expected " + task[4]);
									GM_setValue( myacc() + "_currentError", errMsg );
									flag ( "getthebuildUrl():: Error: " + errMsg );
									return false;
								}
							}
							// GotGs 2011.01.15 -- first find the current level of the building / resource.
							var level = "0";
							var buildLevel = aDoc.evaluate ( xpathCurrentLevel, aElem, null, XPFirst, null );
							if ( buildLevel.singleNodeValue ) {
								level = buildLevel.singleNodeValue.innerHTML.match(/\d{1,}/)[0];
							}
							else {
								var msg = "getthebuildUrl():: Error: Cannot get level of current resource/building!"; 
								TS_debug ( msg );
								throwLogicError ( msg );
							}

							var bData = getCookie("BuildingData",vil);
							if(!bData) bData = new Array();
							var id = Number(task[1]);
							if(bData[id] && bData[id].gid != 0){
								bData[id].level = parseInt(level);
							} else {
								var gid = parseInt($("build",aElem).className.split("gid")[1]);
								var building = {};
								building.level = parseInt(level);
								building.gid = gid;
								var bTitle = $g(xpathPageHeading,XPFirst,aElem).textContent.replace(/\n/g,"").split(" ");
								building.name = bTitle.slice(0,bTitle.length -2).join(" ");
								bData[id] = building;              
							}
							setCookie("BuildingData",bData,vil);
						
							var buildmaxlevel = -1;
							var mainVI = GM_getValue(myacc() + "_mainvillageId");
							//flag ( "getthebuildUrl():: mainVI: " + mainVI + ", vil: " + vil + ", id: " + id + ", gid: " + bData[id].gid );
							if ( bData[id].gid > 4 )
								buildmaxlevel = parseInt ( maxlevel [ bData[id].gid ] );
							else
								buildmaxlevel = parseInt ( maxlevel [ bData[id].gid - 1 ] );
							if ( vil == mainVI && bData[id].gid <= 4 ) {
								buildmaxlevel *= 2;
							}

							// TODO: max level check is done when a new task is added by user
							/*var maxlevel;
							if(getBuildType(parseInt(task[1])) == BuildType.field) {
								var mainVI = GM_getValue(myacc() + "_mainvillageId");
								maxlevel = (mainVI == vil) ? 20 : 10;
							}
							else {
								maxlevel = parseInt ( task[2], 10 );
							}*/

							var nextLevel = parseInt ( level, 10 ) + 1;
							var contract = $g ( xpathNextLevel, XPFirst, aElem );
							if(contract) {
								var tempVal = contract.innerHTML.match(/\b\d{1,}\b[^:]*:/);
								if ( tempVal != null ) {
									nextLevel = tempVal[0].match(/\b\d{1,}\b/)[0];
								}
								if ( tempVal == null || nextLevel == null) {
									throwLogicError ( "getthebuildUrl():: Error: Cannot get next upgrade level! tempVal: "
											+ tempVal + ", nextLevel: " + nextLevel );
								}
							} //nextLevel can be bigger than level + 1 when double build is activated

							//flag ( "getthebuildUrl():: nextLevel: " + nextLevel + ", level: " + level + ", buildmaxlevel: " + buildmaxlevel );
							if ( parseInt ( level ) >= buildmaxlevel || 
									( ( parseInt ( level ) + 1 ) < parseInt ( nextLevel ) && parseInt ( nextLevel ) > buildmaxlevel ) ) {
								flag ( "getthebuildUrl():: Error: Resource / building is already at max level, hence cannot upgrade!" );
								GM_setValue( myacc() + "_currentError", aLangErrorText[2] );
								return false;
							}

							/*var nextLevel = parseInt ( level, 10 )+1;
							var contract = $g("//p[@id='contract']",XPFirst,aElem);
							if(contract) {
								var cString = contract.textContent.split(":");
								var nLevel = cString[0].split(" ");
								var nLevel = parseInt(nLevel[nLevel.length -1]);
								var cost = cString[1].split(" | ");
								if(!isNaN(nLevel))
								{
									nextLevel = nLevel;
									var eCost = bCost[bData[id].gid][nLevel];
									if(eCost[0] != cost[0] || eCost[1] != cost[1] || eCost[2] != cost[2] || eCost[3] != cost[3])
									{
										TS_debug("Invalid cost for building. gid="+bData[id].gid + ", level="+nLevel
												+"eCost=["+eCost+"], cost=["+cost+"]");
									}
								}
								else {
									nextLevel = level+1;
								}
							} //nextLevel can be bigger than level + 1 when double build is activated*/
							
							GM_setValue(myacc() + "_" + vil + "_crtBuildlevel", level); // set current building level to cookie
							// GotGs 2011.01.15 -- do not upgrade if the building / resource is already at the required level.
							if (  parseInt(task[2]) <= parseInt(level) || parseInt(task[2]) < nextLevel ) {
								TS_debug(bData[id].name + " is level " + level
										+ ", next possible upgrade to " + nextLevel
										+ ", requested upgrade level " + task[2] + ". not upgrading");
								var lvlErrMsg = "Resource/Building already at required (or above) level, hence not upgrading!";
								GM_setValue( myacc() + "_currentError", lvlErrMsg );
								flag ( "getthebuildUrl():: Error: " + lvlErrMsg );
								if ( task[1] <= 18 || task[1] == 50 ) {
									var callBackUrl = myhost + "/dorf1.php?newdid=" + vil;
									TS_getRequest ( callBackUrl, function() {} ); // attempt to refresh BuildingData & auto res data.
								}
								else {
									var callBackUrl = myhost + "/dorf2.php?newdid=" + vil;
									TS_getRequest ( callBackUrl, function() {} ); // attempt to refresh BuildingData.
								}
								return false;
							}

							// GotGs 2011.01.15 -- now find the build url for the building / resource.
							var allanchors = aDoc.evaluate ( xpathBuildAnchor, aElem, null, XPFirst, null);
							var allanchors2 = aDoc.evaluate('.//p[@id="contract"]/a[@class="build"]',aElem,null,XPFirst,null);
								
							// by shadowx 05/5/2010
							var constructionmasterurl = new String(allanchors.singleNodeValue);
							if ( constructionmasterurl.indexOf("&b=") != "-1" ) {
								var lvlErrMsg = "Construction Master Enabled, therefore stopping.";
								TS_debug(lvlErrMsg);
								GM_setValue( myacc() + "_currentError", lvlErrMsg );
								return false;
							}

							if ( allanchors.singleNodeValue ) {
								var buildUrl = "";
								switch ( aTravianVersion ) {
									case "3.6":
										buildUrl = allanchors.singleNodeValue.getAttribute("href");
										break;
									case "4.0":
										buildUrl = allanchors.singleNodeValue.getAttribute("onclick").match(/href[ =]*'.*'/)[0].split("'")[1];
										break;
									default:
										throwLogicError ( "getthebuildUrl():: Travian Version not set!!" );
								}
								TS_debug("The newbuild url is : " + buildUrl);
								/*var queued = aDoc.evaluate('.//p[@id="contract"]/span[@class="none"]', aElem, null, XPFirst, null);
								if(!queued.singleNodeValue && aElem.innerHTML.indexOf("Queued") != -1 )
								{
									TS_debug("BUG BUG BUG");
								}

								if(queued.singleNodeValue)
								{
									GM_setValue( myacc() + "_currentError", "The current action would queue the task. aborting" );
									return false;
								}*/
								return buildUrl;
							}
							else {
								checkBuildErrorTranslation ( aElem ); // check for translation errors
								// cannot use id('contract') because there is two element with contract on a main building level 10+
								//var errorXpath = 'id("build")//a[contains(@href,"&bid='+task[1]+'")]/following-sibling::span[@class="none"]';
								//var errorXpath = '//p[@id="contract"]/span[@class="none"]';
								var errorXpath = './/*[@id="contract"]//span[@class="none"]';
								var errors = aDoc.evaluate ( errorXpath, aElem, null, XPFirst, null );
								if ( errors.singleNodeValue ) {
									//var xpathReqRes = 'id("build")//a[contains(@href,"&bid='+task[1]+'")]/..';
									var reqResources = aDoc.evaluate(xpathReqRes, aElem, null, XPFirst, null).singleNodeValue.innerHTML.
										replace(/>(\d{1,}) \||>(\d{1,})</g, "%% $1$2 %%").match(/%% \d{1,} %%/g).splice(0,4).
										join("").match(/\d{1,}/g);
									//flag ( "getthebuildUrl():: reqResources: " + reqResources.join("/") );
									var myRace = GM_getValue ( myacc() + "_raceID", "0" );
									if ( myRace == "0" ) { // romans
										if ( task[1] <= 18 || task[1] == 50 )
											GM_setValue ( myacc() + "_" + vil + "_resRequiredForResUpgrade", reqResources.join("/") );
										else
											GM_setValue ( myacc() + "_" + vil + "_resRequiredForBldgUpgrade", reqResources.join("/") );
									}
									else { // non-romans
										GM_setValue ( myacc() + "_" + vil + "_resRequired", reqResources.join("/") );
									}
									GM_setValue( myacc() + "_currentError",errors.singleNodeValue.innerHTML.replace(/\n/g,""));
									TS_debug("getthebuildUrl():: Error: " + errors.singleNodeValue.innerHTML.replace(/\n/g,""));
								}
								else {
									GM_setValue( myacc() + "_currentError", "I hate debugging grease monkey");
									throwLogicError ( "getthebuildUrl():: Upgrade error not found!" );
								}
								return false;
							}
							break;
						case "1": // 1_id_level_gid_time_name   newbuild for buildings
							var xpathNewBUrl = "";
							switch ( aTravianVersion ) {
								case "3.6":
									xpathNewBUrl = 'id("build")//table[@class="new_building"]//a[contains(@href,"?a='+task[3]+'")]';
									break;
								case "4.0":
									xpathNewBUrl = 'id("build")//div[@class="contract contractNew contractWrapper"]//'
										+ 'button[contains(@onclick,"?a='+task[3]+'")]';
									break;
								default:
									throwLogicError ( "getthebuildUrl():: Travian Version not set!!" );
							}
							//var xpathNewBUrl = '//*[contains(@href,"?a='+task[3]+'")]';
							var newbdurl = aDoc.evaluate( xpathNewBUrl, aElem, null, XPFirst, null);
							//flag ( "getthebuildUrl():: newbdurl : " + newbdurl.singleNodeValue );
							if ( newbdurl.singleNodeValue && newbdurl.singleNodeValue != false ) {
								var buildUrl = "";
								switch ( aTravianVersion ) {
									case "3.6":
										buildUrl = newbdurl.singleNodeValue.getAttribute("href");
										break;
									case "4.0":
										buildUrl = newbdurl.singleNodeValue.getAttribute("onclick").match(/href[ =]*'.*'/)[0].split("'")[1];
										break;
									default:
										throwLogicError ( "getthebuildUrl():: Travian Version not set!!" );
								}
								flag ( "getthebuildUrl():: new build url : " + buildUrl );
								if(new String(buildUrl).indexOf("&b=") != "-1") {
									var lvlErrMsg = "Construction Master Enabled, therefore stopping";
									TS_debug(lvlErrMsg);
									GM_setValue( myacc() + "_currentError", lvlErrMsg );
									return false;
								}
								GM_setValue(myacc() + "_" + vil + "_crtBuildlevel", "0");
								return buildUrl;
							}
							else {
								checkNewBuildErrorTanslations ( aElem ); // check for missing error translations
								checkNewBuildNameTranslations ( aElem ); // check for missing building name translations
								var xpathPageHeading = "";
								var errorListXpath = "";
								var xpathReqResList = "";
								switch ( aTravianVersion ) {
									case "3.6":
										xpathPageHeading = "id('build')/h1";
										errorListXpath = 'id("build")//table[@class="new_building"]//td[@id="contract_n"]';
										xpathReqResList = 'id("build")//table[@class="new_building"]//td[@class="res"]';
										break;
									case "4.0":
										xpathPageHeading = "id('contentOuterContainer')//h1";
										errorListXpath = 'id("build")//div[@class="contract contractNew contractWrapper"]//'
											+ 'div[@class="contractLink"]';
										xpathReqResList = 'id("build")//div[@class="contract contractNew contractWrapper"]//'
											+ 'div[@class="showCosts"]';
										break;
									default:
										throwLogicError ( "getthebuildUrl():: Travian Version not set!!" );
								}
								// GotGs 2011.01.15 -- get error info for the required building instead of the first building in the list
								var h1i = aDoc.evaluate ( xpathPageHeading, aElem, null, XPFirst, null );
								// verify that this is the construction page
								if ( h1i.singleNodeValue && h1i.singleNodeValue.innerHTML.indexOf(aLangGameText[15]) != -1 ) {
									//var errorListXpath = '//*[@id="contract_n"]';
									var errorList = aDoc.evaluate( errorListXpath, aElem, null, XPOrdList, null);
									var buildingList = aDoc.evaluate('.//h2', aElem, null, XPOrdList, null);
									var reqResList = aDoc.evaluate( xpathReqResList, aElem, null, XPOrdList, null);
									for ( var iCtr = 0 ; (iCtr < buildingList.snapshotLength) && (iCtr < errorList.snapshotLength) ; iCtr++ ) {
										//flag ( "iCtr: " + iCtr + ", buildingList.snapshotItem(iCtr).innerHTML: " 
										//		+ buildingList.snapshotItem(iCtr).innerHTML );
										if ( buildingList.snapshotItem(iCtr).innerHTML.match(task[5]) != null ) {
											var error = aDoc.evaluate( './/span[@class="none"]', errorList.snapshotItem(iCtr),
													null, XPFirst, null);
											if ( error.singleNodeValue != null && error.singleNodeValue.innerHTML != "" ) {
												var reqResources = reqResList.snapshotItem(iCtr).innerHTML.
													replace(/>(\d{1,}) \||>(\d{1,})</g, "% $1$2 %").match(/% \d{1,} %/g).
													splice(0,4).join("").match(/\d{1,}/g);
												//flag ( "getthebuildUrl():: reqResources: " + reqResources.join("/") );
												var myRace = GM_getValue ( myacc() + "_raceID", "0" );
												if ( myRace == "0" ) { // romans
													if ( task[1] <= 18 || task[1] == 50 )
														GM_setValue ( myacc() + "_" + vil + "_resRequiredForResUpgrade", 
																reqResources.join("/") );
													else
														GM_setValue ( myacc() + "_" + vil + "_resRequiredForBldgUpgrade", 
																reqResources.join("/") );
												}
												else { // non-romans
													GM_setValue ( myacc() + "_" + vil + "_resRequired", reqResources.join("/") );
												}
												GM_setValue( myacc() + "_currentError", 
														error.singleNodeValue.innerHTML.replace(/\n/g,"") );
												TS_debug("getthebuildUrl():: New Build Error: " + 
														error.singleNodeValue.innerHTML.replace(/\n/g,"") );
												return false;
											}
											else {
												switch ( aTravianVersion ) {
													case "3.6":
														var msg = "getthebuildUrl():: New Build Error Not Found!"; 
														TS_debug ( msg );
														throwLogicError ( msg );
														break;
													case "4.0":
														var errMsg = "Make sure all pre-requisites for the building has been met!"
														GM_setValue( myacc() + "_currentError", errMsg);
														TS_debug("Can't build " + task[5] + "! " + errMsg );
														return false;
													default:
														throwLogicError ( "getthebuildUrl():: Travian Version not set!!" );
												}
											}
										}
									}
									// GotGs 2011.01.15 -- reaching here means, that the requirements for the current building has not been met.
									var errMsg = "Make sure all pre-requisites for the building has been met!"
									GM_setValue( myacc() + "_currentError", errMsg);
									TS_debug("Can't build " + task[5] + "! " + errMsg );
									return false;
								}
								else {
									GM_setValue( myacc() + "_currentError", "newBuild can't run, something is here.");
									TS_debug("oh No! newBuild can't run, something is here.")
									return false;
								}
							}
							break;
					}
				}
			}
		}

		return callback();
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getthebuildUrl():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

/*function getcrtlevel() {
	var theTitle = stripHTML(h1in().innerHTML).split(" ");
	if (theTitle.length>2) {
		return theTitle[theTitle.length-1];
	}
}*/

function currentServer() {
	var serverr = window.location.hostname.replace(/\.travian\./, "");
	return serverr;
}

// called only from INIT()
function getMainVillageid() {
	try {
		//flag ("getMainVillageid():: Started! ");
		if (window.location.href.indexOf("spieler.php") != -1 && window.location.href.match(/\bs=\b/) == null ) { // works only if self profile page.
			if ( window.location.href.match(/\buid=/) == null || window.location.href.match(/\buid=\d{1,}\b/)[0].split("uid=")[1] == getuid() )  {
				var xpathMainVillaAnchor = "";
				var xpathX = "";
				var xpathY = "";
				switch ( aTravianVersion ) {
					case "3.6":
						xpathMainVillaAnchor = './/table[@id="villages"]/descendant::span[@class="none3"]/../a[contains(@href,"karte.php")]';
						xpathX = './/table[@id="villages"]/descendant::span[@class="none3"]/../../td[@class="aligned_coords"]/div[@class="cox"]';
						xpathY = './/table[@id="villages"]/descendant::span[@class="none3"]/../../td[@class="aligned_coords"]/div[@class="coy"]';
						break;
					case "4.0":
						// coordinateX & coordinateY suggested by Rhayader (2011.04.11)
						xpathMainVillaAnchor = '//table[@id="villages"]/descendant::span[@class="mainVillage"]/../a[contains(@href,"karte.php")]';
						xpathX = './/table[@id="villages"]/descendant::span[@class="mainVillage"]/../../td[@class="coords"]'
								+ '//span[@class="cox" or @class="xCoord" or @class="coordinateX"]';
						xpathY = './/table[@id="villages"]/descendant::span[@class="mainVillage"]/../../td[@class="coords"]'
								+ '//span[@class="coy" or @class="yCoord" or @class="coordinateY"]';
						break;
					default:
						throwLogicError ( "getMainVillageid():: Travian Version not set!!" );
				}
				var mainvi = document.evaluate(xpathMainVillaAnchor, document, null, XPFirst, null).singleNodeValue;
				if ( mainvi == null ) {
					var msg = "getMainVillageid():: Cannot get main (capital) village!"; 
					TS_debug ( msg );
					throwLogicError ( msg );
				}
				var themainv = mainvi.innerHTML;
				var mainpos = mainvi.href.match(/\bd=\d{1,}\b/)[0].split("=")[1];
				//flag ( "getMainVillageid():: Setting _mainvillageName: " + themainv );
				GM_setValue(myacc() + "_mainvillageName", themainv);
				//flag ( "getMainVillageid():: Setting _mainvillageId: " + getDidFromVillage(themainv) );
				GM_setValue(myacc() + "_mainvillageId", getDidFromVillage(themainv));

				var racefound = false;
				for (oo in aLangRaceName) {
					var therace = new RegExp(aLangRaceName[oo]);
					if (document.getElementsByTagName("body")[0].innerHTML.match(therace)) {
						GM_setValue(myacc() + "_raceID", oo.toString());
						var racefound = true;
						break;
					}
				}
				if ( racefound == false ) {
					printErrorMSG ( "<b>ERROR:: Cannot set race, translation required for race names.</b>", 1 );
				}

				//flag ( "getMainVillageid():: aTravianVersion: " + aTravianVersion );
				//flag ( "getMainVillageid():: xpathX: " + xpathX );
				//flag ( "getMainVillageid():: xpathY: " + xpathY );
				//flag ( "getMainVillageid():: coordx: " + document.evaluate(xpathX, document, null, XPFirst, null).singleNodeValue.innerHTML );
				//flag ( "getMainVillageid():: coordy: " + document.evaluate(xpathY, document, null, XPFirst, null).singleNodeValue.innerHTML );
				var coordx = document.evaluate(xpathX, document, null, XPFirst, null).singleNodeValue.innerHTML.match(/[-0-9]{1,}/);
				var coordy = document.evaluate(xpathY, document, null, XPFirst, null).singleNodeValue.innerHTML.match(/[-0-9]{1,}/);
				GM_setValue(myacc() + "_mainVillageCoord", coordx+"/"+coordy);
				GM_setValue(myacc() + "_mainVillagePosition", mainpos.toString());
			}
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getMainVillageid():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getResourceCap(aElem, vi) {
	try {
		if ( vi == null || vi == undefined || vi == "" ) {
			var msg = "getResourceCap():: Invalid vi passed as parameter! vi: " + vi; 
			TS_debug ( msg );
			var errObj = new Error () ;
			errObj.name = "Invalid Argument passed to function";
			errObj.message = msg;
			throw errObj;
		}

		getResourceCap2(aElem,vi);

		var resource = [];
		var resstring = "";
		var WarehouseCap = "";
		var GranaryCap = "";
		switch ( aTravianVersion ) {
			case "3.6":
				resource = [	document.evaluate('id("l4")', aElem, null, XPFirst, null).singleNodeValue.innerHTML.split("/")[0], 
						document.evaluate('id("l3")', aElem, null, XPFirst, null).singleNodeValue.innerHTML.split("/")[0], 
						document.evaluate('id("l2")', aElem, null, XPFirst, null).singleNodeValue.innerHTML.split("/")[0], 
						document.evaluate('id("l1")', aElem, null, XPFirst, null).singleNodeValue.innerHTML.split("/")[0], 
					];
				resstring = resource.join("/");
				WarehouseCap = $("l4",aElem).innerHTML.split("/")[1];
				GranaryCap = $("l1",aElem).innerHTML.split("/")[1];
				break;
			case "4.0":
				resource = [	document.evaluate('id("l1")', aElem, null, XPFirst, null).singleNodeValue.innerHTML.split("/")[0], 
						document.evaluate('id("l2")', aElem, null, XPFirst, null).singleNodeValue.innerHTML.split("/")[0], 
						document.evaluate('id("l3")', aElem, null, XPFirst, null).singleNodeValue.innerHTML.split("/")[0], 
						document.evaluate('id("l4")', aElem, null, XPFirst, null).singleNodeValue.innerHTML.split("/")[0], 
					];
				resstring = resource.join("/");
				WarehouseCap = $("l1",aElem).innerHTML.split("/")[1];
				GranaryCap = $("l4",aElem).innerHTML.split("/")[1];
				break;
			default:
				throwLogicError ( "getResourceCap():: Travian Version not set!!" );
		}

		GM_setValue(myacc() + "_" + vi + "_WarehouseCap", WarehouseCap);
		GM_setValue(myacc() + "_" + vi + "_GranaryCap", GranaryCap);
		GM_setValue(myacc() + "_" + vi + "_ResourceNow", resstring);

	}
	catch ( err ) {
		printStackTrace();
		var msg = "getResourceCap():: Something went wrong, error: " + err.name + ", Error Message: " + err.message;
		flag ( msg );
		playSound ( "<b>" + msg + "</b>" );
		throw err;
	}
}

function getResourceCap2(aElem,vi) {
	try {
		var now = new Date().getTime();
		var resources = [0,0,0,0];
		var production = [0,0,0,0];
		for(var i = 4; i> 0;i--) {
			var aX = $("l"+i, aElem);
			if(aX == null) {
				TS_debug(aElem.innerHTML);
			}
			switch ( aTravianVersion ) {
				case "3.6":
					production[4-i] = parseInt(aX.title);
					resources[4-i] = parseInt(aX.innerHTML.split("/")[0]);
					break;
				case "4.0":
					var resprod = $g('.//*[@id="res"]/*[@class="r'+i+'"]', XPFirst, aElem);
					//flag ( "getResourceCap2():: resprod.title: " + resprod.title.match(/\b\d{1,}\b/)[0] );
					production[i-1] = parseInt(resprod.title.match(/\b\d{1,}\b/)[0]);
					resources[i-1] = parseInt(aX.innerHTML.split("/")[0]);
					break;
				default:
					throwLogicError ( "getResourceCap2():: Travian Version not set!!" );
			}
		}
		
		var WarehouseCap = "";
		var GranaryCap = "";
		switch ( aTravianVersion ) {
			case "3.6":
				WarehouseCap = parseInt($("l4", aElem).innerHTML.split("/")[1]);
				GranaryCap = parseInt($("l1", aElem).innerHTML.split("/")[1]);
				break;
			case "4.0":
				WarehouseCap = parseInt($("l1", aElem).innerHTML.split("/")[1]);
				GranaryCap = parseInt($("l4", aElem).innerHTML.split("/")[1]);
				break;
			default:
				throwLogicError ( "getResourceCap2():: Travian Version not set!!" );
		}
		setGMCookie("ResourceNow",resources,vi);
		setGMCookie("WarehouseCap",WarehouseCap,vi);
		setGMCookie("GranaryCap",GranaryCap,vi);
		
		setGMCookie("ResUpdateTime",now,vi);
		setGMCookie("ProductionRate",production,vi);
	}
	catch ( err ) {
		printStackTrace();
		var msg = "getResourceCap2():: Something went wrong, error: " + err.name + ", Error Message: " + err.message;
		flag ( msg );
		playSound ( "<b>" + msg + "</b>" );
		throw err;
	}
}

function getEstimatedResources(newdid)
{
  var resources = getGMCookie("ResourceNow",newdid);
  var production = getGMCookie("ProductionRate",newdid);
  var resUpTime = getGMCookie("ResUpdateTime",newdid);
  var ms2h = 60*60*1000;
  var now = new Date().getTime();
  var gap = now - resUpTime;
  var eRes = [0,0,0,0];
  for(var i =0; i<4; i++)
  {
		eRes[i] = resources[i] + Math.ceil(gap*production[i]/ms2h);
  }
  return eRes;
}

/*
function getEstimatedTransit ( vi, vid ) {
	try {
		//flag ( "getEstimatedTransit():: to: " + getvillagefromdid(vid) + ", from: " + getvillagefromdid(vi) );
		var merchantList = getGMCookieVi("MerchantTransit",vid,vi);
		//var merchantList = getGMCookieVi("MerchantTransit",newdid);
		var resUpTime = getGMCookie("ResUpdateTime",vid);
		//var resUpTime = getGMCookie("ResUpdateTime",newdid);
		var newMerchantList = {};
		//First prune the merchantList based on ResUpdateTime
		
		var transit = [0,0,0,0];
		if ( merchantList ) {
			for ( var i in merchantList ) {
				var viMerchantList = merchantList[i];
				if ( viMerchantList ) {
					newMerchantList[i] = new Array();
					for ( var j in viMerchantList )	{
						var merchant = viMerchantList[j];
						if ( merchant ) {
							if ( merchant.t > resUpTime ) { //If merchant has not arrived Yet
								transit[0] += merchant.r[0];
								transit[1] += merchant.r[1];
								transit[2] += merchant.r[2];
								transit[3] += merchant.r[3];
							}
							else {
								newMerchantList[i].push(merchant);
							}
						}
					}
				}
			}
		}
		setGMCookieAll("MerchantTransit",newMerchantList,vid,vi);
		//setGMCookieAll("MerchantTransit",newMerchantList,newdid);
		return transit;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getEstimatedTransit():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}*/

///
/// Will store cookie in an array. if only one is specified it will store
/// it 
function setGMCookie(aName, aValue, newdid) {
		var nC = myacc() + "_" + aName;
		setGMCookieB(nC,aValue,newdid)
}

function setGMCookieVi ( aName, aValue, vid, newdid )
{
		var nC = myacc() + "_" +vid + "_" + aName;
		setGMCookieB(nC,aValue,newdid);
}
//
//WARNING: used improperly this function can messup
// stored data
function setGMCookieAll(aName, aValue, vid)
{
	var nC;
	if(vid && vid != 0)
	{
		nC =  myacc() + "_" + vid + "_"+ aName;
	}
	else
	{
		nC =  myacc() + "_" + aName;
	}
	try {
		GM_setValue(nC, JSON.stringify(aValue));
	}
	catch (e) {
		GM_setValue(nC, uneval(aValue));
	}
}
function setGMCookieB(nC,aValue,newdid)
{
		if (!newdid  || newdid == 0) return;
		var cV = GM_getValue(nC, '{}');
		try { cV = JSON.parse(cV) } catch(e) { cV = eval(cV); }
		if (cV == 'false' || cV == false || !cV ) cV = {};
		cV[newdid] = aValue;
		try {
			GM_setValue(nC, JSON.stringify(cV)); 
		}
		catch (e) {
			GM_setValue(nC, uneval(cV)); 
		}
}
function getGMCookie(aName, newdid)
{   
		var nC = myacc() +  "_" + aName;
		return getGMCookieB(nC,newdid);
}
function getGMCookieVi(aName, vid, newdid)
{
    var nC = myacc() + "_" +vid + "_" + aName;
    return getGMCookieB(nC,newdid);
}
function getGMCookieB(nC,newdid)
{
    if (!newdid  || newdid == 0) return;
    var cV =  GM_getValue(nC, '{}');
    try { cV = JSON.parse(cV) } catch(e) { cV = eval(cV); }
    if (cV == 'false' || cV == false || !cV ) cV = {};
    if(newdid && newdid != 0)
    {
        return cV[newdid];
    }
    else
    {
        return cV;
    }
}

function HttpRequire (url, v, ta, k, l) {
	try {
		flag ( "HttpRequire():: Started! v: " + v + ", k: " + k + ", l: " + l + ", id: " + ta[1] );
		//TS_debug("come into HttpRequire(), at "+getvillagefromdid(v)+" to build "+ta[ta.length-1]);
		//TS_debug("start HttpRequire(" + url + ", " + v + ", " + ta + ", " + k + ", " + l + ")");
		if (url) {
			var nurl = url.split(".php?")[0] + ".php?newdid=" + v + "&" + url.split(".php?")[1];
			flag ( "HttpRequire():: url = " + nurl );
			GM_xmlhttpRequest({
				method: 'GET',
				url: nurl,
				headers: "",
				onload: function ( result ) {
					try {
						flag ( "HttpRequire():: CallBack Started!");
						if ( gatherStats(result.responseText) ) {
							// attempt reloading page, captcha ll be found there too and script will stop.
							window.location.replace(myhost + "/spieler.php");
							return false;
						}

						function dispHttpRequireError() {
							var msg = "";
							switch (k) {
								case "0": // resource upgrade
									msg = aLangGameText[7] + " " + getvillagefromdid(v) + " (" + v + "):: id: " + ta[1]
											+ ", Auto Resource upgrade to next level failed!";
									break;
								case "1": // build task
									if ( ta[0] == "0" ) { // building upgrade failed
										msg = aLangGameText[7] + " " + getvillagefromdid(v) + " (" + v + "):: id: " + ta[1] + ", " + ta[4]
											+ " upgrade to level " + ta[2] + " failed!";
									}
									else { // new build failed
										msg = aLangGameText[7] + " " + getvillagefromdid(v) + " (" + v + "):: id: " + ta[1] + ", " + ta[5]
											+ " new-build failed!";
									}
									break;
								case "2": // other race resource/building task
									if ( ta[0] == "0" ) { // resource/building upgrade failed
										msg = aLangGameText[7] + " " + getvillagefromdid(v) + " (" + v + "):: id: " + ta[1] + ", " + ta[4]
											+ " upgrade to level " + ta[2] + " failed!";
									}
									else { // new build failed
										msg = aLangGameText[7] + " " + getvillagefromdid(v) + " (" + v + "):: id: " + ta[1] + ", " + ta[5]
											+ " new-build failed!";
									}
									break;
							}
							printErrorMSG ( msg );
							flag ( "HttpRequire():: " + msg );
						}

						var aElem = document.createElement('DIV');
						aElem.innerHTML = result.responseText;

						refreshPageInfo(aElem);

						var loadedVillageId = getVillageId(aElem);
						var villageName = getvillagefromdid(loadedVillageId);
						if ( result == null || result.responseText == null || result.responseText == "" ||
								villageName == null || villageName == "" || 
								villageName.match ( getvillagefromdid(v).replace("\(","\\(").replace("\)","\\)") ) == null
								) { // probably there was some error.
							if ( result == null )
								printErrorMSG ( "result is null!" );
							else if ( result.responseText == null )
								printErrorMSG ( "result.responseText is null!" );
							else if ( result.responseText == "" )
								printErrorMSG ( "result.responseText is ''!" );
							else if ( villageName == null )
								printErrorMSG ( "villageName is null!" );
							else if ( villageName == "" )
								printErrorMSG ( "villageName is ''!" );
							else if ( villageName.match ( getvillagefromdid(v) ) == null )
								printErrorMSG ( "villageName != " + getvillagefromdid(v) + ", got villageName: " + villageName );
							else
								printErrorMSG ( "Unknown Error!" );
							dispHttpRequireError();
							//return false; // do not return here, sometimes, http req goes through, but we might not get back the response.
						}
						else {
							// this check works sort of well for buildings and some what less well for resources.
							// a) only after level 10 of a building, we can build 2 of that building simultaneously, hence if the 2nd one fails, 
							// that wont be caught.
							// b) for resources, we can have two resource tiles of the same kind building simultaneously, hence if the 2nd one fails,
							// that wont be caught.
							
							var bData = getCookie("BuildingData",v);
							var gid;
							if(bData && bData[parseInt(ta[1])])
							{
								gid = bData[parseInt(ta[1])].gid;
							}
							else
							{
								gid = getGidFromName(ta[4]);
							}
							TS_debug("httpRequire:: current task gid = " + gid);
							var btl = getCookie("BuildingTimeList",v);
							var foundRes = false;
							if(btl) //nothing is building
							{
								for(var i in btl)
								{
									if(btl[i].gid == gid)
										foundRes = true;
								}
							}

							if ( foundRes == false ) { // when specified resource is not building
								dispHttpRequireError();
								calldoing1();
								showTaskList();
								return false;
							}
						}

						switch (k) {
							case "0"://resource updata
								GM_deleteValue ( myacc() + "_" + v + "_resRequiredForResUpgrade" );
								GM_deleteValue ( myacc() + "_" + v + "_ResourceUpdataTime" );
								// put the newly built id into _autoResourceDone.
								var ttemp = GM_getValue(myacc() + "_" + v + "_autoResourceDone", "" );
								GM_setValue(myacc() + "_" + v + "_autoResourceDone", ttemp+"|"+ta[1]+"_"+(Number(l)-1).toString());
								if (l >= ta[2]) {
									deleteTaskFromCookie(v, ta);
								}
								break;
							case "1"://build task
								GM_deleteValue ( myacc() + "_" + v + "_resRequiredForBldgUpgrade" );
								GM_deleteValue ( myacc() + "_" + v + "_BuildingUpdataTime" );
									switch (ta[0]) {
									case "0"://build updata
										if (l >= ta[2]) {
											deleteTaskFromCookie(v, ta);
										}
										break;
									case "1"://new build
										if (l >= ta[2]) {
											deleteTaskFromCookie(v, ta);
										}
										else { // change new build task to upgrade task
											//var changeToUP=new Array();
											var changeToUP = ta.slice(0); // clone the array ta.
											changeToUP[0] = "0";
											changeToUP.splice(3,1); // remove the gid
											deleteTaskFromCookie(v, ta,changeToUP);
										}
										break;
								}
								break;
							case "2":
								GM_deleteValue ( myacc() + "_" + v + "_resRequired" );
								GM_deleteValue ( myacc() + "_" + v + "_UpdataTime" );
								// put the newly built id into _autoResourceDone.
								if ( ta[1] <= 18 || ta[1] == 50 ) { // only for resource tasks.
									var ttemp = GM_getValue(myacc() + "_" + v + "_autoResourceDone", "" );
									GM_setValue(myacc() + "_" + v + "_autoResourceDone", ttemp+"|"+ta[1]+"_"+(Number(l)-1).toString());
								}
		
								switch (ta[0]) {
									case "0":
										if (l >= ta[2]) {
											deleteTaskFromCookie(v, ta);
										}
										break;
									case "1":
										if (l >= ta[2]) {
											deleteTaskFromCookie(v, ta);
										}
										else {//new build 1_id_level_gid_time_name  to  Updata 0_id_level_time_name
											//var changeToUP=new Array();
											var changeToUP = ta.slice(0); // clone the array ta.
											changeToUP[0] = "0";
											changeToUP.splice(3,1); // remove the gid
											deleteTaskFromCookie(v, ta,changeToUP);
										}
										break;
								}
								break;
						}
						// if wrong village reload window
						if ( loadedVillageId != v) { // probably there was some error, attempt reload of login window.
							// reload login window, which indirectly calls getTaskCookies
							window.setTimeout ( function() {
										var msg = aLangGameText[7] + " " + getvillagefromdid(v) + " (" + v + "): id: " + ta[1] + " " + 
													aLangOtherText[6];
										printMSG ( msg );
										flag ( "HttpRequire():: " + msg );
										//calldoing1(); // not needed as we are reloading login window.
										showTaskList();
										reloadLoginWindow();
										msg = null;
									}, 
									Math.ceil ( Math.random() * 5*1000 + 5*1000 ) ); // random ( 5 sec ) + 5 sec
						}
						else { // this is either dorf1 or dorf2
							var msg = aLangGameText[7] + " " + getvillagefromdid(v) + " (" + v + "): id: " + ta[1] + " " + aLangOtherText[6];
							printMSG ( msg );
							flag ( "HttpRequire():: " + msg );
							if ( ta[1] <= 18 || ta[1] == 50 ) { // resource task
								getStatsFromDorf1 ( aElem, v );
							}
							else { // non-resource task, ie building task
								clearBuildingPreRequisiteError ( v );
								getStatsFromDorf2 ( aElem, v );
							}
							calldoing1();
							showTaskList();
						}
					}
					catch ( err ) {
						printStackTrace();
						var msg = "HttpRequire() CallBack:: Something went wrong, error: " + err.name + " :: " + err.message;
						playSound ( msg );
						throw err;
					}
				} // end of onload function
			})
		}
		else { // this should never happen
			var varString = ""
			switch (k){
				case "0":
					varString="_ResourceUpdataTime";
					break;
				case "1":
					varString = "_BuildingUpdataTime";
					break;
				case "2":
					varString = "_UpdataTime";
					break;
			}
			delayUpgrade(v, varString);
			calldoing1();
			showTaskList();
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "HttpRequire():: Something went wrong, error: " + err.name + " :: " + err.message;
		playSound ( msg );
		throw err;
	}
}

// event handler for taskForm_wrapper, ie for resource / building upgrades and for new builds
// Task Kind: 0 [ resource / building upgrades ]
// Task Kind: 1 [ newbuild building ]
function setTaskCookies() { // 1_25_1_undefined_1248453089000_Hero
	var taskkindss = $("taskkindss").value;
	var crtvillagee = $("crtvillagee").value;
	var buildnamee = $("buildNamee").value;
	var bidid = $("bidid").value;
	var levelselect = $("levelselect").value;
	var taskTimee = $("userSetTime").value;
	var todday = new Date(taskTimee);
	var userSetTime = todday.getTime();
	//TS_debug(" setTaskCookies() var = " + taskTimee);

	var myRace = GM_getValue(myacc() + "_raceID");
	var thisTask = "";
	switch (taskkindss) {
		case "0":
			thisTask = taskkindss + "_" + bidid + "_" + levelselect + "_" + userSetTime+"_"+buildnamee;
			if ( myRace == "0" ) { // romans
				if ( bidid <= 18 || bidid == 50 ) {
					GM_setValue(herere() + "_ResourceTaskExists", "1");
				}
				else if ( bidid > 18 && bidid <=40 ) {
					GM_setValue(herere() + "_BuildingTaskExists", "1");
				}
			}
			else { // non-romans
				GM_setValue(herere() + "_UpdataTaskExists", "1");
			}
			break;
		case "1":
			thisTask = taskkindss + "_" + bidid + "_" + levelselect + "_" + getGidFromName(buildnamee) + "_" + userSetTime+"_"+buildnamee;
			if ( myRace == "0" ) { // romans
				GM_setValue(herere() + "_BuildingTaskExists", "1");
			}
			else { // non-romans
				GM_setValue(herere() + "_UpdataTaskExists", "1");
			}
			break;
	}
	var allTask = (GM_getValue(herere() + "_waitTask")) ? GM_getValue(herere() + "_waitTask") + "|" + thisTask : thisTask;
	GM_setValue(herere() + "_waitTask", allTask);

	clearCropWarehouseGranaryError ( currentID() );

	document.body.removeChild($("taskForm_wrapper"));
	showTaskList();
	getTaskCookies(); // calling getTaskCookies() to set cookies, this will eventually call startBuildOrSetTime() to set relevant cookies.

	return false;
}

/****************************************************************************/
var mouseOffset = null;
var iMouseDown = false;
var lMouseState = false;
var dragObject = null;
var curTarget = null;
// GotGs 2011.01.15 -- Properly handling dragObjects
var dragObjectList = new Array();
var dragObjectMouseOffSetList = new Array();

// Global set & get options common for all villages.
function setOption(key, value){
	var options = GM_getValue(myacc() + "_option");
	// GotGs 2011.01.15 -- '&&' is the logical 'and' and not '&'
	if (options && options != '' && options != null) {
		options = options.split(",");
	}
	else {
		GM_setValue(myacc() + "_option", "");
		options = new Array();
	}
	var myOption = options.indexOf(key);
	if (myOption < 0) {
		options.push(key);
		options.push(value);
	}
	else {
		options[myOption + 1] = value;
	}
	options = options.join(",");
	GM_setValue(myacc() + "_option", options);
}

function getOption(key, defaultValue, type) {
	var options = GM_getValue(myacc() + "_option", "");
	options = options.split(",");
	var myOption = options.indexOf(key);
	if (myOption < 0) {
		return defaultValue;
	}
	switch (type) {
		case "boolean":
			myOption = (options[myOption + 1] == "true") ? true : false;
			break;
		case "integer":
			myOption = parseInt(options[myOption + 1]);
			break;
		case "string":
		default:
			myOption = options[myOption + 1];
			break;
	}
	return myOption;
}

// Village specific set & get options.
function setVillageOption(key, value, vi){
	if ( !vi )
		throwLogicError ( "setVillageOption():: vi is not set!!" );
	//var options = GM_getValue(herere() + "_taskOption");
	var options = GM_getValue(myacc() + "_" + vi + "_taskOption");
	if (options && options != '' && options != null) {
		options = options.split(",");
	}
	else {
		//GM_setValue(herere() + "_taskOption", "");
		GM_setValue(myacc() + "_" + vi + "_taskOption", "");
		options = new Array();
	}
	var myOption = options.indexOf(key);
	if (myOption < 0) {
		options.push(key);
		options.push(value);
	}
	else {
		options[myOption + 1] = value;
	}
	options = options.join(",");
	//GM_setValue(herere() + "_taskOption", options);
	GM_setValue(myacc() + "_" + vi + "_taskOption", options);
}

function getVillageOption(key, defaultValue, type, vi) {
	if ( !vi )
		throwLogicError ( "getVillageOption():: vi is not set!!" );
	if ( GM_getValue(myacc() + "_undefined_taskOption") )
		GM_deleteValue(myacc() + "_undefined_taskOption");
	//var options = GM_getValue(herere() + "_taskOption");
	var options = GM_getValue(myacc() + "_" + vi + "_taskOption");
	if ( !options ) {
		setVillageOption(key, defaultValue, vi);
		return defaultValue;
	}
	options = options.split(",");
	var myOption = options.indexOf(key);
	if (myOption < 0) {
		return defaultValue;
	}
	switch (type) {
		case "boolean":
			myOption = (options[myOption + 1] == "true") ? true : false;
			break;
		case "integer":
			myOption = parseInt(options[myOption + 1]);
			break;
		case "string":
		default:
			myOption = options[myOption + 1];
			break;
	}
	return myOption;
}

function mouseCoords(ev) {
	return {
		x: ev.pageX,
		y: ev.pageY
	};
}

function makeClickable(object) {
	object.onmousedown = function() {
		dragObject = this;
	}
}

function getMouseOffset(target, ev) {
	var docPos = getPosition(target);
	var mousePos = mouseCoords(ev);
	return {
		x: mousePos.x - docPos.x,
		y: mousePos.y - docPos.y
	};
}

function getPosition(e){
	var leftp = 0;
	var topp = 0;
	while (e.offsetParent) {
		leftp += e.offsetLeft + (e.currentStyle ? (parseInt(e.currentStyle.borderLeftWidth)).NaN0() : 0);
		topp += e.offsetTop + (e.currentStyle ? (parseInt(e.currentStyle.borderTopWidth)).NaN0() : 0);
		e = e.offsetParent;
	}
	leftp += e.offsetLeft + (e.currentStyle ? (parseInt(e.currentStyle.borderLeftWidth)).NaN0() : 0);
	topp += e.offsetTop + (e.currentStyle ? (parseInt(e.currentStyle.borderTopWidth)).NaN0() : 0);
	return {
		x: leftp,
		y: topp
	};
}

function mouseMove(ev) {
	var target = ev.target;
	var mousePos = mouseCoords(ev);

	if (dragObject) {
		// GotGs 2011.01.15 --  Properly handling dragObjects
		//dragObject.style.position = 'fixed';
		dragObject.style.top = (mousePos.y - mouseOffset.y) + "px";
		dragObject.style.left = (mousePos.x - mouseOffset.x) + "px";
	}
	lMouseState = iMouseDown;
	return false;
}

function mouseUp(ev) {
	var key = "";
	if (dragObject) {
		//flag ( "dragObject.id: " + dragObject.id );
		switch (dragObject.id) {
			case "demolistform_wrapper":
				key = "DEMOLISH_POSITION";
				break;
			case "tranlmtform_wrapper":
				key = "TRANLMT_POSITION";
				break;
			case "tasklisttable_wrapper":
				key = "TASKLIST_POSITION";
				break;				
			case "taskForm_wrapper":
				key = "FORM_POSITION";
				break;
			case "tranForm_wrapper":
				key = "TRAN_POSITION";
				break;
			case "MSG_wrapper":
				key = "MSG_POSITION";
				break;
			case "Error_MSG_wrapper":
				key = "ERROR_MSG_POSITION";
				break;
			case "test_alarm_wrapper":
				key = "TEST_ALARM_POSITION";
				break;
			case "alarm_wrapper":
				key = "ALARM_POSITION";
				break;
			case "show_info_bubble_wrapper":
				key = "SHOW_INFO_BUBBLE_POSITION";
				break;
			case "trainform_wrapper":
				key = "TRAIN_POSITION";
				break;
			case "attackform_wrapper":
				key = "ATTACK_POSITION";
				break;
			case "improveform_wrapper":
				key = "IMPRO_POSITION";
				break;
			case "customtransform_wrapper":
				key = "CUSTOMTRAN_POSITION";
				break;
			case "langTranslate_wrapper":
				key = "LANG_TRANSLATE_POSITION";
				break;
			case "crop_finder_wrapper":
				key = "CROP_FINDER_FORM_POSITION";
				break;
			default:
				key = "LIST_POSITION";
				break;
		}
		setOption(key, dragObject.style.top + "_" + dragObject.style.left);
	}
	dragObject = null;
	// GotGs 2011.01.15 --  Properly handling dragObjects 
	if ( dragObjectList.lenght > 0 ) {
		dragObject = dragObjectList.pop()
		mouseOffset = dragObjectMouseOffSetList.pop()
	}
	iMouseDown = false;
}

function mouseDown(ev) {
	var mousePos = mouseCoords(ev);
	var target = ev.target;
	iMouseDown = true;
	if (target.getAttribute('DragObj')) {
		return false;
	}
}

function makeDraggable(item) {
	if (!item) 
		return;
	//flag ( "makeDraggable():: Started! id: " + item.parentNode.id );
	item.parentNode.addEventListener("mousedown", function(ev){
		// GotGs 2011.01.15 -- Properly handling dragObjects
		if ( dragObject ){
			dragObjectList.push(dragObject);
			dragObjectMouseOffSetList.push(mouseOffset);
		}
		//dragObject = this.parentNode;
		//mouseOffset = getMouseOffset(this.parentNode, ev);
		dragObject = this;
		mouseOffset = getMouseOffset(this, ev);
		//flag ( "makeDraggable_eventListener():: id: " + this.id );
		return false;
	}, false);
}

document.addEventListener("mousemove", mouseMove, false);
document.addEventListener("mousedown", mouseDown, false);
document.addEventListener("mouseup", mouseUp, false);


/****************************************************************************/

function createDemolishlnk() {
	var nposi=$("contract");
	var errors = document.evaluate('.//p[@class="none"]', document, null, XPFirst, null);
	var nextposition=(nposi)?nposi:errors.singleNodeValue;
	var demolishdiv=document.createElement("div");
	demolishdiv.id="demolishdiv";
	var demolishlnk=document.createElement("a");
	demolishlnk.id="demolishlnk";
	demolishlnk.href="#";
	demolishlnk.innerHTML="&#160;&#160;"+aLangTaskOfText[18] +"&#160;&#160;";
	demolishlnk.addEventListener("click", createDemolishFloat, false);
	demolishdiv.appendChild(demolishlnk);
	nextposition.parentNode.insertBefore(demolishdiv,nextposition);
}

//-----------------------------------------------------------------------------------------------
// Create link for option update and other
//-----------------------------------------------------------------------------------------------


function createNewbuildLnk() {
	//TS_debug("createNewbuildLnk");
	crtvillagedid = currentID();
	buildnextlevel="1";
	buildidss = window.location.href.match(/[^d]id=\d{1,2}/);
	buildidid = buildidss.toString().match(/\d{1,2}/);		
	switch ( aTravianVersion ) {
		case "3.6":
			xpathNewBuildContract = './/div[@id="build"]/table[@class="new_building"]';
			xpathSoonNewBuildContract = './/div[@id="build_list_soon"]/table[@class="new_building"]';
			xpathMoreNewBuildContract = './/div[@id="build_list_all"]/table[@class="new_building"]';
			break;
		case "4.0":
			xpathNewBuildContract = './/div[@id="build"]/div[@class="contract contractNew contractWrapper"]';
			xpathSoonNewBuildContract = './/div[@id="build_list_soon"]/div[@class="contract contractNew contractWrapper"]';
			xpathMoreNewBuildContract = './/div[@id="build_list_all"]/div[@class="contract contractNew contractWrapper"]';
			break;
		default:
			throwLogicError ( "createNewbuildLnk():: Travian Version not set!!" );
	}
	var allnewbuilds = document.evaluate ( xpathNewBuildContract, document, null, XPSnap, null );
	for (var i = 0; i < allnewbuilds.snapshotLength; i++) {
		switch ( aTravianVersion ) {
			case "3.6": buildName = allnewbuilds.snapshotItem(i).previousSibling.previousSibling.innerHTML; break;
			case "4.0": buildName = allnewbuilds.snapshotItem(i).previousSibling.previousSibling.previousSibling.previousSibling.innerHTML; break;
		}
		//buildName=(buildName.indexOf(aLangAllBuildWithId[10])!=-1)?aLangAllBuildWithId[10]:((buildName.indexOf(aLangAllBuildWithId[11])!=-1)?aLangAllBuildWithId[11]:buildName);
		// when we build more than 1 of warehouse, granary or cranny, the name displayed in build page contains a number along with the name which must be removed.
		// for example if building 2nd warehouse, build name displayed in build.php will be something like '2. Warehouse'.
		if ( buildName.indexOf(aLangAllBuildWithId[10]) != -1 ) { // warehouse
			buildName = aLangAllBuildWithId[10];
		}
		else if ( buildName.indexOf(aLangAllBuildWithId[11]) != -1 ) { // granary
			buildName = aLangAllBuildWithId[11];
		}
		else if ( buildName.indexOf(aLangAllBuildWithId[23]) != -1 ) { // cranny
			buildName = aLangAllBuildWithId[23];
		}
		//TS_debug("GotGs 2011.01.15 -- createNewbuildLnk(): Creating link for: " + buildName );
		buildgid=getGidFromName(buildName);
		buildmaxlevel = parseInt(maxlevel[buildgid],10);
		//theposition = allnewbuilds.snapshotItem(i).lastChild;
		theposition = allnewbuilds.snapshotItem(i);

		var createUrl = document.createElement("a");
		createUrl.id = "createnewurl";
		createUrl.href = "#";
		createUrl.innerHTML = "&#160;&#160;" + aLangTaskOfText[1]+"&#160;&#160;" ;
		createUrl.setAttribute("crtvillage", crtvillagedid);
		createUrl.setAttribute("buildName", buildName);
		createUrl.setAttribute("buildnextlevel", buildnextlevel);
		createUrl.setAttribute("buildmaxlevel", buildmaxlevel);
		createUrl.setAttribute("buildgid", buildgid);
		createUrl.setAttribute("buildidid", buildidid);
		createUrl.addEventListener("click", createUpdateFloat, false);
		theposition.appendChild(createUrl);
		//TS_debug("GotGs 2011.01.15 -- createNewbuildLnk(): " + allnewbuilds.snapshotItem(i).innerHTML );
	}
	var allsoonnewbuilds = document.evaluate ( xpathSoonNewBuildContract, document, null, XPSnap, null );
	for (var i = 0; i < allsoonnewbuilds.snapshotLength; i++) {
		switch ( aTravianVersion ) {
			case "3.6": buildName = allsoonnewbuilds.snapshotItem(i).previousSibling.previousSibling.innerHTML; break;
			case "4.0": buildName = allsoonnewbuilds.snapshotItem(i).previousSibling.previousSibling.previousSibling.previousSibling.innerHTML; break;
		}
		buildName=(buildName.indexOf(aLangAllBuildWithId[10])!=-1)?aLangAllBuildWithId[10]:((buildName.indexOf(aLangAllBuildWithId[11])!=-1)?aLangAllBuildWithId[11]:buildName)
		//TS_debug("GotGs 2011.01.15 -- createNewbuildLnk(): Creating link for (soon): " + buildName );
		buildgid=getGidFromName(buildName);
		buildmaxlevel = parseInt(maxlevel[buildgid],10);
		//theposition = allsoonnewbuilds.snapshotItem(i).lastChild;
		theposition = allsoonnewbuilds.snapshotItem(i);

		var createUrl = document.createElement("a");
		createUrl.id = "createnewurl";
		createUrl.href = "#";
		createUrl.innerHTML = "&#160;&#160;" + aLangTaskOfText[1]+"&#160;&#160;" ;
		createUrl.setAttribute("crtvillage", crtvillagedid);
		createUrl.setAttribute("buildName", buildName);
		createUrl.setAttribute("buildnextlevel", buildnextlevel);
		createUrl.setAttribute("buildmaxlevel", buildmaxlevel);
		createUrl.setAttribute("buildgid", buildgid);
		createUrl.setAttribute("buildidid", buildidid);
		createUrl.addEventListener("click", createUpdateFloat, false);
		theposition.appendChild(createUrl);
		//TS_debug("GotGs 2011.01.15 -- createNewbuildLnk(): Trying to insert after: " + allsoonnewbuilds.snapshotItem(i).innerHTML );
	}
	var allmorenewbuilds = document.evaluate ( xpathMoreNewBuildContract, document, null, XPSnap, null );
	for (var i = 0; i < allmorenewbuilds.snapshotLength; i++) {
		switch ( aTravianVersion ) {
			case "3.6": buildName = allmorenewbuilds.snapshotItem(i).previousSibling.previousSibling.innerHTML; break;
			case "4.0": buildName = allmorenewbuilds.snapshotItem(i).previousSibling.previousSibling.previousSibling.previousSibling.innerHTML; break;
		}
		buildName=(buildName.indexOf(aLangAllBuildWithId[10])!=-1)?aLangAllBuildWithId[10]:((buildName.indexOf(aLangAllBuildWithId[11])!=-1)?aLangAllBuildWithId[11]:buildName)
		//TS_debug("GotGs 2011.01.15 -- createNewbuildLnk(): Creating link for (all): " + buildName );
		buildgid=getGidFromName(buildName);
		buildmaxlevel = parseInt(maxlevel[buildgid],10);
		//theposition = allmorenewbuilds.snapshotItem(i).lastChild;
		theposition = allmorenewbuilds.snapshotItem(i);

		var createUrl = document.createElement("a");
		createUrl.id = "createnewurl";
		createUrl.href = "#";
		createUrl.innerHTML = "&#160;&#160;" + aLangTaskOfText[1]+"&#160;&#160;" ;
		createUrl.setAttribute("crtvillage", crtvillagedid);
		createUrl.setAttribute("buildName", buildName);
		createUrl.setAttribute("buildnextlevel", buildnextlevel);
		createUrl.setAttribute("buildmaxlevel", buildmaxlevel);
		createUrl.setAttribute("buildgid", buildgid);
		createUrl.setAttribute("buildidid", buildidid);
		createUrl.addEventListener("click", createUpdateFloat, false);
		theposition.appendChild(createUrl);
		//TS_debug("GotGs 2011.01.15 -- createNewbuildLnk(): " + allmorenewbuilds.snapshotItem(i).innerHTML );
	}
}

// removes any non-nested tags present in the first argument passed to the function, used mostly to remove <br/> in text
function stripHTML(){
	var re = /<\S[^><]*>/g;
	return arguments[0].replace(re, "");
}

function createbuildlink() {
	crtvillagedid = currentID();
	//TS_debug("START --- function CreateBuiltLink - Upgrade de ELEMENT " + crtvillagedid);
	//TS_debug('for Village: ' + crtvillagedid);
	mainv1 = GM_getValue(myacc() + "_mainvillageId");
	//TS_debug("inner = " + h1in().innerHTML);
	//TS_debug("inner2 = " + stripHTML(h1in().innerHTML));
	h1inner = stripHTML(h1in().innerHTML.replace(/\n/g,"")).split(" ");
	crtlevel = parseInt(h1inner[h1inner.length-1]);
	//TS_debug("h1inner.length = " + h1inner.length);

	var nextLevel = parseInt ( crtlevel, 10 ) + 1;
	var xpathNextLevel = "";
	switch ( aTravianVersion ) {
		case "3.6":
			xpathNextLevel = ".//p[@id='contract']";
			break;
		case "4.0":
			xpathNextLevel = ".//div[@id='contract']/div[@class='contractText']";
			break;
		default:
			throwLogicError ( "createbuildlink():: Travian Version not set!!" );
	}
	var contract = $g ( xpathNextLevel, XPFirst, document );
	if(contract) {
		var tempVal = contract.innerHTML.match(/\b\d{1,}\b[^:]*:/);
		if ( tempVal != null ) {
			nextLevel = tempVal[0].match(/\b\d{1,}\b/)[0];
		}
		if ( tempVal == null || nextLevel == null) {
			throwLogicError ( "createbuildlink():: Error: Cannot get next upgrade level! tempVal: " + tempVal + ", nextLevel: " + nextLevel );
		}
	} //nextLevel can be bigger then level + 1 when double build is activated

	var buildName = "";
	buildidid = "";
	switch (h1inner.length) {
		case 3:
			buildName = h1inner[0];
			break;
		case 4:
			buildName = h1inner[0] + " " + h1inner[1];
			break;
		case 5:
			buildName = h1inner[0] + " " + h1inner[1] + " " + h1inner[2];
			break;
		case 6:
			buildName = h1inner[0] + " " + h1inner[1] + " " + h1inner[2] + " " + h1inner[3];
			break;
	}
	buildmaxlevel = -1;
	for (yyy in aLangAllBuildWithId) {
		if (buildName == aLangAllBuildWithId[yyy]) {
			buildmaxlevel = parseInt(maxlevel[yyy]);
			if ((crtvillagedid == mainv1) && (yyy < 5)) {
				buildmaxlevel *= 2; //mainvillage resource level 20
			}
			break;
		}
	}
	if (buildmaxlevel == -1) return '';
	if (crtlevel < buildmaxlevel && nextLevel <= buildmaxlevel) {
		buildnextlevel = nextLevel;
		if (window.location.href.match(/\bgid=17\b/) != null ) {
			var xpathId = "";
			switch ( aTravianVersion ) {
				case "3.6": xpathId = 'id("textmenu")/descendant::a[@href]'; break;
				case "4.0": xpathId = './/div[@class="contentNavi tabNavi"]//div[@class="container active"]//a[@href]'; break;
				default: throwLogicError ( "createbuildlink():: Travian Version not set!!" );
			}
			var rere = document.evaluate( xpathId, document, null, XPFirst, null);
			buildidid = rere.singleNodeValue.href.match(/\bid=\d{1,2}\b/)[0].split("id=")[1];
		}
		else {
			buildidss = window.location.href.match(/\bid=\d{1,2}\b/);
			buildidid = buildidss[0].match(/\d{1,2}/);
		}
		var theposition = $("contract");
		if ( !theposition ) {
			//theposition = $("contract").nextSibling;
			theposition = $("npcXX_1"); //Travian Beyond
		}
		if ( !theposition ) {
			theposition = find("//p[@class='none']", XPFirst);
		}

		if (theposition) { // Individual update building
			var createUrl = document.createElement("a");
			createUrl.id = "createUrl";
			createUrl.href = "#";
			createUrl.innerHTML = "&#160;&#160;" + aLangTaskOfText[0] + "&#160;&#160;";
			createUrl.setAttribute("crtvillage", crtvillagedid);
			createUrl.setAttribute("buildName", buildName);
			createUrl.setAttribute("buildnextlevel", buildnextlevel);
			createUrl.setAttribute("buildmaxlevel", buildmaxlevel);
			createUrl.setAttribute("buildidid", buildidid);
			createUrl.addEventListener("click", createUpdateFloat, false);
			theposition.parentNode.insertBefore(createUrl, theposition.nextSibling);
			var brElem = document.createElement("br");
			theposition.parentNode.insertBefore(brElem, theposition.nextSibling);
		}
		else
		{
			TS_debug("cannot create Build Link Url, unknown html structure");
		}
	}
	//flag('END 2 --- CreateBuiltLink - Upgrade de BATIMENT ');
}

/*
 * Creates a floating GUI box with demolition parameters.
 */
function createDemolishFloat() {
	var options=document.evaluate('.//select[@name="abriss"]/descendant::option', document, null, XPSnap, null);
	myoptions="";
	for (var i=0; i<options.snapshotLength; i++) {
		if(options.snapshotItem(i).innerHTML.indexOf(aLangGameText[16]) != -1) { continue; }
		myoptions+="<option value='"+options.snapshotItem(i).innerHTML+"'>"+options.snapshotItem(i).innerHTML+"</option>";
	}
	var DemoListForm=document.createElement("form");
	DemoListForm.id="demolistform";
	var floatClose = "<a href='#' onclick='document.body.removeChild($(\"demolistform_wrapper\"));' class='floatClose'><img src='" + 
		sCloseBtn + "' alt='X' /></a>";
	DemoListForm.innerHTML = floatClose;
	DemoListForm.innerHTML += "<br/>" + aLangTaskOfText[18].big() +"<br/><br/>";
	DemoListForm.innerHTML+=  aLangGameText[7] + ":  <select id='crtvillagee' disabled=true><option value='" + currentID() 
		+ "'>" + currentVillageName() + "</option></select><br/><br/>";
	DemoListForm.innerHTML+=aLangTaskOfText[18]+": <select id='selecteddemo'>"+myoptions+"</select><br/><br/>"

	var tSubmitBtn = document.createElement("input");
	tSubmitBtn.value = "OK";
	tSubmitBtn.type = "button";
	tSubmitBtn.addEventListener('click', setDemoCookies, true);
	DemoListForm.appendChild(tSubmitBtn);

	var doWrapper = document.createElement("div");
	doWrapper.id = "demolistform_wrapper";
	doWrapper.appendChild(DemoListForm);

	var formCoords = getOption("DEMOLISH_POSITION", "20px_400px");
	formCoords = formCoords.split("_");
	doWrapper.style.top = formCoords[0];
	doWrapper.style.left = formCoords[1];

	document.body.appendChild(doWrapper);
	makeDraggable($("demolistform"));

	return false;
}

/*
 * Creates a party.
 */
function createPartylnk() {
  	//flag( 'createPartylnk():: Started!' );
	var thePosi = document.getElementsByClassName("gid24")[0];
	var Partylnk = document.createElement("a");
	Partylnk.id = "partylnk";
	Partylnk.href = "#";
	Partylnk.innerHTML = "&#160;&#160;" + aLangTaskOfText[39] + "&#160;&#160;";
	Partylnk.addEventListener("click", createPartyFloat, false);
	if ( aTravianVersion == "4.0" ) {
		var brElem = document.createElement("br");
		thePosi.appendChild(brElem);
	}
	thePosi.appendChild(Partylnk);
}

//
// investigate
//
function createPartyFloat() {
	//flag ( "createPartyFloat(): buildidid: " + buildidid );
	var partyForm = document.createElement("form");
	partyForm.id = "partyform";
	var floatClose = "<a href='#' onclick='document.body.removeChild($(\"partyform_wrapper\"));' class='floatClose'><img src='" + 
		sCloseBtn + "' alt='X' /></a>";

	partyForm.innerHTML = floatClose;
  	//flag("FM S CreatePartyFloat 3 partyid;" + buildidid);
	//var partyid=document.getElementsByTagName("input");// [0]; //.value;
	partyid = buildidid;
	var h1inn = stripHTML(h1in().innerHTML.replace(/\n/g,"")).split(" ");
	bblevel = h1inn[h1inn.length - 1];
	partyForm.innerHTML += "<br/>" + aLangTaskOfText[39].big() + "<br/><br/>";
	partyForm.innerHTML += aLangAddTaskText[2] + ":  <select id='crtvv' disabled=true><option value='" + partyid + "'>" + 
		currentVillageName() + "</option></select><br/>";
  	//TS_debug("FM S CreatePartyFloat 7");
	if ( parseInt(bblevel) < 10 ) {
		//TS_debug("FM S CreatePartyFloat : parseInt(bblevel)<10 ");
		partyForm.innerHTML += aLangAddTaskText[1] + ":<select id='partykind'  disabled=true><option value='1'>" + 
			aLangTaskOfText[40] + "</option>";
	}
	else {
		//TS_debug('FM S CreatePartyFloat : parseInt(bblevel)<10 ');
		partyForm.innerHTML += aLangAddTaskText[1] + ":<select id='partykind' ><option value='1'>" + aLangTaskOfText[40] + 
			"</option><option value='2'>" + aLangTaskOfText[41] + "</option>";
	}

	partyForm.innerHTML +="</select><br/><br/>";

	tod = new Date();
	ye = tod.getFullYear();
	mon = tod.getMonth() + 1;
	dat = tod.getDate();
	hou = tod.getHours();
	if (hou < 10) {hou = "0" + hou;
	}
	minu = tod.getMinutes();
	if (minu < 10) {minu = "0" + minu;
	}
	sec = tod.getSeconds();
	if (sec < 10) {sec = "0" + sec;
	}
	nowtime = ye + "/" + mon + "/" + dat + " " + hou + ":" + minu + ":" + sec;
	partyForm.innerHTML += aLangGameText[4] + ":&#160;&#160;<input type='text' id='startime' style='width:146px' value='" + nowtime + "' /><br/>";
	partyForm.innerHTML += aLangTaskOfText[22] + ":&#160;<input type='text' id='repeat' style='width:30px' value='0' /><br/><br/>";
  	//TS_debug('FM_createPartyFloat : ye=' + ye + " mon=" + mon + " dat=" + dat + " hou=" + hou + " minu=" + minu  );

	var tSubmitBtn = document.createElement("input");
	tSubmitBtn.name = "submitBtn";
	tSubmitBtn.value = "OK";
	tSubmitBtn.type = "button";
	tSubmitBtn.addEventListener('click', setPartyCookies, true);
	partyForm.appendChild(tSubmitBtn);

	var tWrapper = document.createElement("div");
	tWrapper.id = "partyform_wrapper";
	tWrapper.appendChild(partyForm);

	var formCoords = getOption("PARTY_POSITION", "20px_400px");
	formCoords = formCoords.split("_");
	tWrapper.style.top = formCoords[0];
	tWrapper.style.left = formCoords[1];

	document.body.appendChild(tWrapper);
	makeDraggable($("partyform"));

	return false;
}

// event handler for partyform_wrapper, ie for scheduling for parties.
// Task Kind: 6 [ Party Small / Big ]
function setPartyCookies() {
  	//TS_debug("FM ----------------------------------- SetCookiest");
	partyid = $("crtvv").value;
	partykind = $("partykind").value;
	repeat = $("repeat").value;
	var startt = new Date($("startime").value);
	startTime = startt.getTime();
	//------------------------------------------------		//6_1_1000_1245413194000_id
	thisTask = "6_" + partykind + "_" + repeat + "_"+ startTime+"_"+partyid;
	allTask = (GM_getValue(herere() + "_waitTask")) ? GM_getValue(herere() + "_waitTask") + "|" + thisTask : thisTask;
	GM_setValue(herere() + "_waitTask", allTask);
	//---------------------------------------------------------------------------------------------------------------
	document.body.removeChild($("partyform_wrapper"));
	showTaskList();
	getTaskCookies(); // no cookies are required for party, still calling getTaskCookies() for consistency.
	msg = getvillagefromdid(currentID()) + " (" + currentID() + "): " + aLangTaskOfText[39].bold() + " " + aLangOtherText[3];
	printMSG(msg);

	return false;
}

function createImprovelink() {
	//TS_debug('======================= Come into "createImprovelink"');
	if ( $("contract") ) {
		//theposition = $("contract").nextSibling;
		theposition = $("contract")
	}
	else if($("npcXX_1")) { // Travian beyond
		theposition = $("npcXX_1");
	}
	else {
		theposition = find("//p[@class='none']", XPFirst);
	}
	if(theposition)
	{
		var createImprove = document.createElement("a");
		createImprove.id = "createImprove";
		createImprove.href = "#";
		createImprove.innerHTML = "&#160;&#160;" + aLangTaskOfText[48] + "&#160;&#160;";
		createImprove.addEventListener("click", createImproveFloat, false);
		theposition.parentNode.insertBefore(createImprove, theposition.nextSibling);
		if ( aTravianVersion == "4.0" ) {
			var brElem1 = document.createElement("br");
			theposition.parentNode.insertBefore(brElem1, theposition.nextSibling);
			var brElem2 = document.createElement("br");
			theposition.parentNode.insertBefore(brElem2, theposition.nextSibling);
		}
		//theposition.insertBefore(createImprove, theposition.nextSibling);
	}
	else
	{
		TS_debug("cannot create improve url, unknown html structure");
	}
}

function createImproveFloat() {
	//flag(" ----------- createImproveFloat()");
	var h1innI = stripHTML(h1in().innerHTML.replace(/\n/g,"")).split(" ");
	var ibName = "";
	switch (h1innI.length) {
		case 3:
			ibName = h1innI[0];
			break;
		case 4:
			ibName = h1innI[0] + " " + h1innI[1];
			break;
		case 5:
			ibName = h1innI[0] + " " + h1innI[1] + " " + h1innI[2];
			break;
		case 6:
			ibName = h1innI[0] + " " + h1innI[1] + " " + h1innI[2] + " " + h1innI[3];
			break;
	}
	iblevel=h1innI[h1innI.length-1];

	var ImproveForm = document.createElement("form");
	ImproveForm.id = "improveform";
	var floatClose = "<a href='#' onclick='document.body.removeChild($(\"improveform_wrapper\"));' class='floatClose'><img src='" + 
		sCloseBtn + "' alt='X' /></a>";
	ImproveForm.innerHTML = floatClose;

	ImproveForm.innerHTML += "<br/>" + aLangTaskOfText[48].big() + "<br/><br/>";
	ImproveForm.innerHTML += aLangAddTaskText[2] + ":  <select id='crtv' disabled=true><option value='crtv'>" + currentVillageName() + 
		"</option></select><br/><br/>";

	switch (ibName){
		case aLangAllBuildWithId[12]:
			ImproveForm.innerHTML += aLangAddTaskText[1] + ":<select id='improvekind'  disabled=true><option value='1'>" + 
				aLangTaskOfText[49] + "</option></select><br/><br/>";
		break;
		case aLangAllBuildWithId[13]:
			ImproveForm.innerHTML += aLangAddTaskText[1] + ":<select id='improvekind'  disabled=true><option value='2'>" + 
				aLangTaskOfText[50] + "</option></select><br/><br/>";
		break;
	}

	ImproveForm.innerHTML += aLangAddTaskText[3] + ":  " + getImproveTroops(iblevel)+"<br/><br/>";
	ImproveForm.innerHTML += aLangAddTaskText[4] + ":  " + levelselectText(1, iblevel)+"<br/><br/><br/>";

	var tSubmitBtn = document.createElement("input");
	tSubmitBtn.name = "submitBtn";
	tSubmitBtn.value = "OK";
	tSubmitBtn.type = "button";
	tSubmitBtn.addEventListener('click', setImproveCookies, true);
	ImproveForm.appendChild(tSubmitBtn);

	var iWrapper = document.createElement("div");
	iWrapper.id = "improveform_wrapper";
	iWrapper.appendChild(ImproveForm);

	var formCoords = getOption("IMPRO_POSITION", "20px_400px");
	formCoords = formCoords.split("_");
	iWrapper.style.top = formCoords[0];
	iWrapper.style.left = formCoords[1];

	document.body.appendChild(iWrapper);
	makeDraggable($("improveform"));

	return false;
}

// event handler for improveform_wrapper, ie for blacksmith and armoury troops improve.
// Task Kind: 3 [ Blacksmith Improve Offense, Armoury Improve Defense ]
function setImproveCookies() {
	var idss = window.location.href.match(/[^dg]id=\d{1,2}/);
	var idid = idss.toString().match(/\d{1,2}/);
	var imkind = $("improvekind").value;
	var troopkindSN=$("improveTroops").value;
	var impTarget=$("levelselect").value;
	var sotime=new Date();

	var thisTask = "3_" + imkind +"_" + idid + "_" + troopkindSN + "_" +impTarget+"_"+sotime.getTime();
	var allTask = (GM_getValue(herere() + "_waitTask")) ? GM_getValue(herere() + "_waitTask") + "|" + thisTask : thisTask;
	GM_setValue(herere() + "_waitTask", allTask);
	document.body.removeChild($("improveform_wrapper"));
	showTaskList();
	getTaskCookies(); // no cookies are required for blacksmith & armoury troops improve, still calling getTaskCookies() for consistency.

	return false;
}

function getImproveTroops ( maxlvl ) {
	//TS_debug(" getImproveTroops(maxlvl) ");
	//var gettroops=document.evaluate('.//td[@class="desc"]', document, null, XPSnap, null);
	var xpathTroops = "";
	var xpathTroopsLevel = "";
	switch ( aTravianVersion ) {
		case "3.6":
			xpathTroops = './/div[@class="tit"]//a';
			xpathTroopsLevel = './/td[@class="desc"]/*/span[@class="info"]';
			break;
		case "4.0":
			xpathTroops = './/div[@class="title"]//a[2]';
			xpathTroopsLevel = './/div[@class="title"]/span[@class="level"]';
			break;
		default:
			throwLogicError ( "getImproveTroops():: Travian Version not set!!" );
	}

	var gettroops = document.evaluate ( xpathTroops, document, null, XPOrdList, null );
	var gettroopslevel = document.evaluate ( xpathTroopsLevel, document, null, XPOrdList, null );
	var myRace1 = Number ( GM_getValue(myacc() + "_raceID") );
	var troopsSelect = "<select id='improveTroops'>";
		for ( var i = 0; i < gettroops.snapshotLength; i++ ) {
			var troopname = gettroops.snapshotItem(i).innerHTML;
			var trooplevel0 = gettroopslevel.snapshotItem(i).innerHTML.replace(/\n/g,"").replace(/\s/g," ").split(" ");
			var trooplevel = trooplevel0[trooplevel0.length-1].match(/\d{1,}/)[0];
			if ( trooplevel == maxlvl)
				continue;
			var nameFound = false;
			for ( mr in aLangTroops[myRace1] ){
				//TS_debug("aLangTroops[myRace1][mr] = " + aLangTroops[myRace1][mr]);;
				if ( aLangTroops[myRace1][mr] == troopname ) {
					troopsSelect += "<option  value='" + troopname + "_"+ (Number(mr)+1) + "'>" + troopname + "</option>";
					nameFound = true;
					break;
				}
			}
			if ( nameFound == false ) {
				printErrorMSG ( "<b>ERROR:: Translation required for troop name '" + troopname + "'.</b>", 1 );
			}
		}
		troopsSelect+="</select>";
	return troopsSelect;
}

// event handler for demolistform_wrapper, ie for demolishing buildings
// Task Kind: 7 [ Deomolish Buildings ]
function setDemoCookies() {
	selecteddemo = $("selecteddemo").value;
	theID=selecteddemo.split(". ")[0];
	adesa=selecteddemo.split(". ")[1].split(" ");
	crtlevel=adesa[adesa.length-1];
	regexp11=new RegExp(" "+crtlevel);
	theBuild=selecteddemo.split(". ")[1].replace(regexp11,"");
	thisTask = "7_" + theID +"_" + crtlevel + "_" + currentID() + "_" +theBuild;
	allTask = (GM_getValue(herere() + "_waitTask")) ? GM_getValue(herere() + "_waitTask") + "|" + thisTask : thisTask;
	GM_setValue(herere() + "_waitTask", allTask);
	document.body.removeChild($("demolistform_wrapper"));
	showTaskList();
	getTaskCookies(); // calling getTaskCookies() for setting cookies for demolish, this will call startDemoOrSetTime() to set demolish cookies.

	return false;
}

function getGidFromName(name){
	try {
		var gid = name2gid [ name ];
		if ( aTravianVersion == "4.0" && gid == 12 ) // no blacksmith in travian 4.0
			gid = 13;
		return gid ? gid : 0;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getGidFromName():: Something went wrong, error: " + err.name + " :: " + err.message + " :: name: " + name + "</b>";
		playSound ( msg );
		throw err;
	}
}

function createAutoResLink() {
	//flag ( "createAutoResLink():: Started!" );
	var producee = $("production");
	autoResDiv = $("autoResdiv");
	if ( autoResDiv == null ) {
		autoResDiv = document.createElement("div");
		autoResDiv.id = "autoResdiv";
		autoResDiv.innerHTML = aLangTaskOfText[2].bold() + ":&#160;&#160;";
		producee.parentNode.insertBefore(autoResDiv, producee.nextSibling);
	}
	else {
		autoResDiv.innerHTML = aLangTaskOfText[2].bold() + ":&#160;&#160;";
	}

	var autoResStatus = GM_getValue(herere() + "_autoResource", "0");
	if (autoResStatus == "0") { // when auto resource is disabled
		autoResDiv.innerHTML += aLangTaskOfText[3].fontcolor("gray") + "&#160;&#160;";
		var autoResLnk = document.createElement("a");
		autoResLnk.id = "autoResform1";
		autoResLnk.href = "#";
		autoResLnk.innerHTML = aLangTaskOfText[4];
		autoResLnk.title = "When enabled resources tiles are upgraded automatically when resources are available.";
		autoResLnk.addEventListener("click", createAutoResFloat, false);
	}
	else { // when auto resource is enabled
		autoResDiv.innerHTML += aLangTaskOfText[5].fontcolor("green") + "&#160;&#160;";
		var autoResLnk = document.createElement("a");
		autoResLnk.id = "autoResform2";
		autoResLnk.href = "#";
		autoResLnk.innerHTML = aLangTaskOfText[6];
		autoResLnk.title = "When enabled resources tiles are upgraded automatically when resources are available.";
		autoResLnk.addEventListener("click", closeAutoRes, false);
	}
	autoResDiv.appendChild(autoResLnk);

	/********************************** crop upgrade enable / disable *****************************************/
	var cropUpgrdEnabled = $("cropUpgrdEnabled");
	if ( cropUpgrdEnabled == null ) {
		var cropUpgrdEnabled = document.createElement("div");
		cropUpgrdEnabled.id = "cropUpgrdEnabled";
		cropUpgrdEnabled.innerHTML = aLangTaskOfText[54].bold() + ":&#160;&#160;";
		producee.parentNode.insertBefore ( cropUpgrdEnabled, autoResDiv.nextSibling );
	}
	else {
		cropUpgrdEnabled.innerHTML = aLangTaskOfText[54].bold() + ":&#160;&#160;";
	}

	var userCropUpgrdSetup = GM_getValue ( herere() + "_cropUpgradeEnabled", "1" );
	cropUpgrdEnabled.innerHTML += ( userCropUpgrdSetup == "1" ) ? aLangTaskOfText[52] : aLangTaskOfText[53];
	cropUpgrdEnabled.innerHTML += "&#160;&#160;";

	var changeIt4 = document.createElement("a");
	changeIt4.id = "changeit4";
	changeIt4.href = "#";
	changeIt4.innerHTML = aLangTaskOfText[55];
	changeIt4.title = "When disabled crop tiles are upgraded only when required.";
	changeIt4.addEventListener ( "click", toggleCropUpgrade, false);
	cropUpgrdEnabled.appendChild ( changeIt4 );

	/********************************** transport limit here **************************************************/
	var transLimit = $("translimit");
	if ( transLimit == null ) {
		transLimit=document.createElement("div");
		transLimit.id="translimit";
		transLimit.innerHTML=aLangTaskOfText[13].bold() + ":&#160;&#160;";
		producee.parentNode.insertBefore(transLimit, cropUpgrdEnabled.nextSibling);
	}
	else {
		transLimit.innerHTML=aLangTaskOfText[13].bold() + ":&#160;&#160;";
	}

	var userTranSetup = GM_getValue(herere() + "_userTranSetup", "false");
	transLimit.innerHTML+=(userTranSetup=="false")?aLangTaskOfText[14]:userTranSetup;
	transLimit.innerHTML+="&#160;&#160;";

	var changeIt=document.createElement("a");
	changeIt.id="changeit";
	changeIt.href="#";
	changeIt.innerHTML=aLangTaskOfText[15];
	changeIt.title = "Set how much resources to take in when this village is receiving resources from other villages by auto-transport.";
	changeIt.addEventListener("click", createTranLimitFlt, false);
	transLimit.appendChild(changeIt);

	/*********************************** transport remain here ***************************************************/
	// GotGs 2011.01.22 -- Correcting display of autoresource links on dorf1.php
	var resRemain = $("resremain");
	if ( resRemain == null ) {
		resRemain=document.createElement("div");
		resRemain.id="resremain";
		resRemain.innerHTML=aLangTaskOfText[38].bold() + ":&#160;&#160;";
		producee.parentNode.insertBefore(resRemain, transLimit.nextSibling);
	}
	else {
		resRemain.innerHTML=aLangTaskOfText[38].bold() + ":&#160;&#160;";
	}

	var userRemainSetup = GM_getValue(herere() + "_userRemainSetup", "false");
	resRemain.innerHTML += (userRemainSetup=="false")?aLangTaskOfText[14]:userRemainSetup;
	resRemain.innerHTML += "&#160;&#160;";

	var changeIt2=document.createElement("a");
	changeIt2.id="changeit2";
	changeIt2.href="#";
	changeIt2.innerHTML=aLangTaskOfText[15];
	changeIt2.title = "Set how much resources to retain when this village is sending resources to other villages by auto-transport or custom transport.";
	changeIt2.addEventListener("click", createResRemainFlt, false);
	resRemain.appendChild(changeIt2);

	/*********************************** resource overflow check ***************************************************/
	var ovrFlowCheck = $("ovrflwchk");
	if ( ovrFlowCheck == null ) {
		ovrFlowCheck = document.createElement("div");
		ovrFlowCheck.id = "ovrflwchk";
		ovrFlowCheck.innerHTML = aLangTaskOfText[51].bold() + ":&#160;&#160;";
		producee.parentNode.insertBefore(ovrFlowCheck, resRemain.nextSibling);
	}
	else {
		ovrFlowCheck.innerHTML = aLangTaskOfText[51].bold() + ":&#160;&#160;";
	}

	var ovrFlowSetup = GM_getValue(herere() + "_overFlowCheck", "1");
	ovrFlowCheck.innerHTML += ( ovrFlowSetup == "1" ) ? aLangTaskOfText[52] : aLangTaskOfText[53];
	ovrFlowCheck.innerHTML += "&#160;&#160;";

	var changeIt3 = document.createElement("a");
	changeIt3.id = "changeit3";
	changeIt3.href = "#";
	changeIt3.innerHTML = aLangTaskOfText[55];
	changeIt3.title = "When enabled warehouse / granary is automatically upgraded when needed to prevent resource overflow.";
	changeIt3.addEventListener ( "click", toggleResourceOverFlowCheck, false );
	ovrFlowCheck.appendChild ( changeIt3 );

}

function toggleCropUpgrade() {
	if ( GM_getValue ( herere() + "_cropUpgradeEnabled", "1" ) == "1" )
		GM_setValue(herere() + "_cropUpgradeEnabled", "0");
	else
		GM_setValue(herere() + "_cropUpgradeEnabled", "1");
	var callBackUrl = myhost + "/dorf1.php?newdid=" + currentID();
	TS_getRequest ( callBackUrl, function() {} ); // attempt to refresh BuildingData
	createAutoResLink();
}

function toggleResourceOverFlowCheck() {
	//flag ( "toggleResourceOverFlowCheck():: Started!" );
	if ( GM_getValue(herere() + "_overFlowCheck", "1") == "1" )
		GM_setValue(herere() + "_overFlowCheck", "0");
	else {
		GM_setValue(herere() + "_overFlowCheck", "1");
		var callBackUrl = myhost + "/dorf2.php?newdid=" + currentID();
		TS_getRequest ( callBackUrl, function() {} ); // attempt to refresh BuildingData
	}
	createAutoResLink();
}

function createResRemainFlt() {
	var userRemainSetup = GM_getValue(herere() + "_userRemainSetup", "false");
	usersetup2=(userRemainSetup=="false")?aLangTaskOfText[14]:userRemainSetup;
	var resRemainForm = document.createElement("form");
	resRemainForm.id = "resremainform";
	var floatClose = "<a href='#' onclick='document.body.removeChild($(\"resremainform_wrapper\"));' class='floatClose'><img src='" + sCloseBtn + "' alt='X' /></a>";
	resRemainForm.innerHTML = floatClose;
	resRemainForm.innerHTML += "<br/>" + aLangTaskOfText[15].big() +aLangTaskOfText[38].big()+"<br/><br/>";
	resRemainForm.innerHTML += aLangGameText[7] + ":  <select id='crtvi'><option value='" + currentID() + "'>" + currentVillageName() + "</option></select><br/><br/>";
	resRemainForm.innerHTML += aLangTaskOfText[38]+":  <select id='crtremain'><option value='" + usersetup2 + "'>" + usersetup2 + "</option></select><br/><br/>";
	resRemainForm.innerHTML += aLangTaskOfText[15]+aLangGameText[6]+":  <select id='resrrremain'>"+resLimitOption() + "</select>";
	resRemainForm.innerHTML += "  "+"<select id='cropremain'>"+cropLimitOption() + "</select><br/><br/>";

	var tSubmitBtn = document.createElement("input");
	tSubmitBtn.value = "OK";
	tSubmitBtn.type = "button";
	tSubmitBtn.addEventListener('click', setResRmnCookies, true);
	resRemainForm.appendChild(tSubmitBtn);

	var tWrapper = document.createElement("div");
	tWrapper.id = "resremainform_wrapper";
	tWrapper.appendChild(resRemainForm);

	var formCoords = getOption("RESREMAIN_POSITION", "20px_400px");
	formCoords = formCoords.split("_");
	tWrapper.style.top = formCoords[0];
	tWrapper.style.left = formCoords[1];

	document.body.appendChild(tWrapper);
	makeDraggable($("resremainform"));

	return false;
}

function setResRmnCookies(){
	var userSet = new Array();
	userSet[0] = $("resrrremain").value;
	userSet[1] = $("cropremain").value;
	if (userSet[0] == "default" || userSet[1] == "default") {
		GM_deleteValue(herere() + "_userRemainSetup");
	}
	else {
		GM_setValue(herere() + "_userRemainSetup", userSet.join("/"));
	}
	document.body.removeChild($("resremainform_wrapper"));
	$("autoResdiv").parentNode.removeChild($("autoResdiv"));
	$("translimit").parentNode.removeChild($("translimit"));
	$("resremain").parentNode.removeChild($("resremain"));
	createAutoResLink();
	msg = getvillagefromdid(currentID()) + " (" + currentID() + "): " + aLangTaskOfText[38].bold() + " " + aLangOtherText[3];
	printMSG(msg);

	return false;
}

function createTranLimitFlt() {
	var userTranSetup = GM_getValue(herere() + "_userTranSetup", "false");
	usersetup=(userTranSetup=="false")?aLangTaskOfText[14]:userTranSetup;
	var TransLimitForm = document.createElement("form");
	TransLimitForm.id="translimitform";
	var floatClose = "<a href='#' onclick='document.body.removeChild($(\"tranlmtform_wrapper\"));' class='floatClose'><img src='" + 
		sCloseBtn + "' alt='X' /></a>";
	TransLimitForm.innerHTML = floatClose;
	TransLimitForm.innerHTML += "<br/>" + aLangTaskOfText[15].big() +aLangTaskOfText[13].big()+"<br/><br/>";
	TransLimitForm.innerHTML += aLangGameText[7] + ":  <select id='crtvillagee'><option value='" + currentID() + "'>" + 
		currentVillageName() + "</option></select><br/><br/>";
	TransLimitForm.innerHTML += aLangTaskOfText[13]+":  <select id='crtlimit'><option value='" + usersetup + "'>" + usersetup 
		+ "</option></select><br/><br/>";
	TransLimitForm.innerHTML += aLangTaskOfText[15] + aLangGameText[6] + ":  <select id='reslimitto'>"+resLimitOption() + "</select>";
	TransLimitForm.innerHTML += "  "+"<select id='croplimitto'>"+cropLimitOption() + "</select><br/><br/>";

	var tSubmitBtn = document.createElement("input");
	tSubmitBtn.value = "OK";
	tSubmitBtn.type = "button";
	tSubmitBtn.addEventListener('click', setTranLmtCookies, true);
	TransLimitForm.appendChild(tSubmitBtn);

	var tWrapper = document.createElement("div");
	tWrapper.id = "tranlmtform_wrapper";
	tWrapper.appendChild(TransLimitForm);

	var formCoords = getOption("TRANLMT_POSITION", "20px_400px");
	formCoords = formCoords.split("_");
	tWrapper.style.top = formCoords[0];
	tWrapper.style.left = formCoords[1];

	document.body.appendChild(tWrapper);
	makeDraggable($("translimitform"));

	return false;
}

function setTranLmtCookies() {
	var userSet = new Array()
	userSet[0] = $("reslimitto").value;
	userSet[1] = $("croplimitto").value;
	if (userSet[0] == "default" || userSet[1] == "default") {
		GM_deleteValue(herere() + "_userTranSetup");
	}
	else {
		GM_setValue(herere() + "_userTranSetup", userSet.join("/"));
	}
	document.body.removeChild($("tranlmtform_wrapper"));
	$("autoResdiv").parentNode.removeChild($("autoResdiv"));
	$("translimit").parentNode.removeChild($("translimit"));
	$("resremain").parentNode.removeChild($("resremain"));
	createAutoResLink();
	msg = getvillagefromdid(currentID()) + " (" + currentID() + "): " + aLangTaskOfText[13].bold() + " " + aLangOtherText[3];
	printMSG(msg);

	return false;
}

function resLimitOption() {
	var WareCap = getGMCookie("WarehouseCap",currentID());
	WareCap = parseInt ( WareCap );
	if ( WareCap <= 5000 )
		WareCap = WareCap * 4;
	else
		WareCap = parseInt ( WareCap * 2 );
	var string="<option value='"+WareCap*0.8+"'>"+aLangTaskOfText[16]+"</option><option value='default'>"+aLangTaskOfText[14]+"</option>";
	var cnm = 0;
	var tot = 50;
	var inc = parseInt ( (WareCap) / ( tot + 1 ) ) ;
	for( var i = 0; i < tot; i++ ) {
		cnm = ( inc*i ).toString();
		string += "<option value='" + cnm + "'>" + cnm + "</option>";
	}
	return string;
}


function cropLimitOption() {
	var GranCap = getGMCookie("GranaryCap",currentID());
	GranCap = parseInt ( GranCap );
	if ( GranCap <= 5000 )
		GranCap = GranCap * 4;
	else
		GranCap = parseInt ( GranCap * 2 );
	var string="<option value='"+GranCap*0.8+"'>"+aLangTaskOfText[17]+"</option><option value='default'>"+aLangTaskOfText[14]+"</option>";
	var rpy = 0;
	var tot = 50;
	var inc = parseInt ( ( GranCap ) / ( tot + 1 ) );
	for( var i = 0; i < tot ; i++ ) {
		rpy = ( inc*i ).toString();
		string += "<option value='" + rpy + "'>" + rpy + "</option>";
	}
	return string;
}

function getParamsForAttackFloat() {
	try {
		//flag ( "getParamsForAttackFloat():: Started!" );

		if ( document.getElementsByName("x")[0].value == "" ) {
			document.getElementsByName("x")[0].value = "0";
		}
		if ( document.getElementsByName("y")[0].value == "" ) {
			document.getElementsByName("y")[0].value = "0";
		}
		var targetX = document.getElementsByName("x")[0].value;
		var targetY = document.getElementsByName("y")[0].value;

		var attackMode = null; // attack mode (reinforce = 2, attack = 3, raid = 4)
		var xpathAttackMode = "";
		switch ( aTravianVersion ) {
			case "3.6": xpathAttackMode = './/table[@ id="coords"]/descendant::input[@type="radio"]'; break;
			case "4.0": xpathAttackMode = './/form[@action="a2b.php"]/div[@class="option"]//input[@type="radio"]'; break;
			default: throwLogicError ( "getParamsForAttackFloat():: Travian Version not set!!" );
		}
		var attacktypes = document.evaluate ( xpathAttackMode, document, null, XPSnap, null );
		for (var i = 0; i < attacktypes.snapshotLength; i++) {
			if (attacktypes.snapshotItem(i).checked) {
				attackMode = i + 2;
			}
		}
		if ( ( document.getElementsByName("t8")[0].value != "" ) && ( attackMode == 4 ) ) { // never send catas for raid, always convert to attack
			attackMode = 3;
		}

		var troops = new Array();
		troops[0] = document.getElementsByName("t1")[0].value;
		troops[1] = document.getElementsByName("t2")[0].value;
		troops[2] = document.getElementsByName("t3")[0].value;
		troops[3] = document.getElementsByName("t4")[0].value;
		troops[4] = document.getElementsByName("t5")[0].value;
		troops[5] = document.getElementsByName("t6")[0].value;
		troops[6] = document.getElementsByName("t7")[0].value;
		troops[7] = document.getElementsByName("t8")[0].value;
		troops[8] = document.getElementsByName("t9")[0].value;
		troops[9] = document.getElementsByName("t10")[0].value;
		troops[10] = ( document.getElementsByName("t11").length > 0 && document.getElementsByName("t11")[0].value != "" ) ? 1 : 0;

		var villaNewdid = currentID();
		var villaName = currentVillageName();

		var beginProtect = GM_getValue( myacc() + "_beginProtectTime", "" );
		var attackStartTime = null;
		if ( beginProtect == "" || beginProtect.indexOf ( getCoordfromXY ( targetX, targetY ) + "_" ) == -1 ) { //  when beginProtect does not contain current village
			attackStartTime = new Date();
		}
		else { // when beginProtect contains current village
			attackStartTime = new Date();
			var villaLoc = getCoordfromXY ( targetX, targetY );
			var regex = new RegExp (villaLoc + "_[0-9]{1,}","");
			var beginProtectTime = beginProtect.match(regex)[0].split("_")[1];
			if ( attackStartTime.getTime() < beginProtectTime )
				attackStartTime.setTime ( beginProtectTime );
		}

		createAttackFloat ( targetX, targetY, attackMode, troops, villaNewdid, villaName, attackStartTime, false );

		return false;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getParamsForAttackFloat():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

/**
 * Creates a floating GUI box for sheduling attack.
 */
function createAttackFloat ( targetX, targetY, attackMode, troops, villaNewdid, villaName, attackStartTime, editMode, taskStr ) {
	try {
		//flag ( "createAttackFloat():: Started!" );

		if ( editMode == true && ( taskStr == null || taskStr == undefined || taskStr == "" ) )
			throwLogicError ( "createAttackFloat():: Error:: In edit mode but taskStr not specified!!" );

		// Create the form
		var AttackForm = document.createElement("form");
		AttackForm.id = "attackform";
		var floatClose = "<a href='#' onclick='document.body.removeChild($(\"attackform_wrapper\"));' class='floatClose'><img src='" + sCloseBtn + "' alt='X' /></a>";
		AttackForm.innerHTML = floatClose;

		AttackForm.innerHTML += "<br/>" + aLangTaskOfText[19].big() + "<br/><br/>";
		AttackForm.innerHTML += aLangAddTaskText[2] + ":  <select id='crtvill' disabled=true><option value='" + villaNewdid + "'>"
			+ villaName + "</option></select><br/>";
		AttackForm.innerHTML += aLangAddTaskText[4] + ": &#160;&#160;X:&#160;<input type='text' style='width:40px' id='xcoord' value='"
			+ targetX + "' />&#160;Y:&#160;<input type='text' style='width:40px' id='ycoord' value='"
			+ targetY + "'/><br/>";

		// Create attack type selection field
		AttackForm.innerHTML += aLangTaskOfText[20] + ": ";
		var tag = document.createElement("select");
		tag.setAttribute("id", "attacktype");
		for (var i = 0; i < 3; i++) {
			var subTag = document.createElement("option");
			subTag.innerHTML = aLangAttackType[i];
			subTag.setAttribute("value", ( i + 2 ) );
			if ( ( i + 2 ) == attackMode ) {
				subTag.setAttribute("selected", "selected");
			}
			tag.appendChild(subTag);
		}
		AttackForm.appendChild(tag);
		var ra = GM_getValue ( myacc() + "_raceID", "false" );
		if ( ra == "false" )
			throwLogicError ( "createAttackFloat():: Error:: Race not set!!" );
		ra = parseInt(ra);
		var mytable = document.createElement("table");
		mytable.id = "mytablee";
		mytable.innerHTML += "<tr><td>" + aLangTroops[ra][0] + "</td><td><input type='text' id='tt1' style='width:40px' value='" + troops[0]
			+ "' ></td><td>&#160;&#160;" + aLangTroops[ra][1] + "</td><td><input type='text' id='tt2' style='width:40px' value='" + troops[1] + "' ></td></tr>";
		mytable.innerHTML += "<tr><td>" + aLangTroops[ra][2] + "</td><td><input type='text' id='tt3' style='width:40px' value='" + troops[2]
			+ "' ></td><td>&#160;&#160;" + aLangTroops[ra][3] + "</td><td><input type='text' id='tt4' style='width:40px' value='" + troops[3] + "' ></td></tr>";
		mytable.innerHTML += "<tr><td>" + aLangTroops[ra][4] + "</td><td><input type='text' id='tt5' style='width:40px' value='" + troops[4]
			+ "' ></td><td>&#160;&#160;" + aLangTroops[ra][5] + "</td><td><input type='text' id='tt6' style='width:40px' value='" + troops[5] + "' ></td></tr>";
		mytable.innerHTML += "<tr><td>" + aLangTroops[ra][6] + "</td><td><input type='text' id='tt7' style='width:40px' value='" + troops[6]
			+ "' ></td><td>&#160;&#160;" + aLangTroops[ra][7] + "</td><td><input type='text' id='tt8' style='width:40px' value='" + troops[7] + "' ></td></tr>";
		mytable.innerHTML += "<tr><td>" + aLangTroops[ra][8] + "</td><td><input type='text' id='tt9' style='width:40px' value='" + troops[8]
			+ "' ></td><td>&#160;&#160;" + aLangTroops[ra][9] + "</td><td><input type='text' id='tt10' style='width:40px' value='" + troops[9] + "' /></td></tr>";
		if ( troops[7] != "" && troops[7] != "0" && attackMode != 2 ) { // if catapult included and not reinforce mode
			mytable.innerHTML += "<tr><td colspan='4'><hr/></td>";
			mytable.innerHTML += "<tr><td colspan='2'>" + aLangTaskOfText[25] + ":</td><td colspan='2'>&#160;&#160;" + aLangTaskOfText[25] + ":</td></tr>";
			// GotGs 2011.01.15 -- Catapult automatic fire is not working properly!!!
			// TODO:: GotGs 2011.01.22 -- I think i rectified this, ll check this again.
			mytable.innerHTML += "<tr><td colspan='2'><select id='firetarget1'>" + getFireTarget()
				+ "</select></td><td colspan='2'>&#160;&#160;<select id='firetarget2'><option value='0'>" + aLangGameText[16] + "</option>" + getFireTarget()
				+ "</select></td></tr>";
			mytable.innerHTML += "<tr><td colspan='4'><hr/></td>";
		}
		AttackForm.appendChild(mytable);

		if ( troops[10] == true || troops[10] == "1" ) {
			AttackForm.innerHTML += aLangTroops[ra][10]
				+ ":&#160;&#160;<select id='hero'><option value='0'>No</option><option value='1' selected='selected'>Yes</option></select>";
		}
		else {
			AttackForm.innerHTML += aLangTroops[ra][10]
				+ ":&#160;&#160;<select id='hero'><option value='0'>No</option><option value='1' >Yes</option></select>";
		}

		AttackForm.innerHTML += "&#160;&#160; Scout Type:&#160;&#160;<select id='scouttype' disabled='true'>"
			+ "<option value='1'>Resources+Troops</option><option value='2' >Defenses+Troops</option></select><br/>";

		AttackForm.innerHTML += aLangTaskOfText[21]+":&#160;&#160;<input type='text' id='troopstime' style='width:120px' readOnly= 'true' value='"
			+ aLangTaskOfText[27] + "' /><br/>";

		var ye = attackStartTime.getFullYear();
		var mon = attackStartTime.getMonth() + 1;
		var dat = attackStartTime.getDate();
		var hou = attackStartTime.getHours();
		if ( hou < 10 ) { hou = "0" + hou; }
		var minu = attackStartTime.getMinutes();
		if ( minu < 10 ) { minu = "0" + minu; }
		var sec = attackStartTime.getSeconds();
		if ( sec < 10 ) { sec = "0" + sec; }
		var starttime = ye + "/" + mon + "/" + dat + " " + hou + ":" + minu + ":" + sec;

		AttackForm.innerHTML += aLangGameText[4] + ":&#160;&#160;<input type='text' id='startime' style='width:146px' value='" + starttime + "' /><br/>";

		AttackForm.innerHTML += aLangTaskOfText[22]+":&#160;<input type='text' id='repeat' style='width:60px' value='1000000' />&#160;&#160;"
			+ aLangTaskOfText[23] + ":&#160;<input type='text' id='interval' style='width:60px' value='"
			+ aLangTaskOfText[24] + "' /><br/>Attack Frequency: &#160;&#160;<input type='text' id='attackfreq' style='width:120px' readOnly='true' value=''/><br/><br/>";
  		//TS_debug('FM_createAttackFloat : ye=' + ye + " mon=" + mon + " dat=" + dat + " hou=" + hou + " minu=" + minu  );

		var tSubmitBtn = document.createElement("input");
		tSubmitBtn.name = "submitBtn";
		tSubmitBtn.value = "OK";
		tSubmitBtn.type = "button";
		if ( editMode == true )
			tSubmitBtn.addEventListener('click', function () { setAttackCookies ( editMode, taskStr ); }, true);
		else
			tSubmitBtn.addEventListener('click', function () { setAttackCookies ( false ); }, true);
		AttackForm.appendChild(tSubmitBtn);

		var aWrapper = document.createElement("div");
		aWrapper.id = "attackform_wrapper";
		aWrapper.appendChild(AttackForm);

		var formCoords = getOption("ATTACK_POSITION", "20px_400px");
		formCoords = formCoords.split("_");
		aWrapper.style.top = formCoords[0];
		aWrapper.style.left = formCoords[1];

		document.body.appendChild(aWrapper);
		makeDraggable($("attackform"));

		if ( editMode == true ) {
			var thisTask = taskStr.split("_");
			$("repeat").value = thisTask[3];
			$("interval").value = milliSecToHMS ( thisTask[5] );
		}
		else {
			if( $("troopstime").value ){
				$("interval").value = doublee ( $("troopstime").value );
			}
		}

		updateTroopsTimeInAttackForm();
		AttackForm.addEventListener("keyup", updateTroopsTimeInAttackForm, false);
		checkForScoutingInAttackForm();
		AttackForm.addEventListener("keyup", checkForScoutingInAttackForm, false);
		$("attacktype").addEventListener("click", checkForScoutingInAttackForm, false);

		$("hero").addEventListener("click", updateTroopsTimeInAttackForm, false);
		$("hero").addEventListener("click", checkForScoutingInAttackForm, false);

		return false;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>createAttackFloat():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function editTask(taskStr) {
	try {
		//flag ( "editTask():: Started!" );

		maintainFoldStatus();

		thisTask = taskStr.split("_");
		if ( thisTask.length == 0 )
			return false;

		switch ( thisTask[0] ) {
			case "2": // attack task -- Author: Drumst1x
				var targetX = getXfromCoord ( thisTask[1] );
				var targetY = getYfromCoord ( thisTask[1] );
				var attackMode = thisTask[2];
				var troops = thisTask[6].split(",");
				var villaNewdid = currentID();
				var villaName = currentVillageName();
				var attackStartTime = new Date( Number ( thisTask[4] ) );
				createAttackFloat ( targetX, targetY, attackMode, troops, villaNewdid, villaName, attackStartTime, true, taskStr );
				break;
			case "8": // transport task -- Author: blablubbb
				customTransFloat ( true, taskStr );
				break;
			default:
		}

		return false;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>editTask():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}


function checkForScoutingInAttackForm() {
	var myRace = Number ( GM_getValue(myacc() + "_raceID") );
	var scoutId = 0;
	switch ( myRace ) {
		case 0: // romans
		case 1: // teutons
			scoutId = 4;
			break;
		case 2: // gaul
			scoutId = 3;
			break;
	};
	//flag ( "checkForScoutingInAttackForm():: scoutId: " + scoutId );
	var isScoutType = 1;
	if ( $("attacktype").value == "2" ) // if reinforce then it can never be scouting
		isScoutType = 0;
	else if ( $("tt" + scoutId).value == "" || $("tt" + scoutId).value == "0" )
		isScoutType = 0;
	else if ( $("hero").value == "1" )
		isScoutType = 0;
	else {
		for (var u = 1; u < 11; u++) {
			if ( u == scoutId )
				continue;
			if ( $("tt" + u).value != "" && $("tt" + u).value != "0" ) {
				isScoutType = 0;
				break;
			}
		}
	}
	//flag ( "checkForScoutingInAttackForm():: isScoutType: " + isScoutType );
	if ( isScoutType == 1 )
		$("scouttype").disabled = false;
	else
		$("scouttype").disabled = true;

	return false;
}

function updateTroopsTimeInAttackForm() {
	$("troopstime").value = getTroopsTime();
	if ( $("interval").value == aLangTaskOfText[27] )
		$("interval").value = doublee ( $("troopstime").value );
	if ( $("troopstime").value && $("interval").value ) {
		var attackTime = $("troopstime").value;
		if( attackTime.split(":")[2] != null ) {
			hh=attackTime.split(":")[0];
			mm=attackTime.split(":")[1];
			ss=attackTime.split(":")[2];
			attackTimeMilli = Number(hh)*60*60*1000 + Number(mm)*60*1000 + Number(ss)*1000;
		}
		else {
			$("attackfreq").value = aLangTaskOfText[27];
			attackTimeMilli=0;
			return;
		}		
		var interv = $("interval").value;
		if( interv.split(":")[2] != null ) {
			hh=interv.split(":")[0];
			mm=interv.split(":")[1];
			ss=interv.split(":")[2];
			interval = Number(hh)*60*60*1000 + Number(mm)*60*1000 + Number(ss)*1000;
		}
		else {
			$("attackfreq").value = aLangTaskOfText[27];
			interval = 0;
			return;
		}
		if ( Number(interval) && Number(interval) != 0 ) {
			 freqValue = 2 * Number(attackTimeMilli) / Number(interval);
			 $("attackfreq").value = freqValue.toFixed(8);
		}
		else
			$("attackfreq").value = aLangTaskOfText[27];
	}
}

//-----------------------------------------------------------------------------------------------
// Ptitfred06 - Affichage de l'ecran de saisie de attaque 	
//-----------------------------------------------------------------------------------------------

function milliSecToHMS ( timeInMilli ) {
	var hh = Math.floor ( timeInMilli / 3600000 );
	if ( hh < 10 ) { hh = "0" + hh; }
	var mm = Math.floor ( ( timeInMilli - hh*3600000 ) / 60000 );
	if ( mm < 10 ) { mm = "0" + mm; }
	var ss = Math.ceil ( ( timeInMilli - hh*3600000 - mm*60000 ) / 1000 );
	if ( ss < 10 ) { ss = "0" + ss; }
	return hh + ":" + mm + ":" + ss;	
}

function doublee ( t ) {
	if ( t == aLangTaskOfText[27] ) {
		return aLangTaskOfText[27];
	}
	//flag('FM_doublee : t ' + t);
	hh = Number ( t.split(":")[0] );
	mm = Number ( t.split(":")[1] );
	ss = Number ( t.split(":")[2] );
	all = hh*3600000 + mm*60000 + ss*1000;
  	//TS_debug('FM_doublee temps en miliseconde: all ' + all);
 	//FM 30/03/2010 aTime=all*2+10000; Necessaire pour les temps perdu de depart et synchronisation du retour
	aTime = all*2 + 10000;
	return milliSecToHMS ( aTime );
}

function getFireTarget() {
	var thetarget="<option value='99'>"+aLangTaskOfText[26]+"</option>";
	for (i in aLangAllBuildWithId){
		if (i==4) { continue; }
		thetarget += "<option value='" + getGidFromName(aLangAllBuildWithId[i]) + "'>" + aLangAllBuildWithId[i] + "</option>";
		// GotGs 2011.15.01 -- For Cata attack the resource fields have a different numbering as in array aLangAllBuildWithId.
		/*if ( i < 4 )
			thetarget+="<option value='"+(parseInt(i)+1)+"'>"+aLangAllBuildWithId[i]+"</option>";
		else if ( i == 4 )
			continue;
		else
			thetarget+="<option value='"+i+"'>"+aLangAllBuildWithId[i]+"</option>";*/
	}
	return thetarget;
}

// ------------------------------------------------------------------------------
/// Calcul de la vitesse en fonction de la troupe selectionnÃ©.	
// ------------------------------------------------------------------------------
function getTroopsTime() {
	try {
		//flag('START gettroopstime');

		var ra = GM_getValue(myacc() + "_raceID");
		ra = parseInt(ra);
		theSlow = 30;

		if ( $("attackform_wrapper") ) {
			for (var u = 0; u < 10; u++) {
				var x = u + 1;
				if ($("tt" + x).value == "" || $("tt" + x).value == "0" ) {
					continue;
				}
				theSlow = Math.min(theSlow, parseInt(troopspeed[ra][u]));
				//flag('ra ='+ra+' u='+u);
			}
			//flag('GetTroopsTime : the slow ' + theSlow);
			if ($("hero") && $("hero").value =="1") {
				var herosp = GM_getValue(myacc() + "_heroSpeed", "false");
				if (herosp != "false") {
					theSlow = Math.min(theSlow, parseInt(herosp));
				}
				else {
					switch ( aTravianVersion ) {
						case "3.6": 
							printErrorMSG(aLangOtherText[9] + "<br/><br/>"); // if hero speed is not set ask user to visit hero mansion.
							break;
						case "4.0":
							printErrorMSG("Hero Speed is not set! Visit hero_inventory.php to set your hero-speed!!<br/><br/>");
							break;
						default:
							throwLogicError ( "getTroopsTime():: Travian Version not set!!" );
					}
				}
			}
			//flag('GetTroopsTime  Heros : the slow ' + theSlow);
		}
		else {
			throwLogicError ( "getTroopsTime():: Error:: Attack form not setup before calling getTroopsTime()!" );
			/*for (var u = 0; u < 10; u++) {
				var x = u + 1;
				if (document.getElementsByName("t" + x)[0].value == "") {
					continue;
				}
				theSlow = Math.min(theSlow, parseInt(troopspeed[ra][u]));
				//flag('ra ='+ra+' u='+u);
			}
			//flag('GetTroopsTime : the slow ' + theSlow);
			// Gestion du heros
			if (document.getElementsByName("t11").length >0 && document.getElementsByName("t11")[0].value!="") {
				var herosp = GM_getValue(myacc() + "_heroSpeed", "false");
				if (herosp != "false") {
					theSlow = Math.min(theSlow, parseInt(herosp));
				}
				else {
					switch ( aTravianVersion ) {
						case "3.6": 
							printErrorMSG(aLangOtherText[9] + "<br/><br/>"); // if hero speed is not set ask user to visit hero mansion.
							break;
						case "4.0":
							printErrorMSG("Hero Speed is not set! Visit hero_inventory.php to set your hero-speed!!<br/><br/>");
							break;
						default:
							throwLogicError ( "getTroopsTime():: Travian Version not set!!" );
					}
				}
			}
			//flag('GetTroopsTime  Heros : the slow ' + theSlow);
			*/
		}
		if ( theSlow == 30 ) {
			//flag('GetTroopsTime Slow = 30 : the slow ' + theSlow);	
			return aLangTaskOfText[27]; // return string 'Unknown'
		}
		// adjust velocity based on server type
		theSlow *= getTroopSpeedFactor();
		//flag('GetTroopsTime Slow dif 30  : the slow ' + theSlow);
		posi1 = getPosFromNewdid(currentID());
		sx1 = getXfromCoord(posi1);
		sy1 = getYfromCoord(posi1);
		if ( $("attackform_wrapper") ) {
			sx2 = $("xcoord").value;
			sy2 = $("ycoord").value;
		}
		else {
			sx2 = document.getElementsByName("x")[0].value;
			sy2 = document.getElementsByName("y")[0].value;
		}
		qDist = getDistance(sx1, sy1, sx2, sy2); // get distance betw two points
		var aTime = Math.round ( qDist * 3600000 / theSlow ); // time in milli-seconds
		hh = Math.floor ( aTime / 3600000 );
		mm = Math.floor ( ( aTime - hh * 3600000 ) / 60000 );
		ss = Math.ceil ( ( aTime - hh * 3600000 - mm * 60000 ) / 1000 );
		if ( ss == "60" ) { mm+=1; ss=0; }
		if ( mm == "60" ) { hh+=1; mm=0; }
		if ( hh < 10 ) { hh = "0" + hh; }
		if ( mm < 10 ) { mm = "0" + mm; }
		if ( ss < 10 ) { ss = "0" + ss; }
		//flag('GetTroopsTime : hh=' + hh + ' mm=' + mm + ' ss=' + ss + ' aLangTaskOfText[27] ' + aLangTaskOfText[27]);
		//flag('end get troops time');
		return hh+":"+mm+":"+ss;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getTroopsTime():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// ------------------------------------------------------------------------------
// 
// ------------------------------------------------------------------------------	
function getHeroSpeed(aElem) {
	try {
		switch ( aTravianVersion ) {
			case "3.6":
				if ( stripHTML ( h1in().innerHTML.replace(/\n/g,"") ).indexOf( aLangAllBuildWithId[37] ) != -1 ) {
					var myhero = document.evaluate ( './/table[@id="distribution"]/descendant::span[@class="info"]', aElem, null, XPFirst, null );
					if ( myhero.singleNodeValue != null ) {
						var herokind = myhero.singleNodeValue.innerHTML.split("(")[1].split(")")[0];
						var ra = GM_getValue ( myacc() + "_raceID" );
						ra = parseInt ( ra );
						for ( var i in aLangTroops[ra] ) {
							if ( aLangTroops [ ra ] [ i ] == herokind ) {
								GM_setValue ( myacc() + "_heroSpeed", troopspeed [ ra ] [ i ] );
								break;
							}
						}
					}
					else {
						GM_deleteValue ( myacc() + "_heroSpeed" );
						printErrorMSG ( "getHeroSpeed():: Error: Cannot get Hero Speed!" );
						return false;
					}
				}
				break;
			case "4.0":
				//flag ( "getHeroSpeed():: aElem.innerHTML:\n" + aElem.innerHTML );
				// get hero speed
				var xpathHeroSpeed = './/div[@id="content"]/div[@id="attributes"]//div[@class="attribute speed tooltip"]/div[@class="element power"]'
							+ '/span[@class="current"]';
				var heroSpeedElem = document.evaluate( xpathHeroSpeed, aElem, null, XPFirst, null).singleNodeValue;
			      	if ( heroSpeedElem ) {
					var heroSpeed = heroSpeedElem.innerHTML;
					//flag ( "getHeroSpeed():: heroSpeed: " + heroSpeed );
					GM_setValue ( myacc() + "_heroSpeed", heroSpeed );
				}
				else {
					GM_deleteValue ( myacc() + "_heroSpeed" );
					GM_deleteValue ( myacc() + "_heroHealth" );
					GM_deleteValue ( myacc() + "_heroVillage" );
					printErrorMSG ( "getHeroSpeed():: Error: Cannot get Hero Speed!" );
					return false;
				}
				// get hero health
				var xpathHeroHealth = './/div[@id="content"]/div[@id="attributes"]//div[@class="attribute health tooltip"]/div[@class="element current power"]'
							+ '/span[@class="value"]';
				var heroHealthElem = document.evaluate( xpathHeroHealth, aElem, null, XPFirst, null).singleNodeValue;
			      	if ( heroHealthElem ) {
					var heroHealth = heroHealthElem.innerHTML;
					//flag ( "getHeroSpeed():: heroHealth: " + heroHealth );
					GM_setValue ( myacc() + "_heroHealth", heroHealth );
				}
				else {
					GM_deleteValue ( myacc() + "_heroSpeed" );
					GM_deleteValue ( myacc() + "_heroHealth" );
					GM_deleteValue ( myacc() + "_heroVillage" );
					printErrorMSG ( "getHeroSpeed():: Error: Cannot get Hero Health!" );
					return false;
				}
				// get hero village
				var xpathHeroVillage = './/div[@id="content"]/div[@id="attributes"]//div[@class="attribute heroStatus"]'
							+ '//a[ contains(@href,"karte.php") and ( contains(@href,"d=") or contains(@href,"x=") ) ]';
				var heroVillageElem = document.evaluate( xpathHeroVillage, aElem, null, XPFirst, null).singleNodeValue;
			      	if ( heroVillageElem ) { 
					var heroVillage = "";
					if ( heroVillageElem.href.match(/\bd=/) != null ) {
						heroVillage = heroVillageElem.href.match(/\bd=\d{1,}\b/)[0].match(/\b\d{1,}\b/)[0];
					}
					else if ( heroVillageElem.href.match(/\bx=/) != null ) {
						var xx = heroVillageElem.href.match(/\bx=[-0-9]{1,}\b/)[0].match(/\b[-0-9]{1,}\b/)[0];
						var yy = heroVillageElem.href.match(/\by=[-0-9]{1,}\b/)[0].match(/\b[-0-9]{1,}\b/)[0];
						heroVillage = getCoordfromXY(xx, yy);
					}
					//flag ( "getHeroSpeed():: heroVillage: " + heroVillage );
					GM_setValue ( myacc() + "_heroVillage", heroVillage );
				}
				else {
					GM_deleteValue ( myacc() + "_heroSpeed" );
					GM_deleteValue ( myacc() + "_heroHealth" );
					GM_deleteValue ( myacc() + "_heroVillage" );
					printErrorMSG ( "getHeroSpeed():: Error: Cannot get Hero Village!" );
					return false;
				}
				break;
			default:
				throwLogicError ( "getHeroSpeed():: Travian Version not set!!" );
		}
		return true;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getHeroSpeed():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// ------------------------------------------------------------------------------
// Creates a cookie entry with sheduled attack parameters. Takes values from floating form.
// ------------------------------------------------------------------------------
// event handler for attackform_wrapper, ie for attacks / raids / reinforce.
// Task Kind: 2 [ attack normal / raid, reinforce ]
function setAttackCookies ( editMode, taskStr ) {
	try {
		//flag ( "setAttackCookies():: Started!" );

		if ( editMode == null || editMode == undefined )
			editMode = false;

		if ( editMode == true && ( taskStr == null || taskStr == undefined || taskStr == "" ) )
			throwLogicError ( "setAttackCookies():: Error:: In edit mode but taskStr not specified!!" );

		var taskkindss = "2";

		var cX = $("xcoord").value;
		var cY = $("ycoord").value;
		var targetPosition = getCoordfromXY(cX,cY);

		var attackkind = $("attacktype").value;

		var repeat = $("repeat").value;

		var startt = new Date ( $("startime").value );
		var startTime = startt.getTime();

		var attackTime = $("troopstime").value;
		var attackTimeMilli = 0;
		if ( attackTime.split(":")[2] != null ) {
			var hh = attackTime.split(":")[0];
			var mm = attackTime.split(":")[1];
			var ss = attackTime.split(":")[2];
			attackTimeMilli = Number(hh)*60*60*1000 + Number(mm)*60*1000 + Number(ss)*1000;
		}
		else {
			attackTimeMilli = 0;
		}

		var interv = $("interval").value;
		var nterval = 0;
		if ( interv.split(":")[2] != null ) {
			var hh = interv.split(":")[0];
			var mm = interv.split(":")[1];
			var ss = interv.split(":")[2];
			interval = Number(hh)*60*60*1000 + Number(mm)*60*1000 + Number(ss)*1000;
		}
		else {
			interval = 0;
		}

		var troopss = new Array();
			troopss[0]  = ( $("tt1").value  == "" ) ? "0" : $("tt1").value;
			troopss[1]  = ( $("tt2").value  == "" ) ? "0" : $("tt2").value;
			troopss[2]  = ( $("tt3").value  == "" ) ? "0" : $("tt3").value;
			troopss[3]  = ( $("tt4").value  == "" ) ? "0" : $("tt4").value;
			troopss[4]  = ( $("tt5").value  == "" ) ? "0" : $("tt5").value;
			troopss[5]  = ( $("tt6").value  == "" ) ? "0" : $("tt6").value;
			troopss[6]  = ( $("tt7").value  == "" ) ? "0" : $("tt7").value;
			troopss[7]  = ( $("tt8").value  == "" ) ? "0" : $("tt8").value;
			troopss[8]  = ( $("tt9").value  == "" ) ? "0" : $("tt9").value;
			troopss[9]  = ( $("tt10").value == "" ) ? "0" : $("tt10").value;
			troopss[10] = ( $("hero").value == "" ) ? "0" : $("hero").value;
		var troopsoo = troopss.join(",");

		var totalTroops = 0;
		for ( var ctr = 0 ; ctr < 11 ; ctr++ )
			totalTroops += troopss[ctr];

		if ( totalTroops > 0 ) {
			var kata1 = ( $("firetarget1") ) ? $("firetarget1").value : "0";
			var kata2 = ( $("firetarget2") ) ? $("firetarget2").value : "0";

			var thisTask = taskkindss + "_" + targetPosition + "_" + attackkind + "_" + repeat + "_" + startTime + "_" + interval + "_" + 
				troopsoo + "_" + kata1 + "_" + kata2 + "_" + attackTimeMilli + "_" + $("attackfreq").value;
			if ( $("scouttype").disabled == false )
				thisTask = thisTask + "_" + $("scouttype").value;
			else
				thisTask = thisTask + "_" + "0";

			if ( editMode == true )
				deleteTaskCookie(taskStr);
			var allTask = ( GM_getValue(herere() + "_waitTask") ) ? GM_getValue(herere() + "_waitTask") + "|" + thisTask : thisTask;
			GM_setValue(herere() + "_waitTask", allTask);

			document.body.removeChild($("attackform_wrapper"));
			showTaskList();
			getTaskCookies(); // no cookies are required for attacks/raids/reinforce, still calling getTaskCookies() for consistency.
			msg = getvillagefromdid(currentID()) + " (" + currentID() + "): " + aLangTaskOfText[19].bold() + " " + aLangOtherText[3];
			printMSG(msg);
		}

		return false;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>setAttackCookies():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function createAttackBtn() {
	//var bposition = document.evaluate('id("btn_ok")', document, null, XPFirst, null);
	var xpathButton = "";
	switch ( aTravianVersion ) {
		case "3.6": xpathButton = './/input[@id="btn_ok" and @type!="hidden"]'; break;
		case "4.0": xpathButton = './/button[@id="btn_ok" and @type!="hidden"]'; break;
		default: throwLogicError ( "createAttackBtn():: Travian Version not set!!" );
	}
	var bposition = document.evaluate ( xpathButton, document, null, XPFirst, null );
	AttackBtn = document.createElement("a");
	AttackBtn.id = "attackbtn";
	AttackBtn.href = "#";
	AttackBtn.innerHTML = "&#160;&#160;"+aLangTaskOfText[19]+"&#160;&#160;";
	AttackBtn.title = "Fill the troop count above to get the travel time in the popup!";
	AttackBtn.addEventListener("click", getParamsForAttackFloat, false);
	bposition.singleNodeValue.parentNode.appendChild(AttackBtn);
}

function createTrainLnk() {
	//var bposition = document.evaluate('id("btn_train")', document, null, XPFirst, null);
	var xpathTrainButton = "";
	switch ( aTravianVersion ) {
		case "3.6": xpathTrainButton = './/input[@id="btn_train" and @type!="hidden"]'; break;
		case "4.0": xpathTrainButton = './/button[@id="s1" and @type!="hidden"]'; break;
		default: throwLogicError ( "createTrainLnk():: Travian Version not set!!" );
	}
	var bposition = document.evaluate ( xpathTrainButton, document, null, XPFirst, null );
	if (bposition.singleNodeValue) {
		TrainLnk = document.createElement("a");
		TrainLnk.id = "trainlnk";
		TrainLnk.href = "#";
		TrainLnk.innerHTML = "&#160;&#160;" + aLangTaskOfText[32] + "&#160;&#160;";
		TrainLnk.addEventListener("click", createTrainFloat, false);
		bposition.singleNodeValue.parentNode.appendChild(TrainLnk);
	}
}

function createTrainFloat() {
	var trainForm = document.createElement("form");
	trainForm.id = "trainform";
	var floatClose = "<a href='#' onclick='document.body.removeChild($(\"trainform_wrapper\"));' class='floatClose'><img src='" + 
		sCloseBtn + "' alt='X' /></a>";
	trainForm.innerHTML = floatClose;
	var buidd=document.getElementsByName("id")[0].value;
	var h1inn = stripHTML(h1in().innerHTML.replace(/\n/g,"")).split(" ");
	switch (h1inn.length) {
		case 3:
			bbName = h1inn[0]; // bbName is global var
			break;
		case 4:
			bbName = h1inn[0] +" "+ h1inn[1]; // bbName is global var.
			break;
	}
	//flag ( "createTrainFloat():: bbName: " + bbName );

	if (!GM_getValue(myacc() + "_raceID")) {
		trainForm.innerHTML += "<br/>" + aLangOtherText[0].big() + "!!!<br/><br/>" + aLangOtherText[8] + "<br/><br/>";
		var privateee = document.evaluate('id("sleft")/descendant::a[contains(@href,"spieler")]', document, null, XPFirst, null);
		var privatee = document.evaluate('id("side_navi")/descendant::a[contains(@href,"spieler")]', document, null, XPFirst, null);
		privateeee=(privateee.singleNodeValue)?privateee:privatee;
		trainForm.innerHTML += aLangOtherText[2] + ":    <a href='" + privateeee.singleNodeValue.getAttribute("href") + "'>&#160;&#160;&#160;&#160;&#160;" + 
			privateeee.singleNodeValue.innerHTML + "</a><br/><br/>";
	}
	else {
		ra = GM_getValue(myacc() + "_raceID");
		ra = parseInt(ra);
		trainForm.innerHTML += "<br/>" + aLangTaskOfText[32].big() + "<br/><br/>";
		trainForm.innerHTML += aLangAddTaskText[2] + ":  <select id='crtvill' disabled=true><option value='" + currentID() + "'>" + 
			currentVillageName() + "</option></select><br/>";
		// bbName is global var.
		trainForm.innerHTML += aLangTaskOfText[33]+":<select id='trainid' disabled=true><option value='" + buidd + "'>" + 
			bbName + "</option></select><br/>";
		trainForm.innerHTML += getTraintable();

		tod = new Date();
		ye = tod.getFullYear();
		mon = tod.getMonth() + 1;

		dat = tod.getDate();
		hou = tod.getHours();
		if (hou < 10) {
			hou = "0" + hou;
		}
		minu = tod.getMinutes();
		if (minu < 10) {
			minu = "0" + minu;
		}
		sec = tod.getSeconds();
		if (sec < 10) {
			sec = "0" + sec;
		}
		nowtime = ye + "/" + mon + "/" + dat + " " + hou + ":" + minu + ":" + sec;
		//TS_debug('FM_createTrainFloat : ye=' + ye + " mon=" + mon + " dat=" + dat + " hou=" + hou + " minu=" + minu  );

		trainForm.innerHTML += aLangGameText[4] + ":&#160;&#160;<input type='text' id='startime' style='width:146px' value='" + nowtime + "' /><br/>";
		trainForm.innerHTML += aLangTaskOfText[22]+":&#160;<input type='text' id='repeat' style='width:30px' value='0' />&#160;&#160;"+
			aLangTaskOfText[23] + ":&#160;<input type='text' id='interval' style='width:60px' value='" + aLangTaskOfText[24] + "' /><br/><br/>";

		var tSubmitBtn = document.createElement("input");
		tSubmitBtn.name = "submitBtn";
		tSubmitBtn.value = "OK";
		tSubmitBtn.type = "button";
		tSubmitBtn.addEventListener('click', setTrainCookies, true);
		trainForm.appendChild(tSubmitBtn);
	}
	var tWrapper = document.createElement("div");
	tWrapper.id = "trainform_wrapper";
	tWrapper.appendChild(trainForm);

	var formCoords = getOption("TRAIN_POSITION", "20px_400px");
	formCoords = formCoords.split("_");
	tWrapper.style.top = formCoords[0];
	tWrapper.style.left = formCoords[1];

	document.body.appendChild(tWrapper);
	makeDraggable($("trainform"));

	return false;
}


function getTraintable() {
	ra = GM_getValue(myacc() + "_raceID");
	ra = parseInt(ra);
	stainstring = "<table id = 'mytablee'><tr><td>"+aLangTaskKind[4]+":</td><td>&#160;</td></tr><tr><td colspan='2'><hr/></td></tr>";
	switch (ra) {
		case 0:
			switch (bbName){ // bbName is global var.
				case aLangAllBuildWithId[19]:
				case aLangAllBuildWithId[29]:
					var t1e = document.evaluate('.//*[@name="t1" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					stainstring+="<tr><td style='width:80px'>"+aLangTroops[0][0]+"</td><td><input type='text' id='t1' style='width:40px' value='"
						+ t1e.value + "'</td></tr>";
					var t2e = document.evaluate('.//*[@name="t2" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t2e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[0][1]+"</td><td><input type='text' id='t2' style='width:40px' value='"
							+ t2e.value + "'</td></tr>";
					}
					var t3e = document.evaluate('.//*[@name="t3" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t3e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[0][2]+"</td><td><input type='text' id='t3' style='width:40px' value='"
							+ t3e.value + "'</td></tr>";
					}
					break;
				case aLangAllBuildWithId[20]:
				case aLangAllBuildWithId[30]:
					var t4e = document.evaluate('.//*[@name="t4" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t4e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[0][3]+"</td><td><input type='text' id='t4' style='width:40px' value='"
							+ t4e.value + "'</td></tr>";
					}
					var t5e = document.evaluate('.//*[@name="t5" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t5e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[0][4]+"</td><td><input type='text' id='t5' style='width:40px' value='"
							+ t5e.value + "'</td></tr>";
					}
					var t6e = document.evaluate('.//*[@name="t6" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t6e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[0][5]+"</td><td><input type='text' id='t6' style='width:40px' value='"
							+ t6e.value + "'</td></tr>";
					}
					break;
				case aLangAllBuildWithId[21]:
					var t7e = document.evaluate('.//*[@name="t7" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t7e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[0][6]+"</td><td><input type='text' id='t7' style='width:40px' value='"
							+ t7e.value + "'</td></tr>";
					}
					var t8e = document.evaluate('.//*[@name="t8" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t8e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[0][7]+"</td><td><input type='text' id='t8' style='width:40px' value='"
							+ t8e.value + "'</td></tr>";
					}
					break;
				case aLangAllBuildWithId[25]:
				case aLangAllBuildWithId[26]:
					var t9e = document.evaluate('.//*[@name="t9" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t9e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[0][8]+"</td><td><input type='text' id='t9' style='width:40px' value='"
							+ t9e.value + "'</td></tr>";
					}
					var t10e = document.evaluate('.//*[@name="t10" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t10e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[0][9]+"</td><td><input type='text' id='t10' style='width:40px' value='"
							+ t10e.value + "'</td></tr>";
					}
					break;
			}
			break;
		case 1:
			switch (bbName){ // bbName is global var.
				case aLangAllBuildWithId[19]:
				case aLangAllBuildWithId[29]:
					var t1e = document.evaluate('.//*[@name="t1" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					stainstring+="<tr><td style='width:80px'>"+aLangTroops[1][0]+"</td><td><input type='text' id='t1' style='width:40px' value='"
						+ t1e.value + "'</td></tr>";
					var t2e = document.evaluate('.//*[@name="t2" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t2e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[1][1]+"</td><td><input type='text' id='t2' style='width:40px' value='"
							+ t2e.value + "'</td></tr>";
					}
					var t3e = document.evaluate('.//*[@name="t3" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t3e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[1][2]+"</td><td><input type='text' id='t3' style='width:40px' value='"
							+ t3e.value + "'</td></tr>";
					}
					var t4e = document.evaluate('.//*[@name="t4" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t4e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[1][3]+"</td><td><input type='text' id='t4' style='width:40px' value='"
							+ t4e.value + "'</td></tr>";
					}
					break;
				case aLangAllBuildWithId[20]:
				case aLangAllBuildWithId[30]:
					var t5e = document.evaluate('.//*[@name="t5" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t5e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[1][4]+"</td><td><input type='text' id='t5' style='width:40px' value='"
							+ t5e.value + "'</td></tr>";
					}
					var t6e = document.evaluate('.//*[@name="t6" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t6e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[1][5]+"</td><td><input type='text' id='t6' style='width:40px' value='"
							+ t6e.value + "'</td></tr>";
					}
					break;
				case aLangAllBuildWithId[21]:
					var t7e = document.evaluate('.//*[@name="t7" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t7e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[1][6]+"</td><td><input type='text' id='t7' style='width:40px' value='"
							+ t7e.value + "'</td></tr>";
					}
					var t8e = document.evaluate('.//*[@name="t8" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t8e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[1][7]+"</td><td><input type='text' id='t8' style='width:40px' value='"
							+ t8e.value + "'</td></tr>";
					}
					break;
				case aLangAllBuildWithId[25]:
				case aLangAllBuildWithId[26]:
					var t9e = document.evaluate('.//*[@name="t9" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t9e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[1][8]+"</td><td><input type='text' id='t9' style='width:40px' value='"
							+ t9e.value + "'</td></tr>";
					}
					var t10e = document.evaluate('.//*[@name="t10" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t10e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[1][9]+"</td><td><input type='text' id='t10' style='width:40px' value='"
							+ t10e.value + "'</td></tr>";
					}
					break;
			}
			break;
		case 2:
			switch (bbName){ // bbName is global var.
				case aLangAllBuildWithId[19]:
				case aLangAllBuildWithId[29]:
					var t1e = document.evaluate('.//*[@name="t1" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					stainstring+="<tr><td style='width:80px'>"+aLangTroops[2][0]+"</td><td><input type='text' id='t1' style='width:40px' value='"
						+ t1e.value + "'</td></tr>";
					var t2e = document.evaluate('.//*[@name="t2" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t2e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[2][1]+"</td><td><input type='text' id='t2' style='width:40px' value='"
							+ t2e.value + "'</td></tr>";
					}
					break;
				case aLangAllBuildWithId[20]:
				case aLangAllBuildWithId[30]:
					var t3e = document.evaluate('.//*[@name="t3" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t3e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[2][2]+"</td><td><input type='text' id='t3' style='width:40px' value='"
							+ t3e.value + "'</td></tr>";
					}
					var t4e = document.evaluate('.//*[@name="t4" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t4e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[2][3]+"</td><td><input type='text' id='t4' style='width:40px' value='"
							+ t4e.value + "'</td></tr>";
					}
					var t5e = document.evaluate('.//*[@name="t5" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t5e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[2][4]+"</td><td><input type='text' id='t5' style='width:40px' value='"
							+ t5e.value + "'</td></tr>";
					}
					var t6e = document.evaluate('.//*[@name="t6" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t6e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[2][5]+"</td><td><input type='text' id='t6' style='width:40px' value='"
							+ t6e.value + "'</td></tr>";
					}
					break;
				case aLangAllBuildWithId[21]:
					var t7e = document.evaluate('.//*[@name="t7" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t7e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[2][6]+"</td><td><input type='text' id='t7' style='width:40px' value='"
							+ t7e.value + "'</td></tr>";
					}
					var t8e = document.evaluate('.//*[@name="t8" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t8e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[2][7]+"</td><td><input type='text' id='t8' style='width:40px' value='"
							+ t8e.value + "'</td></tr>";
					}
					break;
				case aLangAllBuildWithId[25]:
				case aLangAllBuildWithId[26]:
					var t9e = document.evaluate('.//*[@name="t9" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t9e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[2][8]+"</td><td><input type='text' id='t9' style='width:40px' value='"
							+ t9e.value + "'</td></tr>";
					}
					var t10e = document.evaluate('.//*[@name="t10" and @type!="hidden"]',document,null,XPFirst,null).singleNodeValue;
					if ( t10e != null ) {
						stainstring+="<tr><td style='width:80px'>"+aLangTroops[2][9]+"</td><td><input type='text' id='t10' style='width:40px' value='"
							+ t10e.value + "'</td></tr>";
					}
					break;
			}
			break
	}
	stainstring +="<tr><td colspan='2'><hr/></td></tr></table>";
	return stainstring;
}


// event handler for trainform_wrapper, ie for training troops.
// Task Kind: 4 [ Train Troops ]
function setTrainCookies() {
	var taskkindss = "4";

	//------------------------------------------------	
	var trainid=$("trainid").value;

	//------------------------------------------------	
	var trooss=new Array();
	trooss[0]=($("t1"))?$("t1").value:"0";
	trooss[1]=($("t2"))?$("t2").value:"0";
	trooss[2]=($("t3"))?$("t3").value:"0";
	trooss[3]=($("t4"))?$("t4").value:"0";
	trooss[4]=($("t5"))?$("t5").value:"0";
	trooss[5]=($("t6"))?$("t6").value:"0";
	trooss[6]=($("t7"))?$("t7").value:"0";
	trooss[7]=($("t8"))?$("t8").value:"0";
	trooss[8]=($("t9"))?$("t9").value:"0";
	trooss[9]=($("t10"))?$("t10").value:"0";
	troopses=trooss.join(",");

	var totalTroops = 0;
	for ( var ctr in trooss ) {
		totalTroops += Number(trooss[ctr]);
	}

	if ( totalTroops > 0 ) {
		//------------------------------------------------	
		var repeat=$("repeat").value;

		//------------------------------------------------	
		var startt=new Date($("startime").value);
		var startTime=startt.getTime();

		//------------------------------------------------		
		var interv=$("interval").value;
		var interval = 0;
		if(interv.split(":")[2]!=null){
			hh=interv.split(":")[0];
			mm=interv.split(":")[1];
			ss=interv.split(":")[2];
			interval=Number(hh)*60*60*1000+Number(mm)*60*1000+Number(ss)*1000;
		}
		else{
			interval=0;
		}

		//------------------------------------------------	
		var TrainBuild=bbName; // bbName is global var.
		//flag ( "setTrainCookies(): bbName: " + bbName );

		//------------------------------------------------	
		var thisTask = taskkindss + "_" + trainid + "_" +repeat+ "_" +startTime+ "_" +interval+ "_" + troopses + "_" + TrainBuild;
		var allTask = (GM_getValue(herere() + "_waitTask")) ? GM_getValue(herere() + "_waitTask") + "|" + thisTask : thisTask;
		GM_setValue(herere() + "_waitTask", allTask);

		//------------------------------------------------	
		document.body.removeChild($("trainform_wrapper"));
		showTaskList();
		getTaskCookies(); // no cookies are required for training troops, still calling getTaskCookies() for consistency.
		msg = getvillagefromdid(currentID()) + " (" + currentID() + "): " + aLangTaskOfText[32].bold() + " " + aLangOtherText[3];
		printMSG(msg);
	}

	return false;
}

function createAutoTransBtn() {
	//flag('Create Auto TransBtn');
	//var bposition = document.evaluate('id("btn_ok")', document, null, XPFirst, null);
	var xpathButton = "";
	switch ( aTravianVersion ) {
		case "3.6": xpathButton = './/input[@id="btn_ok" and @type!="hidden"]'; break;
		case "4.0": xpathButton = './/form[@action="build.php"]//button[@type!="hidden"]'; break;
		default: throwLogicError ( "createAttackBtn():: Travian Version not set!!" );
	}
	var bposition = document.evaluate ( xpathButton, document, null, XPFirst, null );
	if ( bposition.singleNodeValue ) {
		AutoTransBtn = document.createElement("a");
		AutoTransBtn.id = "autotransbtn";
		AutoTransBtn.href = "#";
		AutoTransBtn.innerHTML = "&#160;&#160;"+aLangTaskOfText[8] +"&#160;&#160;";
		AutoTransBtn.addEventListener("click", createAutoTransFloat, false);
		bposition.singleNodeValue.parentNode.appendChild(AutoTransBtn);

		customTransBtn= document.createElement("a");
		customTransBtn.id = "customtransbtn";
		customTransBtn.href = "#";
		customTransBtn.innerHTML = "&#160;&#160;"+aLangTaskOfText[35] +"&#160;&#160;";
		customTransBtn.addEventListener("click", customTransFloat, false);
		bposition.singleNodeValue.parentNode.appendChild(customTransBtn);
	}
}

// 19 Oct 2011 -- edited by: blablubbb
function customTransFloat( editMode, taskStr ) {
	try {
			//flag ( "customTransFloat():: Started!" );
			
			if ( editMode == true && ( taskStr == null || taskStr == undefined || taskStr == "" ) )
				throwLogicError ( "customTransFloat():: Error:: In edit mode but taskStr not specified!!" );
				
				// Create the form		
		var customTransForm = document.createElement("form");
		customTransForm.id = "customtransform";
		var floatClose = "<a href='#' onclick='document.body.removeChild($(\"customtransform_wrapper\"));' class='floatClose'><img src='" + sCloseBtn + "' alt='X' /></a>";
		customTransForm.innerHTML = floatClose;
	
		customTransForm.innerHTML += "<br/>" + aLangTaskOfText[35].big() + "<br/><br/>";
		customTransForm.innerHTML += aLangAddTaskText[2] + ":  <select id='crtvill' disabled=true><option value='" + currentID() + "'>" + currentVillageName() + "</option></select><br/>";
	
		var resis = []
		if ( editMode != true)
		{	var targetX = document.getElementsByName("x")[0].value;
			var targetY = document.getElementsByName("y")[0].value;
			for(var i=1;i<5;i++) { resis[i-1]=document.getElementsByName("r"+i)[0].value; }
		}
		else {
			var thisTask = taskStr.split("_");
			var targetX = getXfromCoord ( thisTask[1] );
			var targetY = getYfromCoord ( thisTask[1] );
			var resis = thisTask[2].split(",");
		}
		var targetPosition = getCoordfromXY(targetX, targetY);
		found = "0";
		var allVillagePos=GM_getValue(myacc() + "_allVillagePos").split(",");
		for (var i in allVillagePos) {
			if (allVillagePos[i].split(":")[1] == targetPosition) {
				customTransForm.innerHTML += aLangAddTaskText[4] + ":  <select id='targetPosition' disabled=true><option value='" + targetPosition + "'>" + allVillagePos[i].split(":")[0] + "</option></select><br/>";
				found = "1";
				break;
			}
		}
		if (found == "0") {
			customTransForm.innerHTML += aLangAddTaskText[4] + ": &#160;&#160;X:&#160;<input type='text' style='width:40px' id='xcoord' value='" + targetX + "' />&#160;Y:&#160;<input type='text' style='width:40px' id='ycoord' value='" + targetY + "' /><br/>";
		}
		else { // when found
			customTransForm.innerHTML += aLangAddTaskText[4] + "<input type='hidden' style='width:40px' id='xcoord' value='" + targetX + "' /><input type='hidden' style='width:40px' id='ycoord' value='" + targetY + "' /><br/>";
		}
		var mytable = document.createElement("table");
		mytable.id = "mytablee";
		mytable.innerHTML += "<tr><td style='width:60px'>" + aLangResources[0] + ":</td><td><input type='text' id='rr1' onclick='this.value=\"\"' style='width:60px' value='" + resis[0] + "' ></td></tr>";
		mytable.innerHTML += "<tr><td style='width:60px'>" + aLangResources[1] + ":</td><td><input type='text' id='rr2' onclick='this.value=\"\"' style='width:60px' value='" + resis[1] + "' ></td></tr>";
		mytable.innerHTML += "<tr><td style='width:60px'>" + aLangResources[2] + ":</td><td><input type='text' id='rr3' onclick='this.value=\"\"' style='width:60px' value='" + resis[2] + "' ></td></tr>";
		mytable.innerHTML += "<tr><td style='width:60px'>" + aLangResources[3] + ":</td><td><input type='text' id='rr4' onclick='this.value=\"\"' style='width:60px' value='" + resis[3] + "' ></td></tr>";
	
		customTransForm.appendChild(mytable);
	
		tod = new Date();
		ye = tod.getFullYear();
		mon = tod.getMonth() + 1;
	
		dat = tod.getDate();
		hou = tod.getHours();
		if (hou < 10) { hou = "0" + hou; }
		minu = tod.getMinutes();
		if (minu < 10) { minu = "0" + minu; }
		sec = tod.getSeconds();
		if (sec < 10) { sec = "0" + sec; }
		nowtime = ye + "/" + mon + "/" + dat + " " + hou + ":" + minu + ":" + sec;
		customTransForm.innerHTML += aLangGameText[4] + ":&#160;&#160;<input type='text' id='startime' style='width:146px' value='" + nowtime + "' /><br/>";
	
	
		if (targetX != "" && targetY != "" && editMode != true) {
		/* I think that is way too complicated...
			aTime = getMerchanTime(currentID(), targetPosition);
			hh = Math.floor(aTime / 3600000);
			if (hh < 10) { hh = "0" + hh; }
			mm = Math.floor((aTime - hh * 3600000) / 60000);
			if (mm < 10) {	mm = "0" + mm;	}
			ss = Math.ceil((aTime - hh * 3600000 - mm * 60000) / 1000);
			if (ss < 10) { ss = "0" + ss; }
			totime=hh + ":" + mm + ":" + ss;
			MerchanTime = doublee(totime);*/ 
			MerchanTime = milliSecToHMS ( 2 * getMerchanTime(currentID(), targetPosition) + 10000);
		} else {
			MerchanTime = aLangTaskOfText[24];
		}
		customTransForm.innerHTML += aLangTaskOfText[22] + ":&#160;<input type='text' id='repeat' style='width:30px' value='0' />&#160;&#160;" + aLangTaskOfText[23] + ":&#160;<input type='text'  id='interval' style='width:60px' value='" + MerchanTime + "' /><br/><br/>";
	
	  //flag('FM_customTransFloat : ye=' + ye + " mon=" + mon + " dat=" + dat + " hou=" + hou + " minu=" + minu  );
		var tSubmitBtn = document.createElement("input");
		tSubmitBtn.name = "submitBtn";
		tSubmitBtn.value = "OK";
		tSubmitBtn.type = "button";
		if ( editMode == true )
			tSubmitBtn.addEventListener('click', function () { setCustomTranCookies ( editMode, taskStr ); }, true);
		else
			tSubmitBtn.addEventListener('click', function () { setCustomTranCookies ( false ); }, true);
		customTransForm.appendChild(tSubmitBtn);
	
		var aWrapper = document.createElement("div");
		aWrapper.id = "customtransform_wrapper";
		aWrapper.appendChild(customTransForm);
	
		var formCoords = getOption("CUSTOMTRAN_POSITION", "20px_400px");
		formCoords = formCoords.split("_");
		aWrapper.style.top = formCoords[0];
		aWrapper.style.left = formCoords[1];
	
		document.body.appendChild(aWrapper);
		makeDraggable($("customtransform"));
	
		if(editMode == true) {
			var StartTime = new Date( Number ( thisTask[4] ) );
			var ye = StartTime.getFullYear();
			var mon = StartTime.getMonth() + 1;
			var dat = StartTime.getDate();
			var hou = StartTime.getHours();
			if ( hou < 10 ) { hou = "0" + hou; }
			var minu = StartTime.getMinutes();
			if ( minu < 10 ) { minu = "0" + minu; }
			var sec = StartTime.getSeconds();
			if ( sec < 10 ) { sec = "0" + sec; }
			$("startime").value = ye + "/" + mon + "/" + dat + " " + hou + ":" + minu + ":" + sec;
			$("repeat").value = thisTask[3];
			$("interval").value = milliSecToHMS ( thisTask[5] );
		}
	
		return false;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>createAttackFloat():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// 19 Oct 2011 -- edited by: blablubbb
// event handler for customtransform_wrapper, ie for custom market transfer.
// Task Kind: 8 [ Custom Transport ]
function setCustomTranCookies( editMode, taskStr ) {
	try {
		//flag ( "setCustomTranCookies():: Started!" );

		if ( editMode == null || editMode == undefined )
			editMode = false;

		if ( editMode == true && ( taskStr == null || taskStr == undefined || taskStr == "" ) )
			throwLogicError ( "setCustomTranCookies():: Error:: In edit mode but taskStr not specified!!" );
			
		if ( $("xcoord") != null && $("ycoord") != null && $("xcoord").value != "" && $("ycoord").value != "" ) {
			//var targetPosition = ( $("targetPosition") ) ? $("targetPosition").value : getCoordfromXY ( $("xcoord").value, $("ycoord").value );
			var targetPosition = getCoordfromXY ( $("xcoord").value, $("ycoord").value );
	
			var repeat=$("repeat").value;
	
			var startt=new Date($("startime").value);
			var startTime=startt.getTime();
	
			var interv=$("interval").value
			if ( interv.split(":")[2] != null ) {
				hh=interv.split(":")[0];
				mm=interv.split(":")[1];
				ss=interv.split(":")[2];
				interval=Number(hh)*60*60*1000+Number(mm)*60*1000+Number(ss)*1000;
			}
			else {
				interval=0;
			}
	
			//------------------------------------------------		//8_241654_500,500,500,500_0_1245413194000_interval
			var res=new Array();
				res[0]=($("rr1").value=="")?"0":$("rr1").value;
				res[1]=($("rr2").value=="")?"0":$("rr2").value;
				res[2]=($("rr3").value=="")?"0":$("rr3").value;
				res[3]=($("rr4").value=="")?"0":$("rr4").value;
			var resourcessss=res.join(",");
	
			//---------------------------------------------------------------------------------------------------------------
			var thisTask = "8_" + targetPosition + "_" + resourcessss + "_" + repeat + "_" + startTime + "_" + interval;
			if ( editMode == true )
				deleteTaskCookie(taskStr);
			var allTask = (GM_getValue(herere() + "_waitTask")) ? GM_getValue(herere() + "_waitTask") + "|" + thisTask : thisTask;
			GM_setValue(herere() + "_waitTask", allTask);
	
			//---------------------------------------------------------------------------------------------------------------
			document.body.removeChild($("customtransform_wrapper"));
			showTaskList();
			getTaskCookies(); // no cookies are required for custom market transport, still calling getTaskCookies() for consistency.
			msg = getvillagefromdid(currentID()) + " (" + currentID() + "): " + aLangTaskOfText[35].bold() + " " + aLangOtherText[3];
			printMSG(msg);
		}
	
		return false;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>setCustomTranCookies():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function createAutoTransFloat(){
	var TransForm = document.createElement("form");
	TransForm.id = "transform";
	var floatClose = "<a href='#' onclick='document.body.removeChild($(\"tranForm_wrapper\"));' class='floatClose'><img src='" + sCloseBtn + "' alt='X' /></a>";
	flag('CreatAutoTransFloat');
	//TS_debug("Called function createAutoTransFloat()");
	TransForm.innerHTML = floatClose;
	TransForm.innerHTML += "<br/>" + aLangAddTaskText[0].big() + "<br/><br/>";
	TransForm.innerHTML += aLangAddTaskText[1] + ":  <select id='taskkindss' disabled=true><option value='5'>" + aLangTaskKind[5] + "</option></select><br/><br/>";
	TransForm.innerHTML += aLangAddTaskText[2] + ":  <select id='crtvillagee' disabled=true><option value='" + currentID() + "'>" + currentVillageName() + "</option></select><br/><br/>";
	TransForm.innerHTML += aLangAddTaskText[5] + ":  <select id='tranmodel'><option value='0'>" + aLangAddTaskText[6] + "</option><option value='1'>" + aLangAddTaskText[7] + "</option></select><br/><br/>"
	TransForm.innerHTML += aLangAddTaskText[3] + ":  <select id='villageposition'>" + VillagePosOption() + "</select><br/><br/>";

	var tSubmitBtn = document.createElement("input");
	tSubmitBtn.name = "submitBtn";
	tSubmitBtn.id = "submitBtn";
	tSubmitBtn.value = "OK";
	tSubmitBtn.type = "button";
	tSubmitBtn.addEventListener('click', setTranCookies, true);
	TransForm.appendChild(tSubmitBtn);

	var tWrapper = document.createElement("div");
	tWrapper.id = "tranForm_wrapper";
	tWrapper.appendChild(TransForm);

	var formCoords = getOption("TRAN_POSITION", "20px_400px");
	formCoords = formCoords.split("_");
	tWrapper.style.top = formCoords[0];
	tWrapper.style.left = formCoords[1];

	document.body.appendChild(tWrapper);
	makeDraggable($("transform"));

	return false;
}

// event handler for tranForm_wrapper, ie for auto market transfer.
// Task Kind: 5 [ Auto Transport ]
function setTranCookies() {
	//TS_debug("Called function setTranCookies()");
	var taskkindss = "5";
	var tranmodel = $("tranmodel").value;
	var villageposition = $("villageposition").value;
	var targetVid = getNewdidFromPos(villageposition);

	if ( targetVid != null ) {
		//TS_debug("setTranCookies(): villageposition="+villageposition+"; targetVid="+targetVid+";");
		var thisTask = taskkindss + "_" + tranmodel + "_" + targetVid + "_" + villageposition;
		//TS_debug("setTranCookies(): thisTask="+thisTask);
		var allTask = (GM_getValue(herere() + "_waitTask")) ? GM_getValue(herere() + "_waitTask") + "|" + thisTask : thisTask;
		GM_setValue(herere() + "_waitTask", allTask);
		var allTarget = (GM_getValue(herere() + "_autoTransTo")) ? GM_getValue(herere() + "_autoTransTo") + "|" + targetVid : targetVid;
		GM_setValue(herere() + "_autoTransTo", allTarget);
		document.body.removeChild($("tranForm_wrapper"));
		showTaskList();
		getTaskCookies(); // calling getTaskCookies() for setting cookies for auto market transfer, this will call startTransOrSetTime() to set cookies.
		msg = getvillagefromdid(currentID()) + " (" + currentID() + "): " + aLangTaskOfText[8].bold() + " " + aLangOtherText[3];
		printMSG(msg);
	}

	return false;
}


function VillagePosOption(){
	string = "";
	var allVillagePos=GM_getValue(myacc() + "_allVillagePos").split(",");
	for (var i = 0; i < allVillagePos.length; i++) {
		if (allVillagePos[i].split(":")[0] == currentVillageName()) {
			continue;
		}
		name = allVillagePos[i].split(":")[0];
		position = allVillagePos[i].split(":")[1];
		string += "<option value='" + position + "'>" + name + "</option>";
	}
	return string;
}

// called only from INIT(), should be called only once per page load
// requires _mainvillageName, _mainVillagePosition & _singleTownNEWDID to be first set
function getallVillagePos(){
	try {
		// GotGs 2011.01.15 -- Cannot get all Village Positions if the current page is the profile page of the expansion page in palace/residence.
		//flag ( "getallVillagePos():: Started!" );
		if ( window.location.href.indexOf("spieler.php?") == -1 ) { // when not in profile page get all village positions.
			var allposition = new Array();
			var allposition2 = new Array();
			switch ( aTravianVersion ) {
				case "3.6":
					// this works with travian beyond enabled and when disabled, particularly when user has a single village.
					var xpathAllX = 'id("vlist")//td[@class="aligned_coords"]//div[@class="cox"]';
					var xpathAllY = 'id("vlist")//td[@class="aligned_coords"]//div[@class="coy"]';
					var xpathAllN = 'id("vlist")//td[contains(@class,"link")]//a[contains(@href,"newdid")]';
					var allX = document.evaluate(xpathAllX, document, null, XPOrdList, null);
					var allY = document.evaluate(xpathAllY, document, null, XPOrdList, null);
					var allN = document.evaluate(xpathAllN, document, null, XPOrdList, null);
					//flag ( "getallVillagePos():: allX.snapshotLength: " + allX.snapshotLength );
					//flag ( "getallVillagePos():: allY.snapshotLength: " + allY.snapshotLength );
					//flag ( "getallVillagePos():: allN.snapshotLength: " + allN.snapshotLength );
					if ( allN.snapshotLength > 0 && allN.snapshotLength == allX.snapshotLength && allX.snapshotLength == allY.snapshotLength ) { // when more than 1 village
						for (var i = 0; i < allN.snapshotLength; i++) {
							var xx = (allX.snapshotItem(i).innerHTML.split("(")[1]) ? 
								allX.snapshotItem(i).innerHTML.split("(")[1] : allX.snapshotItem(i).nextSibling.innerHTML;
							var yy = (allY.snapshotItem(i).innerHTML.split(")")[0]) ? 
								allY.snapshotItem(i).innerHTML.split(")")[0] : allY.snapshotItem(i).previousSibling.innerHTML;
							var na  = allN.snapshotItem(i).innerHTML + ":" + getCoordfromXY(xx, yy);
							var na2 = allN.snapshotItem(i).href.match(/newdid=\d{1,}/)[0].match(/\d{1,}/)[0] + ":" + getCoordfromXY(xx, yy);
							//flag ( "getallVillagePos():: i: " + i + ", xx: " + xx + ", yy: " + yy + ", na: " + na + ", na2: " + na2  );
							allposition.push(na);
							allposition2.push(na2);
						}
					}
					else { // when single village
						allposition[0]  = GM_getValue(myacc() + "_mainvillageName")  + ":" + GM_getValue(myacc() + "_mainVillagePosition");
						allposition2[0] = GM_getValue(myacc() + "_singleTownNEWDID") + ":" + GM_getValue(myacc() + "_mainVillagePosition");
					}
					break;
				case "4.0":
					var xpathVillages = 'id("villageList")//li/a[contains(@href,"newdid=")]';
					var allVillages = document.evaluate(xpathVillages, document, null, XPOrdList, null);
					if ( allVillages.snapshotLength > 0 ) {
						for (var i = 0; i < allVillages.snapshotLength; i++) {
							var title = allVillages.snapshotItem(i).getAttribute("title");
							//flag ( "getallVillagePos():: i: " + i + ", title: " + title );
							//var xx = title.match(/\([-0-9]{1,}\|/)[0].match(/[-0-9]{1,}/)[0];
							//var yy = title.match(/\|[-0-9]{1,}\)/)[0].match(/[-0-9]{1,}/)[0];
							var xx = title.match(/\([-0-9]{1,}\|/);
							var yy = title.match(/\|[-0-9]{1,}\)/);
							//flag ( "getallVillagePos():: Title xx: " + xx + ", yy: " + yy );
							if ( xx != null && yy != null ) {
								xx = xx[0].match(/[-0-9]{1,}/)[0];
								yy = yy[0].match(/[-0-9]{1,}/)[0];
								//flag ( "getallVillagePos():: Title Final xx: " + xx + ", yy: " + yy );
							}
							else {
								var elem = document.createElement('div');
								elem.innerHTML = title;
								//flag ( "getallVillagePos():: i: " + i + ", elem.innerHTML: " + elem.innerHTML );
								//flag ( "getallVillagePos():: i: " + i + ", elem.textContent: " + elem.textContent );
								xx = elem.textContent.match(/\([-0-9]{1,}\|/);
								yy = elem.textContent.match(/\|[-0-9]{1,}\)/);
								//flag ( "getallVillagePos():: Div xx: " + xx + ", yy: " + yy );
								if ( xx != null && yy != null ) {
									xx = xx[0].match(/[-0-9]{1,}/)[0];
									yy = yy[0].match(/[-0-9]{1,}/)[0];
									//flag ( "getallVillagePos():: Div Final xx: " + xx + ", yy: " + yy );
								}
								else { // this is weird for travian.ir
									xx = document.evaluate ( './/span/span[ @class="coordinatex" or @class="coordinateX" ]', elem, null, XPFirst, null).singleNodeValue;
									yy = document.evaluate ( './/span/span[ @class="coordinatey" or @class="coordinateY" ]', elem, null, XPFirst, null).singleNodeValue;
									//xx = elem.textContent.match(/\|\([-0-9]{1,}/);
									//yy = elem.textContent.match(/[-0-9]{1,}\)\|/);
									if ( xx != null && yy != null ) {
										xx = xx.innerHTML.match(/[-0-9]{1,}/)[0];
										yy = yy.innerHTML.match(/[-0-9]{1,}/)[0];
										//xx = xx[0].match(/[-0-9]{1,}/)[0];
										//yy = yy[0].match(/[-0-9]{1,}/)[0];
										//flag ( "getallVillagePos():: Div Inner xx: " + xx + ", yy: " + yy );
									}
									else
										throwLogicError ( "getallVillagePos():: Cannot get village coordinates!" );
								}
							}
							//flag ( "getallVillagePos():: Final xx: " + xx + ", yy: " + yy );
							var na  = allVillages.snapshotItem(i).innerHTML + ":" + getCoordfromXY(xx, yy);
							var did = allVillages.snapshotItem(i).href.match(/\bnewdid=\d{1,}\b/)[0].match(/\d{1,}/)[0];
							var na2 = did + ":" + getCoordfromXY(xx, yy);
							//flag ( "getallVillagePos():: i: " + i + ", title: " + title + ", xx: " + xx + ", yy: " + yy + ", na: " + na + ", na2: " + na2 );
							//flag ( "getallVillagePos():: i: " + i + ", xx: " + xx + ", yy: " + yy + ", na: " + na + ", na2: " + na2 );
							allposition.push(na);
							allposition2.push(na2);
						}
					}
					else {
						throwLogicError ( "getallVillagePos():: Cannot get village list!" );
					}
					break;
				default:
					throwLogicError ( "getallVillagePos():: Travian Version not set!!" );
			}
			GM_setValue(myacc() + "_allVillagePos", allposition.join(","));
			GM_setValue(myacc() + "_allVillagePos2", allposition2.join(","));
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getallVillagePos():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// given a position, returns the village newdid.
function getNewdidFromPos(position) {
	//flag ( "getNewdidFromPos():: Started! Called for position: " + position );
	//a=GM_getValue(myacc())
	var allVillagePos = GM_getValue(myacc() + "_allVillagePos2").split(",");
	//flag ( "getNewdidFromPos: allVillagePos="+allVillagePos+";");
	for (var i = 0; i < allVillagePos.length; i++) {
		var tt = allVillagePos[i].split(":");
		if ( tt[1] == position) {
			return tt[0];
			break;
		}
	}
	return null;
}

// given a newdid, returns the village position.
function getPosFromNewdid(newdid) {
	//flag ( "getPosFromNewdid():: Started! Called for position: " + position );
	//a=GM_getValue(myacc())
	var allVillagePos=GM_getValue(myacc() + "_allVillagePos2").split(",");
	//flag ( "getPosFromNewdid: allVillagePos="+allVillagePos+";");
	for (var i = 0; i < allVillagePos.length; i++) {
		var tt = allVillagePos[i].split(":");
		if ( tt[0] == newdid) {
			return tt[1];
			break;
		}
	}
	return null;
}

function getCoordfromXY(x, y){
	x = parseInt(x);
	y = parseInt(y);
	var coordZ = (x + 401) + ((400 - y) * 801);
	return coordZ;
}

function getXfromCoord(z){
	z = parseInt(z);
	var x = ((z - 1) % 801) - 400;
	return x;
}

function getYfromCoord(z){
	z = parseInt(z);
	var y = 400 - (parseInt(((z - 1) / 801)));
	return y;
}

// event handler for auto resource upgrade
// Task Kind: 0 [ resource / building upgrades ] [ auto resource ]
function createAutoResFloat() {
	//flag ( "createAutoResFloat():: Starting!");
	var nowtaskstring = GM_getValue(herere() + "_waitTask", "false");
	var autoTask = "0_50_100"; // auto resource task string
	if ( GM_getValue ( myacc() + "_mainvillageId", "false" ) == "false" ) { // when mainvillageId is not set in cookie ask user to visit profile page.
		msg0 = aLangOtherText[0].big() + "!!!<br/><br/>" + aLangOtherText[1] + "<br/><br/>";
		var privateee = document.evaluate('id("sleft")/descendant::a[contains(@href,"spieler")]', document, null, XPFirst, null);
		var privatee = document.evaluate('id("side_navi")/descendant::a[contains(@href,"spieler")]', document, null, XPFirst, null);
		privateeee=(privateee.singleNodeValue)?privateee:privatee;
		msg0 += getvillagefromdid(currentID()) + " (" + currentID() + "): " +
			aLangOtherText[2] + ":    <a href='" + privateeee.singleNodeValue.getAttribute("href") + "'>&#160;&#160;&#160;&#160;&#160;" + 
			privateeee.singleNodeValue.innerHTML + "</a><br/><br/>";
		printMSG(msg0);
	}
	else { // when mainvillageId is set in cookie...
		var myRace = GM_getValue(myacc() + "_raceID");
		if ( myRace == "0" ) { // romans
			GM_setValue(herere() + "_ResourceTaskExists", "1");
		}
		else { // non-romans
			GM_setValue(herere() + "_UpdataTaskExists", "1");
		}
		var msg1 = getvillagefromdid(currentID()) + " (" + currentID() + "): " + aLangGameText[7].bold() + ":&#160;&#160;" + currentVillageName() + "<br/><br/>" + 
			aLangTaskOfText[2].bold() + ":&#160;&#160;" + aLangOtherText[3] + "<br/><br/>" ;
		if (nowtaskstring != "false" && nowtaskstring.indexOf(autoTask) != -1) { // if auto task string not in nowtaskstring
			GM_setValue(herere() + "_autoResource", "1");
			showTaskList();
			$("autoResdiv").parentNode.removeChild($("autoResdiv"));
			$("translimit").parentNode.removeChild($("translimit"));
			$("resremain").parentNode.removeChild($("resremain"));
			createAutoResLink();
			// GotGs 2011.01.22 -- When ever any task is scheduled, one must call getTaskCookies();
			getTaskCookies(); // calling getTaskCookies() to set cookies for auto resource, this will eventually call startBuildOrSetTime().
			printMSG(msg1);
		}
		else { // if auto task string already in nowtaskstring, ie when auto resource already enabled
			autoResT = autoTask + "_" + "00000000";
			allTask = (GM_getValue(herere() + "_waitTask")) ? GM_getValue(herere() + "_waitTask") + "|" + autoResT : autoResT;
			GM_setValue(herere() + "_waitTask", allTask);
			GM_setValue(herere() + "_autoResource", "1");
			showTaskList();
			$("autoResdiv").parentNode.removeChild($("autoResdiv"));
			$("translimit").parentNode.removeChild($("translimit"));
			$("resremain").parentNode.removeChild($("resremain"));
			createAutoResLink();
			getTaskCookies(); // calling getTaskCookies() to set cookies for auto resource, this will eventually call startBuildOrSetTime().
			printMSG(msg1);
		}
	}

	return false;
}

function closeAutoRes(){
	var msg = getvillagefromdid(currentID()) + " (" + currentID() + "): " + 
		aLangGameText[7].bold() + ":&#160;&#160;" + currentVillageName() + "<br/><br/>" + aLangTaskOfText[2].bold() + ":&#160;&#160;" + aLangOtherText[4] + "<br/>";
	villaa = currentID();
	deleteAutoResTask(villaa)
	// GotGs 2011.01.22 -- recreate autoresource links on dorf1.php.
	if ($("autoResdiv") != null) {
		createAutoResLink();
	}
	printMSG(msg);

	return false;
}

function deleteAutoResTask(villaa){
	//flag ( "deleteAutoResTask():: Started!" );
	Task = new Array();
	Task[0] = "0";
	Task[1] = "50";
	Task[2] = "100";
	Task[3] = "00000000";
	GM_deleteValue ( myacc() + "_" + villaa + "_autoResource" );
	deleteTaskFromCookie(villaa, Task);

	var myRace = GM_getValue ( myacc() + "_raceID", "0" );
	if ( myRace == "0" ) { // romans
		GM_deleteValue ( myacc() + "_" + villaa + "_ResourceUpdataTime" );
		GM_deleteValue ( myacc() + "_" + villaa + "_resRequiredForResUpgrade" );
	}
	else { // non-romans
		GM_deleteValue ( myacc() + "_" + villaa + "_UpdataTime" );
		GM_deleteValue ( myacc() + "_" + villaa + "_resRequired" );
	}	
}

function getGMValueEval ( id ) {
	var obj = GM_getValue ( id, "" );
	if ( obj == "" )
		return undefined;
	else {
		try {
			obj = JSON.parse(obj);
		} 
		catch ( e ) {
			obj = eval( "(" + obj + ")" );
		}
	}
	return obj;
}

function setGMValueUnEval ( id, obj ) {
	try {
		GM_setValue ( id, JSON.stringify(obj) );
	}
	catch (e) {
		GM_setValue ( id, uneval(obj) );
	}
}

function printMSG(msg) {
	try {
		//flag ( "printMSG():: Started!" );
		if ( getuid() != null ) {
			// when not login window
			if ( self.window.name != GM_getValue(currentServer()+'_loginWindow', "noLoginWindow") ) {
				if ( msg == null || msg == undefined || msg == "" ) {
					if ( GM_getValue(myacc() + "_display_print_Msg", "0") == "0" )
						return;
				}
				else { // some new message encountered in non-login window.
					GM_setValue ( myacc() + "_new_print_Msg", "1" ); // flag new message to display in login-window
				}
			}

			// when login window
			if ( self.window.name == GM_getValue(currentServer()+'_loginWindow', "noLoginWindow") ) {
				if ( ( msg == null || msg == undefined || msg == "" ) && ( GM_getValue ( myacc() + "_new_print_Msg", "0" ) == "0" ) ) { // nothing to do
					if ( $("MSG_wrapper") != null ) { // message window already exists
						return;
					}
				}
			}

			// get error message history from gmcookie
			var msgArry = getGMValueEval ( myacc() + "_print_Msg" );
			if ( !msgArry )
				msgArry = [];
		
			if ( msg != null && msg != undefined && msg != "" ) {
				var nowt = new Date(new Date().getTime() - serverTimeDiff).toLocaleTimeString();
				var msgt = "<span class='printMsg'>";
				msgt += nowt + " --> " + msg + "<br/>";
				msgt += "</span>";
	
				// Add the new message at top
				msgArry.unshift ( msgt );
			}
	
			// Enforce message history size
			var msgListMaxSize = parseInt ( GM_getValue ( currentServer() + "_print_Msg_List_Max_Size", "1000" ) );
			//flag ( "printErrorMSG():: 1 msgListMaxSize = " + msgListMaxSize );
			//flag ( "printErrorMSG():: 2 msgArry.length = " + msgArry.length );
			if ( msgListMaxSize >= 0 && msgArry.length > msgListMaxSize )
				msgArry.length = msgListMaxSize;
			//flag ( "printErrorMSG():: 3 msgArry.length = " + msgArry.length );
	
			// store back the message history in gmcookie
			setGMValueUnEval ( myacc() + "_print_Msg", msgArry );
		
			msg = "";
			for ( var iCtr = 0 ; iCtr < msgArry.length ; iCtr++ )
				msg += msgArry[iCtr];
		
			if ( msgArry.length != 0 ) {
				if ( GM_getValue(myacc() + "_display_print_Msg", "0") == "1" || self.window.name == GM_getValue(currentServer() + '_loginWindow', "noLoginWindow") ) {
					var printmsg = document.createElement("form");
					printmsg.id = "printmsg";
					var toggleFloat = "<a id='toggle_msg_bubble' href='#' class='floatToggle' title=" + 
						"'Toggle log display on/off for non-login windows. Once closed, to toggle back *On* go to login window.'>" +
						"<img src='" + sToggleBtn + "' alt='T' /></a>";
					printmsg.innerHTML = toggleFloat;
					var floatClose = "<a id='clearPrintMsg' href='#' class='floatClose' title='Close the Log window.'><img src='"
						+ sCloseBtn + "' alt='X' /></a>";
					printmsg.innerHTML += floatClose;
					printmsg.innerHTML += "<b>&nbsp; List Max Size: " + GM_getValue ( currentServer() + "_print_Msg_List_Max_Size", "1000" ) + ", to change ";
					printmsg.innerHTML += "<a id='changeMsgListSize' href='#'>click here</a>.</b>";
					printmsg.innerHTML += "<br/><br/>";
					printmsg.innerHTML += "<span class='printMsgBlock'>" + msg + "</span>";
					printmsg.innerHTML += "<br/><br/>";
	
					if ( $("MSG_wrapper") != null ) 
						document.body.removeChild($("MSG_wrapper"));
	
					var mWrapper = document.createElement("div");
					mWrapper.id = "MSG_wrapper";
					mWrapper.appendChild(printmsg);
	
					var formCoords = getOption("MSG_POSITION", "300px_800px");
					formCoords = formCoords.split("_");
					mWrapper.style.top = formCoords[0];
					mWrapper.style.left = formCoords[1];
					mWrapper.title = "To delete all logs, close the msg box from the Login Window!";
	
					document.body.appendChild(mWrapper);
					$("clearPrintMsg").addEventListener('click', clearPrintMSG, true);
					$("toggle_msg_bubble").addEventListener('click', toggleDisplayPrintMSG, true);
					$("changeMsgListSize").addEventListener('click', function() { promptMsgListMaxSize(); GM_setValue ( myacc() + "_new_print_Msg", "1" ); printMSG(); }, true);
					makeDraggable($("printmsg"));

					GM_setValue ( myacc() + "_new_print_Msg", "0" ); // all messages displayed, clear new message flag
			       }
			}
		}
	}
	catch ( err ) {
		printStackTrace();
		//var msg = "<b>printMSG():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		//playSound ( msg );
		throw err;
	}
}

function toggleDisplayPrintMSG() {
	var currSetup = GM_getValue(myacc() + "_display_print_Msg", "0");
	GM_setValue(myacc() + "_display_print_Msg", ( currSetup == "1" ) ? "0" : "1" );

	return false;
}

function clearPrintMSG() {
	if ( $("MSG_wrapper") != null ) 
		document.body.removeChild($("MSG_wrapper"));
	if ( self.window.name == GM_getValue(currentServer() + '_loginWindow', "noLoginWindow") )
		GM_deleteValue(myacc() + "_print_Msg");

	return false;
}

// Definition of modes ->
// 0 : Default Mode
// 1 : Translation Error Mode
function printErrorMSG ( msg, mode ) {
	try {
		//flag ( "printErrorMSG():: Started!" );
		if ( getuid() != null ) {
			if ( mode == null || mode == undefined || mode == "" )
				mode = 0;

			// when not login window
			if ( self.window.name != GM_getValue(currentServer()+'_loginWindow', "noLoginWindow") ) {
				if ( msg == null || msg == undefined || msg == "" ) {
					if ( GM_getValue(myacc() + "_display_print_Error_Msg", "0") == "0" )
						return;
				}
				else { // some error encountered in non-login window.
					GM_setValue ( myacc() + "_new_print_Error_Msg", "1" ); // flag new error message to display in login-window
				}
			}

			// when login window
			if ( self.window.name == GM_getValue(currentServer()+'_loginWindow', "noLoginWindow") ) {
				if ( ( msg == null || msg == undefined || msg == "" ) && ( GM_getValue ( myacc() + "_new_print_Error_Msg", "0" ) == "0" ) ) { // nothing to do
					if ( $("Error_MSG_wrapper") != null ) { // error message window already exists
						return;
					}
				}
			}

			// get error message history from gmcookie
			var errArry = getGMValueEval ( myacc() + "_print_Error_Msg" );
			if ( !errArry )
				errArry = [];
	
			if ( msg != null && msg != undefined && msg != "" ) {
				var nowt = new Date(new Date().getTime() - serverTimeDiff).toLocaleTimeString();
				var msgt = "<span class='errorMsg'>";
				switch ( mode ) {
					case 0: // default mode
					default:
						msgt += nowt + " --> " + msg + "<br/>";
						break;
					case 1: // add link for manual translations along with the error msg
						msgt += nowt + " --> " + msg + "<br/>";
						msgt += "<b>For manual translations open *Do manual language translations* from greasemonkey menu ";
						var random_unique_id = Math.round ( Math.random() * 1000000000 );
						msgt += "or <a id='doManualLanguageTranslations_" + random_unique_id + "' href='#'> click here</a>!</b><br/>";
						break;
				}
				msgt += "</span>";
	
				// Add the new error message at top
				errArry.unshift ( msgt );
			}
			else {
				mode = 0;
			}
	
			// Enforce error message history size
			var errListMaxSize = parseInt ( GM_getValue ( currentServer() + "_print_Error_Msg_List_Max_Size", "1000" ) );
			//flag ( "printErrorMSG():: 1 errListMaxSize = " + errListMaxSize );
			//flag ( "printErrorMSG():: 2 errArry.length = " + errArry.length );
			if ( errListMaxSize >= 0 && errArry.length > errListMaxSize )
				errArry.length = errListMaxSize;
			//flag ( "printErrorMSG():: 3 errArry.length = " + errArry.length );

			// store back the error history in gmcookie
			setGMValueUnEval ( myacc() + "_print_Error_Msg", errArry );
	
			msg = "";
			for ( var iCtr = 0 ; iCtr < errArry.length ; iCtr++ )
				msg += errArry[iCtr];

			if ( errArry.length != 0 ) {
				if ( GM_getValue(myacc() + "_display_print_Error_Msg", "0") == "1" || self.window.name == GM_getValue(currentServer()+'_loginWindow', "noLoginWindow") ) {
					var printmsg = document.createElement("form");
					printmsg.id = "printerrormsg";
					var toggleFloat = "<a id='toggle_error_msg_bubble' href='#' class='floatToggle' title=" + 
						"'Toggle log display on/off for non-login windows. Once closed, to toggle back *On* go to login window.'>" +
						"<img src='" + sToggleBtn + "' alt='T' /></a>";
					printmsg.innerHTML = toggleFloat;
					var floatClose = "<a id='clearErrorMsg' href='#' class='floatClose' title='Close the Log window.'><img src='"
						+ sCloseBtn + "' alt='X' /></a>";
					printmsg.innerHTML += floatClose;
					printmsg.innerHTML += "<b>&nbsp; List Max Size: " + GM_getValue ( currentServer() + "_print_Error_Msg_List_Max_Size", "1000" ) + ", to change ";
					printmsg.innerHTML += "<a id='changeErrorMsgListSize' href='#'>click here</a>.</b>";
					printmsg.innerHTML += "<br/><br/>";
					printmsg.innerHTML += "<span class='errorMsgBlock'>" + msg + "</span>";
					printmsg.innerHTML += "<br/><br/>";
	
					if ( $("Error_MSG_wrapper") != null ) 
						document.body.removeChild($("Error_MSG_wrapper"));
	
					var mWrapper = document.createElement("div");
					mWrapper.id = "Error_MSG_wrapper";
					mWrapper.appendChild(printmsg);
	
					var formCoords = getOption("ERROR_MSG_POSITION", "300px_50px");
					formCoords = formCoords.split("_");
					mWrapper.style.top = formCoords[0];
					mWrapper.style.left = formCoords[1];
					mWrapper.title = "To delete all logs, close the msg box from the Login Window!";
	
					document.body.appendChild(mWrapper);
					$("clearErrorMsg").addEventListener('click', clearErrorMSG, true);
					$("toggle_error_msg_bubble").addEventListener('click', toggleDisplayErrorPrintMSG, true);
					$("changeErrorMsgListSize").addEventListener('click', function() { promptErrorMsgListMaxSize(); GM_setValue ( myacc() + "_new_print_Error_Msg", "1" ); printErrorMSG(); }, true);
					makeDraggable($("printerrormsg"));
	
					// Add event listerners to all anchors added by Translation Error Mode
					var doManualLangTransAnchorList = document.evaluate('id("printerrormsg")/descendant::a[contains(@id,"doManualLanguageTranslations_")]', document, null, XPOrdList, null);
					for ( var iCtr = 0 ; iCtr < doManualLangTransAnchorList.snapshotLength ; iCtr++ ) {
						$(doManualLangTransAnchorList.snapshotItem(iCtr).id).addEventListener('click', getLangTranslationsFromUser, true);
					}

					GM_setValue ( myacc() + "_new_print_Error_Msg", "0" ); // all messages displayed, clear new message flag
				}
			}
		}
	}
	catch ( err ) {
		printStackTrace();
		//var msg = "<b>printErrorMSG():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		//playSound ( msg );
		throw err;
	}
}

function toggleDisplayErrorPrintMSG() {
	var currSetup = GM_getValue(myacc() + "_display_print_Error_Msg", "0");
	GM_setValue(myacc() + "_display_print_Error_Msg", ( currSetup == "1" ) ? "0" : "1" );

	return false;
}

function clearErrorMSG() {
	if ( $("Error_MSG_wrapper") != null ) 
		document.body.removeChild($("Error_MSG_wrapper"));
	if ( self.window.name == GM_getValue(currentServer() +'_loginWindow', "noLoginWindow") )
		GM_deleteValue(myacc() + "_print_Error_Msg");

	return false;
}

// ------------------------------------------------------------------------------	
// Creation de la TASK dans la liste des taches.
// ------------------------------------------------------------------------------	
function createUpdateFloat(eventt) { //this eventt is the "click" on the TaskUrl. it is a event object.
	//flag('FM creation task in tasklist'+eventt);
	myUrl = eventt.target; //by this method, define the event object and get the <a> that call this function. 
	bmaxlevel = 20;
	crtvillagee = myUrl.getAttribute("crtvillage");  //then the Attributes of the <a> are usable.
	buildNamee = myUrl.getAttribute("buildName");
	bnextlevel = parseInt(myUrl.getAttribute("buildnextlevel"));
	bmaxlevel = parseInt(myUrl.getAttribute("buildmaxlevel"));
	//flag('Avant Initialisation buildmaxlevel for Cachette =');
	//if (crtvillagee='2. Cachette') {
	//	bmaxlevel = 20;
	//	flag('Initialisation buildmaxlevel for Cachette');
	//}
	buildgid=(myUrl.getAttribute("buildgid"))?myUrl.getAttribute("buildgid"):"";
	bidid = myUrl.getAttribute("buildidid");
	//TS_debug('Value : Crtvillagee=' + crtvillagee+' / BuildNamee=' + buildNamee+' / bnextlevel=' + bnextlevel+' / bmaxlevel=' + bmaxlevel+' / Bidid=' + bidid + ' / Buildgid=' + buildgid);

	var taskKindUp=(buildgid=="")?"0":"1";
	var updataform = document.createElement("form");
	updataform.id = "updataform";
	var floatClose = "<a href='#' onclick='document.body.removeChild($(\"taskForm_wrapper\"));' class='floatClose'><img src='" + sCloseBtn + "' alt='X' /></a>";
	updataform.innerHTML = floatClose;
	if ((bidid < 19) && !GM_getValue(myacc() + "_mainvillageId")) {
		updataform.innerHTML += "<br/>" + aLangOtherText[0].big() + "!!!<br/><br/>" + aLangOtherText[1] + "<br/><br/>";
		var privateee = document.evaluate('id("sleft")/descendant::a[contains(@href,"spieler")]', document, null, XPFirst, null);
		var privatee = document.evaluate('id("side_navi")/descendant::a[contains(@href,"spieler")]', document, null, XPFirst, null);
		privateeee=(privateee.singleNodeValue)?privateee:privatee;
		updataform.innerHTML += aLangOtherText[2] + ":    <a href='" + privateeee.singleNodeValue.getAttribute("href") + "'>&#160;&#160;&#160;&#160;&#160;" + privateeee.singleNodeValue.innerHTML + "</a><br/><br/>";
	}
	else {
		updataform.innerHTML += "<br/>" + aLangAddTaskText[0].big() + "<br/><br/>";
		updataform.innerHTML += aLangAddTaskText[1] + ":  <select id='taskkindss' disabled=true><option value='" + taskKindUp + "'>" + aLangTaskKind[taskKindUp] + "</option></select><br/><br/>";
		updataform.innerHTML += aLangAddTaskText[2] + ":  <select id='crtvillagee' disabled=true><option value='" + crtvillagee + "'>" + getvillagefromdid(crtvillagee) + "</option></select><br/><br/>";
		updataform.innerHTML += aLangAddTaskText[3] + ':  <select id="buildNamee" disabled=true><option value=\"' + buildNamee + "\">" + buildNamee + "</option></select><br/><br/>";
		updataform.innerHTML += aLangGameText[2] + ":  <select id='bidid' disabled=true><option value='" + bidid + "'>" + bidid + "</option></select>&#160;&#160;&#160;";
		updataform.innerHTML += aLangAddTaskText[4] + ":  " + levelselectText(bnextlevel, bmaxlevel) + "<br/><br/>";
		tod = new Date();
		ye = tod.getFullYear();
		mon = tod.getMonth() + 1;
		dat = tod.getDate();
		hou = tod.getHours();
		minu = tod.getMinutes();
		sec = tod.getSeconds();
		if(hou<10){hou="0"+hou}
		if(minu<10){minu="0"+minu}
		if(sec<10){sec="0"+sec}
		nowtime = ye + "/" + mon + "/" + dat + " " + hou + ":" + minu + ":" + sec;
		updataform.innerHTML += aLangGameText[4] + ":  <input type='text' id='userSetTime' readOnly= 'true' style='width:130px' value='" + nowtime + "' /><br/>";
		updataform.innerHTML += "(" + aLangGameText[5] + ")<br/><br/>";


		var oSubmitBtn = document.createElement("input");
		oSubmitBtn.name = "submitBtn";
		oSubmitBtn.id = "submitBtn";
		oSubmitBtn.value = "OK";
		oSubmitBtn.type = "button";
		oSubmitBtn.addEventListener('click', setTaskCookies, true);
		//oSubmitBtn.addEventListener('click', addToTasklist, true);
		updataform.appendChild(oSubmitBtn);
	}
	var oWrapper = document.createElement("div");
	oWrapper.id = "taskForm_wrapper";
	oWrapper.appendChild(updataform);

	var formCoords = getOption("FORM_POSITION", "20px_400px");
	formCoords = formCoords.split("_");
	oWrapper.style.top = formCoords[0];
	oWrapper.style.left = formCoords[1];

	document.body.appendChild(oWrapper);
	makeDraggable($("updataform"));

	return false;
}

// given a newdid, returns the village name.
var var_did_villageName_list = new Array();
function getvillagefromdid(did) {
	try {
		//flag ( "getvillagefromdid():: Started! Called for newdid: " + did );
		//flag ( "getvillagefromdid():: var_did_villageName_list.length: " + var_did_villageName_list.length);
		//printStackTrace();
		if ( var_did_villageName_list.length == 0 ) {
			var foundVillageName = false;
			var returnval = null;
			//var getitit = document.evaluate('id("vlist")//a[contains(@href,"newdid=' + did + '&")]', document, null, XPFirst, null);
			var xpath = "";
			switch ( aTravianVersion ) {
				case "3.6":
					xpath = 'id("vlist")//td[@class="link"]//a[@href]';
					break;
				case "4.0":
					xpath = 'id("villageList")//a[contains(@href,"newdid=")]';
					break;
				default:
					throwLogicError ( "getvillagefromdid():: Travian Version not set!!" );
			}
			var getitit = document.evaluate( xpath, document, null, XPSnap, null );
			//flag ( "getvillagefromdid():: getitit.snapshotLength: " + getitit.snapshotLength );
			if (getitit.snapshotLength > 0) {
				for (var i = 0; i < getitit.snapshotLength; i++) {
					//flag ( "getvillagefromdid():: getitit.snapshotItem("+i+").innerHTML: " + getitit.snapshotItem(i).innerHTML );
					//flag ( "getvillagefromdid():: getitit.snapshotItem("+i+").href: " + getitit.snapshotItem(i).href );
					var longstring = getitit.snapshotItem(i).href.match(/newdid=\d{1,}/)[0];
					//flag ( "getvillagefromdid(): longstring: " + longstring )
					var_did_villageName_list[i] = [ longstring.split("=")[1], getitit.snapshotItem(i).innerHTML ];
					if (longstring=="newdid="+did) {
						returnval = getitit.snapshotItem(i).innerHTML;
						foundVillageName=true;
						//break;
					}

				}

			}
			if ( foundVillageName == false ) {
				var_did_villageName_list[0] = [ GM_getValue(myacc() + '_singleTownNEWDID'), GM_getValue(myacc() + "_mainvillageName") ];
				if ( did == GM_getValue(myacc() + '_singleTownNEWDID') )
					returnval = GM_getValue(myacc() + "_mainvillageName");
			}
			return returnval;
		}
		else {
			for ( var i = 0 ; i < var_did_villageName_list.length ; i++ ) {
				if ( var_did_villageName_list[i][0] == did ) 
					return var_did_villageName_list[i][1];
			}
			return null; // this should never happen
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getvillagefromdid():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// used only by getMainVillageid()
function getDidFromVillage(vil) {
	try {
		//flag ( "getDidFromVillage():: Started! Called for village: " + vil );
		//flag ( "getDidFromVillage():: var_did_villageName_list.length: " + var_did_villageName_list.length);
		//printStackTrace();
		if ( var_did_villageName_list.length == 0 ) {
			var xpathVillageList = "";
			switch ( aTravianVersion ) {
				case "3.6": xpathVillageList = 'id("vlist")//td[@class="link"]//a[@href]'; break;
				case "4.0": xpathVillageList = 'id("villageList")//li/a[contains(@href,"newdid=")]'; break;
				default: throwLogicError ( "getDidFromVillage():: Travian Version not set!!" );
			}
			var getfoots = document.evaluate ( xpathVillageList, document, null, XPSnap, null );
			//flag ( "getDidFromVillage():: getfoots.snapshotLength: " + getfoots.snapshotLength );
			if (getfoots.snapshotLength > 0) {
				var vilFound = false;
				var retValue = "";
				for (var i = 0; i < getfoots.snapshotLength; i++) {
					//flag ( "getDidFromVillage(): getfoots.snapshotitem("+i+").InnerHTML=" + getfoots.snapshotItem(i).innerHTML );
					//flag ( "getDidFromVillage(): getfoots.snapshotitem("+i+").href=" + getfoots.snapshotItem(i).href );
					var vilDid  = getfoots.snapshotItem(i).href.match(/\bnewdid=\d{1,}\b/)[0].split("=")[1];
					var vilName = getfoots.snapshotItem(i).innerHTML;
					var_did_villageName_list[i] = [ vilDid, vilName ];
					if ( vilName == vil ) {
						vilFound = true;
						retValue = vilDid;
					}
				}
				if ( vilFound == false )
					throwLogicError ( "getDidFromVillage():: Newdid for requested village not found: " + vil );
				else
					return retValue;
			}
			else {
				// if _mainvillageName is not set, then do not set var_did_villageName_list! var_did_villageName_list will be set when 
				// getvillagefromdid() will be called from setGlobalVars().
				if ( GM_getValue(myacc() + "_mainvillageName", "") != "" )
					var_did_villageName_list[0] = [ GM_getValue(myacc() + '_singleTownNEWDID'), GM_getValue(myacc() + "_mainvillageName") ];
				return GM_getValue(myacc() + '_singleTownNEWDID');
			}
		}
		else {
			for ( var i = 0 ; i < var_did_villageName_list.length ; i++ ) {
				if ( var_did_villageName_list[i][1] == vil ) 
					return var_did_villageName_list[i][0];
			}
			return undefined; // this should never happen
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getDidFromVillage():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}


function levelselectText(min, max){
	var levelsel = '<select id="levelselect" name="levelselect">';
	for (min; min <= max; min++) {
		levelsel += '<option value="' + min + '">'  + ' ' + aLangGameText[0] + ' ' + min + '</option>';
	}
	levelsel += '</select>';
	return levelsel;
}

// This function goes through each task in task list of all villages and call appropriate functions to set the cookies for them.
// This function sends out a lot of http requests and hence should be envoked only on manual events.
// 	-- It sends http requests only for those village whose parameters are not set.
// calls startBuildOrSetTime() to set cookies for resource/building/new builds/auto-resource
// 	startBuildOrSetTime() in turns opens up dorf1.php for stats collection.
// calls startTransOrSetTime() to set cookies for auto-transport
// 	startTransOrSetTime() in turns opens up the marketplace (gid=17) for stats collection.
// calls startDemoOrSetTime() to set cookies for demolish
// 	startDemoOrSetTime() in turns opens up main building (gid=15) for stats collection.
// for other task kinds, this function does nothing as nothing is required as of now.
function getTaskCookies() {
	try {
		flag("getTaskCookies():: Started!");
		/*if ( taskdoing != "1" ) // getTaskCookies works only when taskdoing is 1, ie when script is running.
			return;*/
		for (e in getAllVillageNewdids()) { // run for all villages
			whatever = GM_getValue(myacc() + "_" + getAllVillageNewdids()[e] + "_waitTask", "false");
			if ( whatever != "false" ) {
				allTasks = whatever.split("|");
				for (nnn in allTasks) { // The loop runs over all villages & all tasks, however http reqs are sent only when parameters are not set.
					thisTask = allTasks[nnn].split("_");
					switch (thisTask[0]) {
						// [ resource / building upgrade ] // call startBuildOrSetTime() to set cookies
						case "0": // 0 is update
							var buildTimepoint = GM_getValue(myacc() + "_" + getAllVillageNewdids()[e] + "_buildSlotBuildingFreeTime", "false");
							var resourceTimepoint = GM_getValue(myacc() + "_" + getAllVillageNewdids()[e] + "_buildSlotResourceFreeTime", "false");
							var updataTimepoint = GM_getValue(myacc() + "_" + getAllVillageNewdids()[e] + "_buildSlotFreeTime", "false");
							if (GM_getValue(myacc() + "_raceID") == "0") { // Romans double build
								if (thisTask[1] < 19) { // romans resource
									GM_setValue(myacc() + "_" + getAllVillageNewdids()[e] + "_ResourceTaskExists", "1");
									if (resourceTimepoint == "false") {
										calldoing0();
										taskTime = startBuildOrSetTime(getAllVillageNewdids()[e], allsourceString);
										//TS_debug("the taskTime return from startBuildOrSetTime is " + taskTime);
										calldoing1();
									}
								}
								else if (thisTask[1] > 18 && thisTask[1] < 42) { // romans building upgrade
									GM_setValue(myacc() + "_" + getAllVillageNewdids()[e] + "_BuildingTaskExists", "1");
									if (buildTimepoint == "false") {
										calldoing0();
										taskTime = startBuildOrSetTime(getAllVillageNewdids()[e], allbuildString);
										//TS_debug("the taskTime return from startBuildOrSetTime is ");
										calldoing1();
									}
								}
								else { // if >=42, it is roman auto resource
									GM_setValue(myacc() + "_" + getAllVillageNewdids()[e] + "_ResourceTaskExists", "1");
									if (resourceTimepoint == "false") {
										calldoing0();
										taskTime = startBuildOrSetTime(getAllVillageNewdids()[e], allsourceString);
										//TS_debug("the taskTime return from startBuildOrSetTime is ");
										calldoing1();
									}
								}
							}
							else { // others race resource building upgrade
								GM_setValue(myacc() + "_" + getAllVillageNewdids()[e] + "_UpdataTaskExists", "1");
								if (updataTimepoint == "false") {
									calldoing0();
									taskTime = startBuildOrSetTime(getAllVillageNewdids()[e], allString);
									//TS_debug("the taskTime return from startBuildOrSetTime is ");
									calldoing1();
								}
							}
							break;

						// [ new building ] // call startBuildOrSetTime() to set cookies
						case "1": //"1" is new building
							var buildTimepoint = GM_getValue(myacc() + "_" + getAllVillageNewdids()[e] + "_buildSlotResourceFreeTime", "false");
							var updataTimepoint = GM_getValue(myacc() + "_" + getAllVillageNewdids()[e] + "_buildSlotFreeTime", "false");
							if (GM_getValue(myacc() + "_raceID") == "0") { //Romans double build
								GM_setValue(myacc() + "_" + getAllVillageNewdids()[e] + "_BuildingTaskExists", "1");
								if (buildTimepoint == "false") {
									calldoing0();
									taskTime = startBuildOrSetTime(getAllVillageNewdids()[e], allbuildString);
									//TS_debug("the taskTime return from startBuildOrSetTime is ");
									calldoing1();
								}
							}
							else {// others race single build
								GM_setValue(myacc() + "_" + getAllVillageNewdids()[e] + "_UpdataTaskExists", "1");
								if (updataTimepoint == "false") {
									calldoing0();
									taskTime = startBuildOrSetTime(getAllVillageNewdids()[e], allString);
									//TS_debug("the taskTime return from startBuildOrSetTime is ");
									calldoing1();
								}
							}
							break;

						// [ attack normal / raid, reinforce ] // no pre-computation required.
						case "2":
					 		break;

						// [ Blacksmith Improve Offense, Armoury Improve Defense ]
						case "3":
							break;

						// [ Train Troops ] // no pre-computation required.
					 	case "4": 
					 		break;

						// [ Auto Transport ] // call startTransOrSetTime() to set cookies
						case "5": //"5" is auto transport 5_model_toid_toposition//5_2_0_241654_500,500,500,500_0_1245413194000_interval

								var transTaskStr = myacc() + "_" + getAllVillageNewdids()[e] + "_to_" + thisTask[2] + "_autoTransTime";
								var autoTransTime = GM_getValue(transTaskStr);
								if(!autoTransTime || autoTransTime == "1500000000000") {
									calldoing0();
									trantime = startTransOrSetTime(getAllVillageNewdids()[e], thisTask);
									TS_debug("the autotrantime back from startTransOrSetTime() is " + trantime);
									calldoing1();
								}
							break;

						// [ Party Small / Big ]
						case "6":
							break;

						// [ Deomolish Buildings ] // call startDemoOrSetTime() to set cookies
						case "7": //"7_" + theID +"_" + crtlevel + "_" + currentID() + "_" +theBuild
						 	var demoTime = GM_getValue(myacc() + "_" + getAllVillageNewdids()[e] + "_demolishTime", "false");
							if(demoTime=="false"){
								calldoing0();
								demotimee=startDemoOrSetTime(getAllVillageNewdids()[e], thisTask);
								TS_debug("the demotime back from startDemoOrSetTime() is " + demotimee);
								calldoing1();
							}
							break;

						// [ Custom Transport ]
						case "8":
							break;

					 	default:
							TS_debug("FM have task ID = " + thisTask[0] + " ??");
							break;
					}
				}
			}
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getTaskCookies():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function startDemoOrSetTime(vi) {
	try {
		flag ( "startDemoOrSetTime():: Started! vi: " + vi );

		var turl= myhost + "/build.php?newdid=" + vi + "&gid=15"; // opens gid=15, ie main building
		function callback() {};
		var getDelayTime = new XMLHttpRequest();
		getDelayTime.open('GET', turl, false);
		getDelayTime.onreadystatechange = callback;
		getDelayTime.send(null);
		function callback() {
			if (getDelayTime.readyState == 4) {
				if (getDelayTime.status == 200) {
					flag ( "startDemoOrSetTime():: Callback Started!" );

					var aElem = document.createElement('DIV');
					aElem.innerHTML = getDelayTime.responseText;

					if ( gatherStats(aElem.innerHTML) ) {
						// attempt reloading page, captcha ll be found there too and script will stop.
						window.location.replace(myhost + "/spieler.php");
						return 60*60*1000;
					}
					
					refreshPageInfo(aElem);

					var snv = document.evaluate('.//*[@id="demolish"]', aElem, null, XPFirst, null).singleNodeValue;
					if ( snv ) {
						var gettime = snv.innerHTML.match(/\d{1,2}:\d{2}:\d{2}/);
						var demot = gettime.toString().split(":");
						var demoTime =  Number(demot[0]) * 60*60*1000 + Number(demot[1]) * 60*1000 + Number(demot[2]) * 1000;
						var endt = getRandomizedTime(demoTime,5*60*1000); // delay by demoTime + random ( 5 mins )
						flag ( "startDemoOrSetTime():: Some demolish is going on, next demo start at " + new Date ( endt ) );
						GM_setValue(myacc() + "_" + vi + "_demolishTime", endt.toString());
						return endt;
					}
					else {
						var endt = getRandomizedTime(20*1000,20*1000); // delay by 20 secs + random ( 20 secs )
						flag ( "startDemoOrSetTime():: No demolish is going on, next demo start soon, at " + new Date ( endt ) );
						GM_setValue(myacc() + "_" + vi + "_demolishTime", endt.toString());
						return endt;
					}
				}
			}
		}
		return callback();
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startDemoOrSetTime():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// delay & randinter are in milli-seconds
// mode 0: current time + delay +   random (    randinter    )
// mode 1: current time + delay +/- random ( randinter / 2.0 ) // this mode is tricky, here return value can be -ve, for +ve values one should ensure delay >= randinter/2
// mode 2:                delay +   random (    randinter    ) // should use this when we need only an interval & not an absolute date/time.
// return value is in milli-seconds
function getRandomizedTime ( delay, randinter, mode ) {
	try {
		randinter = ( randinter == null || randinter == undefined || randinter === "" ) ? 15*60*1000 : Number(randinter); // if randinter not specified, use default 15 min
		mode      = ( mode      == null || mode      == undefined || mode      === "" ) ? 0 : Number(mode); // if mode not specified, use default 0
		switch ( mode ) {
			case 0:
				// curent time (milli) + delay (milli) + random ( randinter ) mins
			        return ( new Date().getTime() + delay + Math.ceil ( Math.random() * randinter ) );
			case 1:
				// current time (milli) + delay (milli) +/- random ( randinter/2 ) mins
				return ( new Date().getTime() + delay + Math.ceil ( Math.random() * randinter - randinter/2.0 ) );
			case 2:
				// delay (milli) + random (randinter ) mins
				return ( delay + Math.ceil ( Math.random() * randinter ) );
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getRandomizedTime():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function startTransOrSetTime(vi, tTask) {
	try {
		flag ( "startTransOrSetTime():: Started! vi: " + vi );
		//TS_debug("come into startTransOrSetTime() from " + getvillagefromdid(vi) + " to " + getvillagefromdid(tTask[2]));
		var turl = myhost + "/build.php?newdid=" + vi + "&gid=17"; // open gid=17, ie marketplace
		function callback() {};
		var getDelayTime = new XMLHttpRequest();
		getDelayTime.open('GET', turl, false);
		getDelayTime.onreadystatechange = callback;
		getDelayTime.send(null);
		function callback(){
			if (getDelayTime.readyState == 4) {
				if (getDelayTime.status == 200) {
					TS_debug("here is startTransOrSetTime callback function");

					// v_kir 2010.01.24

					var aDoc = document/*.implementation.createDocument("", "", null)*/;
					var aElem = document.createElement('DIV');
					aElem.innerHTML = getDelayTime.responseText;
					//aDoc.appendChild(aElem);
					if ( gatherStats(aElem.innerHTML) ) {
						// attempt reloading page, captcha ll be found there too and script will stop.
						window.location.replace(myhost + "/spieler.php");
						return 60*60*1000;
					}
					
					refreshPageInfo(aElem);


					var comm = [0, 0];

					// find max resources per merchant
					var pp = aDoc.evaluate('.//table[@id="send_select"]/descendant::td[@class="max"]/a', aElem, null, XPFirst, null);
					comm[1] = pp.singleNodeValue.innerHTML.match(/\d{3,4}/);

					//TS_debug("responsetime is "+getDelayTime.responseText);
					/*var pp = getDelayTime.responseText.match(/<b>\d{2,4}<\/b>/);
					comm[1] = pp.toString().match(/\d{2,4}/);*/
					/*var capacity = document.evaluate('id("build")/form/p/b',aElem,null,XPFirst,null).singleNodeValue;
					if(capacity) {
						capacity = parseInt(capacity.innerHTML);
					}*/

					// get merchants available in village
					var xpathMerchantCount = "";
					switch ( aTravianVersion ) {
						case "3.6": xpathMerchantCount = './/table[@id="target_select"]/descendant::td[@class="mer"]'; break;
						case "4.0": xpathMerchantCount = './/div[contains(@class,"traderCount")]/div[@class="boxes-contents"]'; break;
						default: throwLogicError ( "startTransOrSetTime():: Travian Version not set!!" );
					}
					var qq = aDoc.evaluate( xpathMerchantCount, aElem, null, XPFirst, null);
					comm[0] = qq.singleNodeValue.innerHTML.split(" ")[1].split("/")[0];
					TS_debug("now Merchants at home is " + comm[0] + ", and each Merchants can load " + comm[1]);
					comm[0] = parseInt(comm[0]); // current count of merchants in village
					comm[1] = parseInt(comm[1]); // max resource per merchant
					/*if(comm[1] != capacity)
					{
						TS_debug("DOHHHHH!, CAPACITY doesn't work...old=" + comm[1] + ",New=" + capacity);
					}*/

					var maxTransAmount = getMaxTransAmount(vi,tTask);

					var ddg = new Date();
					if ( maxTransAmount != false ) {
						if (comm[0] > 0) {

							//Tasktime = ddg.getTime() + 10000
							var Tasktime = getRandomizedTime ( 10*1000, 30*1000 ); // delay by 10 secs + random 0.5 mins
							GM_setValue(myacc() + "_" + vi + "_to_" + tTask[2] + "_autoTransTime", Tasktime.toString());
							var d = new Date(Tasktime);
							TS_debug("============================================== next transport begin from " + d);
							return Tasktime;
						}
						else {
							var nextTime = getGMCookie ( "MerchantReturnTime", vi );
							if ( !nextTime || nextTime < new Date().getTime() ) {
								TS_debug("No merchant at home and no merchant in transit is very unlikely");
								// delay by transsInterval + random ( 15 mins )
								nextTime = getRandomizedTime ( Number(transsInterval), 15*60*1000 );
							}
							GM_setValue(myacc() + "_" + vi + "_to_" + tTask[2] + "_autoTransTime", nextTime.toString());
							var d = new Date(nextTime);
							TS_debug("next transport begin from " + d);
							return nextTime;
						}
					}
					else {
						// delay by transsInterval + random ( 15 mins )
						var Tasktime = getRandomizedTime ( Number(transsInterval), 15*60*1000 );
						GM_setValue(myacc() + "_" + vi + "_to_" + tTask[2] + "_autoTransTime", Tasktime.toString());
						TS_debug("resource is not enough, delay _autoTransTime in startTransOrSetTime");
						return Tasktime;
					}
				}
			}
		}
		return callback();
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startTransOrSetTime():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}


// called after a merchant has reached destination to refresh resource values.
function fleshTraning ( vi, tTask ) {
	try {
		flag ( "fleshTraning():: Started! vi: " + vi );
		//TS_debug("come into fleshTraning in " + getvillagefromdid(vi) + "; to " + getvillagefromdid(tTask[2]));

		var turl = myhost + "/build.php?newdid=" + vi + "&gid=17";

		function callback() {};

		var getDelayTime = new XMLHttpRequest();
		getDelayTime.open('GET', turl, false);
		getDelayTime.onreadystatechange = callback;
		//try {
			getDelayTime.send(null);
		/*} catch(err) {
			TS_debug("FleshTrainig Request failed: " + err);
		}*/
		function callback() {
			if (getDelayTime.readyState == 4) {
				if (getDelayTime.status == 200) {
					TS_debug("transporting flesh Require callback here");

					//v_kir 2010.01.24

					var aDoc = document/*.implementation.createDocument("", "", null)*/;
					var aElem = document.createElement('DIV');
					aElem.innerHTML = getDelayTime.responseText;
					//aDoc.appendChild(aElem);
					if ( gatherStats(aElem.innerHTML) ) {
						// attempt reloading page, captcha ll be found there too and script will stop.
						window.location.replace(myhost + "/spieler.php");
						return 60*60*1000;
					}

					//delete value since we are processing it. Market analysis will set it again if requried.
					GM_deleteValue(myacc() + "_" + vi + "_to_" + tTask[2] + "_TraningTime");

					refreshPageInfo(aElem);
					var Transtime = GM_getValue(myacc() + "_" + vi + "_to_" + tTask[2] + "_TraningTime");
					var t = getIncomingResources ( tTask[2] );
					//TS_debug("Resource Transporting: " + t);

					//update target resource since our merchant just arrive in target village.
					getTargetResource(tTask[2]);
					return Transtime;
				}
			}
		}
		return callback();
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>fleshTraning():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function refreshPageInfo(aElem) {
	try {
		var vid = getVillageId(aElem);
		var content = $( "content", aElem );
		var classname = content.className;
		if ( classname == "build" ) {
			var build = $( "build", content );
			if ( build ) {
				classname = build.className;
			}
			else {
				var myDiv = $g('./div',XPFirst,content);
				if ( myDiv ) {
					classname = myDiv.className;
				}
			}
		}
		switch(classname) {
			case "village1":
			  	analyzeDorf1(aElem,vid);
				break;
			case "village2":
				analyzeDorf2(aElem,vid);
				break;
			/*case "statistics":
				break;
			case "map":
				break;*/
			case "gid17":
				analyzeMarketPlace(aElem,vid);
				break;
			case "gid16":
				//analyzeRallyPoint(aElem,vid); // don't do it here, it will be called explicitily when required
				break;
			default:
				//TS_debug ( "content.className: " + content.className );
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>refreshPageInfo():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getTargetResource ( vi, callback ) {
	try {
		flag ( "getTargetResource():: Started! vi: " + vi );
		//TS_debug("come into getTargetResource at "+getvillagefromdid(vi));
		url = myhost + "/build.php" + "?newdid=" + vi;
		GM_xmlhttpRequest({
			method: 'GET',
			url: url,
			headers: "",
			onload: function(response){
				if ( gatherStats(response.responseText) ) {
					// attempt reloading page, captcha ll be found there too and script will stop.
					window.location.replace(myhost + "/spieler.php");
					return false;
				}

				//TS_debug("getTargetResource Require callback here");

				//v_kir 2010.01.24

				var auDoc = document/*.implementation.createDocument("", "", null)*/;
				var auElem = document.createElement('div');
				auElem.innerHTML = response.responseText;
				
				refreshPageInfo(auElem);
				//auDoc.appendChild(auElem);
				getResourceCap2(auElem,vi);
				if ( !callback ) {
					calldoing1();
				}
				else {
					window.setTimeout ( callback, Math.ceil ( Math.random() * 3000 ) + 2000 ); // delay next call by random 3 secs + 2 secs
				}
			}
		});
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getTargetResource():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getMerchanTime(vi, positionnum){
	xRace = GM_getValue(myacc() + "_raceID");
	posi1 = getPosFromNewdid(vi);
	sx1 = getXfromCoord(posi1);
	sy1 = getYfromCoord(posi1);
	sx2 = getXfromCoord(positionnum);
	sy2 = getYfromCoord(positionnum);
	qDist = getDistance(sx1, sy1, sx2, sy2);
	xRace=parseInt(xRace);
	var factor = getMerchantSpeedFactor();
	var aTime = Math.round(qDist * 3600000 / (mts[xRace] * factor));
	return aTime;
}

function getDistance ( sx1, sy1, sx2, sy2 ) {
	var x1 = parseInt(sx1);
	var y1 = parseInt(sy1);
	var x2 = parseInt(sx2);
	var y2 = parseInt(sy2);
	if ( isNaN ( x1 ) || isNaN ( y1 ) || isNaN ( x2 ) || isNaN ( y2 ) )
		throwLogicError ( "getDistance():: Invalid vlaue for coordinates !! coord1: (" + sx1 + "," + sy1 + "), coord2: (" + sx2 + "," + sy2 + ")" );
	var dX = getCoordDiff ( x1, x2 );
	var dY = getCoordDiff ( y1, y2 );
	//var dist = Math.sqrt ( Math.pow ( dX, 2 ) + Math.pow ( dY, 2 ) );
	var dist = Math.sqrt ( ( dX * dX ) + ( dY * dY ) );
	return dist;
}

function getCoordDiff ( xy1, xy2 ) {
	xy1 = parseInt(xy1);
	xy2 = parseInt(xy2);
	if ( isNaN ( xy1 ) || isNaN ( xy2 ) )
		throwLogicError ( "getCoordDiff():: Invalid vlaue for xy1 or xy2 !! xy1: " + xy1 + ", xy2: " + xy2 );
	return Math.min ( Math.abs ( xy2 - xy1 ), Math.abs ( 801 - Math.abs ( xy2 - xy1 ) ) );
}

function normalizeCoord ( xy ) {
	xy = parseInt ( xy );
	if ( isNaN ( xy ) )
		throwLogicError ( "normalizeCoord():: Invalid vlaue for xy !!" );
	if ( xy >= -400 && xy <= 400 )
		return xy;
	else {
		return ( ( xy + 400 ) % 801 - 400 );
	}
}

function getPlusDoubleBuildStatus ( text ) {
	try {
		flag ( "getPlusDoubleBuildStatus():: Started!" );
		if ( text != null && text != "" ) {
			var aElem = document.createElement("div");
			aElem.innerHTML = text;
			if ( gatherStats(aElem.innerHTML) ) {
				var lvlErrMsg = "Captcha Found!";
				GM_setValue(myacc() + "_currentError", lvlErrMsg );
				// attempt reloading page, captcha ll be found there too and script will stop.
				window.location.replace(myhost + "/spieler.php");
				return false;
			}

			var plusLeftTimeNode = document.evaluate('.//table[@class="plusFunctions"]//td[@class="desc"]//span[@class="run"]//b', document, null, 9, null).singleNodeValue;
			if ( plusLeftTimeNode != null ) { // if we have plus account
				var elapseTime = new Date( new Date().getTime() + Number ( plusLeftTimeNode.innerHTML ) * 24*60*60*1000 - 2*60*60*1000 ).getTime();
				GM_setValue ( myacc() + "_plusElapseTime", elapseTime.toString() );
				if ( new Date().getTime() < elapseTime )
					GM_setValue ( myacc() + "_plusDoubleBuild", "1" );
				else
					GM_setValue ( myacc() + "_plusDoubleBuild", "0" );
			}
			else {
				//GM_setValue ( myacc() + "_plusElapseTime", "" );
				GM_setValue ( myacc() + "_plusDoubleBuild", "0" );
			}
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getPlusDoubleBuildStatus():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function checkPlusDoubleBuildElapsed () {
	try {
		if ( GM_getValue ( myacc() + "_plusDoubleBuildEnabled", "0" ) == "1" ) {
			//flag ( "checkPlusDoubleBuildElapsed():: Started!" );
			var elapseTime = GM_getValue ( myacc() + "_plusElapseTime", "" );
			if ( elapseTime != null && elapseTime != "" ) {
				elapseTime = parseInt ( elapseTime );
				if ( new Date().getTime() < elapseTime )
					GM_setValue ( myacc() + "_plusDoubleBuild", "1" );
				else
					GM_setValue ( myacc() + "_plusDoubleBuild", "0" );
			}
		}
		else {
			GM_setValue ( myacc() + "_plusDoubleBuild", "0" );
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>checkPlusDoubleBuildElapsed():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// this block sets _CorpRemain, _minLevelId, _minLevelCropId
function collectAutoResDataFromDorf1(Villageid, aElem) {
	try {
		//flag ( "collectAutoResDataFromDorf1() Started!" );
		if ( Villageid == null || Villageid == "" || aElem == null ) {
			var msg = "collectAutoResDataFromDorf1():: Incorrent parameter(s) passed!"; 
			TS_debug ( msg );
			var errObj = new Error () ;
			errObj.name = "Invalid Argument passed to function";
			errObj.message = msg;
			throw errObj;
		}

		var xpathCorpRemain = "";
		switch ( aTravianVersion ) {
			case "3.6":
				xpathCorpRemain = ".//*[@id='res']/descendant::td";
				break;
			case "4.0":
				xpathCorpRemain = ".//*[@id='res']/li/p/span";
				break;
			default:
				throwLogicError ( "collectAutoResDataFromDorf1():: Travian Version not set!!" );
		}
		var CorpRemain = document.evaluate( xpathCorpRemain, aElem, null, XPOrdList, null );
		var hehe = CorpRemain.snapshotLength - 1;
		var corpcost = CorpRemain.snapshotItem(hehe).innerHTML.split("/")[0];
		var corpprod = CorpRemain.snapshotItem(hehe).innerHTML.split("/")[1];
		GM_setValue(myacc() + "_" + Villageid + "_CorpRemain", (corpprod - corpcost));

		var mainVI = GM_getValue(myacc() + "_mainvillageId");
		var maxreslevel = (mainVI == Villageid) ? 20 : 10;
		var doneID = GM_getValue(myacc() + "_" + Villageid + "_autoResourceDone", "20_20"); // get the already built resource id.
		var allRess = document.evaluate('.//*[@id="rx"]//area[contains(@href,"build.php") and contains(@href,"id=")]', aElem, null, XPSnap, null);

		var cropUpgradeEnabled = GM_getValue ( myacc() + "_" + Villageid + "_cropUpgradeEnabled", "1" );

		// find the min resource level and set it to numm
		var numm = 20;
		for (var i = 0; i < allRess.snapshotLength; i++) { // get the min level
			var temppp = "";
			switch ( aTravianVersion ) {
				case "3.6": temppp = allRess.snapshotItem(i).title.split(" "); break;
				case "4.0": temppp = allRess.snapshotItem(i).alt.split(" "); break;
				default: throwLogicError ( "collectAutoResDataFromDorf1():: Travian Version not set!!" );
			}
			var resNa = "";
			switch (temppp.length) {
				case 3: resNa = temppp[0]; break;
				case 4: resNa = temppp[0] + " " + temppp[1]; break;
				case 5: resNa = temppp[0] + " " + temppp[1] + " " + temppp[2]; break;
				case 6: resNa = temppp[0] + " " + temppp[1] + " " + temppp[2] + " " + temppp[3]; break;
			}
			if ( cropUpgradeEnabled == "0" ) { // if crop upgrade is disabled
				if ( resNa == aLangAllBuildAltWithId[3] ) { // skip if current id is a crop id
					continue;
				}
			}
			//flag ( "collectAutoResDataFromDorf1():: allRess.snapshotItem("+i+"): " + allRess.snapshotItem(i).getAttribute("href") );
			//flag ( "collectAutoResDataFromDorf1():: i: " + i + ", temppp: " + temppp );
			ddq = parseInt(temppp[temppp.length - 1]);
			numm = Math.min(numm, ddq);
		}
		if ( numm >= maxreslevel ) { // all resources updates are finished
			deleteAutoResTask(Villageid);
			return;
		}

		// find min level id, using _autoResourceDone data skip ids which is currently building
		var sounttt = "0"; // set to 1 when found
		for (var j = 0; j < allRess.snapshotLength; j++) {
			var temppp = "";
			switch ( aTravianVersion ) {
				case "3.6": temppp = allRess.snapshotItem(j).title.split(" "); break;
				case "4.0": temppp = allRess.snapshotItem(j).alt.split(" "); break;
				default: throwLogicError ( "collectAutoResDataFromDorf1():: Travian Version not set!!" );
			}
			var resNa = "";
			switch (temppp.length) {
				case 3: resNa = temppp[0]; break;
				case 4: resNa = temppp[0] + " " + temppp[1]; break;
				case 5: resNa = temppp[0] + " " + temppp[1] + " " + temppp[2]; break;
				case 6: resNa = temppp[0] + " " + temppp[1] + " " + temppp[2] + " " + temppp[3]; break;
			}
			if ( cropUpgradeEnabled == "0" ) { // if crop upgrade is disabled
				if ( resNa == aLangAllBuildAltWithId[3] ) { // skip if current id is a crop id
					continue;
				}
			}
			var myid = allRess.snapshotItem(j).href.match(/\bid=\d{1,}\b/)[0].split("id=")[1];
			var mylvl = parseInt ( temppp [ temppp.length - 1 ] );
			if ( mylvl == numm ) { // if mylvl is same as min level
				var pattText = "\\b" + myid + "_" + numm + "\\b";
				var modifiers = "g";
				var regVar = new RegExp ( pattText, modifiers );
				if ( doneID.match(regVar) == null ) { // found only if current id and lvl is not in _autoResourceDone, ie not built or not currently building
					GM_setValue(myacc() + "_" + Villageid + "_minLevelId", myid);
					GM_setValue(myacc() + "_" + Villageid + "_minLevelIdLevel", numm );
					sounttt = "1";
					break;
				}
			}
		}

		// if the min level id is currently building then find next higher level id and set it to cookie
		if (sounttt == "0") {
			numm = numm + 1; // next min level
			for (var n = 0; n < allRess.snapshotLength; n++) {
				var temppp = "";
				switch ( aTravianVersion ) {
					case "3.6": temppp = allRess.snapshotItem(n).title.split(" "); break;
					case "4.0": temppp = allRess.snapshotItem(n).alt.split(" "); break;
					default: throwLogicError ( "collectAutoResDataFromDorf1():: Travian Version not set!!" );
				}
				var resNa = "";
				switch (temppp.length) {
					case 3: resNa = temppp[0]; break;
					case 4: resNa = temppp[0] + " " + temppp[1]; break;
					case 5: resNa = temppp[0] + " " + temppp[1] + " " + temppp[2]; break;
					case 6: resNa = temppp[0] + " " + temppp[1] + " " + temppp[2] + " " + temppp[3]; break;
				}
				if ( cropUpgradeEnabled == "0" ) { // if crop upgrade is disabled
					if ( resNa == aLangAllBuildAltWithId[3] ) { // skip if current id is a crop id
						continue;
					}
				}
				var myid = allRess.snapshotItem(n).href.match(/\bid=\d{1,}\b/)[0].split("id=")[1];
				var mylvl = parseInt ( temppp [ temppp.length - 1 ] );
				if ( mylvl == numm ) { // if mylvl is same as min level
					var pattText = "\\b" + myid + "_" + numm + "\\b";
					var modifiers = "g";
					var regVar = new RegExp ( pattText, modifiers );
					if ( doneID.match(regVar) == null ) {
						GM_setValue(myacc() + "_" + Villageid + "_minLevelId", myid);
						GM_setValue(myacc() + "_" + Villageid + "_minLevelIdLevel", numm );
						break;
					}
				}
			}
		}

		// find the min crop level and set it to numm2
		var numm2 = 20;
		for (var k = 0; k < allRess.snapshotLength; k++) {
			var temsps = "";
			switch ( aTravianVersion ) {
				case "3.6": temsps = allRess.snapshotItem(k).title.split(" "); break;
				case "4.0": temsps = allRess.snapshotItem(k).alt.split(" "); break;
				default: throwLogicError ( "collectAutoResDataFromDorf1():: Travian Version not set!!" );
			}
			var resNa = "";
			switch (temsps.length) {
				case 3: resNa = temsps[0]; break;
				case 4: resNa = temsps[0] + " " + temsps[1]; break;
				case 5: resNa = temsps[0] + " " + temsps[1] + " " + temsps[2]; break;
				case 6: resNa = temsps[0] + " " + temsps[1] + " " + temsps[2] + " " + temsps[3]; break;
			}
			if ( resNa == aLangAllBuildAltWithId[3] ) { // do only if current id is a crop id
				ffq = parseInt(temsps[temsps.length - 1]);
				numm2 = Math.min(numm2, ffq);
			}
		}

		if ( numm2 < maxreslevel ) {
			// find min level crop id, using _autoResourceDone data skip ids which is currently building
			var mouu = "0"; // set to 1 when found
			for (var l = 0; l < allRess.snapshotLength; l++) {
				var temspp = "";
				switch ( aTravianVersion ) {
					case "3.6": temspp = allRess.snapshotItem(l).title.split(" "); break;
					case "4.0": temspp = allRess.snapshotItem(l).alt.split(" "); break;
					default: throwLogicError ( "collectAutoResDataFromDorf1():: Travian Version not set!!" );
				}
				var resNaa = "";
				switch (temspp.length) {
					case 3: resNaa = temspp[0]; break;
					case 4: resNaa = temspp[0] + " " + temspp[1]; break;
					case 5: resNaa = temspp[0] + " " + temspp[1] + " " + temspp[2]; break;
					case 6: resNaa = temspp[0] + " " + temspp[1] + " " + temspp[2] + " " + temspp[3]; break;
				}
				if ( resNaa == aLangAllBuildAltWithId[3] ) { // do only if current id is a crop id
					var myids = allRess.snapshotItem(l).href.match(/\bid=\d{1,}\b/)[0].split("id=")[1];
					var mylvls = parseInt ( temspp [ temspp.length - 1 ] );
					if ( mylvls == numm2 ) { // if mylvl is same as min crop level
						//flag ( "collectAutoResDataFromDorf1():: 1:: myids: " + myids + ", mylvls: " + mylvls + ", doneID: " + doneID );
						var pattText = "\\b" + myids + "_" + numm2 + "\\b";
						var modifiers = "g";
						var regVar = new RegExp ( pattText, modifiers );
						if ( doneID.match(regVar) == null ) { // found only if current id and lvl is not in _autoResourceDone, ie not built or not currently building
							//flag ( "collectAutoResDataFromDorf1():: m1:: myids: " + myids + ", mylvls: " + mylvls + ", doneID: " + doneID );
							GM_setValue(myacc() + "_" + Villageid + "_minLevelCropId", myids);
							GM_setValue(myacc() + "_" + Villageid + "_minLevelCropLevel", numm2);
							mouu = "1";
							break;
						}
					}
				}
			}

			// if the min level crop id is currently building then find next higher level crop id and set it to cookie
			if (mouu == "0") {
				numm2 = numm2 + 1; // next min level
				for (var m = 0; m < allRess.snapshotLength; m++) {
					var temspsp = "";
					switch ( aTravianVersion ) {
						case "3.6": temspsp = allRess.snapshotItem(m).title.split(" "); break;
						case "4.0": temspsp = allRess.snapshotItem(m).alt.split(" "); break;
						default: throwLogicError ( "collectAutoResDataFromDorf1():: Travian Version not set!!" );
					}
					var resNasa = "";
					switch (temspsp.length) {
						case 3: resNasa = temspsp[0]; break;
						case 4: resNasa = temspsp[0] + " " + temspsp[1]; break;
						case 5: resNasa = temspsp[0] + " " + temspsp[1] + " " + temspsp[2]; break;
						case 6: resNasa = temspsp[0] + " " + temspsp[1] + " " + temspsp[2] + " " + temspsp[3]; break;
					}
					if ( resNasa == aLangAllBuildAltWithId[3] ) { // do only if current id is a crop id
						var myids = allRess.snapshotItem(m).href.match(/\bid=\d{1,}\b/)[0].split("id=")[1];
						var mylvls = parseInt ( temspsp [ temspsp.length - 1 ] );
						//flag ( "collectAutoResDataFromDorf1():: 2:: myids: " + myids + ", mylvls: " + mylvls + ", doneID: " + doneID );
						if ( mylvls == numm2 ) { // if mylvl is same as min crop level
							var pattText = "\\b" + myids + "_" + numm2 + "\\b";
							var modifiers = "g";
							var regVar = new RegExp ( pattText, modifiers );
							if ( doneID.match(regVar) == null ) {
								//flag ( "collectAutoResDataFromDorf1():: m2:: myids: " + myids + ", mylvls: " + mylvls + ", doneID: " + doneID );
								GM_setValue(myacc() + "_" + Villageid + "_minLevelCropId", myids);
								GM_setValue(myacc() + "_" + Villageid + "_minLevelCropLevel", numm2);
								break;
							}
						}
					}
				}
			}
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>collectAutoResDataFromDorf1():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getBuildCompletionTimesFromDorf1Or2(Villageid, str, aElem ) {
	try {
		//flag ( "getBuildCompletionTimesFromDorf1Or2() Started!" );
		if ( Villageid == null || Villageid == "" || str == null || str == "" || aElem == null ) {
			var msg = "getBuildCompletionTimesFromDorf1Or2():: Incorrent parameter(s) passed!"; 
			TS_debug ( msg );
			var errObj = new Error () ;
			errObj.name = "Invalid Argument passed to function";
			errObj.message = msg;
			throw errObj;
		}

		var nowt = new Date().getTime();
		var plusDoubleBuildEnabled = GM_getValue ( myacc() + "_plusDoubleBuild", "0" ) == "1";
		// disable plus double build if cropError, warehouseError or granaryError
		if ( checkCropWarehouseGranaryError ( Villageid, "_cropError" ) || 
			checkCropWarehouseGranaryError ( Villageid, "_warehouseError" ) || 
			checkCropWarehouseGranaryError ( Villageid, "_granaryError" ) ||
			checkBuildingPreRequisiteError ( Villageid ) ) {
			plusDoubleBuildEnabled = false;
		}

		// check what is building	
		var nextBuildTime = getNextBuildTime(Villageid);
		var xpathCurrentBuilds = "";
		var xpathCurrentBuildTimes = "";
		switch ( aTravianVersion ) {
			case "3.6":
				xpathCurrentBuilds = 'id("building_contract")/descendant::td[2]';
				xpathCurrentBuildTimes = 'id("building_contract")/descendant::td[3]/span[contains(@id,"timer")]';
				break;
			case "4.0":
				xpathCurrentBuilds = 'id("building_contract")//td[2]';
				xpathCurrentBuildTimes = 'id("building_contract")//td[3]/span[contains(@id,"timer")]';
				break;
			default:
				throwLogicError ( "getBuildCompletionTimesFromDorf1Or2():: Travian Version not set!!" );
		}
		var aValue = document.evaluate ( xpathCurrentBuilds, aElem, null, XPSnap, null );
		var aTimes = document.evaluate ( xpathCurrentBuildTimes, aElem, null, XPSnap, null );
		if (aValue.snapshotLength > 0) { // when something is building
			var testttt = 0; // this is a mark for search result, default is 0, if found increment by 1, possible values are 0, 1, 2
			for (var i = 0; i < aValue.snapshotLength; i++) {
				//flag ( "getBuildCompletionTimesFromDorf1Or2():: aValue.snapshotItem("+i+").innerHTML: " + aValue.snapshotItem(i).innerHTML );
				var thestring = "";
				switch ( aTravianVersion ) {
					case "3.6": thestring = aValue.snapshotItem(i).innerHTML.split(" (")[0]; break;
					case "4.0": thestring = aValue.snapshotItem(i).firstChild.textContent.replace(/\s*$/g,""); break;
					default: throwLogicError ( "getBuildCompletionTimesFromDorf1Or2():: Travian Version not set!!" );
				}
				//flag ( "getBuildCompletionTimesFromDorf1Or2():: thestring: '" + thestring + "'" );
				//flag ( "getBuildCompletionTimesFromDorf1Or2():: str: " + str );
				//flag ( "getBuildCompletionTimesFromDorf1Or2():: str.indexOf(thestring): " + str.indexOf(thestring) );
				if ( thestring != null && str.indexOf(thestring) != -1 ) {// index resource name from the resourcestring
					//flag("which in building is = " + thestring);
					testttt += 1;
					//flag("testttt = " + testttt);
					//flag("plusDoubleBuildEnabled = " + plusDoubleBuildEnabled);
					if ( testttt == 2 || // if two buildings of the kind specified is building, only possible if double build is enabled
						( testttt == 1 && // if 1 building of the kind specified is building and double build is disabled
							plusDoubleBuildEnabled == false ) 
						) {
						var tt = aTimes.snapshotItem(i).innerHTML.match(/\b\d{1,2}:\d{2}:\d{2}\b/);
						//flag("i get the building time = "+tt);
						ttar = tt.toString().split(":");
						//arriveTime = Number(ttar[0]) * 60 * 60 * 1000 + Number(ttar[1]) * 60 * 1000 + 
						//	Number(ttar[2]) * 1000 +  6000
						arriveTime = Number(ttar[0]) * 60 * 60 * 1000 + Number(ttar[1]) * 60 * 1000 + Number(ttar[2]) * 1000;
						//flag ( "getBuildCompletionTimesFromDorf1Or2():: arriveTime: " + new Date( arriveTime + new Date().getTime() ).toString() );
						Tasktime = getRandomizedTime(arriveTime + 10*1000, 2*60*1000); // delay by arriveTime + 10 secs + random ( 2 mins )
						flag ( "getBuildCompletionTimesFromDorf1Or2():: Build Slot Free Time: " + new Date(Tasktime) );
						switch (str) {
							case allsourceString:
								GM_setValue(myacc() + "_" + Villageid + "_buildSlotResourceFreeTime", Tasktime.toString());
								//flag("getBuildCompletionTimesFromDorf1Or2(" + Villageid + "):: resource is building, will return milsec= "
								//		+ Tasktime.toString());
								//var d = new Date(Tasktime);
								//flag("next task begin from " + d);
								return Tasktime;
								break;
							case allbuildString:
								GM_setValue(myacc() + "_" + Villageid + "_buildSlotBuildingFreeTime", Tasktime.toString());
								//flag("getBuildCompletionTimesFromDorf1Or2(" + Villageid + "):: building is building, will return milsec= "
								//		+ Tasktime.toString());
								//var d = new Date(Tasktime);
								//flag("next task begin from " + d);
								return Tasktime;
								break;
							case allString:
								GM_setValue(myacc() + "_" + Villageid + "_buildSlotFreeTime", Tasktime.toString());
								//flag("getBuildCompletionTimesFromDorf1Or2(" + Villageid + "):: something is building, will return milsec= "
								//		+ Tasktime.toString());
								//var d = new Date(Tasktime);
								//flag("next task begin from " + d);
								return Tasktime;
								break;
						}
					}
				}
			}
			if ( testttt == 0 || // no building of the kind specified is building
				( testttt == 1 && // 1 building of the kind specified is building & double build is enabled
					plusDoubleBuildEnabled == true ) 
				) {
				//flag("getBuildCompletionTimesFromDorf1Or2():: Villageid: " + Villageid + ", workers are available for work.");
				Tasktime = getRandomizedTime(10*1000, 2*60*1000); // delay by 10 secs + random ( 2 mins )
				flag ( "getBuildCompletionTimesFromDorf1Or2():: Build Slot Free Time: " + new Date(Tasktime) );
				switch (str) {
					case allsourceString:
						GM_setValue(myacc() + "_" + Villageid + "_buildSlotResourceFreeTime", Tasktime.toString());
						//flag("getBuildCompletionTimesFromDorf1Or2(" + Villageid + "):: resource will build soon, will return milsec= " + Tasktime.toString());
						return Tasktime;
						break;
					case allbuildString:
						GM_setValue(myacc() + "_" + Villageid + "_buildSlotBuildingFreeTime", Tasktime.toString());
						//flag("getBuildCompletionTimesFromDorf1Or2(" + Villageid + "):: building will build soon, will return milsec= " + Tasktime.toString());
						return Tasktime;
						break;
					case allString:
						GM_setValue(myacc() + "_" + Villageid + "_buildSlotFreeTime", Tasktime.toString());
						//flag("getBuildCompletionTimesFromDorf1Or2(" + Villageid + "):: something will build soon, will return milsec=" + Tasktime.toString());
						return Tasktime;
						break;
				}
			}
		}
		else { // when nothing is building
			//TS_debug("getBuildCompletionTimesFromDorf1Or2():: Villageid: " + Villageid + ", nothing is building, workers are available for work.");
			Tasktime = getRandomizedTime(10*1000, 2*60*1000); // delay by 10 secs + random ( 2 mins )
			flag ( "getBuildCompletionTimesFromDorf1Or2():: Build Slot Free Time: " + new Date(Tasktime) );
			switch (str) {
				case allsourceString:
					GM_setValue(myacc() + "_" + Villageid + "_buildSlotResourceFreeTime", Tasktime.toString());
					//flag("getBuildCompletionTimesFromDorf1Or2(" + Villageid + "):: resource will build soon, will return milsec=" + Tasktime.toString());
					return Tasktime;
					break;
				case allbuildString:
					GM_setValue(myacc() + "_" + Villageid + "_buildSlotBuildingFreeTime", Tasktime.toString());
					//flag("getBuildCompletionTimesFromDorf1Or2(" + Villageid + "):: building will build soon, will return milsec=" + Tasktime.toString());
					return Tasktime;
					break;
				case allString:
					GM_setValue(myacc() + "_" + Villageid + "_buildSlotFreeTime", Tasktime.toString());
					//flag("getBuildCompletionTimesFromDorf1Or2(" + Villageid + "):: something will build soon, will return milsec=" + Tasktime.toString());
					return Tasktime;
					break;
			}
		}
		return false;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getBuildCompletionTimesFromDorf1Or2():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// This function opens up the dorf1.php page and finds and sets the following...
// 1) current crop remain (crop production - crop consumption, _CorpRemain) (used by auto resource)
// 2) min level resource id (_minLevelId) and min level crop id (_minLevelCropId) which should be used for next upgrade (used by auto resource)
// 3) _buildSlotResourceFreeTime, _buildSlotBuildingFreeTime, _buildSlotFreeTime (updated with when current build will complete, or if nothing is building then to current time)
// This function does not calculate _ResourceUpdataTime, _BuildingUpdataTime, _UpdataTime based on current res production & current res level 
function startBuildOrSetTime(Villageid, str) {
	try {
		flag ( "startBuildOrSetTime():: Started! Villageid: " + Villageid );

		function callback() {};

		var turl = myhost + "/dorf1.php?newdid=" + Villageid;
		var getDelayTime = new XMLHttpRequest();
		getDelayTime.open('GET', turl, false);
		getDelayTime.onreadystatechange = callback;
		getDelayTime.send(null);
		function callback(){
			if (getDelayTime.readyState == 4) {
				if (getDelayTime.status == 200) {
					TS_debug("startBuildOrSetTime callback here!");

					var aElem = document.createElement('DIV');
					aElem.innerHTML = getDelayTime.responseText;
					if ( gatherStats(aElem.innerHTML) ) {
						// attempt reloading page, captcha ll be found there too and script will stop.
						window.location.replace(myhost + "/spieler.php");
						return 60*60*1000;
					}
					refreshPageInfo(aElem);
					collectAutoResDataFromDorf1(Villageid, aElem);
					return getBuildCompletionTimesFromDorf1Or2(Villageid, str, aElem );
				}
			}
		}
		return callback();
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startBuildOrSetTime():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function refreshMapData(map,vi, m) {
	try {
		//TS_debug("refreshMapData():: Started!");
		
		var areas = map.areas;
		var buildData = getCookie("BuildingData",vi);
		if ( !buildData ) buildData = new Array();
		for ( var i = 0; i < areas.length; i++ ) {
			var bTitle = "";
			switch ( aTravianVersion ) {
				case "3.6": bTitle = areas[i].title.replace(/\n/g,""); break;
				case "4.0": bTitle = areas[i].alt.replace(/\n/g,""); break;
				default: throwLogicError ( "refreshMapData():: Travian Version not set!!" );
			}
			var href = areas[i].href;
			if ( href.indexOf("build.php") != -1 && href.match(/\bid=/) != null ) { // Village Center does not point to a building;
				
				var id = areas[i].href.match(/\bid=\d{1,}\b/)[0].split("id=")[1]; // sometimes href has newdid after id, eg id=19&newdid=****
				var b = buildData[id];
				var ts = bTitle.split(" ");
				var level = parseInt(ts[ts.length-1]);
				var bName = ts.slice(0,ts.length -2).join(" ");

				var gid = getGidFromName(bName);

				// id = 39 is rally point, id = 26 is main building, id = 40 is city wall, earth wall, palisade
				if ( id == 39 || id == 26 || id == 40 ) {
					if ( isNaN ( level ) )
						level = 0;
					if ( id == 39 ) // rally point
						gid = 16;
					else if ( id == 26 ) // main building
						gid = 15;
					else if ( id == 40 ) // city wall (31), earth wall (32), palisade (33)
						gid = 31 + parseInt ( GM_getValue ( myacc() + "_raceID", "0" ) );
					if ( level == 0 )
						bName = aLangAllBuildAltWithId[gid];
					else if ( bName != aLangAllBuildAltWithId[gid] ) {
						flag ( "refreshMapData():: i: " + i + ", bName: " + bName + ", gid: " + gid + ", id: " + id + ", level: " + level );
						printErrorMSG ( "<b>ERROR:: Translation required for '" + bName + "' from tool-tip on dorf1.php or dorf2.php.</b>", 1 );
					}
				}

				//flag ( "refreshMapData():: i: " + i + ", bName: " + bName + ", gid: " + gid + ", id: " + id + ", level: " + level );
				//flag ( "refreshMapData():: b.gid: " + b.gid + ", b.level: " + b.level + ", b.name: " + b.name );

				// when gid does not exist, but bName is not empty string, we probably need translation
				// for some langs aLangAllBuild(Alt)WithId[4] is set to construction site
				if ( !gid && bName != "" && !( bName == aLangAllBuildAltWithId[4] || bName == aLangAllBuildWithId[4] ) ) {
					if ( ( m == 2 && id != 40 ) || level ) { // in dorf2 id = 40 is city wall, earth wall or palisade
						flag ( "refreshMapData():: i: " + i + ", bName: " + bName + ", gid: " + gid + ", id: " + id + ", level: " + level );
						printErrorMSG ( "<b>ERROR:: Translation required for '" + bName + "' from tool-tip on dorf1.php or dorf2.php.</b>", 1 );
					}
				}

				if ( !b )
					b = { gid: 0, level: 0, name: "" };
				
				//This is for construction site
				if ( !gid || bName == "" ) {
					gid = 0;
					level = 0;
					bName = bTitle;
				}
				
				//if we couldn't find the building type 
				//if ( b.gid == 0 || b.gid == gid ) {
					b.gid = gid;
					b.level = level;
					b.name = bName;
				/*}
				else {
					flag(bName + " should have gid = " + b.gid + " but no gid could be found");
				}*/
				buildData[id] = b;
			}
		}
		setCookie("BuildingData",buildData,vi);
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>refreshMapData():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function refreshDorf2MapData(aElem,vi)
{
	switch ( aTravianVersion ) {
		case "3.6": refreshMapData($("map2",aElem),vi,2); break;
		case "4.0": refreshMapData($("clickareas",aElem),vi,2); break;
		default: throwLogicError ( "refreshDorf2MapData():: Travian Version not set!!" );
	}
}

function refreshDorf1MapData(aElem,vi)
{
	//TS_debug("refreshDorf1MapData():: Started!");
	refreshMapData($("rx",aElem),vi,1)
}

//
//
// 
function refreshBuildingState(aElem,vi) {
	try {
		//TS_debug("refreshBuildingState():: Started! vi: " + vi);
		var bContract = $("building_contract",aElem);
		var cBuilding = 0;
		var cFields = 0;
		var tBuilding = 0;
		var tFields = 0;
		var buildingList = new Array();

		if(bContract) //something is building
		{
				allBuilds = $g("./tbody/tr",XPOrdList, bContract);
				for(var i=0;i< allBuilds.snapshotLength; i++)
				{
					var thisBuild = allBuilds.snapshotItem(i);
					
					var buildName = $g("./td[2]",XPFirst,thisBuild);
					var level = 0;
					switch ( aTravianVersion ) {
						case "3.6":
							var tSplit = buildName.textContent.split(" (");
							buildName = tSplit[0];
							tSplit = tSplit[1].split(" ");
							tSplit = tSplit[1].slice(0,tSplit[1].length -1);
							level = parseInt(tSplit);
							//TS_debug("cur building level = " + tSplit);
							break;
						case "4.0":
							var tSplit = buildName.textContent.replace(/[ ]{1,}/g," ").split(" ");
							buildName = tSplit.slice(0,tSplit.length-2).join(" ");
							level = parseInt(tSplit[tSplit.length-1]);
							break;
						default:
							throwLogicError ( "refreshBuildingState():: Travian Version not set!!" );
					}
					var timer = $g('./td//span[contains(@id,"timer")]',XPFirst,thisBuild);
					//var timer = $("timer"+(i+1), thisBuild); // sometimes timers do not follow strict numbering order in id
					var ttar = timer.textContent.split(":");
					//flag ( "refreshBuildingState():: ttar: " + ttar );
					var t = Number(ttar[0])*60*60*1000 + Number(ttar[1])*60*1000 + ttar[2]*1000;
					var building = {};
					building.time = new Date().getTime() + t;
					building.name = buildName;
					building.level = level;
					building.gid = getGidFromName(buildName);
					building.type = 0;
					if ( allsourceString.indexOf(buildName) != -1 ) {
						cFields++;
						tFields = Math.max(tFields,t);
						building.type = BuildType.field;

					}
					else if ( allbuildString.indexOf(buildName) != -1 ) {
						cBuilding++;
						tBuilding = Math.max(tBuilding,t);
						building.type = BuildType.building;
					}
					else {
						flag ( "refreshBuildingState():: allsourceString: " + allsourceString );
						flag ( "refreshBuildingState():: allbuildString: " + allbuildString );
						throwLogicError ( "refreshBuildingState():: '" + buildName + "' is not part of either allsourceString or allbuildString,"
								+ " probably translation is required!" );
						cBuilding++;
						tBuilding = Math.max(tBuilding,t);
					}
					buildingList.push(building);
				}
		}
		// this is to disable double build during cropError, warehouseError or granaryError
		for ( var ctr = 0 ; ctr < buildingList.length ; ctr++ ) {
			if ( parseInt(buildingList[ctr].gid) == 4 
					&& GM_getValue(myacc() + "_" + vi + "_cropError", "0" ) == "1" // if cropError and crop-land is currently building
					&& GM_getValue(myacc() + "_" + vi + "_cropErrorElapseTime", "0") == "0" ) {
				GM_setValue(myacc() + "_" + vi + "_cropErrorElapseTime", buildingList[ctr].time.toString() ); // set time when crop build will finish
			}
			else if ( ( parseInt(buildingList[ctr].gid) == 10 
						|| parseInt(buildingList[ctr].gid) == 38 ) // if warehouseError and warehouse or great-warehouse is currently building
					&& GM_getValue(myacc() + "_" + vi + "_warehouseError", "0" ) == "1" 
					&& GM_getValue(myacc() + "_" + vi + "_warehouseErrorElapseTime", "0" ) == "0" ) {
				GM_setValue(myacc() + "_" + vi + "_warehouseErrorElapseTime", buildingList[ctr].time.toString() ); // set time when warehouse build will finish
			}
			else if ( ( parseInt(buildingList[ctr].gid) == 11 
						|| parseInt(buildingList[ctr].gid) == 39 ) // if granaryError and granary or great-granary is currently building
					&& GM_getValue(myacc() + "_" + vi + "_granaryError", "0" ) == "1" 
					&& GM_getValue(myacc() + "_" + vi + "_granaryErrorElapseTime", "0" ) == "0" ) {
				GM_setValue(myacc() + "_" + vi + "_granaryErrorElapseTime", buildingList[ctr].time.toString() ); // set time when granary build will finish
			}
		}
		setCookie("BuildingTimeList",buildingList,vi );
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>refreshBuildingState():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getDorf1(vill, callback)
{
	flag("Starting getDorf1");
	var turl = myhost + "/dorf1.php?newdid=" + vill;
	TS_getRequest(turl,callback);
}

function getDorf2(vill, callback)
{
	flag("Starting getDorf2");
	var turl = myhost + "/dorf2.php?newdid=" + vill;
	TS_getRequest(turl,callback);
}


//Will return the next time a building slot will be freed.
// if there is already a free building slot it will return 0
function getNextBuildTime(vi,type,doubleBuild)
{
	if(!type) type =BuildType.all;
	if(!doubleBuild) doubleBuild = false;
	var bl = getCookie("BuildingTimeList",vi);
	if(!bl)
	{
		return false;
	}
		
	var bt = doubleBuild? Infinity: -Infinity;
	var bc = 0;
	for(var i=0; i<bl.length;i++)
	{
		var b = bl[i];
		if(type == BuildType.all || type == b.type)
		{
			if(doubleBuild) bt = Math.min(b.time,bt); //get the fastest as this is when a slot will be freed
			else bt = Math.max(b.time, bt);
			
			bc++;
		}
		else {
			try {
				TS_debug(JSON.stringify(b)); 
			}
			catch (e) {
				TS_debug(uneval(b)); 
			}
		}
	}

	if(bc == 0 || (bc == 1 && doubleBuild))
	{
		return 0;
	}
	else
	{
		return bt + 1000; //todo randomize?
	}
}

//
// Process All build task for a village.
// It will only process the first build task for each build type.
// For teuton and gaul all build are considered the same type.
function processBuildTasks(vi)
{
	taskList = GM_getValue(myacc() + "_" + vi + "_waitTask", "false");
	allTasks = taskList.split("|");
	for(var i =0; i< allTasks.length;i++){
		allTasks[i] = allTasks[i].split("_");
	}
	var raceId = parseInt(GM_getValue(myacc() + "_raceID", "0" ));
	if(raceId == 0){ //roman building
		var fieldTasks = allTasks.filter(
			function(x){	
				if((x[0] == "0" || x[0] == "1") && getBuildType(parseInt(x[1])) == BuildType.field)
					return true;
				else
				 return false;
		});
		
		if(fieldTasks.length > 0){
			if(canExecuteBuildTask(vi,fieldTasks[0])){
				startBuildNow2(vi,fieldTasks[0]);
				return true; //one operation per loop
			}
		}
		
		var buildingTasks = allTasks.filter(
			function(x){	
				if((x[0] == "0" || x[0] == "1") && getBuildType(parseInt(x[1])) == BuildType.building)
					return true;
				else
				 return false;
		});
		
		if(buildingTasks.length > 0)
		{
			if(canExecuteBuildTask(vi,buildingTasks[0]))
			{
				startBuildNow2(vi,buildingTasks[0]);
				return true; //one operation per loop
			}
		}
	}
	else // other building
	{
		var buildTasks = allTasks.filter(
			function(x){	
				if((x[0] == "0" || x[0] == "1"))
					return true;
				else
				 return false;
		});
		
		if(buildTasks.length > 0){
			if(canExecuteBuildTask(vi,buildTasks[0])){
				startBuildNow2(vi,buildTasks[0]);
				return true;
			}
			
		} /*else {
			TS_debug("no build task found");
		}*/
	}
	
	return false;
}

//given a building id it will return the type
function getBuildType(id)
{
	var type;
	if(id == 50) { // AutoResource
		type = BuildType.field;
	}
	else if(id >0 && id < 19){
		type = BuildType.field;
	} else if(id >= 19 && id <=42) {
		type = BuildType.building;
	} else {
		TS_debug("unknown build type with id: " + id);
		type = BuildType.all;
	}
	return type;
}

//verify that the task can be processed based on various factors

function canExecuteBuildTask(vi,task)
{
	switch(task[0])
	{
		case "0":
			return canExecuteUpgradeTask(vi,task);
			break;
		case "1":
			return canExecuteNewTask(vi,task);
		default:
			TS_debug("task[0] is wrong:" + task[0]);
	}
}

//
//
//
function canExecuteNewTask(vi,task)
{
	var id = parseInt(task[1]);
	var gid = parseInt(task[3]);
	var mapdata = getCookie("BuildingData",vi);
	if(!mapdata) mapdata = new Array();
	var bData = mapdata[id];
	if(!bData)
	{
		TS_debug("no information gathered yet");
		return true;
	}
	else if ( bData.gid == 0) // nothing is building
	{
		return true;
	}
	else if(bData.gid == gid) // building is already there.
	{
		//TODO: switch task to an upgrade task
		return false;
	}
	else
	{
		//Error, another building is already present
		// Delete the task?
		return false;
	}
}

//Verify that upgrade tasks can be processed based on the following factor:
// Building in progress
// UpgradeType Paused
// 
function canExecuteUpgradeTask(vi,task)
{
	var ready = true;
	var raceId = parseInt(GM_getValue(myacc() + "_raceID", "0" ));
	var now = new Date().getTime();
	var id = parseInt(task[1]);
	
	type = getBuildType(id);
	if ( getVillageOption( "PAUSE_RESOURCE_UPGRADES", 0, "integer", vi ) == 1 && type == BuildType.field ) {
				//flag("canExecuteUpgradeTask():: All Resource Upgrades has been Paused hence pausing Roman Resource / AutoResource Upgrade!");
				return false;
	}
	
	if ( getVillageOption( "PAUSE_BUILDING_UPGRADES", 0, "integer", vi ) == 1 && type == BuildType.building) {
		//flag("canExecuteUpgradeTask():: All Building Upgrades has been Paused hence pausing Roman Building / NewBuilding Upgrade!");
			return false;
	}
	if(raceId != 0) type = 0; // non-roman
	
	var t = getNextBuildTime(vi,type); //todo randomize
	
	if(t && t > now) {
		//TS_debug("Construction in progress. Ends at " + new Date(t));
		return false;
	}
	var res = getEstimatedResources(vi);
	var mapdata = getCookie("BuildingData",vi);
	if(!mapdata) mapdata = new Array();
	
	if(id == 50)
	{
		id = getAutoResourceId(vi);
	}

	var bData = mapdata[id];
	if(bData && bData.level != 0 && bData.gid != 0)
	{
		if(bData.level >= parseInt(task[2]))
		{
			TS_debug(bData.name + " is level " + bData.level + " requested " + task[2]);
			deleteTaskFromCookie(vi,task);
			return false;
		} 
		//TS_debug("Vi=" + vi+" gid="+bData.gid+" lvl="+bData.level);
		var cost = bCost[bData.gid][bData.level+1];

		if(cost[0] > res[0] || cost[1] > res[1] || cost[2] > res[2] || cost[3] > res[3])
		{
			//TS_debug("Not enough resources: cost=["+cost+"], res=["+res+"]");
			return false;
		}
	}
	else
	{
			TS_debug("not enough data to determine if we can build for id" +id);
	}
	
	var upT = 0;
	switch(type)
	{
		case 0:
			upT = parseInt ( GM_getValue(myacc() + "_" + vi + "_UpdataTime", "0") );
			break;
		case 1:
			upT = parseInt ( GM_getValue(myacc() + "_" + vi + "_ResourceUpdataTime", "0") );
			break;
		case 2:
			upT = parseInt ( GM_getValue(myacc() + "_" + vi + "_BuildingUpdataTime", "0") );
			break;
		default:
			TS_debug("type is wrong: " + type);
	}

	if(upT > now)
	{
		//TS_debug("cannot process task for " + getvillagefromdid(vi) + " because it was forcibly delayed until " + new Date(upT));
		return false;
	}
	return true;
}

/*function getBuildLevel(vi,id)
{
	var level = 0;
	var bData = getCookie("BuildingData",vi);
	if(bData) level = bData.level;
	return level;
}*/

function startBuildNow2(vill,thisTask)
{
	calldoing0();
	var id = parseInt(thisTask[1]);
	var originalTask = thisTask.slice(0);
	
	if(thisTask[0] == "0" && id == 50)
	{
		var resId = getAutoResourceId(vill);
		thisTask[1] = resId;
		id = resId;
	}

	b = getthebuildUrl(vill, thisTask);
	var buildTimeStr;
	var raceid =  GM_getValue(myacc() + "_raceID", "3");
	
	var type;
	
	if(raceid == "0"){ //romans
		type = getBuildType(id);
		if(type == BuildType.field){
			buildTimeStr = "_ResourceUpdataTime";
		} else if(type == BuildType.building){
			buildTimeStr = "_BuildingUpdataTime";
		}
		else { TS_debug("Error: Unknown build type..."); buildTimeStr = "_BuildingUpdataTime"; }
		
	} else {
		type = BuildType.all;
		var buildTimeStr = "_UpdataTime";
	}
	
	if (b) {
		// v_kir 2010.01.24
		//buildurl = myhost + "/" + b
		buildurl = b;
		// v_kir 2010.01.24
		thislevel = parseInt(GM_getValue(myacc() + "_" + vill + "_crtBuildlevel")) + 1;
		TS_debug("start HttpRequire() now for construction.");
		window.setTimeout ( 
			function() { 
				HttpRequire(buildurl, vill, thisTask, type.toString(), thislevel);
				buildurl=null; vill=null; thisTask=null; type=null; thislevel=null;
				},
				Math.ceil ( Math.random() * 1000 ) + 1000 ); // random ( 1 seconds ) + 1 seconds
	}
	else if ( getErrorInfor().indexOf(aLangErrorText[8]) != -1 ) { // error: lack of food, extend crop land first.
		GM_deleteValue(myacc() + "_" + vill + buildTimeStr);
		addCropTaskAtTop(vill);
		calldoing1();
		showTaskList();
		printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: " + getErrorInfor());

		window.setTimeout ( reloadLoginWindow, Math.ceil ( Math.random() * 1*60*1000 + 1*60*1000 ) ); // random ( 1 sec ) + 1 sec
	}
	else if ( getErrorInfor().indexOf("Resource/Building already at required (or above) level, hence not upgrading!") != -1 ) {
		//GM_deleteValue(myacc() + "_" + vill + "_BuildingUpdataTime");
		deleteTaskFromCookie(vill, originalTask);
		calldoing1();
		showTaskList();

	}
	// error: Construction completed, ie all levels built.
	else if ( getErrorInfor().indexOf(aLangErrorText[2]) != -1 ) {
		//GM_deleteValue(myacc() + "_" + vill + "_BuildingUpdataTime");
		deleteTaskFromCookie(vill, originalTask);
		calldoing1();
		showTaskList();
	}
	// error: too few resources (aLangErrorText[0]) && enough resources later (aLangErrorText[7])
	else if ((getErrorInfor().indexOf(aLangErrorText[0]) != -1) || (getErrorInfor().indexOf(aLangErrorText[7]) != -1)) {
		TS_debug("level calculation failed. This code path should not occur");
		delayUpgrade(vill, buildTimeStr);
		calldoing1();
		showTaskList();
	}
	else { // any other errors
	
		TS_debug("build error for " + vill + " is " + getErrorInfor());
		GM_deleteValue(myacc() + "_" + vill + buildTimeStr);
		var type = getBuildType(id);
		var updateCB = getDorf1
		if(type == BuildType.building) {
				updateCB = getDorf2;
		}

		window.setTimeout(
			function() {
						updateCB(vill,
						function(){
							if(canExecuteBuildTask(vill, thisTask) )
							{
								TS_debug("Build Check for " + vill + " task: " + thisTask + " is incorrect");
								//our check still think we can build, but obviously we can't delay upgrade
								delayUpgrade(vill, buildTimeStr);
							}
							calldoing1();
							showTaskList();
						});
			},1000);
	}
}


/*
 * Error Chart for function startBuildnow()
 *possible errors                 | romans resource       | romans auto-resource          | romans buildings      | romans new build      | other race res/build  | other race auto-res           | other race new build
 *
 *lack of food                    | add crop              | add crop, should never happen | add crop              | add crop              | add crop              | add crop, should never happen | add crop
 *not construction page           |                       |                               |                       | change to upgrade     |                       |                               | change to upgrade
 *level already built             | delete task           |                               | delete task           |                       | delete task           | 
 *construction completed          | delete task           | close auto res                | delete task           |                       | delete task           | close auto res                | 
 *warehouse too small             | add wareh & delay     | add wareh & delay             | add wareh & delay     | add wareh & delay     | add wareh & delay     | add wareh & delay             | add wareh & delay
 *granary too small               | add gran & delay      | add gran & delay              | add gran & delay      | add gran & delay      | add gran & delay      | add gran & delay              | add gran & delay
 *too few resources               | delay                 | delay                         | delay                 | delay                 | delay                 | delay                         | delay
 *construction page found         | delete task           |                               | delete task           |                       | delete task           |                               | 
 *some other building             | delete task           |                               | delete task           |                       | delete task           |                               | 
 *building prerequisites not met  |                       |                               |                       | delete task           |                       |                               | delete task
 *the workers are already at work | reload lw             | reload lw                     | reload lw             | reload lw             | reload lw             | reload lw                     | reload lw
 *
 *default (those not handled)     | reload lw             | reload lw                     | reload lw             | reload lw             | reload lw             | reload lw                     | reload lw
 *
 */

function startBuildnow(vill, kind) {
	try {
		//flag ( "startBuildnow():: Started! vill: " + vill + ", kind: " + kind );
		whatever = GM_getValue(myacc() + "_" + vill + "_waitTask", "false");
		allTasks = whatever.split("|");
		switch (kind) {
			case "0": // [Romans Resources]
				if ( getVillageOption( "PAUSE_RESOURCE_UPGRADES", 0, "integer", vill ) == 1 && GM_getValue(myacc() + "_" + vill + "_cropError", "0" ) == "0" ) {
					//flag("startBuildnow():: All Resource Upgrades has been Paused hence pausing Roman Resource / AutoResource Upgrade!");
					break;
				}
				var t = "0";
				for (nnn in allTasks) {
					thisTask = allTasks[nnn].split("_");
					if (thisTask[0] == "0" && thisTask[1] < 19) { // iterate over all tasks but do only for 1st resource tasks.
						calldoing0();
						t = "1";	// a resource task has been found.
						flag ( "startBuildnow():: launching getthebuildUrl()..." );
						b = getthebuildUrl(vill, thisTask);
						if (b) {
							buildurl = b;
							thislevel = parseInt(GM_getValue(myacc() + "_" + vill + "_crtBuildlevel")) + 1; // get current building level + 1
							TS_debug("start HttpRequire() now for romans resource upgrade.");
							window.setTimeout ( 
								function() { 
									HttpRequire(buildurl, vill, thisTask, kind, thislevel);
									buildurl=null; vill=null; thisTask=null; kind=null; thislevel=null;
									},
									Math.ceil ( Math.random() * 5000 ) + 1000 ); // random ( 5 seconds ) + 1 seconds
							break;
						}
						else if ( getErrorInfor().indexOf(aLangErrorText[8]) != -1 ) { // error: lack of food, extend crop land first.
							if ( GM_getValue(myacc() + "_" + vill + "_cropError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_ResourceUpdataTime");	// keep delaying till problem resolves
							addCropTaskAtTop(vill);
							GM_setValue(myacc() + "_" + vill + "_cropError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						else if ( getErrorInfor().indexOf("Resource/Building already at required (or above) level, hence not upgrading!") != -1 ) {
							printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							deleteTaskFromCookie(vill, thisTask);
							calldoing1();
							showTaskList();
							break;
						}
						// error: Construction completed, ie all levels built.
						else if ( getErrorInfor().indexOf(aLangErrorText[2]) != -1 ) { 
							printMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							deleteTaskFromCookie(vill, thisTask);
							calldoing1();
							showTaskList();
							break;
						}
						else if (getErrorInfor().indexOf(aLangErrorText[5]) != -1 ) { // error: warehouse is too small
							if ( GM_getValue(myacc() + "_" + vill + "_warehouseError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_ResourceUpdataTime");	// keep delaying till problem resolves
							addBuildingTaskAtTop(vill, "10");
							GM_setValue(myacc() + "_" + vill + "_warehouseError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						else if (getErrorInfor().indexOf(aLangErrorText[6]) != -1 ) { // error: granary is too small
							if ( GM_getValue(myacc() + "_" + vill + "_granaryError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_ResourceUpdataTime");	// keep delaying till problem resolves
							addBuildingTaskAtTop(vill, "11");
							GM_setValue(myacc() + "_" + vill + "_granaryError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						// error: too few resources (aLangErrorText[0]) && enough resources later (aLangErrorText[7])
						else if ( ( getErrorInfor().indexOf ( aLangErrorText[0] ) != -1 ) || ( getErrorInfor().indexOf ( aLangErrorText[7] ) != -1 ) ) {
							delayUpgrade(vill,"_ResourceUpdataTime");
							calldoing1();
							showTaskList();
							break;
						}
						else if ( ( getErrorInfor().indexOf ( "Construction page found, cannot upgrade!" ) != -1 ) || 
								( getErrorInfor().indexOf ( "Some other building/resource found, cannot upgrade!" ) != -1 ) ) {
							printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							deleteTaskFromCookie(vill, thisTask);
							calldoing1();
							showTaskList();
							break;
						}
						// error: The workers are already at work or any other error 
						//else if ( (getErrorInfor() == aLangErrorText[1]) )
						else {
							GM_deleteValue(myacc() + "_" + vill + "_resRequiredForResUpgrade");
							GM_deleteValue(myacc() + "_" + vill + "_ResourceUpdataTime");
							GM_deleteValue(myacc() + "_" + vill + "_buildSlotResourceFreeTime");
							// newdid is not required as getTaskCookies() refreshes stats for 
							// all villages whose stats are not set. This will set when to attempt build again.
							window.setTimeout ( function () {
										getTaskCookies();
										calldoing1();
									},
									Math.ceil ( Math.random() * 5*1000 + 1*1000 ) ); // random ( 5 sec ) + 1 sec
							break;
						}
						break; // a resource task has been found, now break away from for loop
					}
					else if (thisTask[0] == "0" && thisTask[1] == 50) { // [Romans autoResource]
						calldoing0();
						t = "1";	// a resource task has been found
						var resId = getAutoResourceId(vill);
						thisTask[1] = resId;
						b = getthebuildUrl(vill, thisTask);
						if (b) {
							buildurl = b;
							thislevel = parseInt(GM_getValue(myacc() + "_" + vill + "_crtBuildlevel")) + 1;
							TS_debug("start HttpRequire() now for romans auto resource.");
							window.setTimeout ( 
								function() { 
									HttpRequire(buildurl, vill, thisTask, kind, thislevel);
									buildurl=null; vill=null; thisTask=null; kind=null; thislevel=null;
									},
									Math.ceil ( Math.random() * 5000 ) + 1000 ); // random ( 5 seconds ) + 1 seconds
							break;
						}
						else if ( getErrorInfor().indexOf(aLangErrorText[8]) != -1 ) { // error: lack of food, extend crop land first.
							// this should never happen for auto-resource
							if ( GM_getValue(myacc() + "_" + vill + "_cropError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: (Auto-Resoruce) id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_ResourceUpdataTime");	// keep delaying till problem resolves
							addCropTaskAtTop(vill);
							GM_setValue(myacc() + "_" + vill + "_cropError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						// error: construction completed
						else if (getErrorInfor().indexOf(aLangErrorText[2]) != -1) {
							printMSG(getvillagefromdid(vill) + "("+vill+"):: (Auto-Resoruce) id: " + thisTask[1] + ", " + getErrorInfor());
							deleteAutoResTask(vill);
							calldoing1();
							showTaskList();
							break;
						}
						else if (getErrorInfor().indexOf(aLangErrorText[5]) != -1 ) { // error: warehouse is too small
							if ( GM_getValue(myacc() + "_" + vill + "_warehouseError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: (Auto-Resoruce) id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_ResourceUpdataTime");	// keep delaying till problem resolves
							addBuildingTaskAtTop(vill, "10");
							GM_setValue(myacc() + "_" + vill + "_warehouseError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						else if (getErrorInfor().indexOf(aLangErrorText[6]) != -1 ) { // error: granary is too small
							if ( GM_getValue(myacc() + "_" + vill + "_granaryError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: (Auto-Resoruce) id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_ResourceUpdataTime");	// keep delaying till problem resolves
							addBuildingTaskAtTop(vill, "11");
							GM_setValue(myacc() + "_" + vill + "_granaryError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						// error: too few resources (aLangErrorText[0]) && enough resources later (aLangErrorText[7])
						else if ((getErrorInfor().indexOf(aLangErrorText[0]) != -1 ) || (getErrorInfor().indexOf(aLangErrorText[7]) != -1)) {
							delayUpgrade(vill, "_ResourceUpdataTime");
							calldoing1();
							showTaskList();
							break;
						}
						// error: The workers are already at work or any other error 
						//else if ( (getErrorInfor() == aLangErrorText[1]) )
						else {
							GM_deleteValue(myacc() + "_" + vill + "_resRequiredForResUpgrade");
							GM_deleteValue(myacc() + "_" + vill + "_ResourceUpdataTime");
							GM_deleteValue(myacc() + "_" + vill + "_buildSlotResourceFreeTime");
							// newdid is not required as getTaskCookies() refreshes stats for 
							// all villages whose stats are not set. This will set when to attempt build again.
							window.setTimeout ( function() {
										getTaskCookies();
										calldoing1();
									},
									Math.ceil ( Math.random() * 5*1000 + 1*1000 ) ); // random ( 5 sec ) + 1 sec
							break;
						}
						break;
					}
				} // end of for iterating over all tasks
				if (t == "0") {
					GM_deleteValue(myacc() + "_" + vill + "_resRequiredForResUpgrade");
					GM_deleteValue(myacc() + "_" + vill + "_ResourceUpdataTime");
					GM_setValue(myacc() + "_" + vill + "_ResourceTaskExists", "0");
					TS_debug("No resource task found, deleting ResourceUpdataTime in startBuildnow()");
					calldoing1();
					showTaskList();
					return false; // nothing has been executed
				}
				else
					return true; // something has been executed
				break; // break for case "0"

			case "1": // [Romans Buildings]
				if ( getVillageOption( "PAUSE_BUILDING_UPGRADES", 0, "integer", vill ) == 1 
						&& GM_getValue(myacc() + "_" + vill + "_warehouseError", "0" ) == "0"
				  		&& GM_getValue(myacc() + "_" + vill + "_granaryError", "0" ) == "0" ) {
					//flag("startBuildnow():: All Building Upgrades has been Paused hence pausing Roman Building / NewBuilding Upgrade!");
					break;
				}
				var t = "0";
				for (nnn in allTasks) {
					thisTask = allTasks[nnn].split("_");
					if (thisTask[0] == "0" && thisTask[1] > 18 && thisTask[1] < 42) { // [Romans Building Upgrades]
						calldoing0();
						t = "1";
						b = getthebuildUrl(vill, thisTask);
						if (b) {
							buildurl = b;
							thislevel = parseInt(GM_getValue(myacc() + "_" + vill + "_crtBuildlevel")) + 1;
							TS_debug("start HttpRequire() now for romans building upgrade.");
							window.setTimeout ( 
								function() { 
									HttpRequire(buildurl, vill, thisTask, kind, thislevel);
									buildurl=null; vill=null; thisTask=null; kind=null; thislevel=null;
									},
									Math.ceil ( Math.random() * 5000 ) + 1000 ); // random ( 5 seconds ) + 1 seconds
							break;
						}
						else if ( getErrorInfor().indexOf(aLangErrorText[8]) != -1 ) { // error: lack of food, extend crop land first.
							if ( GM_getValue(myacc() + "_" + vill + "_cropError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: " + getErrorInfor());
							delayUpgrade(vill,"_BuildingUpdataTime");	// keep delaying till problem resolves
							addCropTaskAtTop(vill);
							GM_setValue(myacc() + "_" + vill + "_cropError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						else if ( getErrorInfor().indexOf("Resource/Building already at required (or above) level, hence not upgrading!") != -1 ) {
							printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							deleteTaskFromCookie(vill, thisTask);
							calldoing1();
							showTaskList();
							break;
						}
						// error: Construction completed, ie all levels built.
						else if ( getErrorInfor().indexOf(aLangErrorText[2]) != -1 ) {
							printMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							deleteTaskFromCookie(vill, thisTask);
							calldoing1();
							showTaskList();
							break;
						}
						else if (getErrorInfor().indexOf(aLangErrorText[5]) != -1 ) { // error: warehouse is too small
							if ( GM_getValue(myacc() + "_" + vill + "_warehouseError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_BuildingUpdataTime");	// keep delaying till problem resolves
							addBuildingTaskAtTop(vill, "10");
							GM_setValue(myacc() + "_" + vill + "_warehouseError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						else if (getErrorInfor().indexOf(aLangErrorText[6]) != -1 ) { // error: granary is too small
							if ( GM_getValue(myacc() + "_" + vill + "_granaryError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_BuildingUpdataTime");	// keep delaying till problem resolves
							addBuildingTaskAtTop(vill, "11");
							GM_setValue(myacc() + "_" + vill + "_granaryError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						// error: too few resources (aLangErrorText[0]) && enough resources later (aLangErrorText[7])
						else if ( ( getErrorInfor().indexOf ( aLangErrorText[0] ) != -1 ) || ( getErrorInfor().indexOf ( aLangErrorText[7] ) != -1 ) ) {
							delayUpgrade(vill, "_BuildingUpdataTime");
							calldoing1();
							showTaskList();
							break;
						}
						else if ( ( getErrorInfor().indexOf ( "Construction page found, cannot upgrade!" ) != -1 ) || 
								( getErrorInfor().indexOf ( "Some other building/resource found, cannot upgrade!" ) != -1 ) ) {
							printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							deleteTaskFromCookie(vill, thisTask);
							calldoing1();
							showTaskList();
							break;
						}
						// error: The workers are already at work or any other error 
						//else if ( (getErrorInfor() == aLangErrorText[1]) )
						else {
							GM_deleteValue(myacc() + "_" + vill + "_resRequiredForBldgUpgrade");
							GM_deleteValue(myacc() + "_" + vill + "_BuildingUpdataTime");
							GM_deleteValue(myacc() + "_" + vill + "_buildSlotBuildingFreeTime");
							// newdid is not required as getTaskCookies() refreshes stats for 
							// all villages whose stats are not set. This will set when to attempt build again.
							window.setTimeout ( function() {
										getTaskCookies();
										calldoing1();
									},
									Math.ceil ( Math.random() * 5*1000 + 1*1000 ) ); // random ( 5 sec ) + 1 sec
							break;
						}
						break;
					}
					else if (thisTask[0] == "1") { // [Romans New Building]
						calldoing0();
						t = "1";
						b = getthebuildUrl(vill, thisTask);
						if (b) {
							buildurl = b;
							thislevel = 1;
							TS_debug("start HttpRequire() now for romans new build.");
							window.setTimeout ( 
								function() { 
									HttpRequire(buildurl, vill, thisTask, kind, thislevel);
									buildurl=null; vill=null; thisTask=null; kind=null; thislevel=null;
									},
									Math.ceil ( Math.random() * 5000 ) + 1000 ); // random ( 5 seconds ) + 1 seconds
							break;
						}
						else if ( getErrorInfor().indexOf(aLangErrorText[8]) != -1 ) { // error: lack of food, extend crop land first.
							if ( GM_getValue(myacc() + "_" + vill + "_cropError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_BuildingUpdataTime");	// keep delaying till problem resolves
							addCropTaskAtTop(vill);
							GM_setValue(myacc() + "_" + vill + "_cropError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						else if (getErrorInfor().indexOf("newBuild can't run, something is here.") != -1) {
							printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							TS_debug("newBuild can't run, something is here. changed to upgrade");
							var changeToUP = thisTask.slice(0); // clone the array thisTask.
							changeToUP[0] = "0";
							changeToUP.splice(3,1); // remove the gid
							deleteTaskFromCookie(vill, thisTask, changeToUP);
							calldoing1();
							showTaskList();
							break;
						}
						else if (getErrorInfor().indexOf(aLangErrorText[5]) != -1 ) { // error: warehouse is too small
							if ( GM_getValue(myacc() + "_" + vill + "_warehouseError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_BuildingUpdataTime");	// keep delaying till problem resolves
							addBuildingTaskAtTop(vill, "10");
							GM_setValue(myacc() + "_" + vill + "_warehouseError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						else if (getErrorInfor().indexOf(aLangErrorText[6]) != -1 ) { // error: granary is too small
							if ( GM_getValue(myacc() + "_" + vill + "_granaryError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_BuildingUpdataTime");	// keep delaying till problem resolves
							addBuildingTaskAtTop(vill, "11");
							GM_setValue(myacc() + "_" + vill + "_granaryError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						else if ( getErrorInfor().indexOf ( "Make sure all pre-requisites for the building has been met!" ) != -1 ) {
							if ( getCurrentlyUpgradingFristBuildingGid(vill) ) { // when a building is currently being upgraded
								setBuildingPreRequisiteError(vill);
								GM_deleteValue(myacc() + "_" + vill + "_resRequiredForBldgUpgrade");
								GM_deleteValue(myacc() + "_" + vill + "_BuildingUpdataTime");
								GM_deleteValue(myacc() + "_" + vill + "_buildSlotBuildingFreeTime");
								// newdid is not required as getTaskCookies() refreshes stats for 
								// all villages whose stats are not set. This will set when to attempt build again.
								window.setTimeout ( function() {
											getTaskCookies();
											calldoing1();
										},
										Math.ceil ( Math.random() * 5*1000 + 1*1000 ) ); // random ( 5 sec ) + 1 sec
								break;
							}
							else { // when no building is currently being upgraded
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: Deleting new-build task! id: " + thisTask[1] +
										"(" + thisTask[5] + "), " + getErrorInfor());
								deleteTaskFromCookie(vill, thisTask); // delete the task
								calldoing1();
								showTaskList();
								break;
							}
						}	
						// error: too few resources (aLangErrorText[0]) && enough resources later (aLangErrorText[7])
						else if ( ( getErrorInfor().indexOf ( aLangErrorText[0] ) != -1 ) || ( getErrorInfor().indexOf ( aLangErrorText[7] ) != -1 ) ) {
							delayUpgrade(vill, "_BuildingUpdataTime");
							calldoing1();
							showTaskList();
							break;
						}
						// error: The workers are already at work or any other error 
						//else if ( (getErrorInfor() == aLangErrorText[1]) )
						else {
							GM_deleteValue(myacc() + "_" + vill + "_resRequiredForBldgUpgrade");
							GM_deleteValue(myacc() + "_" + vill + "_BuildingUpdataTime");
							GM_deleteValue(myacc() + "_" + vill + "_buildSlotBuildingFreeTime");
							// newdid is not required as getTaskCookies() refreshes stats for 
							// all villages whose stats are not set. This will set when to attempt build again.
							window.setTimeout ( function() {
										getTaskCookies();
										calldoing1();
									},
									Math.ceil ( Math.random() * 5*1000 + 1*1000 ) ); // random ( 5 sec ) + 1 sec
							break;
						}
						break;
					}
				} // end of for iterating over all tasks
				if (t == "0") {
					GM_deleteValue(myacc() + "_" + vill + "_resRequiredForBldgUpgrade");
					GM_deleteValue(myacc() + "_" + vill + "_BuildingUpdataTime");
					GM_setValue(myacc() + "_" + vill + "_BuildingTaskExists", "0");
					TS_debug("No building task found, deleting BuildingUpdataTime in startBuildnow()");
					calldoing1();
					showTaskList();
					return false; // nothing has been executed
				}
				else
					return true; // something has been executed
				break; // break for case "1"

			case "2": // [Other Races Resources/Buildings]
				var t = "0"
				for (nnn in allTasks) {
					thisTask = allTasks[nnn].split("_");
					if (thisTask[0] == "0" && thisTask[1] < 42) { // [Other Races Resources & Building Upgrades]
						if ( ( thisTask[1] < 19 || thisTask[1] > 41 ) 
								&& getVillageOption( "PAUSE_RESOURCE_UPGRADES", 0, "integer", vill ) == 1 
								&& GM_getValue(myacc() + "_" + vill + "_cropError", "0" ) == "0" ) {
							//flag("startBuildnow():: All Resource Upgrades has been Paused hence pausing Other Races "
							//		+"Resource Upgrade!");
							continue;
						}
						else if ( thisTask[1] > 18 && thisTask[1] <= 41 
								&& getVillageOption( "PAUSE_BUILDING_UPGRADES", 0, "integer", vill ) == 1 
								&& GM_getValue(myacc() + "_" + vill + "_warehouseError", "0" ) == "0"
						  		&& GM_getValue(myacc() + "_" + vill + "_granaryError", "0" ) == "0" ) {
							//flag("startBuildnow():: All Building Upgrades has been Paused hence pausing Other Races "
							//		+"Building Upgrade!"); 
							continue;
						}
						calldoing0();
						t = "1";
						b = getthebuildUrl(vill, thisTask);
						if (b) {
							buildurl = b;
							thislevel = parseInt(GM_getValue(myacc() + "_" + vill + "_crtBuildlevel")) + 1;
							TS_debug("start HttpRequire() now for other races resource/building upgrade.");
							window.setTimeout ( 
								function() { 
									HttpRequire(buildurl, vill, thisTask, kind, thislevel);
									buildurl=null; vill=null; thisTask=null; kind=null; thislevel=null;
									},
									Math.ceil ( Math.random() * 5000 ) + 1000 ); // random ( 5 seconds ) + 1 seconds
							break;
						}
						else if ( getErrorInfor().indexOf(aLangErrorText[8]) != -1 ) { // error: lack of food, extend crop land first.
							if ( GM_getValue(myacc() + "_" + vill + "_cropError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_UpdataTime");	// keep delaying till problem resolves
							addCropTaskAtTop(vill);
							GM_setValue(myacc() + "_" + vill + "_cropError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						else if ( getErrorInfor().indexOf("Resource/Building already at required (or above) level, hence not upgrading!") != -1 ) {
							printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							deleteTaskFromCookie(vill, thisTask);
							calldoing1();
							showTaskList();
							break;
						}
						// error: Construction completed, ie all levels built.
						else if ( getErrorInfor().indexOf(aLangErrorText[2]) != -1 ) { 
							printMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							deleteTaskFromCookie(vill, thisTask);
							calldoing1();
							showTaskList();
							break;
						}
						else if (getErrorInfor().indexOf(aLangErrorText[5]) != -1 ) { // error: warehouse is too small
							if ( GM_getValue(myacc() + "_" + vill + "_warehouseError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_UpdataTime");	// keep delaying till problem resolves
							addBuildingTaskAtTop(vill, "10");
							GM_setValue(myacc() + "_" + vill + "_warehouseError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						else if (getErrorInfor().indexOf(aLangErrorText[6]) != -1 ) { // error: granary is too small
							if ( GM_getValue(myacc() + "_" + vill + "_granaryError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_UpdataTime");	// keep delaying till problem resolves
							addBuildingTaskAtTop(vill, "11");
							GM_setValue(myacc() + "_" + vill + "_granaryError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						// error: too few resources (aLangErrorText[0]) && enough resources later (aLangErrorText[7])
						else if ( ( getErrorInfor().indexOf ( aLangErrorText[0] ) != -1 ) || ( getErrorInfor().indexOf ( aLangErrorText[7] ) != -1 ) ) {
							delayUpgrade(vill, "_UpdataTime");
							calldoing1();
							showTaskList();
							break;
						}
						else if ( ( getErrorInfor().indexOf ( "Construction page found, cannot upgrade!" ) != -1 ) || 
								( getErrorInfor().indexOf ( "Some other building/resource found, cannot upgrade!" ) != -1 ) ) {
							printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							deleteTaskFromCookie(vill, thisTask);
							calldoing1();
							showTaskList();
							break;
						}
						// error: The workers are already at work or any other error 
						//else if ( (getErrorInfor() == aLangErrorText[1]) )
						else {
							GM_deleteValue(myacc() + "_" + vill + "_resRequired");
							GM_deleteValue(myacc() + "_" + vill + "_UpdataTime");
							GM_deleteValue(myacc() + "_" + vill + "_buildSlotFreeTime");
							// newdid is not required as getTaskCookies() refreshes stats for 
							// all villages whose stats are not set. This will set when to attempt build again.
							window.setTimeout ( function() {
										getTaskCookies();
										calldoing1();
									},
									Math.ceil ( Math.random() * 5*1000 + 1*1000 ) ); // random ( 5 sec ) + 1 sec
							break;
						}
						break;
					}
					else if (thisTask[0] == "0" && thisTask[1] == 50) { // [Other Races autoResource]
						if ( getVillageOption( "PAUSE_RESOURCE_UPGRADES", 0, "integer", vill ) == 1 
								&& GM_getValue(myacc() + "_" + vill + "_cropError", "0" ) == "0" ) {
							//flag("startBuildnow():: All Resource Upgrades has been Paused hence pausing Other Races "
							//		+"AutoResource Upgrade!");
							continue;
						}
						calldoing0();
						t = "1";
						var resId = getAutoResourceId(vill);
						thisTask[1] = resId;
						b = getthebuildUrl(vill, thisTask);
						if (b) {
							buildurl = b;
							thislevel = parseInt(GM_getValue(myacc() + "_" + vill + "_crtBuildlevel")) + 1;
							TS_debug("start HttpRequire() now for other races auto resource.");
							window.setTimeout ( 
								function() { 
									HttpRequire(buildurl, vill, thisTask, kind, thislevel);
									buildurl=null; vill=null; thisTask=null; kind=null; thislevel=null;
									},
									Math.ceil ( Math.random() * 5000 ) + 1000 ); // random ( 5 seconds ) + 1 seconds
							break;
						}
						else if ( getErrorInfor().indexOf(aLangErrorText[8]) != -1 ) { // error: lack of food, extend crop land first.
							// this should never happen for auto-resource
							if ( GM_getValue(myacc() + "_" + vill + "_cropError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: (Auto-Resoruce) id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_UpdataTime");	// keep delaying till problem resolves
							addCropTaskAtTop(vill);
							GM_setValue(myacc() + "_" + vill + "_cropError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						// error: Construction completed, ie all levels built.
						else if ( getErrorInfor().indexOf(aLangErrorText[2]) != -1 ) { 
							printMSG(getvillagefromdid(vill) + "("+vill+"):: (Auto-Resoruce) id: " + thisTask[1] + ", " + getErrorInfor());
							deleteAutoResTask(vill);
							calldoing1();
							showTaskList();
							break;
						}
						else if (getErrorInfor().indexOf(aLangErrorText[5]) != -1) { // error: warehouse is too small.
							if ( GM_getValue(myacc() + "_" + vill + "_warehouseError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: (Auto-Resoruce) id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_UpdataTime");	// keep delaying till problem resolves
							addBuildingTaskAtTop(vill, "10");
							GM_setValue(myacc() + "_" + vill + "_warehouseError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						else if (getErrorInfor().indexOf(aLangErrorText[6]) != -1) { // error: granary is too small.
							if ( GM_getValue(myacc() + "_" + vill + "_granaryError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: (Auto-Resoruce) id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_UpdataTime");	// keep delaying till problem resolves
							addBuildingTaskAtTop(vill, "11");
							GM_setValue(myacc() + "_" + vill + "_granaryError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						// error: too few resources (aLangErrorText[0]) && enough resources later (aLangErrorText[7])
						else if ( ( getErrorInfor().indexOf ( aLangErrorText[0] ) != -1 ) || ( getErrorInfor().indexOf ( aLangErrorText[7] ) != -1 ) ) {
							delayUpgrade(vill, "_UpdataTime");
							calldoing1();
							showTaskList();
							break;
						}
						// error: The workers are already at work or any other error 
						//else if ( (getErrorInfor() == aLangErrorText[1]) )						
						else {
							GM_deleteValue(myacc() + "_" + vill + "_resRequired");
							GM_deleteValue(myacc() + "_" + vill + "_UpdataTime");
							GM_deleteValue(myacc() + "_" + vill + "_buildSlotFreeTime");
							// newdid is not required as getTaskCookies() refreshes stats for 
							// all villages whose stats are not set. This will set when to attempt build again.
							window.setTimeout ( function() {
										getTaskCookies();
										calldoing1();
									},
									Math.ceil ( Math.random() * 5*1000 + 1*1000 ) ); // random ( 5 sec ) + 1 sec
							break;
						}
						break;
					}
					else if (thisTask[0] == "1") { // [Other Races New Building]
						if ( getVillageOption( "PAUSE_BUILDING_UPGRADES", 0, "integer", vill ) == 1 
								&& GM_getValue(myacc() + "_" + vill + "_warehouseError", "0" ) == "0"
				  				&& GM_getValue(myacc() + "_" + vill + "_granaryError", "0" ) == "0" ) {
							//flag("startBuildnow():: All Building Upgrades has been Paused hence pausing Other Race NewBuilding Upgrade!");
							continue;
						}
						calldoing0();
						t = "1";
						b = getthebuildUrl(vill, thisTask);
						if (b) {
							buildurl = b;
							thislevel = 1;
							TS_debug("start HttpRequire() now for other races new build.");
							window.setTimeout ( 
								function() { 
									HttpRequire(buildurl, vill, thisTask, kind, thislevel);
									buildurl=null; vill=null; thisTask=null; kind=null; thislevel=null;
									},
									Math.ceil ( Math.random() * 5000 ) + 1000 ); // random ( 5 seconds ) + 1 seconds
							break;
						}
						else if ( getErrorInfor().indexOf(aLangErrorText[8]) != -1 ) { // error: lack of food, extend crop land first.
							if ( GM_getValue(myacc() + "_" + vill + "_cropError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_UpdataTime");	// keep delaying till problem resolves
							addCropTaskAtTop(vill);
							GM_setValue(myacc() + "_" + vill + "_cropError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						else if (getErrorInfor().indexOf("newBuild can't run, something is here.") != -1) {
							printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							TS_debug("newBuild can't run, something is here. change to upgrade");
							var changeToUP = thisTask.slice(0); // clone the array thisTask.
							changeToUP[0] = "0";
							changeToUP.splice(3,1); // remove the gid
							deleteTaskFromCookie(vill, thisTask, changeToUP)
							calldoing1();
							showTaskList();
							break;
						}
						else if (getErrorInfor().indexOf(aLangErrorText[5]) != -1) { // error: warehouse is too small.
							if ( GM_getValue(myacc() + "_" + vill + "_warehouseError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_UpdataTime");	// keep delaying till problem resolves
							addBuildingTaskAtTop(vill, "10");
							GM_setValue(myacc() + "_" + vill + "_warehouseError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						else if (getErrorInfor().indexOf(aLangErrorText[6]) != -1) { // error: granary is too small.
							if ( GM_getValue(myacc() + "_" + vill + "_granaryError", "0" ) == "0" )
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: id: " + thisTask[1] + ", " + getErrorInfor());
							delayUpgrade(vill,"_UpdataTime");	// keep delaying till problem resolves
							addBuildingTaskAtTop(vill, "11");
							GM_setValue(myacc() + "_" + vill + "_granaryError", "1" );
							calldoing1();
							showTaskList();
							break;
						}
						// error: too few resources (aLangErrorText[0]) && enough resources later (aLangErrorText[7])
						else if ( ( getErrorInfor().indexOf ( aLangErrorText[0] ) != -1 ) || ( getErrorInfor().indexOf ( aLangErrorText[7] ) != -1 ) ) {
							delayUpgrade(vill, "_UpdataTime");
							calldoing1();
							showTaskList();
							break;
						}
						else if ( getErrorInfor().indexOf ( "Make sure all pre-requisites for the building has been met!" ) != -1 ) {
							if ( getCurrentlyUpgradingFristBuildingGid(vill) ) { // when a building is currently being upgraded
								setBuildingPreRequisiteError(vill);
								GM_deleteValue(myacc() + "_" + vill + "_resRequired");
								GM_deleteValue(myacc() + "_" + vill + "_UpdataTime");
								GM_deleteValue(myacc() + "_" + vill + "_buildSlotFreeTime");
								// newdid is not required as getTaskCookies() refreshes stats for 
								// all villages whose stats are not set. This will set when to attempt build again.
								window.setTimeout ( function() {
											getTaskCookies();
											calldoing1();
										},
										Math.ceil ( Math.random() * 5*1000 + 1*1000 ) ); // random ( 5 sec ) + 1 sec
								break;
							}
							else { // when no building is currently being upgraded
								printErrorMSG(getvillagefromdid(vill) + "("+vill+"):: Deleting new-build task! id: " + thisTask[1] +
										"(" + thisTask[5] + "), " + getErrorInfor());
								deleteTaskFromCookie(vill, thisTask); // delete the task
								calldoing1();
								showTaskList();
								break;
							}
						}	
						// error: The workers are already at work or any other error 
						//else if ( (getErrorInfor() == aLangErrorText[1]) )
						else {
							GM_deleteValue(myacc() + "_" + vill + "_resRequired");
							GM_deleteValue(myacc() + "_" + vill + "_UpdataTime");
							GM_deleteValue(myacc() + "_" + vill + "_buildSlotFreeTime");
							// newdid is not required as getTaskCookies() refreshes stats for 
							// all villages whose stats are not set. This will set when to attempt build again.
							window.setTimeout ( function() {
										getTaskCookies();
										calldoing1();
									},
									Math.ceil ( Math.random() * 5*1000 + 1*1000 ) ); // random ( 5 sec ) + 1 sec
							break;
						}
						break;
					}
				} // end of for iterating over all tasks
				if (t == "0") {
					GM_deleteValue(myacc() + "_" + vill + "_resRequired");
					GM_deleteValue(myacc() + "_" + vill + "_UpdataTime");
					GM_setValue(myacc() + "_" + vill + "_UpdataTaskExists", "0");
					TS_debug("No upgrade task found, deleting UpdataTime in startBuildnow()");
					calldoing1();
					showTaskList();
					return false; // nothing has been executed
				}
				else
					return true; // something has been executed
				break; // break for case "2"
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startBuildnow():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function delayUpgrade(vi, varString) {
	try {
		var delayT = Number ( GM_getValue ( myacc() + "_buildTrainDelayTime", "60" ) ) * 60*1000;
		// delay by delayT +/- random ( delayT/2 )
		var delayTime  = getRandomizedTime ( delayT, delayT, 1 );
		//flag ( "delayUpgrade():: getErrorInfor(): " + getErrorInfor() );
		if ( getErrorInfor() != null && getErrorInfor() != "" ) { // if there is some error
			var errorDelayTime = getDateAndTimeFromText ( getErrorInfor(), 1 );
			if ( errorDelayTime != null ) { // if error info contains some date/time
				errorDelayTime = getRandomizedTime ( errorDelayTime.getTime() + 20*1000, 2, 2 ); // get delay time from error info + 20 secs + random ( 2 min )
				if ( errorDelayTime < delayTime ) delayTime = errorDelayTime; // use min of delay time from error info and random delay time
			}
		}
		GM_setValue ( myacc() + "_" + vi + varString, delayTime.toString() );
		flag ( "delayUpgrade():: " + varString + " delayed by " +
			Math.round ( (delayTime-new Date().getTime())/(60*1000)*100 )/100 + " mins [ " + new Date(delayTime) + " ]" );
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>delayUpgrade():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// pass a2b_doc as null, when availability check is to be done using available troops information in cookie.
// TODO: This function has become too complicated, will need to write two separate functions to handle the two cases
// a) when a2b_doc is null -- here check for troop availability based on cookie information.
// b) when a2b_doc is not null -- here check for troop availability based on information from a2b.php.
function verifyEnoughTroopsForAttack(a2b_doc, vi, ATask) {
	try {
		// Troop amounts
		var troo = ATask[6].split(",");	// troops required for attack.
		var kata = ATask[7];
		var kata2 = ATask[8];

		var troopArray = [ 0,0,0,0,0,0,0,0,0,0,0 ]; // troops currently available in village.
		var totalTroopsAvailable = 0;	// sum of all troops currently available in village, ie sum of array troopArray.
		var totalTroopsAvailableForAttack = 0; // sum of troops currently available for attack.
		var totalTroopsNeeded = 0; // sum of all troops needed for attack, ie sum of array troo.

		// find troops currently available in village.
		if ( a2b_doc == null ) { // check for avail troops from cookie only if a2b_doc is null.
			//flag ( "verifyEnoughTroopsForAttack(): called in cookie mode." );
			var troopsAvailFrmCookie = GM_getValue(myacc() + "_" + vi + "_troopsAvail" );
			// if _troopsAvail is not set then return true, so that it can be set when attempting attack
			if ( troopsAvailFrmCookie == null || troopsAvailFrmCookie == "" )
				return true;
			if ( troopsAvailFrmCookie.indexOf("none") != -1 ) { // if no troops return false
				var elapseTime = GM_getValue(myacc() + "_" + vi + "_troopsCheckElapseTime", "false" );
				// if _troopsCheckElapseTime is not set return true so that _troopsNoneElapseTime can be set when attempting attack.
				if ( elapseTime == "false" || elapseTime == "" )
					return true;
				var nowt = new Date().getTime();
				// if troops check time has elapsed then return true, so that _troopsAvail & _troopsNoneElapseTime can be 
				// set when attempting attack.
				if ( nowt > Number(elapseTime) )
					return true;
				// delay task by some mins..
				/*var randominter=Math.ceil(Math.random()*10*60*1000) + 5*60*1000;
				var nowt=new Date();
				var newTask = ATask.slice(0); // clone the array ATask.
				newTask[4] = nowt.getTime() + randominter;
				flag ( "verifyEnoughTroopsForAttack() [cookie mode]: Not enough troops for attack, hence delaying by " + milliSecondstoDHMS(randominter) );
				deleteTaskFromCookie(vi, ATask, newTask);*/
				return false; // return false not enough troops.
			}
			troopArray = troopsAvailFrmCookie.split("_");
			for ( var arrCtr = 0 ; arrCtr < troopArray.length ; arrCtr++ )
				totalTroopsAvailable += parseInt(troopArray[arrCtr]);
		}
		else {
			//flag ( "verifyEnoughTroopsForAttack(): called in non-cookie mode." );
			var gettroops = document.evaluate ( 'id("troops")//a[contains(@href,"#")]', a2b_doc, null, XPSnap, null );
			//TS_debug ( "gettroops.snapshotLength: " + gettroops.snapshotLength );
			for (var i = 0 ; i < gettroops.snapshotLength; i++) {
				var snapShotItem = gettroops.snapshotItem(i);
				var troopno = snapShotItem.getAttribute('onclick');
				if ( troopno ) {
					troopno = parseInt(troopno.match(/\bt\d{1,}\b/)[0].match(/\d{1,}/)[0]) - 1;
					//troopno = troopno.split(".")[2];
					//troopno = troopno.split("t")[1];
					//troopno = parseInt(troopno) - 1;
				}
				var troopcount = parseInt(gettroops.snapshotItem(i).innerHTML.match(/\d+/));
				troopArray[troopno] = troopcount;
				if ( troopcount ) {
					totalTroopsAvailable += parseInt(troopcount);
				}
				//TS_debug ( "totalTroopsAvailable: " + totalTroopsAvailable );
				//TS_debug ( "troopno: " + troopno + " :: troopcount : " + troopcount );
			}
			troopArray[10] = parseInt(troopArray[10]) > 0 ? troopArray[10] : 0 ; 
			if ( totalTroopsAvailable > 0 )
				GM_setValue(myacc() + "_" + vi + "_troopsAvail", troopArray.join("_") ); // update troops count in cookie
			else
				GM_setValue(myacc() + "_" + vi + "_troopsAvail", "none" ); // update troops count in cookie

			/*var nowt = new Date().getTime();
			var troopsUpdateInterval = parseInt(GM_getValue(myacc() + "_troopsUpdateInterval", "60"));
			// random ( +/- 1 mins ) + troopsUpdateInterval mins
			var randominter=Math.ceil(Math.random()*2*60*1000 - 1*60*1000) + troopsUpdateInterval*60*1000;
			var elapseTime = nowt + randominter;
			GM_setValue(myacc() + "_" + vi + "_troopsCheckElapseTime", elapseTime.toString() );
			flag ("verifyEnoughTroopsForAttack() [non-cookie mode]: Troops count refreshed, will refresh again in: " 
					+ milliSecondstoDHMS(randominter) );*/
		}

 		// For reinforce always return true...
 		/*if ( ATask[2] == "2" ) {
			return true;
		}*/

		// check if we have enough troops in village for each troop type.
		var flagEnoughTroops = true;
		for (var i = 0 ; i < 11 ; i++ ) {
			var neededTroop = troo[i] ? troo[i] : 0;
			troopArray[i] = troopArray[i] ? troopArray[i] : 0;
			totalTroopsNeeded = totalTroopsNeeded + parseInt(neededTroop);
			//TS_debug ( "i= " + i + " :: " + neededTroop + " : " + troopArray[i] );
			if ( parseInt(neededTroop) > parseInt(troopArray[i]) ){
				//TS_debug ( "not enough troops for i: " + i );
				flagEnoughTroops = false;
				totalTroopsAvailableForAttack = parseInt(totalTroopsAvailableForAttack) + parseInt(troopArray[i]);
				//break;
			}
			else { // if more troops of this kind, then count only that many which r to be sent.
				totalTroopsAvailableForAttack = parseInt(totalTroopsAvailableForAttack) + parseInt(neededTroop);
			}
			//TS_debug ( "totalTroopsAvailableForAttack: " + totalTroopsAvailableForAttack );
		}

		// Verify that total no of troops is more than the minimum allowed troop count...
		var minTroopsCountCheck = GM_getValue ( myacc() + "_minTroopsCountCheck", "1" );
		if ( minTroopsCountCheck == "1" && flagEnoughTroops == true && ( ATask[11] != "1" && ATask[11] != "2" ) ) { // do only when not scouting
			raceId = GM_getValue(myacc() + "_raceID", "0" );
			var minTroopCount = 0;
			switch ( raceId ) {
				case "0": minTroopCount = 2; break;
				case "1": minTroopCount = 3; break;
				case "2": minTroopcount = 3; break;
			}
			if ( Number(totalTroopsAvailableForAttack) < Number(minTroopCount) ) { // if less than min allowed troops
				var msg = "Mininum troop requirement not met, deleting "
					+ aLangAttackType[ATask[2] - 2] + " task to ";
				var xCoord = getXfromCoord ( ATask[1] );
				var yCoord = getYfromCoord ( ATask[1] );
				var targetcoord= "(" + xCoord + "|" + yCoord + ")";
				var villageUrl = "";
				switch ( aTravianVersion ) {
					case "3.6":
						villageUrl = "<a style='color: Green' href='" +
							myhost + "/karte.php?newdid=" + vi + "&z=" + ATask[1] + "'>" + targetcoord + "</a>";
						break;
					case "4.0":
						villageUrl = "<a style='color: Green' href='" +
							myhost + "/karte.php?newdid=" + vi + "&x=" + xCoord + "&y=" + yCoord + "'>" + targetcoord + "</a>";
						break;
					default: throwLogicError ( "verifyEnoughTroopsForAttack():: Travian Version not set!!" );
				}
				var msg1 = getvillagefromdid(vi) + " (" + vi + "): " + msg + villageUrl;
				var msg2 = getvillagefromdid(vi) + " (" + vi + "): " + msg + targetcoord;
				playSound ( "<b>" + msg1 + "</b>" );
				flag ( "verifyEnoughTroopsForAttack():: " + msg2 );
				deleteTaskFromCookie(vi, ATask);
				calldoing1();
				showTaskList();
				return false;
			}
		}

		// for raids check if we have halfRaidEnabled enabled
		if ( flagEnoughTroops == false && ATask[2] == "4" ) {
			var halfRaidEnabled = GM_getValue ( myacc() + "_halfRaidEnabled", "0" );
			if ( halfRaidEnabled == "1" && Number(totalTroopsAvailableForAttack) > ( Number(totalTroopsNeeded) / 2.0 ) ) {
				flag ( "verifyEnoughTroopsForAttack():: " + " More than half number of Troops available for Raid, will send raid! (" 
						+ totalTroopsAvailableForAttack + "/" + totalTroopsAvailable + ")" );
				return true;
			}
		}

		// It seems not enough troop for attack/raid, hence delay the task...
		if ( flagEnoughTroops == false ) {
			if ( a2b_doc == null ) { // if evaluating from cookie
				var elapseTime = GM_getValue(myacc() + "_" + vi + "_troopsCheckElapseTime", "false" );
				// if _troopsCheckElapseTime is not set return true so that _troopsNoneElapseTime can be set when attempting attack.
				if ( elapseTime == "false" || elapseTime == "" )
					return true;
				var nowt = new Date().getTime();
				// if troops check time has elapsed then return true, so that _troopsAvail & _troopsNoneElapseTime can be 
				// set when attempting attack.
				if ( nowt > Number(elapseTime) )
					return true; 
			}

			// delay task by some mins..
			/*var randominter=Math.ceil(Math.random()*10*60*1000) + 5*60*1000;
			var nowt=new Date();
			var newTask = ATask.slice(0); // clone the array ATask.
			newTask[4] = nowt.getTime() + randominter;
			flag("verifyEnoughTroopsForAttack(): Not Enough Troops to attack (" + totalTroopsAvailableForAttack + "/" + 
					totalTroopsNeeded + "), hence delaying by " + milliSecondstoDHMS(randominter) );
			deleteTaskFromCookie(vi, ATask, newTask);*/
			return false;
		}

		if ( a2b_doc == null )
			flag ( "verifyEnoughTroopsForAttack() [cookie mode]:: Enough Troops, will send attack!");
		else
			flag ( "verifyEnoughTroopsForAttack() [non-cookie mode]:: Enough Troops, will send attack!");
		return true;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>verifyEnoughTroopsForAttack():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function sendRandomHttpBeforeAttack(vi, ATask) {
	try {
		flag ( "sendRandomHttpBeforeAttack():: Started! village: " + vi );
		var shouldWeSend = ( Math.random() < 0.2 ) ? true : false ;	// send random http only once in 5 times.
		if ( shouldWeSend ) {
			var reqUrl = "";
			var rndUrl = Math.random();
			if ( rndUrl < 0.3 ) {
				reqUrl = myhost + "/dorf1.php" + "?newdid=" + vi;		// dorf1.php with 0.3 probability
			}
			else if ( rndUrl >= 0.3 && rndUrl < 0.6 ) {
				reqUrl = myhost + "/dorf2.php" + "?newdid=" + vi;		// dorf2.php with 0.3 probability
			}
			else if ( rndUrl >= 0.6 && rndUrl < 0.7 ) {
				reqUrl = myhost + "/build.php?id=39" + "&newdid=" + vi;		// rally point with 0.1 probability
			}
			else if ( rndUrl >= 0.7 && rndUrl < 0.8 ) {
				reqUrl = myhost + "/berichte.php" + "?newdid=" + vi;		// reports page with 0.1 probability
			}
			else if ( rndUrl >= 0.9 && rndUrl < 0.95 ) {
				reqUrl = myhost + "/statistiken.php" + "?newdid=" + vi;		// statistics page with 0.05 probability
			}
			else { //if ( rndUrl >= 0.95 && rndUrl <= 1 )
				reqUrl = myhost + "/nachrichten.php" + "?newdid=" + vi;		// messages page with 0.05 probability
			}
			flag ( "sendRandomHttpBeforeAttack():: Sending random http req before attack, url: " + reqUrl );
			switch ( aTravianVersion ) {
				case "3.6": TS_getRequest ( reqUrl, doRandomizeAttack, vi, ATask ); break;
				case "4.0": TS_getRequest ( reqUrl, doStartAttackNow, vi, ATask, reqUrl ); break;
				default: throwLogicError ( "sendRandomHttpBeforeAttack():: Travian Version not set!!" );
			}
		}
		else {
			switch ( aTravianVersion ) {
				case "3.6": randomizeAttack ( vi, ATask ); break;
				case "4.0": startAttackNow ( vi, ATask, "" ); break;
				default: throwLogicError ( "sendRandomHttpBeforeAttack():: Travian Version not set!!" );
			}
			
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>sendRandomHttpBeforeAttack():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function doRandomizeAttack ( response, vi, ATask ) {
	try {
		flag ( "doRandomizeAttack():: Started! vi: " + vi );
		window.setTimeout ( 
			function() { 
				randomizeAttack ( vi, ATask );		
				vi=null; ATask=null;
			},
			Math.ceil ( Math.random() * 1000 ) + 500 ); // random ( 1 second ) + 0.5 seconds
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>doRandomizeAttack():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function randomizeAttack ( vi, ATask ) {
	try {
		flag ( "randomizeAttack():: Started! vi: " + vi );
		if ( !ATask[12] ) { // if cparam does not exists
			var shouldWeOpenMap = ( Math.random() < 0.5 ) ? true : false ;		// open map once in 2 times.
			if ( shouldWeOpenMap )
				openMapBeforeAttack ( vi, ATask );			// this will collect the cparam
			else
				startAttackNow ( vi, ATask, "" );			// this doesn't need cparam
		}
		else { // if cparam exists
			var rndValue = Math.random();
			if ( rndValue < 0.33 ) {
				var reqUrl = myhost + "/karte.php?d=" + ATask[1] + "&c=" + ATask[12] + "&newdid=" + vi;
				TS_getRequest ( reqUrl, doStartAttackNow, vi, ATask, reqUrl );	// open village with 0.33 probability, this needs cparam
			}
			else if ( rndValue >= 0.33 && rndValue < 0.66 ) {
				openMapBeforeAttack ( vi, ATask );				// open map with 0.33 probability, this will re-check cparam
			}
			else { //if ( rndValue >= 0.66 && rndValue <= 1 )
				startAttackNow ( vi, ATask, "" );				// send attack directly with 0.34 probability, this doesn't need cparam
			}
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>randomizeAttack():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// opens map with the target village at the center
function openMapBeforeAttack(vi, ATask) {
	try {
		flag ( "openMapBeforeAttack():: Started! village: " + vi );
		var reqUrl = "/karte.php?z=" + ATask[1] + "&newdid=" + vi;
		TS_getRequest(reqUrl,openVillageBeforeAttack, vi, ATask);
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>openMapBeforeAttack():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// if target village exists on the map, opens the target village
function openVillageBeforeAttack(response, vi, ATask) {
	try {
		flag ( "openVillageBeforeAttack():: Started! village: " + vi );
		if ( response == null || response == "" ) {
			calldoing1();
			return;
		}
		// confirm village exists
		var xpathVillage = 'id("map_content")/div[ contains(@id,"i_3_3") and ( starts-with(@class,"b") or starts-with(@class,"o") ) ]';
		var village = document.evaluate(xpathVillage, response, null, XPFirst, null).singleNodeValue;
		if ( village == null ) { // if village does not exist delete the attack task.
			var xCoord = getXfromCoord ( ATask[1] );
			var yCoord = getYfromCoord ( ATask[1] );
			var targetcoord= "(" + xCoord + "|" + yCoord + ")" ;
			var villageUrl = "";
			switch ( aTravianVersion ) {
				case "3.6":
					villageUrl = "<a style='color: Green' href='" +
						myhost + "/karte.php?newdid=" + vi + "&z=" + ATask[1] + "'>" + targetcoord + "</a>";
					break;
				case "4.0":
					villageUrl = "<a style='color: Green' href='" +
						myhost + "/karte.php?newdid=" + vi + "&x=" + xCoord + "&y=" + yCoord + "'>" + targetcoord + "</a>";
					break;
				default: throwLogicError ( "openVillageBeforeAttack():: Travian Version not set!!" );
			}
			var errormsg1 = getvillagefromdid(vi) + " (" + vi + "): " + 
				"Deleting " + aLangAttackType[ATask[2] - 2] + " Task to " + villageUrl + ", error: " +
				"There is no village at those coordinates";
			var errormsg2 = getvillagefromdid(vi) + " (" + vi + "): " + 
				"Deleting " + aLangAttackType[ATask[2] - 2] + " Task to " + targetcoord + ", error: " +
				"There is no village at those coordinates";
			printErrorMSG( errormsg1 );
			flag ( "openVillageBeforeAttack():: " + errormsg2 );
			deleteTaskFromCookie(vi, ATask);
			calldoing1();
			showTaskList();
			return;
		}
		else { // if village exists
			var xpathVillage2 = 'id("map_overlay")/area[ contains(@id,"a_3_3") and contains(@href,"c=") ]';
			var village2 = document.evaluate(xpathVillage2, response, null, XPFirst, null).singleNodeValue;

			// now get village href with c parameter for the village from map
			var reqUrl = village2.href;
			if ( reqUrl.match(/\bnewdid=\b/) == null ) // if reqUrl does not have newdid, add newdid
				reqUrl = reqUrl + "&newdid=" + vi;
			var cparam = village2.href.match(/\bc=\b[a-z0-9]+\b/i)[0].split("=")[1];
			if ( ATask[12] != null && ATask[12] != undefined ) { // if ATask already have cparam
				// verify that cparam is same as stored in ATask
				if ( ATask[12] != cparam ) {
					var msg = ": conflicting cparam in task, stored cparam: \'" + ATask[12]
						+ "\', new cparam \'" + cparam + "\', new cparam updated, no action required from user.";
					var xCoord = getXfromCoord ( ATask[1] );
					var yCoord = getYfromCoord ( ATask[1] );
					var targetcoord= "(" + xCoord + "|" + yCoord + ")";
					var villageUrl = "";
					switch ( aTravianVersion ) {
						case "3.6":
							villageUrl = "<a style='color: Green' href='" +
								myhost + "/karte.php?newdid=" + vi + "&z=" + ATask[1] + "'>" + targetcoord + "</a>";
							break;
						case "4.0":
							villageUrl = "<a style='color: Green' href='" +
								myhost + "/karte.php?newdid=" + vi + "&x=" + xCoord + "&y=" + yCoord + "'>" + targetcoord + "</a>";
							break;
						default: throwLogicError ( "openVillageBeforeAttack():: Travian Version not set!!" );
					}
					var msg1 = getvillagefromdid(vi) + " (" + vi + "): " + villageUrl + msg;
					var msg2 = getvillagefromdid(vi) + " (" + vi + "): " + targetcoord + msg;
					playSound ( msg1 );
					flag ( "openVillageBeforeAttack():: " + msg2 );

				}
			}
			// add cparam to ATask
			var newTask = ATask.slice(0); // clone the array ATask.
			newTask[12] = cparam;
			var tTask = newTask.slice(0);
			deleteTaskFromCookie(vi, ATask, newTask);
			ATask = tTask;

			window.setTimeout ( 
				function() { 
					TS_getRequest ( reqUrl, doStartAttackNow, vi, ATask, reqUrl );		
					vi=null; ATask=null;
				},
				Math.ceil ( Math.random() * 1000 ) + 500 ); // random ( 1 second ) + 0.5 seconds
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>openVillageBeforeAttack():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function doStartAttackNow (response, vi, ATask, reqUrl) {
	try {
		flag ( "doStartAttackNow():: Started! village: " + vi );

		// if reqUrl is rally point page, then analyze rally point and update troop counts.
		if ( reqUrl.match(/build\.php.*\bid=39\b/) != null || reqUrl.match(/build\.php\.*\bgid=16\b/) != null )
			analyzeRallyPoint(response,vi,false);

		window.setTimeout ( 
			function() { 
				startAttackNow(vi,ATask, ""); 
				vi=null; ATask=null;
			},
			Math.ceil ( Math.random() * 2000 ) + 1000 ); // random ( 2 seconds ) + 1 seconds
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>doStartAttackNow():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

/**
 * Starts an attack task.
 */
function startAttackNow(vi, ATask, antiFarm) { // 2_targetPosition_kind_repeat_startTime_interval_troops_kata1_kata2
	try {
		flag ( "startAttackNow(): Started! village: " + vi );
		var reqUrl = myhost + "/a2b.php?z=" + ATask[1] + "&newdid=" + vi;
		//var reqUrl = myhost + "/a2b.php" + "?newdid=" + vi;
		if ( antiFarm != null && antiFarm != "" ) // if anti-farm mode
			TS_getRequest(reqUrl, startAttackNPrepare, vi, ATask, antiFarm);
		else { // if ( antiFarm == null ) // ie if not anti-farm mode
			var nowt = new Date().getTime() - serverTimeDiff;
			var comebackTime = parseInt(ATask[9])*2 + nowt; // time when troops will come back.
			var attackIncomingTimes = GM_getValue( myacc() + "_" + vi + "_incomingAttackTimes", "" ).split("|");
			for ( var ctr = 0 ; ctr < attackIncomingTimes.length ; ctr++ ) {
				if ( ( attackIncomingTimes[ctr] - comebackTime ) < 60*1000 && attackIncomingTimes[ctr] > comebackTime ) {
					flag ( "startAttackNow():: Skipping attack this interval as come back time will conincide with some incoming attack time!" );
					calldoing1(); // skip attack this run if comeback time is within 60 sec of any incoming attack and try next time.
					return;
				}
			}
			TS_getRequest(reqUrl, startAttackNPrepare, vi, ATask, "");
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startAttackNow():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

/**
 * Attack task phase function.
 */
function startAttackNPrepare(a2b_doc, vi, ATask, antiFarm) { // 2_targetPosition_kind_repeat_startTime_interval_troops_kata1_kata2
	try {
		flag ( "startAttackNPrepare():: Started! village: " + vi );
		//TS_debug("startAttackNPrepare: Callback starting");
		var reqData;
		if (ATask == undefined) { 
			TS_debug("startAttackNPrepare: Error - parameter definition missing!"); return; 
		}
		formTag = getFormNode(a2b_doc);
		if (formTag == null) { 
			TS_debug("startAttackNPrepare: Error - no form in the answer area"); return; 
		}

		// Other values stored in form
		var timestamp = getFormHidVal(formTag, "timestamp");
		var timestamp_checksum = getFormHidVal(formTag, "timestamp_checksum");
		var bHiddenValue = getFormHidVal(formTag, "b");

		var formCount = document.evaluate('.//form [ @name="snd" and ( @method="POST" or @method="post" ) ]', a2b_doc, null, XPSnap, null).snapshotLength;
		if ( formCount > 1 ) {
			var urlToBuilding = "<a class='spantooltip' style='color: Green' href='"+
				myhost+"/a2b.php?newdid="+vi;
			switch ( aTravianVersion ) {
				case "3.6":
					urlToBuilding = urlToBuilding + "&z=" + ATask[1];
					break;
				case "4.0":
					var xCoord = getXfromCoord(ATask[1]);
					var yCoord = getYfromCoord(ATask[1]);
					urlToBuilding = urlToBuilding + "&x=" + xCoord + "&y=" + yCoord;
					break;
				default:
					throwLogicError ( "startAttackNPrepare():: Travian Version not set!!" );
			}
			var troo = ATask[6].split(",");
			for ( var ctr = 0; ctr < troo.length ; ctr++ )
				if ( troo[ctr] != "" && troo [ctr] != "0" )
					urlToBuilding = urlToBuilding + "&t" + (ctr+1) + "=" + troo[ctr];
			urlToBuilding = urlToBuilding + "&c=" + ATask[2];
			urlToBuilding = urlToBuilding + "'>Send Attack</a>";
			playSound ( "<b>startAttackNPrepare():: Some Problem, send attack once manually! " + urlToBuilding + "</b>" );

			//if ( antiFarm == "" ) { // skip attack if not in anti-farm mode
			if ( true ) { 
				var newTask = ATask.slice(0); // clone the array ATask.
				var nowt = new Date();
				// if attack strict order is disabled, set increment attack time by repeat interval
				if ( GM_getValue ( myacc() + "_attackStrictOrder", "0" ) == "0" ) {
					if (ATask[5] == "0") { // if repeat is set to 0, increment by 1 day +/- random 5 mins
						// delay by 24 hrs +/- random ( 5 )
						temp2 = getRandomizedTime ( 24*60*60*1000, 2 * 5*60*1000, 1 );
					}
					else if ( Number(ATask[5]) > 5*60*1000 ) { // else if repeat interval > 5 mins increment by repeat interval +/- random (repeat-interval/2)
						// delay by repeat interval +/- random ( repeat-interval / 2 )
						temp2 = getRandomizedTime ( Number(ATask[5]), Number(ATask[5]), 1 );
					}
					else { // else if repeat interval < 5 mins just increment by repeat interval
						temp2 = nowt.getTime() + Number(ATask[5]);
					}
					newTask[4] = temp2.toString();
				}
				deleteTaskFromCookie(vi, ATask, newTask);
				calldoing1();
				showTaskList();

				return false;
			}
		}

		var noOfHiddenValues = document.evaluate ( './/*[@type="hidden"]', a2b_doc, null, XPSnap, null).snapshotLength;
		//flag ( "startAttackNPrepare():: Number of hidden values in attack form: " + noOfHiddenValues );
		if ( noOfHiddenValues != 3 ) {
			printErrorMSG ( "startAttackNPrepare():: " + getvillagefromdid(vi) + " (" + vi + "): " +
					"Unaccounted number of hidden values in attack form: " + noOfHiddenValues );
		}

		var reqUrl = myhost + "/a2b.php" + "?newdid=" + vi;

		// For unknown purposes, a mouse position over button is sent with the form
		var s1xPos = Math.floor(46*Math.random())+1;
		var s1yPos = Math.floor(19*Math.random())+1;

		// Target
		var targetPos = new Array();
		targetPos[0] = getXfromCoord(ATask[1]);
		targetPos[1] = getYfromCoord(ATask[1]);

		var flagEnoughTroops = verifyEnoughTroopsForAttack(a2b_doc, vi, ATask); // check for enough troops & update troops count in cookie
		if ( antiFarm == "" ) { // not in anti-farm mode, ie normal mode
			// GotGs 2011.01.15 -- Verify that we have enough troops before sending out...
			if ( flagEnoughTroops == false ) {
				flag ( "startAttackNPrepare():: Not enough troops, delaying attack for village: " + vi );
				var callBackUrl = myhost + "/build.php?gid=16&newdid="+vi;
				TS_getRequest ( callBackUrl, loadRallyPoint, vi, false, false ); // not enough troops, hence load rally point to find out when to update troops again.
				return;
			}
		}
		else { // in anti-farm mode, get all troops avail in cookie and send them out
			var troopsAvailFrmCookie = GM_getValue(myacc() + "_" + vi + "_troopsAvail" );
			var serverNowTime = new Date( new Date().getTime() - serverTimeDiff );
			if ( troopsAvailFrmCookie == null || troopsAvailFrmCookie == "" || troopsAvailFrmCookie.indexOf("none") != -1 ) { // no troops in village
				var msg = getvillagefromdid(vi) + " (" + vi + "): No troops at " + serverNowTime.toLocaleTimeString() + " to send out for anti-farm!";
				flag ( "startAttackNPrepare():: " + msg );
				printErrorMSG( "<b>" + msg + "</b>" );
				// add antiFarm to attacksToCallBack array to initiate call back for this attack.
				attacksToCallBack.push(antiFarm);
				return;
			}
			else { // put available troops in ATask
				troopsAvailFrmCookie = troopsAvailFrmCookie.split("_");
				var troopsToSendOut = GM_getValue ( myacc() + "_troopsToSendOut", "1,1,1,1,1,1,1,1,1,1,1" ).split(",");
				flag ( "startAttackNPrepare():: troopsToSendOut: " + troopsToSendOut );
				flag ( "startAttackNPrepare():: troopsToSendOut.length: " + troopsToSendOut.length );
				var finalTroops = new Array(11);
				var someProblem = false;
				var allNegConditionMet = true;
				if ( troopsToSendOut.length == 11 ) {
					for ( var ctr = 0; ctr < troopsToSendOut.length ; ctr++ ) {
						finalTroops[ctr] = troopsAvailFrmCookie[ctr];
						if ( troopsToSendOut[ctr] == "" || troopsToSendOut[ctr] == null || troopsToSendOut[ctr] == undefined
								|| isNaN ( parseInt( troopsToSendOut[ctr] ) ) || parseInt( troopsToSendOut[ctr] ) > 1 ) {
							flag ( "startAttackNPrepare():: troopsToSendOut["+ctr+"]: " + troopsToSendOut[ctr] );
							someProblem = true;
							break;
						}
						if ( troopsToSendOut[ctr] == "1" ) {
							continue;
						}
						else if ( troopsToSendOut[ctr] == "0" ) {
							finalTroops[ctr] = "0";
						}
						else { // if ( parseInt ( troopsToSendOut[ctr] ) < 0 )
							if ( ( parseInt( troopsToSendOut[ctr] ) * -1 ) <= parseInt ( troopsAvailFrmCookie[ctr] ) ) {
								finalTroops[ctr] = "0";
							}
							else {
								flag ( "startAttackNPrepare():: troopsToSendOut["+ctr+"]: " + troopsToSendOut[ctr] );
								allNegConditionMet = false;
								break;
							}
						}
					}
				}
				else {
					someProblem = true;
				}
				if ( someProblem == true ) { // send all available troops out
					var msg1 = "Some problem with anti-farm configuration, please correctly specify troops to send out!";
					flag ( "startAttackNPrepare():: " + msg1 );
					printErrorMSG( "<b>" + msg1 + "</b>" );
					ATask[6] = troopsAvailFrmCookie.join(",");
				}
				else if ( allNegConditionMet == false ) { // send all available troops out
					ATask[6] = troopsAvailFrmCookie.join(",");
				}
				else { // send selected troops out
					ATask[6] = finalTroops.join(",");
				}
				var msg = getvillagefromdid(vi) + " (" + vi + "): Troops being sent out for anti-farm at " + serverNowTime.toLocaleTimeString();
				flag ( "startAttackNPrepare():: " + msg );
				printErrorMSG( "<b>" + msg + "</b>" );
			}
		}

		// Troop amounts
		var troo = ATask[6].split(",");
		var kata = ATask[7];
		var kata2 = ATask[8];

		// Two versions - with katapults and without them
		if (kata > 0) {
			reqData = "timestamp=" + timestamp + "&timestamp_checksum=" + timestamp_checksum + "&b=" + bHiddenValue + "&c=" + ATask[2] + "&kid=" + ATask[1]
			 + "&t1=" + troo[0] + "&t2=" + troo[1] + "&t3=" + troo[2] + "&t4=" + troo[3] + "&t5=" + troo[4] + "&t6=" + troo[5]
			 + "&t7=" + troo[6] + "&t8=" + troo[7] + "&t9=" + troo[8] + "&t10=" + troo[9] + "&t11=" + troo[10]
			 + "&kata=" + kata + "&kata2=" + kata2
			 + "&dname=&x=" + targetPos[0] + "&y=" + targetPos[1] 
			 + "&s1.x=" + s1xPos + "&s1.y=" + s1yPos + "&s1=ok"; //+ "&attacks=&cords="; // TODO:: do we need &attacks= and &cords=
		}
		else {
			reqData = "timestamp=" + timestamp + "&timestamp_checksum=" + timestamp_checksum + "&b=" + bHiddenValue + "&c=" + ATask[2] + "&kid=" + ATask[1]
			 + "&t1=" + troo[0] + "&t2=" + troo[1] + "&t3=" + troo[2] + "&t4=" + troo[3] + "&t5=" + troo[4] + "&t6=" + troo[5]
			 + "&t7=" + troo[6] + "&t8=" + troo[7] + "&t9=" + troo[8] + "&t10=" + troo[9] + "&t11=" + troo[10]
			 + "&dname=&x=" + targetPos[0] + "&y=" + targetPos[1] 
			 + "&s1.x=" + s1xPos + "&s1.y=" + s1yPos + "&s1=ok"; //+ "&attacks=&cords="; // TODO:: do we need &attacks= and &cords=
		}

		var waitInterval = 0;
		if ( antiFarm == "" ) // normal mode 
			waitInterval = Math.ceil ( Math.random() * 3000 ) + 1000; // random ( 3 seconds ) + 1 seconds
		else // anti-farm mode
			waitInterval = Math.ceil ( Math.random() * 20 ) + 20; // random ( 0.02 seconds ) + 0.02 seconds

		//var waitInterval = Math.ceil ( Math.random() * 10*1000 - 5*1000 );
		window.setTimeout ( 
				function() { 
					TS_postRequest(reqUrl,reqData,startAttackNAccept, vi, ATask, antiFarm); 
					reqUrl=null; reqData=null; vi=null; ATask=null;
				},
				waitInterval );

                //TS_postRequest(reqUrl,reqData,startAttackNAccept, vi, ATask);
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startAttackNPrepare():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// returns interval by reading provided text argument. only 1 timer ideally should be present in text.
// returns null, if text has  no timer.
function getIntervalFromTimer(text) {
	try {
		if ( text != null && text != "" ) {
			var timerValue = text.match(/\b\d{1,}:\d{1,}:\d{1,}\b/); // in hh:mm:ss format
			if ( timerValue == null ) {
				return null;
			}
			timerValue = timerValue[0].split(":");
			var retValue = timerValue[0]*60*60*1000 + timerValue[1]*60*1000 + timerValue[2]*1000;
			return retValue;
		}
		else	{
			printStackTrace();
			var msg = "getIntervalFromTimer():: Incorrect parameter passed!"; 
			TS_debug ( msg );
			var errObj = new Error () ;
			errObj.name = "Invalid Argument passed to function";
			errObj.message = msg;
			throw errObj;
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getIntervalFromTimer():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// returns date by reading provided text argument. only 1 date/time ideally should be present in text.
// returns null, if text has  no date/time.
function getDateAndTimeFromText ( text, adjustForNextDate ) {
	try {
		if ( adjustForNextDate == null || adjustForNextDate == undefined || adjustForNextDate === "" )
			adjustForNextDate = 1;
		if ( text != null && text != "" ) {
			var dateValue = text.match(/\d{1,}\/\d{1,}\/\d{1,}/); // in yyyy/mm/dd format
			var timeValue = text.match(/\d{1,}:\d{1,}:\d{1,}/); // in hh:mm:ss format
			//flag ( "dateValue: " + ( dateValue != null ? dateValue.toString() : "NULL" ) );
			//flag ( "timeValue: " + ( timeValue != null ? timeValue.toString() : "NULL" ) );

			var timeValueNull = false;

			if ( timeValue == null ) {
				timeValue = text.match(/\d{1,}:\d{1,}/); // in hh:mm format
				if ( timeValue == null ) {
					timeValueNull = true;
					timeValue = [ 0, 0, 0];
				}
				else {
					timeValue = timeValue[0].split(":");
					timeValue[2] = 0;
				}
			}
			else {
				timeValue = timeValue[0].split(":");
			}
			//flag ( "timeValue: " + timeValue.join(":") );

			if ( dateValue == null ) {
				var dateValue = text.match(/\d{1,}\/\d{1,}/); // in mm/dd format
				if ( dateValue == null && timeValueNull == true )
					return null; // null means there is no date/time in the input text.
				if ( dateValue == null ) {
					var nowt = new Date(); // do not add server time diff here as we are getting date/time from travian pages
					dateValue = [ nowt.getFullYear(), nowt.getMonth(), nowt.getDate() ];
				}
				else {
					var dateValue2 = dateValue[0].split("/");
					dateValue[0] = new Date().getFullYear();
					dateValue[1] = parseInt(dateValue2[0]) - 1;
					dateValue[2] = dateValue2[1];
				}
			}
			else {
				dateValue = dateValue[0].split("/");
				dateValue[0] = dateValue[0].length == 2 ? "20" + dateValue[0] : dateValue[0];
				dateValue[1] = parseInt(dateValue[1]) - 1;
			}

			var serverTimeZoneCorrection =  GM_getValue ( myacc() + "_serverTimeZoneCorrection", "" );
			//flag ( "getDateAndTimeFromText():: serverTimeZoneCorrection: " + serverTimeZoneCorrection );
			if ( serverTimeZoneCorrection != "" ) {
				var sign = serverTimeZoneCorrection.slice(0,1); // first character is always the sign
				serverTimeZoneCorrection = serverTimeZoneCorrection.slice(1).split(":");
				if ( sign == "+" ) {
					timeValue[0] = Number(timeValue[0]) + Number(serverTimeZoneCorrection[0]);
					timeValue[1] = Number(timeValue[1]) + Number(serverTimeZoneCorrection[1]);
				}
				else {
					timeValue[0] = Number(timeValue[0]) - Number(serverTimeZoneCorrection[0]);
					timeValue[1] = Number(timeValue[1]) - Number(serverTimeZoneCorrection[1]);
				}
				//dateValue[2] -= 1;
			}

			//flag ( "getDateAndTimeFromText():: dateValue: " + dateValue.join("/") + ", timeValue: " + timeValue.join(":") );
			var retVal = new Date ( dateValue[0], dateValue[1], dateValue[2], timeValue[0], timeValue[1], timeValue[2] );
			//flag ( "getDateAndTimeFromText():: retVal: " + retVal );

			// this check is required for year end 
			if ( retVal.getTime() < ( new Date().getTime() - 4*30*24*60*60*1000 ) ) { // if computed date is older than 4 months
				dateValue[0] = dateValue[0] + 1;
				//retVal = new Date ( dateValue[0]+1, dateValue[1], dateValue[2], timeValue[0], timeValue[1], timeValue[2] ); // increment by 1 year
			}

			if (  adjustForNextDate == 1 && retVal.getTime() < new Date().getTime() ) {
				dateValue[2] = dateValue[2] + 1;
				//retVal = new Date ( dateValue[0], dateValue[1], dateValue[2]+1, timeValue[0], timeValue[1], timeValue[2] );
			}

			retVal = new Date ( dateValue[0], dateValue[1], dateValue[2], timeValue[0], timeValue[1], timeValue[2] );
			//flag ( "getDateAndTimeFromText():: retVal: " + retVal );
			return retVal;
		}
		else	{
			printStackTrace();
			var msg = "getDateAndTimeFromText():: Incorrect parameter passed!"; 
			TS_debug ( msg );
			var errObj = new Error () ;
			errObj.name = "Invalid Argument passed to function";
			errObj.message = msg;
			throw errObj;
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getDateAndTimeFromText():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

/**
 * Attack task phase function.
 */
function startAttackNAccept(a2b_doc, vi, ATask, antiFarm) {
	try {
		//flag ( "startAttackNAccept():: Started! village: " + vi );

		var xpathOk_btn = "";
		switch ( aTravianVersion ) {
			case "3.6":
				xpathOk_btn = './/input[@id="btn_ok" and @type!="hidden"]';
				break;
			case "4.0":
				xpathOk_btn = './/button[@id="btn_ok" and @type!="hidden"]';
				break;
			default:
				throwLogicError ( "startAttackNAccept():: Travian Version not set!!" );
		}
		if ( antiFarm == "" ) { // do only when not in anti-farm mode.
			var ok_btn = document.evaluate ( xpathOk_btn, a2b_doc, null, XPFirst, null );
			var errorText = document.evaluate('.//p[@class="error"]', a2b_doc, null, XPFirst, null);
			if ( ok_btn.singleNodeValue != null && errorText.singleNodeValue != null ) { // ok_btn exists & there is some error mentioned in response text.
				var xCoord = getXfromCoord(ATask[1]);
				var yCoord = getYfromCoord(ATask[1]);
				var targetcoord = "(" + xCoord + "|" + yCoord + ")";
				var villageUrl  = "";
				switch ( aTravianVersion ) {
					case "3.6":
						villageUrl = "<a class='spantooltip' style='color: Green' href='" +
							myhost + "/karte.php?newdid=" + vi + "&z=" + ATask[1] + "'>" + targetcoord + "</a>";
						break;
					case "4.0":
						villageUrl = "<a class='spantooltip' style='color: Green' href='" +
							myhost + "/karte.php?newdid=" + vi + "&x=" + xCoord + "&y=" + yCoord + "'>" + targetcoord + "</a>";
						break;
					default:
						throwLogicError ( "startAttackNAccept():: Travian Version not set!!" );
						break;
				}
				// if span exists, then target villa is in beginner's protection...
				if ( errorText.singleNodeValue.innerHTML.match(/<span>.*<\/span>/) != null ) {
					//var errormsg1 = "Village " + villageUrl + ", error: " +
					//	errorText.singleNodeValue.innerHTML;
					var errormsg2 = "Village " + targetcoord + ", error: " +
						errorText.singleNodeValue.innerHTML;
					printErrorMSG( errormsg1 );
					flag ( "startAttackNAccept():: " + errormsg2 );

					// get beginner's protection elapse time from error message...
					var newStartTime = getDateAndTimeFromText ( errorText.singleNodeValue.innerHTML, 1 );
					//flag ( "newStartTime: " + newStartTime.toDateString() + " " + newStartTime.toLocaleTimeString() );

					// set new starttime of attack task to after beginner's protection elapse time...
					var randominter = Math.ceil ( Math.random() * 5*60*1000 ) + 2*60*1000; // random 5 mins + 2 mins.
					var newTask = ATask.slice(0); // clone the array ATask.
					newTask[4] = newStartTime.getTime() + randominter;
					deleteTaskFromCookie(vi, ATask, newTask);
					calldoing1();
					showTaskList();
					return;
				}
				else { // no span, means no village at target coords or player is banned, hence delete attack task.
					var errormsg1 = getvillagefromdid(vi) + " (" + vi + "): " + 
						"Deleting " + aLangAttackType[ATask[2] - 2] + " Task to " + villageUrl + ", error: " +
						errorText.singleNodeValue.innerHTML;
					var errormsg2 = getvillagefromdid(vi) + " (" + vi + "): " + 
						"Deleting " + aLangAttackType[ATask[2] - 2] + " Task to " + targetcoord + ", error: " +
						errorText.singleNodeValue.innerHTML;
					printErrorMSG( errormsg1 );
					flag ( "startAttackNAccept():: " + errormsg2 );
					deleteTaskFromCookie(vi, ATask);
					calldoing1();
					showTaskList();
					return;
				}
			}
		}
		else { // when in anti-farm mode
			// if error is present on page, it means there are no troops currently in village to send out
			var ok_btn = document.evaluate ( xpathOk_btn, a2b_doc, null, XPFirst, null );
			var errorText = document.evaluate('.//p[@class="error"]', a2b_doc, null, XPFirst, null);
			if ( ok_btn.singleNodeValue != null && errorText.singleNodeValue != null ) { // ok_btn exists & there is some error mentioned in response text.
				var msg = "Seems like no troops in " + getvillagefromdid(vi) + " (" + vi + ") to send out for anti-farm!";
				flag ( "startAttackNAccept():: " + msg );
				printErrorMSG( "<b>" + msg + "</b>" );
				// add antiFarm to attacksToCallBack array to initiate call back for this attack.
				attacksToCallBack.push(antiFarm);
				return;
			}
		}

		var formCount = document.evaluate('.//form [ @action="a2b.php" and ( @method="POST" or @method="post" ) ]', a2b_doc, null, XPSnap, null).snapshotLength;
		if ( formCount > 1 ) {
			var urlToBuilding = "<a class='spantooltip' style='color: Green' href='"+
				myhost+"/a2b.php?newdid="+vi;
			switch ( aTravianVersion ) {
				case "3.6":
					urlToBuilding = urlToBuilding + "&z=" + ATask[1];
					break;
				case "4.0":
					var xCoord = getXfromCoord(ATask[1]);
					var yCoord = getYfromCoord(ATask[1]);
					urlToBuilding = urlToBuilding + "&x=" + xCoord + "&y=" + yCoord;
					break;
				default:
					throwLogicError ( "startAttackNPrepare():: Travian Version not set!!" );
			}
			var troo = ATask[6].split(",");
			for ( var ctr = 0; ctr < troo.length ; ctr++ )
				if ( troo[ctr] != "" && troo [ctr] != "0" )
					urlToBuilding = urlToBuilding + "&t" + (ctr+1) + "=" + troo[ctr];
			urlToBuilding = urlToBuilding + "&c=" + ATask[2];
			urlToBuilding = urlToBuilding + "'>Send Attack</a>";
			playSound ( "<b>startAttackNAccept():: Some Problem, send attack once manually! " + urlToBuilding + "</b>" );

			//if ( antiFarm == "" ) { // skip attack if not in anti-farm mode
			if ( true ) {
				var newTask = ATask.slice(0); // clone the array ATask.
				var nowt = new Date();
				// if attack strict order is disabled, set increment attack time by repeat interval
				if ( GM_getValue ( myacc() + "_attackStrictOrder", "0" ) == "0" ) {
					if (ATask[5] == "0") { // if repeat is set to 0, increment by 1 day +/- random 5 mins
						// delay by 24 hrs +/- random ( 5 )
						temp2 = getRandomizedTime ( 24*60*60*1000, 2 * 5*60*1000, 1 );
					}
					else if ( Number(ATask[5]) > 5*60*1000 ) { // else if repeat interval > 5 mins increment by repeat interval +/- random (repeat-interval/2)
						// delay by repeat interval +/- random ( repeat-interval / 2 )
						temp2 = getRandomizedTime ( Number(ATask[5]), Number(ATask[5]), 1 );
					}
					else { // else if repeat interval < 5 mins just increment by repeat interval
						temp2 = nowt.getTime() + Number(ATask[5]);
					}
					newTask[4] = temp2.toString();
				}
				deleteTaskFromCookie(vi, ATask, newTask);
				calldoing1();
				showTaskList();

				return false;
			}
		}

		var reqData, formTag;
		if (ATask == undefined)
		{ TS_debug("startAttackNAccept: Error - parameter definition missing!"); return; }
		formTag = getFormNode(a2b_doc);
		if (formTag == null)
		{ TS_debug("startAttackNAccept: Error - no form in the answer area"); return; }
		//TS_debug("startAttackNAccept: Callback starting");
		var reqUrl = myhost + "/a2b.php" + "?newdid=" + vi;
		// Other values stored in form
		var timestamp = getFormHidVal(formTag, "timestamp");
		var timestamp_checksum = getFormHidVal(formTag, "timestamp_checksum");
		// For unknown purposes, a mouse position over button is sent with the form
		var s1xPos = Math.floor(46*Math.random())+1;
		var s1yPos = Math.floor(19*Math.random())+1;
		// The other parameters from the previous a2b form
		idVal = getFormHidVal(formTag, "id");
		aVal = getFormHidVal(formTag, "a");
		cVal = getFormHidVal(formTag, "c"); // This value determines attack type
		kidVal = getFormHidVal(formTag, "kid");
		if ((formTag.innerHTML.indexOf("m\x65\x66i\x73\x74o") > 0) && (cVal != 2))
		{ startAttackNFinish(a2b_doc, vi, ATask); return; };
		var troo = ATask[6].split(",");
		kata = ATask[7];
		kata2 = ATask[8];
		scoutType = ATask[11];
		if ( scoutType == 0 ) {
			if (kata > 0) {
				reqData = "timestamp=" + timestamp + "&timestamp_checksum=" + timestamp_checksum + "&id=" + idVal + 
					"&a=" + aVal + "&c=" + cVal + "&kid=" + kidVal
				 + "&t1=" + troo[0] + "&t2=" + troo[1] + "&t3=" + troo[2] + "&t4=" + troo[3] + "&t5=" + troo[4] + "&t6=" + troo[5]
				 + "&t7=" + troo[6] + "&t8=" + troo[7] + "&t9=" + troo[8] + "&t10=" + troo[9] + "&t11=" + troo[10]
				 + "&kata=" + kata + "&kata2=" + kata2
				 + "&s1.x=" + s1xPos + "&s1.y=" + s1yPos + "&s1=ok"; //+ "&attacks=&cords=";  // TODO:: do we need &attacks= and &cords=
			} 
			else {
				reqData = "timestamp=" + timestamp + "&timestamp_checksum=" + timestamp_checksum + "&id=" + idVal + 
					"&a=" + aVal + "&c=" + cVal + "&kid=" + kidVal
				 + "&t1=" + troo[0] + "&t2=" + troo[1] + "&t3=" + troo[2] + "&t4=" + troo[3] + "&t5=" + troo[4] + "&t6=" + troo[5]
				 + "&t7=" + troo[6] + "&t8=" + troo[7] + "&t9=" + troo[8] + "&t10=" + troo[9] + "&t11=" + troo[10]
				 + "&s1.x=" + s1xPos + "&s1.y=" + s1yPos + "&s1=ok"; //+ "&attacks=&cords=";  // TODO:: do we need &attacks= and &cords=
			}
		}
		else {
			reqData = "timestamp=" + timestamp + "&timestamp_checksum=" + timestamp_checksum + "&id=" + idVal + 
				"&a=" + aVal + "&c=" + cVal + "&kid=" + kidVal
			 + "&t1=" + troo[0] + "&t2=" + troo[1] + "&t3=" + troo[2] + "&t4=" + troo[3] + "&t5=" + troo[4] + "&t6=" + troo[5]
			 + "&t7=" + troo[6] + "&t8=" + troo[7] + "&t9=" + troo[8] + "&t10=" + troo[9] + "&t11=" + troo[10]
			 + "&s1.x=" + s1xPos + "&s1.y=" + s1yPos + "&s1=ok&attacks=&cords=" + "&spy=" + scoutType;
		}

		var waitInterval = 0;
		if ( antiFarm == "" ) // normal mode 
			waitInterval = Math.ceil ( Math.random() * 700 ) + 300; // random ( 0.7 seconds ) + 0.3 seconds
		else // anti-farm mode
			waitInterval = Math.ceil ( Math.random() * 10 ) + 10; // random ( 0.01 seconds ) + 0.01 seconds

		window.setTimeout ( 
				function() { 
					TS_postRequest(reqUrl, reqData, startAttackNFinish, vi, ATask, antiFarm);
					reqUrl=null; reqData=null; vi=null; ATask=null;
				},
				waitInterval );

                //TS_postRequest(reqUrl, reqData, startAttackNFinish, vi, ATask);
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startAttackNAccept():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

/**
 * Attack task finalization function.
 */
function startAttackNFinish(a2b_doc, vi, ATask, antiFarm) {
	try {
		//flag ( "startAttackNFinish():: Started! village: " + vi );

		// if response is rally point page, then analyze rally point and update troop counts.
		var h1name = document.evaluate('//h1', a2b_doc, null, XPFirst, null).singleNodeValue;
		if ( h1name != null && h1name.innerHTML.indexOf(aLangAllBuildWithId[16]) != -1 )
			analyzeRallyPoint(a2b_doc,vi,false);

		if ( antiFarm == "" ) { // when not in anti-farm mode...
			if (ATask[3] == "0") {
				deleteTaskFromCookie(vi, ATask);
			} 
			else {
				//var newTask = new Array(); // |2_241654_3_0_1248014400000_0_0,0,0,0,0,5,0,0,0,0,0_0_0
				var newTask = ATask.slice(0); // clone the array ATask.
				var nowt=new Date();
				temp = Number(ATask[3]) - 1
				newTask[3] = temp.toString();
				// if attack strict order is disabled, set increment attack time by repeat interval
				if ( GM_getValue ( myacc() + "_attackStrictOrder", "0" ) == "0" ) {
					if (ATask[5] == "0") { // if repeat is set to 0, increment by 1 day +/- random 5 mins
						// delay by 24 hrs +/- random ( 5 )
						temp2 = getRandomizedTime ( 24*60*60*1000, 2 * 5*60*1000, 1 );
					}
					else if ( Number(ATask[5]) > 5*60*1000 ) { // else if repeat interval > 5 mins increment by repeat interval +/- random (repeat-interval/2)
						// delay by repeat interval +/- random ( repeat-interval / 2 )
						temp2 = getRandomizedTime ( Number(ATask[5]), Number(ATask[5]), 1 );
					}
					else { // else if repeat interval < 5 mins just increment by repeat interval
						temp2 = nowt.getTime() + Number(ATask[5]);
					}
					newTask[4] = temp2.toString();
				}
				deleteTaskFromCookie(vi, ATask, newTask);
			}
			var xCoord = getXfromCoord(ATask[1]);
			var yCoord = getYfromCoord(ATask[1]);
			var targetcoord = "(" + xCoord + "|" + yCoord + ")";
			var villageUrl  = "";
			switch ( aTravianVersion ) {
				case "3.6":
					villageUrl = "<a class='spantooltip' style='color: PaleVioletRed' href='" +
						myhost + "/karte.php?newdid=" + vi + "&z=" + ATask[1] + "'>" + targetcoord + "</a>";
					break;
				case "4.0":
					villageUrl = "<a class='spantooltip' style='color: PaleVioletRed' href='" +
						myhost + "/karte.php?newdid=" + vi + "&x=" + xCoord + "&y=" + yCoord + "'>" + targetcoord + "</a>";
					break;
				default:
					throwLogicError ( "startAttackNFinish():: Travian Version not set!!" );
					break;
			}
			var msg1 = getvillagefromdid(vi) + " (" + vi + "): " + aLangTaskOfText[31] + " to " + villageUrl;
			var msg2 = getvillagefromdid(vi) + " (" + vi + "): " + aLangTaskOfText[31] + " to " + targetcoord;
			printMSG ( msg1 );
			flag ( "startAttackNFinish():: " + msg2 );
			calldoing1();
			showTaskList();
		}
		else { // when in anti-form mode...

			var foundCallBackUrl = getAntiFarmCallBackUrls(a2b_doc, vi, antiFarm);
			if ( foundCallBackUrl == false ) {
				// &k for complete incoming troops in rally point, &j is for all outgoing troops
				/*var callBackUrl = myhost + "/build.php?gid=16&newdid="+vi+"&j"; // no need to analyze rally point here as &j is used and not &k
				TS_getRequest ( callBackUrl, getAntiFarmCallBackUrls, vi, antiFarm );*/
				getAntiFarmCallBackUrls2(vi, antiFarm);
			}
		}
		/*window.setTimeout ( 
				function() { 
					calldoing1();
					window.location.replace("dorf1.php?newdid=" + vi);
					vi=null;
				},
				Math.ceil(Math.random()*2000)+2000 ); // random ( 2 seconds ) + 2 seconds*/

		//window.location.replace("dorf1.php?newdid=" + vi);
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startAttackNFinish():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getAntiFarmCallBackUrls2(vi, antiFarm) {
	try {
		flag ( "getAntiFarmCallBackUrls2():: Started!" );
		// &k for complete incoming troops in rally point, &j is for all outgoing troops
		var url = myhost + "/build.php?gid=16&newdid="+vi+"&j"; // no need to analyze rally point here as &j is used and not &k
		function mycallback() {};
		var httpReqObj = new XMLHttpRequest();
		httpReqObj.open('GET', url, false);
		httpReqObj.onreadystatechange = mycallback;
		httpReqObj.send(null);
		function mycallback() {
			if (httpReqObj.readyState == 4) {
				if (httpReqObj.status == 200) {
					flag ( "getAntiFarmCallBackUrls2():: callback function Started!" );
					var aElem = document.createElement('DIV');
					aElem.innerHTML = httpReqObj.responseText;
					if ( gatherStats(aElem.innerHTML) ) {
						// attempt reloading page, captcha ll be found there too and script will stop.
						window.location.replace(myhost + "/spieler.php");
						return;
					}
					var foundCallBackUrl = getAntiFarmCallBackUrls(aElem, vi, antiFarm);
					if ( foundCallBackUrl == false ) { // still call-back url not found, probably something went wrong
						var msg = getvillagefromdid(vi) + " (" + vi + "): Troops sent out for anti-farm at " 
								+ new Date(serverNowTime).toLocaleTimeString() 
								+ ", however call-back url not found! Cannot call-back the attack!";
						printErrorMSG("<b>" + msg + "</b>");
						attacksToCallBack.push(antiFarm); // complete the anti-farm attack
					}
				}
			}
		}
		return mycallback();
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getAntiFarmCallBackUrls2():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getAntiFarmCallBackUrls(aElem, vi, antiFarm) {
	try {
		flag ( "getAntiFarmCallBackUrls():: Started!" );
		// check if anti-farm coordinates are set
		var antiFarmVilas = GM_getValue(myacc() + "_antiFarmVillage", "" );
		if ( antiFarmVilas == "" ) {
			var msg = "Anti-Farm coordinates not set, Anti-Farm cannot work! Halting!";
			printErrorMSG("<b>" + msg + "</b>");
			var msg1= "Set Anti-Farm coordinates from greasemonkey menu and then restart Auto-Task!";
			printErrorMSG("<b>" + msg1 + "</b>");
			flag ( "evadeVillage():: " + msg );
			var errObj = new Error () ;
			errObj.name = "User Error";
			errObj.message = msg;
			throw errObj;
		}
		antiFarmVilas = antiFarmVilas.split(";");

		// get anti-farm coordinates and build xpath
		var temp = "";
		for ( var ctr in antiFarmVilas ) {
			var coords = antiFarmVilas[ctr].split(",");
			coords = getCoordfromXY( coords[0], coords[1] );
			if ( temp == "" ) {
				temp = ' contains(@href,"karte.php?d=' + coords + '") ';
			}
			else {
				temp = temp + ' or contains(@href,"karte.php?d=' + coords + '") ';
			}
		}
		var xpathAbortAttacks = "";
		switch ( aTravianVersion ) {
			case "3.6":
				xpathAbortAttacks = './/*[@id="build"]/table[@class="troop_details"]/thead//td[@colspan="10" or @colspan="11"]//a[' + temp + 
					']/../../../..//div[@class="abort"]/a[contains(@href,"build.php")]';
				break;
			case "4.0":
				xpathAbortAttacks = './/*[@id="build"]/table[@class="troop_details outRaid"]/thead//td[@colspan="10" or @colspan="11"]//a[' + temp +
				       ']/../../../..//div[@class="abort"]/button[contains(@onclick,"build.php")]';
				break;
			default:
				throwLogicError ( "getAntiFarmCallBackUrls():: Travian Version not set!!" );
		}

		// check rally point for call-back urls, if there are urls for call-back put them in attacksCallBackUrl array.
		serverNowTime = new Date().getTime() - serverTimeDiff;
		var foundCallBackUrl = false;
		flag ( "getAntiFarmCallBackUrls():: [anti-farm mode]:: xpathAbortAttacks:\n" + xpathAbortAttacks );
		var abortAttack = document.evaluate(xpathAbortAttacks, aElem, null, XPList, null);
		for ( var ctr = 0; ctr < abortAttack.snapshotLength ; ctr++ ) {
			var abortAttackHref = "";
			switch ( aTravianVersion ) {
				case "3.6": abortAttackHref = abortAttack.snapshotItem(ctr).getAttribute("href"); break;
				case "4.0": abortAttackHref = abortAttack.snapshotItem(ctr).getAttribute("onclick").match(/href[ =]*'.*'/)[0].split("'")[1]; break;
				default: throwLogicError ( "getAntiFarmCallBackUrls():: Travian Version not set!!" );
			}
			flag ( "getAntiFarmCallBackUrls():: [anti-farm mode]:: abortAttackHref:\n" + abortAttackHref );
			attacksCallBackUrl.push(antiFarm + "_" + abortAttackHref + "_" + serverNowTime);
			foundCallBackUrl = true;
		}

		if ( foundCallBackUrl == true ) {
			// add antiFarm to attacksToCallBack array to initiate call back for this attack.
			attacksToCallBack.push(antiFarm);

			var msg = getvillagefromdid(vi) + " (" + vi + "): Troops sent out for anti-farm at " + new Date(serverNowTime).toLocaleTimeString();
			printErrorMSG("<b>" + msg + "</b>");
			flag ( msg );
		}
		else {
			var msg = getvillagefromdid(vi) + " (" + vi + "): Troops sent out for anti-farm at " + new Date(serverNowTime).toLocaleTimeString()
					+ ", but no call back urls found, will have to recheck!"
			flag ( msg );
		}

		return foundCallBackUrl;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getAntiFarmCallBackUrls():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getTrainData(vi, task) {
	try {
		flag ( "getTrainData():: Started! vi: " + vi );

		function callback() {};

		var url = myhost + "/build.php?newdid=" + vi + "&id=" + task[1];
		var getbuildurl = new XMLHttpRequest();
		getbuildurl.open('GET', url, false);
		getbuildurl.onreadystatechange = callback;
		getbuildurl.send(null);
		function callback() {
			if (getbuildurl.readyState == 4) {
				if (getbuildurl.status == 200) {
					flag ( "getTrainData() callback function!" );
					//var aDoc = document.implementation.createDocument("", "", null);
					var aElem = document.createElement('DIV');
					aElem.innerHTML = getbuildurl.responseText;
					//aDoc.appendChild(aElem);
					if ( gatherStats(aElem.innerHTML) ) {
						// attempt reloading page, captcha ll be found there too and script will stop.
						window.location.replace(myhost + "/spieler.php");
						return 60*60*1000;
					}

					var troo = task[5].split(",");
					var xpathMaxTroops = "";
					var xpathTroopType = "";
					switch ( aTravianVersion ) {
						case "3.6":
							xpathMaxTroops = './/table[@class="build_details"]/tbody/tr/td[@class="max"]/a[contains(@onclick,"value=")]';
							xpathTroopType = './/table[@class="build_details"]/tbody/tr/td[@class="val"]/input[@type="text" and contains(@name,"t") ]';
							break;
						case "4.0":
							xpathMaxTroops = './/div[@id="content"]//div[@class="buildActionOverview trainUnits"]//div[@class="details"]/'
										+ 'a[contains(@onclick,"value=")]';
							xpathTroopType = './/div[@id="content"]//div[@class="buildActionOverview trainUnits"]//div[@class="details"]/'
										+ 'input[@type="text" and contains(@name,"t") ]';
							break;
						default:
							throwLogicError ( "getTrainData():: Travian Version not set!!" );
					}
					var maxTroops = document.evaluate( xpathMaxTroops, aElem, null, XPOrdList, null);
					var typeTroops = document.evaluate( xpathTroopType, aElem, null, XPOrdList, null);
					if ( maxTroops.snapshotLength != typeTroops.snapshotLength ) {
						throwLogicError ( "getTrainData():: Then number of troops max value and troops count do not match!" );
					}

					if ( typeTroops.snapshotLength == 0 ) { // no troops can be trained, eg in residence which requires upgradation before troops can be trained
						var delayTime = 0;
						var delayT = Number ( GM_getValue ( myacc() + "_buildTrainDelayTime", "60" ) ) * 60*1000;
						var repeatVal = Number(task[4]); // repeat interval
						if ( delayT < repeatVal ) {
							// delay by delayT +/- random ( delayT/2 )
							delayTime = getRandomizedTime ( delayT, delayT, 1 );
						}
						else {
							// delay by repeat interval +/- random ( 0.5 repeat interval )
							delayTime = getRandomizedTime ( repeatVal, repeatVal, 1);
						}
						var msg = "getTrainData():: " + getvillagefromdid(vi) + "("+vi+"): No troops can be trained in " + task[6] + ", delaying by " +
							Math.round ( (delayTime-new Date().getTime())/(60*1000)*100 )/100 + " mins [ " + new Date(delayTime) + " ]";
						flag ( msg );
						printErrorMSG ( msg );
						var newTask = task.slice(0); // clone the array task.
						newTask[3] = delayTime;
						deleteTaskFromCookie(vi, task, newTask);
						return false;
					}

					for ( var i = 0; i < typeTroops.snapshotLength ; i++ ) {
						try {
							maxNum = parseInt(maxTroops.snapshotItem(i).innerHTML.match(/\d{1,}/)[0]);
							troopType = parseInt(typeTroops.snapshotItem(i).getAttribute("name").match(/\d{1,}/)[0]) - 1;
						} catch (err) {
							printStackTrace();
							var msg = " :: getTrainData():: Training task failed!"; 
							err.message += msg;
							TS_debug ( err.name + " :: " + err.message );
							throw err;
						}
						// When training is completely not possible then delay it by some time, else if training is possible for smaller 
						// number of troops, then do it. This makes sure that the task doesn't get deleted when no troops can be trained.
						if ( troo[troopType] > 0 && maxNum == 0 ) {
							if ( parseInt(troo[troopType]) > maxNum ) {
								var delayTime = 0;
								var delayT = Number ( GM_getValue ( myacc() + "_buildTrainDelayTime", "60" ) ) * 60*1000;
								var repeatVal = Number(task[4]); // repeat interval
								if ( delayT < repeatVal ) {
									// delay by delayT +/- random ( delayT/2 )
									delayTime = getRandomizedTime ( delayT, delayT, 1 );
								}
								else {
									// delay by repeat interval +/- random ( 0.5 repeat interval )
									delayTime = getRandomizedTime ( repeatVal, repeatVal, 1);
								}
								flag ( "getTrainData():: Not enough resources for training, delaying by " +
									Math.round ( (delayTime-new Date().getTime())/(60*1000)*100 )/100 + " mins [ " + new Date(delayTime) + " ]" );
								var newTask = task.slice(0); // clone the array task.
								newTask[3] = delayTime;
								deleteTaskFromCookie(vi, task, newTask);
								return false;
							}
						}
						else
							troo[troopType] = ( troo[troopType] < maxNum ) ? troo[troopType] : maxNum;
					}

					/*var input = aElem.getElementsByTagName("input");
					for (var m = 0; m < input.length; m++) {
						if (input[m].getAttribute("name") == "z") {
							z = input[m].getAttribute("value");
							break;
						}
					}*/

					var formCount = document.evaluate('.//form [ @name="snd" and ( @method="POST" or @method="post" ) ]', aElem, null, XPSnap, null).snapshotLength;
					if ( formCount > 1 ) {
						var urlToBuilding = "<a class='spantooltip' style='color: Green' href='"+
							myhost+"/build.php?newdid="+vi+"&id="+task[1]+"'>"+task[6]+"</a>";
						playSound ( "<b>getTrainData():: Some Problem, train once manually! " + urlToBuilding + "</b>" );

						// delay train
						var newTask = task.slice(0); // clone the array tTask.
						var nowt = new Date();
						if ( task[4] == "0" || task[4] == "" ) { // if next interval is not set, delay by 3 hrs.
							// delay by by 3 hrs +/- random ( 1.5 hrs )
							var threeHrs = 3*60*60*1000; // 3 hrs
							temp2 = getRandomizedTime ( threeHrs, threeHrs, 1); // delay by 3 hrs +/- random ( 1.5 hrs )
						}
						else {
							// delay by repeat interval +/- random ( 0.5 repeat interval )
							var repeatVal = Number(task[4]); // repeat interval
							temp2 = getRandomizedTime ( repeatVal, repeatVal, 1); // delay by repeat interval +/- random ( repeat interval / 2 )
						}
						newTask[3] = temp2.toString();
						deleteTaskFromCookie(vi, task, newTask);

						return false;
					}

					var zHiddenValue = document.evaluate('.//input[@name="z" and @type="hidden" and @value]', aElem, null, XPFirst, null).singleNodeValue.value;
					var aHiddenValue = document.evaluate('.//input[@name="a" and @type="hidden" and @value]', aElem, null, XPFirst, null).singleNodeValue.value;

					/*var noOfHiddenValues = document.evaluate ( './/*[@type="hidden"]', aElem, null, XPSnap, null ).snapshotLength;
					flag ( "startAttackNPrepare():: Number of hidden values in attack form: " + noOfHiddenValues );
					if ( noOfHiddenValues != 3 ) {
						printErrorMSG ( "getTrainData():: " + getvillagefromdid(vi) + " (" + vi + "): " +
								"Unaccounted number of hidden values in train form: " + noOfHiddenValues );
					}*/

					trainstring = "id=" + task[1] + "&z=" + zHiddenValue + "&a=" + aHiddenValue;
					for ( var ctr = 0 ; ctr < troo.length ; ctr++ ) {
						if ( parseInt(troo[ctr]) > 0 )
							trainstring += "&t" + (parseInt(ctr)+1) + "=" + troo[ctr];
					}
					/*trainstring = "id="+task[1]+"&z="+z+"&a=2" + "&t1=" + troo[0] + "&t2=" + troo[1] + "&t3=" + troo[2] + 
						"&t4=" + troo[3] + "&t5=" + troo[4] + "&t6=" + troo[5] + "&t7=" + troo[6] + "&t8=" + troo[7] + 
						"&t9=" + troo[8] + "&t10=" + troo[9];*/
					return trainstring;
				}
			}
		}
		return callback();
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getTrainData():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function startTrainNowExecute(vi,tTask,url,daa) {
	try {
		flag ( "startTrainNowExecute():: Started! vi: " + vi + ", url: " + url + ", daa: " + daa );
		dataa = encodeURI(daa);
		GM_xmlhttpRequest({
			method: 'POST',
			url: url,
			headers: {
				'Accept': 'application/atom+xml,application/xml,text/xml',
				'Content-type': 'application/x-www-form-urlencoded'
			},
			data: dataa,
			onload: function(response){
				if ( gatherStats(response.responseText) ) {
					// attempt reloading page, captcha ll be found there too and script will stop.
					window.location.replace(myhost + "/spieler.php");
					return false;
				}
				var aElem = document.createElement("div");
				aElem.innerHTML = response.responseText;
				refreshPageInfo(aElem);

				flag ( "startTrainNowExecute() callback function! Training Done!");
				if (tTask[2] == "0") {
					deleteTaskFromCookie(vi, tTask);
				}
				else {
					var newTask = tTask.slice(0); // clone the array tTask.
					var nowt=new Date();
					newTask[2] = ( Number ( tTask[2] ) - 1 ).toString();
					if ( tTask[4] == "0" || tTask[4] == "" ) { // if next interval is not set, delay by 3 hrs.
						// delay by by 3 hrs +/- random ( 1.5 hrs )
						var threeHrs = 3*60*60*1000; // 3 hrs
						temp2 = getRandomizedTime ( threeHrs, threeHrs, 1); // delay by 3 hrs +/- random ( 1.5 hrs )
					}
					else {
						// delay by repeat interval +/- random ( 0.5 repeat interval )
						var repeatVal = Number(tTask[4]); // repeat interval
						temp2 = getRandomizedTime ( repeatVal, repeatVal, 1); // delay by repeat interval +/- random ( repeat interval / 2 )
					}
					newTask[3] = temp2.toString();
					deleteTaskFromCookie(vi, tTask, newTask);
				}
				calldoing1();
				showTaskList();
				printMSG ( getvillagefromdid(vi) + " (" + vi + "): " + aLangTaskOfText[34] );
			}
		});
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startTrainNowExecute():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function startTrainNow(vi,tTask) {
	try {
		//flag ( "startTrainNow():: vi: " + vi + ", tTask: " + tTask );
		url = myhost + "/build.php" + "?newdid=" + vi;
		daa = getTrainData ( vi, tTask );
		// When training is completely not possible then delay it by some time, else if training is possible for smaller 
		// number of troops, then do it. This makes sure that the task doesn't get deleted when no troops can be trained.
		if ( daa != false ) {
			window.setTimeout ( 
				function() { 
						startTrainNowExecute(vi,tTask,url,daa);
						vi=null; tTask=null; url=null; daa=null;
					},
					Math.ceil ( Math.random() * 2000 ) + 500 ); // random ( 2 seconds ) + 0.5 seconds
		}
		else {
			calldoing1();
			showTaskList();
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startTrainNow():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// opens market to start custom transport
function startCustomTranNow(vi, task) {//8_241654_500,500,500,500_0_1245413194000_interval
	try {
		flag ( "startCustomTranNow():: Started! vi: " + vi );

		var turl = myhost + "/build.php?newdid=" + vi + "&gid=17";
		GM_xmlhttpRequest({
			method: 'GET',
			url: turl,
			headers: "",
			onload: function(responseDetails){
				flag ( "startCustomTranNow():: CallBack Started!" );

				if ( gatherStats(responseDetails.responseText) ) {
					// attempt reloading page, captcha ll be found there too and script will stop.
					window.location.replace(myhost + "/spieler.php");
					return false;
				}

				var ssElem = document.createElement('DIV');
				ssElem.innerHTML = responseDetails.responseText;

				refreshPageInfo(ssElem);

				var formCount = document.evaluate('.//form [ @name="snd" and ( @method="POST" or @method="post" ) ]', ssElem, null, XPSnap, null).snapshotLength;
				if ( formCount > 1 ) {
					var tarLoc = ( task[0] == "5" ) ? task[3] : task[1] ;
					var urlToBuilding = "<a class='spantooltip' style='color: Green' href='"+
						myhost+"/build.php?newdid="+vi+"&gid=17&z="+ tarLoc +"'>Send Resources</a>";
					playSound ( "<b>startCustomTranNow():: Some Problem, send resources once manually! " + urlToBuilding + "</b>" );
					var newTask = task.slice(0); // clone the array task.
					if (task[5] == "0") { // if repeat interval not set, delay 6 hours
						// delay by 6 hrs +/- random ( 3 hr )
						temp2 = getRandomizedTime ( 6*60*60*1000, 2*3*60*60*1000, 1 );
					}
					else {
						// delay by repeat interval +/- random ( repeat interval / 2 )
						temp2 = getRandomizedTime ( Number(task[5]), Number(task[5]), 1 );
					}
					newTask[4] = temp2.toString();
					deleteTaskFromCookie(vi, task, newTask);
					calldoing1();
					showTaskList();
					return false;
				}

				var resource = getGMCookie("ResourceNow",vi);

				var hereRemain = GM_getValue(myacc() + "_" + vi + "_userRemainSetup", "0/0");
				var hereremainn = hereRemain.split("/");
				hereremainn[0] = parseInt(hereremainn[0]);
				hereremainn[1] = parseInt(hereremainn[1]);

				var xpathId = "";
				switch ( aTravianVersion ) {
					case "3.6": xpathId = './/div[@id="textmenu"]/descendant::a[@href]'; break;
					case "4.0": xpathId = './/div[@class="contentNavi tabNavi"]//div[@class="container active"]//a[@href]'; break;
					default: throwLogicError ( "createbuildlink():: Travian Version not set!!" );
				}
				var ids = document.evaluate ( xpathId, ssElem, null, XPFirst, null );
				theid = ids.singleNodeValue.href.match(/\bid=\d{1,}\b/)[0].split("id=")[1];

				var comm = ["", ""];

				// find max resources per merchant
				var pp = document.evaluate('.//table[@id="send_select"]/descendant::td[@class="max"]/a', ssElem, null, XPFirst, null);
				comm[1] = pp.singleNodeValue.innerHTML.match(/\d{3,4}/);

				// get merchants available in village
				var xpathMerchantCount = "";
				switch ( aTravianVersion ) {
					case "3.6": xpathMerchantCount = './/table[@id="target_select"]/descendant::td[@class="mer"]'; break;
					case "4.0": xpathMerchantCount = './/div[contains(@class,"traderCount")]/div[@class="boxes-contents"]'; break;
					default: throwLogicError ( "startCustomTranNow():: Travian Version not set!!" );
				}
				var qq = document.evaluate ( xpathMerchantCount, ssElem, null, XPFirst, null );
				comm[0] = qq.singleNodeValue.innerHTML.split(" ")[1].split("/")[0];

				TS_debug("now Merchants at home is " + comm[0] + ", and each Merchants can load " + comm[1]);
				comm[0] = parseInt(comm[0]); // current count of merchants in village
				comm[1] = parseInt(comm[1]); // max resource per merchant

				var minResourceToSend = Number ( GM_getValue ( myacc() + "_customTransferMinResourceToSend", "100" ) );

				// for startCustomTranNow() we cannot check for resources in destination villages, as startCustomTranNow() can send resources to
				// villages other than ours.
				if ( (resource[0] - hereremainn[0]) >= minResourceToSend || (resource[1] - hereremainn[0]) >= minResourceToSend || 
					(resource[2] - hereremainn[0]) >= minResourceToSend || (resource[3] - hereremainn[1]) >= minResourceToSend ) { // if enough resources to send
					var delayCustomTransfer = false;
					if ( comm[0] > 0 ) { // if merchants are available

						var balance = task[2].split(","); // resources to transfer
						balance[0] = Number(balance[0]);
						balance[1] = Number(balance[1]);
						balance[2] = Number(balance[2]);
						balance[3] = Number(balance[3]);

						// get max amount than can be transfered based on merchants available and resources to retain in source village
						baalaa = getTranAmount(balance, comm, resource, hereremainn);
						//flag ( "baalaa: " + baalaa );
						var baalaasum = 0;
						for ( var ictr = 0; ictr < baalaa.length ; ictr++ )
							baalaasum += Number(baalaa[ictr]);
						if ( baalaasum == 0 )
							delayCustomTransfer = true;
						else
							autoTranRequire(task, baalaa, vi, theid);
					}
					else
						delayCustomTransfer = true;
					if ( delayCustomTransfer == true ) { // if merchants are not available or total resource to transfer is 0
						var newTask = task.slice(0); // clone the array task.
						var temp2 = 0;
						if (task[5] == "0") { // if repeat interval not set, delay 6 hours
							// delay by 1 hrs +/- random ( 0.5 hr )
							temp2 = getRandomizedTime ( 1*60*60*1000, 2 * 30*60*1000, 1 );
						}
						else {
							// delay by repeat interval / 6 +/- random ( repeat interval / 12 )
							temp2 = getRandomizedTime ( Number(task[5])/6, Number(task[5])/6, 1 );
						}
						newTask[4] = temp2.toString();
						deleteTaskFromCookie(vi, task, newTask);
						calldoing1();
						showTaskList();
						flag ( "startCustomTranNow():: No merchant now or resource to send is 0, delaying custom Transport!" );
					}
				}
				else { // if not enough resources to send
					var newTask = task.slice(0); // clone the array task.
					var temp2;
					if ( task[5] == "0" ) {
						// delay by 1 hrs +/- random ( 0.5 hr )
						temp2 = getRandomizedTime ( 1*60*60*1000, 2 * 30*60*1000, 1 );
					}
					else {
						// delay by repeat interval / 6 +/- random ( repeat interval / 12 )
						temp2 = getRandomizedTime ( Number(task[5])/6, Number(task[5])/6, 1 );
					}
					newTask[4] = temp2.toString();
					deleteTaskFromCookie(vi, task, newTask);
					calldoing1();
					showTaskList();
					flag ( "startCustomTranNow():: Not enough resource, delaying custom Transport!" );
				}
			}
		});
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startCustomTranNow():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function startImproNowExecute ( vi, Task, improveurl ) {
	try {
		flag ( "startImproNowExecute():: Started! vi: " + vi + ", improveurl: " + improveurl );

		if ( improveurl.match(/\bnewdid=/) == null ) { // if improveurl does not have newdid, add newdid
			improveurl = improveurl + "&newdid=" + vi;
		}
		var url = improveurl;
		flag ( "startImproNowExecute():: improve url: " + url );
		GM_xmlhttpRequest({
			method: 'GET',
			url: url,
			headers: {
				'Accept': 'application/atom+xml,application/xml,text/xml',
				'Content-type': 'application/x-www-form-urlencoded'
			},
			data: "",
			onload: function(responseDetails) {
				TS_debug ( "startImproNowExecute():: Callback Started!" );
				if ( gatherStats(responseDetails.responseText) ) {
					// attempt reloading page, captcha ll be found there too and script will stop.
					window.location.replace(myhost + "/spieler.php");
					return false;
				}

				var ssDoc = document;//.implementation.createDocument("", "", null);
				var ssElem = document.createElement('DIV');
				ssElem.innerHTML = responseDetails.responseText;
				refreshPageInfo(ssElem);

				var timer = $g ( './/*[@id="build" or @id="content"]//*[contains(@id,"timer")]', XPFirst, ssElem );
				var Tasktime = null;
				if ( timer ) {
					var ttar = timer.textContent.split(":");
					var finTime = Number(ttar[0]) * 60*60*1000 + Number(ttar[1]) * 60*1000 + Number(ttar[2]) * 1000;
					// delay by finTime + 15 mins +/- random ( 15 mins )
					Tasktime = getRandomizedTime ( finTime + 15*60*1000, 2*15*60*1000, 1 );
					printMSG ( getvillagefromdid(vi) + " (" + vi + "): " + aLangTaskOfText[48] + " " + aLangTaskOfText[5] );
				} 
				else {
					// delay by 1 hour + 15 mins +/- random ( 15 mins )
					Tasktime = getRandomizedTime ( 1*60*60*1000 + 15*60*1000, 2*15*60*1000, 1 );
					TS_debug("startImproNowExecute():: improve failed: " + url);
				}
				var newTask = Task.slice(0); // clone the array Task.
				newTask[6] = Tasktime.toString();
				deleteTaskFromCookie(vi, Task, newTask);
				calldoing1();
				showTaskList();
			}
		});
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startImproNowExecute():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function startImproNow ( vi, Task ) {
	try {
		TS_debug ( "startImproNow():: Started! vi: " + vi + ", village: " + getvillagefromdid(vi) );
		var improveurl = getImproveUrl ( vi, Task );
		if ( improveurl ) {
			window.setTimeout ( 
				function() { 
					startImproNowExecute ( vi, Task, improveurl );
					vi=null; Task=null; improveurl=null;
					},
					Math.ceil ( Math.random() * 5000 ) + 500 ); // random ( 5 seconds ) + 0.5 seconds
		}
		else{
			calldoing1();
			showTaskList();
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startImproNow():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getImproveUrl(vi,Task) {
	try {
		flag ( "getImproveUrl():: Started! vi: " + vi );
		var url = "";
		switch (Task[1]) {
			case "1":
				// blacksmith
				switch ( aTravianVersion ) {
					case "3.6":
						url = myhost + "/build.php?newdid=" + vi + "&gid=12"; break;
					case "4.0":
						url = myhost + "/build.php?newdid=" + vi + "&gid=13"; break;
					default:
						throwLogicError ( "getImproveUrl():: Travian Version not set!!" );
				}
				break;
			case "2":
				// armoury
				url = myhost + "/build.php?newdid=" + vi + "&gid=13";
				break;
			default:
				TS_debug("got Task[1] = " + Task[1] + "??");
		}
		//TS_debug ( "getImproveUrl():: url: " + url );

		function callback() {};

		var getbuildurl = new XMLHttpRequest();
		getbuildurl.open('GET', url, false);
		getbuildurl.onreadystatechange = callback;
		getbuildurl.send(null);
		function callback(){
			if (getbuildurl.readyState == 4) {
				if (getbuildurl.status == 200) {
					TS_debug ( "getImproveUrl():: Callback Started!" );
					var aElem = document.createElement('DIV');
					aElem.innerHTML = getbuildurl.responseText;
					if ( gatherStats(aElem.innerHTML) ) {
						// attempt reloading page, captcha ll be found there too and script will stop.
						window.location.replace(myhost + "/spieler.php");
						return false;
					}
					refreshPageInfo(aElem);

					var xpathTroopList = "";
					var xpathTroopname = "";
					var xpathTroopLevel = "";
					var xpathTroopsLink = "";
					var xpathImproveError = "";
					switch ( aTravianVersion ) {
						case "3.6":
							xpathTroopList = 'id("build")/table[@class="build_details"]/tbody/tr';
							xpathTroopname = './td[@class="desc"]/div/a';
							xpathTroopLevel = './td[@class="desc"]/div/span[@class="info"]';
							xpathTroopsLink = './td[@class="act"]/a';
							xpathImproveError = './td[@class="act"]/span[@class="none"]';
							break;
						case "4.0":
							xpathTroopList = 'id("build")/div[contains(@class,"researches")]/div[@class="research"]/div[@class="information"]';
							xpathTroopname = './div[@class="title"]/a[2]';
							xpathTroopLevel = './div[@class="title"]/span[@class="level"]';
							xpathTroopsLink = './div[@class="contractLink"]/button[@class="contracting" and contains(@onclick,"href")]';
							xpathImproveError = './div[@class="contractLink"]/span[@class="none"]';
							break;
						default: throwLogicError ( "getImproveUrl():: Travian Version not set!!" );
					}
					
					var troopList = document.evaluate ( xpathTroopList, aElem, null, XPOrdList, null );

					var myRace1 = Number(GM_getValue(myacc() + "_raceID"));
					//flag ( "getImproveUrl():: troopList.snapshotLength = " + troopList.snapshotLength );
					if ( troopList.snapshotLength == 0 ) {
						// delay by 1 hour + 15 mins +/- random ( 15 mins )
						var Tasktime = getRandomizedTime ( 1*60*60*1000 + 15*60*1000, 2*15*60*1000, 1 );
						TS_debug ( "getImproveUrl():: " + getvillagefromdid(vi) + "("+vi+"), improve not possible, "
								+ "probably 1st level of building under construction "
								+ ", next attempt at: " + new Date(Tasktime).toString() );
						var newTask = Task.slice(0); // clone the array Task.
						newTask[6] = Tasktime.toString();
						deleteTaskFromCookie(vi, Task, newTask);
						return false;
					}

					for ( var i = 0; i < troopList.snapshotLength ; i++ ) {
						var troop = troopList.snapshotItem(i);

						var troopNameElem = $g ( xpathTroopname, XPFirst, troop );
						var troopname = troopNameElem.textContent.replace(/\n/g,"");

						var gettroopslevel = $g ( xpathTroopLevel, XPFirst, troop );
						var trooplevel0 = gettroopslevel.innerHTML.replace(/\n/g,"").replace(/\s/g," ").split(" ");
						var trooplevel = "";
						var trooplevelRaw = trooplevel0[trooplevel0.length-1].match(/(\d{1,}|\+| )*/)[0];
						if ( trooplevelRaw.match(/\+/g) ) {
							var trooplevelcomponents = trooplevelRaw.split("+");
							trooplevel = parseInt(trooplevelcomponents[0].match(/\d{1,}/)[0]) + parseInt(trooplevelcomponents[1].match(/\d{1,}/)[0]);
						}
						else {
							trooplevel = trooplevelRaw.match(/\d{1,}/)[0];
						}

						if ( troopname == Task[3] ) {
							flag ( "getImproveUrl():: Attempting to improve \"" + troopname + "\" from level "
									+ trooplevel + "(" + trooplevelRaw + ") to level " + Task[5] );
							// GotGs 2011.01.15 -- proceed only if troop level is less than what is mentioned in the task ow return.
							if ( Number(trooplevel) >= Number(Task[5]) ) {
								TS_debug ( "getImproveUrl():: \"" + troopname
										+ "\" is already at (or higher) specified level, will not improve & deleting task." );
								deleteTaskFromCookie(vi, Task);
								return false;
							}
							var theposs = $g ( xpathTroopsLink, XPFirst, troop);
							if ( theposs ) {
								switch ( aTravianVersion ) {
									case "3.6":
										var retHref = theposs.getAttribute("href");
										TS_debug("getImproveUrl():: improve href = " + retHref);
										return retHref;
									case "4.0":
										var retHref = theposs.getAttribute("onclick").match(/href[ =]+'.*'/)[0].match(/'.*'/)[0].replace(/'/g,"");
										TS_debug("getImproveUrl():: improve href = " + retHref);
										return retHref;
									default:
										throwLogicError ( "getImproveUrl():: Travian Version not set!!" );
								}
							}
							else {
								var improveError = $g ( xpathImproveError, XPFirst, troop);
								if ( improveError )
									improveError = stripHTML ( improveError.innerHTML.replace(/\n/g,"") );
								else
									improveError = "Cannot get Improve Error!";
								var timer = $g ( './/*[@id="build" or @id="content"]//*[contains(@id,"timer")]', XPFirst, aElem );
								var Tasktime = null;
								if ( timer ) {
									var finiTime = timer.innerHTML;
									var ttar = finiTime.split(":");
									var finTime = Number(ttar[0]) * 60*60*1000 + Number(ttar[1]) * 60*1000 + Number(ttar[2]) * 1000;
									// delay by finTime + 15 mins +/- random ( 15 mins )
									Tasktime = getRandomizedTime ( finTime + 15*60*1000, 2*15*60*1000, 1 );
									TS_debug ( "getImproveUrl():: " + getvillagefromdid(vi) + "("+vi+"), some improve going on, next attempt at: "
											+ new Date(Tasktime).toString() );
								}
								else { // no timer found, try again in 1 hour
									// delay by 1 hour + 15 mins +/- random ( 15 mins )
									Tasktime = getRandomizedTime ( 1*60*60*1000 + 15*60*1000, 2*15*60*1000, 1 );
									TS_debug ( "getImproveUrl():: " + getvillagefromdid(vi) + "("+vi+"), improve not possible, error: "
											+ improveError + ", next attempt at: " + new Date(Tasktime).toString() );
								}
								var newTask = Task.slice(0); // clone the array Task.
								newTask[6] = Tasktime.toString();
								deleteTaskFromCookie(vi, Task, newTask);
								return false;
							}
							break;
						}
					}
				}
			}
		}
		return callback();
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getImproveUrl():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function startPartyNowExecute(vi, Task, url) {
	try {
		flag ( "startPartyNowExecute():: Started! vi: " + vi + ", url: " + url );
		GM_xmlhttpRequest
		({
			method: 'GET',
			url: url,
			headers: {
				'Accept': 'application/atom+xml,application/xml,text/xml',
				'Content-type': 'application/x-www-form-urlencoded'
			},
			data: "",
			onload: function(responseDetails){
				flag ( "startPartyNowExecute():: CallBack Started!" );

				if ( gatherStats(responseDetails.responseText) ) {
					// attempt reloading page, captcha ll be found there too and script will stop.
					window.location.replace(myhost + "/spieler.php");
					return false;
				}

				var ssElem = document.createElement('DIV');
				ssElem.innerHTML = responseDetails.responseText;

				refreshPageInfo(ssElem);

				var timer = $g ( './/*[@id="build" or @id="content"]//*[contains(@id,"timer")]', XPFirst, ssElem );
				if ( timer ) {
					flag ( "startPartyNowExecute():: " + getvillagefromdid(vi) + "("+vi+"):: Party hold ok!" );
					var finiTime = timer.innerHTML.match(/\d{1,2}:\d{2}:\d{2}/);
					var ttar = finiTime.toString().split(":");
					var finTime = Number(ttar[0]) * 60*60*1000 + Number(ttar[1]) * 60*1000 + Number(ttar[2]) * 1000;
					// delay by finTime + 15 mins +/- random ( 15 mins )
					var Tasktime = getRandomizedTime ( finTime + 15*60*1000, 2*15*60*1000, 1 );
					if (Task[2] == "0") {
						deleteTaskFromCookie(vi, Task);
					}
					else {
						flag ( "startPartyNowExecute():: " + getvillagefromdid(vi) + "("+vi+"):: Next Party at " + new Date ( Tasktime ) );
						var newTask = Task.slice(0); // clone the array Task.
						temp = Number(Task[2]) - 1;
						newTask[2] = temp.toString();
						newTask[3] = Tasktime.toString();
						deleteTaskFromCookie(vi, Task, newTask);
					}
					calldoing1();
					showTaskList();
					printMSG ( getvillagefromdid(vi) + " (" + vi + "): " + aLangTaskOfText[39] + " " + aLangTaskOfText[5] );
				}
				else {
					flag ( "startPartyNowExecute():: " + getvillagefromdid(vi) + "("+vi+"):: Party Failed!" );
					// delay by 1 hrs + 15 mins +/- random ( 15 mins )
					var Tasktime = getRandomizedTime ( 1*60*60*1000 + 15*60*1000, 2*15*60*1000, 1 );
					flag ( "startPartyNowExecute():: " + getvillagefromdid(vi) + "("+vi+"):: Next Party attempt at " + new Date ( Tasktime ) );
					var newTask = Task.slice(0); // clone the array Task.
					newTask[3] = Tasktime.toString();
					deleteTaskFromCookie(vi, Task, newTask);
					calldoing1();
					showTaskList();
				}
			}
		});
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startPartyNowExecute():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function startPartyNow(vi, Task) { // 6_1_1000_1245413194000_id
	try {
		flag("startPartyNow():: Started! vi: " + vi + ", village: " + getvillagefromdid(vi) );
		//TS_debug("FM -------- come into startPartyNow() at vi="+getvillagefromdid(vi));
		//TS_debug("FM -------- come into startPartyNow() at vi="+vi);
		//TS_debug("FM -------- come into startPartyNow() at vi="+Task[4]);
		var partyurl = getPartyUrl(vi,Task);
		if (partyurl) {
			url = myhost + "/build.php" + "?newdid=" + vi + "&id=" + Task[4] + "&a="+Task[1]; // Task[1] specifies small (1) or big (2) party
			flag("startPartyNow():: url="+url);

			window.setTimeout ( 
				function() { 
					startPartyNowExecute(vi, Task, url); // TODO: why using url here instead of partyurl!
					vi=null; Task=null; url=null;
					},
					Math.ceil ( Math.random() * 2000 ) + 500 ); // random ( 2 seconds ) + 0.5 seconds
			//startPartyNowExecute(vi, Task, url);
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startPartyNow():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getPartyUrl(vi, Task) {
	try {
		flag ( "getPartyUrl():: Started! vi: " + vi + ", village: " + getvillagefromdid(vi) );

		var url = myhost + "/build.php?newdid=" + vi + "&gid=24";
		function callback() {};
		var getbuildurl = new XMLHttpRequest();
		getbuildurl.open('GET', url, false);
		getbuildurl.onreadystatechange = callback;
		getbuildurl.send(null);
		function callback() {
			if (getbuildurl.readyState == 4) {
				if (getbuildurl.status == 200) {
					flag ( "getPartyUrl():: CallBack Started!" );

					var aElem = document.createElement('DIV');
					aElem.innerHTML = getbuildurl.responseText;
					if ( gatherStats(aElem.innerHTML) ) {
						// attempt reloading page, captcha ll be found there too and script will stop.
						window.location.replace(myhost + "/spieler.php");
						return false;
					}
					refreshPageInfo(aElem);

					var xpathParyUrl = "";
					switch ( aTravianVersion ) {
						case "3.6":
							xpathParyUrl = './/td[@class="act"]';
							break;
						case "4.0":
							xpathParyUrl = './/div[contains(@class,"build_details")]//div[@class="contractLink"]';
							break;
						default:
							throwLogicError ( "getPartyUrl():: Travian Version not set!!" );
					}
					var theinner = document.evaluate ( xpathParyUrl, aElem, null, XPOrdList, null);

					if ( theinner.snapshotLength == 0 ) {
						// delay by 1 hrs + 15 mins +/- random ( 15 mins )
						var Tasktime = getRandomizedTime ( 1*60*60*1000 + 15*60*1000, 2*15*60*1000, 1 );
						flag ( "getPartyUrl():: " + getvillagefromdid(vi) + "("+vi+"):: Party Delayed to " + new Date ( Tasktime ) );
						var newTask = Task.slice(0); // clone the array Task.
						newTask[3] = Tasktime.toString();
						deleteTaskFromCookie(vi, Task, newTask);
						calldoing1();
						showTaskList();
						return false;
					}

					switch ( Task[1] ) {
						case "1": // small party
							theinner = theinner.snapshotItem(0);
							break;
						case "2": // big party
							theinner = theinner.snapshotItem(1);
							break;
					}

					var urlFound = false;
					switch ( aTravianVersion ) {
						case "3.6":
							if ( theinner.firstChild.href ) {
								urlFound = true;
								var partyUrl = theinner.firstChild.getAttribute("href");
								return partyUrl;
							}
							break;
						case "4.0":
							var xpathPartyButton = './/button[contains(@onclick,"a=")]';
							var partyUrl = document.evaluate ( xpathPartyButton, theinner, null, XPFirst, null).singleNodeValue;
							if ( partyUrl ) {
								urlFound = true;
								partyUrl = partyUrl.getAttribute("onclick").match(/href[ =]*'.*'/)[0].split("'")[1];
								return partyUrl;
							}
							break;
						default:
							throwLogicError ( "getPartyUrl():: Travian Version not set!!" );
					}
					if ( urlFound == false ) {
						var partyError = "";
						switch ( aTravianVersion ) {
							case "3.6":
								partyError = theinner.firstChild.innerHTML;
								break;
							case "4.0":
								partyError = theinner.firstChild.nextSibling.innerHTML;
								break;
							default: throwLogicError ( "getPartyUrl():: Travian Version not set!!" );
						}
						var Tasktime = null;
						// GotGs 2011.01.15 -- sometimes partyError contains a <BR/> which creates problems!!
						if ( partyError != aLangErrorText[9] && partyError != aLangErrorText[0] )
							partyError = partyError.replace(/\<br ?\/\>/gi,"");
						flag ( "getPartyUrl():: " + getvillagefromdid(vi) + "("+vi+"):: partyError: " + partyError );
						//flag ( "aLangErrorText[9]: " + aLangErrorText[9] );
						//flag ( "aLangErrorText[0]: " + aLangErrorText[0] );
						//flag ( "aLangErrorText[7]: " + aLangErrorText[7] );
						if ( partyError.indexOf(aLangErrorText[9]) != -1 || // there is already a celeberation going on
								partyError.indexOf(aLangErrorText[0]) != -1 || // too few resources
								partyError.indexOf(aLangErrorText[7]) != -1 ) { // enough resources at
							var timer = $g ( './/*[@id="build" or @id="content"]//*[contains(@id,"timer")]', XPFirst, aElem );
							if ( timer ) {
								var FiniTime = timer.innerHTML.match(/\d{1,2}:\d{2}:\d{2}/);
								var VFiniTime = FiniTime.toString().split(":");  // Converti les ":" par de virgule ","
								var fintime = Number(VFiniTime[0]) * 60*60*1000 + Number(VFiniTime[1]) * 60*1000 
									+ Number(VFiniTime[2]) * 1000;
								// delay by fintime + 15 mins +/- random ( 15 mins )
								Tasktime = getRandomizedTime ( fintime + 15*60*1000, 2*15*60*1000, 1 );
							}
							else {
								// delay by 1 hrs + 15 mins +/- random ( 15 mins )
								Tasktime = getRandomizedTime ( 1*60*60*1000 + 15*60*1000, 2*15*60*1000, 1 );
							}
						}
						else {
							// delay by 1 hrs + 15 mins +/- random ( 15 mins )
							Tasktime = getRandomizedTime ( 1*60*60*1000 + 15*60*1000, 2*15*60*1000, 1 );
							printErrorMSG("<b>ERROR:: Translation required for : \"" + partyError + "\" from " + aLangAllBuildWithId[24]
									+ "(build.php).</b>", 1 );
						}
						flag ( "getPartyUrl():: " + getvillagefromdid(vi) + "("+vi+"):: Party Delayed to " + new Date ( Tasktime ) );
						var newTask = Task.slice(0); // clone the array Task.
						newTask[3] = Tasktime.toString();
						deleteTaskFromCookie(vi, Task, newTask);
						calldoing1();
						showTaskList();
						return false;
					}
				}
			}
		}
		return callback();
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getPartyUrl():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// [ Auto Transport -- Construction Support / Resource Concentration ]
// opens market to start tranfer of resources
function startTrannow(vi, tranTask) { // 8_241654_500,500,500,500_0_1245413194000_interval
	try {
		flag ( "startTrannow():: Started! vi: " + vi );
		//TS_debug("come into startTrannow() at " + getvillagefromdid(vi));
		getTargetResource(tranTask[2], // first get target resources and then start transfer
		function(){
		var turl = myhost + "/build.php?newdid=" + vi + "&gid=17";
		GM_xmlhttpRequest({
			method: 'GET',
			url: turl,
			headers: "",
			onload: function(responseDetails){
				if ( gatherStats(responseDetails.responseText) ) {
					// attempt reloading page, captcha ll be found there too and script will stop.
					window.location.replace(myhost + "/spieler.php");
					return false;
				}

				//TS_debug("here is startTrannow callback function")

				// v_kir 2010.01.25

				var ssDoc = document/*.implementation.createDocument("", "", null)*/;
				var ssElem = document.createElement('DIV');
				ssElem.innerHTML = responseDetails.responseText;
				//ssDoc.appendChild(ssElem);
				refreshPageInfo(ssElem);

				var formCount = ssDoc.evaluate('.//form [ @name="snd" and ( @method="POST" or @method="post" ) ]', ssElem, null, XPSnap, null).snapshotLength;
				if ( formCount > 1 ) {
					var tarLoc = ( tranTask[0] == "5" ) ? tranTask[3] : tranTask[1] ;
					var urlToBuilding = "<a class='spantooltip' style='color: Green' href='"+
						myhost+"/build.php?newdid="+vi+"&gid=17&z="+ tarLoc +"'>Send Resources</a>";
					playSound ( "<b>startTrannow():: Some Problem, send resources once manually! " + urlToBuilding + "</b>" );
					var nextTime = getGMCookie ( "MerchantReturnTime", vi );
					if ( !nextTime || nextTime < new Date().getTime() ) {
						// delay by transsInterval + random ( 15 mins )
						nextTime = getRandomizedTime( Number(transsInterval), 15*60*1000 );
					}
					GM_setValue(myacc() + "_" + vi + "_to_" + tranTask[2] + "_autoTransTime", nextTime.toString());
					calldoing1();
					showTaskList();
					return false;
				}

				var xpathId = "";
				switch ( aTravianVersion ) {
					case "3.6": xpathId = './/div[@id="textmenu"]/descendant::a[@href]'; break;
					case "4.0": xpathId = './/div[@class="contentNavi tabNavi"]//div[@class="container active"]//a[@href]'; break;
					default: throwLogicError ( "createbuildlink():: Travian Version not set!!" );
				}
				var ids = ssDoc.evaluate(xpathId, ssElem, null, XPFirst, null);
				theid = ids.singleNodeValue.href.match(/\bid=\d{1,}\b/)[0].split("id=")[1];

				var comm = ["", ""];

				// find max resources per merchant
				var pp = ssDoc.evaluate('.//table[@id="send_select"]/descendant::td[@class="max"]/a', ssElem, null, XPFirst, null);
				comm[1] = pp.singleNodeValue.innerHTML.match(/\d{3,4}/);

				// get merchants available in village
				var xpathMerchantCount = "";
				switch ( aTravianVersion ) {
					case "3.6": xpathMerchantCount = './/table[@id="target_select"]/descendant::td[@class="mer"]'; break;
					case "4.0": xpathMerchantCount = './/div[contains(@class,"traderCount")]/div[@class="boxes-contents"]'; break;
					default: throwLogicError ( "startTrannow():: Travian Version not set!!" );
				}
				var qq = ssDoc.evaluate(xpathMerchantCount, ssElem, null, XPFirst, null);
				comm[0] = qq.singleNodeValue.innerHTML.split(" ")[1].split("/")[0];

				flag ( "startTrannow():: Merchants available: " + comm[0] + ", & each Merchants can load: " + comm[1] );
				comm[0] = parseInt(comm[0]); // current count of merchants in village
				comm[1] = parseInt(comm[1]); // max resource per merchant

				// startTrannow() only transfers resources to own villages, hence we can check destination resources for overflow which is
				// done by getMaxTransAmount()
				var balance = getMaxTransAmount(vi, tranTask);
				if ( balance != false ) {
					flag ( "startTrannow():: Amount to transfer: " + balance );
					var delayCustomTransfer = false;
					if ( comm[0] > 0 ) {
						// get max amount than can be transfered based on merchants available and resources to retain in source village
						baalaa = getTranAmount ( balance, comm );
						var baalaasum = 0;
						for ( var ictr = 0; ictr < baalaa.length ; ictr++ )
							baalaasum += Number(baalaa[ictr]);
						if ( baalaasum == 0 )
							delayCustomTransfer = true;
						else
							autoTranRequire(tranTask, baalaa, vi, theid);
					}
					else
						delayCustomTransfer = true;
					if ( delayCustomTransfer == true ) { // if merchants are not available or total resource to transfer is 0
						var nextTime = getGMCookie ( "MerchantReturnTime", vi );
						if ( !nextTime || nextTime < new Date().getTime() ) {
							//TS_debug("a market place with no merchant is impossible. bug in script");
							// delay by transsInterval + random ( 15 mins )
							nextTime = getRandomizedTime( Number(transsInterval), 15*60*1000 );
						}
						GM_setValue(myacc() + "_" + vi + "_to_" + tranTask[2] + "_autoTransTime", nextTime.toString());
						flag ( "startTrannow():: No merchant now or resource to be sent is 0, delaying auto-transport!" );
						calldoing1();
						showTaskList();
					}
				}
				else {
					// delay by transsInterval + random ( 15 mins )
					var nextTime = getRandomizedTime( Number(transsInterval), 15*60*1000 );
					GM_setValue(myacc() + "_" + vi + "_to_" + tranTask[2] + "_autoTransTime", nextTime.toString());
					flag ( "startTrannow():: Not enough resources to send, delaying auto-transport!" );
					calldoing1();
					showTaskList();
				}
			}
		});
		});
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startTrannow():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getDemoParrams(vi, demotask) {
	try {
		flag ( "getDemoParrams():: Started! vi: " + vi );

		function callback() {};

		var url = myhost + "/build.php?newdid=" + vi + "&gid=15";
		var httpReqObj = new XMLHttpRequest();
		httpReqObj.open('GET', url, false);
		httpReqObj.onreadystatechange = callback;
		httpReqObj.send(null);

		function callback() {
			if ( httpReqObj.readyState == 4 ) {
				if ( httpReqObj.status == 200 ) {
					flag ( "getDemoParrams():: Callback Started!" );
					if ( gatherStats(httpReqObj.responseText) ) {
						// attempt reloading page, captcha ll be found there too and script will stop.
						window.location.replace(myhost + "/spieler.php");
						return false;
					}

					var auElem = document.createElement('div');
					auElem.innerHTML = httpReqObj.responseText;
					
					refreshPageInfo(auElem);

					var gettime = $ ( "demolish", auElem );
					if ( gettime ) { // if a demolish is already going on
						var gettime = $("demolish", auElem).innerHTML.match(/\d{1,2}:\d{2}:\d{2}/);
						var demot = gettime.toString().split(":");
						var randominter = 30000 + Math.ceil ( Math.random() * 5*60*1000 ); // 30 secs + random 5 mins
						var endt = new Date().getTime() + Number(demot[0]) * 60*60*1000 + Number(demot[1]) * 60*1000 + Number(demot[2]) * 1000 + randominter;
						flag ( "getDemoParrams():: Some demolish is going on, next demo start at " + new Date ( endt ) );
						GM_setValue(myacc() + "_" + vi + "_demolishTime", endt.toString());
						calldoing1();
						showTaskList();
						return false;
					}
					else { // when no demo is going on
						var formCount = document.evaluate('.//form [ @class="demolish_building" and ( @method="post" or @method="POST" ) ]',
								auElem, null, XPSnap, null).snapshotLength;
						if ( formCount > 1 ) {
							var urlToBuilding = "<a class='spantooltip' style='color: Green' href='"+
								myhost+"/build.php?newdid="+vi+"&gid=15'>Demolish Manually</a>";
							playSound ( "<b>getDemoParrams():: Some Problem, do demolish once manually! " + urlToBuilding + "</b>" );

							var randominter = 1*60*60*1000 + Math.ceil ( Math.random() * 1*60*60*1000 - 30*60*1000 ); // 1 hr +/- random 30 mins
							var endt = new Date().getTime() + randominter;
							flag ( "getDemoParrams():: Some problem, cannot get params, delaying next demolish to " + new Date ( endt ) );
							GM_setValue(myacc() + "_" + vi + "_demolishTime", endt.toString());
							calldoing1();
							showTaskList();
							return false;
						}
						var paramsList = $g ( './/form[ @class="demolish_building" and ( @method="post" or @method="POST" ) ]//input[@type="hidden"]',
									XPOrdList, auElem );
						if ( paramsList && paramsList.snapshotLength > 0 ) {
							var params = [];
							for ( var ctr = 0; ctr < paramsList.snapshotLength ; ctr++ ) {
								var paramName = paramsList.snapshotItem(ctr).getAttribute("name");
								var paramValue = paramsList.snapshotItem(ctr).getAttribute("value");
								//flag ( "getDemoParrams():: ctr: " + ctr + ", name: " + paramName + ", value: " + paramValue );
								params.push( { name: paramName, value: paramValue } );
							}
							//flag ( "getDemoParrams():: params.length: " + params.length );
							return params;
						}
						else {
							var randominter = 1*60*60*1000 + Math.ceil ( Math.random() * 1*60*60*1000 - 30*60*1000 ); // 1 hr +/- random 30 mins
							var endt = new Date().getTime() + randominter;
							flag ( "getDemoParrams():: Some problem, cannot get params, delaying next demolish to " + new Date ( endt ) );
							GM_setValue(myacc() + "_" + vi + "_demolishTime", endt.toString());
							calldoing1();
							showTaskList();
							return false;
						}
					}
				}
			}
		}
		return callback();
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getDemoParrams():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function executeDemo(vi, demotask, params) {
	try {
		flag ( "executeDemo():: Started! vi: " + vi );

		var turl = myhost + "/build.php?newdid=" + vi;
		var demodate = "&gid=15&a=" + vi + "&abriss=" + demotask[1];
		for ( var ctr = 0 ; ctr < params.length ; ctr++ ) {
			if ( params[ctr].name == "gid" && params[ctr].value != "15" )
				throwLogicError ( "executeDemo():: Conflicting gid value: " + params[ctr].value );
			if ( params[ctr].name == "a" && params[ctr].value != vi )
				throwLogicError ( "executeDemo():: Conflicting a value: " + params[ctr].value );
			if ( params[ctr].name != "gid" && params[ctr].name != "a" )
				demodate += "&" + params[ctr].name + "=" + params[ctr].value;
		}
		//flag ( "executeDemo():: demodate: " + demodate );
		dataa = encodeURI(demodate);
		GM_xmlhttpRequest({
			method: 'POST',
			url: turl,
			headers: {
				'Accept': 'application/atom+xml,application/xml,text/xml',
				'Content-type': 'application/x-www-form-urlencoded'
			},
			data: dataa,
			onload: function(response){
				flag ( "executeDemo():: Callback Started!" );

				if ( gatherStats(response.responseText) ) {
					// attempt reloading page, captcha ll be found there too and script will stop.
					window.location.replace(myhost + "/spieler.php");
					return false;
				}

				var auElem = document.createElement('div');
				auElem.innerHTML = response.responseText;
				
				refreshPageInfo(auElem);

				if ( parseInt(demotask[2] ) > 1 ) {
					var newdemoTask = demotask.slice(0); // clone the array demotask.
					newdemoTask[2] = (parseInt(demotask[2])-1).toString();
					deleteTaskFromCookie(vi, demotask, newdemoTask);

					var gettime = $("demolish", auElem).innerHTML.match(/\d{1,2}:\d{2}:\d{2}/);
					var demot = gettime.toString().split(":");
					var randominter = 30000 + Math.ceil ( Math.random() * 5*60*1000 ); // 30 secs + random 5 mins
					var endt = new Date().getTime() + Number(demot[0]) * 60*60*1000 + Number(demot[1]) * 60*1000 + Number(demot[2]) * 1000 + randominter;
					flag ( "executeDemo():: Some demolish is going on, next demo start at " + new Date ( endt ) );
					GM_setValue(myacc() + "_" + vi + "_demolishTime", endt.toString());
				}
				else {
					GM_deleteValue(myacc() + "_" + vi + "_demolishTime");
					deleteTaskFromCookie(vi, demotask);
				}
				calldoing1();
				showTaskList();
				printMSG ( getvillagefromdid(vi) + " (" + vi + "): " + aLangTaskKind[7]+" "+demotask[4]+" "+ aLangOtherText[7]+"!" );
			},
		});
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>executeDemo():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function startDemonow(vi, demotask){//"7_" + theID +"_" + crtlevel + "_" + currentID() + "_" + theBuild;
	try {
		//flag ( "startDemonow():: Started! vi: " + vi );

		var params = getDemoParrams(vi, demotask);
		if ( params != false ) {
			var randominter = Math.ceil ( Math.random() * 3*1000 + 2*1000 ); // random ( 3 sec ) + 2 sec
			window.setTimeout ( function() {
						executeDemo(vi, demotask, params);
						vi = null; demotask = null; params = null;
						}
				, randominter );
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startDemonow():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getWholeNumber(resArray){
	for(xx in resArray){
		//resArray[xx]=Math.floor(resArray[xx]/100)*100; 
		resArray[xx]=Math.floor(resArray[xx]); 
	}
	return resArray;
}

function getIncomingResources ( toid ) {
	try {
		//flag ( "getIncomingResources():: toid: " + toid + ", fromid: " + fromid );
		//flag ( "getIncomingResources():: to: " + getvillagefromdid(toid) + ", from: " + getvillagefromdid(fromid) );
		var resources = [0,0,0,0];
		var allVillas = getAllVillageNewdids();
		var incRes = {};
		for ( var ctr = 0 ; ctr < allVillas.length ; ctr++ ) {
			if ( allVillas[ctr] != toid )
				incRes[ allVillas[ctr] ] = getGMCookieVi ( "ResourceTraning", toid,  allVillas[ctr] );
		}
		if ( incRes ) {
			for ( var v in incRes ) {
				if ( incRes[v] ) {
					resources[0] += Number(incRes[v][0]);
					resources[1] += Number(incRes[v][1]);
					resources[2] += Number(incRes[v][2]);
					resources[3] += Number(incRes[v][3]);
				}
			}
		}
		
		//var eTransit = getEstimatedTransit(fromid,toid);
		//TS_debug("getIncomingResources: r = ["+resources+"], et = ["+eTransit+"]");
		
		return resources;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getIncomingResources():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getNextMerchantArrival()
{
}
	
function getMaxTransAmount ( vi, thisTask ) {
	try {
		TS_debug("getMaxTransAmount():: Started! vi: " + vi );

		var hereRemain    = GM_getValue ( myacc() + "_" + vi + "_userRemainSetup","0/0" );
		var userTranSetup = GM_getValue ( myacc() + "_" + thisTask[2] + "_userTranSetup", "false" );
		var tranTimePoint = GM_getValue ( myacc() + "_" + vi + "_to_" + thisTask[2] + "_autoTransTime", "false" );
		
		validateRMT ( vi, thisTask[2] );

		//TS_debug("validating GRC for getMaxTransAmount()");
		var resnow  = getGMCookie ( "ResourceNow", thisTask[2] ); // resource now in destination village
		var reshere = getGMCookie ( "ResourceNow", vi ); // resource now in source village
		var restran = getIncomingResources ( thisTask[2] ); // find resources incoming in the destination village
		var WareCap = getGMCookie ( "WarehouseCap", thisTask[2] ); // warehouse cap in destination village
		var GranCap = getGMCookie ( "GranaryCap", thisTask[2] ); // granary cap in destination village
		
		if ( !resnow || !WareCap || !GranCap ) {
			TS_debug ( "Reloading. Missing info in GetMaxTransAmount: vid=" + thisTask[2] + "tarResource=" + resnow + "; WareCap=" +WareCap + "; GranCap ="+ GranCap );
			window.location.href = myhost + "/spieler.php?uid="+getuid()+"&newdid=" + thisTask[2];
			return false;
		}
		if ( !reshere ) {
			TS_debug ( "Reloading. GetMaxTransAmount: hereResource =" + hereResource );
			window.location.href = myhost + "/spieler.php?uid="+getuid()+"&newdid="+vi;
			return false;
		}

		var hereremainn = new Array(4);
		var hereRemainT = hereRemain.split("/");
		var hereRemainWH = parseInt(hereRemainT[0]);
		// resources to retain in source
		hereremainn[0] = parseInt(hereRemainT[0]);
		hereremainn[1] = parseInt(hereRemainT[0]);
		hereremainn[2] = parseInt(hereRemainT[0]);
		hereremainn[3] = parseInt(hereRemainT[1]);
		
		var transtarget = new Array(4); // max resources that can be sent to destination
		if ( userTranSetup == "false" ) {
			switch (thisTask[1]) {
				case "0": // [construction support] -- max resource fill in destination is restricted to 15000/15000/15000/16000
					if (WareCap < 18000 || GranCap < 18000) { //  80% of destination warehouse 
						transtarget[0] = WareCap * 0.8;
						transtarget[1] = WareCap * 0.8;
						transtarget[2] = WareCap * 0.8;
						transtarget[3] = GranCap * 0.8;
					}
					else { // 15000 for warehouse and 16000 for destination granary
						transtarget[0] = 15000;
						transtarget[1] = 15000;
						transtarget[2] = 15000;
						transtarget[3] = 16000;
					}
					break;
					
				case "1": // [resource concentration] -- max resource fill in destination is unrestricted, restricted only by destination warehouse & granary cap
					transtarget[0] = WareCap * 0.9;
					transtarget[1] = WareCap * 0.9;
					transtarget[2] = WareCap * 0.9;
					transtarget[3] = GranCap * 0.9;
					break;
			}
		}
		else {
			var targetWarehouse = parseInt(userTranSetup.split("/")[0]);
			// if destination _userTranSetup is less than warehouse/granary cap it over-rides construction/concentration modes ow enforce mode rules.
			if ( targetWarehouse > parseInt ( WareCap ) ) {
				if ( thisTask[1] == "0" ) { // [construction support] -- max resource fill in destination is restricted to 15000/15000/15000/16000
					if ( WareCap < 18000 )
						targetWarehouse = WareCap * 0.8;
					else
						targetWarehouse = 15000;
				}
				else // [resource concentration] -- max resource fill in destination is unrestricted, restricted only by destination warehouse & granary cap
					targetWarehouse = WareCap * 0.9;
			} // if destination _userTranSetup is less than warehouse/granary cap it over-rides construction/concentration modes.
			transtarget[0] = targetWarehouse;
			transtarget[1] = targetWarehouse;
			transtarget[2] = targetWarehouse;
			var targetGranary = parseInt(userTranSetup.split("/")[1]);
			// if destination _userTranSetup is less than warehouse/granary cap it over-rides construction/concentration modes ow enforce mode rules.
			if ( targetGranary > parseInt ( GranCap ) ) {
				if ( thisTask[1] == "0" ) { // [construction support] -- max resource fill in destination is restricted to 15000/15000/15000/16000
					if ( GranCap < 18000 ) //
						targetGranary = GranCap * 0.8;
					else
						targetGranary = 16000;
				}
				else // [resource concentration] -- max resource fill in destination is unrestricted, restricted only by destination warehouse & granary cap
					targetGranary = GranCap * 0.9;
			}
			transtarget[3] = targetGranary;
		}

		/*
		TS_debug("transtarget =" + transtarget);
		TS_debug("resnow=" + resnow);
		TS_debug("reshere=" + reshere);
		TS_debug("hereremainn=" + hereremainn);
		 */   

		var sendResources = false
		var result = new Array(4);
		var balance = [0,0,0,0]; // final resource to send out
		for ( var i = 0 ; i< 4 ; i++ ) {
			// how much destination can take in
			var maxDestTransport = transtarget[i] - (resnow[i] + restran[i]);
			maxDestTransport = maxDestTransport > 0 ? maxDestTransport : 0;

			// how much source can send out
			var maxSrcTransport = reshere[i] - hereremainn[i];
			maxSrcTransport = maxSrcTransport > 0 ? maxSrcTransport : 0;

			// resource to transfer is min of destination max intake & source max out
			var transport = Math.min(maxDestTransport, maxSrcTransport);
			
			if ( maxDestTransport == 0 ) {
				result[i] = "F"
			}
			else if ( maxSrcTransport == 0 ) {
				 result[i] = "E";
			}
			else {
				sendResources = true;
				result[i] = transport.toString();
			}
			balance[i] = transport;
		}
		//var msg = "getMaxTransAmount():: T=[" + result + "], rh=[" + reshere +"], rmn=["+hereremainn+"], rn=["+resnow+"], rt=["+transtarget+"], trx=[" +restran +"]";
		//TS_debug(msg);
		TS_debug( "getMaxTransAmount():: Resource computed for transfer: [" +balance.join(",") + "]" );

		// check for minimum resource amount allowed for transfer
		var all = balance[0] + balance[1] + balance[2] + balance[3];
		var myRace = GM_getValue(myacc() + "_raceID");
		var minAllowed = 0;
		switch ( myRace ) {
			case "0": minAllowed = 450; break;
			case "1": minAllowed = 950; break;
			case "2": minAllowed = 700; break;
		}
		if ( all < minAllowed )  {
			TS_debug( "getMaxTransAmount():: all: " + all + " is less than minAllowd: " + minAllowed + ", will not send resources!" );
			return false;
		}
		else
			return balance;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getMaxTransAmount():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

//
// bala: resources to send
// comm[0]: current count of merchants in village
// comm[1]: max resource per merchant
// resource: current resources in source village
// hereremainn: resources to retain in source village
//
// returns: max amount of resources that can be sent based on merchants available and resources to retain in source village
function getTranAmount ( bala, comm, resource, hereremainn ) {
	try {
		//TS_debug("getTranAmount():: Started! bala: " + bala );
		//TS_debug("getTranAmount():: resource=" + resource);
		//TS_debug("getTranAmount():: hereremainn=" + hereremainn);


		// if resource now in source village and resources to retain in source village is specified, adjust accordingly
		if ( resource && hereremainn ) {
			resource[0] = (parseInt(resource[0])>hereremainn[0])?(parseInt(resource[0])-hereremainn[0]):0;
			resource[1] = (parseInt(resource[1])>hereremainn[0])?(parseInt(resource[1])-hereremainn[0]):0;
			resource[2] = (parseInt(resource[2])>hereremainn[0])?(parseInt(resource[2])-hereremainn[0]):0;
			resource[3] = (parseInt(resource[3])>hereremainn[1])?(parseInt(resource[3])-hereremainn[1]):0;
			bala[0] = (resource[0] >= bala[0]) ? bala[0] : resource[0];
			bala[1] = (resource[1] >= bala[1]) ? bala[1] : resource[1];
			bala[2] = (resource[2] >= bala[2]) ? bala[2] : resource[2];
			bala[3] = (resource[3] >= bala[3]) ? bala[3] : resource[3];
		}

		// find max resource we can send based on merchants available and max resources per merchant
		all = bala[0] + bala[1] + bala[2] + bala[3];
		var maxTransport = comm[0] * comm[1];
		if (all < maxTransport) {
			//TS_debug("getTranAmount():: bala= " + bala );
			return getWholeNumber(bala);
		}
		else {
			balaa = [0, 0, 0, 0];
			var ratio = maxTransport/all;
			for(var i = 0; i< 4; i++)
			{
				balaa[i] = bala[i]*ratio;
			}
			//TS_debug("getTranAmount():: bala= " + bala );
			return getWholeNumber(balaa);
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getTranAmount():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// send resources from market 1st stage (1st click on send button and process the response to find the params for 2nd stage)
// only called from autoTranRequire()
function getRequireData ( tranTask, resArray, vi, id ){//8_241654_500,500,500,500_0_1245413194000_interval
	try {
		flag ( "getRequireData():: Started! resArray: " + resArray + ", vi: " + vi + ", id: " + id );

		var param = "";
		switch (tranTask[0]) {
			case "5":
				param = "&id=" + id + "&r1=" + resArray[0] + "&r2=" + resArray[1] + "&r3=" + resArray[2] + "&r4=" + resArray[3]
					+ "&dname=&x=" + getXfromCoord(tranTask[3]) + "&y=" + getYfromCoord(tranTask[3]);
				break;
			case "8":
				param = "&id=" + id + "&r1=" + resArray[0] + "&r2=" + resArray[1] + "&r3=" + resArray[2] + "&r4=" + resArray[3]
					+ "&dname=&x=" + getXfromCoord(tranTask[1]) + "&y=" + getYfromCoord(tranTask[1]);
				break;
		}
		//TS_debug("in getRequireData:   " + param);
		data = encodeURI(param);

		url = myhost + "/build.php" + "?newdid=" + vi;
		//flag('url : '+url);

		function callback() {};

		var getTranData = new XMLHttpRequest();
		getTranData.open('POST', url, false); 	//	getTranData.open('POST', url, true);
		getTranData.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		getTranData.setRequestHeader("Content-length", data.length);
		getTranData.setRequestHeader("Connection", "close");
		getTranData.onreadystatechange = callback;
		getTranData.send(data);

		function callback() {
			if ( getTranData.readyState == 4 ) {
				if ( getTranData.status == 200 ) {
					flag ( "getRequireData():: CallBack Started!" );

					var abElem = document.createElement('DIV');
					abElem.innerHTML = getTranData.responseText;

					if ( gatherStats(abElem.innerHTML) ) {
						// attempt reloading page, captcha ll be found there too and script will stop.
						window.location.replace(myhost + "/spieler.php");
						return false;
					}

					refreshPageInfo(abElem);

					var formCount = document.evaluate('.//form [ @name="snd" and ( @method="POST" or @method="post" ) ]', abElem, null, XPSnap, null).snapshotLength;
					if ( formCount > 1 ) {
						var tarLoc = ( tranTask[0] == "5" ) ? tranTask[3] : tranTask[1] ;
						var urlToBuilding = "<a class='spantooltip' style='color: Green' href='"+
							myhost+"/build.php?newdid="+vi+"&gid=17&z="+ tarLoc +"'>Send Resources</a>";
						playSound ( "<b>getRequireData():: Some Problem, send resources once manually! " + urlToBuilding + "</b>" );
						return false;
					}

					var input = document.evaluate(".//input", abElem, null, XPSnap, null);
					var paramm = "";
					for ( var i = 0 ; i < input.snapshotLength ; i++ ) {
						var inp = input.snapshotItem(i);
						var paramName = inp.name;

						// by Rhayader and Ptitfred06 add parameters "c" the 23/05/2010
						if ( /id|a|sz|kid|c|r[1-4]/.test ( paramName ) ) {
							var paramName = "&" + paramName + "=";
							if ( paramm.indexOf ( paramName ) == -1 )
								paramm += paramName + inp.value;
							else {
								var tarLoc = ( tranTask[0] == "5" ) ? tranTask[3] : tranTask[1] ;
								var urlToBuilding = "<a class='spantooltip' style='color: Green' href='"+
									myhost+"/build.php?newdid="+vi+"&gid=17&z="+ tarLoc +"'>Send Resources</a>";
								playSound ( "<b>getRequireData():: Some Problem, send resources once manually! " + urlToBuilding + "</b>" );
								return false;
							}
						};
					};
					paramm = paramm.slice(1);
					//TS_debug("Paramm =" + paramm);
					return paramm;
				}
			}
		}
		return callback();
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getRequireData():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// send resources resarray out from village vi
// called from startCustomTranNow() [custom-transport] and startTrannow() [auto-transport]
// send resources from market 2st stage (2nd click on send button)
function autoTranRequire(tranTask, resArray, vi, id) {
	try {
		flag ( "autoTranRequire():: Started! resArray: " + resArray + ", vi: " + vi + ", id: " + id );

		var dataa = getRequireData(tranTask, resArray, vi, id); // send resources 1st stage
		if ( dataa != false ) {
			dataa = encodeURI(dataa);

			url = myhost + "/build.php" + "?newdid=" + vi;
			//flag(" autoTranRequire url = " + url);

			GM_xmlhttpRequest({
				method: 'POST',
				url: url,
				headers: {
					'Accept': 'application/atom+xml,application/xml,text/xml',
					'Content-type': 'application/x-www-form-urlencoded'
				},
				data: dataa,
				onload: function(response){
					flag ( "autoTranRequire():: CallBack Started!" );

					if ( gatherStats(response.responseText) ) {
						// attempt reloading page, captcha ll be found there too and script will stop.
						window.location.replace(myhost + "/spieler.php");
						return false;
					}

					var auElem = document.createElement('div');
					auElem.innerHTML = response.responseText;

					refreshPageInfo(auElem);

					switch (tranTask[0]) {
						case "5": // Auto Transport
							var okk = getvillagefromdid(vi) + " (" + vi + "): " +
								aLangTaskOfText[8].big() + "<br/><br/>" + aLangGameText[11] + " " + getvillagefromdid(vi) + " " + 
								aLangGameText[6] + " " + getvillagefromdid(tranTask[2]) + "<br/><br/>" + aLangTaskOfText[11] + "!";
							printMSG(okk);
							switch ( tranTask[1] ) {
								case "0":
									GM_deleteValue(myacc() + "_" + vi + "_to_" + tranTask[2] + "_autoTransTime");
									break;
								case "1":
									// delay by transsInterval + random ( 15 mins )
									var nextTime = getRandomizedTime( Number(transsInterval), 15*60*1000 );
									GM_setValue(myacc() + "_" + vi + "_to_" + tranTask[2] + "_autoTransTime", nextTime.toString());
									flag ( "autoTranRequire():: next auto-transport start at " + new Date(nextTime) );
									break;
							}
							break;
						case "8": // Custom Transport
							if ( tranTask[3] == "0" ) {
								deleteTaskFromCookie(vi, tranTask);
							}
							else {
								//var newTask = new Array();
								var newTask = tranTask.slice(0); // clone the array tranTask.
								var temp = Number(tranTask[3]) - 1;
								newTask[3] = temp.toString();
								var temp2 = 0;
								if (tranTask[5] == "0") { // if repeat interval not set, delay 6 hours
									// delay by 6 hrs +/- random ( 3 hr )
									temp2 = getRandomizedTime ( 6*60*60*1000, 2*3*60*60*1000, 1 );
								}
								else {
									// delay by repeat interval +/- random ( repeat interval / 2 )
									temp2 = getRandomizedTime ( Number(tranTask[5]), Number(tranTask[5]), 1 );
								}
								newTask[4] = temp2.toString();
								deleteTaskFromCookie(vi, tranTask, newTask);
								flag ( "autoTranRequire():: next custom-transport start at " + new Date(temp2) );
							}
							var okk = getvillagefromdid(vi) + " (" + vi + "): " + aLangTaskOfText[35].bold() + " " + aLangTaskOfText[11] + "!";
							printMSG(okk);
							break;
					}
					calldoing1();
					showTaskList();
				}
			});
		}
		else {
			switch (tranTask[0]) {
				case "5": // Auto Transport
					// delay by transsInterval + random ( 15 mins )
					var nextTime = getRandomizedTime( Number(transsInterval), 15*60*1000 );
					GM_setValue(myacc() + "_" + vi + "_to_" + tranTask[2] + "_autoTransTime", nextTime.toString());
					flag ( "autoTranRequire():: next auto-transport start at " + new Date(nextTime) );
					break;
				case "8": // Custom Transport
					var newTask = tranTask.slice(0); // clone the array tranTask.
					var temp2 = 0;
					if (tranTask[5] == "0") { // if repeat interval not set, delay 6 hours
						// delay by 6 hrs +/- random ( 3 hr )
						temp2 = getRandomizedTime ( 6*60*60*1000, 2*3*60*60*1000, 1 );
					}
					else {
						// delay by repeat interval +/- random ( repeat interval / 2 )
						temp2 = getRandomizedTime ( Number(tranTask[5]), Number(tranTask[5]), 1 );
					}
					newTask[4] = temp2.toString();
					deleteTaskFromCookie(vi, tranTask, newTask);
					flag ( "autoTranRequire():: next custom-transport start at " + new Date(temp2) );
					break;
			}
			calldoing1();
			showTaskList();
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>autoTranRequire():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}


function showTaskList() {
	try {
		//flag ( "showTaskList():: Started!" );

		if ($("tasklisttable_wrapper")) {
			document.body.removeChild($("tasklisttable_wrapper"));
		}

		var tasks = GM_getValue(herere() + "_waitTask", "false");
		var aTable = createTaskListTable();
		var tlWrapper = document.createElement("div");
		tlWrapper.id = "tasklisttable_wrapper";
		tlWrapper.appendChild(aTable);

		var formCoords = getOption("TASKLIST_POSITION", "0px_900px");
		formCoords = formCoords.split("_");
		tlWrapper.style.top = formCoords[0];
		tlWrapper.style.left = formCoords[1];

		document.body.appendChild(tlWrapper);
		makeDraggable($("tasklisttable"));

		if ( self.window.name == GM_getValue(currentServer() + '_loginWindow', "noLoginWindow") ) {
			$("tasklisttable_wrapper").style.backgroundColor = "Teal";
			//$("tasklisttable_wrapper").style.backgroundColor = "LightSteelBlue";
			//$("tasklisttable_wrapper").style.backgroundColor = "SteelBlue";
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>showTaskList():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function milliSecondstoDHMS ( ms ) {
	function two(x) { return ( ( x > 9 ) ? "" : "0" ) + x; }
	function three(x) { return ( ( x > 99 ) ? "" : "0" ) + ( ( x > 9 ) ? "" : "0" ) + x; }

	var sec = Math.floor(ms/1000);
	ms = ms % 1000;
	t = three(ms);

	var min = Math.floor(sec/60);
	sec = sec % 60;
	t = two(sec) + ":" + t;

	var hr = Math.floor(min/60);
	min = min % 60;
	t = two(min) + ":" + t;

	var day = Math.floor(hr/60);
	hr = hr % 60;
	t = two(hr) + ":" + t;
	t = day + ":" + t;

	return t;
}

// GotGs 2011.01.15 -- this function sorts the task list in the order as mentioned in the task-list tool-tip.
function sortTheTaskList (allTasks) {
	try {
		if ( !allTasks || allTasks.length == 0 || allTasks == "false" ) {
			return "false";
		}
		tasksArry = allTasks.split("|");
		var finalStr = "";
		var attackStr = "";
		var trainStr = "";
		var autoTrnsStr = "";
		var resStr = "";
		var resAndBldingStr = "";
		var demoBldingStr = "";
		var taskSeparator = "|";
		var myRace = GM_getValue(myacc() + "_raceID");
		for ( i in tasksArry ) {
			var task = new Array();
			task = tasksArry[i].split("_");
			switch(task[0]) {
				case "0": // [ resource / building upgrades ]
					if ( myRace == "0" ) { // separate resource upgrades from building upgrades only for romans.
						thisTask = tasksArry[i].split("_");
						if ( thisTask[1] < 19 || thisTask[1] == 50 ) { // do only if roman resource upgrade.
							if ( resStr.length == 0 )
								resStr = tasksArry[i];
							else
								resStr += taskSeparator + tasksArry[i];
							break; // break only for romans.
						}
					}
					// no break here.
				case "1": // [ newbuild building ]
					if ( resAndBldingStr.length == 0 )
						resAndBldingStr = tasksArry[i];
					else
						resAndBldingStr += taskSeparator + tasksArry[i];
					break;
				case "2": // [ attack normal / raid, reinforce ]
					if ( attackStr.length == 0 )
						attackStr = tasksArry[i];
					else
						attackStr += taskSeparator + tasksArry[i];
					break;
				case "3": // [ Blacksmith Improve Offense, Armoury Improve Defense ]
				case "4": // [ Train Troops ]
				case "6": // [ Party Small / Big ]
				case "8": // [ Custom Transport ]
					if ( trainStr.length == 0 )
						trainStr = tasksArry[i];
					else
						trainStr += taskSeparator + tasksArry[i];
					break;
				case "5": // [ Auto Transport ]
					if ( autoTrnsStr.length == 0 )
						autoTrnsStr = tasksArry[i];
					else
						autoTrnsStr += taskSeparator + tasksArry[i];
					break;
				case "7": // [ Deomolish Buildings ]
					if ( demoBldingStr.length == 0 )
						demoBldingStr = tasksArry[i];
					else
						demoBldingStr += taskSeparator + tasksArry[i];
					break;
				default:
					TS_debug("sortTheTaskList():: ERROR:: Unknown Task Id: " + task[0] + "! Filtering it out!");
					break;
			}
		}
		var attackSortMode = GM_getValue ( myacc() + "_attackStrictOrder", "0" )

		if ( attackStr != "" ) {
			//sortAttacks(attackStr,taskSeparator);
			function sortAttackNormal(a,b)
			{
				var aArray = a.split("_");
				var bArray = b.split("_");
				return aArray[4] - bArray[4];
			}
			function sortAttackOrder2(a,b)
			{
				var aArray = a.split("_");
				var bArray = b.split("_");
				return aArray[9] - bArray[9];
			}
			var attackArray = attackStr.split(taskSeparator);
			if ( attackSortMode == "2" ) // when attack strict order type 2
				attackArray.sort(sortAttackOrder2); // sort based on distance from village
			else
				attackArray.sort(sortAttackNormal); // else sort based on start time
			attackStr = attackArray.join(taskSeparator);
		}
		
		if ( attackStr.length != 0 )
			finalStr = attackStr;
		if ( trainStr.length != 0 )
			if ( finalStr.length != 0 )
				finalStr += taskSeparator + trainStr;
			else
				finalStr = trainStr;
		if ( autoTrnsStr.length != 0 )
			if ( finalStr.length != 0 )
				finalStr += taskSeparator + autoTrnsStr;
			else
				finalStr = autoTrnsStr;
		if ( resStr.length != 0 )
			if ( finalStr.length != 0 )
				finalStr += taskSeparator + resStr;
			else
				finalStr = resStr;
		if ( resAndBldingStr.length != 0 )
			if ( finalStr.length != 0 )
				finalStr += taskSeparator + resAndBldingStr;
			else
				finalStr = resAndBldingStr;
		if ( demoBldingStr.length != 0 )
			if ( finalStr.length != 0 )
				finalStr += taskSeparator + demoBldingStr;
			else
				finalStr = demoBldingStr;
		//TS_debug("sortTheTaskList():: Sorted Task List: " + finalStr );

		return finalStr;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>sortTheTaskList():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function toggleTaskListFold() {
	try {
		//flag ( "toggleTaskListFold():: Started!" );

		//var taskListFoldVal = getOption("FOLD_TASKLIST", "0"); // 1 means folded, 0 means not-folded.
		var taskListFoldVal = document.evaluate('.//table[@id="tasklisttable"]/thead', document, null, XPFirst, null).singleNodeValue;
		taskListFoldVal = taskListFoldVal == null ? "1" : "0"; // null means folded, non-null means not-folded.
		switch ( taskListFoldVal ) {
			case "0": // currently not-folded, so fold it.
				setOption("FOLD_TASKLIST", "1");
				break;
			case "1": // currently folded, so un-fold it.
				setOption("FOLD_TASKLIST", "0");
				break;
		}
		showTaskList();

		return false; // suppress the default href of the anchor.
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>toggleTaskListFold():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function createTaskListTable() {
	//flag ( "createTaskListTable() Started!" );

	var taskss = GM_getValue(herere() + "_waitTask", "false");
	if ( taskss != "false" ) {
		taskss = sortTheTaskList(taskss); // GotGs 2011.01.15 -- easy fix, but could be a hit on the performance.
		GM_setValue(herere() + "_waitTask", taskss);
	}

	var taskListTable = document.createElement("table");
	var taskListTableBody = document.createElement("tbody");
	taskListTable.id = "tasklisttable";
	taskListTable.border = "0";
	taskListTableToolTipText = "Click here to fold / un-fold task list. For help on this script's functions visit the script's home-page @ userscripts.org.";
	//taskListTableToolTipText = "The order of execution of tasks is as follows:<br/>(1) Attack/Raid/Reinforce<br/>(2) Train Troops, Custom Transport, Party, Troops Upgrade in Blacksmith/Armoury as per sequence<br/>(3) Auto Transport [Resource Concentration / Construction Support]<br/>(4) Roman Resource Upgrades<br/>(5) Roman Building Upgrades<br/>(6) Other Races Resources / Buildings<br/><br/>How to use:<br/>(1) Logon to travian with Auto-Task enabled from within greasemonkey, leave the login window open for Auto-Task to run. To add tasks open other travian windows (non-login windows). Use login window only to check Auto-Task logs and to enable/disable Auto-Task. To open other travian windows use right-click -> open in new tab/window.<br/>(2) You cannot add tasks from login window. Add tasks only from non-login windows.<br/>(3) Click *.START* on the task-list to start Auto-Task, to stop click on *.STOP*. Start/stop Auto-Task only from login window.<br/>(4) Auto Task runs only on the login window (window from where you logon to travian). Non-login windows are used only for adding/deleting tasks. If you close the login window, you can make any other non-login window as your login window by right-clicking on the test-alarm floater.<br/>(5) If there are no *schedule upgrade/add task* buttons on a resource/building page, try opening the resource/building via dorf1.php or dorf2.php and not via any bookmark, ie try opening the resource/building page (build.php) by using id and not gid in the url.<br/>(6) If you are getting server time diff error, go to profile->preferences and set your server time zone.<br/>";
	//taskListTable.innerHTML += "<caption><a id='toggleTaskLista' class='spantooltip' href='#' title='Click to fold/unfold task list.'>" + aLangGameText[7].big() + ":  " + currentVillageName().big() + "&#160;&#160;&#160;" + aLangTaskOfText[12].big() + "<span>" + taskListTableToolTipText + "</span></a></caption>";
	taskListTable.innerHTML += "<caption><a id='toggleTaskLista' class='spantooltip' href='#' title='Click to fold/unfold task list.'>" + "(GAT) ".big()
		+ aLangTaskOfText[12].big() + " : ".big() + currentVillageName().big() + "<span>" + taskListTableToolTipText + "</span></a></caption>";

	toggleTaskListAnchor = taskListTable.getElementsByTagName("a")[0]; // add event listener for task fold unfold.
	toggleTaskListAnchor.addEventListener('click', toggleTaskListFold, false );

	var taskListFoldVal = getOption("FOLD_TASKLIST", "0"); // 1 means folded, 0 means not-folded.
	if ( taskListFoldVal == "0" ) {
		var aThead = document.createElement("thead");
		taskListTable.appendChild(aThead);
		
		var aTrThead = document.createElement("tr");
		aThead.appendChild(aTrThead);

		var aThThead1 = document.createElement("th");
		aTrThead.appendChild(aThThead1);
		aThThead1.setAttribute("colspan",'2');
		aThThead1.innerHTML = aLangAddTaskText[12];

		var aThThead2 = document.createElement("th");
		aTrThead.appendChild(aThThead2);
		aThThead2.innerHTML = aLangAddTaskText[11];

		// msd
		var aThThead4 = document.createElement("th");
		aTrThead.appendChild(aThThead4);
		aThThead4.innerHTML = "Edit";
		// msd end

		var aThThead3 = document.createElement("th");
		aTrThead.appendChild(aThThead3);
		aThThead3.innerHTML = aLangAddTaskText[10];
		
		//taskListTable.innerHTML += "<tr><td colspan='4'><hr/></td></tr>";
		var aTrHr = document.createElement("tr");
		var aTdHr = document.createElement("td");
		aTdHr.setAttribute("colspan","100%");
		aTdHr.innerHTML = "<hr/>";
		aTrHr.appendChild(aTdHr);
		//aTrHr.innerHTML = "<td colspan='4'><hr/></td>";
		taskListTableBody.appendChild(aTrHr);
				
		if (taskss == "false") {
			aTrNoTask = document.createElement("tr");
			aTdNoTask = document.createElement("td");
			aTdNoTask.setAttribute("colspan","100%");
			aTdNoTask.innerHTML = "<div align='middle'><font color='red'>No Tasks! Add Tasks by visiting Resource Tiles or Buildings.</font></div>";
			aTrNoTask.appendChild(aTdNoTask);
			taskListTableBody.appendChild(aTrNoTask);
		}
		else {
			tasks = taskss.split("|");
			for (i in tasks) {
				thisTask = tasks[i].split("_");
				function getTaskKind( taskArr ) {
					var kind = parseInt ( taskArr[0] );
					// [ attack normal / raid, reinforce ]
					if ( kind == 2 )
						return "_1";
					// [ Train Troops ] [ Party Small / Big ] [ Blacksmith Improve Offense, Armoury Improve Defense ]
					if ( kind == 4 || kind == 6 || kind == 3 )
						return "_2";
					// [ Auto Transport ] [ Custom Transport ]
					if ( kind == 5 || kind  == 8 )
						return "_3";
					// [ Deomolish Buildings ]
					if ( kind == 7 )
						return "_7";
					// [ resource / building upgrades ] [ newbuild building ]
					if ( kind == 0 || kind == 1 ) {
						var race = parseInt ( GM_getValue(myacc() + "_raceID"), "" );
						if ( race !=  0 ) // if not romans
							return "_6";
						else { // romans
							var id = parseInt( taskArr[1] );
							if ( id > 18 && id != 50 ) // if building
								return "_5";
							else // resource
								return "_4";
						}
					}
				}
				function checkNewTaskKindUp ( ctr ) {
					if ( ctr == 0 )
						return true;
					var otherTask = tasks[ctr-1].split("_");
					if ( getTaskKind(thisTask) == getTaskKind(otherTask) )
						return false;
					return true;
				}
				function checkNewTaskKindDown ( ctr ) {
					if ( ctr == tasks.length -1 ) {
						return true;
					}
					var otherTask = tasks[parseInt(ctr)+1].split("_");
					if ( getTaskKind(thisTask) == getTaskKind(otherTask) )
						return false;
					return true;
				}
				
				if ( checkNewTaskKindUp(i) && i != 0 ) {
					var aTrHr = document.createElement("tr");
					//aTrHr.innerHTML = "<td colspan='4'><hr/></td>";
					aTdHr = document.createElement("td");
					aTdHr.setAttribute("colspan","100%");
					aTdHr.innerHTML = "<hr/>";
					aTrHr.appendChild(aTdHr);
					taskListTableBody.appendChild(aTrHr);
				}

				// Create up-link for task
				aTr = document.createElement("tr");
				taskListTableBody.appendChild(aTr);
				aTd1 = document.createElement("td");
				aTd1.width = "18px";
				if (i == 0) {
					aTd1.innerHTML = "&#160;";
				}
				else if (i > 0 && thisTask[0] != "2" && ! checkNewTaskKindUp(i) ) {
					taskup = document.createElement("a");
					taskup.href = "#";
					taskup.title = aLangAddTaskText[8];
					nimg = document.createElement("img");
					nimg.setAttribute("src", moveupBtn);
					taskup.appendChild(nimg);
					aTd1.appendChild(taskup);
					taskup.addEventListener('click', moveTask(currentID(), i, -1), false);
				}
				aTr.appendChild(aTd1);

				// Create down-link for task
				aTd2 = document.createElement("td");
				aTd2.width = "28px";
				if (i < tasks.length - 1 && thisTask[0] != "2" && ! checkNewTaskKindDown(i) ) {
					taskdown = document.createElement("a");
					taskdown.href = "#";
					taskdown.title = aLangAddTaskText[9];
					mimg = document.createElement("img");
					mimg.setAttribute("src", movedownBtn);
					taskdown.appendChild(mimg);
					aTd2.appendChild(taskdown);
					taskdown.addEventListener('click', moveTask(currentID(), i, 1), false);
				}
				else if (i == tasks.length - 1) {
					aTd2.innerHTML = "&#160;";
				}
				aTr.appendChild(aTd2);
				
				// Create task text to be shown.
				aTd3 = document.createElement("td");
				taskStr = "";
				// GotGs 2011.01.15 -- Task List Url
				switch (thisTask[0]) {
					case "0": // 0_id_level_time_name 
						// [resource / building upgrade]
						urlToBuilding = "<a class='spantooltip' style='color: PaleVioletRed' href='"+myhost+"/build.php?newdid="+
							currentID()+"&id="+thisTask[1]+"'>"+thisTask[4]+"</a>";
						if (thisTask[1] < 19) { // resource upgrade
							taskStr = aLangTaskKind[0] +"&#160;"+ urlToBuilding + "&#160;&#160;" + aLangGameText[2] + ": " + 
								thisTask[1] + "&#160;&#160;" + aLangAddTaskText[4] + ": " + aLangGameText[0] + " " + thisTask[2];
						}
						else if (thisTask[1] > 18 && thisTask[1] < 42) { // building upgrade
							taskStr = aLangTaskKind[0] +"&#160;"+ urlToBuilding + "&#160;&#160;" + aLangGameText[2] + ": " + 
								thisTask[1] + "&#160;&#160;" + aLangAddTaskText[4] + ": " + aLangGameText[0] + " " + thisTask[2];
						}
						else { // auto-resource upgrade
							taskStr = "<a class='spantooltip' style='color: PaleVioletRed' href='"+myhost+"/dorf1.php?newdid="+
								currentID()+"'>"+aLangTaskOfText[2]+"</a>";
						}
						var starttime= new Date(Number(thisTask[3]));
						aTd3.title = "Start Time: " + starttime.toDateString() + " " + starttime.toLocaleTimeString() + 
							" || Task Str: " + tasks[i];
						break;

					case "1": // 1_id_level_gid_time_name 
						// [newbuild building]
						urlToBuilding = "<a class='spantooltip' style='color: PaleVioletRed' href='"+myhost+"/build.php?newdid="+
							currentID()+"&id="+thisTask[1]+"'>"+aLangAllBuildWithId[parseInt(thisTask[3])]+"</a>";
						taskStr = aLangTaskKind[1] +"&#160;" + urlToBuilding + "&#160;&#160;" + aLangGameText[2] + ": " + 
							thisTask[1] + "&#160;&#160;" + aLangAddTaskText[4] + ": " + aLangGameText[0] + " " + thisTask[2];
						var starttime= new Date(Number(thisTask[3]));
						aTd3.title = "Start Time: " + starttime.toDateString() + " " + starttime.toLocaleTimeString() + 
							" || Task Str: " + tasks[i];
						break;

					case "2": // 2_targetPosition_kind_repeat_startTime_interval_troops_kata1_kata2 
						// [ attack normal / raid, reinforce ]
						var xCoord = getXfromCoord ( thisTask[1] );
						var yCoord = getYfromCoord ( thisTask[1] );
						var targetcoord= "(" + xCoord + "|" + yCoord + ")";
						var villageUrl = "";
						switch ( aTravianVersion ) {
							case "3.6":
								villageUrl = "<a class='spantooltip' style='color: PaleVioletRed' href='"+
									myhost+"/karte.php?newdid="+currentID()+"&z="+thisTask[1]+"'>"+targetcoord+"</a>";
								break;
							case "4.0": // 19 Oct 2011 -- edited by: blablubbb -- Highlight of Attack in Attack-List, when in Detail view of village (which is in the list)
								// TODO:: add this for t3.6 also.
								var hightlight = 'PaleVioletRed';
								if ( window.location.href.indexOf("position_details.php") != -1  ) {
									var highlitCoords = window.location.search.split('=');
									if ( parseInt(highlitCoords[1]) == xCoord && parseInt(highlitCoords[2]) == yCoord ) { hightlight = 'Blue'; }
								}
								villageUrl = "<a class='spantooltip' style='color: "+hightlight+"' href='"+
									myhost+"/karte.php?newdid="+currentID()+"&x="+xCoord+"&y="+yCoord+"'>"+targetcoord+"</a>";
								break;
							default:
								throwLogicError ( "createTaskListTable():: Travian Version not set!!" );
								break;
						}
						var starttime= new Date(Number(thisTask[4]));
						month=starttime.getMonth()+1;
						days=starttime.getDate();
						//if (Xlang == "com") {
							taskStr = aLangAttackType[thisTask[2] - 2] + " " + villageUrl + "&#160;@&#160;" + 
								starttime.toDateString()+" "+starttime.toLocaleTimeString()+ "&#160;for&#160;" + 
								(Number(thisTask[3]) + 1) + " " + aLangTaskOfText[28];
						/*}
						else {
							taskStr = aLangAttackType[thisTask[2] - 2] + " " + targetcoord + "&#160;@&#160;" + month + aLangTaskOfText[29] + days + aLangTaskOfText[30] + starttime.toLocaleTimeString() + "&#160;for&#160;" + (Number(thisTask[3]) + 1) + " " + aLangTaskOfText[28];
						}*/
						var troopse=thisTask[6].split(",");
						troopsss="";
						ra = GM_getValue(myacc() + "_raceID");
						ra = parseInt(ra);
						attackFrequency = thisTask[10] ? thisTask[10] : aLangTaskOfText[27];
						troopsEngaged = "";
						for(w in troopse){
							if(troopse[w]=="0"){continue;}
							troopsss+=aLangTroops[ra][w]+"("+troopse[w]+"), ";
							if ( attackFrequency != aLangTaskOfText[27] ) {
								troopsEngaged += aLangTroops[ra][w]+"("+
									Math.ceil(Number(attackFrequency))*Number(troopse[w])+"), ";
							}
						}
						nextAttackIntervalStr = (thisTask[5]) ? milliSecondstoDHMS(Number(thisTask[5])) : aLangTaskOfText[27];
						attackReachTimeIntervalStr = (thisTask[9]) ? milliSecondstoDHMS(Number(thisTask[9])) : aLangTaskOfText[27];
						//aTd3.title=troopsss;
						aTd3.title= "Troops: " + troopsss + " || Next Attack Interval: " + nextAttackIntervalStr + 
							" || Attack Reach Time Interval: " + attackReachTimeIntervalStr + " || Attack Frequency: " + 
							Number(attackFrequency).toFixed(2) + " || Troops Engaged: " + troopsEngaged + " || Task Str: " + 
							tasks[i];
						break;

					case "3": // 3_kind_id_troop_SN_target//3_2_27_å¤ç½—é©¬æ­¥å…µ_1_11_1251616724168
						// [ Blacksmith Improve Offense, Armoury Improve Defense ]
						var takind = ( thisTask[1] == "1" ) ? aLangTaskOfText[49] : aLangTaskOfText[50];
						var improveUrl = "<a class='spantooltip' style='color: PaleVioletRed' href='"+ 
							myhost+"/build.php?newdid="+currentID()+"&id="+thisTask[2]+"'>"+takind+"</a>";
						taskStr=thisTask[3]+"&#160;&#160;"+ improveUrl +"&#160;&#160;"+ aLangGameText[6]+"&#160;" + aLangGameText[0]+ 
							thisTask[5];
						var starttime= new Date(Number(thisTask[6]));
						//month=starttime.getMonth()+1;
						//days=starttime.getDate();
						//if (Xlang == "com"||Xlang=="fi") {
							titleTime =starttime.toDateString()+" "+starttime.toLocaleTimeString();
						/*}
						else {
							titleTime = month + aLangTaskOfText[29] + days + aLangTaskOfText[30] + starttime.toLocaleTimeString();
						}*/
						//aTd3.title=titleTime;
						aTd3.title="Start Time: " + titleTime + " || Task Str: " + tasks[i];
						break;

					case "4": // 4_25_0_1248341858000_0_54,21,42,0,0,0,0,0,0,0_å…µè¥
						// [ Train Troops ]
						urlToBuilding = "<a class='spantooltip' style='color: PaleVioletRed' href='"+
							myhost+"/build.php?newdid="+currentID()+"&id="+thisTask[1]+"'>"+thisTask[6]+"</a>";
						var starttime = new Date(Number(thisTask[3]));
						month = starttime.getMonth()+1;
						days = starttime.getDate();
						//if ((Xlang == "com") || (Xlang == "fi")) {
							taskStr = aLangTaskKind[4] +" in "+ urlToBuilding + "&#160;@&#160;" + 
								starttime.toDateString()+" "+starttime.toLocaleTimeString()+ "&#160;for&#160;" + 
								(Number(thisTask[2]) + 1) + " " + aLangTaskOfText[28];
						/*}
						else {
							taskStr = thisTask[6] + aLangTaskKind[4] + "&#160;&#160;" + month + aLangTaskOfText[29] + days + aLangTaskOfText[30] + starttime.toLocaleTimeString() + "&#160;&#160;" + (Number(thisTask[2]) + 1) + aLangTaskOfText[28];
						}*/
						var troopse = thisTask[5].split(",");
						troopsss="";
						ra = GM_getValue(myacc() + "_raceID");
						ra = parseInt(ra);
						for(w in troopse){
							if(troopse[w]=="0") continue;
							troopsss += aLangTroops[ra][w]+"("+troopse[w]+"), ";
						}
						//aTd3.title = troopsss;
						aTd3.title = "Troops: " + troopsss + " || Task Str: " + tasks[i];
						break;

					case "5":
						// [ Auto Transport ]
						urlToMarket = "<a class='spantooltip' style='color: PaleVioletRed' href='"+
							myhost+"/build.php?newdid="+currentID()+"&z="+getPosFromNewdid(thisTask[2])+"&gid=17'>"+getvillagefromdid(thisTask[2])+"</a>";
						switch(thisTask[1]){
							case "0":
								taskStr = aLangTaskOfText[8] + " " + aLangGameText[6] + " " + 
									urlToMarket + "&#160;&#160;" + aLangAddTaskText[5] + ":" + 
									aLangAddTaskText[6];
								break;
							case "1":
								taskStr = aLangTaskOfText[8] + " " + aLangGameText[6] + " " + 
									urlToMarket + "&#160;&#160;" + aLangAddTaskText[5] + ":" + 
									aLangAddTaskText[7];
								aTd3.title=aLangTaskOfText[23]+" (d:h:m:s:ms) : " + milliSecondstoDHMS(transsInterval);
								break;
						}
						aTd3.title = aTd3.title + " || Task Str: " + tasks[i];
						break;

					case "6": // 6_1_1000_1245413194000
						// [ Party Small / Big ]
						var taskname = ( thisTask[1] == "1" ) ? aLangTaskOfText[40] : aLangTaskOfText[41];
						var urlToBldgn = "<a class='spantooltip' style='color: PaleVioletRed' href='"+
							myhost+"/build.php?newdid="+currentID()+"&id="+thisTask[4]+"'>"+taskname+"</a>";
						var starttime = new Date(Number(thisTask[3]));
						month=starttime.getMonth()+1;
						days=starttime.getDate();
						//if (Xlang == "com"||Xlang=="fi") {
							taskStr = urlToBldgn + "&#160;&#160;" + starttime.toDateString()+" "+
								starttime.toLocaleTimeString()+ "&#160;&#160;" + (Number(thisTask[2]) + 1) + " " + 
								aLangTaskOfText[28];
						/*}
						else {
							taskStr = taskname + "&#160;&#160;" + month + aLangTaskOfText[29] + days + aLangTaskOfText[30] +"&#160;"+ starttime.toLocaleTimeString() + "&#160;&#160;" + (Number(thisTask[2]) + 1) + aLangTaskOfText[28];
						}*/
						aTd3.title = "Task Str: " + tasks[i];
						break;

					case "7": // "7_" + theID +"_" + crtlevel + "_" + currentID() + "_" +theBuild
						// [ Deomolish Buildings ]
						urlToBuilding = "<a class='spantooltip' style='color: PaleVioletRed' href='"+
							myhost+"/build.php?newdid="+currentID()+"&id=26'>"+aLangTaskKind[7]+"</a>";
						taskStr=urlToBuilding+" "+thisTask[4]+"&#160;&#160;&#160;&#160;"+aLangGameText[17]+
							thisTask[2]+"&#160;&#160;"+aLangGameText[6]+"&#160;&#160;"+aLangGameText[17]+"0";
						aTd3.title = "Task Str: " + tasks[i];
						break;

					case "8": // 8_241654_500,500,500,500_0_1245413194000_interval
						// [ Custom Transport ]
						var tarVillaDid = getNewdidFromPos( thisTask[1] );
						var tarVil = "";
						if ( tarVillaDid != null )
							tarVil = getvillagefromdid ( tarVillaDid );
						else
							tarVil = "(" + getXfromCoord(thisTask[1]) + "/" + getYfromCoord(thisTask[1]) + ")";
						urlToMarketTransf = "<a class='spantooltip' style='color: PaleVioletRed' href='"+
							myhost+"/build.php?newdid="+currentID()+"&z="+thisTask[1]+"&gid=17'>"+tarVil+"</a>";
						var starttime= new Date(Number(thisTask[4]));
						month=starttime.getMonth()+1;

						days=starttime.getDate();
						taskStr = aLangTaskOfText[35] + " " + aLangGameText[6] + " " + urlToMarketTransf +  "&#160;&#160;"  + 
							starttime.toLocaleTimeString() + "&#160;&#160;" + (Number(thisTask[3]) + 1) + aLangTaskOfText[28];

						var asTime = parseInt(thisTask[5]);
						hh=Math.floor(asTime/3600000);
						if(hh<10){hh="0"+hh;}
						mm=Math.floor((asTime-hh*3600000)/60000);
						if(mm<10){mm="0"+mm;}
						ss=Math.ceil((asTime-hh*3600000-mm*60000)/1000);
						if(ss<10){ss="0"+ss;}
						intervalt= hh+":"+mm+":"+ss;
						//aTd3.title=thisTask[2]+" | "+aLangTaskOfText[23]+" "+intervalt;
						aTd3.title="Resources: " + thisTask[2] + " || "+aLangTaskOfText[23] + ": " + intervalt + 
							" || Task Str: " + tasks[i];
						break;
				}
				aTd3.innerHTML = taskStr;
				aTr.appendChild(aTd3);

				var linksList = aTd3.links || aTd3.getElementsByTagName('a');
				if ( linksList.length > 0 && aTd3.title != "" ) {
					var linkSpanText = aTd3.title.replace(/ \|\| /g,"<br/>");
					linksList[0].innerHTML += '<span>' + linkSpanText + '</span>';
					aTd3.title = "";
				}


				// msd
				// Create edit link for task.
				aTd5 = document.createElement("td");
				aTd5.width = "28px";
				aTd5.style.textAlign = "center";
				if ( thisTask[0] == "2" || thisTask[0] == "8" ) { // for now only for attack tasks & custom transports
					editTaskk = document.createElement("a");
					editTaskk.setAttribute("title", "Edit");
					editTaskk.href = "#";
					limg1 = document.createElement("img");
					limg1.setAttribute("src", sDotImage);
					editTaskk.appendChild(limg1);
					(function () {
						var currentTaskStr = tasks[i];
						editTaskk.addEventListener("click", function () { editTask(currentTaskStr); }, false);
					})();
					aTd5.appendChild(editTaskk);
				}
				aTr.appendChild(aTd5);
				// msd end
		
				// Create delete link for task.	
				aTd4 = document.createElement("td");
				aTd4.width = "38px";
				aTd4.style.textAlign = "center";
				deleteTaskk = document.createElement("a");
				deleteTaskk.setAttribute("title", aLangAddTaskText[10]);
				deleteTaskk.href = "#";
				limg2 = document.createElement("img");
				limg2.setAttribute("src", deleteBtn);
				deleteTaskk.appendChild(limg2);
				(function () {
					var currentTaskStr = tasks[i];
					deleteTaskk.addEventListener("click", function () { deleteTaskCookie(currentTaskStr); }, false);
				} ) ();
				aTd4.appendChild(deleteTaskk);
				aTr.appendChild(aTd4);
			}
		}

		// Create a horizontal line after all tasks.
		aTr6 = document.createElement("tr");
		aTd6 = document.createElement("td");
		aTd6.setAttribute("colspan", "100%");
		aTd6.innerHTML="<hr/>";
		aTr6.appendChild(aTd6);
		taskListTableBody.appendChild(aTr6);

		// Create a new row with a new table inside it.
		aTr5 = document.createElement("tr");
		aTd5 = document.createElement("td");
		aTd5.setAttribute("colspan", "100%");

		var enderTable = document.createElement("table");

			// Create link for delete all tasks.
			aTr8 = document.createElement("tr");
			aTd8 = document.createElement("td");
			aTd8.align="center";
			deleteAllTask = document.createElement("a");
			deleteAllTask.style.fontSize = "x-small";
			deleteAllTask.href = "#";
			deleteAllTask.id="deletealltask";
			deleteAllTask.title = aLangAddTaskText[13];
			deleteAllTask.innerHTML = " "+aLangAddTaskText[13]+"&#160;&#160;";
			deleteAllTask.addEventListener('click', deleteAllTasks, true);
			aTd8.appendChild(deleteAllTask);
			aTr8.appendChild(aTd8);

			// Create link for pause / un-pause all activity.	
			aTd9 = document.createElement("td");
			aTd9.align="center";
			pausekey=document.createElement("a");
			pausekey.style.fontSize = "x-small";
			pausekey.href = "#";
			pausekey.title = "If paused, the script will auto-start on next automatic reload of page.";
			switch (taskdoing){
				case "0":
					aTd9.innerHTML="&#160;"+aLangTaskOfText[44].fontcolor("red") +"&#160;";
					pausekey.id="clicktostart";
					pausekey.innerHTML=aLangTaskOfText[46]+"&#160;";
				break;
				case "1":
					aTd9.innerHTML="&#160;"+aLangTaskOfText[45].fontcolor("green")+"&#160;";
					pausekey.id="clicktopause";
					pausekey.innerHTML=aLangTaskOfText[47]+"&#160;";
				break;
			}
			aTd9.appendChild(pausekey);
			pausekey.addEventListener("click", pauseandstart, false);
			aTr8.appendChild(aTd9);

			// Create link for auto task version.
			aTd7 = document.createElement("td");
			aTd7.align="center";
			aTd7.innerHTML="&#160;&#160;"+"<a style='font-size:x-small' href='http://userscripts.org/scripts/show/95032' id='verdisp'  target='_blank'>"+crtVersion+"</a>";
			aTr8.appendChild(aTd7);

			// GotGs 2011.01.15 -- For Pause / Un-Pause Attacks, Pause / Un-Pause Cata Attacks, Pause / Un-Pause Upgrades
			aTr100 = document.createElement("tr");

			// GotGs 2011.01.15 -- For Pause / Un-Pause Attacks...
			aTd100 = document.createElement("td");
			aTd100.align="center";
			pauseAttack = document.createElement("a");
			pauseAttack.style.fontSize = "x-small";
			pauseAttack.href = "#";
			var pauseAttackStatus = getVillageOption ( "PAUSE_ALL_ATTACKS", 0, "integer", currentID() );
			switch (pauseAttackStatus)
			{
			case 0:	// Unpaused, ie currently running
				pauseAttack.id="pauseattack";
				pauseAttack.title = aLangTaskListCmds[0];
				pauseAttack.innerHTML = " " + aLangTaskListCmds[0].fontcolor("green") + "&#160;&#160;";
				pauseAttack.addEventListener('click',pauseAllAttack,true);
				break;
			case 1:	// Paused, ie currently stopped
			default:
				pauseAttack.id="unpauseattack";
				pauseAttack.title = aLangTaskListCmds[1];
				pauseAttack.innerHTML = " " + aLangTaskListCmds[1].fontcolor("red") + "&#160;&#160;";
				pauseAttack.addEventListener('click',unpauseAllAttack,true);
				break;
			};
			aTd100.appendChild(pauseAttack);
			aTr100.appendChild(aTd100);

			// GotGs 2011.01.15 -- For Pause / Un-Pause Cata Attacks...
			aTd101 = document.createElement("td");
			aTd101.align="center";
			pauseCataAttack = document.createElement("a");
			pauseCataAttack.style.fontSize = "x-small";
			pauseCataAttack.href = "#";
			var pauseCataAttackStatus = getVillageOption( "PAUSE_ALL_CATA_ATTACKS", 0, "integer", currentID() );
			switch ( pauseCataAttackStatus )
			{
			case 0: // Unpaused, ie currently running
				pauseCataAttack.id = "pausecataattack";
				pauseCataAttack.title = aLangTaskListCmds[2];
				pauseCataAttack.innerHTML = " " + aLangTaskListCmds[2].fontcolor("green") + "&#160;&#160;";
				pauseCataAttack.addEventListener('click',pauseAllCataAttack,true);
				break;
			case 1: // Paused, ie currently stopped
			default:
				pauseCataAttack.id = "unpausecataattack";
				pauseCataAttack.title = aLangTaskListCmds[3];
				pauseCataAttack.innerHTML = " " + aLangTaskListCmds[3].fontcolor("red") + "&#160;&#160;";
				pauseCataAttack.addEventListener('click',unpauseAllCataAttack,true);
				break;
			};
			aTd101.appendChild(pauseCataAttack);
			aTr100.appendChild(aTd101);

			// GotGs 2011.01.15 -- For Pause / Un-Pause Upgrades...
			aTd102 = document.createElement("td");
			aTd102.align="center";
			pauseUpgrades = document.createElement("a");
			pauseUpgrades.style.fontSize = "x-small";
			pauseUpgrades.href = "#";
			var pauseUpgradesStatus = getVillageOption( "PAUSE_ALL_UPGRADES", 0, "integer", currentID() );
			switch ( pauseUpgradesStatus )
			{
			case 0: // Unpaused, ie currently running
				pauseUpgrades.id = "pauseupgrades";
				pauseUpgrades.title = aLangTaskListCmds[4];
				pauseUpgrades.innerHTML = " " + aLangTaskListCmds[4].fontcolor("green") + "&#160;&#160;";
				pauseUpgrades.addEventListener('click',pauseAllUpgrades,true);
				break;
			case 1: // Paused, ie currently stopped
			default:
				pauseUpgrades.id = "unpauseupgrades";
				pauseUpgrades.title = aLangTaskListCmds[5];
				pauseUpgrades.innerHTML = " " + aLangTaskListCmds[5].fontcolor("red") + "&#160;&#160;";
				pauseUpgrades.addEventListener('click',unpauseAllUpgrades,true);
				break;
			};
			aTd102.appendChild(pauseUpgrades);
			aTr100.appendChild(aTd102);

			// GotGs 2011.01.15 -- For Pause / Un-Pause Resource / Building Upgrades, Pause / Un-Pause Market Transfers
			aTr200 = document.createElement("tr");

			// GotGs 2011.01.15 -- For Pause / Un-Pause Resource Upgrades...
			aTd201 = document.createElement("td");
			aTd201.align="center";
			pauseResUpgrades = document.createElement("a");
			pauseResUpgrades.style.fontSize = "x-small";
			pauseResUpgrades.href = "#";
			var pauseResUpgradesStatus = getVillageOption( "PAUSE_RESOURCE_UPGRADES", 0, "integer", currentID() );
			switch ( pauseResUpgradesStatus )
			{
			case 0: // Unpaused, ie currently running
				pauseResUpgrades.id = "pauseresupgrades";
				pauseResUpgrades.title = aLangTaskListCmds[6];
				pauseResUpgrades.innerHTML = " " + aLangTaskListCmds[6].fontcolor("green") + "&#160;&#160;";
				pauseResUpgrades.addEventListener('click',pauseResourceUpgrades,true);
				break;
			case 1: // Paused, ie currently stopped
			default:
				pauseResUpgrades.id = "unpauseresupgrades";
				pauseResUpgrades.title = aLangTaskListCmds[7];
				pauseResUpgrades.innerHTML = " " + aLangTaskListCmds[7].fontcolor("red") + "&#160;&#160;";
				pauseResUpgrades.addEventListener('click',unpauseResourceUpgrades,true);
				break;
			};
			aTd201.appendChild(pauseResUpgrades);
			aTr200.appendChild(aTd201);

			// GotGs 2011.01.15 -- For Pause / Un-Pause Building Upgrades...
			aTd202 = document.createElement("td");
			aTd202.align="center";
			pauseBldUpgrades = document.createElement("a");
			pauseBldUpgrades.style.fontSize = "x-small";
			pauseBldUpgrades.href = "#";
			var pauseBldUpgradesStatus = getVillageOption( "PAUSE_BUILDING_UPGRADES", 0, "integer", currentID() );
			switch ( pauseBldUpgradesStatus )
			{
			case 0: // Unpaused, ie currently running
				pauseBldUpgrades.id = "pausebldupgrades";
				pauseBldUpgrades.title = aLangTaskListCmds[8];
				pauseBldUpgrades.innerHTML = " " + aLangTaskListCmds[8].fontcolor("green") + "&#160;&#160;";
				pauseBldUpgrades.addEventListener('click',pauseBuildingUpgrades,true);
				break;
			case 1: // Paused, ie currently stopped
			default:
				pauseBldUpgrades.id = "unpausebldupgrades";
				pauseBldUpgrades.title = aLangTaskListCmds[9];
				pauseBldUpgrades.innerHTML = " " + aLangTaskListCmds[9].fontcolor("red") + "&#160;&#160;";
				pauseBldUpgrades.addEventListener('click',unpauseBuildingUpgrades,true);
				break;
			};
			aTd202.appendChild(pauseBldUpgrades);
			aTr200.appendChild(aTd202);

			// GotGs 2011.01.15 -- For Pause / Un-Pause Market Transfers...
			aTd203 = document.createElement("td");
			aTd203.align="center";
			pauseMrktTrnfs = document.createElement("a");
			pauseMrktTrnfs.style.fontSize = "x-small";
			pauseMrktTrnfs.href = "#";
			var pauseMrktTrnfsStatus = getVillageOption( "PAUSE_MARKET_TRANSFERS", 0, "integer", currentID() );
			switch ( pauseMrktTrnfsStatus )
			{
			case 0: // Unpaused, ie currently running
				pauseMrktTrnfs.id = "pausemrkttrnfs";
				pauseMrktTrnfs.title = aLangTaskListCmds[10];
				pauseMrktTrnfs.innerHTML = " " + aLangTaskListCmds[10].fontcolor("green") + "&#160;&#160;";
				pauseMrktTrnfs.addEventListener('click',pauseMarketTransfers,true);
				break;
			case 1: // Paused, ie currently stopped
			default:
				pauseMrktTrnfs.id = "unpausemrkttrnfs";
				pauseMrktTrnfs.title = aLangTaskListCmds[11];
				pauseMrktTrnfs.innerHTML = " " + aLangTaskListCmds[11].fontcolor("red") + "&#160;&#160;";
				pauseMrktTrnfs.addEventListener('click',unpauseMarketTransfers,true);
				break;
			};
			aTd203.appendChild(pauseMrktTrnfs);
			aTr200.appendChild(aTd203);

			// GotGs 2011.01.15 -- For Pause / Un-Pause Troops Training, Pause / Un-Pause Party, Pause / Un-Pause Troops Upgrade.
			aTr300 = document.createElement("tr");

			// GotGs 2011.01.15 -- For Pause / Un-Pause Troops Training...
			aTd301 = document.createElement("td");
			aTd301.align="center";
			pauseTrpsTrain = document.createElement("a");
			pauseTrpsTrain.style.fontSize = "x-small";
			pauseTrpsTrain.href = "#";
			var pauseTrpsTrainStatus = getVillageOption( "PAUSE_TROOPS_TRAINING", 0, "integer", currentID() );
			switch ( pauseTrpsTrainStatus )
			{
			case 0: // Unpaused, ie currently running
				pauseTrpsTrain.id = "pausetroopstraining";
				pauseTrpsTrain.title = aLangTaskListCmds[12];
				pauseTrpsTrain.innerHTML = " " + aLangTaskListCmds[12].fontcolor("green") + "&#160;&#160;";
				pauseTrpsTrain.addEventListener('click',pauseTroopsTraining,true);
				break;
			case 1: // Paused, ie currently stopped
			default:
				pauseTrpsTrain.id = "unpausetroopstraining";
				pauseTrpsTrain.title = aLangTaskListCmds[13];
				pauseTrpsTrain.innerHTML = " " + aLangTaskListCmds[13].fontcolor("red") + "&#160;&#160;";
				pauseTrpsTrain.addEventListener('click',unpauseTroopsTraining,true);
				break;
			};
			aTd301.appendChild(pauseTrpsTrain);
			aTr300.appendChild(aTd301);

			// GotGs 2011.01.15 -- For Pause / Un-Pause Party...
			aTd302 = document.createElement("td");
			aTd302.align="center";
			pausePrty = document.createElement("a");
			pausePrty.style.fontSize = "x-small";
			pausePrty.href = "#";
			var pausePrtyStatus = getVillageOption( "PAUSE_PARTYING", 0, "integer", currentID() );
			switch ( pausePrtyStatus )
			{
			case 0: // Unpaused, ie currently running
				pausePrty.id = "pauseprty";
				pausePrty.title = aLangTaskListCmds[14];
				pausePrty.innerHTML = " " + aLangTaskListCmds[14].fontcolor("green") + "&#160;&#160;";
				pausePrty.addEventListener('click',pausePartying,true);
				break;
			case 1: // Paused, ie currently stopped
			default:
				pausePrty.id = "unpauseprty";
				pausePrty.title = aLangTaskListCmds[15];
				pausePrty.innerHTML = " " + aLangTaskListCmds[15].fontcolor("red") + "&#160;&#160;";
				pausePrty.addEventListener('click',unpausePartying,true);
				break;
			};
			aTd302.appendChild(pausePrty);
			aTr300.appendChild(aTd302);

			// GotGs 2011.01.15 -- For Pause / Un-Pause Troops Upgrade...
			aTd303 = document.createElement("td");
			aTd303.align="center";
			pauseTrpsUpgrade = document.createElement("a");
			pauseTrpsUpgrade.style.fontSize = "x-small";
			pauseTrpsUpgrade.href = "#";
			var pauseTrpsUpgradeStatus = getVillageOption( "PAUSE_TROOPS_UPGRADE", 0, "integer", currentID() );
			switch ( pauseTrpsUpgradeStatus )
			{
			case 0: // Unpaused, ie currently running
				pauseTrpsUpgrade.id = "pausetrpsupgrade";
				pauseTrpsUpgrade.title = aLangTaskListCmds[16];
				pauseTrpsUpgrade.innerHTML = " " + aLangTaskListCmds[16].fontcolor("green") + "&#160;&#160;";
				pauseTrpsUpgrade.addEventListener('click',pauseTroopsUpgrade,true);
				break;
			case 1: // Paused, ie currently stopped
			default:
				pauseTrpsUpgrade.id = "unpausetrpsupgrade";
				pauseTrpsUpgrade.title = aLangTaskListCmds[17];
				pauseTrpsUpgrade.innerHTML = " " + aLangTaskListCmds[17].fontcolor("red") + "&#160;&#160;";
				pauseTrpsUpgrade.addEventListener('click',unpauseTroopsUpgrade,true);
				break;
			};
			aTd303.appendChild(pauseTrpsUpgrade);
			aTr300.appendChild(aTd303);

			enderTable.appendChild(aTr8);
			enderTable.appendChild(aTr100);
			enderTable.appendChild(aTr200);
			enderTable.appendChild(aTr300);

		aTd5.appendChild(enderTable);
		aTr5.appendChild(aTd5);
		taskListTableBody.appendChild(aTr5);

		// Create a horizontal line after all tasks.
		aTr7 = document.createElement("tr");
		aTd7 = document.createElement("td");
		aTd7.setAttribute("colspan", "100%");
		aTd7.innerHTML="<hr/>";
		aTr7.appendChild(aTd7);
		taskListTableBody.appendChild(aTr7);

		// Cluster Maps [clustrmaps] -- not shown on any page with a timer, on login window, and when in debug mode
		var timerElems = document.evaluate ( './/*[contains(@id,"timer")]', document, null, XPFirst, null ).singleNodeValue;
		if ( timerElems == null // show when no timers on current page
				&& self.window.name != GM_getValue(currentServer() +'_loginWindow', "noLoginWindow") // show when not login window
				//&& GM_getValue ( currentServer() + "_debugMode", "0" ) == "0" // show when debug mode is false
			) {
			// Create a new row with a new table inside it.
			aTr8 = document.createElement("tr");
			aTd8 = document.createElement("td");
			aTd8.setAttribute("colspan", "100%");
			var enderTable2 = document.createElement("table");

			aTr400 = document.createElement("tr");
			aTd401 = document.createElement("td");
			aTd402 = document.createElement("td");
			aTd402.style.textAlign = "center";
			// standard cluster map
			/*aTd401.innerHTML = '<a href="http://www2.clustrmaps.com/counter/maps.php?url=http://userscripts.org/scripts/show/95032" id="clustrMapsLink">'+
				'<img src="http://www2.clustrmaps.com/counter/index2.php?url=http://userscripts.org/scripts/show/95032" style="border:0px;"'+
				' alt="Locations of visitors to this page" title="Locations of visitors to this page" id="clustrMapsImg"'+
				' onerror=\'this.onerror=null; this.src="http://clustrmaps.com/images/clustrmaps-back-soon.jpg";'+
				' document.getElementById("clustrMapsLink").href="http://clustrmaps.com";\' />'+
				'</a>';*/
			// minimalistic cluster map
			aTd402.innerHTML = '<a href="http://www2.clustrmaps.com/user/a6ed2027">'+
				'<img src="http://www2.clustrmaps.com/stats/maps-no_clusters/userscripts.org-scripts-show-95032-thumb.jpg"'+
				' alt="Locations of visitors to this page" />'+
				'</a>';
			aTd403 = document.createElement("td");
			aTr400.appendChild(aTd401);
			aTr400.appendChild(aTd402);
			aTr400.appendChild(aTd403);
			enderTable2.appendChild(aTr400);

			aTd8.appendChild(enderTable2);
			aTr8.appendChild(aTd8);
			taskListTableBody.appendChild(aTr8);
		}
	}
	taskListTable.appendChild(taskListTableBody);

	return taskListTable;
}

function pauseAllAttack()
{
	maintainFoldStatus();
	setVillageOption( "PAUSE_ALL_ATTACKS", 1, currentID() );
	setVillageOption("PAUSE_ALL_CATA_ATTACKS", 1, currentID() );

	showTaskList();

	return false;
}

function unpauseAllAttack()
{
	maintainFoldStatus();
	setVillageOption( "PAUSE_ALL_ATTACKS", 0, currentID() );

	showTaskList();

	return false;
}

function pauseAllCataAttack()
{
	maintainFoldStatus();
	setVillageOption("PAUSE_ALL_CATA_ATTACKS", 1, currentID() );

	showTaskList();

	return false;
}

function unpauseAllCataAttack()
{
	maintainFoldStatus();
	if ( getVillageOption( "PAUSE_ALL_ATTACKS", 0, "integer", currentID() ) != 1 ) {
		setVillageOption("PAUSE_ALL_CATA_ATTACKS", 0, currentID() );

		showTaskList();
	}

	return false;
}

function pauseAllUpgrades()
{
	maintainFoldStatus();
	setVillageOption("PAUSE_ALL_UPGRADES", 1, currentID() );
	setVillageOption("PAUSE_RESOURCE_UPGRADES", 1, currentID() );
	setVillageOption("PAUSE_BUILDING_UPGRADES", 1, currentID() );

	showTaskList();

	return false;
}

function unpauseAllUpgrades()
{
	maintainFoldStatus();
	setVillageOption("PAUSE_ALL_UPGRADES", 0, currentID() );
	setVillageOption("PAUSE_RESOURCE_UPGRADES", 0, currentID() );
	setVillageOption("PAUSE_BUILDING_UPGRADES", 0, currentID() );
	var myRace = GM_getValue(myacc() + "_raceID");
	if ( myRace == "0" ) {
		GM_setValue(herere() + "_ResourceTaskExists", "1");
		GM_setValue(herere() + "_BuildingTaskExists", "1");
	}
	else {
		GM_setValue(herere() + "_UpdataTaskExists", "1");
	}

	showTaskList();

	return false;
}

function pauseResourceUpgrades()
{
	maintainFoldStatus();
	setVillageOption("PAUSE_RESOURCE_UPGRADES", 1, currentID() );

	showTaskList();

	return false;
}

function unpauseResourceUpgrades()
{
	maintainFoldStatus();
	setVillageOption("PAUSE_RESOURCE_UPGRADES", 0, currentID() );
	var myRace = GM_getValue(myacc() + "_raceID");
	if ( myRace == "0" )
		GM_setValue(herere() + "_ResourceTaskExists", "1");
	else
		GM_setValue(herere() + "_UpdataTaskExists", "1");

	showTaskList();

	return false;
}

function pauseBuildingUpgrades()
{
	maintainFoldStatus();
	setVillageOption("PAUSE_BUILDING_UPGRADES", 1, currentID() );

	showTaskList();

	return false;
}

function unpauseBuildingUpgrades()
{
	maintainFoldStatus();
	setVillageOption("PAUSE_BUILDING_UPGRADES", 0, currentID() );
	var myRace = GM_getValue(myacc() + "_raceID");
	if ( myRace == "0" )
		GM_setValue(herere() + "_BuildingTaskExists", "1");
	else
		GM_setValue(herere() + "_UpdataTaskExists", "1");

	showTaskList();

	return false;
}

function pauseMarketTransfers()
{
	maintainFoldStatus();
	setVillageOption("PAUSE_MARKET_TRANSFERS", 1, currentID() );

	showTaskList();

	return false;
}

function unpauseMarketTransfers()
{
	maintainFoldStatus();
	setVillageOption("PAUSE_MARKET_TRANSFERS", 0, currentID() );

	showTaskList();

	return false;
}

function pauseTroopsTraining()
{
	maintainFoldStatus();
	setVillageOption("PAUSE_TROOPS_TRAINING", 1, currentID() );

	showTaskList();

	return false;
}

function unpauseTroopsTraining()
{
	maintainFoldStatus();
	setVillageOption("PAUSE_TROOPS_TRAINING", 0, currentID() );

	showTaskList();

	return false;
}

function pausePartying()
{
	maintainFoldStatus();
	setVillageOption("PAUSE_PARTYING", 1, currentID() );

	showTaskList();

	return false;
}

function unpausePartying()
{
	maintainFoldStatus();
	setVillageOption("PAUSE_PARTYING", 0, currentID() );

	showTaskList();

	return false;
}

function pauseTroopsUpgrade()
{
	maintainFoldStatus();
	setVillageOption("PAUSE_TROOPS_UPGRADE", 1, currentID() );

	showTaskList();

	return false;
}

function unpauseTroopsUpgrade()
{
	maintainFoldStatus();
	setVillageOption("PAUSE_TROOPS_UPGRADE", 0, currentID() );

	showTaskList();

	return false;
}

function pauseandstart(){
	if ($("clicktostart")) { 
		calldoing1();
		getTaskCookies();
	}
	if ($("clicktopause")) { 
		calldoing0();
	}
	showTaskList();

	return false;
}

function maintainFoldStatus() {
	try {
		var taskListFoldVal = document.evaluate('.//table[@id="tasklisttable"]/thead', document, null, XPFirst, null).singleNodeValue;
		taskListFoldVal = taskListFoldVal == null ? "1" : "0"; // null means folded, non-null means not-folded.
		switch ( taskListFoldVal ) {
			case "0": // currently not-folded, so keep it unfolded
				setOption("FOLD_TASKLIST", "0");
				break;
			case "1": // currently folded, so keep it folded
				setOption("FOLD_TASKLIST", "1");
				break;
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>maintainFoldStatus():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function deleteTaskCookie(taskStr) {
	try {
		//flag ( "deleteTaskCookie():: Started!" );

		maintainFoldStatus();

		var taskss = GM_getValue ( herere() + "_waitTask", "false" );
		if ( taskss == "false" || taskss.indexOf(taskStr) == -1 ) { // don't do anything if task does not exist.
			//showTaskList();
			return;
		}
		var thisTask = taskStr.split("_");
		//thisTask = taskss.split("|")[j].split("_");
		switch (thisTask[0]) {
			case "0":
				if (thisTask[1] <= 18) {
					GM_deleteValue(herere() + "_resRequiredForResUpgrade");
					GM_deleteValue(herere() + "_resRequired");
					GM_deleteValue(herere() + "_ResourceUpdataTime");
					GM_deleteValue(herere() + "_UpdataTime");
				}
				else if (thisTask[1] > 18 && thisTask[1] < 42) { // resource / building upgrade
					GM_deleteValue(herere() + "_resRequiredForBldgUpgrade");
					GM_deleteValue(herere() + "_resRequired");
					GM_deleteValue(herere() + "_BuildingUpdataTime");
					GM_deleteValue(herere() + "_UpdataTime");
				}
				else { // autoResource
					GM_deleteValue(herere() + "_autoResource");
					// GotGs 2011.01.22 -- when autoresource task is deleted, recreate link on dorf1.php.
					if ( $("autoResdiv") != null )
						createAutoResLink();
				}
				break;

			case "1": // new build
				GM_deleteValue(herere() + "_resRequiredForBldgUpgrade");
				GM_deleteValue(herere() + "_resRequired");
				GM_deleteValue(herere() + "_BuildingUpdataTime");
				GM_deleteValue(herere() + "_UpdataTime");
				break;

			case "5": // auto transport
				GM_deleteValue(herere() + "_to_" + thisTask[2] + "_TraningTime");
				GM_deleteValue(herere() + "_to_" + thisTask[2] + "_autoTransTime");
				auTranTo=GM_getValue(herere() + "_autoTransTo");
				if ( auTranTo != undefined ) {
					auTrans=auTranTo.split("|");
					if (auTrans.length > 1) {
						for (a in auTrans) {
							if (auTrans[a] == thisTask[2]) {
								auTrans.splice(a, 1);
								break;
							}
						}
						GM_setValue(herere() + "_autoTransTo",auTrans.join("|"));
					}
					else {
						GM_deleteValue(herere() + "_autoTransTo");
					}
				}
				break;

			case "7": // demolish
				GM_deleteValue(herere() + "_demolishTime");
				break;

		}
		deleteTaskFromCookie(currentID(), thisTask);
		clearCropWarehouseGranaryError ( currentID() );
		
		return false;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>deleteTaskCookie():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function deleteAllTasks(){
	GM_deleteValue(herere() + "_waitTask");
	GM_deleteValue(herere() + "_resRequiredForResUpgrade");
	GM_deleteValue(herere() + "_resRequiredForBldgUpgrade");
	GM_deleteValue(herere() + "_resRequired");
	GM_deleteValue(herere() + "_BuildingUpdataTime");
	GM_deleteValue(herere() + "_ResourceUpdataTime");
	GM_deleteValue(herere() + "_UpdataTime");
	GM_deleteValue(herere() + "_autoTransTime");
	GM_deleteValue(herere() + "_TraningTime");
	GM_deleteValue(herere() + "_autoTransTo");
	GM_deleteValue(herere() + "_autoResource");
	GM_deleteValue(herere() + "_demolishTime");
	calldoing0();
	showTaskList();

	return false;
}

// adds crop task at top of task list if it was not already added
function addCropTaskAtTop(vill) {
	try {
		flag ( "addCropTaskAtTop():: Started!" );
		var curBuildingList = getCookie("BuildingTimeList",vill);
		if ( curBuildingList ) {
			var serverNowTime = new Date().getTime() - serverTimeDiff;
			for ( var ctr = 0 ; ctr < curBuildingList.length ; ctr++ ) {
				// a crop-land is currently building hence cannot add task
				if ( parseInt(curBuildingList[ctr].gid) == 4 && parseInt(curBuildingList[ctr].time) > serverNowTime ) {
					flag ( "addCropTaskAtTop():: A crop-land is currently building, hence will not add crop task!" );
					return false;
				}
			}
		}

		var minLevelCropId = GM_getValue(myacc() + "_" + vill + "_minLevelCropId");
		if ( minLevelCropId == null ) {
			throwLogicError ( "addCropTaskAtTop():: Error:: _" + vill + "_minLevelCropId is null!" );
		}

		var minLevelCropLevel = GM_getValue(myacc() + "_" + vill + "_minLevelCropLevel");
		if ( minLevelCropLevel == null ) {
			throwLogicError ( "addCropTaskAtTop():: Error:: _" + vill + "_minLevelCropLevel is null!" );
		}

		var newTaskStr = "0_" + minLevelCropId + "_" + (parseInt(minLevelCropLevel)+1) + "_00000000000_" + aLangAllBuildWithId[3];
		var taskString = GM_getValue(myacc() + "_" + vill + "_waitTask", "");
		if ( taskString.indexOf ( "_00000000000_" + aLangAllBuildWithId[3] ) == -1 ) { // add task only if not already present
			var newTaskstring = newTaskStr + "|" + taskString;
			GM_setValue(myacc() + "_" + vill + "_waitTask", newTaskstring);
			var myRace = GM_getValue(myacc() + "_raceID");
			if ( myRace == null ) { // this should not happen
				throwLogicError ( "addCropTaskAtTop():: Error:: _raceID is not set!" );
			}
			switch (myRace) {
				case "0": // romans
					GM_deleteValue ( myacc() + "_" + vill + "_resRequiredForResUpgrade" );
					GM_setValue ( myacc() + "_" + vill + "_ResourceTaskExists", "1" );
					GM_deleteValue ( myacc() + "_" + vill + "_ResourceUpdataTime" );
					break;
				case "1": // non-roman races
				case "2":
					GM_deleteValue ( myacc() + "_" + vill + "_resRequired" );
					GM_setValue(myacc() + "_" + vill + "_UpdataTaskExists", "1");
					GM_deleteValue(myacc() + "_" + vill + "_UpdataTime");
					break;
			}
			//window.setTimeout ( function () {
							//reloadLoginWindow();
							//getTaskCookies();
							//calldoing1();
							//showTaskList();
			//			},
			//		Math.ceil ( Math.random() * 5*1000 + 1*1000 ) ); // random ( 5 sec ) + 1 sec
			return true;
		}
		return false;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>addCropTaskAtTop():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function setBuildingPreRequisiteError ( vi ) {
	GM_setValue ( myacc() + "_" + vi + "_buildingPreRequisiteError", "1" );
}

function checkBuildingPreRequisiteError ( vi ) {
	return ( GM_getValue ( myacc() + "_" + vi + "_buildingPreRequisiteError", "0" ) == "1" );
}

function clearBuildingPreRequisiteError ( vi ) {
	GM_deleteValue ( myacc() + "_" + vi + "_buildingPreRequisiteError" );
}

function getCurrentlyUpgradingFristBuildingGid ( vi ) {
	try {
		var curBuildingList = getCookie("BuildingTimeList",vi);
		if ( curBuildingList ) {
			var serverNowTime = new Date().getTime() - serverTimeDiff;
			for ( var ctr = 0 ; ctr < curBuildingList.length ; ctr++ ) {
				if ( curBuildingList[ctr].type == BuildType.building 
						&& parseInt(curBuildingList[ctr].time) > serverNowTime ) {
					return curBuildingList[ctr].gid;
				}
			}
		}
		return false;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getCurrentlyUpgradingFristBuildingGid():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// Adds a new building newbuild/upgrade task at the top.
// Adds task only if the gid specified is not already building and if the task has not been added earlier.
// If new task is added, login window is reloaded, else not.
// If lvl is specified, it is used, ow next level is assumed.
// gid 10 --> warehouse
// gid 11 --> granary
// returns true if login window has been scheduled for reload ow returns false.
function addBuildingTaskAtTop(vi, gid, lvl) {
	try {
		//flag ( "addBuildingTaskAtTop():: Started! vi: " + vi );
		if ( gid == null || gid == undefined || gid == "" || isNaN(parseInt(gid)) ) {
			var msg = "addBuildingTaskAtTop():: Invalid gid passed as parameter! gid: " + gid; 
			TS_debug ( msg );
			var errObj = new Error () ;
			errObj.name = "Invalid Argument passed to function";
			errObj.message = msg;
			throw errObj;
		}
		gid = parseInt(gid);

		var curBuildingList = getCookie("BuildingTimeList",vi);
		if ( curBuildingList ) {
			var serverNowTime = new Date().getTime() - serverTimeDiff;
			for ( var ctr = 0 ; ctr < curBuildingList.length ; ctr++ ) {
				if ( parseInt(curBuildingList[ctr].gid) == parseInt(gid) 
						&& parseInt(curBuildingList[ctr].time) > serverNowTime ) { // specified gid is currently building hence cannot add task
					flag ( "addBuildingTaskAtTop():: A " + aLangAllBuildWithId[gid] + " is currently building, hence will not add task!" );
					return false;
				}
			}
		}

		var buildData = getCookie("BuildingData",vi);
		if ( !buildData ) {
			return false;
		}
		var buildMaxLevel = parseInt(maxlevel[gid],10);
		var idToUse = 0;
		var level = 1;
		var emptyId = 0;
		if ( gid == 15 || gid == 16 || gid == 31 || gid == 32 || gid == 33 ) {
			switch ( gid ) {
				case 15: // main building
					idToUse = 26; break;
				case 16: // rally point
					idToUse = 39; break;
				case 31: case 32: case 33: // City Wall, Earth Wall, Palisade
					idToUse = 40; break;
			}
			if ( buildData[idToUse] == null || buildData[idToUse].level == null ) {
				var callBackUrl = myhost + "/dorf2.php?newdid=" + vi;
				TS_getRequest ( callBackUrl, function() {} ); // attempt to refresh BuildingData
				return false;
			}
			level = parseInt ( buildData[idToUse].level ) + 1;
			if ( level == 1 ) {
				emptyId = idToUse;
				idToUse = 0;
			}
		}
		else {
			for ( var ctr = 19 ; ctr < buildData.length ; ctr++ ) {
				if ( buildData[ctr] == null ) { // BuildingData is incomplete, cannot process now, hence return false;
					var callBackUrl = myhost + "/dorf2.php?newdid=" + vi;
					TS_getRequest ( callBackUrl, function() {} ); // attempt to refresh BuildingData
					return false;
				}
				// if gid is not warehouse, granary or cranny and building level is at max, we cannot upgrade or create a new building, hence return false.
				if ( parseInt(buildData[ctr].gid) == gid && parseInt(buildData[ctr].level) == buildMaxLevel && gid != 10 && gid != 11 && gid != 23 )
					return false;
				// if found the gid with level less than maxlevel use the id
				if ( parseInt(buildData[ctr].gid) == gid && parseInt(buildData[ctr].level) < buildMaxLevel ) {
					idToUse = ctr;
					level = parseInt(buildData[ctr].level) + 1;
					break;
				}
				// flag empty building site for use when gid is not found
				if ( parseInt(buildData[ctr].gid) == 0 && emptyId == 0 ) {
					emptyId = ctr;
				}
			}
		}

		var newTaskStr = "";
		if ( idToUse == 0 && emptyId == 0 )
			return false; // cannot add new building/upgrade task as gid specified is at maxlevel and there are no empty building sites for new build.

		if ( idToUse != 0 && lvl != null && parseInt(lvl) > level ) { // add upgrade task to the lvl specified
			newTaskStr = "0_" + idToUse.toString() + "_" + lvl.toString() + "_000000000_" + aLangAllBuildWithId[gid];
		}
		else if ( idToUse != 0 && lvl == null ) { // upgrade by 1 level, if lvl is not specified
			newTaskStr = "0_" + idToUse.toString() + "_" + level.toString() + "_000000000_" + aLangAllBuildWithId[gid];
		}
		else if ( emptyId != 0 ) { // add new build task with specified level
			if ( lvl != null )
				level = parseInt(lvl);
			newTaskStr = "1_" + emptyId.toString() + "_" + level.toString() + "_" + gid.toString() + "_000000000_" + aLangAllBuildWithId[gid];
		}
		else { // this should not happen
			return false;
		}

		//var newTaskStr = getBuildTaskStrFromDorf2(vi, gid, lvl);
		if ( newTaskStr != null ) { // add task only if specified gid is not already building or not at max level
			var taskString = GM_getValue(myacc() + "_" + vi + "_waitTask", "");
			if ( taskString.indexOf ( newTaskStr ) == -1 ) { // add task only if not already present
				var newTaskstring = newTaskStr + "|" + taskString;
				GM_setValue(myacc() + "_" + vi + "_waitTask", newTaskstring);
				var myRace = GM_getValue(myacc() + "_raceID");
				if ( myRace == null ) { // this should not happen
					throwLogicError ( "addBuildingTaskAtTop():: Error:: _raceID is not set!" );
				}
				switch (myRace) {
					case "0": // romans
						GM_deleteValue ( myacc() + "_" + vi + "_resRequiredForBldgUpgrade" );
						GM_setValue ( myacc() + "_" + vi + "_BuildingTaskExists", "1" );
						GM_deleteValue ( myacc() + "_" + vi + "_BuildingUpdataTime" );
						break;
					case "1": // non-roman races
					case "2":
						GM_deleteValue ( myacc() + "_" + vi + "_resRequired" );
						GM_setValue ( myacc() + "_" + vi + "_UpdataTaskExists", "1" );
						GM_deleteValue ( myacc() + "_" + vi + "_UpdataTime" );
						break;
				}
				//window.setTimeout ( function () {
							//reloadLoginWindow();
							//getTaskCookies();
							//calldoing1();
							//showTaskList();
				//		},
				//		Math.ceil ( Math.random() * 5*1000 + 1*1000 ) ); // random ( 5 sec ) + 1 sec
				return true;
			}
		}
		return false;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>addBuildingTaskAtTop():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// if lvl is null, gets the task string with the building id & the next upgrade level from dorf2 for the specified gid if it is not already building
// if lvl is not null, gets the task string with the building id and with the specified lvl from dorf2 for the specified gid
// returns task string for gid upgrade or new build
// return format for upgrade  : 0 _ id _ level _ 000000000 _       name
// return format for new build: 1 _ id _     1 _ 000000000 _ gid _ name
// for new build, if no new spot returns null
// if gid already building returns null
// if gid is at max level tries to create a new build of the same building at a new spot
// No more used
/*
function getBuildTaskStrFromDorf2(vil, gid, lvl){
	flag ( "getBuildTaskStrFromDorf2():: Started! vil: " + vil + ", gid: " + gid );
	var turl = myhost + "/dorf2.php?newdid=" + vil;
	var getsomeid = new XMLHttpRequest();
	getsomeid.open('GET', turl, false);
	getsomeid.onreadystatechange = callback;
	getsomeid.send(null);
	function callback(){
		if (getsomeid.readyState == 4) {
			if (getsomeid.status == 200) {
				TS_debug("getBuildTaskStrFromDorf2():: callback Started!");
				var aDoc = document//.implementation.createDocument("", "", null);
				var aElem = document.createElement('DIV');
				aElem.innerHTML = getsomeid.responseText;
				//aDoc.appendChild(aElem);
				if ( gatherStats(aElem.innerHTML) ) {
					// attempt reloading page, captcha ll be found there too and script will stop.
					window.location.replace(myhost + "/spieler.php");
					return false;
				}
				refreshPageInfo(aElem);
				

				if ( lvl == null ) { // do only if lvl is null
					// check if specified gid is currently building...
					var aValue = aDoc.evaluate('id("building_contract")/descendant::td', aElem, null, XPSnap, null); // check what is building
					for (var i = 0; i < aValue.snapshotLength; i++) {
						var thestring = aValue.snapshotItem(i).innerHTML;
						if ( thestring != null && thestring.indexOf(aLangAllBuildWithId[gid]) != -1 ) {
							return null; // specified gid is currently building hence return null
						}
					}
				}

				// find specified gid in dorf2.php
				var thebuild = aDoc.evaluate('id("map2")//area[contains(@title,"' + aLangAllBuildWithId[gid] + '")]', aElem, null, XPSnap, null);
				var retValue = null;
				if ( thebuild.snapshotLength > 0 ) { // gid found in dorf2
					var buildMaxLevel = parseInt(maxlevel[gid],10);
					for ( var ctr = 0 ; ctr < thebuild.snapshotLength ; ctr++ ) {
						var level = parseInt( thebuild.snapshotItem(ctr).title.match(/\b\d{1,}\b/)[0] );
						if ( level < buildMaxLevel ) {
							if ( lvl != null )
								level = lvl;
							var buildId = thebuild.singleNodeValue.href.match(/\bid=\d{1,}\b/)[0].split("id=")[1];
							retValue = "0_" + buildId + "_" + level.toString() + "_000000000_" + aLangAllBuildWithId[gid];
							break;
						}
					}
				}
				// if gid not found in dorf2 find available empty slot to create new building
				if ( thebuild.snapshotLength == 0 ) {
					var xpathEmptySpot = '//div[@id="village_map" and @class="d2_0"]/img[ (contains(@class,"iso")) ' +
						'and not (contains(@class,"d8")) and not (contains(@class,"d21")) and not (contains(@class,"d22")) ]';
					var emptySpot = aDoc.evaluate( xpathEmptySpot, aElem, null, XPFirst, null );
					if ( emptySpot.singleNodeValue == null ) // if no empty spot return null
						return null;
					var emptySpotId = emptySpot.singleNodeValue.className.match(/\bd\d{1,}\b/)[0].split("d")[1];
					lvl = ( lvl != null ) ? lvl : 1; 
					retValue = "1_" + emptySpotId + "_" + lvl.toString() + "_000000000_" + gid + "_" + aLangAllBuildWithId[gid];
				}
				return retValue;
			}
		}
	}
	return callback();
}*/

function getAutoResourceId(vi, bump) {
	try {
		flag ( "getAutoResourceId():: Started! vi: " + vi + ", bump: " + bump );

		if ( !bump ) {
			flag ( "getAutoResourceId():: Attempting to refresh auto-resource data!" );

			function callback() {};
			var turl = myhost + "/dorf1.php?newdid=" + vi;

			var httpReqObj = new XMLHttpRequest();
			httpReqObj.open('GET', turl, false);
			httpReqObj.onreadystatechange = callback;
			httpReqObj.send(null);

			function callback() {
				if (httpReqObj.readyState == 4) {
					if (httpReqObj.status == 200) {
						flag ( "getAutoResourceId():: CallBack Started!" );

						var aElem = document.createElement('DIV');
						aElem.innerHTML = httpReqObj.responseText;

						if ( gatherStats(aElem.innerHTML) ) {
							// attempt reloading page, captcha ll be found there too and script will stop.
							window.location.replace(myhost + "/spieler.php");
							return 60*60*1000;
						}

						refreshPageInfo(aElem); // refreshPageInfo() calls collectAutoResDataFromDorf1()
						//collectAutoResDataFromDorf1(vi, aElem); // hence this is not required here.
					}
				}
			}

			callback();
		}

		var corpremain = parseInt(GM_getValue(myacc() + "_" + vi + "_CorpRemain"));
		var minlevelid = parseInt(GM_getValue(myacc() + "_" + vi + "_minLevelId"));
		var minLevelIdLevel = parseInt(GM_getValue(myacc() + "_" + vi + "_minLevelIdLevel"));
		var minlevelcropid = parseInt(GM_getValue(myacc() + "_" + vi + "_minLevelCropId"));
		var minCropToMaintain = parseInt(GM_getValue(myacc() + "_minCropToMaintain", "20"));
		var nonCrop15CUpgradeLevel = parseInt(GM_getValue(myacc() + "_nonCrop15CUpgradeLevel", "7"));

		var returnId = -1;

		if (GM_getValue(myacc() + "_" + vi + "_ResourceRate")== "1:1:1:15") { // for 15c
			if (corpremain < minCropToMaintain) {
				flag ( "getAutoResourceId():: 15c villa, because of corpremain (" + corpremain + ") <  minCropToMaintain (" + minCropToMaintain
						+ ") upgrading crop, return id: " + minlevelcropid );
				returnId = minlevelcropid;
			}
			else {
				if ( minLevelIdLevel < nonCrop15CUpgradeLevel ) {
					flag ( "getAutoResourceId():: 15c villa, because of corpremain (" + corpremain + ") >= minCropToMaintain (" + minCropToMaintain
							+ ") & minLevelIdLevel (" + minLevelIdLevel + ") < nonCrop15CUpgradeLevel (" + nonCrop15CUpgradeLevel
							+ ") upgrading both crop & non-crop, return id: " + minlevelid );
					returnId = minlevelid;
				}
				else {
					flag ( "getAutoResourceId():: 15c villa, because of corpremain (" + corpremain + ") >= minCropToMaintain (" + minCropToMaintain
							+ ") & minLevelIdLevel (" + minLevelIdLevel + ") >= nonCrop15CUpgradeLevel (" + nonCrop15CUpgradeLevel
							+ ") upgrading only crop, return id: " + minlevelcropid );
					returnId = minlevelcropid;
				}

			}
		}
		else { // for other village kinds
			if (corpremain < minCropToMaintain) {
				flag ( "getAutoResourceId():: because of corpremain (" + corpremain + ") < minCropToMaintain (" + minCropToMaintain
						+ ") upgrading crop, return id is " + minlevelcropid );
				returnId = minlevelcropid;
			}
			else {
				flag( "getAutoResourceId():: because of corpremain (" + corpremain + ") >= minCropToMaintain (" + minCropToMaintain
						+ ") upgrading both crop & non-crop, return id is " + minlevelid );
				returnId = minlevelid;
			}
		}

		return returnId;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getAutoResourceId():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getResourceRate() {
	try {
		if (window.location.href.indexOf("dorf1") != -1) {
			var rate = new Array();
			for (i = 0; i < 4; i++) {
				var xpathResource = "";
				switch ( aTravianVersion ) {
					case "3.6":
						xpathResource = "id('rx')/area[starts-with(@title,\""+aLangAllBuildAltWithId[i]+"\")]";
						break;
					case "4.0":
						xpathResource = "id('rx')/area[starts-with(@alt,\""+aLangAllBuildAltWithId[i]+"\")]";
						break;
					default:
						throwLogicError ( "getResourceRate():: Travian Version not set!!" );
				}
				var result = document.evaluate( xpathResource, document, null, XPSnap, null );
				var rrate = result.snapshotLength;
				if (rrate == 0) {
					flag ( "getResourceRate():: Could not get resource rate! Translation required for i: " + i + ", " + aLangAllBuildAltWithId[i] );
					printErrorMSG ( "<b>ERROR:: Could not get resource rate! Translation required for " + aLangAllBuildAltWithId[i] +
							" from tool-tip on dorf1 or dorf2.</b>", 1 );
				}
				var newlength = rate.push(rrate);
			}
			GM_setValue(herere()+ "_ResourceRate", rate.join(":"));
			GM_deleteValue(myacc() + "_undefined_ResourceRate");
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getResourceRate():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function deleteTaskFromCookie(Vii, Taa, newTa) {
	//flag ( "deleteTaskFromCookie() Started!" );
	//TS_debug("come into deleteTaskFromCookie(Vii, Taa)");
	var taskcook = GM_getValue(myacc() + "_" + Vii + "_waitTask");
	var tasks = taskcook.split("|");
	var taaa = Taa.join("_");
	for (x in tasks) {
		if (tasks[x] == taaa) {
			if (newTa) {
				newTa=newTa.join("_");
				tasks.splice(x, 1, newTa);
				break; // only the 1st matching task is deleted
			}
			else{
				tasks.splice(x, 1);
				break; // only the 1st matching task is deleted
			}
		}
	}
	if (tasks.length > 0) {
		var newCook = tasks.join("|");
		GM_setValue(myacc() + "_" + Vii + "_waitTask", newCook);
		//TS_debug("ok,i delete a task");
		showTaskList();
	}
	else {
		//TS_debug("ok I delete the whole cookie");
		GM_deleteValue(myacc() + "_" + Vii + "_waitTask");
		GM_deleteValue(myacc() + "_" + Vii + "_resRequiredForResUpgrade");
		GM_deleteValue(myacc() + "_" + Vii + "_resRequiredForBldgUpgrade");
		GM_deleteValue(myacc() + "_" + Vii + "_resRequired");
		GM_deleteValue(myacc() + "_" + Vii + "_ResourceUpdataTime");
		GM_deleteValue(myacc() + "_" + Vii + "_BuildingUpdataTime");
		GM_deleteValue(myacc() + "_" + Vii + "_UpdataTime");
		GM_deleteValue(myacc() + "_" + Vii + "_autoTransTime");
		GM_deleteValue(myacc() + "_" + Vii + "_TraningTime");
		GM_deleteValue(myacc() + "_" + Vii + "_autoTransTo");
		GM_deleteValue(myacc() + "_" + Vii + "_autoResource");
		GM_deleteValue(myacc() + "_" + Vii + "_demolishTime");
		showTaskList();
	}
}

function moveTask(vi, i, updown){
	return function(){
		maintainFoldStatus();

		updown=parseInt(updown);
		i=parseInt(i);

		var ubC = GM_getValue(myacc() + "_" + vi + "_waitTask");
		var arrUbC = ubC.split("|");

		var taskArr = arrUbC[i].split("_");
		if ( taskArr[0] == "0" || taskArr[0] == "1" ) {
			var myRace = GM_getValue ( myacc() + "_raceID", "0" );
			if ( myRace == "0" ) { // romans
				if ( taskArr[1] <= 18 || taskArr[1] == 50 ) {
					GM_deleteValue(herere() + "_resRequiredForResUpgrade");
					GM_deleteValue(herere() + "_ResourceUpdataTime");
				}
				else {
					GM_deleteValue(herere() + "_resRequiredForBldgUpgrade");
					GM_deleteValue(herere() + "_BuildingUpdataTime");
				}
			}
			else { // non-romans
				GM_deleteValue(herere() + "_resRequired");
				GM_deleteValue(herere() + "_UpdataTime");
			}
		}

		var tmpUb = arrUbC[i + updown];
		arrUbC[i + updown] = arrUbC[i];
		arrUbC[i] = tmpUb;
		ubC = arrUbC.join("|");
		GM_setValue(myacc() + "_" + vi + "_waitTask", ubC);
		showTaskList();

		clearCropWarehouseGranaryError ( vi );

		return false;
	}
}

function calldoing1() {
	taskdoing = "1";
	GM_setValue(myacc() + "_doing", "1");
	var taskListCapAnchor = $("toggleTaskLista");
	if ( taskListCapAnchor != null )
		taskListCapAnchor.style.backgroundColor = "";
	var testAlarmWrapper = $("test_alarm_wrapper");
	if ( testAlarmWrapper != null ) {
		testAlarmWrapper.style.backgroundColor = "HoneyDew";
	}
	//TS_debug("set doing to 1");
}

function calldoing0(){
	taskdoing = "0";
	GM_setValue(myacc() + "_doing", "0");
	var taskListCapAnchor = $("toggleTaskLista");
	if ( taskListCapAnchor != null )
		taskListCapAnchor.style.backgroundColor = "LightCoral";
	var testAlarmWrapper = $("test_alarm_wrapper");
	if ( testAlarmWrapper != null ) {
		testAlarmWrapper.style.backgroundColor = "LightCoral";
	}
	//TS_debug("set doing to 0");
}

function promptFreshInterval(){
	var curentSetup = GM_getValue ( myacc() + "_loginWindowFreshInterval", "60" );
	var newSetup = prompt(aLangGreaseMenuItemText[32],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_loginWindowFreshInterval", newSetup.replace(/\s/g,"") );
	// pagefreshInterval (mins) is used for when to relad page, randomized by 0.5 times.
	var loginWindowFreshIntrv = GM_getValue ( myacc() + "_loginWindowFreshInterval", "60");
  	pagefreshInterval = loginWindowFreshIntrv * 60*1000 + Math.ceil ( Math.random() * loginWindowFreshIntrv*60*1000 - loginWindowFreshIntrv*60*1000/2.0 );
}

function promptTranInterval(){
	var curentSetup = GM_getValue ( myacc() + "_transInterval", "30" );
	var newSetup = prompt(aLangGreaseMenuItemText[2],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_transInterval", newSetup.replace(/\s/g,"") );
	// transsInterval (mins) is used for by Auto Transport (Construction Support / Resource Concentration).
  	transsInterval = GM_getValue ( myacc() + "_transInterval", "30") * 60*1000;
}

function promptScriptInterval(){
	var curentSetup = GM_getValue ( myacc() + "_scriptRunInterval", "20" );
	var newSetup = prompt(aLangGreaseMenuItemText[1],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_scriptRunInterval", newSetup.replace(/\s/g,"") );
	// scriptRunInterval (seconds) is used for when to run this (auto-task) script.
  	scriptRunInterval = GM_getValue ( myacc() + "_scriptRunInterval", "20" ) * 1000;
}

function promptScriptAutoLogin(){
	var curentSetup = GM_getValue ( currentServer() + "_scriptAutoLogin", "1" );
	var newSetup = prompt(aLangGreaseMenuItemText[4],curentSetup);
	if ( newSetup != null )
		GM_setValue ( currentServer() + "_scriptAutoLogin", newSetup.replace(/\s/g,"") );
	// autologin (true / false) is used for whether to perform auto-login if login page is detected.
  	autologin = GM_getValue ( currentServer() + "_scriptAutoLogin", "1" ) == "1" ? true : false;
}

function promptScriptSleepTimes(){
	var curentSetup = GM_getValue ( myacc() + "_scriptSleepTimes", "" );
	var newSetup = prompt(aLangGreaseMenuItemText[8],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_scriptSleepTimes", newSetup.replace(/\s/g,"") );
}

function promptAntiFarmEnable() {
	var curentSetup = GM_getValue ( myacc() + "_antiFarmEnabled", "1" );
	var newSetup = prompt(aLangGreaseMenuItemText[10],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_antiFarmEnabled", newSetup.replace(/\s/g,"") );
}

function promptAntiFarmCoords() {
	var curentSetup = GM_getValue ( myacc() + "_antiFarmVillage", "" );
	var newSetup = prompt(aLangGreaseMenuItemText[12],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_antiFarmVillage", newSetup.replace(/\s/g,"") );
}

function promptAttackDetectInterval() {
	var curentSetup = GM_getValue ( myacc() + "_attackDetectInterval", "60" );
	var newSetup = prompt(aLangGreaseMenuItemText[14],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_attackDetectInterval", newSetup.replace(/\s/g,"") );
}

function promptTroopsUpdateInterval() {
	var curentSetup = GM_getValue ( myacc() + "_troopsUpdateInterval", "60" );
	var newSetup = prompt(aLangGreaseMenuItemText[16],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_troopsUpdateInterval", newSetup.replace(/\s/g,"") );
}

function promptMapInfoReCalculateInterval() {
	var curentSetup = GM_getValue ( myacc() + "_mapInfoReCalculateInterval", "5000" );
	var newSetup = prompt(aLangGreaseMenuItemText[18],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_mapInfoReCalculateInterval", newSetup.replace(/\s/g,"") );
}

function promptMapEnhancementsEnabled() {
	var curentSetup = GM_getValue ( myacc() + "_mapEnhancementsEnabled", "1" );
	var newSetup = prompt(aLangGreaseMenuItemText[20],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_mapEnhancementsEnabled", newSetup.replace(/\s/g,"") );
}

function promptCaptchaSoundEnabled() {
	var curentSetup = GM_getValue ( currentServer() + "_enableCaptchaSound", "1" );
	var newSetup = prompt(aLangGreaseMenuItemText[22],curentSetup);
	if ( newSetup != null )
		GM_setValue ( currentServer() + "_enableCaptchaSound", newSetup.replace(/\s/g,"") );
}

function promptCaptchaSoundUrl() {
	var curentSetup = GM_getValue ( currentServer() + "_soundUrl", defaultSoundUlrs[1].url );
	var newSetup = prompt(aLangGreaseMenuItemText[24],curentSetup);
	if ( newSetup != null ) {
		for ( var iCtr = 0; iCtr < defaultSoundUlrs.length; iCtr++ ) {
			if ( newSetup.match ( defaultSoundUlrs[iCtr].key ) != null )
				newSetup = defaultSoundUlrs[iCtr].url;
		}
		newSetup = newSetup.replace(/\s/g,"");
		GM_setValue ( currentServer() + "_soundUrl", newSetup );
	}
}

function promptCaptchaSoundLoop() {
	var curentSetup = GM_getValue ( currentServer() + "_soundLoop", "0" );
	var newSetup = prompt(aLangGreaseMenuItemText[26],curentSetup);
	if ( newSetup != null ) {
		newSetup = newSetup.replace(/\s/g,"");
		if ( newSetup != "1" || newSetup != "0" )
			newSetup == "0";
		GM_setValue ( currentServer() + "_soundLoop", newSetup );
	}
}

function promptStrictAttackInterval() {
	var curentSetup = GM_getValue ( myacc() + "_attackStrictOrder", "0" );
	var newSetup = prompt(aLangGreaseMenuItemText[28],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_attackStrictOrder", newSetup.replace(/\s/g,"") );
}

function promptCustomAlarm() {
	var curentSetup = GM_getValue ( myacc() + "_customAlarmTime", "" );
	if ( curentSetup == "" )
		curentSetup = new Date().toString();
	var newSetup = prompt(aLangGreaseMenuItemText[30],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_customAlarmTime", newSetup );
}

function promptResetAllBubblePositions() {
	GM_setValue ( myacc() + "_option", "" );
}

function promptIncomingAttackAlarmTime() {
	var curentSetup = GM_getValue ( myacc() + "_incomingAlarmTime", "15" );
	var newSetup = prompt(aLangGreaseMenuItemText[36],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_incomingAlarmTime", newSetup.replace(/\s/g,"") );
}

function promptCheckMail() {
	var curentSetup = GM_getValue ( myacc() + "_checkMail", "1" );
	var newSetup = prompt(aLangGreaseMenuItemText[38],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_checkMail", newSetup.replace(/\s/g,"") );
}

function promptBuildDelayTime() {
	var curentSetup = GM_getValue ( myacc() + "_buildTrainDelayTime", "60" );
	var newSetup = prompt(aLangGreaseMenuItemText[40],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_buildTrainDelayTime", newSetup.replace(/\s/g,"") );
}

function promptConvertAnchors() {
	var curentSetup = GM_getValue ( myacc() + "_convertAnchors", "0" );
	var newSetup = prompt(aLangGreaseMenuItemText[43],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_convertAnchors", newSetup.replace(/\s/g,"") );
}

function promptUpdateStatsOnUserActivity() {
	var curentSetup = GM_getValue ( myacc() + "_updateStatsOnUserActivity", "0" );
	var newSetup = prompt(aLangGreaseMenuItemText[45],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_updateStatsOnUserActivity", newSetup.replace(/\s/g,"") );
}

function promptCustomAlarmText() {
	var curentSetup = GM_getValue ( myacc() + "_customAlarmText", "" );
	var newSetup = prompt(aLangGreaseMenuItemText[47],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_customAlarmText", newSetup );
}

/*function promptOverFlowCheck() {
	var curentSetup = GM_getValue ( myacc() + "_overFlowCheck", "1" );
	var newSetup = prompt(aLangGreaseMenuItemText[49],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_overFlowCheck", newSetup.replace(/\s/g,"") );
}*/

function promptBuildLogicToUse() {
	var curentSetup = GM_getValue ( myacc() + "_buildLogic", "0" );
	var newSetup = prompt(aLangGreaseMenuItemText[51],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_buildLogic", newSetup.replace(/\s/g,"") );
}

function promptDebugMode() {
	var curentSetup = GM_getValue ( currentServer() + "_debugMode", "0" );
	var newSetup = prompt(aLangGreaseMenuItemText[53],curentSetup);
	if ( newSetup != null )
		GM_setValue ( currentServer() + "_debugMode", newSetup.replace(/\s/g,"") );
}

function promptAlarmDuration() {
	var curentSetup = GM_getValue ( myacc() + "_alarmDuration", "1" );
	var newSetup = prompt(aLangGreaseMenuItemText[55],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_alarmDuration", newSetup.replace(/\s/g,"") );
}

function promptPlusDoubleBuild() {
	var curentSetup = GM_getValue ( myacc() + "_plusDoubleBuildEnabled", "0" );
	var newSetup = prompt(aLangGreaseMenuItemText[57],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_plusDoubleBuildEnabled", newSetup.replace(/\s/g,"") );
}

function promptHalfRaidEnabled() {
	var curentSetup = GM_getValue ( myacc() + "_halfRaidEnabled", "0" );
	var newSetup = prompt(aLangGreaseMenuItemText[59],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_halfRaidEnabled", newSetup.replace(/\s/g,"") );
}

function promptAutoResMinCropToMaintain() {
	var curentSetup = GM_getValue ( myacc() + "_minCropToMaintain", "20" );
	var newSetup = prompt(aLangGreaseMenuItemText[61],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_minCropToMaintain", newSetup.replace(/\s/g,"") );
}

function promptAutoResNonCrop15CUpgradeLevel() {
	var curentSetup = GM_getValue ( myacc() + "_nonCrop15CUpgradeLevel", "7" );
	var newSetup = prompt(aLangGreaseMenuItemText[63],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_nonCrop15CUpgradeLevel", newSetup.replace(/\s/g,"") );
}

function promptEnableHeroAdventure() {
	var curentSetup = GM_getValue ( myacc() + "_heroAdventureEnabled", "1" );
	var newSetup = prompt(aLangGreaseMenuItemText[65],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_heroAdventureEnabled", newSetup.replace(/\s/g,"") );
}

function promptHeroMinHealthForAdventure() {
	var curentSetup = GM_getValue ( myacc() + "_heroMinHealth", "50" );
	var newSetup = prompt(aLangGreaseMenuItemText[67],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_heroMinHealth", newSetup.replace(/\s/g,"") );
}

function promptServerTimeZoneCorrection() {
	var curentSetup = GM_getValue ( myacc() + "_serverTimeZoneCorrection", "" );
	var newSetup = prompt(aLangGreaseMenuItemText[69],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_serverTimeZoneCorrection", newSetup.replace(/\s/g,"") );
}

function promptMinTroopsCountCheck() {
	var curentSetup = GM_getValue ( myacc() + "_minTroopsCountCheck", "1" );
	var newSetup = prompt(aLangGreaseMenuItemText[71],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_minTroopsCountCheck", newSetup.replace(/\s/g,"") );
}

function promptAntiFarmTroopsToSendOut() {
	var curentSetup = GM_getValue ( myacc() + "_troopsToSendOut", "1,1,1,1,1,1,1,1,1,1,1" );
	var newSetup = prompt(aLangGreaseMenuItemText[73],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_troopsToSendOut", newSetup.replace(/\s/g,"") );
}

function promptMinResourcesToSendByCustomTransport() {
	var curentSetup = GM_getValue ( myacc() + "_customTransferMinResourceToSend", "100" );
	var newSetup = prompt(aLangGreaseMenuItemText[75],curentSetup);
	if ( newSetup != null )
		GM_setValue ( myacc() + "_customTransferMinResourceToSend", newSetup.replace(/\s/g,"") );
}

function promptForAllowedServerTimeDiff() {
	var curentSetup = GM_getValue ( currentServer() + "_allowedServerTimeDiff", "20" );
	var newSetup = prompt(aLangGreaseMenuItemText[77],curentSetup);
	if ( newSetup != null )
		GM_setValue ( currentServer() + "_allowedServerTimeDiff", newSetup.replace(/\s/g,"") );
}

function promptMsgListMaxSize() {
	var curentSetup = GM_getValue ( currentServer() + "_print_Msg_List_Max_Size", "1000" );
	var newSetup = prompt(aLangGreaseMenuItemText[79],curentSetup);
	if ( newSetup != null ) {
		newSetup = parseInt ( newSetup.replace(/\s/g,"") );
		if ( newSetup != -1 && newSetup < 100 )
			newSetup = "100";
		GM_setValue ( currentServer() + "_print_Msg_List_Max_Size", newSetup+"" );
	}
}

function promptErrorMsgListMaxSize() {
	var curentSetup = GM_getValue ( currentServer() + "_print_Error_Msg_List_Max_Size", "1000" );
	var newSetup = prompt(aLangGreaseMenuItemText[81],curentSetup);
	if ( newSetup != null ) {
		newSetup = parseInt ( newSetup.replace(/\s/g,"") );
		if ( newSetup != -1 && newSetup < 100 )
			newSetup = "100";
		GM_setValue ( currentServer() + "_print_Error_Msg_List_Max_Size", newSetup+"" );
	}
}

var ccclock = 0;
//var checkForUserActivity = 0;
//var onActivitySkipIntervals = 3;
//var onActivitySkipTime = scriptRunInterval * onActivitySkipIntervals;
var scriptRunIntervalRand = 0;

/*function promptScriptSkipInterval(){
	var curentSetup = GM_getValue(myacc() + "_skipIntervalsOnUserActivity", "3");
	var newSetup = prompt(aLangGreaseMenuItemText[6],curentSetup);
	if ( newSetup != null )
		GM_setValue(myacc() + "_skipIntervalsOnUserActivity", newSetup);
	// autologin (true / false) is used for whether to perform auto-login if login page is detected.
  	onActivitySkipIntervals = Number(GM_getValue(myacc() + "_skipIntervalsOnUserActivity", "3"));
	onActivitySkipTime = scriptRunInterval * onActivitySkipIntervals;
}*/

// setting greasemonkey menus for user input...
function setupGreaseMonkeyMenu() {
	GM_registerMenuCommand(aLangGreaseMenuItemText[9], promptAntiFarmEnable); // get anti-farm enable disable from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[11], promptAntiFarmCoords );  // get anti-farm coordinates from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[72], promptAntiFarmTroopsToSendOut );  // get anti-farm troops to send out from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[76], promptForAllowedServerTimeDiff );  // get allowed server time diff from user by greasemonkey menu

	GM_registerMenuCommand(aLangGreaseMenuItemText[13], promptAttackDetectInterval); // get attack detect interval from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[15], promptTroopsUpdateInterval );  // get troops update interval from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[27], promptStrictAttackInterval ); // get strict attack order enabled info from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[58], promptHalfRaidEnabled ); // get half raid from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[70], promptMinTroopsCountCheck ); // get minimum troops count check from user by greasemonkey menu

	if ( aTravianVersion == "4.0" ) {
		GM_registerMenuCommand(aLangGreaseMenuItemText[64], promptEnableHeroAdventure ); // get hero adventure enabled from user by greasemonkey menu
		GM_registerMenuCommand(aLangGreaseMenuItemText[66], promptHeroMinHealthForAdventure ); // get hero min health for adventure from user by greasemonkey menu
	}

	if ( aTravianVersion == "3.6" ) {	
		GM_registerMenuCommand(aLangGreaseMenuItemText[17], promptMapInfoReCalculateInterval ); // get maps info recalculate from user by greasemonkey menu
		GM_registerMenuCommand(aLangGreaseMenuItemText[19], promptMapEnhancementsEnabled ); // get maps enhancements enabled info from user by greasemonkey menu
	}
	GM_registerMenuCommand(aLangGreaseMenuItemText[42], promptConvertAnchors ); // get convert anchors from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[41], getLangTranslationsFromUser ); // get language translations from user by greasemonkey menu
	
	GM_registerMenuCommand(aLangGreaseMenuItemText[21], promptCaptchaSoundEnabled ); // get captcha sound enabled info from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[23], promptCaptchaSoundUrl ); // get captcha sound url from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[25], promptCaptchaSoundLoop ); // get captcha sound loop enabled info from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[29], promptCustomAlarm ); // get custom alarm time from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[46], promptCustomAlarmText ); // get custom alarm text from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[35], promptIncomingAttackAlarmTime ); // get incoming alarm time from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[54], promptAlarmDuration ); // get alarm duration from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[37], promptCheckMail ); // get check incoming mail from user by greasemonkey menu
	
	GM_registerMenuCommand(aLangGreaseMenuItemText[39], promptBuildDelayTime ); // get build delay time from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[44], promptUpdateStatsOnUserActivity ); // get update stats on user activy from user by greasemonkey menu
	//GM_registerMenuCommand(aLangGreaseMenuItemText[48], promptOverFlowCheck ); // get over flow check from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[50], promptBuildLogicToUse ); // get build logic to use from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[56], promptPlusDoubleBuild ); // get plus double build from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[60], promptAutoResMinCropToMaintain ); // get auto res min crop to maintain from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[62], promptAutoResNonCrop15CUpgradeLevel ); // get auto res non-crop 15C upgrade level from user by greasemonkey menu
	
	GM_registerMenuCommand(aLangGreaseMenuItemText[52], promptDebugMode ); // get debug mode from user by greasemonkey menu
	
	GM_registerMenuCommand(aLangGreaseMenuItemText[0], promptScriptInterval); // get interval for script run from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[31], promptFreshInterval); // get interval time of login window reload from user by greasemonkey menu

	GM_registerMenuCommand(aLangGreaseMenuItemText[33], promptTranInterval); // get interval of resource concentration from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[74], promptMinResourcesToSendByCustomTransport); // get min res to transfer via custom-transport from user by greasemonkey menu

	GM_registerMenuCommand(aLangGreaseMenuItemText[3], promptScriptAutoLogin); // get whether to auto-login from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[7], promptScriptSleepTimes); // get sleep times from user by greasemonkey menu
	//GM_registerMenuCommand(aLangGreaseMenuItemText[5], promptScriptSkipInterval );  // get whether to auto-login from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[34], promptResetAllBubblePositions ); // reset all bubble positions on user request by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[78], promptMsgListMaxSize ); // get server time zone correction from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[80], promptErrorMsgListMaxSize ); // get server time zone correction from user by greasemonkey menu
	GM_registerMenuCommand(aLangGreaseMenuItemText[68], promptServerTimeZoneCorrection ); // get server time zone correction from user by greasemonkey menu
}

var taskIterationCtr = 0;

var defaultDocumentTitle = document.title;
//var defaultFooterText = document.getElementById("footer").innerHTML;
var defaultFooterText = "";
function printFooterMsg() {
	try {
		if ( defaultFooterText == "" )
			defaultFooterText = document.getElementById("footer").innerHTML;

		//onActivitySkipIntervals = Number(GM_getValue(myacc() + "_skipIntervalsOnUserActivity", "3"));
		//onActivitySkipTime = scriptRunInterval * onActivitySkipIntervals;

		var footerMsg = "Auto Task Script runs every " + scriptRunInterval + 
			" milli-seconds randomized by +/- " + Math.ceil ( scriptRunInterval / 2.0 ) + " milli-seconds. " +
			//"In case of any user activity, the script will not run for " + onActivitySkipTime + 
			//" milli-seconds and the page reload timer will be reset.<br/>" +
			//"checkForUserActivity: " + checkForUserActivity  + "<br/>" +
			//"ccclock: " + ccclock + 
			"<br/>Time to Reload Login Window: " + Number(pagefreshInterval-ccclock) + " ms [ " + Math.round((pagefreshInterval-ccclock)*100/(1000*60))/100 +
			" mins @ " + new Date( new Date().getTime() + (pagefreshInterval-ccclock) ) + " ]" +
			"<br/>Last Run Time: " + new Date().toString() + ", taskIterationCtr : " + taskIterationCtr;
			//"taskdoing: " + taskdoing;

		var myRace = GM_getValue ( myacc() + "_raceID", "0" );
		for ( var ctr = 0 ; ctr < getAllVillageNewdids().length ; ctr++ ) {
			var nowt = new Date().getTime();
			var villName = getvillagefromdid(getAllVillageNewdids()[ctr]);
			if ( myRace == "0" ) { // for romans
				var buildSlotResFreeTime = parseInt ( GM_getValue(myacc() + "_" + getAllVillageNewdids()[ctr] + "_buildSlotResourceFreeTime", "0") );
				var resT = parseInt ( GM_getValue(myacc() + "_" + getAllVillageNewdids()[ctr] + "_ResourceUpdataTime", "0") );
				footerMsg += "<br/>Village: " + villName + " (" + getAllVillageNewdids()[ctr] + ") <br/>";
				if ( GM_getValue(myacc() + "_" + getAllVillageNewdids()[ctr] + "_ResourceTaskExists", "0") == "1" && buildSlotResFreeTime > nowt )
					footerMsg += "&nbsp; next resource build attempt in: " + (buildSlotResFreeTime-nowt) + " ms [ "
						+ Math.round((buildSlotResFreeTime-nowt)*100/(1000*60))/100 + " mins @ "
						+ new Date(buildSlotResFreeTime) + " ]<br/>";
				else if ( resT != 0  && GM_getValue(myacc() + "_" + getAllVillageNewdids()[ctr] + "_ResourceTaskExists", "0") == "1" )
					footerMsg += "&nbsp; next resource build attempt in: " + (resT-nowt) + " ms [ "
						+ Math.round((resT-nowt)*100/(1000*60))/100 + " mins @ " + new Date(resT) + " ]<br/>";
				else
					footerMsg += "&nbsp; next resource build attempt in: No resource task!<br/>";

				var buildSlotBldFreeTime = parseInt ( GM_getValue(myacc() + "_" + getAllVillageNewdids()[ctr] + "_buildSlotBuildingFreeTime", "0") );
				var buiT = parseInt ( GM_getValue(myacc() + "_" + getAllVillageNewdids()[ctr] + "_BuildingUpdataTime", "0") );
				if ( GM_getValue(myacc() + "_" + getAllVillageNewdids()[ctr] + "_BuildingTaskExists", "0") == "1" && buildSlotBldFreeTime > nowt )
					footerMsg += "&nbsp; next building build attempt in: " + (buildSlotBldFreeTime-nowt) + " ms [ "
						+ Math.round((buildSlotBldFreeTime-nowt)*100/(1000*60))/100 + " mins @ "
						+ new Date(buildSlotBldFreeTime) + " ]<br/>";
				else if ( buiT != 0 && GM_getValue(myacc() + "_" + getAllVillageNewdids()[ctr] + "_BuildingTaskExists", "0") == "1" )
					footerMsg += "&nbsp; next building build attempt in: " + (buiT-nowt) + " ms [ "
						+ Math.round((buiT-nowt)*100/(1000*60))/100 + " mins @ " + new Date(buiT) + " ]<br/>";
				else
					footerMsg += "&nbsp; next building build attempt in: No building task!<br/>";
			}
			else { // for other races
				var buildSlotFreeTime = parseInt ( GM_getValue(myacc() + "_" + getAllVillageNewdids()[ctr] + "_buildSlotFreeTime", "0") );
				var upT = parseInt ( GM_getValue(myacc() + "_" + getAllVillageNewdids()[ctr] + "_UpdataTime", "0") );
				footerMsg += "<br/>" + villName + " (" + getAllVillageNewdids()[ctr] + ") <br/>";
				if ( GM_getValue(myacc() + "_" + getAllVillageNewdids()[ctr] + "_UpdataTaskExists", "0") == "1" && buildSlotFreeTime > nowt )
					footerMsg += "&nbsp; next build attempt in: " + (buildSlotFreeTime-nowt) + " ms [ "
						+ Math.round((buildSlotFreeTime-nowt)*100/(1000*60))/100 + " mins @ "
						+ new Date(buildSlotFreeTime) + " ]<br/>";
				else if ( upT != 0 && GM_getValue(myacc() + "_" + getAllVillageNewdids()[ctr] + "_UpdataTaskExists", "0") == "1" )
					footerMsg += "&nbsp; next build attempt in: " + (upT-nowt) + " ms [ "
						+ Math.round((upT-nowt)*100/(1000*60))/100 + " mins @ " + new Date(upT) + " ]<br/>";
				else
					footerMsg += "&nbsp; next build attempt in: No build task!<br/>";
			}
			var inAtkT = parseInt ( GM_getValue(myacc() + "_" + getAllVillageNewdids()[ctr] + "_incomingAttackCheckElapseTime", "0") );
			var trpCkT = parseInt ( GM_getValue(myacc() + "_" + getAllVillageNewdids()[ctr] + "_troopsCheckElapseTime", "0") );
			footerMsg += "&nbsp; next incoming attack check in: " + (inAtkT-nowt) + " ms [ "
				+ Math.round((inAtkT-nowt)*100/(1000*60))/100 + " mins @ " + new Date(inAtkT) + " ]<br/>";
			footerMsg += "&nbsp; next troops count check in: " + (trpCkT-nowt) + " ms [ "
				+ Math.round((trpCkT-nowt)*100/(1000*60))/100 + " mins @ " + new Date(trpCkT) + " ]<br/>";
		}

		var footer = $("footer");
		var autoTaskFooterWrapper = $("auto_task_footer_wrapper");
		if ( footer && autoTaskFooterWrapper == null ){
			var divElem = document.createElement("div");
			divElem.id = "auto_task_footer_wrapper"
			divElem.innerHTML = footerMsg;
			divElem.setAttribute("style","text-align: left;");
			switch ( aTravianVersion ) {
				case "3.6": footer.innerHTML = ""; footer.insertBefore(divElem,footer.lastChild); break;
				case "4.0": footer.parentNode.insertBefore(divElem,footer.lastChild.nextSibling); break;
				default:
					throwLogicError ( "printFooterMsg():: Travian Version not set!!" );
			}
		}
		else {
			autoTaskFooterWrapper.innerHTML = footerMsg;
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>printFooterMsg():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function cleartime() {
	try {
		//ccclock = 0;
		//Delay a maximum of two minutes on user activity if page refresh is within the next two minutes
		if ( ccclock > (Number(pagefreshInterval) - 2*60*1000)) {
			ccclock = (Number(pagefreshInterval) - 2*60*1000);

			//onActivitySkipIntervals = Number(GM_getValue(myacc() + "_skipIntervalsOnUserActivity", "3"));
			//onActivitySkipTime = scriptRunInterval * onActivitySkipIntervals;
			//checkForUserActivity = - onActivitySkipTime;
			//var now = new Date();
			//nowmillse = now.getTime();
		    	//GM_setValue(myacc() + "_lastUsrActTime", nowmillse.toString());
			GM_setValue( myacc() + "_Timer_ccclock", ccclock );
			//GM_setValue( myacc() + "_Timer_checkForUserActivity", checkForUserActivity );
			printFooterMsg();
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>cleartime():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

var doEachTimeDoTimer = -1;
var keepScriptRunningTimer = -1;

function startIteration() {
	try {
		// scriptRunInterval +/- random (scriptRunInterval/2)
		scriptRunIntervalRand = scriptRunInterval + Math.ceil ( Math.random() * scriptRunInterval - scriptRunInterval/2.0);
		doEachTimeDoTimer = window.setTimeout ( doEachTimeDo, scriptRunIntervalRand );
		keepScriptRunningTimer = window.setInterval ( keepScriptRunning, scriptRunIntervalRand*3 );
		GM_setValue( myacc() + "_Timer_ccclock", ccclock );
		//GM_setValue( myacc() + "_Timer_checkForUserActivity", checkForUserActivity );
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startIteration():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

var doEachTimeCounter = 0;
var lastDoEachTimeTimer = -1;
function keepScriptRunning() {
	if ( lastDoEachTimeTimer != doEachTimeDoTimer ) {
		lastDoEachTimeTimer = doEachTimeDoTimer;
		doEachTimeCounter = 0;
	}
	else {
		doEachTimeCounter++;
		if ( doEachTimeCounter > 2 ) { // approx 2 mins when script run interval is 20 secs
			// scriptRunInterval +/- random (scriptRunInterval/2)
			scriptRunIntervalRand = scriptRunInterval + Math.ceil ( Math.random() * scriptRunInterval - scriptRunInterval/2.0);
			doEachTimeDoTimer = window.setTimeout ( doEachTimeDo, scriptRunIntervalRand );
		}
	}
}

function checkIsSleepTime() {
	try {
		//flag ( "checkIsSleepTime():: Started!" );
		var sleepTimes = GM_getValue(myacc() + "_scriptSleepTimes", "").split(";");
		var checkSleepTime = false;
		if ( GM_getValue(myacc() + "_scriptSleepTimes", "") != "" ) {
			for ( var ctr in sleepTimes ) {
				var nowt = new Date().getTime();
				var sltime = sleepTimes[ctr].split(",");
				if ( sltime.length != 2 ) {
					flag ("checkIsSleepTime():: Either start-time or end-time not specified in Sleep Times!");
					printErrorMSG("Incorrect value in Sleep Times!");
				}
				else {
					var slStartTime = sltime[0].split(":");
					var slEndTime = sltime[1].split(":");
					if ( slStartTime.length != 3 || slEndTime.length != 3 ) {
						flag ("checkIsSleepTime():: Incorrect value in Sleep Times!");
						printErrorMSG("Incorrect value in Sleep Times!");
					}
					var curDate = new Date();
					curDate.setHours(0,0,0,0);
					curDate = curDate.getTime(); // 12:00am
					var slStart = curDate + slStartTime[0]*60*60*1000 + slStartTime[1]*60*1000 + slStartTime[2]*1000;
					var slEnd   = curDate + slEndTime[0]*60*60*1000 + slEndTime[1]*60*1000 + slEndTime[2]*1000;
					if ( nowt > slStart && nowt < slEnd ) {
						if ( self.window.name == GM_getValue(currentServer() +'_loginWindow', "noLoginWindow") ) {
							slMid = ( slStart + slEnd ) / 2.0;
							slDiff1 = ( Math.abs( slStart - slEnd ) / 2.0 ) * 0.7;
							slDiff2 = ( Math.abs( slStart - slEnd ) / 2.0 ) * 0.3;
							slnowDiff = Math.abs( slMid - nowt );
							if ( slnowDiff <= slDiff1 ) { // if slnowDiff is less than slDiff1, then perfect sleep
								checkSleepTime = true;
							}
							else {
								// intensify sleep as nowt reach slMid, works like a straight line.
								var exprVal = Math.random() * Math.abs(slnowDiff - slDiff1) / slDiff2; 
								checkSleepTime = ( exprVal ) > 0.5 ? false : true;
							}
						}
						else {
							checkSleepTime = true;
						}
						break;
					}
				}
			}
		}
		if ( checkSleepTime )
			showInfoBubble("Sleeping -- " + sleepTimes[ctr]);
		return checkSleepTime;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>checkIsSleepTime():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

var evadingComplete	= true;			// if true then anti-farm has completed
var villagesToEvade	= new Array();		// list of villages (with incoming attack time) to evade
var villagesEvaded	= new Array();		// list of villages (with incoming attack time) already evaded
var attacksToCallBack	= new Array();		// list of attacks (with incoming attack time) to call back
var attacksCallBacked	= new Array();		// list of attacks (with incoming attack time) already call backed
var attacksCallBackCompleted = new Array();	// list of attacks (with incoming attack time) which have been successfully call backed
var attacksCallBackUrl	= new Array();		// list of attacks (with incoming attack time) and urls to use for call back

var villagesAlarmPlayed = new Array();		// list of villages (with incoming attack time) for which alarm has been played.
var villagesIncomingTroopsRefreshed = new Array(); // list of villages (with incoming attack time) for which incoming troops has been refresed

var incomingTroopsFreshTime = 10*60*1000; // default 10 mins, when to refresh incoming troops before an incoming attack

function checkIncomingAttackComing() {
	try {
		//flag ( "checkIncomingAttackComing():: Started!" );

		var antiFarmEnabled = GM_getValue(myacc() + "_antiFarmEnabled", "1" );

		// get anti-farm coordinates
		if ( antiFarmEnabled == "1" ) {
			var villasToAttack = GM_getValue(myacc() + "_antiFarmVillage", "" );
			if ( villasToAttack == "" ) {
				var msg = "Anti-Farm coordinates not set, Anti-Farm cannot work!";
				printErrorMSG("<b>" + msg + "</b>");
				var msg1= "Set Anti-Farm coordinates from greasemonkey menu and then restart Auto-Task!";
				printErrorMSG("<b>" + msg1 + "</b>");
				flag ( "evadeVillage():: " + msg );
			}
		}

		// initialize variables...
		var serverNowTime = new Date().getTime() - serverTimeDiff;
		villagesToEvade = new Array();

		// clean villagesAlarmPlayed so that it does not contain old elapsed village attack times.
		if ( villagesAlarmPlayed.length > 0 ) {
			var tempList = new Array();
			var villagesAlarmPlayedStr = villagesAlarmPlayed.join("|");
			for ( var v in getAllVillageNewdids() ) {
				var attackIncomingTimes = GM_getValue( myacc() + "_" + getAllVillageNewdids()[v] + "_incomingAttackTimes", "" );
				if ( attackIncomingTimes != "" ) {
					attackIncomingTimes = attackIncomingTimes.split("|");
					for ( var ctr in attackIncomingTimes ) {
						var attackTime = attackIncomingTimes[ctr];
						var attackWithTime = getAllVillageNewdids()[v]+"_"+attackTime;
						if ( villagesAlarmPlayedStr.indexOf(attackWithTime) != -1 ) {
							tempList.push(attackWithTime);
						}
					}
				}
			}
			villagesAlarmPlayed = tempList;
		}
		//flag ( "checkIncomingAttackComing():: villagesAlarmPlayed cleaned!" );

		// clean villagesIncomingTroopsRefreshed so that it does not contain old elapsed village attack times.
		if ( villagesIncomingTroopsRefreshed.length > 0 ) {
			var tempList = new Array();
			var alarmPlayedForRiskyIncomingTroopsStr = villagesIncomingTroopsRefreshed.join("|");
			for ( var v in getAllVillageNewdids() ) {
				var attackIncomingTimes = GM_getValue( myacc() + "_" + getAllVillageNewdids()[v] + "_incomingAttackTimes", "" );
				if ( attackIncomingTimes != "" ) {
					attackIncomingTimes = attackIncomingTimes.split("|");
					for ( var ctr in attackIncomingTimes ) {
						var attackTime = attackIncomingTimes[ctr];
						var attackWithTime = getAllVillageNewdids()[v]+"_"+attackTime;
						if ( alarmPlayedForRiskyIncomingTroopsStr.indexOf(attackWithTime) != -1 ) {
							tempList.push(attackWithTime);
						}
					}
				}
			}
			villagesIncomingTroopsRefreshed = tempList;
		}
		//flag ( "checkIncomingAttackComing():: villagesIncomingTroopsRefreshed cleaned!" );

		for ( var v in getAllVillageNewdids() ) {
			var attackIncomingTimes = GM_getValue( myacc() + "_" + getAllVillageNewdids()[v] + "_incomingAttackTimes", "" );
			var crannyCap = GM_getValue ( myacc() + "_" +getAllVillageNewdids()[v] + "_cranniesTotalCap" );
			crannyCap = crannyCap+"/"+crannyCap+"/"+crannyCap+"/"+crannyCap;
			var nowRes = GM_getValue ( myacc() + "_" + getAllVillageNewdids()[v] + "_ResourceNow", "" );
			if ( attackIncomingTimes != "" ) {
				attackIncomingTimes = attackIncomingTimes.split("|");
				for ( var ctr in attackIncomingTimes ) {
					var attackTime = parseInt(attackIncomingTimes[ctr]);
					var timeDiff = attackTime - serverNowTime;
					var attackWithTime = getAllVillageNewdids()[v] + "_" + attackTime;

					// evade attack check
					if ( antiFarmEnabled == "1" ) {
						if ( timeDiff < 45*1000 && // evade attack if less than 45 secs left.
								attackTime > serverNowTime ) {
							villagesToEvade.push(attackWithTime);
							if ( evadingComplete == true ) {
								var villDsip = getvillagefromdid(getAllVillageNewdids()[v]) + " (" + getAllVillageNewdids()[v] + "):";
								var secsLeft = Math.round(Number(timeDiff)/(1000)*100)/100;
								var msg1 = villDsip + " Incoming attack in " + secsLeft + " secs, attackWithTime: " + attackWithTime + ", at " 
									+ new Date(attackTime).toLocaleTimeString();
								var msg2 = villDsip + " Incoming attack in " + secsLeft + " secs at: " 
									+ new Date(attackTime).toLocaleTimeString();
								flag ( "checkIncomingAttackComing():: " + msg1 );
								printErrorMSG( "<b>" + msg2 + "</b>" );
							}
							break;
						}
					}

					// attack alarm check
					var alarmTime = GM_getValue ( myacc() + "_incomingAlarmTime", "15" );
					if ( alarmTime != "" && alarmTime != "0" && villagesAlarmPlayed.join("|").indexOf(attackWithTime) == -1 ) {
						if ( timeDiff < parseInt(alarmTime) * 60*1000 && // sound alarm if less than alarmTime.
								attackTime > serverNowTime ) {
							var marketSellRes = getResourcesForSale ( getAllVillageNewdids()[v] );
							//flag ( "checkIncomingAttackComing():: nowRes: " + nowRes );
							nowRes = nowRes.split("/");
							for ( var ctr = 0; ctr < marketSellRes.length ; ctr++ ) {
								nowRes[ctr] = parseInt(nowRes[ctr]) + parseInt(marketSellRes[ctr]);
							}
							nowRes = nowRes.join("/");
							//flag ( "checkIncomingAttackComing():: nowRes: " + nowRes );
							// play alarm if nowRes >= ( cranny capacity * 0.6 )
							if ( compareResources ( nowRes, crannyCap, 0.6 ) == false ) {
								villagesAlarmPlayed.push(attackWithTime); // alarm now being played, so push into villagesAlarmPlayed
								playSound("&nbsp;&nbsp;Incoming Attack in " + Math.round(Number(timeDiff)/(60*1000)*100)/100 +
										" mins on " + getvillagefromdid(getAllVillageNewdids()[v]) +
										" (" + getAllVillageNewdids()[v] + ") at " + new Date(attackTime).toLocaleTimeString() + "&nbsp;&nbsp;" );
								//flag ( "checkIncomingAttackComing():: alarm check succeeded, attackWithTime: " + attackWithTime );
								break;
							}
						}
					}

					// freshen incoming troops before incoming attack check
					if ( antiFarmEnabled == "1" ) {
						if ( villagesIncomingTroopsRefreshed.join("|").indexOf(attackWithTime) == -1 ) {
							if ( timeDiff < parseInt(incomingTroopsFreshTime) && // refresh incoming troops if less than incomingTroopsFreshTime
									attackTime > serverNowTime ) {
								// incoming troops scheduled for refresh, so push into villagesIncomingTroopsRefreshed
								villagesIncomingTroopsRefreshed.push(attackWithTime);
								var villDsip = getvillagefromdid(getAllVillageNewdids()[v]) + " (" + getAllVillageNewdids()[v] + "):";
								var minsLeft = Math.round(Number(timeDiff)/(60*1000)*100)/100;
								var msg2 = villDsip + " Incoming troops refreshed for incoming attack in " + minsLeft + " mins at: " 
									+ new Date(attackTime).toLocaleTimeString();
								printErrorMSG( msg2 );
								GM_deleteValue ( myacc() + "_" + getAllVillageNewdids()[v] + "_incomingAttackCheckElapseTime" );
								// &k for complete incoming troops in rally point, &j is for all outgoing troops
								var callBackUrl = myhost + "/build.php?gid=16&newdid="+getAllVillageNewdids()[v]+"&k";
								TS_getRequest ( callBackUrl, loadRallyPoint, getAllVillageNewdids()[v], true, false );
								break;
							}
						}
					}
				}
			}
		}
		if ( villagesToEvade.length > 0 ) {
			return true;
		}
		//flag ( "checkIncomingAttackComing():: villagesToEvade.length : " + villagesToEvade.length );
		return false;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>checkIncomingAttackComing():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getResourcesForSale ( vi ) {
	try {
		//flag ( "getResourcesForSale():; Started! vi: " + vi );
		var sellRes = [ 0, 0, 0, 0 ]
		if ( GM_getValue ( myacc() + "_" + vi + "_marketExists", "0" ) == "0" )
			return sellRes;
		var lastMarketSellCheck = parseInt ( GM_getValue ( myacc() + "_" + vi + "_marketLastSellCheck", "0" ) );
		if ( lastMarketSellCheck < ( new Date().getTime() - 4*60*1000 ) ) {
			sellRes = GM_getValue ( myacc() + "_" + vi + "_marketSellResources", "0_0_0_0" ).split("_");
			return sellRes;
		}

		function callback() {};
		var url = myhost + "/build.php?newdid=" + vi + "&gid=17&t=2";
		var httpReqObj = new XMLHttpRequest();
		httpReqObj.open('GET', url, false);
		httpReqObj.onreadystatechange = callback;
		httpReqObj.send(null);

		function callback() {
			if ( httpReqObj.readyState == 4 ) {
				if ( httpReqObj.status == 200 ) {
					flag ( "getResourcesForSale():: callback started!" );

					var aElem = document.createElement("div");
					aElem.innerHTML = httpReqObj.responseText;
					if ( gatherStats(aElem.innerHTML) ) {
						// attempt reloading page, captcha ll be found there too and script will stop.
						window.location.replace(myhost + "/spieler.php");
						return sellRes;
					}

					var xpathSellRes = "";
					switch ( aTravianVersion ) {
						case "3.6": xpathSellRes = './/table[@id="sell_overview"]/tbody/tr/td[2]/img/..'; break;
						case "4.0": xpathSellRes = './/table[@id="sell_overview"]/tbody/tr/td[2]/img/..'; break;
						default:
							throwLogicError ( "getResourcesForSale():: Travian Version not set!!" );
					}
					var sellRess = document.evaluate ( xpathSellRes, aElem, null, XPOrdList, null);
					for ( var ctr = 0; ctr < sellRess.snapshotLength ; ctr++ ) {
						var resValue = parseInt ( sellRess.snapshotItem(ctr).textContent.match(/\d{1,}/)[0] );
						var resType = parseInt ( document.evaluate( './/img', sellRess.snapshotItem(ctr), null, XPFirst, null)
							.singleNodeValue.className.match(/\d{1,}/)[0] ) - 1;
						sellRes[resType] += resValue;
					}
					flag ( "getResourcesForSale():: vi: " + vi + ", sellRes: " + sellRes );

					GM_setValue ( myacc() + "_" + vi + "_marketLastSellCheck", new Date().getTime().toString() );
					GM_setValue ( myacc() + "_" + vi + "_marketSellResources", sellRes.join("_") );
					return sellRes;
				}
			}
		}

		return callback();
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getResourcesForSale():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function evadeVillage (villaToEvade) {
	try {
		//flag ( "evadeVillage():: Started! villaToEvade = " + villaToEvade );
		villagesEvaded.push(villaToEvade);

		// get anti-farm coordinates
		var villasToAttack = GM_getValue(myacc() + "_antiFarmVillage", "" );
		if ( villasToAttack == "" ) {
			var msg = "Anti-Farm coordinates not set, Anti-Farm cannot work! Halting!";
			printErrorMSG("<b>" + msg + "</b>");
			var msg1= "Set Anti-Farm coordinates from greasemonkey menu and then restart Auto-Task!";
			printErrorMSG("<b>" + msg1 + "</b>");
			flag ( "evadeVillage():: " + msg );
			throwLogicError ( "evadeVillage():: " + msg );
		}
		villasToAttack = villasToAttack.split(";");
		var villaToAttack = villasToAttack [ Math.floor ( Math.random() * villasToAttack.length ) ];
		villaToAttack = villaToAttack.split(",");

		// actual troop values will be filled in automatically by startAttackNPrepare()
		var raidTask = "2_" + getCoordfromXY( villaToAttack[0], villaToAttack[1] ) + "_4_0_0_0_" +
			"100000000,100000000,100000000,100000000,100000000,100000000,100000000,100000000,100000000,100000000,100000000_" +
			"0_0_" + "0_0_0";
		raidTask = raidTask.split("_");

		// schedule the raid task in anti-farm mode
		var waitInterval = 10; // 0.01 secs, scedule attack and then continue with other evade villages
		window.setTimeout ( function() {
					flag ( "evadeVillage():: Evading Village : " + villaToEvade );
					startAttackNow(villaToEvade.split("_")[0], raidTask, villaToEvade);
					villaToEvade = null; raidTask = null;
					}
			, waitInterval );
		}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>evadeVillage():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function callBackAttack (attackToCallBack) {
	try {
		//flag ( "callBackAttack():: Started! attackToCallBack = " + attackToCallBack );
		attacksCallBacked.push(attackToCallBack);

		// get anti-farm urls from attacksCallBackUrl and send http get requests to call back troops
		var serverNowTime = new Date().getTime() - serverTimeDiff;
		var foundCallBackUrl = false;
		for ( var ctr in attacksCallBackUrl ) {
			if ( attacksCallBackUrl[ctr].indexOf(attackToCallBack) != -1 ) {
				var callBackUrl = attacksCallBackUrl[ctr].split("_")[2];
				var scheduledAt = attacksCallBackUrl[ctr].split("_")[3];
				var timeToSchedule = 30*1000 - (serverNowTime - scheduledAt) ;
				timeToSchedule = timeToSchedule < 0 ? 500 : timeToSchedule;
				timeToSchedule += Math.ceil ( Math.random() * 5000 )
				var msg = getvillagefromdid(attackToCallBack.split("_")[0]) + 
					" (" + attackToCallBack.split("_")[0] + "): Troops call back will initiate in " + 
						Math.round( parseInt(timeToSchedule) / 1000 * 100 ) / 100 + " secs at " + new Date(serverNowTime+timeToSchedule).toLocaleTimeString();
				flag ( "callBackAttack():: " + msg );
				printErrorMSG ( "<b>" + msg + "</b>" );
				window.setTimeout ( 
					function() {
						flag ( "callBackAttack():: Attempting CallBack: " + attackToCallBack );
						var msg = getvillagefromdid(attackToCallBack.split("_")[0]) + 
							" (" + attackToCallBack.split("_")[0] + "): Troops call back initiated at "
							+ new Date(new Date().getTime() - serverTimeDiff).toLocaleTimeString();
						printErrorMSG ( "<b>" + msg + "</b>" );
						TS_getRequest(callBackUrl,callBackAttackAccept, attackToCallBack);
						callBackUrl=null; attackToCallBack=null;
					},
					timeToSchedule ); // random ( 5 seconds ) + timeToSchedule milli-seconds
				foundCallBackUrl = true;
			}
		}
		if ( foundCallBackUrl == false ) {
			// since no urls were found, means there were no troops to send out to evade attack
			// hence mark attackToCallBack as completed
			window.setTimeout ( 
				function() { 
					flag ( "callBackAttack():: Nothing to CallBack: " + attackToCallBack );
					var msg = getvillagefromdid(attackToCallBack.split("_")[0]) + 
						" (" + attackToCallBack.split("_")[0] + ") : Nothing to CallBack at "
						+ new Date(new Date().getTime() - serverTimeDiff).toLocaleTimeString();
					printErrorMSG ( "<b>" + msg + "</b>" );
					callBackAttackAccept(null,attackToCallBack);
					attackToCallBack=null;
				},
				Math.ceil ( Math.random() * 5000 ) + 30*1000 ); // random ( 5 seconds ) + 30 seconds
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>callBackAttack():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function callBackAttackAccept(doc, attackToCallBack) {
	try {
		//flag ( "callBackAttackAccept():: Started! attackToCallBack = " + attackToCallBack );

		// attack call back is complete, hence push it into attacksCallBackCompleted
		attacksCallBackCompleted.push(attackToCallBack);

		if ( doc != null ) // analyze rally point if doc is not null
			analyzeRallyPoint(doc,attackToCallBack.split("_")[0],false);
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>callBackAttack():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function evadeAttack() {
	try {
		//flag ( "evadeAttack():: Started!" );
		//flag ( "evadeAttack():: villagesToEvade: " + villagesToEvade.join(" || ") );
		//flag ( "evadeAttack():: villagesEvaded: " + villagesEvaded.join(" || ") );
		//flag ( "evadeAttack():: attacksToCallBack: " + attacksToCallBack.join(" || ") );
		//flag ( "evadeAttack():: attacksCallBacked: " + attacksCallBacked.join(" || ") );
		//flag ( "evadeAttack():: attacksCallBackCompleted: " + attacksCallBackCompleted.join(" || ") );

		// villagesToEvade have not been evaded, evade them...
		for ( var ctr in villagesToEvade ) {
			if ( villagesEvaded.join("||").indexOf(villagesToEvade[ctr]) == -1 ) { // if not already evaded
				var serverNowTime = new Date().getTime() - serverTimeDiff;
				var tempvt = villagesToEvade[ctr].split("_");
				var inAtkVill = tempvt[0];
				var inAtkTime = parseInt(tempvt[1]);
				if ( ( inAtkTime - serverNowTime ) < 15*1000 ) { // if attack is with in 15 secs
					flag ( "evadeAttack():: incoming attack in " + Math.round ( ( inAtkTime - serverNowTime ) / 1000 * 100 ) / 100
						+ " secs, evading attack: " + villagesToEvade[ctr] + ", in at: " + new Date(inAtkTime).toLocaleTimeString() );
					var ownTroopsInTimes = GM_getValue(myacc() + "_" + inAtkVill + "_troopsOwnInTimes" ).split("|");
					var tempArry = new Array();
					for ( var itr = 0 ; itr < ownTroopsInTimes.length ; itr++ ) { // TODO:: we should use binary search here instead of linear search.
						if ( ownTroopsInTimes[itr] < serverNowTime )
							continue;
						// can't save own troops which arrive back within 10 secs before incoming attack because of server time diff
						if ( ownTroopsInTimes[itr] > ( inAtkTime - 10*1000 ) )
							break;
						tempArry.push ( ownTroopsInTimes[itr] );
						break;
					}
					//tempArry.reverse();
					if ( tempArry.length == 0 ) { // if no own incoming troops then evade attack
						//flag ( "evadeAttack():: incoming attack in " + Math.round ( ( inAtkTime - serverNowTime ) / 1000 * 100 ) / 100
						//	+ " secs, evading attack: " + villagesToEvade[ctr] );
						evadeVillage(villagesToEvade[ctr]); // evade attack
					}
					else { // if there are still some own troops coming back then wait
						var waitInterval = 2*1000; // 2 secs
						window.setTimeout ( function() {
									checkIncomingAttackComing();
									evadeAttack();
								}
								, waitInterval );
						return;
					}
				}
			}
		}

		// if attacksToCallBack have not been called back, call them back...
		for ( var ctr in attacksToCallBack ) {
			if ( attacksCallBacked.join("||").indexOf(attacksToCallBack[ctr]) == -1 ) { // if not already called back
				callBackAttack(attacksToCallBack[ctr]);
			}
		}

		//flag ( "evadeAttack():: Ended!" );
		if ( villagesToEvade.length > 0 ) { // if not complete then repeat
			var waitInterval = 4*1000 + Math.ceil ( Math.random() * 4*1000 - 2*1000); // 4 secs +/- random 2 secs
			window.setTimeout ( function() {
						checkIncomingAttackComing();
						evadeAttack();
						}
				, waitInterval );
		}
		else { 
			// check if all villages evaded have been called back...
			var checkComplete = true;
			var tempVar = attacksCallBackCompleted.join("||");
			for ( var ctr in villagesEvaded ) {
				if ( tempVar.indexOf(villagesEvaded[ctr]) == -1 ) {
					checkComplete = false;
					break;
				}
			}
			if ( checkComplete == false ) { // if not complete then repeat
				var waitInterval = 4*1000 + Math.ceil ( Math.random() * 4*1000 - 2*1000); // 4 secs +/- random 2 secs
				window.setTimeout ( function() {
							checkIncomingAttackComing();
							evadeAttack();
							}
					, waitInterval );
			}		
			else { // if complete then start doEachTimeDo
				var waitInterval = 10*1000 + Math.ceil ( Math.random() * 10*1000 - 5*1000); // 10 secs +/- random 5 secs
				window.setTimeout ( function() {
							var msg = "Anti-farm completed at " + new Date( new Date().getTime() - serverTimeDiff ).toLocaleTimeString();
							flag ( "evadeAttack():: " + msg );
							printErrorMSG( "<b>" + msg + "</b>" );
							evadingComplete		= true;
							villagesEvaded		= new Array();
							attacksToCallBack	= new Array();
							attacksCallBacked	= new Array();
							attacksCallBackCompleted = new Array();
							attacksCallBackUrl	= new Array();
							//doEachTimeDo(); // no need here, just setting evadingComplete to true is required
							}
					, waitInterval );
			}
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>evadeAttack():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function checkMailAndPlayAlarm(innerText) {
	try {
		//flag ( "checkMailAndPlayAlarm():: Started!" );
		var checkMail = GM_getValue ( myacc() + "_checkMail", "1" );
		if ( checkMail != "0" ) {
			var aElem = document.createElement("div");
			aElem.innerHTML = innerText;
			var xpathMailCheck = "";
			switch ( aTravianVersion ) {
				case "3.6": xpathMailCheck = './/div[ (@id="n5") and ( (@class="i1") or (@class="i2") ) ]'; break;
				case "4.0": xpathMailCheck = './/li[@id="n6"]//div[@class="ltr bubble" and contains(@style,"display: block;")]'; break;
				default: throwLogicError ( "checkMailAndPlayAlarm():: Travian Version not set!!" );
			}
			var checkMailDiv = document.evaluate( xpathMailCheck, aElem, null, XPFirst, null ).singleNodeValue;
			if ( checkMailDiv != null ) {
				switch ( checkMail ) {
					case "1": // all mails
						playSound("&nbsp;&nbsp;New Mail!&nbsp;&nbsp;");
						return true;
					case "2": // multihunter mails
						playSound("&nbsp;&nbsp;New Mail! (Multihunter mails is not implemented yet!)&nbsp;&nbsp;");
						return true;
				}
			}
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>checkMailAndPlayAlarm():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function doEachTimeDo() {
	try {
		// if login window not showing allowed url reload login window.
		if ( ! checkUrlAllowedForLoginWindow() ) {
			printErrorMSG(window.location.href + " is not allowed on Login Window, reloading Login Window!");
			printErrorMSG("<b>To add tasks, open *Non-Login Windows* using 'right click' -> 'open in new tab/window'.</b>" );
			flag ("doEachTimeDo():: Current url is not allowed for Login Window, reloading Login Window!");
			window.setTimeout ( function() { 
						reloadLoginWindow();
					},
					Math.ceil ( Math.random() * 3*1000 + 3*1000 ) ); // 3 secs + random 3 secs
			return;
		}
		else {
			printErrorMSG();
			printMSG();

			var alarmText = GM_getValue ( myacc() + "_alarmText", "" );
			if ( alarmText != "" && $("alarm_wrapper") == null ) { // play alarm again if login window was refreshed before user cleared the alarm.
				playSound(alarmText);
			}
			else if ( $("alarm_wrapper") != null ) { // alarm is currently playing 
				var nowt = new Date().getTime();
				var alarmDuration = Number ( GM_getValue ( myacc() + "_alarmDuration", "1" ) ) * 60*1000;
				var alarmT = GM_getValue ( myacc() + "_alarmStartTime" );
				if ( !alarmT ) {
					alarmT = new Date().getTime();
					GM_setValue ( myacc() + "_alarmStartTime", alarmT.toString() );
				}
				if ( Number(alarmT) + alarmDuration < nowt )
					stopSound();
			}

			var customAlarmTime = GM_getValue(myacc() + "_customAlarmTime", null );
			if ( customAlarmTime != null && customAlarmTime != "" ) {
				var nowTime = new Date().getTime() - serverTimeDiff;
				customAlarmTime = new Date(customAlarmTime).getTime();
				if ( nowTime > customAlarmTime ) {
					var alarmText = GM_getValue ( myacc() + "_alarmText", "" );
					var customAlarmText = "&nbsp;&nbsp;Custom Alarm:: " + GM_getValue ( myacc() + "_customAlarmText", "" ) + "&nbsp;&nbsp;";
					if ( alarmText != ( customAlarmText ) ) { // play alarm if not already playing
						flag ( "doEachTimeDo():: " + customAlarmText );
						playSound(customAlarmText);
					}
				}
			}

			if ( evadingComplete ) {
				var antiFarmEnabled = GM_getValue(myacc() + "_antiFarmEnabled", "1" );
				var inComingAttack = checkIncomingAttackComing();
				if ( antiFarmEnabled == "1" && inComingAttack == true ) {
					evadingComplete = false;
					evadeAttack();
				}
				else {
					var checkSleepTime = checkIsSleepTime();
					if ( taskdoing == "1" && testTimeElapsedIncomingAttackAndTroopsCheck( checkSleepTime ) ) {
						calldoing0(); // load rally point one at a time...
						freshenIncomingAttackAndTroops();
					}
					else {
						if ( checkSleepTime == false ) {
							if ( $("show_info_bubble_wrapper") != null ) 
								document.body.removeChild($("show_info_bubble_wrapper"));
							// check on taskdoing
							if ( taskdoing == 1 ) {
								taskIterationCtr = 0;
								//flag ("doEachTimeDo():: Running!");
								checkPlusDoubleBuildElapsed();
								eachTimedo();
							}
							else {
								taskIterationCtr++;
								if ( taskIterationCtr > 15 ) { // taskdoing should not be 0 for long intervals
									//taskIterationCtr = 0;
									GM_setValue ( myacc() + "_doing", "1" );
									//taskdoing = 1;
									//playSound ( "doEachTimeDo():: Script seems to be stuck, reloading login window!" );
									printErrorMSG ( "doEachTimeDo():: Script seems to be stuck, reloading login window!" );
									reloadLoginWindow();
									return;
								}
							}
						}
					}
				}
			}
		}

		if ( self.window.name == GM_getValue(currentServer() + '_loginWindow', "noLoginWindow") ) {
			// scriptRunInterval +/- random (scriptRunInterval/2)
			scriptRunIntervalRand = scriptRunInterval + Math.ceil ( Math.random() * scriptRunInterval - scriptRunInterval/2.0);
			doEachTimeDoTimer = window.setTimeout ( doEachTimeDo, scriptRunIntervalRand );
		}
		else {
			clearInterval ( keepScriptRunningTimer );
			//TS_debug("Login Window is no longer loginWindow");
			$("footer").innerHTML = defaultFooterText;
			self.window.name = "";	// clear login window name.
			document.title = defaultDocumentTitle;
			showTaskList();
			// add event listeners on keydown and mouse events to clear timers on user activity.
			window.removeEventListener("keydown", cleartime, false);
			window.removeEventListener("mousemove", cleartime, false); 
			window.removeEventListener("DOMMouseScroll", cleartime, false); //adding the event listerner for Mozilla
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>doEachTimeDo():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function checkUrlAllowedForLoginWindow()
{
	if ( window.location.href.indexOf("/spieler.php") != -1 ||
		window.location.href.indexOf("/dorf3.php") != -1 ||
		window.location.href.indexOf("/karte.php") != -1 ||
		window.location.href.indexOf("/statistiken.php") != -1 ||
		window.location.href.indexOf("/berichte.php") != -1 || 
		window.location.href.indexOf("/nachrichten.php") != -1
		) {
		return true;
	}
	else {
		return false;
	}
}

function reloadLoginWindow() {
	try {
		flag ("reloadLoginWindow():: Login Window reloading now...");

		// delete _doing, it will be set on login window reload
		//GM_deleteValue(myacc() + "_doing");

		// pagefreshInterval (mins) is used for when to relad page, randomized by 0.5 times.
		var loginWindowFreshIntrv = GM_getValue ( myacc() + "_loginWindowFreshInterval", "60");
		pagefreshInterval = loginWindowFreshIntrv * 60*1000 + Math.ceil ( Math.random() * loginWindowFreshIntrv*60*1000 - loginWindowFreshIntrv*60*1000/2.0 );
		flag ( "reloadLoginWindow():: Next Login Widnow reload in: " + milliSecondstoDHMS(pagefreshInterval) );

		// find what url to load in login window...
		var newdidsArryLen = getAllVillageNewdids().length;
		var lastNewdidLoaded = Number(GM_getValue(myacc() + "_lastNewdidLoaded", "0" ));
		var newdidToLoad = ( lastNewdidLoaded + 1 < newdidsArryLen ) ? lastNewdidLoaded + 1 : 0;
		GM_getValue(myacc() + "_lastNewdidLoaded", newdidToLoad+"" );
		var vi = getAllVillageNewdids()[newdidToLoad];	
		var reqUrl = "";
		var rndUrl = Math.random();
		if ( rndUrl < 0.2 ) {
			reqUrl = myhost + "/spieler.php" + "?newdid=" + vi;			// profile page with 0.2 probability
		}
		else if ( rndUrl >= 0.2 && rndUrl < 0.4 ) {
			reqUrl = myhost + "/dorf3.php" + "?newdid=" + vi;			// dorf3.php with 0.2 probability
		}
		else if ( rndUrl >= 0.4 && rndUrl < 0.6 ) {
			reqUrl = myhost + "/karte.php" + "?newdid=" + vi;			// karte.php with 0.2 probability
		}
		else if ( rndUrl >= 0.6 && rndUrl < 0.8 ) {
			reqUrl = myhost + "/statistiken.php" + "?newdid=" + vi;			// statistics page with 0.2 probability
		}
		else if ( rndUrl >= 0.8 && rndUrl < 0.9 ) {
			reqUrl = myhost + "/berichte.php" + "?newdid=" + vi;			// reports page with 0.1 probability
		}
		else /*if ( rndUrl >= 0.9 && rndUrl <= 1 ) */ {
			reqUrl = myhost + "/nachrichten.php" + "?newdid=" + vi;			// messages page with 0.1 probability
		}
		flag ( "reloadLoginWindow():: New Login Window url: " + reqUrl );

		// reload login window to gather stats..
		window.location.replace( reqUrl );
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>reloadLoginWindow():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function testTimeElapsedIncomingAttackAndTroopsCheck( checkSleepTime ) {
	try {
		//flag ( "testTimeElapsedIncomingAttackAndTroopsCheck():: Started!" );
		var nowt = new Date().getTime();
		// ideally we should use serverTimeDiff, however since serverTimeDiff is sort of random, we end up sending multiple rally point get requests
		//var nowt = new Date().getTime() - serverTimeDiff;
		for ( var ctr in getAllVillageNewdids() ) {
			var vi = getAllVillageNewdids()[ctr];
			var elapseTimeInAttk = GM_getValue(myacc() + "_" + vi + "_incomingAttackCheckElapseTime", "" );
			var elapseTimeTrpChk = GM_getValue(myacc() + "_" + vi + "_troopsCheckElapseTime", "" );
			if ( elapseTimeInAttk == "" || elapseTimeInAttk < nowt )
				return true;
			if ( getVillageOption ( "PAUSE_ALL_ATTACKS", 0, "integer", vi ) == "0" && checkSleepTime == false && ( elapseTimeTrpChk == "" || elapseTimeTrpChk < nowt ) )
				return true;
		}
		return false;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>testTimeElapsedIncomingAttackAndTroopsCheck():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function freshenIncomingAttackAndTroops() {
	try {
		flag ( "freshenIncomingAttackAndTroops():: Started!" );
		var nowt = new Date().getTime();
		// ideally we should use serverTimeDiff, however since serverTimeDiff is sort of random, we end up sending multiple rally point get requests
		//var nowt = new Date().getTime() - serverTimeDiff;
		for ( var ctr in getAllVillageNewdids() ) {
			var elapseTimeInAttk = GM_getValue(myacc() + "_" + getAllVillageNewdids()[ctr] + "_incomingAttackCheckElapseTime", "" );
			if ( elapseTimeInAttk == "" || elapseTimeInAttk < nowt ) {
				// &k for complete incoming troops in rally point, &j is for all outgoing troops
				var callBackUrl = myhost + "/build.php?gid=16&newdid="+getAllVillageNewdids()[ctr]+"&k";
				TS_getRequest ( callBackUrl, loadRallyPoint, getAllVillageNewdids()[ctr], true, true );
				return; // load a rally point one at a time...
			}
			var elapseTimeTrpChk = GM_getValue(myacc() + "_" + getAllVillageNewdids()[ctr] + "_troopsCheckElapseTime", "" );
			if ( elapseTimeTrpChk == "" || elapseTimeTrpChk < nowt ) {
				var callBackUrl = myhost + "/build.php?gid=16&newdid="+getAllVillageNewdids()[ctr];
				TS_getRequest ( callBackUrl, loadRallyPoint, getAllVillageNewdids()[ctr], false, true );
				return; // load a rally point one at a time...
			}
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>freshenIncomingAttackAndTroops():: Something went wrong, error: " + err.name + " :: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function analyzeDorf1(aElem,vi)
{
	//TS_debug("analyzeDorf1():: Started!");
	refreshDorf1MapData(aElem,vi);
	collectAutoResDataFromDorf1(vi,aElem);
	refreshBuildingState(aElem,vi);
	getResourceCap2(aElem,vi);
}

function analyzeDorf2(aElem,vi)
{
	//TS_debug("analyzeDorf2():: Started!");
	refreshDorf2MapData(aElem,vi);
	refreshBuildingState(aElem,vi);
	getResourceCap2(aElem,vi);
}

function analyzeMarketPlace(aElem,vi)
{
    getResourceCap2(aElem,vi);
    refreshMerchantTransit(aElem,vi);
}

function validateRMT ( fromid, toid ) {
	try {
		var r1 = getGMCookieVi ( "ResourceTraning", toid, fromid );
		if (!r1) {
			r1 = [0,0,0,0];
		}
		var r2 = GM_getValue(myacc()+ "_" + fromid +"_"+ toid + "_ResourceTraning","0/0/0/0").split("/");
		r2[0] = parseInt(r2[0]);
		r2[1] = parseInt(r2[1]);
		r2[2] = parseInt(r2[2]);
		r2[3] = parseInt(r2[3]);
		if ( r1[0] != r2[0] || r1[1] != r2[1] || r1[2] != r2[2] || r1[3] != r2[3] ) {
			//alert("=========================================== validateRMT failed: r1=[" + r1 + "],  r2=["+ r2 + "]");
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>validateRMT():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function validateGRC(vi)
{
    var r1 = getGMCookie("ResourceNow",vi);
    if (!r1)
    {
        r1 = [0,0,0,0];
    }
    var r2 = GM_getValue(myacc()+ "_" + vi + "_ResourceNow","0/0/0/0").split("/");
    r2[0] = parseInt(r2[0]);
    r2[1] = parseInt(r2[1]);
    r2[2] = parseInt(r2[2]);
    r2[3] = parseInt(r2[3]);
    if(r1[0] != r2[0] || r1[1] != r2[1] || r1[2] != r2[2] || r1[3] != r2[3])
    {
        TS_debug("validateGRC failed: r1=[" + r1 + "],  r2=["+ r2 + "]");
    }
}

function refreshMerchantTransit ( aElem, vi ) {
	try {
		var villaNameInputElem = document.evaluate( './/input[@name="dname"]', aElem, null, XPFirst, null).singleNodeValue;
		if ( villaNameInputElem == null ) // do not process if not the 1st tab of the market page
			return;

		flag ( "refreshMerchantTransit():: Started! vi: " + vi );

		var nowms = new Date().getTime();

		//TODO: Refresh Merchan Capacity
		//TODO: refresh Merchant at Home

		var vTransit = {}; // what is being transported from this village (vi) to other villages map

		// initialize vTaransit
		var allV = getAllVillageNewdids();
		for ( var i in allV ) {
			var destVilla = allV[i];
			vTransit[ destVilla ] = {};
			vTransit[ destVilla ].r = [0,0,0,0]; // total resources being sent to destVilla
			vTransit[ destVilla ].a = 0; // minimum arrival back from destVilla
			vTransit[ destVilla ].merch = new Array(); // all merchants array going to destVilla
		}

		var nextReturn; // next merchant arrive back from any villa

		// fill in values in vTransit
		var allTransit = document.evaluate('.//table[@class="traders"]',aElem,null,XPOrdList,null);
		for ( var i = 0 ; i < allTransit.snapshotLength ; i++ ) {
			//TS_debug("Processing merchant id=" + i);
			tElem = allTransit.snapshotItem(i);
			
			var timerxpath = './/*[contains(@id,"timer")]'; // sometimes timer ids do not start with 1
			var delay = $g ( timerxpath, XPFirst, tElem );
			if ( delay ) {
				delay = delay.innerHTML;
				var delaya = delay.split(":");
				delay = Number(delaya[0]) * 60*60*1000 + Number(delaya[1]) * 60*1000 + Number(delaya[2]) * 1000;
			}
			//TS_debug("MerchantTime is " + delay);
			
			var target = document.evaluate ( './/a[contains(@href,"karte.php?d=")]', tElem, null, XPFirst, null );
			// Needs to return something otherwise we'll throw.
			var destPos = target.singleNodeValue.href.match(/\bd=\d{1,}\b/)[0].split("=")[1];
			var destPos = parseInt ( destPos );

			if ( tElem.innerHTML.indexOf ( aLangGameText[10] ) != -1 ) { //Transport to
				//TS_debug("Processing Transport to " + destPos);
				var rTime = getMerchanTime ( vi, parseInt(destPos) ) + delay;
				if ( !nextReturn ) {
					nextReturn = rTime;
				}
				else {
					nextReturn = Math.min ( nextReturn, rTime );
				}
				//TS_debug("merchant return time is " + rTime);

				var vid  = getNewdidFromPos(destPos); // destination village newdid
				if ( vid ) { // do only if vid is one of own village
					//TS_debug("merchant heading in village " + vid);
					var transporting = vTransit[vid].r;
					if ( !transporting ) {
						transporting  = new Array(4);
					}
					var res = document.evaluate('./tbody/tr[@class="res"]/td',tElem,null,XPFirst,null).singleNodeValue;
					if ( res == null )
						throwLogicError ( "refreshMerchantTransit():: Cannot get resources being transfered!!" );
					var ress = [];
					var wood = 0, clay = 0, iron = 0, wheat = 0;
					switch ( aTravianVersion ) {
						case "3.6":
							ress = res.innerHTML.match(/>\d{1,}(?![:(\d:)])/g);
							wood = parseInt(ress[0].split(">")[1]);
							clay = parseInt(ress[1].split(">")[1]);
							iron = parseInt(ress[2].split(">")[1]);
							wheat = parseInt(ress[3].split(">")[1]);
							break;
						case "4.0":
							ress = res.textContent.match(/\b\d{1,}\b/g);
							wood = parseInt(ress[0]);
							clay = parseInt(ress[1]);
							iron = parseInt(ress[2]);
							wheat = parseInt(ress[3]);
							break;
						default:
							throwLogicError ( "refreshMerchantTransit():: Travian Version not set!!" );
					}
					//ress = alltranTo.snapshotItem(i).parentNode.parentNode.parentNode.parentNode.innerHTML.match(/>\d{1,}(?![:(\d:)])/g);
					transporting[0] += wood;
					transporting[1] += clay;
					transporting[2] += iron;
					transporting[3] += wheat;
					var merch = { r: [ wood, clay, iron, wheat ], t: ( nowms + delay ) };
					vTransit[vid].merch.push ( merch );
					vTransit[vid].r = transporting;
					var mindelay = vTransit[vid].a
					if ( !mindelay || mindelay == 0 ) {
						mindelay = delay;
					}
					else {
						mindelay = Math.min ( mindelay, delay );
					}
					vTransit[vid].a = mindelay;
				}
			}
			else if ( tElem.innerHTML.indexOf ( aLangGameText[12] ) != -1 ) { //return from
				//TS_debug("Processing Return from");
				if ( !nextReturn ) {
					nextReturn = delay;
				}
				else {
					nextReturn = Math.min(nextReturn, delay);
				}
			}
			else if ( tElem.innerHTML.indexOf(aLangGameText[11]) != -1 ) { // Transport From
				//TS_debug("processing incoming");
				//nothing to do here
			}
			else {
				printErrorMSG("<b>ERROR:: Translation required for : \"" + aLangGameTextComDef[10] + "\", \"" + aLangGameTextComDef[12]
					+ "\" and \"" + aLangGameTextComDef[11] + "\" from market.</b>", 1 );
				TS_debug("Error parsing transport " + tElem.innerHTML);
			}
		}
  
		// iterate over all destination villages
		for(var vid in vTransit) {
			//flag ( "Total resources out to " + vid + " : " + vTransit[vid].r + ", min arrive back time: " + vTransit[vid].a );
			var transit = vTransit[vid].r;
			tsum = transit[0] + transit[1] + transit[2] + transit[3];
			setGMCookieVi("ResourceTraning",vTransit[vid].r,vid,vi);

			if ( vTransit[vid].a != 0 ) {
				var transitTime = getRandomizedTime ( vTransit[vid].a );
				var ctt = GM_getValue ( myacc() + "_" + vi + "_to_" + vid + "_TraningTime", "150000000000000" );
				if ( parseInt(ctt) > transitTime ) {
					TS_debug ( "Setting Transit time for " + vi + " to " + vid + " : " + vTransit[vid].a );
					GM_setValue ( myacc() + "_" + vi + "_to_" + vid + "_TraningTime", transitTime.toString() );
				} 
			}
			else if ( tsum > 0 ) {
				throwLogicError ( "refreshMerchantTransit():: Delay time not set!!" );
			}

			//var merchantList = getGMCookieVi ( "MerchantTransit", vid, vi );
			//if ( !merchantList ) {
				// This data is not currently used. Could potentially be used to reduce number of request when updating resources
				//setGMCookieVi ( "MerchantTransit", vTransit[vid].merch, vid, vi ); 
			//}
			/*else {
				var lastMerchantTime = 0;
				if ( merchantList.length > 0 ) {
					var lastMerchant = merchantList [ merchantList.length - 1 ];
					lastMerchantTime = lastMerchant.t;
				}

				//This assumes that there cannot be two merchant leaving from the same
				//village arriving at the exact same time. Although it is possible
				// it is very very unlikely since the script only process one request
				// per iteration.
				flag ( "vTransit.merch: " + vTransit[vid].merch )
				for ( var j in vTransit[vid].merch ) {
					if ( merch.t > lastMerchantTime ) {
						merchantList.push ( merch );
						break;
					}
				}
				setGMCookieVi("MerchantTransit",merchantList,vid,vi);
			}*/
		}

		if ( nextReturn ) {
			TS_debug ( "nextReturn: " + nextReturn );
			var merchantReturnTime = getRandomizedTime ( nextReturn );
			setGMCookie ( "MerchantReturnTime", merchantReturnTime, vi );
		}
		//TS_debug("leaving refreshMerchantTransit");
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>refreshMerchantTransit():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// this function doesn't load rally point, rally point must be loaded by a prior call to TS_getRequest()
// its purpose is to set doing to 1 when rally point load is complete
function loadRallyPoint ( response, newdid, checkForIncomingAttack, setDoingToOne ) {
	try {
		//flag ( "loadRallyPoint():: Started for newdid: " + newdid );
		if ( response != null && response != "" ) {
			// check if we have rally point
			var h1name = document.evaluate('.//h1', response, null, XPFirst, null).singleNodeValue;
			//flag ( "loadRallyPoint():: h1name: " + h1name.innerHTML );
			// when not rally point, this should happen only if village has no rally point
			if ( h1name == null || h1name.innerHTML.replace(/\n/g,"").indexOf(aLangAllBuildWithId[16]) == -1 ) {
				var serverNowTime = new Date().getTime() - serverTimeDiff;
				var delayMultiplier = 1;
				if ( getAllVillageNewdids().length == 1 ) { // when we have only 1 village.
					delayMultiplier = 12; // delay 12 times more than normal, probably user is under beginner's protection during this.
				}
				else {	// we have more than 1 village, then most probably this is a new village, or the rally point has been destroyed.
					delayMultiplier = 4; // delay 4 times more than normal
					//addBuildingTaskAtTop(viNewdid, 15, 3); // add main building level 3 upgrade task
					addBuildingTaskAtTop(newdid, 16); // add rally point task
				}
				var attackDetectInterval = parseInt(GM_getValue(myacc() + "_attackDetectInterval", "60")) * delayMultiplier; // delay more than normal
				// attackDetectInterval mins +/- random ( attackDetectInterval/2 )
				var randominter1 = Math.ceil ( Math.random() * attackDetectInterval*60*1000 - attackDetectInterval*60*1000/2.0 ) + attackDetectInterval*60*1000;
				var elapseTime1 = serverNowTime + randominter1;
				GM_setValue ( myacc() + "_" + newdid + "_incomingAttackCheckElapseTime", elapseTime1.toString() );
				var msg1 = getvillagefromdid(newdid) + " (" + newdid + "): No Rally Point! Cannot check for incoming attack, will check again at : " 
						+ new Date(elapseTime1);
				flag ( "loadRallyPoint():: " + msg1 );
				printErrorMSG ( "<b>" + msg1 + "</b>" );

				var troopsUpdateInterval = parseInt(GM_getValue(myacc() + "_troopsUpdateInterval", "60")) * delayMultiplier; // delay more than normal
				// troopsUpdateInterval mins +/- random ( troopsUpdateInterval/2 )
				var randominter2 = Math.ceil ( Math.random() * troopsUpdateInterval*60*1000 - troopsUpdateInterval*60*1000/2.0 ) + troopsUpdateInterval*60*1000;
				var elapseTime2 = serverNowTime + randominter2;
				GM_setValue ( myacc() + "_" + newdid + "_troopsCheckElapseTime", elapseTime2.toString() );
				var msg2 = getvillagefromdid(newdid) + " (" + newdid + "): No Rally Point! Cannot check for available troops, will check again at : "
						+ new Date(elapseTime2);
				flag ( "loadRallyPoint():: " + msg2 );
				printErrorMSG ( "<b>" + msg2 + "</b>" );

				//return; // return after setting doing to 1
			}

			analyzeRallyPoint(response,newdid,checkForIncomingAttack);
			window.setTimeout ( calldoing1, Math.ceil ( Math.random() * 1000 ) + 1000 ); // random ( 1 secs ) + 1 secs

			if ( setDoingToOne )
				calldoing1();
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>loadRallyPoint():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function checkSendHeroForAdventure() {
	try {
		//flag ( "checkSendHeroForAdventure():: Started!" );
		switch ( aTravianVersion ) {
			case "3.6":
				return false;
				break;
			case "4.0":
				if ( GM_getValue ( myacc() + "_heroAdventureEnabled", "1" ) == "0" )
					return false;
				var heroNextSendTime = parseInt ( GM_getValue ( myacc() + "_heroNextTime", "0" ) );
				if ( heroNextSendTime < new Date().getTime() )
					return true;
				return false;
				break;
			default:
				throwLogicError ( "checkSendHeroForAdventure():: Travian Version not set!!" );
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>checkSendHeroForAdventure():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getHeroHealthAndSpeedAndVillage( aElem ) {
	try {
		flag ( "getHeroHealthAndSpeedAndVillage():: Started!" );

		if ( getHeroSpeed( aElem ) == false ) { // get hero speed, health & village
			// delay by 3hrs +/- random ( 3hrs / 2 )
			var randTime = getRandomizedTime ( 3*60*60*1000, 3*60*60*1000, 1 );
			GM_setValue ( myacc() + "_heroNextTime", randTime.toString() );
			calldoing1();
			return;
		}

		// check hero health
		var heroHealth = Number ( GM_getValue ( myacc() + "_heroHealth", "0" ) );
		var heroMinHealth = Number ( GM_getValue ( myacc() + "_heroMinHealth", "50" ) );
		if ( heroHealth < heroMinHealth ) {
			var msg = "Hero Health is less than set minimum" + heroMinHealth + "%, current health: " + heroHealth + ", not sending hero for adventure!";
			flag ( "getHeroHealthAndSpeedAndVillage():: " + msg );
			printErrorMSG ( "<b>" + msg + "</b>" );
			// delay by 3hrs +/- random ( 3hrs / 2 )
			var randTime = getRandomizedTime ( 3*60*60*1000, 3*60*60*1000, 1 );
			GM_setValue ( myacc() + "_heroNextTime", randTime.toString() );
			calldoing1();
			return;
		}

		// check hero village
		var heroVillagePos = GM_getValue ( myacc() + "_heroVillage", "" );
		if ( heroVillagePos == "" ) {
			throwLogicError ( "getHeroHealthAndSpeedAndVillage():: Hero Village not found!!" );
		}
		var heroVillageIsOwnVillage = false;
		var heroVillage = "";
		//flag ( "getHeroHealthAndSpeedAndVillage():: getAllVillageNewdids().length: " + getAllVillageNewdids().length );
		for ( var ctr = 0 ; ctr < getAllVillageNewdids().length ; ctr++ ) {
			var villaPos = getPosFromNewdid ( getAllVillageNewdids()[ctr] );
			//flag ( "getHeroHealthAndSpeedAndVillage():: ctr: " + ctr + ", village did: " + getAllVillageNewdids()[ctr] + ", village pos: " + villaPos );
			if ( heroVillagePos == villaPos ) { // hero village is one of own village, ie hero is either in village or is coming back to village
				heroVillageIsOwnVillage = true;
				heroVillage = getAllVillageNewdids()[ctr];
				//flag ( "getHeroHealthAndSpeedAndVillage():: ctr: " + ctr + ", heroVillage: " + heroVillage + ", village pos: " + villaPos );
				break;
			}
		}
		if ( heroVillageIsOwnVillage == false ) { // hero village is not own village, ie hero is out, try again in 3 hrs
			// delay by 3hrs +/- random ( 3hrs / 2 )
			flag ( "getHeroHealthAndSpeedAndVillage():: Hero village is not own village, ie hero is out, hence cannot send for adventure!" );
			var randTime = getRandomizedTime ( 3*60*60*1000, 3*60*60*1000, 1 );
			GM_setValue ( myacc() + "_heroNextTime", randTime.toString() );
			calldoing1();
			return;
		}

		// check if hero is in village
		var troops = GM_getValue(myacc() + "_" + heroVillage + "_troopsAvail", ""); // get troops count from cookie
		if ( troops == "" || troops == "none" ) { // no troops in village
			// delay by 3hrs +/- random ( 3hrs / 2 )
			flag ( "getHeroHealthAndSpeedAndVillage():: No troops in hero village, ie Hero is not in village, hence cannot send for adventure!" );
			var randTime = getRandomizedTime ( 3*60*60*1000, 3*60*60*1000, 1 );
			GM_setValue ( myacc() + "_heroNextTime", randTime.toString() );
			calldoing1();
			return;
		}
		troops = troops.split("_");
		if ( troops[10] == "0" ) { // hero is not in village
			// delay by 3hrs +/- random ( 3hrs / 2 )
			flag ( "getHeroHealthAndSpeedAndVillage():: Hero is not in village, hence cannot send for adventure!" );
			var randTime = getRandomizedTime ( 3*60*60*1000, 3*60*60*1000, 1 );
			GM_setValue ( myacc() + "_heroNextTime", randTime.toString() );
			calldoing1();
			return;
		}

		flag ( "getHeroHealthAndSpeedAndVillage():: heroVillage: " + heroVillage );

		// everything seems okay, now get available adventures
		var randominter = Math.ceil ( Math.random() * 8*1000 + 2*1000 ); // random ( 8 sec ) + 2 sec
		window.setTimeout ( function() { 
						var url = myhost + "/hero_adventure.php?newdid=" + heroVillage;
						TS_getRequest ( url, getAvailableAdventures, heroVillage, 0 );
					},
					randominter );
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getHeroHealthAndSpeedAndVillage():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// mode: 0 --> check for available adventures, and send hero if available
// mode: 1 --> check for available adventures, and set _heroNextTime if adventure available, no need to set heroVillage in this mode
function getAvailableAdventures( aElem, heroVillage, mode ) {
	try {
		flag ( "getAvailableAdventures():: Started!" );

		var xpathNormalAdventures    = './/div[@id="content" and @class="hero_adventure"]//td[@class="difficulty"]/'
			+ 'img[contains(@class,"adventureDifficulty") and @class="adventureDifficulty1"]'
			+ '/../..//td[@class="goTo"]/a[@class="gotoAdventure arrow" and contains(@href,"karte.php")]';
		var xpathNonNormalAdventures = './/div[@id="content" and @class="hero_adventure"]//td[@class="difficulty"]/'
			+ 'img[contains(@class,"adventureDifficulty") and @class!="adventureDifficulty1"]'
			+ '/../..//td[@class="goTo"]/a[@class="gotoAdventure arrow" and contains(@href,"karte.php")]';
		var normalAdventures    = document.evaluate ( xpathNormalAdventures   , aElem, null, XPOrdList, null);
		var nonNormalAdventures = document.evaluate ( xpathNonNormalAdventures, aElem, null, XPOrdList, null);
		if ( normalAdventures.snapshotLength == 0 && nonNormalAdventures.snapshotLength == 0 ) { // no adventures available
			if ( mode == 0 ) {
				// delay by 3hrs +/- random ( 3hrs / 2 )
				var randTime = getRandomizedTime ( 3*60*60*1000, 3*60*60*1000, 1 );
				GM_setValue ( myacc() + "_heroNextTime", randTime.toString() );
				calldoing1();
				return;
			}
			else if ( mode == 1 ) { // for mode 1 do not delay next hero check if no adventures currently available
				return;
			}
		}

		var xpathToUse = "";
		var adventures = null;
		if ( normalAdventures.snapshotLength > 0 ) { // do normal adventures before non-normal ones
			xpathToUse = './/div[@id="content" and @class="hero_adventure"]//td[@class="difficulty"]/'
						+ 'img[contains(@class,"adventureDifficulty") and @class="adventureDifficulty1"]'
						+ '/../..//td[@class="moveTime"]';
			adventures = normalAdventures;
		}
		else {
			xpathToUse = './/div[@id="content" and @class="hero_adventure"]//td[@class="difficulty"]/'
						+ 'img[contains(@class,"adventureDifficulty") and @class!="adventureDifficulty1"]'
						+ '/../..//td[@class="moveTime"]';
			adventures = nonNormalAdventures;
		}
		var advDurations    = document.evaluate ( xpathToUse, aElem, null, XPOrdList, null);
		var minDurAdventure = 0;
		var minDuration = 365*24*60*60*1000; // interval equivalent to one year
		for ( var ctr = 0 ; ctr < adventures.snapshotLength ; ctr++ ) { // find min duration adventure
			var advDuraiton = getIntervalFromTimer ( advDurations.snapshotItem(ctr).innerHTML );
			flag ( "getAvailableAdventures():: ctr: " + ctr + ", advDuraiton: " + advDuraiton + ", adventure href: " + adventures.snapshotItem(ctr).getAttribute("href") );
			if ( minDuration > advDuraiton ) {
				minDuration = advDuraiton;
				minDurAdventure = ctr;
			}
		}

		if ( mode == 0 ) {
			var advHref = adventures.snapshotItem(minDurAdventure).getAttribute("href");
			if ( !advHref )
				throwLogicError ( "getAvailableAdventures():: Could not get hero adventure href!!" );
			if ( advHref.match(/\bnewdid=/) == null ) {
				if ( advHref.indexOf("?") == -1 )
					advHref = advHref + "?newdid=" + heroVillage;
				else
					advHref = advHref + "&newdid=" + heroVillage;
			}
			flag ( "getAvailableAdventures():: minDuration: " + minDuration + ", min duration adventure href: " + advHref );

			// everything seems okay, now adventure stage 1
			var randominter = Math.ceil ( Math.random() * 5*1000 + 1*1000 ); // random ( 5 sec ) + 1 sec
			window.setTimeout ( function() { 
							var url = advHref;
							TS_getRequest ( url, heroAdventureStage1, heroVillage, minDuration );
						},
						randominter );
		}
		else if ( mode == 1 ) {
			// delay by 5min +/- random ( 5min / 2 )
			var randTime = getRandomizedTime ( 5*60*1000, 5*60*1000, 1 );
			GM_setValue ( myacc() + "_heroNextTime", randTime.toString() );
		}

	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getAvailableAdventures():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function heroAdventureStage1( aElem, heroVillage, dur ) {
	try{
		flag ( "heroAdventureStage1():: Started!" );

		var xpath2ndStage = './/div[@id="content"]//div[@class="options"]/div[@class="option"]'
					+ '/a[@class="a arrow" and contains(@href,"a2b.php") and contains(@href,"id=") and contains(@href,"h=1")]';
		var hero2ndStage = document.evaluate ( xpath2ndStage, aElem, null, XPFirst, null).singleNodeValue;
		var hero2ndStageHref = "";
		if ( hero2ndStage ) {
			hero2ndStageHref = hero2ndStage.getAttribute("href");
		}
		else {
			throwLogicError ( "heroAdventureStage1():: Hero Adventure stage 1 url elem not found!!" );
		}
		if ( hero2ndStageHref == "" ) {
			throwLogicError ( "heroAdventureStage1():: Hero Adventure stage 1 url href not found!!" );
		}

		if ( hero2ndStageHref.match(/\bnewdid=/) == null ) {
			if ( hero2ndStageHref.indexOf("?") == -1 )
				hero2ndStageHref = hero2ndStageHref + "?newdid=" + heroVillage;
			else
				hero2ndStageHref = hero2ndStageHref + "&newdid=" + heroVillage;
		}
		flag ( "heroAdventureStage1():: hero2ndStageHref: " + hero2ndStageHref );

		// everything seems okay, now open adventure stage 2
		var randominter = Math.ceil ( Math.random() * 5*1000 + 1*1000 ); // random ( 5 sec ) + 1 sec
		window.setTimeout ( function() { 
						var url = hero2ndStageHref;
						TS_getRequest ( url, heroAdventureStage2, heroVillage, dur );
					},
					randominter );
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>heroAdventureStage1():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function heroAdventureStage2( aElem, heroVillage, dur ) {
	try {
		flag ( "heroAdventureStage2():: Started!" );

		var formCount = document.evaluate('.//form [ @action="a2b.php" and ( @method="POST" or @method="post" ) ]', aElem, null, XPSnap, null).snapshotLength;
		if ( formCount > 1 ) {
			var urlToHeroAdventures = "<a class='spantooltip' style='color: Green' href='"+
				myhost + "/hero_adventure.php'>Hero Adventures</a>";
			var msg = "heroAdventureStage2():: Some Problem, send hero for adventure once manually!";
			flag ( msg );
			playSound ( "<b>" + msg + " " + urlToHeroAdventures + "</b>" );

			// delay by 3hrs +/- random ( 3hrs / 2 )
			var randTime = getRandomizedTime ( 3*60*60*1000, 3*60*60*1000, 1 );
			GM_setValue ( myacc() + "_heroNextTime", randTime.toString() );
			calldoing1();
			return;
		}

		var xpathAHiddenValue = './/form[ @action="a2b.php" and ( @method="post" or @method="POST" ) ]/input[@name="a" and @type="hidden"]';
		var aHiddenValue = document.evaluate ( xpathAHiddenValue, aElem, null, XPFirst, null).singleNodeValue;
		if ( aHiddenValue ) {
			aHiddenValue = aHiddenValue.value;
		}
		else {
			throwLogicError ( "heroAdventureStage2():: Hero Adventure stage 2 parameter 'a' not found!!" );
		}

		var xpathKidHiddenValue = './/form[ @action="a2b.php" and ( @method="post" or @method="POST" ) ]/input[@name="kid" and @type="hidden"]';
		var kidHiddenValue = document.evaluate ( xpathKidHiddenValue, aElem, null, XPFirst, null).singleNodeValue;
		if ( kidHiddenValue ) {
			kidHiddenValue = kidHiddenValue.value;
		}
		else {
			throwLogicError ( "heroAdventureStage2():: Hero Adventure stage 2 parameter 'kid' not found!!" );
		}

		var xpathHHiddenValue = './/form[ @action="a2b.php" and ( @method="post" or @method="POST" ) ]/input[@name="h" and @type="hidden"]';
		var hHiddenValue = document.evaluate ( xpathHHiddenValue, aElem, null, XPFirst, null).singleNodeValue;
		if ( hHiddenValue ) {
			hHiddenValue = hHiddenValue.value;
		}
		else {
			throwLogicError ( "heroAdventureStage2():: Hero Adventure stage 2 parameter 'h' not found!!" );
		}

		var reqData = "a=" + aHiddenValue + "&kid=" + kidHiddenValue + "&h=" + hHiddenValue + "&h1=ok";
		var reqUrl = myhost + "/a2b.php?newdid=" + heroVillage;

		// everything seems okay, now finish sending adventure
		var randominter = Math.ceil ( Math.random() * 5*1000 + 1*1000 ); // random ( 5 sec ) + 1 sec
		window.setTimeout ( function() { 
						TS_postRequest ( reqUrl, reqData, finishSendHeroForAdventure, heroVillage, dur ); 
						reqUrl=null; reqData=null;
					},
					randominter );

	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>heroAdventureStage2():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function finishSendHeroForAdventure ( aElem, heroVillage, dur ) {
	try {
		flag ( "finishSendHeroForAdventure():: Started!" );

		// everything seems okay, now enable taskdoing for other tasks
		var randominter = Math.ceil ( Math.random() * 5*1000 + 1*1000 ); // random ( 5 sec ) + 1 sec
		window.setTimeout ( function() {
						printMSG ( aLangGameText[7] + " " + getvillagefromdid(heroVillage) + " (" + heroVillage + "): Hero sent for adventure!" );
						// delay by 2*dur + 5 mins +/- random ( dur )
						var randTime = getRandomizedTime ( 2*Number(dur) + 5*60*1000, 2*Number(dur), 1 );
						GM_setValue ( myacc() + "_heroNextTime", randTime.toString() );
						calldoing1();
						randTime = null;
					},
					randominter );
		return;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>finishSendHeroForAdventure():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function sendHeroForAdventure() {
	try {
		var url = myhost + "/hero_inventory.php";
		TS_getRequest ( url, getHeroHealthAndSpeedAndVillage );
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>sendHeroForAdventure():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function randomizeArray ( arr ) {
	try {
		if ( arr == null || arr == undefined || arr.length == 0 )
			return;
		for ( var itr = 0 ; itr < arr.length ; itr++ ) {
			var rndi = Math.floor ( Math.random() * arr.length );
			var temp = arr[rndi];
			arr[rndi] = arr[itr];
			arr[itr] = temp;
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>randomizeArray():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function eachTimedo() {
	try {
		ccclock = ccclock + Number(scriptRunIntervalRand);	// increment ccclock by scriptRunInterval milliseconds
		//checkForUserActivity += Number(scriptRunIntervalRand); 

		GM_setValue( myacc() + "_Timer_ccclock", ccclock );
		//GM_setValue( myacc() + "_Timer_checkForUserActivity", checkForUserActivity );

		// GotGs 2011.01.15 -- If there was user activity in onActivitySkipTime, then skip this run.
		/*if ( checkForUserActivity < 0 ) {
			printFooterMsg();
			return;
		}
		else {
			checkForUserActivity = 0;
			GM_setValue( myacc() + "_Timer_checkForUserActivity", checkForUserActivity );
			printFooterMsg();
		}*/
		printFooterMsg();

		// reload login window if pagefreshInterval has elapsed, this reload is required to collect necessary stats.
		if ( taskdoing == "1" && ccclock > Number(pagefreshInterval) ) {
			// delete _doing, it will be set on login window reload
			//GM_deleteValue(myacc() + "_doing");
			reloadLoginWindow();
			return; // one task at a time
		}
		else if ( taskdoing == "1" && checkSendHeroForAdventure() ) {
			calldoing0();
			sendHeroForAdventure();
			return; // one task at a time
		}
		else { // else execute tasks...
			var nowmillse = new Date(new Date().getTime() - serverTimeDiff).getTime();
			var villageList = getAllVillageNewdids().slice(0);
			randomizeArray ( villageList );
			for (v in villageList) {
				var whatever = GM_getValue(myacc() + "_" + villageList[v] + "_waitTask", "false");
				if ( whatever != "false" && taskdoing == "1" ) {

					// [ Resource & Building Upgrades / New Builds ]
					var buildLogic = GM_getValue ( myacc() + "_buildLogic", "0" );
					if ( buildLogic == "0" ) {
						if ( standardBuildLogic ( villageList[v], nowmillse ) == true )
							return; // one task at a time
					}
					else { // if ( buildLogic == "1" )
						if ( processBuildTasks ( villageList[v] ) )
							return; // one task at a time
					}

					var allTasks = whatever.split("|");

					var allTran = new Array();
					var allDemo = new Array();
					for (nnn in allTasks) {
						var thisTask = allTasks[nnn].split("_");
						allTasks[nnn] = thisTask;
						// [ Auto Transport ]
						if ( getVillageOption( "PAUSE_MARKET_TRANSFERS", 0, "integer", villageList[v] ) != 1 ) {
							if (thisTask[0] == "5") {
								allTran.push(thisTask);
							}
						}
						// [ Demolish Buildings ]
						if ( thisTask[0] == "7" ) {
							allDemo.push(thisTask);
						}
					}

					// [ Demolish Buildings ]
					var DemoT = GM_getValue ( myacc() + "_" + villageList[v] + "_demolishTime", "false" );
					if (DemoT != "false") {
						var remainTime4 = parseInt(DemoT) - nowmillse;
						if ( remainTime4 < 0 && taskdoing == "1" ) {
							//for (lk in allDemo) {
								//var mytask = allDemo[lk];
							if ( allDemo.length > 0 ) {
								var mytask = allDemo[0]; // only execute the 1st demo task
								calldoing0();
								startDemonow(villageList[v], mytask);
								return; // one task at a time
							}
						}
					}

					// [ Auto Transport ]
					if ( getVillageOption( "PAUSE_MARKET_TRANSFERS", 0, "integer", villageList[v] ) != 1 ) {
						if (allTran.length > 0) {
							var TranT = new Array();
							var TraningT = new Array();
							for (i in allTran) {
								//TS_debug("processing transport task for village " + villageList[v]);
								TranT[i] = GM_getValue(myacc() + "_" + villageList[v] + "_to_" + allTran[i][2]
										+ "_autoTransTime");

								TraningT[i] = GM_getValue(myacc() + "_" + villageList[v] + "_to_" + allTran[i][2]
										+ "_TraningTime", "1500000000000");

								// when a merchant has reached destination refresh resource values.
								if ((parseInt(TraningT[i]) - nowmillse) < 0 && taskdoing=="1") {
									calldoing0();
									ki = fleshTraning(villageList[v], allTran[i]);
									//TS_debug("here is eachTimedo(), return from Fleshtraning is " + ki);
									return; // one task at a time
								}

								// [ Auto Transport -- Construction Support / Resource Concentration ]
								if ((!TranT[i] ||(parseInt(TranT[i]) - nowmillse) < 0) && taskdoing=="1") {
									calldoing0();
									startTrannow(villageList[v], allTran[i]);
									return; // one task at a time
								}
							}
						}
					}
					/*else 
						TS_debug("eachTimedo():: All Market Transfers has been Paused hence pausing Auto Transport!");*/

					for (nnn in allTasks) {
						var thisTask = allTasks[nnn];
						// [ Train Troops ]
						if(thisTask[0] == "4"){
							if ( getVillageOption( "PAUSE_TROOPS_TRAINING", 0, "integer", villageList[v] ) != 1 ) {
								var TrainT = Number(thisTask[3]);
								var remainT = TrainT- nowmillse;
								if(remainT < 0 && taskdoing=="1"){
									calldoing0();
									startTrainNow(villageList[v],thisTask);
									return; // one task at a time
								}
							}
							/*else
								TS_debug("eachTimedo():: All Troops Training has been Paused!");*/
						}
						// [ Custom Transport ]
						else if(thisTask[0] == "8"){
							if ( getVillageOption( "PAUSE_MARKET_TRANSFERS", 0, "integer", villageList[v] ) != 1 ) {
								var customTransT = Number(thisTask[4]);
								var remainCu = customTransT - nowmillse;
								if(remainCu < 0 && taskdoing=="1"){
									calldoing0();
									startCustomTranNow(villageList[v], thisTask);
									return; // one task at a time
								}
							}
							/*else
								TS_debug("eachTimedo():: All Market Transfers has been Paused hence pausing Custom Transport!");*/
						}
						// [ Party Small / Big ]
						else if (thisTask[0] == "6"){
							if ( getVillageOption( "PAUSE_PARTYING", 0, "integer", villageList[v] ) != 1 ) {
								var partyT = Number(thisTask[3]);
								 // flag("Party !! = chaque timedo " + partyT);
								var remainPa = partyT - nowmillse;
								if(remainPa < 0 && taskdoing=="1"){
									calldoing0();
									startPartyNow(villageList[v], thisTask);
									return; // one task at a time
								}
							}
							/*else
								TS_debug("eachTimedo():: All Party has been Paused!");*/
						}
						// [ Blacksmith Improve Offense, Armoury Improve Defense ]
						else if (thisTask[0] == "3"){//3_kind_id_troop_SN_target//3_2_27_å¤ç½—é©¬æ­¥å…µ_1_11_1251616724168
							if ( getVillageOption( "PAUSE_TROOPS_UPGRADE", 0, "integer", villageList[v] ) != 1 ) {
								var improveT = Number(thisTask[6]);
								var remainIm = improveT - nowmillse;
								if(remainIm < 0 && taskdoing=="1"){
									calldoing0();
									startImproNow(villageList[v], thisTask);
									return; // one task at a time
								}
							}
							/*else
								TS_debug("eachTimedo():: All Troops Upgrade in Blacksmith & Armoury has been Paused!");*/
						}
					}

					for (nnn in allTasks) {
						var thisTask = allTasks[nnn];
						// used only in strict order 2
						var strictOrder2FirstVillageFound = false;
						// [ attack normal / raid, reinforce ]
						if(thisTask[0] == "2"){
							if ( getVillageOption ( "PAUSE_ALL_ATTACKS", 0, "integer", villageList[v] ) != 1 ) {
								if ( parseInt(thisTask[7]) > 0 
									&& getVillageOption ( "PAUSE_ALL_CATA_ATTACKS", 0, "integer", villageList[v] ) == 1 ) {
									continue;
								}
								// if strict order is disabled, do for all scheduled attacks
								if ( GM_getValue ( myacc() + "_attackStrictOrder", "0" ) == "0" ) {
									var attackT = Number(thisTask[4]);
									var remainA = attackT- nowmillse;
									if((remainA < 0) && (taskdoing=="1")){
										// check for enough troops using troops available in cookie
										if ( verifyEnoughTroopsForAttack(null, villageList[v], thisTask) ) {
											calldoing0();
											//startAttackNow(villageList[v],thisTask);
											sendRandomHttpBeforeAttack(villageList[v],thisTask);
											return; // one task at a time
										}
									}
								}
								// if strict attack order is 1
								else if ( GM_getValue ( myacc() + "_attackStrictOrder", "0" ) == "1" ) {
									if ( nnn == 0 ) { // do only for 1st scheduled attack task
										var attackT = Number(thisTask[4]);
										var remainA = attackT- nowmillse;
										if((remainA < 0) && (taskdoing=="1")){
											// check for enough troops using troops available in cookie
											if ( verifyEnoughTroopsForAttack(null, villageList[v], thisTask) ) {
												calldoing0();
												//startAttackNow(villageList[v],thisTask);
												sendRandomHttpBeforeAttack(villageList[v],thisTask);
												return; // one task at a time
											}
										}
									}
								}
								// if strict attack order is 2
								else if ( GM_getValue ( myacc() + "_attackStrictOrder", "0" ) == "2" ) {
									if ( strictOrder2FirstVillageFound == false ) {
										var attackT = Number(thisTask[4]);
										var remainA = attackT- nowmillse;
										if((remainA < 0) && (taskdoing=="1")){
											strictOrder2FirstVillageFound = true;
											// check for enough troops using troops available in cookie
											if ( verifyEnoughTroopsForAttack(null, villageList[v], thisTask) ) {
												calldoing0();
												//startAttackNow(villageList[v],thisTask);
												sendRandomHttpBeforeAttack(villageList[v],thisTask);
												return; // one task at a time
											}
										}
									}
								}
							}
							/*else 
								TS_debug ("eachTimedo():: All Attacks has been Paused!");*/
						}
					}
				}
			}
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>eachTimedo():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function checkCropWarehouseGranaryError( vill, errorType ) {
	try {
		//flag ( "checkCropWarehouseGranaryError():: Started!" );
		var nowt = new Date().getTime();
		var error = true;
		if ( GM_getValue(myacc() + "_" + vill + errorType, "0" ) == "1" ) {
			var elapseTime = parseInt( GM_getValue(myacc() + "_" + vill + errorType + "ElapseTime", "0" ) );
			if ( elapseTime != 0 ) { // if elapseTime == 0, then error resoulution task has been added at top but hasn't been executed
				if ( elapseTime > nowt )
					error = true;
				else {
					GM_setValue(myacc() + "_" + vill + errorType, "0" );
					GM_setValue(myacc() + "_" + vill + errorType + "ElapseTime", "0" );
					GM_deleteValue(myacc() + "_" + vill + errorType + "ElapseTime2" );
					error = false;
				}
			}
			else
				error = true;
			if ( error == true ) {
				var elapseTime2 = parseInt( GM_getValue(myacc() + "_" + vill + errorType + "ElapseTime2", "-1" ) );
				if ( elapseTime2 == -1 ) {
					GM_setValue(myacc() + "_" + vill + errorType + "ElapseTime2", nowt.toString() );
					//flag ( "checkCropWarehouseGranaryError():: elapseTime2 set to: " + new Date( nowt ).toString() );
				}
				else if ( ( elapseTime2 + 60*60*1000 ) < nowt ) { // if more than 1 hour elapsed since crop error detected
					GM_setValue(myacc() + "_" + vill + errorType, "0" );
					GM_setValue(myacc() + "_" + vill + errorType + "ElapseTime", "0" );
					GM_deleteValue(myacc() + "_" + vill + errorType + "ElapseTime2" );
					error = false;
				}
				//if ( elapseTime != -1 ) {
				//	flag ( "checkCropWarehouseGranaryError():: elapseTime2 : " + new Date( elapseTime2 ).toString() );
				//}
			}
		}
		else
			error = false;
		return error;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>checkCropWarehouseGranaryError():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function clearCropWarehouseGranaryError ( vill ) {
	GM_deleteValue(myacc() + "_" + vill + "_cropError" );
	GM_deleteValue(myacc() + "_" + vill + "_cropErrorElapseTime" );
	GM_deleteValue(myacc() + "_" + vill + "_cropErrorElapseTime2" );

	GM_deleteValue(myacc() + "_" + vill + "_warehouseError" );
	GM_deleteValue(myacc() + "_" + vill + "_warehouseErrorElapseTime" );
	GM_deleteValue(myacc() + "_" + vill + "_warehouseErrorElapseTime2" );

	GM_deleteValue(myacc() + "_" + vill + "_granaryError" );
	GM_deleteValue(myacc() + "_" + vill + "_granaryErrorElapseTime" );
	GM_deleteValue(myacc() + "_" + vill + "_granaryErrorElapseTime2" );
}

function standardBuildLogic ( vill, nowmillse ) {
	try {
		// this is required here for both romans and non-romans
		var cropError = checkCropWarehouseGranaryError ( vill, "_cropError" );
		var warehouseError = checkCropWarehouseGranaryError ( vill, "_warehouseError" );
		var granaryError = checkCropWarehouseGranaryError ( vill, "_granaryError" );

		var myRace = GM_getValue(myacc() + "_raceID");
		switch ( myRace ) {
		case "0": // romans
			// [Romans Resources] // do only if resource task exists
			if ( taskdoing == "1" && GM_getValue(myacc() + "_" + vill + "_ResourceTaskExists", "0") == "1" ) {
				if ( warehouseError == false && granaryError == false ) {
					var buildSlotFreeTime = GM_getValue(myacc() + "_" + vill + "_buildSlotResourceFreeTime", "0");	// get current build completion time
					var buildSlotFreeRemainTime = parseInt(buildSlotFreeTime) - nowmillse;
					var resT = GM_getValue(myacc() + "_" + vill + "_ResourceUpdataTime", "0");			// get next build avail time
					var remainTime1 = parseInt(resT) - nowmillse;
					var reqRes = GM_getValue ( myacc() + "_" + vill + "_resRequiredForResUpgrade", "0/0/0/0" );	// get resource required for next build
					var nowRes = GM_getValue ( myacc() + "_" + vill + "_ResourceNow", "0/0/0/0" );			// get resource now
					if ( buildSlotFreeRemainTime < 0 && // if build slot is free
						( remainTime1 < 0 || // if resource build available time elapsed
						  compareResources(reqRes, nowRes, 0.7) ) // or if reqRes < ( nowRes * 0.7 )
						) {
						return startBuildnow(vill, "0"); // one task at a time
					}
				}
			}
			// [Romans Buildings] // do only if building task exists
			if ( taskdoing == "1" && GM_getValue(myacc() + "_" + vill + "_BuildingTaskExists", "0") == "1" ) {
				if ( cropError == false ) {
					var buildSlotFreeTime = GM_getValue(myacc() + "_" + vill + "_buildSlotBuildingFreeTime", "0");	// get current build completion time
					var buildSlotFreeRemainTime = parseInt(buildSlotFreeTime) - nowmillse;
					var buiT = GM_getValue(myacc() + "_" + vill + "_BuildingUpdataTime", "0");			// get next build avail time
					var remainTime2 = parseInt(buiT) - nowmillse;
					var reqRes = GM_getValue ( myacc() + "_" + vill + "_resRequiredForBldgUpgrade", "0/0/0/0" );	// get resource required for next build
					var nowRes = GM_getValue ( myacc() + "_" + vill + "_ResourceNow", "0/0/0/0" );			// get resource now
					if ( buildSlotFreeRemainTime < 0 && // if build slot is free
						( remainTime2 < 0 || // if building build available time elapsed
						  compareResources(reqRes, nowRes, 0.7) ) // or if reqRes < ( nowRes * 0.7 )
						) {
						return startBuildnow(vill, "1"); // one task at a time
					}
				}
			}
			break;
		case "1": // non-romans
		case "2":
			// [Other Races Resources/Buildings] // do only if a task exists
			if ( taskdoing == "1" && GM_getValue(myacc() + "_" + vill + "_UpdataTaskExists", "0") == "1" ) {
				var buildSlotFreeTime = GM_getValue(myacc() + "_" + vill + "_buildSlotFreeTime", "0");			// get current build completion time
				//flag ( "standardBuildLogic():: buildSlotFreeTime: " + buildSlotFreeTime + ", " + new Date ( parseInt(buildSlotFreeTime) ).toString() );
				var buildSlotFreeRemainTime = parseInt(buildSlotFreeTime) - nowmillse;
				var upT = GM_getValue(myacc() + "_" + vill + "_UpdataTime", "0");					// get next build avail time
				//flag ( "standardBuildLogic():: upT: " + upT + ", " + new Date ( parseInt(upT) ).toString() );
				var remainTime3 = parseInt(upT) - nowmillse;
				var reqRes = GM_getValue ( myacc() + "_" + vill + "_resRequired", "0/0/0/0" );				// get resource required for next build
				//flag ( "standardBuildLogic():: reqRes: " + reqRes );
				var nowRes = GM_getValue ( myacc() + "_" + vill + "_ResourceNow", "0/0/0/0" );				// get resource now
				//flag ( "standardBuildLogic():: nowRes: " + nowRes );
				if ( buildSlotFreeRemainTime < 0 && // if build slot is free
					( remainTime3 < 0 || // if build available time elapsed
					  compareResources(reqRes, nowRes, 0.7) ) // or if reqRes < ( nowRes * 0.7 )
					) {
					return startBuildnow(vill, "2"); // one task at a time
				}
			}
			break;
		}
		return false;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>standardBuildLogic():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// returns true  if resa <  resb*factor
// returns false if resa >= resb*factor
function compareResources ( resa, resb, factor ) {
	if ( resa == null || resa == "" || resb == null || resb == "" ) {
		return true;
	}
	factor = ( factor == null || factor == "" ) ? factor = 0.7 : Number(factor); // factor default value is 0.7
	resa = resa.split("/");
	resb = resb.split("/");
	for ( var ctr = 0; ctr < resa.length ; ctr++ ) {
		if ( parseInt(resa[ctr]) >= (parseInt(resb[ctr])*factor) )
			return false;
	}
	return true;
}

// MUST DO: Always check for captcha whenever a http request is sent out.
function gatherStats(innerText) {
	try {

		//flag ( "gatherStats():: Started!" );
		var nowt = new Date();

		var captchaFound = false;
		var checkCaptcha = innerText.match(/http:\/\/.*\.recaptcha\.net/i);
		captchaFound = ( checkCaptcha && checkCaptcha.length > 0 ) ? true : false;
		if ( captchaFound ) {
			var msg = "gatherStats():: RECAPTCHA FOUND!!!:: " + checkCaptcha.join("\n") + "\nAuto Task Cannot Run!!"; 
			TS_debug ( msg );
			var errObj = new Error () ;
			errObj.name = "Captcha Found";
			errObj.message = msg;
			throw errObj;
			return true;
		}

		var aElem = document.createElement("div");
		aElem.innerHTML = innerText;

		if ( self.window.name == GM_getValue(currentServer() + '_loginWindow', "noLoginWindow") ) { // do only in login window
			// if response is login page then reload login window
			var loginButton = getLoginButton(aElem);
			if ( loginButton != null ) { // if login button exists reload login window
				// delete _doing, it will be set on login window reload
				GM_deleteValue(myacc() + "_doing");
				var reloadTime = Math.ceil ( Math.random() * 30*1000 + 30*1000 ); // random 0.5 mins + 0.5 mins
				window.setTimeout ( reloadLoginWindow, reloadTime );
				var errObj = new Error () ;
				errObj.name = "Login Page Found";
				errObj.message = "Login Page Found, reloading login window!";
				throw errObj;
			}
		}

		// since gatherStats is called each time when an http request is sent, it is the best place to check for mail, resource now etc
		if ( getuid() != null && Number ( GM_getValue(currentServer() + '_loginDetected',"0") ) == 0 ) {
			//flag ( "gatherStats():: getuid(): " + getuid() );

			if ( self.window.name == GM_getValue(currentServer() + '_loginWindow', "noLoginWindow") ) { // do only in login window
				checkMailAndPlayAlarm(innerText);
			}

			if ( self.window.name == GM_getValue(currentServer() + '_loginWindow', "noLoginWindow") ) { // do only in login window
				var nowt = new Date().getTime();
				var comingMidNight = new Date( 
							new Date(nowt).getFullYear(), 
							new Date(nowt).getMonth(), 
							new Date(nowt).getDate()+1, 
							0, 0, 0, 0 ).getTime();
				var intervalToMidNight =  comingMidNight - nowt;
				if ( Math.abs(intervalToMidNight) > 1*60*1000 ) { // do only if not 1 min around mid night
					var serverNowTime = document.evaluate('.//span[@id="tp1"]', aElem, null, XPFirst, null ).singleNodeValue;
					if ( serverNowTime != null ) {
						serverNowTime = getDateAndTimeFromText ( serverNowTime.innerHTML, 0 );
						if ( serverNowTime != null ) {
							serverTimeDiff = nowt - serverNowTime.getTime(); // desktop time - server time
							var allowedServerTimeDiff = Number ( GM_getValue ( currentServer() + "_allowedServerTimeDiff", "20" ) ) * 1000;
							if ( Math.abs(serverTimeDiff) > allowedServerTimeDiff ) { // something went wrong, time-diff more than 20 secs!
								var reloadTime = Math.ceil ( Math.random() * 30*1000 + 30*1000 ); // random 0.5 mins + 0.5 mins
								var errMsg = "<br/>Something went wrong, time difference between desktop & travian server larger than allowed ("
									+ GM_getValue ( currentServer() + "_allowedServerTimeDiff", "20" ) +") : "
									+ ( Math.round ( serverTimeDiff/1000 * 100 ) / 100 ) + " seconds"
									+ "<br/>Attempting to reload login window in " + ( Math.round ( reloadTime/(60*1000) * 100 ) / 100 ) + " mins";
								// delete _doing, it will be set on login window reload
								GM_deleteValue(myacc() + "_doing");
								window.setTimeout ( reloadLoginWindow, reloadTime );
								var errObj = new Error ( errMsg ) ;
								errObj.name = "Server Time Error";
								errObj.message = errMsg;
								throw errObj;
							}
							else {
								GM_setValue ( myacc() + "_serverTimeDiff", ( Math.round ( serverTimeDiff/1000 * 100 ) / 100 ).toString() + " secs" ); 
								/*var msg = "gatherStats():: Time difference between desktop & travian server: "
									+ ( Math.round ( serverTimeDiff/1000 * 100 ) / 100 ) + " seconds";
								printErrorMSG ( "<b>" + msg + "</b>" );*/
							}
						}
					}
				}
			}

			var villa = getVillageId(aElem);
			//flag ( "gatherStats():: villa: " + villa + ", villa name: " + getvillagefromdid(villa) );
			if ( villa ) {
				getResourceCap(aElem,villa);

				// check for warehouse & granary overflow, and upgrade warehouse/granary if not at max level
				var overFlowChkFlg = GM_getValue ( myacc() + "_" + villa + "_overFlowCheck", "1" );
				//flag ( "gatherStats():: overFlowChkFlg: " + overFlowChkFlg );
				if ( overFlowChkFlg == "1" ) {
					var cropError = checkCropWarehouseGranaryError ( villa, "_cropError" );
					if ( cropError == false ) {
						var resNow = GM_getValue ( myacc() + "_" + villa + "_ResourceNow", "" );
						//flag ( "gatherStats():: villa: " + villa + ", resNow: " + resNow );
						if ( resNow != "" ) {
							resNow = resNow.split("/");
							var wareCap = parseInt ( GM_getValue ( myacc() + "_" + villa + "_WarehouseCap", "0" ) );
							var granCap = parseInt ( GM_getValue ( myacc() + "_" + villa + "_GranaryCap", "0" ) );
							//flag ( "gatherStats():: villa: " + villa + ", wareCap: " + wareCap );
							//flag ( "gatherStats():: villa: " + villa + ", granCap: " + granCap );
							// check for crop overflow
							if ( resNow[3] > (granCap*0.9) ) {
								//printErrorMSG ( getvillagefromdid ( villa ) + " (" + villa + "): Crop overflow detected, adding granary upgrade task!" );
								var flg = addBuildingTaskAtTop(villa,11); // add granary upgrade task.
								/*if ( flg == false )
									printErrorMSG ( getvillagefromdid ( villa ) + " (" + villa + "): "
										+ "Could not add granary upgrade task, either granary at max level "
										+ "or is currently builing or no new building sites left!" );*/
							}
							// check for non-crop overflow
							for ( var ctr = 0 ; ctr < 3 ; ctr++ ) {
								if ( resNow[ctr] > (wareCap*0.9) ) {
									//printErrorMSG ( getvillagefromdid ( villa ) 
									//		+ " (" + villa + "): Non-crop overflow detected, adding warehouse upgrade task!" );
									var flg = addBuildingTaskAtTop(villa,10); // add warehouse upgrade task.
									/*if ( flg == false )
										printErrorMSG ( getvillagefromdid ( villa ) + " (" + villa + "): "
											+ "Could not add warehouse upgrade task, either warehouse at max level "
											+ "or is currently builing or no new building sites left!" );*/
									break;
								}
							}
						}
					}
				}
			}
		}

		return false;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>gatherStats():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function clearAvailTroopscount(vi) {
	 GM_setValue(myacc() + "_" + vi + "_troopsAvail", "");
	 GM_setValue(myacc() + "_" + vi + "_troopsCheckElapseTime", "");
}

function getAvailTroopsCountFromA2B(vi) {
	try {
		//flag ( "getAvailTroopsCountFromA2B():: Started!" );
		var troopArray = [ 0,0,0,0,0,0,0,0,0,0,0 ]; // troops currently available in village.
		var totalTroopsAvailable = 0;
		var gettroops = document.evaluate ( 'id("troops")//a[contains(@href,"#")]', document, null, XPSnap, null );
		//TS_debug ( "gettroops.snapshotLength: " + gettroops.snapshotLength );
		for (var i = 0 ; i < gettroops.snapshotLength; i++) {
			var snapShotItem = gettroops.snapshotItem(i);
			var troopno = snapShotItem.getAttribute('onclick');
			if ( troopno ) {
				troopno = parseInt(troopno.match(/\bt\d{1,}\b/)[0].match(/\d{1,}/)[0]) - 1;
				//troopno = troopno.split(".")[2];
				//troopno = troopno.split("t")[1];
				//troopno = parseInt(troopno) - 1;
			}
			var troopcount = gettroops.snapshotItem(i).innerHTML.match(/\d{1,}/);
			//flag ( "getAvailTroopsCountFromA2B():: troopcount: " + troopcount );
			troopArray[troopno] = troopcount.length > 0 ? parseInt(troopcount[0]) : 0 ;
			if ( troopcount ) {
				totalTroopsAvailable = parseInt(totalTroopsAvailable) + parseInt(troopcount);
			}
		}
		troopArray[10] = parseInt(troopArray[10]) > 0 ? troopArray[10] : 0 ; 
		if ( totalTroopsAvailable > 0 )
			GM_setValue(myacc() + "_" + vi + "_troopsAvail", troopArray.join("_") ); // update troops count in cookie	
		else
			GM_setValue(myacc() + "_" + vi + "_troopsAvail", "none" ); // update troops count in cookie

		/*var nowt = new Date().getTime();
		var troopsUpdateInterval = parseInt(GM_getValue(myacc() + "_troopsUpdateInterval", "60"));
		// random ( +/- 1 mins ) + troopsUpdateInterval mins
		var randominter=Math.ceil(Math.random()*2*60*1000 - 1*60*1000) + troopsUpdateInterval*60*1000;
		var elapseTime = nowt + randominter;
		GM_setValue(myacc() + "_" + vi + "_troopsCheckElapseTime", elapseTime.toString() );
		flag ("getAvailTroopsCountFromA2B():: Troops count refreshed, will refresh again in: " + milliSecondstoDHMS(randominter) );*/
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getAvailTroopsCountFromA2B():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// convert all anchors to include newdid
function convertAllAnchors() {
	try {
		var allAnchors = document.getElementsByTagName("a");
		//flag ( "convertAllAnchors():: allAnchors.length: " + allAnchors.length );
		for ( var ctr = 0 ; ctr < allAnchors.length ; ctr++ ) {
			if ( allAnchors[ctr].hostname == window.location.hostname && 
					allAnchors[ctr].href.indexOf("newdid") == -1 && 
					allAnchors[ctr].href.match("spieler.php?.*uid="+getuid()) == null && 
					allAnchors[ctr].href.indexOf("support.php") == -1 && 
					allAnchors[ctr].href.indexOf("#") == -1 &&
					allAnchors[ctr].href.match("javascript:") == null &&
					allAnchors[ctr].href.indexOf("login.php") == -1 && 
					allAnchors[ctr].href.indexOf("logout.php") == -1 ) {
				//flag ( "convertAllAnchors():: allAnchors[" + ctr + "]: " + allAnchors[ctr].href );
				if ( allAnchors[ctr].href.indexOf("?") > 0 ) {
					// adding newdid at end, causes problems with beyond market buy filters
					allAnchors[ctr].href = allAnchors[ctr].href + "&newdid=" + currentID();
					// TODO: adding at begining causes problems with analyze rally point, and anti-farm call-back
					//allAnchors[ctr].href = allAnchors[ctr].protocol + "//" + allAnchors[ctr].host
					//		+ allAnchors[ctr].pathname + "?newdid=" + currentID() + allAnchors[ctr].search.replace("?","&");
				}
				else
					allAnchors[ctr].href = allAnchors[ctr].href + "?newdid=" + currentID();
				//flag ( "convertAllAnchors():: allAnchors[" + ctr + "]: " + allAnchors[ctr].href );
			}
		}
		// TODO: conversion of areas in maps (karte.php) is not useful, as on mousehover, the original value is somehow refreshed which removes the added newdid.
		// Probably will need to find out a way to disable this automatic refresh on mousehover.
		var allAreas = document.getElementsByTagName("area");
		//flag ( "convertAllAnchors():: allAreas.length: " + allAreas.length );
		for ( var ctr = 0 ; ctr < allAreas.length ; ctr++ ) {
			if ( allAreas[ctr].hostname == window.location.hostname && 
					allAreas[ctr].href.indexOf("newdid") == -1 && 
					allAreas[ctr].href.match("spieler.php?.*uid="+getuid()) == null && 
					allAreas[ctr].href.indexOf("support.php") == -1 && 
					allAreas[ctr].href.indexOf("#") == -1 && 
					allAreas[ctr].href.match("javascript:") == null &&
					allAreas[ctr].href.indexOf("login.php") == -1 && 
					allAreas[ctr].href.indexOf("logout.php") == -1 ) {
				//flag ( "convertAllAnchors():: allAreas[" + ctr + "]: " + allAreas[ctr].href );
				if ( allAreas[ctr].href.indexOf("?") > 0 ) {
					// adding newdid at end, causes problems with beyond market buy filters
					allAreas[ctr].href = allAreas[ctr].href + "&newdid=" + currentID();
					// TODO: adding at begining causes problems with analyze rally point, and anti-farm call-back
					//allAreas[ctr].href = allAreas[ctr].protocol + "//" + allAreas[ctr].host
					//		+ allAreas[ctr].pathname + "?newdid=" + currentID() + allAreas[ctr].search.replace("?","&");
				}
				else
					allAreas[ctr].href = allAreas[ctr].href + "?newdid=" + currentID();
				//flag ( "convertAllAnchors():: allAreas[" + ctr + "]: " + allAreas[ctr].href );
			}
	}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>convertAllAnchors():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

var mapOurDivArray = new Array();
function handleMap() {
	try {
		//flag ( "handleMap():: Started!" );
		//flag ( "handleMap():: mapOurDivArray.length: " + mapOurDivArray.length );
		if ( mapOurDivArray.length > 0 ) {
			for ( var ctr = 0 ; ctr < mapOurDivArray.length ; ctr++ ) {
				//flag ( "handleMap():: mapOurDivArray Clearing, ctr: " + ctr + ", id: " + mapOurDivArray[ctr] );
				if ( $(mapOurDivArray[ctr]) != null ) {
					//flag ( "handleMap():: mapOurDivArray  $id: " + $(mapOurDivArray[ctr]).id );
					$(mapOurDivArray[ctr]).parentNode.removeChild($(mapOurDivArray[ctr]));
				}
			}
			mapOurDivArray = new Array();
		}
		//flag ( "handleMap():: mapOurDivArray Cleared!" );

		var xpathXCoords = 'id("map_rulers")//div[contains(@id,"mx")]';
		var xCoords = document.evaluate(xpathXCoords, document, null, XPList, null);
		var minx = 100000;
		var maxx = -100000;
		for ( var ctr = 0; ctr < xCoords.snapshotLength; ctr++ ) {
			if ( parseInt(xCoords.snapshotItem(ctr).innerHTML) < minx )
				minx = parseInt(xCoords.snapshotItem(ctr).innerHTML);
			if ( parseInt(xCoords.snapshotItem(ctr).innerHTML) > maxx )
				maxx = parseInt(xCoords.snapshotItem(ctr).innerHTML);
		}
		var xpathYCoords = 'id("map_rulers")//div[contains(@id,"my")]';
		var yCoords = document.evaluate(xpathYCoords, document, null, XPList, null);
		var miny = 100000;
		var maxy = -100000;
		for ( var ctr = 0; ctr < yCoords.snapshotLength; ctr++ ) {
			if ( parseInt(yCoords.snapshotItem(ctr).innerHTML) < miny )
				miny = parseInt(yCoords.snapshotItem(ctr).innerHTML);
			if ( parseInt(yCoords.snapshotItem(ctr).innerHTML) > maxy )
				maxy = parseInt(yCoords.snapshotItem(ctr).innerHTML);
		}

		var coordsInMap = "";
		for ( var ctr in getAllVillageNewdids() ) {
			var waittasks = GM_getValue(myacc() + "_" + getAllVillageNewdids()[ctr] + "_waitTask", "false");
			if ( waittasks == false )
				continue;
			waittasks = waittasks.split("|");
			for ( var itr in waittasks ) {
				task = waittasks[itr].split("_");
				if ( task[0] == "2" ) {
					var villaloc = task[1];
					var xvillaloc = getXfromCoord(villaloc);
					var yvillaloc = getYfromCoord(villaloc);
					if ( xvillaloc >= minx && xvillaloc <= maxx && yvillaloc >= miny && yvillaloc <= maxy ) {
						var coords = xvillaloc + "_" + yvillaloc + " " + getAllVillageNewdids()[ctr];
						if ( coordsInMap.indexOf(coords) == -1 )
							coordsInMap = coordsInMap == "" ? coords + ":1" : coordsInMap + "|" + coords + ":1";
						else {
							var whereToRemove = coordsInMap.indexOf(coords);
							var lenToRemove = coordsInMap.match(coords+':[0-9]{1,}')[0].length;
							var attkCnt = parseInt(coordsInMap.match(coords+':[0-9]{1,}')[0].split(":")[1]);
							var newArry = coordsInMap.split("");
							newArry.splice(whereToRemove, lenToRemove);
							coordsInMap = newArry.join("");
							coordsInMap = coordsInMap == "" ? coords + ":" + (attkCnt+1) : coordsInMap + "|" + coords + ":" + (attkCnt+1);
						}
					}
				}
			}
		}
		//flag ( "handleMap():: Farms in map: '" + coordsInMap + "'" );

		if ( coordsInMap != "" ) {
			coordsInMap = coordsInMap.split("|");
			//flag ( "handleMap():: coordsInMap.length: " + coordsInMap.length + ", coordsInMap.join(','): " + coordsInMap.join(',') );
			for ( var ctr in coordsInMap ) {
				if ( coordsInMap[ctr] != "" ) {
					var coords = coordsInMap[ctr].match("[-0-9]{1,}_[-0-9]{1,}")[0].split("_");
					var villa = coordsInMap[ctr].match(" [-0-9]{1,}:")[0].match("[-0-9]{1,}")[0];
					var attkCnt = coordsInMap[ctr].match(":[-0-9]{1,}")[0].match("[-0-9]{1,}")[0];
			
					//flag ( "handleMap():: ctr: " + ctr + ", coords: " + coords.join("|") + ", villa: " + villa + ", attkCnt: " + attkCnt );
					var mcoords = [ coords[0] - minx, coords[1] - miny ];
					//flag ( "handleMap():: ctr: " + ctr + ", mcoords: " + mcoords.join("|") );
			
					var mapDivContainer = $("i_"+mcoords[0]+"_"+mcoords[1]);
					var mapOurDiv = $("atmape_"+mcoords[0]+"_"+mcoords[1]);
					if ( mapOurDiv == null ) {
						mapOurDiv = document.createElement("div");
						mapOurDiv.id = "atmape_"+mcoords[0]+"_"+mcoords[1];
						mapDivContainer.appendChild(mapOurDiv);
						mapOurDivArray.push("atmape_"+mcoords[0]+"_"+mcoords[1]);
					}
					mapOurDiv.title = ( mapOurDiv.title == "" ) ? attkCnt : parseInt(mapOurDiv.title) + parseInt(attkCnt);
					mapOurDiv.innerHTML = "<div><img src='" + sDotImage + "' alt='F' /> " + mapOurDiv.title + "</div>";
					mapOurDiv.setAttribute("style", "position: absolute; height: 1px; width: 1px; left: 5px; top: 50px; "
							+ "z-index: 1000; border: 1px solid rgb(0, 192, 0); background-color: rgb(255, 255, 204); "
							+ "-moz-border-radius: 10px 10px 10px 10px; font-size: 50%;");
				}
			}
		}

		var mapInfoReloadInterval = GM_getValue(myacc() + "_mapInfoReCalculateInterval", "5000");
		window.setTimeout ( 
				function() { 
					handleMap();
					},
				parseInt(mapInfoReloadInterval) );
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>handleMap():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// displays beginner's protection time on villages
function handleBeginProtectionTimeDisplay() {
	try {
		if ( ( aTravianVersion == "3.6" && 
				window.location.href.indexOf("karte.php") != -1 &&
				window.location.href.match(/\bd=/) != null ) 
			|| 
			( aTravianVersion == "4.0" &&
			  	window.location.href.indexOf("position_details.php") != -1 &&
				window.location.href.match(/\bx=.*\by=/) != null )
			) { // karte.php with d parameter, ie when showing a village.
			var villageLocation = "";
			var beginProtectXpath = "";
			var sendMerchantXpath = "";
			switch ( aTravianVersion ) {
				case "3.6":
					villageLocation = window.location.href.match(/\bd=\d{1,}\b/)[0].split("=")[1];
					beginProtectXpath = 'id("mid")/div[@id="content"]/table[@id="options"]/tbody/tr[2]/td[@class="none" and @title!=""]';
					sendMerchantXpath = 'id("mid")/div[@id="content"]/table[@id="options"]/tbody/tr[3]/td';
					break;
				case "4.0":
					var xCoord = window.location.href.match(/\bx=[-0-9]{1,}/)[0].match(/[-0-9]{1,}/)[0];
					var yCoord = window.location.href.match(/\by=[-0-9]{1,}/)[0].match(/[-0-9]{1,}/)[0];
					villageLocation = getCoordfromXY(xCoord,yCoord);
					beginProtectXpath = 'id("mid")//div[@id="content"]//div[@class="options"]//span[@class="a arrow disabled"]';
					sendMerchantXpath = 'id("mid")//div[@id="content"]//div[@class="options"]/div[2]/span';
					break;
				default:
					throwLogicError ( "handleBeginProtectionTimeDisplay():: Travian Version not set!!" );
			}
			//flag ( "handleBeginProtectionTimeDisplay():: villageLocation: " + villageLocation );
			var beginnerProtection = document.evaluate(beginProtectXpath, document, null, XPFirst, null);
			var sendMerchantTr = document.evaluate(sendMerchantXpath, document, null, XPFirst, null);
			if ( beginnerProtection.singleNodeValue != null && sendMerchantTr != null ) { // found a village with beginner's protection...
				// find beginners protection time and store in cookie...
				var beginProtectTime = getDateAndTimeFromText ( beginnerProtection.singleNodeValue.getAttribute("title"), 1 );
				//flag ( "handleBeginProtectionTimeDisplay():: beginProtectTime: " + beginProtectTime );
				if ( beginProtectTime != null ) {
					var timeMilli = beginProtectTime.getTime();
					var randominter = Math.ceil ( Math.random() * 5*60*1000 ) + 2*60*1000; // random ( 5 mins ) + 2 mins
					var newTime = timeMilli + randominter;
					beginProtectTime.setTime(newTime);
					//flag ( "handleBeginProtectionTimeDisplay():: beginProtectTime: " + beginProtectTime );
					var beginProtectTimes = GM_getValue( myacc() + "_beginProtectTime", "" );
					if ( beginProtectTimes == "" ) {
						GM_setValue( myacc() + "_beginProtectTime", villageLocation + "_" + beginProtectTime.getTime() );
					}
					else {
						if ( beginProtectTimes.indexOf(villageLocation+"_") == -1 ) {
							var beginProtectTimesArray = beginProtectTimes.split("|");
							if ( beginProtectTimesArray.length >= 1000 ) {	// TODO: should parameterize this
								beginProtectTimesArray.shift(); // remove first element
								beginProtectTimes = beginProtectTimesArray.join("|");
							}
							GM_setValue( myacc() + "_beginProtectTime", 
								beginProtectTimes + "|" + villageLocation + "_" + beginProtectTime.getTime() );
						}
						else {
							var regex = new RegExp (villageLocation + "_[0-9]{1,}[|]*","");
							beginProtectTimes = beginProtectTimes.replace(regex,"");
							GM_setValue( myacc() + "_beginProtectTime", 
								beginProtectTimes + "|" + villageLocation + "_" + beginProtectTime.getTime() );
						}
					}

					//flag ( "handleBeginProtectionTimeDisplay():: text: " + beginnerProtection.singleNodeValue.innerHTML );
					beginnerProtection.singleNodeValue.innerHTML += "<span style='font-size: 80%;'><br/>Elapses @ " + beginProtectTime
						+ "</span>";
					//flag ( "handleBeginProtectionTimeDisplay():: text: " + beginnerProtection.singleNodeValue.innerHTML );

					// create schedule attack link...
					var attckAnchor = document.createElement("a");
					attckAnchor.id = "attackBeginnerProtectionLnk";
					attckAnchor.href="#";
					//attckAnchor.innerHTML = "&#160;"+aLangTaskOfText[19]+"&#160;";
					attckAnchor.innerHTML = "&#160;&#160;"+aLangTaskOfText[19]+"&#160;&#160;";
					attckAnchor.addEventListener("click", function() { 
							window.location.replace(myhost + "/a2b.php?z=" + villageLocation);
							villageLocation = null;
							return false;
						}, false);
					var attckTr = document.createElement("tr");
					var attckTd = document.createElement("td");
					attckTd.appendChild(attckAnchor);
					attckTr.appendChild(attckTd);
					beginnerProtection.singleNodeValue.parentNode.parentNode.appendChild(attckTr);
				}
			}
			else if ( sendMerchantTr != null ) { // a village (& not an oasis) with no beginner's protection.
				var beginProtectTimes = GM_getValue( myacc() + "_beginProtectTime", "" );
				if ( beginProtectTimes.indexOf ( villageLocation+"_" ) != -1 ) { // if village was under beginner's protection recently
					var regex = new RegExp (villageLocation + "_[0-9]{1,}","");
					var beginProtectTime = parseInt(beginProtectTimes.match(regex)[0].split("_")[1]);

					var sendAttackXpath = 'id("mid")/div[@id="content"]/table[@id="options"]/tbody/tr[2]/td';
					var sendAttackTd = document.evaluate(sendAttackXpath, document, null, XPFirst, null);
					if ( sendAttackTd == null ) {
						var msg = "handleBeginProtectionTimeDisplay():: Cannot find Attack Td on village page!"; 
						TS_debug ( msg );
						throwLogicError ( msg );
					}
					sendAttackTd.singleNodeValue.innerHTML += " BP Elasped "
						+ Math.round( ( new Date().getTime() - beginProtectTime ) / (60*60*1000) * 100 ) / 100 + " hours ago."
						+ "<br/> Elapsed @ " + new Date(beginProtectTime);
				}
			}
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>handleBeginProtectionTimeDisplay():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

/*function getPageHeading(aElem) {
	var pageHeading = document.evaluate( './/h1', aElem, null, XPFirst, null).singleNodeValue;
	if ( pageHeading )
		return stripHTML ( pageHeading.innerHTML );
	else
		return "";
}*/

function createCropFinderLink() {
	var parentElem = document.evaluate ( './/div[@id="content"]//table[@id="villages"]', document, null, 9, null).singleNodeValue;
	if ( parentElem ) {
		var cropFinderLink = document.createElement ( "a" );
		cropFinderLink.id = "cropFinderLink";
		cropFinderLink.href = "#";
		cropFinderLink.innerHTML = "&#160;&#160;" + "Crop Finder" + "&#160;&#160;";
		cropFinderLink.addEventListener("click", createCropFinderFloat, false);
		parentElem.parentNode.insertBefore(cropFinderLink, parentElem.previousSibling.previousSibling);
		var brElem1 = document.createElement("br");
		parentElem.parentNode.insertBefore(brElem1, parentElem.previousSibling.previousSibling);
		var brElem2 = document.createElement("br");
		parentElem.parentNode.insertBefore(brElem2, parentElem.previousSibling.previousSibling);
	}
}

function createCropFinderFloat() {
	var cropFinderElem = document.getElementById ( "crop_finder_wrapper" );
	if ( cropFinderElem == null ) {
		var cropFinderElem = document.createElement ( "div" );
		cropFinderElem.id = "crop_finder_wrapper";

		cropFinderElem.innerHTML =
			'<form id="crop_finder_form">'
				+ "<a href='#' onclick='document.body.removeChild($(\"crop_finder_wrapper\"));' class='floatClose'><img src='" + sCloseBtn + "' alt='X' /></a>"
				+ '<p>Crop Finder</p>'
				+ '<label> x: </label><input id="xInputCoord" name="xInputCoord" size="10" type="number" title="Enter a value betwen -400 & 400"/>'
				+ '<label> y: </label><input id="yInputCoord" name="yInputCoord" size="10" type="number" title="Enter a value between -400 & 400"/>'
				+ '<label> Max X/Y Distance: </label><input id="inputRadius" name="inputRadius" value="5" size="10" type="number" '
					+ 'title="Enter a value between 1 & 400"/>'
				+ '<input id="crop_finder_start" name="ok" type="button" value="Start" title="Click to start processing"/>'
				+ '<br/>'
				+ '<label> 9c: </label><input id="find_9c" name="find_9c" type="checkbox" title="Check to find 9c fields">'
				+ '<label> 15c: </label><input id="find_15c" name="find_15c" checked type="checkbox" title="Check to find 15c fields">'
				+ '<label> osases troops: </label><input id="find_oasis_troops" type="checkbox" title="Check to find all oases with there troops">'
				+ '<label> randomize: </label><input id="randomize_crop_finder" checked type="checkbox" title="Check to randomize crop finder">'
				+ '<br/>'
				+ '<input id="crop_finder_clear_fields_memory" name="clear_memory" type="button" value="Clear Map Memory" title="Click to clear memory of all fields"/>'
				+ '&nbsp;&nbsp;&nbsp' + '<input id="crop_finder_clear_oasis_troops_memory" name="clear_memory" type="button" value="Clear Oases Troops Memory" '
					+ 'title="Click to clear memory of all oases troops"/>'
				+ '<br/><br/>'
				+ '<label title="Number of all 9c & 15c fields found"> Fields Found: <span id="fields_found"></span></label>'
				+ '<label title="Number of all oases found"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Oases Found: <span id="oasis_found"></span></label>'
				+ '<label title="Number of all oases checked for troops"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Oases Troops Found: '
					+ '<span id="oasis_troops_found"></span></label>'
				+ '<br/>'
				+ '<div id="cropFinderResultsWrapper">'
					+ '<table><thead><tr><td>Type</td><td>Coords</td><td>Distance</td><td>Oasis Crop Bonus</td><td>Oasis List / Oasis Troops</td></tr>'
						+ '<tbody id="cropFinderResults"></tbody>'
					+ '</table>'
				+ '</div>'
			+ '</form>';

		var formCoords = getOption("CROP_FINDER_FORM_POSITION", "150px_150px");
		formCoords = formCoords.split("_");
		cropFinderElem.style.top = formCoords[0];
		cropFinderElem.style.left = formCoords[1];

		document.body.appendChild(cropFinderElem);
		makeDraggable($("crop_finder_form"));

		document.getElementById ( "crop_finder_start" ).addEventListener('click', cropFinderExecute, true);

		document.getElementById ( "crop_finder_clear_fields_memory" ).addEventListener('click', cropFinderClearFieldsMemory, true);
		if ( ! checkCropFinderFieldsMemoryExists() )
			document.getElementById("crop_finder_clear_fields_memory").disabled = true;

		document.getElementById ( "crop_finder_clear_oasis_troops_memory" ).addEventListener('click', cropFinderClearOasisTroopsMemory, true);
		if ( ! checkCropFinderOasisTroopsMemoryExists() )
			document.getElementById("crop_finder_clear_oasis_troops_memory").disabled = true;

		var mainVillageLoc = GM_getValue(myacc() + "_mainVillagePosition");
		document.getElementById("xInputCoord").value = getXfromCoord ( mainVillageLoc );
		document.getElementById("yInputCoord").value = getYfromCoord ( mainVillageLoc );


	}
}

function cropFinderClearFieldsMemory() {
	GM_deleteValue ( currentServer() + "_cropFinderMemory" );
	if ( document.getElementById("crop_finder_clear_fields_memory") != null )
		document.getElementById("crop_finder_clear_fields_memory").disabled = true;
}

function cropFinderClearOasisTroopsMemory() {
	GM_deleteValue ( currentServer() + "_oasisTroopsMemory" );
	if ( document.getElementById("crop_finder_clear_oasis_troops_memory") != null )
		document.getElementById("crop_finder_clear_oasis_troops_memory").disabled = true;
}

function checkCropFinderFieldsMemoryExists() {
	return ( GM_getValue ( currentServer() + "_cropFinderMemory", "false" ) != "false" );
}

function checkCropFinderOasisTroopsMemoryExists() {
	return ( GM_getValue ( currentServer() + "_oasisTroopsMemory", "false" ) != "false" );
}

function cropFinderExecute() {
	var origX = parseInt ( document.getElementById("xInputCoord").value );
	var origY = parseInt ( document.getElementById("yInputCoord").value );
	var radius = parseInt ( document.getElementById("inputRadius").value );
	if ( isNaN(origX) || isNaN(origY) || isNaN(radius) ) {
		alert ( "Error: Invalid value entered for coordinates or for max x/y distance! " );
		return;
	}
	var find9c = document.getElementById("find_9c").checked;
	find9c = ( find9c == true || find9c == "true" ) ? true : false;
	var find15c = document.getElementById("find_15c").checked;
	find15c = ( find15c == true || find15c == "true" ) ? true : false;
	var findOasisTroops = document.getElementById("find_oasis_troops").checked;
	findOasisTroops = ( findOasisTroops == true || findOasisTroops == "true" ) ? true : false;
	var randomizeCropFinder = document.getElementById("randomize_crop_finder").checked;
	randomizeCropFinder = ( randomizeCropFinder == true || randomizeCropFinder == "true" ) ? true : false;

	//flag ( "origX: " + origX + ", origY: " + origY + ", radius: " + radius + ", find9c: " + find9c + ", find15c: " + find15c + ", findOasisTroops: " + findOasisTroops );

	origX = normalizeCoord ( origX );
	origY = normalizeCoord ( origY );
	radius = ( radius % 401 );
	document.getElementById("xInputCoord").value = origX;
	document.getElementById("yInputCoord").value = origY;
	document.getElementById("inputRadius").value = radius; // max x or y coordinate diff for any two points on map is 400

	if ( ( find9c || find15c || findOasisTroops ) && ( radius != 0 ) ) {
		document.getElementById("xInputCoord").disabled = true;
		document.getElementById("yInputCoord").disabled = true;
		document.getElementById("inputRadius").disabled = true;
		document.getElementById("find_9c").disabled = true;
		document.getElementById("find_15c").disabled = true;
		document.getElementById("find_oasis_troops").disabled = true;
		document.getElementById("randomize_crop_finder").disabled = true;
		document.getElementById("crop_finder_start").disabled = true;
		document.getElementById("crop_finder_clear_fields_memory").disabled = true;
		document.getElementById("crop_finder_clear_oasis_troops_memory").disabled = true;

		document.getElementById ( "cropFinderResults" ).innerHTML = "";

		map9c = {};
		map15c = {};
		map50cropo = {};
		map25cropo = {};
		mapnoncropo = {};

		document.getElementById ( "fields_found" ).innerHTML = ( getObjectSize(map9c) + getObjectSize(map15c) ).toString() + " (Searching...)";
		document.getElementById ( "oasis_found" ).innerHTML = ( getObjectSize(map50cropo) + getObjectSize(map25cropo) + getObjectSize(mapnoncropo) ).toString()
			+ " (Searching...)";
		document.getElementById ( "oasis_troops_found" ).innerHTML = ( getObjectSize(map50cropo) + getObjectSize(map25cropo) + getObjectSize(mapnoncropo) ).toString()
			+ " (Searching...)";

		switch ( aTravianVersion ) {
			case "3.6":
				var fromx = parseInt(origX) - parseInt(radius) - 3;
				var fromy = parseInt(origY) - parseInt(radius) - 3;
				var tox = parseInt(origX) + parseInt(radius) + 3;
				var toy = parseInt(origY) + parseInt(radius) + 3;
				var coordList = [];
				// to iterate over map interval of 7x7
				// getCropInfoFromMap3() chaches data with key minx,miny
				var itrx = fromx, itry = fromy ;
				while ( true ) {
					coordList.push ( { xCoord: itrx, yCoord: itry } );
					if ( ( itrx + 6 ) < tox ) itrx += 7;
					else if ( ( itry + 6 ) < toy ) {
						itrx = fromx;
						itry += 7;
					}
					else
						break;
				}
				for ( var itr = 0 ; itr < coordList.length ; itr++ ) {
					coordList[itr].xCoord = normalizeCoord ( coordList[itr].xCoord );
					coordList[itr].yCoord = normalizeCoord ( coordList[itr].yCoord );
				}
				if ( randomizeCropFinder )
					randomizeArray ( coordList );
				getCropInfoFromMap3(coordList, 0, origX, origY, radius, find9c, find15c, findOasisTroops);
				break;
			case "4.0":
				var fromx = parseInt(origX) - parseInt(radius) - 3;
				var fromy = parseInt(origY) - parseInt(radius) - 3;
				var tox = parseInt(origX) + parseInt(radius) + 3;
				var toy = parseInt(origY) + parseInt(radius) + 3;
				var coordList = [];
				// to iterate over map interval of 21x17
				// getCropInfoFromMap4() chaches data with key minx+10,miny+10 (middle-most coordinate)
				var itrx = fromx, itry = fromy ;
				while ( true ) {
					coordList.push ( { xCoord: itrx+10, yCoord: itry+10 } );
					if ( ( itrx + 20 ) < tox ) itrx += 21;
					else if ( ( itry + 20 ) < toy ) {
						itrx = fromx;
						itry += 21;
					}
					else
						break;
				}
				for ( var itr = 0 ; itr < coordList.length ; itr++ ) {
					coordList[itr].xCoord = normalizeCoord ( coordList[itr].xCoord );
					coordList[itr].yCoord = normalizeCoord ( coordList[itr].yCoord );
				}
				if ( randomizeCropFinder )
					randomizeArray ( coordList );
				getCropInfoFromMap4(coordList, 0, origX, origY, radius, find9c, find15c, findOasisTroops);
				break;
			default: throwLogicError ( "cropFinderExecute():: Travian Version not set!!" );
		}
	}
	else {
		alert ( "Error: Select atleast one of 9c, 15c or oases troops and set max x/y distance to a value between 1 & 400!" );
		return;
	}
}

var map9c = {};
var map15c = {};
var map50cropo = {};
var map25cropo = {};
var mapnoncropo = {};

function getObjectSize ( obj ) {
	var size = 0, key;
	for ( key in obj ) {
		if ( obj.hasOwnProperty(key) ) size++;
	}
	return size;
}

/*************************************************************************
 * global variables specific to data memory
 */
var dataStoreDuration = 24*60*60*1000; // retain data for 24 hrs

/*************************************************************************
 * function to get data from memory
 */
function getDataFromMemory( gm_ck_name, key, clearOldData ) {
	try {
		//flag ( "getDataFromMemory():: Started! gm_ck_name: " + gm_ck_name + ", key: " + key );

		if ( key == "" || key == null || key == undefined )
			throwLogicError ( "getDataFromMemory():: Improper key for " + gm_ck_name + " !!" );

		if ( clearOldData == "" || clearOldData == null || clearOldData == undefined )
			clearOldData = false;

		// get the cookie data
		var gmMemory = GM_getValue ( currentServer() + "_" + gm_ck_name, "" );
		if ( gmMemory == "" )
			return false;
		try {
			gmMemory = JSON.parse(gmMemory);
		} 
		catch ( e ) {
			gmMemory = eval( "(" + gmMemory + ")" );
		}

		// remove all old data.
		if ( clearOldData ) {
			for ( var ikey in gmMemory ) {
				var mydata = gmMemory [ ikey ];
				if ( !mydata.time || mydata.time < ( new Date().getTime() - dataStoreDuration ) ) { // if data is old
					delete gmMemory [ ikey ];
				}
			}
		}

		// find relevant data
		var returnValue = false;
		var mydata = gmMemory [ key ];
		if ( mydata && mydata.key && mydata.key == key ) {
			returnValue = mydata.text;
			//flag ( "getDataFromMemory():: Data found in memory!" );
		}
		else {
			//flag ( "getDataFromMemory():: Data not found in memory!" );
		}

		// store back the cookie data
		try {
			GM_setValue ( currentServer() + "_" + gm_ck_name, JSON.stringify(gmMemory) );
		}
		catch (e){
			GM_setValue ( currentServer() + "_" + gm_ck_name, uneval(gmMemory) );
		}

		return returnValue;
	}
	catch ( err ) {
		printStackTrace();
		var msg = "getDataFromMemory():: Something went wrong, error: " + err.name + ", Error Message: " + err.message;
		playSound ( msg );
		throw err;
	}
}

/*************************************************************************
 * function to put data into memory
 */
function setDataToMemory( gm_ck_name, key, data, clearOldData ) {
	try {
		//flag ( "setDataToMemory():: Started! gm_ck_name: " + gm_ck_name + ", key: " + key );

		if ( key == "" || key == null || key == undefined )
			throwLogicError ( "setDataToMemory():: Improper key for " + gm_ck_name + " !! data: " + data );

		// get the cookie data
		var gmMemory = GM_getValue ( currentServer() + "_" + gm_ck_name, "" );
		if ( gmMemory == "" )
			gmMemory = {};
		else {
			try {
				gmMemory = JSON.parse(gmMemory);
			} 
			catch ( e ) {
				gmMemory = eval( "(" + gmMemory + ")" );
			}
		}

		// remove all old data.
		if ( clearOldData ) {
			for ( var ikey in gmMemory ) {
				var mydata = gmMemory [ ikey ];
				if ( !mydata.time || mydata.time < ( new Date().getTime() - dataStoreDuration ) ) { // if data is old
					delete gmMemory [ ikey ];
				}
			}
		}

		// insert data.
		var mydata = {};
		mydata.key = key;
		mydata.time = new Date().getTime();
		mydata.text = data;
		gmMemory [ key ] = mydata;

		// store back the cookie data
		try {
			GM_setValue ( currentServer() + "_" + gm_ck_name, JSON.stringify(gmMemory) );
		}
		catch (e){
			GM_setValue ( currentServer() + "_" + gm_ck_name, uneval(gmMemory) );
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "setDataToMemory():: Something went wrong, error: " + err.name + ", Error Message: " + err.message;
		playSound ( msg );
		throw err;
	}
}

function processCropInfoMapData3 ( data, coordList, coordListIterator, origX, origY, radius, find9c, find15c, findOasisTroops ) {
	try {
		//flag ( "processCropInfoMapData3():: coordList.length: " + coordList.length + ", coordListIterator: " + coordListIterator + ", find15c: " + find15c );

		data = "(" + data + ")";
		try { data = JSON.parse(data); } catch(e) { data = eval(data); }
		for ( var dtr in data ) {
			var data2 = data[dtr];
			for ( var dtr2 in data2 ) {
				var obj = data2[dtr2];
				//flag ( "processCropInfoMapData3():: obj: " + obj );
				var map = null;
				var etype = "";
				var ourl = "";
				if ( find9c == true && obj[2] == 1 ) { // 9c
					map = map9c; etype = "9c";
				}
				else if ( find15c == true && obj[2] == 6 ) { // 15c
					map = map15c; etype = "15c";
				}
				else if ( obj[2] == 0 && obj[5].match(/\bo12/i) != null ) { // 50% crop oasis
					map = map50cropo; etype = "50cropo"; ourl = obj[4];
				}
				else if ( obj[2] == 0 && obj[5].match(/\bo10\b|\bo3\b|\bo9\b|\bo11\b|\bo6\b/i) != null ) { // 25% crop oasis
					map = map25cropo; etype = "25cropo"; ourl = obj[4];
				}
				else if ( obj[2] == 0 && obj[5].match(/\bo[0-9]{1,}\b/i) != null ) { // non-crop oasis
					map = mapnoncropo; etype = "noncropo"; ourl = obj[4];
				}
				var xCoord = obj[0];
				var yCoord = obj[1];
				if ( map != null ) {
					var coord = xCoord + "|" + yCoord;
					if ( ! map [ coord ] ) {
						if ( etype == "9c" || etype == "15c" ) {
							if ( getCoordDiff ( origX, xCoord ) <= radius && getCoordDiff ( origY, yCoord ) <= radius )
								map [ coord ] =  { type: etype, xcoord: xCoord, ycoord: yCoord };
						}
						else {
							if ( getCoordDiff ( origX, xCoord ) <= ( radius + 3 ) && getCoordDiff ( origY, yCoord ) <= ( radius + 3 ) )
								map [ coord ] =  { type: etype, xcoord: xCoord, ycoord: yCoord, url: ourl };
						}
					}
				}
			}
		}
		document.getElementById ( "fields_found" ).innerHTML = ( getObjectSize(map9c) + getObjectSize(map15c) ).toString() + " (Searching...)";
		document.getElementById ( "oasis_found" ).innerHTML = ( getObjectSize(map50cropo) + getObjectSize(map25cropo) + getObjectSize(mapnoncropo) ).toString()
			+ " (Searching...)";

		getCropInfoFromMap3( coordList, ++coordListIterator, origX, origY, radius, find9c, find15c, findOasisTroops ); // recursively iterate over coordList
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>processCropInfoMapData3():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function makeHttpReqForCropInfoFromMap3 ( coordList, coordListIterator, origX, origY, radius, find9c, find15c, findOasisTroops ) {
	try {
		function callback() {};

		var x = coordList[coordListIterator].xCoord;
		var y = coordList[coordListIterator].yCoord;

		// normalization of (x+6) & (y+6) is not required here
		var turl = myhost + "/ajax.php?f=k7" + "&xx=" + x + "&yy=" + y + "&x=" + ( x + 6 ) + "&y=" + ( y + 6 ); // from xx,yy to x,y
		//flag ( "makeHttpReqForCropInfoFromMap3():: turl: " + turl );

		var xmlHttpReqObj = new XMLHttpRequest();
		xmlHttpReqObj.open('GET', turl, false);
		xmlHttpReqObj.onreadystatechange = callback;
		xmlHttpReqObj.send(null);
		function callback() {
			if (xmlHttpReqObj.readyState == 4) {
				if (xmlHttpReqObj.status == 200) {
					//flag ( "makeHttpReqForCropInfoFromMap3():: callback Started!" );

					var data = xmlHttpReqObj.responseText;
					//flag ( "makeHttpReqForCropInfoFromMap3():: data: " + data );
					setDataToMemory( "cropFinderMemory", x + "|" + y, data, false );
					processCropInfoMapData3 ( data, coordList, coordListIterator, origX, origY, radius, find9c, find15c, findOasisTroops );
				}
			}
		}
		return callback();
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>makeHttpReqForCropInfoFromMap3():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getCropInfoFromMap3 ( coordList, coordListIterator, origX, origY, radius, find9c, find15c, findOasisTroops ) { // recursively iterate over coordList
	try {
		//flag ( "getCropInfoFromMap3():: coordList.length: " + coordList.length + ", coordListIterator: " + coordListIterator );

		if ( coordListIterator >= coordList.length ) { // end recursion
			endCropFinderProcessing(origX, origY, findOasisTroops, radius);
			return;
			//flag ( "getCropInfoFromMap3():: Done!" );
		}

		/*flag ( "getCropInfoFromMap3() Started! x: " + x + ", y: " + y + ", tox: " + tox + ", toy: " + toy 
				+ ", origX: " + origX + ", origY: " + origY + ", radius: " + radius + ", find9c: " +
				find9c + ", find15c: " + find15c  + ", findOasisTroops: " + findOasisTroops );*/

		if ( $("crop_finder_wrapper") == null ) // do only if crop finder interface is open
			return;

		var x = coordList[coordListIterator].xCoord;
		var y = coordList[coordListIterator].yCoord;

		var data = getDataFromMemory( "cropFinderMemory", x + "|" + y, false );
		if ( data ) {
			processCropInfoMapData3(data, coordList, coordListIterator, origX, origY, radius, find9c, find15c, findOasisTroops);
		}
		else {
			var waitInterval = 5*1000 + Math.ceil ( Math.random() * 4*1000 - 2*1000); // 5 secs +/- random 2 secs
			window.setTimeout ( function() {
						makeHttpReqForCropInfoFromMap3 ( coordList, coordListIterator, origX, origY, radius, find9c, find15c, findOasisTroops );
						coordList = null; coordListIterator = null; origX = null; origY = null; radius = null;
						find9c = null, find15c = null; findOasisTroops = null;
						}
				, waitInterval );
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getCropInfoFromMap3():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function processCropInfoMapData4 ( data, coordList, coordListIterator, origX, origY, radius, find9c, find15c, findOasisTroops ) {
	try {
		//flag ( "processCropInfoMapData4():: data: " + data );

		data = "(" + data + ")";
		try { data = JSON.parse(data); } catch(e) { data = eval(data); }
		for ( var dtr in data.data.tiles ) {
			var obj = data.data.tiles[dtr];
			if ( ( typeof obj.c != 'undefined' ) && ( typeof obj.t != 'undefined' ) ) {
				var map = null;
				var etype = "";
				if ( find9c == true && obj.c.match(/\{k\.f1\}/) != null ) { // 9c
					map = map9c; etype = "9c";
				}
				else if ( find15c == true && obj.c.match(/\{k\.f6\}/) != null ) { // 15c
					map = map15c; etype = "15c";
				}
				else if ( obj.t.match(/\{a\.r4\}\s*50%/) != null ) { // 50% crop oasis
					map = map50cropo; etype = "50cropo";
				}
				else if ( obj.t.match(/\{a\.r4\}\s*25%/) != null ) { // 25% crop oasis
					map = map25cropo; etype = "25cropo";
				}
				else if ( findOasisTroops && obj.t.match(/\{a\.r[1-3]\}\s*25%/) != null ) { // non-crop oasis
					map = mapnoncropo; etype = "noncropo";
				}
				/*var divElem = document.createElement ( "div" );
				divElem.innerHTML = obj.t;
				var xCoord = document.evaluate ( './/span[@class="cox" or @class="xCoord" or @class="coordinateX"]',
						divElem, null, XPFirst, null).singleNodeValue.innerHTML.match(/[-0-9]{1,}/);
				var yCoord = document.evaluate ( './/span[@class="coy" or @class="yCoord" or @class="coordinateY"]',
						divElem, null, XPFirst, null).singleNodeValue.innerHTML.match(/[-0-9]{1,}/);*/
				var xCoord = parseInt ( obj.x );
				var yCoord = parseInt ( obj.y );
				if ( map != null ) {
					var coord = xCoord + "|" + yCoord;
					if ( ! map [ coord ] ) {
						if ( etype == "9c" || etype == "15c" ) {
							if ( getCoordDiff ( origX, xCoord ) <= radius && getCoordDiff ( origY, yCoord ) <= radius )
								map [ coord ] =  { type: etype, xcoord: xCoord, ycoord: yCoord };
						}
						else {
							if ( getCoordDiff ( origX, xCoord ) <= ( radius + 3 ) && getCoordDiff ( origY, yCoord ) <= ( radius + 3 ) )
								map [ coord ] =  { type: etype, xcoord: xCoord, ycoord: yCoord };
						}
					}
				}
			}
		}
		document.getElementById ( "fields_found" ).innerHTML = ( getObjectSize(map9c) + getObjectSize(map15c) ).toString() + " (Searching...)";
		document.getElementById ( "oasis_found" ).innerHTML = ( getObjectSize(map50cropo) + getObjectSize(map25cropo) + getObjectSize(mapnoncropo) ).toString()
			+ " (Searching...)";

		getCropInfoFromMap4( coordList, ++coordListIterator, origX, origY, radius, find9c, find15c, findOasisTroops ); // recursively iterate over coordList
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>processCropInfoMapData4():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function makeHttpReqForCropInfoFromMap4 ( coordList, coordListIterator, origX, origY, radius, find9c, find15c, findOasisTroops ) {
	try {
		function callback() {};

		var x = coordList[coordListIterator].xCoord;
		var y = coordList[coordListIterator].yCoord;

		var turl = myhost + "/ajax.php?cmd=mapPositionData&data[x]=" + x + "&data[y]=" + y + "&data[zoomLevel]=2&";
		//flag ( "makeHttpReqForCropInfoFromMap4():: turl: " + turl );

		var xmlHttpReqObj = new XMLHttpRequest();
		xmlHttpReqObj.open('GET', turl, false);
		xmlHttpReqObj.onreadystatechange = callback;
		xmlHttpReqObj.send(null);
		function callback() {
			if (xmlHttpReqObj.readyState == 4) {
				if (xmlHttpReqObj.status == 200) {
					//flag ( "makeHttpReqForCropInfoFromMap4():: callback Started!" );

					var data = xmlHttpReqObj.responseText;
					setDataToMemory( "cropFinderMemory", x + "|" + y, data, false );
					processCropInfoMapData4 ( data, coordList, coordListIterator, origX, origY, radius, find9c, find15c, findOasisTroops );
				}
			}
		}
		return callback();
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>makeHttpReqForCropInfoFromMap4():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getCropInfoFromMap4 ( coordList, coordListIterator, origX, origY, radius, find9c, find15c, findOasisTroops ) {  // recursively iterate over coordList
	try {
		//flag ( "getCropInfoFromMap4():: coordList.length: " + coordList.length + ", coordListIterator: " + coordListIterator );

		if ( coordListIterator >= coordList.length ) { // end recursion
			endCropFinderProcessing(origX, origY, findOasisTroops, radius);
			return;
			//flag ( "getCropInfoFromMap4():: Done!" );
		}

		/*flag ( "getCropInfoFromMap4() Started! x: " + x + ", y: " + y + ", tox: " + tox + ", toy: " + toy 
				+ ", origX: " + origX + ", origY: " + origY + ", radius: " + radius + ", find9c: " +
				find9c + ", find15c: " + find15c + ", findOasisTroops: " + findOasisTroops );*/

		if ( $("crop_finder_wrapper") == null ) // do only if crop finder interface is open
			return;

		var x = coordList[coordListIterator].xCoord;
		var y = coordList[coordListIterator].yCoord;

		var data = getDataFromMemory( "cropFinderMemory", x + "|" + y, false );
		if ( data ) {
			processCropInfoMapData4 ( data, coordList, coordListIterator, origX, origY, radius, find9c, find15c, findOasisTroops );
		}
		else {
			var waitInterval = 5*1000 + Math.ceil ( Math.random() * 4*1000 - 2*1000); // 5 secs +/- random 2 secs
			window.setTimeout ( function() {
						makeHttpReqForCropInfoFromMap4 ( coordList, coordListIterator, origX, origY, radius, find9c, find15c, findOasisTroops );
						coordList = null; coordListIterator = null; origX = null; origY = null; radius = null;
						find9c = null, find15c = null; findOasisTroops = null;
						}
				, waitInterval );
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getCropInfoFromMap4():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function endCropFinderProcessing(origX, origY, findOasisTroops, radius) {
	try {
		flag ( "endCropFinderProcessing():: started!" );

		document.getElementById ( "fields_found" ).innerHTML = getObjectSize(map9c) + getObjectSize(map15c);
		document.getElementById ( "oasis_found" ).innerHTML = getObjectSize(map50cropo) + getObjectSize(map25cropo) + getObjectSize(mapnoncropo);
		var allfields = [];
		var alloasis = [];

		for ( var coord in map9c ) {
			var e = map9c [ coord ];
			if ( !e.distance ) {
				e.distance = getDistance ( origX, origY, e.xcoord, e.ycoord );
			}
			allfields.push(e);
		}
		for ( var coord in map15c ) {
			var e = map15c [ coord ];
			if ( !e.distance ) {
				e.distance = getDistance ( origX, origY, e.xcoord, e.ycoord );
			}	
			allfields.push(e);
		}
		if ( findOasisTroops ) {
			for ( var coord in map50cropo ) {
				var e = map50cropo [ coord ];
				if ( !e.distance ) {
					e.distance = getDistance ( origX, origY, e.xcoord, e.ycoord );
				}
				allfields.push(e);
			}
			for ( var coord in map25cropo ) {
				var e = map25cropo [ coord ];
				if ( !e.distance ) {
					e.distance = getDistance ( origX, origY, e.xcoord, e.ycoord );
				}
				allfields.push(e);
			}
			for ( var coord in mapnoncropo ) {
				var e = mapnoncropo [ coord ];
				if ( !e.distance ) {
					e.distance = getDistance ( origX, origY, e.xcoord, e.ycoord );
				}
				allfields.push(e);
			}
		}

		function sortFun(a,b) { 
			return ( a.distance - b.distance );
		}
		allfields.sort ( sortFun );
		//flag ( "allfields.length: " + allfields.length );

		for ( var itr = 0 ; itr < allfields.length ; itr++ ) {
			var e = allfields [ itr ];
			if ( e.type == "9c" || e.type == "15c" ) { // if 9c or 15 crop field
				e.oasis = 0;
				e.oasisList = [];
				for ( var coord in map50cropo ) {
					var o = map50cropo [ coord ];
					if ( getCoordDiff ( e.xcoord, o.xcoord ) <= 3 && getCoordDiff ( e.ycoord, o.ycoord ) <= 3 ) {
						if ( e.oasisList.length < 3 )
							e.oasis += 50;
						e.oasisList.push ( { key: coord, xcoord: o.xcoord, ycoord: o.ycoord } );
					}
				}
				for ( var coord in map25cropo ) {
					var o = map25cropo [ coord ];
					if ( getCoordDiff ( e.xcoord, o.xcoord ) <= 3 && getCoordDiff ( e.ycoord, o.ycoord ) <= 3 ) {
						if ( e.oasisList.length < 3 )
							e.oasis += 25;
						e.oasisList.push ( { key: coord, xcoord: o.xcoord, ycoord: o.ycoord } );
					}
				}
			}
			else { // if oasis
				alloasis.push(e);
			}
		}

		/*flag ( "endCropFinderProcessing():: map15c.length: " + getObjectSize(map15c) + ", map9c.length: " + getObjectSize(map9c)
				+ ", map50cropo.length: " + getObjectSize(map50cropo)
				+ ", map25cropo.length: " + getObjectSize(map25cropo)
				+ ", mapnoncropo.length: " + getObjectSize(mapnoncropo) );
		flag ( "endCropFinderProcessing():: allfields.length: " + allfields.length + ", alloasis.length: " + alloasis.length );*/
		randomizeArray ( alloasis );
		findAllOasisTroops ( allfields, alloasis, 0 );

	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>endCropFinderProcessing():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function findAllOasisTroops ( allfields, alloasis, ctr ) { // recursive iteration of ctr from 0 to alloasis.length-1
	try {
		if ( ctr >= alloasis.length ) {
			document.getElementById ( "oasis_troops_found" ).innerHTML = ctr;
			displayCropFinderInfo ( allfields );
		}
		else {
			var data = getDataFromMemory ( "oasisTroopsMemory", alloasis[ctr].xcoord + "|" + alloasis[ctr].ycoord, false );
			if ( data ) {
				//flag ( "findAllOasisTroops():: Data found for oasis at: " + alloasis[ctr].xcoord + "|" + alloasis[ctr].ycoord );
				getOasisTroopsFromData ( allfields, alloasis, ctr, data );
			}
			else {
				//flag ( "findAllOasisTroops():: Data not found for oasis at: " + alloasis[ctr].xcoord + "|" + alloasis[ctr].ycoord );
				var waitInterval = 5*1000 + Math.ceil ( Math.random() * 4*1000 - 2*1000); // 5 secs +/- random 2 secs
				window.setTimeout ( function() {
							getOasisTroopsFromServer ( allfields, alloasis, ctr );
							allfields = null;  alloasis = null; ctr = null;
							}
					, waitInterval );
			}
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>findAllOasisTroops():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getOasisTroopsFromData ( allfields, alloasis, ctr, responseText ) {
	try {
		var aElem = document.createElement("div");
		aElem.innerHTML = responseText;

		var xpathTroopInfo = "";
		switch ( aTravianVersion ) {
			case "3.6":
				xpathTroopInfo = './/div[@id="content"]/div[@id="map_details"]/table[@id="troop_info"][1]/tbody/tr';
				break;
			case "4.0":
				xpathTroopInfo = './/div[@id="content"]/div[@id="tileDetails"]/div[@id="map_details"]/table[@id="troop_info"][1]/tbody/tr';
				break;
			default:
				throwLogicError ( "getOasisTroopsFromData():: Travian Version not set!!" );
		}

		var troopInfos = document.evaluate ( xpathTroopInfo, aElem, null, XPOrdList, null );
		var troops = [];
		for ( var itr = 0 ; itr < troopInfos.snapshotLength ; itr++ ) {
			var troopCount = document.evaluate ( './td[@class="val"]', troopInfos.snapshotItem(itr), null, XPFirst, null).singleNodeValue;
			if ( troopCount ) {
				troopCount = troopCount.innerHTML.match ( /[0-9]{1,}/ );
				var troopType = document.evaluate ( './td[@class="ico"]', troopInfos.snapshotItem(itr), null, XPFirst, null)
					.singleNodeValue.innerHTML;
				troops.push( { count: troopCount, type: troopType } );
			}
		}
		alloasis[ctr].troops = troops;
		document.getElementById ( "oasis_troops_found" ).innerHTML = ctr + " (Searching...)";

		findAllOasisTroops ( allfields, alloasis, ++ctr );
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getOasisTroopsFromData():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getOasisTroopsFromServer ( allfields, alloasis, ctr ) {
	try {
		function callback() {};

		var turl = "";
		switch ( aTravianVersion ) {
			case "3.6": turl = myhost + "/karte.php?" + alloasis[ctr].url; break;
			case "4.0": turl = myhost + "/position_details.php?x=" + alloasis[ctr].xcoord + "&y=" + alloasis[ctr].ycoord; break;
			default: throwLogicError ( "getOasisTroopsFromServer():: Travian Version not set!!" );
		}

		var httpReqObj = new XMLHttpRequest();
		httpReqObj.open('GET', turl, false);
		httpReqObj.onreadystatechange = callback;
		httpReqObj.send(null);
		function callback() {
			if (httpReqObj.readyState == 4) {
				if (httpReqObj.status == 200) {
					//flag ( "getOasisTroopsFromServer():: callback Started!" );
					setDataToMemory ( "oasisTroopsMemory", alloasis[ctr].xcoord + "|" + alloasis[ctr].ycoord, httpReqObj.responseText, false );
					getOasisTroopsFromData ( allfields, alloasis, ctr, httpReqObj.responseText );
				}
			}
		}
		return callback();
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getOasisTroopsFromServer():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function displayCropFinderInfo ( allfields ) {
	try {
		flag ( "displayCropFinderInfo():: Started!" );

		var cropFinderResultsElem = document.getElementById ( "cropFinderResults" );
		if ( cropFinderResultsElem != null ) {
			for ( var itr = 0 ; itr < allfields.length ; itr++ ) {
				var e = allfields[itr];
				var elemId = e.xcoord+"|"+e.ycoord;
				var divElem = document.createElement ( "tr" );
				divElem.id = elemId;
				var td1 = document.createElement ( "td" );
				if ( e.type == "9c" || e.type == "15c" ) {
					td1.innerHTML = e.type;
				}
				else
					td1.innerHTML = "oasis";
				divElem.appendChild ( td1 );
				var td2 = document.createElement ( "td" );
				switch ( aTravianVersion ) {
					case "3.6":
						td2.innerHTML = "<a target='_blank' href='karte.php?z=" + getCoordfromXY(e.xcoord, e.ycoord) + "'>"
							+ "(" + e.xcoord + "|" + e.ycoord + ")</a>";
						break;
					case "4.0":
						td2.innerHTML = "<a target='_blank' href='karte.php?x=" + e.xcoord + "&y=" + e.ycoord + "'>"
							+ "(" + e.xcoord + "|" + e.ycoord + ")</a>";
						break;
					default:
						throwLogicError ( "displayCropFinderInfo():: Travian Version not set!!" );
				}
				divElem.appendChild ( td2 );
				var td3 = document.createElement ( "td" );
				td3.innerHTML = "<span class='distance'>"+ ( Math.round ( e.distance * 100 ) / 100 ) + "</span>";
				divElem.appendChild ( td3 );
				var td4 = document.createElement ( "td" );
				if ( e.type == "9c" || e.type == "15c" ) {
					td4.innerHTML = "<span class='oasis_percent'>"+ e.oasis + "</span>";
				}
				else if ( e.type == "50cropo" ) {
					td4.innerHTML = "50";
				}
				else if ( e.type == "25cropo" ) {
					td4.innerHTML = "25";
				}
				else if ( e.type == "noncropo" ) {
					td4.innerHTML = "0";
				}
				divElem.appendChild ( td4 );
				var td5 = document.createElement ( "td" );
				if ( e.type == "9c" || e.type == "15c" ) {
					var temp = "<span class='oasis_list'>";
					for ( var ctr = 0 ; ctr < e.oasisList.length ; ctr++ ) {
						if ( ctr != 0 )
							temp += ", ";
						switch ( aTravianVersion ) {
							case "3.6":
								temp += "<a target='_blank' href='karte.php?z="
									+ getCoordfromXY(e.oasisList [ ctr ].xcoord, e.oasisList [ ctr ].ycoord) + "'>"
									+ "(" + e.oasisList [ ctr ].key + ")</a>";
								break;
							case "4.0":
								temp += "<a target='_blank' href='karte.php?x="
									+ e.oasisList [ ctr ].xcoord + "&y=" + e.oasisList [ ctr ].ycoord + "'>"
									+ "(" + e.oasisList [ ctr ].key + ")</a>";
								break;
							default:
								throwLogicError ( "displayCropFinderInfo():: Travian Version not set!!" );
						}
					}
					temp += "</span>";
					td5.innerHTML = temp;
				}
				else {
					var temp = "<span class='troop_list'>";
					for ( var ctr = 0; ctr < e.troops.length ; ctr++ ) {
						if ( ctr != 0 )
							temp += ", ";
						temp += e.troops[ctr].type + " " + e.troops[ctr].count;
					}
					temp += "</span>";
					td5.innerHTML = temp;
				}
				divElem.appendChild ( td5 );
				cropFinderResultsElem.appendChild ( divElem );
			}

			document.getElementById("xInputCoord").disabled = false;
			document.getElementById("yInputCoord").disabled = false;
			document.getElementById("inputRadius").disabled = false;
			document.getElementById("find_9c").disabled = false;
			document.getElementById("find_15c").disabled = false;
			document.getElementById("find_oasis_troops").disabled = false;
			document.getElementById("randomize_crop_finder").disabled = false;
			document.getElementById("crop_finder_start").disabled = false;
			document.getElementById("crop_finder_clear_fields_memory").disabled = false;
			document.getElementById("crop_finder_clear_oasis_troops_memory").disabled = false;

			if ( ! checkCropFinderFieldsMemoryExists() )
				document.getElementById("crop_finder_clear_fields_memory").disabled = true;
			if ( ! checkCropFinderOasisTroopsMemoryExists() )
				document.getElementById("crop_finder_clear_oasis_troops_memory").disabled = true;

		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>displayCropFinderInfo():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

// create auto-task links on travian pages.
function createAutoTaskLinksOnTravianPages() {
	try {
		if ( window.location.href.indexOf("dorf3.php") == -1 )  { // if not dorf3.php create auto-task links

			if ( ( window.location.href.indexOf("a2b.php") != -1 ) && // a2b.php
					( window.location.href.match(/[\?&]d=/) == null ) // but not 2nd stage of a2b.php
					) {
				if ( $("troops") != undefined ) {
					//TS_debug('Check CreatAttackBtn');
					createAttackBtn();

					// when user manually sends troops for attack , clear _troopsAvail in cookie
					var attkOkBtn = $("btn_ok");
					attkOkBtn.addEventListener("click", function() { clearAvailTroopscount(currentID()); return false; }, false);

					// get avail troops count and set in cookie
					getAvailTroopsCountFromA2B(currentID());
				}
			}

			handleBeginProtectionTimeDisplay();

			if ( aTravianVersion == "3.6" ) {
				if ( window.location.href.indexOf("karte.php") != -1 && // showing karte.php
					window.location.href.match(/\bd=/) == null ) { // karte.php not with d parameter, ie not showing village
					var mapEnhance = GM_getValue ( myacc() + "_mapEnhancementsEnabled", "1" );
					if ( mapEnhance == "1" )
						handleMap();
				}
			}

			if ( window.location.href.match(/\bspieler\.php\b/) != null && 
				( window.location.href.match(/\buid=/) == null || 
						( window.location.href.match(/\buid=/) != null && window.location.href.indexOf ( "uid="+getuid() ) != -1 ) 
					) 
				) {
				createCropFinderLink();
			}

			if ( window.location.href.indexOf("build.php") != -1 ) {
				//TS_debug("h1 text:: h1in().innerHTML:  " + stripHTML(h1in().innerHTML))
				var h1innerr = stripHTML ( h1in().innerHTML.replace(/\n/g,"") ).split ( " " );
				//var h1innerr = getPageHeading(document).split(" ");
				//TS_debug("h1in().innerHTML = " + h1in().lastChild.innerHTML);
				//TS_debug("FM h1innerr.length =" + h1innerr.length);
				var bName = "";
				switch ( h1innerr.length ) {
					case 3:
						bName = h1innerr[0];
						//TS_debug('FM Case 3 bName =' + bName);	
						break;
					case 4:
						bName = h1innerr[0] + " " + h1innerr[1];
						//TS_debug('FM Case 4 bName =' + bName);	
						break;
					case 5:
						bName = h1innerr[0] + " " + h1innerr[1] + " " + h1innerr[2];
						//TS_debug('FM Case 5 bName =' + bName);	
						break;
					case 6:
						bName = h1innerr[0] + " " + h1innerr[1] + " " + h1innerr[2] + " " + h1innerr[3];
						//TS_debug('FM Case 6 bName =' + bName);	
						break;
					default:
						bName = "";
						break;
				}

				//flag ( 'createAutoTaskLinksOnTravianPages():: h1innerr            : "' + h1innerr.join(" ") + '"' );
				//flag ( 'createAutoTaskLinksOnTravianPages():: bName               : "' + bName + '"' );
				var nameFound = false;
				for ( var ctr = 0 ; ctr < aLangAllBuildWithId.length ; ctr ++ ) {
					if ( ctr == 4 ) continue;
					if ( aLangAllBuildWithId[ctr] == bName ) {
						nameFound = true;
						//flag ( 'createAutoTaskLinksOnTravianPages():: nameFound           : ' + nameFound );
						//flag ( 'createAutoTaskLinksOnTravianPages():: aLangAllBuildWithId['+ctr+'] : "' + aLangAllBuildWithId[ctr] + '"' );
					}
				}
				if ( nameFound == false && h1innerr.join(" ").indexOf(aLangGameText[15]) == -1 ) {
					flag ( 'createAutoTaskLinksOnTravianPages():: h1innerr            : "' + h1innerr.join(" ") + '"' );
					flag ( 'createAutoTaskLinksOnTravianPages():: bName               : "' + bName + '"' );
					flag ( 'createAutoTaskLinksOnTravianPages():: "' + bName + '" or "' + h1innerr.join(" ")
							+ '" is not in aLangAllBuildWithId & is not aLangGameText[15]' );
					flag ( 'createAutoTaskLinksOnTravianPages():: aLangGameText[15]   : ' + aLangGameText[15] );
					flag ( 'createAutoTaskLinksOnTravianPages():: aLangAllBuildWithId : ' + aLangAllBuildWithId.join(", ") );
					flag ( 'createAutoTaskLinksOnTravianPages():: aLangGameText       : ' + aLangGameText.join(", ") );
					printErrorMSG("<b>ERROR:: Translation required for : \"" + bName + "\" or \"" + h1innerr.join(" ") + "\" from build.php.</b>", 1 );
				}

				if ( bName == aLangAllBuildWithId[24] && window.location.href.match(/\bid=/) != null && window.location.href.match(/\bgid=/) == null ) {
					//TS_debug('FM --------------------- "CreatePartyLnk" bName = ' + bName);	
					createPartylnk();
				}

				if ( ( bName == aLangAllBuildWithId[12] || bName == aLangAllBuildWithId[13] ) 
						&& window.location.href.match(/[^gd]id=/) != null && window.location.href.match(/\bgid=/) == null) {
					//TS_debug('FM --------------------- "CreateImprove" bName = ' + bName);	
					createImprovelink();
				}

				if ( stripHTML( h1in().innerHTML.replace(/\n/g,"") ).indexOf( aLangAllBuildWithId[15] ) != -1 
						&& h1innerr [ h1innerr.length-1 ] > 9 && ( !$("demolish") ) ) {
					//TS_debug('FM --------------------- "CreateDemolishLink" bName = ' + bName);
					createDemolishlnk();
				}

				if ( ( bName==aLangAllBuildWithId[19] || bName==aLangAllBuildWithId[20] ||
					bName==aLangAllBuildWithId[21] || bName==aLangAllBuildWithId[25] ||
					bName==aLangAllBuildWithId[26] || bName==aLangAllBuildWithId[29] || 
					bName==aLangAllBuildWithId[30] )
					&& window.location.href.match(/\bgid=/) == null ) {
					//TS_debug('FM --------------------- "CreateTrainLink" bName = ' + bName);	
					createTrainLnk();
				}

				// GotGs 201.01.15 -- Why leave gid links, becoz it is difficult to fetch the id in case of a gid link.
				// The id cannot be fetched from upgrade url, becoz if in case of 'not enough resources' we are stuck.
				if ( ( window.location.href.indexOf("build.php") != -1 ) && 
						( window.location.href.match(/\bid=/) != null || window.location.href.match(/\bgid=17/) != null ) && 
						! isNaN ( h1innerr[h1innerr.length-1] ) && 
						window.location.href.match(/\bt=/) == null && window.location.href.match(/\bgid=/) == null ) { 
					createbuildlink();
					checkBuildErrorTranslation(document);
				}

				// Create new build links.
				//TS_debug("Check for 'new build' page... " + stripHTML(h1in().innerHTML));
				if ( stripHTML(h1in().innerHTML.replace(/\n/g,"")).indexOf(aLangGameText[15]) != -1 && window.location.href.match(/\bgid=/) == null ) {
					//flag('Premier flag');
 	 				//TS_debug("Check for 'CreateNewBuild' page..." + stripHTML(h1in().innerHTML));
					createNewbuildLnk();	// Creation option NEW BUILD.
					checkNewBuildErrorTanslations(document);
					checkNewBuildNameTranslations(document);
				}

				if ( bName.indexOf(aLangAllBuildWithId[17]) != -1 && window.location.href.match(/\bt=/) == null ) {
 	 			//TS_debug("Check for 'createAutoTransBtn' page..." + bName);
					createAutoTransBtn(); 	// Creation option for Transport automatique and personnalise
					if ( $("createUrl") == null ) {
						createbuildlink();
						checkBuildErrorTranslation(document);
					}
					GM_setValue ( herere() + "_marketExists", "1" );
				}

				if ( stripHTML ( h1in().innerHTML.replace(/\n/g,"") ).indexOf ( aLangAllBuildWithId[37] ) != -1 ) {
					if ( aTravianVersion == "3.6" )
						getHeroSpeed(document); // if hero mansion, get the hero speed.
				}
			}

			if ( window.location.href.indexOf("dorf1") != -1 ) {
 	 			//TS_debug("Check for 'createAutoResLink' page..." + window.location.href));
				createAutoResLink(); 	// Creation option RESSUPD in page
			}

			if ( window.location.href.indexOf("hero_inventory.php") != -1 ) { // for travian version 4.0
				getHeroSpeed(document); // get the hero speed.
			}
			if ( window.location.href.indexOf("hero_adventure.php") != -1 ) { // for travian version 4.0
				getAvailableAdventures( document, null, 1 );
			}

		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>createAutoTaskLinksOnTravianPages():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function checkBuildErrorTranslation ( aElem ) {
	try {
		//flag ( "checkBuildErrorTranslation():: Started!" );
		var xpathBuildAnchor = "";
		var errorXpath = "";
		switch ( aTravianVersion ) {
			case "3.6":
				xpathBuildAnchor = 'id("build")//a[ contains(@href,"?a=") and @class="build" ]';
				errorXpath = './/*[@id="contract"]//span[@class="none"]';
				break;
			case "4.0":
				xpathBuildAnchor = './/*[@id="build"]//button[ contains(@onclick,"?a=") and @class="build" ]';
				errorXpath = './/*[@id="contract"]//span[@class="none"]';
				break;
			default: throwLogicError ( "checkBuildErrorTranslation():: Travian Version not set!!" );
		}
		var buildLink = document.evaluate ( xpathBuildAnchor, aElem, null, XPFirst, null );
		if ( buildLink.singleNodeValue == null ) { // do only if build link does not exists
			var error = document.evaluate ( errorXpath, aElem, null, XPFirst, null );
			if(error.singleNodeValue) {
				//flag ( "checkBuildErrorTranslation():: error.singleNodeValue.innerHTML: " + error.singleNodeValue.innerHTML );
				var found = false;
				var errorText = error.singleNodeValue.innerHTML.replace(/\n/g,"");
				for ( var ctr = 0 ; ctr < aLangErrorText.length ; ctr++ ) {
					if ( errorText.indexOf( aLangErrorText[ctr] ) != -1 ) {
						//flag ( "checkBuildErrorTranslation():: aLangErrorText["+ctr+"]: " + aLangErrorText[ctr] );
						found = true;
						break;
					}
				}
				if ( found == false ) {
					printErrorMSG("<b>ERROR:: Translation required for travian error: \"" + errorText + "\" from build.php.</b>", 1 );
				}
			}
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>checkBuildErrorTranslation():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function checkNewBuildNameTranslations ( aElem ) {
	try {
		var xpathPageHeading = "";
		var xpathBuildingName = "";
		switch ( aTravianVersion ) {
			case "3.6":
				xpathPageHeading = "id('build')/h1";
				xpathBuildingName = 'id("build")//h2';
				break;
			case "4.0":
				xpathPageHeading = "id('contentOuterContainer')//h1";
				xpathBuildingName = 'id("build")//h2';
				break;
			default:
				throwLogicError ( "getthebuildUrl():: Travian Version not set!!" );
		}
		var pageHeading = document.evaluate ( xpathPageHeading, aElem, null, XPFirst, null );
		if ( pageHeading.singleNodeValue && pageHeading.singleNodeValue.innerHTML.replace(/\n/g,"").indexOf(aLangGameText[15]) != -1 ) { // verify construction page
			var buildingList = document.evaluate ( xpathBuildingName, aElem, null, XPOrdList, null );
			for ( var ctr = 0 ; ctr < buildingList.snapshotLength ; ctr++ ) {
				var buildingName = stripHTML ( buildingList.snapshotItem(ctr).innerHTML ).replace(/\n/g, "");
				// when we build more than 1 of warehouse, granary or cranny, the name displayed in build page contains a number along with the name which 
				// must be removed, for example if building 2nd warehouse, build name displayed in build.php will be something like '2. Warehouse'.
				if ( buildingName.indexOf(aLangAllBuildWithId[10]) != -1 // warehouse
					|| buildingName.indexOf(aLangAllBuildWithId[11]) != -1 // granary
					|| buildingName.indexOf(aLangAllBuildWithId[23]) != -1 // cranny
					) {
					continue
				}
				var found = false;
				for ( var itr = 0 ; itr < aLangAllBuildWithId.length ; itr++ ) {
					if ( aLangAllBuildWithId[itr] == buildingName ) {
						found = true;
						break;
					}
				}
				if ( found == false ) {
					printErrorMSG("<b>ERROR:: Translation required for building name: \"" + buildingName + "\" from new build page.</b>", 1 );
				}
			}

		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>checkNewBuildNameTranslations():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function checkNewBuildErrorTanslations ( aElem ) {
	try {
		var xpathPageHeading = "";
		var errorListXpath = "";
		switch ( aTravianVersion ) {
			case "3.6":
				xpathPageHeading = "id('build')/h1";
				errorListXpath = 'id("build")//table[@class="new_building"]//td[@id="contract_n"]//span[@class="none"]';
				break;
			case "4.0":
				xpathPageHeading = "id('contentOuterContainer')//h1";
				errorListXpath = 'id("build")//div[@class="contract contractNew contractWrapper"]//'
					+ 'div[@class="contractLink"]//span[@class="none"]';
				break;
			default:
				throwLogicError ( "getthebuildUrl():: Travian Version not set!!" );
		}
		var pageHeading = document.evaluate ( xpathPageHeading, aElem, null, XPFirst, null );
		if ( pageHeading.singleNodeValue && pageHeading.singleNodeValue.innerHTML.replace(/\n/g,"").indexOf(aLangGameText[15]) != -1 ) { // verify construction page
			var errorList = document.evaluate( errorListXpath, aElem, null, XPOrdList, null);
			for ( var iCtr = 0 ; (iCtr < errorList.snapshotLength) && (iCtr < errorList.snapshotLength) ; iCtr++ ) {
				if ( errorList.snapshotItem(iCtr).parentNode.firstChild == errorList.snapshotItem(iCtr) ) { // check only if 1st child
					//flag ( "checkNewBuildErrorTanslations():: errorList.snapshotItem("+iCtr+").innerHTML: " + errorList.snapshotItem(iCtr).innerHTML );
					var found = false;
					var errorText = errorList.snapshotItem(iCtr).innerHTML.replace(/\n/g,"");
					for ( var ctr = 0 ; ctr < aLangErrorText.length ; ctr++ ) {
						//flag ( "checkNewBuildErrorTanslations()::  aLangErrorText["+ctr+"]: " +  aLangErrorText[ctr] );
						if ( errorText.indexOf( aLangErrorText[ctr] ) != -1 ) {
							found = true;
							break;
						}
					}
					if ( found == false ) {
						printErrorMSG("<b>ERROR:: Translation required for travian error: \"" + errorText + "\" from build.php.</b>", 1 );
					}
				}
			}
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>checkNewBuildErrorTanslations():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function randomizeIncomingTroopsFreshTime() {
	if ( self.window.name == GM_getValue(currentServer() + '_loginWindow', "noLoginWindow") ) { // do only in login window
		// when to refresh incoming troops before an incoming attack
		incomingTroopsFreshTime = 1.5*60*1000; // min 1.5 mins
		var myRace = GM_getValue ( myacc() + "_raceID" );
		switch ( myRace ) {
			case "0": // romans
				incomingTroopsFreshTime += Math.ceil ( Math.random() * 2.5*60*1000 ); // random 2.5 mins
				break;
			case "1": // teutons
				incomingTroopsFreshTime += Math.ceil ( Math.random() * 4.5*60*1000 ); // random 4.5 mins
				break;
			case "2": // gauls
				incomingTroopsFreshTime += Math.ceil ( Math.random() * 2.0*60*1000 ); // random 2.0 mins
				break;
		}
	}
}

// if current page is profile page, then start auto-task script iteration.
function startIterationOnlyOnLoginWindow() {
	try {
		// pagefreshInterval (mins) is used for when to relad page, randomized by 0.5 times.
		var loginWindowFreshIntrv = GM_getValue ( myacc() + "_loginWindowFreshInterval", "60");
		pagefreshInterval = loginWindowFreshIntrv * 60*1000 + Math.ceil ( Math.random() * loginWindowFreshIntrv*60*1000 - loginWindowFreshIntrv*60*1000/2.0 );
		// transsInterval (mins) is used for by Auto Transport (Construction Support / Resource Concentration).
		transsInterval = GM_getValue(myacc() + "_transInterval", "30")*60*1000;
		// scriptRunInterval (seconds) is used for when to run this (auto-task) script.
		scriptRunInterval = GM_getValue(myacc() + "_scriptRunInterval", "20")*1000;

		// how many intervals to skip on user activity
		//onActivitySkipIntervals = Number(GM_getValue(myacc() + "_skipIntervalsOnUserActivity", "3"));
		//onActivitySkipTime = scriptRunInterval * onActivitySkipIntervals;

		// when to refresh incoming troops before an incoming attack
		randomizeIncomingTroopsFreshTime();

		// print timer status in footer and in log and handle last user activity time.
		/*var scriptStartTime = new Date().getTime();
		var lastUsrActTime = GM_getValue(myacc() + "_lastUsrActTime", "false");
		if ( lastUsrActTime != "false" ) {
			var timeElapsedSinceLastUsrAct = scriptStartTime - parseInt(lastUsrActTime);
			if ( timeElapsedSinceLastUsrAct < onActivitySkipTime ) {
				ccclock = 0;
				checkForUserActivity = - onActivitySkipTime;
				debugText = "checkForUserActivity: " + checkForUserActivity  + "; ccclock: " + ccclock + "; Time to Reload Page: " + Number(pagefreshInterval);
				flag ( debugText );
			}
			else {
				GM_deleteValue(myacc() + "_lastUsrActTime");
			}
		}*/

		// setup footer text
		defaultFooterText = document.getElementById("footer").innerHTML; // first backup original footer
		printFooterMsg();

		// add event listeners on keydown and mouse events to clear timers on user activity.
		window.addEventListener("keydown", cleartime, false);
		window.addEventListener("mousemove", cleartime, false); 
		window.addEventListener("DOMMouseScroll", cleartime, false); //adding the event listerner for Mozilla
		// set task cookies for all tasks, doing this only on refresh of profile page, on login & on addition of tasks.
		getTaskCookies();
		// start iteration on self profile page.
		flag ("Auto Task iteration started on Login Window.");
		startIteration();
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startIterationOnlyOnLoginWindow():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function setGlobalVars() {
	try {
		//flag ( "setGlobalVars():: Started!" );

		if ( ! GM_getValue ( myacc() + "_doing" ) ) { // if _doing entry does not exist, then create it.
			GM_setValue ( myacc() + "_doing", "1" );
			//TS_debug("can't find doing, set doing = 1");
		}
		taskdoing = GM_getValue ( myacc() + "_doing" ); // set taskdoing from cookie.

		if ( ! GM_getValue ( myacc() + "_option" ) ) { // get option from cookie, this contains location of forms created by auto task script.
			GM_setValue ( myacc() + "_option", "" );
		}

		var curentSetup = GM_getValue(myacc() + "_loginWindowFreshInterval", "60");
		GM_setValue(myacc() + "_loginWindowFreshInterval", curentSetup);

		curentSetup = GM_getValue(myacc() + "_transInterval", "30");
		GM_setValue(myacc() + "_transInterval", curentSetup);

		curentSetup = GM_getValue(myacc() + "_scriptRunInterval", "20");
		GM_setValue(myacc() + "_scriptRunInterval", curentSetup);

		curentSetup = GM_getValue(currentServer() + "_scriptAutoLogin", "1");
		GM_setValue(currentServer() + "_scriptAutoLogin", curentSetup);

		//curentSetup = GM_getValue(myacc() + "_skipIntervalsOnUserActivity", "3");
		//GM_setValue(myacc() + "_skipIntervalsOnUserActivity", curentSetup);

		// get _raceID, _mainvillageId, _mainvillageName, _mainVillagePosition, _mainVillageCoord if current page is profile page
		//flag ("setGlobalVars():: calling getMainVillageid()"); // uses getDidFromVillage(), _singleTownNEWDID must be first set for single village.
		getMainVillageid();

		// get _allVillagePos from any non-profile page, for single village 
		// _mainvillageName & _mainVillagePosition must be already set.
		if (window.location.href.match(/\bs=4/) == null) {
			//flag ("setGlobalVars():: calling getallVillagePos()");
			getallVillagePos();
		}

		// call these functions once to initialize them...
		currentID();
		currentVillageName();
		getAllVillageNewdids();
		getvillagefromdid( GM_getValue(myacc() + '_singleTownNEWDID') ); // must be called after getMainVillageid() as getvillagefromdid() uses _mainVillageName.

		// get _ResourceRate if current page is dorf1.php (used only in auto-resource), _singleTownNEWDID must be first set for single village.
		//flag ("setGlobalVars():: calling getResourceRate()");
		getResourceRate();
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>setGlobalVars():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function checkForIncomingAttackFromDorf1(responseText) {
	if ( responseText != null && responseText != "" ) {
		//flag ( "checkForIncomingAttackFromDorf1():: Started!" );
		var aElem = document.createElement("div");
		aElem.innerHTML = responseText;
		if ( gatherStats(aElem.innerHTML) ) {
			var lvlErrMsg = "Captcha Found!";
			GM_setValue(myacc() + "_currentError", lvlErrMsg );
			// attempt reloading page, captcha ll be found there too and script will stop.
			window.location.replace(myhost + "/spieler.php");
			return false;
		}

		var checkAttack = document.evaluate('.//table[@id="movements"]//tbody//td[@class="typ"]//span[@class="a1"]', aElem, null, XPFirst, null);
		if ( checkAttack.singleNodeValue == null ) {
			//flag ( "checkForIncomingAttackFromDorf1():: No incoming Attack Found!" );
			return false;
		}
		else {
			var countIncomingAttack = document.evaluate('.//table[@id="movements"]//tbody//div[@class="mov"]//span[@class="a1"]', 
					aElem, null, XPFirst, null).singleNodeValue.innerHTML.match(/\d{1,}/)[0];
			//flag ( "checkForIncomingAttackFromDorf1():: Village: " + getvillagefromdid(currentID()) + " (" + currentID() + ")" + 
			//		", Incoming Attacks: " + countIncomingAttack );
			return countIncomingAttack;
		}
	}
	else {
		flag ( "checkForIncomingAttackFromDorf1():: Returning undefined!" );
		return undefined;
	}
}

function checkForRiskyIncomingAttacks ( vi ) {
	try {
		//flag ( "checkForRiskyIncomingAttacks():: Started!" );

		if ( self.window.name == GM_getValue(currentServer() + '_loginWindow', "noLoginWindow") ) { // do only in login window
			var alarmPlayedForRiskyIncomingTroops = GM_getValue ( myacc() + "_" + vi + "_alarmPlayedForRiskyIncomingTroops", "" );

			// clean alarmPlayedForRiskyIncomingTroops so that it does not contain old elapsed times.
			if ( alarmPlayedForRiskyIncomingTroops != "" ) {
				var tempList = new Array();
				var ownIncomingTroopsTimes = GM_getValue( myacc() + "_" + vi + "_troopsOwnInTimes", "" );
				if ( ownIncomingTroopsTimes != "" ) {
					ownIncomingTroopsTimes = ownIncomingTroopsTimes.split("|");
					for ( var ctr = 0 ; ctr < ownIncomingTroopsTimes.length ; ctr++ ) {
						var ownIncomingTroopTime = ownIncomingTroopsTimes[ctr];
						var attackWithTime = vi+"_"+ownIncomingTroopTime;
						if ( alarmPlayedForRiskyIncomingTroops.indexOf(attackWithTime) != -1 ) {
							tempList.push(attackWithTime);
						}
					}
				}
				alarmPlayedForRiskyIncomingTroops = tempList.join("|");
				GM_setValue ( myacc() + "_" + vi + "_alarmPlayedForRiskyIncomingTroops", alarmPlayedForRiskyIncomingTroops );
			}
			//flag ( "checkForRiskyIncomingAttacks():: alarmPlayedForRiskyIncomingTroops cleaned!" );

			var ownTroopsInTimes = GM_getValue(myacc() + "_" + vi + "_troopsOwnInTimes" ).split("|"); // assuming is sorted ascending
			var inAttackTimes = GM_getValue( myacc() + "_" + vi + "_incomingAttackTimes" ).split("|"); // assuming is sorted ascending
			//flag ( "ownTroopsInTimes.length: " + ownTroopsInTimes.length + ", ownTroopsInTimes: " + ownTroopsInTimes );
			//flag ( "inAttackTimes.length: " + inAttackTimes.length + ", inAttackTimes: " + inAttackTimes );
			//flag ( "alarmPlayedForRiskyIncomingTroops: " + alarmPlayedForRiskyIncomingTroops );
			var serverNowTime = new Date().getTime() - serverTimeDiff;
			if ( ownTroopsInTimes.length > 0 && inAttackTimes.length > 0 ) {
				var ctr = 0; // iterator over inAttackTimes
				var itr = 0; // iterator over ownTroopsInTimes
				do {
					while ( Number(ownTroopsInTimes[itr]) > Number(inAttackTimes[ctr]) && ctr < inAttackTimes.length )
							ctr++;
					if ( ctr >= inAttackTimes.length )
						break;
					while ( ( alarmPlayedForRiskyIncomingTroops.indexOf(vi+"_"+ownTroopsInTimes[itr]) != -1
							|| Number(ownTroopsInTimes[itr]) < serverNowTime )
							&& itr < ownTroopsInTimes.length ) { // skip if already played
						itr++;
						//flag ( "skipping ownTroopsInTimes["+itr+"]: " + ownTroopsInTimes[itr] );
					}
					if ( itr >= ownTroopsInTimes.length )
						break;
					if ( Number(ownTroopsInTimes[itr]) < Number(inAttackTimes[ctr]) &&
							(Number(inAttackTimes[ctr]) - Number(ownTroopsInTimes[itr]) ) < 20*1000 // if difference is less than 20 seconds, this is risky
							) {
						//flag ( "inAttackTimes["+ctr+"]: " + inAttackTimes[ctr] + ", ownTroopsInTimes["+itr+"]: " + ownTroopsInTimes[itr] );
						var msg = getvillagefromdid ( vi ) + " (" + vi + "): " + "Anti-farm cannot save own troops<br/>&nbsp;&nbsp; arriving at " 
								+ new Date(Number(ownTroopsInTimes[itr])).toLocaleString()
								+ "<br/>&nbsp;&nbsp; from attack arriving at " + new Date(Number(inAttackTimes[ctr])).toLocaleString();
						playSound("&nbsp;&nbsp;<b>" + msg + "</b>&nbsp;&nbsp;");
						var str = GM_getValue ( myacc() + "_" + vi + "_alarmPlayedForRiskyIncomingTroops", "" );
						str = str == "" ? "" : str + "|";
						GM_setValue ( myacc() + "_" + vi + "_alarmPlayedForRiskyIncomingTroops", str + vi+"_"+ownTroopsInTimes[itr] );
					}
					itr++;
				}
				while ( ctr < inAttackTimes.length && itr < ownTroopsInTimes.length );
			}
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>checkForRiskyIncomingAttacks():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function analyzeRallyPoint ( aElem, viNewdid, checkForIncomingAttack ) {
	try {
		flag ( "analyzeRallyPoint():: Started! viNewdid: " + viNewdid + ", checkForIncomingAttack: " + checkForIncomingAttack );
		//printStackTrace();
		if ( aElem != null && viNewdid != null && viNewdid != undefined && viNewdid != "" ) {
			// no need to do gatherStats() here as analyzeRallyPoint() is always called via TS_getRequest()
			/*if ( gatherStats(aElem.innerHTML) ) {
				var lvlErrMsg = "Captcha Found!";
				GM_setValue(myacc() + "_currentError", lvlErrMsg );
				// attempt reloading page, captcha ll be found there too and script will stop.
				window.location.replace(myhost + "/spieler.php");
				return;
			}*/
			//flag ( "analyzeRallyPoint():: aElem.innerHTML: " + aElem.innerHTML );

			// get server time from travian page, by adding current desktop date to time from travian page,
			// since desktop date & server date can be confilicting around mid-night, we should not analyze rally point around mid-night
			var serverNowTime = document.evaluate('.//span[@id="tp1"]', aElem, null, XPFirst, null ).singleNodeValue;
			if ( serverNowTime != null )
				serverNowTime = getDateAndTimeFromText ( serverNowTime.innerHTML, 0 ).getTime();
			else {
				var msg = "<b>analyzeRallyPoint():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
				playSound ( msg );
				throw err;
			}
			//serverNowTime = new Date().getTime() - serverTimeDiff;
			var comingServerMidNight = new Date( 
							new Date().getFullYear(), 
							new Date().getMonth(), 
							new Date().getDate()+1, 
							0, 0, 0, 0 ).getTime() - serverTimeDiff;
			var intervalToMidNight =  comingServerMidNight - serverNowTime;
			//flag ( "analyzeRallyPoint():: intervalToMidNight: " + intervalToMidNight );

			// delay rally point analysis if 1 min around mid night becoz server time diff could cause problems
			// assuiming here that server time diff does not exceed 1 min.
			if ( Math.abs(intervalToMidNight) < 1*60*1000 ) {
				GM_setValue ( myacc() + "_" + viNewdid + "_incomingAttackCheckElapseTime", "" );
				GM_setValue ( myacc() + "_" + viNewdid + "_troopsCheckElapseTime", "" );
				return;
			}

			function getRallyArriveTime(text) {
				//flag ( "getRallyArriveTime():: text: " + text );
				var timeArry = text.match(/\b\d{1,}:\d{1,}:\d{1,}\b/g);
				//flag ( "getRallyArriveTime():: timeArry: " + timeArry );
				var intervalFrmTimer = getIntervalFromTimer(timeArry[0]);
				var arriveTime = getDateAndTimeFromText ( timeArry[1], 0 ).getTime();
				//flag ( "getRallyArriveTime():: intervalFrmTimer: " + intervalFrmTimer + ", arriveTime: " + arriveTime );
				while ( intervalFrmTimer >= intervalToMidNight ) {
					intervalFrmTimer -= 24*60*60*1000;
					arriveTime += 24*60*60*1000;
				}
				//flag ( "getRallyArriveTime():: intervalFrmTimer: " + intervalFrmTimer + ", arriveTime: " + arriveTime );
				return arriveTime;
			}

			// check if we have rally point
			var h1name = document.evaluate('.//h1', aElem, null, XPFirst, null).singleNodeValue;
			//flag ( "analyzeRallyPoint():: h1name: " + h1name );
			// when not rally point, this should happen only if village has no rally point
			if ( h1name == null || h1name.innerHTML.replace(/\n/g,"").indexOf(aLangAllBuildWithId[16]) == -1 ) {
				var delayMultiplier = 1;
				if ( getAllVillageNewdids().length == 1 ) { // when we have only 1 village.
					delayMultiplier = 12; // delay 12 times more than normal, probably user is under beginner's protection during this.
				}
				else {	// we have more than 1 village, then most probably this is a new village, or the rally point has been destroyed.
					delayMultiplier = 4; // delay 4 times more than normal
					//addBuildingTaskAtTop(viNewdid, 15, 3); // add main building level 3 upgrade task
					addBuildingTaskAtTop(viNewdid, 16); // add rally point task
				}
				var attackDetectInterval = parseInt(GM_getValue(myacc() + "_attackDetectInterval", "60")) * delayMultiplier; // delay more than normal
				// attackDetectInterval mins +/- random ( attackDetectInterval/2 )
				var randominter1 = Math.ceil ( Math.random() * attackDetectInterval*60*1000 - attackDetectInterval*60*1000/2.0 ) + attackDetectInterval*60*1000;
				var elapseTime1 = serverNowTime + randominter1;
				GM_setValue ( myacc() + "_" + viNewdid + "_incomingAttackCheckElapseTime", elapseTime1.toString() );
				var msg1 = getvillagefromdid(viNewdid) + " (" + viNewdid + "): No Rally Point! Cannot check for incoming attack, will check again at : " 
						+ new Date(elapseTime1);
				flag ( "analyzeRallyPoint():: " + msg1 );
				printErrorMSG ( "<b>" + msg1 + "</b>" );

				var troopsUpdateInterval = parseInt(GM_getValue(myacc() + "_troopsUpdateInterval", "60")) * delayMultiplier; // delay more than normal
				// troopsUpdateInterval mins +/- random ( troopsUpdateInterval/2 )
				var randominter2 = Math.ceil ( Math.random() * troopsUpdateInterval*60*1000 - troopsUpdateInterval*60*1000/2.0 ) + troopsUpdateInterval*60*1000;
				var elapseTime2 = serverNowTime + randominter2;
				GM_setValue ( myacc() + "_" + viNewdid + "_troopsCheckElapseTime", elapseTime2.toString() );
				var msg2 = getvillagefromdid(viNewdid) + " (" + viNewdid + "): No Rally Point! Cannot check for available troops, will check again at : "
						+ new Date(elapseTime2);
				flag ( "analyzeRallyPoint():: " + msg2 );
				printErrorMSG ( "<b>" + msg2 + "</b>" );

				return;
			}

			// check for complete or partial rally point
			var xpathCompleteRallyPoint = 'id("build")//p[@class="switch"]/a[contains(@href,"id=39") and contains(@href,"&k")]';
			var completeCheck = document.evaluate ( xpathCompleteRallyPoint, document, null, XPFirst, null ).singleNodeValue;
			//flag ( "analyzeRallyPoint():: completeCheck: " + completeCheck );
			if ( completeCheck == null )
				completeCheck = true;
			else
				completeCheck = false;
			//flag ( "analyzeRallyPoint():: completeCheck: " + completeCheck );

			/*
			 * find incoming attacks...
			 */
			if ( completeCheck == true && checkForIncomingAttack == true ) { // only when complete incoming troops info is available in rally point
				var xpathIncomingAttacks  = "";
				var xpathAttackTimes = "";
				var xpathIncomingAttacker = "";
				var xpathIncomingAttackerFirstTroop = "";
				switch ( aTravianVersion ) {
					case "3.6":
						xpathIncomingAttacks  = 'id("build")/table[@class="troop_details"]/thead//td[@colspan="10" or @colspan="11"]//'
							+ 'a[contains(@href,"' + getPosFromNewdid(viNewdid) + '")]';
						xpathAttackTimes      = 'id("build")/table[@class="troop_details"]/thead//td[@colspan="10" or @colspan="11"]//'
							+ 'a[contains(@href,"' + getPosFromNewdid(viNewdid)
							+ '")]/../../../..//div[@class="at"]/../../td[@colspan="10" or @colspan="11"]';
						xpathIncomingAttacker = 'id("build")/table[@class="troop_details"]/thead//td[@colspan="10" or @colspan="11"]//'
							+ 'a[contains(@href,"' + getPosFromNewdid(viNewdid)
							+ '")]/../../td[@class="role"]/a[contains(@href,"karte.php?d=")]';
						xpathIncomingAttackerFirstTroop = 'id("build")/table[@class="troop_details"]/thead//td[@colspan="10" or @colspan="11"]//'
							+ 'a[contains(@href,"' + getPosFromNewdid(viNewdid)
							+ '")]/../../../../tbody[@class="units"]/tr[2]/td[1][@class="none"]';
						break;
					case "4.0":
						xpathIncomingAttacks  = 'id("build")/table[@class="troop_details inAttack" or @class="troop_details inRaid"]/'
							+ 'thead//td[@colspan="10" or @colspan="11"]//'
							+ 'a[contains(@href,"' + getPosFromNewdid(viNewdid) + '")]';
						xpathAttackTimes      = 'id("build")/table[@class="troop_details inAttack" or @class="troop_details inRaid"]/'
							+ 'thead//td[@colspan="10" or @colspan="11"]//'
							+ 'a[contains(@href,"' + getPosFromNewdid(viNewdid)
							+ '")]/../../../..//div[@class="at"]/../../td[@colspan="10" or @colspan="11"]';
						xpathIncomingAttacker = 'id("build")/table[@class="troop_details inAttack" or @class="troop_details inRaid"]/'
							+ 'thead//td[@colspan="10" or @colspan="11"]//'
							+ 'a[contains(@href,"' + getPosFromNewdid(viNewdid)
							+ '")]/../../td[@class="role"]/a[contains(@href,"karte.php?d=")]';
						xpathIncomingAttackerFirstTroop = ""; // not required for travian 4.0
						break;
					default:
						throwLogicError ( "analyzeRallyPoint():: Travian Version not set!!" );
				}
				//flag ( "analyzeRallyPoint():: xpathIncomingAttacks:\n" + xpathIncomingAttacks );
				//flag ( "analyzeRallyPoint():: xpathAttackTimes:\n" + xpathAttackTimes );
				//flag ( "analyzeRallyPoint():: xpathIncomingAttacker:\n" + xpathIncomingAttacker );
				//flag ( "analyzeRallyPoint():: xpathIncomingAttackerFirstTroop:\n" + xpathIncomingAttackerFirstTroop );
				var checkAttack = document.evaluate(xpathIncomingAttacks, aElem, null, XPOrdList, null);
				var attackTimes = document.evaluate(xpathAttackTimes, aElem, null, XPOrdList, null);
				var attackLocs = document.evaluate(xpathIncomingAttacker, aElem, null, XPOrdList, null);
				var attackerFirstTroop = null;
				if ( aTravianVersion == "3.6" )
					attackerFirstTroop = document.evaluate(xpathIncomingAttackerFirstTroop, aElem, null, XPOrdList, null);
				var attackTimesArray = new Array();
				var attackerLocArray = new Array();
				for ( var ctr = 0; ctr < checkAttack.snapshotLength ; ctr++ ) {
					if ( aTravianVersion == "3.6" && attackerFirstTroop.snapshotItem(ctr).innerHTML.match(/\?/) == null )
						continue;
					var attackTime = getRallyArriveTime(attackTimes.snapshotItem(ctr).innerHTML);
					attackTimesArray.push(attackTime);
					//flag ( "analyzeRallyPoint():: ctr: " + ctr + ", attackTime:" + new Date ( parseInt(attackTime) ).toString() );
					var attackLoc = attackLocs.snapshotItem(ctr).getAttribute("href").match(/d=\d{1,}/)[0].match(/\d{1,}/)[0];
					attackerLocArray.push(attackLoc);
					//flag ( "analyzeRallyPoint():: ctr: " + ctr + ", attackLoc:" + attackLoc );
				}
				if ( attackTimesArray.length > 0 ) {
					GM_setValue( myacc() + "_" + viNewdid + "_incomingAttackTimes", attackTimesArray.join("|") );
					GM_setValue( myacc() + "_" + viNewdid + "_incomingAttackers", attackerLocArray.join("|") );
				}
				else {
					//flag ( "analyzeRallyPoint():: No Attack Found!!" );
					//throwLogicError ( "analyzeRallyPoint():: No Attack Found!!" );
					GM_setValue( myacc() + "_" + viNewdid + "_incomingAttackTimes", "" );
					GM_setValue( myacc() + "_" + viNewdid + "_incomingAttackers", "" );
				}
				//GM_setValue( myacc() + "_" + viNewdid + "_incomingAttackTimes", "1299280738008" );

				var attackDetectInterval = parseInt(GM_getValue(myacc() + "_attackDetectInterval", "60"));
				// attackDetectInterval mins +/- random ( attackDetectInterval/2 )
				var randominter1 = Math.ceil ( Math.random() * attackDetectInterval*60*1000 - attackDetectInterval*60*1000/2.0 ) + attackDetectInterval*60*1000;
				var elapseTime1 = serverNowTime + randominter1;
				//flag ( "analyzeRallyPoint():: serverNowTime: " + serverNowTime + ", elapseTime1: " + elapseTime1 );
				//flag ( "analyzeRallyPoint():: serverNowTime: " + new Date(serverNowTime) + ", elapseTime1: " + new Date(elapseTime1) );
				GM_setValue ( myacc() + "_" + viNewdid + "_incomingAttackCheckElapseTime", elapseTime1.toString() );
				flag ( "analyzeRallyPoint():: Incoming attack checked, will refresh again at : " + new Date(elapseTime1) );

				/*
				 * find own incoming troops times...
				 */
				var xpathOwnTroopsTime2  = "";
				switch ( aTravianVersion ) {
					case "3.6":
						xpathOwnTroopsTime2  = 'id("build")/table[@class="troop_details"]/thead//td[@colspan="10" or @colspan="11"]//' +
							'a[ (contains(@href,"spieler.php?uid=' +
							getuid() + '")) and not (contains(@href,"spieler.php?uid=0")) ]/../../td[@class="role"]/a[contains(@href,"' +
							getPosFromNewdid(viNewdid) + '")]/../../../../preceding-sibling::table[@class="troop_details"]' +
							'/thead//td[@colspan="10" or @colspan="11"]//a[not (contains(@href,"spieler.php?uid=' +
							getuid() + '")) and not (contains(@href,"' + 
							getPosFromNewdid(viNewdid) + '")) and not (contains(@href,"spieler.php?uid=0")) ]/../../../..//tbody[@class="infos"]//' +
							'td[@colspan="10" or @colspan="11"]//div[@class="at"]/../../td[@colspan="10" or @colspan="11"]';
						break;
					case "4.0":
						xpathOwnTroopsTime2  = 'id("build")/table[@class="troop_details"]/thead//td[@colspan="10" or @colspan="11"]//' +
							'a[ (contains(@href,"spieler.php?uid=' +
							getuid() + '")) and not (contains(@href,"spieler.php?uid=0")) ]/../../td[@class="role"]/a[contains(@href,"' +
							getPosFromNewdid(viNewdid) + '")]/../../../../preceding-sibling::table[@class="troop_details inReturn"]' +
							'/thead//td[@colspan="10" or @colspan="11"]//a[not (contains(@href,"spieler.php?uid=' +
							getuid() + '")) and not (contains(@href,"' + 
							getPosFromNewdid(viNewdid) + '")) and not (contains(@href,"spieler.php?uid=0")) ]/../../../..//tbody[@class="infos"]//' +
							'td[@colspan="10" or @colspan="11"]//div[@class="at"]/../../td[@colspan="10" or @colspan="11"]';
						break;
					default:
						throwLogicError ( "analyzeRallyPoint():: Travian Version not set!!" );
				}
				//flag ( "analyzeRallyPoint():: xpath:\n" + xpathOwnTroopsTime2 );
				var troopsTimes2 = document.evaluate(xpathOwnTroopsTime2, aElem, null, XPOrdList, null);
				var troopTimesArr = new Array();
				//flag ( "analyzeRallyPoint():: troopsTimes2.snapshotLength:" + troopsTimes2.snapshotLength );
				for ( var ctr = 0; ctr < troopsTimes2.snapshotLength ; ctr++ ) {
					var troopTime2 = getRallyArriveTime(troopsTimes2.snapshotItem(ctr).innerHTML);
					//flag ( "analyzeRallyPoint():: ctr: " + ctr + ", troopTime2: " + new Date(troopTime2) );
					troopTimesArr.push(troopTime2);
				}
				GM_setValue(myacc() + "_" + viNewdid + "_troopsOwnInTimes", troopTimesArr.join("|") );
				//GM_setValue(myacc() + "_" + viNewdid + "_troopsOwnInTimes", "1299280733008" );

				checkForRiskyIncomingAttacks(viNewdid);
				randomizeIncomingTroopsFreshTime();
			}

			/*
			 * find available troops in village...
			 */
			var xpathOwnTroopsType  = "";
			var xpathOwnTroopsCount = "";
			var xpathGetTroopsBackButton = "";
			switch ( aTravianVersion ) {
				case "3.6":
					xpathOwnTroopsType  = 'id("build")/table[@class="troop_details"]/thead'
						+ '//td[@colspan="10" or @colspan="11"]//a[ (contains(@href,"spieler.php?uid='
						+ getuid() + '")) and not (contains(@href,"spieler.php?uid=0")) ]/../../td[@class="role"]/a[contains(@href,"'
						+ getPosFromNewdid(viNewdid)
						+ '")]/../../../..//tbody[@class="units"]/tr[1]/td/img[contains(@class,"unit")]';
					xpathOwnTroopsCount = 'id("build")/table[@class="troop_details"]/thead'
						+ '//td[@colspan="10" or @colspan="11"]//a[ (contains(@href,"spieler.php?uid='
						+ getuid() + '")) and not (contains(@href,"spieler.php?uid=0")) ]/../../td[@class="role"]/a[contains(@href,"'
						+ getPosFromNewdid(viNewdid)
						+ '")]/../../../..//tbody[@class="units"]/tr[2]/td';
					xpathGetTroopsBackButton = ""; // not required for t3.6
					break;
				case "4.0":
					xpathOwnTroopsType  = 'id("build")/a[@name="td"][1]/following-sibling::table[1][@class="troop_details"]/thead'
						+ '//td[@colspan="10" or @colspan="11"]//a[ (contains(@href,"spieler.php?uid='
						+ getuid() + '")) and not (contains(@href,"spieler.php?uid=0")) ]/../../td[@class="role"]/a[contains(@href,"'
						+ getPosFromNewdid(viNewdid)
						+ '")]/../../../..//tbody[@class="units"]/tr[1]/td/img[contains(@class,"unit")]';
					xpathOwnTroopsCount = 'id("build")/a[@name="td"][1]/following-sibling::table[1][@class="troop_details"]/thead'
						+ '//td[@colspan="10" or @colspan="11"]//a[ (contains(@href,"spieler.php?uid='
						+ getuid() + '")) and not (contains(@href,"spieler.php?uid=0")) ]/../../td[@class="role"]/a[contains(@href,"'
						+ getPosFromNewdid(viNewdid)
						+ '")]/../../../..//tbody[@class="units last"]/tr[1]/td';
					xpathGetTroopsBackButton = 'id("build")/a[@name="td"][1]/following-sibling::table[1][@class="troop_details"]/thead'
						+ '//td[@colspan="10" or @colspan="11"]//a[ (contains(@href,"spieler.php?uid='
						+ getuid() + '")) and not (contains(@href,"spieler.php?uid=0")) ]/../../td[@class="role"]/a[contains(@href,"'
						+ getPosFromNewdid(viNewdid)
						+ '")]/../../../..//tbody[@class="infos"]/tr/td/div[@class="sback"]';

					// this is required for new rally point layout of t4.0 as on 17 Oct 2011
					xpathOwnTroopsType_New = 'id("build")/div[@class="data"]/table[@class="troop_details"]/thead'
						+ '//td[@colspan="10" or @colspan="11"]//a[ (contains(@href,"spieler.php?uid='
						+ getuid() + '")) and not (contains(@href,"spieler.php?uid=0")) ]/../../td[@class="role"]/a[contains(@href,"'
						+ getPosFromNewdid(viNewdid)
						+ '")]/../../../..//tbody[@class="units"]/tr[1]/td/img[contains(@class,"unit")]'; 
					xpathOwnTroopsCount_New = 'id("build")/div[@class="data"]/table[@class="troop_details"]/thead'
						+ '//td[@colspan="10" or @colspan="11"]//a[ (contains(@href,"spieler.php?uid='
						+ getuid() + '")) and not (contains(@href,"spieler.php?uid=0")) ]/../../td[@class="role"]/a[contains(@href,"'
						+ getPosFromNewdid(viNewdid)
						+ '")]/../../../..//tbody[@class="units last"]/tr[1]/td';
					xpathGetTroopsBackButton_New = 'id("build")/div[@class="data"]/table[@class="troop_details"]/thead'
						+ '//td[@colspan="10" or @colspan="11"]//a[ (contains(@href,"spieler.php?uid='
						+ getuid() + '")) and not (contains(@href,"spieler.php?uid=0")) ]/../../td[@class="role"]/a[contains(@href,"'
						+ getPosFromNewdid(viNewdid)
						+ '")]/../../../..//tbody[@class="infos"]/tr/td/div[@class="sback"]'
					break;
				default:
					throwLogicError ( "analyzeRallyPoint():: Travian Version not set!!" );
			}
			//flag ( "analyzeRallyPoint():: xpathOwnTroopsType:\n" + xpathOwnTroopsType );
			//flag ( "analyzeRallyPoint():: xpathOwnTroopsCount:\n" + xpathOwnTroopsCount );
			//flag ( "analyzeRallyPoint():: xpathGetTroopsBackButton:\n" + xpathGetTroopsBackButton );
			var troopsTypes = document.evaluate(xpathOwnTroopsType, aElem, null, XPOrdList, null);
			if ( aTravianVersion == "4.0" && troopsTypes.snapshotLength == 0 )
				troopsTypes = document.evaluate(xpathOwnTroopsType_New, aElem, null, XPOrdList, null);
			var troopsCounts = document.evaluate(xpathOwnTroopsCount, aElem, null, XPOrdList, null);
			if ( aTravianVersion == "4.0" && troopsCounts.snapshotLength == 0 )
				troopsCounts = document.evaluate(xpathOwnTroopsCount_New, aElem, null, XPOrdList, null);
			var troopsGetBackButton = null;
			if ( aTravianVersion == "4.0" ) {
				troopsGetBackButton = document.evaluate(xpathGetTroopsBackButton, aElem, null, XPOrdList, null);
				if ( troopsGetBackButton.snapshotLength == 0 )
					troopsGetBackButton = document.evaluate(xpathGetTroopsBackButton_New, aElem, null, XPOrdList, null);
			}
			//flag ( "analyzeRallyPoint():: troopsCounts.snapshotLength: " + troopsCounts.snapshotLength );
			var troopArray = [ 0,0,0,0,0,0,0,0,0,0,0 ];
			var totalTroopsAvailable = 0;
			var myRace = GM_getValue ( myacc() + "_raceID" );
			if ( aTravianVersion == "3.6" || ( aTravianVersion == "4.0" && troopsGetBackButton.snapshotLength == 0 ) ) { // own troops table does not have back button
				for ( var ctr = 0; ctr < troopsTypes.snapshotLength ; ctr++ ) {
					var troopType = -1;
					if ( troopsTypes.snapshotItem(ctr).getAttribute("class") == "unit uhero" )
						troopType = 10;
					else {
						troopType = parseInt(troopsTypes.snapshotItem(ctr).getAttribute("class").match(/\d{1,}/)[0]);
						switch ( myRace ) {
							case "0": // romans
								troopType -=  1; break;
							case "1": // teutons
								troopType -= 11; break;
							case "2": // gauls
								troopType -= 21; break;
						}
					}
					var troopCount = parseInt(troopsCounts.snapshotItem(ctr).innerHTML.match(/\d{1,}/)[0]);
					//flag ( "analyzeRallyPoint():: troopType: " + troopType + ", troopCount: " + troopCount );
					troopArray[troopType] = troopCount;
					totalTroopsAvailable += troopCount;
				}
			}
			troopArray[10] = parseInt(troopArray[10]) > 0 ? troopArray[10] : 0 ; 
			if ( totalTroopsAvailable > 0 )
				GM_setValue(myacc() + "_" + viNewdid + "_troopsAvail", troopArray.join("_") ); // update troops count in cookie
			else
				GM_setValue(myacc() + "_" + viNewdid + "_troopsAvail", "none" ); // update troops count in cookie

			var troopsUpdateInterval = parseInt(GM_getValue(myacc() + "_troopsUpdateInterval", "60"));
			// troopsUpdateInterval mins +/- random ( troopsUpdateInterval/2 )
			var randominter2 = Math.ceil ( Math.random() * troopsUpdateInterval*60*1000 - troopsUpdateInterval*60*1000/2.0 ) + troopsUpdateInterval*60*1000;
			var elapseTime2 = serverNowTime + randominter2;
			//GM_setValue ( myacc() + "_" + viNewdid + "_troopsCheckElapseTime", elapseTime2.toString() );
			//flag ( "analyzeRallyPoint():: Troops count checked, will refresh again at    : " + new Date(elapseTime2) );
			flag ( "analyzeRallyPoint():: Troops Avail count: " + GM_getValue(myacc() + "_" + viNewdid + "_troopsAvail", "none" ) );

			/*
			 * find total troops for the village... (spieler.php?uid=0 is for nature's troops)
			 */
			/*
			var xpathOwnTroopsType2  = 'id("build")/table[@class="troop_details"]/thead//td[@colspan="10" or @colspan="11"]//a[not (contains(@href,"spieler.php?uid=' +
				getuid() + '")) and not (contains(@href,"' + 
				getPosFromNewdid(viNewdid) + '")) and not (contains(@href,"spieler.php?uid=0")) ]/../../../..//tbody[@class="units"]/tr[1]/td/img[contains(@class,"unit")]';
			//flag ( "analyzeRallyPoint():: xpath:\n" + xpathOwnTroopsType2 );
			var xpathOwnTroopsCount2 = 'id("build")/table[@class="troop_details"]/thead//td[@colspan="10" or @colspan="11"]//a[not (contains(@href,"spieler.php?uid=' +
				getuid() + '")) and not (contains(@href,"' +
				getPosFromNewdid(viNewdid) + '")) and not (contains(@href,"spieler.php?uid=0")) ]/../../../..//tbody[@class="units"]/tr[2]/td';
			//flag ( "analyzeRallyPoint():: xpath:\n" + xpathOwnTroopsCount2 );
			var troopsTypes2 = document.evaluate(xpathOwnTroopsType2, aElem, null, XPOrdList, null);
			var troopsCounts2 = document.evaluate(xpathOwnTroopsCount2, aElem, null, XPOrdList, null);
			//flag ( "analyzeRallyPoint():: troopsCounts2.snapshotLength: " + troopsCounts2.snapshotLength );
			var troopArray2 = [ 0,0,0,0,0,0,0,0,0,0,0 ];
			var totalTroopsAvailable2 = 0;
			for ( var ctr = 0; ctr < troopsTypes2.snapshotLength ; ctr++ ) {
				//flag ( "analyzeRallyPoint():: ctr: " + ctr );
				var troopType = 10; // default value is for hero
				if ( troopsTypes2.snapshotItem(ctr).getAttribute("class") != "unit uhero" )
					troopType = parseInt(troopsTypes2.snapshotItem(ctr).getAttribute("class").match(/\d{1,}/)[0]);
				switch ( myRace ) {
					case "0": // romans
						troopType -=  1; break;
					case "1": // teutons
						troopType -= 11; break;
					case "2": // gauls
						troopType -= 21; break;
				}				
				var troopCount = troopsCounts2.snapshotItem(ctr).innerHTML.match(/\d{1,}/);
				troopCount = ( troopCount == null ) ? 0 : parseInt(troopCount[0]);
				troopArray2[troopType] = parseInt(troopArray2[troopType]) > 0 ? troopArray2[troopType] + troopCount : troopCount;
				totalTroopsAvailable2 += troopCount;
			}
			for ( var ctr = 0; ctr < 11 ; ctr++ ) {
				troopArray2[ctr] += troopArray[ctr];
				totalTroopsAvailable2 += troopArray[ctr];
			}
			troopArray2[10] = parseInt(troopArray2[10]) > 0 ? troopArray2[10] : 0 ; 
			if ( totalTroopsAvailable2 > 0 )
				GM_setValue(myacc() + "_" + viNewdid + "_troopsAvailTotal", troopArray2.join("_") ); // update troops count in cookie
			else
				GM_setValue(myacc() + "_" + viNewdid + "_troopsAvailTotal", "none" ); // update troops count in cookie
			flag ("analyzeRallyPoint():: Total Troops count: " + GM_getValue(myacc() + "_" + viNewdid + "_troopsAvailTotal", "none" ) );
			*/

			/*
			 * find when to update troops again...
			 */
			var xpathOwnTroopsTime  = "";
			switch ( aTravianVersion ) {
				case "3.6":
					xpathOwnTroopsTime  = 'id("build")/table[@class="troop_details"]/thead//td[@colspan="10" or @colspan="11"]//' +
						'a[not (contains(@href,"spieler.php?uid=' + getuid() + '")) and not (contains(@href,"' + 
						getPosFromNewdid(viNewdid) + '")) and not (contains(@href,"spieler.php?uid=0")) ]/../../../..//' +
						'tbody[@class="infos"]//td[@colspan="10" or @colspan="11"]' + '//div[@class="at"]/../../td[@colspan="10" or @colspan="11"]';
					break;
				case "4.0":
					xpathOwnTroopsTime  = 'id("build")/table[contains(@class,"troop_details")]/thead//td[@colspan="10" or @colspan="11"]//' +
						'a[not (contains(@href,"spieler.php?uid=' + getuid() + '")) and not (contains(@href,"' + 
						getPosFromNewdid(viNewdid) + '")) and not (contains(@href,"spieler.php?uid=0")) ]/../../../..//' +
						'tbody[@class="infos"]//td[@colspan="10" or @colspan="11"]' + '//div[@class="at"]/../../td[@colspan="10" or @colspan="11"]';
					break;
				default:
					throwLogicError ( "analyzeRallyPoint():: Travian Version not set!!" );
			}
			//flag ( "analyzeRallyPoint():: xpathOwnTroopsTime:\n" + xpathOwnTroopsTime );
			var troopsTimes = document.evaluate(xpathOwnTroopsTime, aElem, null, XPOrdList, null);
			//flag ( "analyzeRallyPoint():: elapseTime2: " + new Date(elapseTime2) );
			var minTime = parseInt(elapseTime2);
			//flag ( "analyzeRallyPoint():: minTime: " + new Date(minTime) );
			//flag ( "analyzeRallyPoint():: troopsTimes.snapshotLength: " + troopsTimes.snapshotLength );
			for ( var ctr = 0; ctr < troopsTimes.snapshotLength ; ctr++ ) {
				var troopTime = getRallyArriveTime(troopsTimes.snapshotItem(ctr).innerHTML);
				minTime = ( troopTime < minTime ) ? troopTime : minTime ;
				//flag ( "analyzeRallyPoint():: ctr: " + ctr + ", troopTime: " + new Date(troopTime) );
				//flag ( "analyzeRallyPoint():: ctr: " + ctr + ", minTime  : " + new Date(minTime) );
			}
			//flag ( "analyzeRallyPoint():: minTime: " + new Date(minTime) );

			var randominter3 = Math.ceil ( Math.random() * 3*60*1000 ) + 1*60*1000; // random ( 3 mins ) + 1 min
			var elapseTime3 = minTime + randominter3;
			//flag ( "analyzeRallyPoint():: randominter3: " + milliSecondstoDHMS(randominter3) );
			//flag ( "analyzeRallyPoint():: elapseTime3: " + new Date(elapseTime3) );
			if ( elapseTime3 < ( serverNowTime + 3*60*1000 ) ) // if elapsetime3 is within 3 mins, then increment it by 3 mins.
				elapseTime3 += 3*60*1000;
			//flag ( "analyzeRallyPoint():: elapseTime3: " + new Date(elapseTime3) );
			GM_setValue(myacc() + "_" + viNewdid + "_troopsCheckElapseTime", elapseTime3.toString() );
			//flag ( "analyzeRallyPoint():: Troops count checked, refresh time changed to  : " + new Date(elapseTime3) );
			flag ( "analyzeRallyPoint():: Troops count checked, will refresh again at    : " + new Date(elapseTime3) );

			//return checkAttack.snapshotLength;
		}
		else {
			var msg = "analyzeRallyPoint():: Invalid argument(s) passed to function!";
			flag ( msg );
			playSound("&nbsp;&nbsp;" + msg + "&nbsp;&nbsp;");
			var errObj = new Error () ;
			errObj.name = "Invalid Argument passed to function";
			errObj.message = msg;
			throw errObj;
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>analyzeRallyPoint():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function playSound(alarmText, endHandler) {
	//flag ( "playSound():: Started!" );
	// play only in login window
	if ( self.window.name == GM_getValue(currentServer()+ '_loginWindow', "noLoginWindow") ) {
		if ( $("alarm_wrapper") == null ) { // do not play if already playing
			if ( alarmText == null || alarmText == "" )
				alarmText = "Unknown";

			/*if ( alarmText.match(/Login Page Found/) != null ) // do not play sound for login page found error
				return;*/

			var soundUrl = GM_getValue ( currentServer() + "_soundUrl", defaultSoundUlrs[1].url );
			flag ( "playSound():: soundUrl: " + soundUrl );
			if ( soundUrl == "" ) {
				var msg = "playSound():: Sound url not set! Cannot Play sound! Set sound url from greasemonkey menu!"; 
				printErrorMSG("<b>" + msg + "</b>");
				TS_debug ( msg );
				var errObj = new Error () ;
				errObj.name = "User Error";
				errObj.message = msg;
				throw errObj;
			}
			var soundLoop = GM_getValue ( currentServer() + "_soundLoop", "0" );
			if ( soundLoop == "1" ) {
				soundLoop = "true";
				//soundLoop = "loop"; // html5 audio
			}
			else {
				soundLoop = "false";
			}

			var alarmForm = document.createElement("div");
			alarmForm.id = "alarmForm";
			// html5 audio, for now firefox supports only wav and ogg audio, & does not support loop
			/*var alarmAnchor = "<audio src='" + soundUrl + "' " +
				"autoplay id='sound1' loop controls='controls'/> " + alarmText;*/
			// embed, this requires some suitable plugin (eg quicktime, flash, windows media player, vlc player plugin, etc), supports most of the audio formats depending upon the plugin installed
			var alarmAnchor = "<embed src='" + soundUrl + "' " +
				"autostart='true' id='sound1' hidden='true' enablejavascript='true' loop='" + soundLoop + "'/> " + alarmText;
			alarmForm.innerHTML = alarmAnchor;

			if ( $("alarm_wrapper") ) {
				$("alarm_wrapper").parentNode.removeChild($("alarm_wrapper"));
				document.removeEventListener( "click", stopSound, false );
			}

			//flag ( "playSound():: soundEmbedStr: " + soundEmbedStr );
			var mWrapper = document.createElement("div");
			mWrapper.appendChild(alarmForm);
			mWrapper.id = "alarm_wrapper";

			var formCoords = getOption("ALARM_POSITION", "40px_200px");
			formCoords = formCoords.split("_");
			mWrapper.style.top = formCoords[0];
			mWrapper.style.left = formCoords[1];

			document.body.appendChild(mWrapper);
			makeDraggable($("alarmForm"));

			document.addEventListener( "click", stopSound, false );

			if ( endHandler != null )
				document.addEventListener( "click", endHandler, false );
		}
		printErrorMSG(alarmText);
		GM_setValue ( myacc() + "_alarmText", alarmText );
		GM_setValue ( myacc() + "_alarmStartTime", new Date().getTime().toString() );
	}
}

function stopSound() {
	if ( $("alarm_wrapper") )
		$("alarm_wrapper").parentNode.removeChild($("alarm_wrapper"));
	document.removeEventListener( "click", stopSound, false );
	var customAlarmTime = GM_getValue(myacc() + "_customAlarmTime", null );
	if ( customAlarmTime != null && customAlarmTime != "" ) { // reset custom alarm, only if it has expired
		var nowTime = new Date().getTime();
		customAlarmTime = new Date(customAlarmTime).getTime();
		if ( nowTime > customAlarmTime ) {
			GM_setValue ( myacc() + "_customAlarmTime", "" );
			flag ( "stopSound():: Stoping Custom Alarm!");
		}
	}
	GM_setValue ( myacc() + "_alarmText", "" );
	GM_deleteValue ( myacc() + "_alarmStartTime" );

	return false;
}

function addTestAlarmInterface() {
	//flag ( "addTestAlarmInterface():: Started!" );
	var soundEnabled = GM_getValue( currentServer() + "_enableCaptchaSound", "1" );
	if ( soundEnabled == "1" ) {
		var testAlarmForm = document.createElement("div");
		testAlarmForm.id = "testAlarmForm";
		var checkAlarmAnchor = "<img src='" + sToggleBtn + "' alt='Check Alarm' style='padding:15px 15px;' />";
		testAlarmForm.innerHTML = checkAlarmAnchor;

		if ( $("test_alarm_wrapper") != null ) 
			document.body.removeChild($("test_alarm_wrapper"));

		var mWrapper = document.createElement("div");
		mWrapper.id = "test_alarm_wrapper";
		mWrapper.appendChild(testAlarmForm);

		var formCoords = getOption("TEST_ALARM_POSITION", "40px_30px");
		formCoords = formCoords.split("_");
		mWrapper.style.top = formCoords[0];
		mWrapper.style.left = formCoords[1];
		mWrapper.title = "In login window double click here to check Captcha Alarm. To stop alarm click anywhere on login window. "
			+"To make this window as your login window right-click here, however first make sure Auto-Task is enabled (Started) first.";
		if ( GM_getValue ( myacc() + "_doing", "0" ) == "1" ) {
			mWrapper.style.backgroundColor = "HoneyDew";
		}
		else {
			mWrapper.style.backgroundColor = "LightCoral";
		}

		document.body.appendChild(mWrapper);
		$("test_alarm_wrapper").addEventListener( 'dblclick',
				function() { playSound("&nbsp;&nbsp;Manual Testing of Alarm!&nbsp;&nbsp;"); return false; } , false);
		$("test_alarm_wrapper").addEventListener( 'mousedown', startIterationHereIfRightClick, false);
		makeDraggable($("testAlarmForm"));
	}
}

function startIterationHereIfRightClick(e) {
	try {
		//flag ( "startIterationHereIfRightClick:: Started!" );
		var rightclick;
		if (!e) var e = window.event;
		if (e.which) rightclick = (e.which == 3);
		else if (e.button) rightclick = (e.button == 2);
		if ( rightclick ) {
			//flag ( "startIterationHereIfRightClick():: Starting iteration on this window!" );
			// will start only if _doing is 1, ow we might interrupt some executing task on the previous login window.
			if ( GM_getValue ( myacc() + "_doing", "0" ) == "1" ) {
				self.window.name = "LoginWindow--" + Math.ceil(Math.random()*100000);
				GM_setValue(currentServer() + '_loginWindow', self.window.name);
				startIterationOnlyOnLoginWindow(); // start iteration on login window
				document.title = document.title + " GAT LW"; // change window title.
				showTaskList(); // change the color of the task list.
			}
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>startIterationHereIfRightClick():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function showInfoBubble(text) {
	//flag ("showInfoBubble():: Started!"); 
	var showInfoBubbleForm = document.createElement("div");
	showInfoBubbleForm.id = "showInfoBubbleForm";
	showInfoBubbleForm.innerHTML = "&nbsp;&nbsp;" + text + "&nbsp;&nbsp;";

	if ( $("show_info_bubble_wrapper") != null ) 
		document.body.removeChild($("show_info_bubble_wrapper"));

	var mWrapper = document.createElement("div");
	mWrapper.id = "show_info_bubble_wrapper";
	mWrapper.appendChild(showInfoBubbleForm);

	var formCoords = getOption("SHOW_INFO_BUBBLE_POSITION", "100px_80px");
	formCoords = formCoords.split("_");
	mWrapper.style.top = formCoords[0];
	mWrapper.style.left = formCoords[1];

	document.body.appendChild(mWrapper);
	makeDraggable($("showInfoBubbleForm"));
}

function showLoginBubble(text) {
	flag ("showLoginBubble():: Started!"); 
	var showLoginBubbleForm = document.createElement("div");
	showLoginBubbleForm.id = "showLoginBubbleForm";
	showLoginBubbleForm.innerHTML = "&nbsp;&nbsp;" + text + "&nbsp;&nbsp;";

	if ( $("show_login_bubble_wrapper") != null ) 
		document.body.removeChild($("show_login_bubble_wrapper"));

	var mWrapper = document.createElement("div");
	mWrapper.id = "show_login_bubble_wrapper";
	mWrapper.appendChild(showLoginBubbleForm);

	var formCoords = "120px_80px";
	formCoords = formCoords.split("_");
	mWrapper.style.top = formCoords[0];
	mWrapper.style.left = formCoords[1];

	document.body.appendChild(mWrapper);
}

function gatherStatsFromCurrentPage() {
	try {
		//flag ( "gatherStatsFromCurrentPage():: Started!" );

		// if current page is plus page showing available gold
		if ( window.location.href.indexOf("plus.php") != -1 && window.location.href.match(/\bid=3\b/) != null ) {
			getPlusDoubleBuildStatus(document.body.innerHTML);
		}

		getResourceCap(document, currentID());

		if ( GM_getValue ( myacc() + "_updateStatsOnUserActivity", "0" ) == "1" ) {
			refreshPageInfo(document.body);

			// get _WarehouseCap, _ResourceNow & _GranaryCap (can be fetched from any page), _singleTownNEWDID must be first set for single village.
			//flag ("gatherStatsFromCurrentPage():: calling getResourceCap()");

			// if current page is rally point
			if ( window.location.href.indexOf("build.php") != -1 &&
				( window.location.href.match(/\bgid=16\b/) != null ||
				window.location.href.match(/\bid=39\b/) != null ) ) {
				var incomingAttack = analyzeRallyPoint(document.body,currentID(),false);
			}

			// if current page is dorf1.php
			if ( window.location.href.indexOf("dorf1.php") != -1 ) {
				getStatsFromDorf1 ( document.body, currentID() );
			}

			// if current page is dorf2.php
			if ( window.location.href.indexOf("dorf2.php") != -1 ) {
				getStatsFromDorf2 ( document.body, currentID() );
			}
		}
		else {
			// if current page is dorf1.php
			if ( window.location.href.indexOf("dorf1.php") != -1 ) {
				refreshDorf1MapData(document, currentID());
			}

			// if current page is dorf2.php
			if ( window.location.href.indexOf("dorf2.php") != -1 ) {
				refreshDorf2MapData(document, currentID());
			}
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>gatherStatsFromCurrentPage():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

function getStatsFromDorf1 ( aElem, vi ) {
	try {
		collectAutoResDataFromDorf1 ( vi, aElem );
		var myRace = GM_getValue ( myacc() + "_raceID" );
		switch ( myRace ) {
			case "0": // romans
				if ( GM_getValue( myacc() + "_" + vi + "_ResourceTaskExists", "0") == "1" )
					getBuildCompletionTimesFromDorf1Or2( vi, allsourceString, aElem );
				else if ( GM_getValue( myacc() + "_" + vi + "_BuildingTaskExists", "0") == "1" )
					getBuildCompletionTimesFromDorf1Or2( vi, allbuildString, aElem );
				break;
			case "1": // non-romans
			case "2":
				if ( GM_getValue( myacc() + "_" + vi + "_UpdataTaskExists", "0") == "1" )
					getBuildCompletionTimesFromDorf1Or2( vi, allString, aElem );
				break;
		}
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getStatsFromDorf1():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}

}

function getStatsFromDorf2 ( aElem, vi ) {
	try {
		var myRace = GM_getValue ( myacc() + "_raceID" );
		switch ( myRace ) {
			case "0": // romans
				if ( GM_getValue( myacc() + "_" + vi + "_ResourceTaskExists", "0") == "1" )
					getBuildCompletionTimesFromDorf1Or2( vi, allsourceString, aElem );
				else if ( GM_getValue( myacc() + "_" + vi + "_BuildingTaskExists", "0") == "1" )
					getBuildCompletionTimesFromDorf1Or2( vi, allbuildString, aElem );
				break;
			case "1": // non-romans
			case "2":
				if ( GM_getValue( myacc() + "_" + vi + "_UpdataTaskExists", "0") == "1" )
					getBuildCompletionTimesFromDorf1Or2( vi, allString, aElem );
				break;
		}
		getCrannies ( aElem, vi );
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getStatsFromDorf2():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}

}

function getCrannies ( aElem, vi ) {
	try {
		var xpathCranny = "";
		switch ( aTravianVersion ) {
			case "3.6": xpathCranny = 'id("map2")//area[contains(@title,"' + aLangAllBuildWithId[23] + '")]'; break;
			case "4.0": xpathCranny = 'id("clickareas")//area[contains(@alt,"' + aLangAllBuildWithId[23] + '")]'; break;
			default: throwLogicError ( "getCrannies():: Travian Version not set!!" );
		}
		//flag ("getCrannies():: xpathCranny: " + xpathCranny );
		var thebuild = document.evaluate( xpathCranny, aElem, null, XPOrdList, null); // gid 23 is cranny
		var crannies = new Array();
		var totalCapacity = 0;
		for ( var ctr = 0 ; ctr < thebuild.snapshotLength ; ctr++ ) {
			if ( thebuild.snapshotItem(ctr).title.indexOf(aLangAllBuildWithId[23]) != -1 ) {
				var id = thebuild.snapshotItem(ctr).href.match(/\bid=\d{1,}\b/)[0].split("=")[1];
				var level = thebuild.snapshotItem(ctr).title.match(/\b\d{1,}\b/)[0];
				var capacity = crannyCapacity[parseInt(level)];
				var myRace = GM_getValue ( myacc() + "_raceID", "0" );
				if ( myRace == "2" ) { // for gauls crannies are twice as large.
					capacity = capacity * 2;
				}
				crannies.push(id+"_"+level+"_"+capacity);
				totalCapacity += capacity;
			}
		}
		GM_setValue(myacc() + "_" + vi + "_crannies", crannies.join("|") );
		GM_setValue(myacc() + "_" + vi + "_cranniesTotalCap", totalCapacity );
	}
	catch ( err ) {
		printStackTrace();
		var msg = "<b>getCrannies():: Something went wrong, error: " + err.name + ", Error Message: " + err.message + "</b>";
		playSound ( msg );
		throw err;
	}
}

var AnotherAutoUpdater = { // update script by sizzlemctwizzle THANKS! http://userscripts.org/scripts/show/38017
 
	id: '95032', 
	days: 5, 
	name: /\/\/\s*@name\s+(.*)\s*\n/i.exec(scr_meta)[1],
	version: /\/\/\s*@version\s+(.*)\s*\n/i.exec(scr_meta)[1].replace(/\./g, ''),
	time: new Date().getTime(),
	call: function ( flg ) {
		var response;
		//flag ( "AnotherAutoUpdater.call():: Started! flg: " + flg );
		//flag ( "AnotherAutoUpdater.call():: url: " + 'http://userscripts.org/scripts/source/'+this.id+'.meta.js' );
		GM_xmlhttpRequest({
			method: 'GET',
			url: 'http://userscripts.org/scripts/source/'+this.id+'.meta.js',
			onload: function(xpr) {
				//flag ( "AnotherAutoUpdater.call():: CallBack Started!" );
				AnotherAutoUpdater.compare ( xpr, flg );
			},
			onerror: function(xpr) {
				//flag ( "AnotherAutoUpdater.call():: CallBack Failed!" );
				GM_setValue ( 'updated_' + this.id, ( this.time - (1000*60*60*24 * this.days) + 12*60*60*1000 ) + '' ); // delay re-check by 12 hour
			}
		});
	},
	compare: function ( xpr, flg ) {
		//flag ( "AnotherAutoUpdater.compare():: Started! flg: " + flg );
		//flag ( "AnotherAutoUpdater.compare():: xpr.responseText: " + xpr.responseText );
		if ( xpr.responseText.match ( /404 Not Found/i ) || xpr.responseText.match ( /bad gateway/i ) ) {
			GM_setValue ( 'updated_' + this.id, ( this.time - (1000*60*60*24 * this.days) + 12*60*60*1000 ) + '' ); // delay re-check by 12 hour
			return false;
		}
		this.xversion = /\/\/\s*@version\s+(.*)\s*\n/i.exec ( xpr.responseText );
		this.xname = /\/\/\s*@name\s+(.*)\s*\n/i.exec ( xpr. responseText );
		if ( (this.xversion) && (this.xname[1] == this.name) ) {
			this.xversion = this.xversion[1].replace(/\./g, '');
			this.xname = this.xname[1];
		} else {
			if ( (xpr.responseText.match("the page you requested doesn't exist")) || (this.xname[1] != this.name) ) 
			GM_setValue ( 'updated_' + this.id, ( this.time - (1000*60*60*24 * this.days) + 12*60*60*1000 ) + '' ); // delay re-check by 12 hour
			//GM_setValue('updated_'+this.id, 'off');
			return false;
		}
		//flag ( "AnotherAutoUpdater.compare():: this.xversion: " + this.xversion + ", this.xname: " + this.xname );
		var msg = '';//'If you like this script, then buy me a burger, sandwitch, chocolates, sweets or a beer from the script\'s home-page @ userscripts.org ... !! :)';
		if ( ( +this.xversion > +this.version ) && ( confirm ( 'A new version of the \'' + this.xname + '\' user script is available. Do you want to update?\n\n' + msg ) ) ) {
			//GM_setValue ( 'updated_' + this.id, this.time + '' );
			GM_setValue ( 'updated_' + this.id, ( this.time - (1000*60*60*24 * this.days) + 24*60*60*1000 ) + '' ); // delay re-check by 24 hour
			//top.location.href = 'http://userscripts.org/scripts/source/'+this.id+'.user.js'; // install user script with-out opening userscript page
			//window.open ( 'http://userscripts.org/scripts/show/'+this.id ); // open userscript page in new tab
			window.location.href = 'http://userscripts.org/scripts/show/'+this.id; // open userscript page in current tab
		} else if ( ( this.xversion ) && ( +this.xversion > +this.version ) ) {
			if ( confirm ( 'Do you want to turn off auto updating for this script?' ) ) {
				GM_setValue ( 'updated_' + this.id, 'off' );
				GM_registerMenuCommand ( "GAT: Auto Update " + this.name,
						function() { GM_setValue ( 'updated_' + AnotherAutoUpdater.id, new Date().getTime() + '' ); AnotherAutoUpdater.call(true); } );
				alert ( 'Automatic updates can be re-enabled for this script from the User Script Commands submenu.' );
			} else {
				GM_setValue ( 'updated_' + this.id, ( this.time - (1000*60*60*24 * this.days) + 24*60*60*1000 ) + '' ); // delay re-check by 24 hour
				//GM_setValue ( 'updated_'+this.id, this.time + '' );
			}
		} else {
			if ( flg ) alert ( 'No updates available for ' + this.name );
			GM_setValue ( 'updated_' + this.id, this.time + '' );
		}
	},
	check: function() {
		//flag ( "AnotherAutoUpdater.check():: Started!" );
		if ( GM_getValue ( 'updated_'+this.id, 0 ) == "off" )
			GM_registerMenuCommand ( "GAT: Enable " + this.name + " updates",
					function() { /*GM_setValue ( 'updated_' + AnotherAutoUpdater.id, new Date().getTime() + '' );*/ AnotherAutoUpdater.call(true) } );
		else {
			if ( +this.time > ( + GM_getValue ( 'updated_' + this.id, 0 ) + 1000*60*60*24 * this.days ) ) {
				//GM_setValue ( 'updated_' + this.id, this.time + '' );
				this.call(false);
			}
			GM_registerMenuCommand ( "GAT: Check " + this.name + " for updates",
				function() { /*GM_setValue ( 'updated_' + AnotherAutoUpdater.id, new Date().getTime() + '' );*/ AnotherAutoUpdater.call(true) } );
		}
	}
};

/*************************************** main function start **********************************************/
function INIT() {
	try {
		if ( document.body == null ) {
			GM_log ( "INIT():: document.body is null!'" );
			return;
		}
		var loginButton = getLoginButton(document);
		if ( window.location.href.indexOf("login.php") == -1 && 
			window.location.href.indexOf("logout.php") == -1 &&
			window.location.href.split("/")[3] && 
			window.location.href.split("/")[3].length > 0 &&
			loginButton == null ) {
	
			getuid(); // call to set the travian version
			customizeLangFromCookie(); // incorporate custom user translations from cookie
			setupGreaseMonkeyMenu();

			// GotGs 2011.01.15 -- Check if recaptcha.net!!! If yes then stop script and play sound!!
			if ( gatherStats(document.body.innerHTML) == false ) {

				// add div which enables manual checking of captcha sound url.
				addTestAlarmInterface();

				flag ( "INIT():: Auto Task Script Starting %=================================%%=================================%");
				//flag ( "INIT():: window.location.href: " + window.location.href );
				//flag ( "INIT():: self.window.name: " + self.window.name );

				var loginWindowName = GM_getValue(currentServer() + '_loginWindow', "noLoginWindow");
				//TS_debug("loginWindowName " + loginWindowName + "self.window.name " + self.window.name);

				if ( Number(GM_getValue(currentServer() + '_loginDetected',"0")) > 0 && self.window.name == loginWindowName ) {
					printErrorMSG ( "Wait, gathering stats, login stage: " 
						+ GM_getValue(currentServer() + '_loginDetected',"0") );

					// if alarm was being played for login page found, then disable it.
					var alarmText = GM_getValue ( myacc() + "_alarmText", "" );
					if ( alarmText != "" && alarmText.match(/Login Page Found/i) != null  )
						GM_setValue ( myacc() + "_alarmText", "" );
					else if ( alarmText != "" && alarmText.match(/reloading login window/i) != null )
						printErrorMSG ( "INIT():: Login Window reloaded!" );
				}

				if ( self.window.name == loginWindowName ) {
					document.title = document.title + " - GAT LW"; // change window title.
				}

				var timeBetweenLoginHrefLoads = 2000;
				// get _singleTownNEWDID if not already set, this should always be the first thing to do..
				if ( ! GM_getValue(myacc() + '_singleTownNEWDID') ) { // if _singleTownNEWDID is not set
					printErrorMSG ( "Wait, _singleTownNEWDID not set, loading dorf3.php" );
					if ( window.location.href.indexOf("dorf3.php") == -1 ) { // not dorf3.php then load dorf3.php
						printErrorMSG ( "<b>Wait, _singleTownNEWDID not set, loading dorf3.php</b>" );
						flag ("INIT():: _singleTownNEWDID is not set, loading dorf3.php ");
						window.setTimeout ( function() { 
									window.location.replace (myhost + "/dorf3.php" );
								},
								Math.ceil ( Math.random() * timeBetweenLoginHrefLoads + timeBetweenLoginHrefLoads ) );
					}
					else { // if dorf3.php then get _singleTownNEWDID and then load profile page
						flag ("INIT():: calling getSingleVillageNum()");
						getSingleVillageNum();
						flag ("INIT():: _singleTownNEWDID is now set, loading profile page" );
						window.setTimeout ( function() { 
									window.location.replace ( myhost + "/spieler.php" );
								},
								Math.ceil ( Math.random() * timeBetweenLoginHrefLoads + timeBetweenLoginHrefLoads ) );
					}
				}
				else { // if _singleTownNEWDID is set
					// set global variables
					//flag ("INIT():: calling setGlobalVars()");
					setGlobalVars();

					if ( GM_getValue(currentServer() + '_loginDetected',"0") == "1" && self.window.name == loginWindowName ) { // login stage 1
						flag ( "INIT():: Login Stage: " + GM_getValue(currentServer() + '_loginDetected',"0") );
						if ( window.location.href.indexOf("dorf1.php") == -1 ) {
							flag ("INIT():: Login Stage 1 page is not dorf1.php, hence loading dorf1.php");
							window.setTimeout ( function() { 
										window.location.replace ( myhost + "/dorf1.php" );
									},
									Math.ceil ( Math.random() * timeBetweenLoginHrefLoads + timeBetweenLoginHrefLoads ) );
						}
						else {
							if ( GM_getValue(myacc() + '_singleTownNEWDID', "") == "" ) {
								flag ("INIT():: Now loading dorf3.php to fetch _singleTownNEWDID");
							GM_setValue(currentServer() + '_loginDetected', "2");
								window.setTimeout ( function() { 
											window.location.replace ( myhost + "/dorf3.php" );
										},
										Math.ceil ( Math.random() * timeBetweenLoginHrefLoads + timeBetweenLoginHrefLoads ) );
							}
							else {
								flag ("INIT():: Now loading profile page");
								GM_setValue(currentServer() + '_loginDetected', "2");
								window.setTimeout ( function() { 
											window.location.replace ( myhost + "/spieler.php" );
										},
										Math.ceil ( Math.random() * timeBetweenLoginHrefLoads + timeBetweenLoginHrefLoads ) );
							}
						}
					}
					else if ( GM_getValue(currentServer() + '_loginDetected',"0") == "2" && self.window.name == loginWindowName ) { // login stage 2
						flag ( "INIT():: Login Stage: " + GM_getValue(currentServer() + '_loginDetected',"0") );
						if ( window.location.href.indexOf("/spieler.php") == -1 ) {
							flag ("INIT():: Login Stage 2 page is not profile page, hence loading profile page");
							window.setTimeout ( function() { 
										window.location.replace ( myhost + "/spieler.php" );
									},
									Math.ceil ( Math.random() * timeBetweenLoginHrefLoads + timeBetweenLoginHrefLoads ) );
						}
						else {
							// get _raceID, _mainvillageId, _mainvillageName, _mainVillagePosition, _mainVillageCoord if 
							// current page is profile page
							//flag ("INIT():: calling getMainVillageid()");
							getMainVillageid();
							flag ("INIT():: Now loading dorf1.php again");
							GM_setValue(currentServer() + '_loginDetected', "3");
							window.setTimeout ( function() { 
										window.location.replace ( myhost + "/dorf1.php" );
									},
									Math.ceil ( Math.random() * timeBetweenLoginHrefLoads + timeBetweenLoginHrefLoads ) );
						}
					}
					else if ( GM_getValue(currentServer() + '_loginDetected',"0") == "3" && self.window.name == loginWindowName ) { // login stage 3
						flag ( "INIT():: Login Stage: " + GM_getValue(currentServer() + '_loginDetected',"0") );
						if ( window.location.href.indexOf("dorf1.php") == -1 ) {
							flag ("INIT():: Login Stage 3 page is not dorf1.php, hence loading dorf1.php");
							window.setTimeout ( function() { 
										window.location.replace ( myhost + "/dorf1.php" );
									},
									Math.ceil ( Math.random() * timeBetweenLoginHrefLoads + timeBetweenLoginHrefLoads ) );
						}
						var foundVillageWithResRateNotSet = false;
						for (var v in getAllVillageNewdids()) {
							if ( GM_getValue(myacc() + "_" + getAllVillageNewdids()[v] + "_ResourceRate", "false") == "false" ) {
								foundVillageWithResRateNotSet = true;
								printErrorMSG ( "Wait, loading dorf1.php?newdid="+getAllVillageNewdids()[v]+" to get _ResourceRate!" );
								flag ("INIT():: Loading dorf1.php?newdid="+getAllVillageNewdids()[v]+" to get _ResourceRate!");
								window.setTimeout ( function() { 
											window.location.replace ( myhost + "/dorf1.php?newdid="+getAllVillageNewdids()[v] );
										},
										Math.ceil ( Math.random() * timeBetweenLoginHrefLoads + timeBetweenLoginHrefLoads ) );
								break;
							}
						}
						if ( foundVillageWithResRateNotSet == false ) {
							// get _allVillagePos from any non-profile page, for single village 
							// _mainvillageName & _mainVillagePosition must be already set.
							if (window.location.href.indexOf("&s=4") == -1) {
								//flag ("INIT():: calling getallVillagePos()");
								getallVillagePos();
							}
							printErrorMSG ( "Login Complete, loading profile page to start iteration" );
							printErrorMSG ( "To add tasks, open *Non-Login Windows* using 'right click' -> 'open in new tab/window'." );
							printErrorMSG ( "To start Auto-Task click on .START link on task-list." );
							flag ("INIT():: Now loading profile page to start iteration");
							GM_setValue(currentServer() + '_loginDetected', "0");
							window.setTimeout ( function() { 
										reloadLoginWindow();
										//window.location.replace ( myhost + "/spieler.php" );
									},
									Math.ceil ( Math.random() * timeBetweenLoginHrefLoads + timeBetweenLoginHrefLoads ) );
						}
					}
					else if ( self.window.name == loginWindowName ) { // if login window
						//flag ("INIT():: calling showTaskList()");
						showTaskList();	// show task-list for the 1st time.
						printMSG(); printErrorMSG();

						// if sleeping then show sleeping bubble.
						checkIsSleepTime();

						checkMailAndPlayAlarm(document.body.innerHTML);

						startIterationOnlyOnLoginWindow(); // start iteration on login window

						// convert all anchors to include newdid
						if ( GM_getValue ( myacc() + "_convertAnchors", "0" ) == "1" )
							convertAllAnchors();

						gatherStatsFromCurrentPage();
					}
					else { // if not login window
						//flag ("INIT():: calling showTaskList()");
						showTaskList();	// show task-list for the 1st time.
						printMSG(); printErrorMSG();
					
						// if sleeping then show sleeping bubble.
						checkIsSleepTime();

						// create auto-task links on travian pages.
						createAutoTaskLinksOnTravianPages();

						// convert all anchors to include newdid
						if ( GM_getValue ( myacc() + "_convertAnchors", "0" ) == "1" )
							convertAllAnchors();

						gatherStatsFromCurrentPage();
						AnotherAutoUpdater.check();
					}
				}
			}
			else {
				if ( GM_getValue( currentServer() + "_enableCaptchaSound", "1" ) == "1" ) {
					playSound("&nbsp;&nbsp;Captcha Found!!!&nbsp;&nbsp;");
				}
			}
		}
		//flag ( "INIT():: Finished!" );
	}
	catch ( err ) {
		printStackTrace();
		var randominter = Math.ceil ( Math.random() * 5*1000 + 5*1000 ); // random ( 5 sec ) + 5 sec
		var msg = "<b>INIT():: Something went wrong, error: " + err.name + ", Error Message: " + err.message +
			". Attempting to refresh page in " + ( Math.ceil ( ( randominter * 100 ) / 1000 ) / 100 ) + " secs...</b>";
		playSound ( msg );
		//throw err;
		window.setTimeout ( function() { 
					window.location.reload();
				},
				randominter );
	}
}

INIT();

};

//GM_log ( "Before document.onreadystatechange! document.readyState: " + document.readyState );
//document.onreadystatechange = functionMain();
/*document.onreadystatechange = function () {
	GM_log ( "document.onreadystatechange handler():: document.readyState: " + document.readyState );
	if (document.readyState == "complete") { // TODO: this will never work as firefox never gets the complete event!!!
		functionMain();
	}
}();*/
//window.onload = functionMain();
window.onDOMContentLoaded = functionMain();



/*
 * GotGS Rough Notes:-
 * *************************************
_newdid_taskOption	-- setVillageOption(key, value)	-- village specific set & get options
			-- getVillageOption(key, defaultValue, type)
_undefined_taskOption	-- one should not get these.

_newdid_WarehouseCap
_newdid_ResourceNow
_newdid_GranaryCap	-- getResourceCap()		-- called from init
				-- available from any page
			-- getTargetResource(vi)
				-- fleshTraning(vi, tTask)	-- called from eachTimedo()
					-- for auto transport [construction support] for target village

_newdid_ResourceRate	-- getResourceRate()		-- called from init
				-- available only from dorf1.php !!!!! and required only once ber village.
			-- used only in getAutoResourceId(vi)
				-- used only in auto-resource

_allVillagePos		-- getallVillagePos()		-- called from init
				-- works only on non-profile page
				-- in case of single village
					-- gets info from _mainvillageName & _mainVillagePosition
				-- curently not working for multiple villages !!!!
					-- gets info from village list on right of web page

_raceID
_mainvillageId
_mainvillageName
_mainVillagePosition
_mainVillageCoord	-- getMainVillageid()		-- called from init
				-- works only on profile page

_singleTownNEWDID	-- getSingleVillageNum()	-- called from init & login check
				-- http requests dorf3.php to get the info


_Timer_ccclock
_Timer_checkForUserActivity
_doing
_lastUsrActTime
_option

_loginDetected

*/

/*
 * Task Id Meaning -->
 * 0 [ resource / building upgrades ]
 * 1 [ newbuild building ]
 * 2 [ attack normal / raid, reinforce ]
 * 3 [ Blacksmith Improve Offense, Armoury Improve Defense ]
 * 4 [ Train Troops ]
 * 5 [ Auto Transport ]
 * 6 [ Party Small / Big ]
 * 7 [ Deomolish Buildings ]
 * 8 [ Custom Transport ]
 */

/*
 * showTaskList, eachtimedo task differentiaton -->
 *
 * _1
 * 2 [ attack normal / raid, reinforce ]
 *
 * _2
 * 4 [ Train Troops ]
 * 8 [ Custom Transport ]
 * 6 [ Party Small / Big ]
 * 3 [ Blacksmith Improve Offense, Armoury Improve Defense ]
 *
 * _3
 * 5 [ Auto Transport ]
 *
 * _4 romans resource upgrades
 * 0 [ resource / building upgrades ] -- filter out buildings
 *
 * _5 romans building upgrades
 * 0 [ resource / building upgrades ] -- filter out resources
 * 1 [ newbuild building ]
 *
 * _6 other races
 * 0 [ resource / building upgrades ]
 * 1 [ newbuild building ]
 *
 * _7
 * 7 [ Deomolish Buildings ]
 *
 */

/*
 * Definition of map.sql.gz file
 *
 *
    ID: Number of the field, starts in the top left corner at the coordinate (-400|400) and ends in the bottom right corner at (400|-400).
    X: X-Coordinate of the village.
    Y: Y-Coordinate of the village.
    TID: The tribe number. 1 = Roman, 2 = Teuton, 3 = Gaul, 4 = Nature and 5 = Natars
    VID: Village number. The unique ID for the village.
    Village: The name of the village.
    UID: The player’s unique ID, also known as User-ID.
    Player: The player name.
    AID: The alliance’s unique ID.
    Alliance: The alliance name.
    Population: The village’s number of inhabitants without the troops.
 * 
 */
