// ==UserScript==
// @name        Navigation rapide
// @description Ajoute des fonctionnalités améliorant votre navigation sur le jeu en ligne Les Royaumes Renaissants
// @include     http://www.lesroyaumes.com/EcranPrincipal.php*
// @require     http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js
// @require     http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js
// @version     2
// ==/UserScript==

function Cookie(e,t){date=new Date;Day=date.getHours()>=4?date.getDate()+1:date.getDate();Month=date.getMonth();Year=date.getFullYear();MAJ=new Date(Year,Month,Day,"4","10");var n="; expires="+MAJ.toGMTString();document.cookie=e+"="+t+n+"; path=/"}function readCookie(e){var t=e+"=";var n=document.cookie.split(";");for(var r=0;r<n.length;r++){var i=n[r];while(i.charAt(0)==" ")i=i.substring(1,i.length);if(i.indexOf(t)==0)return i.substring(t.length,i.length)}return null}$(function(){var e=new Date;var t=e.getDay();var n=e.getHours();var r={TextButton:["Mairie","Marché","Taverne","Eglise","Mine(s)","Champ","Champ","Elections","Offres d'emploi","Sénéchaussée","Université","Forum 1","Forum 2"],IconButton:[5,8,1,2,4,2,2,6,8,5,6,6,6],LinkButton:["?l=3&a=4","?l=6","?l=5","?l=4","?l=8&a=1","?l=1&a=2","?l=1&a=3","?l=3&a=1","?l=3&a=2","?l=7","?l=7&a=2","/Action.php?action=198&redir=1","/Action.php?action=198&redir=3"],TypeField:["Blé","Maïs","Vaches","Moutons","Cochons"],construct:function(){if(!readCookie("OranRRChamp")){console.log("Réactualisation des données");this.ajax(1,r.field)}this.toString();this.css()},css:function(){$("#sortable").css({width:"125px","list-style-type":"none",margin:"0",padding:"0"});$(".zonePubDroite .zone_menu").css({padding:"10px 0 10px 10px",borderRadius:"6px 0px 0px 6px",width:"135px",marginRight:"0px"});$(".zonePubDroite").css({marginLeft:"0px",background:"none"});$(".cadre_interieurPub, .ensemble .cadre_interieur").css({width:"1098px"});$(".cadre_interieurPub .colonneContenu").css({width:"800px"})},ajax:function(e,t){if(e&&t){e=encodeURIComponent(e);GM_xmlhttpRequest({method:"GET",url:"EcranPrincipal.php?l="+e,onload:function(e){return t(e.responseText)}})}},field:function(e){var t=new RegExp('Mon premier champ.*<img src="images/commun/champs/champ([0-9]{1}).*width="202px" height="114px"></p><p class="infosChamp">.*([0-9]{1,2} / [0-9]{1,2})',"gi");var n=new RegExp('Mon second champ.*<img src="images/commun/champs/champ([0-9]{1}).*width="202px" height="114px"></p><p class="infosChamp">.*([0-9]{1,2} / [0-9]{1,2})',"gi");if(t.exec(e)){var r={};r.type=RegExp.$1;r.day=RegExp.$2;Cookie("OranRRChamp1",JSON.stringify(r))}if(n.exec(e)){var r={};r.type=RegExp.$1;r.day=RegExp.$2;Cookie("OranRRChamp2",JSON.stringify(r))}},getStatusMass:function(){var e=window.localStorage.getItem("JourMesse")?parseInt(window.localStorage.getItem("JourMesse")):null;if(t===0){var r=window.localStorage.getItem("MesseDimanche")?parseInt(window.localStorage.getItem("MesseDimanche")):"";var i=r+2;if(r<=n&&n<i){return true}}if(t===e){var r=window.localStorage.getItem("MesseRR")?parseInt(window.localStorage.getItem("MesseRR")):"";var i=r+2;if(r<=n&&n<i){return true}}return false},getStatusField:function(e){var n="OranRRChamp"+e;var r=readCookie(n);var s=false;n="Champ "+e;if(r){Field=JSON.parse(r);i=e-1;Type=this.TypeField[Field.type-1];Status=Field.day;t=Status.split("/");if(Field.type==="2"&&(t[0]==7||t[0]==1)){s=true}else if(Field.type==="1"&&(t[0]==10||t[0]==1||t[0]==2)){s=true}Status="("+Status+")";n=Type+' <span id="OranChamp'+e+'">'+Status+"</span>"}return[n,s]},toString:function(){var e=$("div.zonePubDroite");var t="";var n=0;var r,i,s,o,u;if(window.localStorage.getItem("NROran")){Buttons=window.localStorage.getItem("NROran").split(",");Default=false}else{Buttons=this.TextButton;Default=true}for(var f in Buttons){a=Default?f:Buttons[f];r=2;i="";s=this.TextButton[a]?this.TextButton[a]:"Lien "+a;o=this.IconButton[a]?this.IconButton[a]:5;u="";if(s==="Champ"){n=n+1;Field=this.getStatusField(n);s=Field[0];r=Field[1]?3:2}if(s==="Forum 1"||s==="Forum 2"){i='target="_blank"'}if(s==="Eglise"){if(this.getStatusMass()){r="3";s="Eglise : Messe"}}t+='<li data-bouton="'+a+'"><a class="btns'+r+'" href="'+this.LinkButton[a]+'" '+i+'><span class="iconeMenu iconeMenu'+o+'"><span class="iconeMenuInterne"></span></span><span class="btnsMenu_Texte">'+s+"</span></a></li>"}config=window.localStorage?'- <a id="ConfigNav" title="Paramètres"><i class="ui-icon ui-icon-gear"style="display: inline-block"></i></a>':"";e.html('<div class="zone_menu"><span style="color: #B15714">Navigation rapide</span> '+config+' <br /><br /><ul id="sortable">'+t+'</ul><span style="color: #B15714">Par <a href="javascript:popupPerso(\'FichePersonnage.php?login=orandin\')">Orandin</a> - 2013</span></div>');$("#sortable").sortable({placeholder:"ui-state-highlight",axis:"y",opacity:.7,containment:"parent",update:function(e,t){var n=$("#sortable").sortable("toArray",{attribute:"data-bouton"}).toString();window.localStorage.setItem("NROran",n)},sort:function(e,t){$(".ui-state-highlight").css({height:"33px",lineHeight:"1.2em",margin:"0 0 3px",border:"2px dashed #A85A13",background:"transparent",borderRadius:"5px"})}});$("#sortable").disableSelection()}};r.construct();var s={construct:function(){$("body").append('<div id="dialog-Oran" title="Configuration : Navigation Rapide" style="display: none;"></div>');var e='<option value="0">00:00</option><option value="1">01:00</option><option value="2">02:00</option><option value="3">03:00</option><option value="4">04:00</option><option value="5">05:00</option><option value="6">06:00</option><option value="7">07:00</option><option value="8">08:00</option><option value="9">09:00</option><option value="10">10:00</option><option value="11">11:00</option><option value="12">12:00</option><option value="13">13:00</option><option value="14">14:00</option><option value="15">15:00</option><option value="16">16:00</option><option value="17">17:00</option><option value="18">18:00</option><option value="19">19:00</option><option value="20">20:00</option><option value="21">21:00</option><option value="22">22:00</option><option value="23">23:00</option>';var t='<option value="1">Lundi</option><option value="2">Mardi</option><option value="3">Mercredi</option><option value="4">Jeudi</option><option value="5">Vendredi</option><option value="6">Samedi</option><option value="0">Dimanche</option>';$("#dialog-Oran").append('<h2>Heures de messe</h2><p>Le <select id="JourMesse">'+t+'</select>, la messe commence à <select id="MesseRR">'+e+'</select></p><p>Le dimanche, la messe commence à <select id="MesseDimanche">'+e+'</select></p><h2>Raccourcis disponibles</h2><p><input type="checkbox" id="RaccourciOran"> Activer les raccourcis</p><br /><ul><li><span class="keyboard-Oran">0</span> ou <span class="keyboard-Oran">à</span> : Village</li><li><span class="keyboard-Oran">1</span> ou <span class="keyboard-Oran">&</span> : Ma propriété</li><li><span class="keyboard-Oran">2</span> ou <span class="keyboard-Oran">é</span> : Moi</li><li><span class="keyboard-Oran">3</span> ou <span class="keyboard-Oran">"</span> : Mairie</li><li><span class="keyboard-Oran">4</span> ou <span class="keyboard-Oran">\'</span> : Eglise</li><li><span class="keyboard-Oran">5</span> ou <span class="keyboard-Oran">(</span> : Taverne</li><li><span class="keyboard-Oran">6</span> ou <span class="keyboard-Oran">-</span> : Marché</li><li><span class="keyboard-Oran">7</span> ou <span class="keyboard-Oran">è</span> : Sénéchaussée</li><li><span class="keyboard-Oran">8</span> ou <span class="keyboard-Oran">_</span> : Hors de la ville</li><li><span class="keyboard-Oran">9</span> ou <span class="keyboard-Oran">ç</span> : Forêt/Lac/Verger</li></ul>');if(i=window.localStorage.getItem("JourMesse")){i=i=="0"?6:i-1;$("#JourMesse option:eq("+i+")").prop("selected",true)}if(i=window.localStorage.getItem("MesseRR")){$("#MesseRR option:eq("+i+")").prop("selected",true)}if(i=window.localStorage.getItem("MesseDimanche")){$("#MesseDimanche option:eq("+i+")").prop("selected",true)}if(window.localStorage.getItem("RaccourcisOran")&&window.localStorage.getItem("RaccourcisOran")!="false"){$("#RaccourciOran").prop("checked",true)}$("#JourMesse").change(function(){window.localStorage.setItem("JourMesse",$(this).val())});$("#MesseRR").change(function(){window.localStorage.setItem("MesseRR",$(this).val())});$("#MesseDimanche").change(function(){window.localStorage.setItem("MesseDimanche",$(this).val())});$("#RaccourciOran").change(function(){window.localStorage.setItem("RaccourcisOran",$(this).is(":checked"))})},css:function(){$(".ui-widget-overlay").css({"z-index":"2000",background:"#000"});$(".ui-widget-header").css({background:"none",border:"none",color:"#FFEDB2","font-family":"IM Fell DW Pica",fontSize:"24px",fontWeight:"normal"});$("#dialog-Oran").css({color:"#D1A14C",fontSize:"13px"});var e={border:"1px solid #581806",background:"rgba(0,0,0,0.7)","z-index":"2000"};$(".ui-widget").css(e);$(".ui-dialog-titlebar-close").css({boxShadow:"none"});$(".ui-dialog .ui-dialog-titlebar-close").css({right:"13px",top:"5px"});$(".ui-dialog .ui-dialog-titlebar-close span").css("margin","0px");$(".ui-icon").css("position","static");$(".keyboard-Oran").css({display:"inline-block","min-width":"10px",height:"18px",padding:"0 4px","font-size":"11px","line-height":"18px",color:"#555","text-align":"center","background-color":"#EEE","background-repeat":"repeat-x","background-image":"-moz-linear-gradient(top,whiteSmoke 0,#EEE 100%)","background-image":"-webkit-gradient(linear,left top,left bottom,color-stop(0%,whiteSmoke),color-stop(100%,#EEE))","background-image":"-webkit-linear-gradient(top,whiteSmoke 0,#EEE 100%)","background-image":"-ms-linear-gradient(top,whiteSmoke 0,#EEE 100%)","background-image":"-o-linear-gradient(top,whiteSmoke 0,#EEE 100%)","background-image":"linear-gradient(top,whiteSmoke 0,#EEE 100%)",border:"1px solid #CCC","-webkit-border-radius":"3px","-moz-border-radius":"3px","border-radius":"3px","-webkit-box-shadow":"inset 0 1px 0 white,0 1px 0 #CCC","-moz-box-shadow":"inset 0 1px 0 #fff,0 1px 0 #ccc","box-shadow":"inset 0 1px 0 white,0 1px 0 #CCC",margin:"0 5px 5px 0"})}};s.construct();$("#ConfigNav").click(function(){$("#dialog-Oran").dialog({resizable:false,height:600,width:600,modal:true});s.css()});if(window.localStorage){$(document).keydown(function(e){if($("input:focus").length>0||$("textarea:focus").length>0){}else if(window.localStorage.getItem("RaccourcisOran")!="false"&&window.localStorage.getItem("RaccourcisOran")){if(e.keyCode==true){var t=e.keyCode}else{var t=e.which}switch(t){case 48:window.location.href="/EcranPrincipal.php";return false;break;case 49:window.location.href="/EcranPrincipal.php?l=1";return false;break;case 50:window.location.href="/EcranPrincipal.php?l=2";return false;break;case 51:window.location.href="/EcranPrincipal.php?l=3";return false;break;case 52:window.location.href="/EcranPrincipal.php?l=4";return false;break;case 53:window.location.href="/EcranPrincipal.php?l=5";return false;break;case 54:window.location.href="/EcranPrincipal.php?l=6";return false;break;case 55:window.location.href="/EcranPrincipal.php?l=7";return false;break;case 56:window.location.href="/EcranPrincipal.php?l=8";return false;break;case 57:window.location.href="/EcranPrincipal.php?l=9";return false;break;case 96:window.location.href="/EcranPrincipal.php";return false;break;case 97:window.location.href="/EcranPrincipal.php?l=1";return false;break;case 98:window.location.href="/EcranPrincipal.php?l=2";return false;break;case 99:window.location.href="/EcranPrincipal.php?l=3";return false;break;case 100:window.location.href="/EcranPrincipal.php?l=4";return false;break;case 101:window.location.href="/EcranPrincipal.php?l=5";return false;break;case 102:window.location.href="/EcranPrincipal.php?l=6";return false;break;case 103:window.location.href="/EcranPrincipal.php?l=7";return false;break;case 104:window.location.href="/EcranPrincipal.php?l=8";return false;break;case 105:window.location.href="/EcranPrincipal.php?l=9";return false;break}}})}})