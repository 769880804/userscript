// ==UserScript==
// @name          fb meme
// @namespace     eopin-js
// @description   Implementation of fb meme
// @author        Sa√Ød Dermoumi <sdermoumi@gmail.com>
// @homepage      http://twitter.com/eopin
// @run-at        document-start
// ==/UserScript==

(function() {
if (document.domain.indexOf('facebook.com') == -1 || window['SplSetup']) return;

window['SplSetup'] = true;

var rules = [];

// A utility function for making escaped emoticon RegExps
function makeRegExp(str) {
    str = str.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&');
    return RegExp('^'+str+'$|^'+ str +'([ !?,\.\'"])|([ !?,\.\'"])'+ str +'([ !?,\.\'"])|([ !?,\.\'"])'+ str +'$', 'gm');
}

// Adds a emoticon rule to the file
function addRule(emote, profileId) {
    if (typeof emote == "object") {
        for (n in emote) {
            if (typeof emote[n] != "string") continue;
            rules.push({
                reg: makeRegExp(emote[n]),
                rep: '$4$2[['+ profileId +']]$1$3'
            });
        }
    }
    else if (typeof emote == "string") {
        rules.push({
            reg: makeRegExp(emote),
            rep: '$4$2[['+ profileId +']]$1$3'
        });
    }
}

// Applies rules to a string
function process(str) {
    if (typeof str != 'string') return;
    for (n in rules) {
        str = str.replace(rules[n].reg, rules[n].rep);
    }
    return str;
}

// Watch for when user clicks on "Send" button on message mode
document.addEventListener('mousedown', function(e) {
    var targets = [],
        parent = e.target.parentNode;
    if (!parent) return;
    var parentId = parent.getAttribute('id');
    var parentClass = parent.getAttribute('class');
    if (parentId == 'MessagingSendReplyButton') {
        targets = parent.parentNode.parentNode.getElementsByClassName('MessagingComposerBody');
    }
    else if (parentClass.indexOf('uiButton') >= 0 && parentClass.indexOf('uiButtonConfirm') >= 0) {
        targets = parent.parentNode.parentNode.parentNode.getElementsByClassName('MessagingComposerBody');
    }
    else {
        return;
    }

    for (n in targets) {
        targets[n].value = process(targets[n].value);
    }
}, true);

// Watch for when user clicks on Enter and is focusing a message textarea
document.addEventListener('keydown', function(e) {
    if (e.keyCode != 13 || e.shiftKey) return;

    var elem = document.activeElement;
    var elemClass = elem.getAttribute('class');
    if ((elemClass.indexOf('MessagingComposerBody') >= 0
        && document.getElementById('MessagingSendOnEnterCheckbox').checked)
        || (elemClass.indexOf('uiTextareaAutogrow') >= 0 && elem.parentNode && elem.parentNode.getElementsByClassName('inputIcon')[0])
    ) {
        elem.value = process(elem.value);
    }

}, true);

// Edit these if you want to customize emoticons

addRule([":yuno:"], '214505171976624\]]\[[214505225309952\]]\[[214505285309946\]]\n\[[214505298643278\]]\[[214505308643277\]]\[[214505321976609\]]\n\[[214505331976608\]]\[[214505371976604\]]\[[214505408643267');
addRule([":sir:"], '214496455310829\]]\[[214496465310828\]]\[[214496478644160\]]\n\[[214496505310824\]]\[[214496531977488\]]\[[214496551977486\]]\n\[[214496608644147\]]\[[214496678644140\]]\[[214496701977471');
addRule([":milk:"], '214512295309245\]]\[[214512325309242\]]\[[214512428642565\]]\n\[[214512455309229\]]\[[214512471975894\]]\[[214512521975889\]]\n\[[214512545309220\]]\[[214512575309217\]]\[[214512615309213');
addRule([":alone:"], '211330042294137\]]\[[211330068960801\]]\[[211330088960799\]]\n\[[211330108960797\]]\[[211330128960795\]]\[[211330168960791\]]\n\[[211330178960790\]]\[[211330212294120\]]\[[211330228960785');
addRule([":fapfapfap:"], '210153292411812\]][[210153309078477\]][[210153342411807\]]\[[210153359078472\]]\n\[[210153375745137\]]\[[210153409078467\]]\[[210153449078463\]]\[[210153459078462\]]\n\[[210153465745128\]]\[[210153515745123\]]\[[210153535745121\]]\[[210153559078452\]]\n\[[210153569078451\]]\[[210153572411784\]]\[[210153585745116');
addRule([":youporn:"], '210159982411143\]]\[[210159992411142\]]\[[210159999077808\]]\[[210160012411140\]]\[[210160045744470\]]\[[210160055744469\]]\n\[[210160069077801\]]\[[210160075744467\]]\[[210160092411132\]]\[[210160129077795\]][[210160149077793\]][[210160172411124');
addRule([":nyancat:"], '210074499086358\]]\[[210074522419689\]]\[[210074542419687\]]\[[210074572419684\]]\[[210074602419681\]]\[[210074652419676\]]\[[210074665753008\]]\n\[[210074699086338\]]\[[210074732419668\]]\[[210074742419667\]]\[[210074752419666\]]\[[210074762419665\]]\[[210074802419661\]]\[[210074839086324\]]\n\[[210074855752989\]]\[[210074875752987\]]\[[210074885752986\]]\[[210074909086317\]]\[[210074925752982\]]\[[210074959086312\]]\[[210074979086310\]]\n\[[210075002419641\]]\[[210075055752969\]]\[[210075085752966\]]\[[210075109086297\]]\[[210075129086295\]]\[[210075145752960\]]\[[210075212419620');
addRule([":megusta:"], '183494078416650\]]\[[183494101749981\]]\[[183494115083313\]]\[[183494128416645\]]\[[183494141749977\]]\[[183494171749974\]]\n\[[183494185083306\]]\[[183494201749971\]]\[[183494211749970\]]\[[183494218416636\]]\[[183494238416634\]]\[[183494255083299\]]\n\[[183494261749965\]]\[[183494268416631\]]\[[183494308416627\]]\[[183494341749957\]]\[[183494355083289\]]\[[183494385083286\]]\n\[[183494405083284\]]\[[183494435083281\]]\[[183494445083280\]]\[[183494475083277\]]\[[183494531749938\]]\[[183494555083269');
addRule([":yaoming:"], '183502745082450\]]\[[183502768415781\]]\[[183502785082446\]]\[[183502791749112\]]\n\[[183502808415777\]]\[[183502821749109\]]\[[183502835082441\]]\[[183502855082439\]]\n\[[183502878415770\]]\[[183502895082435\]]\[[183502921749099\]]\[[183502961749095\]]\n\[[183502991749092\]]\[[183503005082424\]]\[[183503028415755\]]\[[183503048415753\]]\n\[[183503058415752\]]\[[183503081749083\]]\[[183503098415748\]]\[[183503108415747');
addRule([":troll:"], '184906471608744\]]\[[184906484942076\]]\[[184906531608738\]]\[[184906578275400\]]\n\[[184906598275398\]]\[[184906618275396\]]\[[184906641608727\]]\[[184906671608724\]]\n\[[184906698275388\]]\[[184906711608720\]]\[[184906734942051\]]\[[184906758275382\]]\n\[[184906784942046\]]\[[184906821608709\]]\[[184906874942037\]]\[[184906928275365\]]\n\[[184907001608691\]]\[[184907061608685\]]\[[184907098275348\]]\[[184907134942011');
addRule([":fuckyeah:"], '140230169424967\]]\[[140230199424964\]]\[[140230212758296\]]\[[140230236091627\]]\[[140230249424959\]]\n\[[140230269424957\]]\[[140230292758288\]]\[[140230302758287\]]\[[140230329424951\]]\[[140230349424949\]]\n\[[140230249424959\]]\[[140230386091612\]]\[[140230399424944\]]\[[140230416091609\]]\[[140230426091608\]]\n\[[140230439424940\]]\[[140230456091605\]]\[[140230472758270\]]\[[140230489424935\]]\[[140230506091600\]]\n\[[140230519424932\]]\[[140230526091598\]]\[[140230539424930\]]\[[140230556091595\]]\[[140230576091593');

})();