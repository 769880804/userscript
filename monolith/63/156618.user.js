// ==UserScript==
// @name           TSR Toolbox
// @author         Chrosson
// @version        1.1.3
// @description    A little toolbox on the left hand side of the screen
// @downloadURL    https://userscripts.org/scripts/source/156618.user.js
// @updateURL      https://userscripts.org/scripts/source/156618.meta.js
// @include        http*://www.thestudentroom.co.uk/*
// @grant          GM_getValue
// @grant          GM_setValue
// @grant          GM_getResourceText
// @grant          GM_xmlhttpRequest
// @copyright      2013+, Chrosson
// @namespace      http://www.thestudentroom.co.uk/member.php?u=334116
// @require        https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js
// @require        https://raw.github.com/vitch/jScrollPane/f4042d628a6a593462239fe5eb74a7f7d386f2a7/script/jquery.jscrollpane.min.js
// @require        https://raw.github.com/vitch/jScrollPane/f4042d628a6a593462239fe5eb74a7f7d386f2a7/script/jquery.mousewheel.js
// @require        https://raw.github.com/vitch/jScrollPane/f4042d628a6a593462239fe5eb74a7f7d386f2a7/script/mwheelIntent.js
// @require        https://raw.github.com/jackmoore/autosize/a1c015726001cdd39a6da08efa7928ad74e7b2a7/jquery.autosize-min.js
// @require        https://raw.github.com/desandro/imagesloaded/eb363e0db53da02fc180323ba8fe8a320937221e/jquery.imagesloaded.min.js
// @resource       jscrollpanecss https://raw.github.com/vitch/jScrollPane/f4042d628a6a593462239fe5eb74a7f7d386f2a7/style/jquery.jscrollpane.css
// ==/UserScript==

window.util={};window.util.utf8tob64=function(q){return btoa(unescape(encodeURIComponent(q)))};window.util.b64toutf8=function(q){return decodeURIComponent(escape(atob(q)))};(function(){var q=0;window.util.uniqueNum=function(){return q++};window.util.uniqueStr=function(){for(var l="",f=q++;0<=f;)l=String.fromCharCode(f%26+97)+l,f=Math.floor(f/26)-1;return l};window.util.uniqueStr=function(){return q++}})();
function TSRXMLParser(){function q(f){var n=f.firstElementChild;switch(n.nodeName){case "int":return parseInt(f.textContent,10);case "boolean":return"1"===f.textContent;case "string":return f.textContent;case "base64":return null===f.textContent&&alert("Error occured"),util.b64toutf8(f.textContent);case "dateTime.iso8601":return f=f.textContent,f.slice(0,4)+"-"+f.slice(4,6)+"-"+f.slice(6,8)+" "+f.slice(9,14);case "struct":return l(n);case "array":return l(n);default:throw"Unrecognised val type '"+
n.nodeName+"'";}}function l(f){switch(f.nodeName){case "value":return q(f);case "struct":var n={};for(f=f.firstElementChild;null!==f;f=f.nextElementSibling)n[f.getElementsByTagName("name")[0].textContent]=l(f.getElementsByTagName("value")[0]);return n;case "array":n=[];for(f=f.firstElementChild.firstElementChild;null!==f;f=f.nextElementSibling)n.push(l(f.firstElementChild));return n;case "param":return l(f.firstElementChild);case "params":return l(f.firstElementChild);case "methodResponse":return l(f.firstElementChild);
default:throw"Unrecognised elt '"+f.nodeName+"'";}}this.parse=function(f){return l(f.firstChild)}}
(function(){function q(){return $("<div>").attr("class","tbx-loader").append($("<div>")).append($("<div>")).append($("<div>")).append($("<div>"))}function l(a){a.children(".tbx-loader").length||a.append(q().css("top","50%").css("left","50%").css("position","absolute"))}function f(a){a.children(".tbx-loader").length||a.append(q().css("top","90%").css("left","70px").css("position","absolute"))}function n(a){a.children(".tbx-loader").remove()}function O(a){jQuery.ajax({type:"POST",url:"http://www.thestudentroom.co.uk/mobiquo/mobiquo.php",
data:'<?xml version="1.0"?><methodCall><methodName>get_inbox_stat</methodName><params></params></methodCall>',success:function(b,c,d){a(v.parse(b))},error:function(a,c,d){console.log("Cannot connect to TSR to get inbox status")},dataType:"xml"})}function D(a,b,c,d,e,k){for(var h="",m=0,w=a.length;m<w;m++)h+="<value><base64>"+util.utf8tob64(a[m])+"</base64></value>";jQuery.ajax({type:"POST",url:"http://www.thestudentroom.co.uk/mobiquo/mobiquo.php",data:'<?xml version="1.0"?><methodCall><methodName>create_message</methodName><params><param><value><array><data>'+
h+"</data></array></value></param><param><value><base64>"+util.utf8tob64(b)+"</base64></value></param><param><value><base64>"+util.utf8tob64(c)+"</base64></value></param>"+(1===d||2===d?"<param><value><i4>"+d+"</i4></value></param><param><value><string>"+e+"</string></value></param>":"")+"</params></methodCall>",success:function(a,b,e){a=v.parse(a);if(!a.result)return alert("FAILED: "+a.result_text);k(a)},error:function(a,b,e){alert("Failed to connect to TSR to send PM...")},dataType:"xml"})}function P(a,
b){jQuery.ajax({type:"POST",url:"http://www.thestudentroom.co.uk/mobiquo/mobiquo.php",data:'<?xml version="1.0"?><methodCall><methodName>get_quote_pm</methodName><params><param><value><string>'+a+"</string></value></param></params></methodCall>",success:function(a,d,e){a=v.parse(a);if(!a.result)return alert("FAILED: "+a.result_text);b(a)},error:function(a,b,e){alert("Failed to connect to TSR to load quoted PM...")},dataType:"xml"})}function Q(a,b,c,d){jQuery.ajax({type:"POST",url:"http://www.thestudentroom.co.uk/mobiquo/mobiquo.php",
data:'<?xml version="1.0"?><methodCall><methodName>get_box</methodName><params><param><value><string>'+a+"</string></value></param><param><value><i4>"+b+"</i4></value></param><param><value><i4>"+(b+c-1)+"</i4></value></param></params></methodCall>",success:function(a,b,c){a=v.parse(a);if(!a.result)return alert("FAILED: "+a.result_text);d(a)},error:function(a,b,c){alert("Failed to connect to TSR to load PMs...")},dataType:"xml"})}function E(a,b,c,d){jQuery.ajax({type:"POST",url:"http://www.thestudentroom.co.uk/mobiquo/mobiquo.php",
data:'<?xml version="1.0"?><methodCall><methodName>get_message</methodName><params><param><value><string>'+a+"</string></value></param><param><value><string>"+b+"</string></value></param><param><value><boolean>"+c+"</boolean></value></param></params></methodCall>",success:function(a,b,c){a=v.parse(a);if(!a.result)return alert("FAILED: "+a.result_text);d(a)},error:function(a,b,c){alert("Failed to connect to TSR to load PM...")},dataType:"xml"})}function R(a,b){var c={list:[]};$("<div>").load("http://www.thestudentroom.co.uk/quoted.php?page="+
a+"&sortby=latest #primary_content .thread",function(a,e,k){if("error"===e)return alert("Failed to load quotes...");$(this).children().map(function(a,b){var e={};e.unread=!b.classList.contains("read");e.title=$(".titleline",b).text().trim();e.postUrl=$(".titleline",b).children("a:not(.threadbit-icon)")[0].href;e.lastPostUrl=$(".lastpost",b)[0].href;$(".firstnew",b)[0]&&(e.firstNewPostUrl=$(".firstnew",b)[0].href);e.post_id=e.postUrl.match(/p=([0-9]*)/)[1];e.post=$(".post",b).text();"Click the thread title to view this post"===
e.post&&(e.post="Unable to quick-view post");e.user=$(".byline > a",b).text().trim();e.user_id=$(".byline > a",b)[0].href.match(/u=([0-9]*)/)[1];e.date=$(".date",b).text().trim();e.forumUrl=$(".forum-link > a",b)[0].href;e.forumName=$(".forum-link > a",b).text().trim();c.list.push(e)});b(c)})}function F(a){var b=$(a);b.unbind("jsp-scroll-y");f(b);var c=b.data("pageNum");b.data("pageNum",c?c+=1:c=1);var d=function(a){return{time:document.createTextNode(a.date),user:a.user,content:a.title,unread:!0===
a.unread}};R(c,function(e){G(e,b[0],d,S,function(){F(a)})})}function H(a){t.msg.refresh();var b=$(a);b.unbind("jsp-scroll-y");f(b);var c=b[0].getElementsByClassName("tbx-list-item").length,d=function(a){var b=document.createDocumentFragment();b.appendChild(document.createTextNode(a.sent_date.split(" ")[0]));b.appendChild(document.createElement("br"));b.appendChild(document.createTextNode(a.sent_date.split(" ")[1]));return{time:b,user:a.msg_from,content:a.short_content,unread:1===a.msg_state}};Q(0,
c,10,function(e){G(e,b[0],d,T,function(){H(a)})})}function G(a,b,c,d,e){n($(b));for(var k=$(b).data("jsp"),h=k.getContentPane(),m=a.list.length,w=0;w<m;w++){var f=a.list[w],r=c(f),s=document.createElement("div"),I=document.createElement("div"),g=document.createElement("div"),l=document.createElement("div"),q=document.createElement("div");I.appendChild(r.time);g.appendChild(document.createTextNode(r.user));g.style["float"]="right";q.style.whiteSpace="pre-wrap";l.appendChild(g);l.appendChild(I);q.textContent=
r.content;s.appendChild(l);s.appendChild(document.createElement("br"));s.appendChild(q);s.classList.add("tbx-list-item");r.unread&&s.classList.add("tbx-list-item-unread");s.addEventListener("click",function(a,b){return function(){d(a,b)}}(f,s),!1);s.style.cursor="default";h.append(s)}k.reinitialise();$(b).bind("jsp-scroll-y",function(a,b,c,k){k&&e()})}function U(){var a=y("settings"),b=a.getElementsByClassName("tbx-view-content")[0],c=document.createElement("input"),d=[];c.value="Save";c.type="button";
c.disabled=!0;c.addEventListener("click",function(){c.disabled=!0;for(var a=d.length,b=0;b<a;b++){var e=d[b],k=e.getAttribute("data-settings-key");e.disabled||""===e.value.trim?g.set(k,void 0):g.set(k,e.value)}g.apply()},!1);b.addEventListener("input",function(){c.disabled=!1},!1);b.addEventListener("change",function(){c.disabled=!1},!1);b.appendChild(document.createElement("h3"));b.lastChild.appendChild(document.createTextNode("TSR Overrides"));var e=g.items,k;for(k in e)if(e.hasOwnProperty(k)){var h=
e[k],m=document.createElement("div"),h=h.input(),f=h.querySelector(".tbx-setting-input");d.push(f);m.appendChild(h);b.appendChild(m)}b.appendChild(document.createElement("br"));b.appendChild(c);b.appendChild(document.createElement("br"));b.appendChild(document.createElement("br"));var p=document.createElement("input");p.type="button";p.value="Clear all settings";p.style.borderColor="red";p.addEventListener("click",function(){confirm("Are you sure you want to clear all settings?\nThis includes hidden settings like your preferred PM view type.\nYou will need to refresh the page if you proceed.")&&
(g.reset(),$(document.getElementById("overlay-control-panel")).remove(),p.value="Refresh to continue using the TSR Toolbox",p.disabled=!0,c.parentNode.removeChild(c))},!1);b.appendChild(p);document.body.appendChild(a);return a}function V(){var a=y("compose"),b=document.createElement("input"),c=document.createElement("input"),d=document.createElement("textarea"),e=document.createElement("a"),k=document.createElement("a");c.style.cssText="width: 70%; padding: 2px; border: thin inset black; float: right;-webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box;";
c.placeholder="Subject";c.tabIndex="2";b.style.cssText="width: 30%; padding: 2px; border: thin inset black;-webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box;";b.placeholder="To (single user)";b.tabIndex="1";d.style.cssText="resize: none; width: 100%; box-sizing: border-box!important; border: thin inset black; padding: 10px;";d.placeholder="Message";d.tabIndex="3";$(d).autosize();e.href="http://www.thestudentroom.co.uk/private.php?do=newpm";e.textContent="Advanced Compose";
e.style.cssText="font-weight: bold; font-size: 15px;";k.style.cssText="cursor: pointer; float: right; font-weight: bold; font-size: 15px;";k.textContent="Send";var h=a.getElementsByClassName("tbx-view-content")[0];h.appendChild(c);h.appendChild(b);h.appendChild(document.createElement("br"));h.appendChild(d);h.appendChild(document.createElement("br"));h.appendChild(k);h.appendChild(e);var m=document.createElement("div");m.className="tbx-view-content";m.style.textAlign="center";m.appendChild(document.createTextNode("SENT"));
m.appendChild(document.createElement("p"));e=document.createElement("a");e.style.cursor="pointer";e.textContent="New";e.addEventListener("click",function(){$(m).replaceWith(h)},!1);m.appendChild(e);k.addEventListener("click",function(){l($(a));D([b.value.trim()],c.value.trim(),d.value,0,0,function(e){n($(a));b.value=c.value=d.value="";$(d).trigger("autosize");$(h).replaceWith(m)})},!1);document.body.appendChild(a);return a}function W(){var a=J();a.id="msg-list-overlay";document.body.appendChild(a);
H(a);var b=y("msg");document.body.appendChild(b);X();return a}function Y(){B();var a=J();a.id="quote-list-overlay";document.body.appendChild(a);F(a);var b=y("quote");document.body.appendChild(b);Z();return a}function Z(){var a=C([{icon:"&#8661;",value:"vexpand",type:"checkbox",event:"change",handler:function(b){K(a,document.getElementById("quote-view-overlay"))}},{icon:"&#8660;",value:"hexpand",type:"checkbox",event:"change",handler:function(b){L(a,document.getElementById("quote-view-overlay"))}},
{icon:"&#8801;",value:"textview",type:"radio",event:"change",handler:function(a){u(a.target.value,"quote")}},{icon:"&#9733;",value:"preview",type:"radio",event:"change",handler:function(a){u(a.target.value,"quote")}}]);a.style.position="fixed";a.id="quote-control-panel";a.style.display="none";document.body.appendChild(a)}function X(){var a=C([{icon:"&#8661;",value:"vexpand",type:"checkbox",event:"change",handler:function(b){K(a,document.getElementById("msg-view-overlay"))}},{icon:"&#8660;",value:"hexpand",
type:"checkbox",event:"change",handler:function(b){L(a,document.getElementById("msg-view-overlay"))}},{icon:"&#8801;",value:"textview",type:"radio",event:"change",handler:function(a){u(a.target.value,"msg")}},{icon:"&#9733;",value:"preview",type:"radio",event:"change",handler:function(a){u(a.target.value,"msg")}},{icon:"&#9997;",value:"reply",type:"radio",event:"change",handler:function(a){u(a.target.value,"msg")}}]);a.style.position="fixed";a.id="msg-control-panel";a.style.display="none";document.body.appendChild(a)}
function T(a,b){M(a,b,"msg")}function S(a,b){M(a,b,"quote")}function u(a,b){var c=$(document.getElementById(b+"-view-overlay")),d=$(document.getElementById(b+"-view-content")),e=$(document.getElementById(b+"-view-container")),k=c.data("data");l(c);g.set("pref-view-"+b,a);d.empty();if("preview"===a&&"msg"===b)d.load("http://www.thestudentroom.co.uk/private.php?do=showpm&pmid="+k.msg_id+" #post_message_",function(a,b,e){"error"===b?alert("Failed to load PM..."):n(c)});else if("preview"===a&&"quote"===
b)d.load(k.postUrl+" #posts",function(a,b,h){"error"===b?alert("Failed to load PM..."):d.imagesLoaded(function(){n(c);e.data("jsp").reinitialise();e.data("jsp").scrollToElement(e.find("#post_"+k.post_id),!0,!1)})});else if("reply"===a&&"msg"===b){1===k.msg_state&&E(k.msg_id,0,!1,function(){});var h=document.createElement("textarea"),m=document.createElement("a"),f=document.createElement("a");h.style.cssText="resize: none; width: 100%; box-sizing: border-box!important; border: thin inset black; padding: 10px;";
h.placeholder="Message";h.tabIndex="3";m.href="http://www.thestudentroom.co.uk/private.php?do=newpm&pmid="+k.msg_id;m.textContent="Advanced Compose";m.style.cssText="font-weight: bold; font-size: 15px;";f.style.cssText="cursor: pointer; float: right; font-weight: bold; font-size: 15px;";f.textContent="Send";P(k.msg_id,function(a){n(c);d.append(h).append(document.createElement("br")).append(f).append(m);h.textContent=a.text_body;$(h).autosize();f.addEventListener("click",function(){l(c);D([k.msg_from],
a.msg_subject,h.value,1,a.msg_id,function(a){n(c);a=document.createElement("div");a.appendChild(document.createTextNode("SENT"));a.style.textAlign="center";d.empty().append(a)})},!1)})}else if("textview"===a){var p=function(a){n(c);var b=document.createElement("div");b.textContent=a;b.style.whiteSpace="pre-wrap";d.append(b)};"msg"===b?E(k.msg_id,0,!1,function(a){p(a.text_body)}):"quote"===b&&p(k.post)}}function M(a,b,c){var d=$(document.getElementById(c+"-control-panel")),e=$(document.getElementById(c+
"-view-overlay"));d.children('[type="button"][value="close"]').click();b.classList.add("tbx-list-item-selected");b.classList.contains("tbx-list-item-unread")&&(t[c]&&t[c].change(-1),b.classList.remove("tbx-list-item-unread"));l(e);e[0].style.display=null;d[0].style.left=e.offset().left+e.outerWidth()+"px";d.css("top",Math.round(100*((e.offset().top-window.pageYOffset)/$(window).height()))+5+"%");d[0].style.display=null;e.data("data",a);0<d.children('[type="radio"]:checked').length?(g.set("pref-view-"+
c,d.children('[type="radio"]:checked')[0].value),u(d.children('[type="radio"]:checked')[0].value,c)):d.children('[type="radio"][value="'+g.get("pref-view-"+c)+'"]').click();x.push(function(){b.classList.remove("tbx-list-item-selected");e[0].style.display=d[0].style.display="none"})}function aa(){var a=C([{icon:"&#9993;",value:"msglist",type:"radio",event:"change",handler:z},{icon:"&#9997;",value:"compose",type:"radio",event:"change",handler:z},{icon:"&ldquo;&bdquo;",value:"quotelist",type:"radio",
event:"change",handler:z},{icon:"&#9784;",value:"settings",type:"radio",event:"change",handler:z},{icon:"&#9788;",value:"brightness",type:"checkbox",event:"change",handler:ba},{icon:"&#8635;",value:"refresh",type:"button",event:"click",handler:ca}]);a.style.top="28px";a.style.left="0px";a.style.position="fixed";a.id="overlay-control-panel";document.body.appendChild(a);t.create("msg",function(a){O(function(c){a(c.inbox_unread_count)})}).refresh();$(a).children('input[value="msglist"] + label').children("span").append(t.msg.elt());
setInterval(function(){var a=JSON.parse(GM_getValue("data-notify-msg")||'{ "time": 0, "value": 0 }');a.time<Date.now()-(6E4-1E3*Math.floor(11*Math.random()))?t.msg.refresh():t.msg.set(a.value)},6E4+1E3*Math.floor(11*Math.random()))}function z(a){var b,c,d,e,k,h=a.target;a=h.value;var m=document.getElementById("overlay-control-panel");"msglist"===a?(b="msg-list-overlay",d=W,e=function(){m.style.left=document.getElementById(b).style.width},k=function(){m.style.left="0px"}):"compose"===a?(b="compose-view-overlay",
d=V,e=k=function(){}):"quotelist"===a?(b="quote-list-overlay",d=Y,e=function(){m.style.left=document.getElementById(b).style.width},k=function(){m.style.left="0px"}):"settings"===a&&(b="settings-view-overlay",d=U,e=k=function(){});$(h).parent().children('[type="button"][value="close"]').click();x.push(function(){c.style.display="none";h.checked=!1;k()});c=document.getElementById(b)||d();c.style.display=null;$(c).data("jsp")&&$(c).data("jsp").reinitialise();e()}function ba(){if(null!=document.getElementById("tbx-brightness-overlay"))g.set("pref-brightness",
!1),document.body.removeChild(document.getElementById("tbx-brightness-overlay"));else{g.set("pref-brightness",!0);var a=document.createElement("div");a.setAttribute("id","tbx-brightness-overlay");a.style.cssText="height: 100%; width: 100%; background-color: #000; position: fixed; top: 0px; left: 0px;z-index: 20000; pointer-events: none; opacity: "+g.get("pref-brightness-level")+";";document.body.appendChild(a)}}function ca(){var a=$("#overlay-control-panel"),b=a.children(":checked"),c=b.attr("value").slice(0,
-4);a.children('[type="button"][value="close"]').click();$(document.getElementById(c+"-view-overlay")).remove();$(document.getElementById(c+"-list-overlay")).remove();$(document.getElementById(c+"-control-panel")).remove();b.click()}function C(a){var b=document.createElement("div"),c=util.uniqueStr();b.className="tbx-control-panel";for(var d=0,e=a.length;d<e;d++){var k="tbx-control-panel-option-"+util.uniqueStr(),h=a[d];b.appendChild(N(k,h.type,c,h.value,h.icon,h.event,h.handler))}b.appendChild(N("tbx-control-panel-close-"+
c,"button",c,"close","&#10005;","click",function(a){return function(b){for(;a<x.length;)x.pop()()}}(x.length)));return b}function N(a,b,c,d,e,k,h){var m=document.createDocumentFragment(),f=document.createElement("input"),g=document.createElement("label"),r=document.createElement("span");f.id=a;f.value=d;f.setAttribute("type",b);f.setAttribute("name",c);h&&f.addEventListener(k,function(a){a.stopPropagation();h(a)});r.innerHTML=e;g.appendChild(r);g.setAttribute("for",a);m.appendChild(f);m.appendChild(g);
return m}function J(){var a=document.createElement("div");a.className="tbx-list-overlay";a.style.display="none";var b=$(a).jScrollPane({verticalGutter:0,mouseWheelSpeed:30}).data("jsp");$(window).bind("resize",function(){b.reinitialise()});$(a).bind("mousewheel DOMMouseScroll",function(a){a.preventDefault()});return a}function y(a){var b=document.createElement("div"),c=document.createElement("div"),d=document.createElement("div");b.setAttribute("id",a+"-view-overlay");b.setAttribute("class","tbx-view-overlay");
c.setAttribute("id",a+"-view-container");c.setAttribute("class","tbx-view-container");d.setAttribute("id",a+"-view-content");d.setAttribute("class","tbx-view-content");b.style.display="none";b.appendChild(c);$(c).jScrollPane({verticalGutter:0,autoReinitialise:!0,stickToBottom:!0,contentWidth:"0px",mouseWheelSpeed:30});$(c).data("jsp").getContentPane().append(d);$(c).bind("mousewheel DOMMouseScroll",function(a){a.preventDefault()});return b}function K(a,b){b.style.top=b.style.top?"":"0%";a.style.top=
Math.round(100*(($(b).offset().top-window.pageYOffset)/$(window).height()))+5+"%"}function L(a,b){$(a);var c=$(b);b.style.right?(b.style.right="",b.style.width="",a.style.left=c.offset().left+c.outerWidth()+"px"):(b.style.right=$(a).width()+"px",b.style.width="auto",a.style.left="",a.style.right=0)}function A(a,b){var c;if(a){if("px"===a.slice(-2))c=parseFloat(a.slice(0,-2),10);else if("em"===a.slice(-2)){c=(c=document.getElementsByClassName("postcontent")[0])||document.body;var d=document.createElement("span");
d.style.cssText="display:inline-block; padding:0; line-height:1; position:absolute; visibility:hidden; font-size:1em";d.appendChild(document.createTextNode("M"));c.appendChild(d);var e=[d.offsetWidth,d.offsetHeight];c.removeChild(d);c=e[1]*parseFloat(a.slice(0,-2),10)}else return null;return b?c:Math.round(c)}}function B(){if(!$('link[rel="stylesheet"][href$="showthread.min.css"]').length){var a=document.createElement("link");a.rel="stylesheet";a.type="text/css";a.href=$('link[rel="stylesheet"][href$="stylesheet.min.css"]')[0].href.slice(0,
-18)+"script-css/showthread.min.css";document.body.appendChild(a)}}if(/thestudentroom/.test(window.location.host)){console.log("found tsr url - "+window.location.host);var v=new TSRXMLParser,x=[];(function(){var a=GM_getResourceText("jscrollpanecss")+'.jspHorizontalBar,.jspVerticalBar,.jspTrack{background:#eeeef4}/*.jspDrag{background:#bbd;-moz-border-radius:10px;-webkit-border-radius:10px;border-radius:10px}*/.jspTrack .jspActive,.jspTrack .jspHover,.jspDrag:hover{background:#8b8b9f}/*.jspVerticalBar>.jspActive,.jspArrow:hover{background-image:url("../image/ui-icons_cd0a0a_256x240.png")}*//*.jspVerticalBar>.jspDisabled,.jspVerticalBar>.jspDisabled:hover,.jspHorizontalBar>.jspDisabled,.jspHorizontalBar>.jspDisabled:hover{background-color:transparent;/*background-image:url("../image/ui-icons_888888_256x240.png")}*/.jspVerticalBar { width: 10px; }/* http://tympanus.net/codrops/2012/11/14/creative-css-loading-animations/ */.tbx-loader {    font-size: 20px; /* 100px */    width: 1em;    height: 1em;    margin: auto auto;    border-radius: 50%;    border: .01em solid rgba(150,150,150,0.1);    list-style: none;}.tbx-loader div {    position: absolute;    width: .3em; /* .2em */    height: .3em;  /* .2em */    border-radius: 50%;}.tbx-loader div:nth-child(1) {    left: 50%;    top: 0;    margin: 0 0 0 -.1em;    background: #00C176;    -webkit-transform-origin: 50% 250%; -moz-transform-origin: 50% 250%; transform-origin: 50% 250%;    -webkit-animation: rota 1.13s linear infinite, opa 3.67s ease-in-out infinite alternate;    -moz-animation:    rota 1.13s linear infinite, opa 3.67s ease-in-out infinite alternate;    animation:         rota 1.13s linear infinite, opa 3.67s ease-in-out infinite alternate;}.tbx-loader div:nth-child(2) {    top: 50%;    right: 0;    margin: -.1em 0 0 0;    background: #FF003C;    -webkit-transform-origin: -150% 50%; -moz-transform-origin: -150% 50%; transform-origin: -150% 50%;    -webkit-animation: rota 1.86s linear infinite, opa 4.29s ease-in-out infinite alternate;    -moz-animation:    rota 1.86s linear infinite, opa 4.29s ease-in-out infinite alternate;    animation:         rota 1.86s linear infinite, opa 4.29s ease-in-out infinite alternate;}.tbx-loader div:nth-child(3) {    left: 50%;    bottom: 0;    margin: 0 0 0 -.1em;    background: #FABE28;    -webkit-transform-origin: 50% -150%; -moz-transform-origin: 50% -150%; transform-origin: 50% -150%;    -webkit-animation: rota 1.45s linear infinite, opa 5.12s ease-in-out infinite alternate;    -moz-animation:    rota 1.45s linear infinite, opa 5.12s ease-in-out infinite alternate;    animation:         rota 1.45s linear infinite, opa 5.12s ease-in-out infinite alternate;}.tbx-loader div:nth-child(4) {    top: 50%;    left 0;    margin: -.1em 0 0 0;    background: #88C100;    -webkit-transform-origin: 250% 50%; -moz-transform-origin: 250% 50%; transform-origin: 250% 50%;    -webkit-animation: rota 1.72s linear infinite, opa 5.25s ease-in-out infinite alternate;    -moz-animation:    rota 1.72s linear infinite, opa 5.25s ease-in-out infinite alternate;    animation:         rota 1.72s linear infinite, opa 5.25s ease-in-out infinite alternate;}@-webkit-keyframes rota { to { -webkit-transform: rotate(360deg); } }@-moz-keyframes rota    { to { -moz-transform: rotate(360deg); } }@keyframes rota         { to { transform: rotate(360deg); } }@-webkit-keyframes opa {    12.0% { opacity: 0.80; } 19.5% { opacity: 0.88; } 37.2% { opacity: 0.64; }    40.5% { opacity: 0.52; } 52.7% { opacity: 0.69; } 60.2% { opacity: 0.60; }    66.6% { opacity: 0.52; } 70.0% { opacity: 0.63; } 79.9% { opacity: 0.60; }    84.2% { opacity: 0.75; } 91.0% { opacity: 0.87; }}@-moz-keyframes opa {    12.0% { opacity: 0.80; } 19.5% { opacity: 0.88; } 37.2% { opacity: 0.64; }    40.5% { opacity: 0.52; } 52.7% { opacity: 0.69; } 60.2% { opacity: 0.60; }    66.6% { opacity: 0.52; } 70.0% { opacity: 0.63; } 79.9% { opacity: 0.60; }    84.2% { opacity: 0.75; } 91.0% { opacity: 0.87; }}@keyframes opa {    12.0% { opacity: 0.80; } 19.5% { opacity: 0.88; } 37.2% { opacity: 0.64; }    40.5% { opacity: 0.52; } 52.7% { opacity: 0.69; } 60.2% { opacity: 0.60; }    66.6% { opacity: 0.52; } 70.0% { opacity: 0.63; } 79.9% { opacity: 0.60; }    84.2% { opacity: 0.75; } 91.0% { opacity: 0.87; }}.tbx-control-panel {    margin: 0px;    background-color: rgba(0,0,0,1);    color: rgba(255,255,255,1);    width: auto;    height: auto;    font-size: 20px;    padding: 0px;    z-index: 11000;    font-weight: bold;    display: table;    -moz-user-select: none;    -webkit-user-select: none;    user-select: none;    line-height: 25px;}.tbx-control-panel > label > span {    font-family: serif!important;    text-align: center;    display: table-cell;    vertical-align: middle;    padding: 5px;}.tbx-control-panel > label,.tbx-control-panel > input[type="radio"]:checked ~ input[type="button"][value="close"] + label,.tbx-control-panel > input[type="radio"][value$="list"]:checked ~ input[type="button"] + label {    width: 100%;    display: table-row;}.tbx-control-panel > input[value="close"] + label { display: none; background-color: rgba(230, 65, 65, 1); }.tbx-control-panel > input[value="refresh"] + label { display: none; background-color: rgba(65, 230, 65, 1); }.tbx-control-panel > input { display: none; }.tbx-control-panel > label > span:hover { background-color: rgba(0,255,255,0.5); background-image:none; }.tbx-control-panel > input[type="radio"]:checked + label > span { background-color: #0FF; }.tbx-control-panel > input[type="checkbox"]:checked + label > span {    background-image: -moz-radial-gradient(center center, circle cover, #00ffff, rgba(0,0,0,0) 100%);    background-image: -webkit-radial-gradient(center center, circle cover, #00ffff, rgba(0,0,0,0) 100%);    background-image: radial-gradient(center center, circle cover, #00ffff, rgba(0,0,0,0) 100%)}.tbx-notification {    position: absolute;    border-radius: 36px;    -moz-border-radius: 36px;    -webkit-border-radius: 36px;    height: 10px;    width: 10px;    top: -3px;    right: -3px;    border-radius: 36px;    padding: 2px;    display: inline-block;    color: #fff;    text-shadow: 0px 1px 1px #707070;    font-weight: bold;    text-align: center;    font-size: 8px;    font-family: helvetica !important;    line-height: normal;    background-color: hsl(348, 83%, 55%);    border: 1px solid hsl(352, 57%, 56%);    background: -webkit-linear-gradient(top, hsl(348, 83%, 55%) 0%, hsl(353, 88%, 68%) 100%);    background: -moz-linear-gradient(top, hsl(348, 83%, 55%) 0%, hsl(353, 88%, 68%) 100%);    background: linear-gradient(top, hsl(348, 83%, 55%) 0%, hsl(353, 88%, 68%) 100%);}.tbx-notification-none {    height: 5px;    width: 5px;    top: -2px;    right: -2px;    background-color: hsl(148, 83%, 55%);    border: 1px solid hsl(152, 57%, 56%);    background: -webkit-linear-gradient(top, hsl(148, 83%, 55%) 0%, hsl(153, 88%, 68%) 100%);    background: -moz-linear-gradient(top, hsl(148, 83%, 55%) 0%, hsl(153, 88%, 68%) 100%);    background: linear-gradient(top, hsl(148, 83%, 55%) 0%, hsl(153, 88%, 68%) 100%);}.tbx-list-item { overflow-wrap: break-word; width: 187px; background-color: hsla(0,0%, 64%, 0.9);                 font-size: 10px; color: #FFF; padding: 5px; margin: 2px }.tbx-list-item-unread { background-color: hsla(214, 25%, 61%, 1.0); }.tbx-list-item-selected { -webkit-box-shadow: inset 0 0 10px black; -moz-box-shadow: inset 0 0 10px black; box-shadow: inset 0 0 10px black; }.tbx-list-item:hover { background-color: hsla(214, 50%, 50%, 1.0); }.tbx-list-overlay { width: 210px; background-color: rgba(0,0,0,0.5); position: fixed;                   top: 0px; bottom: 0px; left: 0px; padding: 0px; z-index: 10500; }.tbx-view-content { padding: 15px; height: 100%; }.tbx-view-container { height: 100%; /*width: auto;*/ background-color: rgba(255,255,255,1.0); position: relative; }.tbx-view-overlay { width: 800px; background-color: rgba(0,0,0,0.5); position: fixed;                    top: 40%; bottom: 0px; left: 211px; padding: 5px; z-index: 10000; }',
b=document.createElement("style");b.textContent=a;b.type="text/css";document.body.appendChild(b)})();var t={create:function(a,b){this[a]=new function(){var c=function(){GM_setValue("data-notify-"+a,JSON.stringify({time:Date.now(),value:d}));0===d?e.addClass("tbx-notification-none").text(""):e.removeClass("tbx-notification-none").text(d)};this.set=function(a){d=0>a?0:a;c()};this.change=function(a){a=d+a;d=0>a?0:a;c()};this.elt=function(){return e};this.refresh=function(a){var e=this;b(function(b){e.set(b);
a&&a()})};var d,e=$("<div>");e.attr("class","tbx-notification");this.set(0)};return this[a]}},da=function(){var a=[];return function(){if(0!==a.length)return a;for(var b="cursive;monospace;serif;sans-serif;fantasy;Antiqua;Arial;Arial Black;Arial Narrow;Arial Rounded MT Bold;Avqest;Blackletter;Bookman Old Style;Bradley Hand ITC;Calibri;Century;Century Gothic;Comic Sans;Comic Sans MS;Courier;Courier New;Decorative;Fraktur;Frosty;Garamond;Geneva;Gentium;Georgia;Helvetica;Impact;King;Lalit;Lucida;Lucida Console;Minion;Modena;Modern;Monospace;Monotype Corsiva;Palatino;Papyrus;Roman;Script;Swiss;Tahoma;TeX;Times;Times New Roman;Trebuchet MS;Verdana;Verona".split(";"),
c=new function(){var a=["monospace","sans-serif","serif"],b=document.getElementsByTagName("body")[0],e=document.createElement("span");e.style.fontSize="72px";e.innerHTML="mmmmmmmmmmlli";var c={},d={},f;for(f in a)e.style.fontFamily=a[f],b.appendChild(e),c[a[f]]=e.offsetWidth,d[a[f]]=e.offsetHeight,b.removeChild(e);this.detect=function(f){var g=!1,r;for(r in a){e.style.fontFamily=f+","+a[r];b.appendChild(e);var l=e.offsetWidth!=c[a[r]]||e.offsetHeight!=d[a[r]];b.removeChild(e);g=g||l}return g}},d=
b.length,e=0;e<d;e++)c.detect(b[e])&&a.push(b[e]);return a}}(),g={};(function(){var a=JSON.parse(GM_getValue("settings")||"{}");g.get=function(b){return a[b]};g.set=function(b,c){a[b]=c;GM_setValue("settings",JSON.stringify(a))};g.reset=function(){g={};GM_setValue("settings","{}");GM_setValue("version",0)};1>(GM_getValue("version")||0)&&(g.set("pref-view-quote","textview"),g.set("pref-view-msg","textview"),g.set("pref-brightness",!1),g.set("pref-brightness-level",0.2));GM_setValue("version",1)})();
g.apply=function(){var a=document.getElementById("tbx-settings-style");a&&a.parentNode.removeChild(a);var a=null,b="";g.items={"override-thread-fontsize":{key:"override-thread-fontsize",text:"Thread font size: ",apply:function(a){var c=$(".postcontent"),d=A(c.css("font-size"),!0),c=A(c.css("line-height"),!0);b+=".postcontent{font-size:"+a+"px;"+(c?"line-height:"+c*a/d+"px;":"")+"}"},input:function(){var a=document.createDocumentFragment(),b=document.createElement("input");b.type="checkbox";a.appendChild(b);
a.appendChild(document.createTextNode(this.text));var c=document.createElement("span");c.style.cssText="width: 30px; display: inline-block; text-align: right;";a.appendChild(c);a.appendChild(document.createTextNode("px"));var d=document.createElement("input");d.setAttribute("data-settings-key",this.key);d.style.marginLeft="10px";d.style.marginRight="10px";a.appendChild(d);d.className="tbx-setting-input";d.type="range";d.min="6";d.max="20";b.addEventListener("change",function(a){d.disabled=!b.checked},
!1);d.addEventListener("change",function(){c.textContent=d.value},!1);d.addEventListener("keypress",function(a){a.charCode&&/^[^0-9]$/.test(String.fromCharCode(a.charCode))?a.preventDefault():setTimeout(function(){c.textContent=d.value=d.value.slice(-3)},0)},!1);d.disabled=!1;var f=g.get(this.key);f||(d.disabled=!0,f=A($(".postcontent").css("font-size")),null===f&&a.appendChild(document.createTextNode("[ unknown default font size, override still possible ]")));c.textContent=d.value=f;if(void 0===
f){d.value="6";c.innerHTML="???&nbsp;";b.disabled=!0;var p=document.createElement("a");p.textContent="Load default font size";p.href="#";p.addEventListener("click",function(g){B();var l=document.createElement("div");$(l).load("http://www.thestudentroom.co.uk/showthread.php?t=128 .main",function(g,r,l){if("error"===r)return a.appendChild(document.createTextNode("[ error getting font size, cannot override [#516]]"));g=this.firstChild;g.style.display="none";document.getElementById("page-columns").appendChild(g);
f=$(".postcontent").css("font-size");g.parentNode.removeChild(g);f?(b.disabled=!1,(f=A(f))?c.textContent=d.value=f:a.appendChild(document.createTextNode("[ unknown default font size, override still possible ]"))):a.appendChild(document.createTextNode("[ error getting font size, cannot override [#519]]"))});p.parentNode.removeChild(p);g.preventDefault()},!1);a.appendChild(p)}b.checked=!d.disabled;return a}},"override-thread-font":{key:"override-thread-font",text:"Thread font: ",apply:function(a){b+=
".content .postcontent, .content .quote_block, .postbit_container a, .postbit_container label, .postbit_container div, .postbit_container li, .postbit_container span,.postbit_container blockquote, .postbit_container legend, .postbit_container fieldset {font-family:"+a+"!important;}"},input:function(){var a=document.createDocumentFragment(),b=document.createElement("input");b.type="checkbox";a.appendChild(b);a.appendChild(document.createTextNode(this.text));var c=document.createElement("input");a.appendChild(c);
c.setAttribute("data-settings-key",this.key);c.style.marginLeft="10px";c.style.marginRight="10px";c.style.width="250px";c.style.padding="1px 5px";a.appendChild(c);c.className="tbx-setting-input";b.addEventListener("change",function(a){c.disabled=!b.checked;c.style.cursor=c.disabled?"":"pointer"},!1);c.addEventListener("keydown",function(a){a.preventDefault()},!1);var d=null;c.addEventListener("click",function(){if(null!==d)d.style.visibility="";else{c.disabled=!0;var a=$(c),e=da();d=document.createElement("div");
d.style.cssText="border-width: 1px; border-color: #000; border-style: solid; z-index: 15000;font-size: 14px; background-color: #FFF; padding: 5px; position: fixed; visibility: hidden;top: 0px; bottom: 0px; left: "+(a.offset().left+a.width()+5)+"px;";a=document.createElement("style");a.textContent=".font-picker { padding: 3px; } .font-picker:hover { background-color: rgba(0,255,255,0.5); cursor: pointer; }";document.body.appendChild(a);a=document.createElement("div");a.style.cssText="position: relative; height: 100%;";
d.appendChild(a);document.body.appendChild(d);for(var f,g=0,l,n=0;n<e.length;n++)f=document.createElement("div"),f.className="font-picker",f.appendChild(document.createTextNode(e[n])),f.style.fontFamily=e[n],f.addEventListener("click",function(a){c.value=a.target.textContent;c.disabled=!1;a=new CustomEvent("change",{bubbles:!0,cancelable:!0});b.dispatchEvent(a);d.style.visibility="hidden"},!1),f.style.position="absolute",f.style.whiteSpace="nowrap",a.appendChild(f),l=$(f).width(),f.style.position=
f.style.whiteSpace="",l>g&&(g=l);f.style.width=g+15+"px";d.style.visibility="";$(a).jScrollPane({verticalGutter:0,contentWidth:"0px",autoReinitialise:!0,mouseWheelSpeed:30});$(a).bind("mousewheel DOMMouseScroll",function(a){a.preventDefault()})}},!1);c.disabled=!1;var f=g.get(this.key);f||(c.disabled=!0,f=$(".postcontent").css("font-family"));c.value=f;if(!f){c.value="???";b.disabled=!0;var l=document.createElement("a");l.textContent="Load default font family";l.href="#";l.addEventListener("click",
function(d){B();var g=document.createElement("div");$(g).load("http://www.thestudentroom.co.uk/showthread.php?t=128 .main",function(d,g,l){if("error"===g)return a.appendChild(document.createTextNode("[ error getting font family, cannot override [#483]]"));d=this.firstChild;d.style.display="none";document.getElementById("page-columns").appendChild(d);f=$(".postcontent").css("font-family");d.parentNode.removeChild(d);f?(b.disabled=!1,c.value=f):a.appendChild(document.createTextNode("[ error getting font family, cannot override [#313]]"))});
l.parentNode.removeChild(l);d.preventDefault()},!1);a.appendChild(l)}b.checked=!c.disabled;c.disabled||(c.style.cursor="pointer");return a}},"override-header-scrolling":{key:"override-header-scrolling",text:"Pin header to top: ",apply:function(a){var c=$(document.getElementById("user-menu")).css("height");"true"===a&&(b+="#user-menu { position: absolute!important; top:-"+c+" }")},input:function(){var a=document.createDocumentFragment(),b=document.createElement("input");b.type="checkbox";a.appendChild(document.createTextNode(this.text));
a.appendChild(b);b.setAttribute("data-settings-key",this.key);b.className="tbx-setting-input";b.value=g.get(this.key)||"false";b.checked="true"===b.value?!0:!1;b.addEventListener("change",function(a){b.value="true"===b.value?"false":"true"},!1);return a}}};var a=g.items,c=null,d;for(d in a)a.hasOwnProperty(d)&&(c=g.get(d),void 0!==c&&a[d].apply(c));a=document.createElement("style");a.id="tbx-settings-style";b.type="text/css";a.textContent=b;document.body.appendChild(a)};g.apply();aa();g.get("pref-brightness")&&
$('#overlay-control-panel > input[value="brightness"]').click();console.log("UI finished")}else console.log("not root tsr url - "+window.location.host)})();