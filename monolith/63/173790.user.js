// ==UserScript==
// @name           CNCTA Nobel Dashboard & CDSIM Combat Simulator 
// @author         HACHIDC
// @description    Advanced Alliance Management and Combat Simulator Tools
// @namespace      https://prodgame*.alliances.commandandconquer.com/*/index.aspx*
// @include        https://prodgame*.alliances.commandandconquer.com/*/index.aspx*
// @require        http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js
// @grant          none
// @version        4.0
// ==/UserScript==

//**BEGIN Noble ALLIANCE DASHBOARD CODE**//
function initADReport(){var AD_main=function(){function createInstance(){qx.Class.define("AD",{type:"singleton",extend:qx.core.Object,members:{data:null,mail:null,ui:null,intervalUpdate:null,initialize:function(){this.data=ADDataProvider.getInstance().initialize();this.ui=ADUserInterface.getInstance().initialize()}}},qx.Class.define("ADDataProvider",{type:"singleton",extend:qx.core.Object,members:{mainData:null,alliance:null,members:null,pois:new Array,poiTypes:new Array,poiColors:new Array,initialize:function(){this.mainData=
ClientLib.Data.MainData.GetInstance();this.player=this.mainData.get_Player();this.alliance=this.mainData.get_Alliance();this.members=this.initMemberData();this.pois=this.initPois();return this},initMemberData:function(){var memberData=this.alliance.get_MemberData().d;var output=new Array;for(var i in memberData){var date=new Date(memberData[i]["LastSeen"]);var hours=date.getHours();if(hours<10)hours="0"+hours;var minutes=date.getMinutes();if(minutes<10)minutes="0"+minutes;var seconds=date.getSeconds();
if(seconds<10)seconds="0"+seconds;var day=date.getDate();var month=date.getMonth();var year=date.getFullYear();var formattedTime=month+1+"/"+day+"/"+year+" "+hours+":"+minutes+":"+seconds;var onlinestate="Hidden";if(memberData[i]["OnlineState"]==0)onlinestate="Offline";if(memberData[i]["OnlineState"]==1)onlinestate="Online";if(memberData[i]["OnlineState"]==2)onlinestate="Away";output.push(new Array(memberData[i]["Id"],memberData[i]["Name"],memberData[i]["Rank"],memberData[i]["Points"],memberData[i]["Bases"],
onlinestate,formattedTime))}return output},getMemberData:function(){return this.members},doRequest:function(command,params,context){ClientLib.Net.CommunicationManager.GetInstance().SendSimpleCommand(command,params,phe.cnc.Util.createEventDelegate(ClientLib.Net.CommandResult,this,this.commandCallback),context)},commandCallback:function(context,data){switch(context){case "GetMemberDataForDetailMemberTab":ADUserInterface.getInstance().populateDetailMemberTab(data);break;case "GetBaseReportDataForDetailMemberBasesTabs":ADUserInterface.getInstance().populateBaseReportDetailMemberBaseTab(data);
break;case "GetMemberDataForDetailRosterTab":ADUserInterface.getInstance().populateDetailRosterTab(data);break}},initPois:function(){this.poiTypes["2"]="Tiberium";this.poiTypes["3"]="Crystal";this.poiTypes["4"]="Reactor";this.poiTypes["5"]="Infantry";this.poiTypes["6"]="Ground";this.poiTypes["7"]="Air";this.poiTypes["8"]="Defense";this.poiColors["2"]="00FF37";this.poiColors["3"]="8A54FF";this.poiColors["4"]="77F0FC";this.poiColors["5"]="E6FF00";this.poiColors["6"]="FFB13D";this.poiColors["7"]="FF5757";
this.poiColors["8"]="FF73B0";var pois=this.alliance.get_OwnedPOIs();for(var key in pois){var poi=pois[key];var item=new Array('<span style="background:#'+this.poiColors[poi["t"]]+';display:block;width:15px;height:15px;">&nbsp;</span>',this.poiTypes[poi["t"]],poi["l"],poi["x"],poi["y"]);this.pois.push(item)}return this.pois},getPois:function(){return this.pois},getPoiTypes:function(){return this.poiTypes},getAlliance:function(){return this.alliance},getNameByIdx:function(object,idx){var i=0;for(var n in object){if(i==
idx)return n;i++}return null}}}));qx.Class.define("ADUserInterface",{type:"singleton",extend:qx.core.Object,members:{adWindow:null,data:null,UIDetailGroupbox:null,UITabsCities:new Array,initialize:function(){this.data=ADDataProvider.getInstance();this.initMenu()},initMenu:function(){var bar=qx.core.Init.getApplication().getUIItem(ClientLib.Data.Missions.PATH.BAR_NAVIGATION);var cctaBtn=new qx.ui.form.Button("","http://i.imgur.com/0VF4Rzr.png");cctaBtn.set({center:true,show:"icon",alignY:"middle",
width:40,height:50,toolTipText:"GET TO THE CENTER FOOL!",appearance:"button-text-small"});cctaBtn.addListener("click",function(){ADUserInterface.getInstance().openADWindow()},this);bar.add(cctaBtn)},initADWindow:function(){if(this.adWindow!=null)return this.adWindow;var adWindow=new qx.ui.window.Window("Noble Alliance Management: "+this.data.getAlliance().get_Name());adWindow.set({layout:new qx.ui.layout.VBox(10),showMaximize:true,showMinimize:false,alignX:"center",alignY:"middle",width:1E3,
height:660,minWidth:100,minHeight:200,showStatusbar:true,textColor:"#4E5661"});adWindow.addListener("close",function(e){this.adWindow=null},this);var tabView=new qx.ui.tabview.TabView;var rosterTab=this.initAdWindowRosterTab();tabView.add(rosterTab,{flex:1});var membersTab=this.initAdWindowMembersTab();tabView.add(membersTab,{flex:1});var poiTab=this.initAdWindowPoiTab();tabView.add(poiTab,{flex:1});var rankTab=this.initAdWindowRankTab();tabView.add(rankTab,{flex:1});adWindow.add(tabView,{flex:1});
var slider=new qx.ui.form.Slider;slider.set({value:100,minimum:0,maximum:100,singleStep:1,pageStep:20});adWindow.add(slider);slider.addListener("changeValue",function(e){var op=e.getData()/100;this.adWindow.set({opacity:op})},this);this.adWindow=adWindow;return this.adWindow},openADWindow:function(){if(this.adWindow==null)this.initADWindow();this.adWindow.open();this.adWindow.center();this.adWindow.set({opacity:1})},initAbstractTab:function(tab){tab.setOpacity(1);return tab},initAdWindowRosterTab:function(){var tab=
new qx.ui.tabview.Page("Roster");tab=this.initAbstractTab(tab);tab.setLayout(new qx.ui.layout.HBox(10));var groupbox=new qx.ui.groupbox.GroupBox("Member Statistics");groupbox.setLayout(new qx.ui.layout.VBox(10));tab.add(groupbox,{flex:1,width:"100%"});var tableModel=new qx.ui.table.model.Simple;tableModel.setColumns(["Id","Name","Rank","Points","Bases","Online","Last Online"]);var tableData=this.data.getMemberData();tableModel.setData(tableData);var table=(new qx.ui.table.Table(tableModel)).set({decorator:null});
var detailGroupbox=new qx.ui.groupbox.GroupBox("Attack Logs (per base)");groupbox.add(table,{flex:1});detailGroupbox.setLayout(new qx.ui.layout.VBox(10));this.UIDetailGroupbox=detailGroupbox;tab.add(this.UIDetailGroupbox,{flex:1,width:"0%"});return tab},initAdWindowDetailRosterTab:function(playerId){this.data.doRequest("GetPublicPlayerInfo",{id:playerId},"GetMemberDataForDetailRosterTab")},initAdWindowMembersTab:function(){var tab=new qx.ui.tabview.Page("PvE & PvP Attack Logs");tab=this.initAbstractTab(tab);
tab.setLayout(new qx.ui.layout.HBox(10));var groupbox=new qx.ui.groupbox.GroupBox("Members");groupbox.setLayout(new qx.ui.layout.VBox(10));tab.add(groupbox,{flex:1,width:"50%"});var tableModel=new qx.ui.table.model.Simple;tableModel.setColumns(["Id","Name","Rank"]);var tableData=this.data.getMemberData();tableModel.setData(tableData);var table=(new qx.ui.table.Table(tableModel)).set({decorator:null});var detailGroupbox=new qx.ui.groupbox.GroupBox("Attack Logs (per base)");table.addListener("cellClick",
function(e){var playerId=tableData[e["$$user_row"]][0];detailGroupbox.removeAll();this.initAdWindowDetailMemberTab(playerId)},this);groupbox.add(table,{flex:1});detailGroupbox.setLayout(new qx.ui.layout.VBox(10));this.UIDetailGroupbox=detailGroupbox;tab.add(this.UIDetailGroupbox,{flex:1,width:"50%"});return tab},initAdWindowDetailMemberTab:function(playerId){this.data.doRequest("GetPublicPlayerInfo",{id:playerId},"GetMemberDataForDetailMemberTab")},initAdWindowPoiTab:function(){var tab=new qx.ui.tabview.Page("POI");
tab=this.initAbstractTab(tab);tab.setLayout(new qx.ui.layout.HBox(10));var groupbox=new qx.ui.groupbox.GroupBox("POI Management");groupbox.setLayout(new qx.ui.layout.VBox(10));tab.add(groupbox,{flex:1});var tableModel=new qx.ui.table.model.Simple;tableModel.setColumns(["-","Type","Level","X","Y"]);var tableData=this.data.getPois();tableModel.setData(tableData);var customTCM={tableColumnModel:function(obj){return new qx.ui.table.columnmodel.Resize(obj)}};var table=(new qx.ui.table.Table(tableModel,
customTCM)).set({decorator:null});table.addListener("cellClick",function(e){webfrontend.gui.UtilView.centerCoordinatesOnRegionViewWindow(parseInt(tableData[e["$$user_row"]][3],10),parseInt(tableData[e["$$user_row"]][4],10))},this);var tcm=table.getTableColumnModel();var resizeBehavior=tcm.getBehavior();resizeBehavior.set(0,{width:"1*",minWidth:20,maxWidth:30});var renderer=new qx.ui.table.cellrenderer.Html;table.getTableColumnModel().setDataCellRenderer(0,renderer);groupbox.add(table,{flex:1});var detailPOIBox=
new qx.ui.groupbox.GroupBox("POI");detailPOIBox.setLayout(new qx.ui.layout.VBox(10));tab.add(detailPOIBox,{flex:1,width:"0%"});return tab},initAdWindowRankTab:function(){var tab=new qx.ui.tabview.Page("POI Ratings");tab=this.initAbstractTab(tab);tab.setLayout(new qx.ui.layout.HBox(10));var alliance=this.data.alliance;var tableModel=new qx.ui.table.model.Simple;tableModel.setColumns(["Type","Rate","Score","Next Step","Further Information"]);var rankScore=alliance.get_POIRankScore();var rankSteps=new Array([0,
0,0],[5,14,3E3],[16,17,4E3],[27,20,5500],[50,23,7E3],[90,26,8500],[160,29,1E4],[260,32,12E3],[420,35,15E3],[750,38,18E3],[1300,41,22E3],[2200,44,26E3],[3600,47,3E4],[5700,50,36E3],[9700,53,45E3],[16400,56,6E4],[28E3,58,8E4],[44E3,60,105E3],[8E4,62,135E3],[115E3,64,17E4],[19E4,66,215E3],[33E4,68,27E4]);var nextSteps=new Array;for(var i in rankScore)for(var j in rankScore[i])for(var iStep in rankSteps){if(rankSteps[iStep][0]<=rankScore[i]["s"])continue;nextSteps[i]=rankSteps[iStep][0];break}var rankGeneral=
new Array("General",alliance.get_Rank(),alliance.get_TotalScore(),"/");var rankTib=new Array("POI Tiberium",rankScore[0]["r"],rankScore[0]["s"],nextSteps[0],"Bonus: "+alliance.get_POITiberiumBonus()+"/h");var rankCry=new Array("POI Crystal",rankScore[1]["r"],rankScore[1]["s"],nextSteps[1],"Bonus: "+alliance.get_POICrystalBonus()+"/h");var rankRea=new Array("POI Reactor",rankScore[2]["r"],rankScore[2]["s"],nextSteps[2],"Bonus: "+alliance.get_POIPowerBonus()+"/h");var rankTun=new Array("POI Infantry",
rankScore[3]["r"],rankScore[3]["s"],nextSteps[3],"Bonus: "+alliance.get_POIInfantryBonus()+"%");var rankUra=new Array("POI Ground",rankScore[4]["r"],rankScore[4]["s"],nextSteps[4],"Bonus: "+alliance.get_POIVehicleBonus()+"%");var rankAir=new Array("POI Air",rankScore[5]["r"],rankScore[5]["s"],nextSteps[5],"Bonus: "+alliance.get_POIAirBonus()+"%");var rankRes=new Array("POI Defense",rankScore[6]["r"],rankScore[6]["s"],nextSteps[6],"Bonus: "+alliance.get_POIDefenseBonus()+"%");var rankings=new Array;
rankings.push(rankGeneral,rankTib,rankCry,rankRea,rankTun,rankUra,rankAir,rankRes);tableModel.setData(rankings);var table=(new qx.ui.table.Table(tableModel)).set({decorator:null});tab.add(table,{flex:1});return tab},populateDetailMemberTab:function(data){var detailTabView=new qx.ui.tabview.TabView;var infoTab=new qx.ui.tabview.Page("History");infoTab=this.initAbstractTab(infoTab);infoTab.setLayout(new qx.ui.layout.VBox(10));var citiesTabs=new qx.ui.tabview.TabView;var memberCities=data.c;for(var k in memberCities){var city=
memberCities[k];var cityTab=new qx.ui.tabview.Page(city["n"]);cityTab.setLayout(new qx.ui.layout.VBox(10));var noFightLabel=(new qx.ui.basic.Label("Combat Reports")).set({textColor:"text-value",font:"font_size_13_bold"});cityTab.add(noFightLabel);this.UITabsCities[city["i"]]=cityTab;this.data.doRequest("GetReportHeaderBase",{ascending:false,baseId:city["i"],skip:0,sort:1,take:200,type:1},"GetBaseReportDataForDetailMemberBasesTabs");citiesTabs.add(cityTab,{flex:1})}infoTab.add(citiesTabs,{flex:1});
detailTabView.add(infoTab,{flex:1});this.UIDetailGroupbox.add(detailTabView,{flex:1})},populateBaseReportDetailMemberBaseTab:function(data){if(data.length==0)return true;var firstObject=data[0];var baseId=firstObject.bi;var imgResult=new Array;imgResult["img"]="none";imgResult["img0"]="0";imgResult["img1"]='<img src="https://eaassets-a.akamaihd.net/cncalliancesgame/cdn/data/5aaca4e32fdcbc59a332a90ab09560fd.png" />';imgResult["img2"]="2";imgResult["img3"]="3";imgResult["img4"]='<img src="https://eaassets-a.akamaihd.net/cncalliancesgame/cdn/data/d0b7b7f9cceaf177eeb45703dd5b8583.png" />';
imgResult["img5"]='<img src="https://eaassets-a.akamaihd.net/cncalliancesgame/cdn/data/8b3f702643d0916531dd088032c0b14e.png" />';imgResult["img6"]='<img src="https://eaassets-a.akamaihd.net/cncalliancesgame/cdn/data/d0b7b7f9cceaf177eeb45703dd5b8583.png" />';var thisCityTab=this.UITabsCities[baseId];thisCityTab.removeAll();var tableModel=new qx.ui.table.model.Simple;tableModel.setColumns(["Result","Type","Time"]);var tableData=new Array;for(var i in data){var item=data[i];var combatInfo=item.ad;var typeVal=
"Attack: "+combatInfo.dbn;if(combatInfo.dbn==2)typeVal="<span style='color:green;'>Attack: Camp lvl "+combatInfo.dbl+"</span>";if(combatInfo.dbn==3)typeVal="<span style='color:#ff8c00;'>Attack: Outpost lvl "+combatInfo.dbl+"</span>";if(combatInfo.dbn==4)typeVal="<span style='color:red;'>Attack: Base lvl "+combatInfo.dbl+"</span>";var date=new Date(item.t);var hours=date.getHours();if(hours<10)hours="0"+hours;var minutes=date.getMinutes();if(minutes<10)minutes="0"+minutes;var seconds=date.getSeconds();
if(seconds<10)seconds="0"+seconds;var day=date.getDate();var month=date.getMonth();var year=date.getFullYear();var formattedTime=month+1+"/"+day+"/"+year+" "+hours+":"+minutes+":"+seconds;tableData.push(new Array(imgResult["img"+combatInfo.cr],typeVal,formattedTime))}tableModel.setData(tableData);var customTCM={tableColumnModel:function(obj){return new qx.ui.table.columnmodel.Resize(obj)}};var table=(new qx.ui.table.Table(tableModel,customTCM)).set({decorator:null});var tcm=table.getTableColumnModel();
var resizeBehavior=tcm.getBehavior();resizeBehavior.setWidth(0,60);resizeBehavior.set(1,{width:"1*",minWidth:100,maxWidth:600});var renderer=new qx.ui.table.cellrenderer.Html;table.getTableColumnModel().setDataCellRenderer(0,renderer);table.getTableColumnModel().setDataCellRenderer(1,renderer);thisCityTab.add(table,{flex:1})}}})}function AD_checkIfLoaded(){try{if(typeof qx!="undefined")if(qx.core.Init.getApplication().getMenuBar()!==null){createInstance();AD.getInstance().initialize()}else setTimeout(AD_checkIfLoaded,
1E3);else setTimeout(AD_checkIfLoaded,1E3)}catch(e){if(typeof console!="undefined")console.log(e);else if(window.opera)opera.postError(e);else GM_log(e)}}if(/commandandconquer\.com/i.test(document.domain))setTimeout(AD_checkIfLoaded,1E3)};var AllDash=document.createElement("script");var txt=AD_main.toString();AllDash.innerHTML="("+txt+")();";AllDash.type="text/javascript";if(/commandandconquer\.com/i.test(document.domain))document.getElementsByTagName("head")[0].appendChild(AllDash)}
function waitForClientLib(){for(var i in unsafeWindow);qx=unsafeWindow["qx"];ClientLib=unsafeWindow["ClientLib"];webfrontend=unsafeWindow["webfrontend"];if(typeof ClientLib=="undefined"||typeof qx=="undefined"||qx.core.Init.getApplication().initDone==false){setTimeout(waitForClientLib,1E4);return}else initADReport()}function startup(){setTimeout(waitForClientLib,1E4)}startup();
(function(){var injectFunction=function(){function createClasses(){qx.Class.define("Simulator",{type:"singleton",extend:qx.core.Object,construct:function(){try{armyBar=qx.core.Init.getApplication().getUIItem(ClientLib.Data.Missions.PATH.BAR_ATTACKSETUP);simBtn=new qx.ui.form.Button("","http://i.imgur.com/nmVHmdY.png");simBtn.set({center:true,show:"icon",alignY:"middle",width:45,height:28,toolTipText:"SIMULATE BATTLE!",appearance:"button-text-small"});simBtn.addListener("click",this.__openSimulatorWindow,
this);armyBar.add(simBtn,{left:null,right:66,bottom:120});simBtn.getChildControl("icon").set({width:45,height:28,scale:true});shiftUpBtn=new qx.ui.form.Button("\u2191");shiftUpBtn.set({alignY:"middle",width:30,height:10,toolTipText:"Move up one space",appearance:"button-text-small"});armyBar.add(shiftUpBtn,{left:null,right:80,bottom:101});shiftUpBtn.addListener("click",function(){this.shiftFormation("u")},this);shiftDownBtn=new qx.ui.form.Button("\u2193");shiftDownBtn.set({alignY:"middle",width:30,
height:10,toolTipText:"Move down one space",appearance:"button-text-small"});armyBar.add(shiftDownBtn,{left:null,right:80,bottom:67});shiftDownBtn.addListener("click",function(){this.shiftFormation("d")},this);shiftLeftBtn=new qx.ui.form.Button("\u2190");shiftLeftBtn.set({alignY:"middle",width:28,height:8,toolTipText:"Move left one space",appearance:"button-text-small"});armyBar.add(shiftLeftBtn,{left:null,right:96,bottom:84});shiftLeftBtn.addListener("click",function(){this.shiftFormation("l")},
this);shiftRightBtn=new qx.ui.form.Button("\u2192");shiftRightBtn.set({alignY:"middle",width:28,height:8,toolTipText:"Move right one space",appearance:"button-text-small"});armyBar.add(shiftRightBtn,{left:null,right:65,bottom:84});shiftRightBtn.addListener("click",function(){this.shiftFormation("r")},this);mirrorBtn=new qx.ui.form.Button("","https://cdn1.iconfinder.com/data/icons/ie_Financial_set/16/50.png");mirrorBtn.set({center:true,show:"icon",alignY:"middle",width:25,height:22,toolTipText:"MIRRIOR",
appearance:"button-text-small"});armyBar.add(mirrorBtn,{left:null,right:96,bottom:46});mirrorBtn.addListener("click",function(){this.mirrorFormation()},this);flipBtn=new qx.ui.form.Button("","http://icons.iconarchive.com/icons/oxygen-icons.org/oxygen/16/Actions-object-flip-vertical-icon.png");flipBtn.set({center:true,show:"icon",alignY:"middle",width:25,height:22,toolTipText:"FLIP",appearance:"button-text-small"});armyBar.add(flipBtn,{left:null,right:65,bottom:46});flipBtn.addListener("click",function(){this.flipFormation()},
this);disableAllUnitsBtn=new qx.ui.form.Button("","FactionUI/icons/icon_disable_unit.png");disableAllUnitsBtn.set({center:true,show:"icon",alignY:"middle",width:20,height:20,toolTipText:"Disable all/Enable all",appearance:"button-text-small"});armyBar.add(disableAllUnitsBtn,{left:null,right:96,bottom:1});disableAllUnitsBtn.addListener("click",function(){this.shiftFormation("n")},this);disableAllUnitsBtn.getChildControl("icon").set({width:15,height:15,scale:true});armyUndoBtn=new qx.ui.form.Button("",
"FactionUI/icons/icon_refresh_funds.png");armyUndoBtn.set({center:true,show:"icon",alignY:"middle",width:20,height:20,toolTipText:"Changes to the previous formation after simulation. This button unlocks after simulating a formation.",appearance:"button-text-small"});armyBar.add(armyUndoBtn,{left:null,right:69,bottom:1});armyUndoBtn.addListener("click",function(){this.undoCurrentFormation()},this);armyUndoBtn.getChildControl("icon").set({width:15,height:15,scale:true});armyUndoBtn.setEnabled(false);
armySaveBtn=new qx.ui.form.Button("","http://www.bridge4events.com/img/icon_save_small.png");armySaveBtn.set({center:true,show:"icon",alignY:"middle",width:26,height:26,toolTipText:"QUICK SAVES YOUR PRETTY FORMATION. RETRIEVE FROM SAVE MENU.",appearance:"button-text-small"});armyBar.add(armySaveBtn,{left:null,right:80,bottom:20});armySaveBtn.addListener("click",function(){Simulator.LayoutWindow.getInstance().saveNewLayout(true)},this);unlockCmtBtn=new qx.ui.form.Button("Unlock");unlockCmtBtn.set({alignY:"middle",
width:50,height:50,toolTipText:"UNLOCK MOFO",appearance:"button-text-small"});unlockCmtBtn.setOpacity(0.7);armyBar.add(unlockCmtBtn,{left:null,right:7,bottom:5});unlockCmtBtn.addListener("click",this.timeoutCmtBtn,this);unlockRTBtn=new qx.ui.form.Button("Unlock");unlockRTBtn.set({alignY:"middle",width:50,height:50,toolTipText:"REPAIR YOUR SH*T",appearance:"button-text-small"});unlockRTBtn.setOpacity(0.7);armyBar.add(unlockRTBtn,{left:null,right:7,bottom:97});unlockRTBtn.addListener("click",this.timeoutRTBtn,
this);playArea=qx.core.Init.getApplication().getUIItem(ClientLib.Data.Missions.PATH.OVL_PLAYAREA);optionBtn=new qx.ui.form.Button("Options");optionBtn.set({alignY:"middle",width:60,height:30,toolTipText:"THE OPTIONS BRO",appearance:"button-text-small"});optionBtn.addListener("click",this.__openOptionWindow,this);optionBtn.hide();playArea.add(optionBtn,{left:null,right:25,bottom:280});statBtn=new qx.ui.form.Button("Stats");statBtn.set({alignY:"middle",width:60,height:30,toolTipText:"JUICY STATS",appearance:"button-text-small"});
statBtn.addListener("click",this.__openStatWindow,this);statBtn.hide();playArea.add(statBtn,{left:null,right:25,bottom:240});layoutBtn=new qx.ui.form.Button("","http://www.bridge4events.com/img/icon_save_small.png");layoutBtn.set({center:true,show:"icon",alignY:"middle",width:60,height:30,toolTipText:"SAVE MENU OF GLORY",appearance:"button-text-small"});layoutBtn.addListener("click",this.__openLayoutWindow,this);layoutBtn.hide();playArea.add(layoutBtn,{left:null,right:25,bottom:200});replayBar=qx.core.Init.getApplication().getReportReplayOverlay();
var backBtn=new qx.ui.form.Button("Back");backBtn.set({width:50,height:24,appearance:"button-text-small",toolTipText:"Back to attack screen"});backBtn.addListener("click",this.backToCombatSetup,this);replayBar.add(backBtn,{top:37,left:255});var replayStatBtn=new qx.ui.form.Button("Stats");replayStatBtn.set({width:50,height:24,appearance:"button-text-small",toolTipText:"Return to simulation"});replayStatBtn.addListener("click",this.__openStatWindow,this);replayBar.add(replayStatBtn,{top:7,left:255});
this.isSimButtonDisabled=false;this.isSimulation=false;this.armyTempFormations=new Array;this.armyTempIdx=0;this.repairOneBtns=new Array}catch(e){console.log("Error setting up Simulator Database: ");console.log(e.toString())}},destruct:function(){},members:{armyBar:null,playArea:null,replayBar:null,simBtn:null,optionBtn:null,statBtn:null,layoutBtn:null,unlockCmtBtn:null,unlockRTBtn:null,shiftUpBtn:null,shiftDownBtn:null,shiftLeftBtn:null,shiftRightBtn:null,backBtn:null,isSimButtonDisabled:null,disableAllUnitsBtn:null,
armyTempFormations:null,armyTempIdx:null,armyUndoBtn:null,isSimulation:null,quickSaveBtn:null,armySaveBtn:null,__openSimulatorWindow:function(){var city=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentCity();if(city!=null){var ownCity=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentOwnCity();this.isSimulation=true;this.saveTempFormation();localStorage.ta_sim_last_city=city.get_Id();ownCity.get_CityArmyFormationsManager().set_CurrentTargetBaseId(city.get_Id());ClientLib.API.Battleground.GetInstance().SimulateBattle();
var app=qx.core.Init.getApplication();var battleground=ClientLib.Vis.VisMain.GetInstance().get_Battleground();app.getPlayArea().setView(ClientLib.Data.PlayerAreaViewMode.pavmCombatReplay,city.get_Id(),0,0);var autoSim=localStorage["autoSimulate"];if(typeof autoSim!="undefined")if(autoSim=="yes"){var speed=localStorage["simulateSpeed"];setTimeout(function(){battleground.RestartReplay();battleground.set_ReplaySpeed(parseInt(speed))},1E3)}if(this.isSimButtonDisabled==false){simBtn.setEnabled(false);
var simTimer=1E4;this.disableSimulateButtonTimer(simTimer);if(typeof simStatBtn!="undefined"){simStatBtn.setEnabled(false);var simStatTimer=1E4;Simulator.StatWindow.getInstance().disableSimulateStatButtonTimer(simStatTimer)}}setTimeout(function(){var battleDuration=battleground.get_BattleDuration();battleDuration=Simulator.StatWindow.getInstance().formatBattleDurationTime(battleDuration);Simulator.StatWindow.getInstance().__labelMiscBattleDuration.setValue(battleDuration)},1E3);if(simReplayBtn.getEnabled()==
false)simReplayBtn.setEnabled(true)}},__openOptionWindow:function(){try{if(Simulator.OptionWindow.getInstance().isVisible()){console.log("Closing Option Window");Simulator.OptionWindow.getInstance().close()}else{console.log("Opening Option Window");Simulator.OptionWindow.getInstance().open()}}catch(e){console.log("Error Opening or Closing Option Window");console.log(e.toString())}},__openStatWindow:function(){try{if(Simulator.StatWindow.getInstance().isVisible()){console.log("Closing Stat Window");
Simulator.StatWindow.getInstance().close()}else{console.log("Opening Stat Window");Simulator.StatWindow.getInstance().open();Simulator.StatWindow.getInstance().calcResources()}}catch(e){console.log("Error Opening or Closing Stat Window");console.log(e.toString())}},__openLayoutWindow:function(){try{if(Simulator.LayoutWindow.getInstance().isVisible()){console.log("Closing Layout Window");Simulator.LayoutWindow.getInstance().close()}else{console.log("Opening LayoutWindow");Simulator.LayoutWindow.getInstance().updateLayoutList();
Simulator.LayoutWindow.getInstance().layoutTextBox.setValue("");Simulator.LayoutWindow.getInstance().persistentCheck.setValue(false);Simulator.LayoutWindow.getInstance().open()}}catch(e){console.log("Error Opening or Closing Layout Window");console.log(e.toString())}},__openToolsWindow:function(){},attachNetEvent:function(){console.log("Need to assign correct function!")},formatNumbersCompact:function(){console.log("Need to assign correct function!")},GetUnitMaxHealth:function(){console.log("Need to assign correct function!");
return-1},saveTempFormation:function(){try{if(this.armyTempFormations.length!=0){var currForm=this.getCityPreArmyUnits().get_ArmyUnits().l;for(var i=0;i<currForm.length;i++){var lastForm=this.armyTempFormations[this.armyTempIdx][i];if(currForm[i].get_CoordX()!=lastForm.x||currForm[i].get_CoordY()!=lastForm.y)break;else if(i+1==currForm.length)return}}var formation=new Array;var unitList=this.getCityPreArmyUnits().get_ArmyUnits().l;for(var i=0;i<unitList.length;i++){var unit=unitList[i];var unitInfo=
{};unitInfo.x=unit.get_CoordX();unitInfo.y=unit.get_CoordY();unitInfo.id=unit.get_Id();unitInfo.enabled=unit.get_Enabled();formation.push(unitInfo)}this.armyTempFormations.push(formation);this.armyTempIdx=this.armyTempFormations.length-1;if(this.armyTempFormations.length>1)armyUndoBtn.setEnabled(true)}catch(e){console.log("Error Saving Temp Formation");console.log(e.toString())}},undoCurrentFormation:function(){try{this.restoreFormation(this.armyTempFormations[this.armyTempIdx-1]);this.armyTempFormations.splice(this.armyTempIdx,
1);this.armyTempIdx--;if(this.armyTempFormations.length==1)armyUndoBtn.setEnabled(false)}catch(e){console.log("Error undoing formation");console.log(e.toString())}},mirrorFormation:function(){try{var units=this.getCityPreArmyUnits();var unitsList=this.getCityPreArmyUnits().get_ArmyUnits().l;var mirror=new Array;for(var i=0;i<unitsList.length;i++){var unit=unitsList[i];var armyUnit={};var x=unit.get_CoordX();var distanceX=x-4;if(distanceX<0)x=x-distanceX+-1*distanceX;else if(distanceX>0)x=x-distanceX-
distanceX;armyUnit.x=x;armyUnit.y=unit.get_CoordY();armyUnit.id=unit.get_Id();armyUnit.enabled=unit.get_Enabled();mirror.push(armyUnit)}this.restoreFormation(mirror)}catch(e){console.log("Error Mirroring Formation");console.log(e)}},flipFormation:function(){try{var units=this.getCityPreArmyUnits();var unitsList=this.getCityPreArmyUnits().get_ArmyUnits().l;var flip=new Array;for(var i=0;i<unitsList.length;i++){var unit=unitsList[i];var armyUnit={};var y=unit.get_CoordY();var distanceY=y-1.5;if(distanceY<
0)y=y-distanceY+-1*distanceY;else if(distanceY>0)y=y-distanceY-distanceY;armyUnit.y=y;armyUnit.x=unit.get_CoordX();armyUnit.id=unit.get_Id();armyUnit.enabled=unit.get_Enabled();flip.push(armyUnit)}this.restoreFormation(flip)}catch(e){console.log("Error Flipping Formation");console.log(e)}},shiftFormation:function(direction){try{console.log("Shifting Unit Formation");var v_shift=0;var h_shift=0;if(direction=="u")var v_shift=-1;if(direction=="d")var v_shift=1;if(direction=="l")var h_shift=-1;if(direction==
"r")var h_shift=1;if(v_shift==0&&h_shift==0&&direction!="n")return;var units=this.getCityPreArmyUnits().get_ArmyUnits().l;var newLayout=[];for(var i=0;i<units.length;i++){var unit=units[i];var armyUnit={};var x=unit.get_CoordX()+h_shift;switch(x){case 9:x=0;break;case -1:x=8;break}var y=unit.get_CoordY()+v_shift;switch(y){case 4:y=0;break;case -1:y=3;break}armyUnit.x=x;armyUnit.y=y;armyUnit.id=unit.get_Id();if(direction=="n")if(typeof localStorage["allUnitsDisabled"]!="undefined")if(localStorage["allUnitsDisabled"]==
"yes")armyUnit.enabled=unit.set_Enabled(false);else armyUnit.enabled=unit.set_Enabled(true);else armyUnit.enabled=unit.set_Enabled(false);armyUnit.enabled=unit.get_Enabled();newLayout.push(armyUnit)}if(direction=="n")if(localStorage["allUnitsDisabled"]=="yes")localStorage["allUnitsDisabled"]="no";else localStorage["allUnitsDisabled"]="yes";this.restoreFormation(newLayout)}catch(e){console.log("Error Shifting Units");console.log(e.toString())}},restoreFormation:function(layout){try{var sUnits=layout;
var units=this.getCityPreArmyUnits();var units_list=units.get_ArmyUnits().l;for(var idx=0;idx<sUnits.length;idx++){var saved_unit=sUnits[idx];var uid=saved_unit.id;for(var i=0;i<units_list.length;i++)if(units_list[i].get_Id()===uid){units_list[i].MoveBattleUnit(saved_unit.x,saved_unit.y);if(saved_unit.enabled===undefined)units_list[i].set_Enabled(true);else units_list[i].set_Enabled(saved_unit.enabled)}}units.UpdateFormation(true)}catch(e){console.log("Error Restoring Formation");console.log(e.toString())}},
getCityPreArmyUnits:function(){var city=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentCity();var ownCity=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentOwnCity();var formationManager=ownCity.get_CityArmyFormationsManager();ownCity.get_CityArmyFormationsManager().set_CurrentTargetBaseId(city.get_Id());return formationManager.GetFormationByTargetBaseId(formationManager.get_CurrentTargetBaseId())},timeoutCmtBtn:function(){armyBar.remove(unlockCmtBtn);setTimeout(function(){armyBar.add(unlockCmtBtn,
{left:null,right:7,bottom:5})},2E3)},timeoutRTBtn:function(){armyBar.remove(unlockRTBtn);setTimeout(function(){armyBar.add(unlockRTBtn,{left:null,right:7,bottom:97})},2E3)},backToCombatSetup:function(){var app=qx.core.Init.getApplication();var player_cities=ClientLib.Data.MainData.GetInstance().get_Cities();var current_city=player_cities.get_CurrentCity();try{app.getPlayArea().setView(ClientLib.Data.PlayerAreaViewMode.pavmCombatSetupDefense,localStorage.ta_sim_last_city,0,0)}catch(e){console.log("Error closing Simulation Window");
console.log(e.toString())}},disableSimulateButtonTimer:function(timer){try{if(timer>=500){this.isSimButtonDisabled=true;simBtn.setLabel(Math.floor(timer/500));timer-=500;setTimeout(function(){Simulator.getInstance().disableSimulateButtonTimer(timer)},500)}else{setTimeout(function(){simBtn.setEnabled(true);if(Simulator.OptionWindow.getInstance()._buttonSizeCB.getValue())simBtn.setLabel("");else simBtn.setLabel("")},timer);this.isSimButtonDisabled=false}}catch(e){console.log("Error disabling simulator button");
console.log(e.toString())}}}});qx.Class.define("Simulator.StatWindow",{type:"singleton",extend:qx.ui.window.Window,construct:function(){this.base(arguments);this.setLayout(new qx.ui.layout.VBox);this.set({width:220,caption:"BOOTY, SPOILS, and DATA",padding:2,allowMaximize:false,showMaximize:false,allowMinimize:false,showMinimize:false});this.setResizable(false,true,false,true);if(typeof localStorage["statWindowPosLeft"]!="undefined"){var left=parseInt(localStorage["statWindowPosLeft"]);var top=parseInt(localStorage["statWindowPosTop"]);
this.moveTo(left,top)}else this.moveTo(125,35);var enemyHealthHeader=(new qx.ui.container.Composite(new qx.ui.layout.VBox)).set({decorator:"pane-light-opaque"});var enemyHealthTitle=(new qx.ui.basic.Label("THE ENEMY'S BACON")).set({alignX:"center",alignY:"top",font:"font_size_14_bold"});enemyHealthHeader.add(enemyHealthTitle);this.add(enemyHealthHeader);var enemyHealth=new qx.ui.container.Composite(new qx.ui.layout.HBox(2));enemyHealth.setThemedFont("bold");var enemyHealthBox=(new qx.ui.container.Composite(new qx.ui.layout.VBox(5))).set({width:70,
padding:5,decorator:"pane-light-opaque"});var eHLabelOverall=new qx.ui.basic.Label("Total:");var eHLabelBase=new qx.ui.basic.Label("Base:");var eHLabelDefense=new qx.ui.basic.Label("Defense:");var eHLabelCY=new qx.ui.basic.Label("CY:");var eHLabelDF=new qx.ui.basic.Label("DF:");enemyHealthBox.add(eHLabelOverall);enemyHealthBox.add(eHLabelBase);enemyHealthBox.add(eHLabelDefense);enemyHealthBox.add(eHLabelCY);enemyHealthBox.add(eHLabelDF);enemyHealth.add(enemyHealthBox);this.__labelEnemyOverallHealth=
new Array;this.__labelEnemyBaseHealth=new Array;this.__labelEnemyDefenseHealth=new Array;this.__labelEnemyCYHealth=new Array;this.__labelEnemyDFHealth=new Array;var enemyHealthValues=(new qx.ui.container.Composite(new qx.ui.layout.VBox(5))).set({alignX:"center",width:90,padding:5,decorator:"pane-light-opaque"});this.__labelEnemyOverallHealth=(new qx.ui.basic.Label("-")).set({alignX:"right"});this.__labelEnemyBaseHealth=(new qx.ui.basic.Label("-")).set({alignX:"right"});this.__labelEnemyDefenseHealth=
(new qx.ui.basic.Label("-")).set({alignX:"right"});this.__labelEnemyCYHealth=(new qx.ui.basic.Label("-")).set({alignX:"right"});this.__labelEnemyDFHealth=(new qx.ui.basic.Label("-")).set({alignX:"right"});enemyHealthValues.add(this.__labelEnemyOverallHealth);enemyHealthValues.add(this.__labelEnemyBaseHealth);enemyHealthValues.add(this.__labelEnemyDefenseHealth);enemyHealthValues.add(this.__labelEnemyCYHealth);enemyHealthValues.add(this.__labelEnemyDFHealth);enemyHealth.add(enemyHealthValues,{flex:1});
this.add(enemyHealth);var playerRepairHeader=(new qx.ui.container.Composite(new qx.ui.layout.VBox)).set({decorator:"pane-light-opaque"});var playerRepairTitle=(new qx.ui.basic.Label("Repair Times")).set({alignX:"center",alignY:"top",font:"font_size_14_bold"});playerRepairHeader.add(playerRepairTitle);this.add(playerRepairHeader);var playerRepair=new qx.ui.container.Composite(new qx.ui.layout.HBox(2));playerRepair.setThemedFont("bold");var playerRepairBox=(new qx.ui.container.Composite(new qx.ui.layout.VBox(5))).set({width:70,
padding:5,decorator:"pane-light-opaque"});var pRLabelStorage=new qx.ui.basic.Label("Total:");var pRLabelOverall=new qx.ui.basic.Label("Leftover:");var pRLabelInf=new qx.ui.basic.Label("Infantry:");var pRLabelVehi=new qx.ui.basic.Label("Ground:");var pRLabelAir=new qx.ui.basic.Label("Air:");playerRepairBox.add(pRLabelStorage);playerRepairBox.add(pRLabelOverall);playerRepairBox.add(pRLabelInf);playerRepairBox.add(pRLabelVehi);playerRepairBox.add(pRLabelAir);playerRepair.add(playerRepairBox);var playerRepairValues=
(new qx.ui.container.Composite(new qx.ui.layout.VBox(5))).set({alignX:"center",width:90,padding:5,decorator:"pane-light-opaque"});this.__labelRepairStorage=(new qx.ui.basic.Label("-")).set({alignX:"right"});this.__labelRepairOverall=(new qx.ui.basic.Label("-")).set({alignX:"right"});this.__labelRepairInf=(new qx.ui.basic.Label("-")).set({alignX:"right"});this.__labelRepairVehi=(new qx.ui.basic.Label("-")).set({alignX:"right"});this.__labelRepairAir=(new qx.ui.basic.Label("-")).set({alignX:"right"});
playerRepairValues.add(this.__labelRepairStorage);playerRepairValues.add(this.__labelRepairOverall);playerRepairValues.add(this.__labelRepairInf);playerRepairValues.add(this.__labelRepairVehi);playerRepairValues.add(this.__labelRepairAir);playerRepair.add(playerRepairValues,{flex:1});this.add(playerRepair);var miscHeader=(new qx.ui.container.Composite(new qx.ui.layout.VBox)).set({decorator:"pane-light-opaque"});var miscTitle=(new qx.ui.basic.Label("Condition")).set({alignX:"center",alignY:"top",font:"font_size_14_bold"});
miscHeader.add(miscTitle);this.add(miscHeader);var misc=new qx.ui.container.Composite(new qx.ui.layout.HBox(2));misc.setThemedFont("bold");var miscBox=(new qx.ui.container.Composite(new qx.ui.layout.VBox(5))).set({width:70,padding:5,decorator:"pane-light-opaque"});var miscOutcome=new qx.ui.basic.Label("Status:");var miscBattleDuration=new qx.ui.basic.Label("Battle Time:");miscBox.add(miscOutcome);miscBox.add(miscBattleDuration);misc.add(miscBox);this.__labelMiscOutcome=new Array;this.__labelMiscBattleDuration=
new Array;var miscValues=(new qx.ui.container.Composite(new qx.ui.layout.VBox(5))).set({alignX:"center",width:90,padding:5,decorator:"pane-light-opaque"});this.__labelMiscOutcome=(new qx.ui.basic.Atom("Unknown",null)).set({allowGrowX:false,alignX:"right"});this.__labelMiscBattleDuration=(new qx.ui.basic.Label("0:00")).set({alignX:"right"});miscValues.add(this.__labelMiscOutcome);miscValues.add(this.__labelMiscBattleDuration);misc.add(miscValues,{flex:1});this.add(misc);var battleLootHeader=(new qx.ui.container.Composite(new qx.ui.layout.VBox)).set({decorator:"pane-light-opaque"});
var battleLootTitle=(new qx.ui.basic.Label("BOOTY")).set({alignX:"center",alignY:"top",font:"font_size_14_bold"});battleLootHeader.add(battleLootTitle);this.add(battleLootHeader);var battleLoot=new qx.ui.container.Composite(new qx.ui.layout.HBox(2));battleLoot.setThemedFont("bold");var battleLootBox=(new qx.ui.container.Composite(new qx.ui.layout.VBox(5))).set({width:70,padding:5,decorator:"pane-light-opaque"});var battleLootTib=new qx.ui.basic.Atom(null,"webfrontend/ui/common/icn_res_tiberium.png");
var battleLootCry=new qx.ui.basic.Atom(null,"webfrontend/ui/common/icn_res_chrystal.png");var battleLootCred=new qx.ui.basic.Atom(null,"webfrontend/ui/common/icn_res_dollar.png");var battleLootRP=new qx.ui.basic.Atom(null,"webfrontend/ui/common/icn_res_research_mission.png");var battleLootTotal=new qx.ui.basic.Atom(null,"webfrontend/ui/icons/icon_item.png");var battleLootTotal=new qx.ui.basic.Atom(null,"webfrontend/ui/common/icn_build_slots.png");battleLootTib.setToolTipText("Tiberium");battleLootCry.setToolTipText("Crystal");
battleLootCred.setToolTipText("Credits");battleLootRP.setToolTipText("Research Points");battleLootTotal.setToolTipText("Total Resources");battleLootTib.getChildControl("icon").set({width:23,height:23,scale:true});battleLootCry.getChildControl("icon").set({width:23,height:23,scale:true});battleLootCred.getChildControl("icon").set({width:23,height:23,scale:true});battleLootRP.getChildControl("icon").set({width:23,height:23,scale:true});battleLootTotal.getChildControl("icon").set({width:23,height:23,
scale:true});battleLootBox.add(battleLootTib);battleLootBox.add(battleLootCry);battleLootBox.add(battleLootCred);battleLootBox.add(battleLootRP);battleLootBox.add(battleLootTotal);battleLoot.add(battleLootBox);this.__labelBattleLootTotal=new Array;this.__labelBattleLootTib=new Array;this.__labelBattleLootCry=new Array;this.__labelBattleLootCred=new Array;this.__labelBattleLootRP=new Array;var battleLootValues=(new qx.ui.container.Composite(new qx.ui.layout.VBox(5))).set({alignX:"center",width:90,
padding:5,decorator:"pane-light-opaque"});this.__labelBattleLootTib=(new qx.ui.basic.Label("-")).set({alignX:"right",padding:3});this.__labelBattleLootCry=(new qx.ui.basic.Label("-")).set({alignX:"right",padding:3});this.__labelBattleLootCred=(new qx.ui.basic.Label("-")).set({alignX:"right",padding:3});this.__labelBattleLootRP=(new qx.ui.basic.Label("-")).set({alignX:"right",padding:3});this.__labelBattleLootTotal=(new qx.ui.basic.Label("-")).set({alignX:"right",padding:3});battleLootValues.add(this.__labelBattleLootTib);
battleLootValues.add(this.__labelBattleLootCry);battleLootValues.add(this.__labelBattleLootCred);battleLootValues.add(this.__labelBattleLootRP);battleLootValues.add(this.__labelBattleLootTotal);battleLoot.add(battleLootValues,{flex:1});this.add(battleLoot);var simButton=(new qx.ui.container.Composite(new qx.ui.layout.HBox(5))).set({padding:5,decorator:"pane-light-opaque"});this.add(simButton);simStatBtn=(new qx.ui.form.Button("Sim Stats")).set({allowGrowX:false});simStatBtn.setToolTipText("Sim Stats");
simStatBtn.addListener("click",this.simulateStats,this);simReplayBtn=(new qx.ui.form.Button("Replay")).set({allowGrowX:false});simReplayBtn.setToolTipText("Sim Replay");simReplayBtn.addListener("click",this.doSimReplay,this);simReplayBtn.setEnabled(false);simButton.add(simStatBtn,{width:"50%"});simButton.add(simReplayBtn,{width:"50%"});enemyHealthHeader.addListener("click",function(){if(enemyHealth.isVisible())enemyHealth.exclude();else enemyHealth.show()},this);playerRepairHeader.addListener("click",
function(){if(playerRepair.isVisible())playerRepair.exclude();else playerRepair.show()},this);miscHeader.addListener("click",function(){if(misc.isVisible())misc.exclude();else misc.show()},this);battleLootHeader.addListener("click",function(){if(battleLoot.isVisible())battleLoot.exclude();else battleLoot.show()},this);if(typeof localStorage["hideHealth"]!="undefined")if(localStorage["hideHealth"]=="yes")enemyHealth.exclude();if(typeof localStorage["hideRepair"]!="undefined")if(localStorage["hideRepair"]==
"yes")playerRepair.exclude();if(typeof localStorage["hideMisc"]!="undefined")if(localStorage["hideMisc"]=="yes")misc.exclude();if(typeof localStorage["hideLoot"]!="undefined")if(localStorage["hideLoot"]=="yes")battleLoot.exclude();this.isSimStatButtonDisabled=false;Simulator.getInstance().attachNetEvent(ClientLib.API.Battleground.GetInstance(),"OnSimulateBattleFinished",ClientLib.API.OnSimulateBattleFinished,this,this.__OnSimulateBattleFinished)},destruct:function(){},members:{simStatBtn:null,simReplayBtn:null,
__labelEnemyOverallHealth:null,__labelEnemyBaseHealth:null,__labelEnemyDefenseHealth:null,__labelEnemyCYHealth:null,__labelEnemyDFHealth:null,__labelRepairOverall:null,__labelRepairInf:null,__labelRepairVehi:null,__labelRepairAir:null,__labelBattleLootTotal:null,__labelBattleLootTib:null,__labelBattleLootCry:null,__labelBattleLootCred:null,__labelBattleLootRP:null,__labelMiscOutcome:null,__labelMiscBattleDuration:null,isSimStatButtonDisabled:null,__labelRepairStorage:null,simulateStats:function(){console.log("Simulated Stats");
var city=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentCity();if(city!=null){Simulator.getInstance().isSimulation=true;Simulator.getInstance().saveTempFormation();localStorage.ta_sim_last_city=city.get_Id();var ownCity=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentOwnCity();ownCity.get_CityArmyFormationsManager().set_CurrentTargetBaseId(city.get_Id());ClientLib.API.Battleground.GetInstance().SimulateBattle();var battleground=ClientLib.Vis.VisMain.GetInstance().get_Battleground();
if(this.isSimStatButtonDisabled==false){simStatBtn.setEnabled(false);var simStatTimer=1E4;var simStatTimeout=this.disableSimulateStatButtonTimer(simStatTimer);simBtn.setEnabled(false);var simTimer=500;Simulator.getInstance().disableSimulateButtonTimer(simTimer)}setTimeout(function(){var battleDuration=battleground.get_BattleDuration();battleDuration=Simulator.StatWindow.getInstance().formatBattleDurationTime(battleDuration);Simulator.StatWindow.getInstance().__labelMiscBattleDuration.setValue(battleDuration)},
1E3);if(simReplayBtn.getEnabled()==false)simReplayBtn.setEnabled(true)}},doSimReplay:function(){try{Simulator.getInstance().isSimulation=true;var battleground=ClientLib.Vis.VisMain.GetInstance().get_Battleground();var app=qx.core.Init.getApplication();app.getPlayArea().setView(ClientLib.Data.PlayerAreaViewMode.pavmCombatReplay,localStorage.ta_sim_last_city,0,0);var autoSim=localStorage["autoSimulate"];if(typeof autoSim!="undefined")if(autoSim=="yes"){var speed=localStorage["simulateSpeed"];setTimeout(function(){battleground.RestartReplay();
battleground.set_ReplaySpeed(parseInt(speed))},1E3)}}catch(e){console.log("Error attempting to show Simulation Replay");console.log(e.toString())}},__OnSimulateBattleFinished:function(data){this.getSimulationInfo(data)},formatBattleDurationTime:function(time){var seconds=time/1E3;var minutes=seconds/60;minutes=Math.round(minutes-0.5);seconds=Math.round(seconds-0.5-minutes*60);if(seconds<10)seconds="0"+seconds;return minutes+":"+seconds},calculateRepairCosts:function(id,level,sHealth,eHealth,mHealth){repairCosts=
{"RT":0,"C":0};var dmgRatio=1;if(sHealth!=eHealth){if(eHealth>0)dmgRatio=(sHealth-eHealth)/16/mHealth;else dmgRatio=sHealth/16/mHealth;var costs=ClientLib.API.Util.GetUnitRepairCosts(level,id,dmgRatio);for(var idx=0;idx<costs.length;idx++){var uCosts=costs[idx];var cType=parseInt(uCosts.Type);switch(cType){case ClientLib.Base.EResourceType.Crystal:repairCosts["C"]+=uCosts.Count;break;case ClientLib.Base.EResourceType.RepairChargeBase:case ClientLib.Base.EResourceType.RepairChargeInf:case ClientLib.Base.EResourceType.RepairChargeVeh:case ClientLib.Base.EResourceType.RepairChargeAir:repairCosts["RT"]+=
uCosts.Count;break}}}return repairCosts},getSimulationInfo:function(data){console.log("Getting Player Unit Damage");try{var crystals=0,infCry=0,vehiCry=0,airCry=0;var allSH=0,allEH=0,allMH=0,allHP=0;var baseSH=0,baseEH=0,baseMH=0,baseHP=0;var defSH=0,defEH=0,defMH=0,defHP=0;var infSH=0,infEH=0,infMH=0,infHP=0;var vehiSH=0,vehiEH=0,vehiMH=0,vehiHP=0;var airSH=0,airEH=0,airMH=0,airHP=0;var infRT=0,vehiRT=0,airRT=0;var cySH=0,cyEH=0,cyMH=0,cyHP=0;var dfSH=0,dfEH=0,dfMH=0,dfHP=0;var costs={};var entities=
[];var city=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentOwnCity();var defBonus=city.get_AllianceDefenseBonus();for(var idx=0;idx<data.length;idx++){var unitData=data[idx].Value;var uMDBID=unitData.t;var unit=ClientLib.Res.ResMain.GetInstance().GetUnit_Obj(uMDBID);var level=unitData.l;var sHealth=unitData.sh;var eHealth=unitData.h;var mHealth=Simulator.getInstance().GetUnitMaxHealth(level,unit,false);var pType=unit.pt;var mType=unit.mt;entities.push(unitData);switch(pType){case ClientLib.Base.EPlacementType.Defense:allMH+=
mHealth;allEH+=eHealth;defMH+=mHealth;defEH+=eHealth;break;case ClientLib.Base.EPlacementType.Offense:switch(mType){case ClientLib.Base.EUnitMovementType.Feet:infMH+=mHealth;infEH+=eHealth;costs=this.calculateRepairCosts(uMDBID,level,sHealth,eHealth,mHealth);infRT+=costs["RT"];infCry+=costs["C"];crystals+=costs["C"];break;case ClientLib.Base.EUnitMovementType.Wheel:case ClientLib.Base.EUnitMovementType.Track:vehiMH+=mHealth;vehiEH+=eHealth;costs=this.calculateRepairCosts(uMDBID,level,sHealth,eHealth,
mHealth);vehiRT+=costs["RT"];vehiCry+=costs["C"];crystals+=costs["C"];break;case ClientLib.Base.EUnitMovementType.Air:case ClientLib.Base.EUnitMovementType.Air2:airMH+=mHealth;airEH+=eHealth;costs=this.calculateRepairCosts(uMDBID,level,sHealth,eHealth,mHealth);airRT+=costs["RT"];airCry+=costs["C"];crystals+=costs["C"];break}break;case ClientLib.Base.EPlacementType.Structure:allMH+=mHealth;allEH+=eHealth;baseMH+=mHealth;baseEH+=eHealth;switch(uMDBID){case 151:case 112:case 177:cySH=sHealth;cyMH=mHealth;
cyEH=eHealth;break;case 158:case 131:case 195:dfMH=mHealth;dfEH=eHealth;break}break}}crystals=Simulator.getInstance().formatNumbersCompact(crystals);infCry=Simulator.getInstance().formatNumbersCompact(infCry);vehiCry=Simulator.getInstance().formatNumbersCompact(vehiCry);airCry=Simulator.getInstance().formatNumbersCompact(airCry);var allOffRTInSeconds=Math.max(infRT,vehiRT,airRT);var allOffRT=phe.cnc.Util.getTimespanString(ClientLib.Data.MainData.GetInstance().get_Time().GetTimeSpan(Math.max(infRT,
vehiRT,airRT)));infRT=phe.cnc.Util.getTimespanString(ClientLib.Data.MainData.GetInstance().get_Time().GetTimeSpan(infRT));vehiRT=phe.cnc.Util.getTimespanString(ClientLib.Data.MainData.GetInstance().get_Time().GetTimeSpan(vehiRT));airRT=phe.cnc.Util.getTimespanString(ClientLib.Data.MainData.GetInstance().get_Time().GetTimeSpan(airRT));allHP=allMH==0?100:allEH/(allMH*16)*100;baseHP=baseMH==0?100:baseEH/(baseMH*16)*100;defHP=defMH==0?100:defEH/(defMH*16)*100;cyHP=cyMH==0?100:cyEH/(cyMH*16)*100;dfHP=
dfMH==0?100:dfEH/(dfMH*16)*100;infHP=infMH==0?100:infEH/(infMH*16)*100;vehiHP=vehiMH==0?100:vehiEH/(vehiMH*16)*100;airHP=airMH==0?100:airEH/(airMH*16)*100;var allOffHP=(infEH+vehiEH+airEH)/((infMH+vehiMH+airMH)*16)*100;if(allOffHP==0){this.__labelMiscOutcome.setLabel("Total Defeat");this.__labelMiscOutcome.setIcon("FactionUI/icons/icon_reports_total_defeat.png");this.__labelMiscOutcome.setTextColor("red")}else if(cyEH==0){this.__labelMiscOutcome.setLabel("Total Victory");this.__labelMiscOutcome.setIcon("FactionUI/icons/icon_reports_total_victory.png");
this.__labelMiscOutcome.setTextColor("darkgreen")}else{this.__labelMiscOutcome.setLabel("Victory");this.__labelMiscOutcome.setIcon("FactionUI/icons/icon_reports_victory.png");this.__labelMiscOutcome.setTextColor("darkgreen")}this.__labelEnemyOverallHealth.setValue(allHP.toFixed(2));this.setEHLabelColor(this.__labelEnemyOverallHealth,allHP.toFixed(2));this.__labelEnemyDefenseHealth.setValue(defHP.toFixed(2));this.setEHLabelColor(this.__labelEnemyDefenseHealth,defHP.toFixed(2));this.__labelEnemyBaseHealth.setValue(baseHP.toFixed(2));
this.setEHLabelColor(this.__labelEnemyBaseHealth,baseHP.toFixed(2));this.__labelEnemyCYHealth.setValue(cyHP.toFixed(2));this.setEHLabelColor(this.__labelEnemyCYHealth,cyHP.toFixed(2));this.__labelEnemyDFHealth.setValue(dfHP.toFixed(2));this.setEHLabelColor(this.__labelEnemyDFHealth,dfHP.toFixed(2));var getRTSelection=localStorage["getRTSelection"];if(typeof localStorage["getDivider"]!="undefined")var divider=" "+localStorage["getDivider"]+" ";else var divider=" | ";if(typeof getRTSelection!="undefined")if(getRTSelection==
"crt"){this.__labelRepairOverall.setValue(crystals+divider+allOffRT);this.__labelRepairInf.setValue(infCry+divider+infRT);this.__labelRepairVehi.setValue(vehiCry+divider+vehiRT);this.__labelRepairAir.setValue(airCry+divider+airRT)}else if(getRTSelection=="hprt"){this.__labelRepairOverall.setValue(allOffHP.toFixed(2)+divider+allOffRT);this.__labelRepairInf.setValue(infHP.toFixed(2)+divider+infRT);this.__labelRepairVehi.setValue(vehiHP.toFixed(2)+divider+vehiRT);this.__labelRepairAir.setValue(airHP.toFixed(2)+
divider+airRT)}else{this.__labelRepairOverall.setValue(allOffRT);this.__labelRepairInf.setValue(infRT);this.__labelRepairVehi.setValue(vehiRT);this.__labelRepairAir.setValue(airRT)}else{this.__labelRepairOverall.setValue(allOffRT);this.__labelRepairInf.setValue(infRT);this.__labelRepairVehi.setValue(vehiRT);this.__labelRepairAir.setValue(airRT)}this.setRTLabelColor(this.__labelRepairOverall,allOffHP.toFixed(2));this.setRTLabelColor(this.__labelRepairInf,infHP.toFixed(2));this.setRTLabelColor(this.__labelRepairVehi,
vehiHP.toFixed(2));this.setRTLabelColor(this.__labelRepairAir,airHP.toFixed(2));if(infRT===allOffRT&&infHP<100)this.__labelRepairInf.setTextColor("black");else if(vehiRT===allOffRT&&vehiHP<100)this.__labelRepairVehi.setTextColor("black");else if(airRT===allOffRT&&airHP<100)this.__labelRepairAir.setTextColor("black");var ownCity=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentOwnCity();var currRTStorage=Math.max(ownCity.GetResourceCount(8),ownCity.GetResourceCount(9),ownCity.GetResourceCount(10));
this.__labelRepairStorage.setValue(phe.cnc.Util.getTimespanString(ClientLib.Data.MainData.GetInstance().get_Time().GetTimeSpan(currRTStorage)));if(currRTStorage>allOffRTInSeconds)this.__labelRepairStorage.setTextColor("darkgreen");else this.__labelRepairStorage.setTextColor("red");this.calcResources(entities)}catch(e){console.log("Error Getting Player Unit Damage");console.log(e.toString())}},calcResources:function(entities){try{buildingEnts=entities;defEnts=entities;var city=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentCity();
var lootArray={1:0,2:0,3:0,6:0};var lootArray2={1:0,2:0,3:0,6:0};var mod=-1;var isFirstHarvester=false;for(var x=0;x<9;x++)for(var y=0;y<8;y++){var width=ClientLib.Vis.VisMain.GetInstance().get_City().get_GridWidth();var height=ClientLib.Vis.VisMain.GetInstance().get_City().get_GridHeight();var cityEntity=ClientLib.Vis.VisMain.GetInstance().GetObjectFromPosition(x*width,y*height);if(cityEntity!=null&&cityEntity.get_CityEntity()!==null){if(typeof entities!="undefined")for(var idx=0;idx<buildingEnts.length;idx++){var entity=
buildingEnts[idx];var unit=ClientLib.Res.ResMain.GetInstance().GetUnit_Obj(entity.t);if(unit.dn==cityEntity.get_BuildingName()){mHealth=Simulator.getInstance().GetUnitMaxHealth(entity.l,unit);mod=(entity.sh-entity.h)/16/mHealth;if(unit.dn=="Harvester"){var mod2=cityEntity.get_BuildingDetails().get_HitpointsPercent();if(Math.round(mod2*100)!=Math.round(mod*100))mod=mod2}var isSpliced=buildingEnts.splice(idx,1);break}}var buildingDetails=cityEntity.get_BuildingDetails();if(mod==-1){mod=buildingDetails.get_HitpointsPercent();
if(cityEntity.get_BuildingName()=="Harvester"){var mod2=cityEntity.get_BuildingDetails().get_HitpointsPercent();if(Math.round(mod2*100)!=Math.round(mod*100))mod=mod2}}var reqs=buildingDetails.get_UnitLevelRepairRequirements();for(var idx2=0;idx2<reqs.length;idx2++){var type=reqs[idx2].Type;var count=reqs[idx2].Count;lootArray[type]+=Math.round(mod*count-0.5)}mod=-1}}for(var x=0;x<9;x++)for(var y=8;y<16;y++){var width=ClientLib.Vis.VisMain.GetInstance().get_DefenseSetup().get_GridWidth();var height=
ClientLib.Vis.VisMain.GetInstance().get_DefenseSetup().get_GridHeight();if(y==8){width+=1;height+=1}var defEntity=ClientLib.Vis.VisMain.GetInstance().GetObjectFromPosition(x*width,y*height);if(defEntity!==null&&defEntity.get_CityEntity()!==null&&defEntity.get_VisObjectType()!=ClientLib.Vis.VisObject.EObjectType.CityBuildingType){if(typeof entities!="undefined")for(var idx=0;idx<defEnts.length;idx++){var entity=defEnts[idx];var unit=ClientLib.Res.ResMain.GetInstance().GetUnit_Obj(entity.t);if(unit.dn==
defEntity.get_UnitName()){mHealth=Simulator.getInstance().GetUnitMaxHealth(entity.l,unit);mod=(entity.sh-entity.h)/16/mHealth;var isSpliced=defEnts.splice(idx,1);break}}var unitDetails=defEntity.get_UnitDetails();if(mod==-1)mod=unitDetails.get_HitpointsPercent();var reqs=unitDetails.get_UnitLevelRepairRequirements();for(var idx2=0;idx2<reqs.length;idx2++){var type=reqs[idx2].Type;var count=reqs[idx2].Count;lootArray[type]+=Math.round(mod*count-0.5)}mod=-1}}if(typeof entities=="undefined"){var totalLoot=
lootArray[1]+lootArray[2]+lootArray[3]+lootArray[6];this.__labelBattleLootTotal.setValue(Simulator.getInstance().formatNumbersCompact(totalLoot));this.__labelBattleLootTib.setValue(Simulator.getInstance().formatNumbersCompact(lootArray[1]));this.__labelBattleLootCry.setValue(Simulator.getInstance().formatNumbersCompact(lootArray[2]));this.__labelBattleLootCred.setValue(Simulator.getInstance().formatNumbersCompact(lootArray[3]));this.__labelBattleLootRP.setValue(Simulator.getInstance().formatNumbersCompact(lootArray[6]))}else{var totalLoot=
lootArray[1]+lootArray[2]+lootArray[3]+lootArray[6];if(typeof localStorage["getDivider"]!="undefined")var divider=localStorage["getDivider"];else var divider="|";var idxOf=this.__labelBattleLootTotal.getValue().indexOf(divider);if(idxOf!=-1){var subString=this.__labelBattleLootTotal.getValue().substring(idxOf-1);this.__labelBattleLootTotal.setValue(Simulator.getInstance().formatNumbersCompact(totalLoot)+" "+subString);var subString=this.__labelBattleLootTib.getValue().substring(this.__labelBattleLootTib.getValue().indexOf(divider)-
1);this.__labelBattleLootTib.setValue(Simulator.getInstance().formatNumbersCompact(lootArray[1])+" "+subString);var subString=this.__labelBattleLootCry.getValue().substring(this.__labelBattleLootCry.getValue().indexOf(divider)-1);this.__labelBattleLootCry.setValue(Simulator.getInstance().formatNumbersCompact(lootArray[2])+" "+subString);var subString=this.__labelBattleLootCred.getValue().substring(this.__labelBattleLootCred.getValue().indexOf(divider)-1);this.__labelBattleLootCred.setValue(Simulator.getInstance().formatNumbersCompact(lootArray[3])+
" "+subString);var subString=this.__labelBattleLootRP.getValue().substring(this.__labelBattleLootRP.getValue().indexOf(divider)-1);this.__labelBattleLootRP.setValue(Simulator.getInstance().formatNumbersCompact(lootArray[6])+" "+subString)}else{this.__labelBattleLootTotal.setValue(Simulator.getInstance().formatNumbersCompact(totalLoot)+" "+divider+" "+this.__labelBattleLootTotal.getValue());this.__labelBattleLootTib.setValue(Simulator.getInstance().formatNumbersCompact(lootArray[1])+" "+divider+" "+
this.__labelBattleLootTib.getValue());this.__labelBattleLootCry.setValue(Simulator.getInstance().formatNumbersCompact(lootArray[2])+" "+divider+" "+this.__labelBattleLootCry.getValue());this.__labelBattleLootCred.setValue(Simulator.getInstance().formatNumbersCompact(lootArray[3])+" "+divider+" "+this.__labelBattleLootCred.getValue());this.__labelBattleLootRP.setValue(Simulator.getInstance().formatNumbersCompact(lootArray[6])+" "+divider+" "+this.__labelBattleLootRP.getValue())}}}catch(e){console.log("Error Calculating Resources");
console.log(e)}},setRTLabelColor:function(label,number){if(number<25)label.setTextColor("red");else if(number<75)label.setTextColor("orangered");else label.setTextColor("darkgreen")},setEHLabelColor:function(label,number){if(number<25)label.setTextColor("darkgreen");else if(number<75)label.setTextColor("orangered");else label.setTextColor("red")},disableSimulateStatButtonTimer:function(timer){try{if(timer>=1E3){this.isSimStatButtonDisabled=true;simStatBtn.setLabel(Math.floor(timer/1E3));timer-=1E3;
setTimeout(function(){Simulator.StatWindow.getInstance().disableSimulateStatButtonTimer(timer)},1E3)}else{setTimeout(function(){simStatBtn.setEnabled(true);simStatBtn.setLabel("Update")},timer);this.isSimStatButtonDisabled=false}}catch(e){console.log("Error disabling simulator button");console.log(e.toString())}}}});qx.Class.define("Simulator.OptionWindow",{type:"singleton",extend:qx.ui.window.Window,construct:function(){this.base(arguments);this.setLayout(new qx.ui.layout.VBox(5));this.addListener("resize",
function(){this.center()},this);this.set({caption:"Simulator Options",width:300,height:300,allowMaximize:false,showMaximize:false,allowMinimize:false,showMinimize:false});var tabView=new qx.ui.tabview.TabView;tabView.set({height:295,width:295});var genPage=new qx.ui.tabview.Page("General");genLayout=new qx.ui.layout.VBox(5);genPage.setLayout(genLayout);var buttonsHeader=new qx.ui.container.Composite(new qx.ui.layout.HBox(5));buttonsHeader.setThemedFont("bold");var buttonsTitle=new qx.ui.basic.Label("Buttons:");
buttonsHeader.add(buttonsTitle);genPage.add(buttonsHeader);var buttonsBox=new qx.ui.container.Composite(new qx.ui.layout.VBox(5));this._buttonLocCB=new qx.ui.form.CheckBox("Mirror Button Location (Right on/Left off)");this._buttonSizeCB=new qx.ui.form.CheckBox("Sim Button Size");this._buttonLocCB.addListener("changeValue",this._onButtonLocChange,this);this._buttonSizeCB.addListener("changeValue",this._onButtonSizeChange,this);if(typeof localStorage["isBtnRight"]!="yes")if(localStorage["isBtnRight"]==
"yes")this._buttonLocCB.setValue(true);else this._buttonLocCB.setValue(false);if(typeof localStorage["isBtnNorm"]!="no"){if(localStorage["isBtnNorm"]=="yes")this._buttonSizeCB.setValue(true);else this._buttonSizeCB.setValue(false);this.setButtonSize()}this._disableRTBtnCB=new qx.ui.form.CheckBox("Disable Repair Lock Button");this._disableRTBtnCB.addListener("changeValue",this._onDisableRTBtnChange,this);if(typeof localStorage["isRTBtnDisabled"]!="undefined")if(localStorage["isRTBtnDisabled"]=="yes")this._disableRTBtnCB.setValue(true);
else this._disableRTBtnCB.setValue(false);this._disableCmtBtnCB=new qx.ui.form.CheckBox("Disable Combat Lock Button");this._disableCmtBtnCB.addListener("changeValue",this._onDisableCmtBtnChange,this);if(typeof localStorage["isCmtBtnDisabled"]!="undefined")if(localStorage["isCmtBtnDisabled"]=="yes")this._disableCmtBtnCB.setValue(true);else this._disableCmtBtnCB.setValue(false);buttonsBox.add(this._buttonSizeCB);buttonsBox.add(this._buttonLocCB);buttonsBox.add(this._disableRTBtnCB);buttonsBox.add(this._disableCmtBtnCB);
genPage.add(buttonsBox);var simulatorHeader=(new qx.ui.container.Composite(new qx.ui.layout.HBox(5))).set({marginTop:10});simulatorHeader.setThemedFont("bold");var simulatorTitle=new qx.ui.basic.Label("Simualtor:");simulatorHeader.add(simulatorTitle);genPage.add(simulatorHeader);var simulatorBox=new qx.ui.container.Composite(new qx.ui.layout.VBox(5));this._autoSimulateCB=new qx.ui.form.CheckBox("AutoSim");if(typeof localStorage["autoSimulate"]!="yes")if(localStorage["autoSimulate"]=="yes")this._autoSimulateCB.setValue(true);
var simulatorBox2=(new qx.ui.container.Composite(new qx.ui.layout.Grid(5))).set({marginLeft:20});var simSpeedOpt1=new qx.ui.form.RadioButton("x1");var simSpeedOpt2=new qx.ui.form.RadioButton("x2");var simSpeedOpt4=new qx.ui.form.RadioButton("x4");this._simSpeedGroup=new qx.ui.form.RadioGroup(simSpeedOpt1,simSpeedOpt2,simSpeedOpt4);this._simSpeedGroup.addListener("changeSelection",this._onSimSpeedChange,this);this._autoSimulateCB.addListener("changeValue",this._onAutoSimulateChange,this);if(typeof localStorage["simulateSpeed"]!=
"4"){var options=this._simSpeedGroup.getSelectables(false);if(localStorage["simulateSpeed"]=="2")options[1].setValue(true);else if(localStorage["simulateSpeed"]=="4")options[2].setValue(true);else options[0].setValue(true)}if(this._autoSimulateCB.getValue()==false)this._simSpeedGroup.setEnabled(false);simulatorBox2.add(simSpeedOpt1,{row:0,column:0});simulatorBox2.add(simSpeedOpt2,{row:0,column:1});simulatorBox2.add(simSpeedOpt4,{row:0,column:2});simulatorBox.add(this._autoSimulateCB);simulatorBox.add(simulatorBox2);
genPage.add(simulatorBox);var statsPage=new qx.ui.tabview.Page("Stats");statsLayout=new qx.ui.layout.VBox(5);statsPage.setLayout(statsLayout);var statWindowHeader=new qx.ui.container.Composite(new qx.ui.layout.HBox(5));statWindowHeader.setThemedFont("bold");var statWindowTitle=new qx.ui.basic.Label("Stats:");statWindowHeader.add(statWindowTitle);statsPage.add(statWindowHeader);var statWindowBox=new qx.ui.container.Composite(new qx.ui.layout.VBox(5));this._autoOpenCB=new qx.ui.form.CheckBox("Auto open on window open");
this._autoOpenCB.addListener("changeValue",this._onAutoOpenStatsChange,this);if(typeof localStorage["autoOpenStat"]!="undefined")if(localStorage["autoOpenStat"]=="no")this._autoOpenCB.setValue(false);else this._autoOpenCB.setValue(true);statWindowBox.add(this._autoOpenCB);statsPage.add(statWindowBox);var repairSecHeader=(new qx.ui.container.Composite(new qx.ui.layout.HBox(5))).set({marginTop:10});repairSecHeader.setThemedFont("bold");var repairSecTitle=new qx.ui.basic.Label("Repair Time:");repairSecHeader.add(repairSecTitle);
statsPage.add(repairSecHeader);var repairSecBox=new qx.ui.container.Composite(new qx.ui.layout.HBox(5));var repairDisplayOpt1=new qx.ui.form.RadioButton("C/RT");var repairDisplayOpt2=new qx.ui.form.RadioButton("HP/RT");var repairDisplayOpt3=new qx.ui.form.RadioButton("Time");this._repairSecGroup=new qx.ui.form.RadioGroup(repairDisplayOpt1,repairDisplayOpt2,repairDisplayOpt3);this._repairSecGroup.addListener("changeSelection",this._onRepairSelectionChange,this);if(typeof localStorage["getRTSelection"]!=
"undefined"){var options=this._repairSecGroup.getSelectables(false);if(localStorage["getRTSelection"]=="hprt")options[1].setValue(true);else if(localStorage["getRTSelection"]=="rt")options[2].setValue(true);else options[0].setValue(true)}repairSecBox.add(repairDisplayOpt1);repairSecBox.add(repairDisplayOpt2);repairSecBox.add(repairDisplayOpt3);statsPage.add(repairSecBox);var dividerHeader=(new qx.ui.container.Composite(new qx.ui.layout.HBox(5))).set({marginTop:10});dividerHeader.setThemedFont("bold");
var dividerTitle=new qx.ui.basic.Label("Mapping:");dividerHeader.add(dividerTitle);statsPage.add(dividerHeader);var dividerBox=new qx.ui.container.Composite(new qx.ui.layout.HBox(10));var dividerOpt1=new qx.ui.form.RadioButton("|");var dividerOpt2=new qx.ui.form.RadioButton("/");this._dividerGroup=new qx.ui.form.RadioGroup(dividerOpt1,dividerOpt2);this._dividerGroup.addListener("changeSelection",this._onDividerChange,this);if(typeof localStorage["getDivider"]!="undefined"){var options=this._dividerGroup.getSelectables(false);
if(localStorage["getDivider"]=="/")options[1].setValue(true);else options[0].setValue(true)}dividerBox.add(dividerOpt1);dividerBox.add(dividerOpt2);statsPage.add(dividerBox);var hideSecHeader=(new qx.ui.container.Composite(new qx.ui.layout.HBox(5))).set({marginTop:10});hideSecHeader.setThemedFont("bold");var hideSecTitle=new qx.ui.basic.Label("Hide:");hideSecHeader.add(hideSecTitle);statsPage.add(hideSecHeader);var hideSecBox=new qx.ui.container.Composite(new qx.ui.layout.HBox(10));this._hideHealthCB=
new qx.ui.form.CheckBox("Damage");this._hideRepairCB=new qx.ui.form.CheckBox("Repair");this._hideMiscCB=new qx.ui.form.CheckBox("Condition");this._hideLootCB=new qx.ui.form.CheckBox("Resources");this._hideHealthCB.addListener("changeValue",this._onHideEHChange,this);this._hideRepairCB.addListener("changeValue",this._onHideRTChange,this);this._hideMiscCB.addListener("changeValue",this._onHideMiscChange,this);this._hideLootCB.addListener("changeValue",this._onHideLootChange,this);if(typeof localStorage["hideHealth"]!=
"undefined")if(localStorage["hideHealth"]=="yes")this._hideHealthCB.setValue(true);else this._hideHealthCB.setValue(false);if(typeof localStorage["hideRepair"]!="undefined")if(localStorage["hideRepair"]=="yes")this._hideRepairCB.setValue(true);else this._hideRepairCB.setValue(false);if(typeof localStorage["hideMisc"]!="undefined")if(localStorage["hideMisc"]=="yes")this._hideMiscCB.setValue(true);else this._hideMiscCB.setValue(false);if(typeof localStorage["hideLoot"]!="undefined")if(localStorage["hideLoot"]==
"yes")this._hideLootCB.setValue(true);else this._hideLootCB.setValue(false);hideSecBox.add(this._hideHealthCB);hideSecBox.add(this._hideRepairCB);hideSecBox.add(this._hideMiscCB);hideSecBox.add(this._hideLootCB);statsPage.add(hideSecBox);var statPosHeader=(new qx.ui.container.Composite(new qx.ui.layout.HBox(5))).set({marginTop:10});var statPosTitle=(new qx.ui.basic.Label("Update Changes:")).set({alignY:"middle"});statPosTitle.setFont("bold");var statPosBtn=(new qx.ui.form.Button("Ok")).set({allowGrowX:false,
allowGrowY:false,height:20});statPosBtn.addListener("click",this._onSetStatWindowPositionChange,this);statPosHeader.add(statPosTitle);statPosHeader.add(statPosBtn);statsPage.add(statPosHeader);tabView.add(genPage);tabView.add(statsPage);this.add(tabView)},destruct:function(){},members:{_buttonSizeCB:null,_buttonLocCB:null,_disableRTBtnCB:null,_disableCmtBtnCB:null,_autoOpenCB:null,_autoSimulateCB:null,_simSpeedGroup:null,_repairSecGroup:null,_dividerGroup:null,_hideHealthCB:null,_hideRepairCB:null,
_hideMiscCB:null,_hideLootCB:null,_onButtonSizeChange:function(){try{value=this._buttonSizeCB.getValue();if(value==true)localStorage["isBtnNorm"]="yes";else localStorage["isBtnNorm"]="no";this.setButtonSize()}catch(e){console.log("Error Button Size Change: "+e.toString())}},_onButtonLocChange:function(){try{value=this._buttonLocCB.getValue();if(value==true)localStorage["isBtnRight"]="yes";else localStorage["isBtnRight"]="no";this.setButtonLoc()}catch(e){console.log("Error Button Location Change: "+
e.toString())}},_onDisableRTBtnChange:function(){try{value=this._disableRTBtnCB.getValue();if(value==true)localStorage["isRTBtnDisabled"]="yes";else localStorage["isRTBtnDisabled"]="no";this.setRTBtn(value)}catch(e){console.log("Error Disable RT Button Change: "+e.toString())}},_onDisableCmtBtnChange:function(){try{value=this._disableCmtBtnCB.getValue();if(value==true)localStorage["isCmtBtnDisabled"]="yes";else localStorage["isCmtBtnDisabled"]="no";this.setCmtBtn(value)}catch(e){console.log("Error Disable Cmt Button Change: "+
e.toString())}},_onRepairSelectionChange:function(selection){try{var option=selection.getData()[0];var label=option.getLabel();if(label=="C/RT")localStorage["getRTSelection"]="crt";else if(label=="HP/RT")localStorage["getRTSelection"]="hprt";else localStorage["getRTSelection"]="rt"}catch(e){console.log("Error Repair Section Selection Change: "+e.toString())}},_onAutoOpenStatsChange:function(){try{var value=this._autoOpenCB.getValue();if(value==false)localStorage["autoOpenStat"]="no";else localStorage["autoOpenStat"]=
"yes"}catch(e){console.log("Error Auto Open Stats Change: "+e.toString())}},_onAutoSimulateChange:function(){try{var value=this._autoSimulateCB.getValue();if(value==false){this._simSpeedGroup.setEnabled(false);localStorage["autoSimulate"]="no"}else{this._simSpeedGroup.setEnabled(true);localStorage["autoSimulate"]="yes"}}catch(e){console.log("Error Auto Simulate Change: "+e.toString())}},_onSimSpeedChange:function(selection){try{var option=selection.getData()[0];var label=option.getLabel();if(label==
"x1")localStorage["simulateSpeed"]="1";else if(label=="x2")localStorage["simulateSpeed"]="2";else localStorage["simulateSpeed"]="4"}catch(e){console.log("Error Sim Speed Change: "+e.toString())}},_onDividerChange:function(selection){try{var option=selection.getData()[0];var label=option.getLabel();if(label=="/")localStorage["getDivider"]="/";else localStorage["getDivider"]="|";Simulator.StatWindow.getInstance().calcResources()}catch(e){console.log("Error Divider Change: "+e.toString())}},_onHideEHChange:function(){try{value=
this._hideHealthCB.getValue();if(value==true)localStorage["hideHealth"]="yes";else localStorage["hideHealth"]="no"}catch(e){console.log("Error Hide Enemy Base Health Change: "+e.toString())}},_onHideRTChange:function(){try{value=this._hideRepairCB.getValue();if(value==true)localStorage["hideRepair"]="yes";else localStorage["hideRepair"]="no"}catch(e){console.log("Error Hide Repair Times Change: "+e.toString())}},_onHideMiscChange:function(){try{value=this._hideMiscCB.getValue();if(value==true)localStorage["hideMisc"]=
"yes";else localStorage["hideMisc"]="no"}catch(e){console.log("Error Hide Misc Change: "+e.toString())}},_onHideLootChange:function(){try{value=this._hideLootCB.getValue();if(value==true)localStorage["hideLoot"]="yes";else localStorage["hideLoot"]="no"}catch(e){console.log("Error Hide Loot Change: "+e.toString())}},_onSetStatWindowPositionChange:function(){try{var props=Simulator.StatWindow.getInstance().getLayoutProperties();localStorage["statWindowPosLeft"]=props["left"];localStorage["statWindowPosTop"]=
props["top"]}catch(e){console.log("Error Stat Window Position Change: "+e.toString())}},setRTBtn:function(value){if(value==true)unlockRTBtn.hide();else unlockRTBtn.show()},setCmtBtn:function(value){if(value==true)unlockCmtBtn.hide();else unlockCmtBtn.show()},setButtonLoc:function(){try{value=this._buttonLocCB.getValue();size=this._buttonSizeCB.getValue();if(value==true){var pLeft=null;if(size==true)var pRight=58;else var pRight=70;armyBar.add(simBtn,{left:pLeft,right:66,bottom:120});armyBar.add(shiftUpBtn,
{left:pLeft,right:80,bottom:101});armyBar.add(shiftDownBtn,{left:pLeft,right:80,bottom:67});armyBar.add(shiftLeftBtn,{left:pLeft,right:96,bottom:84});armyBar.add(shiftRightBtn,{left:pLeft,right:65,bottom:84});armyBar.add(disableAllUnitsBtn,{left:pLeft,right:96,bottom:1});armyBar.add(mirrorBtn,{left:pLeft,right:96,bottom:46});armyBar.add(flipBtn,{left:pLeft,right:65,bottom:46});armyBar.add(armyUndoBtn,{left:pLeft,right:69,bottom:1});armyBar.add(armySaveBtn,{left:pLeft,right:80,bottom:20});playArea.add(statBtn,
{left:pLeft,right:25,bottom:240});playArea.add(optionBtn,{left:pLeft,right:25,bottom:280});playArea.add(layoutBtn,{left:pLeft,right:25,bottom:200})}else{var pRight=null;if(size==true)var pLeft=13;else var pLeft=83;armyBar.add(simBtn,{right:pRight,left:66,bottom:120});armyBar.add(shiftUpBtn,{right:pRight,left:80,bottom:101});armyBar.add(shiftDownBtn,{right:pRight,left:80,bottom:67});armyBar.add(shiftLeftBtn,{right:pRight,left:96,bottom:84});armyBar.add(shiftRightBtn,{right:pRight,left:65,bottom:84});
armyBar.add(disableAllUnitsBtn,{right:pRight,left:96,bottom:1});armyBar.add(mirrorBtn,{right:pRight,left:96,bottom:46});armyBar.add(flipBtn,{right:pRight,left:65,bottom:46});armyBar.add(armyUndoBtn,{right:pRight,left:69,bottom:1});armyBar.add(armySaveBtn,{right:pRight,left:80,bottom:20});playArea.add(statBtn,{right:pRight,left:25,bottom:240});playArea.add(optionBtn,{right:pRight,left:25,bottom:280});playArea.add(layoutBtn,{right:pRight,left:25,bottom:200})}}catch(e){console.log("Error Setting Button Location: "+
e.toString())}},setButtonSize:function(){try{value=this._buttonSizeCB.getValue();if(value==true){simBtn.setLabel("Simulate");simBtn.setWidth(60);statBtn.setLabel("Stats");statBtn.setWidth(60);optionBtn.setLabel("Options");optionBtn.setWidth(60);layoutBtn.setLabel("Layout");layoutBtn.setWidth(60)}else{simBtn.setLabel("S");simBtn.setWidth(45);statBtn.setLabel("Stats");statBtn.setWidth(60);statBtn.setHieght(30);optionBtn.setLabel("Options");optionBtn.setWidth(60);optionBtn.setHieght(30);layoutBtn.setLabel("L");
layoutBtn.setWidth(60);layoutBtn.setHieght(30)}this.setButtonLoc()}catch(e){console.log("Error Setting Button Size: "+e.toString())}}}});qx.Class.define("Simulator.LayoutWindow",{type:"singleton",extend:webfrontend.gui.CustomWindow,construct:function(){this.base(arguments);this.setLayout(new qx.ui.layout.VBox);this.set({width:200,caption:"Save / Delete / Load",padding:2,allowMaximize:false,showMaximize:false,allowMinimize:false,showMinimize:false});var layoutListHeader=(new qx.ui.container.Composite(new qx.ui.layout.VBox(5))).set({decorator:"pane-light-opaque"});
var layoutListTitle=(new qx.ui.basic.Label("Saved Formations")).set({alignX:"center",alignY:"top",font:"font_size_14_bold"});layoutListHeader.add(layoutListTitle);this.add(layoutListHeader);this.layoutList=new qx.ui.form.List;this.layoutList.set({selectionMode:"one",height:100,width:150,margin:5});this.add(this.layoutList);var listButtonBox=new qx.ui.container.Composite;var listButtonLayout=new qx.ui.layout.HBox(5,"center");listButtonBox.setLayout(listButtonLayout);var loadButton=new qx.ui.form.Button("Load");
var deleteButton=new qx.ui.form.Button("Delete");loadButton.set({height:15,width:70,alignX:"center"});loadButton.addListener("click",this.loadLayout,this);deleteButton.set({height:15,width:70,alignX:"center"});deleteButton.addListener("click",this.deleteLayout,this);listButtonBox.add(loadButton);listButtonBox.add(deleteButton);this.add(listButtonBox);var saveLayoutBox=(new qx.ui.container.Composite((new qx.ui.layout.HBox).set({spacing:10}))).set({marginTop:20,marginLeft:5});this.layoutTextBox=(new qx.ui.form.TextField("")).set({width:75,
maxLength:15});var saveButton=new qx.ui.form.Button("Save");saveButton.set({height:10,width:70,alignX:"center"});saveButton.addListener("click",this.saveNewLayout,this);saveLayoutBox.add(this.layoutTextBox);saveLayoutBox.add(saveButton);this.add(saveLayoutBox);var checkBox=(new qx.ui.container.Composite((new qx.ui.layout.HBox).set({spacing:10}))).set({marginTop:10,marginLeft:5});this.persistentCheck=new qx.ui.form.CheckBox("Fixed Formation");this.persistentCheck.setTextColor("white");this.persistentCheck.setFont("bold");
this.persistentCheck.setToolTipText("If selected, the simulation layout will be saved and can be used in another battle");checkBox.add(this.persistentCheck);this.add(checkBox);var noticeBox=(new qx.ui.container.Composite(new qx.ui.layout.HBox)).set({marginTop:5,marginLeft:5});var noticeText=(new qx.ui.basic.Label("")).set({alignX:"center",alignY:"top"});noticeText.setValue("<p align='justify'><b>If simulation does not change when loading, try moving a unit and try again.</b></p>");noticeText.set({rich:true,
wrap:true,width:165,textColor:"white"});noticeBox.add(noticeText);this.add(noticeBox);var clearAllLayoutsBox=(new qx.ui.container.Composite(new qx.ui.layout.VBox)).set({alignX:"center",marginTop:5,marginLeft:5,allowGrowX:false});var clearAllLayoutsBtn=(new qx.ui.form.Button("Delete All")).set({alignX:"center",width:95});clearAllLayoutsBtn.addListener("click",this.clearAllLayouts,this);clearAllLayoutsBox.add(clearAllLayoutsBtn);this.add(clearAllLayoutsBox);this.layoutsArray=new Array},destruct:function(){},
members:{layoutList:null,layoutTextBox:null,layoutsArray:null,persistentCheck:null,saveNewLayout:function(isQS){try{console.log("Save Formation");if(typeof isQS!="undefined"&&isQS==true||this.layoutTextBox.getValue()==""){var date=new Date;var day=date.getDate();var month=date.getMonth()+1;var hour=date.getHours()<10?"0"+date.getHours():date.getHours();var minute=date.getMinutes()<10?"0"+date.getMinutes():date.getMinutes();var second=date.getSeconds()<10?"0"+date.getSeconds():date.getSeconds();var label=
month+"/"+day+"@"+hour+":"+minute+":"+second}else var label=this.layoutTextBox.getValue();var cityID=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentCityId();var ownCityID=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentOwnCityId();var model=ownCityID+"."+cityID+"."+label;var children=this.layoutList.getChildren();for(var item=0;item<children.length;item++){thisItem=children[item].getModel();if(thisItem==model){alert("Save Failed: Duplicate Name");return}}var units=Simulator.getInstance().getCityPreArmyUnits().get_ArmyUnits().l;
units=this.prepareLayout(units);var layoutInformation={};if(this.persistentCheck.getValue()==true)layoutInformation={id:model,label:label,formation:units,pers:"yes"};else layoutInformation={id:model,label:label,formation:units,pers:"no"};this.layoutsArray.push(layoutInformation);this.layoutList.add(new qx.ui.form.ListItem(layoutInformation.label,null,layoutInformation.id));this.layoutTextBox.setValue("");armySaveBtn.setLabel("\u2714");(function(armySaveBtn){setTimeout(function(){armySaveBtn.setLabel("Save")},
2E3)})(armySaveBtn);this.updateStorage()}catch(e){console.log("Error Saving Layout");console.log(e)}},loadLayout:function(){try{console.log("Loading Simulation");var ownCityID=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentOwnCityId();var layout=this.layoutList.getSelection()[0].getModel();for(var item in this.layoutsArray){var thisLayout=this.layoutsArray[item].id;if(thisLayout==layout){Simulator.getInstance().restoreFormation(this.layoutsArray[item].formation);break}}}catch(e){console.log("Error Loading Layout");
console.log(e)}},deleteLayout:function(){try{console.log("Delete Formation");var rUSure=confirm("DO YOU REALLY WANT TO DELETE?");if(!rUSure)return;for(var item in this.layoutsArray)if(this.layoutsArray[item].id==this.layoutList.getSelection()[0].getModel()){var isRemoved=this.layoutsArray.splice(item,1);this.updateStorage()}this.updateLayoutList()}catch(e){console.log("Error deleting formation");console.log(e)}},updateStorage:function(){try{console.log("Updating Storage");localStorage["savedFormations"]=
JSON.stringify(this.layoutsArray)}catch(e){console.log("Error updating localStorage");console.log(e)}},updateLayoutList:function(){try{console.log("Updating Layout List");var savedLayouts=localStorage["savedFormations"];if(typeof savedLayouts!="undefined")this.layoutsArray=JSON.parse(savedLayouts);this.layoutList.removeAll();var cityID=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentCityId();var ownCityID=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentOwnCityId();var model=
ownCityID+"."+cityID;for(var item in this.layoutsArray){var itemLabel=this.layoutsArray[item].label;var itemModel=model+"."+itemLabel;var pers=this.layoutsArray[item].pers;var match=this.layoutsArray[item].id.match(ownCityID.toString());if(itemModel==this.layoutsArray[item].id||typeof pers!="undefined"&&pers=="yes"&&match!=null)this.layoutList.add(new qx.ui.form.ListItem(itemLabel,null,this.layoutsArray[item].id))}}catch(e){console.log("Error Updating Layout List");console.log(e)}},prepareLayout:function(units){try{console.log("Preparing Layout for Saving");
saved_units=[];for(var i=0;i<units.length;i++){var unit=units[i];var armyUnit={};armyUnit.x=unit.get_CoordX();armyUnit.y=unit.get_CoordY();armyUnit.id=unit.get_Id();armyUnit.enabled=unit.get_Enabled();saved_units.push(armyUnit)}return saved_units}catch(e){console.log("Error Preparing Unit Layout");console.log(e)}},clearAllLayouts:function(){try{console.log("Delete all formations");var rUSure=confirm("Clicking OK will erase all of your saved layouts for each base!");if(rUSure){localStorage.removeItem("savedFormations");
this.layoutsArray=new Array;alert("All your saved formations were saved.");this.updateLayoutList()}else alert("No simulations to be deleted.")}catch(e){console.log("Error Clearing All Layouts");console.log(e)}}}})}function onViewChanged(oldMode,newMode){setTimeout(function(){try{console.log("View Changed");Simulator.OptionWindow.getInstance().close();Simulator.LayoutWindow.getInstance().close();if(newMode!=ClientLib.Vis.Mode.CombatSetup&&newMode!=ClientLib.Vis.Mode.Battleground){Simulator.StatWindow.getInstance().close();
Simulator.getInstance().armyTempFormations=new Array;Simulator.getInstance().armyTempIdx=0;armyUndoBtn.setEnabled(false);Simulator.getInstance().isSimulation=false}else if(newMode==ClientLib.Vis.Mode.CombatSetup){var autoStatOpen=localStorage["autoOpenStat"];if(typeof autoStatOpen!="undefined"){if(autoStatOpen=="yes")Simulator.StatWindow.getInstance().open()}else Simulator.StatWindow.getInstance().open();if(Simulator.getInstance().isSimulation==false)setTimeout(function(){Simulator.StatWindow.getInstance().calcResources()},
2E3);else Simulator.getInstance().isSimulation=false;if(oldMode!=ClientLib.Vis.Mode.Battleground)Simulator.getInstance().saveTempFormation()}if(ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentCity()!=null){var city=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentCity().get_Name();var ownCity=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentOwnCity().get_Name();if(newMode==ClientLib.Vis.Mode.Battleground||city==ownCity){optionBtn.hide();statBtn.hide();layoutBtn.hide()}else if(city!=
ownCity){optionBtn.show();statBtn.show();layoutBtn.show()}}}catch(e){console.log("Error closing windows or hiding buttons on view change");console.log(e.toString())}},500)}function waitForGame(){try{if(typeof qx!="undefined"&&typeof qx.core!="undfined"&&typeof qx.core.Init!="undefined"){var app=qx.core.Init.getApplication();if(app.initDone==true)try{createClasses();console.log("Creating phe.cnc function wraps");if(typeof phe.cnc.Util.attachNetEvent=="undefined")Simulator.getInstance().attachNetEvent=
webfrontend.gui.Util.attachNetEvent;else Simulator.getInstance().attachNetEvent=phe.cnc.Util.attachNetEvent;if(typeof phe.cnc.gui.util=="undefined")Simulator.getInstance().formatNumbersCompact=webfrontend.gui.Util.formatNumbersCompact;else Simulator.getInstance().formatNumbersCompact=phe.cnc.gui.util.Numbers.formatNumbersCompact;if(typeof ClientLib.API.Util.GetUnitMaxHealth=="undefined")for(var key in ClientLib.Base.Util){var strFunction=ClientLib.Base.Util[key].toString();if(strFunction.indexOf("*=1.1")>
-1||strFunction.indexOf("*= 1.1")>-1){Simulator.getInstance().GetUnitMaxHealth=ClientLib.Base.Util[key];break}}else Simulator.getInstance().GetUnitMaxHealth=ClientLib.API.Util.GetUnitMaxHealth;if(PerforceChangelist>=392583){var u=""+ClientLib.Data.Cities.prototype.get_CurrentCity;for(var a in ClientLib.Data.Cities.prototype)if(ClientLib.Data.Cities.prototype.hasOwnProperty(a)&&"function"==typeof ClientLib.Data.Cities.prototype[a]){var l=""+ClientLib.Data.Cities.prototype[a];if(l.indexOf(u)>-1&&6==
a.length){u=a;break}}var c=""+ClientLib.Data.Cities.prototype.get_CurrentOwnCity;for(var h in ClientLib.Data.Cities.prototype)if(ClientLib.Data.Cities.prototype.hasOwnProperty(h)&&"function"==typeof ClientLib.Data.Cities.prototype[h]){var p=""+ClientLib.Data.Cities.prototype[h];if(p.indexOf(c)>-1&&6==h.length){c=h;break}}var s=""+ClientLib.API.Util.GetUnitRepairCosts;s=s.replace(u,c);var d=s.substring(s.indexOf("{")+1,s.lastIndexOf("}")),v=Function("a,b,c",d);ClientLib.API.Util.GetUnitRepairCosts=
v}Simulator.getInstance();Simulator.StatWindow.getInstance();Simulator.OptionWindow.getInstance();Simulator.LayoutWindow.getInstance();Simulator.getInstance().attachNetEvent(ClientLib.Vis.VisMain.GetInstance(),"ViewModeChange",ClientLib.Vis.ViewModeChange,this,onViewChanged)}catch(e){console.log("Simulator initialization error:");console.log(e)}else window.setTimeout(waitForGame,1E3)}else window.setTimeout(waitForGame,1E3)}catch(e){if(typeof console!="undefined")console.log(e);else if(window.opera)opera.postError(e);
else GM_log(e)}}window.setTimeout(waitForGame,1E3)};var script=document.createElement("script");var txt=injectFunction.toString();script.innerHTML="("+txt+")();";script.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(script)})();

Because it's your web

Powered by monkeys and unicorns with the help of many friends

Policy & Guidelines: DMCA Privacy Policy
