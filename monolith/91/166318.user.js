// ==UserScript==
// @name			QLRanks.com Compare Players
// @version			0.2
// @author			ejjpi
// @namespace		ejjpi
// @description		Compare Quake Live players stats on qlranks.com
// @require			https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js
// @require			http://code.highcharts.com/highcharts.js
// @include        http://qlranks.com/*
// @include        http://*.qlranks.com/*
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_addStyle
// @run-at         document-end
// ==/UserScript==

var isChrome=/chrome/i.test(navigator.userAgent); if(isChrome||"undefined"==typeof GM_getValue){var scripts=["//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js","//code.highcharts.com/highcharts.js"],numScripts=scripts.length,loadedScripts=0,i,protocol=document.location.protocol;for(i=0;i<numScripts;i++){var script=document.createElement("script");script.setAttribute("src",protocol+scripts[i]);script.addEventListener("load",function(){loadedScripts+=1;if(!(loadedScripts<numScripts)){var d=document.createElement("script");d.textContent="("+ main.toString()+")();";document.body.appendChild(d)}},!1);document.body.appendChild(script)}}else main(); function main(){/chrome/i.test(navigator.userAgent)&&(GM_getValue=function(d,g){var h=localStorage.getItem(d);if(!h)return g;var j=h[0],h=h.substring(1);switch(j){case "b":return"true"==h;case "n":return Number(h);default:return h}},GM_setValue=function(d,g){g=(typeof g)[0]+g;localStorage.setItem(d,g)},GM_addStyle=function(d){document.documentElement.appendChild(document.createElement("style")).appendChild(document.createTextNode(d))});GM_addStyle("#mainStats td{height:25px;}.button-link{cursor:pointer;letter-spacing:0;margin:10px;padding:10px 15px;background:#4479ba;color:#FFF;-webkit-border-radius:4px;-moz-border-radius:4px;border-radius:4px;border:solid 1px #20538d;text-shadow:0 -1px 0 rgba(0,0,0,0.4);-webkit-box-shadow:inset 0 1px 0 rgba(255,255,255,0.4),0 1px 1px rgba(0,0,0,0.2);-moz-box-shadow:inset 0 1px 0 rgba(255,255,255,0.4),0 1px 1px rgba(0,0,0,0.2);box-shadow:inset 0 1px 0 rgba(255,255,255,0.4),0 1px 1px rgba(0,0,0,0.2);-webkit-transition-duration:.2s;-moz-transition-duration:.2s;transition-duration:.2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.button-link:hover{background:#356094;border:solid 1px #2a4e77;text-decoration:none}.button-link:active{-webkit-box-shadow:inset 0 1px 4px rgba(0,0,0,0.6);-moz-box-shadow:inset 0 1px 4px rgba(0,0,0,0.6);box-shadow:inset 0 1px 4px rgba(0,0,0,0.6);background:#2e5481;border:solid 1px #203e5f}"); jQuery.noConflict();jQuery(document).ready(function(d){var g=d("#player"),h=function(a){var c={};a=d(a);c.elo=a.find("span[id$=lblPlayerCurrentElo]").text();c.winPercent=a.find("span[id$=lblWinLossRatio]").text().substring(0,a.find("span[id$=lblWinLossRatio]").text().length-1);c.rank=a.find("span[id$=lblPlayerWorldrank]").text();c.totalMatches=a.find("span[id$=lblDuelsTracked]").text();c.elo=a.find("span[id$=lblPlayerCurrentElo]").text();c.avgFrags=Math.round(a.find("span[id$=lblFrags]").text()/c.totalMatches); c.avgDeaths=Math.round(a.find("span[id$=lblDeaths]").text()/c.totalMatches);c.avgNet=Math.round((a.find("span[id$=lbldmgGiven]").text()-a.find("span[id$=lbldmgTaken]").text())/c.totalMatches);c.arena=a.find("span[id$=lblFaveArena]").text();var b=a.find("#weapon_stats tr.accuracy");c.accuracy={mg:parseFloat(b.find("td:eq(2)").text().substring(0,b.find("td:eq(2)").text().length-1)),sg:parseFloat(b.find("td:eq(3)").text().substring(0,b.find("td:eq(3)").text().length-1)),gl:parseFloat(b.find("td:eq(4)").text().substring(0, b.find("td:eq(4)").text().length-1)),rl:parseFloat(b.find("td:eq(5)").text().substring(0,b.find("td:eq(5)").text().length-1)),lg:parseFloat(b.find("td:eq(6)").text().substring(0,b.find("td:eq(6)").text().length-1)),rg:parseFloat(b.find("td:eq(7)").text().substring(0,b.find("td:eq(7)").text().length-1)),pg:parseFloat(b.find("td:eq(8)").text().substring(0,b.find("td:eq(8)").text().length-1))};a=a.find("#weapon_stats tr.use");c.weaponUsage={mg:parseFloat(a.find("td:eq(2)").text().substring(0,a.find("td:eq(2)").text().length- 1)),sg:parseFloat(a.find("td:eq(3)").text().substring(0,a.find("td:eq(3)").text().length-1)),gl:parseFloat(a.find("td:eq(4)").text().substring(0,a.find("td:eq(4)").text().length-1)),rl:parseFloat(a.find("td:eq(5)").text().substring(0,a.find("td:eq(5)").text().length-1)),lg:parseFloat(a.find("td:eq(6)").text().substring(0,a.find("td:eq(6)").text().length-1)),rg:parseFloat(a.find("td:eq(7)").text().substring(0,a.find("td:eq(7)").text().length-1)),pg:parseFloat(a.find("td:eq(8)").text().substring(0, a.find("td:eq(8)").text().length-1))};return c};if(g.length){var j=d("#comparebar");0===j.length&&(d("#content > .inner").prepend(d('<div id="comparebar" class="left"><div class="box"><h2>Current compare list</h2><div><table></table></div></div></div>')),d("#searchbar").append('<div class="clear"></div>'));var j=d("#comparebar"),m=j.find("table"),k=GM_getValue("players");if(void 0!==k&&""!==k){k=JSON.parse(k);m.append('<tbody><tr><th scope="col">Player</th><th scope="col">Country</th></tr></tbody>'); for(var l=0;l<k.length;l++)m.find("tbody").append("<tr><td>"+k[l].name+"</td><td>"+k[l].country+"</td></tr>");j.find(".box").append(d('<button class="button-link">Clear list</button>').click(function(a){a.preventDefault();j.find("table tr:not(:first-child)").remove();j.find("button").hide();GM_setValue("players","")}));j.find(".box").append(d('<button class="button-link">Compare!</button>').click(function(a){a.preventDefault();var c=d("<div></div>"),b=JSON.parse(GM_getValue("players"));if(2>b.length)alert("Select 2 players first!"); else{d("#content .inner").hide();c.append('<div class="inner inner2"><div class="left-third"><div class="box"><h2 style="text-align:center;">'+b[0].country+" "+b[0].name+'</h2><div style="text-align:center; margin:10px;">'+b[0].avatar+'</div></div></div><div class="mid-third" style="text-align:center;font-size:40px; margin-top:70px;"><h1>VS.</h1><button class="button-link button-back" style="margin-top:50px;">Back to player view</button></div><div class="right-third"><div class="box"><h2 style="text-align:center;">'+ b[1].country+" "+b[1].name+'</h2><div style="text-align:center; margin:10px;">'+b[1].avatar+'</div></div></div><div class="clear"></div><h1 id="loading">Prepare to fight....</h1></div>');c.find("h2 > a").remove();d("#content").append(c);c.find(".button-back").click(function(a){a.preventDefault();d("#content .inner2").remove();d("#content .inner").show()});var e,f;d.when(d.get("/duel/player/"+b[0].name,function(a){e=h(a)}),d.get("/duel/player/"+b[1].name,function(a){f=h(a)})).done(function(){c.find("#loading").remove(); c.find(".inner").append('<div class="left"><div class="box"><h2>Weapons Accuracy</h2><div><div id="accuracyGraph" style="width:100%;height:300px"></div></div></div></div>');d("#accuracyGraph").highcharts({chart:{type:"column"},title:{text:"Stats"},xAxis:{categories:"MG SG GL RL LG RG PG".split(" ")},yAxis:{min:0,title:{text:"%"}},credits:{enabled:!1},series:[{name:b[0].name,data:[e.accuracy.mg,e.accuracy.sg,e.accuracy.gl,e.accuracy.rl,e.accuracy.lg,e.accuracy.rg,e.accuracy.pg]},{name:b[1].name,data:[f.accuracy.mg, f.accuracy.sg,f.accuracy.gl,f.accuracy.rl,f.accuracy.lg,f.accuracy.rg,f.accuracy.pg]}]});c.find(".inner").append('<div class="right"><div class="box"><h2>Weapons Usage</h2><div><div id="usageGraph" style="width:100%;height:300px"></div></div></div></div>');d("#usageGraph").highcharts({chart:{type:"column"},title:{text:"Stats"},xAxis:{categories:"MG SG GL RL LG RG PG".split(" ")},yAxis:{min:0,title:{text:"%"}},credits:{enabled:!1},series:[{name:b[0].name,data:[e.weaponUsage.mg,e.weaponUsage.sg,e.weaponUsage.gl, e.weaponUsage.rl,e.weaponUsage.lg,e.weaponUsage.rg,e.weaponUsage.pg]},{name:b[1].name,data:[f.weaponUsage.mg,f.weaponUsage.sg,f.weaponUsage.gl,f.weaponUsage.rl,f.weaponUsage.lg,f.weaponUsage.rg,f.weaponUsage.pg]}]});c.find(".inner").append('<div class="clear"></div>');c.find(".inner").append('<div class="left"><div class="box"><h2>General Stats</h2><div id="mainStats"></div></div></div>');var a='<table><tbody><tr style="color:#A54E4E;font-size:16px;font-weight:bold;"><td></td><td>'+b[0].name+"</td><td>"+ b[1].name+"</td></tr>",a=a+("<tr><td><b>World Rank</b></td><td>"+e.rank+"</td><td>"+f.rank+"</td></tr>"),a=a+("<tr><td><b>Elo</b></td><td>"+e.elo+"</td><td>"+f.elo+"</td></tr>"),a=a+("<tr><td><b>Win percent</b></td><td>"+e.winPercent+"</td><td>"+f.winPercent+"</td></tr>"),a=a+("<tr><td><b>Total matches</b></td><td>"+e.totalMatches+"</td><td>"+f.totalMatches+"</td></tr>"),a=a+("<tr><td><b>Average frags</b></td><td>"+e.avgFrags+"</td><td>"+f.avgFrags+"</td></tr>"),a=a+("<tr><td><b>Average deaths</b></td><td>"+ e.avgDeaths+"</td><td>"+f.avgDeaths+"</td></tr>"),a=a+("<tr><td><b>Average Net damage</b></td><td>"+e.avgNet+"</td><td>"+f.avgNet+"</td></tr>"),a=d(a+"</tbody></table>").find("tr").each(function(){var a=d(this);if(!isNaN(a.find("td:eq(1)").text())){var b=parseInt(a.find("td:eq(1)").text()),c=parseInt(a.find("td:eq(2)").text());if("World Rank"===a.find("td:eq(0)").text()||"Average deaths"===a.find("td:eq(0)").text())c=b+(b=c)-c;b>c?(a.find("td:eq(1)").css("background-color","#DFF0D8").css("border", "1px solid #D6E9C6").css("font-weight","bold"),a.find("td:eq(2)").css("background-color","#F2DEDE").css("border","1px solid #EED3D7")):b<c&&(a.find("td:eq(2)").css("background-color","#DFF0D8").css("border","1px solid #D6E9C6").css("font-weight","bold"),a.find("td:eq(1)").css("background-color","#F2DEDE").css("border","1px solid #EED3D7"))}}).end();d("#mainStats").append(a);c.find(".inner").append('<div class="right"><div class="box"><h2>Favourite Arena</h2><div id="favouriteArena"></div></div></div>'); a='<table><tbody><tr style="color:#A54E4E;font-size:16px;font-weight:bold;text-align:center;"><td>'+b[0].name+"</td><td>"+b[1].name+"</td></tr>";a+='<tr><td style="text-align:center;"><img src="http://www.esreality.com/images/maps/7/'+e.arena.toLowerCase()+'.jpg"></td><td style="text-align:center;"><img src="http://www.esreality.com/images/maps/7/'+f.arena.toLowerCase()+'.jpg"></td></tr>';a+="</tbody></table>";d("#favouriteArena").append(a);c.find(".inner").append('<div class="clear"></div>')})}}))}g.find("h1").append(d('<button class="button-link">Add to compare list</button>').click(function(a){a.preventDefault(); a=GM_getValue("players");if(void 0===a||""===a)a=[];else if(a=JSON.parse(a),2===a.length){alert("There are already 2 players in the compare list!");return}a.push({name:g.find("h1 > a").text(),country:d('tr[style="background-color:#EABD70;"]').find("td:eq(1)").html(),avatar:d("#avatar").html()});GM_setValue("players",JSON.stringify(a));a=d("#comparebar");var c=a.find("table");a.find("table tr:not(:first-child)").remove();var b=GM_getValue("players");if(void 0!==b&&""!==b){b=JSON.parse(b);c.is(":empty")&& c.append('<tbody><tr><th scope="col">Player</th><th scope="col">Country</th></tr></tbody>');for(var e=0;e<b.length;e++)c.find("tbody").append("<tr><td>"+b[e].name+"</td><td>"+b[e].country+"</td></tr>");a.find("button").show()}}))}})};

